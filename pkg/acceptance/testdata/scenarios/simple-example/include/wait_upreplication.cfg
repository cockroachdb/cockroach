role wait_upreplication
  :wait $COCKROACH sql --url $(cat ../$node/pgurl) \\
      -e "select if((select min(array_length(replicas,1)) from crdb_internal.ranges)>=3, 0, if(pg_sleep(.5), crdb_internal.force_retry('1h'), 0))"; sleep 2
end

cast
  waiter plays wait_upreplication with node=n2
end

script
  scene U entails for waiter: wait
  # Insert a wait as first step in act 2.
  edit s/^([^ ]*) /$1 U/
end
