# Test basic tenant capability watcher functionality.

start
----
ok

updates
----

upsert ten=10 can_admin_split=true
----
ok

upsert ten=11 can_admin_split=false
----
ok

updates
----
Incremental Update
{Entry:{TenantID:10 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:false}
{Entry:{TenantID:11 TenantCapabilities:{CanAdminSplit:false CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:false}

flush-state
----
{TenantID:10 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}}
{TenantID:11 TenantCapabilities:{CanAdminSplit:false CanViewNodeInfo:false CanViewTsdbMetrics:false}}

upsert ten=11 can_admin_split=true
----
ok

updates
----
Incremental Update
{Entry:{TenantID:11 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:false}

get-capabilities ten=11
----
{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}

delete ten=10
----
ok

updates
----
Incremental Update
{Entry:{TenantID:10 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:true}

get-capabilities ten=10
----
not-found

# No-op update.
delete ten=15
----
ok

updates
----

# Check that the internal state after a few incremental updates corresponds to
# what we'd expect.
flush-state
----
{TenantID:11 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}}

upsert ten=15 can_admin_split=true
----
ok

updates
----
Incremental Update
{Entry:{TenantID:15 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:false}

# Ensure only the last update is applied, even when there are multiple updates
# to a single key.
upsert ten=11 can_admin_split=false
----
ok

upsert ten=11 can_admin_split=true
----
ok

delete ten=11
----
ok

updates
----
Incremental Update
{Entry:{TenantID:11 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:true}

get-capabilities ten=11
----
not-found

flush-state
----
{TenantID:15 TenantCapabilities:{CanAdminSplit:true CanViewNodeInfo:false CanViewTsdbMetrics:false}}

# Same thing, but this time instead of deleting the key, leave it behind.
delete ten=15
----
ok

upsert ten=15 can_admin_split=true
----
ok

upsert ten=15 can_admin_split=false
----
ok

updates
----
Incremental Update
{Entry:{TenantID:15 TenantCapabilities:{CanAdminSplit:false CanViewNodeInfo:false CanViewTsdbMetrics:false}} Deleted:false}

flush-state
----
{TenantID:15 TenantCapabilities:{CanAdminSplit:false CanViewNodeInfo:false CanViewTsdbMetrics:false}}

get-capabilities ten=15
----
{CanAdminSplit:false CanViewNodeInfo:false CanViewTsdbMetrics:false}
