# We allow implicit access to non-admin users so that we can test
# with nodelocal.
new-cluster name=s1 allow-implicit-access
----

exec-sql
CREATE DATABASE testdb;
USE testdb;
CREATE TABLE testdb.t (a int primary key, b int);
CREATE MATERIALIZED VIEW testdb.mv AS SELECT a, b FROM testdb.t;
CREATE MATERIALIZED VIEW testdb.mv2 AS SELECT a, b FROM testdb.t;
INSERT INTO testdb.t (a, b) VALUES (1, 2);
----

exec-sql
REFRESH MATERIALIZED VIEW mv;
----

exec-sql
INSERT INTO testdb.t (a, b) VALUES (2, 3);
----

exec-sql
REFRESH MATERIALIZED VIEW mv;
----


# Pause the schema change intentionally to refresh a view on mv2
exec-sql
SET CLUSTER SETTING jobs.debug.pausepoints = 'schemachanger.before.exec'
----


exec-sql expect-error-regex=(pq: job \d+ was paused before it completed with reason: pause point "schemachanger.before.exec" hit)
REFRESH MATERIALIZED VIEW mv2;
----
regex matches error

exec-sql
BACKUP INTO 'nodelocal://1/test/'
----


new-cluster name=s2 share-io-dir=s1 allow-implicit-access
----

exec-sql
RESTORE DATABASE testdb FROM LATEST IN 'nodelocal://1/test/' WITH new_db_name = 'newdb';
----

query-sql
SELECT * FROM newdb.mv;
----
1 2
2 3
