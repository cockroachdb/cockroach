# Test for unstructured log with no split.
run maxlen=100 redactable=true structured=false withLongStack=false
hello ‹world› and universe
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"message":"hello ‹world› and universe"}

# Test for unstructured log, with split. Max len is 23 after suffix length.
run maxlen=30 redactable=false structured=false withLongStack=false
hello world and universe
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"message":"hello world "}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"message":"and universe"}

# Test for unstructured log, split with correct redaction markers. Max len is 23 after suffix length.
run maxlen=30 redactable=true structured=false withLongStack=false
hello ‹world› and universe
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"message":"hello ‹wor›"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"message":"‹ld› and"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"message":" universe"}


# Test for structured log, don't split on an integer value. Max len is 23 after suffix length.
run maxlen=30 redactable=false structured=true withLongStack=false
"Timestamp":1647874213395872000
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"event":{"Timestamp":1647874213395872000}}

# Test for structured log, split on an string value with correction quotations. Max len is 23 after suffix length.
run maxlen=30 redactable=false structured=true withLongStack=false
"StringField":"this is a string value"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"event":{"StringField":"this is "}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"event":{"StringField":"a string"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"event":{"StringField":" value"}}

# Test for structured log, split on an string value with correction quotations and redaction markers. Max len is 23 after suffix length.
run maxlen=30 redactable=true structured=true withLongStack=false
"StringField":"‹this is a string value›"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"StringField":"‹this ›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"StringField":"‹is a ›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"StringField":"‹strin›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"StringField":"‹g val›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"StringField":"‹ue›"}}

# Multi-field structured log, integer and string fields, split string with escaped characters and redaction markers. Max len is 23 after suffix length.
# Split early on *all* JSON keys.
run maxlen=30 redactable=true structured=true withLongStack=false
"Number":12345678901234567890,"Statement":"SELECT id, name, something FROM \"\".\"\".table WHERE column = ‹'secret_column'›","User":"‹test›"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Number":12345678901234567890}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"SELECT id,"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":" name, som"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"ething FRO"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"M \"\".\"\""}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":".table WHE"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"RE column "}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"= ‹'secr›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"‹et_colu›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"‹mn'›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"User":"‹test›"}}

# Multi-field structured log, integer and string fields, split with escaped characters and redaction markers. Max len is 43 after suffix length.
# Split early on *some* JSON keys. Do not split on "unsplittable" key (e.g. "User")
run maxlen=50 redactable=true structured=true withLongStack=false
"Number":1234567890,"Statement":"SELECT id, name, something FROM \"\".\"\".table WHERE column = ‹'secret_column'›","User":"‹test›"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Number":1234567890,"Statement":"SELECT id,"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":" name, something FROM \"\".\"\""}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":".table WHERE column = ‹'secr›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Statement":"‹et_column'›","User":"‹test›"}}

# Test for unstructured log containing multi-byte sequences.
run maxlen=30 redactable=false structured=false withLongStack=false
☃☃☃☃☃☃☃☃☃☃☃☃
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"message":"☃☃☃☃"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"message":"☃☃☃☃"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":0,"message":"☃☃☃☃"}

# Test for splitting long stack.
run maxlen=50 redactable=true structured=false withLongStack=true
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"message":"","stacks":"this is aaaaaaaaaaaaaaaaaaaaaaaaa"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"stacks":"aaaaaaaaaaaaaaaaaaaaaaaaa fake st"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"stacks":"ack"}

# Multi-field structured log, integer and string fields, split with escaped characters and redaction markers. Max len is 43 after suffix length.
# Include long stack.
run maxlen=50 redactable=true structured=true withLongStack=true
"Number":1234567890,"Message":"This is a \"message\" for ‹you›"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Number":1234567890,"Message":"This is a \""}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Message":"message\" for ‹you›"},"stacks":"this is aaaaaaaaaaaaaaaaaaaaaaaaa"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"stacks":"aaaaaaaaaaaaaaaaaaaaaaaaa fake st"}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"stacks":"ack"}

# Test for split in middle of redaction marker. Max len 23 after suffix length.
run maxlen=30 redactable=true structured=true withLongStack=false
"Redaction":"This is ‹marker›"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Redaction":"This is ‹›"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Redaction":"‹marker›"}}

# Test for split in middle of escape character. Max len 25 after suffix length.
run maxlen=32 redactable=true structured=true withLongStack=false
"Redaction":"This is an \"escaped\" string"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Redaction":"This is an \""}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Redaction":"escaped\" st"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"Redaction":"ring"}}

# Test for no split on "unsplittable" keys. Max len 23 after suffix length.
run maxlen=30 redactable=true structured=true withLongStack=false
"User":"this is a really long username","SQLSTATE":"this is a long sql state string"
----
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"User":"this is a really long username"}}
json: {"channel_numeric":0,"channel":"DEV","timestamp":"0.000000000","severity_numeric":0,"severity":"UNKNOWN","goroutine":0,"file":"","line":0,"entry_counter":0,"redactable":1,"event":{"SQLSTATE":"this is a long sql state string"}}

