#!/usr/bin/env bash

set -eu -o pipefail

if [ $# -ne 8 ]; then
    echo "Usage: $0 <type> <package>"
    exit 1
fi

type=$1
pkg=$2
contract=$3
bin_generics=$4
interval_1=$5
interval_2=$6
crlfmt_out=$7
internal_pkg=$8

templates=(
    ${interval_1}
    ${interval_2}
)
# Make filename prefix from type. Lower case and strip pointer.
dst_prefix=$(echo ${type} | awk '{print tolower($0)}' | sed 's/*//')

# Add code generation comment to beginning of files.
gen_header_comment="// Code generated by go_generics. DO NOT EDIT.\n"

# Generate files:
# 1. strip internal/contract.go of its comments and package declaration. This
#    script originally used github.com/mmatczuk/go_generics/cmd/go_merge to
#    merge files, but that passes the AST through go/ast.MergePackageFiles,
#    which causes all "unassociated" comments (those not tied to AST nodes)
#    to be stripped due to https://github.com/golang/go/issues/20744.
# 2. for each template file, concatenate the code gen comment, the template
#    file, and the stripped contract file, remove any build tags, and pass
#    this all to go_generics.
# 3. crlfmt the result because go_generics might re-order imports.
# 4. remove the temporary stripped contract file.
# Busca todo lo que no tenga empiece con // o package y lo manda a un archivo temporal
grep -vE '(//|package)' ${contract} > ${internal_pkg}/contract_stripped.tmp


for template in "${templates[@]}" ; do
    # Extracting file name from bazel input genrule
    interval_name=$(echo ${template} | rev | cut -d"/" -f1 | rev)
    dst=${internal_pkg}/${dst_prefix}_${interval_name//_tmpl/}
    echo =====================
    echo "dst value"
    echo ${dst}
    echo ======================
    echo -e ${gen_header_comment} \
    | cat - ${template} ${internal_pkg}/contract_stripped.tmp \
    | grep -v '// +build ignore' \
    | ${bin_generics} -i /dev/stdin -t T=${type} -p ${pkg} -o ${dst}
    ${crlfmt_out} -w -diff=false ${dst}
done
rm ${internal_pkg}/contract_stripped.tmp
