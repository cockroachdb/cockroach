# Explore the effects of latency smoothing. Set up an elastic limit of 20% and
# further below, a set-point of the same. We'll simulate three workloads under
# different smoothing values.
#
# (This is not to determine the right tuning parameters; that has to happen
# with actual experiments, this should hopefully help understand effects of
# this latency smoothing.)
init limit=20%
----

# Simulate 500 ticks with ewma-c=1.0; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

params ewma-c=1.0
----
ewma-c            = 1.00
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Simulate 500 ticks with ewma-c=0.3; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

# Simulate 500 ticks with ewma-c=0.3; ensure the random component in the
# latency function is relatively large.
params ewma-c=0.3
----
ewma-c            = 0.30
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Simulate 500 ticks with ewma-c=0.01; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

params ewma-c=0.01
----
ewma-c            = 0.01
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Plot the three workloads. Too little smoothing (left) can lead to under
# utilization, too much smoothing (right) can lead to a lagging controller with
# unstable outputs (large swings in utilization limits) -- we want something in
# between (middle).
plot width=70 height=20
----
----
 1087 ┤                                                       ╭╮
 1077 ┤                             ╭╮                        ││
 1067 ┤                             ││                      ╭╮││
 1056 ┤                             ││╭─╮    ╭╮             ││││      ╭╮
 1046 ┤  ╭╮                         │││ │    ││             ││││      ││
 1036 ┤  ││                         │││ │    ││             ││││   ╭╮ ││
 1026 ┤  ││          ╭╮     ╭╮   ╭╮╭╯││ │    │╰╮  ╭─╮       ││││   ││ ││
 1015 ┤  ││ ╭╮       ││     ││   │││ ││ │    │ │  │ │       ││││   ││ ││
 1005 ┤╭╮││╭╯│  ╭╮   ││   ╭╮││   │││ ││ │    │ │  │ ╰╮     ╭╯│││   ││ ││ ╭╮
  995 ┼─────────────────────────────────────────────────────────────────────
  984 ┤ ││││ │╭╮││   ││   │││╰╮  │   ││ │ ╭╮ │ │  │  │     │ │││ ││││╭╯╰╮││
  974 ┤ ││││ │││││╭╮ ││   │││ │ ╭╯   ││ ╰╮│╰─╯ │  │  │  ╭╮ │ ╰╯╰╮│││││  │││
  964 ┤ ││││ ││╰╯│││ ││   │││ │╭╯    ││  ││    │  │  ╰─╮││ │    ││││││  ╰╯│
  954 ┤ ╰╯││ ││  │││╭╯│   │││ ││     ││  ││    │  │    │││╭╯    ││││││    │╭
  943 ┤   ╰╯ ││  ││││ │   │││ ││     ╰╯  ││    ╰╮ │    ╰╯││     ││││││    ││
  933 ┤      ││  ││╰╯ │   │││ ││         ││     │╭╯      ╰╯     ││││╰╯    ╰╯
  923 ┤      ││  ││   │╭╮ │││ ╰╯         ╰╯     ╰╯              ││││
  912 ┤      ││  ╰╯   │││ │││                                   ││╰╯
  902 ┤      ││       │││╭╯╰╯                                   ╰╯
  892 ┤      ││       ╰╯╰╯
  882 ┤      ╰╯
                           p99 scheduler latencies (μs)


 24.3 ┤                                                     ╭─╮
 23.1 ┤                                                     │ │    ╭╮
 21.9 ┤                                                    ╭╯ │   ╭╯│      ╭
 20.6 ┤                                    ╭╭╮             │  │   │ │  ╭─╮ ╭
 19.4 ┼─╮                          ╭╮╭──╮  ╭╯╰──╮         ╭╯  ╰╮ ╭╯ │  │ │╭╯
 18.2 ┤ ╰╮                        ╭─╮│  │ ╭╯    ╰───╮    ╭╯    │ │  ╰╮╭╯ ││
 17.0 ┤  ╰─╭─╮╮              ╭────│ ╰╯  ╰╮│        ╰│─╮  │     │╭╯   ╰╯  ╰╯
 15.8 ┤    │╯╰──╮  ╭─╮  ╭╮ ╭─╮    │      ╰╯         │ ╰──│     ╰╯
 14.6 ┤   ╭╯    ╰──╯ ╰╮╭───╯ │   ╭╯                 │    │     ╰╯
 13.4 ┤   │           ╰╯     │   │                  │   ╭╯
 12.1 ┤   │                  │   │                  ╰╮  │
 10.9 ┤  ╭╯                  │  ╭╯                   │  │
  9.7 ┤  │                   │  │                    │ ╭╯
  8.5 ┤ ╭╯                   │  │                    │ │
  7.3 ┤ │                    │ ╭╯                    │╭╯
  6.1 ┤ │                    ╰╮│                     ││
  4.9 ┤╭╯                     ││                     ││
  3.6 ┤│                      ╰╯                     ╰╯
  2.4 ┤│
  1.2 ┤│
  0.0 ┼╯
                       elastic cpu utilization and limit (%)
----
----

# vim:ft=sh
