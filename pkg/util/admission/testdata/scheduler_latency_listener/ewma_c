# Explore the effects of latency smoothing. Set up an elastic limit of 20% and
# further below, a set-point of the same. We'll simulate three workloads under
# different smoothing values.
#
# (This is not to determine the right tuning parameters; that has to happen
# with actual experiments, this should hopefully help understand effects of
# this latency smoothing.)
init limit=20%
----

# Simulate 500 ticks with ewma-c=1.0; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

params ewma-c=1.0
----
ewma-c            = 1.00
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Simulate 500 ticks with ewma-c=0.3; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

# Simulate 500 ticks with ewma-c=0.3; ensure the random component in the
# latency function is relatively large.
params ewma-c=0.3
----
ewma-c            = 0.30
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Simulate 500 ticks with ewma-c=0.01; ensure the random component in the
# latency function is relatively large.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

params ewma-c=0.01
----
ewma-c            = 0.01
target-p99        = 1ms
min-util          = 5.00%
max-util          = 25.00%
delta             = 0.10%
factor            = 2.00
min-util-fraction = 90.00%

auto set-point=20% ticks=500 m=10 c=100
----

# Plot the three workloads. Too little smoothing (left) can lead to under
# utilization, too much smoothing (right) can lead to a lagging controller with
# unstable outputs (large swings in utilization limits) -- we want something in
# between (middle).
plot width=70 height=20
----
----
 1082 ┤                             ╭╮                      ╭╮
 1072 ┤                             ││   ╭╮                 ││
 1062 ┤                             ││   ││  ╭╮             ││╭╮      ╭╮
 1051 ┤                             ││   ││  ││           ╭╮││││      ││
 1041 ┤  ╭╮          ╭╮             ││   ││  ││           ││││││   ╭╮ ││  ╭╮
 1031 ┤  ││          ││            ╭╯│   ││  ││   ╭─╮     ││││││   ││ ││  ││
 1020 ┤  ││          ││     ╭╮   ╭╮│ │   ││  │╰╮  │ │     │╰╯│││   ││ ││ ╭╯╰
 1010 ┤  ││ ╭╮  ╭╮   ││   ╭╮││   │││ │  ╭╯│  │ │  │ ╰╮    │  │││   ││ ││ │
 1000 ┼─────────────────────────────────────────────────────────────────────
  990 ┤╰╮│││ │  ││   ││   │││╰╮  │   │  │  │ │ │  │  │    │  │││   ││╭╯ ││
  979 ┤ ││││ │╭╮││   ││   │││ │╭─╯   │  │  ╰─╯ │  │  │  ╭╮│  │││ ╭╮│││  ╰╯
  969 ┤ ││││ ││╰╯│╭╮ ││   │││ ││     │  │      │  │  ╰─╮│││  ╰╯╰╮│││││
  959 ┤ ╰╯││ ││  │││╭╯│   │││ ││     │  │      │  │    ││││     ││││││
  948 ┤   ││ ││  ││││ │   │││ ││     │╭─╯      ╰╮ │    ╰╯││     ││││││
  938 ┤   ╰╯ ││  ││││ │   │││ ││     ╰╯         │╭╯      ╰╯     ││││╰╯
  928 ┤      ││  ││╰╯ │╭╮ │││ ╰╯                ╰╯              ││││
  918 ┤      ││  ╰╯   │││ │││                                   ││╰╯
  907 ┤      ││       ╰╯│╭╯╰╯                                   ││
  897 ┤      ││         ╰╯                                      ╰╯
  887 ┤      ││
  876 ┤      ╰╯
                           p99 scheduler latencies (μs)


 25.0 ┤                                                     ╭╮
 23.7 ┤                                                     ││
 22.5 ┤                                  ╭╮                ╭╯╰╮    ╭╮
 21.2 ┤                                 ╭╯│               ╭│  │   ╭╯│  ╭─╮
 20.0 ┼─╮                             ╭─╯ ╰────╮          ╭╯  │   │ │ ╭╯ │╭╮
 18.7 ┤ ╰╮                        ╭─╮╭╯       ╰╰────╮    ╭╯   │  ╭╯ ╰╮│  ╰╯│
 17.5 ┤  ╰╮                 ╭╮────│ ╰╯             ╰│─╮  │    ╰╮ │  ╰╰╯    │
 16.2 ┤   ╰╭────╮╭╮╭─╮ ╭─╮ ╭╯│    │                 │ ╰──│     │╭╯         ╰
 15.0 ┤    │    ╰──╯ ╰─╯ ╰─╯ │   ╭╯                 │    │     ││
 13.7 ┤   ╭╯                 │   │                  │   ╭╯     ╰╯
 12.5 ┤   │                  │   │                  ╰╮  │
 11.2 ┤  ╭╯                  │  ╭╯                   │ ╭╯
 10.0 ┤  │                   │  │                    │ │
  8.7 ┤  │                   │  │                    │ │
  7.5 ┤ ╭╯                   │ ╭╯                    │╭╯
  6.2 ┤ │                    ╰╮│                     ││
  5.0 ┤ │                     ││                     ││
  3.7 ┤╭╯                     ╰╯                     ╰╯
  2.5 ┤│
  1.2 ┤│
  0.0 ┼╯
                       elastic cpu utilization and limit (%)
----
----

# vim:ft=sh
