# Explore how the controller behaves when there's no utilization.
init limit=50%
----

params
----
target-p99       = 1ms
min-util         = 5.00%
max-util         = 75.00%
inactive-util    = 22.50%
adjustment-delta = 0.10%
factor           = 2.00
inactive-factor  = 0.25

# Start a workload from scratch, increasing at 1% per tick.
tick
p99=1ms ticks=1 util-fraction=0.0
p99=1ms ticks=1 util-fraction=+0.01
----

auto set-point=45% ticks=400
----

# Decrease the workload at 1% per tick.
tick
p99=1ms ticks=1 util-fraction=-0.01
----

# Run for a lot longer.
auto set-point=45% ticks=900
----

# We should observe the limit gradually decrease to inactive-util == 22.5%;
# decreasing unused CPU limit to prevent bursts of over admission.
plot width=70 height=20
----
----
 1109 ┤   ╭╮
 1075 ┤   ││          ╭╮
 1041 ┤ ╭╮││     ╭╮╭─╮│╰╮
 1007 ┤ ││││     │││ ││ │ ╭─╮╭╮
  973 ┼─────────────────────────────────────────────────────────────────────
  939 ┤││╰╯  │ │││   ││ │ │   │  ││
  905 ┤╰╯    │ │╰╯   ││ │ │   ╰╮╭╯│     ╭─╮
  871 ┤      │ │     ││ │╭╯    ││ │     │ │  ╭╮
  837 ┤      ╰╮│     ││ ╰╯     ╰╯ │    ╭╯ │  ││╭╮
  803 ┤       ╰╯     ││           │    │  │  ││││ ╭╮╭╮  ╭╮
  768 ┤              ││           ╰─╮  │  │  │││╰╮││││  ││╭─╮
  734 ┤              ╰╯             ╰─╮│  │  │││ │││││ ╭╯││ ╰╮
  700 ┤                               ╰╯  ╰╮ │╰╯ ││╰╯│ │ ││  ╰╮            ╭
  666 ┤                                    │ │   ╰╯  │ │ ╰╯   │╭╮          │
  632 ┤                                    ╰╮│       │ │      │││          │
  598 ┤                                     ╰╯       ╰╮│      │││╭╮        │
  564 ┤                                               ╰╯      ││╰╯╰╮       │
  530 ┤                                                       ╰╯   │╭╮ ╭╮ ╭╯
  496 ┤                                                            │││ ││ │
  462 ┤                                                            ╰╯│ ││ │
  428 ┤                                                              ╰─╯╰─╯
                           p99 scheduler latencies (μs)


 50.0 ┼╮
 47.5 ┤╰─╮
 45.0 ┤  ╰──╭─╮
 42.5 ┤    ╭╯╯╰──╮╭────╮  ╭╮╭╮ ╭──╮
 40.0 ┤    │     ╰╯   ╰╰──╯╰╮╰─╯  ╰─╮
 37.5 ┤    │                │       ╰─╮
 35.0 ┤    │                ╰╮        ╰─────╮
 32.5 ┤   ╭╯                 │              ╰────╮
 30.0 ┤   │                  │                   ╰────╮
 27.5 ┤   │                  ╰╮                       ╰────╮
 25.0 ┤  ╭╯                   │                            ╰─────╮
 22.5 ┤  │                    │                                  ╰──────────
 20.0 ┤  │                    ╰╮
 17.5 ┤ ╭╯                     │
 15.0 ┤ │                      │
 12.5 ┤ │                      ╰╮
 10.0 ┤╭╯                       │
  7.5 ┤│                        │
  5.0 ┤│                        ╰╮
  2.5 ┤│                         │
  0.0 ┼╯                         ╰──────────────────────────────────────────
                       elastic cpu utilization and limit (%)
----
----

# vim:ft=sh
