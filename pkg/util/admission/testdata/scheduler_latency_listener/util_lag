# Explore the effects of controller lag. If there's enough of a lag, the
# utilization trails the limit we're looking to enforce at any point in time.
#
# (This is not to determine the right tuning parameters; that has to happen
# with actual experiments, this should hopefully help understand effects of the
# delay.)
init limit=20%
----

# Start a workload from scratch, increasing at 1% per tick but lagging by 100
# ticks.
tick
p99=1ms ticks=1 util-fraction=0.00 util-lag=100
p99=1ms ticks=1 util-fraction=+0.01
----

auto set-point=20% ticks=500 m=10 c=100
----

# Start a workload from scratch, increasing at 1% per tick with no lag.
tick
p99=1ms ticks=1 util-fraction=0.00 util-lag=0
p99=1ms ticks=1 util-fraction=+0.01
----

auto set-point=20% ticks=500 m=10 c=25
----

# With more lag (first half of the graph), we're more likely to observe a large
# difference between the set-point we need to hit and the utilization we
# currently have, making for larger scheduling latency fluctuations (i.e. an
# ineffective controller).
plot width=70 height=20
----
----
 1065 ┤ ╭╮
 1056 ┤ ││
 1047 ┤ ││
 1037 ┤ ││   ╭╮                   ╭╮
 1028 ┤ ││   ││                 ╭╮││╭╮             ╭╮
 1019 ┤ ││   ││      ╭╮         ││││││  ╭╮         ││
 1010 ┤╭╯│   ││      ││         ││││││  ││         ││           ╭╮╭╮     ╭╮
 1000 ┼─────────────────────────────────────────────────────────────────────
  991 ┤  │   │╰╯│  ╭╮││   ││││  ││││││ │ │ ╭╯││╰─╯╰╯╰╮╭╮ │   ╰╮ │││││╰╯╰─╯ ╰
  982 ┤  │╭╮ │  │╭╮│╰╯╰╮  ││││  ││││││ │ │ │ ╰╯      ╰╯╰─╯    │╭╯╰╯││
  972 ┤  │││ │  ││╰╯   │  │╰╯│  │││││╰╮│ ╰─╯                  ││   ╰╯
  963 ┤  │││ │  ╰╯     │╭╮│  │  │││││ ││                      ╰╯
  954 ┤  │││ │         ││││  ╰╮ │││││ ││
  944 ┤  ╰╯│ │         ││││   │ │││││ ││
  935 ┤    │ │         ││││   │ │││││ ││
  926 ┤    │╭╯         ││││   │ │││││ ╰╯
  916 ┤    ││          ││││   │╭╯││││
  907 ┤    ││          ││││   ╰╯ ││││
  898 ┤    ││          ││╰╯      ╰╯╰╯
  888 ┤    ╰╯          ││
  879 ┤                ╰╯
                           p99 scheduler latencies (μs)


 20.0 ┼╮                                          ╭─╮╮      ╭╮
 19.0 ┤╰╮                                 ╭────╮╭─╯ ╰───────╯╰─────╮╭╭──────
 18.0 ┤ │                                ╭╯    ╰│                  ╰─╯
 17.0 ┤ ╰─╮                           ╭──╯     ╭╯
 16.0 ┤   ╰─╮   ╭───╮  ╭───╮─╮ ╭╭───╮╭╭──╮     │
 15.0 ┤     ╰───╯   ╭──╯─╯ ╰────╯   ╰─╯  │    ╭╯
 14.0 ┤            ╭╯                    │    │
 13.0 ┤            │                     │    │
 12.0 ┤           ╭╯                     │   ╭╯
 11.0 ┤           │                      │   │
 10.0 ┤          ╭╯                      │  ╭╯
  9.0 ┤          │                       │  │
  8.0 ┤         ╭╯                       │  │
  7.0 ┤         │                        │ ╭╯
  6.0 ┤         │                        │ │
  5.0 ┤        ╭╯                        │ │
  4.0 ┤        │                         │╭╯
  3.0 ┤       ╭╯                         ││
  2.0 ┤       │                          ││
  1.0 ┤       │                          ╰╯
  0.0 ┼───────╯
                       elastic cpu utilization and limit (%)
----
----

# vim:ft=sh
