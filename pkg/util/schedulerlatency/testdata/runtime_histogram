# Explore how the histogram type that wraps around runtime/metrics behaves.
# Initialize it to buckets that have a:
# - width of 1.0 apart in the range [0, 5)
# - width of 5.0 apart in the range [5, 20)
# - width of 10.0 apart in the range [20, 50)
init
bucket=[-inf,0)
bucket=[0,1)
bucket=[1,2)
bucket=[2,3)
bucket=[3,4)
bucket=[4,5)
bucket=[5,10)
bucket=[10,15)
bucket=[15,20)
bucket=[20,30)
bucket=[30,40)
bucket=[40,50)
bucket=[50,+inf)
----

# We should see the right cumulative buckets, trimming out +/- inf.
# Both cumulative and windowed snapshots start at zero.
print
----
cumulative count=0 sum=0.00
windowed count=0 sum=0.00
buckets:
  upper-bound=1.00 cumulative-count=0
  upper-bound=2.00 cumulative-count=0
  upper-bound=3.00 cumulative-count=0
  upper-bound=4.00 cumulative-count=0
  upper-bound=5.00 cumulative-count=0
  upper-bound=10.00 cumulative-count=0
  upper-bound=15.00 cumulative-count=0
  upper-bound=20.00 cumulative-count=0
  upper-bound=30.00 cumulative-count=0
  upper-bound=40.00 cumulative-count=0
  upper-bound=50.00 cumulative-count=0

# If updating within a bucket (the histogram is initialized with a subset of
# the buckets updates can have), the right buckets are incremented. We'll
# increment the buckets between [3, 4) by 9 across two sub-increments.
# We'll also increment [10, 15) using data that lies within the range.
update
bucket=[0,1) count=0
bucket=[1,2) count=0
bucket=[2,3) count=0
bucket=[3,3.5) count=5
bucket=[3.5,4) count=4
bucket=[4,5) count=0
bucket=[5,10) count=0
bucket=[10,11) count=1
bucket=[11,15) count=0
----

# Observe how the right buckets are incremented and reduced into.
# After the first update, cumulative and windowed are the same.
#
# count = 5 + 4 + 1 = 10 (total observations)
# sum uses lower bound of each bucket (underestimate):
#   - 9 observations in [3,4) -> 9 * 3 = 27
#   - 1 observation in [10,15) -> 1 * 10 = 10
#   - total: 27 + 10 = 37
print
----
cumulative count=10 sum=37.00
windowed count=10 sum=37.00
buckets:
  upper-bound=1.00 cumulative-count=0
  upper-bound=2.00 cumulative-count=0
  upper-bound=3.00 cumulative-count=0
  upper-bound=4.00 cumulative-count=9
  upper-bound=5.00 cumulative-count=9
  upper-bound=10.00 cumulative-count=9
  upper-bound=15.00 cumulative-count=10
  upper-bound=20.00 cumulative-count=10
  upper-bound=30.00 cumulative-count=10
  upper-bound=40.00 cumulative-count=10
  upper-bound=50.00 cumulative-count=10

# Updates are cumulative (fixes #161605). The delta counts from each update
# are added to the existing cumulative counts. This is required because
# Prometheus expects monotonically increasing values for histogram buckets.
update
bucket=[0,1) count=0
bucket=[1,2) count=0
bucket=[2,3) count=0
bucket=[3,4) count=0
bucket=[4,5) count=0
bucket=[5,10) count=0
bucket=[10,15) count=2
bucket=[15,20) count=1
----

# After the second update, cumulative and windowed diverge:
# - Cumulative: 10 + 3 = 13 total, for Prometheus rate()
# - Windowed: just 3 from this window, for TSDB percentiles
#
# The sum is computed using start of bucket boundaries:
#   Previous update: 9*3 + 1*10 = 37
#   This update:     2*10 + 1*15 = 35
#   Cumulative:      37 + 35 = 72
print
----
cumulative count=13 sum=72.00
windowed count=3 sum=35.00
buckets:
  upper-bound=1.00 cumulative-count=0
  upper-bound=2.00 cumulative-count=0
  upper-bound=3.00 cumulative-count=0
  upper-bound=4.00 cumulative-count=9
  upper-bound=5.00 cumulative-count=9
  upper-bound=10.00 cumulative-count=9
  upper-bound=15.00 cumulative-count=12
  upper-bound=20.00 cumulative-count=13
  upper-bound=30.00 cumulative-count=13
  upper-bound=40.00 cumulative-count=13
  upper-bound=50.00 cumulative-count=13
