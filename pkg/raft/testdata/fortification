add-nodes 3 voters=(1,2,3) index=10
----
INFO 1 switched to configuration voters=(1 2 3)
INFO 1 became follower at term 0
INFO newRaft 1 [peers: [1,2,3], term: 0, commit: 10, applied: 10, lastindex: 10, lastterm: 1]
INFO 2 switched to configuration voters=(1 2 3)
INFO 2 became follower at term 0
INFO newRaft 2 [peers: [1,2,3], term: 0, commit: 10, applied: 10, lastindex: 10, lastterm: 1]
INFO 3 switched to configuration voters=(1 2 3)
INFO 3 became follower at term 0
INFO newRaft 3 [peers: [1,2,3], term: 0, commit: 10, applied: 10, lastindex: 10, lastterm: 1]

campaign 1
----
INFO 1 is starting a new election at term 0
INFO 1 became candidate at term 1
INFO 1 [logterm: 1, index: 10] sent MsgVote request to 2 at term 1
INFO 1 [logterm: 1, index: 10] sent MsgVote request to 3 at term 1

stabilize
----
> 1 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateCandidate
  HardState Term:1 Vote:1 Commit:10
  Messages:
  1->2 MsgVote Term:1 Log:1/10
  1->3 MsgVote Term:1 Log:1/10
  INFO 1 received MsgVoteResp from 1 at term 1
  INFO 1 has received 1 MsgVoteResp votes and 0 vote rejections
> 2 receiving messages
  1->2 MsgVote Term:1 Log:1/10
  INFO 2 [term: 0] received a MsgVote message with higher term from 1 [term: 1]
  INFO 2 became follower at term 1
  INFO 2 [logterm: 1, index: 10, vote: 0] cast MsgVote for 1 [logterm: 1, index: 10] at term 1
> 3 receiving messages
  1->3 MsgVote Term:1 Log:1/10
  INFO 3 [term: 0] received a MsgVote message with higher term from 1 [term: 1]
  INFO 3 became follower at term 1
  INFO 3 [logterm: 1, index: 10, vote: 0] cast MsgVote for 1 [logterm: 1, index: 10] at term 1
> 2 handling Ready
  Ready MustSync=true:
  HardState Term:1 Vote:1 Commit:10
  Messages:
  2->1 MsgVoteResp Term:1 Log:0/0
> 3 handling Ready
  Ready MustSync=true:
  HardState Term:1 Vote:1 Commit:10
  Messages:
  3->1 MsgVoteResp Term:1 Log:0/0
> 1 receiving messages
  2->1 MsgVoteResp Term:1 Log:0/0
  INFO 1 received MsgVoteResp from 2 at term 1
  INFO 1 has received 2 MsgVoteResp votes and 0 vote rejections
  INFO 1 became leader at term 1
  3->1 MsgVoteResp Term:1 Log:0/0
> 1 handling Ready
  Ready MustSync=true:
  Lead:1 State:StateLeader
  Entries:
  1/11 EntryNormal ""
  Messages:
  1->2 MsgApp Term:1 Log:1/10 Commit:10 Entries:[1/11 EntryNormal ""]
  1->3 MsgApp Term:1 Log:1/10 Commit:10 Entries:[1/11 EntryNormal ""]
  1->2 MsgFortifyLeader Term:1 Log:0/0
  1->3 MsgFortifyLeader Term:1 Log:0/0
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/10 Commit:10 Entries:[1/11 EntryNormal ""]
  1->2 MsgFortifyLeader Term:1 Log:0/0
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/10 Commit:10 Entries:[1/11 EntryNormal ""]
  1->3 MsgFortifyLeader Term:1 Log:0/0
> 2 handling Ready
  Ready MustSync=true:
  Lead:1 State:StateFollower
  Entries:
  1/11 EntryNormal ""
  Messages:
  2->1 MsgFortifyLeaderResp Term:1 Log:0/0 LeadEpoch 1
  2->1 MsgAppResp Term:1 Log:0/11
> 3 handling Ready
  Ready MustSync=true:
  Lead:1 State:StateFollower
  Entries:
  1/11 EntryNormal ""
  Messages:
  3->1 MsgFortifyLeaderResp Term:1 Log:0/0 LeadEpoch 1
  3->1 MsgAppResp Term:1 Log:0/11
> 1 receiving messages
  2->1 MsgFortifyLeaderResp Term:1 Log:0/0 LeadEpoch 1
  2->1 MsgAppResp Term:1 Log:0/11
  3->1 MsgFortifyLeaderResp Term:1 Log:0/0 LeadEpoch 1
  3->1 MsgAppResp Term:1 Log:0/11
> 1 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:11
  CommittedEntries:
  1/11 EntryNormal ""
  Messages:
  1->2 MsgApp Term:1 Log:1/11 Commit:11
  1->3 MsgApp Term:1 Log:1/11 Commit:11
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/11 Commit:11
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/11 Commit:11
> 2 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:11
  CommittedEntries:
  1/11 EntryNormal ""
  Messages:
  2->1 MsgAppResp Term:1 Log:0/11
> 3 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:11
  CommittedEntries:
  1/11 EntryNormal ""
  Messages:
  3->1 MsgAppResp Term:1 Log:0/11
> 1 receiving messages
  2->1 MsgAppResp Term:1 Log:0/11
  3->1 MsgAppResp Term:1 Log:0/11

store-liveness
----
  1 2 3
1 1 1 1
2 1 1 1
3 1 1 1

bump-epoch 2
----
  1 2 3
1 1 2 1
2 1 2 1
3 1 2 1

# bump support for 2 by 1. Store 3 should continue to support the older epoch
# (2). The current epoch of store 2 is stored at (2,2), so that'll get bumped to
# 3 as well.
bump-support-for 2 1
----
  1 2 3
1 1 3 1
2 1 3 1
3 1 2 1

# withdraw support for 1 by 3.
withdraw-support-for 2 3
----
  1 2 3
1 1 3 1
2 1 3 1
3 1 x 1

campaign 2
----
INFO 2 is starting a new election at term 1
INFO 2 became candidate at term 2
INFO 2 [logterm: 1, index: 11] sent MsgVote request to 1 at term 2
INFO 2 [logterm: 1, index: 11] sent MsgVote request to 3 at term 2

# 2 becomes the leader at term 2. It wins the election and tries to fortify.
# It's successfully able to fortify 1, at epoch 3. However, store 3 isn't
# supporting store 2 -- so it'll reject its fortification request.
stabilize
----
> 2 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateCandidate
  HardState Term:2 Vote:2 Commit:11
  Messages:
  2->1 MsgVote Term:2 Log:1/11
  2->3 MsgVote Term:2 Log:1/11
  INFO 2 received MsgVoteResp from 2 at term 2
  INFO 2 has received 1 MsgVoteResp votes and 0 vote rejections
> 1 receiving messages
  2->1 MsgVote Term:2 Log:1/11
  INFO 1 [term: 1] received a MsgVote message with higher term from 2 [term: 2]
  INFO 1 became follower at term 2
  INFO 1 [logterm: 1, index: 11, vote: 0] cast MsgVote for 2 [logterm: 1, index: 11] at term 2
> 3 receiving messages
  2->3 MsgVote Term:2 Log:1/11
  INFO 3 [term: 1] received a MsgVote message with higher term from 2 [term: 2]
  INFO 3 became follower at term 2
  INFO 3 [logterm: 1, index: 11, vote: 0] cast MsgVote for 2 [logterm: 1, index: 11] at term 2
> 1 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateFollower
  HardState Term:2 Vote:2 Commit:11
  Messages:
  1->2 MsgVoteResp Term:2 Log:0/0
> 3 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateFollower
  HardState Term:2 Vote:2 Commit:11
  Messages:
  3->2 MsgVoteResp Term:2 Log:0/0
> 2 receiving messages
  1->2 MsgVoteResp Term:2 Log:0/0
  INFO 2 received MsgVoteResp from 1 at term 2
  INFO 2 has received 2 MsgVoteResp votes and 0 vote rejections
  INFO 2 became leader at term 2
  3->2 MsgVoteResp Term:2 Log:0/0
> 2 handling Ready
  Ready MustSync=true:
  Lead:2 State:StateLeader
  Entries:
  2/12 EntryNormal ""
  Messages:
  2->1 MsgApp Term:2 Log:1/11 Commit:11 Entries:[2/12 EntryNormal ""]
  2->3 MsgApp Term:2 Log:1/11 Commit:11 Entries:[2/12 EntryNormal ""]
  2->1 MsgFortifyLeader Term:2 Log:0/0
  2->3 MsgFortifyLeader Term:2 Log:0/0
> 1 receiving messages
  2->1 MsgApp Term:2 Log:1/11 Commit:11 Entries:[2/12 EntryNormal ""]
  2->1 MsgFortifyLeader Term:2 Log:0/0
> 3 receiving messages
  2->3 MsgApp Term:2 Log:1/11 Commit:11 Entries:[2/12 EntryNormal ""]
  2->3 MsgFortifyLeader Term:2 Log:0/0
> 1 handling Ready
  Ready MustSync=true:
  Lead:2 State:StateFollower
  Entries:
  2/12 EntryNormal ""
  Messages:
  1->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 3
  1->2 MsgAppResp Term:2 Log:0/12
> 3 handling Ready
  Ready MustSync=true:
  Lead:2 State:StateFollower
  Entries:
  2/12 EntryNormal ""
  Messages:
  3->2 MsgFortifyLeaderResp Term:2 Log:0/0 Rejected (Hint: 0)
  3->2 MsgAppResp Term:2 Log:0/12
> 2 receiving messages
  1->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 3
  1->2 MsgAppResp Term:2 Log:0/12
  3->2 MsgFortifyLeaderResp Term:2 Log:0/0 Rejected (Hint: 0)
  3->2 MsgAppResp Term:2 Log:0/12
> 2 handling Ready
  Ready MustSync=false:
  HardState Term:2 Vote:2 Commit:12
  CommittedEntries:
  2/12 EntryNormal ""
  Messages:
  2->1 MsgApp Term:2 Log:2/12 Commit:12
  2->3 MsgApp Term:2 Log:2/12 Commit:12
> 1 receiving messages
  2->1 MsgApp Term:2 Log:2/12 Commit:12
> 3 receiving messages
  2->3 MsgApp Term:2 Log:2/12 Commit:12
> 1 handling Ready
  Ready MustSync=false:
  HardState Term:2 Vote:2 Commit:12
  CommittedEntries:
  2/12 EntryNormal ""
  Messages:
  1->2 MsgAppResp Term:2 Log:0/12
> 3 handling Ready
  Ready MustSync=false:
  HardState Term:2 Vote:2 Commit:12
  CommittedEntries:
  2/12 EntryNormal ""
  Messages:
  3->2 MsgAppResp Term:2 Log:0/12
> 2 receiving messages
  1->2 MsgAppResp Term:2 Log:0/12
  3->2 MsgAppResp Term:2 Log:0/12

store-liveness
----
  1 2 3
1 1 3 1
2 1 3 1
3 1 x 1

# Tick 2 and ensure there's no attempt to re-fortify from 3 as 3 isn't currently
# supporting 2.
tick-heartbeat 2
----
ok

stabilize
----
> 2 handling Ready
  Ready MustSync=false:
  Messages:
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
> 1 receiving messages
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
> 3 receiving messages
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
> 1 handling Ready
  Ready MustSync=false:
  Messages:
  1->2 MsgHeartbeatResp Term:2 Log:0/0
> 3 handling Ready
  Ready MustSync=false:
  Messages:
  3->2 MsgHeartbeatResp Term:2 Log:0/0
> 2 receiving messages
  1->2 MsgHeartbeatResp Term:2 Log:0/0
  3->2 MsgHeartbeatResp Term:2 Log:0/0

# Gain back support for 2 from 3. We'll then tick the raft group and expect 2
# to fortify from 3 now that it's supported.
bump-support-for 2 3
----
  1 2 3
1 1 3 1
2 1 4 1
3 1 4 1

tick-heartbeat 2
----
ok

stabilize
----
> 2 handling Ready
  Ready MustSync=false:
  Messages:
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->3 MsgFortifyLeader Term:2 Log:0/0
> 1 receiving messages
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
> 3 receiving messages
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->3 MsgFortifyLeader Term:2 Log:0/0
> 1 handling Ready
  Ready MustSync=false:
  Messages:
  1->2 MsgHeartbeatResp Term:2 Log:0/0
> 3 handling Ready
  Ready MustSync=false:
  Messages:
  3->2 MsgHeartbeatResp Term:2 Log:0/0
  3->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 4
> 2 receiving messages
  1->2 MsgHeartbeatResp Term:2 Log:0/0
  3->2 MsgHeartbeatResp Term:2 Log:0/0
  3->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 4


# Withdraw support for 2 from 1 at epoch 3. As a result, 1 will now support 2
# at epoch 5. We'll then tick the raft group and ensure it tries to re-fortify
# at this new epoch.
bump-support-for 2 1
----
  1 2 3
1 1 5 1
2 1 5 1
3 1 4 1

tick-heartbeat 2
----
ok

stabilize
----
> 2 handling Ready
  Ready MustSync=false:
  Messages:
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->1 MsgFortifyLeader Term:2 Log:0/0
> 1 receiving messages
  2->1 MsgHeartbeat Term:2 Log:0/0 Commit:12
  2->1 MsgFortifyLeader Term:2 Log:0/0
> 3 receiving messages
  2->3 MsgHeartbeat Term:2 Log:0/0 Commit:12
> 1 handling Ready
  Ready MustSync=false:
  Messages:
  1->2 MsgHeartbeatResp Term:2 Log:0/0
  1->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 5
> 3 handling Ready
  Ready MustSync=false:
  Messages:
  3->2 MsgHeartbeatResp Term:2 Log:0/0
> 2 receiving messages
  1->2 MsgHeartbeatResp Term:2 Log:0/0
  1->2 MsgFortifyLeaderResp Term:2 Log:0/0 LeadEpoch 5
  3->2 MsgHeartbeatResp Term:2 Log:0/0
