// Copyright 2025 The Cockroach Authors.
//
// Use of this software is governed by the CockroachDB Software License
// included in the /LICENSE file.

syntax = "proto3";
package cockroach.kv.kvserver.rangefeed.rangefeedpb;
option go_package = "github.com/cockroachdb/cockroach/pkg/kv/kvserver/rangefeed/rangefeedpb";

import "gogoproto/gogo.proto";
import "roachpb/data.proto";
import "util/hlc/timestamp.proto";
import "google/protobuf/timestamp.proto";

// RegistrationState represents the state of a single active rangefeed
// registration.
message RegistrationState {
  // StreamID is set by the client when starting the rangefeed.
  int64 stream_id = 1 [(gogoproto.customname) = "StreamID"];
  // ConsumerID is set by the client when starting the rangefeed.
  int64 consumer_id = 2 [(gogoproto.customname) = "ConsumerID"];
  // ID of the range being watched by this rangefeed.
  int32 range_id = 3 [(gogoproto.customname) = "RangeID",
                      (gogoproto.casttype) = "github.com/cockroachdb/cockroach/pkg/roachpb.RangeID"];
  // Span being watched by this rangefeed.
  roachpb.Span span = 4 [(gogoproto.nullable) = false];
  // The starting timestamp of catch-up scans. Historical events with timestamp > catchup_ts 
  // will be replayed before the feed switches to live updates. 
  util.hlc.Timestamp catchup_ts = 5 [(gogoproto.nullable) = false,
                                     (gogoproto.customname) = "CatchUpTS"];
  // Whether this rangefeed is configured to emit diffs.
  bool diff = 6;
  // Time that this rangefeed registration was created at.
  google.protobuf.Timestamp created = 7 [(gogoproto.nullable) = false,
                                          (gogoproto.stdtime) = true];
  // Frontier of the stream. All key-value events with timestamp <= resolved_ts
  // have already been emitted.
  util.hlc.Timestamp resolved_ts = 8 [(gogoproto.nullable) = false,
                                      (gogoproto.customname) = "ResolvedTS"];
  // Whether the rangefeed is currently running a catch-up scan.
  bool catchup_running = 9 [(gogoproto.customname) = "CatchUpRunning"];
  // Tags set in the stream context when starting the rangefeed.
  string tags = 10;
}

// InspectRangefeedsRequest is used to power the Rangefeeds /inspectz
// functionality. The request doesn't take any parameters.
message InspectRangefeedsRequest {}

// InspectRangefeedsResponse is used to power the Rangefeeds /inspectz
// functionality. The response is a list of RangefeedInfoPerStore.
message InspectRangefeedsResponse {
  repeated RangefeedInfoPerStore rangefeed_info_per_store = 1 [(gogoproto.nullable) = false];
}

message RangefeedInfoPerStore {
  // Identity of the store these states belong to.
  roachpb.StoreIdent store_ident = 1 [(gogoproto.nullable) = false,
                                      (gogoproto.customname) = "StoreIdent"];
  // Collection of rangefeed registration states active on that store.
  repeated RegistrationState registrations = 2 [(gogoproto.nullable) = false];
}
