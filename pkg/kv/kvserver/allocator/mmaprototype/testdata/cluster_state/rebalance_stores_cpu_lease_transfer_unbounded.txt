include path=rebalance_stores_cpu_lease_include.txt
----
ok

# s1 is overloaded and local, so rebalanceStores should try and succeed to shed
# leases from it. We disable all limits.
# TODO(tbg,during PR): understand the frac-pending part of the "cannot add load" messages[1],
# concretely why this is using >eps instead of >maxFracPendingThreshold. It wouldn't change
# the test outcome since there are other reasons for rejection, but I don't understand this
# particular one at the time of writing.
#
# [1]: https://cockroachlabs.slack.com/archives/C048HDZJSAY/p1763644073142999
rebalance-stores store-id=1 fraction-pending-decrease-threshold=10.0 max-lease-transfer-count=999
----
[mmaid=0] rebalanceStores begins
[mmaid=0] cluster means: (stores-load [cpu:400, write-bandwidth:0, byte-size:0]) (stores-capacity [cpu:1000, write-bandwidth:1000, byte-size:1000]) (nodes-cpu-load 400) (nodes-cpu-capacity 1000)
[mmaid=0] evaluating s1: node load overloadUrgent, store load overloadUrgent, worst dim CPURate
[mmaid=0] overload-continued s1 ((store=overloadUrgent worst=CPURate cpu=overloadUrgent writes=loadNormal bytes=loadNormal node=overloadUrgent high_disk=false frac_pending=0.00,0.00(true))) - within grace period
[mmaid=0] store s1 was added to shedding store list
[mmaid=0] evaluating s2: node load loadLow, store load loadNormal, worst dim WriteBandwidth
[mmaid=0] evaluating s3: node load loadLow, store load loadNormal, worst dim WriteBandwidth
[mmaid=0] start processing shedding store s1: cpu node load overloadUrgent, store load overloadUrgent, worst dim CPURate
[mmaid=0] top-K[CPURate] ranges for s1 with lease on local s1: r4:[cpu:250, write-bandwidth:0, byte-size:0] r3:[cpu:250, write-bandwidth:0, byte-size:0] r2:[cpu:250, write-bandwidth:0, byte-size:0] r1:[cpu:250, write-bandwidth:0, byte-size:0]
[mmaid=0] local store s1 is CPU overloaded (overloadUrgent >= overloadSlow), attempting lease transfers first
[mmaid=0] considering lease-transfer r4 from s1: candidates are [1 2 3]
[mmaid=0] sortTargetCandidateSetAndPick: candidates: s2(loadNormal) s3(loadNormal), picked s2
[mmaid=0] can add load to n2s2: true targetSLS[(store=loadNormal worst=WriteBandwidth cpu=loadLow writes=loadNormal bytes=loadNormal node=loadLow high_disk=false frac_pending=0.00,0.00(true))] srcSLS[(store=overloadUrgent worst=CPURate cpu=overloadUrgent writes=loadNormal bytes=loadNormal node=overloadUrgent high_disk=false frac_pending=0.00,0.00(true))]
[mmaid=0] result(success): shedding r4 lease from s1 to s2 [change:r4=[transfer_to=2 cids=1,2]] with resulting loads source:[cpu:770, write-bandwidth:0, byte-size:0] target:[cpu:353, write-bandwidth:0, byte-size:0] (means: [cpu:400, write-bandwidth:0, byte-size:0]) (frac_pending: (src:0.00,target:0.23) (src:2.53,target:0.00))
[mmaid=0] considering lease-transfer r3 from s1: candidates are [1 2 3]
[mmaid=0] sortTargetCandidateSetAndPick: candidates: s2(loadNormal) s3(loadNormal), picked s2
[mmaid=0] cannot add load to n2s2: due to target_summary(overloadSlow)>=loadNoChange,targetSLS.frac_pending(2.53or0.00>=epsilon)
[mmaid=0] [target_sls:(store=overloadSlow worst=CPURate cpu=overloadSlow writes=loadNormal bytes=loadNormal node=overloadSlow high_disk=false frac_pending=2.53,0.00(false)),src_sls:(store=overloadSlow worst=CPURate cpu=overloadSlow writes=loadNormal bytes=loadNormal node=overloadSlow high_disk=false frac_pending=0.00,0.23(false))]
[mmaid=0] result(failed): cannot shed from s1 to s2 for r3: delta load [cpu:230, write-bandwidth:0, byte-size:0]
[mmaid=0] considering lease-transfer r2 from s1: candidates are [1 2 3]
[mmaid=0] sortTargetCandidateSetAndPick: candidates: s2(loadNormal) s3(loadNormal), picked s3
[mmaid=0] can add load to n3s3: true targetSLS[(store=loadNormal worst=WriteBandwidth cpu=loadLow writes=loadNormal bytes=loadNormal node=loadLow high_disk=false frac_pending=0.00,0.00(true))] srcSLS[(store=overloadSlow worst=CPURate cpu=overloadSlow writes=loadNormal bytes=loadNormal node=overloadSlow high_disk=false frac_pending=0.00,0.23(false))]
[mmaid=0] result(success): shedding r2 lease from s1 to s3 [change:r2=[transfer_to=3 cids=3,4]] with resulting loads source:[cpu:540, write-bandwidth:0, byte-size:0] target:[cpu:353, write-bandwidth:0, byte-size:0] (means: [cpu:400, write-bandwidth:0, byte-size:0]) (frac_pending: (src:0.00,target:0.46) (src:2.53,target:0.00))
[mmaid=0] considering lease-transfer r1 from s1: candidates are [1 2 3]
[mmaid=0] sortTargetCandidateSetAndPick: candidates: s2(loadNormal) s3(loadNormal), picked s2
[mmaid=0] cannot add load to n2s2: due to !overloadedDimPermitsChange,target_summary(overloadSlow)>=loadNoChange,targetSLS.frac_pending(2.53or0.00>=epsilon),target-store(overloadSlow)>src-store(loadNormal)
[mmaid=0] [target_sls:(store=overloadSlow worst=CPURate cpu=overloadSlow writes=loadNormal bytes=loadNormal node=overloadSlow high_disk=false frac_pending=2.53,0.00(false)),src_sls:(store=loadNormal worst=WriteBandwidth cpu=loadLow writes=loadNormal bytes=loadNormal node=loadLow high_disk=false frac_pending=0.00,0.46(false))]
[mmaid=0] result(failed): cannot shed from s1 to s2 for r1: delta load [cpu:230, write-bandwidth:0, byte-size:0]
[mmaid=0] attempting to shed replicas next
[mmaid=0] excluding all stores on n1 due to overload/fd status
[mmaid=0] skipping r4: has pending changes
[mmaid=0] considering replica-transfer r3 from s1: store load [cpu:540, write-bandwidth:0, byte-size:0]
[mmaid=0] result(failed): no candidates found for r3 after exclusions
[mmaid=0] skipping r2: has pending changes
[mmaid=0] considering replica-transfer r1 from s1: store load [cpu:540, write-bandwidth:0, byte-size:0]
[mmaid=0] result(failed): no candidates found for r1 after exclusions
pending(4)
change-id=1 store-id=1 node-id=1 range-id=4 load-delta=[cpu:-230, write-bandwidth:0, byte-size:0] start=0s gc=1m0s
  prev=(replica-id=1 type=VOTER_FULL leaseholder=true)
  next=(replica-id=1 type=VOTER_FULL)
change-id=2 store-id=2 node-id=2 range-id=4 load-delta=[cpu:253, write-bandwidth:0, byte-size:0] start=0s gc=1m0s
  prev=(replica-id=2 type=VOTER_FULL)
  next=(replica-id=2 type=VOTER_FULL leaseholder=true)
change-id=3 store-id=1 node-id=1 range-id=2 load-delta=[cpu:-230, write-bandwidth:0, byte-size:0] start=0s gc=1m0s
  prev=(replica-id=1 type=VOTER_FULL leaseholder=true)
  next=(replica-id=1 type=VOTER_FULL)
change-id=4 store-id=3 node-id=3 range-id=2 load-delta=[cpu:253, write-bandwidth:0, byte-size:0] start=0s gc=1m0s
  prev=(replica-id=3 type=VOTER_FULL)
  next=(replica-id=3 type=VOTER_FULL leaseholder=true)
