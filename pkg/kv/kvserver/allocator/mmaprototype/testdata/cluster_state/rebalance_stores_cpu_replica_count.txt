# Set up the base scenario - four stores, replicas on first three, leases on s1, s3 overloaded.
include path=rebalance_stores_cpu_replica_include.txt
----
ok

# One replica gets moved, then we hit the count limit.
rebalance-stores store-id=1 max-range-move-count=1 fraction-pending-decrease-threshold=1.0
----
[mmaid=2] rebalanceStores begins
[mmaid=2] cluster means: (stores-load [cpu:525ns/s, write-bandwidth:0 B/s, byte-size:0 B]) (stores-capacity [cpu:1µs/s, write-bandwidth:1.0 kB/s, byte-size:1.0 kB]) (nodes-cpu-load 525) (nodes-cpu-capacity 1000)
[mmaid=2] evaluating s1: node load loadNormal, store load loadNormal, worst dim CPURate
[mmaid=2] evaluating s2: node load loadNormal, store load loadNormal, worst dim CPURate
[mmaid=2] evaluating s3: node load overloadUrgent, store load overloadUrgent, worst dim CPURate
[mmaid=2] store s3 was added to shedding store list
[mmaid=2] evaluating s4: node load loadLow, store load loadNormal, worst dim WriteBandwidth
[mmaid=2] start processing shedding store s3: cpu node load overloadUrgent, store load overloadUrgent, worst dim CPURate
[mmaid=2] top-K[CPURate] ranges for s3 with lease on local s1: r3:[cpu:100ns/s, write-bandwidth:0 B/s, byte-size:0 B] r2:[cpu:100ns/s, write-bandwidth:0 B/s, byte-size:0 B] r1:[cpu:100ns/s, write-bandwidth:0 B/s, byte-size:0 B]
[mmaid=2] attempting to shed replicas next
[mmaid=2] load summary for dim=CPURate (‹×›): overloadUrgent, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=WriteBandwidth (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=ByteSize (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): overloadUrgent, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): loadLow, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=WriteBandwidth (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=ByteSize (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): loadLow, reason: ‹×› [‹×›]
[mmaid=2] considering replica-transfer r3 from s3: store load [cpu:1µs/s, write-bandwidth:0 B/s, byte-size:0 B]
[mmaid=2] candidates are:
[mmaid=2]  s4: (store=loadNormal worst=WriteBandwidth cpu=loadLow writes=loadNormal bytes=loadNormal node=loadLow frac_pending=0.00,0.00(true))
[mmaid=2] sortTargetCandidateSetAndPick: candidates: s4(SLS:loadNormal, overloadedDimLoadSummary:loadLow), overloadedDim:CPURate, picked s4
[mmaid=2] load summary for dim=CPURate (‹×›): loadLow, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=WriteBandwidth (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=ByteSize (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): loadLow, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): overloadUrgent, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=WriteBandwidth (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=ByteSize (‹×›): loadNormal, reason: ‹×› [‹×›]
[mmaid=2] load summary for dim=CPURate (‹×›): overloadUrgent, reason: ‹×› [‹×›]
[mmaid=2] can add load to n4s4: true targetSLS[(store=loadNormal worst=WriteBandwidth cpu=loadLow writes=loadNormal bytes=loadNormal node=loadLow frac_pending=0.00,0.00(true))] srcSLS[(store=overloadUrgent worst=CPURate cpu=overloadUrgent writes=loadNormal bytes=loadNormal node=overloadUrgent frac_pending=0.00,0.00(true))]
[mmaid=2] applying replica change r3 type: ‹×› target store n4,s4 (‹×› type=VOTER_FULL)->(‹×› type=VOTER_FULL) to range 3 on store 4
[mmaid=2] addPendingRangeChange: change_id=‹×›, range_id=3, change=r3 type: ‹×› target store n4,s4 (‹×› type=VOTER_FULL)->(‹×› type=VOTER_FULL)
[mmaid=2] applying replica change r3 type: ‹×› target store n3,s3 (‹×›3 type=VOTER_FULL)->(‹×› type=VOTER_FULL) to range 3 on store 3
[mmaid=2] addPendingRangeChange: change_id=‹×›, range_id=3, change=r3 type: ‹×› target store n3,s3 (‹×›3 type=VOTER_FULL)->(‹×› type=VOTER_FULL)
[mmaid=2] result(success): rebalancing r3 from s3 to s4 [change: r3=[change_replicas=[{ADD_VOTER n4,s4} {REMOVE_VOTER n3,s3}]‹×›] with resulting loads source: [cpu:900ns/s, write-bandwidth:0 B/s, byte-size:0 B] target: [cpu:210ns/s, write-bandwidth:0 B/s, byte-size:0 B]
[mmaid=2] reached max range move count 1; done shedding
[mmaid=2] rebalancing pass summary [local=s1]:
	overloaded:
		short: [s3]
	success: [s3]
pending(2)
change-id=1 store-id=4 node-id=4 range-id=3 load-delta=[cpu:110ns/s, write-bandwidth:0 B/s, byte-size:0 B] start=5m0s gc=10m0s
  prev=(replica-id=none type=VOTER_FULL)
  next=(replica-id=unknown type=VOTER_FULL)
change-id=2 store-id=3 node-id=3 range-id=3 load-delta=[cpu:-100ns/s, write-bandwidth:0 B/s, byte-size:0 B] start=5m0s gc=10m0s
  prev=(replica-id=3 type=VOTER_FULL)
  next=(replica-id=none type=VOTER_FULL)
