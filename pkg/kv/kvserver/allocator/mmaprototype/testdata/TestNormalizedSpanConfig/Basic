# No replica constraint or voter constraints, and normalization adds the empty
# constraint.
normalize num-replicas=3 num-voters=3
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   :3
after:
 (unchanged)

# Voter constraint, no replica constraint, but have non-voters. Normalization
# promotes the voter constraint to a replica constraint, and adds the empty
# constraint to the replica constraints.
normalize num-replicas=5 num-voters=3
voter-constraint +region=a
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   :5
 voter-constraints:
   +region=a:3
normalizeVoterConstraints:
 (unchanged)
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=a:3
   :2
 voter-constraints:
   +region=a:3

# Two replica constraints don't specify replica counts, so normalization
# creates a conjunction of the constraints.
normalize num-replicas=3 num-voters=3
constraint +region=us-west -zone=us-west-b
constraint +zone=us-west-a
lease-preference +region=us-west +rack=10
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=us-west,+zone=us-west-a,-zone=us-west-b:3
 lease-preferences:
   +region=us-west,+rack=10
after:
 (unchanged)

# Two voter constraints don't specify voter counts, so normalization creates a
# conjunction of the constraints.
normalize num-replicas=3 num-voters=3
voter-constraint +region=us-west -zone=us-west-b
voter-constraint +zone=us-west-a
----
basic:
 num-replicas=3 num-voters=3
 voter-constraints:
   +region=us-west,+zone=us-west-a,-zone=us-west-b:3
after:
 (unchanged)

# Two replica constraints, one of which specifies a count, and another that
# does not. This is disallowed by roachpb.SpanConfig.
normalize num-replicas=5 num-voters=5
constraint num-replicas=1 -zone=us-west-b
constraint +zone=us-west-a
lease-preference +region=us-west +rack=10
----
err=cannot have zero-replica constraints mixed with non-zero-replica constraints

# Replica constraints and voter constraints are fleshed out by adding the
# empty conjunctions.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 -zone=us-west-b -zone=us-west-b +rack=10
constraint num-replicas=2 +zone=us-west-a
voter-constraint num-replicas=2 +zone=us-west-a
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +rack=10,-zone=us-west-b:1
   +zone=us-west-a:2
   :2
 voter-constraints:
   +zone=us-west-a:2
   :1
normalizeVoterConstraints:
 (unchanged)
after:
 (unchanged)

# Multi-region config with all specified voter constraints in one region, and
# one voter pinned to zone=a1.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 +region=b
constraint num-replicas=1 +region=c
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a -zone=a1
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +region=b:1
   +region=c:1
   :3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,-zone=a1:1
   :1
normalizeVoterConstraints:
 (unchanged)
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=b:1
   +region=c:1
   +region=a,-zone=a1:1
   +region=a,+zone=a1:1
   :1
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,-zone=a1:1
   :1

# Similar to previous, but with another constraint that does not intersect with the
# voter constraints.
#
# TODO(sumeer): we should return an error when there is non-determinism in
# promoting a replica constraint to a voter constraint, along with the
# best-effort normalization we have done, so that the operator can fix the
# config.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 +region=b
constraint num-replicas=1 +region=c
constraint num-replicas=1 +region=d
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a -zone=a1
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +region=b:1
   +region=c:1
   +region=d:1
   :2
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,-zone=a1:1
   :1
normalizeVoterConstraints:
 num-replicas=5 num-voters=3
 constraints:
   +region=b:1
   +region=c:1
   +region=d:1
   :2
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,-zone=a1:1
   +region=b:1
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=b:1
   +region=c:1
   +region=d:1
   +region=a,-zone=a1:1
   +region=a,+zone=a1:1
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,-zone=a1:1
   +region=b:1

# Simple multi-region config with voters in multiple regions.
normalize num-replicas=5 num-voters=5
constraint num-replicas=2 +region=a
constraint num-replicas=2 +region=b
constraint num-replicas=1 +region=c
voter-constraint num-replicas=2 +region=a
voter-constraint num-replicas=2 +region=b
voter-constraint num-replicas=1 +region=c
lease-preference +region=a
lease-preference +region=b
lease-preference +region=c
----
basic:
 num-replicas=5 num-voters=5
 constraints:
   +region=a:2
   +region=b:2
   +region=c:1
 voter-constraints:
   +region=a:2
   +region=b:2
   +region=c:1
 lease-preferences:
   +region=a
   +region=b
   +region=c
normalizeVoterConstraints:
 (unchanged)
after:
 (unchanged)

# Multi-region config with under-specified replica and voter constraints.
normalize num-replicas=9 num-voters=9
constraint num-replicas=1 +region=a
constraint num-replicas=1 +region=b
constraint num-replicas=1 +region=c
constraint num-replicas=1 +region=d
constraint num-replicas=1 +region=e
voter-constraint num-replicas=2 +region=f
lease-preference +region=f
----
basic:
 num-replicas=9 num-voters=9
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   :4
 voter-constraints:
   +region=f:2
   :7
 lease-preferences:
   +region=f
normalizeVoterConstraints:
 num-replicas=9 num-voters=9
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   :4
 voter-constraints:
   +region=f:2
   +region=e:1
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   :2
 lease-preferences:
   +region=f
after:
 num-replicas=9 num-voters=9
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   +region=f:2
   :2
 voter-constraints:
   +region=f:2
   +region=e:1
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   :2
 lease-preferences:
   +region=f

# Multi-region config with under-specified replica and voter constraints.
#
# TODO(sumeer): we should return an error when there is non-determinism in
# promoting a replica constraint to a voter constraint, along with the
# best-effort normalization we have done, so that the operator can fix the
# config.
normalize num-replicas=9 num-voters=7
constraint num-replicas=1 +region=a
constraint num-replicas=1 +region=b
constraint num-replicas=1 +region=c
constraint num-replicas=1 +region=d
constraint num-replicas=1 +region=e
voter-constraint num-replicas=2 +region=f
lease-preference +region=f
----
basic:
 num-replicas=9 num-voters=7
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   :4
 voter-constraints:
   +region=f:2
   :5
 lease-preferences:
   +region=f
normalizeVoterConstraints:
 num-replicas=9 num-voters=7
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   :4
 voter-constraints:
   +region=f:2
   +region=c:1
   +region=a:1
   +region=b:1
   :2
 lease-preferences:
   +region=f
after:
 num-replicas=9 num-voters=7
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   +region=d:1
   +region=e:1
   +region=f:2
   :2
 voter-constraints:
   +region=f:2
   +region=c:1
   +region=a:1
   +region=b:1
   :2
 lease-preferences:
   +region=f

# Two voter constraints are promoted to replica constraints.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 +region=b +zone=b2
constraint num-replicas=1 +region=c +zone=c2
voter-constraint num-replicas=1 +region=b +zone=b1
voter-constraint num-replicas=1 +region=a -zone=a1
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   :3
 voter-constraints:
   +region=b,+zone=b1:1
   +region=a,-zone=a1:1
   :1
normalizeVoterConstraints:
 (unchanged)
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=a,-zone=a1:1
   +region=b,+zone=b1:1
   :1
 voter-constraints:
   +region=b,+zone=b1:1
   +region=a,-zone=a1:1
   :1

# Multi-region with under-specified voter-constraint. In this case the
# under-specification is not the unconstrained set, but the conjunction
# "+region=b", which can be further narrowed.
normalize num-replicas=3 num-voters=3
constraint num-replicas=1 +region=b +zone=b2
constraint num-replicas=1 +region=c +zone=c2
constraint num-replicas=1 +region=d +zone=d2
voter-constraint num-replicas=2 +region=b
voter-constraint num-replicas=1 +region=c +zone=c2
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
 voter-constraints:
   +region=b:2
   +region=c,+zone=c2:1
normalizeVoterConstraints:
 num-replicas=3 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
 voter-constraints:
   +region=b:1
   +region=c,+zone=c2:1
   +region=b,+zone=b2:1
after:
 (unchanged)
err=could not satisfy all voter constraints due to non-intersecting conjunctions in voter and all replica constraints

# Similar to previous, but under-specified in a way that does not generate an
# error.
normalize num-replicas=4 num-voters=3
constraint num-replicas=1 +region=b +zone=b2
constraint num-replicas=1 +region=c +zone=c2
constraint num-replicas=1 +region=d +zone=d2
voter-constraint num-replicas=1 +region=e
voter-constraint num-replicas=1 +region=c
voter-constraint num-replicas=1 +region=d
----
basic:
 num-replicas=4 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
   :1
 voter-constraints:
   +region=e:1
   +region=c:1
   +region=d:1
normalizeVoterConstraints:
 num-replicas=4 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
   :1
 voter-constraints:
   +region=e:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
after:
 num-replicas=4 num-voters=3
 constraints:
   +region=b,+zone=b2:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1
   +region=e:1
 voter-constraints:
   +region=e:1
   +region=c,+zone=c2:1
   +region=d,+zone=d2:1

# Single-region very under-specified.
normalize num-replicas=9 num-voters=5
constraint num-replicas=3 +region=a +zone=a1
constraint num-replicas=3 +region=a +zone=a2
constraint num-replicas=3 +region=a +zone=a3
voter-constraint num-replicas=5 +region=a
----
basic:
 num-replicas=9 num-voters=5
 constraints:
   +region=a,+zone=a1:3
   +region=a,+zone=a2:3
   +region=a,+zone=a3:3
 voter-constraints:
   +region=a:5
normalizeVoterConstraints:
 num-replicas=9 num-voters=5
 constraints:
   +region=a,+zone=a1:3
   +region=a,+zone=a2:3
   +region=a,+zone=a3:3
 voter-constraints:
   +region=a,+zone=a1:2
   +region=a,+zone=a2:2
   +region=a,+zone=a3:1
after:
 (unchanged)

# Config from #106559.
normalize num-replicas=6 num-voters=5
constraint num-replicas=1 +region=eu-west-1
constraint num-replicas=1 +region=us-central-1
constraint num-replicas=1 +region=us-east-1
constraint num-replicas=1 +region=us-west-1
voter-constraint num-replicas=2 +region=us-west-1
voter-constraint num-replicas=2 +region=us-east-1
----
basic:
 num-replicas=6 num-voters=5
 constraints:
   +region=eu-west-1:1
   +region=us-central-1:1
   +region=us-east-1:1
   +region=us-west-1:1
   :2
 voter-constraints:
   +region=us-west-1:2
   +region=us-east-1:2
   :1
normalizeVoterConstraints:
 num-replicas=6 num-voters=5
 constraints:
   +region=eu-west-1:1
   +region=us-central-1:1
   +region=us-east-1:1
   +region=us-west-1:1
   :2
 voter-constraints:
   +region=us-west-1:2
   +region=us-east-1:2
   +region=eu-west-1:1
after:
 num-replicas=6 num-voters=5
 constraints:
   +region=eu-west-1:1
   +region=us-central-1:1
   +region=us-east-1:2
   +region=us-west-1:2
 voter-constraints:
   +region=us-west-1:2
   +region=us-east-1:2
   +region=eu-west-1:1

# Config from #122292. Note that the normalization over-specifies by adding a
# voter constraint for +region=a:1. Based on the original configuration,
# either +region=a:1 or +region=b:1 could be added, but we cannot express a
# disjunction.
normalize num-replicas=4 num-voters=3
constraint num-replicas=1 +region=a
constraint num-replicas=1 +region=b
constraint num-replicas=1 +region=c
voter-constraint num-replicas=2 +region=c
----
basic:
 num-replicas=4 num-voters=3
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   :1
 voter-constraints:
   +region=c:2
   :1
normalizeVoterConstraints:
 num-replicas=4 num-voters=3
 constraints:
   +region=a:1
   +region=b:1
   +region=c:1
   :1
 voter-constraints:
   +region=c:2
   +region=a:1
after:
 num-replicas=4 num-voters=3
 constraints:
   +region=a:1
   +region=b:1
   +region=c:2
 voter-constraints:
   +region=c:2
   +region=a:1

# A voter constraint that is missing from the replica constraints is promoted
# to a replica constraint during normalization, since voters are a subset of
# all replicas.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 +region=a +zone=a1
constraint num-replicas=1 +region=a +zone=a3
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a +zone=a2
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a3:1
   :3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
normalizeVoterConstraints:
 (unchanged)
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a3:1
   +region=a,+zone=a2:1
   :2
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1

# Unable to promote one of the voter constraints that is missing in the
# replica constraints, since the replica constraints are already full. An
# error is returned.
normalize num-replicas=5 num-voters=3
constraint num-replicas=1 +region=a +zone=a1
constraint num-replicas=1 +region=a +zone=a3
constraint num-replicas=3 +region=b
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a +zone=a2
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a3:1
   +region=b:3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
normalizeVoterConstraints:
 num-replicas=5 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a3:1
   +region=b:3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   +region=a,+zone=a3:1
after:
 (unchanged)
err=could not satisfy all voter constraints due to non-intersecting conjunctions in voter and all replica constraints

# Specify two constraints with no replicas. A conjunction will be created.
# Currently the normalization code does not error out on the fact that the
# conjunction has the same key and different values, so can never be
# satisfied.
#
# TODO(sumeer): improve the above.
normalize num-replicas=3 num-voters=3
constraint +region=a
constraint +region=b
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=a,+region=b:3
after:
 (unchanged)

# Replica constraints promoted to voter constraints and vice versa. The
# promotion to voter constraints uses the fact that +region=a covers the
# narrower constraints.
normalize num-replicas=3 num-voters=3
constraint num-replicas=1 +region=a +zone=a1
constraint num-replicas=1 +region=a +zone=a2
voter-constraint +region=a
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
 voter-constraints:
   +region=a:3
normalizeVoterConstraints:
 num-replicas=3 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
 voter-constraints:
   +region=a:1
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
after:
 num-replicas=3 num-voters=3
 constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   +region=a:1
 voter-constraints:
   +region=a:1
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1

# Same case as above but the constraints specified are reversed between voters
# and replicas.
#
# TODO(sumeer): investigate why the normalization does not promote the voter
# constraints to replica constraints.
normalize num-replicas=3 num-voters=3
constraint +region=a
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a +zone=a2
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=a:3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
normalizeVoterConstraints:
 num-replicas=3 num-voters=3
 constraints:
   +region=a:3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   +region=a:1
after:
 (unchanged)

# Replicas are not constrained. The voter constraints are promoted to replica
# constraints.
normalize num-replicas=5 num-voters=3
constraint num-replicas=5
voter-constraint num-replicas=1 +region=a +zone=a1
voter-constraint num-replicas=1 +region=a +zone=a2
----
basic:
 num-replicas=5 num-voters=3
 constraints:
   :5
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1
normalizeVoterConstraints:
 (unchanged)
after:
 num-replicas=5 num-voters=3
 constraints:
   +region=a,+zone=a2:1
   +region=a,+zone=a1:1
   :3
 voter-constraints:
   +region=a,+zone=a1:1
   +region=a,+zone=a2:1
   :1

# Regression test for out-of-bounds access bug when all relationships are
# conjPossiblyIntersecting. The voter constraint (+region=a,+zone=a1) and the
# all-replica constraint (+region=a,+zone=a2) share +region=a but differ in
# zone constraints, creating the only possibly intersecting relationship.
normalize num-replicas=3 num-voters=3
constraint num-replicas=3 +region=a +zone=a2
voter-constraint num-replicas=3 +region=a +dc=dc1
----
basic:
 num-replicas=3 num-voters=3
 constraints:
   +region=a,+zone=a2:3
 voter-constraints:
   +region=a,+dc=dc1:3
normalizeVoterConstraints:
 (unchanged)
after:
 (unchanged)
err=could not satisfy all voter constraints due to non-intersecting conjunctions in voter and all replica constraints
