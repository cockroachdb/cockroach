// Copyright 2023 The Cockroach Authors.
//
// Use of this software is governed by the CockroachDB Software License
// included in the /LICENSE file.

package mmaprototype

import (
	"time"

	"github.com/cockroachdb/cockroach/pkg/roachpb"
)

// Incoming messages for updating cluster state.

// StoreLoadMsg is periodically sent by each store.
type StoreLoadMsg struct {
	roachpb.NodeID
	roachpb.StoreID

	Load LoadVector
	// Capacity[CPURate] is derived based on considering the aggregate usage
	// across all stores, and using the utilization observed at the node, to
	// derive a node level capacity, and then dividing that by the number of
	// stores.
	Capacity      LoadVector
	SecondaryLoad SecondaryLoadVector

	LoadTime time.Time
}

// StoreLeaseholderMsg is sent by a local store and includes information about
// all ranges for which this store is the leaseholder. The range information
// includes other replica stores. This is a local message and will be sent
// before every allocator pass, so that the allocator has the latest state to
// make decisions.
type StoreLeaseholderMsg struct {
	roachpb.StoreID

	// Ranges provides authoritative information from the leaseholder.
	Ranges []RangeMsg
}

// RangeMsg is generated by the leaseholder store (and part of
// StoreLeaseholderMsg). All fields except for MaybeSpanConf are always
// populated. The MaybeSpanConf is populated if there is a possible change in
// the SpanConfig (including when this is a new leaseholder for the range),
// and is indicated by MaybeSpanConfIsPopulated being true. The optional
// population is done to avoid the expensive processing of a SpanConfig by
// MMA, on every message for the range.
//
// The main reason we always populate Replicas is to ensure that the allocator
// does not lose synchronization with the current set of replicas, due to
// spurious changes (we had one undiagnosed example where the allocator was
// spuriously told that a lease was transferred away).
type RangeMsg struct {
	roachpb.RangeID
	Replicas                 []StoreIDAndReplicaState
	RangeLoad                RangeLoad
	MaybeSpanConfIsPopulated bool
	MaybeSpanConf            roachpb.SpanConfig
}
