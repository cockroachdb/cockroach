debug "Test Setup"
----

set-closed-ts-override lag=1h
----

set-txn-expiration 3s
----

init num-nodes=3 intercept-on-nodes=1
----
n1, n2, n3

debug "Putting initial keys"
----

put account=1 balance=50
----

put account=2 balance=50
----

dump-accounts
----
key: /Table/100/1, value: /INT/50
key: /Table/100/2, value: /INT/50

debug "Splitting ranges"
----

split
----

split account=2
----

range-desc account=1
----
span: /Table/100{-/2}
voters: n1, n2, n3

range-desc account=2
----
span: /{Table/100/2-Max}
voters: n1, n2, n3

debug "Moving leases"
----

transfer-lease account=1 node-id=1
----

transfer-lease account=2 node-id=2
----

check-lease account=1
----
n1

check-lease account=2
----
n2

debug "Executing txn1's GetForUpdates"
----

new-txn name=txn1
----

exec-batch txn=txn1
  load-balances accounts=(1,2) for-update=true
----
key: /Table/100/1, value: /INT/50
key: /Table/100/2, value: /INT/50

debug "Jamming txn1's responses from n2"
----

jam-resp token=1 txn=txn1 src-node=1 dst-node=2
----

pause-req token=2 txn=txn1 method=HeartbeatTxn
----

async op=t1writes exec-batch txn=txn1 commit=true
  modify-balances accounts=1 delta=+10
  modify-balances accounts=2 delta=-10
  store-balances accounts=(1,2)
----

await op=t1writes timeout=10ms
----
t1writes: context canceled while awaiting

debug "Dumping accounts"
----

dump-accounts
----
key: /Table/100/1, value: /INT/60
key: /Table/100/2, value: /INT/40

debug "Releasing intercepts"
----

release token=1
----

# TODO(sarkesian): Note that the error below should not be the case!
# In the best case, we should see this transaction successfully commit,
# and in the worst case we should at least return an ambiguous error to the
# client.

await op=t1writes timeout=10ms
----
transaction unexpectedly committed, ba: Put [/Table/100/1,/Min), Put [/Table/100/2,/Min), EndTxn(commit) [/Table/100/1], [txn: ‹×›]. txn: "txn1" meta=‹×› lock=true stat=COMMITTED rts=‹×› wto=false gul=‹×› int=2 ifw=1: TransactionStatusError: already committed (REASON_TXN_COMMITTED)
