# In this test, we run the randomized testing framework with both the
# rand_ranges and rand_cluster options. We anticipate that the range_gen and
# cluster_gen configurations will change across iterations and runs.
#
# When a specific generator type is used, we expect the numbers generated to
# form a distribution. Due to limited sample size, it can be hard to observe the
# corresponding distribution pattern, but we can confirm that the parameters are
# set correctly and they look roughly accurate.
#
# Other parameters, such as replication factor and placement type should also be
# set and remain consistent across iterations.
rand_cluster cluster_gen_type=single_region
----

# We expect the placement of ranges across stores to be randomized with a
# replication factor of 3. Both range∈[1, 1000] and keyspace∈[1, 200000]
# configurations should be generated with an uniform distribution pattern across
# iterations.
rand_ranges placement_type=random replication_factor=3 range_gen_type=uniform keyspace_gen_type=uniform
----

eval duration=5m num_iterations=3 verbose=(all)
----
----
SETTINGS           num_iterations=3         duration=5m0s
rand_options       cluster=true             ranges=true                   load=false  staticSettings=false  staticEvents=false
rand_cluster=true  cluster_gen_settings ->  clusterGenType=single_region  
rand_ranges=true   range_gen_settings ->    placementType=random          replicationFactor=3  rangeGenType=uniform  keySpaceGenType=uniform  weightedRand=[]
rand_load=false
rand_events=false
rand_settings=false
----------------------------------
sample1: start running
CONFIG_GEN:
duration=[5m0s]
clusterGen=[loaded_cluster: region:US -> zones: US_1(nodes_count:1, stores_per_node:5) US_2(nodes_count:1, stores_per_node:5) US_3(nodes_count:1, stores_per_node:5)]
rangeGen=[placement_type=random, base_ranges=ranges=305, key_space=96760, replication_factor=3, bytes=0]
loadGen=[rw_ratio=0.00, rate=0.00, skewed_access=false, min_block_size=1, max_block_size=1, min_key=1, max_key=200000]
eventGen=[len(delayed_event_list)=0]
seed=[1926012586526624009]
STATE at 2022-03-21 11:00:00 +0000 UTC:
stores(15)=[s1n1=(replicas(38)),s2n1=(replicas(62)),s3n1=(replicas(87)),s4n1=(replicas(74)),s5n1=(replicas(98)),s6n2=(replicas(37)),s7n2=(replicas(111)),s8n2=(replicas(86)),s9n2=(replicas(61)),s10n2=(replicas(99)),s11n3=(replicas(25)),s12n3=(replicas(37)),s13n3=(replicas(25)),s14n3=(replicas(13)),s15n3=(replicas(62))] 
topology:
US
  US_1
    └── [1]
  US_2
    └── [2]
  US_3
    └── [3]

sample1: pass
----------------------------------
sample2: start running
CONFIG_GEN:
duration=[5m0s]
clusterGen=[loaded_cluster: region:US -> zones: US_1(nodes_count:5, stores_per_node:0) US_2(nodes_count:5, stores_per_node:0) US_3(nodes_count:5, stores_per_node:0)]
rangeGen=[placement_type=random, base_ranges=ranges=944, key_space=150098, replication_factor=3, bytes=0]
loadGen=[rw_ratio=0.00, rate=0.00, skewed_access=false, min_block_size=1, max_block_size=1, min_key=1, max_key=200000]
eventGen=[len(delayed_event_list)=0]
seed=[2643318057788968173]
STATE at 2022-03-21 11:00:00 +0000 UTC:
stores(15)=[s1n1=(replicas(191)),s2n2=(replicas(154)),s3n3=(replicas(38)),s4n4=(replicas(77)),s5n5=(replicas(344)),s6n6=(replicas(268)),s7n7=(replicas(345)),s8n8=(replicas(76)),s9n9=(replicas(76)),s10n10=(replicas(191)),s11n11=(replicas(0)),s12n12=(replicas(344)),s13n13=(replicas(307)),s14n14=(replicas(153)),s15n15=(replicas(268))] 
topology:
US
  US_1
    └── [1 2 3 4 5]
  US_2
    └── [6 7 8 9 10]
  US_3
    └── [11 12 13 14 15]

sample2: pass
----------------------------------
sample3: start running
CONFIG_GEN:
duration=[5m0s]
clusterGen=[loaded_cluster: region:US -> zones: US_1(nodes_count:5, stores_per_node:0) US_2(nodes_count:5, stores_per_node:0) US_3(nodes_count:5, stores_per_node:0)]
rangeGen=[placement_type=random, base_ranges=ranges=479, key_space=199954, replication_factor=3, bytes=0]
loadGen=[rw_ratio=0.00, rate=0.00, skewed_access=false, min_block_size=1, max_block_size=1, min_key=1, max_key=200000]
eventGen=[len(delayed_event_list)=0]
seed=[6972490225919430754]
STATE at 2022-03-21 11:00:00 +0000 UTC:
stores(15)=[s1n1=(replicas(80)),s2n2=(replicas(0)),s3n3=(replicas(120)),s4n4=(replicas(40)),s5n5=(replicas(80)),s6n6=(replicas(40)),s7n7=(replicas(180)),s8n8=(replicas(180)),s9n9=(replicas(160)),s10n10=(replicas(40)),s11n11=(replicas(180)),s12n12=(replicas(19)),s13n13=(replicas(39)),s14n14=(replicas(119)),s15n15=(replicas(160))] 
topology:
US
  US_1
    └── [1 2 3 4 5]
  US_2
    └── [6 7 8 9 10]
  US_3
    └── [11 12 13 14 15]

sample3: pass
----------------------------------
PLOT
sample1
 111 ┼─╮
 104 ┤ ╰╮
  98 ┼──╮─╮
  91 ┤  ╰──╮╮
  85 ┼────╮╰──╮
  78 ┤    ╰───╰──╮
  72 ┼─────╮  ╰─╰╰────╮
  65 ┤     ╰─╮    ╰─╭╭╮╭╮╭╭╮╮─╮─╭╮─╭────╮─────╭─╮─╭─╮─╮  ╭──╮  ╭──────╮     ╭────╮───
  59 ┼───╮───────╭╭────╯╰───────╯╰────────────────╯─╰────────────────────────────────
  52 ┤   ╰───╮╭───╯╯   ╰╯
  46 ┤     ╭╭╰╯╯╯
  39 ┼───╭───╯
  33 ┤  ╭╯╯
  26 ┼──│
  20 ┤╭─╯
  13 ┼╯
                                          replicas
sample2
 345 ┼───╮
 322 ┤  ╰╰─────╮
 299 ┼──────╮╰─╰─────╮
 276 ┼──╮──╮╰──────────────╮
 253 ┤  ╰────────────────╮─╰───────╮╮
 230 ┤                 ╰─╰─────────────────╮╮
 207 ┤                                    ╰╰─────────────────────────────────────────
 184 ┼─────────────────────────────────────────╭─────────────────────────────────────
 161 ┼─────────────────────────────────────────╯╯╯
 138 ┤                     ╭─────────╯╯
 115 ┤              ╭──────╯╯
  92 ┤   ╭─────╭────╯╯
  69 ┼───╯╯╭───╯
  46 ┼───╭─╯
  23 ┤ ╭─╯
   0 ┼─╯
                                          replicas
sample3
 180 ┼─╮╮
 168 ┤ ╰──╮╮
 156 ┼───────╮╮
 144 ┤       ╰───╮╮╮
 132 ┤           ╰───╮╮╮
 120 ┼───────╮      ╰╰────╮╮
 108 ┤   ╰───╰────────╮───╰───────╮
  96 ┤                ╰───────────╰──────────────────────────────────────────────────
  84 ┼─────────────────╭╭──────╯╯
  72 ┤             ╭────╯╯
  60 ┤       ╭─╭───╯
  48 ┤╭╭───────╯
  36 ┼─╯╭──╯
  24 ┼──╯╯
  12 ┤ ╭╯
   0 ┼─╯
                                          replicas
----
----

clear
----


# We expect the placement of ranges across stores to be equally allocated with a
# replication factor of 3. Range∈[1, 1000] should be generated with uniform
# distribution while and keyspace∈[1, 200000] configurations should be generated
# with zipf distribution across iterations.
rand_cluster cluster_gen_type=single_region
----

rand_ranges placement_type=even replication_factor=3 range_gen_type=uniform keyspace_gen_type=zipf
----

eval duration=5m num_iterations=3
----
----------------------------------
sample1: start running
sample1: pass
----------------------------------
sample2: start running
sample2: pass
----------------------------------
sample3: start running
sample3: pass
----------------------------------

clear
----

# We expect the placement of ranges across stores to be randomly allocated with
# a replication factor of 3. Both Range∈[1, 1000] and keyspace∈[1, 200000]
# should be generated with zipf distribution pattern across iterations.
rand_cluster cluster_gen_type=any_region
----

rand_ranges placement_type=random replication_factor=3 range_gen_type=zipf keyspace_gen_type=zipf
----

eval duration=5m num_iterations=3
----
----------------------------------
sample1: start running
sample1: pass
----------------------------------
sample2: start running
sample2: pass
----------------------------------
sample3: start running
sample3: pass
----------------------------------

clear
----

# We expect ranges to be randomly allocated across stores with a replication
# factor of 1. Assertion failures on some samples are expected due to this
# factor. When there is only one replica, the removal target in rebalancing is a
# leaseholder, it is locked into the current replica distribution. The
# rebalancer falls back to adding one replica, hoping the rebalancing would
# happen next time this range is checked. This can create a rebalancing
# deadlock, where settling is difficult.
# occurs.

rand_cluster cluster_gen_type=single_region
----

rand_ranges placement_type=random replication_factor=1
----

eval duration=20m num_iterations=3
----
----------------------------------
sample1: start running
sample1: pass
----------------------------------
sample2: start running
sample2: failed assertion
  conformance unavailable=0 under=0 over=0 violating=0 
  actual unavailable=0 under=0, over=9 violating=0
over replicated:
  r120:000001{8921-9080} [(n8,s8):2, (n15,s15):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r133:000002{0988-1147} [(n3,s3):2, (n5,s5):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r138:0000021{783-942} [(n3,s3):2, (n12,s12):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r156:0000024{645-804} [(n3,s3):2, (n2,s2):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r243:0000038{478-637} [(n3,s3):2, (n12,s12):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r322:0000051{039-198} [(n1,s1):2, (n3,s3):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r567:00000{89994-90153} [(n3,s3):2, (n5,s5):3] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r605:0000096{036-195} [(n3,s3):3, (n8,s8):4] applying ttl_seconds=0 num_replicas=1 num_voters=1
  r875:000013{8966-9125} [(n3,s3):3, (n2,s2):4] applying ttl_seconds=0 num_replicas=1 num_voters=1
----------------------------------
sample3: start running
sample3: pass
----------------------------------
