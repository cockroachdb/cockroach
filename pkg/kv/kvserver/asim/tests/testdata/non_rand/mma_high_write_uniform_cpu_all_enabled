# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 15905 ┤                            ╭╮
 14845 ┤                            ││
 13785 ┤ ╭─╭────╮╭╭──╭╮─╮╮╭╭──────╮ ││                        ╭╮╮
 12724 ┤╭│╭╯╭───│─╯  ││ ││││  │╰╯ │╭───╮                      │││
 11664 ┤│││││   │    ││ ││││  │   │││  │                      │││
 10604 ┤╭╮│╰─╭╮ │╮╭──│╰─╮──│╮╭╭───╭╯╭╮ │                      ││╭─╮
  9543 ┤│╰╯─────╰─────────────╮───│─╯╰─╰───────────────────────────────────────────────
  8483 ┤││  ││  ││   ││ ││    │   ││││ │                      │ │
  7423 ┤││  ││  ││   ││ ││    │   ││││ │                      │ │
  6362 ┤│╰──╰╯──╰────╯──────╮─╰───╯╰╰╯ │                      │ │
  5302 ┤││       │          │ │    │   │                      │ │
  4241 ┤││       │          │ │    │   │                      │ │
  3181 ┤│╰╮ ╭────╯          ╰─╯    ╰───╯                      ╰─╯
  2121 ┤│ │ │
  1060 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=9903 s2=10009 s3=9997 s4=9995 s5=10035 s6=9997 s7=10029 s8=10029 s9=9997 s10=9956]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮╭╮
 11207599 ┤│ │╭╮───╮
  9962310 ┤│ │││   │
  8717021 ┤│ ╰╯│╮  │╭──╮╭╮
  7471733 ┤│   │╭──╭╯──│││╭─╭╮─╭╮╭───╮╭╮╮  ╭╮
  6226444 ┤│   ╭───╯╭──│││─╭╯│╭──╭──╮╭────────────────────────────────────────────────────
  4981155 ┤│  ╭│╭──╯───╰╯╰─╯╭────╯──╰╯╰╯╭─╰─────╯
  3735866 ┤│╭─╭────────────╮│╰╯╰╯     ╰╯╯╯
  2490578 ┤╭╭─╯────────╯   ╰╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=5993615 s2=5996456 s3=5995384 s4=5992451 s5=6012062 s6=5990849 s7=5998942 s8=6010459 s9=6010363 s10=5990871]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮                                                                            ╭
 27.00 ┤ │                                                   ╭─────────────────────────
 25.00 ┤ ╰╮                                                  │────────────────────────╯
 23.00 ┤ ╰│         ╭╭╮                                      │╯
 21.00 ┤  │         │││╮  ╭╮      ╭╮╭╮ ╭╮                    │
 19.00 ┤  ╭─╮╭──╭───╭╮│──╭╮╭╮╭╮───╮╭╭────────────────────────╯
 17.00 ┤  │─╰───────╯│╭──╯╰──╯│───╮╭╯────────────────────────╯
 15.00 ┤ ╭│─╯╯  ╰╯──│╰╯─╯│╰╮│╯╰────╯╰╯─╰────╯────────────────╯
 13.00 ┤╭╭╯         ╰╯╯  ╰╯╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas

last store values: [s1=26 s2=28 s3=27 s4=25 s5=29 s6=28 s7=28 s8=27 s9=27 s10=28]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮                                                 ╭╮
 14.40 ┤   │                                                 │╰───────────────────────╭
 12.33 ┤   ╰╮           ╭╮ ╭╮           ╭╮                   ╭────────────────────────╯
 10.27 ┤    ╰────────╭╮╮│╰─╯╰───────╭╮──╯╰───────────────────│─────────────────────────
  8.20 ┤        ╭───╮││╰╯ ╭╭──────╮╭───╮─────────────────────╭─────────────────────────
  6.13 ┤  ╭─────╮───╭──────────────╯───╰─────────────────────╯╯╮───────────────────────
  4.07 ┤╭─╯─────╰───╯╯╯─╰╰─╰╯╯───╮─╰╯──╰────╯──────────────────────────────────────────
  2.00 ┼╯─╯─╯   ╰╯  ╰───────╯    ╰───────╯
                                             leases

last store values: [s1=14 s2=6 s3=9 s4=11 s5=5 s6=5 s7=9 s8=9 s9=14 s10=9]
----
----
