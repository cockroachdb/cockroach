# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 23446 ┤                                ╭╮
 21883 ┤                                ││
 20320 ┤     ╭──╮                       │╰╮                                          ╭╮
 18757 ┤     │  │                       │ │                                          ││
 17194 ┤    ╭╯  ╰───╮╭╮                 │ ╰─╭─╮                          ╭╮        ╭╮││
 15631 ┤    │       │││                 │  ╭╯ │                          ││        ││││
 14068 ┤ ╭──────╮╭──╭───╮╭╮╭─╮╭───╮╭──╮─╭╮ │  ╰────╮╮╭──╭╮╭╭──╭──╮╭───╮╭─╮╰──╭╮  ╭─╮│││
 12505 ┤╭│╰╯│  │││  │─╯╰││╭╯ ││╰─╮││╭╮│ │╭╮──╮╰╯╰╭╯│││──│╰╮││ │─╮││──╮││││╭╮ │╭──╯╭│╭│╭
 10941 ┤╭╯│││  │││  │││││╮│╭─╮│  ││││╰╭╮││││ │   │ │││ ││││││ │╭│││ ││││││││ ││╭─╮│││││
  9378 ┤╭───╮───────╮╭╭──────────────╮│╰─╯╰╮─╰────╭───────────╯──╰╯──╭╰────────╯─╰────╯
  7815 ┤││  │   ││╯ │││││││  ││  ││││││ │  │  │ ││││  │││││  │││ ││  ││   ││╭╮│ │││ ││
  6252 ┤│╰──╰─────────╯───────╯──────╰╯─╰──╰──────╯─╮─╰╯──╯──╮╰──╰───╯─╮╮ ╭─╯╰───╮╯╭─╰─
  4689 ┤││   │  ││       ││             ││ ││ │  ╰╮││ │      │    │    ││ │      │ │ ││
  3126 ┤│╰╮ ╭╰──╯╯       ╰╯             ╰╯ ╰──╯   ╰╯╰─╯      ╰────╯    ╰──╯      ╰─╯ ╰╯
  1563 ┤│ │ │
    -0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=6691 s2=10078 s3=6630 s4=6503 s5=9914 s6=9985 s7=13334 s8=13268 s9=6575 s10=13235]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──╮╭──╮
  9962310 ┤│ │╭╮│  ││  │                                      ╭╮
  8717021 ┤│ ╰╯│╯  ╰╯  │╭╮  ╭╮╭╮    ╭──╮   ╭╮╮      ╭╮ ╭╮     │╭╮              ╭╮
  7471733 ┤│   ╭───╮╭──╮╮──╭│╰╯╰╭╮──╭╮ │╭───╮╭─╭──╮─╮╮╭╯╭─╮╭╭─╮││╭╮╮ ╭─╭╮ ╭╮╭╮─╮╭╭╮╭╮╮╮╭─╭
  6226444 ┤│   ╭───╮╭──╮╭───╮╭╮─││╯╭╯╰╮╭╮───╮─╭│╯╭╰─╮╭─╮╭─╮─╭╮│╭─╮╭─────╮╭────╮╭──────╮╭──
  4981155 ┤│ ╭╭╯╭──╰╯──╰╯───╰╯╰─╯│╭─╮╭─╯╰──────╯───╯╰╯│╰╯─╰─╯╰─╯╯╰╯╯──╯─╰╯╯╰╯╯╰╯╰╰╰─╯╰╰╯╰╰
  3735866 ┤│╭╭╯╰╯──╭╮╭─╯╰╯ ╰╯╯╰─╰╰╯ ╰╯╯ ╰╰╯╰─╰╯─╰───╯ ╰─╯──────╯             ╰╰───╯╰╯  ╰╰╯
  2490578 ┤╭╭╯─────╯╰╯─╯╰╯
  1245289 ┤╭╯╯ ╰╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=4655730 s2=5323035 s3=5998042 s4=4334266 s5=5004322 s6=6995902 s7=6327793 s8=8007943 s9=4673662 s10=6647991]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│                                                                     ╭╮
 33.00 ┤│                                                                     ││╮     ╭
 31.00 ┤│╮                                                    ╭╮         ╭╭╮╭╮││╭╭╮╭╮╮╭
 29.00 ┤╰╮                                                    ││╭╮╭─╭╭─╮╮╭╭╮╭╮││││╰╮╭╮│
 27.00 ┤ │                                                   ╭╮─╭╮─────╭───╮││─╮╭──╮│╰│
 25.00 ┤ ╰╮             ╭╮                                   ││╭╯╰─────╯───││╰──╯│╭╰──╯
 23.00 ┤ ╰│     ╭╮  ╭╮  ││                ╭╮╮             ╭╮ │╰╯╯╰╰──╯╯│╯││╰╯╯│││╰╯╰│││
 21.00 ┤  │ ╭╮  ││  ││╮ ││   ╭╮╮╭╮╭╭╮ ╭╮╭╮│││     ╭╮╮╭╮╭─╮╯╭─││       ╰╯ ╰╯│  ╰╰╯   ╰╯╰
 19.00 ┤  ╰─╭────╮╭─╭╭──╮─╭╮╭╯│─╭╮╮╭─╮╮─╭─╮╭╭───╮╭╭╮╮││╭─╭╮│╭│╯           ╰╯
 17.00 ┤  ╭─────────╮│──╰─╯╰╯││╭╯╰─╯╭│╭─╯╮╰╮│───╰─╯╰─────╯╰──╯
 15.00 ┤ ╭╯     ╰╰╯─╰╯╯╭╰╯╰╯─│╰╯╯│╰╰╯╰╯╯╰╰─╰╯╯ ││╰╯╰╯╰╯╰╯╰─╰╯
 13.00 ┤╭│╯         ╰╯╰╯     ╰╯ ││  ╰╯   ╰╯╰╯  ╰╯ ╰╯     ╰╯
 11.00 ┤╭╯                      ╰╯
  9.00 ┼╯
                                            replicas

last store values: [s1=21 s2=27 s3=23 s4=25 s5=24 s6=34 s7=30 s8=33 s9=22 s10=31]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │
 14.40 ┤   │                                                  ╭──────╮ ╭╮ ╭╮  ╭─╮ ╭╮
 12.33 ┤   ╰╮                                                ╭╭──╮   ╰─╯╰─╯╰──╯╭╰─╯╰─╭╮
 10.27 ┤    ╰─────────╮                 ╭╭╮     ╭──╭╮        ╭─────╮╭──────────╮╭─╮╭╮│╰
  8.20 ┤  ╭─╮───╭───╮╭──╮╮╭─╭─╮──────────╯╰─────╯  │╰╭╮─╭──╮─│────╭───╮──╯────╰╰╭─╮───╭
  6.13 ┤ ╭╯─╰───────╮│──╰───╯─╰──────╮╭────╮─────────╯╰─╯╮╭╰─╭╮╯ ╰│───╰─────────╯╰╰───╯
  4.07 ┤╭╯╭─────╮───╰╯──╭╮─╯──╭─────╯╰╯╭╮╰╯╰─────────────────╯╰──╮│╯
  2.00 ┼╯─╯╯╰───╰───────╯╰────╯       ╰╯╰─╯        ╰╯   ╰╯       ╰╯
                                             leases

last store values: [s1=8 s2=12 s3=8 s4=8 s5=10 s6=10 s7=8 s8=10 s9=7 s10=9]
----
----
