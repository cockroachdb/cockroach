# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 20270 ┤        ╭──╮
 18919 ┤        │  │
 17568 ┤        │  │
 16216 ┤ ╭─╮    │  ╰───╮╭──╮
 14865 ┤ │ │    │      ││  │
 13513 ┤╭╭╭─╭──╮│╭─╮ ╭─╮────╭──────────────╮───╮╭──╮    ╭──────────────────────────────
 12162 ┤│││ │  │││ │ │ ││   │╯ ││  ││  ││  ││  ││  │    ││  │
 10811 ┤│││╮│  ╰╮│ │╭│╮││─╮╭│  ││  ││╭──│──│─╮ ││  │╭──╮││  │
  9459 ┤╭───╯╮─╰╰───────────╮──╰╭───────────────────────╮──────────────────────────────
  8108 ┤││   │  ││  │   ││  │   │   ││  │   │   │  ││   │   │
  6757 ┤│────╰──╯╰──╰───────╰───╯───╰───╯───╰───────╯   ╰──────────────────────────────
  5405 ┤││          │   │   │       │
  4054 ┤│╰╮  ╭─╮╭─╮ │   │   │       │
  2703 ┤│ │  │ ╰╯ ╰─╯   ╰───╯───────╯
  1351 ┤│ │  │
     0 ┼╯ ╰──╯
                                              cpu

last store values: [s1=9976 s2=9948 s3=10007 s4=10010 s5=9967 s6=13359 s7=10053 s8=9985 s9=9957 s10=6664]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 93337 ┤╭╮
 87115 ┤││
 80892 ┤╭╮
 74670 ┤││╮
 68447 ┤│││
 62225 ┤│╰╮  ╭─╮
 56002 ┤│ │──╯ ╰───╮
 49780 ┤│ ╰─╮     ╭╮
 43557 ┤│ │ ╰─────╯│╭──╮            ╭╮          ╭╮  ╭──╮
 37335 ┤│ ╰─╭╮─╭╮╭─││╯ │╭──╮╭──╭╭──╭╮│─╭╮──╭───╮││─╮│  ╰╮╭──╮   ╭───╮
 31112 ┤│  ╭╭───╮╭──╮──╭╭──╮╭──────╯│╭─╮╭───────╮───╭────╯──╰───╯───╰──────────────────
 24890 ┤│ ╭─╯╭──╰╯─╭╰───╯──╰╯───────╰╯─││───────╰───╯───╯──╯───────────────────────────
 18667 ┤│╭╯╭╮╭─╮╭──╯╮╭──╯  ╰╯──────────╰╯──╯╯       ╰──╯
 12445 ┤╭╯─╯╰╯─╰╯──╯╰╯
  6222 ┤│╯─╯
     0 ┼╯╯
                                     write_bytes_per_second

last store values: [s1=29993 s2=30133 s3=29881 s4=30010 s5=30028 s6=26650 s7=29987 s8=30002 s9=29957 s10=33335]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 36.96 ┤│
 34.92 ┤│
 32.88 ┤│╮
 30.83 ┤╰╮
 28.79 ┤ │
 26.75 ┤ │
 24.71 ┤ ╰╮
 22.67 ┤  │╭╮  ╭╮              ╭╮          ╭╮   ╭╮
 20.63 ┤  ╰╭───╮╭╮─╭╮╭─╭╮──╭╮  │╭──╮╭╮─╭╭───────╮│ ╭╭───╮   ╭───╮──╮
 18.59 ┤  ╭╯───╰────╮──│╭──────╮───╭╮╭─╮│───────╰───╯───│╭──╮───╭──────────────────────
 16.55 ┤ ╭│────────╯╰───╯──╰╯──╰───╯╰╯─╰╯──╮╭───────╰───╰╯─╯╰───╯──────────────────────
 14.50 ┤ ╭╯        ╰╯  │╰───╯  ╰╯  ╰╯╰─╰╯  ╰╯  ││╯ ╰╯
 12.46 ┤╭╯             ││                      ╰╯
 10.42 ┤│              ││
  8.38 ┼╯              ╰╯
                                            replicas

last store values: [s1=18 s2=19 s3=17 s4=18 s5=19 s6=17 s7=17 s8=18 s9=19 s10=18]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ │
 22.67 ┤ ╰╮
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮
 14.40 ┤   │
 12.33 ┤   │
 10.27 ┤   ╰───╭───────╮
  8.20 ┤   ╭───╮    ╰──╰───╭───╮───╭────────────────────╮╭──╮──────────────────────────
  6.13 ┤ ╭╭│───╰─────────────────────────────────────────╯──╰──────────────────────────
  4.07 ┤╭──╯───╰───────╯╮──╰╯──╭────╯  ╰───╰───────────────────────────────────────────
  2.00 ┼╯╯╯╯   ╰───╯╰──╯╰──╯╰──╯────────────────────╯      ╰───────────────────────────
                                             leases

last store values: [s1=5 s2=6 s3=3 s4=6 s5=7 s6=7 s7=8 s8=7 s9=4 s10=7]
----
----
