# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 20152 ┤                              ╭╮   ╭───────╮╭╮─╮   ╭─╮ ╭╮
 18808 ┤                              ││   │       │││ │   │ │ ││        ╭╮
 17465 ┤                              ││   │      ╭│││ │   │ │ ││    ╭─╮ ││   ╭╮
 16121 ┤    ╭───╮                 ╭╮  │╰─╮╮│      │╰╯╰─────╯─╰╮│╰───╮│ ╭─╭───╮│╰──╮
 14778 ┤    │   │                 ││  │ ││││      │││         ││  ││││ │ │   │││  │
 13434 ┤╭╭─────╮╮╭─────╮──╭╭─╮╭───╮╰╭╭╮──╰─╯──╮  ╭╮╭╮╭╮╭─╭╮   ╭╮──╮╰╰──╯╭│───╰╯╭──╰─╮╮╭
 12091 ┤│││││  │││     │  │││││ │ │││││ ││││  │  │││││││ ││   ││ ││   │ ││    ││  │││││
 10748 ┤╭╮│╰─╮ ╰╭╯   ╭─│ ╭╭│╭╭╯───╰───╮╭╭╮──╭╮│╮╭─╮│││││╮││   ││ ╭╮╭╮ ╭─╯│    ││╭─│││││
  9404 ┤│╰──╮───│──────╰─╮─╯╭╯───────╯││││╭─╯╰──╮─╭╯╰─────────╯╰──────╮─╮│╭───────────╯
  8061 ┤││  │   │    │   ││ ││ │ │││  ││││││  │││││╮│││  │││ │ ││││  ││╭│││ │ │││││││││
  6717 ┤│╰──╰───╯────────╰──╯╰───╯╰─╮╮╰─╯╰╯╰────╰─╯─╭────╯───╮╭╰─╯│╭──╰───╯─────╯╭──╯╰╰
  5374 ┤││       │        │ │    ╰╯ │││ │         │ │        ││   ││  │  │       │││
  4030 ┤│╰╮ ╭╮   │        │ │       │││ ╰╮ ╭╮     ╭╮│        ╭╯   ││  │  │       │││
  2687 ┤│ │ │╰───╯        ╰─╯       ╰─╯─╯│╭╯╰─────╯││     ╭──╯╮   ╰╯╭─╯  ╰─╮   ╭─╯╰╯
  1343 ┤│ │ │                            ││       │││    ╭╯   │     │      │   │
     0 ┼╯ ╰─╯                            ╰╯       ╰╰╯────╯    ╰─────╯      ╰───╯
                                              cpu

last store values: [s1=10018 s2=10049 s3=9813 s4=10004 s5=10165 s6=9950 s7=9825 s8=6664 s9=6668 s10=13233]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──╮         ╭╮
  9962310 ┤│ │ ╰╯  │     ╭╮  ││            ╭╮
  8717021 ┤│ ╰─╮   ╭╭──╮ ││ ╭╯╰──╮         ││ ╭╮ ╭╭╮                       ╭╮      ╭╮╭╮
  7471733 ┤│   ╭────╯──╰╮││╮╭─╮  ╭╭╭╮─╮╭╭╮╭╭╮─╮╭╮─│╰╮╮╭╮ ╭─╮─╭─╮╭─╮╭╮╮╭─╭╮╮│╰────╮╭╮╭─╭╮╭╮
  6226444 ┤│   │╯──│───╰╰╯╰──────╮╭╯│╭─╭╯╰─╯│╮╰╯╭╮──╭╮│╰───╮╭╯╮╰─╮╮│╰────╭╮─╭╮╭───────╯╰╮╮
  4981155 ┤│ ╭╭╯╰──│╭──╮││╭│╰────╰╯─╰──╯│╰╯╯╰───╯│╭─╯╰╯╯╯╰╯╰╯────│╰╯╯╰╯│╭╯╰─╯╰╯╰──╮─╭╮╭╮╰╮
  3735866 ┤│╭╭╯╯───╰╯──╰───╯││╮╭╯╰││╰╯╰─╰╯╰───╯╯╰╰╯─╯╰╮│   ╰╯    ╰──────╯╰─╰─╯╰──╮╰╮│╰╯╰─╰
  2490578 ┤╭╭╯─╯───╰╯──╯╰─╯ ╰╯╰╯  ╰╯                  ╰╯                         ╰╯╰╯╰╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=4647944 s2=5973596 s3=4986419 s4=6638736 s5=3650434 s6=5322714 s7=5325266 s8=3999189 s9=4970363 s10=4320595]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│                                                      ╭╮       ╭╮╭╮  ╭╮╭╮╭╮╭─╮
 31.00 ┤│╮                                                    ╭╮╭╮╮╮ ╭╮╭╮╭╮│ ╭╭╮╭╮│╭╮╮│
 29.00 ┤╰╮                                                    ╭╮│││╭╮╭╮╯╭╮│╭╭─╯╰╯│╮││╭╮
 27.00 ┤ │                                                   ╭│╰╭╮╭─╮│╰╮││╰╭╯╮╮│╰╰─╯╰╮╭
 25.00 ┤ ╰╮                                                  ╭│╭╯╰╯│╰╯╯╰╯╰─╯───╮╮││╭╮││
 23.00 ┤ ╰│          ╭╮               ╭╮ ╭╮    ╭╮ ╭╮         ╭╭╯─╯╰╯│││╯╰╯╯╯╯│╰╰─╯│││╰╯
 21.00 ┤  │     ╭╮  ╭╮╭╮╭╮╮╮╭╮╭╭╮╭╮╮╭╭╮│╮│╭╮╮╭╮││ ││ ╭╮╭─╮╮  ╭╯╯   ╰╯╰╯ ╰╯   ╰╯╰╰╯╰╯││╰
 19.00 ┤  ╰─╭───╭───╮╮││││─╮╮╭╮││╭╮─╭╭╮╭╭╮╭───╮╭╮─╭──╮───╮╭─╮│╰╯                  ││╰╯
 17.00 ┤  ╭────╮│───╰─╯│╯╭───╯││╰╮╭──╯│╭╯╰╯│╰─│││╭╯──│─╰╭╭╯─╰╯                    ╰╯
 15.00 ┤ ╭╯    ╰╯───╰╯╯╰─╯╯│╰╰╰╯─╰╯─╯│╰╯╯╰╯╯│╰╰╯╰╯│││╰───╯──╯╯
 13.00 ┤╭│╯     ││  ╰╯  ╰╯╰╯     ╰╯  ╰╰╯╰╯ ╰╯  ╰╯╰╯╰╯
 11.00 ┤╭╯      ╰╯  ╰╯
  9.00 ┼╯
                                            replicas

last store values: [s1=26 s2=28 s3=26 s4=34 s5=21 s6=29 s7=24 s8=26 s9=28 s10=28]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │                                                      ╭╮
 14.40 ┤   │                                                 ╭╮──╮││ ╭─╮      ╭─────╮─╮
 12.33 ┤   ╰─╮          ╭─╮       ╭╮                         ││  ╰╭─────╮╭────╯ ╭╮─╭╰─╮
 10.27 ┤     ╰──╮╭──╮╭──╯ ╰───╭───╯╰╮ ╭─╮    ╭─╭╮ ╭─╭╮─╭─────╭─╮╭─╯╭──╯╰││╰───╮────╮╭╮│
  8.20 ┤  ╭─────────╮╮╮ ╭╮╭──╭╮╭──╮╯╰─╭╮╰──╭─╮╭╭──╭╮│╰─╯─╭╮╭─╯╭╭─╮╰╭╮╭─╮╭╯╰─╯─│──╭──╮╰╰
  6.13 ┤ ╭╯╭╮╭──╮───│─╭╮╭╮╯╭─╯╰╯──╰───╮╭╭╮─╯╯╰─╯──│╰╮────╯╰╯─╯╭╯╰╰─╯╰╯─╰╯──╯╰─╰──╯╮╭│╭─
  4.07 ┤╭╯╭╯╰╯──╰───╰─╯╰╯╰─╯─│╰╭────╯╰╰─╯╰────────╯╯╰─────────╯─╯ ╰╰╯╰╰╯╯╰──╯─╰╯─╰─╯╰╯
  2.00 ┼╯─╯╯   ╰────╯╰╯ ╰╯───╰─╯╯╰╰╰────╯╰────────╯───────────╯╯
                                             leases

last store values: [s1=7 s2=12 s3=9 s4=12 s5=9 s6=8 s7=10 s8=9 s9=6 s10=8]
----
----
