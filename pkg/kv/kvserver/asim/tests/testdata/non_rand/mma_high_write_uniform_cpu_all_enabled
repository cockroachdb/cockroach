# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 19935 ┤     ╭──╮
 18606 ┤     │  │
 17277 ┤     │  │╭──╮╭╮            ╭╮╭──╮
 15948 ┤    ╭╯  ╰╯  │││            │╰╯  │
 14619 ┤    │       │││            │    │
 13290 ┤╭╭──────╮╭──╭───╮╭╭───╭╮───╯╭╮  ╰─╮
 11961 ┤│││││  │││  │││││││  │││ │  ││    │
 10632 ┤╭─╮╭╮──╭────╮╮╭─────────────╯╰╮╭───────────────────────────────────────────────
  9303 ┤│╰╰─╮──╯││─╯│╭││││╰──╮││╰╭──╯╰╰╯──╭╰──╯╰─────────╯  ╰──╯───╰───────────────────
  7974 ┤││  │   ││╯ ││││││   │││ │ │││    │
  6645 ┤│╰──╰─────────╯──╮   ╭╯╰─╯──│╯   ╭╯
  5316 ┤││   │  ││       │   │      │    │
  3987 ┤│╰╮ ╭│ ╭╯│       ╰───╯      ╰────╯
  2658 ┤│ │ │╰─╯─╯
  1329 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=9997 s2=10010 s3=9991 s4=10012 s5=9989 s6=9979 s7=9955 s8=10074 s9=10037 s10=9975]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──╮╭──╮
  9962310 ┤│ │╭╮│  ││  │
  8717021 ┤│ ╰╯│╯  ╰╯  │╭╮       ╭╮
  7471733 ┤│   ╭───╮╭──╮╮──╮╭╮──╮││╮╭╮╭╮╮╭╮
  6226444 ┤│   ╭───╮╭──╮╭────────╮╭───╮─╮╭───╮─╭──────────────────────────────────────────
  4981155 ┤│ ╭╭╯╭──╰╯──╰╯──╯╯───│╰╯╯─╰╰──╯───╰─╯
  3735866 ┤│╭╭╯╰╯──╭╮╭─╯╰╯ ╰╯   ╰╯╯      ╰╯
  2490578 ┤╭╭╯─────╯╰╯─╯╰╯
  1245289 ┤╭╯╯ ╰╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=5993137 s2=6011448 s3=6012255 s4=5663879 s5=6323367 s6=5997076 s7=6010559 s8=5993747 s9=5995332 s10=5996010]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮
 27.00 ┤ │                                                   ╭╭────────────────────────
 25.00 ┤ ╰╮                                                  ╭╯────────────────────────
 23.00 ┤ ╰│     ╭╮  ╭╮                                       │╯
 21.00 ┤  │ ╭╮  ││  ││╮ ╭╮   ╭╭╮  ╭╭╮                        │
 19.00 ┤  ╰─╭────╮╭─╭╭──╮│───╭╮╭───╮╮─╭───╮╭╭────────────────╯
 17.00 ┤  ╭─────────╮│──╰────╯╰╯───╰──╯╯─╰╰─╯────────────────╯
 15.00 ┤ ╭╯     ╰╰╯─╰╯╯╭╰╰╰──╯─╯╰─╯│╰─╯╰──╯ ╰────────────────╯
 13.00 ┤╭│╯         ╰╯╰╯      ╰╯  ╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas

last store values: [s1=27 s2=28 s3=28 s4=27 s5=27 s6=25 s7=28 s8=28 s9=27 s10=28]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │
 14.40 ┤   │                                                                          ╭
 12.33 ┤   ╰╮                                                ╭────────────────────────╯
 10.27 ┤    ╰─────────╮                                      │─────────────────────────
  8.20 ┤  ╭─╮───╭───╮╭──╮╮    ╭╮──────────╮─╭────────────────╯
  6.13 ┤ ╭╯─╰───────╮│──╰──────────╮╭╮╭───╮─╯────────────────╭─────────────────────────
  4.07 ┤╭╯╭─────╮───╰╯──│────╮╭╰─╯─╰╯╰╯──╰╰──────────────────╯─────────────────────────
  2.00 ┼╯─╯╯╰───╰───────╯    ╰╯      ╰────╯
                                             leases

last store values: [s1=11 s2=5 s3=13 s4=11 s5=5 s6=13 s7=14 s8=5 s9=7 s10=7]
----
----
