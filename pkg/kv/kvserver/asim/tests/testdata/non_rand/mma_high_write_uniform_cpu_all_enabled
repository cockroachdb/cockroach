# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 23434 ┤                          ╭──────╮
 21872 ┤                          │      │
 20310 ┤                          │      ╰╮               ╭╮
 18747 ┤                          │       │               ││
 17185 ┤                        ╭─╯       ╰─╮             │╰─╮           ╭╮   ╭╭──╮
 15623 ┤                        │           │             │  │           ││   ││  │
 14061 ┤ ╭─╭────╮          ╭─╮  │─╮        ╭│╭──╮         │  │╭╮╭─╮╮   ╭╮╭────╮│╭─│╮ ╭╭
 12498 ┤╭│╭╯╭───│    ╭──╮ ╭╯ │  │ │      ╭╮│╰────╮        │  ╰─╭──╮│  ╭│││  │││││ ╰╮─││
 10936 ┤╭╯│││╭╮ │   ╭│  │ │  │  │ │      │││││  ╰│        │╭╮ ││││││  ││││  │││││ ││ ││
  9374 ┤╭─╯─────╰─────────╮──╭──╯─╮─╭╮───╯╰──│───╰───────────╮╭╯──╰────╮╭─────╮───╭───╮
  7811 ┤││  ││  ││   │   ││  │ ││ │ │││    │ │   ││       ││ │││  │ │ ││││ │  │││ │ │││
  6249 ┤│╰──╰───╯╯   ╰───╯╰──╯ ╰─────────────╯────╯       ╰──╰╯╯──╯─╯ ╰╰╯╰─╯──╰───╯─╯╰╰
  4687 ┤││      ╭╯                                            │   │         │ │  ││
  3125 ┤│╰╮ ╭───╯                                             ╰───╯         ╰─╯  ╰╯
  1562 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=9872 s2=10028 s3=9924 s4=9904 s5=9899 s6=9897 s7=6636 s8=10021 s9=13480 s10=6632]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮╭╮╭──╮
 11207599 ┤│ │╭╮╯  │
  9962310 ┤│ │││   │
  8717021 ┤│ ╰╯│   │            ╭╮                                                 ╭╮
  7471733 ┤│   │╮  │╭──╮╮──╮╭╮╭╮││ ╭╮─╮  ╭─╭─╮╭╮╭─╮╮╮ ╭─╭───╮╭╮   ╭╮   ╭─╭╮    ╭╮╭╭─╭╮╮╭╮╭
  6226444 ┤│   ╭╭───╯──│╭─────╯╰│╰╮││─╭╮──╮╭╮╭╯╰╮─╰╭───╭─╮───╯╰───╮╭────────╭─╮─╭───╯╰╮╭──
  4981155 ┤│  ╭╭╯──╰╰──│╭───────╯─╰╯│╭╯│╭╮╰╭╮╯╰╯╰──╯─╯╭╯─│─╯╭───────────────╯╰╰─╯─╯│╰╰╰╯╯│
  3735866 ┤│╭─╭────╮╭───╯  ╰╯╰╯ ╰╯  ╰╯ ╰╯╰─╯╰─────────╯  ╰──╯╰╯         ╰╯     ╰╯╯╯╰╯    ╰
  2490578 ┤╭╭─╯────╰╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=6354367 s2=5534234 s3=5324708 s4=7204394 s5=4999153 s6=6016900 s7=5660703 s8=7203053 s9=4320924 s10=6012002]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│                                                                             ╭
 33.00 ┤│                                                            ╭╮         ╭╭╮╭╮ │
 31.00 ┤│╮                                                          ╭││         ││╰╮╭╮│
 29.00 ┤╰╮                                                       ╭──╮│╭╮╭╭─╮╮╭╮╭─╭╮│││╭
 27.00 ┤ │                                                    ╭╭╮────╭─╮─│╯╰╮│╰╮╭││╮│╭─
 25.00 ┤ ╰╮                                                  ╭╭╯╰────╯│╰─╯╮╰╰╯╰╰─╯╰╮╭╯╮
 23.00 ┤ ╰│         ╭╮                                       ╭╯╭╯  ╰╰╯│  ╰╰─╰╯╯││││╰╯│╰
 21.00 ┤  │ ╭╮      ╭╮  ╭╮╮  ╭╮ ╭╮    ╭╮  ╭╮        ╭╮      ╭│╰╯     ╰╯       ╰╯╰╯╯ ╰╯
 19.00 ┤  ╭─╮╭──╭───╭─────╮──││╮││╭╮╭╭╮─╭╮╮╭╮╭─╮╮╭╭╭╯│─╮╮╮╭──╯
 17.00 ┤  │─╰───────╯│──╭│╰╮╭╯│╭╯││╰╮│╰─╯╰─────────╯─╰╮──╭╯──╯
 15.00 ┤ ╭│─╯╯──││  ││──╯╰╯╰╯│╰╯╰││╯││╯╯╰╯ ╰╯╰─╯╰╯╯ ╰╯│╭─╯╯ ╰╯
 13.00 ┤╭╭╯     ╰╯  ╰╯       ╰╯  ╰╯ ╰╯                ╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas

last store values: [s1=28 s2=28 s3=25 s4=35 s5=24 s6=26 s7=25 s8=29 s9=23 s10=27]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮
 14.40 ┤   │                                                  ╭╮╭─╭─╮                ╭╮
 12.33 ┤   ╰──╮ ╭╮             ╭╮                            ╭────╯─╰─╭─╮╭──╮╭╮─╮╭───╯╰
 10.27 ┤      ╰─╯╰───────╮╭────╯╭╮╭──────╮                   │╯╭──╮   │ ╰╯╭──╯╰────╮╭╮╭
  8.20 ┤            ╭╮  ╭────╭╮╭╯╰╯    ╰─╰──╮────╭──╮─╭──────╭╭───╮───────╯╯ ╭───╭─────
  6.13 ┤  ╭─────╮───╭────────╯╰╯────────────╰─────────╮───╮╮╭─╯─╯─╰──────────────╯╰────
  4.07 ┤╭─╯─────╰───╯───╯─╯──╰╯───╰╯─────╰──╰╯─╮─╭────╰─────╯╯╯╭╰─╯   ╰╰────╯╰─╯──╰╯
  2.00 ┼╯─╯─╯   ╰╯              ╰╯╰──╰──╯      ╰─╯       ╰╯─╯ ╰╯
                                             leases

last store values: [s1=8 s2=8 s3=10 s4=6 s5=13 s6=10 s7=10 s8=7 s9=10 s10=8]
----
----
