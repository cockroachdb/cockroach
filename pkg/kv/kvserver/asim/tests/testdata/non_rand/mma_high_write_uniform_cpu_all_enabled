# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 16772 ┤                  ╭╮                                                ╭╮╭╮
 15654 ┤                  ││                                                ││││
 14536 ┤                  ││                                                ││││
 13418 ┤╭╭╭─────╮╭──╮╭───╮│╰─╮╭──────╮                                 ╭╮ ╭╮╭─│╰─╮╮╭╮╭╮
 12300 ┤│││││   ││  ││   ││││││      │                                 ││ │││││  ╰╮││││
 11182 ┤│││││   ││  ││   ││││││      │                                 ││ │││││  ││││││
 10063 ┤╭─╯─────╰─────────╮──╭──────────────────────────────────────────────╮─╯──╭───╯╰
  8945 ┤││  │   ╭╮  ││   ││││││       │                               │ ││ │││ ││││││││
  7827 ┤││  │   ││  ││   ││││││       │                               │ ││ │││ ││││││││
  6709 ┤│╰──╰───────╯────╯╰──╯╰───────╯                               ╰─╯╰─╯╰────╯╯╰╯╰─
  5591 ┤││   │                                                              │    │
  4473 ┤││   │                                                              │    │
  3354 ┤│╰╮ ╭╯                                                              ╰────╯
  2236 ┤│ │ │
  1118 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=10051 s2=10090 s3=10108 s4=10136 s5=6671 s6=9928 s7=9958 s8=6679 s9=9947 s10=9889]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮╭╮
 11207599 ┤│ │╭╮ ╭─╮
  9962310 ┤│ │││╮╯ │
  8717021 ┤│ ╰╯││  │                                                           ╭╮ ╭╮╮╭╮
  7471733 ┤│   │╰──╭───╮╭╭─╮ ╭╮─╭╮                                   ╭╮   ╭╮╭╮╭╮│╭─╮││╭╭╮╭
  6226444 ┤│   ╭───╯───│────╭╮──╭──────────────────────────────────────────╮─╭╯╰───╮╭─╮─╭╮
  4981155 ┤│  ╭│─╯─╰───│╭╭──╯╰──╯╯──╯╰───╯                            ╰╯  ╰╰─╯╰─╰╯─╰╯╰╰─╯╰
  3735866 ┤│╭─╭────────╮╭╯      ╰╯                                            ╰╯         ╰
  2490578 ┤╭╭─╯─╯      ╰╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=5991371 s2=5663111 s3=6681900 s4=8004676 s5=3660328 s6=4994707 s7=7195558 s8=5664723 s9=6187683 s10=5540118]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│                                                                   ╭╮ ╭╮╮    ╭
 31.00 ┤│╮                                                        ╭╮   ╭╮ ╭╮││╮│││╭╭╭╮│
 29.00 ┤╰╮                                                    ╭╭─╮││──╮╭╮╮╮╭╮│╭╮╭╭─╮││╭
 27.00 ┤ │                                                    ╭───╮╭──╭╯│─╭╯│─╭─╮│╭│─╭╮
 25.00 ┤ ╰╮                                                  ╭╯───╰───╯─╰─╯╯╰─╯╯╰╯╯╰─╯╰
 23.00 ┤ ╰│                                                  │╯        ╰╯╯│╰╯││╰╰╯││╰╯╰
 21.00 ┤  │ ╭╮               ╭╮                              │╯        ││ │││╰╯  ╰╰╯
 19.00 ┤  ╭─╮╭──╭───╮╭────╮──╭───────────────────────────────╯         ╰╯ ╰╯╯
 17.00 ┤  │─╰────────╯──╮│╰──╯╰──────────────────────────────╯
 15.00 ┤ ╭│─╯   ╰───╰╯──╰─╯╰──╯──────────────────────────────╯
 13.00 ┤╭╭╯         ╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas

last store values: [s1=24 s2=27 s3=29 s4=33 s5=23 s6=26 s7=29 s8=26 s9=27 s10=26]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮                                                               ╭╮
 14.40 ┤   │                                                 ╭────╮╭────╮  │╰╮ ╭╮ ╭────
 12.33 ┤   ╰╮   ╭╮                                           │╭──╭╰─────╮─╭─╮╰─╯╰╭─╮─╭╮
 10.27 ┤    ╰───╯╰───────╮                                 ╭─╯───╯ ╰────╰─╯─╰────╯─╰─╯╰
  8.20 ┤            ╭╮   ╭╮──╭─────────────────────────────╯─╭─────────────╮╭─╭╮╭─╮╭│╰╭
  6.13 ┤  ╭─────╮───╮╭───╯╰──╯───────────────────────────────╯─────────╯╰──╰╯─│╰──────╯
  4.07 ┤╭─╯─────╰────╯────╯──╭────────────────────────────────────────────────╯─╯    ╰╯
  2.00 ┼╯─╯─╯╰──╯   ╰────────╯
                                             leases

last store values: [s1=11 s2=7 s3=8 s4=14 s5=7 s6=9 s7=7 s8=8 s9=8 s10=11]
----
----
