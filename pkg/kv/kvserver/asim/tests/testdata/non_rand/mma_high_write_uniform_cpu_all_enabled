# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu
----
 0.00 ┼───────────────────────────────────────────────────────────────────────────────
                                             cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)

plot stat=write_bytes_per_second
----
 37358663 ┤╭╮
 34868086 ┤╭╮
 32377508 ┤││
 29886931 ┤╭╮╮
 27396353 ┤│││
 24905776 ┤│╰╮─╮
 22415198 ┤│╰│ │
 19924620 ┤│ │╭╮╭──╮
 17434043 ┤│ ╰╯││  │
 14943465 ┤│   ╭───╭╮──╮
 12452888 ┤│  ╭╮───│╭─────────────────────────────────────────────────────────────────────
  9962310 ┤│ ╭╯╭────╯────────────────────────────────────────────╯────────────────────────
  7471733 ┤│╭╭─╯╯  ╰╯╰────────────────────────────────────────────────────────────────────
  4981155 ┤╭─╯─╯
  2490578 ┤│╯╯
        0 ┼╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=13317939, s2=11987959, s3=13362518, s4=11992070, s5=8692515, s6=12657029, s7=13314213, s8=9754738, s9=11598162, s10=13321114] (stddev=1537528.65, mean=11999825.70, sum=119998257)

plot stat=replicas
----
 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│╮
 31.00 ┤││
 29.00 ┤╰╮                                                    ╭────────────────────────
 27.00 ┤ │                                                   ╭╭────────────────────────
 25.00 ┤ ╰╮                                                  ╭╯────────────────────────
 23.00 ┤ ╰│                                                  │╯
 21.00 ┤  │     ╭╮                                           │╯
 19.00 ┤  ╭─╮───╭╭───────────────────────────────────────────╯
 17.00 ┤  ╭──────╯───────────────────────────────────────────╯
 15.00 ┤ ╭╯─╰───╯╯╰─────────────────────────────────────────╯
 13.00 ┤╭╯      ╰╯
 11.00 ┤│╯
  9.00 ┼╯
                                            replicas
initial store values: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
last store values: [s1=29, s2=27, s3=27, s4=25, s5=27, s6=26, s7=27, s8=26, s9=28, s10=28] (stddev=1.10, mean=27.00, sum=270)

plot stat=leases
----
 33.00 ┼╮
 30.94 ┤╰╮
 28.88 ┤ │
 26.82 ┤ │
 24.76 ┤ ╰╮
 22.70 ┤  │
 20.64 ┤  │
 18.58 ┤  ╰╮
 16.52 ┤   │
 14.46 ┤   │                                                  ╭────────────────────────
 12.40 ┤   │                                                 ╭╭────────────────────────
 10.34 ┤   ╰─────────────────────────────────────────────────╭╯────────────────────────
  8.28 ┤        ╭────────────────────────────────────────────╭─────────────────────────
  6.22 ┤  ╭╭╮───╭────────────────────────────────────────────╭─────────────────────────
  4.16 ┤╭──╯╰────────────────────────────────────────────────╯╯
  2.10 ┼╯─╯╯╯
                                             leases
initial store values: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
last store values: [s1=14, s2=9, s3=9, s4=6, s5=10, s6=6, s7=8, s8=12, s9=9, s10=7] (stddev=2.41, mean=9.00, sum=90)
