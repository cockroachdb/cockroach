# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 16995 ┤ ╭╮     ╭──╮╭──╮ ╭──╮       ╭───╮       ╭──╮
 15862 ┤ │╰╮    ││ ││  ╰╮╯  │       │   │       │  │
 14729 ┤ │ │    ││ ││   │   │       │   │       │  │
 13596 ┤╭╭╭╮╭──╮│╯ ╰╭──╮╰───╭───╮───╭──╮╭───╮───│  ╰───────────╮╭───╮──╮
 12463 ┤││││││ ││   │  ││   │─╯││  ││  ││   │   │           │  ││   │  │
 11330 ┤││││││ ││   │  ││   │  ││  ││  ╰╮   │   │           │  ││   │  │
 10197 ┤╭───╯╯─╰────────────╯───╰───╮───╰───╭──────────────────────────────────────────
  9064 ┤││  │   │   │   │   │   │   │   │   │   │  │        │  │        │
  7931 ┤││  │   │   │   │   │   │   │   │   │   │  │        │  │        │
  6798 ┤│───╰╮──│───│╭──╯───│───╭───╰───────╯───╯──╯────────╰──╯────────╯
  5665 ┤││   │  ││  ││      │   │
  4532 ┤││   │  │╯  ││      │   │
  3399 ┤│╰╮  ╰──╰───╰╯──────╰───╯
  2266 ┤│ │  │
  1133 ┤│ │  │
     0 ┼╯ ╰──╯
                                              cpu

last store values: [s1=10007 s2=9940 s3=10091 s4=9923 s5=9966 s6=9987 s7=9986 s8=9931 s9=9965 s10=10013]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 93337 ┤╭╮
 87115 ┤││
 80892 ┤╭╮
 74670 ┤││╮
 68447 ┤│││
 62225 ┤│╰╮  ╭─╮
 56002 ┤│ │╮ │ ╰───╮
 49780 ┤│ ╰╮╭╯     │
 43557 ┤│ │╰───╮╭──╮
 37335 ┤│ ╰╭╮╭─╭╯  ╰╭──╮╭───╮   ╭──╮╭──╮╭──╮╭──╮   ╭╮  ╭╭──╮╭───╭──────╮
 31112 ┤│  ││──╯─╮──╭───╯╭──│───╯──╰│──╰╮───────╭───────╯──│╭──╭╮───────╭──────────────
 24890 ┤│ ╭╯╰───────╯╭──────╰───────╯───│──╭────╯───────╰──╰───╯╰───────╯──╯╰──────╰───
 18667 ┤│╭╯╭╮╭─────╯╰╯─────╯            │  │            ╰──╯╰───╯
 12445 ┤╭╯─╯╰╯─╮╭───╯                   ╰──╯
  6222 ┤│╯───╯ ╰╯
     0 ┼╯╯
                                     write_bytes_per_second

last store values: [s1=30011 s2=30058 s3=29921 s4=29854 s5=30087 s6=33274 s7=26750 s8=30021 s9=29945 s10=30025]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮
 27.00 ┤ │
 25.00 ┤ │╮
 23.00 ┤ ╰╮╭╮
 21.00 ┤  │││      ╭╮                      ╭╮
 19.00 ┤  ╰││──╭╭──╭╮──╮╭───╮───╭──╮╭──╮───││──╭╮───╭──╮╭──╮╭───╮──╮───╮╭──────────────
 17.00 ┤  ╭╯╰───────╮───╭───────────╯──╰───╯│──╭───╮╯──╰│──││──╯╰───────╯──────────────
 15.00 ┤ ╭╯╰╯  │╰╯─╰╰───╯  ╰╯  ╰╯──╯╰───────╰──╯│──╰────╯──╰╯──╯╯
 13.00 ┤╭╯ ╰╯  ╰╯                              ╰╯
 11.00 ┤│╯
  9.00 ┼╯
                                            replicas

last store values: [s1=17 s2=17 s3=19 s4=18 s5=19 s6=19 s7=17 s8=17 s9=18 s10=19]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ │
 22.67 ┤ ╰╮
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮
 14.40 ┤   │
 12.33 ┤   │╭╮
 10.27 ┤   ╰╯╰──────╮   ╭───╭───────╮   ╭───╮
  8.20 ┤   ╭╮  ╭╮──╭───╮╭───╯──╭╮──╭╰───╯───╰───╭───╮───────╮  ╭────────╭──────────────
  6.13 ┤ ╭╭│╰──╮╭──╭╮──╭────────╮───╭───────╭───╯───╰───────────────────╯──────────────
  4.07 ┤╭──╯─╯─╰───╯╰──╯───────╮╰───────╮──╭╯──╮│──╯───╯╰──╯╯──╰────────────╯──────╰───
  2.00 ┼╯╯╯─╯╰─╰───╯╯  ╰───╯╰──╰╯  ╰╯──╯╰──╯   ╰╯──╯
                                             leases

last store values: [s1=6 s2=5 s3=5 s4=6 s5=5 s6=7 s7=5 s8=7 s9=6 s10=8]
----
----
