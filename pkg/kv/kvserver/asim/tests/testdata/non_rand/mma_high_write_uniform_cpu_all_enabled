# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 23446 ┤                                ╭╮
 21883 ┤                                ││
 20320 ┤     ╭──╮                       │╰╮                                 ╭╮
 18757 ┤     │  │                       │ │                                 ││
 17194 ┤    ╭╯  ╰───╮╭╮                 │ ╰─╭─╮                          ╭──╯╰╭─╮
 15631 ┤    │       │││                 │  ╭╯ │                          │    │ │
 14068 ┤ ╭──────╮╭──╭───╮╭╮╭─╮╭───╮╭──╮─╭╮ │  ╰────╮╮╭──╭╮╭╭──╭───╮╭─╮   │   ╭╯╮╰╮──╮──
 12505 ┤╭│╰╯│  │││  │─╯╰││╭╯ ││╰─╮││╭╮│ │╭╮──╮╰╯╰╭╯│││──│╰╮││ │──│││─│   │   │╰│││─╯│──
 10941 ┤╭╯│││  │││  │││││╮│╭─╮│  ││││╰╭╮││││ │   │ │││ ││││││ │╭╮││╭╮│   │╭╮ │ ││││││
  9378 ┤╭───╮───────╮╭╭──────────────╮│╰─╯╰╮─╰────╭───────────╯───╰╯╰────────╯─╭╯╰─╮╰──
  7815 ┤││  │   ││╯ │││││││  ││  ││││││ │  │  │ ││││  │││││  │││  │   │  ││││││││ ╭││
  6252 ┤│╰──╰─────────╯───────╯──────╰╯─╰──╰──────╯─╮─╰╯──╯──╮╰───╯╮ ╭╯  ╰─╰───╯──╯╰───
  4689 ┤││   │  ││       ││             ││ ││ │  ╰╮││ │      │   │ │ │         ╰╮ │
  3126 ┤│╰╮ ╭╰──╯╯       ╰╯             ╰╯ ╰──╯   ╰╯╰─╯      ╰───╯ ╰─╯          ╰─╯
  1563 ┤│ │ │
    -0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=9999 s2=6673 s3=13219 s4=13309 s5=10011 s6=10106 s7=9924 s8=10002 s9=9998 s10=6627]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──╮╭──╮
  9962310 ┤│ │╭╮│  ││  │                                      ╭╮
  8717021 ┤│ ╰╯│╯  ╰╯  │╭╮  ╭╮╭╮    ╭──╮   ╭╮╮      ╭╮ ╭╮     │╭╮                        ╭
  7471733 ┤│   ╭───╮╭──╮╮──╭│╰╯╰╭╮──╭╮ │╭───╮╭─╭──╮─╮╮╭╯╭─╮╭╭─╮││╭╮╮╭╮     ╭─╮╭╮╮╭╮╮╭─╮╮╭╮
  6226444 ┤│   ╭───╮╭──╮╭───╮╭╮─││╯╭╯╰╮╭╮───╮─╭│╯╭╰─╮╭─╮╭─╮─╭╮│╭─╮╭──╮╭──────╮─────╮─╭╭─╮╭
  4981155 ┤│ ╭╭╯╭──╰╯──╰╯───╰╯╰─╯│╭─╮╭─╯╰──────╯───╯╰╯│╰╯─╰─╯╰─╯╯╰╯╯─╰╯────╰╯╰───────╮│╯╰─
  3735866 ┤│╭╭╯╰╯──╭╮╭─╯╰╯ ╰╯╯╰─╰╰╯ ╰╯╯ ╰╰╯╰─╰╯─╰───╯ ╰─╯──────╯             ╰╰╯     ╰╯
  2490578 ┤╭╭╯─────╯╰╯─╯╰╯
  1245289 ┤╭╯╯ ╰╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=5409571 s2=8996098 s3=5996224 s4=4716130 s5=6658022 s6=5320799 s7=5981794 s8=5004090 s9=5728713 s10=5349094]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│                                                                             ╭
 35.00 ┤│                                                                             │
 33.00 ┤│                                                                             │
 31.00 ┤│╮                                                    ╭╮ ╭╮       ╭╮╮╭╭╮╭╮╭╮╭╮│
 29.00 ┤╰╮                                                    ││╭──────╮╮╭─╮╮─││╮╭╮││╰╮
 27.00 ┤ │                                                   ╭╮─╭─────────╮││╭╭─╮─╭──╮─
 25.00 ┤ ╰╮             ╭╮                                   ││╭╯╰──────╯╰╰───╯╰╰─╯╭╯╰─
 23.00 ┤ ╰│     ╭╮  ╭╮  ││                ╭╮╮             ╭╮ │╰╯ ╰╯ ╰╯╰─╰╯│╰╰╯╰╰╯╯╰╯│╰╯
 21.00 ┤  │ ╭╮  ││  ││╮ ││   ╭╮╮╭╮╭╭╮ ╭╮╭╮│││     ╭╮╮╭╮╭─╮╯╭─││           ││        ││
 19.00 ┤  ╰─╭────╮╭─╭╭──╮─╭╮╭╯│─╭╮╮╭─╮╮─╭─╮╭╭───╮╭╭╮╮││╭─╭╮│╭│╯           ││        ╰╯
 17.00 ┤  ╭─────────╮│──╰─╯╰╯││╭╯╰─╯╭│╭─╯╮╰╮│───╰─╯╰─────╯╰──╯            ╰╯
 15.00 ┤ ╭╯     ╰╰╯─╰╯╯╭╰╯╰╯─│╰╯╯│╰╰╯╰╯╯╰╰─╰╯╯ ││╰╯╰╯╰╯╰╯╰─╰╯
 13.00 ┤╭│╯         ╰╯╰╯     ╰╯ ││  ╰╯   ╰╯╰╯  ╰╯ ╰╯     ╰╯
 11.00 ┤╭╯                      ╰╯
  9.00 ┼╯
                                            replicas

last store values: [s1=29 s2=37 s3=26 s4=26 s5=25 s6=23 s7=28 s8=24 s9=26 s10=26]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │
 14.40 ┤   │                                                  ╭───╮                  ╭╮
 12.33 ┤   ╰╮                                                ╭╭──╮╰───────────╮╭─────╯╰
 10.27 ┤    ╰─────────╮                 ╭╭╮     ╭──╭╮        ╭────╮────────╮╯─╭╮╰───╭─╮
  8.20 ┤  ╭─╮───╭───╮╭──╮╮╭─╭─╮──────────╯╰─────╯  │╰╭╮─╭──╮─│───╮╰────────╮──╭─╮────╮╰
  6.13 ┤ ╭╯─╰───────╮│──╰───╯─╰──────╮╭────╮─────────╯╰─╯╮╭╰─╭╮╯╰╰╭───────────╯─╰─────╮
  4.07 ┤╭╯╭─────╮───╰╯──╭╮─╯──╭─────╯╰╯╭╮╰╯╰─────────────────╯╰───╯                   ╰
  2.00 ┼╯─╯╯╰───╰───────╯╰────╯       ╰╯╰─╯        ╰╯   ╰╯
                                             leases

last store values: [s1=9 s2=14 s3=11 s4=10 s5=13 s6=9 s7=6 s8=7 s9=6 s10=5]
----
----
