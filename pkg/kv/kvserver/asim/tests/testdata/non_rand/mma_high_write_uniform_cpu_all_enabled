# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 16879 ┤    ╭───╮╭──╮                                              ╭─╮ ╭──╮╭╮
 15754 ┤    │   ││  │                                              │ │ │  │││
 14629 ┤    │   ││  │                                              │ │ │  │││
 13504 ┤╭╭──────╭╮╭─╮╭╮──╮╭──╮╭──╮                            ╭╮╮╭─╯ │╭╮  ╰│╰╮─╮╭╭───╮╭
 12378 ┤│││││  ││││ │││ │││  ││  │                            │││││  │││   │││││││   ││
 11253 ┤│││││  ││││ │││ │││  ││  │                            │││││  ╰╮│   │││││││   ││
 10128 ┤╭───╮───╭────╯╰───────────────────────────────────────╮──╭─────────╮────╭╯───╰─
  9002 ┤││  │   │   ││ │││   │   ││                          ││ │││││││ │  │ ││││     │
  7877 ┤││  │   │   ││╭╯││   │   ││                          ││ │││││││ │  │ ││││     │
  6752 ┤│╰──╰───╯────╯──╯╰╮  ╭───╯╯                          ╰╰──╯╯╯╰╯╰─╯──╰────╯─────╰
  5626 ┤││       │        │  │                                                ││
  4501 ┤││       │        │  │                                                ││
  3376 ┤│╰╮ ╭────╯        ╰──╯                                                ╰╯
  2251 ┤│ │ │
  1125 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu

last store values: [s1=13133 s2=9883 s3=10025 s4=9927 s5=9953 s6=10015 s7=9961 s8=10015 s9=6673 s10=9992] (stddev=1445.36)
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──╮╭──╮
  9962310 ┤│ │╭╮╯  ││  │
  8717021 ┤│ ╰╯│   ││  │ ╭─╮                                         ╭╮               ╭╮
  7471733 ┤│   ╭───╭───╮╭╮ ╰╮ ╭╮╭╮                                 ╭╭╮╭╮╭─╮╭─╮╭─╮╭╭╭─╮╮╭╮╭
  6226444 ┤│   ╭╮──│╯╰─│││──╭──────────╮╭─╮──╭───────────────────────────╮╭────────╮─╭╮───
  4981155 ┤│ ╭╭╯╰──╯╮──││╰──╯╰─────────╰╯─╰──╯─╯                 ╰╯╰╯╰╰╯╰╰╯╰─╯╰──╯─╰─╯╰╮╭─
  3735866 ┤│╭╭╯╭────╰──╰╯╯                                             ╰╯╰╯      ╰╯    ╰╯╰
  2490578 ┤╭╭╯─╯╭──────╯
  1245289 ┤╭╯╯ ╰╯
        0 ┼╯
                                        write_bytes_per_second

last store values: [s1=7664219 s2=5994993 s3=5645356 s4=4654569 s5=4325040 s6=5335894 s7=5675217 s8=7669542 s9=6019173 s10=4983653] (stddev=1070760.28)
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│                                                         ╭╮                  ╭
 33.00 ┤│                                                         ││ ╭╮╭╮             ╭
 31.00 ┤│╮                                                        │╭╮│╭╮╭╮ ╭╮  ╭╭╮ ╭╭╭╯
 29.00 ┤╰╮                                                    ╭╮╭╭╮│││╭╮│╭╭╮│╮╭╮││╭╮╭││
 27.00 ┤ │                                                    ╭╭─╮│╭──╮╭──╯╰─╮╭─╮╭╯╰╮──
 25.00 ┤ ╰╮                                                  ╭╭╯╯╰─╯─╯╰╯───╯╰╰╯─││╰╯╰──
 23.00 ┤ ╰│         ╭╮                                       ╭╯  │╰╯│╰╯╰╰╯╰╯  ╰╰╰╯╰╯╯│╭
 21.00 ┤  │     ╭╮  ╭╭╮  ╭╮                                 ╭│╯  ╰╯ ╰╯ ╰╯         ╰╯ ╰╯
 19.00 ┤  ╰─╮╭──││──│││─╭─╮──╮╮──╭───╭──────────────────────╭╯
 17.00 ┤  ╭──╮──╭───╮││─╯╭─────────────╮─╭──────────────────╯╯
 15.00 ┤ ╭╯  ╰──╯╯╯ ││╰──╯│   ╰──────╰─╰─╯──╯────────────────╯
 13.00 ┤╭│╯         ╰╯   ╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas

last store values: [s1=36 s2=28 s3=26 s4=22 s5=23 s6=25 s7=27 s8=33 s9=27 s10=26] (stddev=4.05)
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │
 14.40 ┤   │                                                  ╭╮╭╮
 12.33 ┤   ╰─╮                                               ╭╭╮╭╮───╮          ╭╮ ╭╮╭─
 10.27 ┤     ╰──╭───╮╭╮──────────╮  ╭─╮                     ╭─╯╰╯╰───────────────────╮╮
  8.20 ┤  ╭─╮──╭╯╭──╰╯╰────────────────╮─╭──────────────────╯╭╭──╯╰╯╰──────╮──╰─╯╰╮─╯╰─
  6.13 ┤ ╭╯─╰──╯╭───╮╮╯─╭────────╭─────╰─╯───────────────────╭╯───╯─╰╯╭╯╰─╯╰────╮─╭╮─╭╯
  4.07 ┤╭╯╭─────╯───╰────────────────────────────────────────╯╯╭──────╯         ╰─╯╰─╯
  2.00 ┼╯─╯╯╰───╯╰──╰╯─────────────────────────────────────────╯
                                             leases

last store values: [s1=13 s2=6 s3=10 s4=10 s5=8 s6=9 s7=6 s8=8 s9=12 s10=9] (stddev=2.17)
----
----
