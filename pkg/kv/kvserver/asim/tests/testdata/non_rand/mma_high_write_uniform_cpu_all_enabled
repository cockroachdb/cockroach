# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 20270 ┤        ╭──╮
 18919 ┤        │  │
 17568 ┤        │  │
 16216 ┤ ╭─╮    │  ╰───╮    ╭──╮                            ╭──╮
 14865 ┤ │ │    │      │    │  │                            │  │
 13513 ┤╭╭╭─╭──╮│╭─╮╭╭─╮───╮│  ╰╭──╮╭───╭───╭──╮╭──╮        │╭─╰╭──╮╭╭─╮╭──────────╮
 12162 ┤│││ │  │││ │││ ││  ╰╮   ││ │╮   │  ││  ││  │        ││  │  │││ ││          │
 10811 ┤│││╮│  ╰╮│ │╭│╮││  ││╭╮╭││ ││   │  ││  ││  │        ││  │  │││╭││          │
  9459 ┤╭───╯╮─╰╰───────────────────────╮───│──╰─────────────────────╯─╰───────────────
  8108 ┤││   │  ││  │   │       │   │   │   │   │   │       │   │   ││ ││           │
  6757 ┤│────╰──╯╰──╯───╯───────╰───╰───╰───╯───╯───╯       ╰───╯───╯──╯╯───────────╯
  5405 ┤││          │                                               ││
  4054 ┤│╰╮  ╭─╮╭─╮ │                                               ││
  2703 ┤│ │  │ ╰╯ ╰─╯                                               ╰╯
  1351 ┤│ │  │
     0 ┼╯ ╰──╯
                                              cpu

last store values: [s1=10003 s2=9919 s3=9899 s4=9963 s5=10101 s6=9970 s7=10067 s8=9959 s9=10040 s10=9977]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 93337 ┤╭╮
 87115 ┤││
 80892 ┤╭╮
 74670 ┤││╮
 68447 ┤│││
 62225 ┤│╰╮  ╭─╮
 56002 ┤│ │──╯ ╰───╮
 49780 ┤│ ╰─╮     ╭╮╭──╮
 43557 ┤│ │ ╰─────╯││  │         ╭─╮        ╭──╮
 37335 ┤│ ╰─╭╮─╭╮╭─││  ╭╭──╮╭──╮╮╯ ╭───╭╮──╮╯  ╭╭───╮    ╭─╮╭╮ ╭╭──╭╮──╮
 31112 ┤│  ╭╭───╮╭──╮╭─╮╯──│╭──────╭╮───╭──╮────╮──╭╭──────────╮╮╮──╭──────╭───────────
 24890 ┤│ ╭─╯╭──╰╯─│╰╮─╰╭──────────╯╰───╯──││──╰╭───╯──╰─╯─╰─╯─╰───────────╯─╯─────╯
 18667 ┤│╭╯╭╮╭─╮╭──╯╰╰──╯──╰╯      ╰╯╰─╯╰──╰────╯
 12445 ┤╭╯─╯╰╯─╰╯──╯
  6222 ┤│╯─╯
     0 ┼╯╯
                                     write_bytes_per_second

last store values: [s1=29969 s2=30089 s3=29884 s4=30019 s5=29938 s6=30065 s7=29921 s8=30032 s9=29997 s10=29993]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮
 27.00 ┤ │
 25.00 ┤ │╮                                ╭╮
 23.00 ┤ ╰╮                                ││
 21.00 ┤  │╭╭╮ ╭╭╮ ╭╮  ╭╮  ╭╮      ╭╮╮ ╭╮  ││  ╭╮      ╭╮  ╭╮      ╭╮
 19.00 ┤  ╰╭─────────╮──╭───────╮──╭╮╰─││──╮╭──╮╭───╭──╮│╭──╭──╮╮───╭──────╭╮──────────
 17.00 ┤  ╭╯───────╯│╰──╯───────╰──╯╰───────╮──╰╭───────────╯╯─╰───────────────────────
 15.00 ┤ ╭╯╰─╰─╰╯╰─╯││ ││──╰╯  ╰─╯─╰───╯╯  ╰╰───╯──╰╯───╯╰─╰╯╰─╮│╰──╯──╯   ╰╯
 13.00 ┤╭╯         │╰╯ ││  ╰╯      ╰╯  ╰╯  ╰╯              ╰╯  ╰╯  ╰╯
 11.00 ┤│╯         ╰╯  ╰╯
  9.00 ┼╯
                                            replicas

last store values: [s1=18 s2=17 s3=19 s4=18 s5=18 s6=18 s7=18 s8=19 s9=17 s10=18]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ │
 22.67 ┤ ╰╮
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮
 14.40 ┤   │
 12.33 ┤   │                               ╭╮
 10.27 ┤   ╰───╭───────╮╮  ╭────╮   ╭╮     │╰───────────────╮  ╭╮   ╭──────────────────
  8.20 ┤   ╭───╮    ╭╭─╮────────╮──╭────────╮──╮   ╭╮───╮  ╭────╮──╭───────╮
  6.13 ┤ ╭╭│───╰─────╮─╰────────────────╮───╰───╭───╮──╭─╭─╮───────╯╭──╮───╰───────────
  4.07 ┤╭──╯───╰─────╰─────────────────────────────────────────────────────────────────
  2.00 ┼╯╯╯╯   ╰───╯╰──╯───╯       ╰─╯     ╰───╯   ╰───╯────╰──╯    ╰──╯
                                             leases

last store values: [s1=10 s2=7 s3=6 s4=4 s5=5 s6=7 s7=7 s8=5 s9=4 s10=5]
----
----
