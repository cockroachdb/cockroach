skip_under_ci
----

# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity_ms=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu
----
 20149 ┤             ╭─────╮  ╭╮
 18806 ┤             │     │  ││
 17463 ┤             │     │  ││
 16120 ┤    ╭────╮   │     ╰──╯╰──╮────╭──────────────────────────╭╮╮   ╭╮    ╭╮  ╭─╮ ╭
 14776 ┤    │    │   │         │  │    │                          │││   ││    ││  │ │ │
 13433 ┤╭╭╭╭╮───╮╭───╮───╭─╮──────────────────────────────────╭───╯╰─╮╮─╯╭────╯│──│ │╭╮
 12090 ┤│││││   ││╮  │   │││  │                              ││   ││ ││  │   ││╰╮ │ │││
 10746 ┤╭╮│││   ╰│───│───│││╮ │   ╭╮                         ││╭╭╮─╮ ││  │   │╰╮│ │ │││
  9403 ┤│╰─╯╰───────╮╰───╯╯╰──────││──────────────────────────│││╰───╰─────────────────
  8060 ┤││  ││   ││ │    │││      ││                          │││    ││ ││      │ │ ││
  6716 ┤│╰╮ │────╰╯─╰─────────────╯╰──────────────────────────╯─╯─────│─╰╯──────│─╰─╯╰╮
  5373 ┤│││ ││                   ││ │                           │     │         │     │
  4030 ┤│╰╰─││      ╭╮╭───────╮  ╰╯─╯                           │     │         │     │
  2687 ┤│ │ │╯   ╭──╯╰╯       │╭─╯                              ╰─────╰─────────╯     ╰
  1343 ┤│ │ │    │            ││
     0 ┼╯ ╰─╰────╯            ╰╯
                                              cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=6626, s2=9964, s3=13191, s4=3318, s5=10021, s6=16635, s7=9933, s8=9967, s9=9921, s10=10011] (stddev=3320.17, mean=9958.70, sum=99587)

plot stat=write_bytes_per_second
----
 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮╭╮
 11207599 ┤│ │╭╮
  9962310 ┤│ │││╭──╮╭╮
  8717021 ┤│ ╰╯│╯──│││─╮    ╭╮       ╭╮
  7471733 ┤│   │╭──╮│╭╮╭───╮╭╮╭─╭╮╭╭╮╮╭╮                              ╭╮        ╭╮ ╭╮ ╭╮╮╭
  6226444 ┤│   ╭╮  ╭╮──╭───────────╯╰╮│╰────────────────────────────╮╮││╭─────────────╮─╭─
  4981155 ┤│ ╭╭╯╰──╯╰──╯╯───││╰──────╰╯╯─╰╯──────────╰╯          ╰─╯╰───╯╯╰─╯╰╯╰│╭╰───╰─╯─
  3735866 ┤│╭╭╯╯╭──╰╯──╯    ╰╯    ╰╰─╯                                 ╰╯╰╯     ╰╯
  2490578 ┤╭╭╯──╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=6327774, s2=5991375, s3=5678038, s4=5644479, s5=5310902, s6=4674952, s7=7668021, s8=4995599, s9=5312465, s10=6327369] (stddev=806912.42, mean=5793097.40, sum=57930974)

plot stat=replicas
----
 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│                                                                           ╭─╭
 31.00 ┤│╮                                                    ╭╮╮╭╮             ╭╮ ╭╮ │
 29.00 ┤╰╮                                                    │╭─╮─╭╮╭╮─╮╭───╮╭╭╮│╮││╮╭
 27.00 ┤ │                                                   ╭╭╯││╭╮╭────╮───╭─╮╭╭─╮─╭╯
 25.00 ┤ ╰╮                                                  ││─││││││╰│╰╰───╯││╭╯╯╰─╯╰
 23.00 ┤ ╰│      ╭╮      ╭╮                                  ││─╯╰╯╰╯╯╯╰╯   ╰╰╯╰╯╯│╰╰─╯
 21.00 ┤  │      │╭╮╭╮   ││╭╮╭╮╭╭╮    ╭╮                     ╭╯                  ╰╯
 19.00 ┤  ╭──╮──╭╮│╰│╭───╮╭╮─╮│╭││╭─╮────────────────────────│
 17.00 ┤  │─╯╰──╯╰───╯──╮╰──────╯││╯│╰──╭─────────╮──────────│
 15.00 ┤ ╭╯─╰───╰╯╯ ╰╯──╰─╯╰╯╰│││││╯╰───╯─────────╰──────────╯
 13.00 ┤╭│╯     ╰╯        ╰╯  ╰╯╰╰╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas
initial store values: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
last store values: [s1=27, s2=27, s3=28, s4=23, s5=27, s6=29, s7=33, s8=25, s9=25, s10=29] (stddev=2.61, mean=27.30, sum=273)

plot stat=leases
----
 33.00 ┼╮
 30.87 ┤╰╮
 28.73 ┤ │
 26.60 ┤ │
 24.47 ┤ ╰╮
 22.33 ┤  │
 20.20 ┤  │
 18.07 ┤  ╰╮
 15.93 ┤   │                                                 ╭──╮  ╭╮╭╮               ╭
 13.80 ┤   │                  ╭╮      ╭╮                     │  ╰──│╰╯╰────────────────
 11.67 ┤   ╰────╮╭────────╮╭──╯╰──────╯╰─────────────────────╭──╭╮─│╯╭──────────────╮╮╭
  9.53 ┤  ╭─╮   ╭─╮ ╭╮   ╭────────╮ ╭────────────────────────╭╭──╮╭╮─╯──╭╮──╭╮╭─╮╭╭─╮╭─
  7.40 ┤  │─╰───────╮╭───╮─────╭─╮╭─╮────────────────────────╯│─╯╰╯╰───────────────╮───
  5.27 ┤╭─╯─╯───╰───╰╯───╰─────╯─╰╯─╰─────────────────────────╯         ╰╯    ╰─╯╰╯╰───
  3.13 ┼╯─╯│╰───────╰╯───╰─────────────╯
  1.00 ┤  ╰╯
                                             leases
initial store values: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
last store values: [s1=12, s2=8, s3=9, s4=6, s5=10, s6=14, s7=9, s8=6, s9=12, s10=5] (stddev=2.81, mean=9.10, sum=91)
