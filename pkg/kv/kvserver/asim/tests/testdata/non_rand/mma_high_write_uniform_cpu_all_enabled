skip_under_ci
----

# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

eval duration=20m samples=1 seed=42
----
[nodes: 10, stores_per_node:1, store_disk_capacity: 256GiB, node_capacity: 0cpu-sec/sec]
[workload: 1000ops/s(r:1,w:0), 0cpu-us/op, 1-1B/op, key=[1,10000]
[workload: 20000ops/s(r:0,w:1), 1000-1000B/op, key=[10001,20000]
[ranges: num_ranges=30, key=[1,10000], rf=3, range_size=0 MiB (even across stores)]
[ranges: num_ranges=30, key=[10001,20000], rf=3, range_size=0 MiB (skewed across stores)]
OK

plot stat=cpu
----
 16918 ┤    ╭───╮╭──╮╭──╮           ╭──╮     ╭────╮            ╭─╮
 15790 ┤    │   ││╯ ││  │          ╭╯  │     │    │            │ │
 14662 ┤    │   ││  ││  │          │   │     │    │            │ │
 13534 ┤╭╭╭╭╮╮──╮╯──╰╯╭─╮────╮╭╭──╮───╮╰───╮╭│─╭──╰───╮      ╭╮╯ ╭─╮─╮
 12407 ┤││││││  │   │││ │    │││││││  ││   │││ │   │  │      ││  │ │ │
 11279 ┤││││││  │   │││ │    │││││││  ││   │││ │   │  │      ││  │ │ │
 10151 ┤╭──╯╰───────╮─╯─╭──────╯─╰╰──────────────────────────────╯─╰───────────────────
  9023 ┤││  │   │││ ││  ││ │  ││││││       │││ ││  │  │      ││      │
  7895 ┤││  │   │││ ││  │╯ │  ││││││       │││ ││  │  │      ││      │
  6767 ┤│╰╮ │   ╭╯──╰───╯───────╯╭╯│──╭──────╯─╮╯──╭──╯      ╰╯╮    ╭╯
  5639 ┤│││ │   │╭╮ ╭╯        ││ │││  │      │ │  ╭╯           │    │
  4511 ┤│││ │   │││ │         ││ │││  │      │ │  │            │    │
  3384 ┤│╰╰─╰───╯╯╰─╯         ╰╰─╯╯╰──╯      ╰─╰──╯            ╰────╯
  2256 ┤│ │ │
  1128 ┤│ │ │
     0 ┼╯ ╰─╯
                                              cpu
initial store values: cpu: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
node_cpu_utilization: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
last store values: cpu: [s1=10038, s2=10025, s3=10000, s4=9974, s5=10003, s6=9956, s7=9948, s8=10094, s9=10008, s10=9931] (stddev=45.83, mean=9997.70, sum=99977)
node_cpu_utilization: [s1=0.33, s2=0.33, s3=0.33, s4=0.33, s5=0.33, s6=0.33, s7=0.33, s8=0.34, s9=0.33, s10=0.33] (stddev=0.00, mean=0.33, sum=3)

plot stat=write_bytes_per_second
----
 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮╭╮
 11207599 ┤│ │╭╮╭──╮
  9962310 ┤│ │││╯  │             ╭╮
  8717021 ┤│ ╰╯╭───╮╭──╮╭──╮     │╰╮   ╭╮     ╭╮╭╮
  7471733 ┤│   │╰──╭╯╭╮╰╯╭─│╭╮╭─╮╮╮╰─╭╭╮╭─╮╭╮╭││╮╭─╮    ╭─╮
  6226444 ┤│   │╭╮ │╭╮╭────╰─────╮╭─╭────╮╭───────────────────────────────────────────────
  4981155 ┤│ ╭╭────╯│╰╯╰────╯╰╯╯╰╰──╯╰╯╰╯╰╯│╰─╯╯╰╯──╰──╯╰────╯   ╰╯
  3735866 ┤│╭╭╯────╰╯╰╯╭────╯╰╯ ╰╰╯╰╯ ╰╯  ╰╯  ╰╯─╯
  2490578 ┤╭╭╯──╯   ╰──╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=5989519, s2=5992559, s3=5993420, s4=5991496, s5=5798182, s6=5993900, s7=6014907, s8=6011632, s9=6209234, s10=5996410] (stddev=92298.53, mean=5999125.90, sum=59991259)

plot stat=replicas
----
 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮                                                           ╭─────────────────
 27.00 ┤ │                                                   ╭╭────────────────────────
 25.00 ┤ ╰╮                                                  ╭╯───────────────────────╯
 23.00 ┤ ╰│     ╭╮ ╭╮                       ╭╮               │╯
 21.00 ┤  │     │╭╮│╭╮╮  ╭╮  ╭╮  ╭╮ ╭╮  ╭╮╭╭╮│╭╮             │
 19.00 ┤  ╭──╮──╮│╭╮│╭──╮╭╭──╮│╭╭╮╭╭╮╭╮╮╭╮╮││╭─╮╮╭───╭─╮╭─╮─╭│
 17.00 ┤  │─╯╰───────╯──╰╮╭─────╯╰──────╯╰───────────────────╯
 15.00 ┤ ╭╯─│╰╯─╰╯ ╰╰╯╯ ╰╰╯  ╰╯││╰╯─╰╯╯╰╯╰╮│╰╯╰╯╯╰──╯╰╰──────╯
 13.00 ┤╭│╯ ╰╯   ╰─╯╰╯       ╰╰╯╰╯        ╰╯ ╰╯╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas
initial store values: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
last store values: [s1=29, s2=27, s3=26, s4=27, s5=27, s6=27, s7=27, s8=28, s9=28, s10=27] (stddev=0.78, mean=27.30, sum=273)

plot stat=leases
----
 33.00 ┼╮
 30.87 ┤╰╮
 28.73 ┤ │
 26.60 ┤ │
 24.47 ┤ ╰╮
 22.33 ┤  │
 20.20 ┤  │
 18.07 ┤  ╰╮
 15.93 ┤   │                                                 ╭─────────────────────────
 13.80 ┤   ╰╮                                                │
 11.67 ┤    ╰────╮                       ╭─╮    ╭────────────╭╮────────────────────────
  9.53 ┤  ╭─╮   ╭────────╮╭─────────╮────╯ ╭─╭────╮──╮      ╭│╭────────────────────────
  7.40 ┤  │╮╰───╯╭───────╰───────────────╮─╭─╯────╰──────────╭╯────────────────────────
  5.27 ┤╭─╯──────╯──╯╰╯─╯╰───╰╯╯─╰───╯╯╰╯╰───────────────────╯│
  3.13 ┼╯─╯│    ╰╯──╯          ╰─╯╯ ╰────────────╰╯───────────╯
  1.00 ┤  ╰╯
                                             leases
initial store values: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
last store values: [s1=14, s2=7, s3=6, s4=9, s5=7, s6=9, s7=10, s8=11, s9=9, s10=9] (stddev=2.17, mean=9.10, sum=91)
