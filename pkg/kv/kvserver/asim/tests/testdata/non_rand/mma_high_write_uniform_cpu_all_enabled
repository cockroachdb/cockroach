# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 23674 ┤        ╭──╮
 22096 ┤        │  │
 20517 ┤        │  ╰───╮
 18939 ┤        │      │
 17361 ┤        │      │╭───╮                        ╭─╮             ╭╮
 15783 ┤ ╭─╮    │      ╰╮   ╭──╮                    ╭╯ │        ╭──╮ │╰─╮
 14204 ┤╭╭────╭╮│       │   ╭╮ ╭╮                   │╮ │    ╭──╮│  │ │╭╮│
 12626 ┤││╭─╭─╯││   ╭──╮╰───│╰─╯│──────╮╭──╮    ╭──╮╭──────────╮│  ╰──╯│╭──╮╭╭─╮───╮╭──
 11048 ┤│││ │  ╰╮   ╭╮ ││  ││   │   │  ││  │    │  ││   │  ││  ││   │  ││  │││ │   ││
  9470 ┤╭───╯╮─╰╰───╮───╮───│───╰───────────────╮───╭────────────────────────╯─╰───────
  7891 ┤││   │  │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │
  6313 ┤│────╰──╯───╰───╮───│───╯───╰───╯───╯   ╰───╯───────│───╯   ╭───────╰───────╯──
  4735 ┤││          │   │   │                       │   │   │       │
  3157 ┤│╰╮  ╭──────╯   ╰───╯                       ╰───╯   │   ╭───╯
  1578 ┤│ │  │                                              │   │
     0 ┼╯ ╰──╯                                              ╰───╯
                                              cpu

last store values: [s1=9916 s2=10018 s3=6659 s4=13352 s5=9870 s6=10043 s7=10048 s8=10014 s9=10006 s10=9998]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 93337 ┤╭╮
 87115 ┤││
 80892 ┤╭╮
 74670 ┤││╮
 68447 ┤│││
 62225 ┤│╰╮  ╭─╮
 56002 ┤│ │──╯ ╰───╮
 49780 ┤│ ╰─╮     ╭╮
 43557 ┤│ │ ╰─────╯│ ╭─╭╮                                   ╭──╮
 37335 ┤│ ╰─╭╮─╭╮  │─╭─││───╭──╮───╭╮   ╭──────╮╭──╮╭──╮╭──╭╯──│╭──╮╭──╮╭──╭╮   ╭──╮╮
 31112 ┤│  ╭╭───╮╭──╮──│╰──╮╭──╮╭──────────────────╮╭──╮╭──╮╭──────╮╭──╮╭──╮╭╮─╮╭──╮╭──
 24890 ┤│ ╭─╯╭──╰╯─╯╰──╯───╰╯──╰╯──╯╭──╯╰───╯──││──╰╯──││──╰╯──────╰╯╰─╰╯──││╰──╯──╰╯──
 18667 ┤│╭╯╭╮╭─╮╭╯───╯ ╰╭──╯   ╰────╯          ╰╯  │╭──╰╯──╰╯──││──╰╯──╰╯  ╰╯  ╰╯  ╰╯
 12445 ┤╭╯─╯╰╯─╰╯──╯╰───╯                          ╰╯          ││  ╰╯
  6222 ┤│╯─╯                                                   ╰╯
     0 ┼╯╯
                                     write_bytes_per_second

last store values: [s1=26759 s2=33265 s3=26900 s4=29837 s5=33511 s6=33270 s7=29934 s8=33278 s9=23071 s10=30151]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮
 27.00 ┤ │
 25.00 ┤ │╮
 23.00 ┤ ╰╮            ╭╮          ╭╮                  ╭╮  ╭╮  ╭╮          ╭╮      ╭╮
 21.00 ┤  │╭╭╮ ╭╮  ╭╮  ││  ╭╮      ││  ╭╮      ╭╮  ╭╮  ╭╮  ││  ││  ╭╮      │╭╮ ╭╮  ││
 19.00 ┤  ╰╭────────╮──││──╯╰──╮╭──╯│──╮╰──────╭───╭───╮────╮──╭╮──╭────────││─╮╭──╮╮──
 17.00 ┤  ╭╯───╮│──╯│╭─╯╰──╮╭──────────────────────╯│──╰───────╯╰──────────╮││─╭╯──╰───
 15.00 ┤ ╭╯╰─╰─╰╯  │╰╯─╮╰──││  ╰╯───╰──╯╯  ╰───╮│──││──╰───╰╯  ╰╯  ╰╯╯─╰╯──││╰─╯╯──╰╰──
 13.00 ┤╭╯         ││  ││  ╰╯      ╰╯          ││  ╰╯  ╰╯  ╰╯  ││  ╰╯      ╰╯      ╰╯
 11.00 ┤│╯         ╰╯  ╰╯                      ╰╯              ││
  9.00 ┼╯                                                      ╰╯
                                            replicas

last store values: [s1=19 s2=20 s3=16 s4=19 s5=18 s6=19 s7=18 s8=16 s9=17 s10=18]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ │
 22.67 ┤ ╰╮
 20.60 ┤  │
 18.53 ┤  │
 16.47 ┤  ╰╮
 14.40 ┤   │
 12.33 ┤   │   ╭─╮
 10.27 ┤   ╰───│─╰──────╮───╮                      ╭───╮   ╭╮      ╭╮              ╭╮
  8.20 ┤   ╭───╮        ╰───╮──────────╭───╮────╭──╮╭──╰───╯╰──╮╭──╮╭──╮────╮  ╭───╮╭──
  6.13 ┤ ╭╭│───╰────╮──╭╮──╭╭───╮──────╯╯──╰───╮│──╰───────────────────────────────╮───
  4.07 ┤╭──╯───╰╯───╰──╯│──╭╯──╰╰──────────────────────────────────────────╮╭──────────
  2.00 ┼╯╯╯╯   ╰───╯╯   ╰──╯           ╰───╯   ╰╯  ╰───╯───╯───╯           ╰╯  ╰───╯
                                             leases

last store values: [s1=6 s2=6 s3=7 s4=8 s5=6 s6=4 s7=7 s8=6 s9=5 s10=5]
----
----
