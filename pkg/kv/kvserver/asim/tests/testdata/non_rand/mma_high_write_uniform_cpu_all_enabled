# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 20201 ┤    ╭──╮                                ╭╮
 18855 ┤    │  │                                ││
 17508 ┤    │  │                         ╭─╮    ││
 16161 ┤    │  ╰───╮╭───╮   ╭──╮╭───╮   ╭───╮   │╰──╮
 14814 ┤    │      ╰│   │   │  ││   │   ││  │   │   │
 13468 ┤╭╭─╭╮──╮╭───╭───╮───╭───╮╭─╮╭───╮╯  ╭───╮╭─╮╭───────╮╭─╮ ╭──╮
 12121 ┤│││││  ││   │  ││   │   ││ ││   │   │  │││ ││  ││   ││ │ │  │
 10774 ┤╭╮│││╮ ╰╭─╮ │  ╭│   │  ╭│╮ ││───│   │  │││ ││────╭─╮│╭╮│╭╮  │╭╮
  9427 ┤│╰──╮───│─╰─│───╰───────────╯───╰───╯───│───────╭╯─╰───────────────────────────
  8081 ┤││  │   │   │   │   │   ││  │   │       ││      │   ││  ││  │
  6734 ┤│╰╮ │   ╭───╯───────│───│╰──╯───╰───────╰───────╯───╯╰──╯╰──╯
  5387 ┤│││ │   │   │       │   │   │   │       ││
  4040 ┤│╰╰─│ ╭─╯   │       │   │   │   │       ││
  2694 ┤│ │ ╰─╯─╯───╯       │   │───╯   ╰───────╰╯
  1347 ┤│ │ │               │   │
     0 ┼╯ ╰─╯               ╰───╯
                                              cpu

last store values: [s1=9974 s2=9963 s3=9942 s4=10060 s5=9978 s6=10003 s7=9988 s8=10019 s9=9946 s10=10085]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 93439 ┤╭╮
 87210 ┤││
 80980 ┤╭╮
 74751 ┤││╮
 68522 ┤│││
 62293 ┤│╰╮╮╭──╮
 56063 ┤│ │╰╯  │
 49834 ┤│ │    │
 43605 ┤│ ╰╮   ╰───╮╭───╮   ╭───╮
 37376 ┤│ ╰╭╭──╮╭──╮╭╮──╭──╮│   ╰╮──╭───╮╭─╮╭──╮╭──╮╭──╮╮
 31146 ┤│  ╭╯──╰╮──╭╯╰──╯──╰╮───╭───────────╮───╮╭╭─╭──────────────────────────────────
 24917 ┤│ ╭│───│╰──╯│╭─╮╭───╰───╯╯──╯───│╰──╰────╮╭─╯───╯╯  ╰╯──╰╯──╰──────╯╰───╯
 18688 ┤│╭╭╯───╰╯   ╰───╯───────────────╰────────╰╯─╯    ╰──╯
 12459 ┤╭╭╯─────────╯
  6229 ┤╭╯╯
     0 ┼╯
                                     write_bytes_per_second

last store values: [s1=29982 s2=29868 s3=29972 s4=30043 s5=29969 s6=30037 s7=29990 s8=29853 s9=30025 s10=30012]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮
 29.00 ┤╰╮
 27.00 ┤ │
 25.00 ┤ ╰╮
 23.00 ┤ ╰│
 21.00 ┤  │╭╮  ╭╮       ╭╮     ╭╭╮      ╭╮                  ╭╮
 19.00 ┤  ╭│╰──╮╭──╭╮───╮╭──╮───╯│──╭───╭──╮╭────╮─╮╭───╭───╮──────────────────────────
 17.00 ┤  ╭╯╰──╰───╯╰╮──╭───╮───╭───────╯│─╰╯───╰╰──────╯───╰──────────────────────────
 15.00 ┤ ╭╯││  ││──╰╯╰──╯╰─╰╰───╯╰──╯───╯╰──╯──╰─╯ ╰╰───╯╰───╯
 13.00 ┤╭│╯││  ╰╯  ╰╯
 11.00 ┤╭╯ ╰╯
  9.00 ┼╯
                                            replicas

last store values: [s1=18 s2=17 s3=19 s4=18 s5=19 s6=18 s7=19 s8=17 s9=17 s10=18]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼╮
 30.87 ┤╰╮
 28.73 ┤ │
 26.60 ┤ │
 24.47 ┤ ╰╮
 22.33 ┤  │
 20.20 ┤  │
 18.07 ┤  ╰╮
 15.93 ┤   │
 13.80 ┤   ╰╮
 11.67 ┤    ╰──╮    ╭───────╮   ╭───────╮       ╭───╮            ╭──╮
  9.53 ┤  ╭─╮  ╭╭───╯──╯╰──╭╰───────────────────╮  ╭╮──╭╮╭───────╯──╰──────────────────
  7.40 ┤ ╭╯╭╰──╮│───────╮──╭───╯╮╭─╮╭───╭╮──╭───╰──╯╰──────────────────────────────────
  5.27 ┤╭╯╯│╰──╰╯───╰───╰───────────────╯╰──╯──╰╰───────╯───╰──────────────────────────
  3.13 ┼╯──╯   ╰────────╯  ╰╰───╯───────────╯──╰────╯  ╰───────────────────────────────
  1.00 ┤  ╰╯
                                             leases

last store values: [s1=8 s2=9 s3=5 s4=6 s5=7 s6=3 s7=5 s8=5 s9=6 s10=6]
----
----
