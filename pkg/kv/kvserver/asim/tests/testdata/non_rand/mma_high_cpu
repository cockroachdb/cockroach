gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 142607 ┤╭────╮
 133100 ┤│    │
 123593 ┤│    ╰─────╮
 114086 ┤│          ╰────╮
 104579 ┤│               │╭────╮
  95071 ┤│               ╰╯    ╰───╮
  85564 ┤│                         ╰╮
  76057 ┤│                          ╰──────────╮
  66550 ┤│                                     ╰─────╮
  57043 ┤│                                           ╰────╮
  47536 ┤│    ╭╭───╮                 ╭───╮╭───╮ ╭──╮ ╭───╮╰─────╭──╮─╮
  38029 ┤╭─────╯   ╰─────────────────╯─╯ ╭──────────╭───────────────────────────────────
  28521 ┤│          ╭─────╭──────────────╭────╭─────────────────────────────────────────
  19014 ┤╭────────────────────────────────────╯
   9507 ┤│
      0 ┼╯
                                               cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=39335, s2=38297, s3=37641, s4=39551, s5=34898, s6=38494, s7=26509, s8=37481, s9=27070, s10=30274] (stddev=4827.21, mean=34955.00, sum=349550)

plot stat=write_bytes_per_second
----
 7970 ┤╭╮──╭╮╭────────────────────────────────────────────────────────────────────────
 7439 ┤╭─────╯────────────────────────────────────────────────────────────────────────
 6908 ┤│    ╰╯   ╰╯
 6376 ┤│         ╰╯
 5845 ┤│
 5314 ┤│
 4782 ┤│
 4251 ┤│
 3720 ┤│
 3188 ┤│
 2657 ┤│
 2125 ┤│
 1594 ┤│
 1063 ┤│
  531 ┤│
    0 ┼╯
                                    write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=7723, s2=7621, s3=7378, s4=7576, s5=7475, s6=7501, s7=7551, s8=7581, s9=7551, s10=7798] (stddev=113.68, mean=7575.50, sum=75755)

plot stat=replicas sample=1 
----
 80.00 ┼──────────╮────╮
 76.67 ┤          ╰─────╮─────────────────────────────────────╮
 73.33 ┤                ╰─────────╮                           ╰────────────────────────
 70.00 ┤                     ╰────╰──────────╮
 66.67 ┤                                ╰────╰──────────╮
 63.33 ┤                                          ╰─────╰──────────────────────────────
 60.00 ┤                                                          ╰────────────────────
 56.67 ┤
 53.33 ┤
 50.00 ┤
 46.67 ┤
 43.33 ┤                                                     ╭─────────────────────────
 40.00 ┤                          ╭──────────────────────────╯─────────────────────────
 36.67 ┤                ╭─────────╯────────────────────────────────────────────────────
 33.33 ┤               ╭╯────╭─────────────────────────────────────────────────────────
 30.00 ┼─────────────────────╯──────────╯───────────────╯
                                            replicas
initial store values: [s1=80, s2=80, s3=80, s4=30, s5=30, s6=30, s7=30, s8=30, s9=30, s10=30] (stddev=22.91, mean=45.00, sum=450)
last store values: [s1=72, s2=60, s3=62, s4=40, s5=35, s6=36, s7=36, s8=42, s9=33, s10=34] (stddev=13.43, mean=45.00, sum=450)

plot stat=leases sample=1 
----
 60.00 ┼─────╮
 56.33 ┤     │
 52.67 ┤     ╰─────╮
 49.00 ┤           │
 45.33 ┤           ╰────╮
 41.67 ┤                │
 38.00 ┤                ╰─────╮
 34.33 ┤                      ╰────╮
 30.67 ┤                           │
 27.00 ┤                           ╰─────╮
 23.33 ┤                                 ╰────╮              ╭─────────────────────────
 19.67 ┤          ╭──────────────────────────────────────────╭────╭────────────────────
 16.00 ┤     ╭────────────────────────────────────────────────────╯────────────────────
 12.33 ┼─────╯─────╯─────────╯╯    ╭────╮╭───╮╭───╮ ╭───╮╭──────────────╮
  8.67 ┼─────╯─────────────────────╯────╰╯───╰╯   ╰─╯   ╰╯   ╰╯───╰─────╰──────────────
  5.00 ┤          ╰╯
                                             leases
initial store values: [s1=60, s2=10, s3=10, s4=11, s5=10, s6=10, s7=10, s8=10, s9=9, s10=10] (stddev=15.01, mean=15.00, sum=150)
last store values: [s1=7, s2=9, s3=9, s4=19, s5=20, s6=23, s7=13, s8=17, s9=15, s10=18] (stddev=5.08, mean=15.00, sum=150)
