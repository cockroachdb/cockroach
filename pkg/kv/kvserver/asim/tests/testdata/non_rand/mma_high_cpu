gen_cluster nodes=7
----

gen_ranges ranges=100
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false 
----

gen_load rate=7000 rw_ratio=0.95 access_skew=true min_block=128 max_block=256
----

# TODO(kvoli): We are now generating changes, so this test is failing. Investigate:
#
# panic: programming error: unexpected multiple snapshot targets for replica change (+voter=[n1,s1 n7,s7] +non-voter=[]) changes=[{ADD_VOTER n1,s1} {ADD_VOTER n7,s7}] [recovered]

eval duration=5m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
----

 520196847 ┤ ╭─────────────────────────────────────────────────────────────────────────────
 485517058 ┤ │
 450837268 ┤ │
 416157478 ┤ ╭─────────────────────────────────────────────────────────────────────────────
 381477688 ┤ ╭─────────────────────────────────────────────────────────────────────────────
 346797898 ┤ │─────────────────────────────────────────────────────────────────────────────
 312118108 ┤ │╮
 277438319 ┤ │╰────────────────────────────────────────────────────────────────────────────
 242758529 ┤ │
 208078739 ┤ │
 173398949 ┤ │
 138719159 ┤ │
 104039369 ┤ │
  69359580 ┤ │
  34679790 ┤ │
         0 ┼─╯
                                                  cpu
----
----
