gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 555977 ┤╭────╮
 518912 ┤│    │
 481846 ┤│    ╰─────╮
 444781 ┤│          ╰────╮
 407716 ┤│               │
 370651 ┤│               ╰─────╮
 333586 ┤│                     ╰────╮
 296521 ┤│                          ╰────╮
 259456 ┤│                               ╰─────╮
 222391 ┤│                                     ╰──────────╮
 185326 ┤│                                                ╰────╮
 148260 ┤│                                                     ╰──────────╮
 111195 ┤│                     ╭─────────────────────╭─────────────────────────╭────────
  74130 ┤╭────╭────────────────────────────────────────────────────────────────╯────────
  37065 ┤╭────╯─────╯
      0 ┼╯
                                               cpu

last store values: [s1=105635 s2=112990 s3=108239 s4=108231 s5=108445 s6=82849 s7=103161 s8=104047 s9=98078 s10=97940]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 10176 ┤                                               ╭╭──────────────────────────────
  9498 ┤               ╭───────────────────────────────╭╯
  8819 ┤               ╭───────────────────────────────╯╭────╭─────────────────────────
  8141 ┤╭╮╭╮  ╭╮       │───╭────────────────────────────╯    │     ╭───────────────────
  7462 ┤╭────────────────────────────────────────────────────╯─────╯
  6784 ┤│              │                               ╰╰────╮
  6106 ┤│              │                                     ╰─────╮ ╭─────────────────
  5427 ┤│              │                                           ╰─╯─────────────────
  4749 ┤│              │
  4070 ┤│              ╰╮
  3392 ┤│               ╰────╮
  2714 ┤│                    │   ╭╮
  2035 ┤│                    ╰───╯╰────╮
  1357 ┤│                              ╰─────╮
   678 ┤│                                    ╰─────────────────────────────────────────
     0 ┼╯
                                     write_bytes_per_second

last store values: [s1=793 s2=5333 s3=5872 s4=10086 s5=8060 s6=8787 s7=8821 s8=10149 s9=8825 s10=9069]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 88.00 ┤               ╭───────────────────────────────╮
 82.93 ┼───────────────────────────────────────────────╮
 77.87 ┤     ╰─────────╮                               │
 72.80 ┤               │                               │
 67.73 ┤               │                               │
 62.67 ┤               │                               ╰╮                    ╭─────────
 57.60 ┤               ╰╮                               │───╭────────────────╯─────────
 52.53 ┤                ╰────╮                         ╭────╯╯    ╭────────────────────
 47.47 ┤                     ╰────╮                    │╭────╭────╯────────────────────
 42.40 ┤                     ╭─────────────────────────╭─────╯     ╰───────────────────
 37.33 ┤               ╭─────╯────╭────────────────────│
 32.27 ┼───────────────────────────────────────────────╯
 27.20 ┤                                      ╰─────────╮
 22.13 ┤                                                ╰─────────╮
 17.07 ┤                                                          ╰───────────╮
 12.00 ┤                                                                      ╰────────
                                            replicas

last store values: [s1=12 s2=39 s3=45 s4=54 s5=50 s6=46 s7=47 s8=59 s9=48 s10=50]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 60.00 ┼─────╮
 56.60 ┤     │
 53.20 ┤     ╰────╮
 49.80 ┤          ╰╮
 46.40 ┤           ╰────╮
 43.00 ┤                │
 39.60 ┤                ╰────╮
 36.20 ┤                     ╰─────╮
 32.80 ┤                           │
 29.40 ┤                           ╰────╮
 26.00 ┤                                ╰─────╮
 22.60 ┤                                      ╰────╮
 19.20 ┤                                           ╰──────────╮
 15.80 ┤                                ╭────╮╭───╮╭────╮╭─────────────────────────────
 12.40 ┤          ╭──────────────────────────────────────╯─────────────────────────────
  9.00 ┼──────────╯─────╯──────────╯
                                             leases

last store values: [s1=12 s2=16 s3=15 s4=16 s5=16 s6=13 s7=15 s8=15 s9=15 s10=17]
----
----
