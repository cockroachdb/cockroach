gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 142607 ┤╭────╮
 133100 ┤│    │
 123593 ┤│    ╰─────╮
 114086 ┤│          ╰────╮
 104579 ┤│               ╰─────╮
  95071 ┤│                     ╰────╮
  85564 ┤│                          │
  76057 ┤│                          ╰─────╮
  66550 ┤│                                ╰────╮
  57043 ┤│                                     ╰──────────╮
  47536 ┤│                                                ╰────╮
  38029 ┤╭───────────────────────────╭──────────╭───────────────────────────────────────
  28521 ┤│          ╭──────────╭────────────────╯───────────────────────────────────────
  19014 ┤╭─────────────────────╯─────────╯────╯
   9507 ┤│
      0 ┼╯
                                               cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=37921, s2=35840, s3=37575, s4=34997, s5=35715, s6=32999, s7=34730, s8=35054, s9=26550, s10=38330] (stddev=3208.47, mean=34971.10, sum=349711)

plot stat=write_bytes_per_second
----
 16317 ┤╭╮   ╭──────────╭╮────╭╮────────────────────────────────────────╭──────────────
 15229 ┤╭───────────────╮╭────╯╰───────────────────────────────────────────────────────
 14141 ┤│    ╰────╰╯╭───╰╯─────────────────────────────────────────────────────────────
 13053 ┤│         │╭╯   ╰──────────────────────────────────────────────────────────────
 11965 ┤│         ╰╯
 10878 ┤│
  9790 ┤│
  8702 ┤│
  7614 ┤│
  6527 ┤│
  5439 ┤│
  4351 ┤│
  3263 ┤│
  2176 ┤│
  1088 ┤│
     0 ┼╯
                                     write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=15338, s2=14288, s3=12782, s4=16152, s5=15483, s6=14995, s7=15628, s8=15152, s9=16112, s10=15653] (stddev=945.04, mean=15158.30, sum=151583)

plot stat=replicas sample=1 
----
 80.00 ┼─────╮
 76.67 ┤     ╰─────────╮╮
 73.33 ┤               │╮─────╮
 70.00 ┤               ╰╮────────────────────╮
 66.67 ┤                ╰─────────────────────────╮──────────╮
 63.33 ┤                                      ╰───╰───────────────╮────────────────────
 60.00 ┤                                                 ╰────────╰────────────────────
 56.67 ┤
 53.33 ┤
 50.00 ┤
 46.67 ┤
 43.33 ┤
 40.00 ┤                           ╭──────────────╭────────────────────────────────────
 36.67 ┤               ╭────────────────╭─────────╯──────────╯────╭────╭───────────────
 33.33 ┤     ╭────╭────╭────────────────╯──────────────────────────────╯
 30.00 ┼───────────────╯╯─────────────────────────╯
                                            replicas
initial store values: [s1=80, s2=80, s3=80, s4=30, s5=30, s6=30, s7=30, s8=30, s9=30, s10=30] (stddev=22.91, mean=45.00, sum=450)
last store values: [s1=59, s2=62, s3=60, s4=40, s5=39, s6=35, s7=39, s8=41, s9=35, s10=40] (stddev=10.24, mean=45.00, sum=450)

plot stat=leases sample=1 
----
 60.00 ┼─────╮
 56.33 ┤     │
 52.67 ┤     ╰─────╮
 49.00 ┤           │
 45.33 ┤           ╰────╮
 41.67 ┤                │
 38.00 ┤                ╰─────╮
 34.33 ┤                      ╰────╮
 30.67 ┤                           │
 27.00 ┤                           ╰─────╮
 23.33 ┤                                 ╰────╮
 19.67 ┤                ╭──────────╭────╭──────────────────────────────────────────────
 16.00 ┤     ╭────╭╭────────────────────╯──────────────────────────────────────────────
 12.33 ┼───────────╯────╯───────────────────────────╯    ╭───╮╭───╮─╭──╮
  8.67 ┼─────╯───────────────────────────────────────────╯───╰╯───╰─╯──╰───────────────
  5.00 ┤          ╰╯    ╰─────╯
                                             leases
initial store values: [s1=60, s2=10, s3=10, s4=11, s5=10, s6=10, s7=10, s8=10, s9=9, s10=10] (stddev=15.01, mean=15.00, sum=150)
last store values: [s1=8, s2=7, s3=9, s4=18, s5=20, s6=19, s7=17, s8=16, s9=16, s10=20] (stddev=4.80, mean=15.00, sum=150)
