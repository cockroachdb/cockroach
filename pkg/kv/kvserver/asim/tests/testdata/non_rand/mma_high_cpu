gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 555977 ┤╭────╮
 518912 ┤│    │
 481846 ┤│    ╰────╮
 444781 ┤│         ╰─────╮
 407716 ┤│               ╰────╮
 370651 ┤│                    ╰─────╮
 333586 ┤│                          ╰────╮
 296521 ┤│                               ╰─────╮
 259456 ┤│                                     ╰────╮
 222391 ┤│                                          ╰─────╮
 185326 ┤│                                                ╰─────────╮
 148260 ┤│          ╭───╮╭────╮╭───╮╭────╮╭───╮╭───╮ ╭─╭─╮╭────────╮╰───╭╮─────╮
 111195 ┤│    ╭─────╯   ╰╯    ╰╯   ╰╯────╰╯───╰╯───╰╭───────────────────────────────────
  74130 ┤╭──────────╭───────────────────────────────╯───────────────────────────────────
  37065 ┤╭──────────╯─────╯─────────╯
      0 ┼╯
                                               cpu

last store values: [s7=61462 s9=76890 s5=97067 s8=102172 s10=106549 s6=106863 s4=117230 s3=119691 s1=120302 s2=121388]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 7970 ┤╭╮──╭╮────╮╭─╮ ╭╭╮ ╭─╮╭──────────────────────────────────────────────────────╭─
 7439 ┤╭───────────────╮╭─────────────────────────────────────────────────────────────
 6908 ┤│              ╰╰╯
 6376 ┤│
 5845 ┤│
 5314 ┤│
 4782 ┤│
 4251 ┤│
 3720 ┤│
 3188 ┤│
 2657 ┤│
 2125 ┤│
 1594 ┤│
 1063 ┤│
  531 ┤│
    0 ┼╯
                                    write_bytes_per_second

last store values: [s5=7463 s6=7491 s7=7526 s10=7542 s8=7546 s9=7550 s4=7556 s3=7643 s2=7708 s1=7731]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 80.00 ┼──────────────────────────╮───────────────────────────────╮
 76.67 ┤                          ╰──────────╮────────────────────╰────────────────────
 73.33 ┤                                     ╰────╮                      ╰─────────────
 70.00 ┤                                          ╰──────────╮
 66.67 ┤                                                     ╰─────────────────────────
 63.33 ┤
 60.00 ┤
 56.67 ┤
 53.33 ┤
 50.00 ┤
 46.67 ┤
 43.33 ┤
 40.00 ┤
 36.67 ┤                                                          ╭────────────────────
 33.33 ┤                           ╭────╭─────────╭────────────────────────────────────
 30.00 ┼──────────────────────────────────────────╯───────────────╯────────────────────
                                            replicas

last store values: [s7=31 s9=32 s6=33 s10=33 s5=34 s8=35 s4=36 s3=65 s1=73 s2=78]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 60.00 ┼─────╮
 56.60 ┤     │
 53.20 ┤     ╰────╮
 49.80 ┤          ╰╮
 46.40 ┤           ╰────╮
 43.00 ┤                │
 39.60 ┤                ╰────╮
 36.20 ┤                     ╰─────╮
 32.80 ┤                           ╰────╮
 29.40 ┤                                ╰─────╮
 26.00 ┤                                      ╰────╮
 22.60 ┤                                           ╰─────╮
 19.20 ┤                                                 ╰────╮
 15.80 ┤     ╭─────────╮╭────╭─────────────────────────────────────────────────────────
 12.40 ┤     │     ╭─────────╯─────────╯╭────╭─────────────────────────────────────────
  9.00 ┼───────────╯─────────────────────────╯─────────────────────────────────────────
                                             leases

last store values: [s7=11 s1=13 s9=13 s3=14 s5=15 s8=15 s2=16 s4=17 s6=18 s10=18]
----
----
