gen_cluster nodes=10
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 555977 ┤╭────╮
 518912 ┤│    ╰────╮
 481846 ┤│         ╰╮
 444781 ┤│          ╰────╮
 407716 ┤│               ╰──────────╮
 370651 ┤│                          ╰────╮
 333586 ┤│                               ╰─────╮
 296521 ┤│                                     ╰────╮
 259456 ┤│                                          ╰────╮
 222391 ┤│                                               ╰─────╭───╮     ╭╮   ╭╮
 185326 ┤│                                     ╭────────────────────────────────────────
 148260 ┤│                     ╭───╮╭───╮╭─────╯────╯   ╰╯
 111195 ┤│          ╭──────────╯───╰╯───╰╯╯
  74130 ┤╭────╭─────────────────────────────────────────────────────────────────────────
  37065 ┤╭────╯─────╯───────────────────────────────────────────────────────────────────
      0 ┼╯
                                               cpu

last store values: [s7=51451 s8=51600 s4=56463 s9=61598 s10=71408 s5=76480 s6=91413 s1=186097 s3=186191 s2=195333]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 7974 ┤╭╮────────╮╭────╮  ╭─╮╭──────╭─╮─╭───╮────────────────────╮ ╭───╭─────╮╭──╮╭───
 7442 ┤╭──────────────────────────────────────────────────────────────────────────────
 6911 ┤│                                              ╰╯         ╰╯╯  ╰╯
 6379 ┤│
 5847 ┤│
 5316 ┤│
 4784 ┤│
 4253 ┤│
 3721 ┤│
 3189 ┤│
 2658 ┤│
 2126 ┤│
 1595 ┤│
 1063 ┤│
  532 ┤│
    0 ┼╯
                                    write_bytes_per_second

last store values: [s5=7427 s6=7498 s7=7521 s8=7521 s4=7526 s10=7526 s9=7539 s2=7761 s3=7761 s1=7803]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 80.00 ┼───────────────────────────────────────────────────────────────────────────────
 76.67 ┤
 73.33 ┤
 70.00 ┤
 66.67 ┤
 63.33 ┤
 60.00 ┤
 56.67 ┤
 53.33 ┤
 50.00 ┤
 46.67 ┤
 43.33 ┤
 40.00 ┤
 36.67 ┤
 33.33 ┤
 30.00 ┼───────────────────────────────────────────────────────────────────────────────
                                            replicas

last store values: [s4=30 s5=30 s6=30 s7=30 s8=30 s9=30 s10=30 s1=80 s2=80 s3=80]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 60.00 ┼─────╮
 56.60 ┤     │
 53.20 ┤     ╰────╮
 49.80 ┤          ╰╮
 46.40 ┤           ╰────╮
 43.00 ┤                ╰────╮
 39.60 ┤                     ╰─────╮
 36.20 ┤                           ╰────╮
 32.80 ┤                                ╰─────╮
 29.40 ┤                                      ╰────╮
 26.00 ┤                                           ╰────╮
 22.60 ┤                                           ╭───╮╭────╮╭───╮╮              ╭╮
 19.20 ┤                                ╭──────────╯───╰╯╯   ╰───────────────╮╭───╮─╭──
 15.80 ┤                ╭─────────╮╭────╯   ╰╯                         ╭───────────────
 12.40 ┤     ╭────╭────────────────────────────────────────────────────────────────────
  9.00 ┼──────────╯─────╯──────────────────────────────────────────────────────────────
                                             leases

last store values: [s7=10 s8=10 s4=11 s9=12 s10=14 s5=15 s6=18 s3=19 s1=20 s2=21]
----
----
