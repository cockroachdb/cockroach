gen_cluster nodes=7 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 256 MiB.
gen_ranges ranges=21 placement_type=skewed bytes=268435456
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# node_cpu_rate_capacity
# utilization: set request_cpu_per_access high to avoid utilization rebalancing

gen_load rate=1000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=10
----

# TODO(kvoli): Reduce this back to 30m once replica thrashing in later half is
# resolved.
eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 14999 ┤╭──╮
 13999 ┤│  │
 12999 ┤│  ╰──╮
 11999 ┤│     │╭──╮
 10999 ┤│     ╰╯  │
  9999 ┤│         ╰╮
  8999 ┤│          ╰─╮
  7999 ┤│            │╭─╮
  7000 ┤│            ╰╯ ╰╮
  6000 ┤│      ╭──╮      ╰──╮
  5000 ┤╭─────╮│──╰╮  ╭─╮   ╰──╮
  4000 ┤│     ╰╯  ╰╭───╮╭──────╭─────╭─────────────────────────────────────────────────
  3000 ┤│         ╭╯╰──╰╭────────────╯─────────────────────────────────────────────────
  2000 ┤│         │╭────╯───╯╯
  1000 ┤│  ╭───────╯────╯
     0 ┼───╯───────╯
                                              cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=3811, s2=3309, s3=3560, s4=3574, s5=3564, s6=3577, s7=3565] (stddev=134.32, mean=3565.71, sum=24960)

plot stat=write_bytes_per_second
----
 10000 ┤╭─────╮
  9333 ┤│  ╰──│╭──╮
  8667 ┤│     ││ ╰│
  8000 ┤│     ││  ╰╮
  7333 ┤│     ╰╯  ╰│╮
  6667 ┤│          ╰─╮╭─╮──╮
  6000 ┤│           ╰╰╯─╰╮ ╰╮   ╭╮
  5333 ┤│            ╰╯─╮╰──────╯╰─────────────────────────────────────────────────────
  4667 ┤│            ╰╯ ╰──╮ ╭╮╭╮─╮────────────────────────────────────────────────────
  4000 ┤│                  ╭─╯╰│╰──────────────────────────────────────────────────────
  3333 ┤│               ╭──────╯
  2667 ┤│         ╭╭────╯╯╰──╯ ╰───────────────────────────────────────────────────────
  2000 ┤│         ╭╯│╰╯╰╯
  1333 ┤│         │╭╯
   667 ┤│  ╭──────╯╯
     0 ┼───╯──────╯
                                     write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=2855, s2=4721, s3=5210, s4=4296, s5=4270, s6=4295, s7=4286] (stddev=664.46, mean=4276.14, sum=29933)

plot stat=replicas sample=1
----
 21.00 ┼──────╮
 19.60 ┤   ╰──╰───╮
 18.20 ┤          │
 16.80 ┤          ╰╮
 15.40 ┤          ╰╰──╮
 14.00 ┤           ╰│ ╰─╮──╮
 12.60 ┤            ╰───╰────────╮
 11.20 ┤                │      │ ╰─────────────────────────────────────────────────────
  9.80 ┤                ╰──╮   ╰╮╭─────────────────────────────────────────────────────
  8.40 ┤                   ╭───╭───────────────────────────────────────────────────────
  7.00 ┤                ╭──────╯╮
  5.60 ┤          ╭╭────╯╯───╯  ╰──────────────────────────────────────────────────────
  4.20 ┤          ╭╯╯
  2.80 ┤          ││╯
  1.40 ┤   ╭──────╯╯
  0.00 ┼───╯──────╯
                                            replicas
initial store values: [s1=21, s2=21, s3=21, s4=0, s5=0, s6=0, s7=0] (stddev=10.39, mean=9.00, sum=63)
last store values: [s1=6, s2=10, s3=11, s4=9, s5=9, s6=9, s7=9] (stddev=1.41, mean=9.00, sum=63)

plot stat=leases sample=1
----
 21.00 ┼───╮
 19.60 ┤   │
 18.20 ┤   ╰──╮
 16.80 ┤      │
 15.40 ┤      ╰───╮
 14.00 ┤          │
 12.60 ┤          ╰──╮
 11.20 ┤             │
  9.80 ┤             ╰───╮
  8.40 ┤                 ╰──╮
  7.00 ┤                    │
  5.60 ┤           ╭────╮   ╰──────────────────────────────────────────────────────────
  4.20 ┤          ╭╯    ╰──────╮
  2.80 ┤          │╮ ╭──╮   ╭──╭───╭───────────────────────────────────────────────────
  1.40 ┤   ╭───────────────────────╯───────────────────────────────────────────────────
  0.00 ┼───╯────────────╯
                                             leases
initial store values: [s1=21, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=7.35, mean=3.00, sum=21)
last store values: [s1=5, s2=2, s3=2, s4=3, s5=3, s6=3, s7=3] (stddev=0.93, mean=3.00, sum=21)
