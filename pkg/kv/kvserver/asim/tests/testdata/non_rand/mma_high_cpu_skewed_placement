gen_cluster nodes=7 node_cpu_rate_capacity_ms=5000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 256 MiB.
gen_ranges ranges=21 placement_type=skewed bytes=268435456
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# node_cpu_rate_capacity
# utilization: set request_cpu_per_access high to avoid utilization rebalancing

gen_load rate=1000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access_us=100 raft_cpu_per_write_us=10
----

# TODO(kvoli): Reduce this back to 30m once replica thrashing in later half is
# resolved.
eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 100500000000 ┤╭──╮
  93800000000 ┤│  │
  87100000000 ┤│  ╰──╮
  80400000000 ┤│     │
  73700000000 ┤│     ╰───╮
  67000000000 ┤│         ╰──╮
  60300000000 ┤│            ╰──╮
  53600000000 ┤│               │
  46900000000 ┤│               ╰──╮
  40200000000 ┤│                  ╰──╮
  33500000000 ┤│                     ╰───╮
  26800000000 ┤│                         ╰─────╮
  20100000000 ┤│            ╭──────╭─╮────╮─╭╮ ╰───╮
  13400000000 ┤│         ╭──╯      │ ╰╭───────────────────────────────────────────────────────
   6700000000 ┤│  ╭───────────────────╯───╭──╯─────╯
            0 ┼───╯───────────────────────╯
                                                     cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=14679337309, s2=14698691814, s3=14629259725, s4=14378365468, s5=14339910950, s6=14391500223, s7=14345282785] (stddev=153194061.62, mean=14494621182.00, sum=101462348274)

plot stat=write_bytes_per_second
----
 5000 ┤╭─────╮╭────────╮
 4667 ┤│  ╰──││────────╰──╮╭─╮╭────────────╮
 4333 ┤│     ╰╯           ╰───────╮──╮     ╰──────────────────────────────────────────
 4000 ┤│                          ╰──╮─────╭─────╮────────────────────────────────────
 3667 ┤│                             ╰─────╯     ╰────────────────────────────────────
 3333 ┤│
 3000 ┤│
 2667 ┤│
 2333 ┤│
 2000 ┤│
 1667 ┤│
 1333 ┤│
 1000 ┤│                   ╭─╮
  667 ┤│               ╭╮  │ ╰╭───────────────────────────────────────────────────────
  333 ┤│  ╭───────────────────╯───╭──╯─────╯
    0 ┼───╯───────────────────────╯
                                    write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=4279, s2=4064, s3=3806, s4=720, s5=702, s6=715, s7=718] (stddev=1655.71, mean=2143.43, sum=15004)

plot stat=replicas sample=1
----
 21.00 ┼────────────────╮
 19.60 ┤   ╰────────────╰──────╮────────────╮
 18.20 ┤                       ╰───╮──╮     ╰──────────────────────────────────────────
 16.80 ┤                           ╰──╮────────────────────────────────────────────────
 15.40 ┤                              ╰────────────────────────────────────────────────
 14.00 ┤
 12.60 ┤
 11.20 ┤
  9.80 ┤
  8.40 ┤
  7.00 ┤
  5.60 ┤
  4.20 ┤                   ╭──╮
  2.80 ┤                   │  ╰╭───────────────────────────────────────────────────────
  1.40 ┤   ╭───────────────────╯───╭──╯─────╯
  0.00 ┼───╯───────────────────────╯
                                            replicas
initial store values: [s1=21, s2=21, s3=21, s4=0, s5=0, s6=0, s7=0] (stddev=10.39, mean=9.00, sum=63)
last store values: [s1=18, s2=17, s3=16, s4=3, s5=3, s6=3, s7=3] (stddev=6.95, mean=9.00, sum=63)

plot stat=leases sample=1
----
 21.00 ┼───╮
 19.60 ┤   │
 18.20 ┤   ╰──╮
 16.80 ┤      │
 15.40 ┤      ╰───╮
 14.00 ┤          ╰──╮
 12.60 ┤             ╰──╮
 11.20 ┤                │
  9.80 ┤                ╰──╮
  8.40 ┤                   ╰──╮
  7.00 ┤                      ╰───╮
  5.60 ┤                      ╭╮  ╰─────╮
  4.20 ┤             ╭─────╭──╮╰───╮─╭╮ ╰───╮
  2.80 ┤          ╭──╯     │  ╰╭───────────────────────────────────────────────────────
  1.40 ┤   ╭───────────────────╯───╭──╯─────╯
  0.00 ┼───╯───────────────────────╯
                                             leases
initial store values: [s1=21, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0] (stddev=7.35, mean=3.00, sum=21)
last store values: [s1=3, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3] (stddev=0.00, mean=3.00, sum=21)
