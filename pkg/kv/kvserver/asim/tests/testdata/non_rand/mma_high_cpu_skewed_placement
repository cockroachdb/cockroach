gen_cluster nodes=7 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease.
gen_ranges ranges=21 placement_type=skewed
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

gen_load rate=1000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=10
----

eval duration=30m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 100500 ┤╭─╮
  93800 ┤│ │
  87100 ┤│ ╰──╮
  80400 ┤│    │
  73700 ┤│    ╰──╮
  67000 ┤│       ╰─╮
  60300 ┤│         ╰──╮
  53600 ┤│            │
  46900 ┤│            ╰──╮
  40200 ┤│               ╰─╮
  33500 ┤│                 ╰──╮
  26800 ┤│                    ╰────╮
  20100 ┤│            ╭─╮╭─╭──╮─╮╭─╮──╮
  13400 ┤│       ╭──╭──────╯──╰─────────────────────────────────────────────────────────
   6700 ┤│ ╭──╭─────╯─────────────────╯
      0 ┼─────╯──────────╯
                                               cpu

last store values: [s6=14422 s1=14444 s4=14457 s5=14489 s2=14531 s3=14563 s7=14570]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 5024 ┤╭─╮──╮
 4689 ┤│ ╰──╮─╮╭─╮╭───╮╭─╮╭──────╮╭───╮
 4354 ┤│    ╰─╮╯ ╰╯   ╰╯ ╰╯      ╰╯   │
 4019 ┤│    ╰─│                       │
 3684 ┤│      ╰╮                      │
 3349 ┤│      ╰╰─╮                    │
 3015 ┤│         │                    ╭──╮
 2680 ┤│         │──╮                 │  ╭─╮╮─╭──╮─╮╭─╮──╭─╮╭─╭──╮─╭──╮──╭─╮──╮
 2345 ┤│         │╭──────╮╭──────╮╭───│──╭────────────────────────────────────────────
 2010 ┤│         ╰╭──────────────────────╯  │─│──│─╭╯─│──│─│──│──│─│──│──│─│──╭───────
 1675 ┤│         ╭╯───╮╭──────╮╭──────╭──╯──│ │  │ ││ │  │ ╰╮ │  │ │  │  │ │  │
 1340 ┤│      ╭──╯  ╭─╰╯╭╮╭───╰╯──────│  │  ╰─╯──╰─╯╰─╰──╯─╯╰─╯──╰─╯──╰──╯─╰──╯
 1005 ┤│      │╭─╯──╯ ╰─╯╰╯           │  │ ╭╯
  670 ┤│    ╭─╯│    ╭─────────────────╯  ╰─╯
  335 ┤│ ╭──╯───────╯
    0 ┼──╯──╯
                                    write_bytes_per_second

last store values: [s4=1903 s5=1911 s6=1916 s1=2136 s7=2369 s2=2382 s3=2397]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 21.00 ┼──╮──╮
 19.60 ┤  ╰────╮───────────────────────╮
 18.20 ┤     │ │                       │
 16.80 ┤     ╰─│                       │
 15.40 ┤       ╰╮                      │
 14.00 ┤        ╰─╮                    │
 12.60 ┤          │──╮                 ╭──╮
 11.20 ┤          │  │                 │  ╭─╮╮─╭──╮─╮╭─╮──╭─╮╭─╭──╮─╭──╮──╭─╮──╮
  9.80 ┤          ╰────────────────────│──╭────────────────────────────────────────────
  8.40 ┤          ╭───────────────────────╯──│─│──│─╭╯─│──│─│──│──│─│──│──│─│──╭───────
  7.00 ┤          │────────────────────╭──╯  │ │  │ ││ │  │ ╰╮ │  │ │  │  │ │  │
  5.60 ┤       ╭──╯  ╭─────────────────│  │  ╰─╯──╰─╯╰─╰──╯─╯╰─╯──╰─╯──╰──╯─╰──╯
  4.20 ┤       │╭─╯──╯                 │  │ ╭╯
  2.80 ┤     ╭─╯╯    ╭─────────────────╯  ╰─╯
  1.40 ┤  ╭──╯───────╯
  0.00 ┼──╯──╯
                                            replicas

last store values: [s4=8 s5=8 s6=8 s1=9 s2=10 s3=10 s7=10]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 21.00 ┼──╮
 19.60 ┤  │
 18.20 ┤  ╰──╮
 16.80 ┤     │
 15.40 ┤     ╰──╮
 14.00 ┤        ╰─╮
 12.60 ┤          ╰──╮
 11.20 ┤             │
  9.80 ┤             ╰──╮
  8.40 ┤                ╰─╮
  7.00 ┤                  ╰──╮
  5.60 ┤                     ╰────╮
  4.20 ┤             ╭─╮╭─╭──╮─╮──╮──╮
  2.80 ┤       ╭──╭───────╯──╰─────────────────────────────────────────────────────────
  1.40 ┤  ╭──╭────╯──────────────────╯
  0.00 ┼─────╯─────────╯
                                             leases

last store values: [s1=3 s2=3 s3=3 s4=3 s5=3 s6=3 s7=3]
----
----
