skip_under_ci
----

gen_cluster nodes=25 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
last store values: [s1=136379, s2=129290, s3=125223, s4=123944, s5=123486, s6=123156, s7=122649, s8=122712, s9=122735, s10=122880, s11=122088, s12=122794, s13=122493, s14=122389, s15=122678, s16=122748, s17=122315, s18=122290, s19=122822, s20=122531, s21=122596, s22=122164, s23=122322, s24=122685, s25=122315] (stddev=2973.94, mean=123587.36, sum=3089684)
mma_high_cpu_25nodes_1_cpu.png (390800b03b09abd1)

plot stat=write_bytes_per_second
----
last store values: [s1=9742, s2=9385, s3=7661, s4=7622, s5=9074, s6=9039, s7=9014, s8=9037, s9=9065, s10=9045, s11=8997, s12=10478, s13=9042, s14=9037, s15=9087, s16=9069, s17=9024, s18=9026, s19=9035, s20=9008, s21=9042, s22=9022, s23=9039, s24=9071, s25=10519] (stddev=591.07, mean=9087.20, sum=227180)
mma_high_cpu_25nodes_1_write_bytes_per_second.png (fda9da96eb95670d)

plot stat=replicas sample=1
----
initial store values: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
last store values: [s1=55, s2=32, s3=18, s4=13, s5=12, s6=10, s7=9, s8=9, s9=9, s10=9, s11=7, s12=9, s13=8, s14=8, s15=9, s16=9, s17=8, s18=8, s19=9, s20=8, s21=9, s22=7, s23=8, s24=9, s25=8] (stddev=10.08, mean=12.00, sum=300)
mma_high_cpu_25nodes_1_replicas.png (dde548647ce289a0)

plot stat=leases sample=1
----
initial store values: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
last store values: [s1=4, s2=4, s3=4, s4=4, s5=4, s6=4, s7=4, s8=4, s9=4, s10=4, s11=4, s12=4, s13=4, s14=4, s15=4, s16=4, s17=4, s18=4, s19=4, s20=4, s21=4, s22=4, s23=4, s24=4, s25=4] (stddev=0.00, mean=4.00, sum=100)
mma_high_cpu_25nodes_1_leases.png (475c649a96dd0bb8)
