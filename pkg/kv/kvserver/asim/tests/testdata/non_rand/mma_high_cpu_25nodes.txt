skip_under_ci
----

gen_cluster nodes=25 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
last store values: [s1=136072, s2=129139, s3=125590, s4=124577, s5=123583, s6=122905, s7=122542, s8=122849, s9=122747, s10=121812, s11=122699, s12=122388, s13=122436, s14=122272, s15=123380, s16=122342, s17=123026, s18=121990, s19=122870, s20=122091, s21=123032, s22=121999, s23=122818, s24=121849, s25=122434] (stddev=2952.35, mean=123577.68, sum=3089442)
mma_high_cpu_25nodes_1_cpu.png (652125b491654e96)

plot stat=write_bytes_per_second
----
last store values: [s1=9725, s2=9361, s3=9154, s4=9136, s5=9082, s6=9041, s7=9018, s8=9047, s9=9060, s10=8991, s11=9017, s12=8988, s13=9039, s14=9045, s15=9116, s16=9051, s17=9050, s18=9011, s19=9035, s20=8990, s21=9062, s22=9013, s23=9054, s24=9021, s25=9038] (stddev=149.87, mean=9085.80, sum=227145)
mma_high_cpu_25nodes_1_write_bytes_per_second.png (076ced00a6db3c14)

plot stat=replicas sample=1
----
initial store values: [s1=56, s2=42, s3=24, s4=15, s5=12, s6=9, s7=8, s8=9, s9=9, s10=6, s11=9, s12=6, s13=8, s14=6, s15=9, s16=6, s17=9, s18=6, s19=9, s20=6, s21=9, s22=6, s23=9, s24=6, s25=6] (stddev=11.71, mean=12.00, sum=300)
last store values: [s1=54, s2=31, s3=19, s4=15, s5=12, s6=10, s7=9, s8=10, s9=9, s10=6, s11=9, s12=8, s13=8, s14=8, s15=11, s16=8, s17=10, s18=7, s19=9, s20=7, s21=10, s22=7, s23=9, s24=6, s25=8] (stddev=9.94, mean=12.00, sum=300)
mma_high_cpu_25nodes_1_replicas.png (edab0c3ae73aec6d)

plot stat=leases sample=1
----
initial store values: [s1=26, s2=14, s3=4, s4=4, s5=4, s6=2, s7=2, s8=2, s9=3, s10=2, s11=4, s12=1, s13=3, s14=2, s15=3, s16=2, s17=3, s18=2, s19=2, s20=2, s21=3, s22=2, s23=4, s24=3, s25=1] (stddev=5.09, mean=4.00, sum=100)
last store values: [s1=4, s2=4, s3=4, s4=4, s5=4, s6=4, s7=4, s8=4, s9=4, s10=4, s11=4, s12=4, s13=4, s14=4, s15=4, s16=4, s17=4, s18=4, s19=4, s20=4, s21=4, s22=4, s23=4, s24=4, s25=4] (stddev=0.00, mean=4.00, sum=100)
mma_high_cpu_25nodes_1_leases.png (f3e23be0390cbc90)
