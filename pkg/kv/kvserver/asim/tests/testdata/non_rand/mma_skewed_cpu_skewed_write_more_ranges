# This test can now roughly equalize both cpu and write bandwidth. It didn't
# use to be able to do this, because the highest cpu node had the lowest write
# bandwidth and vice versa, so neither was able to shed to the other. The
# ignoreLevel logic in rebalanceStores with the grace duration to start
# shedding more aggressively and other related changes have made this much
# better.

gen_cluster nodes=6 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 26 MiB.
gen_ranges ranges=300 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1,s2,s3}:1
----
{s1:*,s2,s3}:1

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates little CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace.
gen_ranges ranges=300 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545
{s4,s5,s6}:1
----
{s4:*,s5,s6}:1

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000
----

setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

eval duration=60m samples=1 seed=42
----
OK

plot stat=cpu sample=1  
----
 20000 ┤╭─╮
 18667 ┤│ ╰──────╮
 17333 ┤│        ╰───╮
 16000 ┤│            ╰──╮
 14667 ┤│               ╰─╮
 13333 ┤│                 ╰╮
 12000 ┤│                  ╰─╮
 10667 ┤│                    ╰───╮
  9333 ┤│                        ╰────╮
  8000 ┤│                             ╰────╮
  6667 ┤│                                  ╰─────╮
  5333 ┤│                                        ╰────╮
  4000 ┤│                     ╭───────╭───────────────╰────╮───────────────────────────
  2667 ┤│                ╭────╯ ╭─────╯            ╭╭──────────────────────────────────
  1333 ┤│       ╭───────╭───────╯     ╭─╭───────────╯
     0 ┼────────────────────────────────╯
                                              cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=3630, s2=3632, s3=3565, s4=3169, s5=3102, s6=2904] (stddev=287.44, mean=3333.67, sum=20002)

plot stat=write_bytes_per_second
----
 19999999 ┤╭───╮────╮
 18666666 ┤│   ╰────╮──────╮
 17333333 ┤│        ╰────╮ ╰──╮
 15999999 ┤│             ╰──╮ ╰──╮
 14666666 ┤│                ╰─╮  ╰───────╮
 13333333 ┤│                  ╰─╮        ╰───────────────────╮
 11999999 ┤│                    ╰──╮                         ╰──╮
 10666666 ┤│                     ╰─╰──────────────────────────────────────────────────────
  9333333 ┤│                          ╭─────────────────────────╯────────────╭────────────
  8000000 ┤│                     ╭╭───╯──────────────────────╭───────────────╯
  6666666 ┤│                   ╭╭─╯──────────────────────────╯
  5333333 ┤│                  ╭─╯
  4000000 ┤│              ╭╭╭─╯
  2666667 ┤│          ╭─────╯
  1333333 ┤│    ╭─────╯╯
        0 ┼╯────╯╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=9511789, s2=8717420, s3=10302826, s4=10492479, s5=10493001, s6=10494925] (stddev=671512.66, mean=10002073.33, sum=60012440)

plot stat=replicas  
----
 453 ┤                                                   ╭───────────────────────────
 433 ┤                          ╭────────────────────────╯──╭────────────────────────
 413 ┤                      ╭───╯───────────────────────────╯
 394 ┤                   ╭─╭╯─╯
 374 ┤                  ╭╭─╯
 354 ┤               ╭─╭─╯
 334 ┤          ╭╭─────╯
 314 ┤    ╭╭─────╯
 295 ┼──────╮───╮
 275 ┤     ╰╰────╮──────╮
 255 ┤           ╰───╮  ╰╮
 235 ┤               ╰───╮──╮
 215 ┤                  ╰│  ╰──────────╮
 196 ┤                   ╰──╮          ╰─────────────────╮
 176 ┤                     ╰╰──╮                         ╰─╮
 156 ┤                      ╰──╰─────────────────────────────────────────────────────
                                          replicas
initial store values: [s1=300, s2=300, s3=300, s4=300, s5=300, s6=300] (stddev=0.00, mean=300.00, sum=1800)
last store values: [s1=441, s2=432, s3=453, s4=159, s5=159, s6=156] (stddev=142.13, mean=300.00, sum=1800)

plot stat=leases sample=1  
----
 353 ┤                     ╭─────────────────────────────────────────────────────────
 329 ┤              ╭──────╯
 306 ┼──╮───────────╯
 282 ┤  ╰──────╮
 259 ┤         ╰────╮
 235 ┤              ╰───╮
 212 ┤                  ╰╮
 188 ┤                   ╰─╮
 165 ┤                     ╰──╮
 141 ┤                        ╰─────╮
 118 ┤                              ╰──────╮
  94 ┤                                     ╰─────╮
  71 ┤                                           ╰────╮
  47 ┤                  ╭───────╭──────────────────╭─╭───────────────────────────────
  24 ┤        ╭─────────╭───────╯     ╭╭─────────────╯
   0 ┼─────────────────────────────────╯
                                           leases
initial store values: [s1=300, s2=0, s3=0, s4=300, s5=0, s6=0] (stddev=141.42, mean=100.00, sum=600)
last store values: [s1=352, s2=55, s3=54, s4=48, s5=47, s6=44] (stddev=112.76, mean=100.00, sum=600)
