# This test can now roughly equalize both cpu and write bandwidth. It didn't
# use to be able to do this, because the highest cpu node had the lowest write
# bandwidth and vice versa, so neither was able to shed to the other. The
# ignoreLevel logic in rebalanceStores with the grace duration to start
# shedding more aggressively and other related changes have made this much
# better.

gen_cluster nodes=6 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 26 MiB.
gen_ranges ranges=300 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1,s2,s3}:1
----
{s1,s2,s3}:1

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates little CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace.
gen_ranges ranges=300 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545 add_to_existing=true
{s4,s5,s6}:1
----
{s4,s5,s6}:1

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000 add_to_existing=true
----

setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

eval duration=60m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true show_initial_value=true
----
----

 100000 ┤╭────╮
  93333 ┤│    ╰──────╮
  86667 ┤│           ╰───╮
  80000 ┤│               ╰──╮
  73333 ┤│                  ╰──╮
  66667 ┤│                     ╰─╮
  60000 ┤│                       ╰─╮
  53333 ┤│                         ╰╮╭╮
  46667 ┤│                          ╰╯╰╮
  40000 ┤│                             ╰──╮
  33333 ┤│                             ╭───────╮─────╮───╮
  26667 ┤│                     ╭╮ ╭╭───╯      ╭─────────────────────────────────────────
  20000 ┤╭─────────────────────╯╰─────────────╯───────╯──╯
  13333 ┤│                ╭──╰─╰──────╯
   6667 ┤│     ╭──────────╯─╯
      0 ┼╯─────╯──╯
                                               cpu

initial store values: [s1=0 s2=0 s3=0 s4=0 s5=0 s6=0] (stddev=0.00)
last store values: [s1=29510 s2=29255 s3=29000 s4=24016 s5=24425 s6=23736] (stddev=2609.85)
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 19999999 ┤╭──────────────────────╮
 18666666 ┤│    ╰╰──────╮         ╰╮
 17333333 ┤│           ╰╰────╮     ╰──────────────────────╮
 15999999 ┤│                ╰╰─╮                          ╰───────────────────╮
 14666666 ┤│                 ╰╮╰╮                                             ╰───────────
 13333333 ┤│                  ╰─╰╮
 11999999 ┤│                    ╰│
 10666666 ┤│                     ╰────────────────────────────────────────────────────────
  9333333 ┤│                     ╭─╯              ╰───────────────────────────────────────
  8000000 ┤│                    ╭│
  6666666 ┤│                   ╭╭╯
  5333333 ┤│                  ╭─╯
  4000000 ┤│                 ╭╯                                            ╭──────────────
  2666667 ┤│            ╭────╯                                ╭────────────╯
  1333333 ┤│     ╭──────╯                     ╭───────────────╯
        0 ┼╯─────╯────────────────────────────╯
                                        write_bytes_per_second

last store values: [s1=4562452 s2=9441839 s3=10497665 s4=10496990 s5=10563974 s6=14450660] (stddev=2901136.32)
----
----

plot stat=replicas show_last_value=true  show_initial_value=true
----
----

 457 ┤                       ╭───────────────────────────────────────────────────────
 438 ┤                      ╭╯                  ╰────────────────────────────────────
 419 ┤                     ╭│
 400 ┤                    ╭╭╯
 381 ┤                   ╭─╯
 362 ┤                  ╭╯
 343 ┤               ╭──╯
 324 ┤         ╭─────╯
 305 ┼───────────────────────╮
 286 ┤    ╰╰─────────╮───╮   ╰──────────────────────╮
 267 ┤              ╰╰──╮╰────╮                     ╰────────────────────╮───────────
 248 ┤                  ╰──╮  ╰────────────────────────────────────╯     ╰───────────
 229 ┤                   ╰╮╰╮
 210 ┤                    ╰╮│                        ╭───────────────────────────────
 191 ┤                     ╰╰╮        ╭──────────────────────────────────────────────
 172 ┤                      ╰╰────────╯───╯
                                          replicas

initial store values: [s1=300 s2=300 s3=300 s4=300 s5=300 s6=300] (stddev=0.00)
last store values: [s1=275 s2=432 s3=450 s4=200 s5=196 s6=247] (stddev=103.42)
----
----

plot stat=leases sample=1 show_last_value=true  show_initial_value=true
----
----

 300 ┼────────╮
 280 ┤        ╰──────╮
 260 ┤            ╰──╰──╮
 240 ┤                ╰─╰╮╮
 220 ┤                   ╰╮──╮
 200 ┤                    ╰╮ ╰╮                   ╭──────────────────────────────────
 180 ┤                     ╰──────────────────────╯──────────────────────────────────
 160 ┤                          ╰──╮         │
 140 ┤                             ╭─╮       │
 120 ┤                        ╭──╭───────────╯
 100 ┤                     ╭╭────╯        ╰──│───────────────────────────────────────
  80 ┤                    ╭─╯                │
  60 ┤                  ╭─╯                  ╰───────────────────────────────────────
  40 ┤              ╭───╯            ╭───────────────────────────────────────────────
  20 ┤      ╭───────╯     ╭──────────────────────────────────────────────────────────
   0 ┼────────────────────╯
                                           leases

initial store values: [s1=300 s2=0 s3=0 s4=300 s5=0 s6=0] (stddev=141.42)
last store values: [s1=90 s2=65 s3=180 s4=193 s5=44 s6=28] (stddev=64.15)
----
----
