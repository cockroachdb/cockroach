# Disable all lease and replica movement.
setting rebalance_mode=0 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This testfile provides examples generating imbalanced CPU usage and write
# load. All the examples will use the same cluster, which has 10 nodes with
# 20_000 CPU capacity each.
gen_cluster nodes=10 node_cpu_rate_capacity=20000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=10000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

setting rebalance_mode=3 delay=2m
----

eval duration=5m samples=1 seed=42 metrics=(cpu,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=10020, s2=9921, s3=9998, s4=9923, s5=9990, s6=10006, s7=9970, s8=10202, s9=9970, s10=9995] (stddev=74.39, mean=9999.50, sum=99995)
leases#1: first: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
leases#1: last:  [s1=24, s2=3, s3=3, s4=5, s5=4, s6=4, s7=5, s8=4, s9=3, s10=5] (stddev=6.05, mean=6.00, sum=60)
replicas#1: first: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
replicas#1: last:  [s1=30, s2=27, s3=30, s4=15, s5=13, s6=12, s7=13, s8=15, s9=12, s10=13] (stddev=7.31, mean=18.00, sum=180)
write_bytes_per_second#1: last:  [s1=6983100, s2=5989048, s3=6986495, s4=2013966, s5=1347561, s6=998044, s7=1339248, s8=2006398, s9=997054, s10=1330659] (stddev=2427881.97, mean=2999157.30, sum=29991573)
artifacts[default]: f7377dae79f291a4

# Next setup a cluster such that there will be imbalanced CPU usage but
# balanced write load.
#
# Write only workload, which generates:
# - 0 request cpu nanos/s 
# - 100_000 write bytes per second
# over the first half of the keyspace, evenly distributed over the cluster
# initially.
gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=1 max_key=10000 replace=true
----

# Read only workload, which generates:
# - 100_000 request cpu nanos/s
# - 10_000  raft cpu nanos/s
# - 1000    write bytes per second
# over the second half of the keyspace, which is on s1-s3, with all the leases
# on s1 (all request CPU).
gen_load rate=1000 rw_ratio=0 request_cpu_per_access=90 raft_cpu_per_write=10 min_key=10001 max_key=20000
----

setting rebalance_mode=0
----

eval duration=5m samples=1 seed=42 metrics=(cpu,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=68329, s2=15654, s3=15554, s4=10006, s5=3489, s6=0, s7=3266, s8=3309, s9=0, s10=0] (stddev=19644.73, mean=11960.70, sum=119607)
leases#1: first: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
leases#1: last:  [s1=23, s2=5, s3=5, s4=6, s5=4, s6=3, s7=4, s8=4, s9=3, s10=3] (stddev=5.74, mean=6.00, sum=60)
replicas#1: first: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
replicas#1: last:  [s1=35, s2=38, s3=38, s4=12, s5=10, s6=9, s7=10, s8=10, s9=9, s10=9] (stddev=12.49, mean=18.00, sum=180)
write_bytes_per_second#1: last:  [s1=30849, s2=30964, s3=30964, s4=30168, s5=29876, s6=29948, s7=30135, s8=30135, s9=30039, s10=29905] (stddev=422.24, mean=30298.30, sum=302983)
artifacts[default]: 1260e995808c8da
