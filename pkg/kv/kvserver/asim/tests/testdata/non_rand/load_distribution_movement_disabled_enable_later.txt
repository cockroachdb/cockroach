skip_under_ci
----

# 16vCPU machines.
gen_cluster nodes=10 node_cpu_rate_capacity=16000000000
----

# 30 ranges on first fives nodes, 30 ranges on the last five nodes.

gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=replica_placement
{s1,s2,s3}:1
{s2,s3,s4}:1
{s3,s4,s5}:1
{s4,s5,s1}:1
{s5,s1,s2}:1
----
{s1:*,s2,s3}:1
{s2:*,s3,s4}:1
{s3:*,s4,s5}:1
{s4:*,s5,s1}:1
{s5:*,s1,s2}:1

gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=replica_placement
{s6,s7,s8}:1
{s7,s8,s9}:1
{s8,s9,s10}:1
{s9,s10,s6}:1
{s10,s6,s7}:1
----
{s6:*,s7,s8}:1
{s7:*,s8,s9}:1
{s8:*,s9,s10}:1
{s9:*,s10,s6}:1
{s10:*,s6,s7}:1

# Read-only workload on first 30 ranges. 5 cores.
gen_load rate=1000000 rw_ratio=1 request_cpu_per_access=50000 min_key=1 max_key=10000
----

# Write only workload on second 30 ranges. 10mb/s before 3x replication.
gen_load rate=10000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

# Two minutes into the test, we'll enable the MMA.
setting rebalance_mode=4 delay=2m
----

eval duration=7m samples=1 seed=42 cfgs=(sma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=4803276993, s2=4490036470, s3=4701738561, s4=4638584610, s5=5064699447, s6=5296204207, s7=5262154951, s8=5305090671, s9=5182137151, s10=5231667635] (stddev=293062528.06, mean=4997559069.60, sum=49975590696)
cpu#1: thrash_pct: [s1=51%, s2=42%, s3=63%, s4=30%, s5=50%, s6=14%, s7=28%, s8=5%, s9=22%, s10=13%]  (sum=318%)
cpu_util#1: last:  [s1=0.30, s2=0.28, s3=0.29, s4=0.29, s5=0.32, s6=0.33, s7=0.33, s8=0.33, s9=0.32, s10=0.33] (stddev=0.02, mean=0.31, sum=3)
cpu_util#1: thrash_pct: [s1=51%, s2=42%, s3=63%, s4=30%, s5=50%, s6=14%, s7=28%, s8=5%, s9=22%, s10=13%]  (sum=318%)
leases#1: first: [s1=6, s2=6, s3=6, s4=6, s5=6, s6=6, s7=6, s8=6, s9=6, s10=6] (stddev=0.00, mean=6.00, sum=60)
leases#1: last:  [s1=56, s2=57, s3=56, s4=56, s5=60, s6=57, s7=57, s8=59, s9=57, s10=56] (stddev=1.30, mean=57.10, sum=571)
leases#1: thrash_pct: [s1=145%, s2=121%, s3=131%, s4=109%, s5=165%, s6=33%, s7=48%, s8=18%, s9=36%, s10=33%]  (sum=838%)
replicas#1: first: [s1=18, s2=18, s3=18, s4=18, s5=18, s6=18, s7=18, s8=18, s9=18, s10=18] (stddev=0.00, mean=18.00, sum=180)
replicas#1: last:  [s1=173, s2=178, s3=178, s4=175, s5=177, s6=167, s7=166, s8=166, s9=169, s10=164] (stddev=5.22, mean=171.30, sum=1713)
replicas#1: thrash_pct: [s1=148%, s2=136%, s3=142%, s4=155%, s5=161%, s6=17%, s7=15%, s8=14%, s9=15%, s10=18%]  (sum=819%)
write_bytes_per_second#1: last:  [s1=3666349, s2=3339637, s3=4000618, s4=3648915, s5=3326166, s6=2679632, s7=1993873, s8=2654127, s9=2662661, s10=1991827] (stddev=667287.07, mean=2996380.50, sum=29963805)
write_bytes_per_second#1: thrash_pct: [s1=108%, s2=167%, s3=236%, s4=153%, s5=128%, s6=172%, s7=234%, s8=146%, s9=157%, s10=158%]  (sum=1660%)
artifacts[sma-count]: ce770f737867f52a
==========================
