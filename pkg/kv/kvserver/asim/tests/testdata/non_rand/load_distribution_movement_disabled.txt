# Disable all lease and replica movement.
setting rebalance_mode=0 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This testfile provides examples generating imbalanced CPU usage and write
# load. All the examples will use the same cluster, which has 10 nodes with
# 20_000 CPU capacity each.
gen_cluster nodes=10 node_cpu_rate_capacity=20000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000
----

eval duration=5m samples=1 seed=42
----
OK

plot stat=cpu
----
last store values: [s1=10020, s2=9921, s3=9998, s4=9923, s5=9990, s6=10006, s7=9970, s8=10202, s9=9970, s10=9995] (stddev=74.39, mean=9999.50, sum=99995)
load_distribution_movement_disabled_1_cpu.png (278ae26598ec0eae)

plot stat=write_bytes_per_second
----
last store values: [s1=99999, s2=80041, s3=46659, s4=23381, s5=13438, s6=10100, s7=6589, s8=6589, s9=6600, s10=6600] (stddev=32537.48, mean=29999.60, sum=299996)
load_distribution_movement_disabled_1_write_bytes_per_second.png (19b2b62f49761023)

plot stat=replicas
----
initial store values: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
last store values: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
load_distribution_movement_disabled_1_replicas.png (f7ca1c72e219e471)

plot stat=leases
----
initial store values: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
last store values: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
load_distribution_movement_disabled_1_leases.png (7147bbd06d47d2a9)

# Next setup a cluster such that there will be imbalanced CPU usage but
# balanced write load.
#
# Write only workload, which generates:
# - 0 request cpu nanos/s 
# - 100_000 write bytes per second
# over the first half of the keyspace, evenly distributed over the cluster
# initially.
gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=1 max_key=10000 replace=true
----

# Read only workload, which generates:
# - 100_000 request cpu nanos/s
# - 10_000  raft cpu nanos/s
# - 1000    write bytes per second
# over the second half of the keyspace, which is on s1-s3, with all the leases
# on s1 (all request CPU).
gen_load rate=1000 rw_ratio=0 request_cpu_per_access=90 raft_cpu_per_write=10 min_key=10001 max_key=20000
----

eval duration=5m samples=1 seed=42
----
OK

plot stat=cpu sample=2
----
last store values: [s1=57797, s2=32223, s3=13751, s4=2338, s5=1343, s6=1010, s7=3616, s8=658, s9=3615, s10=3645] (stddev=17821.77, mean=11999.60, sum=119996)
load_distribution_movement_disabled_2_cpu.png (9c0642680c36d141)

plot stat=write_bytes_per_second sample=2
----
last store values: [s1=30987, s2=30801, s3=30467, s4=30302, s5=29976, s6=30049, s7=30168, s8=30168, s9=30105, s10=29972] (stddev=331.56, mean=30299.50, sum=302995)
load_distribution_movement_disabled_2_write_bytes_per_second.png (a936ae75e86a7d71)

plot stat=replicas sample=2
----
initial store values: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
last store values: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
load_distribution_movement_disabled_2_replicas.png (f7ca1c72e219e471)

plot stat=leases sample=2
----
initial store values: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
last store values: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
load_distribution_movement_disabled_2_leases.png (7147bbd06d47d2a9)
