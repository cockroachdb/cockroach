# Disable all lease and replica movement.
setting rebalance_mode=0 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This testfile provides examples generating imbalanced CPU usage and write
# load. All the examples will use the same cluster, which has 10 nodes with
# 20_000 CPU capacity each.
gen_cluster nodes=10 node_cpu_rate_capacity=20000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=10001 max_key=20000 add_to_existing=true
----

setting rebalance_mode=3 delay=2m
----

eval duration=5m samples=1 seed=42
----
OK

plot stat=cpu show_last_value=true
----
----

 10482 ┤ ╭╮╮─────────────────╮                          ╭──────────────────────────────
  9783 ┤ ╭─────────────────────────────────────────────────────────────────────────────
  9084 ┤ │
  8386 ┤ │
  7687 ┤ │
  6988 ┤ │
  6289 ┤ │
  5590 ┤ │
  4892 ┤ │
  4193 ┤ │
  3494 ┤ │
  2795 ┤ │
  2096 ┤ │
  1398 ┤ │
   699 ┤ │
     0 ┼─╯
                                              cpu

last store values: [s2=9921 s4=9923 s7=9970 s9=9970 s5=9990 s10=9995 s3=9998 s6=10006 s1=10020 s8=10202]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 100000 ┤ ╭─────────────────────────────╮ ╭╮
  93333 ┤ │                             │╭╯╰─────────────╮╭─────────────╮
  86667 ┤ │                             ╰╯──────────────╮╰╯             │
  80000 ┤ │                                             ╰╮──────────────╰─╮
  73333 ┤ │                                              │                │╭────────────
  66667 ┤ │                                              ╰──────────────╮ ││────────────
  60000 ┤ │                                                             ╰─╰╯
  53333 ┤ │                                                               ╰─────────────
  46667 ┤ │
  40000 ┤ │
  33333 ┤ │
  26667 ┤ │
  20000 ┤ │                                                                ╭────────────
  13333 ┤ │                                             ╭───────────────╭──╯╮─╭─────────
   6667 ┤ │                              ╭─────╭╮───────╮╮╭─────────────╯──╯╰─╯╰╯  ╰─╯ ╰
      0 ┼──────────────────────────────────────╯╰─────────╯               ╰╯
                                      write_bytes_per_second

last store values: [s5=9990 s9=10192 s6=13328 s7=13349 s4=16587 s8=16720 s10=20028 s2=56321 s1=69661 s3=73043]
----
----

plot stat=replicas show_last_value=true
----
----

 39.00 ┼────────────────────────────────╮
 37.00 ┤                               ╰╰──────────────────────────────╮
 35.00 ┤                               ╰╰──────────────╮╮              │
 33.00 ┤                                               ╰╮──────────────╰─╮
 31.00 ┤                                                │                ╰─────────────
 29.00 ┤                                                ╰──────────────╮ ╰─────────────
 27.00 ┤                                                               ╰─╮
 25.00 ┤                                                                 ╰─────────────
 23.00 ┤
 21.00 ┤
 19.00 ┤
 17.00 ┤
 15.00 ┤                                                                 ╭─────────────
 13.00 ┤                                                ╭──────────────╭─╯─────────────
 11.00 ┤                                               ╭╭╭─────────────╯───────────────
  9.00 ┼─────────────────────────────────────────────────╯
                                            replicas

last store values: [s5=12 s9=12 s6=13 s7=13 s4=14 s8=14 s10=15 s2=26 s1=30 s3=31]
----
----

plot stat=leases show_last_value=true
----
----

 33.00 ┼───────────────────────────────╮
 31.00 ┤                               │
 29.00 ┤                               ╰────────────────╮
 27.00 ┤                                                ╰────────────────╮
 25.00 ┤                                                                 │
 23.00 ┤                                                                 ╰─────────────
 21.00 ┤
 19.00 ┤
 17.00 ┤
 15.00 ┤
 13.00 ┤
 11.00 ┤
  9.00 ┤
  7.00 ┤
  5.00 ┤                                                ╭────────────────╭─────────────
  3.00 ┼─────────────────────────────────────────────────────────────────╯─────────────
                                             leases

last store values: [s2=3 s3=3 s8=3 s5=4 s6=4 s7=4 s4=5 s9=5 s10=5 s1=24]
----
----

# Next setup a cluster such that there will be imbalanced CPU usage but
# balanced write load.
#
# Write only workload, which generates:
# - 0 request cpu nanos/s 
# - 100_000 write bytes per second
# over the first half of the keyspace, evenly distributed over the cluster
# initially.
gen_load rate=1000 rw_ratio=0 min_block=100 max_block=100 min_key=1 max_key=10000
----

# Read only workload, which generates:
# - 100_000 request cpu nanos/s
# - 10_000  raft cpu nanos/s
# - 1000    write bytes per second
# over the second half of the keyspace, which is on s1-s3, with all the leases
# on s1 (all request CPU).
gen_load rate=1000 rw_ratio=0 request_cpu_per_access=90 raft_cpu_per_write=10 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=5m samples=1 seed=42
----
OK

plot stat=cpu sample=2 show_last_value=true
----
----

 100000 ┤ ╭─────────────────────────────────────────────────────────────────────────────
  93333 ┤ │
  86667 ┤ │
  80000 ┤ │
  73333 ┤ │
  66667 ┤ │
  60000 ┤ │
  53333 ┤ │
  46667 ┤ │
  40000 ┤ │
  33333 ┤ │
  26667 ┤ │
  20000 ┤ │
  13333 ┤ │
   6667 ┤ ╭─────────────────────────────────────────────────────────────────────────────
      0 ┼───────────────────────────────────────────────────────────────────────────────
                                               cpu

last store values: [s4=0 s5=0 s6=0 s7=0 s8=0 s9=0 s10=0 s2=10000 s3=10000 s1=99999]
----
----

plot stat=write_bytes_per_second sample=2 show_last_value=true
----
----

 31540 ┤ ╭──╮──────────────────────────────────────────────────────────────────────────
 29437 ┤ ╭─────────────────────────────────────────────────────────────────────────────
 27335 ┤ │
 25232 ┤ │
 23129 ┤ │
 21027 ┤ │
 18924 ┤ │
 16821 ┤ │
 14719 ┤ │
 12616 ┤ │
 10513 ┤ │
  8411 ┤ │
  6308 ┤ │
  4205 ┤ │
  2103 ┤ │
     0 ┼─╯
                                     write_bytes_per_second

last store values: [s5=29841 s10=29905 s6=29948 s9=30039 s4=30068 s7=30102 s8=30102 s1=30987 s2=31001 s3=31001]
----
----

plot stat=replicas sample=2 show_last_value=true
----
----

 39.00 ┼───────────────────────────────────────────────────────────────────────────────
 37.00 ┤
 35.00 ┤
 33.00 ┤
 31.00 ┤
 29.00 ┤
 27.00 ┤
 25.00 ┤
 23.00 ┤
 21.00 ┤
 19.00 ┤
 17.00 ┤
 15.00 ┤
 13.00 ┤
 11.00 ┤
  9.00 ┼───────────────────────────────────────────────────────────────────────────────
                                            replicas

last store values: [s4=9 s5=9 s6=9 s7=9 s8=9 s9=9 s10=9 s1=39 s2=39 s3=39]
----
----

plot stat=leases sample=2 show_last_value=true
----
----

 33.00 ┼───────────────────────────────────────────────────────────────────────────────
 31.00 ┤
 29.00 ┤
 27.00 ┤
 25.00 ┤
 23.00 ┤
 21.00 ┤
 19.00 ┤
 17.00 ┤
 15.00 ┤
 13.00 ┤
 11.00 ┤
  9.00 ┤
  7.00 ┤
  5.00 ┤
  3.00 ┼───────────────────────────────────────────────────────────────────────────────
                                             leases

last store values: [s2=3 s3=3 s4=3 s5=3 s6=3 s7=3 s8=3 s9=3 s10=3 s1=33]
----
----
