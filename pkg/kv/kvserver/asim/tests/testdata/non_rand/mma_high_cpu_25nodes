gen_cluster nodes=25 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 1546500 ┤╭──╮
 1443400 ┤│  │
 1340300 ┤│  ╰──╮
 1237200 ┤│     ╰──╮
 1134100 ┤│        ╰───╮
 1031000 ┤│            │
  927900 ┤│            ╰──╮
  824800 ┤│               ╰──╮
  721700 ┤│                  ╰──╮
  618600 ┤│                     ╰──────╮
  515500 ┤│                            ╰──╮
  412400 ┤│                               ╰──────╮
  309300 ┤│                                      ╰─────╮
  206200 ┤│                  ╭──╮╭─╮╭─╮╭─────╮╭─╮╭─╮╭─╮╰─────────╮
  103100 ┤╭──╭───────────────────────────────────────────────────────────────────────────
       0 ┼───╯
                                                cpu

last store values: [s1=120932 s2=122957 s3=123785 s4=124880 s5=123766 s6=124742 s7=123631 s8=123877 s9=123293 s10=123319 s11=125412 s12=124144 s13=124168 s14=123493 s15=124942 s16=123470 s17=122573 s18=123501 s19=123383 s20=122821 s21=122709 s22=122404 s23=122668 s24=122742 s25=125536]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 19564 ┤               ╭───────────────────────────────────────────────────────────────
 18260 ┤               │
 16956 ┤               │
 15651 ┤               │
 14347 ┤               │
 13043 ┤               │
 11739 ┤         ╭─────╮╭──────────────────────────────────────────────────────────────
 10434 ┤╭╮╭──╮╭──╭────────────╭────────────────────────────────────────────────────────
  9130 ┤╭───────────╮╭────────╯────────────────────────────────────────────────────────
  7826 ┤│        │  ╰╯ ╰╯
  6521 ┤│        │     │
  5217 ┤│        │     │
  3913 ┤│        │     ╰──────╮
  2609 ┤│        ╰─────╰──────│
  1304 ┤│               ╰─────╰────────────────────────────────────────────────────────
    -0 ┼╯                                               ╰──╰───────────────────────────
                                     write_bytes_per_second

last store values: [s1=59 s2=150 s3=1659 s4=19550 s5=9095 s6=12096 s7=9065 s8=9097 s9=9095 s10=9072 s11=10634 s12=9080 s13=12114 s14=10588 s15=10691 s16=9098 s17=9038 s18=9083 s19=10529 s20=10495 s21=9049 s22=9050 s23=9053 s24=9071 s25=10661]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 56.00 ┼───────────────╮
 52.53 ┤   ╰──╮        │
 49.07 ┤      ╰──╮     │
 45.60 ┤         │     │
 42.13 ┤         │     ╰──────╮
 38.67 ┤         ╰──╮         │
 35.20 ┤            ╰──╮      │
 31.73 ┤               ╰───╮  ╰──╮
 28.27 ┤                   ╰──╮  ╰──╮
 24.80 ┤                      ╰──╮  ╰───╮
 21.33 ┤                         ╰──╮   ╰────╮
 17.87 ┤                            ╭─────╭╭──╭────────────────────────────────────────
 14.40 ┤               ╭───────────────╭──────╯────────────────────────────────────────
 10.93 ┤         ╭─────╭──────╭────────╯───────────────────────────────────────────────
  7.47 ┼──────────────────────╯──╯──────╯────────╯───────────────╯
  4.00 ┤                                                         ╰─────────────────────
                                            replicas

last store values: [s1=4 s2=10 s3=13 s4=16 s5=13 s6=16 s7=12 s8=13 s9=11 s10=11 s11=18 s12=14 s13=14 s14=12 s15=17 s16=11 s17=9 s18=12 s19=11 s20=9 s21=9 s22=9 s23=9 s24=9 s25=18]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 51.00 ┼───╮
 47.67 ┤   ╰──╮
 44.33 ┤      │
 41.00 ┤      ╰──╮
 37.67 ┤         ╰───╮
 34.33 ┤             ╰──╮
 31.00 ┤                │
 27.67 ┤                ╰─────╮
 24.33 ┤                      ╰───╮
 21.00 ┤                          ╰──╮
 17.67 ┤                             ╰─────╮
 14.33 ┤                                   ╰───╮
 11.00 ┤                                       ╰─────╮
  7.67 ┤             ╭─╮   ╭──╭──╭──╮╭────────╮╭─╮╭──╮─────╭──╮╭─╮───────────────╮
  4.33 ┼───╭───────────────────────────────────────────────────────────────────────────
  1.00 ┼───╯
                                             leases

last store values: [s1=4 s2=4 s3=4 s4=4 s5=4 s6=4 s7=4 s8=4 s9=4 s10=4 s11=4 s12=4 s13=4 s14=4 s15=4 s16=4 s17=4 s18=4 s19=4 s20=4 s21=4 s22=4 s23=4 s24=4 s25=4]
----
----
