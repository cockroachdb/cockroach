skip_under_ci
----

gen_cluster nodes=25 node_cpu_rate_capacity_ms=8000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 1546786 ┤╭──────────────────────────────────────────────────────────────────────────────
 1443667 ┤│
 1340548 ┤│
 1237429 ┤│
 1134310 ┤│
 1031191 ┤│
  928072 ┤│
  824953 ┤│
  721833 ┤│
  618714 ┤│
  515595 ┤│
  412476 ┤│
  309357 ┤│
  206238 ┤│
  103119 ┤╭──────────────────────────────────────────────────────────────────────────────
       0 ┼───────────────────────────────────────────────────────────────────────────────
                                                cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=1546769, s2=76821, s3=76724, s4=61839, s5=61688, s6=61798, s7=61793, s8=31796, s9=61773, s10=61829, s11=91784, s12=31822, s13=91855, s14=61750, s15=61725, s16=61908, s17=61750, s18=61760, s19=61908, s20=61821, s21=61776, s22=61770, s23=91825, s24=91874, s25=31830] (stddev=290957.54, mean=123599.52, sum=3089988)

plot stat=write_bytes_per_second
----
 9835 ┤╭──────────────────────────────────────────────────────────────────────────────
 9179 ┤╭──────────────────────────────────────────────────────────────────────────────
 8524 ┤│╯ ╰╯ ╰╯
 7868 ┤│
 7212 ┤│
 6557 ┤│
 5901 ┤│
 5245 ┤│
 4590 ┤│
 3934 ┤│
 3278 ┤│
 2623 ┤│
 1967 ┤│
 1311 ┤│
  656 ┤│
    0 ┼╯
                                    write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=9755, s2=9747, s3=9720, s4=9001, s5=8990, s6=8984, s7=8975, s8=8997, s9=9020, s10=9003, s11=8982, s12=8951, s13=9012, s14=9013, s15=9041, s16=9024, s17=8999, s18=9000, s19=8990, s20=8975, s21=9001, s22=9005, s23=9008, s24=9024, s25=9020] (stddev=241.23, mean=9089.48, sum=227237)

plot stat=replicas sample=1
----
 56.00 ┼───────────────────────────────────────────────────────────────────────────────
 52.67 ┤
 49.33 ┤
 46.00 ┤
 42.67 ┤
 39.33 ┤
 36.00 ┤
 32.67 ┤
 29.33 ┤
 26.00 ┤
 22.67 ┤
 19.33 ┤
 16.00 ┤
 12.67 ┤
  9.33 ┤
  6.00 ┼───────────────────────────────────────────────────────────────────────────────
                                            replicas
initial store values: [s1=56, s2=56, s3=56, s4=6, s5=6, s6=6, s7=6, s8=6, s9=6, s10=6, s11=6, s12=6, s13=6, s14=6, s15=6, s16=6, s17=6, s18=6, s19=6, s20=6, s21=6, s22=6, s23=6, s24=6, s25=6] (stddev=16.25, mean=12.00, sum=300)
last store values: [s1=56, s2=56, s3=56, s4=6, s5=6, s6=6, s7=6, s8=6, s9=6, s10=6, s11=6, s12=6, s13=6, s14=6, s15=6, s16=6, s17=6, s18=6, s19=6, s20=6, s21=6, s22=6, s23=6, s24=6, s25=6] (stddev=16.25, mean=12.00, sum=300)

plot stat=leases sample=1
----
 51.00 ┼───────────────────────────────────────────────────────────────────────────────
 47.67 ┤
 44.33 ┤
 41.00 ┤
 37.67 ┤
 34.33 ┤
 31.00 ┤
 27.67 ┤
 24.33 ┤
 21.00 ┤
 17.67 ┤
 14.33 ┤
 11.00 ┤
  7.67 ┤
  4.33 ┼───────────────────────────────────────────────────────────────────────────────
  1.00 ┼───────────────────────────────────────────────────────────────────────────────
                                             leases
initial store values: [s1=51, s2=2, s3=2, s4=2, s5=2, s6=2, s7=2, s8=1, s9=2, s10=2, s11=3, s12=1, s13=3, s14=2, s15=2, s16=2, s17=2, s18=2, s19=2, s20=2, s21=2, s22=2, s23=3, s24=3, s25=1] (stddev=9.61, mean=4.00, sum=100)
last store values: [s1=51, s2=2, s3=2, s4=2, s5=2, s6=2, s7=2, s8=1, s9=2, s10=2, s11=3, s12=1, s13=3, s14=2, s15=2, s16=2, s17=2, s18=2, s19=2, s20=2, s21=2, s22=2, s23=3, s24=3, s25=1] (stddev=9.61, mean=4.00, sum=100)
