gen_cluster nodes=25 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed add_to_existing=true
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000 add_to_existing=true
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true
----
----

 1546500 ┤╭──╮
 1443400 ┤│  │
 1340300 ┤│  ╰──╮
 1237200 ┤│     ╰──╮
 1134100 ┤│        │
 1031000 ┤│        ╰───╮
  927900 ┤│            ╰──╮
  824800 ┤│               ╰──╮
  721700 ┤│                  ╰──╮
  618600 ┤│                     ╰───╮
  515500 ┤│                         ╰─────╮
  412400 ┤│                               ╰─────╮
  309300 ┤│                                     ╰───╮
  206200 ┤│                         ╭─╮╭─╮╭─╮ ╭─╮╭─╮╭───────╮─╭─╮
  103100 ┤╭──╭───────────────────────────────────────────────────────────────────────────
       0 ┼───╯
                                                cpu

last store values: [s1=130794 s2=133820 s3=133713 s4=122482 s5=122408 s6=122218 s7=122327 s8=122711 s9=121982 s10=122383 s11=122262 s12=122367 s13=122497 s14=122018 s15=122286 s16=122465 s17=122367 s18=122075 s19=122494 s20=122062 s21=122434 s22=122205 s23=122357 s24=122138 s25=122816]
----
----

plot stat=write_bytes_per_second show_last_value=true
----
----

 10730 ┤                            ╭────────╮╭───────────╭──╮╭────────────────────────
 10015 ┤╭──────────────────╮╭─╮╭─╮──│ ╭╮╭╮   ││           │╮╭││           │
  9299 ┤╭───────────╮╭────────────────────────────────────╯──╰╯────────────────────────
  8584 ┤│╰─╯╰────╰──╰╯──╯────────╰────────╯│╯││           │  ││   ╰╯      │
  7869 ┤│              ││           │     ││ ╰╯╭──────────╰────────────────────────────
  7153 ┤│              ╰╯           ╰─────╰╯─╯╰╯             ╰╯           ╰╯
  6438 ┤│
  5723 ┤│
  5007 ┤│
  4292 ┤│
  3577 ┤│
  2861 ┤│
  2146 ┤│
  1431 ┤│
   715 ┤│
     0 ┼╯
                                     write_bytes_per_second

last store values: [s1=9458 s2=9579 s3=9522 s4=9039 s5=9039 s6=7522 s7=10486 s8=9037 s9=10533 s10=9032 s11=9009 s12=8973 s13=9049 s14=9022 s15=9071 s16=9045 s17=9016 s18=7519 s19=9020 s20=8996 s21=9033 s22=7546 s23=9043 s24=9024 s25=10567]
----
----

plot stat=replicas sample=1 show_last_value=true
----
----

 56.00 ┼───────────────────╮
 52.67 ┤   ╰──╮            ╰───────────╮
 49.33 ┤      ╰──╮                     ╰─────────╮
 46.00 ┤         ╰───╮                           ╰─────────────────────────────────────
 42.67 ┤             ╰─────╮
 39.33 ┤                   ╰────────────────────────────╮
 36.00 ┤                                                ╰──────────────────────────────
 32.67 ┤
 29.33 ┤
 26.00 ┤
 22.67 ┤
 19.33 ┤
 16.00 ┤
 12.67 ┤
  9.33 ┤               ╭───────────────────────────────╭──╭────────────────────────────
  6.00 ┼──────────────────────────────────────────────────╯────────────────────────────
                                            replicas

last store values: [s1=37 s2=46 s3=46 s4=8 s5=8 s6=7 s7=7 s8=9 s9=7 s10=8 s11=8 s12=8 s13=8 s14=7 s15=8 s16=8 s17=8 s18=7 s19=8 s20=7 s21=8 s22=8 s23=8 s24=7 s25=9]
----
----

plot stat=leases sample=1 show_last_value=true
----
----

 51.00 ┼───╮
 47.67 ┤   ╰──╮
 44.33 ┤      │
 41.00 ┤      ╰──╮
 37.67 ┤         ╰───╮
 34.33 ┤             │
 31.00 ┤             ╰──╮
 27.67 ┤                ╰──╮
 24.33 ┤                   ╰──╮
 21.00 ┤                      ╰───╮
 17.67 ┤                          ╰─────╮
 14.33 ┤                                ╰─────╮
 11.00 ┤                                      ╰───╮
  7.67 ┤             ╭─╮   ╭──╭──╮╭─╭──╮──╭──╮╭──╮╭────╭──╭──╮╭───────────╮
  4.33 ┼───╭──────────────────────────────────────────────╯──╰─────────────────────────
  1.00 ┼───╯
                                             leases

last store values: [s1=4 s2=4 s3=4 s4=4 s5=4 s6=4 s7=4 s8=4 s9=4 s10=4 s11=4 s12=4 s13=4 s14=4 s15=4 s16=4 s17=4 s18=4 s19=4 s20=4 s21=4 s22=4 s23=4 s24=4 s25=4]
----
----
