gen_cluster nodes=25 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 389894 ┤╭──╮
 363901 ┤│  │
 337908 ┤│  ╰──╮
 311915 ┤│     ╰──╮
 285922 ┤│        │╭─╮
 259929 ┤│        ╰╯ ╰╮
 233936 ┤│            ╰──╮
 207943 ┤│               ╰──╮
 181950 ┤│                  ╰──────╮
 155958 ┤│                         ╰──╮
 129965 ┤│                            ╰──╮
 103972 ┤╭────────╮                      ╰──────╮
  77979 ┤│        ╰─────────╮╭─╮                ╰────╮
  51986 ┤│        ╭────────────╭────────────────────────────────────────────────────────
  25993 ┤╭─────────────────────╯───╯──────────────╯──╯──╯─────╰╯─────────────────╰╯─────
      0 ┼╯
                                               cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=37410, s2=43469, s3=44895, s4=42041, s5=43465, s6=38937, s7=42025, s8=45062, s9=36023, s10=37468, s11=37507, s12=40397, s13=45025, s14=43491, s15=39004, s16=42035, s17=40480, s18=44973, s19=44977, s20=40457, s21=44920, s22=40482, s23=44976, s24=45028, s25=45020] (stddev=2913.73, mean=41982.68, sum=1049567)

plot stat=write_bytes_per_second
----
 13543 ┤                                            ╭──────────────────────────────────
 12640 ┤                                            │         ╭╮
 11737 ┤                  ╭───╭────────────────────────────────────────────────────────
 10834 ┤         ╭──╭─────╭───╭────────────────────────────────────────────────────────
  9932 ┤╭────────│╭─╯─────│   │╯    │         │     │  │
  9029 ┤╭──────────────────────────────────────────────────────────────────────────────
  8126 ┤│        │╭───────────╮───────────││────────╮        ││
  7223 ┤│        ││       │   │           ╰╯        │        ╰╯
  6320 ┤│        ╰╯       │   │                     │
  5417 ┤│                 │   │                     │
  4514 ┤│                 ╰───│                     │
  3611 ┤│                     │                     │
  2709 ┤│                     │                     │
  1806 ┤│                     │     ╭─────────╮     │
   903 ┤│                     │     │         │     │
     0 ┼╯                     ╰─────╯─────────╰────────────────────────────────────────
                                     write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=253, s2=134, s3=149, s4=12121, s5=9098, s6=9105, s7=12074, s8=9031, s9=9048, s10=9016, s11=9042, s12=10489, s13=12115, s14=13541, s15=9133, s16=10645, s17=10551, s18=9060, s19=9042, s20=10556, s21=9053, s22=12052, s23=12047, s24=10568, s25=9140] (stddev=3542.20, mean=9082.52, sum=227063)

plot stat=replicas sample=1
----
 56.00 ┼──────╮
 52.67 ┤   ╰──╰──╮
 49.33 ┤         ╰──╮────────────────╮
 46.00 ┤         ╰──╰──────╮         ╰──────────────╮
 42.67 ┤                ╰─╮╰──╮                     │
 39.33 ┤                  │   │                     │
 36.00 ┤                  │   │                     │
 32.67 ┤                  ╰───│                     │
 29.33 ┤                      │                     │
 26.00 ┤                      │                     │
 22.67 ┤                      ╰──╮                  │
 19.33 ┤                      ╰──╰─────╮            │
 16.00 ┤                  ╭───╭─────╮───────────────╭──────────────────────────────────
 12.67 ┤                  │   ╭────────╭───────────────────────────────────────────────
  9.33 ┤      ╭──╭────────────╭────────╯───────────────────────────────────────────────
  6.00 ┼──────────────────────╯───╯──╯──────────────╯──────────────────────────────────
                                            replicas
initial store values: [s1=56, s2=56, s3=56, s4=6, s5=6, s6=6, s7=6, s8=6, s9=6, s10=6, s11=6, s12=6, s13=6, s14=6, s15=6, s16=6, s17=6, s18=6, s19=6, s20=6, s21=6, s22=6, s23=6, s24=6, s25=6] (stddev=16.25, mean=12.00, sum=300)
last store values: [s1=17, s2=9, s3=10, s4=16, s5=13, s6=14, s7=12, s8=10, s9=8, s10=9, s11=9, s12=11, s13=14, s14=13, s15=14, s16=16, s17=11, s18=10, s19=10, s20=15, s21=10, s22=11, s23=14, s24=10, s25=14] (stddev=2.51, mean=12.00, sum=300)

plot stat=leases sample=1
----
 51.00 ┼───╮
 47.60 ┤   │
 44.20 ┤   ╰──╮
 40.80 ┤      │
 37.40 ┤      ╰──╮
 34.00 ┤         ╰───╮
 30.60 ┤             │
 27.20 ┤             ╰──╮
 23.80 ┤                ╰──╮
 20.40 ┤                   ╰───╮
 17.00 ┤                       ╰──╮
 13.60 ┤                          ╰──╮
 10.20 ┤                             ╰──╮
  6.80 ┤         ╭──╮                   ╭─╮─╮     ╭─╮
  3.40 ┼───╭───────────────────────────────────────────────────────────────────────────
  0.00 ┼───╯──────────────────────────────────╯   ╰─╯
                                             leases
initial store values: [s1=51, s2=2, s3=2, s4=2, s5=2, s6=2, s7=2, s8=1, s9=2, s10=2, s11=3, s12=1, s13=3, s14=2, s15=2, s16=2, s17=2, s18=2, s19=2, s20=2, s21=2, s22=2, s23=3, s24=3, s25=1] (stddev=9.61, mean=4.00, sum=100)
last store values: [s1=2, s2=5, s3=5, s4=3, s5=4, s6=3, s7=4, s8=5, s9=4, s10=4, s11=4, s12=4, s13=4, s14=4, s15=3, s16=3, s17=4, s18=5, s19=5, s20=3, s21=5, s22=4, s23=4, s24=5, s25=4] (stddev=0.80, mean=4.00, sum=100)
