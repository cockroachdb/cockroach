# This test verifies that MMA can balance disks when the write patterns are
# skewed towards a single node/set of nodes such that it leads to imbalanced
# disk usage in the long run. It creates two nodes with 20 GiB store capacity.
# It creates 100 ranges of 1 MiB each on both nodes. The first node is targeted
# with a read-only workload and the second with a write-only workload keeping
# the CPU utilization the same.
#
# Expectation: MMA should perform rebalancing based on disk usage and write
# bandwidth to prevent one of the nodes from becoming full way in advance of the
# other node.
gen_cluster nodes=2 node_cpu_cores=2 store_byte_capacity_gib=20
----

gen_ranges ranges=100 repl_factor=1 min_key=0 max_key=10000 placement_type=replica_placement bytes_mib=1
{s1}:1
----
{s1:*}:1

gen_ranges ranges=100 repl_factor=1 min_key=10000 max_key=20000 placement_type=replica_placement bytes_mib=1
{s2}:1
----
{s2:*}:1

# Read-only workload with 1 CPU s/s targeting the first node
gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=1000000 min_key=0 max_key=10000
----
1.00 access-vcpus

# Write-only workload with 1 CPU s/s and 5 MiB/s write bandwidth targeting the
# second node
gen_load rate=5000 rw_ratio=0 min_block=1024 max_block=1024 request_cpu_per_access=100000 raft_cpu_per_write=100000 min_key=10000 max_key=20000
----
0.50 access-vcpus, 0.50 raft-vcpus, 4.9 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=100m samples=1 seed=42 cfgs=(mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases,disk_fraction_used)
----
mma-count:
cpu#1: last:  [s1=1219322086, s2=780398932] (stddev=219461577.00, mean=999860509.00, sum=1999721018)
cpu#1: thrash_pct: [s1=324%, s2=346%]  (sum=669%)
cpu_util#1: last:  [s1=0.61, s2=0.39] (stddev=0.11, mean=0.50, sum=1)
cpu_util#1: thrash_pct: [s1=324%, s2=346%]  (sum=669%)
disk_fraction_used#1: first: [s1=0.01, s2=0.01] (stddev=0.00, mean=0.01, sum=0)
disk_fraction_used#1: last:  [s1=0.85, s2=0.95] (stddev=0.05, mean=0.90, sum=2)
disk_fraction_used#1: thrash_pct: [s1=46%, s2=116%]  (sum=162%)
leases#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
leases#1: last:  [s1=122, s2=78] (stddev=22.00, mean=100.00, sum=200)
leases#1: thrash_pct: [s1=245%, s2=245%]  (sum=490%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=122, s2=78] (stddev=22.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=245%, s2=245%]  (sum=490%)
write_bytes_per_second#1: last:  [s1=2405580, s2=2715840] (stddev=155130.00, mean=2560710.00, sum=5121420)
write_bytes_per_second#1: thrash_pct: [s1=75%, s2=56%]  (sum=131%)
hash: df73a26bc5cb0bd9
==========================
