# This test verifies allocator behavior in a heterogeneous cluster where nodes
# have different CPU capacities and there are no placement constraints. The test
# sets up a 3-node cluster with nodes n1 and n2 having 8vCPU capacity each, and
# node n3 having 16vCPU capacity. It creates 200 ranges evenly distributed across
# all stores and generates a read-only workload.
#
# Expected outcome: MMA and SMA balance on absolute CPU nanos, so the higher
# capacity node n3 is underutilized in terms of CPU utilization. This is tracked
# in issue: https://github.com/cockroachdb/cockroach/issues/153777.
gen_cluster nodes=3 node_cpu_cores=(8,8,16)
----

gen_ranges ranges=200 min_key=1 max_key=10000 placement_type=even
{s1,s2,s3}:1
----

# Read-only workload on first 30 ranges. 20 cores (out of 24 total in the cluster).
# Because the ranges are placed evenly, initially each node will have about the same
# CPU nanos per second.
gen_load rate=40000 rw_ratio=1 request_cpu_per_access=500000 min_key=1 max_key=10000
----
20.00 access-vcpus

# We want the CPU load to balance based on %cpu. But both the MMA and SMA balance
# on absolute cpu-nanos, i.e. not taking into account that n3 has double the capacity.
# See tracking issue: https://github.com/cockroachdb/cockroach/issues/153777
assertion stat=cpu_util type=balance ticks=6 upper_bound=1.1
----
asserting: max_{stores}(cpu_util)/mean_{stores}(cpu_util) ≤ 1.10 at each of last 6 ticks

eval cfgs=(sma-count,mma-count) duration=3m metrics=(cpu,cpu_util)
----
sma-count:
cpu#1: last:  [s1=6702050000, s2=6694069444, s3=6603880555] (stddev=44515870.96, mean=6666666666.33, sum=19999999999)
cpu#1: thrash_pct: [s1=133%, s2=123%, s3=139%]  (sum=395%)
cpu_util#1: last:  [s1=0.84, s2=0.84, s3=0.41] (stddev=0.20, mean=0.70, sum=2)
cpu_util#1: thrash_pct: [s1=5%, s2=5%, s3=3%]  (sum=12%)
hash: 1306b93e8b8d4a39
failed assertion sample 1
  balance stat=cpu_util threshold=(≤1.10) ticks=6
	max/mean=1.20 tick=0
	max/mean=1.20 tick=1
	max/mean=1.20 tick=2
	max/mean=1.20 tick=3
	max/mean=1.20 tick=4
	max/mean=1.20 tick=5
==========================
mma-count:
cpu#1: last:  [s1=5494008333, s2=5488055555, s3=9004024799] (stddev=1656042496.50, mean=6662029562.33, sum=19986088687)
cpu#1: thrash_pct: [s1=6%, s2=8%, s3=11%]  (sum=25%)
cpu_util#1: last:  [s1=0.69, s2=0.69, s3=0.56] (stddev=0.06, mean=0.65, sum=2)
cpu_util#1: thrash_pct: [s1=7%, s2=8%, s3=6%]  (sum=20%)
hash: 5db3bc1238dc03b7
==========================
