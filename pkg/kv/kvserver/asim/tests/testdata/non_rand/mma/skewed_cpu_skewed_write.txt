# This test verifies the allocator's behavior with opposing CPU and write load
# distributions, complicated by the presence of many "cold" (idle) ranges that
# prevent count-based rebalancing from "accidentally" fixing the load imbalance.
#
#   Keyspace          Ranges   Placement   Load
#   ─────────────────────────────────────────────────────────────
#   [1, 10000)         36      s1-s3       read-heavy
#   [10001, 20000)     36      s4-s6       write-heavy
#   [20001, 30000)    100      s1-s3       (cold)
#   [30001, 40000)    100      s4-s6       (cold)
#   ─────────────────────────────────────────────────────────────
#
# The cold ranges are important to prevent count-based rebalancing from
# "accidentally" fixing the write imbalance (after CPU-based rebalancing
# has created a count-imbalance).
#
# Expected outcome: MMA should rebalance both CPU and write load across all
# stores by identifying and moving the hot ranges, regardless of the cold
# range distribution. SMA can deliberately balance CPU, but has no visibility
# into write load and so can't equalize on that dimension. Because CPU and
# writes are coupled (via raft processing), SMA ends up thrashing — repeatedly
# balancing CPU only to have write redistribution destabilize it again. This
# is reflected in the high thrash percentages for sma-count (~2300% CPU,
# ~5500% writes) vs mma-only (~150% CPU, ~240% writes).
gen_cluster nodes=6 node_cpu_cores=5
----

# Hot read ranges on s1-s3: high CPU, no writes
gen_ranges ranges=36 min_key=1 max_key=10000 placement_type=replica_placement
{s1,s2,s3}:1
----
{s1:*,s2,s3}:1

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Cold ranges co-located with the hot read ranges on s1-s3.
# These have no load but contribute to range count, making count-based
# rebalancing see s1-s3 as having "too many" ranges even though the load
# problem is actually the opposite (s1-s3 need to shed CPU load, not ranges).
gen_ranges ranges=100 min_key=20001 max_key=30000 placement_type=replica_placement
{s1,s2,s3}:1
----
{s1:*,s2,s3}:1

# Hot write ranges on s4-s6: high write throughput, minimal CPU
gen_ranges ranges=36 min_key=10001 max_key=20000 placement_type=replica_placement
{s4,s5,s6}:1
----
{s4:*,s5,s6}:1

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000
----
0.00 raft-vcpus, 19 MiB/s goodput

# Cold ranges co-located with the hot write ranges on s4-s6.
# Same principle: these pad the range count on s4-s6, obscuring the real
# problem (write concentration) from count-based rebalancing.
gen_ranges ranges=100 min_key=30001 max_key=40000 placement_type=replica_placement
{s4,s5,s6}:1
----
{s4:*,s5,s6}:1

setting split_queue_enabled=false
----

eval duration=25m samples=1 seed=42 cfgs=(sma-count,mma-only,mma-count) metrics=(cpu_util,write_bytes_per_second,replicas,leases)
----
sma-count:
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.19, s4=0.17, s5=0.17, s6=0.14] (stddev=0.02, mean=0.17, sum=1)
cpu_util#1: thrash_pct: [s1=317%, s2=139%, s3=420%, s4=230%, s5=181%, s6=204%]  (sum=1490%)
leases#1: first: [s1=136, s2=0, s3=0, s4=136, s5=0, s6=0] (stddev=64.11, mean=45.33, sum=272)
leases#1: last:  [s1=42, s2=44, s3=41, s4=51, s5=48, s6=46] (stddev=3.45, mean=45.33, sum=272)
leases#1: thrash_pct: [s1=86%, s2=49%, s3=103%, s4=68%, s5=46%, s6=49%]  (sum=401%)
replicas#1: first: [s1=136, s2=136, s3=136, s4=136, s5=136, s6=136] (stddev=0.00, mean=136.00, sum=816)
replicas#1: last:  [s1=135, s2=129, s3=135, s4=138, s5=139, s6=140] (stddev=3.65, mean=136.00, sum=816)
replicas#1: thrash_pct: [s1=0%, s2=245%, s3=13%, s4=115%, s5=103%, s6=66%]  (sum=543%)
write_bytes_per_second#1: last:  [s1=0, s2=2772297, s3=0, s4=18336933, s5=20000880, s6=18892529] (stddev=9136363.37, mean=10000439.83, sum=60002639)
write_bytes_per_second#1: thrash_pct: [s1=0%, s2=2%, s3=0%, s4=89%, s5=100%, s6=101%]  (sum=292%)
hash: bbe8bd0a4c78e7a1
==========================
mma-only:
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17] (stddev=0.00, mean=0.17, sum=1)
cpu_util#1: thrash_pct: [s1=7%, s2=36%, s3=58%, s4=14%, s5=14%, s6=13%]  (sum=142%)
leases#1: first: [s1=136, s2=0, s3=0, s4=136, s5=0, s6=0] (stddev=64.11, mean=45.33, sum=272)
leases#1: last:  [s1=106, s2=15, s3=13, s4=125, s5=7, s6=6] (stddev=50.02, mean=45.33, sum=272)
leases#1: thrash_pct: [s1=0%, s2=5%, s3=10%, s4=10%, s5=0%, s6=0%]  (sum=25%)
replicas#1: first: [s1=136, s2=136, s3=136, s4=136, s5=136, s6=136] (stddev=0.00, mean=136.00, sum=816)
replicas#1: last:  [s1=142, s2=152, s3=148, s4=125, s5=125, s6=124] (stddev=11.70, mean=136.00, sum=816)
replicas#1: thrash_pct: [s1=53%, s2=20%, s3=37%, s4=37%, s5=43%, s6=37%]  (sum=228%)
write_bytes_per_second#1: last:  [s1=8365970, s2=10579513, s3=10027499, s4=10523766, s5=10522676, s6=9966826] (stddev=769765.72, mean=9997708.33, sum=59986250)
write_bytes_per_second#1: thrash_pct: [s1=1%, s2=13%, s3=5%, s4=2%, s5=109%, s6=109%]  (sum=240%)
hash: 777f2410cca7e6a9
==========================
mma-count:
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17] (stddev=0.00, mean=0.17, sum=1)
cpu_util#1: thrash_pct: [s1=11%, s2=48%, s3=44%, s4=11%, s5=13%, s6=11%]  (sum=139%)
leases#1: first: [s1=136, s2=0, s3=0, s4=136, s5=0, s6=0] (stddev=64.11, mean=45.33, sum=272)
leases#1: last:  [s1=47, s2=48, s3=45, s4=47, s5=42, s6=43] (stddev=2.21, mean=45.33, sum=272)
leases#1: thrash_pct: [s1=17%, s2=24%, s3=18%, s4=19%, s5=22%, s6=24%]  (sum=125%)
replicas#1: first: [s1=136, s2=136, s3=136, s4=136, s5=136, s6=136] (stddev=0.00, mean=136.00, sum=816)
replicas#1: last:  [s1=140, s2=138, s3=138, s4=132, s5=132, s6=136] (stddev=3.06, mean=136.00, sum=816)
replicas#1: thrash_pct: [s1=215%, s2=313%, s3=269%, s4=226%, s5=237%, s6=289%]  (sum=1550%)
write_bytes_per_second#1: last:  [s1=10577825, s2=10578721, s3=10579409, s4=8861690, s5=8853122, s6=10519649] (stddev=804723.82, mean=9995069.33, sum=59970416)
write_bytes_per_second#1: thrash_pct: [s1=82%, s2=104%, s3=99%, s4=300%, s5=252%, s6=291%]  (sum=1129%)
hash: cc3bfedcbe717adc
==========================
