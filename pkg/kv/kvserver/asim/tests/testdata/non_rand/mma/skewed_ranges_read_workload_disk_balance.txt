# This test verifies that MMA can balance disks when doing so might go against
# the goal of balancing CPU utilization. It creates two nodes with 20 GiB store
# capacity. The first node has 100 ranges of a 100 MiB each (61% full). The
# second node has 100 ranges of 1 MiB each (1% full). A read-only workload is
# started that targets both nodes evenly.
#
# Expectation: MMA should perform rebalancing based on disk usage to bring the
# disk utilization on the overloaded node down below 50%.
gen_cluster nodes=2 node_cpu_cores=2 store_byte_capacity_gib=20
----

gen_ranges ranges=100 repl_factor=1 min_key=0 max_key=10000 placement_type=replica_placement bytes_mib=100
{s1}:1
----
{s1:*}:1

gen_ranges ranges=100 repl_factor=1 min_key=10000 max_key=20000 placement_type=replica_placement bytes_mib=1
{s2}:1
----
{s2:*}:1

gen_load rate=5000 rw_ratio=1 min_block=1024 max_block=1024 request_cpu_per_access=100000 raft_cpu_per_write=100000 min_key=0 max_key=20000
----
0.50 access-vcpus

setting split_queue_enabled=false
----

eval duration=35m samples=1 seed=42 cfgs=(mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases,disk_fraction_used)
----
mma-count:
cpu#1: last:  [s1=245048481, s2=255076755] (stddev=5014137.00, mean=250062618.00, sum=500125236)
cpu#1: thrash_pct: [s1=288%, s2=286%]  (sum=574%)
cpu_util#1: last:  [s1=0.12, s2=0.13] (stddev=0.00, mean=0.13, sum=0)
cpu_util#1: thrash_pct: [s1=288%, s2=286%]  (sum=574%)
disk_fraction_used#1: first: [s1=0.61, s2=0.01] (stddev=0.30, mean=0.31, sum=1)
disk_fraction_used#1: last:  [s1=0.50, s2=0.12] (stddev=0.19, mean=0.31, sum=1)
disk_fraction_used#1: thrash_pct: [s1=8%, s2=8%]  (sum=16%)
leases#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
leases#1: last:  [s1=98, s2=102] (stddev=2.00, mean=100.00, sum=200)
leases#1: thrash_pct: [s1=202%, s2=202%]  (sum=404%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=98, s2=102] (stddev=2.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=202%, s2=202%]  (sum=404%)
hash: b5e4cbd902e67e24
==========================
