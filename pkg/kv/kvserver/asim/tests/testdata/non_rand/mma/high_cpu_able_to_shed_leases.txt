# See comments on top of high_cpu_able_to_shed_leases.txt for test details.

# Case (2) where s1 has leases and is CPU overloaded due to raft CPU. It
# will be able to shed its own leases because it is the leaseholer. There should
# be a period of lease-rebalancing activity before replica-rebalancing.

gen_cluster nodes=5 node_cpu_rate_capacity=9000000000
----

setting split_queue_enabled=false
----

gen_ranges ranges=25 min_key=0 max_key=10000 placement_type=replica_placement
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6
----
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6

gen_load rate=50000 rw_ratio=0 min_key=0 max_key=10000 raft_cpu_per_write=100000
----
5.00 raft-vcpus, 49 KiB/s goodput

eval duration=5m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=2798207219, s2=2599439056, s3=3198001179, s4=3201158227, s5=3201666605] (stddev=253577383.96, mean=2999694457.20, sum=14998472286)
cpu#1: thrash_pct: [s1=132%, s2=67%, s3=70%, s4=48%, s5=60%]  (sum=377%)
cpu_util#1: last:  [s1=0.31, s2=0.29, s3=0.36, s4=0.36, s5=0.36] (stddev=0.03, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=132%, s2=67%, s3=70%, s4=48%, s5=60%]  (sum=377%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=3, s2=7, s3=6, s4=7, s5=2] (stddev=2.10, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=30%, s2=0%, s3=0%, s4=0%, s5=10%]  (sum=40%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=14, s2=13, s3=16, s4=16, s5=16] (stddev=1.26, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=20%, s2=0%, s3=0%, s4=0%, s5=18%]  (sum=39%)
write_bytes_per_second#1: last:  [s1=27982, s2=25994, s3=31980, s4=32011, s5=32016] (stddev=2535.71, mean=29996.60, sum=149983)
write_bytes_per_second#1: thrash_pct: [s1=132%, s2=67%, s3=70%, s4=48%, s5=60%]  (sum=377%)
artifacts[mma-only]: 4e2a515e6387e41b
==========================
cpu#1: last:  [s1=3200128826, s2=2799426111, s3=3199916255, s4=2800243710, s5=3000677202] (stddev=178969798.68, mean=3000078420.80, sum=15000392104)
cpu#1: thrash_pct: [s1=28%, s2=1%, s3=2%, s4=0%, s5=1%]  (sum=33%)
cpu_util#1: last:  [s1=0.36, s2=0.31, s3=0.36, s4=0.31, s5=0.33] (stddev=0.02, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=28%, s2=1%, s3=2%, s4=0%, s5=1%]  (sum=33%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=10, s2=2, s3=3, s4=5, s5=5] (stddev=2.76, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=16, s2=14, s3=16, s4=14, s5=15] (stddev=0.89, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=32001, s2=27994, s3=31999, s4=28002, s5=30006] (stddev=1789.75, mean=30000.40, sum=150002)
write_bytes_per_second#1: thrash_pct: [s1=28%, s2=1%, s3=2%, s4=0%, s5=1%]  (sum=33%)
artifacts[mma-count]: e59fd9dad8bd40e7
==========================
