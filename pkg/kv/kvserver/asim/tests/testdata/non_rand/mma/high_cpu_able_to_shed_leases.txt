# See comments on top of high_cpu_able_to_shed_leases.txt for test details.

# Case (2) where s1 has leases and is CPU overloaded due to raft CPU. It
# will be able to shed its own leases because it is the leaseholer. There should
# be a period of lease-rebalancing activity before replica-rebalancing.

gen_cluster nodes=5 node_cpu_cores=9
----

setting split_queue_enabled=false
----

gen_ranges ranges=25 min_key=0 max_key=10000 placement_type=replica_placement
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6
----
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6

gen_load rate=50000 rw_ratio=0 min_key=0 max_key=10000 raft_cpu_per_write=100000
----
5.00 raft-vcpus, 49 KiB/s goodput

eval duration=5m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=3197476333, s2=2799049045, s3=3199121916, s4=2600154893, s5=3199507821] (stddev=252468931.50, mean=2999062001.60, sum=14995310008)
cpu#1: thrash_pct: [s1=1%, s2=71%, s3=60%, s4=71%, s5=61%]  (sum=264%)
cpu_util#1: last:  [s1=0.36, s2=0.31, s3=0.36, s4=0.29, s5=0.36] (stddev=0.03, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=1%, s2=71%, s3=60%, s4=71%, s5=61%]  (sum=264%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=16, s2=1, s3=3, s4=1, s5=4] (stddev=5.62, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=16, s2=14, s3=16, s4=13, s5=16] (stddev=1.26, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=31974, s2=27990, s3=31991, s4=26001, s5=31995] (stddev=2524.77, mean=29990.20, sum=149951)
write_bytes_per_second#1: thrash_pct: [s1=2%, s2=71%, s3=60%, s4=71%, s5=61%]  (sum=264%)
artifacts[mma-only]: 8d80b42b0063e56d
==========================
cpu#1: last:  [s1=3200249625, s2=2799056785, s3=3199845634, s4=2600167376, s5=3200011846] (stddev=253095690.09, mean=2999866253.20, sum=14999331266)
cpu#1: thrash_pct: [s1=80%, s2=77%, s3=49%, s4=77%, s5=36%]  (sum=319%)
cpu_util#1: last:  [s1=0.36, s2=0.31, s3=0.36, s4=0.29, s5=0.36] (stddev=0.03, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=80%, s2=77%, s3=49%, s4=77%, s5=36%]  (sum=319%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=9, s2=3, s3=3, s4=4, s5=6] (stddev=2.28, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=16, s2=14, s3=16, s4=13, s5=16] (stddev=1.26, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=32002, s2=27990, s3=31998, s4=26001, s5=32000] (stddev=2531.09, mean=29998.20, sum=149991)
write_bytes_per_second#1: thrash_pct: [s1=80%, s2=77%, s3=49%, s4=77%, s5=36%]  (sum=319%)
artifacts[mma-count]: fd1562faf1daf31b
==========================
