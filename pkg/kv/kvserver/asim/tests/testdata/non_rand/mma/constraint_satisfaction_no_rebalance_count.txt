# This test verifies that the allocator does not perform count based rebalancing
# when that would go against the higher priority goals of zone constraints and
# disk fullness. The test sets up a 4-node cluster across 2 regions (a, b) with
# 1 and 3 nodes respectively. The test creates 6000 ranges with 3 replicas of
# size 1 MiB each with a replica on s1, and the other 2 replicas are equally
# balanced across s2, s3, and s4. The span config for these ranges requires 1
# replica in region a and 2 in region b, with lease preferences for region a.
# The test creates another range of size 2000 MiB with 3 replicas each on s2,
# s3, and s4. The span config for this ranges requires 3 replicas in region b,
# with lease preferences for region b. Initially, all the zone constraints are
# satisfied. The vast difference between the size of the ranges and the count,
# makes it so that the s1 has a much higher replica count (6000) than s2, s3,
# and s4 (~4000) despite having the same amount of disk utilization (73%).

# Expected outcome: The allocator should not perform any rebalancing. Despite
# the immense difference between the replica counts, performing any rebalancing
# would violate either zone constraints, or make disk utilization unbalanced.
gen_cluster nodes=4 region=(a,b) nodes_per_region=(1,3) store_byte_capacity_gib=10
----

gen_ranges ranges=6000 repl_factor=3 placement_type=replica_placement bytes_mib=1 min_key=0 max_key=300000
{s1,s2,s3}:1 {s1,s3,s4}:1 {s1,s2,s4}:1
----
{s1:*,s2,s3}:1
{s1:*,s3,s4}:1
{s1:*,s2,s4}:1

gen_ranges ranges=1 repl_factor=3 placement_type=replica_placement bytes_mib=2000 min_key=300000 max_key=400000
{s2,s3,s4}:1
----
{s2:*,s3,s4}:1

set_span_config
[0,300000): num_replicas=3 num_voters=3 constraints={'+region=a':1,'+region=b':2} lease_preferences=[['+region=a']]
----

set_span_config
[300000,400000): num_replicas=3 num_voters=3 constraints={'+region=b':3} lease_preferences=[['+region=b']]
----

setting split_queue_enabled=false
----

eval duration=3m samples=1 seed=42 cfgs=(sma-count,mma-count,mma-only) metrics=(leases,replicas,disk_fraction_used)
----
disk_fraction_used#1: first: [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: last:  [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
leases#1: first: [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: last:  [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
replicas#1: first: [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: last:  [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
artifacts[sma-count]: 8554051e3ba57e05
==========================
disk_fraction_used#1: first: [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: last:  [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
leases#1: first: [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: last:  [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
replicas#1: first: [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: last:  [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
artifacts[mma-count]: 8554051e3ba57e05
==========================
disk_fraction_used#1: first: [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: last:  [s1=0.73, s2=0.73, s3=0.73, s4=0.73] (stddev=0.00, mean=0.73, sum=3)
disk_fraction_used#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
leases#1: first: [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: last:  [s1=6000, s2=2, s3=0, s4=0] (stddev=2597.79, mean=1500.50, sum=6002)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
replicas#1: first: [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: last:  [s1=6000, s2=4002, s3=4002, s4=4002] (stddev=865.16, mean=4501.50, sum=18006)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%]  (sum=0%)
artifacts[mma-only]: 8554051e3ba57e05
==========================
