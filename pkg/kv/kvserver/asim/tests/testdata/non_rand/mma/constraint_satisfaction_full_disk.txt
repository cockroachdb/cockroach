# This test verifies that the allocator can satisfy zone constraints when stores
# have limited disk capacity and replicas need to be rebalanced due to disk
# fullness. The test sets up a 9-node cluster across 4 regions (a, b, c, d) with
# 3, 2, 1, and 3 nodes respectively. It creates 10 ranges with 5 replicas each,
# initially placed only on stores s1, s2, s4, s5, s6 (regions a, b, c). Each store
# has a 10GB capacity and each range is 500MiB, making stores s1, s2, s4, s5, s6
# approximately 61% full initially. The span config requires 2 replicas in region
# a, 2 in region b, and 1 in region c, with lease preferences for region a.
#
# Expected outcome: The allocator should rebalance replicas to satisfy the zone
# constraints while managing disk capacity. Since stores s1 and s2 in region a are
# initially full, some replicas should move to s3 (also in region a) to maintain
# the constraint of 2 replicas in region a while reducing disk pressure. Leases
# should be distributed within region a (s1, s2, s3) due to lease preferences when
# count-based rebalancing is enabled.
gen_cluster nodes=9 region=(a,b,c,d) nodes_per_region=(3,2,1,3) store_byte_capacity_gib=10
----

gen_ranges ranges=10 repl_factor=5 placement_type=replica_placement bytes_mib=500
{s1,s2,s4,s5,s6}:1
----
{s1:*,s2,s4,s5,s6}:1

set_span_config
[0,9999999999): num_replicas=5 num_voters=5 constraints={'+region=a':2,'+region=b':2,'+region=c':1} lease_preferences=[['+region=a']]
----

setting split_queue_enabled=false
----

# TODO(wenyihu6): for mma-only, why didn't we balance more replicas to s3 before stabilizing?
# TODO(wenyihu6): tests more cases here
# 1. whats happens if zone config started being satisfied but the full-disk
# target is against the goal of zone/lease constraints
# 2. what happens if zone config started being un-satisfied but the full-disk
# target is against the goal of zone/lease constraints
# 3. what happens if count-based rebalancing is against any of these goals ^

eval duration=3m samples=1 seed=42 cfgs=(sma-count,mma-count) metrics=(cpu,cpu_util,leases,replicas,disk_fraction_used)
----
disk_fraction_used#1: first: [s1=0.61, s2=0.61, s3=0.00, s4=0.61, s5=0.61, s6=0.61, s7=0.00, s8=0.00, s9=0.00] (stddev=0.30, mean=0.34, sum=3)
disk_fraction_used#1: last:  [s1=0.49, s2=0.37, s3=0.37, s4=0.61, s5=0.61, s6=0.61, s7=0.00, s8=0.00, s9=0.00] (stddev=0.26, mean=0.34, sum=3)
disk_fraction_used#1: thrash_pct: [s1=25%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=25%)
leases#1: first: [s1=10, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0] (stddev=3.14, mean=1.11, sum=10)
leases#1: last:  [s1=6, s2=0, s3=4, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0] (stddev=2.13, mean=1.11, sum=10)
leases#1: thrash_pct: [s1=24%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=24%)
replicas#1: first: [s1=10, s2=10, s3=0, s4=10, s5=10, s6=10, s7=0, s8=0, s9=0] (stddev=4.97, mean=5.56, sum=50)
replicas#1: last:  [s1=8, s2=6, s3=6, s4=10, s5=10, s6=10, s7=0, s8=0, s9=0] (stddev=4.19, mean=5.56, sum=50)
replicas#1: thrash_pct: [s1=25%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=25%)
artifacts[sma-count]: 162d9e12464dc5d9
==========================
disk_fraction_used#1: first: [s1=0.61, s2=0.61, s3=0.00, s4=0.61, s5=0.61, s6=0.61, s7=0.00, s8=0.00, s9=0.00] (stddev=0.30, mean=0.34, sum=3)
disk_fraction_used#1: last:  [s1=0.43, s2=0.37, s3=0.43, s4=0.61, s5=0.61, s6=0.61, s7=0.00, s8=0.00, s9=0.00] (stddev=0.25, mean=0.34, sum=3)
disk_fraction_used#1: thrash_pct: [s1=49%, s2=26%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=75%)
leases#1: first: [s1=10, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0] (stddev=3.14, mean=1.11, sum=10)
leases#1: last:  [s1=5, s2=0, s3=5, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0] (stddev=2.08, mean=1.11, sum=10)
leases#1: thrash_pct: [s1=24%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=24%)
replicas#1: first: [s1=10, s2=10, s3=0, s4=10, s5=10, s6=10, s7=0, s8=0, s9=0] (stddev=4.97, mean=5.56, sum=50)
replicas#1: last:  [s1=7, s2=6, s3=7, s4=10, s5=10, s6=10, s7=0, s8=0, s9=0] (stddev=4.17, mean=5.56, sum=50)
replicas#1: thrash_pct: [s1=49%, s2=26%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%]  (sum=75%)
artifacts[mma-count]: 728034f91d6afa71
==========================
