# This test sets up a 10-node multi-store cluster with two workloads:
# (read-only, high-cpu on lh) uniformly across nodes and (write-only,
# high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_cores=3  stores_per_node=2
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
mma-only:
cpu#1: last:  [s1=166733333, s2=333087500, s3=332200000, s4=166087500, s5=165008333, s6=332937500, s7=166958333, s8=334753097, s9=334327114, s10=334445833, s11=333762299, s12=166275000, s13=166883333, s14=165841666, s15=167395833, s16=332033333, s17=170470833, s18=332821681, s19=166062500, s20=332395833] (stddev=83260795.75, mean=250024042.70, sum=5000480854)
cpu#1: thrash_pct: [s1=44%, s2=69%, s3=60%, s4=48%, s5=45%, s6=56%, s7=40%, s8=175%, s9=79%, s10=61%, s11=158%, s12=43%, s13=45%, s14=63%, s15=43%, s16=158%, s17=68%, s18=78%, s19=53%, s20=59%]  (sum=1445%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.22, s10=0.22, s11=0.17, s12=0.17, s13=0.11, s14=0.11, s15=0.17, s16=0.17, s17=0.17, s18=0.17, s19=0.17, s20=0.17] (stddev=0.03, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=50%, s2=50%, s3=53%, s4=53%, s5=52%, s6=52%, s7=132%, s8=132%, s9=72%, s10=72%, s11=141%, s12=141%, s13=55%, s14=55%, s15=120%, s16=120%, s17=127%, s18=127%, s19=61%, s20=61%]  (sum=1727%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.05, s3=0.05, s4=0.01, s5=0.01, s6=0.01, s7=0.00, s8=0.01, s9=0.02, s10=0.02, s11=0.01, s12=0.01, s13=0.01, s14=0.00, s15=0.01, s16=0.00, s17=0.01, s18=0.02, s19=0.01, s20=0.00] (stddev=0.01, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=15%, s2=3%, s3=0%, s4=4%, s5=0%, s6=0%, s7=8%, s8=0%, s9=1%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=0%, s18=0%, s19=3%, s20=0%]  (sum=34%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=5, s2=8, s3=3, s4=3, s5=1, s6=2, s7=2, s8=3, s9=3, s10=4, s11=3, s12=3, s13=2, s14=2, s15=3, s16=2, s17=3, s18=4, s19=2, s20=2] (stddev=1.45, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=13%, s5=0%, s6=0%, s7=24%, s8=13%, s9=0%, s10=0%, s11=25%, s12=0%, s13=0%, s14=0%, s15=0%, s16=12%, s17=13%, s18=0%, s19=24%, s20=0%]  (sum=122%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=8, s2=18, s3=17, s4=7, s5=7, s6=9, s7=6, s8=8, s9=10, s10=10, s11=9, s12=8, s13=9, s14=5, s15=9, s16=7, s17=8, s18=11, s19=8, s20=6] (stddev=3.18, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=15%, s5=13%, s6=0%, s7=40%, s8=7%, s9=8%, s10=0%, s11=8%, s12=0%, s13=8%, s14=7%, s15=0%, s16=0%, s17=7%, s18=0%, s19=28%, s20=0%]  (sum=141%)
write_bytes_per_second#1: last:  [s1=2664475, s2=9990961, s3=8656089, s4=1997673, s5=2666355, s6=2663658, s7=666268, s8=2682724, s9=3332509, s10=3327703, s11=2664669, s12=2663382, s13=2684130, s14=665509, s15=2664546, s16=665509, s17=2662923, s18=3349273, s19=2662437, s20=666745] (stddev=2292410.07, mean=2999876.90, sum=59997538)
write_bytes_per_second#1: thrash_pct: [s1=29%, s2=53%, s3=57%, s4=30%, s5=9%, s6=16%, s7=41%, s8=10%, s9=9%, s10=10%, s11=2%, s12=2%, s13=2%, s14=1%, s15=2%, s16=1%, s17=10%, s18=2%, s19=30%, s20=15%]  (sum=332%)
hash: 957716351d2ab1d4
==========================
mma-count:
cpu#1: last:  [s1=333378759, s2=165788079, s3=165982062, s4=333815801, s5=166556948, s6=167504166, s7=332183513, s8=165297827, s9=332791832, s10=165824427, s11=167952548, s12=331345403, s13=334284378, s14=332165457, s15=165876777, s16=166394463, s17=334154467, s18=330441000, s19=336397669, s20=169360000] (stddev=83233087.66, mean=249874778.80, sum=4997495576)
cpu#1: thrash_pct: [s1=186%, s2=160%, s3=348%, s4=388%, s5=137%, s6=64%, s7=393%, s8=68%, s9=296%, s10=284%, s11=244%, s12=281%, s13=116%, s14=96%, s15=313%, s16=256%, s17=70%, s18=216%, s19=173%, s20=142%]  (sum=4230%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.11, s6=0.11, s7=0.17, s8=0.17, s9=0.17, s10=0.17, s11=0.17, s12=0.17, s13=0.22, s14=0.22, s15=0.11, s16=0.11, s17=0.22, s18=0.22, s19=0.17, s20=0.17] (stddev=0.04, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=273%, s2=273%, s3=579%, s4=579%, s5=142%, s6=142%, s7=367%, s8=367%, s9=450%, s10=450%, s11=391%, s12=391%, s13=150%, s14=150%, s15=424%, s16=424%, s17=207%, s18=207%, s19=230%, s20=230%]  (sum=6427%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.01, s3=0.02, s4=0.01, s5=0.02, s6=0.02, s7=0.01, s8=0.02, s9=0.01, s10=0.02, s11=0.02, s12=0.01, s13=0.02, s14=0.01, s15=0.01, s16=0.02, s17=0.02, s18=0.01, s19=0.01, s20=0.01] (stddev=0.00, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=84%, s2=94%, s3=307%, s4=344%, s5=100%, s6=66%, s7=73%, s8=28%, s9=351%, s10=178%, s11=197%, s12=84%, s13=32%, s14=62%, s15=314%, s16=307%, s17=32%, s18=72%, s19=17%, s20=124%]  (sum=2865%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=5, s2=3, s3=1, s4=2, s5=2, s6=4, s7=3, s8=2, s9=3, s10=1, s11=2, s12=3, s13=5, s14=4, s15=3, s16=4, s17=3, s18=2, s19=5, s20=3] (stddev=1.18, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=116%, s2=88%, s3=132%, s4=165%, s5=60%, s6=25%, s7=142%, s8=24%, s9=120%, s10=96%, s11=95%, s12=143%, s13=62%, s14=36%, s15=166%, s16=108%, s17=25%, s18=83%, s19=62%, s20=131%]  (sum=1878%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=9, s2=9, s3=10, s4=10, s5=7, s6=9, s7=11, s8=10, s9=9, s10=8, s11=9, s12=9, s13=11, s14=9, s15=7, s16=7, s17=9, s18=9, s19=9, s20=9] (stddev=1.10, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=152%, s2=116%, s3=411%, s4=413%, s5=127%, s6=61%, s7=123%, s8=29%, s9=362%, s10=161%, s11=149%, s12=149%, s13=63%, s14=89%, s15=288%, s16=335%, s17=48%, s18=116%, s19=42%, s20=169%]  (sum=3401%)
write_bytes_per_second#1: last:  [s1=2663366, s2=2663486, s3=3347626, s4=2663135, s5=3349658, s6=3330949, s7=2666389, s8=3350893, s9=2666340, s10=3330488, s11=3330102, s12=2662588, s13=3996177, s14=2661658, s15=2665955, s16=3326917, s17=3328455, s18=2664456, s19=2663527, s20=2660947] (stddev=396510.24, mean=2999655.60, sum=59993112)
write_bytes_per_second#1: thrash_pct: [s1=135%, s2=147%, s3=295%, s4=334%, s5=146%, s6=86%, s7=112%, s8=60%, s9=259%, s10=133%, s11=139%, s12=112%, s13=66%, s14=78%, s15=200%, s16=254%, s17=38%, s18=139%, s19=38%, s20=146%]  (sum=2915%)
hash: c9d83ddb8896616b
==========================
