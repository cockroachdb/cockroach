# This test sets up a 10-node cluster with two workloads: (read-only, high-cpu on lh)
# uniformly across nodes and (write-only, high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_rate_capacity=3000000000
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=501327173, s2=496136077, s3=501801763, s4=499428811, s5=499252414, s6=497001259, s7=497711045, s8=505602687, s9=500558588, s10=501180176] (stddev=2610545.55, mean=499999999.30, sum=4999999993)
cpu#1: thrash_pct: [s1=79%, s2=74%, s3=79%, s4=81%, s5=110%, s6=111%, s7=58%, s8=109%, s9=127%, s10=87%]  (sum=915%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=79%, s2=74%, s3=79%, s4=81%, s5=110%, s6=111%, s7=58%, s8=109%, s9=127%, s10=87%]  (sum=915%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.03, s2=0.03, s3=0.03, s4=0.03, s5=0.03, s6=0.03, s7=0.03, s8=0.03, s9=0.03, s10=0.03] (stddev=0.00, mean=0.03, sum=0)
disk_fraction_used#1: thrash_pct: [s1=38%, s2=34%, s3=16%, s4=2%, s5=15%, s6=11%, s7=0%, s8=18%, s9=0%, s10=4%]  (sum=138%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=12, s2=5, s3=4, s4=4, s5=6, s6=5, s7=8, s8=5, s9=5, s10=6] (stddev=2.28, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=16%, s2=29%, s3=27%, s4=0%, s5=14%, s6=14%, s7=0%, s8=14%, s9=0%, s10=0%]  (sum=114%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=18, s2=18, s3=18, s4=18, s5=18, s6=18, s7=18, s8=18, s9=18, s10=18] (stddev=0.00, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=10%, s2=34%, s3=31%, s4=8%, s5=31%, s6=17%, s7=0%, s8=24%, s9=0%, s10=9%]  (sum=164%)
write_bytes_per_second#1: last:  [s1=5989391, s2=5993226, s3=5991558, s4=5991329, s5=5992220, s6=6013490, s7=5995472, s8=6013107, s9=5994690, s10=6016509] (stddev=10160.34, mean=5999099.20, sum=59990992)
write_bytes_per_second#1: thrash_pct: [s1=19%, s2=42%, s3=39%, s4=16%, s5=47%, s6=25%, s7=1%, s8=25%, s9=10%, s10=10%]  (sum=232%)
artifacts[mma-only]: 6b5a851153d3a8a5
==========================
cpu#1: last:  [s1=500755554, s2=501717484, s3=501553713, s4=502928868, s5=499887265, s6=496585615, s7=501535517, s8=514350619, s9=502845597, s10=497595434] (stddev=4575286.26, mean=501975566.60, sum=5019755666)
cpu#1: thrash_pct: [s1=273%, s2=356%, s3=325%, s4=410%, s5=96%, s6=389%, s7=179%, s8=289%, s9=236%, s10=233%]  (sum=2786%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=273%, s2=356%, s3=325%, s4=410%, s5=96%, s6=389%, s7=179%, s8=289%, s9=236%, s10=233%]  (sum=2786%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.04, s2=0.04, s3=0.03, s4=0.04, s5=0.03, s6=0.02, s7=0.03, s8=0.03, s9=0.03, s10=0.03] (stddev=0.01, mean=0.03, sum=0)
disk_fraction_used#1: thrash_pct: [s1=252%, s2=211%, s3=197%, s4=558%, s5=156%, s6=412%, s7=241%, s8=164%, s9=288%, s10=147%]  (sum=2625%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=10, s2=10, s3=4, s4=7, s5=3, s6=6, s7=6, s8=4, s9=5, s10=5] (stddev=2.28, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=242%, s2=201%, s3=135%, s4=226%, s5=100%, s6=236%, s7=124%, s8=157%, s9=190%, s10=190%]  (sum=1802%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=16, s2=18, s3=19, s4=20, s5=19, s6=17, s7=19, s8=17, s9=15, s10=20] (stddev=1.61, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=357%, s2=424%, s3=281%, s4=689%, s5=204%, s6=468%, s7=377%, s8=275%, s9=317%, s10=270%]  (sum=3662%)
write_bytes_per_second#1: last:  [s1=7341026, s2=7331474, s3=6005842, s4=6660347, s5=5989825, s6=3993657, s7=5344404, s8=5332267, s9=5997854, s10=5990313] (stddev=943850.46, mean=5998700.90, sum=59987009)
write_bytes_per_second#1: thrash_pct: [s1=299%, s2=347%, s3=318%, s4=690%, s5=266%, s6=402%, s7=302%, s8=240%, s9=318%, s10=206%]  (sum=3388%)
artifacts[mma-count]: aca34c7645db9000
==========================
