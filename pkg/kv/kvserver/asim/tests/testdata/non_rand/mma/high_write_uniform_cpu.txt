# This test sets up a 10-node cluster with two workloads: (read-only, high-cpu on lh)
# uniformly across nodes and (write-only, high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_rate_capacity=3000000000
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=501095833, s2=496283333, s3=501825000, s4=499525000, s5=499191666, s6=496991666, s7=497529166, s8=505645833, s9=500662500, s10=501250000] (stddev=2612585.85, mean=499999999.70, sum=4999999997)
cpu#1: thrash_pct: [s1=462%, s2=503%, s3=518%, s4=521%, s5=478%, s6=550%, s7=472%, s8=510%, s9=542%, s10=507%]  (sum=5065%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=462%, s2=503%, s3=518%, s4=521%, s5=478%, s6=550%, s7=472%, s8=510%, s9=542%, s10=507%]  (sum=5065%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.03, s2=0.03, s3=0.03, s4=0.03, s5=0.03, s6=0.03, s7=0.03, s8=0.03, s9=0.03, s10=0.03] (stddev=0.00, mean=0.03, sum=0)
disk_fraction_used#1: thrash_pct: [s1=119%, s2=55%, s3=43%, s4=45%, s5=27%, s6=23%, s7=24%, s8=12%, s9=109%, s10=29%]  (sum=487%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=10, s2=6, s3=6, s4=3, s5=6, s6=4, s7=4, s8=6, s9=9, s10=6] (stddev=2.05, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=16%, s2=15%, s3=38%, s4=12%, s5=14%, s6=0%, s7=25%, s8=14%, s9=42%, s10=27%]  (sum=204%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=18, s2=18, s3=18, s4=18, s5=18, s6=18, s7=18, s8=18, s9=18, s10=18] (stddev=0.00, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=50%, s2=18%, s3=38%, s4=58%, s5=38%, s6=24%, s7=17%, s8=9%, s9=97%, s10=39%]  (sum=390%)
write_bytes_per_second#1: last:  [s1=5987983, s2=5994822, s3=5992147, s4=6010824, s5=5991846, s6=5993816, s7=5993780, s8=6013651, s9=5996138, s10=6012394] (stddev=9123.97, mean=5998740.10, sum=59987401)
write_bytes_per_second#1: thrash_pct: [s1=95%, s2=73%, s3=98%, s4=123%, s5=83%, s6=70%, s7=56%, s8=49%, s9=97%, s10=77%]  (sum=821%)
artifacts[mma-only]: a187f7fcdc7520a5
==========================
cpu#1: last:  [s1=507916789, s2=498501253, s3=500579751, s4=499842814, s5=501335541, s6=494153659, s7=496397433, s8=499418762, s9=499983556, s10=504531465] (stddev=3665905.75, mean=500266102.30, sum=5002661023)
cpu#1: thrash_pct: [s1=492%, s2=358%, s3=429%, s4=435%, s5=479%, s6=229%, s7=232%, s8=428%, s9=435%, s10=417%]  (sum=3933%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.16, s7=0.17, s8=0.17, s9=0.17, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=492%, s2=358%, s3=429%, s4=435%, s5=479%, s6=229%, s7=232%, s8=428%, s9=435%, s10=417%]  (sum=3933%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.04, s2=0.04, s3=0.03, s4=0.03, s5=0.03, s6=0.02, s7=0.04, s8=0.03, s9=0.03, s10=0.04] (stddev=0.01, mean=0.03, sum=0)
disk_fraction_used#1: thrash_pct: [s1=440%, s2=282%, s3=270%, s4=437%, s5=536%, s6=284%, s7=139%, s8=248%, s9=473%, s10=235%]  (sum=3344%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=6, s2=8, s3=5, s4=7, s5=9, s6=6, s7=7, s8=3, s9=6, s10=3] (stddev=1.84, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=245%, s2=181%, s3=201%, s4=304%, s5=284%, s6=114%, s7=148%, s8=189%, s9=302%, s10=201%]  (sum=2169%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=18, s2=19, s3=18, s4=18, s5=18, s6=14, s7=18, s8=18, s9=18, s10=21] (stddev=1.61, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=621%, s2=423%, s3=396%, s4=730%, s5=682%, s6=259%, s7=283%, s8=426%, s9=769%, s10=321%]  (sum=4911%)
write_bytes_per_second#1: last:  [s1=6665505, s2=6679332, s3=4655369, s4=5343865, s5=5999973, s6=3993692, s7=7993314, s8=5328834, s9=6010782, s10=7317305] (stddev=1154442.08, mean=5998797.10, sum=59987971)
write_bytes_per_second#1: thrash_pct: [s1=592%, s2=450%, s3=421%, s4=587%, s5=529%, s6=409%, s7=333%, s8=413%, s9=607%, s10=371%]  (sum=4712%)
artifacts[mma-count]: 5f5d90a8fe809362
==========================
