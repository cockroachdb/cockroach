# This test sets up a 10-node multi-store cluster with two workloads:
# (read-only, high-cpu on lh) uniformly across nodes and (write-only,
# high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_rate_capacity=3000000000  stores_per_node=2
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=334082528, s2=334270833, s3=167395833, s4=166816666, s5=336229166, s6=166275000, s7=332456453, s8=166883333, s9=167408333, s10=331108333, s11=165920833, s12=332475000, s13=335316666, s14=167766666, s15=332504166, s16=164629166, s17=165708333, s18=331708333, s19=166062500, s20=334555916] (stddev=83501926.63, mean=249978702.85, sum=4999574057)
cpu#1: thrash_pct: [s1=213%, s2=43%, s3=31%, s4=33%, s5=44%, s6=31%, s7=65%, s8=33%, s9=37%, s10=45%, s11=30%, s12=116%, s13=45%, s14=35%, s15=47%, s16=51%, s17=46%, s18=49%, s19=32%, s20=129%]  (sum=1156%)
cpu_util#1: last:  [s1=0.22, s2=0.22, s3=0.11, s4=0.11, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17, s11=0.17, s12=0.17, s13=0.17, s14=0.17, s15=0.17, s16=0.17, s17=0.17, s18=0.17, s19=0.17, s20=0.17] (stddev=0.02, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=223%, s2=223%, s3=43%, s4=43%, s5=51%, s6=51%, s7=78%, s8=78%, s9=60%, s10=60%, s11=121%, s12=121%, s13=54%, s14=54%, s15=79%, s16=79%, s17=68%, s18=68%, s19=139%, s20=139%]  (sum=1832%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.03, s2=0.05, s3=0.01, s4=0.00, s5=0.02, s6=0.01, s7=0.03, s8=0.01, s9=0.01, s10=0.02, s11=0.01, s12=0.00, s13=0.01, s14=0.01, s15=0.01, s16=0.01, s17=0.01, s18=0.01, s19=0.01, s20=0.01] (stddev=0.01, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=9%, s2=4%, s3=8%, s4=14%, s5=0%, s6=10%, s7=0%, s8=9%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=10%, s15=0%, s16=0%, s17=8%, s18=0%, s19=2%, s20=0%]  (sum=75%)
leases#1: first: [s1=17, s2=9, s3=2, s4=2, s5=2, s6=1, s7=1, s8=1, s9=1, s10=3, s11=1, s12=2, s13=3, s14=1, s15=3, s16=2, s17=3, s18=2, s19=2, s20=2] (stddev=3.63, mean=3.00, sum=60)
leases#1: last:  [s1=8, s2=7, s3=1, s4=1, s5=3, s6=3, s7=3, s8=3, s9=3, s10=4, s11=2, s12=2, s13=3, s14=1, s15=4, s16=2, s17=2, s18=3, s19=3, s20=2] (stddev=1.73, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=43%, s2=0%, s3=0%, s4=0%, s5=0%, s6=14%, s7=0%, s8=14%, s9=0%, s10=0%, s11=0%, s12=12%, s13=0%, s14=0%, s15=0%, s16=12%, s17=26%, s18=0%, s19=13%, s20=12%]  (sum=149%)
replicas#1: first: [s1=35, s2=28, s3=16, s4=10, s5=8, s6=6, s7=5, s8=5, s9=5, s10=6, s11=6, s12=6, s13=6, s14=5, s15=5, s16=5, s17=6, s18=6, s19=5, s20=6] (stddev=7.97, mean=9.00, sum=180)
replicas#1: last:  [s1=13, s2=20, s3=6, s4=6, s5=10, s6=8, s7=12, s8=7, s9=8, s10=10, s11=8, s12=6, s13=8, s14=8, s15=8, s16=8, s17=8, s18=11, s19=7, s20=8] (stddev=3.13, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=28%, s5=0%, s6=33%, s7=0%, s8=40%, s9=0%, s10=0%, s11=7%, s12=6%, s13=0%, s14=34%, s15=0%, s16=7%, s17=27%, s18=8%, s19=20%, s20=0%]  (sum=211%)
write_bytes_per_second#1: last:  [s1=5992097, s2=9327360, s3=2661290, s4=665430, s5=3332113, s6=2664514, s7=4682081, s8=2663963, s9=2666335, s10=3330153, s11=2664958, s12=666627, s13=2017688, s14=2663691, s15=1997264, s16=2662541, s17=1997141, s18=2664088, s19=2664232, s20=2017315] (stddev=1842414.52, mean=3000044.05, sum=60000881)
write_bytes_per_second#1: thrash_pct: [s1=28%, s2=76%, s3=75%, s4=39%, s5=3%, s6=38%, s7=11%, s8=38%, s9=10%, s10=10%, s11=2%, s12=1%, s13=9%, s14=45%, s15=2%, s16=10%, s17=30%, s18=17%, s19=17%, s20=1%]  (sum=461%)
artifacts[mma-only]: 7753fb54a154bca0
==========================
cpu#1: last:  [s1=163867924, s2=333323295, s3=331866896, s4=334233514, s5=167098635, s6=340122249, s7=167662682, s8=165243101, s9=166641679, s10=164060258, s11=165947622, s12=330390589, s13=332597928, s14=336178108, s15=332328149, s16=165981651, s17=334308760, s18=166016159, s19=165955414, s20=334629155] (stddev=84098546.33, mean=249922688.40, sum=4998453768)
cpu#1: thrash_pct: [s1=411%, s2=262%, s3=870%, s4=941%, s5=222%, s6=401%, s7=317%, s8=422%, s9=416%, s10=334%, s11=315%, s12=434%, s13=436%, s14=443%, s15=395%, s16=397%, s17=340%, s18=316%, s19=370%, s20=337%]  (sum=8380%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.22, s4=0.22, s5=0.17, s6=0.17, s7=0.11, s8=0.11, s9=0.11, s10=0.11, s11=0.17, s12=0.17, s13=0.22, s14=0.22, s15=0.17, s16=0.17, s17=0.17, s18=0.17, s19=0.17, s20=0.17] (stddev=0.04, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=438%, s2=438%, s3=1120%, s4=1120%, s5=424%, s6=424%, s7=476%, s8=476%, s9=487%, s10=487%, s11=481%, s12=481%, s13=564%, s14=564%, s15=529%, s16=529%, s17=420%, s18=420%, s19=459%, s20=459%]  (sum=10797%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.01, s3=0.01, s4=0.02, s5=0.01, s6=0.02, s7=0.02, s8=0.01, s9=0.02, s10=0.02, s11=0.01, s12=0.01, s13=0.01, s14=0.01, s15=0.02, s16=0.01, s17=0.02, s18=0.01, s19=0.02, s20=0.01] (stddev=0.00, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=147%, s2=97%, s3=592%, s4=649%, s5=229%, s6=316%, s7=177%, s8=277%, s9=137%, s10=335%, s11=496%, s12=466%, s13=360%, s14=375%, s15=114%, s16=495%, s17=222%, s18=342%, s19=84%, s20=87%]  (sum=5998%)
leases#1: first: [s1=17, s2=9, s3=2, s4=2, s5=2, s6=1, s7=1, s8=1, s9=1, s10=3, s11=1, s12=2, s13=3, s14=1, s15=3, s16=2, s17=3, s18=2, s19=2, s20=2] (stddev=3.63, mean=3.00, sum=60)
leases#1: last:  [s1=4, s2=3, s3=5, s4=3, s5=4, s6=6, s7=1, s8=4, s9=1, s10=3, s11=1, s12=2, s13=3, s14=5, s15=5, s16=2, s17=2, s18=3, s19=1, s20=2] (stddev=1.48, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=128%, s2=123%, s3=321%, s4=354%, s5=108%, s6=134%, s7=118%, s8=192%, s9=118%, s10=153%, s11=176%, s12=165%, s13=188%, s14=181%, s15=143%, s16=165%, s17=95%, s18=178%, s19=83%, s20=94%]  (sum=3218%)
replicas#1: first: [s1=35, s2=28, s3=16, s4=10, s5=8, s6=6, s7=5, s8=5, s9=5, s10=6, s11=6, s12=6, s13=6, s14=5, s15=5, s16=5, s17=6, s18=6, s19=5, s20=6] (stddev=7.97, mean=9.00, sum=180)
replicas#1: last:  [s1=8, s2=9, s3=7, s4=11, s5=6, s6=10, s7=10, s8=6, s9=10, s10=11, s11=9, s12=9, s13=10, s14=10, s15=9, s16=9, s17=9, s18=9, s19=9, s20=9] (stddev=1.34, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=194%, s2=216%, s3=630%, s4=826%, s5=157%, s6=284%, s7=190%, s8=232%, s9=184%, s10=272%, s11=558%, s12=496%, s13=434%, s14=441%, s15=165%, s16=346%, s17=171%, s18=296%, s19=102%, s20=171%]  (sum=6363%)
write_bytes_per_second#1: last:  [s1=2667624, s2=2659735, s3=2683853, s4=3989765, s5=1999042, s6=3326972, s7=3332459, s8=1995466, s9=3332449, s10=3997267, s11=2666568, s12=2655797, s13=2657650, s14=2681150, s15=4013086, s16=2666765, s17=3988143, s18=2655467, s19=3324323, s20=2661582] (stddev=614003.18, mean=2997758.15, sum=59955163)
write_bytes_per_second#1: thrash_pct: [s1=190%, s2=216%, s3=494%, s4=608%, s5=228%, s6=257%, s7=180%, s8=207%, s9=225%, s10=258%, s11=528%, s12=451%, s13=388%, s14=331%, s15=153%, s16=405%, s17=287%, s18=313%, s19=124%, s20=286%]  (sum=6131%)
artifacts[mma-count]: a43bcc88c1915865
==========================
