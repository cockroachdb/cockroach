# This test sets up a 10-node multi-store cluster with two workloads:
# (read-only, high-cpu on lh) uniformly across nodes and (write-only,
# high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_rate_capacity=3000000000  stores_per_node=2
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=166733333, s2=333087500, s3=332200000, s4=166087500, s5=165008333, s6=332937500, s7=166958333, s8=167408333, s9=334327114, s10=334445833, s11=333762299, s12=166275000, s13=166883333, s14=165841666, s15=167395833, s16=332033333, s17=337815597, s18=332821681, s19=166062500, s20=332395833] (stddev=83567992.93, mean=250024042.70, sum=5000480854)
cpu#1: thrash_pct: [s1=44%, s2=69%, s3=60%, s4=48%, s5=45%, s6=56%, s7=40%, s8=61%, s9=79%, s10=61%, s11=158%, s12=43%, s13=45%, s14=63%, s15=43%, s16=158%, s17=176%, s18=78%, s19=53%, s20=59%]  (sum=1439%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.11, s8=0.11, s9=0.22, s10=0.22, s11=0.17, s12=0.17, s13=0.11, s14=0.11, s15=0.17, s16=0.17, s17=0.22, s18=0.22, s19=0.17, s20=0.17] (stddev=0.04, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=50%, s2=50%, s3=53%, s4=53%, s5=52%, s6=52%, s7=55%, s8=55%, s9=72%, s10=72%, s11=141%, s12=141%, s13=55%, s14=55%, s15=120%, s16=120%, s17=151%, s18=151%, s19=61%, s20=61%]  (sum=1620%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.05, s3=0.05, s4=0.01, s5=0.01, s6=0.01, s7=0.00, s8=0.01, s9=0.02, s10=0.02, s11=0.01, s12=0.01, s13=0.01, s14=0.00, s15=0.01, s16=0.00, s17=0.01, s18=0.02, s19=0.01, s20=0.00] (stddev=0.01, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=15%, s2=3%, s3=0%, s4=4%, s5=0%, s6=0%, s7=8%, s8=0%, s9=1%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=0%, s18=0%, s19=3%, s20=0%]  (sum=34%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=5, s2=8, s3=3, s4=3, s5=1, s6=2, s7=2, s8=2, s9=3, s10=4, s11=3, s12=3, s13=3, s14=2, s15=3, s16=2, s17=3, s18=4, s19=2, s20=2] (stddev=1.45, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=13%, s5=0%, s6=0%, s7=24%, s8=12%, s9=0%, s10=0%, s11=25%, s12=0%, s13=0%, s14=0%, s15=0%, s16=12%, s17=13%, s18=0%, s19=24%, s20=0%]  (sum=121%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=8, s2=18, s3=17, s4=8, s5=7, s6=9, s7=6, s8=8, s9=10, s10=10, s11=9, s12=8, s13=9, s14=5, s15=9, s16=7, s17=7, s18=11, s19=8, s20=6] (stddev=3.18, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=21%, s5=13%, s6=0%, s7=40%, s8=7%, s9=8%, s10=0%, s11=8%, s12=0%, s13=8%, s14=7%, s15=0%, s16=0%, s17=7%, s18=0%, s19=28%, s20=0%]  (sum=147%)
write_bytes_per_second#1: last:  [s1=2664475, s2=9990961, s3=8656089, s4=2664418, s5=2666355, s6=2663658, s7=666268, s8=2682724, s9=3332509, s10=3327703, s11=2664669, s12=2663382, s13=2682644, s14=665509, s15=2664546, s16=665509, s17=1997665, s18=3349273, s19=2662437, s20=666745] (stddev=2292409.54, mean=2999876.95, sum=59997539)
write_bytes_per_second#1: thrash_pct: [s1=29%, s2=53%, s3=57%, s4=37%, s5=9%, s6=16%, s7=41%, s8=10%, s9=9%, s10=10%, s11=2%, s12=2%, s13=2%, s14=1%, s15=2%, s16=1%, s17=9%, s18=2%, s19=30%, s20=15%]  (sum=338%)
artifacts[mma-only]: b3d73568e2e3aedb
==========================
cpu#1: last:  [s1=333742344, s2=164084967, s3=166947040, s4=166609311, s5=164748455, s6=332784476, s7=335351639, s8=334494907, s9=336447928, s10=166739562, s11=334841106, s12=332918112, s13=332816550, s14=164598425, s15=334779339, s16=167056204, s17=0, s18=169782608, s19=330150330, s20=166952104] (stddev=98589571.98, mean=241792270.35, sum=4835845407)
cpu#1: thrash_pct: [s1=326%, s2=717%, s3=405%, s4=376%, s5=379%, s6=356%, s7=467%, s8=911%, s9=596%, s10=316%, s11=351%, s12=311%, s13=285%, s14=486%, s15=319%, s16=190%, s17=388%, s18=593%, s19=592%, s20=371%]  (sum=8735%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.11, s4=0.11, s5=0.17, s6=0.17, s7=0.22, s8=0.22, s9=0.17, s10=0.17, s11=0.22, s12=0.22, s13=0.17, s14=0.17, s15=0.17, s16=0.17, s17=0.06, s18=0.06, s19=0.17, s20=0.17] (stddev=0.05, mean=0.16, sum=3)
cpu_util#1: thrash_pct: [s1=748%, s2=748%, s3=535%, s4=535%, s5=503%, s6=503%, s7=959%, s8=959%, s9=650%, s10=650%, s11=419%, s12=419%, s13=538%, s14=538%, s15=371%, s16=371%, s17=675%, s18=675%, s19=663%, s20=663%]  (sum=12120%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.02, s3=0.02, s4=0.01, s5=0.01, s6=0.01, s7=0.01, s8=0.01, s9=0.01, s10=0.01, s11=0.04, s12=0.02, s13=0.01, s14=0.01, s15=0.02, s16=0.01, s17=0.03, s18=0.03, s19=0.01, s20=0.00] (stddev=0.01, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=160%, s2=263%, s3=189%, s4=409%, s5=152%, s6=230%, s7=172%, s8=632%, s9=424%, s10=49%, s11=273%, s12=122%, s13=81%, s14=164%, s15=99%, s16=234%, s17=153%, s18=294%, s19=381%, s20=329%]  (sum=4811%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=2, s2=5, s3=2, s4=2, s5=2, s6=2, s7=3, s8=2, s9=4, s10=4, s11=8, s12=3, s13=4, s14=3, s15=2, s16=3, s17=2, s18=3, s19=3, s20=1] (stddev=1.48, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=129%, s2=251%, s3=178%, s4=176%, s5=95%, s6=129%, s7=142%, s8=247%, s9=227%, s10=119%, s11=124%, s12=155%, s13=96%, s14=176%, s15=141%, s16=142%, s17=141%, s18=179%, s19=201%, s20=189%]  (sum=3241%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=9, s2=9, s3=9, s4=7, s5=8, s6=9, s7=10, s8=8, s9=8, s10=9, s11=12, s12=9, s13=8, s14=9, s15=10, s16=9, s17=11, s18=10, s19=9, s20=7] (stddev=1.18, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=297%, s2=405%, s3=262%, s4=421%, s5=239%, s6=356%, s7=196%, s8=730%, s9=595%, s10=183%, s11=301%, s12=209%, s13=124%, s14=222%, s15=190%, s16=306%, s17=216%, s18=358%, s19=447%, s20=401%]  (sum=6457%)
write_bytes_per_second#1: last:  [s1=2663008, s2=3321052, s3=3330664, s4=1988212, s5=2659475, s6=2689448, s7=1995561, s8=1999752, s9=2678213, s10=2666906, s11=6660568, s12=3326073, s13=2660766, s14=2663583, s15=4004468, s16=2667484, s17=4657240, s18=4675995, s19=2684404, s20=0] (stddev=1290248.94, mean=2999643.60, sum=59992872)
write_bytes_per_second#1: thrash_pct: [s1=308%, s2=385%, s3=290%, s4=397%, s5=296%, s6=281%, s7=269%, s8=517%, s9=402%, s10=93%, s11=272%, s12=195%, s13=98%, s14=249%, s15=182%, s16=316%, s17=156%, s18=357%, s19=362%, s20=319%]  (sum=5742%)
artifacts[mma-count]: 519e91692a65fe4d
==========================
