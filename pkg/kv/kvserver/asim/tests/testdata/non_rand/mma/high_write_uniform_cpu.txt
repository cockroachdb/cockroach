# This test sets up a 10-node multi-store cluster with two workloads:
# (read-only, high-cpu on lh) uniformly across nodes and (write-only,
# high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_cores=3  stores_per_node=2
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=166733333, s2=333087500, s3=166100000, s4=336587963, s5=165008333, s6=165433333, s7=332199773, s8=334258333, s9=334595124, s10=331761293, s11=332502256, s12=166275000, s13=166883333, s14=332783333, s15=167395833, s16=333815846, s17=167408333, s18=332821681, s19=166062500, s20=167766666] (stddev=83474937.14, mean=249973988.30, sum=4999479766)
cpu#1: thrash_pct: [s1=23%, s2=35%, s3=29%, s4=42%, s5=23%, s6=28%, s7=39%, s8=34%, s9=43%, s10=90%, s11=90%, s12=22%, s13=23%, s14=31%, s15=22%, s16=84%, s17=34%, s18=40%, s19=27%, s20=33%]  (sum=793%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.11, s6=0.11, s7=0.22, s8=0.22, s9=0.22, s10=0.22, s11=0.17, s12=0.17, s13=0.17, s14=0.17, s15=0.17, s16=0.17, s17=0.17, s18=0.17, s19=0.11, s20=0.11] (stddev=0.04, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=30%, s2=30%, s3=78%, s4=78%, s5=31%, s6=31%, s7=45%, s8=45%, s9=92%, s10=92%, s11=174%, s12=174%, s13=33%, s14=33%, s15=73%, s16=73%, s17=75%, s18=75%, s19=35%, s20=35%]  (sum=1330%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.01, s2=0.05, s3=0.01, s4=0.01, s5=0.01, s6=0.01, s7=0.02, s8=0.01, s9=0.02, s10=0.01, s11=0.01, s12=0.01, s13=0.01, s14=0.00, s15=0.01, s16=0.01, s17=0.01, s18=0.02, s19=0.01, s20=0.01] (stddev=0.01, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=15%, s2=3%, s3=33%, s4=4%, s5=9%, s6=13%, s7=0%, s8=0%, s9=8%, s10=6%, s11=0%, s12=0%, s13=29%, s14=0%, s15=16%, s16=0%, s17=20%, s18=0%, s19=15%, s20=22%]  (sum=195%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=5, s2=8, s3=2, s4=3, s5=1, s6=1, s7=4, s8=2, s9=4, s10=4, s11=3, s12=2, s13=1, s14=3, s15=3, s16=2, s17=3, s18=4, s19=2, s20=3] (stddev=1.58, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=25%, s4=13%, s5=12%, s6=0%, s7=13%, s8=0%, s9=14%, s10=25%, s11=49%, s12=0%, s13=13%, s14=0%, s15=13%, s16=12%, s17=25%, s18=0%, s19=24%, s20=25%]  (sum=259%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=8, s2=18, s3=7, s4=9, s5=7, s6=8, s7=11, s8=9, s9=11, s10=9, s11=9, s12=8, s13=9, s14=6, s15=9, s16=8, s17=7, s18=11, s19=8, s20=8] (stddev=2.45, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=58%, s4=27%, s5=40%, s6=34%, s7=8%, s8=0%, s9=29%, s10=28%, s11=29%, s12=0%, s13=75%, s14=0%, s15=29%, s16=8%, s17=47%, s18=0%, s19=41%, s20=55%]  (sum=507%)
write_bytes_per_second#1: last:  [s1=2664475, s2=9991099, s3=2661835, s4=2664561, s5=2665150, s6=2664539, s7=3328843, s8=2682573, s9=3334332, s10=2662517, s11=2664810, s12=2661389, s13=2664684, s14=665509, s15=2663067, s16=1997940, s17=2663227, s18=3349132, s19=2682770, s20=2663191] (stddev=1691603.86, mean=2999782.15, sum=59995643)
write_bytes_per_second#1: thrash_pct: [s1=29%, s2=74%, s3=114%, s4=51%, s5=43%, s6=50%, s7=45%, s8=24%, s9=31%, s10=30%, s11=2%, s12=2%, s13=84%, s14=1%, s15=30%, s16=1%, s17=58%, s18=10%, s19=37%, s20=64%]  (sum=779%)
artifacts[mma-only]: 52f2aa0cbb787201
==========================
cpu#1: last:  [s1=335611936, s2=334020713, s3=333773363, s4=166007017, s5=165607385, s6=334010681, s7=167271487, s8=330028873, s9=335107230, s10=167812500, s11=332361519, s12=330762137, s13=167659894, s14=167085463, s15=165906005, s16=167843766, s17=330972145, s18=165630983, s19=166535061, s20=332058823] (stddev=83079551.53, mean=249803349.05, sum=4996066981)
cpu#1: thrash_pct: [s1=345%, s2=434%, s3=431%, s4=442%, s5=381%, s6=261%, s7=722%, s8=434%, s9=159%, s10=272%, s11=266%, s12=508%, s13=212%, s14=151%, s15=196%, s16=313%, s17=389%, s18=357%, s19=152%, s20=250%]  (sum=6677%)
cpu_util#1: last:  [s1=0.22, s2=0.22, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17, s11=0.22, s12=0.22, s13=0.11, s14=0.11, s15=0.11, s16=0.11, s17=0.17, s18=0.17, s19=0.17, s20=0.17] (stddev=0.04, mean=0.17, sum=3)
cpu_util#1: thrash_pct: [s1=514%, s2=514%, s3=583%, s4=583%, s5=424%, s6=424%, s7=782%, s8=782%, s9=304%, s10=304%, s11=509%, s12=509%, s13=230%, s14=230%, s15=333%, s16=333%, s17=492%, s18=492%, s19=262%, s20=262%]  (sum=8864%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00, s11=0.00, s12=0.00, s13=0.00, s14=0.00, s15=0.00, s16=0.00, s17=0.00, s18=0.00, s19=0.00, s20=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.02, s2=0.01, s3=0.02, s4=0.01, s5=0.01, s6=0.02, s7=0.02, s8=0.01, s9=0.02, s10=0.01, s11=0.02, s12=0.02, s13=0.01, s14=0.01, s15=0.01, s16=0.01, s17=0.01, s18=0.01, s19=0.01, s20=0.02] (stddev=0.00, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=135%, s2=242%, s3=314%, s4=249%, s5=381%, s6=276%, s7=648%, s8=257%, s9=59%, s10=115%, s11=279%, s12=377%, s13=389%, s14=167%, s15=447%, s16=443%, s17=297%, s18=260%, s19=426%, s20=94%]  (sum=5855%)
leases#1: first: [s1=17, s2=9, s3=3, s4=2, s5=1, s6=2, s7=2, s8=2, s9=1, s10=3, s11=1, s12=1, s13=2, s14=3, s15=2, s16=2, s17=2, s18=1, s19=2, s20=2] (stddev=3.62, mean=3.00, sum=60)
leases#1: last:  [s1=3, s2=4, s3=3, s4=4, s5=3, s6=4, s7=3, s8=3, s9=4, s10=3, s11=2, s12=3, s13=5, s14=3, s15=1, s16=2, s17=3, s18=1, s19=1, s20=5] (stddev=1.14, mean=3.00, sum=60)
leases#1: thrash_pct: [s1=129%, s2=205%, s3=165%, s4=132%, s5=143%, s6=73%, s7=272%, s8=131%, s9=62%, s10=71%, s11=107%, s12=143%, s13=133%, s14=106%, s15=95%, s16=153%, s17=119%, s18=106%, s19=83%, s20=109%]  (sum=2535%)
replicas#1: first: [s1=34, s2=28, s3=16, s4=10, s5=7, s6=7, s7=6, s8=6, s9=6, s10=6, s11=5, s12=5, s13=6, s14=5, s15=5, s16=5, s17=6, s18=5, s19=6, s20=6] (stddev=7.78, mean=9.00, sum=180)
replicas#1: last:  [s1=10, s2=9, s3=9, s4=8, s5=9, s6=9, s7=10, s8=9, s9=9, s10=10, s11=9, s12=10, s13=9, s14=8, s15=9, s16=8, s17=9, s18=8, s19=9, s20=9] (stddev=0.63, mean=9.00, sum=180)
replicas#1: thrash_pct: [s1=258%, s2=379%, s3=282%, s4=298%, s5=240%, s6=182%, s7=428%, s8=234%, s9=124%, s10=73%, s11=235%, s12=429%, s13=241%, s14=137%, s15=196%, s16=305%, s17=208%, s18=215%, s19=176%, s20=118%]  (sum=4758%)
write_bytes_per_second#1: last:  [s1=3328007, s2=2684337, s3=3328861, s4=2680750, s5=2660828, s6=3330215, s7=3332833, s8=2663184, s9=3996737, s10=2664392, s11=3350996, s12=3330574, s13=2658792, s14=2664642, s15=2657895, s16=2664052, s17=2652524, s18=2664485, s19=2665366, s20=3990797] (stddev=446649.08, mean=2998513.35, sum=59970267)
write_bytes_per_second#1: thrash_pct: [s1=238%, s2=275%, s3=331%, s4=261%, s5=240%, s6=235%, s7=369%, s8=250%, s9=163%, s10=65%, s11=291%, s12=287%, s13=188%, s14=127%, s15=187%, s16=330%, s17=228%, s18=249%, s19=193%, s20=128%]  (sum=4634%)
artifacts[mma-count]: 5ea12f4cf711bd1f
==========================
