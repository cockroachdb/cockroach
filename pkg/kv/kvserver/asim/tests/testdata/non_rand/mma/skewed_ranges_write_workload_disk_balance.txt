# This test verifies that MMA can balance disks when the imbalance is already
# high under a write-heavy workload. In this setting, doing disk based
# rebalancing goes against the goals of CPU and write bandwidth balancing. The
# test creates two nodes with 20 GiB store capacity. The first node has 100
# ranges of 90 MiB each (55% full). The second node has 100 ranges of 1 MiB each
# (1% full). A write-only workload is started that targets both nodes evenly.
#
# Expectation: MMA should perform rebalancing based on disk usage while trying
# to keep CPU utilization and write bandwidth also balanced. The hope is that
# MMA extends the time it takes for the first node to hit high disk-usage
# threshold compared to SMA.
gen_cluster nodes=2 node_cpu_cores=2 store_byte_capacity_gib=20
----

gen_ranges ranges=100 repl_factor=1 min_key=0 max_key=10000 placement_type=replica_placement bytes_mib=90
{s1}:1
----
{s1:*}:1

gen_ranges ranges=100 repl_factor=1 min_key=10000 max_key=20000 placement_type=replica_placement bytes_mib=1
{s2}:1
----
{s2:*}:1

gen_load rate=5000 rw_ratio=0 min_block=1024 max_block=1024 request_cpu_per_access=100000 raft_cpu_per_write=100000 min_key=0 max_key=20000
----
0.50 access-vcpus, 0.50 raft-vcpus, 4.9 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=100m samples=1 seed=42 cfgs=(sma-count,mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases,disk_fraction_used)
----
cpu#1: last:  [s1=390367199, s2=609965047] (stddev=109798924.00, mean=500166123.00, sum=1000332246)
cpu#1: thrash_pct: [s1=36%, s2=63%]  (sum=98%)
cpu_util#1: last:  [s1=0.20, s2=0.30] (stddev=0.05, mean=0.25, sum=1)
cpu_util#1: thrash_pct: [s1=36%, s2=63%]  (sum=98%)
disk_fraction_used#1: first: [s1=0.55, s2=0.01] (stddev=0.27, mean=0.28, sum=1)
disk_fraction_used#1: last:  [s1=1.13, s2=1.22] (stddev=0.05, mean=1.17, sum=2)
disk_fraction_used#1: thrash_pct: [s1=44%, s2=0%]  (sum=44%)
leases#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
leases#1: last:  [s1=78, s2=122] (stddev=22.00, mean=100.00, sum=200)
leases#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=78, s2=122] (stddev=22.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=1998680, s2=3123021] (stddev=562170.50, mean=2560850.50, sum=5121701)
write_bytes_per_second#1: thrash_pct: [s1=36%, s2=63%]  (sum=98%)
artifacts[sma-count]: 1a6e9465915e3ac7
==========================
cpu#1: last:  [s1=405306929, s2=595000980] (stddev=94847025.50, mean=500153954.50, sum=1000307909)
cpu#1: thrash_pct: [s1=97%, s2=123%]  (sum=220%)
cpu_util#1: last:  [s1=0.20, s2=0.30] (stddev=0.05, mean=0.25, sum=1)
cpu_util#1: thrash_pct: [s1=97%, s2=123%]  (sum=220%)
disk_fraction_used#1: first: [s1=0.55, s2=0.01] (stddev=0.27, mean=0.28, sum=1)
disk_fraction_used#1: last:  [s1=1.13, s2=1.22] (stddev=0.05, mean=1.17, sum=2)
disk_fraction_used#1: thrash_pct: [s1=43%, s2=5%]  (sum=48%)
leases#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
leases#1: last:  [s1=81, s2=119] (stddev=19.00, mean=100.00, sum=200)
leases#1: thrash_pct: [s1=48%, s2=48%]  (sum=96%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=81, s2=119] (stddev=19.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=48%, s2=48%]  (sum=96%)
write_bytes_per_second#1: last:  [s1=2075171, s2=3046405] (stddev=485617.00, mean=2560788.00, sum=5121576)
write_bytes_per_second#1: thrash_pct: [s1=97%, s2=123%]  (sum=220%)
artifacts[mma-only]: c693fb0ed3222a01
==========================
cpu#1: last:  [s1=395390460, s2=604900459] (stddev=104754999.50, mean=500145459.50, sum=1000290919)
cpu#1: thrash_pct: [s1=89%, s2=114%]  (sum=203%)
cpu_util#1: last:  [s1=0.20, s2=0.30] (stddev=0.05, mean=0.25, sum=1)
cpu_util#1: thrash_pct: [s1=89%, s2=114%]  (sum=203%)
disk_fraction_used#1: first: [s1=0.55, s2=0.01] (stddev=0.27, mean=0.28, sum=1)
disk_fraction_used#1: last:  [s1=1.11, s2=1.23] (stddev=0.06, mean=1.17, sum=2)
disk_fraction_used#1: thrash_pct: [s1=44%, s2=3%]  (sum=47%)
leases#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
leases#1: last:  [s1=79, s2=121] (stddev=21.00, mean=100.00, sum=200)
leases#1: thrash_pct: [s1=44%, s2=44%]  (sum=87%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=79, s2=121] (stddev=21.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=44%, s2=44%]  (sum=87%)
write_bytes_per_second#1: last:  [s1=2024399, s2=3097090] (stddev=536345.50, mean=2560744.50, sum=5121489)
write_bytes_per_second#1: thrash_pct: [s1=89%, s2=114%]  (sum=203%)
artifacts[mma-count]: f6f21a680fa51730
==========================
