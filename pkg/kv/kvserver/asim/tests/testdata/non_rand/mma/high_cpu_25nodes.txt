# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

# TODO(tbg): likely accidentally too low.
gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----
0.00 access-vcpus, 0.00 raft-vcpus, 73 KiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# only mainly on s1-s3 due to the skewed distribution.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=4206019833, s2=4196185516, s3=6307338295, s4=4199573838, s5=4191438687, s6=4198998914, s7=4195902382, s8=4189575907, s9=4205480772, s10=4212518971, s11=4203942143, s12=4208124857, s13=4201922174, s14=4201899513, s15=4186889030, s16=4198293007, s17=4190652522, s18=4201917446, s19=4208931395, s20=4203404170, s21=4211222091, s22=2100653787, s23=4197759491, s24=4209891497, s25=4199679069] (stddev=594952429.35, mean=4201128612.28, sum=105028215307)
cpu#1: thrash_pct: [s1=6%, s2=40%, s3=51%, s4=51%, s5=26%, s6=3%, s7=2%, s8=2%, s9=3%, s10=2%, s11=3%, s12=3%, s13=3%, s14=2%, s15=2%, s16=19%, s17=2%, s18=3%, s19=2%, s20=3%, s21=19%, s22=1%, s23=3%, s24=2%, s25=11%]  (sum=263%)
cpu_util#1: last:  [s1=0.53, s2=0.52, s3=0.79, s4=0.52, s5=0.52, s6=0.52, s7=0.52, s8=0.52, s9=0.53, s10=0.53, s11=0.53, s12=0.53, s13=0.53, s14=0.53, s15=0.52, s16=0.52, s17=0.52, s18=0.53, s19=0.53, s20=0.53, s21=0.53, s22=0.26, s23=0.52, s24=0.53, s25=0.52] (stddev=0.07, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=6%, s2=40%, s3=51%, s4=51%, s5=26%, s6=3%, s7=2%, s8=2%, s9=3%, s10=2%, s11=3%, s12=3%, s13=3%, s14=2%, s15=2%, s16=19%, s17=2%, s18=3%, s19=2%, s20=3%, s21=19%, s22=1%, s23=3%, s24=2%, s25=11%]  (sum=263%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=3, s2=4, s3=5, s4=4, s5=4, s6=4, s7=4, s8=3, s9=4, s10=4, s11=5, s12=3, s13=5, s14=4, s15=4, s16=4, s17=4, s18=4, s19=4, s20=4, s21=4, s22=3, s23=5, s24=5, s25=3] (stddev=0.63, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=34%, s3=45%, s4=45%, s5=23%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=15%, s17=0%, s18=0%, s19=0%, s20=0%, s21=16%, s22=0%, s23=0%, s24=0%, s25=8%]  (sum=187%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=54, s2=33, s3=19, s4=11, s5=10, s6=9, s7=10, s8=8, s9=9, s10=9, s11=8, s12=8, s13=9, s14=9, s15=9, s16=9, s17=8, s18=8, s19=9, s20=9, s21=8, s22=7, s23=9, s24=10, s25=8] (stddev=9.99, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=5%, s5=5%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=9%, s17=0%, s18=0%, s19=0%, s20=0%, s21=9%, s22=0%, s23=0%, s24=0%, s25=4%]  (sum=31%)
write_bytes_per_second#1: last:  [s1=9721, s2=9412, s3=9170, s4=9071, s5=9058, s6=9017, s7=9030, s8=9036, s9=9071, s10=9056, s11=8998, s12=8976, s13=9054, s14=9041, s15=9071, s16=9064, s17=9041, s18=9034, s19=9053, s20=9025, s21=9019, s22=9028, s23=9069, s24=9090, s25=9033] (stddev=151.38, mean=9089.52, sum=227238)
write_bytes_per_second#1: thrash_pct: [s1=461%, s2=452%, s3=399%, s4=395%, s5=411%, s6=380%, s7=378%, s8=353%, s9=336%, s10=337%, s11=330%, s12=360%, s13=357%, s14=364%, s15=341%, s16=349%, s17=382%, s18=375%, s19=355%, s20=354%, s21=400%, s22=345%, s23=426%, s24=381%, s25=348%]  (sum=9369%)
artifacts[mma-only]: a914dbff5ba132ec
==========================
cpu#1: last:  [s1=4196738540, s2=4209925703, s3=4197642531, s4=4203976925, s5=6310337534, s6=4209549595, s7=4203396226, s8=4200533744, s9=4199232325, s10=4204283723, s11=4202398757, s12=4202236594, s13=4200513264, s14=4198252071, s15=4197887916, s16=4189080432, s17=4200838805, s18=4204416326, s19=4199394659, s20=2104037568, s21=4206078761, s22=4205179750, s23=4193854155, s24=4207461570, s25=4202573370] (stddev=594880102.87, mean=4201992833.76, sum=105049820844)
cpu#1: thrash_pct: [s1=5%, s2=4%, s3=10%, s4=10%, s5=4%, s6=3%, s7=3%, s8=2%, s9=3%, s10=2%, s11=3%, s12=26%, s13=3%, s14=3%, s15=2%, s16=3%, s17=3%, s18=2%, s19=3%, s20=2%, s21=3%, s22=34%, s23=3%, s24=3%, s25=3%]  (sum=139%)
cpu_util#1: last:  [s1=0.52, s2=0.53, s3=0.52, s4=0.53, s5=0.79, s6=0.53, s7=0.53, s8=0.53, s9=0.52, s10=0.53, s11=0.53, s12=0.53, s13=0.53, s14=0.52, s15=0.52, s16=0.52, s17=0.53, s18=0.53, s19=0.52, s20=0.26, s21=0.53, s22=0.53, s23=0.52, s24=0.53, s25=0.53] (stddev=0.07, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=5%, s2=4%, s3=10%, s4=10%, s5=4%, s6=3%, s7=3%, s8=2%, s9=3%, s10=2%, s11=3%, s12=26%, s13=3%, s14=3%, s15=2%, s16=3%, s17=3%, s18=2%, s19=3%, s20=2%, s21=3%, s22=34%, s23=3%, s24=3%, s25=3%]  (sum=139%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=3, s2=2, s3=2, s4=4, s5=4, s6=4, s7=4, s8=3, s9=4, s10=4, s11=5, s12=4, s13=5, s14=5, s15=4, s16=5, s17=4, s18=4, s19=4, s20=4, s21=4, s22=4, s23=5, s24=5, s25=4] (stddev=0.80, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=8%, s4=8%, s5=8%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=23%, s13=0%, s14=0%, s15=0%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=0%, s22=30%, s23=0%, s24=0%, s25=0%]  (sum=78%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=12, s2=12, s3=13, s4=12, s5=12, s6=14, s7=11, s8=12, s9=12, s10=11, s11=12, s12=12, s13=12, s14=12, s15=12, s16=11, s17=12, s18=12, s19=12, s20=12, s21=11, s22=11, s23=13, s24=13, s25=12] (stddev=0.69, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=5%, s5=4%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=0%, s22=5%, s23=0%, s24=0%, s25=0%]  (sum=14%)
write_bytes_per_second#1: last:  [s1=1657, s2=179, s3=1671, s4=3136, s5=7606, s6=9091, s7=9045, s8=10574, s9=12089, s10=9083, s11=12027, s12=10531, s13=10575, s14=10567, s15=12086, s16=10579, s17=12085, s18=9095, s19=12056, s20=13503, s21=9063, s22=9088, s23=10619, s24=9136, s25=12089] (stddev=3540.66, mean=9089.20, sum=227230)
write_bytes_per_second#1: thrash_pct: [s1=21%, s2=16%, s3=27%, s4=26%, s5=46%, s6=67%, s7=64%, s8=61%, s9=46%, s10=63%, s11=44%, s12=45%, s13=46%, s14=66%, s15=43%, s16=46%, s17=72%, s18=92%, s19=46%, s20=54%, s21=43%, s22=38%, s23=51%, s24=67%, s25=81%]  (sum=1271%)
artifacts[mma-count]: f4a8d3922318a8d0
==========================
