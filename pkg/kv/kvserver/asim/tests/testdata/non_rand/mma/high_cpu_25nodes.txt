# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_cores=8
----

setting split_queue_enabled=false
----

# A workload is added over the entire keyspace, which is initially placed only
# on s1-s9.
gen_ranges ranges=500 min_key=0 max_key=20000 placement_type=replica_placement
{s1,s2,s3}:1
{s4,s5,s6}:1
{s7,s8,s9}:1
----
{s1:*,s2,s3}:1
{s4:*,s5,s6}:1
{s7:*,s8,s9}:1

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=700000 raft_cpu_per_write=200000 min_key=0 max_key=20000
----
10.50 access-vcpus, 0.15 raft-vcpus, 750 B/s goodput

eval duration=25m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=465448266, s2=454658033, s3=370200309, s4=466241466, s5=348807435, s6=326294624, s7=465931266, s8=327022268, s9=433135213, s10=468650978, s11=468032284, s12=468703586, s13=319373726, s14=404347235, s15=468052372, s16=467741409, s17=468474449, s18=468209178, s19=468940504, s20=467592518, s21=468116054, s22=468954354, s23=468571821, s24=468690916, s25=468574476] (stddev=52192287.95, mean=437550589.60, sum=10938764740)
cpu#1: thrash_pct: [s1=11%, s2=9%, s3=8%, s4=10%, s5=8%, s6=8%, s7=11%, s8=8%, s9=9%, s10=8%, s11=11%, s12=7%, s13=5%, s14=6%, s15=9%, s16=7%, s17=14%, s18=9%, s19=7%, s20=10%, s21=7%, s22=7%, s23=10%, s24=7%, s25=7%]  (sum=213%)
cpu_util#1: last:  [s1=0.06, s2=0.06, s3=0.05, s4=0.06, s5=0.04, s6=0.04, s7=0.06, s8=0.04, s9=0.05, s10=0.06, s11=0.06, s12=0.06, s13=0.04, s14=0.05, s15=0.06, s16=0.06, s17=0.06, s18=0.06, s19=0.06, s20=0.06, s21=0.06, s22=0.06, s23=0.06, s24=0.06, s25=0.06] (stddev=0.01, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=11%, s2=9%, s3=8%, s4=10%, s5=8%, s6=8%, s7=11%, s8=8%, s9=9%, s10=8%, s11=11%, s12=7%, s13=5%, s14=6%, s15=9%, s16=7%, s17=14%, s18=9%, s19=7%, s20=10%, s21=7%, s22=7%, s23=10%, s24=7%, s25=7%]  (sum=213%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=22, s2=19, s3=15, s4=22, s5=14, s6=13, s7=22, s8=13, s9=18, s10=22, s11=22, s12=22, s13=15, s14=19, s15=22, s16=22, s17=22, s18=22, s19=22, s20=22, s21=22, s22=22, s23=22, s24=22, s25=22] (stddev=3.21, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=2%, s11=5%, s12=0%, s13=0%, s14=0%, s15=2%, s16=0%, s17=7%, s18=2%, s19=0%, s20=3%, s21=0%, s22=0%, s23=3%, s24=0%, s25=0%]  (sum=23%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=22, s2=186, s3=182, s4=22, s5=181, s6=180, s7=22, s8=179, s9=184, s10=22, s11=22, s12=22, s13=15, s14=19, s15=22, s16=22, s17=22, s18=22, s19=22, s20=22, s21=22, s22=22, s23=22, s24=22, s25=22] (stddev=68.58, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=2%, s11=4%, s12=0%, s13=0%, s14=0%, s15=2%, s16=0%, s17=6%, s18=2%, s19=0%, s20=3%, s21=0%, s22=0%, s23=3%, s24=0%, s25=0%]  (sum=21%)
write_bytes_per_second#1: last:  [s1=32, s2=279, s3=273, s4=32, s5=270, s6=269, s7=32, s8=268, s9=275, s10=32, s11=32, s12=33, s13=22, s14=28, s15=32, s16=32, s17=33, s18=32, s19=33, s20=33, s21=33, s22=33, s23=33, s24=33, s25=33] (stddev=102.80, mean=89.48, sum=2237)
write_bytes_per_second#1: thrash_pct: [s1=33%, s2=219%, s3=213%, s4=36%, s5=227%, s6=237%, s7=20%, s8=228%, s9=248%, s10=22%, s11=34%, s12=43%, s13=18%, s14=34%, s15=18%, s16=19%, s17=43%, s18=30%, s19=27%, s20=20%, s21=28%, s22=20%, s23=24%, s24=30%, s25=30%]  (sum=1902%)
artifacts[mma-only]: badf16a7721889e3
==========================
cpu#1: last:  [s1=479582462, s2=416893232, s3=354683378, s4=480755517, s5=375112525, s6=438669079, s7=479287682, s8=374734078, s9=353558405, s10=459115168, s11=459641964, s12=416567087, s13=457864915, s14=479677281, s15=458969381, s16=416838126, s17=439177543, s18=459494023, s19=458443535, s20=458980623, s21=416392513, s22=459704532, s23=479212304, s24=437658822, s25=438217958] (stddev=37993693.80, mean=437969285.32, sum=10949232133)
cpu#1: thrash_pct: [s1=8%, s2=8%, s3=6%, s4=8%, s5=7%, s6=7%, s7=8%, s8=7%, s9=7%, s10=11%, s11=7%, s12=9%, s13=19%, s14=7%, s15=7%, s16=6%, s17=6%, s18=5%, s19=10%, s20=7%, s21=12%, s22=6%, s23=18%, s24=7%, s25=8%]  (sum=209%)
cpu_util#1: last:  [s1=0.06, s2=0.05, s3=0.04, s4=0.06, s5=0.05, s6=0.05, s7=0.06, s8=0.05, s9=0.04, s10=0.06, s11=0.06, s12=0.05, s13=0.06, s14=0.06, s15=0.06, s16=0.05, s17=0.05, s18=0.06, s19=0.06, s20=0.06, s21=0.05, s22=0.06, s23=0.06, s24=0.05, s25=0.05] (stddev=0.00, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=8%, s2=8%, s3=6%, s4=8%, s5=7%, s6=7%, s7=8%, s8=7%, s9=7%, s10=11%, s11=7%, s12=9%, s13=19%, s14=7%, s15=7%, s16=6%, s17=6%, s18=5%, s19=10%, s20=7%, s21=12%, s22=6%, s23=18%, s24=7%, s25=8%]  (sum=209%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=22, s2=19, s3=16, s4=22, s5=17, s6=20, s7=22, s8=17, s9=16, s10=21, s11=21, s12=19, s13=21, s14=22, s15=21, s16=19, s17=20, s18=21, s19=21, s20=21, s21=19, s22=21, s23=22, s24=20, s25=20] (stddev=1.81, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=2%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=6%, s11=2%, s12=3%, s13=12%, s14=2%, s15=2%, s16=0%, s17=0%, s18=0%, s19=5%, s20=2%, s21=7%, s22=2%, s23=12%, s24=2%, s25=3%]  (sum=60%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=58, s2=62, s3=61, s4=60, s5=59, s6=60, s7=58, s8=59, s9=61, s10=61, s11=63, s12=59, s13=58, s14=61, s15=61, s16=60, s17=61, s18=61, s19=59, s20=60, s21=58, s22=62, s23=59, s24=60, s25=59] (stddev=1.36, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=10%, s3=4%, s4=0%, s5=2%, s6=2%, s7=0%, s8=4%, s9=6%, s10=2%, s11=2%, s12=11%, s13=2%, s14=0%, s15=4%, s16=0%, s17=5%, s18=0%, s19=0%, s20=0%, s21=0%, s22=2%, s23=2%, s24=4%, s25=0%]  (sum=60%)
write_bytes_per_second#1: last:  [s1=87, s2=93, s3=91, s4=89, s5=88, s6=90, s7=87, s8=88, s9=91, s10=91, s11=94, s12=88, s13=86, s14=91, s15=91, s16=89, s17=91, s18=91, s19=88, s20=89, s21=86, s22=93, s23=88, s24=89, s25=88] (stddev=2.12, mean=89.48, sum=2237)
write_bytes_per_second#1: thrash_pct: [s1=49%, s2=97%, s3=115%, s4=73%, s5=103%, s6=112%, s7=54%, s8=100%, s9=107%, s10=49%, s11=39%, s12=47%, s13=45%, s14=37%, s15=57%, s16=53%, s17=47%, s18=51%, s19=37%, s20=37%, s21=33%, s22=53%, s23=46%, s24=51%, s25=35%]  (sum=1528%)
artifacts[mma-count]: ff789b5ff064514f
==========================
