# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_cores=8
----

setting split_queue_enabled=false
----

# A workload is added over the entire keyspace, which is initially placed only
# on s1-s9.
gen_ranges ranges=500 min_key=0 max_key=20000 placement_type=replica_placement
{s1,s2,s3}:1
{s4,s5,s6}:1
{s7,s8,s9}:1
----
{s1:*,s2,s3}:1
{s4:*,s5,s6}:1
{s7:*,s8,s9}:1

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=700000 raft_cpu_per_write=200000 min_key=0 max_key=20000
----
10.50 access-vcpus, 0.15 raft-vcpus, 750 B/s goodput

eval duration=25m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
mma-only:
cpu#1: last:  [s1=463047636, s2=464742044, s3=465584574, s4=464309298, s5=465847383, s6=466444044, s7=463910580, s8=466175498, s9=464760769, s10=467967426, s11=468395602, s12=468693867, s13=468326290, s14=319992397, s15=468057733, s16=403289930, s17=467566175, s18=340531137, s19=467968120, s20=468090063, s21=361926413, s22=404937284, s23=469792185, s24=383090767, s25=319789535] (stddev=50329198.14, mean=437329470.00, sum=10933236750)
cpu#1: thrash_pct: [s1=13%, s2=39%, s3=29%, s4=12%, s5=41%, s6=29%, s7=13%, s8=29%, s9=38%, s10=8%, s11=7%, s12=7%, s13=10%, s14=6%, s15=8%, s16=7%, s17=12%, s18=6%, s19=7%, s20=8%, s21=6%, s22=7%, s23=9%, s24=6%, s25=6%]  (sum=362%)
cpu_util#1: last:  [s1=0.06, s2=0.06, s3=0.06, s4=0.06, s5=0.06, s6=0.06, s7=0.06, s8=0.06, s9=0.06, s10=0.06, s11=0.06, s12=0.06, s13=0.06, s14=0.04, s15=0.06, s16=0.05, s17=0.06, s18=0.04, s19=0.06, s20=0.06, s21=0.05, s22=0.05, s23=0.06, s24=0.05, s25=0.04] (stddev=0.01, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=13%, s2=39%, s3=29%, s4=12%, s5=41%, s6=29%, s7=13%, s8=29%, s9=38%, s10=8%, s11=7%, s12=7%, s13=10%, s14=6%, s15=8%, s16=7%, s17=12%, s18=6%, s19=7%, s20=8%, s21=6%, s22=7%, s23=9%, s24=6%, s25=6%]  (sum=362%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=21, s2=20, s3=20, s4=21, s5=20, s6=20, s7=21, s8=20, s9=20, s10=22, s11=22, s12=22, s13=22, s14=15, s15=22, s16=19, s17=22, s18=16, s19=22, s20=22, s21=17, s22=19, s23=22, s24=18, s25=15] (stddev=2.19, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=27%, s3=16%, s4=0%, s5=33%, s6=18%, s7=0%, s8=21%, s9=29%, s10=0%, s11=0%, s12=0%, s13=3%, s14=0%, s15=0%, s16=0%, s17=5%, s18=0%, s19=0%, s20=2%, s21=0%, s22=0%, s23=2%, s24=0%, s25=0%]  (sum=156%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=84, s2=153, s3=156, s4=86, s5=155, s6=157, s7=85, s8=155, s9=152, s10=22, s11=22, s12=22, s13=22, s14=15, s15=22, s16=19, s17=22, s18=16, s19=22, s20=22, s21=17, s22=19, s23=22, s24=18, s25=15] (stddev=57.14, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=11%, s3=5%, s4=0%, s5=13%, s6=8%, s7=0%, s8=9%, s9=10%, s10=0%, s11=0%, s12=0%, s13=3%, s14=0%, s15=0%, s16=0%, s17=4%, s18=0%, s19=0%, s20=2%, s21=0%, s22=0%, s23=2%, s24=0%, s25=0%]  (sum=67%)
write_bytes_per_second#1: last:  [s1=125, s2=229, s3=233, s4=128, s5=231, s6=235, s7=126, s8=232, s9=227, s10=32, s11=33, s12=33, s13=32, s14=22, s15=32, s16=28, s17=32, s18=23, s19=32, s20=32, s21=25, s22=28, s23=33, s24=26, s25=22] (stddev=85.61, mean=89.24, sum=2231)
write_bytes_per_second#1: thrash_pct: [s1=179%, s2=262%, s3=281%, s4=185%, s5=247%, s6=266%, s7=180%, s8=250%, s9=247%, s10=29%, s11=23%, s12=8%, s13=31%, s14=24%, s15=22%, s16=10%, s17=27%, s18=23%, s19=34%, s20=22%, s21=12%, s22=19%, s23=33%, s24=58%, s25=21%]  (sum=2492%)
hash: 99cd3e4d17a5a700
==========================
mma-count:
cpu#1: last:  [s1=479541893, s2=394894037, s3=416781158, s4=480633985, s5=438092267, s6=460008196, s7=479824510, s8=416638830, s9=395875015, s10=459678143, s11=438126370, s12=438136092, s13=460036899, s14=416625793, s15=438457211, s16=416755069, s17=459167573, s18=415927908, s19=416680045, s20=438471684, s21=438114345, s22=459125837, s23=417135214, s24=436636531, s25=438059370] (stddev=24044745.63, mean=437976959.00, sum=10949423975)
cpu#1: thrash_pct: [s1=7%, s2=8%, s3=8%, s4=8%, s5=9%, s6=7%, s7=8%, s8=7%, s9=7%, s10=20%, s11=8%, s12=8%, s13=9%, s14=7%, s15=8%, s16=11%, s17=7%, s18=8%, s19=9%, s20=8%, s21=13%, s22=10%, s23=11%, s24=8%, s25=8%]  (sum=222%)
cpu_util#1: last:  [s1=0.06, s2=0.05, s3=0.05, s4=0.06, s5=0.05, s6=0.06, s7=0.06, s8=0.05, s9=0.05, s10=0.06, s11=0.05, s12=0.05, s13=0.06, s14=0.05, s15=0.05, s16=0.05, s17=0.06, s18=0.05, s19=0.05, s20=0.05, s21=0.05, s22=0.06, s23=0.05, s24=0.05, s25=0.05] (stddev=0.00, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=7%, s2=8%, s3=8%, s4=8%, s5=9%, s6=7%, s7=8%, s8=7%, s9=7%, s10=20%, s11=8%, s12=8%, s13=9%, s14=7%, s15=8%, s16=11%, s17=7%, s18=8%, s19=9%, s20=8%, s21=13%, s22=10%, s23=11%, s24=8%, s25=8%]  (sum=222%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=22, s2=18, s3=19, s4=22, s5=20, s6=21, s7=22, s8=19, s9=18, s10=21, s11=20, s12=20, s13=21, s14=19, s15=20, s16=19, s17=21, s18=19, s19=19, s20=20, s21=20, s22=21, s23=19, s24=20, s25=20] (stddev=1.13, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=2%, s3=0%, s4=0%, s5=2%, s6=0%, s7=0%, s8=0%, s9=0%, s10=16%, s11=3%, s12=2%, s13=3%, s14=2%, s15=3%, s16=7%, s17=2%, s18=3%, s19=4%, s20=3%, s21=8%, s22=4%, s23=6%, s24=3%, s25=3%]  (sum=77%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=60, s2=60, s3=59, s4=62, s5=59, s6=62, s7=61, s8=60, s9=60, s10=61, s11=58, s12=59, s13=62, s14=60, s15=60, s16=60, s17=60, s18=59, s19=59, s20=60, s21=59, s22=61, s23=60, s24=59, s25=60] (stddev=1.02, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=2%, s4=0%, s5=2%, s6=0%, s7=0%, s8=0%, s9=0%, s10=11%, s11=0%, s12=0%, s13=0%, s14=4%, s15=0%, s16=0%, s17=0%, s18=0%, s19=2%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=4%]  (sum=24%)
write_bytes_per_second#1: last:  [s1=89, s2=89, s3=88, s4=92, s5=88, s6=92, s7=91, s8=89, s9=89, s10=91, s11=86, s12=88, s13=93, s14=90, s15=89, s16=90, s17=89, s18=88, s19=88, s20=90, s21=89, s22=91, s23=90, s24=88, s25=90] (stddev=1.55, mean=89.48, sum=2237)
write_bytes_per_second#1: thrash_pct: [s1=67%, s2=94%, s3=100%, s4=72%, s5=113%, s6=108%, s7=59%, s8=116%, s9=102%, s10=52%, s11=41%, s12=48%, s13=43%, s14=45%, s15=72%, s16=53%, s17=51%, s18=44%, s19=53%, s20=44%, s21=51%, s22=53%, s23=32%, s24=32%, s25=69%]  (sum=1616%)
hash: 66d1b46823398d5d
==========================
