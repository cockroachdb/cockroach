# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

# TODO(tbg): likely accidentally too low.
gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----
0.00 access-vcpus, 0.00 raft-vcpus, 73 KiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# only mainly on s1-s3 due to the skewed distribution.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=4206165723, s2=4195975266, s3=6306747320, s4=4197505701, s5=4191446223, s6=4199626893, s7=4196288384, s8=4190694847, s9=4205139322, s10=4211961351, s11=4204109607, s12=4207188644, s13=4201185082, s14=4201802124, s15=4187425758, s16=4198661366, s17=4191856498, s18=4202107821, s19=4210212288, s20=4203187025, s21=4210477184, s22=2100714714, s23=4197165059, s24=4211437747, s25=4200090984] (stddev=594858621.79, mean=4201166917.24, sum=105029172931)
cpu#1: thrash_pct: [s1=2%, s2=19%, s3=31%, s4=46%, s5=23%, s6=1%, s7=0%, s8=0%, s9=1%, s10=0%, s11=1%, s12=1%, s13=0%, s14=0%, s15=0%, s16=16%, s17=0%, s18=1%, s19=0%, s20=1%, s21=17%, s22=0%, s23=1%, s24=0%, s25=9%]  (sum=171%)
cpu_util#1: last:  [s1=0.53, s2=0.52, s3=0.79, s4=0.52, s5=0.52, s6=0.52, s7=0.52, s8=0.52, s9=0.53, s10=0.53, s11=0.53, s12=0.53, s13=0.53, s14=0.53, s15=0.52, s16=0.52, s17=0.52, s18=0.53, s19=0.53, s20=0.53, s21=0.53, s22=0.26, s23=0.52, s24=0.53, s25=0.53] (stddev=0.07, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=2%, s2=19%, s3=31%, s4=46%, s5=23%, s6=1%, s7=0%, s8=0%, s9=1%, s10=0%, s11=1%, s12=1%, s13=0%, s14=0%, s15=0%, s16=16%, s17=0%, s18=1%, s19=0%, s20=1%, s21=17%, s22=0%, s23=1%, s24=0%, s25=9%]  (sum=171%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=3, s2=4, s3=5, s4=4, s5=4, s6=4, s7=4, s8=3, s9=4, s10=4, s11=5, s12=3, s13=5, s14=4, s15=4, s16=4, s17=4, s18=4, s19=4, s20=4, s21=4, s22=3, s23=5, s24=5, s25=3] (stddev=0.63, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=10%, s3=15%, s4=30%, s5=23%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=15%, s17=0%, s18=0%, s19=0%, s20=0%, s21=16%, s22=0%, s23=0%, s24=0%, s25=8%]  (sum=118%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=54, s2=33, s3=19, s4=11, s5=10, s6=9, s7=10, s8=8, s9=9, s10=9, s11=8, s12=8, s13=9, s14=9, s15=9, s16=9, s17=8, s18=8, s19=9, s20=9, s21=8, s22=7, s23=9, s24=10, s25=8] (stddev=9.99, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=5%, s5=5%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=9%, s17=0%, s18=0%, s19=0%, s20=0%, s21=9%, s22=0%, s23=0%, s24=0%, s25=4%]  (sum=31%)
write_bytes_per_second#1: last:  [s1=9722, s2=9413, s3=9169, s4=9073, s5=9056, s6=9015, s7=9031, s8=9040, s9=9075, s10=9054, s11=8999, s12=8976, s13=9053, s14=9041, s15=9070, s16=9064, s17=9039, s18=9034, s19=9054, s20=9026, s21=9020, s22=9028, s23=9067, s24=9089, s25=9034] (stddev=151.56, mean=9089.68, sum=227242)
write_bytes_per_second#1: thrash_pct: [s1=122%, s2=108%, s3=101%, s4=95%, s5=111%, s6=94%, s7=84%, s8=86%, s9=84%, s10=93%, s11=78%, s12=62%, s13=106%, s14=84%, s15=89%, s16=89%, s17=90%, s18=71%, s19=93%, s20=71%, s21=93%, s22=100%, s23=80%, s24=91%, s25=60%]  (sum=2233%)
artifacts[mma-only]: e6dadd360e52e1ae
==========================
cpu#1: last:  [s1=4199241428, s2=4201715916, s3=4199888979, s4=4201549572, s5=4202870413, s6=4210203681, s7=4199932797, s8=4205109316, s9=4196134960, s10=4211672135, s11=4194889454, s12=4205483067, s13=4196093831, s14=4197936383, s15=4205533552, s16=4201757868, s17=4200579877, s18=4200395386, s19=4205277525, s20=4200892315, s21=4208397476, s22=4201668427, s23=4200829097, s24=4203729084, s25=4201571860] (stddev=4052762.60, mean=4202134175.96, sum=105053354399)
cpu#1: thrash_pct: [s1=1%, s2=1%, s3=27%, s4=10%, s5=36%, s6=1%, s7=1%, s8=10%, s9=1%, s10=1%, s11=10%, s12=18%, s13=10%, s14=10%, s15=1%, s16=10%, s17=10%, s18=10%, s19=0%, s20=1%, s21=1%, s22=9%, s23=1%, s24=19%, s25=28%]  (sum=226%)
cpu_util#1: last:  [s1=0.52, s2=0.53, s3=0.52, s4=0.53, s5=0.53, s6=0.53, s7=0.52, s8=0.53, s9=0.52, s10=0.53, s11=0.52, s12=0.53, s13=0.52, s14=0.52, s15=0.53, s16=0.53, s17=0.53, s18=0.53, s19=0.53, s20=0.53, s21=0.53, s22=0.53, s23=0.53, s24=0.53, s25=0.53] (stddev=0.00, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=1%, s2=1%, s3=27%, s4=10%, s5=36%, s6=1%, s7=1%, s8=10%, s9=1%, s10=1%, s11=10%, s12=18%, s13=10%, s14=10%, s15=1%, s16=10%, s17=10%, s18=10%, s19=0%, s20=1%, s21=1%, s22=9%, s23=1%, s24=19%, s25=28%]  (sum=226%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=2, s2=2, s3=2, s4=4, s5=4, s6=4, s7=4, s8=3, s9=4, s10=5, s11=6, s12=3, s13=5, s14=4, s15=4, s16=4, s17=4, s18=5, s19=4, s20=4, s21=4, s22=4, s23=5, s24=6, s25=4] (stddev=1.02, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=16%, s4=8%, s5=30%, s6=0%, s7=0%, s8=8%, s9=0%, s10=0%, s11=9%, s12=15%, s13=8%, s14=8%, s15=0%, s16=8%, s17=8%, s18=8%, s19=0%, s20=0%, s21=0%, s22=8%, s23=0%, s24=16%, s25=24%]  (sum=175%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=12, s2=13, s3=9, s4=11, s5=11, s6=13, s7=12, s8=13, s9=14, s10=13, s11=13, s12=11, s13=12, s14=12, s15=11, s16=12, s17=10, s18=12, s19=12, s20=13, s21=12, s22=12, s23=11, s24=14, s25=12] (stddev=1.13, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=4%, s6=0%, s7=0%, s8=5%, s9=0%, s10=0%, s11=5%, s12=5%, s13=0%, s14=0%, s15=0%, s16=0%, s17=5%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=24%)
write_bytes_per_second#1: last:  [s1=180, s2=194, s3=135, s4=3121, s5=7580, s6=10569, s7=9061, s8=10598, s9=15071, s10=16515, s11=12056, s12=9021, s13=9099, s14=9086, s15=10584, s16=10588, s17=12056, s18=10580, s19=12069, s20=12064, s21=12023, s22=9103, s23=9097, s24=10639, s25=6147] (stddev=4164.95, mean=9089.44, sum=227236)
write_bytes_per_second#1: thrash_pct: [s1=1%, s2=1%, s3=22%, s4=2%, s5=7%, s6=5%, s7=6%, s8=7%, s9=7%, s10=10%, s11=7%, s12=4%, s13=7%, s14=5%, s15=6%, s16=9%, s17=23%, s18=27%, s19=8%, s20=5%, s21=5%, s22=7%, s23=5%, s24=27%, s25=45%]  (sum=257%)
artifacts[mma-count]: 429b32ec51b0bbe0
==========================
