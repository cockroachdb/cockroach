# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# A workload is added over the entire keyspace, which is initially placed only
# on s1-s9.
gen_ranges ranges=500 min_key=0 max_key=20000 placement_type=replica_placement
{s1,s2,s3}:1
{s4,s5,s6}:1
{s7,s8,s9}:1
----
{s1:*,s2,s3}:1
{s4:*,s5,s6}:1
{s7:*,s8,s9}:1

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=700000 raft_cpu_per_write=200000 min_key=0 max_key=20000
----
10.50 access-vcpus, 0.15 raft-vcpus, 750 B/s goodput

eval duration=25m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=462960464, s2=465035848, s3=464972544, s4=463969880, s5=466155661, s6=466117559, s7=463888531, s8=466178155, s9=464505189, s10=467530709, s11=467610222, s12=468342297, s13=467915033, s14=383329076, s15=467856426, s16=425455042, s17=467269295, s18=384307381, s19=468124852, s20=468399541, s21=340780833, s22=362572843, s23=468798735, s24=319097608, s25=320239692] (stddev=50501544.37, mean=437256536.64, sum=10931413416)
cpu#1: thrash_pct: [s1=13%, s2=38%, s3=29%, s4=12%, s5=39%, s6=31%, s7=13%, s8=29%, s9=38%, s10=8%, s11=7%, s12=9%, s13=10%, s14=7%, s15=8%, s16=7%, s17=14%, s18=7%, s19=7%, s20=6%, s21=6%, s22=7%, s23=7%, s24=5%, s25=6%]  (sum=362%)
cpu_util#1: last:  [s1=0.06, s2=0.06, s3=0.06, s4=0.06, s5=0.06, s6=0.06, s7=0.06, s8=0.06, s9=0.06, s10=0.06, s11=0.06, s12=0.06, s13=0.06, s14=0.05, s15=0.06, s16=0.05, s17=0.06, s18=0.05, s19=0.06, s20=0.06, s21=0.04, s22=0.05, s23=0.06, s24=0.04, s25=0.04] (stddev=0.01, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=13%, s2=38%, s3=29%, s4=12%, s5=39%, s6=31%, s7=13%, s8=29%, s9=38%, s10=8%, s11=7%, s12=9%, s13=10%, s14=7%, s15=8%, s16=7%, s17=14%, s18=7%, s19=7%, s20=6%, s21=6%, s22=7%, s23=7%, s24=5%, s25=6%]  (sum=362%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=21, s2=20, s3=20, s4=21, s5=20, s6=20, s7=21, s8=20, s9=20, s10=22, s11=22, s12=22, s13=22, s14=18, s15=22, s16=20, s17=22, s18=18, s19=22, s20=22, s21=16, s22=17, s23=22, s24=15, s25=15] (stddev=2.21, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=26%, s3=16%, s4=0%, s5=32%, s6=17%, s7=0%, s8=21%, s9=25%, s10=0%, s11=0%, s12=2%, s13=3%, s14=0%, s15=0%, s16=0%, s17=7%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=148%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=83, s2=154, s3=156, s4=85, s5=156, s6=156, s7=85, s8=155, s9=152, s10=22, s11=22, s12=22, s13=22, s14=18, s15=22, s16=20, s17=23, s18=18, s19=22, s20=22, s21=16, s22=17, s23=22, s24=15, s25=15] (stddev=57.14, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=11%, s3=5%, s4=0%, s5=13%, s6=6%, s7=0%, s8=9%, s9=10%, s10=0%, s11=0%, s12=2%, s13=3%, s14=0%, s15=0%, s16=0%, s17=6%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=65%)
write_bytes_per_second#1: last:  [s1=124, s2=230, s3=233, s4=126, s5=233, s6=233, s7=126, s8=232, s9=227, s10=32, s11=32, s12=33, s13=32, s14=26, s15=32, s16=30, s17=34, s18=27, s19=32, s20=32, s21=24, s22=25, s23=33, s24=22, s25=22] (stddev=85.54, mean=89.28, sum=2232)
write_bytes_per_second#1: thrash_pct: [s1=178%, s2=247%, s3=273%, s4=168%, s5=250%, s6=253%, s7=169%, s8=284%, s9=248%, s10=24%, s11=27%, s12=22%, s13=31%, s14=31%, s15=20%, s16=30%, s17=27%, s18=25%, s19=31%, s20=26%, s21=34%, s22=29%, s23=20%, s24=16%, s25=23%]  (sum=2486%)
artifacts[mma-only]: be5bd956f25b28fe
==========================
cpu#1: last:  [s1=479911909, s2=373580982, s3=417004825, s4=481191026, s5=437968812, s6=418529844, s7=480521667, s8=416565076, s9=375203500, s10=416487421, s11=459073056, s12=417390139, s13=458452447, s14=438198669, s15=438626986, s16=436488614, s17=459362930, s18=437947945, s19=458740016, s20=438620980, s21=437601149, s22=458747503, s23=416674300, s24=436424336, s25=460194196] (stddev=27439196.31, mean=437980333.12, sum=10949508328)
cpu#1: thrash_pct: [s1=7%, s2=8%, s3=7%, s4=8%, s5=8%, s6=7%, s7=8%, s8=7%, s9=7%, s10=13%, s11=7%, s12=7%, s13=10%, s14=5%, s15=9%, s16=12%, s17=6%, s18=6%, s19=10%, s20=8%, s21=10%, s22=7%, s23=7%, s24=7%, s25=6%]  (sum=199%)
cpu_util#1: last:  [s1=0.06, s2=0.05, s3=0.05, s4=0.06, s5=0.05, s6=0.05, s7=0.06, s8=0.05, s9=0.05, s10=0.05, s11=0.06, s12=0.05, s13=0.06, s14=0.05, s15=0.05, s16=0.05, s17=0.06, s18=0.05, s19=0.06, s20=0.05, s21=0.05, s22=0.06, s23=0.05, s24=0.05, s25=0.06] (stddev=0.00, mean=0.05, sum=1)
cpu_util#1: thrash_pct: [s1=7%, s2=8%, s3=7%, s4=8%, s5=8%, s6=7%, s7=8%, s8=7%, s9=7%, s10=13%, s11=7%, s12=7%, s13=10%, s14=5%, s15=9%, s16=12%, s17=6%, s18=6%, s19=10%, s20=8%, s21=10%, s22=7%, s23=7%, s24=7%, s25=6%]  (sum=199%)
leases#1: first: [s1=167, s2=0, s3=0, s4=167, s5=0, s6=0, s7=166, s8=0, s9=0, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=54.16, mean=20.00, sum=500)
leases#1: last:  [s1=22, s2=17, s3=19, s4=22, s5=20, s6=19, s7=22, s8=19, s9=17, s10=19, s11=21, s12=19, s13=21, s14=20, s15=20, s16=20, s17=21, s18=20, s19=21, s20=20, s21=20, s22=21, s23=19, s24=20, s25=21] (stddev=1.30, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=2%, s3=0%, s4=0%, s5=2%, s6=0%, s7=0%, s8=0%, s9=0%, s10=8%, s11=2%, s12=2%, s13=4%, s14=0%, s15=4%, s16=7%, s17=0%, s18=0%, s19=5%, s20=3%, s21=6%, s22=2%, s23=2%, s24=2%, s25=0%]  (sum=50%)
replicas#1: first: [s1=167, s2=167, s3=167, s4=167, s5=167, s6=167, s7=166, s8=166, s9=166, s10=0, s11=0, s12=0, s13=0, s14=0, s15=0, s16=0, s17=0, s18=0, s19=0, s20=0, s21=0, s22=0, s23=0, s24=0, s25=0] (stddev=80.00, mean=60.00, sum=1500)
replicas#1: last:  [s1=61, s2=60, s3=61, s4=63, s5=58, s6=63, s7=63, s8=60, s9=61, s10=58, s11=58, s12=59, s13=58, s14=61, s15=60, s16=57, s17=62, s18=61, s19=59, s20=60, s21=58, s22=60, s23=59, s24=58, s25=62] (stddev=1.74, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=5%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=2%]  (sum=7%)
write_bytes_per_second#1: last:  [s1=91, s2=89, s3=91, s4=94, s5=87, s6=94, s7=94, s8=89, s9=91, s10=87, s11=86, s12=88, s13=87, s14=91, s15=89, s16=85, s17=92, s18=91, s19=88, s20=90, s21=87, s22=90, s23=88, s24=87, s25=92] (stddev=2.50, mean=89.52, sum=2238)
write_bytes_per_second#1: thrash_pct: [s1=74%, s2=98%, s3=89%, s4=68%, s5=111%, s6=106%, s7=63%, s8=104%, s9=110%, s10=45%, s11=38%, s12=48%, s13=34%, s14=33%, s15=81%, s16=44%, s17=47%, s18=43%, s19=32%, s20=68%, s21=37%, s22=67%, s23=40%, s24=70%, s25=55%]  (sum=1606%)
artifacts[mma-count]: 783f63043b18076a
==========================
