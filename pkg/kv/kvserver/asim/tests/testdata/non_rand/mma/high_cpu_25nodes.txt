# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# A workload is added over the entire keyspace, which is initially only mainly
# on s1-s3 due to the skewed distribution.
gen_ranges ranges=500 min_key=0 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=25m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=4615457454, s2=4605945362, s3=4200516480, s4=4201173158, s5=4197917500, s6=4607240957, s7=4616104121, s8=4195742398, s9=4616642521, s10=4208717847, s11=4200722922, s12=3357430916, s13=4203014456, s14=4197074793, s15=4206909862, s16=4200018430, s17=4617798139, s18=3792523550, s19=4200863461, s20=4203020767, s21=4201866800, s22=4191623858, s23=4192483958, s24=4208812611, s25=2947407648] (stddev=372550932.03, mean=4199481198.76, sum=104987029969)
cpu#1: thrash_pct: [s1=10%, s2=16%, s3=8%, s4=59%, s5=60%, s6=55%, s7=20%, s8=15%, s9=8%, s10=8%, s11=9%, s12=7%, s13=15%, s14=11%, s15=7%, s16=11%, s17=8%, s18=8%, s19=15%, s20=8%, s21=8%, s22=16%, s23=7%, s24=22%, s25=6%]  (sum=418%)
cpu_util#1: last:  [s1=0.58, s2=0.58, s3=0.53, s4=0.53, s5=0.52, s6=0.58, s7=0.58, s8=0.52, s9=0.58, s10=0.53, s11=0.53, s12=0.42, s13=0.53, s14=0.52, s15=0.53, s16=0.53, s17=0.58, s18=0.47, s19=0.53, s20=0.53, s21=0.53, s22=0.52, s23=0.52, s24=0.53, s25=0.37] (stddev=0.05, mean=0.52, sum=13)
cpu_util#1: thrash_pct: [s1=10%, s2=16%, s3=8%, s4=59%, s5=60%, s6=55%, s7=20%, s8=15%, s9=8%, s10=8%, s11=9%, s12=7%, s13=15%, s14=11%, s15=7%, s16=11%, s17=8%, s18=8%, s19=15%, s20=8%, s21=8%, s22=16%, s23=7%, s24=22%, s25=6%]  (sum=418%)
leases#1: first: [s1=254, s2=119, s3=35, s4=16, s5=9, s6=7, s7=6, s8=3, s9=2, s10=3, s11=3, s12=3, s13=4, s14=3, s15=3, s16=3, s17=4, s18=2, s19=3, s20=3, s21=3, s22=3, s23=3, s24=3, s25=3] (stddev=53.10, mean=20.00, sum=500)
leases#1: last:  [s1=199, s2=73, s3=10, s4=10, s5=10, s6=11, s7=11, s8=10, s9=11, s10=10, s11=10, s12=8, s13=10, s14=10, s15=10, s16=10, s17=11, s18=9, s19=10, s20=10, s21=10, s22=10, s23=10, s24=10, s25=7] (stddev=38.58, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=0%, s2=1%, s3=0%, s4=12%, s5=13%, s6=11%, s7=3%, s8=2%, s9=0%, s10=0%, s11=0%, s12=0%, s13=2%, s14=1%, s15=0%, s16=1%, s17=0%, s18=0%, s19=2%, s20=0%, s21=0%, s22=2%, s23=0%, s24=4%, s25=0%]  (sum=54%)
replicas#1: first: [s1=500, s2=386, s3=198, s4=104, s5=57, s6=33, s7=21, s8=15, s9=13, s10=11, s11=11, s12=10, s13=11, s14=11, s15=10, s16=11, s17=11, s18=11, s19=11, s20=11, s21=11, s22=11, s23=11, s24=10, s25=11] (stddev=121.01, mean=60.00, sum=1500)
replicas#1: last:  [s1=499, s2=375, s3=173, s4=83, s5=43, s6=20, s7=18, s8=16, s9=19, s10=16, s11=17, s12=13, s13=15, s14=17, s15=17, s16=16, s17=16, s18=17, s19=16, s20=17, s21=16, s22=17, s23=16, s24=15, s25=13] (stddev=117.25, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=1%, s6=1%, s7=0%, s8=1%, s9=0%, s10=0%, s11=0%, s12=0%, s13=1%, s14=1%, s15=0%, s16=0%, s17=0%, s18=0%, s19=1%, s20=0%, s21=0%, s22=1%, s23=0%, s24=2%, s25=0%]  (sum=8%)
write_bytes_per_second#1: last:  [s1=746, s2=375, s3=32, s4=44, s5=69, s6=59, s7=54, s8=47, s9=56, s10=48, s11=51, s12=38, s13=45, s14=51, s15=50, s16=47, s17=47, s18=51, s19=47, s20=50, s21=48, s22=50, s23=47, s24=44, s25=39] (stddev=148.66, mean=89.40, sum=2235)
write_bytes_per_second#1: thrash_pct: [s1=171%, s2=136%, s3=5%, s4=33%, s5=44%, s6=36%, s7=21%, s8=26%, s9=13%, s10=17%, s11=15%, s12=13%, s13=14%, s14=18%, s15=20%, s16=19%, s17=13%, s18=19%, s19=19%, s20=14%, s21=19%, s22=15%, s23=11%, s24=17%, s25=13%]  (sum=740%)
artifacts[mma-only]: ccde6454c677843c
==========================
cpu#1: last:  [s1=4199729326, s2=4200349491, s3=2932110649, s4=4203795382, s5=4619513550, s6=4614613606, s7=4197606651, s8=4198463790, s9=4199779367, s10=4203957390, s11=4199721268, s12=4200684282, s13=4210146037, s14=4194284113, s15=4202444596, s16=4204717260, s17=4208141257, s18=4197989834, s19=4203813709, s20=4198980871, s21=4617436747, s22=4207904136, s23=4200741766, s24=4199798724, s25=4194328308] (stddev=291895319.80, mean=4200442084.40, sum=105011052110)
cpu#1: thrash_pct: [s1=34%, s2=74%, s3=39%, s4=68%, s5=54%, s6=72%, s7=28%, s8=32%, s9=43%, s10=42%, s11=21%, s12=25%, s13=27%, s14=29%, s15=43%, s16=25%, s17=34%, s18=32%, s19=25%, s20=28%, s21=29%, s22=36%, s23=33%, s24=25%, s25=28%]  (sum=925%)
cpu_util#1: last:  [s1=0.52, s2=0.53, s3=0.37, s4=0.53, s5=0.58, s6=0.58, s7=0.52, s8=0.52, s9=0.52, s10=0.53, s11=0.52, s12=0.53, s13=0.53, s14=0.52, s15=0.53, s16=0.53, s17=0.53, s18=0.52, s19=0.53, s20=0.52, s21=0.58, s22=0.53, s23=0.53, s24=0.52, s25=0.52] (stddev=0.04, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=34%, s2=74%, s3=39%, s4=68%, s5=54%, s6=72%, s7=28%, s8=32%, s9=43%, s10=42%, s11=21%, s12=25%, s13=27%, s14=29%, s15=43%, s16=25%, s17=34%, s18=32%, s19=25%, s20=28%, s21=29%, s22=36%, s23=33%, s24=25%, s25=28%]  (sum=925%)
leases#1: first: [s1=254, s2=119, s3=35, s4=16, s5=9, s6=7, s7=6, s8=3, s9=2, s10=3, s11=3, s12=3, s13=4, s14=3, s15=3, s16=3, s17=4, s18=2, s19=3, s20=3, s21=3, s22=3, s23=3, s24=3, s25=3] (stddev=53.10, mean=20.00, sum=500)
leases#1: last:  [s1=25, s2=25, s3=26, s4=22, s5=17, s6=14, s7=19, s8=18, s9=21, s10=18, s11=20, s12=19, s13=20, s14=20, s15=17, s16=20, s17=23, s18=20, s19=20, s20=19, s21=20, s22=17, s23=20, s24=20, s25=20] (stddev=2.64, mean=20.00, sum=500)
leases#1: thrash_pct: [s1=7%, s2=19%, s3=23%, s4=21%, s5=12%, s6=15%, s7=7%, s8=7%, s9=15%, s10=9%, s11=5%, s12=5%, s13=10%, s14=10%, s15=9%, s16=9%, s17=11%, s18=9%, s19=6%, s20=5%, s21=7%, s22=7%, s23=6%, s24=5%, s25=7%]  (sum=246%)
replicas#1: first: [s1=500, s2=386, s3=198, s4=104, s5=57, s6=33, s7=21, s8=15, s9=13, s10=11, s11=11, s12=10, s13=11, s14=11, s15=10, s16=11, s17=11, s18=11, s19=11, s20=11, s21=11, s22=11, s23=11, s24=10, s25=11] (stddev=121.01, mean=60.00, sum=1500)
replicas#1: last:  [s1=61, s2=63, s3=58, s4=60, s5=59, s6=60, s7=60, s8=59, s9=60, s10=59, s11=60, s12=60, s13=60, s14=60, s15=60, s16=62, s17=60, s18=60, s19=60, s20=60, s21=60, s22=58, s23=60, s24=61, s25=60] (stddev=1.02, mean=60.00, sum=1500)
replicas#1: thrash_pct: [s1=4%, s2=7%, s3=5%, s4=5%, s5=2%, s6=1%, s7=4%, s8=6%, s9=8%, s10=2%, s11=3%, s12=1%, s13=2%, s14=8%, s15=1%, s16=3%, s17=7%, s18=3%, s19=3%, s20=1%, s21=2%, s22=3%, s23=4%, s24=2%, s25=2%]  (sum=87%)
write_bytes_per_second#1: last:  [s1=36, s2=47, s3=23, s4=48, s5=102, s6=134, s7=99, s8=105, s9=92, s10=105, s11=84, s12=104, s13=96, s14=86, s15=111, s16=86, s17=77, s18=87, s19=93, s20=110, s21=104, s22=105, s23=104, s24=92, s25=108] (stddev=25.22, mean=89.52, sum=2238)
write_bytes_per_second#1: thrash_pct: [s1=64%, s2=100%, s3=42%, s4=58%, s5=84%, s6=94%, s7=53%, s8=52%, s9=67%, s10=61%, s11=43%, s12=57%, s13=51%, s14=46%, s15=54%, s16=54%, s17=63%, s18=52%, s19=58%, s20=45%, s21=53%, s22=47%, s23=47%, s24=49%, s25=53%]  (sum=1444%)
artifacts[mma-count]: a95febe8e93c38a5
==========================
