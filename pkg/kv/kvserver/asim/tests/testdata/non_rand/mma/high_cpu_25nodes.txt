# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

# TODO(tbg): likely accidentally too low.
gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----
0.00 access-vcpus, 0.00 raft-vcpus, 73 KiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# only mainly on s1-s3 due to the skewed distribution.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=6305516202, s2=4203121714, s3=4209044827, s4=6316721595, s5=4197368968, s6=2107290360, s7=2099077812, s8=4207644575, s9=4199517611, s10=4195522966, s11=4205024256, s12=4198000753, s13=4202637211, s14=4186734543, s15=4199295119, s16=4199174047, s17=4204480499, s18=6290045651, s19=4193666150, s20=4211828495, s21=4201735135, s22=2096004946, s23=4201402387, s24=4193586357, s25=4193056496] (stddev=1029616922.87, mean=4200699947.00, sum=105017498675)
cpu#1: thrash_pct: [s1=6%, s2=47%, s3=81%, s4=21%, s5=11%, s6=2%, s7=1%, s8=3%, s9=2%, s10=3%, s11=2%, s12=3%, s13=3%, s14=2%, s15=11%, s16=2%, s17=3%, s18=3%, s19=3%, s20=2%, s21=3%, s22=2%, s23=3%, s24=2%, s25=2%]  (sum=222%)
cpu_util#1: last:  [s1=0.79, s2=0.53, s3=0.53, s4=0.79, s5=0.52, s6=0.26, s7=0.26, s8=0.53, s9=0.52, s10=0.52, s11=0.53, s12=0.52, s13=0.53, s14=0.52, s15=0.52, s16=0.52, s17=0.53, s18=0.79, s19=0.52, s20=0.53, s21=0.53, s22=0.26, s23=0.53, s24=0.52, s25=0.52] (stddev=0.13, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=6%, s2=47%, s3=81%, s4=21%, s5=11%, s6=2%, s7=1%, s8=3%, s9=2%, s10=3%, s11=2%, s12=3%, s13=3%, s14=2%, s15=11%, s16=2%, s17=3%, s18=3%, s19=3%, s20=2%, s21=3%, s22=2%, s23=3%, s24=2%, s25=2%]  (sum=222%)
leases#1: first: [s1=29, s2=13, s3=4, s4=2, s5=2, s6=2, s7=3, s8=3, s9=2, s10=3, s11=4, s12=1, s13=2, s14=2, s15=4, s16=3, s17=3, s18=3, s19=2, s20=3, s21=3, s22=2, s23=2, s24=1, s25=2] (stddev=5.56, mean=4.00, sum=100)
leases#1: last:  [s1=5, s2=4, s3=4, s4=4, s5=4, s6=3, s7=4, s8=4, s9=4, s10=4, s11=5, s12=3, s13=3, s14=4, s15=5, s16=4, s17=4, s18=6, s19=4, s20=4, s21=4, s22=3, s23=4, s24=3, s25=4] (stddev=0.69, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=40%, s3=71%, s4=15%, s5=8%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=8%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=142%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=11, s6=9, s7=8, s8=8, s9=7, s10=8, s11=7, s12=7, s13=7, s14=7, s15=7, s16=7, s17=7, s18=7, s19=7, s20=8, s21=8, s22=7, s23=8, s24=7, s25=7] (stddev=11.96, mean=12.00, sum=300)
replicas#1: last:  [s1=55, s2=32, s3=15, s4=14, s5=11, s6=9, s7=9, s8=9, s9=9, s10=9, s11=8, s12=9, s13=8, s14=9, s15=8, s16=8, s17=8, s18=10, s19=9, s20=9, s21=8, s22=7, s23=9, s24=9, s25=9] (stddev=9.99, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=4%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=4%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=8%)
write_bytes_per_second#1: last:  [s1=9716, s2=9343, s3=9125, s4=9067, s5=9042, s6=9053, s7=9020, s8=9052, s9=9057, s10=9082, s11=9000, s12=9014, s13=9018, s14=9057, s15=9071, s16=9067, s17=9060, s18=9063, s19=9030, s20=9049, s21=9047, s22=9031, s23=9068, s24=9035, s25=9069] (stddev=142.27, mean=9089.44, sum=227236)
write_bytes_per_second#1: thrash_pct: [s1=418%, s2=368%, s3=390%, s4=341%, s5=347%, s6=355%, s7=338%, s8=308%, s9=363%, s10=340%, s11=320%, s12=337%, s13=341%, s14=367%, s15=331%, s16=367%, s17=307%, s18=352%, s19=355%, s20=370%, s21=356%, s22=331%, s23=352%, s24=367%, s25=362%]  (sum=8782%)
artifacts[mma-only]: c30c22902539d7de
==========================
cpu#1: last:  [s1=4195620275, s2=4196803898, s3=4201453881, s4=4207023762, s5=4205406711, s6=4208677351, s7=4214607012, s8=4200332000, s9=4197470437, s10=4195295352, s11=4213016495, s12=4204698413, s13=4207405981, s14=4200445833, s15=4195950476, s16=4206976540, s17=4201083041, s18=4195551669, s19=4194449158, s20=4199778225, s21=4200014668, s22=4201038712, s23=4199242495, s24=4197916137, s25=4199865623] (stddev=5412725.77, mean=4201604965.80, sum=105040124145)
cpu#1: thrash_pct: [s1=4%, s2=4%, s3=18%, s4=3%, s5=2%, s6=10%, s7=2%, s8=11%, s9=11%, s10=10%, s11=2%, s12=3%, s13=10%, s14=3%, s15=3%, s16=11%, s17=11%, s18=11%, s19=11%, s20=11%, s21=2%, s22=11%, s23=2%, s24=2%, s25=3%]  (sum=172%)
cpu_util#1: last:  [s1=0.52, s2=0.52, s3=0.53, s4=0.53, s5=0.53, s6=0.53, s7=0.53, s8=0.53, s9=0.52, s10=0.52, s11=0.53, s12=0.53, s13=0.53, s14=0.53, s15=0.52, s16=0.53, s17=0.53, s18=0.52, s19=0.52, s20=0.52, s21=0.53, s22=0.53, s23=0.52, s24=0.52, s25=0.52] (stddev=0.00, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=4%, s2=4%, s3=18%, s4=3%, s5=2%, s6=10%, s7=2%, s8=11%, s9=11%, s10=10%, s11=2%, s12=3%, s13=10%, s14=3%, s15=3%, s16=11%, s17=11%, s18=11%, s19=11%, s20=11%, s21=2%, s22=11%, s23=2%, s24=2%, s25=3%]  (sum=172%)
leases#1: first: [s1=29, s2=13, s3=4, s4=2, s5=2, s6=2, s7=3, s8=3, s9=2, s10=3, s11=4, s12=1, s13=2, s14=2, s15=4, s16=3, s17=3, s18=3, s19=2, s20=3, s21=3, s22=2, s23=2, s24=1, s25=2] (stddev=5.56, mean=4.00, sum=100)
leases#1: last:  [s1=3, s2=3, s3=2, s4=3, s5=4, s6=4, s7=5, s8=4, s9=4, s10=4, s11=5, s12=5, s13=3, s14=5, s15=5, s16=4, s17=4, s18=6, s19=4, s20=4, s21=4, s22=4, s23=4, s24=3, s25=4] (stddev=0.85, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=9%, s3=15%, s4=0%, s5=0%, s6=8%, s7=0%, s8=7%, s9=8%, s10=7%, s11=0%, s12=0%, s13=7%, s14=0%, s15=0%, s16=7%, s17=14%, s18=8%, s19=8%, s20=7%, s21=0%, s22=8%, s23=0%, s24=0%, s25=0%]  (sum=114%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=11, s6=9, s7=8, s8=8, s9=7, s10=8, s11=7, s12=7, s13=7, s14=7, s15=7, s16=7, s17=7, s18=7, s19=7, s20=8, s21=8, s22=7, s23=8, s24=7, s25=7] (stddev=11.96, mean=12.00, sum=300)
replicas#1: last:  [s1=14, s2=12, s3=11, s4=12, s5=12, s6=12, s7=12, s8=12, s9=12, s10=12, s11=12, s12=13, s13=12, s14=12, s15=12, s16=12, s17=11, s18=11, s19=12, s20=12, s21=12, s22=11, s23=11, s24=12, s25=14] (stddev=0.75, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=16%, s3=6%, s4=5%, s5=0%, s6=0%, s7=5%, s8=0%, s9=5%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=5%, s17=9%, s18=5%, s19=5%, s20=0%, s21=0%, s22=0%, s23=0%, s24=0%, s25=0%]  (sum=60%)
write_bytes_per_second#1: last:  [s1=1687, s2=4653, s3=1641, s4=1668, s5=9057, s6=9096, s7=10547, s8=10574, s9=10578, s10=10615, s11=10528, s12=13516, s13=10549, s14=13531, s15=12095, s16=12095, s17=7615, s18=12030, s19=9073, s20=9093, s21=9109, s22=10572, s23=9099, s24=9085, s25=9144] (stddev=3277.31, mean=9090.00, sum=227250)
write_bytes_per_second#1: thrash_pct: [s1=23%, s2=95%, s3=22%, s4=19%, s5=39%, s6=66%, s7=66%, s8=43%, s9=73%, s10=43%, s11=40%, s12=59%, s13=125%, s14=53%, s15=43%, s16=50%, s17=90%, s18=47%, s19=67%, s20=42%, s21=62%, s22=42%, s23=42%, s24=97%, s25=42%]  (sum=1391%)
artifacts[mma-count]: e82e4e9c52d587b
==========================
