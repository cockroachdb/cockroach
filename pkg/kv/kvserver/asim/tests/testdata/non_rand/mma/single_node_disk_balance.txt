# This test verifies that the MMA can balance disk utilization between stores
# on a single node. The test sets up one node with two stores, each with 50GiB
# capacity. Store s1 starts with 100 ranges of 400MiB each (40GiB total, 80%
# full), while store s2 starts with 100 ranges of 200MiB each (20GiB total, 40%
# full). There is no workload.
#
# The MMA only considers disk utilization a concern when a store exceeds 50%
# capacity, so s1 starting at 80% should trigger rebalancing. The total cluster
# utilization is 60% (60GiB / 100GiB), ensuring the balanced state (60% each)
# remains above the 50% threshold where disk balancing stays active.
#
# Expected outcome: The MMA should rebalance replicas between the two stores
# to equalize disk utilization at ~60% each.
gen_cluster nodes=1 stores_per_node=2 store_byte_capacity_gib=50
----

# 100 ranges of 400MiB on store 1 (40GiB total, 80% of 50GiB capacity)
gen_ranges ranges=100 bytes_mib=400 repl_factor=1 placement_type=replica_placement min_key=1 max_key=10000
{s1:*}:100
----
{s1:*}:100

# 100 ranges of 200MiB on store 2 (20GiB total, 40% of 50GiB capacity)
gen_ranges ranges=100 bytes_mib=200 repl_factor=1 placement_type=replica_placement min_key=10001 max_key=20000
{s2:*}:100
----
{s2:*}:100

# Assert that disk utilization balances within 10% of mean.
assertion stat=disk_fraction_used type=balance ticks=6 upper_bound=1.1
----
asserting: max_{stores}(disk_fraction_used)/mean_{stores}(disk_fraction_used) â‰¤ 1.10 at each of last 6 ticks

eval duration=30m seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,replicas)
----
disk_fraction_used#1: first: [s1=0.98, s2=0.49] (stddev=0.24, mean=0.73, sum=1)
disk_fraction_used#1: last:  [s1=0.80, s2=0.66] (stddev=0.07, mean=0.73, sum=1)
disk_fraction_used#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=82, s2=118] (stddev=18.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
artifacts[mma-only]: 5a5007acc8e4ec1d
==========================
disk_fraction_used#1: first: [s1=0.98, s2=0.49] (stddev=0.24, mean=0.73, sum=1)
disk_fraction_used#1: last:  [s1=0.80, s2=0.66] (stddev=0.07, mean=0.73, sum=1)
disk_fraction_used#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
replicas#1: first: [s1=100, s2=100] (stddev=0.00, mean=100.00, sum=200)
replicas#1: last:  [s1=82, s2=118] (stddev=18.00, mean=100.00, sum=200)
replicas#1: thrash_pct: [s1=0%, s2=0%]  (sum=0%)
artifacts[mma-count]: 5a5007acc8e4ec1d
==========================
