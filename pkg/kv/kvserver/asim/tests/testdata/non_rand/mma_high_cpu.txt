skip_under_ci
----

gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
last store values: [s1=101168, s2=104447, s3=108028, s4=112981, s5=112365, s6=102223, s7=92074, s8=112254, s9=102089, s10=82000] (stddev=9303.16, mean=102962.90, sum=1029629)
mma_high_cpu_1_cpu.png (b3db100012824084)

plot stat=write_bytes_per_second
----
last store values: [s1=7777, s2=7627, s3=7552, s4=7601, s5=7483, s6=7494, s7=7559, s8=7564, s9=7579, s10=7562] (stddev=77.50, mean=7579.80, sum=75798)
mma_high_cpu_1_write_bytes_per_second.png (7e801facbb1632ad)

plot stat=replicas sample=1 
----
initial store values: [s1=80, s2=70, s3=51, s4=42, s5=37, s6=35, s7=34, s8=33, s9=34, s10=34] (stddev=16.02, mean=45.00, sum=450)
last store values: [s1=80, s2=61, s3=46, s4=45, s5=38, s6=36, s7=36, s8=37, s9=36, s10=35] (stddev=13.92, mean=45.00, sum=450)
mma_high_cpu_1_replicas.png (a000164df8ea5bf0)

plot stat=leases sample=1 
----
initial store values: [s1=37, s2=22, s3=14, s4=13, s5=11, s6=11, s7=10, s8=11, s9=10, s10=11] (stddev=8.07, mean=15.00, sum=150)
last store values: [s1=13, s2=11, s3=17, s4=14, s5=18, s6=17, s7=15, s8=16, s9=15, s10=14] (stddev=2.00, mean=15.00, sum=150)
mma_high_cpu_1_leases.png (2ba8ec74e37e809c)
