skip_under_ci
----

gen_cluster nodes=10 node_cpu_rate_capacity=800000
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

gen_load rate=5000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----

# Another workload is added over the second half of the keyspace, which is initially
# only on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=5000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=10001 max_key=20000
----

eval duration=15m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
last store values: [s1=111121, s2=104238, s3=107664, s4=107763, s5=97523, s6=102244, s7=102408, s8=112555, s9=107544, s10=76493] (stddev=9784.63, mean=102955.30, sum=1029553)
mma_high_cpu_1_cpu.png (fd85b0fe8d4cc0f8)

plot stat=write_bytes_per_second
----
last store values: [s1=7761, s2=7618, s3=7543, s4=7582, s5=7493, s6=7510, s7=7561, s8=7566, s9=7574, s10=7516] (stddev=72.22, mean=7572.40, sum=75724)
mma_high_cpu_1_write_bytes_per_second.png (d762620d0971dfc1)

plot stat=replicas sample=1 
----
initial store values: [s1=80, s2=68, s3=50, s4=41, s5=38, s6=35, s7=36, s8=36, s9=36, s10=30] (stddev=15.53, mean=45.00, sum=450)
last store values: [s1=80, s2=59, s3=44, s4=43, s5=40, s6=36, s7=38, s8=39, s9=40, s10=31] (stddev=13.56, mean=45.00, sum=450)
mma_high_cpu_1_replicas.png (1a11890c9f350f09)

plot stat=leases sample=1 
----
initial store values: [s1=36, s2=22, s3=14, s4=13, s5=10, s6=11, s7=12, s8=12, s9=10, s10=10] (stddev=7.77, mean=15.00, sum=150)
last store values: [s1=15, s2=11, s3=15, s4=16, s5=17, s6=17, s7=15, s8=16, s9=14, s10=14] (stddev=1.67, mean=15.00, sum=150)
mma_high_cpu_1_leases.png (5eb326f2a977a0a9)
