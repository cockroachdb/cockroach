# This test reproduces #106559, where a (satisfiable) voter constraint will
# never be satisfied if every existing replica is necessary to satisfy either a
# voter or non-voter constraint. See the topology below.
gen_cluster nodes=3
----

# Setup the localities of nodes in the cluster, note the first 3 nodes are
# effectively ignored.
# TODO(kvoli): Add variadic add_node command for this case.
add_node locality=region=us-east-1
----

add_node locality=region=us-east-1
----

add_node locality=region=us-west-1
----

add_node locality=region=us-west-1
----

add_node locality=region=us-central-1
----

add_node locality=region=us-central-1
----

add_node locality=region=us-central-1
----

add_node locality=region=eu-west-1
----

add_node locality=region=eu-west-1
----

add_node locality=region=eu-west-1
----

# Generate 10 ranges, these will be be placed uniformly over the cluster,
# ignoring constraints initially.
gen_ranges ranges=10
----

# Update the span config to be exactly the replica placement seen in #106559,
set_span_config 
[0,10000): num_replicas=6 num_voters=5 constraints={'+region=eu-west-1':1,'+region=us-central-1':1,'+region=us-east-1':2,'+region=us-west-1':2} voter_constraints={'+region=eu-west-1':1,'+region=us-central-1':1,'+region=us-east-1':2,'+region=us-west-1':1}
----

# 15 minutes after starting, switch the span config to the config applied in
# #106559.
set_span_config delay=15m
[0,10000): num_replicas=6 num_voters=5 constraints={'+region=eu-west-1':1,'+region=us-central-1':1,'+region=us-east-1':1,'+region=us-west-1':1} voter_constraints={'+region=us-west-1':2,'+region=us-east-1':2}
----

assertion type=conformance under=0 over=0 unavailable=0 violating=0
----

eval duration=30m
----
OK

topology
----
AU_EAST
  AU_EAST_1
  │ └── [1 2 3]
eu-west-1
  └── [11 12 13]
us-central-1
  └── [8 9 10]
us-east-1
  └── [4 5]
us-west-1
  └── [6 7]

# vim:ft=sh
