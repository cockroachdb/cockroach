gen_cluster nodes=7 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 256 MiB.
gen_ranges ranges=21 placement_type=skewed bytes=268435456
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

# node_cpu_rate_capacity
# utilization: set request_cpu_per_access high to avoid utilization rebalancing

gen_load rate=1000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=10
----

# TODO(kvoli): Reduce this back to 30m once replica thrashing in later half is
# resolved.
eval duration=25m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
last store values: [s1=14752, s2=14661, s3=14420, s4=14406, s5=14355, s6=14440, s7=14420] (stddev=139.07, mean=14493.43, sum=101454)
mma_high_cpu_skewed_placement_1_cpu.png (7a0a24d5aabb9360)

plot stat=write_bytes_per_second
----
last store values: [s1=4761, s2=3331, s3=1887, s4=1432, s5=1444, s6=951, s7=1179] (stddev=1291.46, mean=2140.71, sum=14985)
mma_high_cpu_skewed_placement_1_write_bytes_per_second.png (a5f861263709501e)

plot stat=replicas sample=1
----
initial store values: [s1=21, s2=17, s3=10, s4=6, s5=4, s6=3, s7=2] (stddev=6.85, mean=9.00, sum=63)
last store values: [s1=20, s2=14, s3=8, s4=6, s5=6, s6=4, s7=5] (stddev=5.42, mean=9.00, sum=63)
mma_high_cpu_skewed_placement_1_replicas.png (566ee5c60ea021a4)

plot stat=leases sample=1
----
initial store values: [s1=11, s2=5, s3=2, s4=2, s5=0, s6=1, s7=0] (stddev=3.63, mean=3.00, sum=21)
last store values: [s1=3, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3] (stddev=0.00, mean=3.00, sum=21)
mma_high_cpu_skewed_placement_1_leases.png (8cf2cdb808fd55cf)
