skip_under_ci
----

gen_cluster nodes=7 node_cpu_rate_capacity=5000000000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 256 MiB.
gen_ranges ranges=21 placement_type=skewed bytes=268435456
----

# Set the rebalance mode to use the mma store rebalancer and disable the lease
# and replicate queues so that only the mma store rebalancer is moving replicas
# or leases.
setting split_queue_enabled=false
----

# node_cpu_rate_capacity
# utilization: set request_cpu_per_access high to avoid utilization rebalancing

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=100000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----

# TODO(kvoli): Reduce this back to 30m once replica thrashing in later half is
# resolved.
eval duration=25m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=15000000, s2=0, s3=15000000, s4=0, s5=0, s6=1515000000, s7=0] (stddev=528430483.14, mean=220714285.71, sum=1545000000)
cpu#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%]  (sum=0%)
cpu_util#1: last:  [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.30, s7=0.00] (stddev=0.11, mean=0.04, sum=0)
cpu_util#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%]  (sum=0%)
leases#1: first: [s1=11, s2=5, s3=2, s4=2, s5=0, s6=1, s7=0] (stddev=3.63, mean=3.00, sum=21)
leases#1: last:  [s1=11, s2=5, s3=2, s4=2, s5=0, s6=1, s7=0] (stddev=3.63, mean=3.00, sum=21)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%]  (sum=0%)
replicas#1: first: [s1=21, s2=17, s3=10, s4=6, s5=4, s6=3, s7=2] (stddev=6.85, mean=9.00, sum=63)
replicas#1: last:  [s1=21, s2=17, s3=10, s4=6, s5=4, s6=3, s7=2] (stddev=6.85, mean=9.00, sum=63)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=750, s2=0, s3=750, s4=0, s5=0, s6=750, s7=0] (stddev=371.15, mean=321.43, sum=2250)
write_bytes_per_second#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%]  (sum=0%)
artifacts[mma-only]: 3f1eb6bea9da4126
==========================
cpu#1: last:  [s1=0, s2=0, s3=15000000, s4=0, s5=15000000, s6=1515000000, s7=0] (stddev=528430483.14, mean=220714285.71, sum=1545000000)
cpu#1: thrash_pct: [s1=58%, s2=46%, s3=57%, s4=50%, s5=63%, s6=0%, s7=52%]  (sum=326%)
cpu_util#1: last:  [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.30, s7=0.00] (stddev=0.11, mean=0.04, sum=0)
cpu_util#1: thrash_pct: [s1=58%, s2=46%, s3=57%, s4=50%, s5=63%, s6=0%, s7=52%]  (sum=326%)
leases#1: first: [s1=11, s2=5, s3=2, s4=2, s5=0, s6=1, s7=0] (stddev=3.63, mean=3.00, sum=21)
leases#1: last:  [s1=5, s2=1, s3=8, s4=1, s5=4, s6=1, s7=1] (stddev=2.56, mean=3.00, sum=21)
leases#1: thrash_pct: [s1=628%, s2=552%, s3=792%, s4=602%, s5=787%, s6=0%, s7=673%]  (sum=4035%)
replicas#1: first: [s1=21, s2=17, s3=10, s4=6, s5=4, s6=3, s7=2] (stddev=6.85, mean=9.00, sum=63)
replicas#1: last:  [s1=10, s2=6, s3=12, s4=9, s5=13, s6=3, s7=10] (stddev=3.21, mean=9.00, sum=63)
replicas#1: thrash_pct: [s1=1738%, s2=1664%, s3=1876%, s4=1751%, s5=2094%, s6=0%, s7=1714%]  (sum=10835%)
write_bytes_per_second#1: last:  [s1=0, s2=0, s3=750, s4=0, s5=750, s6=750, s7=0] (stddev=371.15, mean=321.43, sum=2250)
write_bytes_per_second#1: thrash_pct: [s1=5820%, s2=4620%, s3=5800%, s4=5020%, s5=6400%, s6=0%, s7=5220%]  (sum=32879%)
artifacts[mma-count]: 6abde4345c1cc9ce
==========================
