skip_under_ci
----

gen_cluster nodes=6 node_cpu_rate_capacity=16000000000 stores_per_node=2 region=(a,b) nodes_per_region=(3,3)
----

set_span_config
[0,5000): constraints={'+region=a':3}
[5000,9999999999): constraints={'+region=b':3}
----

# Writes will hit region a, reads will hit region b.
# Leases are initially pre-randomized (within each region).

gen_ranges ranges=100 min_key=min max_key=5000 placement_type=replica_placement bytes=268435456
{s1:*,s3,s5}:1
{s1,s3:*,s5}:1
{s1,s3,s5:*}:1
----
{s1:*,s3,s5}:1
{s1,s3:*,s5}:1
{s1,s3,s5:*}:1

gen_ranges ranges=100 min_key=5000 max_key=max placement_type=replica_placement bytes=268435456
{s7:*,s9,s11}:1
{s7,s9:*,s11}:1
{s7,s9,s11:*}:1
----
{s7:*,s9,s11}:1
{s7,s9:*,s11}:1
{s7,s9,s11:*}:1

# write-only on region a
gen_load rate=1000 rw_ratio=0.0 min_block=1024 max_block=1024 min_key=1 max_key=5000
----

# read-only on region b
gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=5000 max_key=max
----

assertion type=balance stat=leases upper_bound=1.32
----

assertion type=balance stat=replicas upper_bound=1.05
----

eval duration=60m cfgs=(sma-only,mma-only,both) metrics=(replicas,leases,cpu,write_bytes_per_second)
----
cpu#1: last:  [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=900112419, s8=798637394, s9=802686666, s10=901494842, s11=698413333, s12=899713801] (stddev=420126322.55, mean=416754871.25, sum=5001058455)
leases#1: first: [s1=34, s2=0, s3=33, s4=0, s5=33, s6=0, s7=34, s8=0, s9=33, s10=0, s11=33, s12=0] (stddev=16.67, mean=16.67, sum=200)
leases#1: last:  [s1=18, s2=16, s3=17, s4=17, s5=16, s6=16, s7=18, s8=16, s9=16, s10=18, s11=14, s12=18] (stddev=1.18, mean=16.67, sum=200)
replicas#1: first: [s1=100, s2=0, s3=100, s4=0, s5=100, s6=0, s7=100, s8=0, s9=100, s10=0, s11=100, s12=0] (stddev=50.00, mean=50.00, sum=600)
replicas#1: last:  [s1=49, s2=51, s3=49, s4=51, s5=48, s6=52, s7=50, s8=50, s9=50, s10=50, s11=50, s12=50] (stddev=1.00, mean=50.00, sum=600)
write_bytes_per_second#1: last:  [s1=501925, s2=522415, s3=501753, s4=522587, s5=492134, s6=532206, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0] (stddev=256285.02, mean=256085.00, sum=3073020)
artifacts[sma-only]: ba48d00e3673279a
cpu#1: last:  [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=948091627, s8=750168310, s9=900196666, s10=750176688, s11=900207821, s12=752348533] (stddev=420993561.04, mean=416765803.75, sum=5001189645)
leases#1: first: [s1=34, s2=0, s3=33, s4=0, s5=33, s6=0, s7=34, s8=0, s9=33, s10=0, s11=33, s12=0] (stddev=16.67, mean=16.67, sum=200)
leases#1: last:  [s1=16, s2=18, s3=12, s4=21, s5=9, s6=24, s7=19, s8=15, s9=18, s10=15, s11=18, s12=15] (stddev=3.79, mean=16.67, sum=200)
replicas#1: first: [s1=100, s2=0, s3=100, s4=0, s5=100, s6=0, s7=100, s8=0, s9=100, s10=0, s11=100, s12=0] (stddev=50.00, mean=50.00, sum=600)
replicas#1: last:  [s1=50, s2=50, s3=51, s4=49, s5=51, s6=49, s7=85, s8=15, s9=85, s10=15, s11=85, s12=15] (stddev=24.76, mean=50.00, sum=600)
write_bytes_per_second#1: last:  [s1=512279, s2=512140, s3=522707, s4=501711, s5=522632, s6=501786, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0] (stddev=256175.79, mean=256104.58, sum=3073255)
artifacts[mma-only]: 71215e5d7d5db949
failed assertion sample 1
  balance stat=leases threshold=(<1.32) ticks=5
	max/mean=24.00/16.67 1.44 tick=0
	max/mean=24.00/16.67 1.44 tick=1
	max/mean=24.00/16.67 1.44 tick=2
	max/mean=24.00/16.67 1.44 tick=3
	max/mean=24.00/16.67 1.44 tick=4
  balance stat=replicas threshold=(<1.05) ticks=5
	max/mean=85.00/50.00 1.70 tick=0
	max/mean=85.00/50.00 1.70 tick=1
	max/mean=85.00/50.00 1.70 tick=2
	max/mean=85.00/50.00 1.70 tick=3
	max/mean=85.00/50.00 1.70 tick=4
cpu#1: last:  [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=851810000, s8=902101294, s9=799126666, s10=848956207, s11=798549999, s12=800981721] (stddev=417666714.11, mean=416793823.92, sum=5001525887)
leases#1: first: [s1=34, s2=0, s3=33, s4=0, s5=33, s6=0, s7=34, s8=0, s9=33, s10=0, s11=33, s12=0] (stddev=16.67, mean=16.67, sum=200)
leases#1: last:  [s1=14, s2=20, s3=12, s4=21, s5=19, s6=14, s7=17, s8=18, s9=16, s10=17, s11=16, s12=16] (stddev=2.49, mean=16.67, sum=200)
replicas#1: first: [s1=100, s2=0, s3=100, s4=0, s5=100, s6=0, s7=100, s8=0, s9=100, s10=0, s11=100, s12=0] (stddev=50.00, mean=50.00, sum=600)
replicas#1: last:  [s1=49, s2=51, s3=49, s4=51, s5=49, s6=51, s7=48, s8=52, s9=49, s10=51, s11=51, s12=49] (stddev=1.22, mean=50.00, sum=600)
write_bytes_per_second#1: last:  [s1=501192, s2=523142, s3=501541, s4=522794, s5=501194, s6=523141, s7=0, s8=0, s9=0, s10=0, s11=0, s12=0] (stddev=256198.77, mean=256083.67, sum=3073004)
artifacts[both]: 52b5f80ea071cd7f
