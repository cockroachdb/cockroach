# This test reproduces #106559 in a simpler format, where a (satisfiable) voter
# constraint will never be satisfied if every existing replica is necessary to
# satisfy either a voter or non-voter constraint. See the topology below.
gen_cluster nodes=5 region=(a,b) nodes_per_region=(2,3)
----

# Generate 10 ranges, one replica will be placed on each node initially.
gen_ranges ranges=10 repl_factor=4
----

# Update the span config to require a non-voter in the `region=a` locality.
# There should be the following replica localities for voters and non-voters:
#   voters      [a,b,b]
#   non_voters  [a]
set_span_config 
[0,10000): num_replicas=4 num_voters=3 constraints={'+region=a':2,'+region=b':2} voter_constraints={'+region=a':1,'+region=b':2}
----

# Switch the span config to require the non-voter be placed in the 'region=b'
# locality. This will require a swap between one of the voting replicas in b,
# and the non-voter a.
set_span_config delay=5m
[0,10000): num_replicas=4 num_voters=3 constraints={'+region=a':2,'+region=b':2} voter_constraints={'+region=a':2,'+region=b':1}
----

assertion type=conformance under=0 over=0 unavailable=0 violating=0
----

eval duration=1m cfgs=(sma-count,mma-only) metrics=(replicas) full=true
----
replicas#1: first: [s1=9, s2=9, s3=9, s4=9, s5=8] (stddev=0.40, mean=8.80, sum=44)
replicas#1: last:  [s1=11, s2=10, s3=9, s4=5, s5=9] (stddev=2.04, mean=8.80, sum=44)
replicas#1: thrash_pct: [s1=105%, s2=36%, s3=67%, s4=0%, s5=0%]  (sum=208%)
artifacts[sma-count]: 8440b2431ce5cf58
==========================
replicas#1: first: [s1=9, s2=9, s3=9, s4=9, s5=8] (stddev=0.40, mean=8.80, sum=44)
replicas#1: last:  [s1=11, s2=11, s3=9, s4=5, s5=8] (stddev=2.23, mean=8.80, sum=44)
replicas#1: thrash_pct: [s1=105%, s2=0%, s3=67%, s4=0%, s5=0%]  (sum=172%)
artifacts[mma-only]: 69ad81f1f2b7046a
==========================
Cluster Set Up
	n1(a,a_1,8vcpu): {s1:(256GiB)}
	n2(a,a_1,8vcpu): {s2:(256GiB)}
	n3(b,b_1,8vcpu): {s3:(256GiB)}
	n4(b,b_1,8vcpu): {s4:(256GiB)}
	n5(b,b_1,8vcpu): {s5:(256GiB)}
Key Space
	[0,10000): 10(rf=4), 0MiB, [s1:(8,2*),s2:(8,2*),s3:(8,2*),s4:(8,2*),s5:(8,2*)]
Event
	[0,10000): 3voters,1nonvoters [replicas:{2:region=a}{2:region=b}] [voters:{1:region=a}{2:region=b}]
	set LBRebalancingMode to 2
	[0,10000): 3voters,1nonvoters [replicas:{2:region=a}{2:region=b}] [voters:{2:region=a}{1:region=b}] at 11:05:00
Workload Set Up
	empty
Changed Settings
	empty
==========================
