// Copyright 2019 The Cockroach Authors.
//
// Use of this software is governed by the CockroachDB Software License
// included in the /LICENSE file.

syntax = "proto3";
package cockroach.blobs;
option go_package = "github.com/cockroachdb/cockroach/pkg/blobs/blobspb";

// GetRequest is used to read a file from a remote node.
// It's path is specified by `filename`, which can either
// be a relative path from the base of external IO dir, or
// an absolute path, which must be contained in external IO dir.
message GetRequest {
  string filename = 1;
  int64 offset = 2;
}

// GetResponse returns contents of the file requested by GetRequest.
message GetResponse {
  bytes payload = 1;
}

// PutRequest is used to write a payload to a remote node.
// It's path is specified by `filename`, as described in GetRequest.
message PutRequest {
  string filename = 1;
  bytes payload = 2;
}

// PutResponse is returned once a file has successfully been written by a PutRequest.
message PutResponse {
}

// GlobRequest is used to list all files that match the glob pattern on a given node.
message GlobRequest {
  string pattern = 1;
}

// GlobResponse responds with the list of files that matched the given pattern.
message GlobResponse {
  repeated string files = 1;
}

// DeleteRequest is used to delete a file or empty directory on a remote node.
// It's path is specified by `filename`, as described in GetRequest.
message DeleteRequest {
  string filename = 1;
}

// DeleteResponse is returned once a file has been successfully deleted by DeleteRequest.
message DeleteResponse {
}

// StatRequest is used to get the file size of a file.
// It's path is specified by `filename`, as described in GetRequest.
message StatRequest {
  string filename = 1;
}

// BlobStat returns the file size of the file requested in StatRequest.
message BlobStat {
  int64 filesize = 1;
}

// StreamChunk contains a chunk of the payload we are streaming
message StreamChunk {
  bytes payload = 1;
}

// StreamResponse is used to acknowledge a stream ending.
message StreamResponse {
}

// FlowControlledGetRequest initiates a flow-controlled file read stream.
// The client sends this as the first message to configure the stream parameters.
message FlowControlledGetRequest {
  // filename is the path to the file, either relative to external IO dir
  // or an absolute path contained within the external IO dir.
  string filename = 1;
  // offset is the byte offset to start reading from.
  int64 offset = 2;
  // flow_control_window is the maximum number of unacknowledged chunks
  // the server can have in flight at any time.
  int32 flow_control_window = 3;
}

// FlowControlledClientMessage is sent by the client during a flow-controlled
// file transfer. The first message must be a request, subsequent messages
// are acknowledgments.
message FlowControlledClientMessage {
  oneof msg {
    // request is the initial message containing stream parameters.
    FlowControlledGetRequest request = 1;
    // ack indicates the client has processed chunks and the server
    // may send more. The value indicates how many chunks to acknowledge.
    int32 ack = 2;
  }
}

// FlowControlledServerMessage is sent by the server during a flow-controlled
// file transfer. Contains either data chunks or an EOF marker.
message FlowControlledServerMessage {
  oneof msg {
    // chunk contains the file data being streamed from server to client.
    StreamChunk chunk = 1;
    // eof indicates the server has finished sending all data.
    bool eof = 2;
  }
}

// Blob service allows for inter node file sharing.
// It is used by ExternalStorage when interacting with
// files that are stored on a node's local file system.
service Blob {
  rpc List(GlobRequest) returns (GlobResponse) {}
  rpc Delete(DeleteRequest) returns (DeleteResponse) {}
  rpc Stat(StatRequest) returns (BlobStat) {}
  rpc GetStream(GetRequest) returns (stream StreamChunk) {}
  rpc PutStream(stream StreamChunk) returns (StreamResponse) {}
  // GetStreamFlowControlled provides flow-controlled file streaming where
  // the client sends acknowledgments to control the pace of data transfer.
  rpc GetStreamFlowControlled(stream FlowControlledClientMessage)
      returns (stream FlowControlledServerMessage) {}
}
