<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="/future/assets/htmx.min.js"></script>
    <script defer src="/future/assets/alpine.min.js"></script>
    <script src="/future/assets/auto-refresh.js"></script>
    <link rel=stylesheet href="/future/assets/missing.css">
    <script src="/future/assets/table-sort.js"></script>
    <meta charset="utf-8">
  </head>
  <body>
    <style>
      section.grid {
        grid-template:
          "name status"  auto
          "uuid version" auto /
          1fr   max-content;
      }
    </style>
    <div class="sidebar-layout" style="height: 100vh;">
      <header>
        <nav>
          <strong class="<h1>">DB Console</strong>
            <ul role="list">
              <li><a href="overview">Overview</a></li>
              <li><a href="metrics">Metrics</a></li>
              <li>Databases</li>
              <li>SQL Activity</li>
                <ul role="list" class="margin">
                  <li>Statements</li>
                  <li>Transactions</li>
                  <li>Sessions</li>
                </ul>
              <li>Insights</li>
              <li>Top Ranges</li>
              <li>Jobs</li>
              <li>Schedules</li>
              <li>Advanced Debug</li>
            </ul>
        </nav>
        <section aria-label="Status">
          <chip class="ok">logged in</chip>
          <chip class="info">v123.234</chip>
        </section>
      </header>
        <main class="width:100% padding">
          <nav class="breadcrumbs" aria-label="Breadcrumbs">
            <ul>
              <li class="<h1>">SQL Activity</li>
              <li class="<h2>"><a href="#" aria-current=page>Statements</a></li>
            </ul>
          </nav>
          <form class="flex-column box">
            <div class="flex-row">
            <div>
              <label for=top>Top:</label>
              <select id=top>
                <option>25</option>
                <option>50</option>
                <option>100</option>
                <option>500</option>
                <hr />
                <optgroup label="Loads more slowly">
                <option>1,000</option>
                <option>5,000</option>
                <option>10,000</option>
                </optgroup>
              </select>
            </div>
            <div>
              <label for=by>By:</label>
              <select id=by>
                <option>% of All Runtime</option>
                <option>Contention Time</option>
                <option>Execution Count</option>
                <option>SQL CPU Time</option>
                <option>Statement Time</option>
                <hr />
                <optgroup label="Load smore slowly">
                  <option>Last Execution Time</option>
                  <option>Max Latency</option>
                  <option>Max Memory</option>
                  <option>Min Latency</option>
                  <option>Network</option>
                  <option>Retries</option>
                  <option>Rows Processed</option>
                </optgroup>
              </select>
            </div>
            <div role=radiogroup aria-labelledby=active-lbl>
              <span id=active-lbl>Result Type:</span>
              <div>
                <div><label><input name=active type="radio" value="fingerprints" checked />Statement Fingerprints</label></div>
                <div><label><input name=active type="radio" value="active" />Active Executions</label></div>
              </div>
            </div>
            </div>
            <div class="flex-row">
            <div>
              <label for=category>Interval:</label>
              <select id=interval>
                <option>Last 10m</option>
                <option>Last 30m</option>
                <option>Last 1h</option>
                <option>Custom</option>
              </select>
            </div>
            <div>
              <label for="start-time">Start:</label>
              <input
                type="datetime-local"
                id="start-time"
                name="start-time"
                x-model="$store.timeRange.startTime"
                :disabled="$store.timeRange.interval !== 'Custom'" />
            </div>
            <div>
              <label for="end-time">End:</label>
              <input
                type="datetime-local"
                id="end-time"
                name="end-time"
                x-model="$store.timeRange.endTime"
                :disabled="$store.timeRange.interval !== 'Custom'" />
            </div>
            </div>
            <div>
            <strong><button type="submit" class="<big>">Apply</button></strong>
            </div>
          </form>
          <h3>Results - Top 100 Statement Fingerprints by % of All Runtime</h3>

          <div x-data="tableSort()" style="overflow-x: auto;">
            <table id="table-data">
              <thead>
                <tr>
                  <th @click="sort('statements', 0)" style="cursor: pointer;">
                    Statements <span x-text="getSortIndicator('statements')"></span>
                  </th>
                  <th @click="sort('execution-count', 1)" style="cursor: pointer;">
                    Execution Count <span x-text="getSortIndicator('execution-count')"></span>
                  </th>
                  <th @click="sort('database', 2)" style="cursor: pointer;">
                    Database <span x-text="getSortIndicator('database')"></span>
                  </th>
                  <th @click="sort('application-name', 3)" style="cursor: pointer;">
                    Application Name <span x-text="getSortIndicator('application-name')"></span>
                  </th>
                  <th @click="sort('statement-time', 4)" style="cursor: pointer;">
                    Statement Time <span x-text="getSortIndicator('statement-time')"></span>
                  </th>
                  <th @click="sort('pct-runtime', 5)" style="cursor: pointer;">
                    % of All Runtime <span x-text="getSortIndicator('pct-runtime')"></span>
                  </th>
                  <th @click="sort('contention-time', 6)" style="cursor: pointer;">
                    Contention Time <span x-text="getSortIndicator('contention-time')"></span>
                  </th>
                  <th @click="sort('sql-cpu-time', 7)" style="cursor: pointer;">
                    SQL CPU Time <span x-text="getSortIndicator('sql-cpu-time')"></span>
                  </th>
                  <th @click="sort('min-latency', 8)" style="cursor: pointer;">
                    Min Latency <span x-text="getSortIndicator('min-latency')"></span>
                  </th>
                  <th @click="sort('max-latency', 9)" style="cursor: pointer;">
                    Max Latency <span x-text="getSortIndicator('max-latency')"></span>
                  </th>
                  <th @click="sort('rows-processed', 10)" style="cursor: pointer;">
                    Rows Processed <span x-text="getSortIndicator('rows-processed')"></span>
                  </th>
                  <th @click="sort('bytes-read', 11)" style="cursor: pointer;">
                    Bytes Read <span x-text="getSortIndicator('bytes-read')"></span>
                  </th>
                  <th @click="sort('max-memory', 12)" style="cursor: pointer;">
                    Max Memory <span x-text="getSortIndicator('max-memory')"></span>
                  </th>
                  <th @click="sort('network', 13)" style="cursor: pointer;">
                    Network <span x-text="getSortIndicator('network')"></span>
                  </th>
                  <th @click="sort('retries', 14)" style="cursor: pointer;">
                    Retries <span x-text="getSortIndicator('retries')"></span>
                  </th>
                  <th @click="sort('last-exec-time', 15)" style="cursor: pointer;">
                    Last Execution Time <span x-text="getSortIndicator('last-exec-time')"></span>
                  </th>
                  <th @click="sort('fingerprint-id', 16)" style="cursor: pointer;">
                    Statement Fingerprint ID <span x-text="getSortIndicator('fingerprint-id')"></span>
                  </th>
                </tr>
              </thead>
              <tbody>
                {{range .Data.Statements}}
                <tr>
                  <td>
                    {{.Key.KeyData.Query}}
                  </td>
                  <td data-sort="{{.Stats.Count}}">
                    {{formatNumber .Stats.Count}}
                  </td>
                  <td>
                    {{.Key.KeyData.Database}}
                  </td>
                  <td>
                    {{.Key.KeyData.App}}
                  </td>
                  <td data-sort="{{mul .Stats.ServiceLat.Mean 1000000000}}">
                    {{formatTime (mul .Stats.ServiceLat.Mean 1000000000)}}
                  </td>
                  <td data-sort="{{mul (mul .Stats.ServiceLat.Mean .Stats.Count) 1000000000}}">
                    -
                  </td>
                  <td data-sort="{{.Stats.ExecStats.ContentionTime.Mean}}">
                    {{formatTime .Stats.ExecStats.ContentionTime.Mean}}
                  </td>
                  <td data-sort="{{.Stats.ExecStats.CPUSQLNanos.Mean}}">
                    {{formatTime .Stats.ExecStats.CPUSQLNanos.Mean}}
                  </td>
                  <td data-sort="{{mul .Stats.LatencyInfo.Min 1000000000}}">
                    {{formatTime (mul .Stats.LatencyInfo.Min 1000000000)}}
                  </td>
                  <td data-sort="{{mul .Stats.LatencyInfo.Max 1000000000}}">
                    {{formatTime (mul .Stats.LatencyInfo.Max 1000000000)}}
                  </td>
                  <td data-sort="{{.Stats.RowsRead.Mean}}">
                    {{formatNumber .Stats.RowsRead.Mean}}
                  </td>
                  <td data-sort="{{.Stats.BytesRead.Mean}}">
                    {{formatBytes .Stats.BytesRead.Mean}}
                  </td>
                  <td data-sort="{{.Stats.ExecStats.MaxMemUsage.Mean}}">
                    {{formatBytes .Stats.ExecStats.MaxMemUsage.Mean}}
                  </td>
                  <td data-sort="{{.Stats.ExecStats.NetworkBytes.Mean}}">
                    {{formatBytes .Stats.ExecStats.NetworkBytes.Mean}}
                  </td>
                  <td data-sort="{{.Stats.MaxRetries}}">
                    {{formatNumber .Stats.MaxRetries}}
                  </td>
                  <td data-sort="{{.Stats.LastExecTimestamp.Unix}}">
                    {{if .Stats.LastExecTimestamp.IsZero}}-{{else}}{{.Stats.LastExecTimestamp.Format "2006-01-02 15:04:05"}}{{end}}
                  </td>
                  <td>
                    {{.ID}}
                  </td>
                </tr>
                {{end}}
              </tbody>
            </table>

            <div class="flex-row" style="justify-content: space-between; align-items: center; margin-top: 1rem;">
              <div>
                <span x-text="paginationInfo"></span>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button
                  @click="prevPage()"
                  :disabled="currentPage === 1"
                  type="button">
                  ← Previous
                </button>
                <span>Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></span>
                <button
                  @click="nextPage()"
                  :disabled="currentPage === totalPages"
                  type="button">
                  Next →
                </button>
              </div>
            </div>
          </div>
       </main>
      </div>
   </body>
</html>
