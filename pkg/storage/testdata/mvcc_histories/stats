# Tests MVCC stats calculations for puts, dels, and rangedels.
#
# Intermediate states are tested through stats traces. Final state:
#
# (x is tombstone, o---o is range tombstone, [] is intent)
#
# 6             d6  e6  f6
# 5                         x   x   x
# 4     b4  x   o-----------------------o   Two range tombstones: the lowest is the one
# 3     x   c3  o-----------------------o   that matters for point key GCBytesAge.
# 2     x
# 1     b1  x       e1  x       h1  x
# 0 a0
#   a   b   c   d   e   f   g   h   i   j

run stats trace
put k=a ts=0 v=a0
put k=b ts=1 v=b1
del k=b ts=2
del k=b ts=3
put k=b ts=4 v=b4
del k=c ts=1
put k=c ts=3 v=c3
del k=c ts=4
put k=e ts=1 v=e1
del k=f ts=1
put k=h ts=1 v=h1
del k=i ts=1
del_range k=d end=j ts=3
del_range k=d end=j ts=4
put k=d ts=6 v=d6
put k=e ts=6 v=e6
put k=f ts=6 v=f6
del k=g ts=5
del k=h ts=5
del k=i ts=5
----
>> put k=a ts=0 v=a0
stats: live_bytes:+23 live_count:+1 key_bytes:+2 key_count:+1 val_bytes:+21 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
>> put k=b ts=1 v=b1
stats: live_bytes:+21 live_count:+1 key_bytes:+14 key_count:+1 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/1.000000000,0 -> /BYTES/b1
>> del k=b ts=2
stats: live_bytes:-21 live_count:-1 key_bytes:+12 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
>> del k=b ts=3
stats: gc_bytes_age:-2 key_bytes:+12 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
>> put k=b ts=4 v=b4
stats: gc_bytes_age:-2 live_bytes:+21 live_count:+1 key_bytes:+12 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
>> del k=c ts=1
stats: key_bytes:+14 key_count:+1 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/1.000000000,0 -> /<empty>
>> put k=c ts=3 v=c3
stats: gc_bytes_age:-4 live_bytes:+21 live_count:+1 key_bytes:+12 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
>> del k=c ts=4
stats: live_bytes:-21 live_count:-1 key_bytes:+12 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
>> put k=e ts=1 v=e1
stats: live_bytes:+21 live_count:+1 key_bytes:+14 key_count:+1 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
>> del k=f ts=1
stats: key_bytes:+14 key_count:+1 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
>> put k=h ts=1 v=h1
stats: live_bytes:+21 live_count:+1 key_bytes:+14 key_count:+1 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
>> del k=i ts=1
stats: key_bytes:+14 key_count:+1 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> del_range k=d end=j ts=3
del_range: "d"-"j" -> deleted 2 key(s)
stats: live_bytes:-42 live_count:-2 key_bytes:+24 val_count:+2
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> del_range k=d end=j ts=4
del_range: "d"-"j" -> deleted 0 key(s)
stats: 
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> put k=d ts=6 v=d6
stats: live_bytes:+21 live_count:+1 key_bytes:+14 key_count:+1 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> put k=e ts=6 v=e6
stats: gc_bytes_age:-6 live_bytes:+21 live_count:+1 key_bytes:+12 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/6.000000000,0 -> /BYTES/e6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/1.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> put k=f ts=6 v=f6
stats: gc_bytes_age:-10 live_bytes:+21 live_count:+1 key_bytes:+12 val_bytes:+7 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/6.000000000,0 -> /BYTES/e6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /BYTES/f6
data: "f"/1.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> del k=g ts=5
stats: key_bytes:+14 key_count:+1 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/6.000000000,0 -> /BYTES/e6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /BYTES/f6
data: "f"/1.000000000,0 -> /<empty>
data: "g"/5.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> del k=h ts=5
stats: gc_bytes_age:-4 key_bytes:+12 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/6.000000000,0 -> /BYTES/e6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /BYTES/f6
data: "f"/1.000000000,0 -> /<empty>
data: "g"/5.000000000,0 -> /<empty>
data: "h"/5.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/1.000000000,0 -> /<empty>
>> del k=i ts=5
stats: gc_bytes_age:-8 key_bytes:+12 val_count:+1
meta: "a"/0,0 -> txn={<nil>} ts=0,0 del=false klen=0 vlen=0 raw=/BYTES/a0 mergeTs=<nil> txnDidNotUpdateMeta=false
data: "b"/4.000000000,0 -> /BYTES/b4
data: "b"/3.000000000,0 -> /<empty>
data: "b"/2.000000000,0 -> /<empty>
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/4.000000000,0 -> /<empty>
data: "c"/3.000000000,0 -> /BYTES/c3
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /BYTES/d6
data: "e"/6.000000000,0 -> /BYTES/e6
data: "e"/3.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /BYTES/f6
data: "f"/1.000000000,0 -> /<empty>
data: "g"/5.000000000,0 -> /<empty>
data: "h"/5.000000000,0 -> /<empty>
data: "h"/3.000000000,0 -> /<empty>
data: "h"/1.000000000,0 -> /BYTES/h1
data: "i"/5.000000000,0 -> /<empty>
data: "i"/1.000000000,0 -> /<empty>
stats: {
  contains_estimates:0
  last_update_nanos:1000000000000
  intent_age:0
  gc_bytes_age:215338
  live_bytes:107
  live_count:5
  key_bytes:246
  key_count:9
  val_bytes:77
  val_count:20
  intent_bytes:0
  intent_count:0
  separated_intent_count:0
  range_key_count:0
  range_key_bytes:0
  sys_bytes:0
  sys_count:0
  abort_span_bytes:0
}
