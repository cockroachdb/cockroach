# Tests MVCC stats calculations for intent resolution.
#
# Intermediate states are tested through stats traces. Final state before resolution:
#
# (x is tombstone, o---o is range tombstone, [] is intent)
#
# 6 [a6][b6][c6][x] [x] [x] [g6][h6][i6][x] [x] [x]
# 5
# 4                          o-----------------------o   Two range tombstones: the lowest is the
# 3                          o-----------------------o   one that matters for point key GCBytesAge.
# 2 
# 1      b1  x       e1  x       h1  x       k1  x
#    a   b   c   d   e   f   g   h   i   j   k   l   m

run stats
with ts=1
  put k=b v=b1
  del k=c
  put k=e v=e1
  del k=f
  put k=g v=g1
  del k=h
  put k=i v=i1
  del k=j
del_range_ts k=g end=m ts=3
del_range_ts k=g end=m ts=4
with t=A
  txn_begin ts=6
  put k=a v=a6
  put k=b v=b6
  put k=c v=c6
  del k=d
  del k=e
  del k=f
  put k=g v=g6
  put k=h v=h6
  put k=i v=i6
  del k=j
  del k=k
  del k=l
----
>> at end:
txn: "A" meta={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} lock=true stat=PENDING rts=6.000000000,0 wto=false gul=0,0
rangekey: {g-m}/[4.000000000,0 3.000000000,0]
meta: "a"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "a"/6.000000000,0 -> /BYTES/a6
meta: "b"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "b"/6.000000000,0 -> /BYTES/b6
data: "b"/1.000000000,0 -> /BYTES/b1
meta: "c"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "c"/6.000000000,0 -> /BYTES/c6
data: "c"/1.000000000,0 -> /<empty>
meta: "d"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "d"/6.000000000,0 -> /<empty>
meta: "e"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "e"/6.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
meta: "f"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "f"/6.000000000,0 -> /<empty>
data: "f"/1.000000000,0 -> /<empty>
meta: "g"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "g"/6.000000000,0 -> /BYTES/g6
data: "g"/1.000000000,0 -> /BYTES/g1
meta: "h"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "h"/6.000000000,0 -> /BYTES/h6
data: "h"/1.000000000,0 -> /<empty>
meta: "i"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "i"/6.000000000,0 -> /BYTES/i6
data: "i"/1.000000000,0 -> /BYTES/i1
meta: "j"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "j"/6.000000000,0 -> /<empty>
data: "j"/1.000000000,0 -> /<empty>
meta: "k"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "k"/6.000000000,0 -> /<empty>
meta: "l"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "l"/6.000000000,0 -> /<empty>
stats: {
  contains_estimates:0
  last_update_nanos:1000000000000
  intent_age:11928
  gc_bytes_age:515299
  live_bytes:414
  live_count:6
  key_bytes:264
  key_count:12
  val_bytes:646
  val_count:20
  intent_bytes:186
  intent_count:12
  separated_intent_count:12
  range_key_count:1
  range_key_bytes:22
  sys_bytes:0
  sys_count:0
  abort_span_bytes:0
}

run stats trace
resolve_intent_range t=A k=a end=z status=COMMITTED
----
>> resolve_intent_range t=A k=a end=z status=COMMITTED
called ClearIntent("a", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("b", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("c", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("d", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("e", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("f", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("g", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("h", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("i", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("j", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("k", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("l", TDNUM(true), 00000000-0000-0000-0000-000000000001)
stats: live_bytes:-288 val_bytes:-576 intent_bytes:-186 intent_count:-12 separated_intent_count:-12
rangekey: {g-m}/[4.000000000,0 3.000000000,0]
data: "a"/6.000000000,0 -> /BYTES/a6
data: "b"/6.000000000,0 -> /BYTES/b6
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/6.000000000,0 -> /BYTES/c6
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /<empty>
data: "e"/6.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /<empty>
data: "f"/1.000000000,0 -> /<empty>
data: "g"/6.000000000,0 -> /BYTES/g6
data: "g"/1.000000000,0 -> /BYTES/g1
data: "h"/6.000000000,0 -> /BYTES/h6
data: "h"/1.000000000,0 -> /<empty>
data: "i"/6.000000000,0 -> /BYTES/i6
data: "i"/1.000000000,0 -> /BYTES/i1
data: "j"/6.000000000,0 -> /<empty>
data: "j"/1.000000000,0 -> /<empty>
data: "k"/6.000000000,0 -> /<empty>
data: "l"/6.000000000,0 -> /<empty>
stats: {
  contains_estimates:0
  last_update_nanos:1000000000000
  intent_age:0
  gc_bytes_age:229027
  live_bytes:126
  live_count:6
  key_bytes:264
  key_count:12
  val_bytes:70
  val_count:20
  intent_bytes:0
  intent_count:0
  separated_intent_count:0
  range_key_count:1
  range_key_bytes:22
  sys_bytes:0
  sys_count:0
  abort_span_bytes:0
}
