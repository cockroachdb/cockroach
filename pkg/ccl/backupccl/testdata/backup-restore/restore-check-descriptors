new-server name=s1
----

exec-sql
CREATE DATABASE testdb;
CREATE TABLE testdb.parent (k INT PRIMARY KEY, v STRING);
INSERT INTO testdb.parent (k, v) VALUES (1, 'a');
CREATE TABLE testdb.child (k INT NOT NULL, FOREIGN KEY (k) REFERENCES testdb.parent (k))
----

exec-sql
BACKUP INTO 'nodelocal://1/full_cluster_backup/';
----

exec-sql
SET CLUSTER SETTING jobs.debug.pausepoints = 'restore.after_publishing_descriptors';
----

exec-sql
ALTER TABLE testdb.child RENAME TO cool_cousin;
----

restore expect-pausepoint tag=a
RESTORE DATABASE testdb FROM LATEST IN 'nodelocal://1/full_cluster_backup/' with new_db_name='d2'
----
job paused at pausepoint

# Corrupt the child >;-)
exec-sql
SELECT crdb_internal.unsafe_delete_descriptor(id) FROM system.namespace WHERE name = 'child'
----

exec-sql
SELECT crdb_internal.unsafe_delete_namespace_entry("parentID", "parentSchemaID", name, id) FROM system.namespace WHERE name = 'child'
----

job resume=a
----

job tag=a wait-for-state=revert-failed
----
