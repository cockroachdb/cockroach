# LogicTest: multiregion-9node-3region-3azs-tenant
# tenant-cluster-setting-override-opt: sql.virtual_cluster.feature_access.multiregion.enabled=true

statement ok
CREATE DATABASE db PRIMARY REGION "us-east-1"

statement ok
ALTER DATABASE db ADD REGION "ca-central-1"

statement ok
SET override_multi_region_zone_config = true

statement ok
ALTER DATABASE db CONFIGURE ZONE USING constraints = '{+region=us-east-1: 3}'

subtest constrained_replicas

statement ok
SET CLUSTER SETTING sql.zone_configs.max_replicas_per_region = 2

statement error pgcode 23514 constraint for "us-east-1" exceeds the configured maximum of 2 replicas
ALTER DATABASE db CONFIGURE ZONE USING constraints = '{+region=us-east-1: 3}'

statement ok
ALTER DATABASE db CONFIGURE ZONE USING constraints = '{+region=us-east-1: 2, +region=ca-central-1: 1}'

statement ok
SET CLUSTER SETTING sql.zone_configs.max_replicas_per_region = 1

statement error pgcode 23514 constraint for "us-east-1" exceeds the configured maximum of 1 replicas
ALTER DATABASE db CONFIGURE ZONE USING gc.ttlseconds = 10

statement ok
ALTER DATABASE db CONFIGURE ZONE USING constraints = '{+region=us-east-1: 1, +region=ca-central-1: 1}'

subtest end

subtest privileged_ranges

statement ok
SET CLUSTER SETTING sql.zone_configs.allow_non_root_modify_default_range.enabled = false

statement ok
ALTER RANGE default CONFIGURE ZONE USING num_replicas = 10

statement ok
SET ROLE admin

statement error pgcode 42501 only root users are allowed to modify the default range
ALTER RANGE default CONFIGURE ZONE USING num_replicas = 10

statement ok
SET CLUSTER SETTING sql.zone_configs.allow_non_root_modify_default_range.enabled = true

statement ok
ALTER RANGE default CONFIGURE ZONE USING num_replicas = 10

subtest end
