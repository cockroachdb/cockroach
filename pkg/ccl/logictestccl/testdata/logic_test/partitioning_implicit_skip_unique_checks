# LogicTest: local

statement ok
SET experimental_enable_implicit_column_partitioning = true

# Test the skip_unique_checks storage parameter on UNIQUE indexes in PARTITION
# ALL BY tables. When a table uses PARTITION ALL BY, unique indexes have the
# partition column implicitly added, which creates UNIQUE WITHOUT INDEX
# constraints since global uniqueness can't be guaranteed by the partitioned index.

statement ok
CREATE TABLE t (
  region STRING NOT NULL,
  a INT PRIMARY KEY,
  b INT,
  UNIQUE INDEX idx_b (b),
  CHECK (region IN ('us-west', 'us-east', 'eu-west'))
) PARTITION ALL BY LIST (region) (
  PARTITION us_west VALUES IN (('us-west')),
  PARTITION us_east VALUES IN (('us-east')),
  PARTITION eu_west VALUES IN (('eu-west'))
)

# Without the storage parameter, unique checks are planned for the implicitly
# partitioned unique index and primary key.
query T
SELECT DISTINCT regexp_extract(info, 'table:\s+\w+@([\w_]+)') AS index_name
FROM [EXPLAIN INSERT INTO t VALUES ('us-west', 1, 10), ('us-east', 2, 20)]
WHERE info ~ 'table:';
----
t_pkey
idx_b

# Set the storage parameter to skip unique checks on the secondary index.
statement ok
ALTER INDEX t@idx_b SET (skip_unique_checks = true)

# Now unique checks should not be planned for the secondary.
query T
SELECT DISTINCT regexp_extract(info, 'table:\s+\w+@([\w_]+)') AS index_name
FROM [EXPLAIN INSERT INTO t VALUES ('us-west', 3, 30), ('us-east', 4, 40)]
WHERE info ~ 'table:';
----
t_pkey

# Set the storage parameter to skip unique checks on the primary index.
statement ok
ALTER INDEX t@t_pkey SET (skip_unique_checks = true)

# Now unique checks should not be planned for the primary either.
query T
SELECT DISTINCT regexp_extract(info, 'table:\s+\w+@([\w_]+)') AS index_name
FROM [EXPLAIN INSERT INTO t VALUES ('us-west', 5, 50), ('us-east', 6, 60)]
WHERE info ~ 'table:';
----

# Reset the parameter for the secondary.
statement ok
ALTER INDEX t@idx_b RESET (skip_unique_checks)

# Checks should be planned again for the secondary only.
query T
SELECT DISTINCT regexp_extract(info, 'table:\s+\w+@([\w_]+)') AS index_name
FROM [EXPLAIN INSERT INTO t VALUES ('us-west', 7, 70), ('us-east', 8, 80)]
WHERE info ~ 'table:';
----
idx_b

# Reset the parameter for the primary.
statement ok
ALTER INDEX t@t_pkey RESET (skip_unique_checks)

# Checks should be planned again for both indexes.
query T
SELECT DISTINCT regexp_extract(info, 'table:\s+\w+@([\w_]+)') AS index_name
FROM [EXPLAIN INSERT INTO t VALUES ('us-west', 9, 90), ('us-east', 10, 100)]
WHERE info ~ 'table:';
----
t_pkey
idx_b
