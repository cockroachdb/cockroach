# LogicTest: 3node-tenant-multiregion

# Only the root user can modify the system database's regions.
user root

# Create a database before transforming the system database into a multi-region
# database.
statement ok
CREATE DATABASE "non-mr-system-database"

query TTBBT colnames
SHOW REGIONS FROM DATABASE "non-mr-system-database"
----
database  region  primary  secondary  zones

# Configure the regions on the system database
statement ok
ALTER DATABASE system PRIMARY REGION "test"

statement ok
ALTER DATABASE system ADD REGION "test1"

query TTBBT colnames,rowsort
SHOW REGIONS FROM DATABASE system
----
database  region  primary  secondary  zones
system    test    true     false      {}
system    test1   false    false      {}

# A database with no primary region should have the same regions as the system
# database.
statement ok
CREATE DATABASE "defaults-to-system";

query TTBBT colnames,rowsort
SHOW REGIONS FROM DATABASE "defaults-to-system"
----
database            region  primary  secondary  zones
defaults-to-system  test    true     false      {}
defaults-to-system  test1   false    false      {}

# If any regions are provided when creating the region, then those regions are
# used instead of the system database's regions.
statement ok
CREATE DATABASE "with-custom-primary" WITH PRIMARY REGION 'test1'

query TTBBT colnames
SHOW REGIONS FROM DATABASE "with-custom-primary"
----
database             region  primary  secondary  zones
with-custom-primary  test1   true     false      {}

# If sql.defaults.primary_region is set, then the database is created with the
# setting's region as the only region.
statement ok
SET CLUSTER SETTING sql.defaults.primary_region TO 'test1';

statement ok
CREATE DATABASE "with-primary-setting"

query TTBBT colnames
SHOW REGIONS FROM DATABASE "with-primary-setting"
----
database              region  primary  secondary  zones
with-primary-setting  test1   true     false      {}

subtest regional_by_table_follows_primary

# Add a third region to enable multiple primary region switches.
statement ok
ALTER DATABASE system ADD REGION "test2"

query TTBBT colnames,rowsort
SHOW REGIONS FROM DATABASE system
----
database  region  primary  secondary  zones
system    test    true     false      {}
system    test1   false    false      {}
system    test2   false    false      {}

statement ok
ALTER DATABASE system SET PRIMARY REGION "test1"

query T
SELECT create_statement FROM [SHOW CREATE DATABASE system]
----
CREATE DATABASE system PRIMARY REGION test1 REGIONS = test, test1, test2 SURVIVE REGION FAILURE

# Verify system tables show "LOCALITY REGIONAL BY TABLE IN PRIMARY REGION"
# syntax (not an explicit region like "test" or "test1").
query B
SELECT create_statement LIKE '%LOCALITY REGIONAL BY TABLE IN PRIMARY REGION%'
FROM [SHOW CREATE TABLE system.jobs]
----
true

query B
SELECT create_statement LIKE '%LOCALITY REGIONAL BY TABLE IN PRIMARY REGION%'
FROM [SHOW CREATE TABLE system.scheduled_jobs]
----
true

statement ok
ALTER DATABASE system SET PRIMARY REGION "test2"

query T
SELECT create_statement FROM [SHOW CREATE DATABASE system]
----
CREATE DATABASE system PRIMARY REGION test2 REGIONS = test, test1, test2 SURVIVE REGION FAILURE

# Verify tables still show PRIMARY REGION syntax after the second switch.
# This ensures they're not reverting to explicit region references.
query B
SELECT create_statement LIKE '%LOCALITY REGIONAL BY TABLE IN PRIMARY REGION%'
FROM [SHOW CREATE TABLE system.jobs]
----
true

query B
SELECT create_statement LIKE '%LOCALITY REGIONAL BY TABLE IN PRIMARY REGION%'
FROM [SHOW CREATE TABLE system.scheduled_jobs]
----
true

subtest end
