# LogicTest: local

statement error  declared partition columns \(partition_by\) do not match first 1 columns in index being partitioned \(a\)
CREATE TABLE t (
  pk INT PRIMARY KEY,
  partition_by int,
  a INT,
  INDEX (a) PARTITION BY LIST (partition_by) (
    PARTITION one VALUES IN (1),
    PARTITION two VALUES IN (2)
  )
)

statement error PARTITION ALL BY LIST/RANGE is currently experimental
CREATE TABLE public.t (
  pk int PRIMARY KEY,
  partition_by int
) PARTITION ALL BY LIST (partition_by) (
  PARTITION one VALUES IN (1),
  PARTITION two VALUES IN (2)
)

statement ok
SET experimental_enable_implicit_column_partitioning = true

statement error found multiple definitions in partition using column "a"
CREATE TABLE t (
  pk INT PRIMARY KEY,
  a INT,
  b INT,
  c INT
) PARTITION BY LIST (a, a) (
  PARTITION a1 VALUES IN ((1, 1))
)

statement error implicit column partitioning on a subpartition is not yet supported
CREATE TABLE t (
  pk INT PRIMARY KEY,
  a INT,
  b INT,
  c INT,
  INDEX (c) PARTITION BY LIST (a) (
    PARTITION a1 VALUES IN (1) PARTITION BY LIST (b) (
      PARTITION a1b1 VALUES IN ((1))
    )
  )
)

statement ok
CREATE TABLE t (
  pk INT PRIMARY KEY,
  a INT,
  b INT,
  c INT,
  d INT,
  INDEX (b) PARTITION BY LIST(a) (
    PARTITION b_implicit VALUES IN (2)
  ),
  UNIQUE INDEX (c) PARTITION BY LIST (a) (
    PARTITION c_implicit VALUES IN (3)
  ),
  FAMILY (pk, a, b, c, d)
) PARTITION BY LIST(a) (
  PARTITION pk_implicit VALUES IN (1)
)

query T
SELECT create_statement FROM [SHOW CREATE TABLE t]
----
CREATE TABLE public.t (
  pk INT8 NOT NULL,
  a INT8 NULL,
  b INT8 NULL,
  c INT8 NULL,
  d INT8 NULL,
  CONSTRAINT "primary" PRIMARY KEY (a ASC, pk ASC),
  INDEX t_a_b_idx (a ASC, b ASC) PARTITION BY LIST (a) (
    PARTITION b_implicit VALUES IN ((2))
  ),
  UNIQUE INDEX t_a_c_key (a ASC, c ASC) PARTITION BY LIST (a) (
    PARTITION c_implicit VALUES IN ((3))
  ),
  FAMILY fam_0_pk_a_b_c_d (pk, a, b, c, d)
) PARTITION BY LIST (a) (
  PARTITION pk_implicit VALUES IN ((1))
)
-- Warning: Partitioned table with no zone configurations.

statement ok
CREATE INDEX new_idx ON t(d) PARTITION BY LIST (a) (
  PARTITION d_implicit VALUES IN (1)
)

query T
SELECT create_statement FROM [SHOW CREATE TABLE t]
----
CREATE TABLE public.t (
  pk INT8 NOT NULL,
  a INT8 NULL,
  b INT8 NULL,
  c INT8 NULL,
  d INT8 NULL,
  CONSTRAINT "primary" PRIMARY KEY (a ASC, pk ASC),
  INDEX t_a_b_idx (a ASC, b ASC) PARTITION BY LIST (a) (
    PARTITION b_implicit VALUES IN ((2))
  ),
  UNIQUE INDEX t_a_c_key (a ASC, c ASC) PARTITION BY LIST (a) (
    PARTITION c_implicit VALUES IN ((3))
  ),
  INDEX new_idx (a ASC, d ASC) PARTITION BY LIST (a) (
    PARTITION d_implicit VALUES IN ((1))
  ),
  FAMILY fam_0_pk_a_b_c_d (pk, a, b, c, d)
) PARTITION BY LIST (a) (
  PARTITION pk_implicit VALUES IN ((1))
)
-- Warning: Partitioned table with no zone configurations.

statement error cannot ALTER INDEX PARTITION BY on index which already has implicit column partitioning
ALTER INDEX new_idx PARTITION BY LIST (a) (
  PARTITION d_implicit VALUES IN (1)
)

statement error cannot ALTER TABLE PARTITION BY on table which already has implicit column partitioning
ALTER TABLE t PARTITION BY LIST (a) (
  PARTITION pk_implicit VALUES IN (1)
)

statement error PARTITION ALL BY not yet implemented
ALTER TABLE t PARTITION ALL BY LIST (a) (
  PARTITION pk_implicit VALUES IN (1)
)

statement ok
DROP TABLE t

statement error cannot define PARTITION BY on an index if the table has a PARTITION ALL BY definition
CREATE TABLE public.t (
  pk int PRIMARY KEY,
  partition_by int,
  a int,
  INDEX(a) PARTITION BY LIST (partition_by) (
    PARTITION one VALUES IN (1)
  )
) PARTITION ALL BY LIST (partition_by) (
  PARTITION one VALUES IN (1),
  PARTITION two VALUES IN (2)
)

statement error cannot define PARTITION BY on an unique constraint if the table has a PARTITION ALL BY definition
CREATE TABLE public.t (
  pk int PRIMARY KEY,
  partition_by int,
  a int,
  UNIQUE(a) PARTITION BY LIST (partition_by) (
    PARTITION one VALUES IN (1)
  )
) PARTITION ALL BY LIST (partition_by) (
  PARTITION one VALUES IN (1),
  PARTITION two VALUES IN (2)
)


statement ok
CREATE TABLE public.t (
  pk int PRIMARY KEY,
  partition_by int,
  a int,
  b int,
  c int,
  d int,
  INDEX (a),
  UNIQUE (b),
  FAMILY (pk, partition_by, a, b, c, d)
) PARTITION ALL BY LIST (partition_by) (
  PARTITION one VALUES IN (1),
  PARTITION two VALUES IN (2)
)

query T
SELECT create_statement FROM [SHOW CREATE TABLE t]
----
CREATE TABLE public.t (
  pk INT8 NOT NULL,
  partition_by INT8 NULL,
  a INT8 NULL,
  b INT8 NULL,
  c INT8 NULL,
  d INT8 NULL,
  CONSTRAINT "primary" PRIMARY KEY (partition_by ASC, pk ASC),
  INDEX t_partition_by_a_idx (partition_by ASC, a ASC) PARTITION BY LIST (partition_by) (
    PARTITION one VALUES IN ((1)),
    PARTITION two VALUES IN ((2))
  ),
  UNIQUE INDEX t_partition_by_b_key (partition_by ASC, b ASC) PARTITION BY LIST (partition_by) (
    PARTITION one VALUES IN ((1)),
    PARTITION two VALUES IN ((2))
  ),
  FAMILY fam_0_pk_partition_by_a_b_c_d (pk, partition_by, a, b, c, d)
) PARTITION BY LIST (partition_by) (
  PARTITION one VALUES IN ((1)),
  PARTITION two VALUES IN ((2))
)
-- Warning: Partitioned table with no zone configurations.
