# LogicTest: local

subtest protect_cluster

user root

statement ok
SET CLUSTER SETTING jobs.registry.interval.adopt = '10ms'

statement ok
SET CLUSTER SETTING jobs.registry.interval.cancel = '10ms'

statement ok
GRANT admin TO testuser

user testuser

statement ok
select crdb_internal.protect_cluster(1709131929793796000.0000000000, 'molt fetch');

query TTT colnames
select ts as timestamp, meta_type, crdb_internal.pb_to_json( 'cockroach.protectedts.Target', target ) from system.protected_ts_records
----
timestamp  meta_type  crdb_internal.pb_to_json
1709131929793796000.0000000000  jobs       {"cluster": {}}

query T
SELECT description FROM [SHOW JOBS] WHERE job_type = 'REPLICATION STREAM PRODUCER'
----
History Retention for molt fetch

# Cancel the session to force the cleanup the PTS.
statement ok
CANCEL JOB (SELECT id FROM system.jobs WHERE job_type = 'REPLICATION STREAM PRODUCER');

# Confirm that the PTS is gone.
query TTT retry
select ts as timestamp, meta_type, crdb_internal.pb_to_json( 'cockroach.protectedts.Target', target ) from system.protected_ts_records
----
