# LogicTest: multiregion-9node-3region-3azs multiregion-9node-3region-3azs-tenant

query TTTT
SHOW REGIONS
----
ap-southeast-2  {ap-az1,ap-az2,ap-az3}  {}  {}
ca-central-1    {ca-az1,ca-az2,ca-az3}  {}  {}
us-east-1       {us-az1,us-az2,us-az3}  {}  {}

statement ok
CREATE DATABASE db PRIMARY REGION "ca-central-1"

# Cannot add super regions with regions that are not regions of the database.
statement error pq: region ap-southeast-2 not part of database
ALTER DATABASE db ADD SUPER REGION "test" VALUES "ap-southeast-2", "us-east-1"

statement ok
ALTER DATABASE db ADD REGION "us-east-1"

statement ok
ALTER DATABASE db ADD REGION "ap-southeast-2"

# Add super region.
statement ok
ALTER DATABASE db ADD SUPER REGION "test" VALUES "ap-southeast-2", "us-east-1"

# Can't add super region with same name.
statement error pq: super region test already exists
ALTER DATABASE db ADD SUPER REGION "test" VALUES "ap-southeast-2", "us-east-1"

# Can't add super region with overlapping region set with previously defined
# super regions.
statement error pq: region us-east-1 is already defined in super region test
ALTER DATABASE db ADD SUPER REGION "test2" VALUES "us-east-1"

statement ok
CREATE DATABASE mr1 PRIMARY REGION "us-east-1";
CREATE TABLE mr1.t(x INT) LOCALITY REGIONAL BY TABLE;
CREATE TABLE mr1.t2(x INT) LOCALITY REGIONAL BY ROW;
ALTER DATABASE mr1 ADD SUPER REGION "test" VALUES "us-east-1";

query TT
SHOW ZONE CONFIGURATION FOR TABLE mr1.t;
----
TABLE mr1.public.t  ALTER TABLE mr1.public.t CONFIGURE ZONE USING
                    range_min_bytes = 134217728,
                    range_max_bytes = 536870912,
                    gc.ttlseconds = 90000,
                    num_replicas = 3,
                    num_voters = 3,
                    constraints = '{+region=us-east-1: 3}',
                    voter_constraints = '[+region=us-east-1]',
                    lease_preferences = '[[+region=us-east-1]]'

# t2 should only have it's subzones changed.
query TT
SHOW ZONE CONFIGURATION FOR TABLE mr1.t2
----
TABLE mr1.public.t2  ALTER TABLE mr1.public.t2 CONFIGURE ZONE USING
                     range_min_bytes = 134217728,
                     range_max_bytes = 536870912,
                     gc.ttlseconds = 90000,
                     num_replicas = 3,
                     num_voters = 3,
                     constraints = '{+region=us-east-1: 1}',
                     voter_constraints = '[+region=us-east-1]',
                     lease_preferences = '[[+region=us-east-1]]'

query TT
SHOW ZONE CONFIGURATION FOR PARTITION "us-east-1" OF TABLE mr1.t2
----
PARTITION "us-east-1" OF TABLE mr1.public.t2  ALTER PARTITION "us-east-1" OF TABLE mr1.public.t2 CONFIGURE ZONE USING
                                              range_min_bytes = 134217728,
                                              range_max_bytes = 536870912,
                                              gc.ttlseconds = 90000,
                                              num_replicas = 3,
                                              num_voters = 3,
                                              constraints = '{+region=us-east-1: 3}',
                                              voter_constraints = '[+region=us-east-1]',
                                              lease_preferences = '[[+region=us-east-1]]'

statement ok
use mr1;

query B
select crdb_internal.validate_multi_region_zone_configs();
----
true

statement ok
CREATE DATABASE mr2 PRIMARY REGION "us-east-1" REGIONS "ap-southeast-2", "ca-central-1"

statement ok
use mr2

statement ok
CREATE TABLE mr2.t_rt(x INT) LOCALITY REGIONAL BY TABLE IN "ap-southeast-2"

statement ok
CREATE TABLE mr2.t_rt_with_idx(x INT) LOCALITY REGIONAL BY TABLE IN "ap-southeast-2"

statement ok
CREATE TABLE mr2.t_rbr(x INT) LOCALITY REGIONAL BY ROW;

statement ok
CREATE TABLE mr2.t_rbr_with_idx(x INT, y INT, INDEX idx(y)) LOCALITY REGIONAL BY ROW;

statement ok
ALTER DATABASE mr2 ADD SUPER REGION "test" VALUES "us-east-1", "ap-southeast-2"

query TT
SHOW ZONE CONFIGURATION FOR PARTITION "us-east-1" OF TABLE mr2.t_rbr;
----
PARTITION "us-east-1" OF TABLE mr2.public.t_rbr  ALTER PARTITION "us-east-1" OF TABLE mr2.public.t_rbr CONFIGURE ZONE USING
                                                 range_min_bytes = 134217728,
                                                 range_max_bytes = 536870912,
                                                 gc.ttlseconds = 90000,
                                                 num_replicas = 5,
                                                 num_voters = 3,
                                                 constraints = '{+region=ap-southeast-2: 2, +region=us-east-1: 3}',
                                                 voter_constraints = '[+region=us-east-1]',
                                                 lease_preferences = '[[+region=us-east-1]]'

query TT
SHOW ZONE CONFIGURATION FOR PARTITION "ap-southeast-2" OF TABLE mr2.t_rbr_with_idx;
----
PARTITION "ap-southeast-2" OF TABLE mr2.public.t_rbr_with_idx  ALTER PARTITION "ap-southeast-2" OF TABLE mr2.public.t_rbr_with_idx CONFIGURE ZONE USING
                                                               range_min_bytes = 134217728,
                                                               range_max_bytes = 536870912,
                                                               gc.ttlseconds = 90000,
                                                               num_replicas = 5,
                                                               num_voters = 3,
                                                               constraints = '{+region=ap-southeast-2: 4, +region=us-east-1: 1}',
                                                               voter_constraints = '[+region=ap-southeast-2]',
                                                               lease_preferences = '[[+region=ap-southeast-2]]'

statement ok
select crdb_internal.validate_multi_region_zone_configs();
