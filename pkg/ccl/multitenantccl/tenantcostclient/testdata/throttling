# By default, the test provider grants all RUs immediately. Test cases where it
# instead throttles usage to a limited rate.

# Wait for initial 10K RUs to be granted.
wait-for-event
token-bucket-response
----

# Set up throttling at 1K RU/s.
configure
throttle: 1000
----

# Issue 12K RU write to consume all tokens in the bucket and create 2K debt.
write bytes=12285952
----

wait-for-event
token-bucket-response
----

token-bucket
----
-2000.00 RU filling @ 1000.00 RU/s

# Issue 20K RU write that should block as long as it takes to pay down the 2K
# debt with a 1K fill rate.
write bytes=20477952 label=w1
----

timers
----
00:00:02.000
00:00:09.000

advance wait=true
2s
----
00:00:02.000

await label=w1
----

token-bucket
----
-20000.00 RU filling @ 1000.00 RU/s

# The remaining debt in the token bucket is still greater than what one trickle
# duration can cover. Ensure that another write blocks for entire trickle
# duration, plus another fetch from the server token bucket.
write bytes=1024 label=w2
----

# Wait for 7 more seconds until 90% of the trickle duration is complete and a
# token bucket request is issued.
advance
7s
----
00:00:09.000

wait-for-event
token-bucket-response
----

# Ensure that fill rate has been updated to include RU leftover from previous
# trickle, as well as the RU from the new trickle.
token-bucket
----
-13000.00 RU filling @ 1100.00 RU/s

timers
----
00:00:18.000
00:00:20.818

advance
12s
----
00:00:21.000

wait-for-event
token-bucket-response
----

await label=w2
----
