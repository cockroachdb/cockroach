create-tenant name=with-cap
----
ok

create-tenant name=without-cap
----
ok

# List default value of the unsplit capability.
sql only=system
SELECT * FROM [SHOW TENANTS WITH CAPABILITIES] WHERE capability_id = 'can_admin_scatter'
----
-- system
1 system ready shared can_admin_scatter true
10 with-cap ready none can_admin_scatter true
11 without-cap ready none can_admin_scatter true

update-capabilities
ALTER TENANT 'with-cap' GRANT CAPABILITY can_admin_scatter;
ALTER TENANT 'without-cap' REVOKE CAPABILITY can_admin_scatter;
----
ok

sql only=system
SELECT * FROM [SHOW TENANTS WITH CAPABILITIES] WHERE capability_id = 'can_admin_scatter'
----
-- system
1 system ready shared can_admin_scatter true
10 with-cap ready none can_admin_scatter true
11 without-cap ready none can_admin_scatter false

sql statement
CREATE TABLE t(a INT)
----
-- system
ok
-- with-cap
ok
-- without-cap
ok

sql statement
CREATE INDEX idx on t(a)
----
-- system
ok
-- with-cap
ok
-- without-cap
ok

sql statement
ALTER TABLE t SCATTER
----
-- system
ok
-- with-cap
ok
-- without-cap
ERROR: pq: ba: AdminScatter [/Tenant/11/Table/104/1,/Tenant/11/Table/104/2) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)

sql statement
ALTER INDEX t@idx SCATTER
----
-- system
ok
-- with-cap
ok
-- without-cap
ERROR: pq: ba: AdminScatter [/Tenant/11/Table/104/2,/Tenant/11/Table/104/3) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)


update-capabilities
ALTER TENANT 'with-cap' GRANT CAPABILITY can_admin_scatter=false
----
ok

sql statement
ALTER TABLE t SCATTER
----
-- system
ok
-- with-cap
ERROR: pq: ba: AdminScatter [/Tenant/10/Table/104/1,/Tenant/10/Table/104/2) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)
-- without-cap
ERROR: pq: ba: AdminScatter [/Tenant/11/Table/104/1,/Tenant/11/Table/104/2) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)

sql statement
ALTER INDEX t@idx SCATTER
----
-- system
ok
-- with-cap
ERROR: pq: ba: AdminScatter [/Tenant/10/Table/104/2,/Tenant/10/Table/104/3) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)
-- without-cap
ERROR: pq: ba: AdminScatter [/Tenant/11/Table/104/2,/Tenant/11/Table/104/3) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)

# Grant the capability with explicit syntax.
update-capabilities
ALTER TENANT 'with-cap' GRANT CAPABILITY can_admin_scatter = true
----
ok

sql statement
ALTER TABLE t SCATTER
----
-- system
ok
-- with-cap
ok
-- without-cap
ERROR: pq: ba: AdminScatter [/Tenant/11/Table/104/1,/Tenant/11/Table/104/2) RPC error: rpc error: code = Unauthenticated desc = client tenant does not have capability "can_admin_scatter" (*kvpb.AdminScatterRequest)
