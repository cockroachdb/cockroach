new-cluster localities=us-east-1,us-east-1,us-east-1,us-west-1,us-central-1,eu-central-1
----

exec-sql idx=0
CREATE DATABASE db PRIMARY REGION "us-east-1" REGIONS  "us-west-1", "us-central-1";
----

exec-sql idx=0
CREATE TABLE db.rbt(k INT PRIMARY KEY, v INT) LOCALITY REGIONAL BY TABLE IN "us-east-1";
----

exec-sql idx=0
INSERT INTO db.rbt VALUES (1, 1), (2,2)
----

wait-for-zone-config-changes idx=0 table-name=rbt
0=leaseholder, 1=voter, 2=voter, 3=nonvoter, 4=nonvoter, 5=not-present
----

# Sleep to ensure we can get follower reads.
sleep duration=6s
----

# trace-sql idx=0
# SELECT * FROM db.rbt WHERE k = 1
# ----
# served locally: true
# served via follower read: false
#
# refresh-range-descriptor-cache idx=3 table-name=rbt
# SELECT * FROM db.rbt WHERE k = 1
# ----
# LAG_BY_CLUSTER_SETTING
#
# # us-west-1 should be able to serve follower reads.
# trace-sql idx=3
# SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
# ----
# served locally: true
# served via follower read: true

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# Note that eu-central-1 is not a region on the database, therefore it shouldn't
# have a replica to serve the query locally. It also should not be able to serve
# a follower read.
trace-sql idx=5
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

cleanup-cluster
----
