new-cluster localities=us-east-1,us-east-1,us-east-1,us-west-1,us-central-1,eu-central-1
----

exec-sql idx=0
CREATE DATABASE db PRIMARY REGION "us-east-1" REGIONS  "us-west-1", "us-central-1";
----

exec-sql idx=0
CREATE TABLE db.rbt(k INT PRIMARY KEY, v INT) LOCALITY REGIONAL BY TABLE IN "us-east-1";
----

exec-sql idx=0
INSERT INTO db.rbt VALUES (1, 1), (2,2)
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=2 lease-holder-node=0
----

trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false

refresh-range-descriptor-cache idx=1 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=1
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=2 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=2
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

# Sleep to ensure we can get follower reads.
sleep duration=6s
----

refresh-range-descriptor-cache idx=3 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# us-west-1 should be able to serve follower reads.
trace-sql idx=3
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# Note that eu-central-1 is not a region on the database, therefore it shouldn't
# have a replica to serve the query locally. It also should not be able to serve
# a follower read.
trace-sql idx=5
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

trace-sql idx=5
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

exec-sql idx=0
ALTER TABLE db.rbt SET LOCALITY REGIONAL BY TABLE IN "us-west-1";
----

wait-for-zone-config-changes idx=3 table-name=rbt num-voters=3 num-non-voters=2 lease-holder-node=3
----

refresh-range-descriptor-cache idx=0 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=3 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=3
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false

# We'll now drop us-central-1 from our regions and ensure that
# follower reads can no longer be performed.

# Sleep to ensure we can get follower reads post region change.
sleep duration=6s
----

refresh-range-descriptor-cache idx=4 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# us-central-1 should be able to serve follower reads.
trace-sql idx=4
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: true
served via follower read: true

exec-sql idx=0
ALTER DATABASE db DROP REGION "us-central-1";
----

wait-for-zone-config-changes idx=3 table-name=rbt num-voters=3 num-non-voters=1 lease-holder-node=3
----

# Sleep to ensure we can get follower reads post region change.
sleep duration=6s
----

refresh-range-descriptor-cache idx=4 table-name=rbt
SELECT * FROM db.rbt WHERE k = 1
----
LAG_BY_CLUSTER_SETTING

# us-central-1 now should not be able to serve follower reads.
trace-sql idx=4
SELECT * FROM db.rbt AS OF SYSTEM TIME follower_read_timestamp() WHERE k = 1
----
served locally: false

# Finally, we'll test out region survivability. First, we'll add all regions to the
# database. This should leave us with 3 voters (all in us-east1) and 3 non-voters

exec-sql idx=0
ALTER TABLE db.rbt SET LOCALITY REGIONAL BY TABLE IN "us-east-1";
----

exec-sql idx=0
ALTER DATABASE db ADD REGION "us-central-1"
----

exec-sql idx=0
ALTER DATABASE db ADD REGION "eu-central-1"
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=3 lease-holder-node=0
----

# We now modify to region survivability. This should bring us down to 5 replicas since we can't have
# 3 in us-east-1 without losing quorum in the case of failure in us-east1.

exec-sql idx=0
ALTER DATABASE db SURVIVE REGION FAILURE
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=5 num-non-voters=0 lease-holder-node=0
----
