new-cluster localities=us-east-1,us-east-1,us-east-1,us-west-1,us-central-1,eu-central-1
----

exec-sql idx=0
CREATE DATABASE db PRIMARY REGION "us-east-1" REGIONS  "us-west-1", "us-central-1";
----

exec-sql idx=0
CREATE TABLE db.rbt(k INT PRIMARY KEY, v INT) LOCALITY REGIONAL BY TABLE IN "us-east-1";
----

exec-sql idx=0
INSERT INTO db.rbt VALUES (1, 1), (2,2)
----

wait-for-zone-config-changes idx=0 table-name=rbt num-voters=3 num-non-voters=2 lease-holder-node=0
----

refresh-range-descriptor-cache idx=0 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false

refresh-range-descriptor-cache idx=1 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=1
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=2 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=2
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=5 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

# Note that eu-central-1 is not a region on the database, therefore it shouldn't
# have a replica to serve the query locally.
trace-sql idx=5
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

exec-sql idx=0
ALTER TABLE db.rbt SET LOCALITY REGIONAL BY TABLE IN "us-west-1";
----

wait-for-zone-config-changes idx=3 table-name=rbt num-voters=3 num-non-voters=2 lease-holder-node=3
----

refresh-range-descriptor-cache idx=0 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=0
SELECT * FROM db.rbt WHERE k = 1
----
served locally: false

refresh-range-descriptor-cache idx=3 table-name=rbt
SELECT * FROM db.rbt WHERE k = 2
----
LAG_BY_CLUSTER_SETTING

trace-sql idx=3
SELECT * FROM db.rbt WHERE k = 1
----
served locally: true
served via follower read: false
