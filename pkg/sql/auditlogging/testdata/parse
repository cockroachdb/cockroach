
subtest not_enough_inputs

line
test_role
----
error: end-of-line before statement types specification

subtest end

subtest too_many_inputs

line
test_role DML unexpected
----
error: too many fields specified

subtest end

subtest invalid_role_inputs

# Multi-role input
line
test_role,test_role2 DDL
----
error: multiple values specified for role

# 'public' reserved role input
line
public DDL
----
error: cannot use reserved role name: 'public'

# 'none' reserved role input
line
none DDL
----
error: cannot use reserved role name: 'none'

# 'node' reserved role input
line
node DDL
----
error: cannot use reserved username: 'node'

# 'pg_' prefix reserved role input
line
pg_test_role DDL
----
error: cannot use 'pg_' prefix in role name: 'pg_test_role'

# 'crdb_internal_' prefix reserved role input
line
crdb_internal_test_role DDL
----
error: cannot use 'crdb_internal_' prefix in role name: 'crdb_internal_test_role'

subtest end

subtest inputs_normalized

line
TeSt_ROLe DdL,dcL,dMl
----
# Original configuration:
# TeSt_ROLe DdL,dcL,dMl
#
# Interpreted configuration:
# ROLE    STATEMENT_TYPE
test_role TypeDDL,TypeDCL,TypeDML

subtest end

subtest invalid_statement_types

# Single unknown statement type
line
test_role not_a_statement_type
----
error: unknown statement type: "not_a_statement_type" (valid types include: "DDL", "DML", "DCL", "ALL", "NONE")

# Multi statement type including unknown
line
test_role DDL,DML,DCL,fake
----
error: unknown statement type: "fake" (valid types include: "DDL", "DML", "DCL", "ALL", "NONE")

# Redundant statement types with "ALL"
line
test_role DDL,DCL,ALL
----
error: redundant statement types with "ALL"

# Redundant statement types with "NONE"
line
test_role DDL,DCL,NONE
----
error: redundant statement types with "NONE"

subtest end

subtest quoted_columns

line
"test_role" DDL,DML,DCL
----
# Original configuration:
# "test_role" DDL,DML,DCL
#
# Interpreted configuration:
# ROLE    STATEMENT_TYPE
test_role TypeDDL,TypeDML,TypeDCL

# Quoting the collection of statement types is not recognized.
line
"test_role" "DDL,DML,DCL"
----
error: unknown statement type: "DDL,DML,DCL" (valid types include: "DDL", "DML", "DCL", "ALL", "NONE")

# Individually quoted statement types are recognized.
line
test_role "DDL","DML","DCL"
----
# Original configuration:
# test_role "DDL","DML","DCL"
#
# Interpreted configuration:
# ROLE    STATEMENT_TYPE
test_role TypeDDL,TypeDML,TypeDCL

# Single quoted statement types are not recognized.
line
test_role 'DDL',DML,DCL
----
error: unknown statement type: "'DDL'" (valid types include: "DDL", "DML", "DCL", "ALL", "NONE")

subtest end

subtest special_statement_types

line
test_role ALL
----
# Original configuration:
# test_role ALL
#
# Interpreted configuration:
# ROLE    STATEMENT_TYPE
test_role TypeDCL,TypeDDL,TypeDML

line
test_role NONE
----
# Original configuration:
# test_role NONE
#
# Interpreted configuration:
# ROLE    STATEMENT_TYPE
test_role NONE

subtest end

subtest all_role

line
all DCL,DML
----
# Original configuration:
# all DCL,DML
#
# Interpreted configuration:
# ROLE STATEMENT_TYPE
all    TypeDCL,TypeDML

subtest end

subtest multiline_entries

# no duplicate role entries
multiline
test_role DCL,DML
test_role ALL
----
error: duplicate role listed: test_role

multiline
test_role ALL
anotherRole DML,DCL,DDL
thirddRole "DML"
----
# String render check:
# Original configuration:
# test_role ALL
# anotherRole DML,DCL,DDL
# thirddRole "DML"
#
# Interpreted configuration:
# ROLE      STATEMENT_TYPE
test_role   TypeDCL,TypeDDL,TypeDML
anotherrole TypeDML,TypeDCL,TypeDDL
thirddrole  TypeDML
# Detail:
&auditlogging.AuditConfig{
    settings: {
        {
            input:          "test_role ALL",
            Role:           username.SQLUsername{u:"test_role"},
            StatementTypes: {0:1, 1:2, 2:0},
        },
        {
            input:          "anotherRole DML,DCL,DDL",
            Role:           username.SQLUsername{u:"anotherrole"},
            StatementTypes: {0:2, 1:0, 2:1},
        },
        {
            input:          "thirddRole \"DML\"",
            Role:           username.SQLUsername{u:"thirddrole"},
            StatementTypes: {1:0},
        },
    },
    allRoleAuditSettingIdx: -1,
}

# Test ALL role
multiline
test_role ALL
anotherRole DML,DCL,DDL
all ALL
thirddRole "DML"
----
# String render check:
# Original configuration:
# test_role ALL
# anotherRole DML,DCL,DDL
# all ALL
# thirddRole "DML"
#
# Interpreted configuration:
# ROLE      STATEMENT_TYPE
test_role   TypeDCL,TypeDDL,TypeDML
anotherrole TypeDML,TypeDCL,TypeDDL
all         TypeDCL,TypeDDL,TypeDML
thirddrole  TypeDML
# Detail:
&auditlogging.AuditConfig{
    settings: {
        {
            input:          "test_role ALL",
            Role:           username.SQLUsername{u:"test_role"},
            StatementTypes: {0:1, 1:2, 2:0},
        },
        {
            input:          "anotherRole DML,DCL,DDL",
            Role:           username.SQLUsername{u:"anotherrole"},
            StatementTypes: {0:2, 1:0, 2:1},
        },
        {
            input:          "all ALL",
            Role:           username.SQLUsername{u:"all"},
            StatementTypes: {0:1, 1:2, 2:0},
        },
        {
            input:          "thirddRole \"DML\"",
            Role:           username.SQLUsername{u:"thirddrole"},
            StatementTypes: {1:0},
        },
    },
    allRoleAuditSettingIdx: 2,
}

# Test NONE statement types
multiline
test_role NONE
anotherRole DML,DCL,DDL
thirddRole "DML"
all ALL
----
# String render check:
# Original configuration:
# test_role NONE
# anotherRole DML,DCL,DDL
# thirddRole "DML"
# all ALL
#
# Interpreted configuration:
# ROLE      STATEMENT_TYPE
test_role   NONE
anotherrole TypeDML,TypeDCL,TypeDDL
thirddrole  TypeDML
all         TypeDCL,TypeDDL,TypeDML
# Detail:
&auditlogging.AuditConfig{
    settings: {
        {
            input:          "test_role NONE",
            Role:           username.SQLUsername{u:"test_role"},
            StatementTypes: {},
        },
        {
            input:          "anotherRole DML,DCL,DDL",
            Role:           username.SQLUsername{u:"anotherrole"},
            StatementTypes: {0:2, 1:0, 2:1},
        },
        {
            input:          "thirddRole \"DML\"",
            Role:           username.SQLUsername{u:"thirddrole"},
            StatementTypes: {1:0},
        },
        {
            input:          "all ALL",
            Role:           username.SQLUsername{u:"all"},
            StatementTypes: {0:1, 1:2, 2:0},
        },
    },
    allRoleAuditSettingIdx: 3,
}

subtest end
