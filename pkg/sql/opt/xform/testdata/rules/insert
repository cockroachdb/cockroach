####################
#  InsertFastPath  #
####################

exec-ddl
CREATE TABLE t (
  k INT PRIMARY KEY,
  r STRING NOT NULL,
  a INT,
  b INT,
  INDEX (r, a) WHERE k != 1,
  UNIQUE WITHOUT INDEX (a) WHERE k != 1,
  CHECK (r IN ('east', 'west'))
)
----

# Fast path is not allowed when there is a UNIQUE WITHOUT INDEX with a 
# partial index predicate.
opt expect-not=InsertFastPath
INSERT INTO t VALUES (1, 'east', 10, 100)
----
insert t
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => t.k:1
 │    ├── column2:8 => t.r:2
 │    ├── column3:9 => t.a:3
 │    └── column4:10 => t.b:4
 ├── check columns: check1:11
 ├── partial index put columns: partial_index_put1:12
 ├── cardinality: [0 - 0]
 ├── volatile, mutations
 ├── values
 │    ├── columns: column1:7!null column2:8!null column3:9!null column4:10!null check1:11!null partial_index_put1:12!null
 │    ├── cardinality: [1 - 1]
 │    ├── key: ()
 │    ├── fd: ()-->(7-12)
 │    └── (1, 'east', 10, 100, true, false)
 └── unique-checks
      └── unique-checks-item: t(a)
           └── values
                ├── columns: a:21!null
                ├── cardinality: [0 - 0]
                ├── key: ()
                └── fd: ()-->(21)

exec-ddl
DROP TABLE t
----

exec-ddl
CREATE TABLE t (
  k INT PRIMARY KEY,
  r STRING NOT NULL,
  a INT,
  b INT AS (k % 9) STORED,
  INDEX (b, r, a),
  UNIQUE WITHOUT INDEX (a),
  CHECK (r IN ('east', 'west'))
)
----

# A computed leading index column allows fast path uniqueness checks.
opt expect-not=InsertFastPath
INSERT INTO t (k, r, a) VALUES (2, 'east', 10)
----
insert t
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => t.k:1
 │    ├── column2:8 => t.r:2
 │    ├── column3:9 => t.a:3
 │    └── b_comp:10 => t.b:4
 ├── check columns: check1:11
 ├── cardinality: [0 - 0]
 ├── volatile, mutations
 ├── values
 │    ├── columns: column1:7!null column2:8!null column3:9!null b_comp:10!null check1:11!null
 │    ├── cardinality: [1 - 1]
 │    ├── key: ()
 │    ├── fd: ()-->(7-11)
 │    └── (2, 'east', 10, 2, true)
 └── unique-checks
      └── unique-checks-item: t(a)
           └── project
                ├── columns: a:20!null
                ├── cardinality: [0 - 1]
                ├── key: ()
                ├── fd: ()-->(20)
                └── project
                     ├── columns: a:20!null
                     ├── cardinality: [0 - 1]
                     ├── key: ()
                     ├── fd: ()-->(20)
                     └── inner-join (cross)
                          ├── columns: t.k:12!null t.a:14!null a:20!null
                          ├── cardinality: [0 - 1]
                          ├── multiplicity: left-rows(zero-or-one), right-rows(exactly-one)
                          ├── key: ()
                          ├── fd: ()-->(12,14,20)
                          ├── values
                          │    ├── columns: a:20!null
                          │    ├── cardinality: [1 - 1]
                          │    ├── key: ()
                          │    ├── fd: ()-->(20)
                          │    └── (10,)
                          ├── limit
                          │    ├── columns: t.k:12!null t.a:14!null
                          │    ├── cardinality: [0 - 1]
                          │    ├── key: ()
                          │    ├── fd: ()-->(12,14)
                          │    ├── select
                          │    │    ├── columns: t.k:12!null t.a:14!null
                          │    │    ├── key: (12)
                          │    │    ├── fd: ()-->(14)
                          │    │    ├── limit hint: 1.00
                          │    │    ├── scan t
                          │    │    │    ├── columns: t.k:12!null t.a:14
                          │    │    │    ├── constraint: /12
                          │    │    │    │    ├── [ - /1]
                          │    │    │    │    └── [/3 - ]
                          │    │    │    ├── key: (12)
                          │    │    │    ├── fd: (12)-->(14)
                          │    │    │    └── limit hint: 35.71
                          │    │    └── filters
                          │    │         └── t.a:14 = 10 [outer=(14), constraints=(/14: [/10 - /10]; tight), fd=()-->(14)]
                          │    └── 1
                          └── filters (true)

exec-ddl
DROP TABLE t
----

exec-ddl
CREATE TABLE t (
  k INT PRIMARY KEY,
  r STRING NOT NULL,
  a INT,
  b INT AS (k % 9) STORED,
  INDEX (a),
  INDEX (r, a, b),
  INDEX (b, a),
  UNIQUE WITHOUT INDEX (a),
  UNIQUE WITHOUT INDEX (b),
  UNIQUE WITHOUT INDEX (r, a, b),
  UNIQUE WITHOUT INDEX (a, b),
  CHECK (r IN ('east', 'west'))
)
----

# An insert to a table with multiple unique without index checks can utilize fast path.
opt expect=InsertFastPath
INSERT INTO t (k, r, a) VALUES (2, 'east', 10)
----
insert t
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => t.k:1
 │    ├── column2:8 => t.r:2
 │    ├── column3:9 => t.a:3
 │    └── b_comp:10 => t.b:4
 ├── check columns: check1:11
 ├── cardinality: [0 - 0]
 ├── volatile, mutations
 ├── values
 │    ├── columns: column1:7!null column2:8!null column3:9!null b_comp:10!null check1:11!null
 │    ├── cardinality: [1 - 1]
 │    ├── key: ()
 │    ├── fd: ()-->(7-11)
 │    └── (2, 'east', 10, 2, true)
 └── unique-checks
      ├── unique-checks-item: t(a)
      │    └── project
      │         ├── columns: a:20!null
      │         ├── cardinality: [0 - 1]
      │         ├── key: ()
      │         ├── fd: ()-->(20)
      │         └── project
      │              ├── columns: a:20!null
      │              ├── cardinality: [0 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(20)
      │              └── inner-join (cross)
      │                   ├── columns: t.k:12!null t.a:14!null a:20!null
      │                   ├── cardinality: [0 - 1]
      │                   ├── multiplicity: left-rows(zero-or-one), right-rows(exactly-one)
      │                   ├── key: ()
      │                   ├── fd: ()-->(12,14,20)
      │                   ├── values
      │                   │    ├── columns: a:20!null
      │                   │    ├── cardinality: [1 - 1]
      │                   │    ├── key: ()
      │                   │    ├── fd: ()-->(20)
      │                   │    └── (10,)
      │                   ├── scan t@t_a_idx
      │                   │    ├── columns: t.k:12!null t.a:14!null
      │                   │    ├── constraint: /14/12
      │                   │    │    ├── [/10 - /10/1]
      │                   │    │    └── [/10/3 - /10]
      │                   │    ├── limit: 1
      │                   │    ├── key: ()
      │                   │    └── fd: ()-->(12,14)
      │                   └── filters (true)
      ├── unique-checks-item: t(b)
      │    └── project
      │         ├── columns: b:37!null
      │         ├── cardinality: [0 - 1]
      │         ├── key: ()
      │         ├── fd: ()-->(37)
      │         └── project
      │              ├── columns: b:37!null
      │              ├── cardinality: [0 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(37)
      │              └── inner-join (cross)
      │                   ├── columns: t.k:28!null t.b:31!null b:37!null
      │                   ├── cardinality: [0 - 1]
      │                   ├── multiplicity: left-rows(zero-or-one), right-rows(exactly-one)
      │                   ├── key: ()
      │                   ├── fd: ()-->(28,31,37)
      │                   ├── values
      │                   │    ├── columns: b:37!null
      │                   │    ├── cardinality: [1 - 1]
      │                   │    ├── key: ()
      │                   │    ├── fd: ()-->(37)
      │                   │    └── (2,)
      │                   ├── limit
      │                   │    ├── columns: t.k:28!null t.b:31!null
      │                   │    ├── cardinality: [0 - 1]
      │                   │    ├── key: ()
      │                   │    ├── fd: ()-->(28,31)
      │                   │    ├── select
      │                   │    │    ├── columns: t.k:28!null t.b:31!null
      │                   │    │    ├── key: (28)
      │                   │    │    ├── fd: ()-->(31)
      │                   │    │    ├── limit hint: 1.00
      │                   │    │    ├── scan t@t_b_a_idx
      │                   │    │    │    ├── columns: t.k:28!null t.b:31!null
      │                   │    │    │    ├── constraint: /31/30/28: [/2 - /2]
      │                   │    │    │    ├── key: (28)
      │                   │    │    │    ├── fd: ()-->(31)
      │                   │    │    │    └── limit hint: 1.07
      │                   │    │    └── filters
      │                   │    │         └── t.k:28 != 2 [outer=(28), constraints=(/28: (/NULL - /1] [/3 - ]; tight)]
      │                   │    └── 1
      │                   └── filters (true)
      ├── unique-checks-item: t(r,a,b)
      │    └── project
      │         ├── columns: r:51!null a:52!null b:53!null
      │         ├── cardinality: [0 - 1]
      │         ├── key: ()
      │         ├── fd: ()-->(51-53)
      │         └── project
      │              ├── columns: r:51!null a:52!null b:53!null
      │              ├── cardinality: [0 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(51-53)
      │              └── inner-join (cross)
      │                   ├── columns: t.k:44!null t.r:45!null t.a:46!null t.b:47!null r:51!null a:52!null b:53!null
      │                   ├── cardinality: [0 - 1]
      │                   ├── multiplicity: left-rows(zero-or-one), right-rows(exactly-one)
      │                   ├── key: ()
      │                   ├── fd: ()-->(44-47,51-53)
      │                   ├── values
      │                   │    ├── columns: r:51!null a:52!null b:53!null
      │                   │    ├── cardinality: [1 - 1]
      │                   │    ├── key: ()
      │                   │    ├── fd: ()-->(51-53)
      │                   │    └── ('east', 10, 2)
      │                   ├── scan t@t_r_a_b_idx
      │                   │    ├── columns: t.k:44!null t.r:45!null t.a:46!null t.b:47!null
      │                   │    ├── constraint: /45/46/47/44
      │                   │    │    ├── [/'east'/10/2 - /'east'/10/2/1]
      │                   │    │    └── [/'east'/10/2/3 - /'east'/10/2]
      │                   │    ├── limit: 1
      │                   │    ├── key: ()
      │                   │    └── fd: ()-->(44-47)
      │                   └── filters (true)
      └── unique-checks-item: t(a,b)
           └── project
                ├── columns: a:68!null b:69!null
                ├── cardinality: [0 - 1]
                ├── key: ()
                ├── fd: ()-->(68,69)
                └── project
                     ├── columns: a:68!null b:69!null
                     ├── cardinality: [0 - 1]
                     ├── key: ()
                     ├── fd: ()-->(68,69)
                     └── inner-join (cross)
                          ├── columns: t.k:60!null t.a:62!null t.b:63!null a:68!null b:69!null
                          ├── cardinality: [0 - 1]
                          ├── multiplicity: left-rows(zero-or-one), right-rows(exactly-one)
                          ├── key: ()
                          ├── fd: ()-->(60,62,63,68,69)
                          ├── values
                          │    ├── columns: a:68!null b:69!null
                          │    ├── cardinality: [1 - 1]
                          │    ├── key: ()
                          │    ├── fd: ()-->(68,69)
                          │    └── (10, 2)
                          ├── scan t@t_b_a_idx
                          │    ├── columns: t.k:60!null t.a:62!null t.b:63!null
                          │    ├── constraint: /63/62/60
                          │    │    ├── [/2/10 - /2/10/1]
                          │    │    └── [/2/10/3 - /2/10]
                          │    ├── limit: 1
                          │    ├── key: ()
                          │    └── fd: ()-->(60,62,63)
                          └── filters (true)
