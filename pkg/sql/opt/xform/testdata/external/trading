# =============================================================================
# This schema is based on a business buying/selling online trading cards. This
# file simulates queries taking place while schema changes are *not* taking
# place. See the trading-mutation file for the same queries running against
# tables with simulated schema changes in progress.
# =============================================================================

# --------------------------------------------------
# Schema Definitions
# --------------------------------------------------

# Cards is the catalog of all cards that can be traded.
exec-ddl
CREATE TABLE Cards
(
  id INT NOT NULL,
  name VARCHAR(128) NOT NULL,
  rarity VARCHAR(1) NULL,
  setname VARCHAR(5) NULL,
  number INT NOT NULL,
  isfoil BIT NOT NULL,
  CONSTRAINT CardsPrimaryKey PRIMARY KEY
  (
    id ASC
  ),
  CONSTRAINT CardsNameSetNumber UNIQUE
  (
    name ASC,
    setname ASC,
    number ASC
  )
)
----

exec-ddl
ALTER TABLE Cards INJECT STATISTICS '[
  {
    "columns": ["id"],
    "distinct_count": 57000,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["name"],
    "distinct_count": 39000,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["setname"],
    "distinct_count": 162,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["number"],
    "distinct_count": 829,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["name", "setname"],
    "distinct_count": 56700,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["name", "setname", "number"],
    "distinct_count": 57000,
    "null_count": 0,
    "row_count": 57000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# CardsInfo tracks current inventory of each card, as well as current buy/sell
# price. It is partitioned on dealerid, which represents multiple licensees
# (dealers) using the trading software.
exec-ddl
CREATE TABLE CardsInfo
(
  dealerid OID NOT NULL,
  cardid INT NOT NULL,
  buyprice DECIMAL(10,4) NOT NULL,
  sellprice DECIMAL(10,4) NOT NULL,
  discount DECIMAL(10,4) NOT NULL,
  desiredinventory INT NOT NULL,
  actualinventory INT NOT NULL,
  maxinventory INT NOT NULL,
  version DECIMAL NOT NULL DEFAULT (cluster_logical_timestamp()),
  CONSTRAINT CardsInfoPrimaryKey PRIMARY KEY
  (
    dealerid ASC,
    cardid ASC
  ),
  CONSTRAINT CardsInfoCardIdKey FOREIGN KEY (cardid)
  REFERENCES Cards (id),
  UNIQUE INDEX CardsInfoVersionIndex (dealerid ASC, version ASC)
)
----

exec-ddl
ALTER TABLE CardsInfo INJECT STATISTICS '[
  {
    "columns": ["dealerid"],
    "distinct_count": 12,
    "null_count": 0,
    "row_count": 700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["cardid"],
    "distinct_count": 57000,
    "null_count": 0,
    "row_count": 700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["version"],
    "distinct_count": 700000,
    "null_count": 0,
    "row_count": 700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00",
    "histo_col_type": "decimal",
    "histo_buckets": [
      {"num_eq": 0, "num_range": 0, "distinct_range": 0, "upper_bound": "1426741777604892000"},
      {"num_eq": 0, "num_range": 350000, "distinct_range": 350000, "upper_bound": "1584421693935036000"}
    ]
  },
  {
    "columns": ["dealerid", "cardid"],
    "distinct_count": 700000,
    "null_count": 0,
    "row_count": 700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "version"],
    "distinct_count": 700000,
    "null_count": 0,
    "row_count": 700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# InventoryDetails stores the quantity and location of all the cards.
exec-ddl
CREATE TABLE InventoryDetails
(
  dealerid OID NOT NULL,
  cardid INT NOT NULL,
  accountname VARCHAR(128) NOT NULL,
  quantity INT NOT NULL,
  version DECIMAL NOT NULL DEFAULT (cluster_logical_timestamp()),
  CONSTRAINT InventoryDetailsPrimaryKey PRIMARY KEY
  (
    dealerid ASC,
    cardid ASC,
    accountname ASC
  ),
  CONSTRAINT InventoryDetailsCardIdKey FOREIGN KEY (cardid)
  REFERENCES Cards (id)
)
----

exec-ddl
ALTER TABLE InventoryDetails INJECT STATISTICS '[
  {
    "columns": ["dealerid"],
    "distinct_count": 12,
    "null_count": 0,
    "row_count": 1700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["cardid"],
    "distinct_count": 50000,
    "null_count": 0,
    "row_count": 1700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["accountname"],
    "distinct_count": 150,
    "null_count": 0,
    "row_count": 1700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "cardid"],
    "distinct_count": 250000,
    "null_count": 0,
    "row_count": 1700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "cardid", "accountname"],
    "distinct_count": 170000,
    "null_count": 0,
    "row_count": 1700000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# Transactions records all buy/sell trading activity.
#
# NOTE: The TransactionsOpIndex is meant to be a partial index, only containing
#       non-NULL values. The operationid column is for idempotency, and
#       older values get set to NULL after X hours to save space. 99%+ of values
#       are NULL.
exec-ddl
CREATE TABLE Transactions
(
  dealerid OID NOT NULL,
  isbuy BOOL NOT NULL,
  date TIMESTAMPTZ NOT NULL,
  accountname VARCHAR(128) NOT NULL,
  customername VARCHAR(128) NOT NULL,
  operationid UUID,
  version DECIMAL NOT NULL DEFAULT (cluster_logical_timestamp()),
  CONSTRAINT TransactionsPrimaryKey PRIMARY KEY
  (
    dealerid ASC,
    isbuy ASC,
    date ASC
  ),
  UNIQUE INDEX TransactionsOpIndex (dealerid ASC, operationid ASC)
  --WHERE operationid IS NOT NULL
)
----

exec-ddl
ALTER TABLE Transactions INJECT STATISTICS '[
  {
    "columns": ["dealerid"],
    "distinct_count": 10,
    "null_count": 0,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["isbuy"],
    "distinct_count": 2,
    "null_count": 0,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["date"],
    "distinct_count": 20000000,
    "null_count": 0,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["operationid"],
    "distinct_count": 4000,
    "null_count": 19996000,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy"],
    "distinct_count": 15,
    "null_count": 0,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy", "date"],
    "distinct_count": 20000000,
    "null_count": 0,
    "row_count": 20000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# TransactionDetails records line items of each Transaction.
exec-ddl
CREATE TABLE TransactionDetails
(
  dealerid OID NOT NULL,
  isbuy BOOL NOT NULL,
  transactiondate TIMESTAMPTZ NOT NULL,
  cardid INT NOT NULL,
  quantity INT NOT NULL,
  sellprice DECIMAL(10,4) NOT NULL,
  buyprice DECIMAL(10,4) NOT NULL,
  version DECIMAL NOT NULL DEFAULT (cluster_logical_timestamp()),
  CONSTRAINT DetailsPrimaryKey PRIMARY KEY
  (
    dealerid ASC,
    isbuy ASC,
    transactiondate ASC,
    cardid ASC,
    quantity ASC
  ),
  CONSTRAINT DetailsDealerDateKey FOREIGN KEY (dealerid, isbuy, transactiondate)
  REFERENCES Transactions (dealerid, isbuy, date),
  CONSTRAINT DetailsCardIdKey FOREIGN KEY (cardid)
  REFERENCES Cards (id),
  INDEX DetailsCardIdIndex (dealerid ASC, isbuy ASC, cardid ASC)
)
----

exec-ddl
ALTER TABLE TransactionDetails INJECT STATISTICS '[
  {
    "columns": ["dealerid"],
    "distinct_count": 10,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["isbuy"],
    "distinct_count": 2,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["transactiondate"],
    "distinct_count": 180000000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["cardid"],
    "distinct_count": 57000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy"],
    "distinct_count": 15,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy", "transactiondate"],
    "distinct_count": 20000000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy", "transactiondate", "cardid"],
    "distinct_count": 180000000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy", "transactiondate", "cardid", "quantity"],
    "distinct_count": 180000000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "isbuy", "cardid"],
    "distinct_count": 350000,
    "null_count": 0,
    "row_count": 180000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# PriceDetails records price history for each card.
exec-ddl
CREATE TABLE PriceDetails
(
    dealerid OID NOT NULL,
    cardid INT NOT NULL,
    pricedate TIMESTAMPTZ NOT NULL,
    pricedby VARCHAR(128) NOT NULL,
    buyprice DECIMAL(10,4) NOT NULL,
    sellprice DECIMAL(10,4) NOT NULL,
    discount DECIMAL(10,4) NOT NULL,
    version DECIMAL NOT NULL,
    CONSTRAINT PriceDetailsPrimaryKey PRIMARY KEY
    (
        dealerid ASC,
        cardid ASC,
        pricedate ASC
    ),
    CONSTRAINT PriceDetailsCardIdKey FOREIGN KEY (cardid)
    REFERENCES Cards (id)
)
----

exec-ddl
ALTER TABLE PriceDetails INJECT STATISTICS '[
  {
    "columns": ["dealerid"],
    "distinct_count": 2,
    "null_count": 0,
    "row_count": 40000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["cardid"],
    "distinct_count": 57000,
    "null_count": 0,
    "row_count": 40000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["pricedate"],
    "distinct_count": 40000000,
    "null_count": 0,
    "row_count": 40000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "cardid"],
    "distinct_count": 90000,
    "null_count": 0,
    "row_count": 40000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  },
  {
    "columns": ["dealerid", "cardid", "pricedate"],
    "distinct_count": 40000000,
    "null_count": 0,
    "row_count": 40000000,
    "created_at": "2020-01-01 0:00:00.00000+00:00"
  }
]'
----

# NOTE: These views should not be checking for the constant dealerid = 1.
# Instead, the dealerid should be derived from the current user, like this:
#
#   dealerid = (SELECT oid FROM pg_roles WHERE rolname = current_user);
#
# However, the optimizer and execution engine are not smart enough to do a good
# job with this. The following needs to be done:
#
#   1. Optimizer needs access to key information about pg_roles so that it can
#      infer that there will be at most one row that matches the predicate.
#   2. Optimizer needs to replace "current_user" with constant after the query
#      is prepared, as if it were a parameter.
#   3. Execution engine should allow "push down" into virtual tables, or else
#      this query will need to enumerate every user and role in order to find
#      the requested rolname.
#

exec-ddl
CREATE VIEW CardsView AS
    SELECT  id AS Id, name AS Name, rarity AS Rarity, setname AS SetName, number AS Number, isfoil AS IsFoil,
            buyprice AS BuyPrice, sellprice AS SellPrice, discount AS Discount,
            desiredinventory AS DesiredInventory, actualinventory AS ActualInventory,
            maxinventory AS MaxInventory, version AS Version
    FROM Cards
    JOIN CardsInfo
    ON id = cardid
    WHERE dealerid = 1
----

exec-ddl
CREATE VIEW TransactionsView AS
    SELECT
      date AS Date, accountname AS AccountName, customername AS CustomerName,
      isbuy AS IsBuy, operationid AS OperationId
    FROM Transactions
    WHERE dealerid = 1
----

exec-ddl
CREATE VIEW TransactionDetailsView AS
    SELECT  isbuy AS IsBuy, transactiondate AS TransactionDate, cardid AS CardId, quantity AS Quantity,
            sellprice AS SellPrice, buyprice AS BuyPrice
    FROM TransactionDetails
    WHERE dealerid = 1
----

exec-ddl
CREATE VIEW PriceDetailsView AS
    SELECT  cardid AS CardId, pricedate AS PriceDate, pricedby AS PricedBy, buyprice AS BuyPrice,
            sellprice AS SellPrice,
            (
                CASE
                    WHEN dealerid <> 1
                    THEN 0::DECIMAL(10,4)
                    ELSE discount
                END
            ) AS Discount
    FROM PriceDetails
    WHERE dealerid = 1
----

exec-ddl
CREATE VIEW GlobalInventoryView AS
    SELECT cardid, min(buyprice) AS BuyPrice, max(sellprice) AS SellPrice, max(discount) AS Discount,
        sum(desiredinventory) AS DesiredInventory,
        sum
        (
            CASE
                WHEN dealerid = 2 AND actualinventory > 24 THEN 24
                WHEN dealerid <> 1 AND actualinventory > maxinventory THEN maxinventory
                ELSE actualinventory
            END
        ) AS ActualInventory,
        sum(maxinventory) AS MaxInventory,
        max(version) AS Version
    FROM CardsInfo
    INNER JOIN Cards
    ON cardid = id
    WHERE (dealerid = 1 OR dealerid = 2 OR dealerid = 3 OR dealerid = 4)
    GROUP BY cardid
----

exec-ddl
CREATE VIEW GlobalCardsView AS
    SELECT c.id AS Id, c.name AS Name, c.rarity AS Rarity, c.setname AS SetName, c.number AS Number, c.isfoil AS IsFoil,
            inv.BuyPrice, inv.SellPrice, inv.Discount, inv.DesiredInventory, inv.ActualInventory,
            inv.MaxInventory, inv.Version
    FROM Cards c
    INNER JOIN GlobalInventoryView inv
    ON c.id = inv.cardid
----

# --------------------------------------------------
# SELECT Queries
# --------------------------------------------------

# Find all cards that have been modified in the last 5 seconds.
#
# Problems:
#   1. The wrong index is selected because of mismatched row estimates. The
#      CardsInfoVersionIndex should be used instead.
#
opt format=show-stats
SELECT
  Id, Name, Rarity, SetName, Number, IsFoil, BuyPrice, SellPrice,
  DesiredInventory, ActualInventory, Version, Discount, MaxInventory
FROM CardsView WHERE Version > 1584421773604892000.0000000000
----
project
 ├── columns: id:1!null name:2!null rarity:3 setname:4 number:5!null isfoil:6!null buyprice:9!null sellprice:10!null desiredinventory:12!null actualinventory:13!null version:15!null discount:11!null maxinventory:14!null
 ├── stats: [rows=0.3325]
 ├── key: (15)
 ├── fd: (1)-->(2-6,9-15), (2,4,5)~~>(1,3,6), (15)-->(1-6,9-14)
 └── inner-join (lookup cards)
      ├── columns: id:1!null name:2!null rarity:3 setname:4 number:5!null isfoil:6!null dealerid:7!null cardid:8!null buyprice:9!null sellprice:10!null discount:11!null desiredinventory:12!null actualinventory:13!null maxinventory:14!null version:15!null
      ├── key columns: [8] = [1]
      ├── lookup columns are key
      ├── stats: [rows=0.3325, distinct(1)=5.83333167e-06, null(1)=0, distinct(8)=5.83333167e-06, null(8)=0]
      ├── key: (8)
      ├── fd: ()-->(7), (1)-->(2-6), (2,4,5)~~>(1,3,6), (8)-->(9-15), (15)-->(8-14), (1)==(8), (8)==(1)
      ├── select
      │    ├── columns: dealerid:7!null cardid:8!null buyprice:9!null sellprice:10!null discount:11!null desiredinventory:12!null actualinventory:13!null maxinventory:14!null version:15!null
      │    ├── stats: [rows=5.83333333e-06, distinct(7)=5.83333333e-06, null(7)=0, distinct(8)=5.83333167e-06, null(8)=0, distinct(9)=5.83333333e-06, null(9)=0, distinct(10)=5.83333333e-06, null(10)=0, distinct(11)=5.83333333e-06, null(11)=0, distinct(12)=5.83333333e-06, null(12)=0, distinct(13)=5.83333333e-06, null(13)=0, distinct(14)=5.83333333e-06, null(14)=0, distinct(15)=5.83333333e-06, null(15)=0]
      │    │   histogram(15)=
      │    ├── key: (8)
      │    ├── fd: ()-->(7), (8)-->(9-15), (15)-->(8-14)
      │    ├── scan cardsinfo
      │    │    ├── columns: dealerid:7!null cardid:8!null buyprice:9!null sellprice:10!null discount:11!null desiredinventory:12!null actualinventory:13!null maxinventory:14!null version:15!null
      │    │    ├── constraint: /7/8: [/1 - /1]
      │    │    ├── stats: [rows=58333.3333, distinct(7)=1, null(7)=0]
      │    │    ├── key: (8)
      │    │    └── fd: ()-->(7), (8)-->(9-15), (15)-->(8-14)
      │    └── filters
      │         └── version:15 > 1584421773604892000.0000000000 [outer=(15), constraints=(/15: (/1584421773604892000.0000000000 - ]; tight)]
      └── filters (true)

# Get version of last card that was changed.
#
# Problems:
#   1. CardsView is actually a join between Cards and CardsInfo tables. But the
#      optimizer is missing join elimination rules. If those were available, we
#      could eliminate the join to Cards (because of FK).
#   2. InnerJoin can be pushed below GroupBy, which would put the GroupBy as the
#      input of the ScalarGroupBy.
#   3. ScalarGroupBy Max of a GroupBy Max is just ScalarGroupBy Max. Those two
#      would then be collapsed into one.
#   4. Furthermore, the join with the second Cards table could be eliminated,
#      just as with #1.
#
opt format=show-stats
SELECT coalesce(max(Version), 0) FROM GlobalCardsView
----
project
 ├── columns: coalesce:31
 ├── cardinality: [1 - 1]
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(31)
 ├── scalar-group-by
 │    ├── columns: max:30
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(30)
 │    ├── limit
 │    │    ├── columns: c.id:1!null cardid:8!null max:29!null
 │    │    ├── internal-ordering: -29
 │    │    ├── cardinality: [0 - 1]
 │    │    ├── stats: [rows=1]
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(1,8,29)
 │    │    ├── inner-join (lookup cards)
 │    │    │    ├── columns: c.id:1!null cardid:8!null max:29!null
 │    │    │    ├── key columns: [8] = [1]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── stats: [rows=56607.9417, distinct(1)=56607.9417, null(1)=0, distinct(8)=56607.9417, null(8)=0]
 │    │    │    ├── key: (8)
 │    │    │    ├── fd: (8)-->(29), (1)==(8), (8)==(1)
 │    │    │    ├── ordering: -29
 │    │    │    ├── limit hint: 1.00
 │    │    │    ├── sort
 │    │    │    │    ├── columns: cardid:8!null max:29!null
 │    │    │    │    ├── stats: [rows=56607.9417, distinct(8)=56607.9417, null(8)=0, distinct(29)=56607.9417, null(29)=0]
 │    │    │    │    ├── key: (8)
 │    │    │    │    ├── fd: (8)-->(29)
 │    │    │    │    ├── ordering: -29
 │    │    │    │    ├── limit hint: 100.00
 │    │    │    │    └── group-by
 │    │    │    │         ├── columns: cardid:8!null max:29!null
 │    │    │    │         ├── grouping columns: cardid:8!null
 │    │    │    │         ├── stats: [rows=56607.9417, distinct(8)=56607.9417, null(8)=0, distinct(29)=56607.9417, null(29)=0]
 │    │    │    │         ├── key: (8)
 │    │    │    │         ├── fd: (8)-->(29)
 │    │    │    │         ├── inner-join (hash)
 │    │    │    │         │    ├── columns: dealerid:7!null cardid:8!null version:15!null cards.id:16!null
 │    │    │    │         │    ├── stats: [rows=233333.333, distinct(8)=56607.9417, null(8)=0, distinct(16)=56607.9417, null(16)=0]
 │    │    │    │         │    ├── key: (7,16)
 │    │    │    │         │    ├── fd: (7,8)-->(15), (7,15)-->(8), (8)==(16), (16)==(8)
 │    │    │    │         │    ├── scan cardsinfo@cardsinfoversionindex
 │    │    │    │         │    │    ├── columns: dealerid:7!null cardid:8!null version:15!null
 │    │    │    │         │    │    ├── constraint: /7/15: [/1 - /4]
 │    │    │    │         │    │    ├── stats: [rows=233333.333, distinct(7)=4, null(7)=0, distinct(8)=56607.9417, null(8)=0, distinct(15)=233333.333, null(15)=0]
 │    │    │    │         │    │    ├── key: (7,8)
 │    │    │    │         │    │    └── fd: (7,8)-->(15), (7,15)-->(8)
 │    │    │    │         │    ├── scan cards@cardsnamesetnumber
 │    │    │    │         │    │    ├── columns: cards.id:16!null
 │    │    │    │         │    │    ├── stats: [rows=57000, distinct(16)=57000, null(16)=0]
 │    │    │    │         │    │    └── key: (16)
 │    │    │    │         │    └── filters
 │    │    │    │         │         └── cardid:8 = cards.id:16 [outer=(8,16), constraints=(/8: (/NULL - ]; /16: (/NULL - ]), fd=(8)==(16), (16)==(8)]
 │    │    │    │         └── aggregations
 │    │    │    │              └── max [as=max:29, outer=(15)]
 │    │    │    │                   └── version:15
 │    │    │    └── filters (true)
 │    │    └── 1
 │    └── aggregations
 │         └── const-agg [as=max:30, outer=(29)]
 │              └── max:29
 └── projections
      └── COALESCE(max:30, 0) [as=coalesce:31, outer=(30)]

# Show last 20 transactions for a particular card.
#
# Problems:
#   1. Wrong join-type is selected (hash instead of lookup). This is because
#      "NOT IsBuy" needs to be mapped to "IsBuy = FALSE".
#   2. Index join should be applied after join between TransactionsView and
#      TransactionDetailsView.
#
opt format=show-stats
SELECT
  d.IsBuy, TransactionDate, CardId, Quantity, SellPrice, BuyPrice,
  t.IsBuy AS IsBuy2, Date, AccountName, CustomerName
FROM TransactionDetailsView d
INNER JOIN TransactionsView t
ON t.Date = d.TransactionDate
WHERE (d.CardId = 21953) AND NOT d.IsBuy AND NOT t.IsBuy
ORDER BY TransactionDate DESC
LIMIT 20
----
project
 ├── columns: isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null sellprice:6!null buyprice:7!null isbuy2:10!null date:11!null accountname:12!null customername:13!null
 ├── cardinality: [0 - 20]
 ├── stats: [rows=20]
 ├── key: (5,11)
 ├── fd: ()-->(2,4,10), (3,5)-->(6,7), (11)-->(12,13), (3)==(11), (11)==(3)
 ├── ordering: -(3|11) opt(2,4,10) [actual: -3]
 └── limit
      ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null sellprice:6!null buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
      ├── internal-ordering: -(3|11) opt(1,2,4,9,10)
      ├── cardinality: [0 - 20]
      ├── stats: [rows=20]
      ├── key: (5,11)
      ├── fd: ()-->(1,2,4,9,10), (3,5)-->(6,7), (11)-->(12,13), (3)==(11), (11)==(3)
      ├── ordering: -(3|11) opt(1,2,4,9,10) [actual: -3]
      ├── sort
      │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null sellprice:6!null buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
      │    ├── stats: [rows=157.894737, distinct(3)=157.894737, null(3)=0, distinct(11)=157.894737, null(11)=0]
      │    ├── key: (5,11)
      │    ├── fd: ()-->(1,2,4,9,10), (3,5)-->(6,7), (11)-->(12,13), (3)==(11), (11)==(3)
      │    ├── ordering: -(3|11) opt(1,2,4,9,10) [actual: -3]
      │    ├── limit hint: 20.00
      │    └── inner-join (hash)
      │         ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null sellprice:6!null buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
      │         ├── stats: [rows=157.894737, distinct(3)=157.894737, null(3)=0, distinct(11)=157.894737, null(11)=0]
      │         ├── key: (5,11)
      │         ├── fd: ()-->(1,2,4,9,10), (3,5)-->(6,7), (11)-->(12,13), (3)==(11), (11)==(3)
      │         ├── scan transactions
      │         │    ├── columns: transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
      │         │    ├── constraint: /9/10/11: [/1/false - /1/false]
      │         │    ├── stats: [rows=1000000, distinct(9)=1, null(9)=0, distinct(10)=1, null(10)=0, distinct(11)=1000000, null(11)=0, distinct(12)=802526.122, null(12)=0, distinct(13)=802526.122, null(13)=0]
      │         │    ├── key: (11)
      │         │    └── fd: ()-->(9,10), (11)-->(12,13)
      │         ├── index-join transactiondetails
      │         │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null sellprice:6!null buyprice:7!null
      │         │    ├── stats: [rows=157.894737, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=0, distinct(3)=157.894737, null(3)=0, distinct(4)=1, null(4)=0, distinct(5)=157.894114, null(5)=0, distinct(6)=157.894114, null(6)=0, distinct(7)=157.894114, null(7)=0]
      │         │    ├── key: (3,5)
      │         │    ├── fd: ()-->(1,2,4), (3,5)-->(6,7)
      │         │    └── scan transactiondetails@detailscardidindex
      │         │         ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null
      │         │         ├── constraint: /1/2/4/3/5: [/1/false/21953 - /1/false/21953]
      │         │         ├── stats: [rows=157.894737, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=0, distinct(4)=1, null(4)=0]
      │         │         ├── key: (3,5)
      │         │         └── fd: ()-->(1,2,4)
      │         └── filters
      │              └── date:11 = transactiondate:3 [outer=(3,11), constraints=(/3: (/NULL - ]; /11: (/NULL - ]), fd=(3)==(11), (11)==(3)]
      └── 20

# Show last 20 prices for a card.
opt format=show-stats
SELECT CardId, PriceDate, PricedBy, BuyPrice, SellPrice
FROM PriceDetailsView
WHERE CardId = 12345
ORDER BY PriceDate DESC
LIMIT 10
----
project
 ├── columns: cardid:2!null pricedate:3!null pricedby:4!null buyprice:5!null sellprice:6!null
 ├── cardinality: [0 - 10]
 ├── stats: [rows=10]
 ├── key: (3)
 ├── fd: ()-->(2), (3)-->(4-6)
 ├── ordering: -3 opt(2) [actual: -3]
 └── scan pricedetails,rev
      ├── columns: dealerid:1!null cardid:2!null pricedate:3!null pricedby:4!null buyprice:5!null sellprice:6!null
      ├── constraint: /1/2/3: [/1/12345 - /1/12345]
      ├── limit: 10(rev)
      ├── stats: [rows=10]
      ├── key: (3)
      ├── fd: ()-->(1,2), (3)-->(4-6)
      └── ordering: -3 opt(1,2) [actual: -3]

# Show next page of 50 cards.
#
# Problems:
#   1. This query will not compile, due to #46180.
#   2. The TransactionDate comparisons should be the last 2 days from the
#      current timestamp. However, the current timestamp is not treated as a
#      constant as it should be.
#   3. Missing rule to push "LIMIT 50" into GroupBy->LeftJoin complex. This
#      would need to be an exploration rule since it involves an ordering.
#      Or we could push down the "limit hint" into GroupBy->LeftJoin.
#   4. Wrong join-type (probably due to #3 above). Should be LookupJoin.
#
#opt format=show-stats
#SELECT
#  Id, Name, Rarity, SetName, Number, IsFoil, BuyPrice, SellPrice,
#  DesiredInventory, ActualInventory, Version, Discount, MaxInventory, Value AS TwoDaySales
#FROM
#(
#  SELECT *,
#    coalesce((
#      SELECT sum(Quantity)
#      FROM TransactionDetailsView d
#      WHERE
#        d.CardId = c.Id AND
#        d.IsBuy = FALSE AND
#        d.TransactionDate BETWEEN '2020-03-01'::TIMESTAMPTZ - INTERVAL '2 days' AND '2020-03-01'::TIMESTAMPTZ
#      ), 0) AS Value
#  FROM CardsView c
#) AS c
#WHERE (Name, SetName, Number) > ('Shock', '7E', 248)
#ORDER BY Name, SetName, Number
#LIMIT 50
#----

# Daily transaction query.
#
# Problems:
#   1. CardsView is actually a join between Cards and CardsInfo tables. But the
#      optimizer is missing join elimination rules. If those were available, we
#      could eliminate the join to Cards (because of FK).
#   2. Inequality predicate terms (accountname / customername) are too
#      selective.
#   3. The Date comparisons should be the last 7 days from the current
#      timestamp. However, the current timestamp is not treated as a constant as
#      it should be.
#
opt format=show-stats
SELECT
  extract(day from d.TransactionDate),
  sum(d.SellPrice * d.Quantity) AS TotalSell,
  sum(d.BuyPrice * d.Quantity) AS TotalBuy,
  sum((d.SellPrice - d.BuyPrice) * d.Quantity) AS TotalProfit
FROM TransactionDetailsView d, TransactionsView t, CardsView c
WHERE
  d.TransactionDate = t.Date AND
  c.Id = d.CardId AND
  NOT d.IsBuy AND
  NOT t.IsBuy AND
  t.Date BETWEEN '2020-03-01'::TIMESTAMPTZ - INTERVAL '7 days' AND '2020-03-01'::TIMESTAMPTZ AND
  t.AccountName <> 'someaccount' AND
  t.customername <> 'somecustomer'
GROUP BY extract(day from d.TransactionDate)
ORDER BY extract(day from d.TransactionDate)
----
group-by
 ├── columns: extract:37 totalsell:32!null totalbuy:34!null totalprofit:36!null
 ├── grouping columns: column37:37
 ├── stats: [rows=12345.679, distinct(37)=12345.679, null(37)=0]
 ├── key: (37)
 ├── fd: (37)-->(32,34,36)
 ├── ordering: +37
 ├── sort
 │    ├── columns: column31:31!null column33:33!null column35:35!null column37:37
 │    ├── stats: [rows=12634.4671, distinct(37)=12345.679, null(37)=0]
 │    ├── ordering: +37
 │    └── project
 │         ├── columns: column31:31!null column33:33!null column35:35!null column37:37
 │         ├── stats: [rows=12634.4671, distinct(37)=12345.679, null(37)=0]
 │         ├── inner-join (hash)
 │         │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null transactiondetails.cardid:4!null quantity:5!null transactiondetails.sellprice:6!null transactiondetails.buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null id:16!null cardsinfo.dealerid:22!null cardsinfo.cardid:23!null
 │         │    ├── stats: [rows=12634.4671, distinct(3)=12345.679, null(3)=0, distinct(4)=12634.4671, null(4)=0, distinct(11)=12345.679, null(11)=0, distinct(16)=12634.4671, null(16)=0]
 │         │    ├── key: (5,11,23)
 │         │    ├── fd: ()-->(1,2,9,10,22), (3-5)-->(6,7), (11)-->(12,13), (16)==(4,23), (23)==(4,16), (3)==(11), (11)==(3), (4)==(16,23)
 │         │    ├── scan cardsinfo@cardsinfoversionindex
 │         │    │    ├── columns: cardsinfo.dealerid:22!null cardsinfo.cardid:23!null
 │         │    │    ├── constraint: /22/30: [/1 - /1]
 │         │    │    ├── stats: [rows=58333.3333, distinct(22)=1, null(22)=0, distinct(23)=37420.3552, null(23)=0]
 │         │    │    ├── key: (23)
 │         │    │    └── fd: ()-->(22)
 │         │    ├── inner-join (hash)
 │         │    │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null transactiondetails.cardid:4!null quantity:5!null transactiondetails.sellprice:6!null transactiondetails.buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null id:16!null
 │         │    │    ├── stats: [rows=12345.679, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=0, distinct(3)=12345.679, null(3)=0, distinct(4)=12345.679, null(4)=0, distinct(5)=12267.872, null(5)=0, distinct(6)=12267.872, null(6)=0, distinct(7)=12267.872, null(7)=0, distinct(9)=1, null(9)=0, distinct(10)=1, null(10)=0, distinct(11)=12345.679, null(11)=0, distinct(12)=7803.95639, null(12)=0, distinct(13)=7803.95639, null(13)=0, distinct(16)=12345.679, null(16)=0]
 │         │    │    ├── key: (5,11,16)
 │         │    │    ├── fd: ()-->(1,2,9,10), (11)-->(12,13), (3-5)-->(6,7), (3)==(11), (11)==(3), (4)==(16), (16)==(4)
 │         │    │    ├── scan cards@cardsnamesetnumber
 │         │    │    │    ├── columns: id:16!null
 │         │    │    │    ├── stats: [rows=57000, distinct(16)=57000, null(16)=0]
 │         │    │    │    └── key: (16)
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null transactiondetails.cardid:4!null quantity:5!null transactiondetails.sellprice:6!null transactiondetails.buyprice:7!null transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
 │         │    │    │    ├── stats: [rows=12345.679, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=0, distinct(3)=12345.679, null(3)=0, distinct(4)=11100.2211, null(4)=0, distinct(5)=12267.8812, null(5)=0, distinct(6)=12267.8812, null(6)=0, distinct(7)=12267.8812, null(7)=0, distinct(9)=1, null(9)=0, distinct(10)=1, null(10)=0, distinct(11)=12345.679, null(11)=0, distinct(12)=7803.95979, null(12)=0, distinct(13)=7803.95979, null(13)=0]
 │         │    │    │    ├── key: (4,5,11)
 │         │    │    │    ├── fd: ()-->(1,2,9,10), (11)-->(12,13), (3-5)-->(6,7), (3)==(11), (11)==(3)
 │         │    │    │    ├── scan transactiondetails
 │         │    │    │    │    ├── columns: transactiondetails.dealerid:1!null transactiondetails.isbuy:2!null transactiondate:3!null transactiondetails.cardid:4!null quantity:5!null transactiondetails.sellprice:6!null transactiondetails.buyprice:7!null
 │         │    │    │    │    ├── constraint: /1/2/3/4/5: [/1/false/'2020-02-23 00:00:00+00:00' - /1/false/'2020-03-01 00:00:00+00:00']
 │         │    │    │    │    ├── stats: [rows=1000000, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=0, distinct(3)=1000000, null(3)=0, distinct(4)=56999.9987, null(4)=0, distinct(5)=975366.793, null(5)=0, distinct(6)=975366.793, null(6)=0, distinct(7)=975366.793, null(7)=0]
 │         │    │    │    │    ├── key: (3-5)
 │         │    │    │    │    └── fd: ()-->(1,2), (3-5)-->(6,7)
 │         │    │    │    ├── select
 │         │    │    │    │    ├── columns: transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
 │         │    │    │    │    ├── stats: [rows=12345.679, distinct(9)=1, null(9)=0, distinct(10)=1, null(10)=0, distinct(11)=12345.679, null(11)=0, distinct(12)=12345.679, null(12)=0, distinct(13)=12345.679, null(13)=0]
 │         │    │    │    │    ├── key: (11)
 │         │    │    │    │    ├── fd: ()-->(9,10), (11)-->(12,13)
 │         │    │    │    │    ├── scan transactions
 │         │    │    │    │    │    ├── columns: transactions.dealerid:9!null transactions.isbuy:10!null date:11!null accountname:12!null customername:13!null
 │         │    │    │    │    │    ├── constraint: /9/10/11: [/1/false/'2020-02-23 00:00:00+00:00' - /1/false/'2020-03-01 00:00:00+00:00']
 │         │    │    │    │    │    ├── stats: [rows=111111.111, distinct(9)=1, null(9)=0, distinct(10)=1, null(10)=0, distinct(11)=111111.111, null(11)=0]
 │         │    │    │    │    │    ├── key: (11)
 │         │    │    │    │    │    └── fd: ()-->(9,10), (11)-->(12,13)
 │         │    │    │    │    └── filters
 │         │    │    │    │         ├── accountname:12 != 'someaccount' [outer=(12), constraints=(/12: (/NULL - /'someaccount') [/e'someaccount\x00' - ]; tight)]
 │         │    │    │    │         └── customername:13 != 'somecustomer' [outer=(13), constraints=(/13: (/NULL - /'somecustomer') [/e'somecustomer\x00' - ]; tight)]
 │         │    │    │    └── filters
 │         │    │    │         └── transactiondate:3 = date:11 [outer=(3,11), constraints=(/3: (/NULL - ]; /11: (/NULL - ]), fd=(3)==(11), (11)==(3)]
 │         │    │    └── filters
 │         │    │         └── id:16 = transactiondetails.cardid:4 [outer=(4,16), constraints=(/4: (/NULL - ]; /16: (/NULL - ]), fd=(4)==(16), (16)==(4)]
 │         │    └── filters
 │         │         └── id:16 = cardsinfo.cardid:23 [outer=(16,23), constraints=(/16: (/NULL - ]; /23: (/NULL - ]), fd=(16)==(23), (23)==(16)]
 │         └── projections
 │              ├── transactiondetails.sellprice:6 * quantity:5 [as=column31:31, outer=(5,6)]
 │              ├── transactiondetails.buyprice:7 * quantity:5 [as=column33:33, outer=(5,7)]
 │              ├── quantity:5 * (transactiondetails.sellprice:6 - transactiondetails.buyprice:7) [as=column35:35, outer=(5-7)]
 │              └── extract('day', transactiondate:3) [as=column37:37, outer=(3)]
 └── aggregations
      ├── sum [as=sum:32, outer=(31)]
      │    └── column31:31
      ├── sum [as=sum:34, outer=(33)]
      │    └── column33:33
      └── sum [as=sum:36, outer=(35)]
           └── column35:35

# Check if transaction was already inserted, for idempotency.
#
# Problems:
#   1. Missing rule to transform AnyOp into ExistsOp when both the scalar
#      inclusion value and subquery column are non-NULL.
#
# NOTE: This looks awkward, but it's adapted from stored procedure code.
opt
SELECT
(
  '70F03EB1-4F58-4C26-B72D-C524A9D537DD'::UUID IN
  (
    SELECT coalesce(OperationId, '00000000-0000-0000-0000-000000000000'::UUID)
    FROM TransactionsView
    WHERE IsBuy = FALSE
  )
) AS AlreadyInserted
----
values
 ├── columns: alreadyinserted:9
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(9)
 └── tuple
      └── any: eq
           ├── project
           │    ├── columns: coalesce:8
           │    ├── scan transactions
           │    │    ├── columns: dealerid:1!null isbuy:2!null operationid:6
           │    │    ├── constraint: /1/2/3: [/1/false - /1/false]
           │    │    ├── lax-key: (6)
           │    │    └── fd: ()-->(1,2)
           │    └── projections
           │         └── COALESCE(operationid:6, '00000000-0000-0000-0000-000000000000') [as=coalesce:8, outer=(6)]
           └── '70f03eb1-4f58-4c26-b72d-c524a9d537dd'

# Get account locations of a list of cards.
#
# Problems:
#   1. WITH is not inlined into the query, because it is marked as having side
#      effects, even though it does not.
#   2. unnest should be folded into VALUES operator when it operates over
#      constant ARRAY.
opt
WITH CardsToFind AS
(
  SELECT (IdAndQuantity).@1 AS Id, (IdAndQuantity).@2 AS Quantity
  FROM unnest(ARRAY[(42948, 3), (24924, 4)]) AS IdAndQuantity
)
SELECT AccountName, sum(Quantity) AS Quantity
FROM
(
    SELECT Id, AccountName, (CASE WHEN needed.Quantity < have.Quantity THEN needed.Quantity ELSE have.Quantity END) Quantity
    FROM CardsToFind AS needed
    INNER JOIN LATERAL
    (
        SELECT AccountName, Quantity
        FROM InventoryDetails
        WHERE (dealerid = 1 OR dealerid = 2 OR dealerid = 3 OR dealerid = 4 OR dealerid = 5) AND
            CardId = Id AND AccountName = ANY ARRAY['account-1', 'account-2', 'account-3']
    ) AS have
    ON TRUE
) AS allData
GROUP BY AccountName
ORDER BY sum(Quantity) DESC
LIMIT 1000
----
sort
 ├── columns: accountname:8!null quantity:12
 ├── cardinality: [0 - 1000]
 ├── side-effects
 ├── key: (8)
 ├── fd: (8)-->(12)
 ├── ordering: -12
 └── with &1 (cardstofind)
      ├── columns: accountname:8!null sum:12
      ├── cardinality: [0 - 1000]
      ├── side-effects
      ├── key: (8)
      ├── fd: (8)-->(12)
      ├── project
      │    ├── columns: id:2 quantity:3
      │    ├── side-effects
      │    ├── project-set
      │    │    ├── columns: unnest:1
      │    │    ├── side-effects
      │    │    ├── values
      │    │    │    ├── cardinality: [1 - 1]
      │    │    │    ├── key: ()
      │    │    │    └── ()
      │    │    └── zip
      │    │         └── unnest(ARRAY[(42948, 3),(24924, 4)]) [side-effects]
      │    └── projections
      │         ├── (unnest:1).@1 [as=id:2, outer=(1)]
      │         └── (unnest:1).@2 [as=quantity:3, outer=(1)]
      └── limit
           ├── columns: accountname:8!null sum:12
           ├── internal-ordering: -12
           ├── cardinality: [0 - 1000]
           ├── key: (8)
           ├── fd: (8)-->(12)
           ├── sort
           │    ├── columns: accountname:8!null sum:12
           │    ├── key: (8)
           │    ├── fd: (8)-->(12)
           │    ├── ordering: -12
           │    ├── limit hint: 1000.00
           │    └── group-by
           │         ├── columns: accountname:8!null sum:12
           │         ├── grouping columns: accountname:8!null
           │         ├── key: (8)
           │         ├── fd: (8)-->(12)
           │         ├── project
           │         │    ├── columns: quantity:11 accountname:8!null
           │         │    ├── inner-join (lookup inventorydetails)
           │         │    │    ├── columns: id:4!null quantity:5 dealerid:6!null cardid:7!null accountname:8!null inventorydetails.quantity:9!null
           │         │    │    ├── key columns: [6 7 8] = [6 7 8]
           │         │    │    ├── lookup columns are key
           │         │    │    ├── fd: (6-8)-->(9), (4)==(7), (7)==(4)
           │         │    │    ├── inner-join (lookup inventorydetails@inventorydetails_auto_index_inventorydetailscardidkey)
           │         │    │    │    ├── columns: id:4!null quantity:5 dealerid:6!null cardid:7!null accountname:8!null
           │         │    │    │    ├── key columns: [4] = [7]
           │         │    │    │    ├── fd: (4)==(7), (7)==(4)
           │         │    │    │    ├── with-scan &1 (cardstofind)
           │         │    │    │    │    ├── columns: id:4 quantity:5
           │         │    │    │    │    └── mapping:
           │         │    │    │    │         ├──  id:2 => id:4
           │         │    │    │    │         └──  quantity:3 => quantity:5
           │         │    │    │    └── filters
           │         │    │    │         ├── ((((dealerid:6 = 1) OR (dealerid:6 = 2)) OR (dealerid:6 = 3)) OR (dealerid:6 = 4)) OR (dealerid:6 = 5) [outer=(6), constraints=(/6: [/1 - /1] [/2 - /2] [/3 - /3] [/4 - /4] [/5 - /5]; tight)]
           │         │    │    │         └── accountname:8 IN ('account-1', 'account-2', 'account-3') [outer=(8), constraints=(/8: [/'account-1' - /'account-1'] [/'account-2' - /'account-2'] [/'account-3' - /'account-3']; tight)]
           │         │    │    └── filters (true)
           │         │    └── projections
           │         │         └── CASE WHEN quantity:5 < inventorydetails.quantity:9 THEN quantity:5 ELSE inventorydetails.quantity:9 END [as=quantity:11, outer=(5,9)]
           │         └── aggregations
           │              └── sum [as=sum:12, outer=(11)]
           │                   └── quantity:11
           └── 1000

# Get buy/sell volume of a particular card in the last 2 days.
#
# Problems:
#   1. Multiple duplicate predicates. Scan is already constraining CardId,
#      IsBuy, and TransactionDate. But filters still contain those checks.
#
opt
SELECT coalesce((
    SELECT sum(Quantity) AS Volume
    FROM
    (
        SELECT d.Quantity
        FROM TransactionDetails d
        INNER JOIN Transactions t
        ON d.dealerid = t.dealerid AND d.isbuy = t.isbuy AND d.transactiondate = t.date
        WHERE
          (d.dealerid = 1 OR d.dealerid = 2 OR d.dealerid = 3 OR d.dealerid = 4 OR d.dealerid = 5) AND
          d.isbuy IN (TRUE, FALSE) AND
          d.cardid = 19483 AND
          d.transactiondate BETWEEN '2020-03-01'::TIMESTAMPTZ - INTERVAL '2 days' AND '2020-03-01'::TIMESTAMPTZ
        ORDER BY TransactionDate DESC
        LIMIT 100
    ) t
), 0)
----
values
 ├── columns: coalesce:17
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(17)
 └── tuple
      └── coalesce
           ├── subquery
           │    └── scalar-group-by
           │         ├── columns: sum:16
           │         ├── cardinality: [1 - 1]
           │         ├── key: ()
           │         ├── fd: ()-->(16)
           │         ├── limit
           │         │    ├── columns: d.dealerid:1!null d.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null t.dealerid:9!null t.isbuy:10!null date:11!null
           │         │    ├── internal-ordering: -(3|11) opt(4)
           │         │    ├── cardinality: [0 - 100]
           │         │    ├── key: (5,9-11)
           │         │    ├── fd: ()-->(4), (1)==(9), (9)==(1), (2)==(10), (10)==(2), (3)==(11), (11)==(3)
           │         │    ├── sort
           │         │    │    ├── columns: d.dealerid:1!null d.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null t.dealerid:9!null t.isbuy:10!null date:11!null
           │         │    │    ├── key: (5,9-11)
           │         │    │    ├── fd: ()-->(4), (1)==(9), (9)==(1), (2)==(10), (10)==(2), (3)==(11), (11)==(3)
           │         │    │    ├── ordering: -(3|11) opt(4) [actual: -3]
           │         │    │    ├── limit hint: 100.00
           │         │    │    └── inner-join (lookup transactions)
           │         │    │         ├── columns: d.dealerid:1!null d.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null t.dealerid:9!null t.isbuy:10!null date:11!null
           │         │    │         ├── key columns: [1 2 3] = [9 10 11]
           │         │    │         ├── lookup columns are key
           │         │    │         ├── key: (5,9-11)
           │         │    │         ├── fd: ()-->(4), (1)==(9), (9)==(1), (2)==(10), (10)==(2), (3)==(11), (11)==(3)
           │         │    │         ├── scan d@detailscardidindex
           │         │    │         │    ├── columns: d.dealerid:1!null d.isbuy:2!null transactiondate:3!null cardid:4!null quantity:5!null
           │         │    │         │    ├── constraint: /1/2/4/3/5
           │         │    │         │    │    ├── [/1/false/19483/'2020-02-28 00:00:00+00:00' - /1/false/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/1/true/19483/'2020-02-28 00:00:00+00:00' - /1/true/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/2/false/19483/'2020-02-28 00:00:00+00:00' - /2/false/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/2/true/19483/'2020-02-28 00:00:00+00:00' - /2/true/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/3/false/19483/'2020-02-28 00:00:00+00:00' - /3/false/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/3/true/19483/'2020-02-28 00:00:00+00:00' - /3/true/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/4/false/19483/'2020-02-28 00:00:00+00:00' - /4/false/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/4/true/19483/'2020-02-28 00:00:00+00:00' - /4/true/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    ├── [/5/false/19483/'2020-02-28 00:00:00+00:00' - /5/false/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    │    └── [/5/true/19483/'2020-02-28 00:00:00+00:00' - /5/true/19483/'2020-03-01 00:00:00+00:00']
           │         │    │         │    ├── key: (1-3,5)
           │         │    │         │    └── fd: ()-->(4)
           │         │    │         └── filters
           │         │    │              ├── (date:11 >= '2020-02-28 00:00:00+00:00') AND (date:11 <= '2020-03-01 00:00:00+00:00') [outer=(11), constraints=(/11: [/'2020-02-28 00:00:00+00:00' - /'2020-03-01 00:00:00+00:00']; tight)]
           │         │    │              ├── ((((t.dealerid:9 = 1) OR (t.dealerid:9 = 2)) OR (t.dealerid:9 = 3)) OR (t.dealerid:9 = 4)) OR (t.dealerid:9 = 5) [outer=(9), constraints=(/9: [/1 - /1] [/2 - /2] [/3 - /3] [/4 - /4] [/5 - /5]; tight)]
           │         │    │              └── t.isbuy:10 IN (false, true) [outer=(10), constraints=(/10: [/false - /false] [/true - /true]; tight)]
           │         │    └── 100
           │         └── aggregations
           │              └── sum [as=sum:16, outer=(5)]
           │                   └── quantity:5
           └── 0

# --------------------------------------------------
# INSERT/UPDATE/DELETE/UPSERT Queries
# --------------------------------------------------

# Insert buy or sell transaction.
opt
INSERT INTO Transactions (dealerid, isbuy, date, accountname, customername, operationid)
VALUES (1, FALSE, '2020-03-01', 'the-account', 'the-customer', '70F03EB1-4F58-4C26-B72D-C524A9D537DD')
----
insert transactions
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:8 => dealerid:1
 │    ├── column2:9 => isbuy:2
 │    ├── column3:10 => date:3
 │    ├── column4:11 => accountname:4
 │    ├── column5:12 => customername:5
 │    ├── column6:13 => operationid:6
 │    └── column14:14 => version:7
 ├── cardinality: [0 - 0]
 ├── side-effects, mutations
 └── values
      ├── columns: column1:8!null column2:9!null column3:10!null column4:11!null column5:12!null column6:13!null column14:14
      ├── cardinality: [1 - 1]
      ├── side-effects
      ├── key: ()
      ├── fd: ()-->(8-14)
      └── (1, false, '2020-03-01 00:00:00+00:00', 'the-account', 'the-customer', '70f03eb1-4f58-4c26-b72d-c524a9d537dd', cluster_logical_timestamp())

# Upsert buy or sell transaction.
opt
UPSERT INTO Transactions (dealerid, isbuy, date, accountname, customername, operationid)
VALUES (1, FALSE, '2020-03-01', 'the-account', 'the-customer', '70F03EB1-4F58-4C26-B72D-C524A9D537DD')
----
upsert transactions
 ├── columns: <none>
 ├── canary column: 15
 ├── fetch columns: dealerid:15 isbuy:16 date:17 accountname:18 customername:19 operationid:20 version:21
 ├── insert-mapping:
 │    ├── column1:8 => dealerid:1
 │    ├── column2:9 => isbuy:2
 │    ├── column3:10 => date:3
 │    ├── column4:11 => accountname:4
 │    ├── column5:12 => customername:5
 │    ├── column6:13 => operationid:6
 │    └── column14:14 => version:7
 ├── update-mapping:
 │    ├── column4:11 => accountname:4
 │    ├── column5:12 => customername:5
 │    └── column6:13 => operationid:6
 ├── cardinality: [0 - 0]
 ├── side-effects, mutations
 └── left-join (cross)
      ├── columns: column1:8!null column2:9!null column3:10!null column4:11!null column5:12!null column6:13!null column14:14 dealerid:15 isbuy:16 date:17 accountname:18 customername:19 operationid:20 version:21
      ├── cardinality: [1 - 1]
      ├── side-effects
      ├── key: ()
      ├── fd: ()-->(8-21)
      ├── values
      │    ├── columns: column1:8!null column2:9!null column3:10!null column4:11!null column5:12!null column6:13!null column14:14
      │    ├── cardinality: [1 - 1]
      │    ├── side-effects
      │    ├── key: ()
      │    ├── fd: ()-->(8-14)
      │    └── (1, false, '2020-03-01 00:00:00+00:00', 'the-account', 'the-customer', '70f03eb1-4f58-4c26-b72d-c524a9d537dd', cluster_logical_timestamp())
      ├── scan transactions
      │    ├── columns: dealerid:15!null isbuy:16!null date:17!null accountname:18!null customername:19!null operationid:20 version:21!null
      │    ├── constraint: /15/16/17: [/1/false/'2020-03-01 00:00:00+00:00' - /1/false/'2020-03-01 00:00:00+00:00']
      │    ├── cardinality: [0 - 1]
      │    ├── key: ()
      │    └── fd: ()-->(15-21)
      └── filters (true)

# Insert structured data (c=CardId, q=Quantity, s=SellPrice, b=BuyPrice)
# represented as JSON into TransactionDetails table.
#
# Problems:
#   1. WITH is not inlined into the query, because it is marked as having side
#      effects, even though it does not.
#   2. jsonb_array_elements should be folded into VALUES operator when it
#      operates over constant JSON.
#
opt
WITH updates AS (SELECT jsonb_array_elements('[
    {"c": 49833, "q": 4, "s": 2.89, "b": 2.29},
    {"c": 29483, "q": 2, "s": 18.93, "b": 17.59}
  ]'::JSONB
) AS Detail)
UPSERT INTO TransactionDetails
(dealerid, isbuy, transactiondate, cardid, quantity, sellprice, buyprice)
SELECT
  1, FALSE, current_timestamp(), (Detail->'c')::TEXT::INT, (Detail->'q')::TEXT::INT,
  (Detail->'s')::TEXT::DECIMAL(10,4), (Detail->'b')::TEXT::DECIMAL(10,4)
FROM updates
----
with &1 (updates)
 ├── cardinality: [0 - 0]
 ├── side-effects, mutations
 ├── project-set
 │    ├── columns: jsonb_array_elements:1
 │    ├── side-effects
 │    ├── values
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── key: ()
 │    │    └── ()
 │    └── zip
 │         └── jsonb_array_elements('[{"b": 2.29, "c": 49833, "q": 4, "s": 2.89}, {"b": 17.59, "c": 29483, "q": 2, "s": 18.93}]') [side-effects]
 └── upsert transactiondetails
      ├── columns: <none>
      ├── canary column: 21
      ├── fetch columns: transactiondetails.dealerid:21 transactiondetails.isbuy:22 transactiondate:23 cardid:24 quantity:25 transactiondetails.sellprice:26 transactiondetails.buyprice:27 transactiondetails.version:28
      ├── insert-mapping:
      │    ├── "?column?":11 => transactiondetails.dealerid:2
      │    ├── bool:12 => transactiondetails.isbuy:3
      │    ├── current_timestamp:13 => transactiondate:4
      │    ├── int8:14 => cardid:5
      │    ├── int8:15 => quantity:6
      │    ├── sellprice:29 => transactiondetails.sellprice:7
      │    ├── buyprice:30 => transactiondetails.buyprice:8
      │    └── column18:18 => transactiondetails.version:9
      ├── update-mapping:
      │    ├── sellprice:29 => transactiondetails.sellprice:7
      │    └── buyprice:30 => transactiondetails.buyprice:8
      ├── input binding: &2
      ├── cardinality: [0 - 0]
      ├── side-effects, mutations
      ├── project
      │    ├── columns: upsert_dealerid:31 upsert_isbuy:32 upsert_transactiondate:33 upsert_cardid:34 sellprice:29 buyprice:30 "?column?":11!null bool:12!null current_timestamp:13 int8:14 int8:15 column18:18 transactiondetails.dealerid:21 transactiondetails.isbuy:22 transactiondate:23 cardid:24 quantity:25 transactiondetails.sellprice:26 transactiondetails.buyprice:27 transactiondetails.version:28
      │    ├── side-effects
      │    ├── lax-key: (13-15,21-25)
      │    ├── fd: ()-->(11,12), (13-15)~~>(18), (21-25)-->(26-28), (21)-->(31), (21,22)-->(32), (13,21,23)-->(33), (14,21,24)-->(34), (13-15,21-25)~~>(18,29,30)
      │    ├── left-join (lookup transactiondetails)
      │    │    ├── columns: "?column?":11!null bool:12!null current_timestamp:13 int8:14 int8:15 column18:18 sellprice:19 buyprice:20 transactiondetails.dealerid:21 transactiondetails.isbuy:22 transactiondate:23 cardid:24 quantity:25 transactiondetails.sellprice:26 transactiondetails.buyprice:27 transactiondetails.version:28
      │    │    ├── key columns: [11 12 13 14 15] = [21 22 23 24 25]
      │    │    ├── lookup columns are key
      │    │    ├── side-effects
      │    │    ├── lax-key: (13-15,21-25)
      │    │    ├── fd: ()-->(11,12), (13-15)~~>(18-20), (21-25)-->(26-28)
      │    │    ├── upsert-distinct-on
      │    │    │    ├── columns: "?column?":11!null bool:12!null current_timestamp:13 int8:14 int8:15 column18:18 sellprice:19 buyprice:20
      │    │    │    ├── grouping columns: current_timestamp:13 int8:14 int8:15
      │    │    │    ├── error-on-dup
      │    │    │    ├── side-effects
      │    │    │    ├── lax-key: (13-15)
      │    │    │    ├── fd: ()-->(11,12), (13-15)~~>(11,12,18-20)
      │    │    │    ├── project
      │    │    │    │    ├── columns: sellprice:19 buyprice:20 column18:18 "?column?":11!null bool:12!null current_timestamp:13 int8:14 int8:15
      │    │    │    │    ├── side-effects
      │    │    │    │    ├── fd: ()-->(11,12)
      │    │    │    │    ├── with-scan &1 (updates)
      │    │    │    │    │    ├── columns: detail:10
      │    │    │    │    │    └── mapping:
      │    │    │    │    │         └──  jsonb_array_elements:1 => detail:10
      │    │    │    │    └── projections
      │    │    │    │         ├── crdb_internal.round_decimal_values((detail:10->'s')::STRING::DECIMAL(10,4), 4) [as=sellprice:19, outer=(10)]
      │    │    │    │         ├── crdb_internal.round_decimal_values((detail:10->'b')::STRING::DECIMAL(10,4), 4) [as=buyprice:20, outer=(10)]
      │    │    │    │         ├── cluster_logical_timestamp() [as=column18:18, side-effects]
      │    │    │    │         ├── 1 [as="?column?":11]
      │    │    │    │         ├── false [as=bool:12]
      │    │    │    │         ├── current_timestamp() [as=current_timestamp:13, side-effects]
      │    │    │    │         ├── (detail:10->'c')::STRING::INT8 [as=int8:14, outer=(10)]
      │    │    │    │         └── (detail:10->'q')::STRING::INT8 [as=int8:15, outer=(10)]
      │    │    │    └── aggregations
      │    │    │         ├── first-agg [as=sellprice:19, outer=(19)]
      │    │    │         │    └── sellprice:19
      │    │    │         ├── first-agg [as=buyprice:20, outer=(20)]
      │    │    │         │    └── buyprice:20
      │    │    │         ├── first-agg [as=column18:18, outer=(18)]
      │    │    │         │    └── column18:18
      │    │    │         ├── const-agg [as="?column?":11, outer=(11)]
      │    │    │         │    └── "?column?":11
      │    │    │         └── const-agg [as=bool:12, outer=(12)]
      │    │    │              └── bool:12
      │    │    └── filters (true)
      │    └── projections
      │         ├── CASE WHEN transactiondetails.dealerid:21 IS NULL THEN "?column?":11 ELSE transactiondetails.dealerid:21 END [as=upsert_dealerid:31, outer=(11,21)]
      │         ├── CASE WHEN transactiondetails.dealerid:21 IS NULL THEN bool:12 ELSE transactiondetails.isbuy:22 END [as=upsert_isbuy:32, outer=(12,21,22)]
      │         ├── CASE WHEN transactiondetails.dealerid:21 IS NULL THEN current_timestamp:13 ELSE transactiondate:23 END [as=upsert_transactiondate:33, outer=(13,21,23)]
      │         ├── CASE WHEN transactiondetails.dealerid:21 IS NULL THEN int8:14 ELSE cardid:24 END [as=upsert_cardid:34, outer=(14,21,24)]
      │         ├── crdb_internal.round_decimal_values(sellprice:19, 4) [as=sellprice:29, outer=(19)]
      │         └── crdb_internal.round_decimal_values(buyprice:20, 4) [as=buyprice:30, outer=(20)]
      └── f-k-checks
           ├── f-k-checks-item: transactiondetails(dealerid,isbuy,transactiondate) -> transactions(dealerid,isbuy,date)
           │    └── anti-join (lookup transactions)
           │         ├── columns: upsert_dealerid:37 upsert_isbuy:38 upsert_transactiondate:39
           │         ├── key columns: [37 38 39] = [40 41 42]
           │         ├── lookup columns are key
           │         ├── with-scan &2
           │         │    ├── columns: upsert_dealerid:37 upsert_isbuy:38 upsert_transactiondate:39
           │         │    └── mapping:
           │         │         ├──  upsert_dealerid:31 => upsert_dealerid:37
           │         │         ├──  upsert_isbuy:32 => upsert_isbuy:38
           │         │         └──  upsert_transactiondate:33 => upsert_transactiondate:39
           │         └── filters (true)
           └── f-k-checks-item: transactiondetails(cardid) -> cards(id)
                └── anti-join (lookup cards)
                     ├── columns: upsert_cardid:47
                     ├── key columns: [47] = [48]
                     ├── lookup columns are key
                     ├── with-scan &2
                     │    ├── columns: upsert_cardid:47
                     │    └── mapping:
                     │         └──  upsert_cardid:34 => upsert_cardid:47
                     └── filters (true)

# Delete inventory detail rows to reflect card transfers.
opt
DELETE FROM InventoryDetails
WHERE dealerid = 1 AND accountname = 'some-account' AND cardid = ANY ARRAY[29483, 1793, 294]
----
delete inventorydetails
 ├── columns: <none>
 ├── fetch columns: dealerid:6 cardid:7 accountname:8
 ├── cardinality: [0 - 0]
 ├── side-effects, mutations
 └── scan inventorydetails@inventorydetails_auto_index_inventorydetailscardidkey
      ├── columns: dealerid:6!null cardid:7!null accountname:8!null
      ├── constraint: /7/6/8
      │    ├── [/294/1/'some-account' - /294/1/'some-account']
      │    ├── [/1793/1/'some-account' - /1793/1/'some-account']
      │    └── [/29483/1/'some-account' - /29483/1/'some-account']
      ├── cardinality: [0 - 3]
      ├── key: (7)
      └── fd: ()-->(6,8)

# Update CardsInfo inventory numbers (by CardId, Quantity) to reflect card
# transfers.
#
# Problems:
#   1. WITH is not inlined into the query, because it is marked as having side
#      effects, even though it does not.
#   2. unnest should be folded into VALUES operator when it operates over
#      constant ARRAY.
opt
WITH Updates AS
(
  SELECT (Detail).@1 AS c, (Detail).@2 AS q
  FROM unnest(ARRAY[(42948, 3), (24924, 4)]) AS Detail
)
UPDATE CardsInfo ci
SET actualinventory = (SELECT coalesce(sum_INT(quantity), 0)
                       FROM InventoryDetails id
                       WHERE dealerid = 1 AND id.cardid = ci.cardid)
FROM Updates
WHERE ci.cardid = Updates.c AND ci.dealerid = 1
----
with &1 (updates)
 ├── cardinality: [0 - 0]
 ├── side-effects, mutations
 ├── project
 │    ├── columns: c:2 q:3
 │    ├── side-effects
 │    ├── project-set
 │    │    ├── columns: unnest:1
 │    │    ├── side-effects
 │    │    ├── values
 │    │    │    ├── cardinality: [1 - 1]
 │    │    │    ├── key: ()
 │    │    │    └── ()
 │    │    └── zip
 │    │         └── unnest(ARRAY[(42948, 3),(24924, 4)]) [side-effects]
 │    └── projections
 │         ├── (unnest:1).@1 [as=c:2, outer=(1)]
 │         └── (unnest:1).@2 [as=q:3, outer=(1)]
 └── update ci
      ├── columns: <none>
      ├── fetch columns: ci.dealerid:13 ci.cardid:14 buyprice:15 sellprice:16 discount:17 desiredinventory:18 actualinventory:19 maxinventory:20 ci.version:21
      ├── update-mapping:
      │    └── column31:31 => actualinventory:10
      ├── cardinality: [0 - 0]
      ├── side-effects, mutations
      └── project
           ├── columns: column31:31 ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23
           ├── key: (14)
           ├── fd: ()-->(13), (14)-->(15-23,31), (21)-->(14-20), (14)==(22), (22)==(14)
           ├── group-by
           │    ├── columns: ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23 sum_int:29
           │    ├── grouping columns: ci.cardid:14!null
           │    ├── key: (14)
           │    ├── fd: ()-->(13), (14)-->(13,15-23,29), (21)-->(14-20), (14)==(22), (22)==(14)
           │    ├── left-join (lookup inventorydetails)
           │    │    ├── columns: ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23 id.dealerid:24 id.cardid:25 quantity:27
           │    │    ├── key columns: [35 14] = [24 25]
           │    │    ├── fd: ()-->(13), (14)-->(15-23), (21)-->(14-20), (14)==(22), (22)==(14)
           │    │    ├── project
           │    │    │    ├── columns: "project_const_col_@24":35!null ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23
           │    │    │    ├── key: (14)
           │    │    │    ├── fd: ()-->(13,35), (14)-->(15-23), (21)-->(14-20), (14)==(22), (22)==(14)
           │    │    │    ├── distinct-on
           │    │    │    │    ├── columns: ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23
           │    │    │    │    ├── grouping columns: ci.cardid:14!null
           │    │    │    │    ├── key: (14)
           │    │    │    │    ├── fd: ()-->(13), (14)-->(13,15-23), (21)-->(14-20), (14)==(22), (22)==(14)
           │    │    │    │    ├── inner-join (lookup cardsinfo)
           │    │    │    │    │    ├── columns: ci.dealerid:13!null ci.cardid:14!null buyprice:15!null sellprice:16!null discount:17!null desiredinventory:18!null actualinventory:19!null maxinventory:20!null ci.version:21!null c:22!null q:23
           │    │    │    │    │    ├── key columns: [32 22] = [13 14]
           │    │    │    │    │    ├── lookup columns are key
           │    │    │    │    │    ├── fd: ()-->(13), (14)-->(15-21), (21)-->(14-20), (14)==(22), (22)==(14)
           │    │    │    │    │    ├── project
           │    │    │    │    │    │    ├── columns: "project_const_col_@13":32!null c:22 q:23
           │    │    │    │    │    │    ├── fd: ()-->(32)
           │    │    │    │    │    │    ├── with-scan &1 (updates)
           │    │    │    │    │    │    │    ├── columns: c:22 q:23
           │    │    │    │    │    │    │    └── mapping:
           │    │    │    │    │    │    │         ├──  c:2 => c:22
           │    │    │    │    │    │    │         └──  q:3 => q:23
           │    │    │    │    │    │    └── projections
           │    │    │    │    │    │         └── 1 [as="project_const_col_@13":32]
           │    │    │    │    │    └── filters (true)
           │    │    │    │    └── aggregations
           │    │    │    │         ├── first-agg [as=buyprice:15, outer=(15)]
           │    │    │    │         │    └── buyprice:15
           │    │    │    │         ├── first-agg [as=sellprice:16, outer=(16)]
           │    │    │    │         │    └── sellprice:16
           │    │    │    │         ├── first-agg [as=discount:17, outer=(17)]
           │    │    │    │         │    └── discount:17
           │    │    │    │         ├── first-agg [as=desiredinventory:18, outer=(18)]
           │    │    │    │         │    └── desiredinventory:18
           │    │    │    │         ├── first-agg [as=actualinventory:19, outer=(19)]
           │    │    │    │         │    └── actualinventory:19
           │    │    │    │         ├── first-agg [as=maxinventory:20, outer=(20)]
           │    │    │    │         │    └── maxinventory:20
           │    │    │    │         ├── first-agg [as=ci.version:21, outer=(21)]
           │    │    │    │         │    └── ci.version:21
           │    │    │    │         ├── first-agg [as=c:22, outer=(22)]
           │    │    │    │         │    └── c:22
           │    │    │    │         ├── first-agg [as=q:23, outer=(23)]
           │    │    │    │         │    └── q:23
           │    │    │    │         └── const-agg [as=ci.dealerid:13, outer=(13)]
           │    │    │    │              └── ci.dealerid:13
           │    │    │    └── projections
           │    │    │         └── 1 [as="project_const_col_@24":35]
           │    │    └── filters (true)
           │    └── aggregations
           │         ├── sum-int [as=sum_int:29, outer=(27)]
           │         │    └── quantity:27
           │         ├── const-agg [as=ci.dealerid:13, outer=(13)]
           │         │    └── ci.dealerid:13
           │         ├── const-agg [as=buyprice:15, outer=(15)]
           │         │    └── buyprice:15
           │         ├── const-agg [as=sellprice:16, outer=(16)]
           │         │    └── sellprice:16
           │         ├── const-agg [as=discount:17, outer=(17)]
           │         │    └── discount:17
           │         ├── const-agg [as=desiredinventory:18, outer=(18)]
           │         │    └── desiredinventory:18
           │         ├── const-agg [as=actualinventory:19, outer=(19)]
           │         │    └── actualinventory:19
           │         ├── const-agg [as=maxinventory:20, outer=(20)]
           │         │    └── maxinventory:20
           │         ├── const-agg [as=ci.version:21, outer=(21)]
           │         │    └── ci.version:21
           │         ├── const-agg [as=c:22, outer=(22)]
           │         │    └── c:22
           │         └── const-agg [as=q:23, outer=(23)]
           │              └── q:23
           └── projections
                └── COALESCE(sum_int:29, 0) [as=column31:31, outer=(29)]
