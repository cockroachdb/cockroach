import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q1
# Pricing Summary Report
# Reports the amount of business that was billed, shipped, and returned.
#
# Provides a summary pricing report for all lineitems shipped as of a given
# date. The date is within 60 - 120 days of the greatest ship date contained in
# the database. The query lists totals for extended price, discounted extended
# price, discounted extended price plus tax, average quantity, average extended
# price, and average discount. These aggregates are grouped by RETURNFLAG and
# LINESTATUS, and listed in ascending order of RETURNFLAG and LINESTATUS. A
# count of the number of lineitems in each group is included.
# --------------------------------------------------
opt
SELECT
    l_returnflag,
    l_linestatus,
    sum(l_quantity) AS sum_qty,
    sum(l_extendedprice) AS sum_base_price,
    sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price,
    sum(l_extendedprice * (1 - l_discount) * (1 + l_tax)) AS sum_charge,
    avg(l_quantity) AS avg_qty,
    avg(l_extendedprice) AS avg_price,
    avg(l_discount) AS avg_disc,
    count(*) AS count_order
FROM
    lineitem
WHERE
    l_shipdate <= DATE '1998-12-01' - INTERVAL '90' DAY
GROUP BY
    l_returnflag,
    l_linestatus
ORDER BY
    l_returnflag,
    l_linestatus;
----
sort
 ├── columns: l_returnflag:9!null l_linestatus:10!null sum_qty:18!null sum_base_price:19!null sum_disc_price:21!null sum_charge:23!null avg_qty:24!null avg_price:25!null avg_disc:26!null count_order:27!null
 ├── immutable
 ├── key: (9,10)
 ├── fd: (9,10)-->(18,19,21,23-27)
 ├── ordering: +9,+10
 └── group-by
      ├── columns: l_returnflag:9!null l_linestatus:10!null sum:18!null sum:19!null sum:21!null sum:23!null avg:24!null avg:25!null avg:26!null count_rows:27!null
      ├── grouping columns: l_returnflag:9!null l_linestatus:10!null
      ├── immutable
      ├── key: (9,10)
      ├── fd: (9,10)-->(18,19,21,23-27)
      ├── project
      │    ├── columns: column20:20!null column22:22!null l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_returnflag:9!null l_linestatus:10!null
      │    ├── immutable
      │    ├── fd: (6,7)-->(20)
      │    ├── select
      │    │    ├── columns: l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_tax:8!null l_returnflag:9!null l_linestatus:10!null l_shipdate:11!null
      │    │    ├── scan lineitem
      │    │    │    └── columns: l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_tax:8!null l_returnflag:9!null l_linestatus:10!null l_shipdate:11!null
      │    │    └── filters
      │    │         └── l_shipdate:11 <= '1998-09-02' [outer=(11), constraints=(/11: (/NULL - /'1998-09-02']; tight)]
      │    └── projections
      │         ├── l_extendedprice:6 * (1.0 - l_discount:7) [as=column20:20, outer=(6,7), immutable]
      │         └── (l_extendedprice:6 * (1.0 - l_discount:7)) * (l_tax:8 + 1.0) [as=column22:22, outer=(6-8), immutable]
      └── aggregations
           ├── sum [as=sum:18, outer=(5)]
           │    └── l_quantity:5
           ├── sum [as=sum:19, outer=(6)]
           │    └── l_extendedprice:6
           ├── sum [as=sum:21, outer=(20)]
           │    └── column20:20
           ├── sum [as=sum:23, outer=(22)]
           │    └── column22:22
           ├── avg [as=avg:24, outer=(5)]
           │    └── l_quantity:5
           ├── avg [as=avg:25, outer=(6)]
           │    └── l_extendedprice:6
           ├── avg [as=avg:26, outer=(7)]
           │    └── l_discount:7
           └── count-rows [as=count_rows:27]

# --------------------------------------------------
# Q2
# Minimum Cost Supplier
# Finds which supplier should be selected to place an order for a given part in
# a given region.
#
# Finds, in a given region, for each part of a certain type and size, the
# supplier who can supply it at minimum cost. If several suppliers in that
# region offer the desired part type and size at the same (minimum) cost, the
# query lists the parts from suppliers with the 100 highest account balances.
# For each supplier, the query lists the supplier's account balance, name and
# nation; the part's number and manufacturer; the supplier's address, phone
# number and comment information.
# --------------------------------------------------
opt
SELECT
    s_acctbal,
    s_name,
    n_name,
    p_partkey,
    p_mfgr,
    s_address,
    s_phone,
    s_comment
FROM
    part,
    supplier,
    partsupp,
    nation,
    region
WHERE
    p_partkey = ps_partkey
    AND s_suppkey = ps_suppkey
    AND p_size = 15
    AND p_type LIKE '%BRASS'
    AND s_nationkey = n_nationkey
    AND n_regionkey = r_regionkey
    AND r_name = 'EUROPE'
    AND ps_supplycost = (
        SELECT
            min(ps_supplycost)
        FROM
            partsupp,
            supplier,
            nation,
            region
        WHERE
            p_partkey = ps_partkey
            AND s_suppkey = ps_suppkey
            AND s_nationkey = n_nationkey
            AND n_regionkey = r_regionkey
            AND r_name = 'EUROPE'
    )
ORDER BY
    s_acctbal DESC,
    n_name,
    s_name,
    p_partkey
LIMIT 100;
----
project
 ├── columns: s_acctbal:16!null s_name:12!null n_name:26!null p_partkey:1!null p_mfgr:3!null s_address:13!null s_phone:15!null s_comment:17!null
 ├── cardinality: [0 - 100]
 ├── fd: (1)-->(3)
 ├── ordering: -16,+26,+12,+1
 └── limit
      ├── columns: p_partkey:1!null p_mfgr:3!null s_name:12!null s_address:13!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_name:26!null min:57!null
      ├── internal-ordering: -16,+26,+12,+(1|19)
      ├── cardinality: [0 - 100]
      ├── key: (19,20)
      ├── fd: (1)-->(3), (19,20)-->(1,3,12,13,15-17,22,26,57), (1)==(19), (19)==(1), (20)-->(12,13,15-17,26), (22)==(57), (57)==(22)
      ├── ordering: -16,+26,+12,+(1|19) [actual: -16,+26,+12,+1]
      ├── sort
      │    ├── columns: p_partkey:1!null p_mfgr:3!null s_name:12!null s_address:13!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_name:26!null min:57!null
      │    ├── key: (19,20)
      │    ├── fd: (1)-->(3), (19,20)-->(1,3,12,13,15-17,22,26,57), (1)==(19), (19)==(1), (20)-->(12,13,15-17,26), (22)==(57), (57)==(22)
      │    ├── ordering: -16,+26,+12,+(1|19) [actual: -16,+26,+12,+1]
      │    ├── limit hint: 100.00
      │    └── select
      │         ├── columns: p_partkey:1!null p_mfgr:3!null s_name:12!null s_address:13!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_name:26!null min:57!null
      │         ├── key: (19,20)
      │         ├── fd: (1)-->(3), (19,20)-->(1,3,12,13,15-17,22,26,57), (1)==(19), (19)==(1), (20)-->(12,13,15-17,26), (22)==(57), (57)==(22)
      │         ├── group-by
      │         │    ├── columns: p_partkey:1!null p_mfgr:3!null s_name:12!null s_address:13!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_name:26!null min:57!null
      │         │    ├── grouping columns: ps_partkey:19!null ps_suppkey:20!null
      │         │    ├── key: (19,20)
      │         │    ├── fd: (1)-->(3), (19,20)-->(1,3,12,13,15-17,22,26,57), (1)==(19), (19)==(1), (20)-->(12,13,15-17,26)
      │         │    ├── inner-join (hash)
      │         │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null s_suppkey:11!null s_name:12!null s_address:13!null s_nationkey:14!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_nationkey:25!null n_name:26!null n_regionkey:27!null r_regionkey:30!null r_name:31!null ps_partkey:34!null ps_suppkey:35!null ps_supplycost:37!null s_suppkey:40!null s_nationkey:43!null n_nationkey:48!null n_regionkey:50!null r_regionkey:53!null r_name:54!null
      │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    ├── key: (20,34,40)
      │         │    │    ├── fd: ()-->(6,31,54), (1)-->(3,5), (11)-->(12-17), (19,20)-->(22), (11)==(20), (20)==(11), (25)-->(26,27), (27)==(30), (30)==(27), (14)==(25), (25)==(14), (1)==(19,34), (19)==(1,34), (34,35)-->(37), (40)-->(43), (48)-->(50), (50)==(53), (53)==(50), (43)==(48), (48)==(43), (35)==(40), (40)==(35), (34)==(1,19)
      │         │    │    ├── inner-join (lookup partsupp)
      │         │    │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null s_suppkey:11!null s_name:12!null s_address:13!null s_nationkey:14!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_nationkey:25!null n_name:26!null n_regionkey:27!null r_regionkey:30!null r_name:31!null ps_partkey:34!null ps_suppkey:35!null ps_supplycost:37!null
      │         │    │    │    ├── key columns: [1] = [34]
      │         │    │    │    ├── key: (20,34,35)
      │         │    │    │    ├── fd: ()-->(6,31), (1)-->(3,5), (25)-->(26,27), (11)-->(12-17), (19,20)-->(22), (34,35)-->(37), (19)==(1,34), (34)==(1,19), (11)==(20), (20)==(11), (14)==(25), (25)==(14), (27)==(30), (30)==(27), (1)==(19,34)
      │         │    │    │    ├── inner-join (hash)
      │         │    │    │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null s_suppkey:11!null s_name:12!null s_address:13!null s_nationkey:14!null s_phone:15!null s_acctbal:16!null s_comment:17!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null n_nationkey:25!null n_name:26!null n_regionkey:27!null r_regionkey:30!null r_name:31!null
      │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    │    ├── key: (19,20)
      │         │    │    │    │    ├── fd: ()-->(6,31), (1)-->(3,5), (11)-->(12-17), (19,20)-->(22), (11)==(20), (20)==(11), (25)-->(26,27), (27)==(30), (30)==(27), (14)==(25), (25)==(14), (1)==(19), (19)==(1)
      │         │    │    │    │    ├── inner-join (lookup partsupp)
      │         │    │    │    │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null ps_partkey:19!null ps_suppkey:20!null ps_supplycost:22!null
      │         │    │    │    │    │    ├── key columns: [1] = [19]
      │         │    │    │    │    │    ├── key: (19,20)
      │         │    │    │    │    │    ├── fd: ()-->(6), (1)-->(3,5), (19,20)-->(22), (1)==(19), (19)==(1)
      │         │    │    │    │    │    ├── select
      │         │    │    │    │    │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null
      │         │    │    │    │    │    │    ├── key: (1)
      │         │    │    │    │    │    │    ├── fd: ()-->(6), (1)-->(3,5)
      │         │    │    │    │    │    │    ├── scan part
      │         │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_mfgr:3!null p_type:5!null p_size:6!null
      │         │    │    │    │    │    │    │    ├── key: (1)
      │         │    │    │    │    │    │    │    └── fd: (1)-->(3,5,6)
      │         │    │    │    │    │    │    └── filters
      │         │    │    │    │    │    │         ├── p_size:6 = 15 [outer=(6), constraints=(/6: [/15 - /15]; tight), fd=()-->(6)]
      │         │    │    │    │    │    │         └── p_type:5 LIKE '%BRASS' [outer=(5), constraints=(/5: (/NULL - ])]
      │         │    │    │    │    │    └── filters (true)
      │         │    │    │    │    ├── inner-join (hash)
      │         │    │    │    │    │    ├── columns: s_suppkey:11!null s_name:12!null s_address:13!null s_nationkey:14!null s_phone:15!null s_acctbal:16!null s_comment:17!null n_nationkey:25!null n_name:26!null n_regionkey:27!null r_regionkey:30!null r_name:31!null
      │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    │    │    ├── key: (11)
      │         │    │    │    │    │    ├── fd: ()-->(31), (11)-->(12-17), (25)-->(26,27), (27)==(30), (30)==(27), (14)==(25), (25)==(14)
      │         │    │    │    │    │    ├── scan supplier
      │         │    │    │    │    │    │    ├── columns: s_suppkey:11!null s_name:12!null s_address:13!null s_nationkey:14!null s_phone:15!null s_acctbal:16!null s_comment:17!null
      │         │    │    │    │    │    │    ├── key: (11)
      │         │    │    │    │    │    │    └── fd: (11)-->(12-17)
      │         │    │    │    │    │    ├── inner-join (hash)
      │         │    │    │    │    │    │    ├── columns: n_nationkey:25!null n_name:26!null n_regionkey:27!null r_regionkey:30!null r_name:31!null
      │         │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    │    │    │    ├── key: (25)
      │         │    │    │    │    │    │    ├── fd: ()-->(31), (25)-->(26,27), (27)==(30), (30)==(27)
      │         │    │    │    │    │    │    ├── scan nation
      │         │    │    │    │    │    │    │    ├── columns: n_nationkey:25!null n_name:26!null n_regionkey:27!null
      │         │    │    │    │    │    │    │    ├── key: (25)
      │         │    │    │    │    │    │    │    └── fd: (25)-->(26,27)
      │         │    │    │    │    │    │    ├── select
      │         │    │    │    │    │    │    │    ├── columns: r_regionkey:30!null r_name:31!null
      │         │    │    │    │    │    │    │    ├── key: (30)
      │         │    │    │    │    │    │    │    ├── fd: ()-->(31)
      │         │    │    │    │    │    │    │    ├── scan region
      │         │    │    │    │    │    │    │    │    ├── columns: r_regionkey:30!null r_name:31!null
      │         │    │    │    │    │    │    │    │    ├── key: (30)
      │         │    │    │    │    │    │    │    │    └── fd: (30)-->(31)
      │         │    │    │    │    │    │    │    └── filters
      │         │    │    │    │    │    │    │         └── r_name:31 = 'EUROPE' [outer=(31), constraints=(/31: [/'EUROPE' - /'EUROPE']; tight), fd=()-->(31)]
      │         │    │    │    │    │    │    └── filters
      │         │    │    │    │    │    │         └── n_regionkey:27 = r_regionkey:30 [outer=(27,30), constraints=(/27: (/NULL - ]; /30: (/NULL - ]), fd=(27)==(30), (30)==(27)]
      │         │    │    │    │    │    └── filters
      │         │    │    │    │    │         └── s_nationkey:14 = n_nationkey:25 [outer=(14,25), constraints=(/14: (/NULL - ]; /25: (/NULL - ]), fd=(14)==(25), (25)==(14)]
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── s_suppkey:11 = ps_suppkey:20 [outer=(11,20), constraints=(/11: (/NULL - ]; /20: (/NULL - ]), fd=(11)==(20), (20)==(11)]
      │         │    │    │    └── filters (true)
      │         │    │    ├── inner-join (lookup supplier@s_nk)
      │         │    │    │    ├── columns: s_suppkey:40!null s_nationkey:43!null n_nationkey:48!null n_regionkey:50!null r_regionkey:53!null r_name:54!null
      │         │    │    │    ├── key columns: [48] = [43]
      │         │    │    │    ├── key: (40)
      │         │    │    │    ├── fd: ()-->(54), (40)-->(43), (48)-->(50), (50)==(53), (53)==(50), (43)==(48), (48)==(43)
      │         │    │    │    ├── inner-join (lookup nation@n_rk)
      │         │    │    │    │    ├── columns: n_nationkey:48!null n_regionkey:50!null r_regionkey:53!null r_name:54!null
      │         │    │    │    │    ├── key columns: [53] = [50]
      │         │    │    │    │    ├── key: (48)
      │         │    │    │    │    ├── fd: ()-->(54), (48)-->(50), (50)==(53), (53)==(50)
      │         │    │    │    │    ├── select
      │         │    │    │    │    │    ├── columns: r_regionkey:53!null r_name:54!null
      │         │    │    │    │    │    ├── key: (53)
      │         │    │    │    │    │    ├── fd: ()-->(54)
      │         │    │    │    │    │    ├── scan region
      │         │    │    │    │    │    │    ├── columns: r_regionkey:53!null r_name:54!null
      │         │    │    │    │    │    │    ├── key: (53)
      │         │    │    │    │    │    │    └── fd: (53)-->(54)
      │         │    │    │    │    │    └── filters
      │         │    │    │    │    │         └── r_name:54 = 'EUROPE' [outer=(54), constraints=(/54: [/'EUROPE' - /'EUROPE']; tight), fd=()-->(54)]
      │         │    │    │    │    └── filters (true)
      │         │    │    │    └── filters (true)
      │         │    │    └── filters
      │         │    │         └── s_suppkey:40 = ps_suppkey:35 [outer=(35,40), constraints=(/35: (/NULL - ]; /40: (/NULL - ]), fd=(35)==(40), (40)==(35)]
      │         │    └── aggregations
      │         │         ├── min [as=min:57, outer=(37)]
      │         │         │    └── ps_supplycost:37
      │         │         ├── const-agg [as=s_name:12, outer=(12)]
      │         │         │    └── s_name:12
      │         │         ├── const-agg [as=s_address:13, outer=(13)]
      │         │         │    └── s_address:13
      │         │         ├── const-agg [as=s_phone:15, outer=(15)]
      │         │         │    └── s_phone:15
      │         │         ├── const-agg [as=s_acctbal:16, outer=(16)]
      │         │         │    └── s_acctbal:16
      │         │         ├── const-agg [as=s_comment:17, outer=(17)]
      │         │         │    └── s_comment:17
      │         │         ├── const-agg [as=ps_supplycost:22, outer=(22)]
      │         │         │    └── ps_supplycost:22
      │         │         ├── const-agg [as=n_name:26, outer=(26)]
      │         │         │    └── n_name:26
      │         │         ├── const-agg [as=p_mfgr:3, outer=(3)]
      │         │         │    └── p_mfgr:3
      │         │         └── const-agg [as=p_partkey:1, outer=(1)]
      │         │              └── p_partkey:1
      │         └── filters
      │              └── ps_supplycost:22 = min:57 [outer=(22,57), constraints=(/22: (/NULL - ]; /57: (/NULL - ]), fd=(22)==(57), (57)==(22)]
      └── 100

# --------------------------------------------------
# Q3
# Shipping Priority
# Retrieves the 10 unshipped orders with the highest value.
#
# Retrieves the shipping priority and potential revenue, defined as the sum of
# l_extendedprice * (1-l_discount), of the orders having the largest revenue
# among those that had not been shipped as of a given date. Orders are listed in
# decreasing order of revenue. If more than 10 unshipped orders exist, only the
# 10 orders with the largest revenue are listed.
# --------------------------------------------------
opt
SELECT
    l_orderkey,
    sum(l_extendedprice * (1 - l_discount)) AS revenue,
    o_orderdate,
    o_shippriority
FROM
    customer,
    orders,
    lineitem
WHERE
    c_mktsegment = 'BUILDING'
    AND c_custkey = o_custkey
    AND l_orderkey = o_orderkey
    AND o_orderDATE < DATE '1995-03-15'
    AND l_shipdate > DATE '1995-03-15'
GROUP BY
    l_orderkey,
    o_orderdate,
    o_shippriority
ORDER BY
    revenue DESC,
    o_orderdate
LIMIT 10;
----
limit
 ├── columns: l_orderkey:20!null revenue:38!null o_orderdate:14!null o_shippriority:17!null
 ├── internal-ordering: -38,+14
 ├── cardinality: [0 - 10]
 ├── immutable
 ├── key: (20)
 ├── fd: (20)-->(14,17,38)
 ├── ordering: -38,+14
 ├── sort
 │    ├── columns: o_orderdate:14!null o_shippriority:17!null l_orderkey:20!null sum:38!null
 │    ├── immutable
 │    ├── key: (20)
 │    ├── fd: (20)-->(14,17,38)
 │    ├── ordering: -38,+14
 │    ├── limit hint: 10.00
 │    └── group-by
 │         ├── columns: o_orderdate:14!null o_shippriority:17!null l_orderkey:20!null sum:38!null
 │         ├── grouping columns: l_orderkey:20!null
 │         ├── immutable
 │         ├── key: (20)
 │         ├── fd: (20)-->(14,17,38)
 │         ├── project
 │         │    ├── columns: column37:37!null o_orderdate:14!null o_shippriority:17!null l_orderkey:20!null
 │         │    ├── immutable
 │         │    ├── fd: (20)-->(14,17)
 │         │    ├── inner-join (lookup lineitem)
 │         │    │    ├── columns: c_custkey:1!null c_mktsegment:7!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null o_shippriority:17!null l_orderkey:20!null l_extendedprice:25!null l_discount:26!null l_shipdate:30!null
 │         │    │    ├── key columns: [10] = [20]
 │         │    │    ├── fd: ()-->(7), (10)-->(11,14,17), (10)==(20), (20)==(10), (1)==(11), (11)==(1)
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: c_custkey:1!null c_mktsegment:7!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null o_shippriority:17!null
 │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    ├── key: (10)
 │         │    │    │    ├── fd: ()-->(7), (10)-->(11,14,17), (1)==(11), (11)==(1)
 │         │    │    │    ├── select
 │         │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_orderdate:14!null o_shippriority:17!null
 │         │    │    │    │    ├── key: (10)
 │         │    │    │    │    ├── fd: (10)-->(11,14,17)
 │         │    │    │    │    ├── scan orders
 │         │    │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_orderdate:14!null o_shippriority:17!null
 │         │    │    │    │    │    ├── key: (10)
 │         │    │    │    │    │    └── fd: (10)-->(11,14,17)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── o_orderdate:14 < '1995-03-15' [outer=(14), constraints=(/14: (/NULL - /'1995-03-14']; tight)]
 │         │    │    │    ├── select
 │         │    │    │    │    ├── columns: c_custkey:1!null c_mktsegment:7!null
 │         │    │    │    │    ├── key: (1)
 │         │    │    │    │    ├── fd: ()-->(7)
 │         │    │    │    │    ├── scan customer
 │         │    │    │    │    │    ├── columns: c_custkey:1!null c_mktsegment:7!null
 │         │    │    │    │    │    ├── key: (1)
 │         │    │    │    │    │    └── fd: (1)-->(7)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── c_mktsegment:7 = 'BUILDING' [outer=(7), constraints=(/7: [/'BUILDING' - /'BUILDING']; tight), fd=()-->(7)]
 │         │    │    │    └── filters
 │         │    │    │         └── c_custkey:1 = o_custkey:11 [outer=(1,11), constraints=(/1: (/NULL - ]; /11: (/NULL - ]), fd=(1)==(11), (11)==(1)]
 │         │    │    └── filters
 │         │    │         └── l_shipdate:30 > '1995-03-15' [outer=(30), constraints=(/30: [/'1995-03-16' - ]; tight)]
 │         │    └── projections
 │         │         └── l_extendedprice:25 * (1.0 - l_discount:26) [as=column37:37, outer=(25,26), immutable]
 │         └── aggregations
 │              ├── sum [as=sum:38, outer=(37)]
 │              │    └── column37:37
 │              ├── const-agg [as=o_orderdate:14, outer=(14)]
 │              │    └── o_orderdate:14
 │              └── const-agg [as=o_shippriority:17, outer=(17)]
 │                   └── o_shippriority:17
 └── 10

# --------------------------------------------------
# Q4
# Order Priority Checking
# Determines how well the order priority system is working and gives an
# assessment of customer satisfaction.
#
# Counts the number of orders ordered in a given quarter of a given year in
# which at least one lineitem was received by the customer later than its
# committed date. The query lists the count of such orders for each order
# priority sorted in ascending priority order.
# --------------------------------------------------
opt
SELECT
    o_orderpriority,
    count(*) AS order_count
FROM
    orders
WHERE
    o_orderdate >= DATE '1993-07-01'
    AND o_orderdate < DATE '1993-07-01' + INTERVAL '3' MONTH
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem
        WHERE
            l_orderkey = o_orderkey
            AND l_commitDATE < l_receiptdate
    )
GROUP BY
    o_orderpriority
ORDER BY
    o_orderpriority;
----
sort
 ├── columns: o_orderpriority:6!null order_count:28!null
 ├── key: (6)
 ├── fd: (6)-->(28)
 ├── ordering: +6
 └── group-by
      ├── columns: o_orderpriority:6!null count_rows:28!null
      ├── grouping columns: o_orderpriority:6!null
      ├── key: (6)
      ├── fd: (6)-->(28)
      ├── semi-join (lookup lineitem)
      │    ├── columns: o_orderkey:1!null o_orderdate:5!null o_orderpriority:6!null
      │    ├── key columns: [1] = [11]
      │    ├── key: (1)
      │    ├── fd: (1)-->(5,6)
      │    ├── index-join orders
      │    │    ├── columns: o_orderkey:1!null o_orderdate:5!null o_orderpriority:6!null
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    └── scan orders@o_od
      │    │         ├── columns: o_orderkey:1!null o_orderdate:5!null
      │    │         ├── constraint: /5/1: [/'1993-07-01' - /'1993-09-30']
      │    │         ├── key: (1)
      │    │         └── fd: (1)-->(5)
      │    └── filters
      │         └── l_commitdate:22 < l_receiptdate:23 [outer=(22,23), constraints=(/22: (/NULL - ]; /23: (/NULL - ])]
      └── aggregations
           └── count-rows [as=count_rows:28]

# --------------------------------------------------
# Q5
# Local Supplier Volume
# Lists the revenue volume done through local suppliers.
#
# Lists for each nation in a region the revenue volume that resulted from
# lineitem transactions in which the customer ordering parts and the supplier
# filling them were both within that nation. The query is run in order to
# determine whether to institute local distribution centers in a given region.
# The query considers only parts ordered in a given year. The query displays the
# nations and revenue volume in descending order by revenue. Revenue volume for
# all qualifying lineitems in a particular nation is defined as
# sum(l_extendedprice * (1 - l_discount)).
# --------------------------------------------------
opt
SELECT
    n_name,
    sum(l_extendedprice * (1 - l_discount)) AS revenue
FROM
    customer,
    orders,
    lineitem,
    supplier,
    nation,
    region
WHERE
    c_custkey = o_custkey
    AND l_orderkey = o_orderkey
    AND l_suppkey = s_suppkey
    AND c_nationkey = s_nationkey
    AND s_nationkey = n_nationkey
    AND n_regionkey = r_regionkey
    AND r_name = 'ASIA'
    AND o_orderDATE >= DATE '1994-01-01'
    AND o_orderDATE < DATE '1994-01-01' + INTERVAL '1' YEAR
GROUP BY
    n_name
ORDER BY
    revenue DESC;
----
sort
 ├── columns: n_name:46!null revenue:55!null
 ├── immutable
 ├── key: (46)
 ├── fd: (46)-->(55)
 ├── ordering: -55
 └── group-by
      ├── columns: n_name:46!null sum:55!null
      ├── grouping columns: n_name:46!null
      ├── immutable
      ├── key: (46)
      ├── fd: (46)-->(55)
      ├── project
      │    ├── columns: column54:54!null n_name:46!null
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: c_custkey:1!null c_nationkey:4!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null l_orderkey:20!null l_suppkey:22!null l_extendedprice:25!null l_discount:26!null s_suppkey:37!null s_nationkey:40!null n_nationkey:45!null n_name:46!null n_regionkey:47!null r_regionkey:50!null r_name:51!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(51), (1)-->(4), (10)-->(11,14), (37)-->(40), (45)-->(46,47), (47)==(50), (50)==(47), (40)==(4,45), (45)==(4,40), (22)==(37), (37)==(22), (10)==(20), (20)==(10), (1)==(11), (11)==(1), (4)==(40,45)
      │    │    ├── inner-join (lookup lineitem)
      │    │    │    ├── columns: c_custkey:1!null c_nationkey:4!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null l_orderkey:20!null l_suppkey:22!null l_extendedprice:25!null l_discount:26!null n_nationkey:45!null n_name:46!null n_regionkey:47!null r_regionkey:50!null r_name:51!null
      │    │    │    ├── key columns: [10] = [20]
      │    │    │    ├── fd: ()-->(51), (10)-->(11,14), (1)-->(4), (45)-->(46,47), (47)==(50), (50)==(47), (4)==(45), (45)==(4), (1)==(11), (11)==(1), (10)==(20), (20)==(10)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: c_custkey:1!null c_nationkey:4!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null n_nationkey:45!null n_name:46!null n_regionkey:47!null r_regionkey:50!null r_name:51!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── key: (10)
      │    │    │    │    ├── fd: ()-->(51), (10)-->(11,14), (1)-->(4), (45)-->(46,47), (47)==(50), (50)==(47), (4)==(45), (45)==(4), (1)==(11), (11)==(1)
      │    │    │    │    ├── index-join orders
      │    │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_orderdate:14!null
      │    │    │    │    │    ├── key: (10)
      │    │    │    │    │    ├── fd: (10)-->(11,14)
      │    │    │    │    │    └── scan orders@o_od
      │    │    │    │    │         ├── columns: o_orderkey:10!null o_orderdate:14!null
      │    │    │    │    │         ├── constraint: /14/10: [/'1994-01-01' - /'1994-12-31']
      │    │    │    │    │         ├── key: (10)
      │    │    │    │    │         └── fd: (10)-->(14)
      │    │    │    │    ├── inner-join (lookup customer@c_nk)
      │    │    │    │    │    ├── columns: c_custkey:1!null c_nationkey:4!null n_nationkey:45!null n_name:46!null n_regionkey:47!null r_regionkey:50!null r_name:51!null
      │    │    │    │    │    ├── key columns: [45] = [4]
      │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    ├── fd: ()-->(51), (1)-->(4), (45)-->(46,47), (47)==(50), (50)==(47), (4)==(45), (45)==(4)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: n_nationkey:45!null n_name:46!null n_regionkey:47!null r_regionkey:50!null r_name:51!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── key: (45)
      │    │    │    │    │    │    ├── fd: ()-->(51), (45)-->(46,47), (47)==(50), (50)==(47)
      │    │    │    │    │    │    ├── scan nation
      │    │    │    │    │    │    │    ├── columns: n_nationkey:45!null n_name:46!null n_regionkey:47!null
      │    │    │    │    │    │    │    ├── key: (45)
      │    │    │    │    │    │    │    └── fd: (45)-->(46,47)
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: r_regionkey:50!null r_name:51!null
      │    │    │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    │    │    ├── fd: ()-->(51)
      │    │    │    │    │    │    │    ├── scan region
      │    │    │    │    │    │    │    │    ├── columns: r_regionkey:50!null r_name:51!null
      │    │    │    │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    │    │    │    └── fd: (50)-->(51)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── r_name:51 = 'ASIA' [outer=(51), constraints=(/51: [/'ASIA' - /'ASIA']; tight), fd=()-->(51)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── n_regionkey:47 = r_regionkey:50 [outer=(47,50), constraints=(/47: (/NULL - ]; /50: (/NULL - ]), fd=(47)==(50), (50)==(47)]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    └── filters
      │    │    │    │         └── c_custkey:1 = o_custkey:11 [outer=(1,11), constraints=(/1: (/NULL - ]; /11: (/NULL - ]), fd=(1)==(11), (11)==(1)]
      │    │    │    └── filters (true)
      │    │    ├── scan supplier@s_nk
      │    │    │    ├── columns: s_suppkey:37!null s_nationkey:40!null
      │    │    │    ├── key: (37)
      │    │    │    └── fd: (37)-->(40)
      │    │    └── filters
      │    │         ├── s_nationkey:40 = n_nationkey:45 [outer=(40,45), constraints=(/40: (/NULL - ]; /45: (/NULL - ]), fd=(40)==(45), (45)==(40)]
      │    │         └── l_suppkey:22 = s_suppkey:37 [outer=(22,37), constraints=(/22: (/NULL - ]; /37: (/NULL - ]), fd=(22)==(37), (37)==(22)]
      │    └── projections
      │         └── l_extendedprice:25 * (1.0 - l_discount:26) [as=column54:54, outer=(25,26), immutable]
      └── aggregations
           └── sum [as=sum:55, outer=(54)]
                └── column54:54

# --------------------------------------------------
# Q6
# Forecasting Revenue Change
# Quantifies the amount of revenue increase that would have resulted from
# eliminating certain companywide discounts in a given percentage range in a
# given year. Asking this type of "what if" query can be used to look for ways
# to increase revenues.
#
# Considers all the lineitems shipped in a given year with discounts between
# DISCOUNT-0.01 and DISCOUNT+0.01. The query lists the amount by which the total
# revenue would have increased if these discounts had been eliminated for
# lineitems with l_quantity less than quantity. Note that the potential revenue
# increase is equal to the sum of [l_extendedprice * l_discount] for all
# lineitems with discounts and quantities in the qualifying range.
# --------------------------------------------------
opt
SELECT
    sum(l_extendedprice * l_discount) AS revenue
FROM
    lineitem
WHERE
    l_shipdate >= DATE '1994-01-01'
    AND l_shipdate < DATE '1994-01-01' + INTERVAL '1' YEAR
    AND l_discount BETWEEN 0.06 - 0.01 AND 0.06 + 0.01
    AND l_quantity < 24;
----
scalar-group-by
 ├── columns: revenue:19
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(19)
 ├── project
 │    ├── columns: column18:18!null
 │    ├── immutable
 │    ├── select
 │    │    ├── columns: l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_shipdate:11!null
 │    │    ├── index-join lineitem
 │    │    │    ├── columns: l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_shipdate:11!null
 │    │    │    └── scan lineitem@l_sd
 │    │    │         ├── columns: l_orderkey:1!null l_linenumber:4!null l_shipdate:11!null
 │    │    │         ├── constraint: /11/1/4: [/'1994-01-01' - /'1994-12-31']
 │    │    │         ├── key: (1,4)
 │    │    │         └── fd: (1,4)-->(11)
 │    │    └── filters
 │    │         ├── (l_discount:7 >= 0.05) AND (l_discount:7 <= 0.07) [outer=(7), constraints=(/7: [/0.05 - /0.07]; tight)]
 │    │         └── l_quantity:5 < 24.0 [outer=(5), constraints=(/5: (/NULL - /23.999999999999996]; tight)]
 │    └── projections
 │         └── l_extendedprice:6 * l_discount:7 [as=column18:18, outer=(6,7), immutable]
 └── aggregations
      └── sum [as=sum:19, outer=(18)]
           └── column18:18

# --------------------------------------------------
# Q7
# Volume Shipping
# Determines the value of goods shipped between certain nations to help in the
# re-negotiation of shipping contracts.
#
# Finds, for two given nations, the gross discounted revenues derived from
# lineitems in which parts were shipped from a supplier in either nation to a
# customer in the other nation during 1995 and 1996. The query lists the
# supplier nation, the customer nation, the year, and the revenue from shipments
# that took place in that year. The query orders the answer by Supplier nation,
# Customer nation, and year (all ascending).
# --------------------------------------------------
opt
SELECT
    supp_nation,
    cust_nation,
    l_year, sum(volume) AS revenue
FROM (
    SELECT
        n1.n_name AS supp_nation,
        n2.n_name AS cust_nation,
        extract(year FROM l_shipdate) AS l_year,
        l_extendedprice * (1 - l_discount) AS volume
    FROM
        supplier,
        lineitem,
        orders,
        customer,
        nation n1,
        nation n2
    WHERE
        s_suppkey = l_suppkey
        AND o_orderkey = l_orderkey
        AND c_custkey = o_custkey
        AND s_nationkey = n1.n_nationkey
        AND c_nationkey = n2.n_nationkey
        AND (
            (n1.n_name = 'FRANCE' AND n2.n_name = 'GERMANY')
            or (n1.n_name = 'GERMANY' AND n2.n_name = 'FRANCE')
        )
        AND l_shipdate BETWEEN DATE '1995-01-01' AND DATE '1996-12-31'
    ) AS shipping
GROUP BY
    supp_nation,
    cust_nation,
    l_year
ORDER BY
    supp_nation,
    cust_nation,
    l_year;
----
sort
 ├── columns: supp_nation:46!null cust_nation:51!null l_year:55 revenue:57!null
 ├── immutable
 ├── key: (46,51,55)
 ├── fd: (46,51,55)-->(57)
 ├── ordering: +46,+51,+55
 └── group-by
      ├── columns: n1.n_name:46!null n2.n_name:51!null l_year:55 sum:57!null
      ├── grouping columns: n1.n_name:46!null n2.n_name:51!null l_year:55
      ├── immutable
      ├── key: (46,51,55)
      ├── fd: (46,51,55)-->(57)
      ├── project
      │    ├── columns: l_year:55 volume:56!null n1.n_name:46!null n2.n_name:51!null
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null l_orderkey:9!null l_suppkey:11!null l_extendedprice:14!null l_discount:15!null l_shipdate:19!null o_orderkey:26!null o_custkey:27!null c_custkey:36!null c_nationkey:39!null n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    ├── fd: (1)-->(4), (26)-->(27), (36)-->(39), (45)-->(46), (50)-->(51), (39)==(50), (50)==(39), (27)==(36), (36)==(27), (9)==(26), (26)==(9), (1)==(11), (11)==(1), (4)==(45), (45)==(4)
      │    │    ├── scan customer@c_nk
      │    │    │    ├── columns: c_custkey:36!null c_nationkey:39!null
      │    │    │    ├── key: (36)
      │    │    │    └── fd: (36)-->(39)
      │    │    ├── inner-join (lookup orders)
      │    │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null l_orderkey:9!null l_suppkey:11!null l_extendedprice:14!null l_discount:15!null l_shipdate:19!null o_orderkey:26!null o_custkey:27!null n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    ├── key columns: [9] = [26]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── fd: (26)-->(27), (1)-->(4), (45)-->(46), (50)-->(51), (4)==(45), (45)==(4), (1)==(11), (11)==(1), (9)==(26), (26)==(9)
      │    │    │    ├── inner-join (lookup lineitem)
      │    │    │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null l_orderkey:9!null l_suppkey:11!null l_extendedprice:14!null l_discount:15!null l_shipdate:19!null n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    │    ├── key columns: [9 12] = [9 12]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── fd: (1)-->(4), (45)-->(46), (50)-->(51), (4)==(45), (45)==(4), (1)==(11), (11)==(1)
      │    │    │    │    ├── inner-join (lookup lineitem@l_sk)
      │    │    │    │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null l_orderkey:9!null l_suppkey:11!null l_linenumber:12!null n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    │    │    ├── key columns: [1] = [11]
      │    │    │    │    │    ├── key: (9,12,50)
      │    │    │    │    │    ├── fd: (1)-->(4), (45)-->(46), (50)-->(51), (4)==(45), (45)==(4), (9,12)-->(11), (1)==(11), (11)==(1)
      │    │    │    │    │    ├── inner-join (lookup supplier@s_nk)
      │    │    │    │    │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    │    │    │    ├── key columns: [45] = [4]
      │    │    │    │    │    │    ├── key: (1,50)
      │    │    │    │    │    │    ├── fd: (1)-->(4), (45)-->(46), (50)-->(51), (4)==(45), (45)==(4)
      │    │    │    │    │    │    ├── inner-join (cross)
      │    │    │    │    │    │    │    ├── columns: n1.n_nationkey:45!null n1.n_name:46!null n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    │    │    │    │    ├── key: (45,50)
      │    │    │    │    │    │    │    ├── fd: (45)-->(46), (50)-->(51)
      │    │    │    │    │    │    │    ├── scan nation [as=n1]
      │    │    │    │    │    │    │    │    ├── columns: n1.n_nationkey:45!null n1.n_name:46!null
      │    │    │    │    │    │    │    │    ├── key: (45)
      │    │    │    │    │    │    │    │    └── fd: (45)-->(46)
      │    │    │    │    │    │    │    ├── scan nation [as=n2]
      │    │    │    │    │    │    │    │    ├── columns: n2.n_nationkey:50!null n2.n_name:51!null
      │    │    │    │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    │    │    │    └── fd: (50)-->(51)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── ((n1.n_name:46 = 'FRANCE') AND (n2.n_name:51 = 'GERMANY')) OR ((n1.n_name:46 = 'GERMANY') AND (n2.n_name:51 = 'FRANCE')) [outer=(46,51), constraints=(/46: [/'FRANCE' - /'FRANCE'] [/'GERMANY' - /'GERMANY']; /51: [/'FRANCE' - /'FRANCE'] [/'GERMANY' - /'GERMANY'])]
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    └── filters (true)
      │    │    │    │    └── filters
      │    │    │    │         └── (l_shipdate:19 >= '1995-01-01') AND (l_shipdate:19 <= '1996-12-31') [outer=(19), constraints=(/19: [/'1995-01-01' - /'1996-12-31']; tight)]
      │    │    │    └── filters (true)
      │    │    └── filters
      │    │         ├── c_nationkey:39 = n2.n_nationkey:50 [outer=(39,50), constraints=(/39: (/NULL - ]; /50: (/NULL - ]), fd=(39)==(50), (50)==(39)]
      │    │         └── c_custkey:36 = o_custkey:27 [outer=(27,36), constraints=(/27: (/NULL - ]; /36: (/NULL - ]), fd=(27)==(36), (36)==(27)]
      │    └── projections
      │         ├── extract('year', l_shipdate:19) [as=l_year:55, outer=(19), immutable]
      │         └── l_extendedprice:14 * (1.0 - l_discount:15) [as=volume:56, outer=(14,15), immutable]
      └── aggregations
           └── sum [as=sum:57, outer=(56)]
                └── volume:56

# --------------------------------------------------
# Q8
# National Market Share
# Determines how the market share of a given nation within a given region has
# changed over two years for a given part type.
#
# The market share for a given nation within a given region is defined as the
# fraction of the revenue, the sum of [l_extendedprice * (1-l_discount)], from
# the products of a specified type in that region that was supplied by suppliers
# from the given nation. The query determines this for the years 1995 and 1996
# presented in this order.
# --------------------------------------------------
opt
SELECT
    o_year,
    sum(CASE
        WHEN nation = 'BRAZIL'
            THEN volume
        ELSE 0
    END) / sum(volume) AS mkt_share
FROM (
    SELECT
        extract(year FROM o_orderdate) AS o_year,
        l_extendedprice * (1 - l_discount) AS volume,
        n2.n_name AS nation
    FROM
        part,
        supplier,
        lineitem,
        orders,
        customer,
        nation n1,
        nation n2,
        region
    WHERE
        p_partkey = l_partkey
        AND s_suppkey = l_suppkey
        AND l_orderkey = o_orderkey
        AND o_custkey = c_custkey
        AND c_nationkey = n1.n_nationkey
        AND n1.n_regionkey = r_regionkey
        AND r_name = 'AMERICA'
        AND s_nationkey = n2.n_nationkey
        AND o_orderdate BETWEEN DATE '1995-01-01' AND DATE '1996-12-31'
        AND p_type = 'ECONOMY ANODIZED STEEL'
    ) AS all_nations
GROUP BY
    o_year
ORDER BY
    o_year;
----
sort
 ├── columns: o_year:69 mkt_share:74!null
 ├── immutable
 ├── key: (69)
 ├── fd: (69)-->(74)
 ├── ordering: +69
 └── project
      ├── columns: mkt_share:74!null o_year:69
      ├── immutable
      ├── key: (69)
      ├── fd: (69)-->(74)
      ├── group-by
      │    ├── columns: o_year:69 sum:72!null sum:73!null
      │    ├── grouping columns: o_year:69
      │    ├── immutable
      │    ├── key: (69)
      │    ├── fd: (69)-->(72,73)
      │    ├── project
      │    │    ├── columns: column71:71!null o_year:69 volume:70!null
      │    │    ├── immutable
      │    │    ├── project
      │    │    │    ├── columns: o_year:69 volume:70!null n2.n_name:61!null
      │    │    │    ├── immutable
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null s_suppkey:11!null s_nationkey:14!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_extendedprice:24!null l_discount:25!null o_orderkey:36!null o_custkey:37!null o_orderdate:40!null c_custkey:46!null c_nationkey:49!null n1.n_nationkey:55!null n1.n_regionkey:57!null n2.n_nationkey:60!null n2.n_name:61!null r_regionkey:65!null r_name:66!null
      │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(5,66), (11)-->(14), (36)-->(37,40), (46)-->(49), (55)-->(57), (57)==(65), (65)==(57), (49)==(55), (55)==(49), (37)==(46), (46)==(37), (19)==(36), (36)==(19), (11)==(21), (21)==(11), (60)-->(61), (14)==(60), (60)==(14), (1)==(20), (20)==(1)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null s_suppkey:11!null s_nationkey:14!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_extendedprice:24!null l_discount:25!null o_orderkey:36!null o_custkey:37!null o_orderdate:40!null c_custkey:46!null c_nationkey:49!null n1.n_nationkey:55!null n1.n_regionkey:57!null r_regionkey:65!null r_name:66!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
      │    │    │    │    │    ├── fd: ()-->(5,66), (11)-->(14), (36)-->(37,40), (46)-->(49), (55)-->(57), (57)==(65), (65)==(57), (49)==(55), (55)==(49), (37)==(46), (46)==(37), (19)==(36), (36)==(19), (11)==(21), (21)==(11), (1)==(20), (20)==(1)
      │    │    │    │    │    ├── scan supplier@s_nk
      │    │    │    │    │    │    ├── columns: s_suppkey:11!null s_nationkey:14!null
      │    │    │    │    │    │    ├── key: (11)
      │    │    │    │    │    │    └── fd: (11)-->(14)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_extendedprice:24!null l_discount:25!null o_orderkey:36!null o_custkey:37!null o_orderdate:40!null c_custkey:46!null c_nationkey:49!null n1.n_nationkey:55!null n1.n_regionkey:57!null r_regionkey:65!null r_name:66!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    │    │    │    │    ├── fd: ()-->(5,66), (36)-->(37,40), (46)-->(49), (55)-->(57), (57)==(65), (65)==(57), (49)==(55), (55)==(49), (37)==(46), (46)==(37), (19)==(36), (36)==(19), (1)==(20), (20)==(1)
      │    │    │    │    │    │    ├── inner-join (lookup customer@c_nk)
      │    │    │    │    │    │    │    ├── columns: c_custkey:46!null c_nationkey:49!null n1.n_nationkey:55!null n1.n_regionkey:57!null r_regionkey:65!null r_name:66!null
      │    │    │    │    │    │    │    ├── key columns: [55] = [49]
      │    │    │    │    │    │    │    ├── key: (46)
      │    │    │    │    │    │    │    ├── fd: ()-->(66), (46)-->(49), (55)-->(57), (57)==(65), (65)==(57), (49)==(55), (55)==(49)
      │    │    │    │    │    │    │    ├── inner-join (lookup nation@n_rk [as=n1])
      │    │    │    │    │    │    │    │    ├── columns: n1.n_nationkey:55!null n1.n_regionkey:57!null r_regionkey:65!null r_name:66!null
      │    │    │    │    │    │    │    │    ├── key columns: [65] = [57]
      │    │    │    │    │    │    │    │    ├── key: (55)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(66), (55)-->(57), (57)==(65), (65)==(57)
      │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    ├── columns: r_regionkey:65!null r_name:66!null
      │    │    │    │    │    │    │    │    │    ├── key: (65)
      │    │    │    │    │    │    │    │    │    ├── fd: ()-->(66)
      │    │    │    │    │    │    │    │    │    ├── scan region
      │    │    │    │    │    │    │    │    │    │    ├── columns: r_regionkey:65!null r_name:66!null
      │    │    │    │    │    │    │    │    │    │    ├── key: (65)
      │    │    │    │    │    │    │    │    │    │    └── fd: (65)-->(66)
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         └── r_name:66 = 'AMERICA' [outer=(66), constraints=(/66: [/'AMERICA' - /'AMERICA']; tight), fd=()-->(66)]
      │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    ├── inner-join (lookup orders)
      │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_extendedprice:24!null l_discount:25!null o_orderkey:36!null o_custkey:37!null o_orderdate:40!null
      │    │    │    │    │    │    │    ├── key columns: [19] = [36]
      │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    ├── fd: ()-->(5), (36)-->(37,40), (19)==(36), (36)==(19), (1)==(20), (20)==(1)
      │    │    │    │    │    │    │    ├── inner-join (lookup lineitem)
      │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_extendedprice:24!null l_discount:25!null
      │    │    │    │    │    │    │    │    ├── key columns: [19 22] = [19 22]
      │    │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    │    ├── fd: ()-->(5), (1)==(20), (20)==(1)
      │    │    │    │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk)
      │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null l_orderkey:19!null l_partkey:20!null l_linenumber:22!null
      │    │    │    │    │    │    │    │    │    ├── key columns: [1] = [20]
      │    │    │    │    │    │    │    │    │    ├── key: (19,22)
      │    │    │    │    │    │    │    │    │    ├── fd: ()-->(5), (19,22)-->(20), (1)==(20), (20)==(1)
      │    │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null
      │    │    │    │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(5)
      │    │    │    │    │    │    │    │    │    │    ├── scan part
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_type:5!null
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    │    │    │    │    └── fd: (1)-->(5)
      │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │         └── p_type:5 = 'ECONOMY ANODIZED STEEL' [outer=(5), constraints=(/5: [/'ECONOMY ANODIZED STEEL' - /'ECONOMY ANODIZED STEEL']; tight), fd=()-->(5)]
      │    │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── (o_orderdate:40 >= '1995-01-01') AND (o_orderdate:40 <= '1996-12-31') [outer=(40), constraints=(/40: [/'1995-01-01' - /'1996-12-31']; tight)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── o_custkey:37 = c_custkey:46 [outer=(37,46), constraints=(/37: (/NULL - ]; /46: (/NULL - ]), fd=(37)==(46), (46)==(37)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── s_suppkey:11 = l_suppkey:21 [outer=(11,21), constraints=(/11: (/NULL - ]; /21: (/NULL - ]), fd=(11)==(21), (21)==(11)]
      │    │    │    │    ├── scan nation [as=n2]
      │    │    │    │    │    ├── columns: n2.n_nationkey:60!null n2.n_name:61!null
      │    │    │    │    │    ├── key: (60)
      │    │    │    │    │    └── fd: (60)-->(61)
      │    │    │    │    └── filters
      │    │    │    │         └── s_nationkey:14 = n2.n_nationkey:60 [outer=(14,60), constraints=(/14: (/NULL - ]; /60: (/NULL - ]), fd=(14)==(60), (60)==(14)]
      │    │    │    └── projections
      │    │    │         ├── extract('year', o_orderdate:40) [as=o_year:69, outer=(40), immutable]
      │    │    │         └── l_extendedprice:24 * (1.0 - l_discount:25) [as=volume:70, outer=(24,25), immutable]
      │    │    └── projections
      │    │         └── CASE WHEN n2.n_name:61 = 'BRAZIL' THEN volume:70 ELSE 0.0 END [as=column71:71, outer=(61,70)]
      │    └── aggregations
      │         ├── sum [as=sum:72, outer=(71)]
      │         │    └── column71:71
      │         └── sum [as=sum:73, outer=(70)]
      │              └── volume:70
      └── projections
           └── sum:72 / sum:73 [as=mkt_share:74, outer=(72,73), immutable]

# --------------------------------------------------
# Q9
# Product Type Profit Measure
# Determines how much profit is made on a given line of parts, broken out by
# supplier nation and year.
#
# Finds, for each nation and each year, the profit for all parts ordered in that
# year that contain a specified substring in their names and that were filled by
# a supplier in that nation. The profit is defined as the sum of:
#
#   [(l_extendedprice*(1-l_discount)) - (ps_supplycost * l_quantity)]
#
# for all lineitems describing parts in the specified line. The query lists the
#  nations in ascending alphabetical order and, for each nation, the year and
#  profit in descending order by year (most recent first).
# --------------------------------------------------
opt
SELECT
    nation,
    o_year,
    sum(amount) AS sum_profit
FROM (
    SELECT
        n_name AS nation,
        extract(year FROM o_orderdate) AS o_year,
        l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity AS amount
    FROM
        part,
        supplier,
        lineitem,
        partsupp,
        orders,
        nation
    WHERE
        s_suppkey = l_suppkey
        AND ps_suppkey = l_suppkey
        AND ps_partkey = l_partkey
        AND p_partkey = l_partkey
        AND o_orderkey = l_orderkey
        AND s_nationkey = n_nationkey
        AND p_name LIKE '%green%'
    ) AS profit
GROUP BY
    nation,
    o_year
ORDER BY
    nation,
    o_year DESC;
----
sort
 ├── columns: nation:53!null o_year:57 sum_profit:59!null
 ├── immutable
 ├── key: (53,57)
 ├── fd: (53,57)-->(59)
 ├── ordering: +53,-57
 └── group-by
      ├── columns: n_name:53!null o_year:57 sum:59!null
      ├── grouping columns: n_name:53!null o_year:57
      ├── immutable
      ├── key: (53,57)
      ├── fd: (53,57)-->(59)
      ├── project
      │    ├── columns: o_year:57 amount:58!null n_name:53!null
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: p_partkey:1!null p_name:2!null s_suppkey:11!null s_nationkey:14!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_quantity:23!null l_extendedprice:24!null l_discount:25!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null o_orderkey:42!null o_orderdate:46!null n_nationkey:52!null n_name:53!null
      │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
      │    │    ├── fd: (1)-->(2), (11)-->(14), (36,37)-->(39), (21)==(11,37), (37)==(11,21), (20)==(1,36), (36)==(1,20), (42)-->(46), (19)==(42), (42)==(19), (11)==(21,37), (52)-->(53), (14)==(52), (52)==(14), (1)==(20,36)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: p_partkey:1!null p_name:2!null s_suppkey:11!null s_nationkey:14!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_quantity:23!null l_extendedprice:24!null l_discount:25!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null o_orderkey:42!null o_orderdate:46!null
      │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
      │    │    │    ├── fd: (1)-->(2), (11)-->(14), (36,37)-->(39), (21)==(11,37), (37)==(11,21), (20)==(1,36), (36)==(1,20), (42)-->(46), (19)==(42), (42)==(19), (11)==(21,37), (1)==(20,36)
      │    │    │    ├── scan supplier@s_nk
      │    │    │    │    ├── columns: s_suppkey:11!null s_nationkey:14!null
      │    │    │    │    ├── key: (11)
      │    │    │    │    └── fd: (11)-->(14)
      │    │    │    ├── inner-join (lookup orders)
      │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_quantity:23!null l_extendedprice:24!null l_discount:25!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null o_orderkey:42!null o_orderdate:46!null
      │    │    │    │    ├── key columns: [19] = [42]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── fd: (1)-->(2), (36,37)-->(39), (21)==(37), (37)==(21), (20)==(1,36), (36)==(1,20), (42)-->(46), (19)==(42), (42)==(19), (1)==(20,36)
      │    │    │    │    ├── inner-join (lookup lineitem)
      │    │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_quantity:23!null l_extendedprice:24!null l_discount:25!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null
      │    │    │    │    │    ├── key columns: [19 22] = [19 22]
      │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    ├── fd: (1)-->(2), (36,37)-->(39), (21)==(37), (37)==(21), (20)==(1,36), (36)==(1,20), (1)==(20,36)
      │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk_sk)
      │    │    │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null l_orderkey:19!null l_partkey:20!null l_suppkey:21!null l_linenumber:22!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null
      │    │    │    │    │    │    ├── key columns: [36 37] = [20 21]
      │    │    │    │    │    │    ├── key: (19,22)
      │    │    │    │    │    │    ├── fd: (1)-->(2), (36,37)-->(39), (1)==(20,36), (36)==(1,20), (19,22)-->(20,21), (20)==(1,36), (21)==(37), (37)==(21)
      │    │    │    │    │    │    ├── inner-join (merge)
      │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null
      │    │    │    │    │    │    │    ├── left ordering: +1
      │    │    │    │    │    │    │    ├── right ordering: +36
      │    │    │    │    │    │    │    ├── key: (36,37)
      │    │    │    │    │    │    │    ├── fd: (1)-->(2), (36,37)-->(39), (1)==(36), (36)==(1)
      │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null
      │    │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    │    ├── fd: (1)-->(2)
      │    │    │    │    │    │    │    │    ├── ordering: +1
      │    │    │    │    │    │    │    │    ├── scan part
      │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:1!null p_name:2!null
      │    │    │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    │    │    ├── fd: (1)-->(2)
      │    │    │    │    │    │    │    │    │    └── ordering: +1
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── p_name:2 LIKE '%green%' [outer=(2), constraints=(/2: (/NULL - ])]
      │    │    │    │    │    │    │    ├── scan partsupp
      │    │    │    │    │    │    │    │    ├── columns: ps_partkey:36!null ps_suppkey:37!null ps_supplycost:39!null
      │    │    │    │    │    │    │    │    ├── key: (36,37)
      │    │    │    │    │    │    │    │    ├── fd: (36,37)-->(39)
      │    │    │    │    │    │    │    │    └── ordering: +36
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    └── filters (true)
      │    │    │    │    └── filters (true)
      │    │    │    └── filters
      │    │    │         └── s_suppkey:11 = l_suppkey:21 [outer=(11,21), constraints=(/11: (/NULL - ]; /21: (/NULL - ]), fd=(11)==(21), (21)==(11)]
      │    │    ├── scan nation
      │    │    │    ├── columns: n_nationkey:52!null n_name:53!null
      │    │    │    ├── key: (52)
      │    │    │    └── fd: (52)-->(53)
      │    │    └── filters
      │    │         └── s_nationkey:14 = n_nationkey:52 [outer=(14,52), constraints=(/14: (/NULL - ]; /52: (/NULL - ]), fd=(14)==(52), (52)==(14)]
      │    └── projections
      │         ├── extract('year', o_orderdate:46) [as=o_year:57, outer=(46), immutable]
      │         └── (l_extendedprice:24 * (1.0 - l_discount:25)) - (ps_supplycost:39 * l_quantity:23) [as=amount:58, outer=(23-25,39), immutable]
      └── aggregations
           └── sum [as=sum:59, outer=(58)]
                └── amount:58

# --------------------------------------------------
# Q10
# Returned Item Reporting
# Identifies customers who might be having problems with the parts that are
# shipped to them.
#
# Finds the top 20 customers, in terms of their effect on lost revenue for a
# given quarter, who have returned parts. The query considers only parts that
# were ordered in the specified quarter. The query lists the customer's name,
# address, nation, phone number, account balance, comment information and
# revenue lost. The customers are listed in descending order of lost revenue.
# Revenue lost is defined as sum(l_extendedprice*(1-l_discount)) for all
# qualifying lineitems.
# --------------------------------------------------
opt
SELECT
    c_custkey,
    c_name,
    sum(l_extendedprice * (1 - l_discount)) AS revenue,
    c_acctbal,
    n_name,
    c_address,
    c_phone,
    c_comment
FROM
    customer,
    orders,
    lineitem,
    nation
WHERE
    c_custkey = o_custkey
    AND l_orderkey = o_orderkey
    AND o_orderDATE >= DATE '1993-10-01'
    AND o_orderDATE < DATE '1993-10-01' + INTERVAL '3' MONTH
    AND l_returnflag = 'R'
    AND c_nationkey = n_nationkey
GROUP BY
    c_custkey,
    c_name,
    c_acctbal,
    c_phone,
    n_name,
    c_address,
    c_comment
ORDER BY
    revenue DESC
LIMIT 20;
----
limit
 ├── columns: c_custkey:1!null c_name:2!null revenue:43!null c_acctbal:6!null n_name:38!null c_address:3!null c_phone:5!null c_comment:8!null
 ├── internal-ordering: -43
 ├── cardinality: [0 - 20]
 ├── immutable
 ├── key: (1)
 ├── fd: (1)-->(2,3,5,6,8,38,43)
 ├── ordering: -43
 ├── sort
 │    ├── columns: c_custkey:1!null c_name:2!null c_address:3!null c_phone:5!null c_acctbal:6!null c_comment:8!null n_name:38!null sum:43!null
 │    ├── immutable
 │    ├── key: (1)
 │    ├── fd: (1)-->(2,3,5,6,8,38,43)
 │    ├── ordering: -43
 │    ├── limit hint: 20.00
 │    └── group-by
 │         ├── columns: c_custkey:1!null c_name:2!null c_address:3!null c_phone:5!null c_acctbal:6!null c_comment:8!null n_name:38!null sum:43!null
 │         ├── grouping columns: c_custkey:1!null
 │         ├── immutable
 │         ├── key: (1)
 │         ├── fd: (1)-->(2,3,5,6,8,38,43)
 │         ├── project
 │         │    ├── columns: column42:42!null c_custkey:1!null c_name:2!null c_address:3!null c_phone:5!null c_acctbal:6!null c_comment:8!null n_name:38!null
 │         │    ├── immutable
 │         │    ├── fd: (1)-->(2,3,5,6,8,38)
 │         │    ├── inner-join (hash)
 │         │    │    ├── columns: c_custkey:1!null c_name:2!null c_address:3!null c_nationkey:4!null c_phone:5!null c_acctbal:6!null c_comment:8!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null l_orderkey:20!null l_extendedprice:25!null l_discount:26!null l_returnflag:28!null n_nationkey:37!null n_name:38!null
 │         │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
 │         │    │    ├── fd: ()-->(28), (1)-->(2-6,8), (10)-->(11,14), (10)==(20), (20)==(10), (1)==(11), (11)==(1), (37)-->(38), (4)==(37), (37)==(4)
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: c_custkey:1!null c_name:2!null c_address:3!null c_nationkey:4!null c_phone:5!null c_acctbal:6!null c_comment:8!null o_orderkey:10!null o_custkey:11!null o_orderdate:14!null l_orderkey:20!null l_extendedprice:25!null l_discount:26!null l_returnflag:28!null
 │         │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
 │         │    │    │    ├── fd: ()-->(28), (1)-->(2-6,8), (10)-->(11,14), (10)==(20), (20)==(10), (1)==(11), (11)==(1)
 │         │    │    │    ├── scan customer
 │         │    │    │    │    ├── columns: c_custkey:1!null c_name:2!null c_address:3!null c_nationkey:4!null c_phone:5!null c_acctbal:6!null c_comment:8!null
 │         │    │    │    │    ├── key: (1)
 │         │    │    │    │    └── fd: (1)-->(2-6,8)
 │         │    │    │    ├── inner-join (lookup lineitem)
 │         │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_orderdate:14!null l_orderkey:20!null l_extendedprice:25!null l_discount:26!null l_returnflag:28!null
 │         │    │    │    │    ├── key columns: [10] = [20]
 │         │    │    │    │    ├── fd: ()-->(28), (10)-->(11,14), (10)==(20), (20)==(10)
 │         │    │    │    │    ├── index-join orders
 │         │    │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_orderdate:14!null
 │         │    │    │    │    │    ├── key: (10)
 │         │    │    │    │    │    ├── fd: (10)-->(11,14)
 │         │    │    │    │    │    └── scan orders@o_od
 │         │    │    │    │    │         ├── columns: o_orderkey:10!null o_orderdate:14!null
 │         │    │    │    │    │         ├── constraint: /14/10: [/'1993-10-01' - /'1993-12-31']
 │         │    │    │    │    │         ├── key: (10)
 │         │    │    │    │    │         └── fd: (10)-->(14)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── l_returnflag:28 = 'R' [outer=(28), constraints=(/28: [/'R' - /'R']; tight), fd=()-->(28)]
 │         │    │    │    └── filters
 │         │    │    │         └── c_custkey:1 = o_custkey:11 [outer=(1,11), constraints=(/1: (/NULL - ]; /11: (/NULL - ]), fd=(1)==(11), (11)==(1)]
 │         │    │    ├── scan nation
 │         │    │    │    ├── columns: n_nationkey:37!null n_name:38!null
 │         │    │    │    ├── key: (37)
 │         │    │    │    └── fd: (37)-->(38)
 │         │    │    └── filters
 │         │    │         └── c_nationkey:4 = n_nationkey:37 [outer=(4,37), constraints=(/4: (/NULL - ]; /37: (/NULL - ]), fd=(4)==(37), (37)==(4)]
 │         │    └── projections
 │         │         └── l_extendedprice:25 * (1.0 - l_discount:26) [as=column42:42, outer=(25,26), immutable]
 │         └── aggregations
 │              ├── sum [as=sum:43, outer=(42)]
 │              │    └── column42:42
 │              ├── const-agg [as=c_name:2, outer=(2)]
 │              │    └── c_name:2
 │              ├── const-agg [as=c_address:3, outer=(3)]
 │              │    └── c_address:3
 │              ├── const-agg [as=c_phone:5, outer=(5)]
 │              │    └── c_phone:5
 │              ├── const-agg [as=c_acctbal:6, outer=(6)]
 │              │    └── c_acctbal:6
 │              ├── const-agg [as=c_comment:8, outer=(8)]
 │              │    └── c_comment:8
 │              └── const-agg [as=n_name:38, outer=(38)]
 │                   └── n_name:38
 └── 20

# --------------------------------------------------
# Q11
# Important Stock Identification
# Finds the most important subset of suppliers' stock in a given nation.
#
# Finds, from scanning the available stock of suppliers in a given nation, all
# the parts that represent a significant percentage of the total value of all
# available parts. The query displays the part number and the value of those
# parts in descending order of value.
# --------------------------------------------------
opt
SELECT
    ps_partkey,
    sum(ps_supplycost * ps_availqty::float) AS value
FROM
    partsupp,
    supplier,
    nation
WHERE
    ps_suppkey = s_suppkey
    AND s_nationkey = n_nationkey
    AND n_name = 'GERMANY'
GROUP BY
    ps_partkey HAVING
        sum(ps_supplycost * ps_availqty::float) > (
            SELECT
                sum(ps_supplycost * ps_availqty::float) * 0.0001
            FROM
                partsupp,
                supplier,
                nation
            WHERE
                ps_suppkey = s_suppkey
                AND s_nationkey = n_nationkey
                AND n_name = 'GERMANY'
        )
ORDER BY
    value DESC;
----
sort
 ├── columns: ps_partkey:1!null value:21!null
 ├── immutable
 ├── key: (1)
 ├── fd: (1)-->(21)
 ├── ordering: -21
 └── select
      ├── columns: ps_partkey:1!null sum:21!null
      ├── immutable
      ├── key: (1)
      ├── fd: (1)-->(21)
      ├── group-by
      │    ├── columns: ps_partkey:1!null sum:21!null
      │    ├── grouping columns: ps_partkey:1!null
      │    ├── immutable
      │    ├── key: (1)
      │    ├── fd: (1)-->(21)
      │    ├── project
      │    │    ├── columns: column20:20!null ps_partkey:1!null
      │    │    ├── immutable
      │    │    ├── inner-join (lookup partsupp)
      │    │    │    ├── columns: ps_partkey:1!null ps_suppkey:2!null ps_availqty:3!null ps_supplycost:4!null s_suppkey:7!null s_nationkey:10!null n_nationkey:15!null n_name:16!null
      │    │    │    ├── key columns: [1 2] = [1 2]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── key: (1,7)
      │    │    │    ├── fd: ()-->(16), (1,2)-->(3,4), (7)-->(10), (10)==(15), (15)==(10), (2)==(7), (7)==(2)
      │    │    │    ├── inner-join (lookup partsupp@ps_sk)
      │    │    │    │    ├── columns: ps_partkey:1!null ps_suppkey:2!null s_suppkey:7!null s_nationkey:10!null n_nationkey:15!null n_name:16!null
      │    │    │    │    ├── key columns: [7] = [2]
      │    │    │    │    ├── key: (1,7)
      │    │    │    │    ├── fd: ()-->(16), (7)-->(10), (10)==(15), (15)==(10), (2)==(7), (7)==(2)
      │    │    │    │    ├── inner-join (lookup supplier@s_nk)
      │    │    │    │    │    ├── columns: s_suppkey:7!null s_nationkey:10!null n_nationkey:15!null n_name:16!null
      │    │    │    │    │    ├── key columns: [15] = [10]
      │    │    │    │    │    ├── key: (7)
      │    │    │    │    │    ├── fd: ()-->(16), (7)-->(10), (10)==(15), (15)==(10)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: n_nationkey:15!null n_name:16!null
      │    │    │    │    │    │    ├── key: (15)
      │    │    │    │    │    │    ├── fd: ()-->(16)
      │    │    │    │    │    │    ├── scan nation
      │    │    │    │    │    │    │    ├── columns: n_nationkey:15!null n_name:16!null
      │    │    │    │    │    │    │    ├── key: (15)
      │    │    │    │    │    │    │    └── fd: (15)-->(16)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── n_name:16 = 'GERMANY' [outer=(16), constraints=(/16: [/'GERMANY' - /'GERMANY']; tight), fd=()-->(16)]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    └── filters (true)
      │    │    │    └── filters (true)
      │    │    └── projections
      │    │         └── ps_supplycost:4 * ps_availqty:3::FLOAT8 [as=column20:20, outer=(3,4), immutable]
      │    └── aggregations
      │         └── sum [as=sum:21, outer=(20)]
      │              └── column20:20
      └── filters
           └── gt [outer=(21), immutable, subquery, constraints=(/21: (/NULL - ])]
                ├── sum:21
                └── subquery
                     └── project
                          ├── columns: "?column?":43
                          ├── cardinality: [1 - 1]
                          ├── immutable
                          ├── key: ()
                          ├── fd: ()-->(43)
                          ├── scalar-group-by
                          │    ├── columns: sum:42
                          │    ├── cardinality: [1 - 1]
                          │    ├── immutable
                          │    ├── key: ()
                          │    ├── fd: ()-->(42)
                          │    ├── project
                          │    │    ├── columns: column41:41!null
                          │    │    ├── immutable
                          │    │    ├── inner-join (lookup partsupp)
                          │    │    │    ├── columns: ps_suppkey:23!null ps_availqty:24!null ps_supplycost:25!null s_suppkey:28!null s_nationkey:31!null n_nationkey:36!null n_name:37!null
                          │    │    │    ├── key columns: [22 23] = [22 23]
                          │    │    │    ├── lookup columns are key
                          │    │    │    ├── fd: ()-->(37), (28)-->(31), (31)==(36), (36)==(31), (23)==(28), (28)==(23)
                          │    │    │    ├── inner-join (lookup partsupp@ps_sk)
                          │    │    │    │    ├── columns: ps_partkey:22!null ps_suppkey:23!null s_suppkey:28!null s_nationkey:31!null n_nationkey:36!null n_name:37!null
                          │    │    │    │    ├── key columns: [28] = [23]
                          │    │    │    │    ├── key: (22,28)
                          │    │    │    │    ├── fd: ()-->(37), (28)-->(31), (31)==(36), (36)==(31), (23)==(28), (28)==(23)
                          │    │    │    │    ├── inner-join (lookup supplier@s_nk)
                          │    │    │    │    │    ├── columns: s_suppkey:28!null s_nationkey:31!null n_nationkey:36!null n_name:37!null
                          │    │    │    │    │    ├── key columns: [36] = [31]
                          │    │    │    │    │    ├── key: (28)
                          │    │    │    │    │    ├── fd: ()-->(37), (28)-->(31), (31)==(36), (36)==(31)
                          │    │    │    │    │    ├── select
                          │    │    │    │    │    │    ├── columns: n_nationkey:36!null n_name:37!null
                          │    │    │    │    │    │    ├── key: (36)
                          │    │    │    │    │    │    ├── fd: ()-->(37)
                          │    │    │    │    │    │    ├── scan nation
                          │    │    │    │    │    │    │    ├── columns: n_nationkey:36!null n_name:37!null
                          │    │    │    │    │    │    │    ├── key: (36)
                          │    │    │    │    │    │    │    └── fd: (36)-->(37)
                          │    │    │    │    │    │    └── filters
                          │    │    │    │    │    │         └── n_name:37 = 'GERMANY' [outer=(37), constraints=(/37: [/'GERMANY' - /'GERMANY']; tight), fd=()-->(37)]
                          │    │    │    │    │    └── filters (true)
                          │    │    │    │    └── filters (true)
                          │    │    │    └── filters (true)
                          │    │    └── projections
                          │    │         └── ps_supplycost:25 * ps_availqty:24::FLOAT8 [as=column41:41, outer=(24,25), immutable]
                          │    └── aggregations
                          │         └── sum [as=sum:42, outer=(41)]
                          │              └── column41:41
                          └── projections
                               └── sum:42 * 0.0001 [as="?column?":43, outer=(42), immutable]

# --------------------------------------------------
# Q12
# Shipping Modes and Order Priority
# Determines whether selecting less expensive modes of shipping is negatively
# affecting the critical-priority orders by causing more parts to be received by
# customers after the committed date.
#
# Counts, by ship mode, for lineitems actually received by customers in a given
# year, the number of lineitems belonging to orders for which the l_receiptdate
# exceeds the l_commitdate for two different specified ship modes. Only
# lineitems that were actually shipped before the l_commitdate are considered.
# The late lineitems are partitioned into two groups, those with priority URGENT
# or HIGH, and those with a priority other than URGENT or HIGH.
# --------------------------------------------------
opt
SELECT
    l_shipmode,
    sum(CASE
        WHEN o_orderpriority = '1-URGENT'
            OR o_orderpriority = '2-HIGH'
            THEN 1
        ELSE 0
    END) AS high_line_count,
    sum(CASE
        WHEN o_orderpriority <> '1-URGENT'
            AND o_orderpriority <> '2-HIGH'
            THEN 1
        ELSE 0
    END) AS low_line_count
FROM
    orders,
    lineitem
WHERE
    o_orderkey = l_orderkey
    AND l_shipmode IN ('MAIL', 'SHIP')
    AND l_commitdate < l_receiptdate
    AND l_shipdate < l_commitdate
    AND l_receiptdate >= DATE '1994-01-01'
    AND l_receiptdate < DATE '1994-01-01' + INTERVAL '1' YEAR
GROUP BY
    l_shipmode
ORDER BY
    l_shipmode;
----
sort
 ├── columns: l_shipmode:25!null high_line_count:29!null low_line_count:31!null
 ├── key: (25)
 ├── fd: (25)-->(29,31)
 ├── ordering: +25
 └── group-by
      ├── columns: l_shipmode:25!null sum:29!null sum:31!null
      ├── grouping columns: l_shipmode:25!null
      ├── key: (25)
      ├── fd: (25)-->(29,31)
      ├── project
      │    ├── columns: column28:28!null column30:30!null l_shipmode:25!null
      │    ├── inner-join (lookup orders)
      │    │    ├── columns: o_orderkey:1!null o_orderpriority:6!null l_orderkey:11!null l_shipdate:21!null l_commitdate:22!null l_receiptdate:23!null l_shipmode:25!null
      │    │    ├── key columns: [11] = [1]
      │    │    ├── lookup columns are key
      │    │    ├── fd: (1)-->(6), (1)==(11), (11)==(1)
      │    │    ├── select
      │    │    │    ├── columns: l_orderkey:11!null l_shipdate:21!null l_commitdate:22!null l_receiptdate:23!null l_shipmode:25!null
      │    │    │    ├── index-join lineitem
      │    │    │    │    ├── columns: l_orderkey:11!null l_shipdate:21!null l_commitdate:22!null l_receiptdate:23!null l_shipmode:25!null
      │    │    │    │    └── scan lineitem@l_rd
      │    │    │    │         ├── columns: l_orderkey:11!null l_linenumber:14!null l_receiptdate:23!null
      │    │    │    │         ├── constraint: /23/11/14: [/'1994-01-01' - /'1994-12-31']
      │    │    │    │         ├── key: (11,14)
      │    │    │    │         └── fd: (11,14)-->(23)
      │    │    │    └── filters
      │    │    │         ├── l_shipmode:25 IN ('MAIL', 'SHIP') [outer=(25), constraints=(/25: [/'MAIL' - /'MAIL'] [/'SHIP' - /'SHIP']; tight)]
      │    │    │         ├── l_commitdate:22 < l_receiptdate:23 [outer=(22,23), constraints=(/22: (/NULL - ]; /23: (/NULL - ])]
      │    │    │         └── l_shipdate:21 < l_commitdate:22 [outer=(21,22), constraints=(/21: (/NULL - ]; /22: (/NULL - ])]
      │    │    └── filters (true)
      │    └── projections
      │         ├── CASE WHEN (o_orderpriority:6 = '1-URGENT') OR (o_orderpriority:6 = '2-HIGH') THEN 1 ELSE 0 END [as=column28:28, outer=(6)]
      │         └── CASE WHEN (o_orderpriority:6 != '1-URGENT') AND (o_orderpriority:6 != '2-HIGH') THEN 1 ELSE 0 END [as=column30:30, outer=(6)]
      └── aggregations
           ├── sum [as=sum:29, outer=(28)]
           │    └── column28:28
           └── sum [as=sum:31, outer=(30)]
                └── column30:30

# --------------------------------------------------
# Q13
# Customer Distribution
# Seeks relationships between customers and the size of their orders.
#
# Determines the distribution of customers by the number of orders they have
# made, including customers who have no record of orders, past or present. It
# counts and reports how many customers have no orders, how many have 1, 2, 3,
# etc. A check is made to ensure that the orders counted do not fall into one of
# several special categories of orders. Special categories are identified in the
# order comment column by looking for a particular pattern.
# --------------------------------------------------
opt
SELECT
    c_count, count(*) AS custdist
FROM (
    SELECT
        c_custkey,
        count(o_orderkey)
    FROM
        customer LEFT OUTER JOIN orders ON
            c_custkey = o_custkey
            AND o_comment NOT LIKE '%special%requests%'
    GROUP BY
        c_custkey
    ) AS c_orders (c_custkey, c_count)
GROUP BY
    c_count
ORDER BY
    custdist DESC,
    c_count DESC;
----
sort
 ├── columns: c_count:20!null custdist:21!null
 ├── key: (20)
 ├── fd: (20)-->(21)
 ├── ordering: -21,-20
 └── group-by
      ├── columns: count:20!null count_rows:21!null
      ├── grouping columns: count:20!null
      ├── key: (20)
      ├── fd: (20)-->(21)
      ├── group-by
      │    ├── columns: c_custkey:1!null count:20!null
      │    ├── grouping columns: c_custkey:1!null
      │    ├── key: (1)
      │    ├── fd: (1)-->(20)
      │    ├── right-join (hash)
      │    │    ├── columns: c_custkey:1!null o_orderkey:10 o_custkey:11 o_comment:18
      │    │    ├── key: (1,10)
      │    │    ├── fd: (10)-->(11,18)
      │    │    ├── select
      │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_comment:18!null
      │    │    │    ├── key: (10)
      │    │    │    ├── fd: (10)-->(11,18)
      │    │    │    ├── scan orders
      │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_comment:18!null
      │    │    │    │    ├── key: (10)
      │    │    │    │    └── fd: (10)-->(11,18)
      │    │    │    └── filters
      │    │    │         └── o_comment:18 NOT LIKE '%special%requests%' [outer=(18), constraints=(/18: (/NULL - ])]
      │    │    ├── scan customer@c_nk
      │    │    │    ├── columns: c_custkey:1!null
      │    │    │    └── key: (1)
      │    │    └── filters
      │    │         └── c_custkey:1 = o_custkey:11 [outer=(1,11), constraints=(/1: (/NULL - ]; /11: (/NULL - ]), fd=(1)==(11), (11)==(1)]
      │    └── aggregations
      │         └── count [as=count:20, outer=(10)]
      │              └── o_orderkey:10
      └── aggregations
           └── count-rows [as=count_rows:21]

# --------------------------------------------------
# Q14
# Promotion Effect
# Monitors the market response to a promotion such as TV advertisements or a
# special campaign.
#
# Determines what percentage of the revenue in a given year and month was
# derived from promotional parts. The query considers only parts actually
# shipped in that month and gives the percentage. Revenue is defined as
# (l_extendedprice * (1-l_discount)).
# --------------------------------------------------
opt
SELECT
    100.00 * sum(CASE
        WHEN p_type LIKE 'PROMO%'
            THEN l_extendedprice * (1 - l_discount)
        ELSE 0
    END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue
FROM
    lineitem,
    part
WHERE
    l_partkey = p_partkey
    AND l_shipdate >= DATE '1995-09-01'
    AND l_shipdate < DATE '1995-09-01' + INTERVAL '1' MONTH;
----
project
 ├── columns: promo_revenue:32
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(32)
 ├── scalar-group-by
 │    ├── columns: sum:29 sum:31
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── key: ()
 │    ├── fd: ()-->(29,31)
 │    ├── project
 │    │    ├── columns: column28:28!null column30:30!null
 │    │    ├── immutable
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: l_partkey:2!null l_extendedprice:6!null l_discount:7!null l_shipdate:11!null p_partkey:18!null p_type:22!null
 │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
 │    │    │    ├── fd: (18)-->(22), (2)==(18), (18)==(2)
 │    │    │    ├── scan part
 │    │    │    │    ├── columns: p_partkey:18!null p_type:22!null
 │    │    │    │    ├── key: (18)
 │    │    │    │    └── fd: (18)-->(22)
 │    │    │    ├── index-join lineitem
 │    │    │    │    ├── columns: l_partkey:2!null l_extendedprice:6!null l_discount:7!null l_shipdate:11!null
 │    │    │    │    └── scan lineitem@l_sd
 │    │    │    │         ├── columns: l_orderkey:1!null l_linenumber:4!null l_shipdate:11!null
 │    │    │    │         ├── constraint: /11/1/4: [/'1995-09-01' - /'1995-09-30']
 │    │    │    │         ├── key: (1,4)
 │    │    │    │         └── fd: (1,4)-->(11)
 │    │    │    └── filters
 │    │    │         └── l_partkey:2 = p_partkey:18 [outer=(2,18), constraints=(/2: (/NULL - ]; /18: (/NULL - ]), fd=(2)==(18), (18)==(2)]
 │    │    └── projections
 │    │         ├── CASE WHEN p_type:22 LIKE 'PROMO%' THEN l_extendedprice:6 * (1.0 - l_discount:7) ELSE 0.0 END [as=column28:28, outer=(6,7,22), immutable]
 │    │         └── l_extendedprice:6 * (1.0 - l_discount:7) [as=column30:30, outer=(6,7), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:29, outer=(28)]
 │         │    └── column28:28
 │         └── sum [as=sum:31, outer=(30)]
 │              └── column30:30
 └── projections
      └── (sum:29 * 100.0) / sum:31 [as=promo_revenue:32, outer=(29,31), immutable]

# --------------------------------------------------
# Q15
# Top Supplier
# Determines the top supplier so it can be rewarded, given more business, or
# identified for special recognition.
#
# Finds the supplier who contributed the most to the overall revenue for parts
# shipped during a given quarter of a given year. In case of a tie, the query
# lists all suppliers whose contribution was equal to the maximum, presented in
# supplier number order.
# --------------------------------------------------
exec-ddl
CREATE VIEW revenue0 (supplier_no, total_revenue) AS
    SELECT
        l_suppkey,
        sum(l_extendedprice * (1 - l_discount))
    FROM
        lineitem
    WHERE
        l_shipdate >= DATE '1996-01-01'
        AND l_shipdate < DATE '1996-01-01' + INTERVAL '3' MONTH
    GROUP BY
        l_suppkey;
----

opt
SELECT
    s_suppkey,
    s_name,
    s_address,
    s_phone,
    total_revenue
FROM
    supplier,
    revenue0
WHERE
    s_suppkey = supplier_no
    AND total_revenue = (
        SELECT
            max(total_revenue)
        FROM
            revenue0
    )
ORDER BY
    s_suppkey;
----
project
 ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_phone:5!null total_revenue:27!null
 ├── immutable
 ├── key: (1)
 ├── fd: (1)-->(2,3,5,27)
 ├── ordering: +1
 └── inner-join (merge)
      ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_phone:5!null l_suppkey:11!null sum:27!null
      ├── left ordering: +1
      ├── right ordering: +11
      ├── immutable
      ├── key: (11)
      ├── fd: (1)-->(2,3,5), (11)-->(27), (1)==(11), (11)==(1)
      ├── ordering: +(1|11) [actual: +1]
      ├── scan supplier
      │    ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_phone:5!null
      │    ├── key: (1)
      │    ├── fd: (1)-->(2,3,5)
      │    └── ordering: +1
      ├── sort
      │    ├── columns: l_suppkey:11!null sum:27!null
      │    ├── immutable
      │    ├── key: (11)
      │    ├── fd: (11)-->(27)
      │    ├── ordering: +11
      │    └── select
      │         ├── columns: l_suppkey:11!null sum:27!null
      │         ├── immutable
      │         ├── key: (11)
      │         ├── fd: (11)-->(27)
      │         ├── group-by
      │         │    ├── columns: l_suppkey:11!null sum:27!null
      │         │    ├── grouping columns: l_suppkey:11!null
      │         │    ├── immutable
      │         │    ├── key: (11)
      │         │    ├── fd: (11)-->(27)
      │         │    ├── project
      │         │    │    ├── columns: column26:26!null l_suppkey:11!null
      │         │    │    ├── immutable
      │         │    │    ├── index-join lineitem
      │         │    │    │    ├── columns: l_suppkey:11!null l_extendedprice:14!null l_discount:15!null l_shipdate:19!null
      │         │    │    │    └── scan lineitem@l_sd
      │         │    │    │         ├── columns: l_orderkey:9!null l_linenumber:12!null l_shipdate:19!null
      │         │    │    │         ├── constraint: /19/9/12: [/'1996-01-01' - /'1996-03-31']
      │         │    │    │         ├── key: (9,12)
      │         │    │    │         └── fd: (9,12)-->(19)
      │         │    │    └── projections
      │         │    │         └── l_extendedprice:14 * (1.0 - l_discount:15) [as=column26:26, outer=(14,15), immutable]
      │         │    └── aggregations
      │         │         └── sum [as=sum:27, outer=(26)]
      │         │              └── column26:26
      │         └── filters
      │              └── eq [outer=(27), immutable, subquery, constraints=(/27: (/NULL - ])]
      │                   ├── sum:27
      │                   └── subquery
      │                        └── scalar-group-by
      │                             ├── columns: max:47
      │                             ├── cardinality: [1 - 1]
      │                             ├── immutable
      │                             ├── key: ()
      │                             ├── fd: ()-->(47)
      │                             ├── group-by
      │                             │    ├── columns: l_suppkey:30!null sum:46!null
      │                             │    ├── grouping columns: l_suppkey:30!null
      │                             │    ├── immutable
      │                             │    ├── key: (30)
      │                             │    ├── fd: (30)-->(46)
      │                             │    ├── project
      │                             │    │    ├── columns: column45:45!null l_suppkey:30!null
      │                             │    │    ├── immutable
      │                             │    │    ├── index-join lineitem
      │                             │    │    │    ├── columns: l_suppkey:30!null l_extendedprice:33!null l_discount:34!null l_shipdate:38!null
      │                             │    │    │    └── scan lineitem@l_sd
      │                             │    │    │         ├── columns: l_orderkey:28!null l_linenumber:31!null l_shipdate:38!null
      │                             │    │    │         ├── constraint: /38/28/31: [/'1996-01-01' - /'1996-03-31']
      │                             │    │    │         ├── key: (28,31)
      │                             │    │    │         └── fd: (28,31)-->(38)
      │                             │    │    └── projections
      │                             │    │         └── l_extendedprice:33 * (1.0 - l_discount:34) [as=column45:45, outer=(33,34), immutable]
      │                             │    └── aggregations
      │                             │         └── sum [as=sum:46, outer=(45)]
      │                             │              └── column45:45
      │                             └── aggregations
      │                                  └── max [as=max:47, outer=(46)]
      │                                       └── sum:46
      └── filters (true)

# --------------------------------------------------
# Q16
# Parts/Supplier Relationship
# Finds out how many suppliers can supply parts with given attributes. It might
# be used, for example, to determine whether there is a sufficient number of
# suppliers for heavily ordered parts.
#
# Counts the number of suppliers who can supply parts that satisfy a particular
# customer's requirements. The customer is interested in parts of eight
# different sizes as long as they are not of a given type, not of a given brand,
# and not from a supplier who has had complaints registered at the Better
# Business Bureau. Results must be presented in descending count and ascending
# brand, type, and size.
# --------------------------------------------------
opt
SELECT
    p_brand,
    p_type,
    p_size,
    count(DISTINCT ps_suppkey) AS supplier_cnt
FROM
    partsupp,
    part
WHERE
    p_partkey = ps_partkey
    AND p_brand <> 'Brand#45'
    AND p_type NOT LIKE 'MEDIUM POLISHED %'
    AND p_size IN (49, 14, 23, 45, 19, 3, 36, 9)
    AND ps_suppkey NOT IN (
        SELECT
            s_suppkey
        FROM
            supplier
        WHERE
            s_comment LIKE '%Customer%Complaints%'
    )
GROUP BY
    p_brand,
    p_type,
    p_size
ORDER BY
    supplier_cnt DESC,
    p_brand,
    p_type,
    p_size;
----
sort
 ├── columns: p_brand:10!null p_type:11!null p_size:12!null supplier_cnt:25!null
 ├── key: (10-12)
 ├── fd: (10-12)-->(25)
 ├── ordering: -25,+10,+11,+12
 └── group-by
      ├── columns: p_brand:10!null p_type:11!null p_size:12!null count:25!null
      ├── grouping columns: p_brand:10!null p_type:11!null p_size:12!null
      ├── key: (10-12)
      ├── fd: (10-12)-->(25)
      ├── distinct-on
      │    ├── columns: ps_suppkey:2!null p_brand:10!null p_type:11!null p_size:12!null
      │    ├── grouping columns: ps_suppkey:2!null p_brand:10!null p_type:11!null p_size:12!null
      │    ├── key: (2,10-12)
      │    └── anti-join (hash)
      │         ├── columns: ps_partkey:1!null ps_suppkey:2!null p_partkey:7!null p_brand:10!null p_type:11!null p_size:12!null
      │         ├── key: (2,7)
      │         ├── fd: (7)-->(10-12), (1)==(7), (7)==(1)
      │         ├── inner-join (lookup partsupp)
      │         │    ├── columns: ps_partkey:1!null ps_suppkey:2!null p_partkey:7!null p_brand:10!null p_type:11!null p_size:12!null
      │         │    ├── key columns: [7] = [1]
      │         │    ├── key: (2,7)
      │         │    ├── fd: (7)-->(10-12), (1)==(7), (7)==(1)
      │         │    ├── select
      │         │    │    ├── columns: p_partkey:7!null p_brand:10!null p_type:11!null p_size:12!null
      │         │    │    ├── key: (7)
      │         │    │    ├── fd: (7)-->(10-12)
      │         │    │    ├── scan part
      │         │    │    │    ├── columns: p_partkey:7!null p_brand:10!null p_type:11!null p_size:12!null
      │         │    │    │    ├── key: (7)
      │         │    │    │    └── fd: (7)-->(10-12)
      │         │    │    └── filters
      │         │    │         ├── p_brand:10 != 'Brand#45' [outer=(10), constraints=(/10: (/NULL - /'Brand#45') [/e'Brand#45\x00' - ]; tight)]
      │         │    │         ├── p_type:11 NOT LIKE 'MEDIUM POLISHED %' [outer=(11), constraints=(/11: (/NULL - ])]
      │         │    │         └── p_size:12 IN (3, 9, 14, 19, 23, 36, 45, 49) [outer=(12), constraints=(/12: [/3 - /3] [/9 - /9] [/14 - /14] [/19 - /19] [/23 - /23] [/36 - /36] [/45 - /45] [/49 - /49]; tight)]
      │         │    └── filters (true)
      │         ├── select
      │         │    ├── columns: s_suppkey:17!null s_comment:23!null
      │         │    ├── key: (17)
      │         │    ├── fd: (17)-->(23)
      │         │    ├── scan supplier
      │         │    │    ├── columns: s_suppkey:17!null s_comment:23!null
      │         │    │    ├── key: (17)
      │         │    │    └── fd: (17)-->(23)
      │         │    └── filters
      │         │         └── s_comment:23 LIKE '%Customer%Complaints%' [outer=(23), constraints=(/23: (/NULL - ])]
      │         └── filters
      │              └── ps_suppkey:2 = s_suppkey:17 [outer=(2,17), constraints=(/2: (/NULL - ]; /17: (/NULL - ]), fd=(2)==(17), (17)==(2)]
      └── aggregations
           └── count-rows [as=count:25]

# --------------------------------------------------
# Q17
# Small-Quantity-Order Revenue
# Determines how much average yearly revenue would be lost if orders were no
# longer filled for small quantities of certain parts. This may reduce overhead
# expenses by concentrating sales on larger shipments.
#
# Considers parts of a given brand and with a given container type and
# determines the average lineitem quantity of such parts ordered for all orders
# (past and pending) in the 7-year database. What would be the average yearly
# gross (undiscounted) loss in revenue if orders for these parts with a quantity
# of less than 20% of this average were no longer taken?
# --------------------------------------------------
opt
SELECT
    sum(l_extendedprice) / 7.0 AS avg_yearly
FROM
    lineitem,
    part
WHERE
    p_partkey = l_partkey
    AND p_brand = 'Brand#23'
    AND p_container = 'MED BOX'
    AND l_quantity < (
        SELECT
            0.2 * avg(l_quantity)
        FROM
            lineitem
        WHERE
            l_partkey = p_partkey
    );
----
project
 ├── columns: avg_yearly:48
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(48)
 ├── scalar-group-by
 │    ├── columns: sum:47
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── key: ()
 │    ├── fd: ()-->(47)
 │    ├── inner-join (lookup lineitem)
 │    │    ├── columns: l_partkey:2!null l_quantity:5!null l_extendedprice:6!null p_partkey:18!null "?column?":46!null
 │    │    ├── key columns: [1 4] = [1 4]
 │    │    ├── lookup columns are key
 │    │    ├── immutable
 │    │    ├── fd: (18)-->(46), (2)==(18), (18)==(2)
 │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    ├── columns: l_orderkey:1!null l_partkey:2!null l_linenumber:4!null p_partkey:18!null "?column?":46!null
 │    │    │    ├── key columns: [18] = [2]
 │    │    │    ├── immutable
 │    │    │    ├── key: (1,4)
 │    │    │    ├── fd: (18)-->(46), (1,4)-->(2), (2)==(18), (18)==(2)
 │    │    │    ├── project
 │    │    │    │    ├── columns: "?column?":46!null p_partkey:18!null
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: (18)
 │    │    │    │    ├── fd: (18)-->(46)
 │    │    │    │    ├── group-by
 │    │    │    │    │    ├── columns: p_partkey:18!null avg:45!null
 │    │    │    │    │    ├── grouping columns: p_partkey:18!null
 │    │    │    │    │    ├── internal-ordering: +(18|29) opt(21,24)
 │    │    │    │    │    ├── key: (18)
 │    │    │    │    │    ├── fd: (18)-->(45)
 │    │    │    │    │    ├── inner-join (lookup lineitem)
 │    │    │    │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_container:24!null l_partkey:29!null l_quantity:32!null
 │    │    │    │    │    │    ├── key columns: [28 31] = [28 31]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── fd: ()-->(21,24), (18)==(29), (29)==(18)
 │    │    │    │    │    │    ├── ordering: +(18|29) opt(21,24) [actual: +18]
 │    │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    │    │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_container:24!null l_orderkey:28!null l_partkey:29!null l_linenumber:31!null
 │    │    │    │    │    │    │    ├── key columns: [18] = [29]
 │    │    │    │    │    │    │    ├── key: (28,31)
 │    │    │    │    │    │    │    ├── fd: ()-->(21,24), (28,31)-->(29), (18)==(29), (29)==(18)
 │    │    │    │    │    │    │    ├── ordering: +(18|29) opt(21,24) [actual: +18]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_container:24!null
 │    │    │    │    │    │    │    │    ├── key: (18)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(21,24)
 │    │    │    │    │    │    │    │    ├── ordering: +18 opt(21,24) [actual: +18]
 │    │    │    │    │    │    │    │    ├── scan part
 │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_container:24!null
 │    │    │    │    │    │    │    │    │    ├── key: (18)
 │    │    │    │    │    │    │    │    │    ├── fd: (18)-->(21,24)
 │    │    │    │    │    │    │    │    │    └── ordering: +18
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         ├── p_brand:21 = 'Brand#23' [outer=(21), constraints=(/21: [/'Brand#23' - /'Brand#23']; tight), fd=()-->(21)]
 │    │    │    │    │    │    │    │         └── p_container:24 = 'MED BOX' [outer=(24), constraints=(/24: [/'MED BOX' - /'MED BOX']; tight), fd=()-->(24)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── avg [as=avg:45, outer=(32)]
 │    │    │    │    │              └── l_quantity:32
 │    │    │    │    └── projections
 │    │    │    │         └── avg:45 * 0.2 [as="?column?":46, outer=(45), immutable]
 │    │    │    └── filters (true)
 │    │    └── filters
 │    │         └── l_quantity:5 < "?column?":46 [outer=(5,46), constraints=(/5: (/NULL - ]; /46: (/NULL - ])]
 │    └── aggregations
 │         └── sum [as=sum:47, outer=(6)]
 │              └── l_extendedprice:6
 └── projections
      └── sum:47 / 7.0 [as=avg_yearly:48, outer=(47)]

# --------------------------------------------------
# Q18
# Large Volume Customer
# Ranks customers based on their having placed a large quantity order. Large
# quantity orders are defined as those orders whose total quantity is above a
# certain level.
#
# Finds a list of the top 100 customers who have ever placed large quantity
# orders. The query lists the customer name, customer key, the order key, date
# and total price and the quantity for the order.
# --------------------------------------------------
opt
SELECT
    c_name,
    c_custkey,
    o_orderkey,
    o_orderdate,
    o_totalprice,
    sum(l_quantity)
FROM
    customer,
    orders,
    lineitem
WHERE
    o_orderkey IN (
        SELECT
            l_orderkey
        FROM
            lineitem
        GROUP BY
            l_orderkey HAVING
                sum(l_quantity) > 300
    )
    AND c_custkey = o_custkey
    AND o_orderkey = l_orderkey
GROUP BY
    c_name,
    c_custkey,
    o_orderkey,
    o_orderdate,
    o_totalprice
ORDER BY
    o_totalprice DESC,
    o_orderdate
LIMIT 100;
----
limit
 ├── columns: c_name:2!null c_custkey:1!null o_orderkey:10!null o_orderdate:14!null o_totalprice:13!null sum:55!null
 ├── internal-ordering: -13,+14
 ├── cardinality: [0 - 100]
 ├── key: (10)
 ├── fd: (1)-->(2), (10)-->(1,2,13,14,55)
 ├── ordering: -13,+14
 ├── sort
 │    ├── columns: c_custkey:1!null c_name:2!null o_orderkey:10!null o_totalprice:13!null o_orderdate:14!null sum:55!null
 │    ├── key: (10)
 │    ├── fd: (1)-->(2), (10)-->(1,2,13,14,55)
 │    ├── ordering: -13,+14
 │    ├── limit hint: 100.00
 │    └── group-by
 │         ├── columns: c_custkey:1!null c_name:2!null o_orderkey:10!null o_totalprice:13!null o_orderdate:14!null sum:55!null
 │         ├── grouping columns: o_orderkey:10!null
 │         ├── key: (10)
 │         ├── fd: (1)-->(2), (10)-->(1,2,13,14,55)
 │         ├── inner-join (hash)
 │         │    ├── columns: c_custkey:1!null c_name:2!null o_orderkey:10!null o_custkey:11!null o_totalprice:13!null o_orderdate:14!null l_orderkey:20!null l_quantity:24!null
 │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    ├── fd: (1)-->(2), (10)-->(11,13,14), (10)==(20), (20)==(10), (1)==(11), (11)==(1)
 │         │    ├── scan lineitem
 │         │    │    └── columns: l_orderkey:20!null l_quantity:24!null
 │         │    ├── inner-join (hash)
 │         │    │    ├── columns: c_custkey:1!null c_name:2!null o_orderkey:10!null o_custkey:11!null o_totalprice:13!null o_orderdate:14!null
 │         │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
 │         │    │    ├── key: (10)
 │         │    │    ├── fd: (1)-->(2), (10)-->(11,13,14), (1)==(11), (11)==(1)
 │         │    │    ├── semi-join (merge)
 │         │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_totalprice:13!null o_orderdate:14!null
 │         │    │    │    ├── left ordering: +10
 │         │    │    │    ├── right ordering: +37
 │         │    │    │    ├── key: (10)
 │         │    │    │    ├── fd: (10)-->(11,13,14)
 │         │    │    │    ├── scan orders
 │         │    │    │    │    ├── columns: o_orderkey:10!null o_custkey:11!null o_totalprice:13!null o_orderdate:14!null
 │         │    │    │    │    ├── key: (10)
 │         │    │    │    │    ├── fd: (10)-->(11,13,14)
 │         │    │    │    │    └── ordering: +10
 │         │    │    │    ├── select
 │         │    │    │    │    ├── columns: l_orderkey:37!null sum:54!null
 │         │    │    │    │    ├── key: (37)
 │         │    │    │    │    ├── fd: (37)-->(54)
 │         │    │    │    │    ├── ordering: +37
 │         │    │    │    │    ├── group-by
 │         │    │    │    │    │    ├── columns: l_orderkey:37!null sum:54!null
 │         │    │    │    │    │    ├── grouping columns: l_orderkey:37!null
 │         │    │    │    │    │    ├── key: (37)
 │         │    │    │    │    │    ├── fd: (37)-->(54)
 │         │    │    │    │    │    ├── ordering: +37
 │         │    │    │    │    │    ├── scan lineitem
 │         │    │    │    │    │    │    ├── columns: l_orderkey:37!null l_quantity:41!null
 │         │    │    │    │    │    │    └── ordering: +37
 │         │    │    │    │    │    └── aggregations
 │         │    │    │    │    │         └── sum [as=sum:54, outer=(41)]
 │         │    │    │    │    │              └── l_quantity:41
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── sum:54 > 300.0 [outer=(54), constraints=(/54: [/300.00000000000006 - ]; tight)]
 │         │    │    │    └── filters (true)
 │         │    │    ├── scan customer
 │         │    │    │    ├── columns: c_custkey:1!null c_name:2!null
 │         │    │    │    ├── key: (1)
 │         │    │    │    └── fd: (1)-->(2)
 │         │    │    └── filters
 │         │    │         └── c_custkey:1 = o_custkey:11 [outer=(1,11), constraints=(/1: (/NULL - ]; /11: (/NULL - ]), fd=(1)==(11), (11)==(1)]
 │         │    └── filters
 │         │         └── o_orderkey:10 = l_orderkey:20 [outer=(10,20), constraints=(/10: (/NULL - ]; /20: (/NULL - ]), fd=(10)==(20), (20)==(10)]
 │         └── aggregations
 │              ├── sum [as=sum:55, outer=(24)]
 │              │    └── l_quantity:24
 │              ├── const-agg [as=c_custkey:1, outer=(1)]
 │              │    └── c_custkey:1
 │              ├── const-agg [as=c_name:2, outer=(2)]
 │              │    └── c_name:2
 │              ├── const-agg [as=o_totalprice:13, outer=(13)]
 │              │    └── o_totalprice:13
 │              └── const-agg [as=o_orderdate:14, outer=(14)]
 │                   └── o_orderdate:14
 └── 100

# --------------------------------------------------
# Q19
# Discounted Revenue
# Reports the gross discounted revenue attributed to the sale of selected parts
# handled in a particular manner. This query is an example of code such as might
# be produced programmatically by a data mining tool.
#
# The Discounted Revenue query finds the gross discounted revenue for all orders
# for three different types of parts that were shipped by air and delivered in
# person. Parts are selected based on the combination of specific brands, a list
# of containers, and a range of sizes.
# --------------------------------------------------
opt
SELECT
    sum(l_extendedprice* (1 - l_discount)) AS revenue
FROM
    lineitem,
    part
WHERE
    (
        p_partkey = l_partkey
        AND p_brand = 'Brand#12'
        AND p_container IN ('SM CASE', 'SM BOX', 'SM PACK', 'SM PKG')
        AND l_quantity >= 1 AND l_quantity <= 1 + 10
        AND p_size BETWEEN 1 AND 5
        AND l_shipmode IN ('AIR', 'AIR REG')
        AND l_shipinstruct = 'DELIVER IN PERSON'
    )
    OR
    (
        p_partkey = l_partkey
        AND p_brand = 'Brand#23'
        AND p_container IN ('MED BAG', 'MED BOX', 'MED PKG', 'MED PACK')
        AND l_quantity >= 10 AND l_quantity <= 10 + 10
        AND p_size BETWEEN 1 AND 10
        AND l_shipmode IN ('AIR', 'AIR REG')
        AND l_shipinstruct = 'DELIVER IN PERSON'
    )
    OR
    (
        p_partkey = l_partkey
        AND p_brand = 'Brand#34'
        AND p_container IN ('LG CASE', 'LG BOX', 'LG PACK', 'LG PKG')
        AND l_quantity >= 20 AND l_quantity <= 20 + 10
        AND p_size BETWEEN 1 AND 15
        AND l_shipmode IN ('AIR', 'AIR REG')
        AND l_shipinstruct = 'DELIVER IN PERSON'
    );
----
scalar-group-by
 ├── columns: revenue:29
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(29)
 ├── project
 │    ├── columns: column28:28!null
 │    ├── immutable
 │    ├── inner-join (hash)
 │    │    ├── columns: l_partkey:2!null l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_shipinstruct:14!null l_shipmode:15!null p_partkey:18!null p_brand:21!null p_size:23!null p_container:24!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── fd: ()-->(14), (18)-->(21,23,24), (2)==(18), (18)==(2)
 │    │    ├── select
 │    │    │    ├── columns: l_partkey:2!null l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_shipinstruct:14!null l_shipmode:15!null
 │    │    │    ├── fd: ()-->(14)
 │    │    │    ├── scan lineitem
 │    │    │    │    └── columns: l_partkey:2!null l_quantity:5!null l_extendedprice:6!null l_discount:7!null l_shipinstruct:14!null l_shipmode:15!null
 │    │    │    └── filters
 │    │    │         ├── l_shipmode:15 IN ('AIR', 'AIR REG') [outer=(15), constraints=(/15: [/'AIR' - /'AIR'] [/'AIR REG' - /'AIR REG']; tight)]
 │    │    │         └── l_shipinstruct:14 = 'DELIVER IN PERSON' [outer=(14), constraints=(/14: [/'DELIVER IN PERSON' - /'DELIVER IN PERSON']; tight), fd=()-->(14)]
 │    │    ├── select
 │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_size:23!null p_container:24!null
 │    │    │    ├── key: (18)
 │    │    │    ├── fd: (18)-->(21,23,24)
 │    │    │    ├── scan part
 │    │    │    │    ├── columns: p_partkey:18!null p_brand:21!null p_size:23!null p_container:24!null
 │    │    │    │    ├── key: (18)
 │    │    │    │    └── fd: (18)-->(21,23,24)
 │    │    │    └── filters
 │    │    │         └── p_size:23 >= 1 [outer=(23), constraints=(/23: [/1 - ]; tight)]
 │    │    └── filters
 │    │         ├── p_partkey:18 = l_partkey:2 [outer=(2,18), constraints=(/2: (/NULL - ]; /18: (/NULL - ]), fd=(2)==(18), (18)==(2)]
 │    │         └── ((((((p_brand:21 = 'Brand#12') AND (p_container:24 IN ('SM BOX', 'SM CASE', 'SM PACK', 'SM PKG'))) AND (l_quantity:5 >= 1.0)) AND (l_quantity:5 <= 11.0)) AND (p_size:23 <= 5)) OR (((((p_brand:21 = 'Brand#23') AND (p_container:24 IN ('MED BAG', 'MED BOX', 'MED PACK', 'MED PKG'))) AND (l_quantity:5 >= 10.0)) AND (l_quantity:5 <= 20.0)) AND (p_size:23 <= 10))) OR (((((p_brand:21 = 'Brand#34') AND (p_container:24 IN ('LG BOX', 'LG CASE', 'LG PACK', 'LG PKG'))) AND (l_quantity:5 >= 20.0)) AND (l_quantity:5 <= 30.0)) AND (p_size:23 <= 15)) [outer=(5,21,23,24), constraints=(/5: [/1.0 - /30.0]; /21: [/'Brand#12' - /'Brand#12'] [/'Brand#23' - /'Brand#23'] [/'Brand#34' - /'Brand#34']; /23: (/NULL - /15]; /24: [/'LG BOX' - /'LG BOX'] [/'LG CASE' - /'LG CASE'] [/'LG PACK' - /'LG PACK'] [/'LG PKG' - /'LG PKG'] [/'MED BAG' - /'MED BAG'] [/'MED BOX' - /'MED BOX'] [/'MED PACK' - /'MED PACK'] [/'MED PKG' - /'MED PKG'] [/'SM BOX' - /'SM BOX'] [/'SM CASE' - /'SM CASE'] [/'SM PACK' - /'SM PACK'] [/'SM PKG' - /'SM PKG'])]
 │    └── projections
 │         └── l_extendedprice:6 * (1.0 - l_discount:7) [as=column28:28, outer=(6,7), immutable]
 └── aggregations
      └── sum [as=sum:29, outer=(28)]
           └── column28:28

# --------------------------------------------------
# Q20
# Potential Part Promotion
# Identifies suppliers in a particular nation having selected parts that may be
# candidates for a promotional offer.
#
# Identifies suppliers who have an excess of a given part available; an excess
# defined to be more than 50% of the parts like the given part that the supplier
# shipped in a given year for a given nation. Only parts whose names share a
# certain naming convention are considered.
#
# TODO:
#   1. Push 'forest%' prefix filter down into Scan
# --------------------------------------------------
opt
SELECT
    s_name,
    s_address
FROM
    supplier,
    nation
WHERE
    s_suppkey IN (
        SELECT
            ps_suppkey
        FROM
            partsupp
        WHERE
            ps_partkey IN (
                SELECT
                    p_partkey
                FROM
                    part
                WHERE
                    p_name LIKE 'forest%'
            )
            AND ps_availqty > (
                SELECT
                    0.5 * sum(l_quantity)
                FROM
                    lineitem
                WHERE
                    l_partkey = ps_partkey
                    AND l_suppkey = ps_suppkey
                    AND l_shipdate >= DATE '1994-01-01'
                    AND l_shipdate < DATE '1994-01-01' + INTERVAL '1' YEAR
            )
    )
    AND s_nationkey = n_nationkey
    AND n_name = 'CANADA'
ORDER BY
    s_name;
----
sort
 ├── columns: s_name:2!null s_address:3!null
 ├── immutable
 ├── ordering: +2
 └── project
      ├── columns: s_name:2!null s_address:3!null
      ├── immutable
      └── inner-join (lookup nation)
           ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_nationkey:4!null n_nationkey:9!null n_name:10!null
           ├── key columns: [4] = [9]
           ├── lookup columns are key
           ├── immutable
           ├── key: (1)
           ├── fd: ()-->(10), (1)-->(2-4), (4)==(9), (9)==(4)
           ├── project
           │    ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_nationkey:4!null
           │    ├── immutable
           │    ├── key: (1)
           │    ├── fd: (1)-->(2-4)
           │    └── inner-join (lookup supplier)
           │         ├── columns: s_suppkey:1!null s_name:2!null s_address:3!null s_nationkey:4!null ps_suppkey:15!null
           │         ├── key columns: [15] = [1]
           │         ├── lookup columns are key
           │         ├── immutable
           │         ├── key: (15)
           │         ├── fd: (1)-->(2-4), (1)==(15), (15)==(1)
           │         ├── distinct-on
           │         │    ├── columns: ps_suppkey:15!null
           │         │    ├── grouping columns: ps_suppkey:15!null
           │         │    ├── immutable
           │         │    ├── key: (15)
           │         │    └── project
           │         │         ├── columns: ps_partkey:14!null ps_suppkey:15!null
           │         │         ├── immutable
           │         │         ├── key: (14,15)
           │         │         └── project
           │         │              ├── columns: ps_partkey:14!null ps_suppkey:15!null p_partkey:20!null
           │         │              ├── immutable
           │         │              ├── key: (15,20)
           │         │              ├── fd: (14)==(20), (20)==(14)
           │         │              └── inner-join (lookup part)
           │         │                   ├── columns: ps_partkey:14!null ps_suppkey:15!null ps_availqty:16!null p_partkey:20!null p_name:21!null sum:47!null
           │         │                   ├── key columns: [14] = [20]
           │         │                   ├── lookup columns are key
           │         │                   ├── immutable
           │         │                   ├── key: (15,20)
           │         │                   ├── fd: (14,15)-->(16,47), (20)-->(21), (14)==(20), (20)==(14)
           │         │                   ├── select
           │         │                   │    ├── columns: ps_partkey:14!null ps_suppkey:15!null ps_availqty:16!null sum:47!null
           │         │                   │    ├── immutable
           │         │                   │    ├── key: (14,15)
           │         │                   │    ├── fd: (14,15)-->(16,47)
           │         │                   │    ├── group-by
           │         │                   │    │    ├── columns: ps_partkey:14!null ps_suppkey:15!null ps_availqty:16!null sum:47!null
           │         │                   │    │    ├── grouping columns: ps_partkey:14!null ps_suppkey:15!null
           │         │                   │    │    ├── key: (14,15)
           │         │                   │    │    ├── fd: (14,15)-->(16,47)
           │         │                   │    │    ├── inner-join (hash)
           │         │                   │    │    │    ├── columns: ps_partkey:14!null ps_suppkey:15!null ps_availqty:16!null l_partkey:31!null l_suppkey:32!null l_quantity:34!null l_shipdate:40!null
           │         │                   │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
           │         │                   │    │    │    ├── fd: (14,15)-->(16), (14)==(31), (31)==(14), (15)==(32), (32)==(15)
           │         │                   │    │    │    ├── index-join lineitem
           │         │                   │    │    │    │    ├── columns: l_partkey:31!null l_suppkey:32!null l_quantity:34!null l_shipdate:40!null
           │         │                   │    │    │    │    └── scan lineitem@l_sd
           │         │                   │    │    │    │         ├── columns: l_orderkey:30!null l_linenumber:33!null l_shipdate:40!null
           │         │                   │    │    │    │         ├── constraint: /40/30/33: [/'1994-01-01' - /'1994-12-31']
           │         │                   │    │    │    │         ├── key: (30,33)
           │         │                   │    │    │    │         └── fd: (30,33)-->(40)
           │         │                   │    │    │    ├── scan partsupp
           │         │                   │    │    │    │    ├── columns: ps_partkey:14!null ps_suppkey:15!null ps_availqty:16!null
           │         │                   │    │    │    │    ├── key: (14,15)
           │         │                   │    │    │    │    └── fd: (14,15)-->(16)
           │         │                   │    │    │    └── filters
           │         │                   │    │    │         ├── l_partkey:31 = ps_partkey:14 [outer=(14,31), constraints=(/14: (/NULL - ]; /31: (/NULL - ]), fd=(14)==(31), (31)==(14)]
           │         │                   │    │    │         └── l_suppkey:32 = ps_suppkey:15 [outer=(15,32), constraints=(/15: (/NULL - ]; /32: (/NULL - ]), fd=(15)==(32), (32)==(15)]
           │         │                   │    │    └── aggregations
           │         │                   │    │         ├── sum [as=sum:47, outer=(34)]
           │         │                   │    │         │    └── l_quantity:34
           │         │                   │    │         └── const-agg [as=ps_availqty:16, outer=(16)]
           │         │                   │    │              └── ps_availqty:16
           │         │                   │    └── filters
           │         │                   │         └── ps_availqty:16 > (sum:47 * 0.5) [outer=(16,47), immutable, constraints=(/16: (/NULL - ])]
           │         │                   └── filters
           │         │                        └── p_name:21 LIKE 'forest%' [outer=(21), constraints=(/21: [/'forest' - /'foresu'); tight)]
           │         └── filters (true)
           └── filters
                └── n_name:10 = 'CANADA' [outer=(10), constraints=(/10: [/'CANADA' - /'CANADA']; tight), fd=()-->(10)]

# --------------------------------------------------
# Q21
# Suppliers Who Kept Orders Waiting Query
# Identifies certain suppliers who were not able to ship required parts in a
#  timely manner.
#
# Identifies suppliers, for a given nation, whose product was part of a multi-
# supplier order (with current status of 'F') where they were the only supplier
# who failed to meet the committed delivery date.
# --------------------------------------------------
opt
SELECT
    s_name,
    count(*) AS numwait
FROM
    supplier,
    lineitem l1,
    orders,
    nation
WHERE
    s_suppkey = l1.l_suppkey
    AND o_orderkey = l1.l_orderkey
    AND o_orderstatus = 'F'
    AND l1.l_receiptDATE > l1.l_commitdate
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem l2
        WHERE
            l2.l_orderkey = l1.l_orderkey
            AND l2.l_suppkey <> l1.l_suppkey
    )
    AND NOT EXISTS (
        SELECT
            *
        FROM
            lineitem l3
        WHERE
            l3.l_orderkey = l1.l_orderkey
            AND l3.l_suppkey <> l1.l_suppkey
            AND l3.l_receiptDATE > l3.l_commitdate
    )
    AND s_nationkey = n_nationkey
    AND n_name = 'SAUDI ARABIA'
GROUP BY
    s_name
ORDER BY
    numwait DESC,
    s_name
LIMIT 100;
----
limit
 ├── columns: s_name:2!null numwait:75!null
 ├── internal-ordering: -75,+2
 ├── cardinality: [0 - 100]
 ├── key: (2)
 ├── fd: (2)-->(75)
 ├── ordering: -75,+2
 ├── sort
 │    ├── columns: s_name:2!null count_rows:75!null
 │    ├── key: (2)
 │    ├── fd: (2)-->(75)
 │    ├── ordering: -75,+2
 │    ├── limit hint: 100.00
 │    └── group-by
 │         ├── columns: s_name:2!null count_rows:75!null
 │         ├── grouping columns: s_name:2!null
 │         ├── key: (2)
 │         ├── fd: (2)-->(75)
 │         ├── inner-join (lookup orders)
 │         │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null l1.l_orderkey:9!null l1.l_suppkey:11!null l1.l_commitdate:20!null l1.l_receiptdate:21!null o_orderkey:26!null o_orderstatus:28!null n_nationkey:36!null n_name:37!null
 │         │    ├── key columns: [9] = [26]
 │         │    ├── lookup columns are key
 │         │    ├── fd: ()-->(28,37), (1)-->(2,4), (9)==(26), (26)==(9), (1)==(11), (11)==(1), (4)==(36), (36)==(4)
 │         │    ├── anti-join (lookup lineitem [as=l3])
 │         │    │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null l1.l_orderkey:9!null l1.l_suppkey:11!null l1.l_commitdate:20!null l1.l_receiptdate:21!null n_nationkey:36!null n_name:37!null
 │         │    │    ├── key columns: [9] = [58]
 │         │    │    ├── fd: ()-->(37), (1)-->(2,4), (4)==(36), (36)==(4), (1)==(11), (11)==(1)
 │         │    │    ├── semi-join (lookup lineitem [as=l2])
 │         │    │    │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null l1.l_orderkey:9!null l1.l_suppkey:11!null l1.l_commitdate:20!null l1.l_receiptdate:21!null n_nationkey:36!null n_name:37!null
 │         │    │    │    ├── key columns: [9] = [41]
 │         │    │    │    ├── fd: ()-->(37), (1)-->(2,4), (4)==(36), (36)==(4), (1)==(11), (11)==(1)
 │         │    │    │    ├── inner-join (lookup lineitem [as=l1])
 │         │    │    │    │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null l1.l_orderkey:9!null l1.l_suppkey:11!null l1.l_commitdate:20!null l1.l_receiptdate:21!null n_nationkey:36!null n_name:37!null
 │         │    │    │    │    ├── key columns: [9 12] = [9 12]
 │         │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    ├── fd: ()-->(37), (1)-->(2,4), (4)==(36), (36)==(4), (1)==(11), (11)==(1)
 │         │    │    │    │    ├── inner-join (lookup lineitem@l_sk [as=l1])
 │         │    │    │    │    │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null l1.l_orderkey:9!null l1.l_suppkey:11!null l1.l_linenumber:12!null n_nationkey:36!null n_name:37!null
 │         │    │    │    │    │    ├── key columns: [1] = [11]
 │         │    │    │    │    │    ├── key: (9,12)
 │         │    │    │    │    │    ├── fd: ()-->(37), (1)-->(2,4), (4)==(36), (36)==(4), (9,12)-->(11), (1)==(11), (11)==(1)
 │         │    │    │    │    │    ├── inner-join (lookup supplier)
 │         │    │    │    │    │    │    ├── columns: s_suppkey:1!null s_name:2!null s_nationkey:4!null n_nationkey:36!null n_name:37!null
 │         │    │    │    │    │    │    ├── key columns: [1] = [1]
 │         │    │    │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    │    │    ├── key: (1)
 │         │    │    │    │    │    │    ├── fd: ()-->(37), (1)-->(2,4), (4)==(36), (36)==(4)
 │         │    │    │    │    │    │    ├── inner-join (lookup supplier@s_nk)
 │         │    │    │    │    │    │    │    ├── columns: s_suppkey:1!null s_nationkey:4!null n_nationkey:36!null n_name:37!null
 │         │    │    │    │    │    │    │    ├── key columns: [36] = [4]
 │         │    │    │    │    │    │    │    ├── key: (1)
 │         │    │    │    │    │    │    │    ├── fd: ()-->(37), (1)-->(4), (4)==(36), (36)==(4)
 │         │    │    │    │    │    │    │    ├── select
 │         │    │    │    │    │    │    │    │    ├── columns: n_nationkey:36!null n_name:37!null
 │         │    │    │    │    │    │    │    │    ├── key: (36)
 │         │    │    │    │    │    │    │    │    ├── fd: ()-->(37)
 │         │    │    │    │    │    │    │    │    ├── scan nation
 │         │    │    │    │    │    │    │    │    │    ├── columns: n_nationkey:36!null n_name:37!null
 │         │    │    │    │    │    │    │    │    │    ├── key: (36)
 │         │    │    │    │    │    │    │    │    │    └── fd: (36)-->(37)
 │         │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │         └── n_name:37 = 'SAUDI ARABIA' [outer=(37), constraints=(/37: [/'SAUDI ARABIA' - /'SAUDI ARABIA']; tight), fd=()-->(37)]
 │         │    │    │    │    │    │    │    └── filters (true)
 │         │    │    │    │    │    │    └── filters (true)
 │         │    │    │    │    │    └── filters (true)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── l1.l_receiptdate:21 > l1.l_commitdate:20 [outer=(20,21), constraints=(/20: (/NULL - ]; /21: (/NULL - ])]
 │         │    │    │    └── filters
 │         │    │    │         └── l2.l_suppkey:43 != l1.l_suppkey:11 [outer=(11,43), constraints=(/11: (/NULL - ]; /43: (/NULL - ])]
 │         │    │    └── filters
 │         │    │         ├── l3.l_suppkey:60 != l1.l_suppkey:11 [outer=(11,60), constraints=(/11: (/NULL - ]; /60: (/NULL - ])]
 │         │    │         └── l3.l_receiptdate:70 > l3.l_commitdate:69 [outer=(69,70), constraints=(/69: (/NULL - ]; /70: (/NULL - ])]
 │         │    └── filters
 │         │         └── o_orderstatus:28 = 'F' [outer=(28), constraints=(/28: [/'F' - /'F']; tight), fd=()-->(28)]
 │         └── aggregations
 │              └── count-rows [as=count_rows:75]
 └── 100

# --------------------------------------------------
# Q22
# Global Sales Opportunity
# Identifies geographies where there are customers who may be likely to make a
# purchase.
#
# This query counts how many customers within a specific range of country codes
# have not placed orders for 7 years but who have a greater than average
# “positive” account balance. It also reflects the magnitude of that balance.
# Country code is defined as the first two characters of c_phone.
# --------------------------------------------------
opt
SELECT
    cntrycode,
    count(*) AS numcust,
    sum(c_acctbal) AS totacctbal
FROM (
    SELECT
        substring(c_phone FROM 1 FOR 2) AS cntrycode,
        c_acctbal
    FROM
        customer
    WHERE
        substring(c_phone FROM 1 FOR 2) in
            ('13', '31', '23', '29', '30', '18', '17')
        AND c_acctbal > (
            SELECT
                avg(c_acctbal)
            FROM
                customer
            WHERE
                c_acctbal > 0.00
                AND substring(c_phone FROM 1 FOR 2) in
                    ('13', '31', '23', '29', '30', '18', '17')
        )
        AND NOT EXISTS (
            SELECT
                *
            FROM
                orders
            WHERE
                o_custkey = c_custkey
        )
    ) AS custsale
GROUP BY
    cntrycode
ORDER BY
    cntrycode;
----
sort
 ├── columns: cntrycode:30 numcust:31!null totacctbal:32!null
 ├── immutable
 ├── key: (30)
 ├── fd: (30)-->(31,32)
 ├── ordering: +30
 └── group-by
      ├── columns: cntrycode:30 count_rows:31!null sum:32!null
      ├── grouping columns: cntrycode:30
      ├── immutable
      ├── key: (30)
      ├── fd: (30)-->(31,32)
      ├── project
      │    ├── columns: cntrycode:30 c_acctbal:6!null
      │    ├── immutable
      │    ├── anti-join (lookup orders@o_ck)
      │    │    ├── columns: c_custkey:1!null c_phone:5!null c_acctbal:6!null
      │    │    ├── key columns: [1] = [21]
      │    │    ├── immutable
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    ├── select
      │    │    │    ├── columns: c_custkey:1!null c_phone:5!null c_acctbal:6!null
      │    │    │    ├── immutable
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(5,6)
      │    │    │    ├── scan customer
      │    │    │    │    ├── columns: c_custkey:1!null c_phone:5!null c_acctbal:6!null
      │    │    │    │    ├── key: (1)
      │    │    │    │    └── fd: (1)-->(5,6)
      │    │    │    └── filters
      │    │    │         ├── substring(c_phone:5, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [outer=(5), immutable]
      │    │    │         └── gt [outer=(6), immutable, subquery, constraints=(/6: (/NULL - ])]
      │    │    │              ├── c_acctbal:6
      │    │    │              └── subquery
      │    │    │                   └── scalar-group-by
      │    │    │                        ├── columns: avg:19
      │    │    │                        ├── cardinality: [1 - 1]
      │    │    │                        ├── immutable
      │    │    │                        ├── key: ()
      │    │    │                        ├── fd: ()-->(19)
      │    │    │                        ├── select
      │    │    │                        │    ├── columns: c_phone:14!null c_acctbal:15!null
      │    │    │                        │    ├── immutable
      │    │    │                        │    ├── scan customer
      │    │    │                        │    │    └── columns: c_phone:14!null c_acctbal:15!null
      │    │    │                        │    └── filters
      │    │    │                        │         ├── c_acctbal:15 > 0.0 [outer=(15), constraints=(/15: [/5e-324 - ]; tight)]
      │    │    │                        │         └── substring(c_phone:14, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [outer=(14), immutable]
      │    │    │                        └── aggregations
      │    │    │                             └── avg [as=avg:19, outer=(15)]
      │    │    │                                  └── c_acctbal:15
      │    │    └── filters (true)
      │    └── projections
      │         └── substring(c_phone:5, 1, 2) [as=cntrycode:30, outer=(5), immutable]
      └── aggregations
           ├── count-rows [as=count_rows:31]
           └── sum [as=sum:32, outer=(6)]
                └── c_acctbal:6
