import file=tpcds_schema
----

import file=tpcds_stats
----

# --------------------------------------------------
# Q11
opt
	WITH
		year_total
			AS (
				SELECT
					c_customer_id AS customer_id,
					c_first_name AS customer_first_name,
					c_last_name AS customer_last_name,
					c_preferred_cust_flag
						AS customer_preferred_cust_flag,
					c_birth_country AS customer_birth_country,
					c_login AS customer_login,
					c_email_address AS customer_email_address,
					d_year AS dyear,
					sum(ss_ext_list_price - ss_ext_discount_amt)
						AS year_total,
					's' AS sale_type
				FROM
					customer, store_sales, date_dim
				WHERE
					c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
				GROUP BY
					c_customer_id,
					c_first_name,
					c_last_name,
					c_preferred_cust_flag,
					c_birth_country,
					c_login,
					c_email_address,
					d_year
				UNION ALL
					SELECT
						c_customer_id AS customer_id,
						c_first_name AS customer_first_name,
						c_last_name AS customer_last_name,
						c_preferred_cust_flag
							AS customer_preferred_cust_flag,
						c_birth_country
							AS customer_birth_country,
						c_login AS customer_login,
						c_email_address
							AS customer_email_address,
						d_year AS dyear,
						sum(
							ws_ext_list_price
							- ws_ext_discount_amt
						)
							AS year_total,
						'w' AS sale_type
					FROM
						customer, web_sales, date_dim
					WHERE
						c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
					GROUP BY
						c_customer_id,
						c_first_name,
						c_last_name,
						c_preferred_cust_flag,
						c_birth_country,
						c_login,
						c_email_address,
						d_year
			)
	SELECT
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_email_address
	FROM
		year_total AS t_s_firstyear,
		year_total AS t_s_secyear,
		year_total AS t_w_firstyear,
		year_total AS t_w_secyear
	WHERE
		t_s_secyear.customer_id = t_s_firstyear.customer_id
		AND t_s_firstyear.customer_id = t_w_secyear.customer_id
		AND t_s_firstyear.customer_id
			= t_w_firstyear.customer_id
		AND t_s_firstyear.sale_type = 's'
		AND t_w_firstyear.sale_type = 'w'
		AND t_s_secyear.sale_type = 's'
		AND t_w_secyear.sale_type = 'w'
		AND t_s_firstyear.dyear = 1998
		AND t_s_secyear.dyear = 1998 + 1
		AND t_w_firstyear.dyear = 1998
		AND t_w_secyear.dyear = 1998 + 1
		AND t_s_firstyear.year_total > 0
		AND t_w_firstyear.year_total > 0
		AND CASE
			WHEN t_w_firstyear.year_total > 0
			THEN t_w_secyear.year_total
			/ t_w_firstyear.year_total
			ELSE 0.0
			END
			> CASE
				WHEN t_s_firstyear.year_total > 0
				THEN t_s_secyear.year_total
				/ t_s_firstyear.year_total
				ELSE 0.0
				END
	ORDER BY
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_email_address
	LIMIT
		100;
----
with &1 (year_total)
 ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +188,+189,+190,+194
 ├── union-all
 │    ├── columns: customer_id:168!null customer_first_name:169 customer_last_name:170 customer_preferred_cust_flag:171 customer_birth_country:172 customer_login:173 customer_email_address:174 dyear:175 year_total:176 sale_type:177!null
 │    ├── left columns: c_customer_id:2 c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77 sale_type:78
 │    ├── right columns: c_customer_id:80 c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166 sale_type:167
 │    ├── immutable
 │    ├── project
 │    │    ├── columns: sale_type:78!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    ├── immutable
 │    │    ├── key: (2,9-11,15-17,52)
 │    │    ├── fd: ()-->(78), (2,9-11,15-17,52)-->(77)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    │    ├── grouping columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    ├── immutable
 │    │    │    ├── key: (2,9-11,15-17,52)
 │    │    │    ├── fd: (2,9-11,15-17,52)-->(77)
 │    │    │    ├── project
 │    │    │    │    ├── columns: column76:76 c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    │    ├── immutable
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21!null ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_list_price:38 d_date_sk:46!null d_year:52
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (46)-->(52), (21)==(46), (46)==(21), (1)==(24), (24)==(1)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21 ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_list_price:38
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (1)==(24), (24)==(1)
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:21 ss_customer_sk:24 ss_ext_discount_amt:35 ss_ext_list_price:38
 │    │    │    │    │    │    ├── scan customer
 │    │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17
 │    │    │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    │    │    └── fd: (1)-->(2,9-11,15-17)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── c_customer_sk:1 = ss_customer_sk:24 [outer=(1,24), constraints=(/1: (/NULL - ]; /24: (/NULL - ]), fd=(1)==(24), (24)==(1)]
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:46!null d_year:52
 │    │    │    │    │    │    ├── key: (46)
 │    │    │    │    │    │    └── fd: (46)-->(52)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:21 = d_date_sk:46 [outer=(21,46), constraints=(/21: (/NULL - ]; /46: (/NULL - ]), fd=(21)==(46), (46)==(21)]
 │    │    │    │    └── projections
 │    │    │    │         └── ss_ext_list_price:38 - ss_ext_discount_amt:35 [as=column76:76, outer=(35,38), immutable]
 │    │    │    └── aggregations
 │    │    │         └── sum [as=sum:77, outer=(76)]
 │    │    │              └── column76:76
 │    │    └── projections
 │    │         └── 's' [as=sale_type:78]
 │    └── project
 │         ├── columns: sale_type:167!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │         ├── immutable
 │         ├── key: (80,87-89,93-95,141)
 │         ├── fd: ()-->(167), (80,87-89,93-95,141)-->(166)
 │         ├── group-by (hash)
 │         │    ├── columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │         │    ├── grouping columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │         │    ├── immutable
 │         │    ├── key: (80,87-89,93-95,141)
 │         │    ├── fd: (80,87-89,93-95,141)-->(166)
 │         │    ├── project
 │         │    │    ├── columns: column165:165 c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │         │    │    ├── immutable
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 ws_sold_date_sk:99!null ws_bill_customer_sk:103!null ws_ext_discount_amt:121 ws_ext_list_price:124 d_date_sk:135!null d_year:141
 │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    ├── fd: (79)-->(80,87-89,93-95), (135)-->(141), (99)==(135), (135)==(99), (79)==(103), (103)==(79)
 │         │    │    │    ├── inner-join (hash)
 │         │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 ws_sold_date_sk:99 ws_bill_customer_sk:103!null ws_ext_discount_amt:121 ws_ext_list_price:124
 │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    ├── fd: (79)-->(80,87-89,93-95), (79)==(103), (103)==(79)
 │         │    │    │    │    ├── scan web_sales
 │         │    │    │    │    │    └── columns: ws_sold_date_sk:99 ws_bill_customer_sk:103 ws_ext_discount_amt:121 ws_ext_list_price:124
 │         │    │    │    │    ├── scan customer
 │         │    │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95
 │         │    │    │    │    │    ├── key: (79)
 │         │    │    │    │    │    └── fd: (79)-->(80,87-89,93-95)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── c_customer_sk:79 = ws_bill_customer_sk:103 [outer=(79,103), constraints=(/79: (/NULL - ]; /103: (/NULL - ]), fd=(79)==(103), (103)==(79)]
 │         │    │    │    ├── scan date_dim
 │         │    │    │    │    ├── columns: d_date_sk:135!null d_year:141
 │         │    │    │    │    ├── key: (135)
 │         │    │    │    │    └── fd: (135)-->(141)
 │         │    │    │    └── filters
 │         │    │    │         └── ws_sold_date_sk:99 = d_date_sk:135 [outer=(99,135), constraints=(/99: (/NULL - ]; /135: (/NULL - ]), fd=(99)==(135), (135)==(99)]
 │         │    │    └── projections
 │         │    │         └── ws_ext_list_price:124 - ws_ext_discount_amt:121 [as=column165:165, outer=(121,124), immutable]
 │         │    └── aggregations
 │         │         └── sum [as=sum:166, outer=(165)]
 │         │              └── column165:165
 │         └── projections
 │              └── 'w' [as=sale_type:167]
 └── project
      ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +188,+189,+190,+194
      └── top-k
           ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
           ├── internal-ordering: +(178|188|198|208),+189,+190,+194 opt(185,187,195,197,205,207,215,217)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── fd: ()-->(185,187,195,197,205,207,215,217), (178)==(188,198,208), (188)==(178,198,208), (198)==(178,188,208), (208)==(178,188,198)
           ├── ordering: +(178|188|198|208),+189,+190,+194 opt(185,187,195,197,205,207,215,217) [actual: +178,+189,+190,+194]
           └── inner-join (hash)
                ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                ├── immutable
                ├── fd: ()-->(185,187,195,197,205,207,215,217), (178)==(188,198,208), (188)==(178,198,208), (198)==(178,188,208), (208)==(178,188,198)
                ├── select
                │    ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null
                │    ├── fd: ()-->(195,197)
                │    ├── with-scan &1 (year_total)
                │    │    ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195 year_total:196 sale_type:197!null
                │    │    └── mapping:
                │    │         ├──  customer_id:168 => customer_id:188
                │    │         ├──  customer_first_name:169 => customer_first_name:189
                │    │         ├──  customer_last_name:170 => customer_last_name:190
                │    │         ├──  customer_email_address:174 => customer_email_address:194
                │    │         ├──  dyear:175 => dyear:195
                │    │         ├──  year_total:176 => year_total:196
                │    │         └──  sale_type:177 => sale_type:197
                │    └── filters
                │         ├── sale_type:197 = 's' [outer=(197), constraints=(/197: [/'s' - /'s']; tight), fd=()-->(197)]
                │         └── dyear:195 = 1999 [outer=(195), constraints=(/195: [/1999 - /1999]; tight), fd=()-->(195)]
                ├── inner-join (hash)
                │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                │    ├── immutable
                │    ├── fd: ()-->(185,187,205,207,215,217), (178)==(198,208), (198)==(178,208), (208)==(178,198)
                │    ├── select
                │    │    ├── columns: customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                │    │    ├── fd: ()-->(215,217)
                │    │    ├── with-scan &1 (year_total)
                │    │    │    ├── columns: customer_id:208!null dyear:215 year_total:216 sale_type:217!null
                │    │    │    └── mapping:
                │    │    │         ├──  customer_id:168 => customer_id:208
                │    │    │         ├──  dyear:175 => dyear:215
                │    │    │         ├──  year_total:176 => year_total:216
                │    │    │         └──  sale_type:177 => sale_type:217
                │    │    └── filters
                │    │         ├── sale_type:217 = 'w' [outer=(217), constraints=(/217: [/'w' - /'w']; tight), fd=()-->(217)]
                │    │         └── dyear:215 = 1999 [outer=(215), constraints=(/215: [/1999 - /1999]; tight), fd=()-->(215)]
                │    ├── inner-join (hash)
                │    │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null
                │    │    ├── immutable
                │    │    ├── fd: ()-->(185,187,205,207), (178)==(198), (198)==(178)
                │    │    ├── select
                │    │    │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(185,187)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:178!null dyear:185 year_total:186 sale_type:187!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:168 => customer_id:178
                │    │    │    │         ├──  dyear:175 => dyear:185
                │    │    │    │         ├──  year_total:176 => year_total:186
                │    │    │    │         └──  sale_type:177 => sale_type:187
                │    │    │    └── filters
                │    │    │         ├── sale_type:187 = 's' [outer=(187), constraints=(/187: [/'s' - /'s']; tight), fd=()-->(187)]
                │    │    │         ├── dyear:185 = 1998 [outer=(185), constraints=(/185: [/1998 - /1998]; tight), fd=()-->(185)]
                │    │    │         └── year_total:186 > 0 [outer=(186), immutable, constraints=(/186: (/0 - ]; tight)]
                │    │    ├── select
                │    │    │    ├── columns: customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(205,207)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:198!null dyear:205 year_total:206 sale_type:207!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:168 => customer_id:198
                │    │    │    │         ├──  dyear:175 => dyear:205
                │    │    │    │         ├──  year_total:176 => year_total:206
                │    │    │    │         └──  sale_type:177 => sale_type:207
                │    │    │    └── filters
                │    │    │         ├── sale_type:207 = 'w' [outer=(207), constraints=(/207: [/'w' - /'w']; tight), fd=()-->(207)]
                │    │    │         ├── dyear:205 = 1998 [outer=(205), constraints=(/205: [/1998 - /1998]; tight), fd=()-->(205)]
                │    │    │         └── year_total:206 > 0 [outer=(206), immutable, constraints=(/206: (/0 - ]; tight)]
                │    │    └── filters
                │    │         └── customer_id:178 = customer_id:198 [outer=(178,198), constraints=(/178: (/NULL - ]; /198: (/NULL - ]), fd=(178)==(198), (198)==(178)]
                │    └── filters
                │         └── customer_id:198 = customer_id:208 [outer=(198,208), constraints=(/198: (/NULL - ]; /208: (/NULL - ]), fd=(198)==(208), (208)==(198)]
                └── filters
                     ├── customer_id:188 = customer_id:198 [outer=(188,198), constraints=(/188: (/NULL - ]; /198: (/NULL - ]), fd=(188)==(198), (198)==(188)]
                     └── CASE WHEN year_total:206 > 0 THEN year_total:216 / year_total:206 ELSE 0.0 END > CASE WHEN year_total:186 > 0 THEN year_total:196 / year_total:186 ELSE 0.0 END [outer=(186,196,206,216), immutable]

# --------------------------------------------------
# Q12
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price,
		sum(ws_ext_sales_price) AS itemrevenue,
		sum(ws_ext_sales_price) * 100
		/ sum(sum(ws_ext_sales_price)) OVER (
				PARTITION BY i_class
			)
			AS revenueratio
	FROM
		web_sales, item, date_dim
	WHERE
		ws_item_sk = i_item_sk
		AND i_category IN ('Men', 'Books', 'Electronics')
		AND ws_sold_date_sk = d_date_sk
		AND d_date BETWEEN CAST('2001-06-15' AS DATE) AND (CAST('2001-06-15' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price
	ORDER BY
		i_category,
		i_class,
		i_item_id,
		i_item_desc,
		revenueratio
	LIMIT
		100;
----
top-k
 ├── columns: i_item_id:38!null i_item_desc:41 i_category:49!null i_class:47 i_current_price:42 itemrevenue:91 revenueratio:93
 ├── internal-ordering: +49,+47,+38,+41,+93
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (38,41,42,47,49)
 ├── fd: (38,41,42,47,49)-->(91,93)
 ├── ordering: +49,+47,+38,+41,+93
 └── project
      ├── columns: revenueratio:93 i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      ├── immutable
      ├── key: (38,41,42,47,49)
      ├── fd: (38,41,42,47,49)-->(91,93)
      ├── window partition=(47)
      │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91 sum:92
      │    ├── key: (38,41,42,47,49)
      │    ├── fd: (38,41,42,47,49)-->(91,92)
      │    ├── group-by (hash)
      │    │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      │    │    ├── grouping columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    ├── key: (38,41,42,47,49)
      │    │    ├── fd: (38,41,42,47,49)-->(91)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null d_date_sk:61!null d_date:63!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(38,41,42,47,49), (61)-->(63), (4)==(37), (37)==(4), (1)==(61), (61)==(1)
      │    │    │    ├── inner-join (lookup web_sales)
      │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    ├── key columns: [37] = [4]
      │    │    │    │    ├── fd: (37)-->(38,41,42,47,49), (4)==(37), (37)==(4)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    ├── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49
      │    │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    │    └── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── i_category:49 IN ('Books', 'Electronics', 'Men') [outer=(49), constraints=(/49: [/'Books' - /'Books'] [/'Electronics' - /'Electronics'] [/'Men' - /'Men']; tight)]
      │    │    │    │    └── filters (true)
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
      │    │    │    │    ├── key: (61)
      │    │    │    │    ├── fd: (61)-->(63)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
      │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    └── fd: (61)-->(63)
      │    │    │    │    └── filters
      │    │    │    │         └── (d_date:63 >= '2001-06-15') AND (d_date:63 <= '2001-07-15') [outer=(63), constraints=(/63: [/'2001-06-15' - /'2001-07-15']; tight)]
      │    │    │    └── filters
      │    │    │         └── ws_sold_date_sk:1 = d_date_sk:61 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
      │    │    └── aggregations
      │    │         └── sum [as=sum:91, outer=(24)]
      │    │              └── ws_ext_sales_price:24
      │    └── windows
      │         └── sum [as=sum:92, outer=(91)]
      │              └── sum:91
      └── projections
           └── (sum:91 * 100) / sum:92 [as=revenueratio:93, outer=(91,92), immutable]

# --------------------------------------------------
# Q13
opt
	SELECT
		avg(ss_quantity),
		avg(ss_ext_sales_price),
		avg(ss_ext_wholesale_cost),
		sum(ss_ext_wholesale_cost)
	FROM
		store_sales,
		store,
		customer_demographics,
		household_demographics,
		customer_address,
		date_dim
	WHERE
		s_store_sk = ss_store_sk
		AND ss_sold_date_sk = d_date_sk
		AND d_year = 2001
		AND (
				(
					ss_hdemo_sk = hd_demo_sk
					AND cd_demo_sk = ss_cdemo_sk
					AND cd_marital_status = 'M'
					AND cd_education_status = 'College'
					AND ss_sales_price BETWEEN 100.00 AND 150.00
					AND hd_dep_count = 3
				)
				OR (
						ss_hdemo_sk = hd_demo_sk
						AND cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'D'
						AND cd_education_status = 'Primary'
						AND ss_sales_price BETWEEN 50.00 AND 100.00
						AND hd_dep_count = 1
					)
				OR (
						ss_hdemo_sk = hd_demo_sk
						AND cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'W'
						AND cd_education_status = '2 yr Degree'
						AND ss_sales_price BETWEEN 150.00 AND 200.00
						AND hd_dep_count = 1
					)
			)
		AND (
				(
					ss_addr_sk = ca_address_sk
					AND ca_country = 'United States'
					AND ca_state IN ('IL', 'TN', 'TX')
					AND ss_net_profit BETWEEN 100 AND 200
				)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('WY', 'OH', 'ID')
						AND ss_net_profit BETWEEN 150 AND 300
					)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('MS', 'SC', 'IA')
						AND ss_net_profit BETWEEN 50 AND 250
					)
			);
----
scalar-group-by
 ├── columns: avg:120 avg:121 avg:122 sum:123
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(120-123)
 ├── inner-join (lookup customer_demographics)
 │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5!null ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14!null ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null cd_demo_sk:57!null cd_marital_status:59!null cd_education_status:60!null hd_demo_sk:68!null hd_dep_count:71!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    ├── key columns: [5] = [57]
 │    ├── lookup columns are key
 │    ├── immutable
 │    ├── fd: ()-->(85,96), (57)-->(59,60), (68)-->(71), (75)-->(83), (8)==(26), (26)==(8), (5)==(57), (57)==(5), (6)==(68), (68)==(6), (7)==(75), (75)==(7), (1)==(90), (90)==(1)
 │    ├── inner-join (hash)
 │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null hd_demo_sk:68!null hd_dep_count:71 ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── immutable
 │    │    ├── fd: ()-->(85,96), (68)-->(71), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7), (6)==(68), (68)==(6), (8)==(26), (26)==(8)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── immutable
 │    │    │    ├── fd: ()-->(85,96), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7), (8)==(26), (26)==(8)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7!null ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(85,96), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23 d_date_sk:90!null d_year:96!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: ()-->(96), (1)==(90), (90)==(1)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:90!null d_year:96!null
 │    │    │    │    │    │    ├── key: (90)
 │    │    │    │    │    │    ├── fd: ()-->(96)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:90!null d_year:96
 │    │    │    │    │    │    │    ├── key: (90)
 │    │    │    │    │    │    │    └── fd: (90)-->(96)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── d_year:96 = 2001 [outer=(96), constraints=(/96: [/2001 - /2001]; tight), fd=()-->(96)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:90 [outer=(1,90), constraints=(/1: (/NULL - ]; /90: (/NULL - ]), fd=(1)==(90), (90)==(1)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: ca_address_sk:75!null ca_state:83 ca_country:85!null
 │    │    │    │    │    ├── key: (75)
 │    │    │    │    │    ├── fd: ()-->(85), (75)-->(83)
 │    │    │    │    │    ├── scan customer_address
 │    │    │    │    │    │    ├── columns: ca_address_sk:75!null ca_state:83 ca_country:85
 │    │    │    │    │    │    ├── key: (75)
 │    │    │    │    │    │    └── fd: (75)-->(83,85)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ca_country:85 = 'United States' [outer=(85), constraints=(/85: [/'United States' - /'United States']; tight), fd=()-->(85)]
 │    │    │    │    └── filters
 │    │    │    │         ├── ss_addr_sk:7 = ca_address_sk:75 [outer=(7,75), constraints=(/7: (/NULL - ]; /75: (/NULL - ]), fd=(7)==(75), (75)==(7)]
 │    │    │    │         └── ((((ca_state:83 IN ('IL', 'TN', 'TX')) AND (ss_net_profit:23 >= 100)) AND (ss_net_profit:23 <= 200)) OR (((ca_state:83 IN ('ID', 'OH', 'WY')) AND (ss_net_profit:23 >= 150)) AND (ss_net_profit:23 <= 300))) OR (((ca_state:83 IN ('IA', 'MS', 'SC')) AND (ss_net_profit:23 >= 50)) AND (ss_net_profit:23 <= 250)) [outer=(23,83), immutable, constraints=(/23: [/50 - /300]; /83: [/'IA' - /'IA'] [/'ID' - /'ID'] [/'IL' - /'IL'] [/'MS' - /'MS'] [/'OH' - /'OH'] [/'SC' - /'SC'] [/'TN' - /'TN'] [/'TX' - /'TX'] [/'WY' - /'WY'])]
 │    │    │    ├── scan store
 │    │    │    │    ├── columns: s_store_sk:26!null
 │    │    │    │    └── key: (26)
 │    │    │    └── filters
 │    │    │         └── s_store_sk:26 = ss_store_sk:8 [outer=(8,26), constraints=(/8: (/NULL - ]; /26: (/NULL - ]), fd=(8)==(26), (26)==(8)]
 │    │    ├── scan household_demographics
 │    │    │    ├── columns: hd_demo_sk:68!null hd_dep_count:71
 │    │    │    ├── key: (68)
 │    │    │    └── fd: (68)-->(71)
 │    │    └── filters
 │    │         └── ss_hdemo_sk:6 = hd_demo_sk:68 [outer=(6,68), constraints=(/6: (/NULL - ]; /68: (/NULL - ]), fd=(6)==(68), (68)==(6)]
 │    └── filters
 │         └── ((((((cd_marital_status:59 = 'M') AND (cd_education_status:60 = 'College')) AND (ss_sales_price:14 >= 100.00)) AND (ss_sales_price:14 <= 150.00)) AND (hd_dep_count:71 = 3)) OR (((((cd_marital_status:59 = 'D') AND (cd_education_status:60 = 'Primary')) AND (ss_sales_price:14 >= 50.00)) AND (ss_sales_price:14 <= 100.00)) AND (hd_dep_count:71 = 1))) OR (((((cd_marital_status:59 = 'W') AND (cd_education_status:60 = '2 yr Degree')) AND (ss_sales_price:14 >= 150.00)) AND (ss_sales_price:14 <= 200.00)) AND (hd_dep_count:71 = 1)) [outer=(14,59,60,71), immutable, constraints=(/14: [/50.00 - /200.00]; /59: [/'D' - /'D'] [/'M' - /'M'] [/'W' - /'W']; /60: [/'2 yr Degree' - /'2 yr Degree'] [/'College' - /'College'] [/'Primary' - /'Primary']; /71: [/1 - /1] [/3 - /3])]
 └── aggregations
      ├── avg [as=avg:120, outer=(11)]
      │    └── ss_quantity:11
      ├── avg [as=avg:121, outer=(16)]
      │    └── ss_ext_sales_price:16
      ├── avg [as=avg:122, outer=(17)]
      │    └── ss_ext_wholesale_cost:17
      └── sum [as=sum:123, outer=(17)]
           └── ss_ext_wholesale_cost:17

# --------------------------------------------------
# Q14
# TODO(#46280): adjust the query to work with CRDB.
# opt
# 	WITH
# 		cross_items
# 			AS (
# 				SELECT
# 					i_item_sk AS ss_item_sk
# 				FROM
# 					item,
# 					(
# 						SELECT
# 							iss.i_brand_id AS brand_id,
# 							iss.i_class_id AS class_id,
# 							iss.i_category_id AS category_id
# 						FROM
# 							store_sales,
# 							item AS iss,
# 							date_dim AS d1
# 						WHERE
# 							ss_item_sk = iss.i_item_sk
# 							AND ss_sold_date_sk = d1.d_date_sk
# 							AND d1.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								ics.i_brand_id,
# 								ics.i_class_id,
# 								ics.i_category_id
# 							FROM
# 								catalog_sales,
# 								item AS ics,
# 								date_dim AS d2
# 							WHERE
# 								cs_item_sk = ics.i_item_sk
# 								AND cs_sold_date_sk
# 									= d2.d_date_sk
# 								AND d2.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								iws.i_brand_id,
# 								iws.i_class_id,
# 								iws.i_category_id
# 							FROM
# 								web_sales,
# 								item AS iws,
# 								date_dim AS d3
# 							WHERE
# 								ws_item_sk = iws.i_item_sk
# 								AND ws_sold_date_sk
# 									= d3.d_date_sk
# 								AND d3.d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 				WHERE
# 					i_brand_id = brand_id
# 					AND i_class_id = class_id
# 					AND i_category_id = category_id
# 			),
# 		avg_sales
# 			AS (
# 				SELECT
# 					avg(quantity * list_price) AS average_sales
# 				FROM
# 					(
# 						SELECT
# 							ss_quantity AS quantity,
# 							ss_list_price AS list_price
# 						FROM
# 							store_sales, date_dim
# 						WHERE
# 							ss_sold_date_sk = d_date_sk
# 							AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								cs_quantity AS quantity,
# 								cs_list_price AS list_price
# 							FROM
# 								catalog_sales, date_dim
# 							WHERE
# 								cs_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								ws_quantity AS quantity,
# 								ws_list_price AS list_price
# 							FROM
# 								web_sales, date_dim
# 							WHERE
# 								ws_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 			)
# 	SELECT
# 		channel,
# 		i_brand_id,
# 		i_class_id,
# 		i_category_id,
# 		sum(sales),
# 		sum(number_sales)
# 	FROM
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_year = 1999 + 2
# 				AND d_moy = 11
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 			UNION ALL
# 				SELECT
# 					'catalog' AS channel,
# 					i_brand_id,
# 					i_class_id,
# 					i_category_id,
# 					sum(cs_quantity * cs_list_price) AS sales,
# 					count(*) AS number_sales
# 				FROM
# 					catalog_sales, item, date_dim
# 				WHERE
# 					cs_item_sk
# 					IN (SELECT ss_item_sk FROM cross_items)
# 					AND cs_item_sk = i_item_sk
# 					AND cs_sold_date_sk = d_date_sk
# 					AND d_year = 1999 + 2
# 					AND d_moy = 11
# 				GROUP BY
# 					i_brand_id, i_class_id, i_category_id
# 				HAVING
# 					sum(cs_quantity * cs_list_price)
# 					> (SELECT average_sales FROM avg_sales)
# 			UNION ALL
# 				SELECT
# 					'web' AS channel,
# 					i_brand_id,
# 					i_class_id,
# 					i_category_id,
# 					sum(ws_quantity * ws_list_price) AS sales,
# 					count(*) AS number_sales
# 				FROM
# 					web_sales, item, date_dim
# 				WHERE
# 					ws_item_sk
# 					IN (SELECT ss_item_sk FROM cross_items)
# 					AND ws_item_sk = i_item_sk
# 					AND ws_sold_date_sk = d_date_sk
# 					AND d_year = 1999 + 2
# 					AND d_moy = 11
# 				GROUP BY
# 					i_brand_id, i_class_id, i_category_id
# 				HAVING
# 					sum(ws_quantity * ws_list_price)
# 					> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS y
# 	GROUP BY
# 		rollup(channel, i_brand_id, i_class_id, i_category_id)
# 	ORDER BY
# 		channel, i_brand_id, i_class_id, i_category_id
# 	LIMIT
# 		100;
# 	WITH
# 		cross_items
# 			AS (
# 				SELECT
# 					i_item_sk AS ss_item_sk
# 				FROM
# 					item,
# 					(
# 						SELECT
# 							iss.i_brand_id AS brand_id,
# 							iss.i_class_id AS class_id,
# 							iss.i_category_id AS category_id
# 						FROM
# 							store_sales,
# 							item AS iss,
# 							date_dim AS d1
# 						WHERE
# 							ss_item_sk = iss.i_item_sk
# 							AND ss_sold_date_sk = d1.d_date_sk
# 							AND d1.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								ics.i_brand_id,
# 								ics.i_class_id,
# 								ics.i_category_id
# 							FROM
# 								catalog_sales,
# 								item AS ics,
# 								date_dim AS d2
# 							WHERE
# 								cs_item_sk = ics.i_item_sk
# 								AND cs_sold_date_sk
# 									= d2.d_date_sk
# 								AND d2.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								iws.i_brand_id,
# 								iws.i_class_id,
# 								iws.i_category_id
# 							FROM
# 								web_sales,
# 								item AS iws,
# 								date_dim AS d3
# 							WHERE
# 								ws_item_sk = iws.i_item_sk
# 								AND ws_sold_date_sk
# 									= d3.d_date_sk
# 								AND d3.d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 				WHERE
# 					i_brand_id = brand_id
# 					AND i_class_id = class_id
# 					AND i_category_id = category_id
# 			),
# 		avg_sales
# 			AS (
# 				SELECT
# 					avg(quantity * list_price) AS average_sales
# 				FROM
# 					(
# 						SELECT
# 							ss_quantity AS quantity,
# 							ss_list_price AS list_price
# 						FROM
# 							store_sales, date_dim
# 						WHERE
# 							ss_sold_date_sk = d_date_sk
# 							AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								cs_quantity AS quantity,
# 								cs_list_price AS list_price
# 							FROM
# 								catalog_sales, date_dim
# 							WHERE
# 								cs_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								ws_quantity AS quantity,
# 								ws_list_price AS list_price
# 							FROM
# 								web_sales, date_dim
# 							WHERE
# 								ws_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 			)
# 	SELECT
# 		this_year.channel AS ty_channel,
# 		this_year.i_brand_id AS ty_brand,
# 		this_year.i_class_id AS ty_class,
# 		this_year.i_category_id AS ty_category,
# 		this_year.sales AS ty_sales,
# 		this_year.number_sales AS ty_number_sales,
# 		last_year.channel AS ly_channel,
# 		last_year.i_brand_id AS ly_brand,
# 		last_year.i_class_id AS ly_class,
# 		last_year.i_category_id AS ly_category,
# 		last_year.sales AS ly_sales,
# 		last_year.number_sales AS ly_number_sales
# 	FROM
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_week_seq
# 					= (
# 							SELECT
# 								d_week_seq
# 							FROM
# 								date_dim
# 							WHERE
# 								d_year = 1999 + 1
# 								AND d_moy = 12
# 								AND d_dom = 3
# 						)
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS this_year,
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_week_seq
# 					= (
# 							SELECT
# 								d_week_seq
# 							FROM
# 								date_dim
# 							WHERE
# 								d_year = 1999
# 								AND d_moy = 12
# 								AND d_dom = 3
# 						)
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS last_year
# 	WHERE
# 		this_year.i_brand_id = last_year.i_brand_id
# 		AND this_year.i_class_id = last_year.i_class_id
# 		AND this_year.i_category_id = last_year.i_category_id
# 	ORDER BY
# 		this_year.channel,
# 		this_year.i_brand_id,
# 		this_year.i_class_id,
# 		this_year.i_category_id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q15
opt
	SELECT
		ca_zip, sum(cs_sales_price)
	FROM
		catalog_sales, customer, customer_address, date_dim
	WHERE
		cs_bill_customer_sk = c_customer_sk
		AND c_current_addr_sk = ca_address_sk
		AND (
				substr(ca_zip, 1, 5)
				IN (
						'85669',
						'86197',
						'88274',
						'83405',
						'86475',
						'85392',
						'85460',
						'80348',
						'81792'
					)
				OR ca_state IN ('CA', 'WA', 'GA')
				OR cs_sales_price > 500
			)
		AND cs_sold_date_sk = d_date_sk
		AND d_qoy = 2
		AND d_year = 2001
	GROUP BY
		ca_zip
	ORDER BY
		ca_zip
	LIMIT
		100;
----
top-k
 ├── columns: ca_zip:66 sum:102
 ├── internal-ordering: +66
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (66)
 ├── fd: (66)-->(102)
 ├── ordering: +66
 └── group-by (hash)
      ├── columns: ca_zip:66 sum:102
      ├── grouping columns: ca_zip:66
      ├── immutable
      ├── key: (66)
      ├── fd: (66)-->(102)
      ├── inner-join (hash)
      │    ├── columns: cs_sold_date_sk:1!null cs_bill_customer_sk:4!null cs_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_state:65 ca_zip:66 d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── immutable
      │    ├── fd: ()-->(78,82), (37)-->(41), (57)-->(65,66), (41)==(57), (57)==(41), (4)==(37), (37)==(4), (1)==(72), (72)==(1)
      │    ├── inner-join (hash)
      │    │    ├── columns: cs_sold_date_sk:1!null cs_bill_customer_sk:4 cs_sales_price:22 d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(78,82), (1)==(72), (72)==(1)
      │    │    ├── scan catalog_sales
      │    │    │    └── columns: cs_sold_date_sk:1 cs_bill_customer_sk:4 cs_sales_price:22
      │    │    ├── select
      │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    │    ├── key: (72)
      │    │    │    ├── fd: ()-->(78,82)
      │    │    │    ├── scan date_dim
      │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_qoy:82
      │    │    │    │    ├── key: (72)
      │    │    │    │    └── fd: (72)-->(78,82)
      │    │    │    └── filters
      │    │    │         ├── d_qoy:82 = 2 [outer=(82), constraints=(/82: [/2 - /2]; tight), fd=()-->(82)]
      │    │    │         └── d_year:78 = 2001 [outer=(78), constraints=(/78: [/2001 - /2001]; tight), fd=()-->(78)]
      │    │    └── filters
      │    │         └── cs_sold_date_sk:1 = d_date_sk:72 [outer=(1,72), constraints=(/1: (/NULL - ]; /72: (/NULL - ]), fd=(1)==(72), (72)==(1)]
      │    ├── inner-join (hash)
      │    │    ├── columns: c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_state:65 ca_zip:66
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── key: (37)
      │    │    ├── fd: (37)-->(41), (57)-->(65,66), (41)==(57), (57)==(41)
      │    │    ├── scan customer
      │    │    │    ├── columns: c_customer_sk:37!null c_current_addr_sk:41
      │    │    │    ├── key: (37)
      │    │    │    └── fd: (37)-->(41)
      │    │    ├── scan customer_address
      │    │    │    ├── columns: ca_address_sk:57!null ca_state:65 ca_zip:66
      │    │    │    ├── key: (57)
      │    │    │    └── fd: (57)-->(65,66)
      │    │    └── filters
      │    │         └── c_current_addr_sk:41 = ca_address_sk:57 [outer=(41,57), constraints=(/41: (/NULL - ]; /57: (/NULL - ]), fd=(41)==(57), (57)==(41)]
      │    └── filters
      │         ├── cs_bill_customer_sk:4 = c_customer_sk:37 [outer=(4,37), constraints=(/4: (/NULL - ]; /37: (/NULL - ]), fd=(4)==(37), (37)==(4)]
      │         └── ((substr(ca_zip:66, 1, 5) IN ('80348', '81792', '83405', '85392', '85460', '85669', '86197', '86475', '88274')) OR (ca_state:65 IN ('CA', 'GA', 'WA'))) OR (cs_sales_price:22 > 500) [outer=(22,65,66), immutable]
      └── aggregations
           └── sum [as=sum:102, outer=(22)]
                └── cs_sales_price:22

# --------------------------------------------------
# Q16
# NOTE: Added conversion of 60 days to an interval.
opt
	SELECT
		count(DISTINCT cs_order_number) AS "order count",
		sum(cs_ext_ship_cost) AS "total shipping cost",
		sum(cs_net_profit) AS "total net profit"
	FROM
		catalog_sales AS cs1,
		date_dim,
		customer_address,
		call_center
	WHERE
		d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + '60 days'::INTERVAL)
		AND cs1.cs_ship_date_sk = d_date_sk
		AND cs1.cs_ship_addr_sk = ca_address_sk
		AND ca_state = 'PA'
		AND cs1.cs_call_center_sk = cc_call_center_sk
		AND cc_county
			IN (
					'Williamson County',
					'Williamson County',
					'Williamson County',
					'Williamson County',
					'Williamson County'
				)
		AND EXISTS(
				SELECT
					*
				FROM
					catalog_sales AS cs2
				WHERE
					cs1.cs_order_number = cs2.cs_order_number
					AND cs1.cs_warehouse_sk
						!= cs2.cs_warehouse_sk
			)
		AND NOT
				EXISTS(
					SELECT
						*
					FROM
						catalog_returns AS cr1
					WHERE
						cs1.cs_order_number
						= cr1.cr_order_number
				)
	ORDER BY
		count(DISTINCT cs_order_number)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: "order count":182!null "total shipping cost":183 "total net profit":184
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(182-184)
 ├── semi-join (hash)
 │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11!null cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null cc_call_center_sk:82!null cc_county:107!null
 │    ├── fd: ()-->(75,107), (37)-->(39), (3)==(37), (37)==(3), (11)==(67), (67)==(11), (12)==(82), (82)==(12)
 │    ├── inner-join (lookup customer_address)
 │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11!null cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null cc_call_center_sk:82!null cc_county:107!null
 │    │    ├── key columns: [11] = [67]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(75,107), (37)-->(39), (12)==(82), (82)==(12), (11)==(67), (67)==(11), (3)==(37), (37)==(3)
 │    │    ├── anti-join (hash)
 │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null cc_call_center_sk:82!null cc_county:107!null
 │    │    │    ├── fd: ()-->(107), (37)-->(39), (12)==(82), (82)==(12), (3)==(37), (37)==(3)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null cc_call_center_sk:82!null cc_county:107!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(107), (37)-->(39), (12)==(82), (82)==(12), (3)==(37), (37)==(3)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12 cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (37)-->(39), (3)==(37), (37)==(3)
 │    │    │    │    │    ├── scan catalog_sales [as=cs1]
 │    │    │    │    │    │    └── columns: cs1.cs_ship_date_sk:3 cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12 cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39!null
 │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    ├── fd: (37)-->(39)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39
 │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    └── fd: (37)-->(39)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (d_date:39 >= '2002-04-01') AND (d_date:39 <= '2002-05-31') [outer=(39), constraints=(/39: [/'2002-04-01' - /'2002-05-31']; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── cs1.cs_ship_date_sk:3 = d_date_sk:37 [outer=(3,37), constraints=(/3: (/NULL - ]; /37: (/NULL - ]), fd=(3)==(37), (37)==(3)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: cc_call_center_sk:82!null cc_county:107!null
 │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    ├── fd: ()-->(107)
 │    │    │    │    │    ├── scan call_center
 │    │    │    │    │    │    ├── columns: cc_call_center_sk:82!null cc_county:107
 │    │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    │    └── fd: (82)-->(107)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── cc_county:107 = 'Williamson County' [outer=(107), constraints=(/107: [/'Williamson County' - /'Williamson County']; tight), fd=()-->(107)]
 │    │    │    │    └── filters
 │    │    │    │         └── cs1.cs_call_center_sk:12 = cc_call_center_sk:82 [outer=(12,82), constraints=(/12: (/NULL - ]; /82: (/NULL - ]), fd=(12)==(82), (82)==(12)]
 │    │    │    ├── scan catalog_returns [as=cr1]
 │    │    │    │    └── columns: cr_order_number:167!null
 │    │    │    └── filters
 │    │    │         └── cs1.cs_order_number:18 = cr_order_number:167 [outer=(18,167), constraints=(/18: (/NULL - ]; /167: (/NULL - ]), fd=(18)==(167), (167)==(18)]
 │    │    └── filters
 │    │         └── ca_state:75 = 'PA' [outer=(75), constraints=(/75: [/'PA' - /'PA']; tight), fd=()-->(75)]
 │    ├── scan catalog_sales [as=cs2]
 │    │    └── columns: cs2.cs_warehouse_sk:129 cs2.cs_order_number:132!null
 │    └── filters
 │         ├── cs1.cs_order_number:18 = cs2.cs_order_number:132 [outer=(18,132), constraints=(/18: (/NULL - ]; /132: (/NULL - ]), fd=(18)==(132), (132)==(18)]
 │         └── cs1.cs_warehouse_sk:15 != cs2.cs_warehouse_sk:129 [outer=(15,129), constraints=(/15: (/NULL - ]; /129: (/NULL - ])]
 └── aggregations
      ├── agg-distinct [as=count:182, outer=(18)]
      │    └── count
      │         └── cs1.cs_order_number:18
      ├── sum [as=sum:183, outer=(29)]
      │    └── cs1.cs_ext_ship_cost:29
      └── sum [as=sum:184, outer=(34)]
           └── cs1.cs_net_profit:34

# --------------------------------------------------
# Q17
opt
	SELECT
		i_item_id,
		i_item_desc,
		s_state,
		count(ss_quantity) AS store_sales_quantitycount,
		avg(ss_quantity) AS store_sales_quantityave,
		stddev_samp(ss_quantity) AS store_sales_quantitystdev,
		stddev_samp(ss_quantity) / avg(ss_quantity)
			AS store_sales_quantitycov,
		count(sr_return_quantity)
			AS store_returns_quantitycount,
		avg(sr_return_quantity) AS store_returns_quantityave,
		stddev_samp(sr_return_quantity)
			AS store_returns_quantitystdev,
		stddev_samp(sr_return_quantity)
		/ avg(sr_return_quantity)
			AS store_returns_quantitycov,
		count(cs_quantity) AS catalog_sales_quantitycount,
		avg(cs_quantity) AS catalog_sales_quantityave,
		stddev_samp(cs_quantity) AS catalog_sales_quantitystdev,
		stddev_samp(cs_quantity) / avg(cs_quantity)
			AS catalog_sales_quantitycov
	FROM
		store_sales,
		store_returns,
		catalog_sales,
		date_dim AS d1,
		date_dim AS d2,
		date_dim AS d3,
		store,
		item
	WHERE
		d1.d_quarter_name = '2001Q1'
		AND d1.d_date_sk = ss_sold_date_sk
		AND i_item_sk = ss_item_sk
		AND s_store_sk = ss_store_sk
		AND ss_customer_sk = sr_customer_sk
		AND ss_item_sk = sr_item_sk
		AND ss_ticket_number = sr_ticket_number
		AND sr_returned_date_sk = d2.d_date_sk
		AND d2.d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')
		AND sr_customer_sk = cs_bill_customer_sk
		AND sr_item_sk = cs_item_sk
		AND cs_sold_date_sk = d3.d_date_sk
		AND d3.d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')
	GROUP BY
		i_item_id, i_item_desc, s_state
	ORDER BY
		i_item_id, i_item_desc, s_state
	LIMIT
		100;
----
project
 ├── columns: i_item_id:206!null i_item_desc:209 s_state:198 store_sales_quantitycount:229!null store_sales_quantityave:230 store_sales_quantitystdev:231 store_sales_quantitycov:238 store_returns_quantitycount:232!null store_returns_quantityave:233 store_returns_quantitystdev:234 store_returns_quantitycov:239 catalog_sales_quantitycount:235!null catalog_sales_quantityave:236 catalog_sales_quantitystdev:237 catalog_sales_quantitycov:240
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (198,206,209)
 ├── fd: (198,206,209)-->(229-237), (230,231)-->(238), (233,234)-->(239), (236,237)-->(240)
 ├── ordering: +206,+209,+198
 ├── top-k
 │    ├── columns: s_state:198 i_item_id:206!null i_item_desc:209 count:229!null avg:230 stddev_samp:231 count:232!null avg:233 stddev_samp:234 count:235!null avg:236 stddev_samp:237
 │    ├── internal-ordering: +206,+209,+198
 │    ├── k: 100
 │    ├── cardinality: [0 - 100]
 │    ├── key: (198,206,209)
 │    ├── fd: (198,206,209)-->(229-237)
 │    ├── ordering: +206,+209,+198
 │    └── group-by (hash)
 │         ├── columns: s_state:198 i_item_id:206!null i_item_desc:209 count:229!null avg:230 stddev_samp:231 count:232!null avg:233 stddev_samp:234 count:235!null avg:236 stddev_samp:237
 │         ├── grouping columns: s_state:198 i_item_id:206!null i_item_desc:209
 │         ├── key: (198,206,209)
 │         ├── fd: (198,206,209)-->(229-237)
 │         ├── inner-join (lookup date_dim [as=d3])
 │         │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null d3.d_date_sk:144!null d3.d_quarter_name:159!null s_store_sk:174!null s_state:198 i_item_sk:205!null i_item_id:206!null i_item_desc:209
 │         │    ├── key columns: [48] = [144]
 │         │    ├── lookup columns are key
 │         │    ├── fd: ()-->(99), (3,10)-->(1,4,8,11), (174)-->(198), (28,35)-->(26,29,36), (144)-->(159), (205)-->(206,209), (114)-->(129), (8)==(174), (174)==(8), (48)==(144), (144)==(48), (3)==(28,63,205), (28)==(3,63,205), (63)==(3,28,205), (205)==(3,28,63), (4)==(29,51), (29)==(4,51), (51)==(4,29), (26)==(114), (114)==(26), (10)==(35), (35)==(10), (1)==(84), (84)==(1)
 │         │    ├── inner-join (lookup item)
 │         │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48 cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198 i_item_sk:205!null i_item_id:206!null i_item_desc:209
 │         │    │    ├── key columns: [63] = [205]
 │         │    │    ├── lookup columns are key
 │         │    │    ├── fd: ()-->(99), (174)-->(198), (205)-->(206,209), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63,205), (28)==(3,63,205), (63)==(3,28,205), (205)==(3,28,63), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
 │         │    │    ├── inner-join (lookup catalog_sales)
 │         │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48 cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    ├── key columns: [28] = [63]
 │         │    │    │    ├── fd: ()-->(99), (174)-->(198), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
 │         │    │    │    ├── inner-join (lookup date_dim [as=d1])
 │         │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    │    ├── key columns: [1] = [84]
 │         │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    ├── fd: ()-->(99), (174)-->(198), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
 │         │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    ├── fd: (174)-->(198), (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (8)==(174), (174)==(8)
 │         │    │    │    │    │    ├── inner-join (lookup store_sales)
 │         │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8 ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
 │         │    │    │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    ├── fd: (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10)
 │         │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    │    ├── fd: (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26)
 │         │    │    │    │    │    │    │    ├── scan store_returns
 │         │    │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26 sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36
 │         │    │    │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    │    │    └── fd: (28,35)-->(26,29,36)
 │         │    │    │    │    │    │    │    ├── select
 │         │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    │    │    ├── key: (114)
 │         │    │    │    │    │    │    │    │    ├── fd: (114)-->(129)
 │         │    │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
 │         │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_quarter_name:129
 │         │    │    │    │    │    │    │    │    │    ├── key: (114)
 │         │    │    │    │    │    │    │    │    │    └── fd: (114)-->(129)
 │         │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │         └── d2.d_quarter_name:129 IN ('2001Q1', '2001Q2', '2001Q3') [outer=(129), constraints=(/129: [/'2001Q1' - /'2001Q1'] [/'2001Q2' - /'2001Q2'] [/'2001Q3' - /'2001Q3']; tight)]
 │         │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │         └── sr_returned_date_sk:26 = d2.d_date_sk:114 [outer=(26,114), constraints=(/26: (/NULL - ]; /114: (/NULL - ]), fd=(26)==(114), (114)==(26)]
 │         │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │         └── ss_customer_sk:4 = sr_customer_sk:29 [outer=(4,29), constraints=(/4: (/NULL - ]; /29: (/NULL - ]), fd=(4)==(29), (29)==(4)]
 │         │    │    │    │    │    ├── scan store
 │         │    │    │    │    │    │    ├── columns: s_store_sk:174!null s_state:198
 │         │    │    │    │    │    │    ├── key: (174)
 │         │    │    │    │    │    │    └── fd: (174)-->(198)
 │         │    │    │    │    │    └── filters
 │         │    │    │    │    │         └── s_store_sk:174 = ss_store_sk:8 [outer=(8,174), constraints=(/8: (/NULL - ]; /174: (/NULL - ]), fd=(8)==(174), (174)==(8)]
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── d1.d_quarter_name:99 = '2001Q1' [outer=(99), constraints=(/99: [/'2001Q1' - /'2001Q1']; tight), fd=()-->(99)]
 │         │    │    │    └── filters
 │         │    │    │         └── sr_customer_sk:29 = cs_bill_customer_sk:51 [outer=(29,51), constraints=(/29: (/NULL - ]; /51: (/NULL - ]), fd=(29)==(51), (51)==(29)]
 │         │    │    └── filters (true)
 │         │    └── filters
 │         │         └── d3.d_quarter_name:159 IN ('2001Q1', '2001Q2', '2001Q3') [outer=(159), constraints=(/159: [/'2001Q1' - /'2001Q1'] [/'2001Q2' - /'2001Q2'] [/'2001Q3' - /'2001Q3']; tight)]
 │         └── aggregations
 │              ├── count [as=count:229, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── avg [as=avg:230, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── std-dev [as=stddev_samp:231, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── count [as=count:232, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── avg [as=avg:233, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── std-dev [as=stddev_samp:234, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── count [as=count:235, outer=(66)]
 │              │    └── cs_quantity:66
 │              ├── avg [as=avg:236, outer=(66)]
 │              │    └── cs_quantity:66
 │              └── std-dev [as=stddev_samp:237, outer=(66)]
 │                   └── cs_quantity:66
 └── projections
      ├── stddev_samp:231 / avg:230 [as=store_sales_quantitycov:238, outer=(230,231), immutable]
      ├── stddev_samp:234 / avg:233 [as=store_returns_quantitycov:239, outer=(233,234), immutable]
      └── stddev_samp:237 / avg:236 [as=catalog_sales_quantitycov:240, outer=(236,237), immutable]

# --------------------------------------------------
# Q18
# TODO(#46280): adjust the query to work with CRDB.
# opt
# 	SELECT
# 		i_item_id,
# 		ca_country,
# 		ca_state,
# 		ca_county,
# 		avg(CAST(cs_quantity AS DECIMAL(12,2))) AS agg1,
# 		avg(CAST(cs_list_price AS DECIMAL(12,2))) AS agg2,
# 		avg(CAST(cs_coupon_amt AS DECIMAL(12,2))) AS agg3,
# 		avg(CAST(cs_sales_price AS DECIMAL(12,2))) AS agg4,
# 		avg(CAST(cs_net_profit AS DECIMAL(12,2))) AS agg5,
# 		avg(CAST(c_birth_year AS DECIMAL(12,2))) AS agg6,
# 		avg(CAST(cd1.cd_dep_count AS DECIMAL(12,2))) AS agg7
# 	FROM
# 		catalog_sales,
# 		customer_demographics AS cd1,
# 		customer_demographics AS cd2,
# 		customer,
# 		customer_address,
# 		date_dim,
# 		item
# 	WHERE
# 		cs_sold_date_sk = d_date_sk
# 		AND cs_item_sk = i_item_sk
# 		AND cs_bill_cdemo_sk = cd1.cd_demo_sk
# 		AND cs_bill_customer_sk = c_customer_sk
# 		AND cd1.cd_gender = 'F'
# 		AND cd1.cd_education_status = 'Primary'
# 		AND c_current_cdemo_sk = cd2.cd_demo_sk
# 		AND c_current_addr_sk = ca_address_sk
# 		AND c_birth_month IN (1, 3, 7, 11, 10, 4)
# 		AND d_year = 2001
# 		AND ca_state
# 			IN ('AL', 'MO', 'TN', 'GA', 'MT', 'IN', 'CA')
# 	GROUP BY
# 		rollup(i_item_id, ca_country, ca_state, ca_county)
# 	ORDER BY
# 		ca_country, ca_state, ca_county, i_item_id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q19
opt
	SELECT
		i_brand_id AS brand_id,
		i_brand AS brand,
		i_manufact_id,
		i_manufact,
		sum(ss_ext_sales_price) AS ext_price
	FROM
		date_dim,
		store_sales,
		item,
		customer,
		customer_address,
		store
	WHERE
		d_date_sk = ss_sold_date_sk
		AND ss_item_sk = i_item_sk
		AND i_manager_id = 14
		AND d_moy = 11
		AND d_year = 2002
		AND ss_customer_sk = c_customer_sk
		AND c_current_addr_sk = ca_address_sk
		AND substr(ca_zip, 1, 5) != substr(s_zip, 1, 5)
		AND ss_store_sk = s_store_sk
	GROUP BY
		i_brand, i_brand_id, i_manufact_id, i_manufact
	ORDER BY
		ext_price DESC,
		i_brand,
		i_brand_id,
		i_manufact_id,
		i_manufact
	LIMIT
		100;
----
top-k
 ├── columns: brand_id:63 brand:64 i_manufact_id:69 i_manufact:70 ext_price:146
 ├── internal-ordering: -146,+64,+63,+69,+70
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (63,64,69,70)
 ├── fd: (63,64,69,70)-->(146)
 ├── ordering: -146,+64,+63,+69,+70
 └── group-by (hash)
      ├── columns: i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 sum:146
      ├── grouping columns: i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70
      ├── immutable
      ├── key: (63,64,69,70)
      ├── fd: (63,64,69,70)-->(146)
      ├── inner-join (lookup customer_address)
      │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34!null ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null c_customer_sk:80!null c_current_addr_sk:84!null ca_address_sk:100!null ca_zip:109 s_store_sk:115!null s_zip:140
      │    ├── key columns: [84] = [100]
      │    ├── lookup columns are key
      │    ├── immutable
      │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (80)-->(84), (100)-->(109), (115)-->(140), (33)==(56), (56)==(33), (84)==(100), (100)==(84), (34)==(80), (80)==(34), (38)==(115), (115)==(38), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup customer)
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34!null ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null c_customer_sk:80!null c_current_addr_sk:84 s_store_sk:115!null s_zip:140
      │    │    ├── key columns: [34] = [80]
      │    │    ├── lookup columns are key
      │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (80)-->(84), (115)-->(140), (38)==(115), (115)==(38), (34)==(80), (80)==(34), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null s_store_sk:115!null s_zip:140
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (115)-->(140), (38)==(115), (115)==(38), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38 ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38 ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    │    ├── key columns: [56] = [33]
      │    │    │    │    │    ├── fd: ()-->(76), (56)-->(63,64,69,70), (33)==(56), (56)==(33)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    ├── fd: ()-->(76), (56)-->(63,64,69,70)
      │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76
      │    │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    │    └── fd: (56)-->(63,64,69,70,76)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── i_manager_id:76 = 14 [outer=(76), constraints=(/76: [/14 - /14]; tight), fd=()-->(76)]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null
      │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    ├── fd: ()-->(7,9)
      │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    └── fd: (1)-->(7,9)
      │    │    │    │    │    └── filters
      │    │    │    │    │         ├── d_moy:9 = 11 [outer=(9), constraints=(/9: [/11 - /11]; tight), fd=()-->(9)]
      │    │    │    │    │         └── d_year:7 = 2002 [outer=(7), constraints=(/7: [/2002 - /2002]; tight), fd=()-->(7)]
      │    │    │    │    └── filters
      │    │    │    │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      │    │    │    ├── scan store
      │    │    │    │    ├── columns: s_store_sk:115!null s_zip:140
      │    │    │    │    ├── key: (115)
      │    │    │    │    └── fd: (115)-->(140)
      │    │    │    └── filters
      │    │    │         └── ss_store_sk:38 = s_store_sk:115 [outer=(38,115), constraints=(/38: (/NULL - ]; /115: (/NULL - ]), fd=(38)==(115), (115)==(38)]
      │    │    └── filters (true)
      │    └── filters
      │         └── substr(ca_zip:109, 1, 5) != substr(s_zip:140, 1, 5) [outer=(109,140), immutable]
      └── aggregations
           └── sum [as=sum:146, outer=(46)]
                └── ss_ext_sales_price:46

# --------------------------------------------------
# Q20
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
	    i_item_id,
	    i_item_desc,
	    i_category,
	    i_class,
	    i_current_price,
	    sum(cs_ext_sales_price) AS itemrevenue,
	    sum(cs_ext_sales_price) * 100
	    / sum(sum(cs_ext_sales_price)) OVER (
	            PARTITION BY i_class
	        )
	        AS revenueratio
	FROM
	    catalog_sales, item, date_dim
	WHERE
	    cs_item_sk = i_item_sk
	    AND i_category IN ('Books', 'Music', 'Sports')
	    AND cs_sold_date_sk = d_date_sk
	    AND d_date BETWEEN CAST('2002-06-18' AS DATE) AND (CAST('2002-06-18' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
	    i_item_id,
	    i_item_desc,
	    i_category,
	    i_class,
	    i_current_price
	ORDER BY
	    i_category,
	    i_class,
	    i_item_id,
	    i_item_desc,
	    revenueratio
	LIMIT
	    100;
----
top-k
 ├── columns: i_item_id:38!null i_item_desc:41 i_category:49!null i_class:47 i_current_price:42 itemrevenue:91 revenueratio:93
 ├── internal-ordering: +49,+47,+38,+41,+93
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (38,41,42,47,49)
 ├── fd: (38,41,42,47,49)-->(91,93)
 ├── ordering: +49,+47,+38,+41,+93
 └── project
      ├── columns: revenueratio:93 i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      ├── immutable
      ├── key: (38,41,42,47,49)
      ├── fd: (38,41,42,47,49)-->(91,93)
      ├── window partition=(47)
      │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91 sum:92
      │    ├── key: (38,41,42,47,49)
      │    ├── fd: (38,41,42,47,49)-->(91,92)
      │    ├── group-by (hash)
      │    │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      │    │    ├── grouping columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    ├── key: (38,41,42,47,49)
      │    │    ├── fd: (38,41,42,47,49)-->(91)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: cs_sold_date_sk:1!null cs_item_sk:16!null cs_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null d_date_sk:61!null d_date:63!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(38,41,42,47,49), (61)-->(63), (16)==(37), (37)==(16), (1)==(61), (61)==(1)
      │    │    │    ├── inner-join (lookup catalog_sales)
      │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_item_sk:16!null cs_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    ├── key columns: [37] = [16]
      │    │    │    │    ├── fd: (37)-->(38,41,42,47,49), (16)==(37), (37)==(16)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    ├── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49
      │    │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    │    └── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── i_category:49 IN ('Books', 'Music', 'Sports') [outer=(49), constraints=(/49: [/'Books' - /'Books'] [/'Music' - /'Music'] [/'Sports' - /'Sports']; tight)]
      │    │    │    │    └── filters (true)
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
      │    │    │    │    ├── key: (61)
      │    │    │    │    ├── fd: (61)-->(63)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
      │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    └── fd: (61)-->(63)
      │    │    │    │    └── filters
      │    │    │    │         └── (d_date:63 >= '2002-06-18') AND (d_date:63 <= '2002-07-18') [outer=(63), constraints=(/63: [/'2002-06-18' - /'2002-07-18']; tight)]
      │    │    │    └── filters
      │    │    │         └── cs_sold_date_sk:1 = d_date_sk:61 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
      │    │    └── aggregations
      │    │         └── sum [as=sum:91, outer=(24)]
      │    │              └── cs_ext_sales_price:24
      │    └── windows
      │         └── sum [as=sum:92, outer=(91)]
      │              └── sum:91
      └── projections
           └── (sum:91 * 100) / sum:92 [as=revenueratio:93, outer=(91,92), immutable]
