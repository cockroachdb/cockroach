import file=tpcds_schema
----

import file=tpcds_stats
----

# --------------------------------------------------
# Q1
opt
	WITH
	    customer_total_return
	        AS (
	            SELECT
	                sr_customer_sk AS ctr_customer_sk,
	                sr_store_sk AS ctr_store_sk,
	                sum(sr_fee) AS ctr_total_return
	            FROM
	                store_returns, date_dim
	            WHERE
	                sr_returned_date_sk = d_date_sk
	                AND d_year = 2000
	            GROUP BY
	                sr_customer_sk, sr_store_sk
	        )
	SELECT
	    c_customer_id
	FROM
	    customer_total_return AS ctr1, store, customer
	WHERE
	    ctr1.ctr_total_return
	    > (
	            SELECT
	                avg(ctr_total_return) * 1.2
	            FROM
	                customer_total_return AS ctr2
	            WHERE
	                ctr1.ctr_store_sk = ctr2.ctr_store_sk
	        )
	    AND s_store_sk = ctr1.ctr_store_sk
	    AND s_state = 'TN'
	    AND ctr1.ctr_customer_sk = c_customer_sk
	ORDER BY
	    c_customer_id
	LIMIT
	    100;
----
with &1 (customer_total_return)
 ├── columns: c_customer_id:89!null
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +89
 ├── group-by (hash)
 │    ├── columns: sr_customer_sk:4 sr_store_sk:8 sum:53
 │    ├── grouping columns: sr_customer_sk:4 sr_store_sk:8
 │    ├── key: (4,8)
 │    ├── fd: (4,8)-->(53)
 │    ├── inner-join (hash)
 │    │    ├── columns: sr_returned_date_sk:1!null sr_customer_sk:4 sr_store_sk:8 sr_fee:15 d_date_sk:23!null d_year:29!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── fd: ()-->(29), (1)==(23), (23)==(1)
 │    │    ├── scan store_returns
 │    │    │    └── columns: sr_returned_date_sk:1 sr_customer_sk:4 sr_store_sk:8 sr_fee:15
 │    │    ├── select
 │    │    │    ├── columns: d_date_sk:23!null d_year:29!null
 │    │    │    ├── key: (23)
 │    │    │    ├── fd: ()-->(29)
 │    │    │    ├── scan date_dim
 │    │    │    │    ├── columns: d_date_sk:23!null d_year:29
 │    │    │    │    ├── key: (23)
 │    │    │    │    └── fd: (23)-->(29)
 │    │    │    └── filters
 │    │    │         └── d_year:29 = 2000 [outer=(29), constraints=(/29: [/2000 - /2000]; tight), fd=()-->(29)]
 │    │    └── filters
 │    │         └── sr_returned_date_sk:1 = d_date_sk:23 [outer=(1,23), constraints=(/1: (/NULL - ]; /23: (/NULL - ]), fd=(1)==(23), (23)==(1)]
 │    └── aggregations
 │         └── sum [as=sum:53, outer=(15)]
 │              └── sr_fee:15
 └── project
      ├── columns: c_customer_id:89!null
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +89
      └── top-k
           ├── columns: ctr_customer_sk:54!null ctr_store_sk:55!null ctr_total_return:56!null s_store_sk:57!null s_state:81!null c_customer_sk:88!null c_customer_id:89!null avg:111!null
           ├── internal-ordering: +89 opt(81)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── key: (57,88)
           ├── fd: ()-->(81), (54,55)-->(56,111), (88)-->(89), (55)==(57), (57)==(55), (54)==(88), (88)==(54)
           ├── ordering: +89 opt(81) [actual: +89]
           └── inner-join (lookup customer)
                ├── columns: ctr_customer_sk:54!null ctr_store_sk:55!null ctr_total_return:56!null s_store_sk:57!null s_state:81!null c_customer_sk:88!null c_customer_id:89!null avg:111!null
                ├── key columns: [54] = [88]
                ├── lookup columns are key
                ├── immutable
                ├── key: (57,88)
                ├── fd: ()-->(81), (54,55)-->(56,111), (88)-->(89), (55)==(57), (57)==(55), (54)==(88), (88)==(54)
                ├── inner-join (hash)
                │    ├── columns: ctr_customer_sk:54 ctr_store_sk:55!null ctr_total_return:56!null s_store_sk:57!null s_state:81!null avg:111!null
                │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                │    ├── immutable
                │    ├── key: (54,57)
                │    ├── fd: ()-->(81), (54,55)-->(56,111), (55)==(57), (57)==(55)
                │    ├── select
                │    │    ├── columns: ctr_customer_sk:54 ctr_store_sk:55!null ctr_total_return:56!null avg:111!null
                │    │    ├── immutable
                │    │    ├── key: (54,55)
                │    │    ├── fd: (54,55)-->(56,111)
                │    │    ├── group-by (hash)
                │    │    │    ├── columns: ctr_customer_sk:54 ctr_store_sk:55!null ctr_total_return:56 avg:111!null
                │    │    │    ├── grouping columns: ctr_customer_sk:54 ctr_store_sk:55!null
                │    │    │    ├── immutable
                │    │    │    ├── key: (54,55)
                │    │    │    ├── fd: (54,55)-->(56,111)
                │    │    │    ├── inner-join (hash)
                │    │    │    │    ├── columns: ctr_customer_sk:54 ctr_store_sk:55!null ctr_total_return:56 ctr_store_sk:109!null ctr_total_return:110!null
                │    │    │    │    ├── immutable
                │    │    │    │    ├── fd: (54,55)-->(56), (55)==(109), (109)==(55)
                │    │    │    │    ├── with-scan &1 (customer_total_return)
                │    │    │    │    │    ├── columns: ctr_customer_sk:54 ctr_store_sk:55 ctr_total_return:56
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  sr_customer_sk:4 => ctr_customer_sk:54
                │    │    │    │    │    │    ├──  sr_store_sk:8 => ctr_store_sk:55
                │    │    │    │    │    │    └──  sum:53 => ctr_total_return:56
                │    │    │    │    │    ├── key: (54,55)
                │    │    │    │    │    └── fd: (54,55)-->(56)
                │    │    │    │    ├── select
                │    │    │    │    │    ├── columns: ctr_store_sk:109 ctr_total_return:110!null
                │    │    │    │    │    ├── immutable
                │    │    │    │    │    ├── with-scan &1 (customer_total_return)
                │    │    │    │    │    │    ├── columns: ctr_store_sk:109 ctr_total_return:110
                │    │    │    │    │    │    └── mapping:
                │    │    │    │    │    │         ├──  sr_store_sk:8 => ctr_store_sk:109
                │    │    │    │    │    │         └──  sum:53 => ctr_total_return:110
                │    │    │    │    │    └── filters
                │    │    │    │    │         └── ctr_total_return:110 IS NOT NULL [outer=(110), immutable, constraints=(/110: (/NULL - ]; tight)]
                │    │    │    │    └── filters
                │    │    │    │         └── ctr_store_sk:55 = ctr_store_sk:109 [outer=(55,109), constraints=(/55: (/NULL - ]; /109: (/NULL - ]), fd=(55)==(109), (109)==(55)]
                │    │    │    └── aggregations
                │    │    │         ├── avg [as=avg:111, outer=(110)]
                │    │    │         │    └── ctr_total_return:110
                │    │    │         └── const-agg [as=ctr_total_return:56, outer=(56)]
                │    │    │              └── ctr_total_return:56
                │    │    └── filters
                │    │         └── ctr_total_return:56 > (avg:111 * 1.2) [outer=(56,111), immutable, constraints=(/56: (/NULL - ])]
                │    ├── select
                │    │    ├── columns: s_store_sk:57!null s_state:81!null
                │    │    ├── key: (57)
                │    │    ├── fd: ()-->(81)
                │    │    ├── scan store
                │    │    │    ├── columns: s_store_sk:57!null s_state:81
                │    │    │    ├── key: (57)
                │    │    │    └── fd: (57)-->(81)
                │    │    └── filters
                │    │         └── s_state:81 = 'TN' [outer=(81), constraints=(/81: [/'TN' - /'TN']; tight), fd=()-->(81)]
                │    └── filters
                │         └── s_store_sk:57 = ctr_store_sk:55 [outer=(55,57), constraints=(/55: (/NULL - ]; /57: (/NULL - ]), fd=(55)==(57), (57)==(55)]
                └── filters (true)

# --------------------------------------------------
# Q2
opt
	WITH
		wscs
			AS (
				SELECT
					sold_date_sk, sales_price
				FROM
					(
						SELECT
							ws_sold_date_sk AS sold_date_sk,
							ws_ext_sales_price AS sales_price
						FROM
							web_sales
						UNION ALL
							SELECT
								cs_sold_date_sk AS sold_date_sk,
								cs_ext_sales_price
									AS sales_price
							FROM
								catalog_sales
					)
			),
		wswscs
			AS (
				SELECT
					d_week_seq,
					sum(
						CASE
						WHEN (d_day_name = 'Sunday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS sun_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Monday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS mon_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Tuesday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS tue_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Wednesday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS wed_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Thursday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS thu_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Friday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS fri_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Saturday')
						THEN sales_price
						ELSE NULL
						END
					)
						AS sat_sales
				FROM
					wscs, date_dim
				WHERE
					d_date_sk = sold_date_sk
				GROUP BY
					d_week_seq
			)
	SELECT
		d_week_seq1,
		round(sun_sales1 / sun_sales2, 2),
		round(mon_sales1 / mon_sales2, 2),
		round(tue_sales1 / tue_sales2, 2),
		round(wed_sales1 / wed_sales2, 2),
		round(thu_sales1 / thu_sales2, 2),
		round(fri_sales1 / fri_sales2, 2),
		round(sat_sales1 / sat_sales2, 2)
	FROM
		(
			SELECT
				wswscs.d_week_seq AS d_week_seq1,
				sun_sales AS sun_sales1,
				mon_sales AS mon_sales1,
				tue_sales AS tue_sales1,
				wed_sales AS wed_sales1,
				thu_sales AS thu_sales1,
				fri_sales AS fri_sales1,
				sat_sales AS sat_sales1
			FROM
				wswscs, date_dim
			WHERE
				date_dim.d_week_seq = wswscs.d_week_seq
				AND d_year = 1998
		)
			AS y,
		(
			SELECT
				wswscs.d_week_seq AS d_week_seq2,
				sun_sales AS sun_sales2,
				mon_sales AS mon_sales2,
				tue_sales AS tue_sales2,
				wed_sales AS wed_sales2,
				thu_sales AS thu_sales2,
				fri_sales AS fri_sales2,
				sat_sales AS sat_sales2
			FROM
				wswscs, date_dim
			WHERE
				date_dim.d_week_seq = wswscs.d_week_seq
				AND d_year = 1998 + 1
		)
			AS z
	WHERE
		d_week_seq1 = d_week_seq2 - 53
	ORDER BY
		d_week_seq1;
----
sort
 ├── columns: d_week_seq1:121!null round:198 round:199 round:200 round:201 round:202 round:203 round:204
 ├── immutable
 ├── ordering: +121
 └── with &2 (wswscs)
      ├── columns: d_week_seq:121!null round:198 round:199 round:200 round:201 round:202 round:203 round:204
      ├── immutable
      ├── group-by (hash)
      │    ├── columns: date_dim.d_week_seq:81 sum:108 sum:110 sum:112 sum:114 sum:116 sum:118 sum:120
      │    ├── grouping columns: date_dim.d_week_seq:81
      │    ├── immutable
      │    ├── key: (81)
      │    ├── fd: (81)-->(108,110,112,114,116,118,120)
      │    ├── project
      │    │    ├── columns: column107:107 column109:109 column111:111 column113:113 column115:115 column117:117 column119:119 date_dim.d_week_seq:81
      │    │    ├── immutable
      │    │    ├── project
      │    │    │    ├── columns: sales_price:76 date_dim.d_week_seq:81 d_day_name:91
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: sold_date_sk:73!null sales_price:74 d_date_sk:77!null date_dim.d_week_seq:81 d_day_name:91
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: (77)-->(81,91), (73)==(77), (77)==(73)
      │    │    │    │    ├── union-all
      │    │    │    │    │    ├── columns: sold_date_sk:73 sales_price:74
      │    │    │    │    │    ├── left columns: ws_sold_date_sk:1 ws_ext_sales_price:24
      │    │    │    │    │    ├── right columns: cs_sold_date_sk:37 cs_ext_sales_price:60
      │    │    │    │    │    ├── scan web_sales
      │    │    │    │    │    │    └── columns: ws_sold_date_sk:1 ws_ext_sales_price:24
      │    │    │    │    │    └── scan catalog_sales
      │    │    │    │    │         └── columns: cs_sold_date_sk:37 cs_ext_sales_price:60
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:77!null date_dim.d_week_seq:81 d_day_name:91
      │    │    │    │    │    ├── key: (77)
      │    │    │    │    │    └── fd: (77)-->(81,91)
      │    │    │    │    └── filters
      │    │    │    │         └── d_date_sk:77 = sold_date_sk:73 [outer=(73,77), constraints=(/73: (/NULL - ]; /77: (/NULL - ]), fd=(73)==(77), (77)==(73)]
      │    │    │    └── projections
      │    │    │         └── sales_price:74 [as=sales_price:76, outer=(74)]
      │    │    └── projections
      │    │         ├── CASE WHEN d_day_name:91 = 'Sunday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column107:107, outer=(76,91), immutable]
      │    │         ├── CASE WHEN d_day_name:91 = 'Monday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column109:109, outer=(76,91), immutable]
      │    │         ├── CASE WHEN d_day_name:91 = 'Tuesday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column111:111, outer=(76,91), immutable]
      │    │         ├── CASE WHEN d_day_name:91 = 'Wednesday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column113:113, outer=(76,91), immutable]
      │    │         ├── CASE WHEN d_day_name:91 = 'Thursday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column115:115, outer=(76,91), immutable]
      │    │         ├── CASE WHEN d_day_name:91 = 'Friday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column117:117, outer=(76,91), immutable]
      │    │         └── CASE WHEN d_day_name:91 = 'Saturday' THEN sales_price:76::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column119:119, outer=(76,91), immutable]
      │    └── aggregations
      │         ├── sum [as=sum:108, outer=(107)]
      │         │    └── column107:107
      │         ├── sum [as=sum:110, outer=(109)]
      │         │    └── column109:109
      │         ├── sum [as=sum:112, outer=(111)]
      │         │    └── column111:111
      │         ├── sum [as=sum:114, outer=(113)]
      │         │    └── column113:113
      │         ├── sum [as=sum:116, outer=(115)]
      │         │    └── column115:115
      │         ├── sum [as=sum:118, outer=(117)]
      │         │    └── column117:117
      │         └── sum [as=sum:120, outer=(119)]
      │              └── column119:119
      └── project
           ├── columns: round:198 round:199 round:200 round:201 round:202 round:203 round:204 d_week_seq:121!null
           ├── immutable
           ├── inner-join (hash)
           │    ├── columns: d_week_seq:121!null sun_sales:122 mon_sales:123 tue_sales:124 wed_sales:125 thu_sales:126 fri_sales:127 sat_sales:128 date_dim.d_week_seq:133!null d_year:135!null sun_sales:160 mon_sales:161 tue_sales:162 wed_sales:163 thu_sales:164 fri_sales:165 sat_sales:166 column197:197!null
           │    ├── immutable
           │    ├── fd: ()-->(135), (121)-->(122-128), (121)==(133,197), (133)==(121,197), (197)==(121,133)
           │    ├── inner-join (hash)
           │    │    ├── columns: d_week_seq:121!null sun_sales:122 mon_sales:123 tue_sales:124 wed_sales:125 thu_sales:126 fri_sales:127 sat_sales:128 date_dim.d_week_seq:133!null d_year:135!null
           │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
           │    │    ├── fd: ()-->(135), (121)-->(122-128), (121)==(133), (133)==(121)
           │    │    ├── with-scan &2 (wswscs)
           │    │    │    ├── columns: d_week_seq:121 sun_sales:122 mon_sales:123 tue_sales:124 wed_sales:125 thu_sales:126 fri_sales:127 sat_sales:128
           │    │    │    ├── mapping:
           │    │    │    │    ├──  date_dim.d_week_seq:81 => d_week_seq:121
           │    │    │    │    ├──  sum:108 => sun_sales:122
           │    │    │    │    ├──  sum:110 => mon_sales:123
           │    │    │    │    ├──  sum:112 => tue_sales:124
           │    │    │    │    ├──  sum:114 => wed_sales:125
           │    │    │    │    ├──  sum:116 => thu_sales:126
           │    │    │    │    ├──  sum:118 => fri_sales:127
           │    │    │    │    └──  sum:120 => sat_sales:128
           │    │    │    ├── key: (121)
           │    │    │    └── fd: (121)-->(122-128)
           │    │    ├── select
           │    │    │    ├── columns: date_dim.d_week_seq:133 d_year:135!null
           │    │    │    ├── fd: ()-->(135)
           │    │    │    ├── scan date_dim
           │    │    │    │    └── columns: date_dim.d_week_seq:133 d_year:135
           │    │    │    └── filters
           │    │    │         └── d_year:135 = 1998 [outer=(135), constraints=(/135: [/1998 - /1998]; tight), fd=()-->(135)]
           │    │    └── filters
           │    │         └── date_dim.d_week_seq:133 = d_week_seq:121 [outer=(121,133), constraints=(/121: (/NULL - ]; /133: (/NULL - ]), fd=(121)==(133), (133)==(121)]
           │    ├── project
           │    │    ├── columns: column197:197!null sun_sales:160 mon_sales:161 tue_sales:162 wed_sales:163 thu_sales:164 fri_sales:165 sat_sales:166
           │    │    ├── immutable
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: d_week_seq:159!null sun_sales:160 mon_sales:161 tue_sales:162 wed_sales:163 thu_sales:164 fri_sales:165 sat_sales:166 date_dim.d_week_seq:171!null d_year:173!null
           │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
           │    │    │    ├── fd: ()-->(173), (159)-->(160-166), (159)==(171), (171)==(159)
           │    │    │    ├── with-scan &2 (wswscs)
           │    │    │    │    ├── columns: d_week_seq:159 sun_sales:160 mon_sales:161 tue_sales:162 wed_sales:163 thu_sales:164 fri_sales:165 sat_sales:166
           │    │    │    │    ├── mapping:
           │    │    │    │    │    ├──  date_dim.d_week_seq:81 => d_week_seq:159
           │    │    │    │    │    ├──  sum:108 => sun_sales:160
           │    │    │    │    │    ├──  sum:110 => mon_sales:161
           │    │    │    │    │    ├──  sum:112 => tue_sales:162
           │    │    │    │    │    ├──  sum:114 => wed_sales:163
           │    │    │    │    │    ├──  sum:116 => thu_sales:164
           │    │    │    │    │    ├──  sum:118 => fri_sales:165
           │    │    │    │    │    └──  sum:120 => sat_sales:166
           │    │    │    │    ├── key: (159)
           │    │    │    │    └── fd: (159)-->(160-166)
           │    │    │    ├── select
           │    │    │    │    ├── columns: date_dim.d_week_seq:171 d_year:173!null
           │    │    │    │    ├── fd: ()-->(173)
           │    │    │    │    ├── scan date_dim
           │    │    │    │    │    └── columns: date_dim.d_week_seq:171 d_year:173
           │    │    │    │    └── filters
           │    │    │    │         └── d_year:173 = 1999 [outer=(173), constraints=(/173: [/1999 - /1999]; tight), fd=()-->(173)]
           │    │    │    └── filters
           │    │    │         └── date_dim.d_week_seq:171 = d_week_seq:159 [outer=(159,171), constraints=(/159: (/NULL - ]; /171: (/NULL - ]), fd=(159)==(171), (171)==(159)]
           │    │    └── projections
           │    │         └── d_week_seq:159 - 53 [as=column197:197, outer=(159), immutable]
           │    └── filters
           │         └── d_week_seq:121 = column197:197 [outer=(121,197), constraints=(/121: (/NULL - ]; /197: (/NULL - ]), fd=(121)==(197), (197)==(121)]
           └── projections
                ├── round(sun_sales:122 / sun_sales:160, 2) [as=round:198, outer=(122,160), immutable]
                ├── round(mon_sales:123 / mon_sales:161, 2) [as=round:199, outer=(123,161), immutable]
                ├── round(tue_sales:124 / tue_sales:162, 2) [as=round:200, outer=(124,162), immutable]
                ├── round(wed_sales:125 / wed_sales:163, 2) [as=round:201, outer=(125,163), immutable]
                ├── round(thu_sales:126 / thu_sales:164, 2) [as=round:202, outer=(126,164), immutable]
                ├── round(fri_sales:127 / fri_sales:165, 2) [as=round:203, outer=(127,165), immutable]
                └── round(sat_sales:128 / sat_sales:166, 2) [as=round:204, outer=(128,166), immutable]

# --------------------------------------------------
# Q3
opt
	SELECT
		dt.d_year,
		item.i_brand_id AS brand_id,
		item.i_brand AS brand,
		sum(ss_sales_price) AS sum_agg
	FROM
		date_dim AS dt, store_sales, item
	WHERE
		dt.d_date_sk = store_sales.ss_sold_date_sk
		AND store_sales.ss_item_sk = item.i_item_sk
		AND item.i_manufact_id = 816
		AND dt.d_moy = 11
	GROUP BY
		dt.d_year, item.i_brand, item.i_brand_id
	ORDER BY
		dt.d_year, sum_agg DESC, brand_id
	LIMIT
		100;
----
top-k
 ├── columns: d_year:7 brand_id:63 brand:64 sum_agg:80
 ├── internal-ordering: +7,-80,+63
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (7,63,64)
 ├── fd: (7,63,64)-->(80)
 ├── ordering: +7,-80,+63
 └── group-by (hash)
      ├── columns: d_year:7 i_brand_id:63 i_brand:64 sum:80
      ├── grouping columns: d_year:7 i_brand_id:63 i_brand:64
      ├── key: (7,63,64)
      ├── fd: (7,63,64)-->(80)
      ├── inner-join (hash)
      │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_sales_price:44 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── fd: ()-->(9,69), (1)-->(7), (56)-->(63,64), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup store_sales)
      │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_sales_price:44 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69!null
      │    │    ├── key columns: [56] = [33]
      │    │    ├── fd: ()-->(69), (56)-->(63,64), (33)==(56), (56)==(33)
      │    │    ├── select
      │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69!null
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: ()-->(69), (56)-->(63,64)
      │    │    │    ├── scan item
      │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(63,64,69)
      │    │    │    └── filters
      │    │    │         └── i_manufact_id:69 = 816 [outer=(69), constraints=(/69: [/816 - /816]; tight), fd=()-->(69)]
      │    │    └── filters (true)
      │    ├── select
      │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9!null
      │    │    ├── key: (1)
      │    │    ├── fd: ()-->(9), (1)-->(7)
      │    │    ├── scan date_dim [as=dt]
      │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    ├── key: (1)
      │    │    │    └── fd: (1)-->(7,9)
      │    │    └── filters
      │    │         └── d_moy:9 = 11 [outer=(9), constraints=(/9: [/11 - /11]; tight), fd=()-->(9)]
      │    └── filters
      │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      └── aggregations
           └── sum [as=sum:80, outer=(44)]
                └── ss_sales_price:44

# --------------------------------------------------
# Q4
opt
	WITH
		year_total
			AS (
				SELECT
					c_customer_id AS customer_id,
					c_first_name AS customer_first_name,
					c_last_name AS customer_last_name,
					c_preferred_cust_flag
						AS customer_preferred_cust_flag,
					c_birth_country AS customer_birth_country,
					c_login AS customer_login,
					c_email_address AS customer_email_address,
					d_year AS dyear,
					sum(
						(
							ss_ext_list_price
							- ss_ext_wholesale_cost
							- ss_ext_discount_amt
							+ ss_ext_sales_price
						)
						/ 2
					)
						AS year_total,
					's' AS sale_type
				FROM
					customer, store_sales, date_dim
				WHERE
					c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
				GROUP BY
					c_customer_id,
					c_first_name,
					c_last_name,
					c_preferred_cust_flag,
					c_birth_country,
					c_login,
					c_email_address,
					d_year
				UNION ALL
					SELECT
						c_customer_id AS customer_id,
						c_first_name AS customer_first_name,
						c_last_name AS customer_last_name,
						c_preferred_cust_flag
							AS customer_preferred_cust_flag,
						c_birth_country
							AS customer_birth_country,
						c_login AS customer_login,
						c_email_address
							AS customer_email_address,
						d_year AS dyear,
						sum(
							(
								cs_ext_list_price
								- cs_ext_wholesale_cost
								- cs_ext_discount_amt
								+ cs_ext_sales_price
							)
							/ 2
						)
							AS year_total,
						'c' AS sale_type
					FROM
						customer, catalog_sales, date_dim
					WHERE
						c_customer_sk = cs_bill_customer_sk
						AND cs_sold_date_sk = d_date_sk
					GROUP BY
						c_customer_id,
						c_first_name,
						c_last_name,
						c_preferred_cust_flag,
						c_birth_country,
						c_login,
						c_email_address,
						d_year
				UNION ALL
					SELECT
						c_customer_id AS customer_id,
						c_first_name AS customer_first_name,
						c_last_name AS customer_last_name,
						c_preferred_cust_flag
							AS customer_preferred_cust_flag,
						c_birth_country
							AS customer_birth_country,
						c_login AS customer_login,
						c_email_address
							AS customer_email_address,
						d_year AS dyear,
						sum(
							(
								ws_ext_list_price
								- ws_ext_wholesale_cost
								- ws_ext_discount_amt
								+ ws_ext_sales_price
							)
							/ 2
						)
							AS year_total,
						'w' AS sale_type
					FROM
						customer, web_sales, date_dim
					WHERE
						c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
					GROUP BY
						c_customer_id,
						c_first_name,
						c_last_name,
						c_preferred_cust_flag,
						c_birth_country,
						c_login,
						c_email_address,
						d_year
			)
	SELECT
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_birth_country
	FROM
		year_total AS t_s_firstyear,
		year_total AS t_s_secyear,
		year_total AS t_c_firstyear,
		year_total AS t_c_secyear,
		year_total AS t_w_firstyear,
		year_total AS t_w_secyear
	WHERE
		t_s_secyear.customer_id = t_s_firstyear.customer_id
		AND t_s_firstyear.customer_id = t_c_secyear.customer_id
		AND t_s_firstyear.customer_id
			= t_c_firstyear.customer_id
		AND t_s_firstyear.customer_id
			= t_w_firstyear.customer_id
		AND t_s_firstyear.customer_id = t_w_secyear.customer_id
		AND t_s_firstyear.sale_type = 's'
		AND t_c_firstyear.sale_type = 'c'
		AND t_w_firstyear.sale_type = 'w'
		AND t_s_secyear.sale_type = 's'
		AND t_c_secyear.sale_type = 'c'
		AND t_w_secyear.sale_type = 'w'
		AND t_s_firstyear.dyear = 1999
		AND t_s_secyear.dyear = 1999 + 1
		AND t_c_firstyear.dyear = 1999
		AND t_c_secyear.dyear = 1999 + 1
		AND t_w_firstyear.dyear = 1999
		AND t_w_secyear.dyear = 1999 + 1
		AND t_s_firstyear.year_total > 0
		AND t_c_firstyear.year_total > 0
		AND t_w_firstyear.year_total > 0
		AND CASE
			WHEN t_c_firstyear.year_total > 0
			THEN t_c_secyear.year_total
			/ t_c_firstyear.year_total
			ELSE NULL
			END
			> CASE
				WHEN t_s_firstyear.year_total > 0
				THEN t_s_secyear.year_total
				/ t_s_firstyear.year_total
				ELSE NULL
				END
		AND CASE
			WHEN t_c_firstyear.year_total > 0
			THEN t_c_secyear.year_total
			/ t_c_firstyear.year_total
			ELSE NULL
			END
			> CASE
				WHEN t_w_firstyear.year_total > 0
				THEN t_w_secyear.year_total
				/ t_w_firstyear.year_total
				ELSE NULL
				END
	ORDER BY
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_birth_country
	LIMIT
		100;
----
with &1 (year_total)
 ├── columns: customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +287,+288,+289,+291
 ├── union-all
 │    ├── columns: customer_id:267!null customer_first_name:268 customer_last_name:269 customer_preferred_cust_flag:270 customer_birth_country:271 customer_login:272 customer_email_address:273 dyear:274 year_total:275 sale_type:276!null
 │    ├── left columns: customer_id:168 customer_first_name:169 customer_last_name:170 customer_preferred_cust_flag:171 customer_birth_country:172 customer_login:173 customer_email_address:174 dyear:175 year_total:176 sale_type:177
 │    ├── right columns: c_customer_id:179 c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 d_year:240 sum:265 sale_type:266
 │    ├── immutable
 │    ├── union-all
 │    │    ├── columns: customer_id:168!null customer_first_name:169 customer_last_name:170 customer_preferred_cust_flag:171 customer_birth_country:172 customer_login:173 customer_email_address:174 dyear:175 year_total:176 sale_type:177!null
 │    │    ├── left columns: c_customer_id:2 c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77 sale_type:78
 │    │    ├── right columns: c_customer_id:80 c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166 sale_type:167
 │    │    ├── immutable
 │    │    ├── project
 │    │    │    ├── columns: sale_type:78!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    │    ├── immutable
 │    │    │    ├── key: (2,9-11,15-17,52)
 │    │    │    ├── fd: ()-->(78), (2,9-11,15-17,52)-->(77)
 │    │    │    ├── group-by (hash)
 │    │    │    │    ├── columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    │    │    ├── grouping columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: (2,9-11,15-17,52)
 │    │    │    │    ├── fd: (2,9-11,15-17,52)-->(77)
 │    │    │    │    ├── project
 │    │    │    │    │    ├── columns: column76:76 c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21!null ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_sales_price:36 ss_ext_wholesale_cost:37 ss_ext_list_price:38 d_date_sk:46!null d_year:52
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (46)-->(52), (21)==(46), (46)==(21), (1)==(24), (24)==(1)
 │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21 ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_sales_price:36 ss_ext_wholesale_cost:37 ss_ext_list_price:38
 │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (1)==(24), (24)==(1)
 │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:21 ss_customer_sk:24 ss_ext_discount_amt:35 ss_ext_sales_price:36 ss_ext_wholesale_cost:37 ss_ext_list_price:38
 │    │    │    │    │    │    │    ├── scan customer
 │    │    │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17
 │    │    │    │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    │    │    │    └── fd: (1)-->(2,9-11,15-17)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── c_customer_sk:1 = ss_customer_sk:24 [outer=(1,24), constraints=(/1: (/NULL - ]; /24: (/NULL - ]), fd=(1)==(24), (24)==(1)]
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:46!null d_year:52
 │    │    │    │    │    │    │    ├── key: (46)
 │    │    │    │    │    │    │    └── fd: (46)-->(52)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_sold_date_sk:21 = d_date_sk:46 [outer=(21,46), constraints=(/21: (/NULL - ]; /46: (/NULL - ]), fd=(21)==(46), (46)==(21)]
 │    │    │    │    │    └── projections
 │    │    │    │    │         └── (ss_ext_sales_price:36 + ((ss_ext_list_price:38 - ss_ext_wholesale_cost:37) - ss_ext_discount_amt:35)) / 2 [as=column76:76, outer=(35-38), immutable]
 │    │    │    │    └── aggregations
 │    │    │    │         └── sum [as=sum:77, outer=(76)]
 │    │    │    │              └── column76:76
 │    │    │    └── projections
 │    │    │         └── 's' [as=sale_type:78]
 │    │    └── project
 │    │         ├── columns: sale_type:167!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │    │         ├── immutable
 │    │         ├── key: (80,87-89,93-95,141)
 │    │         ├── fd: ()-->(167), (80,87-89,93-95,141)-->(166)
 │    │         ├── group-by (hash)
 │    │         │    ├── columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │    │         │    ├── grouping columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │    │         │    ├── immutable
 │    │         │    ├── key: (80,87-89,93-95,141)
 │    │         │    ├── fd: (80,87-89,93-95,141)-->(166)
 │    │         │    ├── project
 │    │         │    │    ├── columns: column165:165 c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │    │         │    │    ├── immutable
 │    │         │    │    ├── inner-join (hash)
 │    │         │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 cs_sold_date_sk:99!null cs_bill_customer_sk:102!null cs_ext_discount_amt:121 cs_ext_sales_price:122 cs_ext_wholesale_cost:123 cs_ext_list_price:124 d_date_sk:135!null d_year:141
 │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    │    │    ├── fd: (79)-->(80,87-89,93-95), (135)-->(141), (99)==(135), (135)==(99), (79)==(102), (102)==(79)
 │    │         │    │    │    ├── inner-join (hash)
 │    │         │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 cs_sold_date_sk:99 cs_bill_customer_sk:102!null cs_ext_discount_amt:121 cs_ext_sales_price:122 cs_ext_wholesale_cost:123 cs_ext_list_price:124
 │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    │    │    │    ├── fd: (79)-->(80,87-89,93-95), (79)==(102), (102)==(79)
 │    │         │    │    │    │    ├── scan catalog_sales
 │    │         │    │    │    │    │    └── columns: cs_sold_date_sk:99 cs_bill_customer_sk:102 cs_ext_discount_amt:121 cs_ext_sales_price:122 cs_ext_wholesale_cost:123 cs_ext_list_price:124
 │    │         │    │    │    │    ├── scan customer
 │    │         │    │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95
 │    │         │    │    │    │    │    ├── key: (79)
 │    │         │    │    │    │    │    └── fd: (79)-->(80,87-89,93-95)
 │    │         │    │    │    │    └── filters
 │    │         │    │    │    │         └── c_customer_sk:79 = cs_bill_customer_sk:102 [outer=(79,102), constraints=(/79: (/NULL - ]; /102: (/NULL - ]), fd=(79)==(102), (102)==(79)]
 │    │         │    │    │    ├── scan date_dim
 │    │         │    │    │    │    ├── columns: d_date_sk:135!null d_year:141
 │    │         │    │    │    │    ├── key: (135)
 │    │         │    │    │    │    └── fd: (135)-->(141)
 │    │         │    │    │    └── filters
 │    │         │    │    │         └── cs_sold_date_sk:99 = d_date_sk:135 [outer=(99,135), constraints=(/99: (/NULL - ]; /135: (/NULL - ]), fd=(99)==(135), (135)==(99)]
 │    │         │    │    └── projections
 │    │         │    │         └── (cs_ext_sales_price:122 + ((cs_ext_list_price:124 - cs_ext_wholesale_cost:123) - cs_ext_discount_amt:121)) / 2 [as=column165:165, outer=(121-124), immutable]
 │    │         │    └── aggregations
 │    │         │         └── sum [as=sum:166, outer=(165)]
 │    │         │              └── column165:165
 │    │         └── projections
 │    │              └── 'c' [as=sale_type:167]
 │    └── project
 │         ├── columns: sale_type:266!null c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 d_year:240 sum:265
 │         ├── immutable
 │         ├── key: (179,186-188,192-194,240)
 │         ├── fd: ()-->(266), (179,186-188,192-194,240)-->(265)
 │         ├── group-by (hash)
 │         │    ├── columns: c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 d_year:240 sum:265
 │         │    ├── grouping columns: c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 d_year:240
 │         │    ├── immutable
 │         │    ├── key: (179,186-188,192-194,240)
 │         │    ├── fd: (179,186-188,192-194,240)-->(265)
 │         │    ├── project
 │         │    │    ├── columns: column264:264 c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 d_year:240
 │         │    │    ├── immutable
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: c_customer_sk:178!null c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 ws_sold_date_sk:198!null ws_bill_customer_sk:202!null ws_ext_discount_amt:220 ws_ext_sales_price:221 ws_ext_wholesale_cost:222 ws_ext_list_price:223 d_date_sk:234!null d_year:240
 │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    ├── fd: (178)-->(179,186-188,192-194), (234)-->(240), (198)==(234), (234)==(198), (178)==(202), (202)==(178)
 │         │    │    │    ├── inner-join (hash)
 │         │    │    │    │    ├── columns: c_customer_sk:178!null c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194 ws_sold_date_sk:198 ws_bill_customer_sk:202!null ws_ext_discount_amt:220 ws_ext_sales_price:221 ws_ext_wholesale_cost:222 ws_ext_list_price:223
 │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    ├── fd: (178)-->(179,186-188,192-194), (178)==(202), (202)==(178)
 │         │    │    │    │    ├── scan web_sales
 │         │    │    │    │    │    └── columns: ws_sold_date_sk:198 ws_bill_customer_sk:202 ws_ext_discount_amt:220 ws_ext_sales_price:221 ws_ext_wholesale_cost:222 ws_ext_list_price:223
 │         │    │    │    │    ├── scan customer
 │         │    │    │    │    │    ├── columns: c_customer_sk:178!null c_customer_id:179!null c_first_name:186 c_last_name:187 c_preferred_cust_flag:188 c_birth_country:192 c_login:193 c_email_address:194
 │         │    │    │    │    │    ├── key: (178)
 │         │    │    │    │    │    └── fd: (178)-->(179,186-188,192-194)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── c_customer_sk:178 = ws_bill_customer_sk:202 [outer=(178,202), constraints=(/178: (/NULL - ]; /202: (/NULL - ]), fd=(178)==(202), (202)==(178)]
 │         │    │    │    ├── scan date_dim
 │         │    │    │    │    ├── columns: d_date_sk:234!null d_year:240
 │         │    │    │    │    ├── key: (234)
 │         │    │    │    │    └── fd: (234)-->(240)
 │         │    │    │    └── filters
 │         │    │    │         └── ws_sold_date_sk:198 = d_date_sk:234 [outer=(198,234), constraints=(/198: (/NULL - ]; /234: (/NULL - ]), fd=(198)==(234), (234)==(198)]
 │         │    │    └── projections
 │         │    │         └── (ws_ext_sales_price:221 + ((ws_ext_list_price:223 - ws_ext_wholesale_cost:222) - ws_ext_discount_amt:220)) / 2 [as=column264:264, outer=(220-223), immutable]
 │         │    └── aggregations
 │         │         └── sum [as=sum:265, outer=(264)]
 │         │              └── column264:264
 │         └── projections
 │              └── 'w' [as=sale_type:266]
 └── project
      ├── columns: customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +287,+288,+289,+291
      └── top-k
           ├── columns: customer_id:277!null dyear:284!null year_total:285!null sale_type:286!null customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291 dyear:294!null year_total:295 sale_type:296!null customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:307!null dyear:314!null year_total:315 sale_type:316!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
           ├── internal-ordering: +(277|287|297|307|317|327),+288,+289,+291 opt(284,286,294,296,304,306,314,316,324,326,334,336)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── fd: ()-->(284,286,294,296,304,306,314,316,324,326,334,336), (277)==(287,297,307,317,327), (287)==(277,297,307,317,327), (297)==(277,287,307,317,327), (307)==(277,287,297,317,327), (317)==(277,287,297,307,327), (327)==(277,287,297,307,317)
           ├── ordering: +(277|287|297|307|317|327),+288,+289,+291 opt(284,286,294,296,304,306,314,316,324,326,334,336) [actual: +277,+288,+289,+291]
           └── inner-join (hash)
                ├── columns: customer_id:277!null dyear:284!null year_total:285!null sale_type:286!null customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291 dyear:294!null year_total:295 sale_type:296!null customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:307!null dyear:314!null year_total:315 sale_type:316!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
                ├── immutable
                ├── fd: ()-->(284,286,294,296,304,306,314,316,324,326,334,336), (277)==(287,297,307,317,327), (287)==(277,297,307,317,327), (297)==(277,287,307,317,327), (307)==(277,287,297,317,327), (317)==(277,287,297,307,327), (327)==(277,287,297,307,317)
                ├── select
                │    ├── columns: customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291 dyear:294!null year_total:295 sale_type:296!null
                │    ├── fd: ()-->(294,296)
                │    ├── with-scan &1 (year_total)
                │    │    ├── columns: customer_id:287!null customer_first_name:288 customer_last_name:289 customer_birth_country:291 dyear:294 year_total:295 sale_type:296!null
                │    │    └── mapping:
                │    │         ├──  customer_id:267 => customer_id:287
                │    │         ├──  customer_first_name:268 => customer_first_name:288
                │    │         ├──  customer_last_name:269 => customer_last_name:289
                │    │         ├──  customer_birth_country:271 => customer_birth_country:291
                │    │         ├──  dyear:274 => dyear:294
                │    │         ├──  year_total:275 => year_total:295
                │    │         └──  sale_type:276 => sale_type:296
                │    └── filters
                │         ├── sale_type:296 = 's' [outer=(296), constraints=(/296: [/'s' - /'s']; tight), fd=()-->(296)]
                │         └── dyear:294 = 2000 [outer=(294), constraints=(/294: [/2000 - /2000]; tight), fd=()-->(294)]
                ├── inner-join (hash)
                │    ├── columns: customer_id:277!null dyear:284!null year_total:285!null sale_type:286!null customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:307!null dyear:314!null year_total:315 sale_type:316!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
                │    ├── immutable
                │    ├── fd: ()-->(284,286,304,306,314,316,324,326,334,336), (277)==(297,307,317,327), (297)==(277,307,317,327), (307)==(277,297,317,327), (317)==(277,297,307,327), (327)==(277,297,307,317)
                │    ├── select
                │    │    ├── columns: customer_id:277!null dyear:284!null year_total:285!null sale_type:286!null
                │    │    ├── immutable
                │    │    ├── fd: ()-->(284,286)
                │    │    ├── with-scan &1 (year_total)
                │    │    │    ├── columns: customer_id:277!null dyear:284 year_total:285 sale_type:286!null
                │    │    │    └── mapping:
                │    │    │         ├──  customer_id:267 => customer_id:277
                │    │    │         ├──  dyear:274 => dyear:284
                │    │    │         ├──  year_total:275 => year_total:285
                │    │    │         └──  sale_type:276 => sale_type:286
                │    │    └── filters
                │    │         ├── sale_type:286 = 's' [outer=(286), constraints=(/286: [/'s' - /'s']; tight), fd=()-->(286)]
                │    │         ├── dyear:284 = 1999 [outer=(284), constraints=(/284: [/1999 - /1999]; tight), fd=()-->(284)]
                │    │         └── year_total:285 > 0 [outer=(285), immutable, constraints=(/285: (/0 - ]; tight)]
                │    ├── inner-join (hash)
                │    │    ├── columns: customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:307!null dyear:314!null year_total:315 sale_type:316!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
                │    │    ├── immutable
                │    │    ├── fd: ()-->(304,306,314,316,324,326,334,336), (297)==(307,317,327), (307)==(297,317,327), (317)==(297,307,327), (327)==(297,307,317)
                │    │    ├── select
                │    │    │    ├── columns: customer_id:307!null dyear:314!null year_total:315 sale_type:316!null
                │    │    │    ├── fd: ()-->(314,316)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:307!null dyear:314 year_total:315 sale_type:316!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:267 => customer_id:307
                │    │    │    │         ├──  dyear:274 => dyear:314
                │    │    │    │         ├──  year_total:275 => year_total:315
                │    │    │    │         └──  sale_type:276 => sale_type:316
                │    │    │    └── filters
                │    │    │         ├── sale_type:316 = 'c' [outer=(316), constraints=(/316: [/'c' - /'c']; tight), fd=()-->(316)]
                │    │    │         └── dyear:314 = 2000 [outer=(314), constraints=(/314: [/2000 - /2000]; tight), fd=()-->(314)]
                │    │    ├── inner-join (hash)
                │    │    │    ├── columns: customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(304,306,324,326,334,336), (297)==(317,327), (317)==(297,327), (327)==(297,317)
                │    │    │    ├── select
                │    │    │    │    ├── columns: customer_id:327!null dyear:334!null year_total:335 sale_type:336!null
                │    │    │    │    ├── fd: ()-->(334,336)
                │    │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    │    ├── columns: customer_id:327!null dyear:334 year_total:335 sale_type:336!null
                │    │    │    │    │    └── mapping:
                │    │    │    │    │         ├──  customer_id:267 => customer_id:327
                │    │    │    │    │         ├──  dyear:274 => dyear:334
                │    │    │    │    │         ├──  year_total:275 => year_total:335
                │    │    │    │    │         └──  sale_type:276 => sale_type:336
                │    │    │    │    └── filters
                │    │    │    │         ├── sale_type:336 = 'w' [outer=(336), constraints=(/336: [/'w' - /'w']; tight), fd=()-->(336)]
                │    │    │    │         └── dyear:334 = 2000 [outer=(334), constraints=(/334: [/2000 - /2000]; tight), fd=()-->(334)]
                │    │    │    ├── inner-join (hash)
                │    │    │    │    ├── columns: customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null
                │    │    │    │    ├── immutable
                │    │    │    │    ├── fd: ()-->(304,306,324,326), (297)==(317), (317)==(297)
                │    │    │    │    ├── select
                │    │    │    │    │    ├── columns: customer_id:297!null dyear:304!null year_total:305!null sale_type:306!null
                │    │    │    │    │    ├── immutable
                │    │    │    │    │    ├── fd: ()-->(304,306)
                │    │    │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    │    │    ├── columns: customer_id:297!null dyear:304 year_total:305 sale_type:306!null
                │    │    │    │    │    │    └── mapping:
                │    │    │    │    │    │         ├──  customer_id:267 => customer_id:297
                │    │    │    │    │    │         ├──  dyear:274 => dyear:304
                │    │    │    │    │    │         ├──  year_total:275 => year_total:305
                │    │    │    │    │    │         └──  sale_type:276 => sale_type:306
                │    │    │    │    │    └── filters
                │    │    │    │    │         ├── sale_type:306 = 'c' [outer=(306), constraints=(/306: [/'c' - /'c']; tight), fd=()-->(306)]
                │    │    │    │    │         ├── dyear:304 = 1999 [outer=(304), constraints=(/304: [/1999 - /1999]; tight), fd=()-->(304)]
                │    │    │    │    │         └── year_total:305 > 0 [outer=(305), immutable, constraints=(/305: (/0 - ]; tight)]
                │    │    │    │    ├── select
                │    │    │    │    │    ├── columns: customer_id:317!null dyear:324!null year_total:325!null sale_type:326!null
                │    │    │    │    │    ├── immutable
                │    │    │    │    │    ├── fd: ()-->(324,326)
                │    │    │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    │    │    ├── columns: customer_id:317!null dyear:324 year_total:325 sale_type:326!null
                │    │    │    │    │    │    └── mapping:
                │    │    │    │    │    │         ├──  customer_id:267 => customer_id:317
                │    │    │    │    │    │         ├──  dyear:274 => dyear:324
                │    │    │    │    │    │         ├──  year_total:275 => year_total:325
                │    │    │    │    │    │         └──  sale_type:276 => sale_type:326
                │    │    │    │    │    └── filters
                │    │    │    │    │         ├── sale_type:326 = 'w' [outer=(326), constraints=(/326: [/'w' - /'w']; tight), fd=()-->(326)]
                │    │    │    │    │         ├── dyear:324 = 1999 [outer=(324), constraints=(/324: [/1999 - /1999]; tight), fd=()-->(324)]
                │    │    │    │    │         └── year_total:325 > 0 [outer=(325), immutable, constraints=(/325: (/0 - ]; tight)]
                │    │    │    │    └── filters
                │    │    │    │         └── customer_id:297 = customer_id:317 [outer=(297,317), constraints=(/297: (/NULL - ]; /317: (/NULL - ]), fd=(297)==(317), (317)==(297)]
                │    │    │    └── filters
                │    │    │         └── customer_id:317 = customer_id:327 [outer=(317,327), constraints=(/317: (/NULL - ]; /327: (/NULL - ]), fd=(317)==(327), (327)==(317)]
                │    │    └── filters
                │    │         ├── customer_id:307 = customer_id:317 [outer=(307,317), constraints=(/307: (/NULL - ]; /317: (/NULL - ]), fd=(307)==(317), (317)==(307)]
                │    │         └── CASE WHEN year_total:305 > 0 THEN year_total:315 / year_total:305 ELSE CAST(NULL AS DECIMAL) END > CASE WHEN year_total:325 > 0 THEN year_total:335 / year_total:325 ELSE CAST(NULL AS DECIMAL) END [outer=(305,315,325,335), immutable]
                │    └── filters
                │         └── customer_id:277 = customer_id:297 [outer=(277,297), constraints=(/277: (/NULL - ]; /297: (/NULL - ]), fd=(277)==(297), (297)==(277)]
                └── filters
                     ├── customer_id:287 = customer_id:297 [outer=(287,297), constraints=(/287: (/NULL - ]; /297: (/NULL - ]), fd=(287)==(297), (297)==(287)]
                     └── CASE WHEN year_total:305 > 0 THEN year_total:315 / year_total:305 ELSE CAST(NULL AS DECIMAL) END > CASE WHEN year_total:285 > 0 THEN year_total:295 / year_total:285 ELSE CAST(NULL AS DECIMAL) END [outer=(285,295,305,315), immutable]

# --------------------------------------------------
# Q5
# NOTE: Added conversion of 14 days to an interval.
# TODO: adjust the query to work with CRDB.
# opt
# WITH
# 	ssr
# 		AS (
# 			SELECT
# 				s_store_id,
# 				sum(sales_price) AS sales,
# 				sum(profit) AS profit,
# 				sum(return_amt) AS returns,
# 				sum(net_loss) AS profit_loss
# 			FROM
# 				(
# 					SELECT
# 						ss_store_sk AS store_sk,
# 						ss_sold_date_sk AS date_sk,
# 						ss_ext_sales_price AS sales_price,
# 						ss_net_profit AS profit,
# 						CAST(0 AS DECIMAL(7,2))
# 							AS return_amt,
# 						CAST(0 AS DECIMAL(7,2)) AS net_loss
# 					FROM
# 						store_sales
# 					UNION ALL
# 						SELECT
# 							sr_store_sk AS store_sk,
# 							sr_returned_date_sk AS date_sk,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS sales_price,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS profit,
# 							sr_return_amt AS return_amt,
# 							sr_net_loss AS net_loss
# 						FROM
# 							store_returns
# 				)
# 					AS salesreturns,
# 				date_dim,
# 				store
# 			WHERE
# 				date_sk = d_date_sk
# 				AND d_date BETWEEN CAST('2000-08-19' AS DATE) AND (CAST('2000-08-19' AS DATE) + '14 days'::INTERVAL)
# 				AND store_sk = s_store_sk
# 			GROUP BY
# 				s_store_id
# 		),
# 	csr
# 		AS (
# 			SELECT
# 				cp_catalog_page_id,
# 				sum(sales_price) AS sales,
# 				sum(profit) AS profit,
# 				sum(return_amt) AS returns,
# 				sum(net_loss) AS profit_loss
# 			FROM
# 				(
# 					SELECT
# 						cs_catalog_page_sk AS page_sk,
# 						cs_sold_date_sk AS date_sk,
# 						cs_ext_sales_price AS sales_price,
# 						cs_net_profit AS profit,
# 						CAST(0 AS DECIMAL(7,2))
# 							AS return_amt,
# 						CAST(0 AS DECIMAL(7,2)) AS net_loss
# 					FROM
# 						catalog_sales
# 					UNION ALL
# 						SELECT
# 							cr_catalog_page_sk AS page_sk,
# 							cr_returned_date_sk AS date_sk,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS sales_price,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS profit,
# 							cr_return_amount AS return_amt,
# 							cr_net_loss AS net_loss
# 						FROM
# 							catalog_returns
# 				)
# 					AS salesreturns,
# 				date_dim,
# 				catalog_page
# 			WHERE
# 				date_sk = d_date_sk
# 				AND d_date BETWEEN CAST('2000-08-19' AS DATE) AND (CAST('2000-08-19' AS DATE) + '14 days'::INTERVAL)
# 				AND page_sk = cp_catalog_page_sk
# 			GROUP BY
# 				cp_catalog_page_id
# 		),
# 	wsr
# 		AS (
# 			SELECT
# 				web_site_id,
# 				sum(sales_price) AS sales,
# 				sum(profit) AS profit,
# 				sum(return_amt) AS returns,
# 				sum(net_loss) AS profit_loss
# 			FROM
# 				(
# 					SELECT
# 						ws_web_site_sk AS wsr_web_site_sk,
# 						ws_sold_date_sk AS date_sk,
# 						ws_ext_sales_price AS sales_price,
# 						ws_net_profit AS profit,
# 						CAST(0 AS DECIMAL(7,2))
# 							AS return_amt,
# 						CAST(0 AS DECIMAL(7,2)) AS net_loss
# 					FROM
# 						web_sales
# 					UNION ALL
# 						SELECT
# 							ws_web_site_sk
# 								AS wsr_web_site_sk,
# 							wr_returned_date_sk AS date_sk,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS sales_price,
# 							CAST(0 AS DECIMAL(7,2))
# 								AS profit,
# 							wr_return_amt AS return_amt,
# 							wr_net_loss AS net_loss
# 						FROM
# 							web_returns
# 							LEFT JOIN web_sales ON
# 									wr_item_sk = ws_item_sk
# 									AND wr_order_number
# 										= ws_order_number
# 				)
# 					AS salesreturns,
# 				date_dim,
# 				web_site
# 			WHERE
# 				date_sk = d_date_sk
# 				AND d_date BETWEEN CAST('2000-08-19' AS DATE) AND (CAST('2000-08-19' AS DATE) + '14 days'::INTERVAL)
# 				AND wsr_web_site_sk = web_site_sk
# 			GROUP BY
# 				web_site_id
# 		)
# SELECT
# 	channel,
# 	id,
# 	sum(sales) AS sales,
# 	sum(returns) AS returns,
# 	sum(profit) AS profit
# FROM
# 	(
# 		SELECT
# 			'store channel' AS channel,
# 			'store' || s_store_id AS id,
# 			sales,
# 			returns,
# 			profit - profit_loss AS profit
# 		FROM
# 			ssr
# 		UNION ALL
# 			SELECT
# 				'catalog channel' AS channel,
# 				'catalog_page' || cp_catalog_page_id AS id,
# 				sales,
# 				returns,
# 				profit - profit_loss AS profit
# 			FROM
# 				csr
# 		UNION ALL
# 			SELECT
# 				'web channel' AS channel,
# 				'web_site' || web_site_id AS id,
# 				sales,
# 				returns,
# 				profit - profit_loss AS profit
# 			FROM
# 				wsr
# 	)
# 		AS x
# GROUP BY
# 	rollup(channel, id)
# ORDER BY
# 	channel, id
# LIMIT
# 	100;
# ----

# --------------------------------------------------
# Q6
opt
	SELECT
		a.ca_state AS state, count(*) AS cnt
	FROM
		customer_address AS a,
		customer AS c,
		store_sales AS s,
		date_dim AS d,
		item AS i
	WHERE
		a.ca_address_sk = c.c_current_addr_sk
		AND c.c_customer_sk = s.ss_customer_sk
		AND s.ss_sold_date_sk = d.d_date_sk
		AND s.ss_item_sk = i.i_item_sk
		AND d.d_month_seq
			= (
					SELECT
						DISTINCT d_month_seq
					FROM
						date_dim
					WHERE
						d_year = 2002 AND d_moy = 3
				)
		AND i.i_current_price
			> 1.2
				* (
						SELECT
							avg(j.i_current_price)
						FROM
							item AS j
						WHERE
							j.i_category = i.i_category
					)
	GROUP BY
		a.ca_state
	HAVING
		count(*) >= 10
	ORDER BY
		cnt, a.ca_state
	LIMIT
		100;
----
top-k
 ├── columns: state:9 cnt:170!null
 ├── internal-ordering: +170,+9
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (9)
 ├── fd: (9)-->(170)
 ├── ordering: +170,+9
 └── select
      ├── columns: ca_state:9 count_rows:170!null
      ├── immutable
      ├── key: (9)
      ├── fd: (9)-->(170)
      ├── group-by (hash)
      │    ├── columns: ca_state:9 count_rows:170!null
      │    ├── grouping columns: ca_state:9
      │    ├── immutable
      │    ├── key: (9)
      │    ├── fd: (9)-->(170)
      │    ├── inner-join (hash)
      │    │    ├── columns: ca_address_sk:1!null ca_state:9 c_customer_sk:16!null c_current_addr_sk:20!null ss_sold_date_sk:36!null ss_item_sk:38!null ss_customer_sk:39!null d.d_date_sk:61!null d.d_month_seq:64!null i.i_item_sk:91!null i.i_current_price:96!null date_dim.d_month_seq:118!null avg:169
      │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    ├── immutable
      │    │    ├── fd: ()-->(64,118), (1)-->(9), (16)-->(20), (91)-->(96,169), (64)==(118), (118)==(64), (36)==(61), (61)==(36), (38)==(91), (91)==(38), (16)==(39), (39)==(16), (1)==(20), (20)==(1)
      │    │    ├── scan customer_address [as=a]
      │    │    │    ├── columns: ca_address_sk:1!null ca_state:9
      │    │    │    ├── key: (1)
      │    │    │    └── fd: (1)-->(9)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: c_customer_sk:16!null c_current_addr_sk:20 ss_sold_date_sk:36!null ss_item_sk:38!null ss_customer_sk:39!null d.d_date_sk:61!null d.d_month_seq:64!null i.i_item_sk:91!null i.i_current_price:96!null date_dim.d_month_seq:118!null avg:169
      │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    │    ├── immutable
      │    │    │    ├── fd: ()-->(64,118), (16)-->(20), (91)-->(96,169), (64)==(118), (118)==(64), (36)==(61), (61)==(36), (38)==(91), (91)==(38), (16)==(39), (39)==(16)
      │    │    │    ├── scan customer [as=c]
      │    │    │    │    ├── columns: c_customer_sk:16!null c_current_addr_sk:20
      │    │    │    │    ├── key: (16)
      │    │    │    │    └── fd: (16)-->(20)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ss_sold_date_sk:36!null ss_item_sk:38!null ss_customer_sk:39 d.d_date_sk:61!null d.d_month_seq:64!null i.i_item_sk:91!null i.i_current_price:96!null date_dim.d_month_seq:118!null avg:169
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── immutable
      │    │    │    │    ├── fd: ()-->(64,118), (91)-->(96,169), (64)==(118), (118)==(64), (36)==(61), (61)==(36), (38)==(91), (91)==(38)
      │    │    │    │    ├── inner-join (lookup store_sales [as=s])
      │    │    │    │    │    ├── columns: ss_sold_date_sk:36 ss_item_sk:38!null ss_customer_sk:39 i.i_item_sk:91!null i.i_current_price:96!null avg:169
      │    │    │    │    │    ├── key columns: [91] = [38]
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── fd: (91)-->(96,169), (38)==(91), (91)==(38)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: i.i_item_sk:91!null i.i_current_price:96!null avg:169
      │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    ├── key: (91)
      │    │    │    │    │    │    ├── fd: (91)-->(96,169)
      │    │    │    │    │    │    ├── group-by (hash)
      │    │    │    │    │    │    │    ├── columns: i.i_item_sk:91!null i.i_current_price:96 avg:169
      │    │    │    │    │    │    │    ├── grouping columns: i.i_item_sk:91!null
      │    │    │    │    │    │    │    ├── key: (91)
      │    │    │    │    │    │    │    ├── fd: (91)-->(96,169)
      │    │    │    │    │    │    │    ├── left-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: i.i_item_sk:91!null i.i_current_price:96 i.i_category:103 j.i_current_price:150 j.i_category:157
      │    │    │    │    │    │    │    │    ├── fd: (91)-->(96,103)
      │    │    │    │    │    │    │    │    ├── scan item [as=i]
      │    │    │    │    │    │    │    │    │    ├── columns: i.i_item_sk:91!null i.i_current_price:96 i.i_category:103
      │    │    │    │    │    │    │    │    │    ├── key: (91)
      │    │    │    │    │    │    │    │    │    └── fd: (91)-->(96,103)
      │    │    │    │    │    │    │    │    ├── scan item [as=j]
      │    │    │    │    │    │    │    │    │    └── columns: j.i_current_price:150 j.i_category:157
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── j.i_category:157 = i.i_category:103 [outer=(103,157), constraints=(/103: (/NULL - ]; /157: (/NULL - ]), fd=(103)==(157), (157)==(103)]
      │    │    │    │    │    │    │    └── aggregations
      │    │    │    │    │    │    │         ├── avg [as=avg:169, outer=(150)]
      │    │    │    │    │    │    │         │    └── j.i_current_price:150
      │    │    │    │    │    │    │         └── const-agg [as=i.i_current_price:96, outer=(96)]
      │    │    │    │    │    │    │              └── i.i_current_price:96
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── i.i_current_price:96 > (avg:169 * 1.2) [outer=(96,169), immutable, constraints=(/96: (/NULL - ])]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: d.d_date_sk:61!null d.d_month_seq:64!null date_dim.d_month_seq:118!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    ├── fd: ()-->(64,118), (64)==(118), (118)==(64)
      │    │    │    │    │    ├── scan date_dim [as=d]
      │    │    │    │    │    │    ├── columns: d.d_date_sk:61!null d.d_month_seq:64
      │    │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    │    └── fd: (61)-->(64)
      │    │    │    │    │    ├── max1-row
      │    │    │    │    │    │    ├── columns: date_dim.d_month_seq:118
      │    │    │    │    │    │    ├── error: "more than one row returned by a subquery used as an expression"
      │    │    │    │    │    │    ├── cardinality: [0 - 1]
      │    │    │    │    │    │    ├── key: ()
      │    │    │    │    │    │    ├── fd: ()-->(118)
      │    │    │    │    │    │    └── distinct-on
      │    │    │    │    │    │         ├── columns: date_dim.d_month_seq:118
      │    │    │    │    │    │         ├── grouping columns: date_dim.d_month_seq:118
      │    │    │    │    │    │         ├── key: (118)
      │    │    │    │    │    │         └── select
      │    │    │    │    │    │              ├── columns: date_dim.d_month_seq:118 date_dim.d_year:121!null date_dim.d_moy:123!null
      │    │    │    │    │    │              ├── fd: ()-->(121,123)
      │    │    │    │    │    │              ├── scan date_dim
      │    │    │    │    │    │              │    └── columns: date_dim.d_month_seq:118 date_dim.d_year:121 date_dim.d_moy:123
      │    │    │    │    │    │              └── filters
      │    │    │    │    │    │                   ├── date_dim.d_year:121 = 2002 [outer=(121), constraints=(/121: [/2002 - /2002]; tight), fd=()-->(121)]
      │    │    │    │    │    │                   └── date_dim.d_moy:123 = 3 [outer=(123), constraints=(/123: [/3 - /3]; tight), fd=()-->(123)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── d.d_month_seq:64 = date_dim.d_month_seq:118 [outer=(64,118), constraints=(/64: (/NULL - ]; /118: (/NULL - ]), fd=(64)==(118), (118)==(64)]
      │    │    │    │    └── filters
      │    │    │    │         └── ss_sold_date_sk:36 = d.d_date_sk:61 [outer=(36,61), constraints=(/36: (/NULL - ]; /61: (/NULL - ]), fd=(36)==(61), (61)==(36)]
      │    │    │    └── filters
      │    │    │         └── c_customer_sk:16 = ss_customer_sk:39 [outer=(16,39), constraints=(/16: (/NULL - ]; /39: (/NULL - ]), fd=(16)==(39), (39)==(16)]
      │    │    └── filters
      │    │         └── ca_address_sk:1 = c_current_addr_sk:20 [outer=(1,20), constraints=(/1: (/NULL - ]; /20: (/NULL - ]), fd=(1)==(20), (20)==(1)]
      │    └── aggregations
      │         └── count-rows [as=count_rows:170]
      └── filters
           └── count_rows:170 >= 10 [outer=(170), constraints=(/170: [/10 - ]; tight)]

# --------------------------------------------------
# Q7
opt
	SELECT
		i_item_id,
		avg(ss_quantity) AS agg1,
		avg(ss_list_price) AS agg2,
		avg(ss_coupon_amt) AS agg3,
		avg(ss_sales_price) AS agg4
	FROM
		store_sales,
		customer_demographics,
		date_dim,
		item,
		promotion
	WHERE
		ss_sold_date_sk = d_date_sk
		AND ss_item_sk = i_item_sk
		AND ss_cdemo_sk = cd_demo_sk
		AND ss_promo_sk = p_promo_sk
		AND cd_gender = 'F'
		AND cd_marital_status = 'W'
		AND cd_education_status = 'College'
		AND (p_channel_email = 'N' OR p_channel_event = 'N')
		AND d_year = 2001
	GROUP BY
		i_item_id
	ORDER BY
		i_item_id
	LIMIT
		100;
----
limit
 ├── columns: i_item_id:68!null agg1:112 agg2:113 agg3:114 agg4:115
 ├── internal-ordering: +68
 ├── cardinality: [0 - 100]
 ├── key: (68)
 ├── fd: (68)-->(112-115)
 ├── ordering: +68
 ├── group-by (streaming)
 │    ├── columns: i_item_id:68!null avg:112 avg:113 avg:114 avg:115
 │    ├── grouping columns: i_item_id:68!null
 │    ├── key: (68)
 │    ├── fd: (68)-->(112-115)
 │    ├── ordering: +68
 │    ├── limit hint: 100.00
 │    ├── inner-join (lookup date_dim)
 │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_cdemo_sk:5!null ss_promo_sk:9!null ss_quantity:11 ss_list_price:13 ss_sales_price:14 ss_coupon_amt:20 cd_demo_sk:26!null cd_gender:27!null cd_marital_status:28!null cd_education_status:29!null d_date_sk:37!null d_year:43!null i_item_sk:67!null i_item_id:68!null p_promo_sk:91!null p_channel_email:100 p_channel_event:105
 │    │    ├── key columns: [1] = [37]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(27-29,43), (67)-->(68), (91)-->(100,105), (5)==(26), (26)==(5), (1)==(37), (37)==(1), (3)==(67), (67)==(3), (9)==(91), (91)==(9)
 │    │    ├── ordering: +68 opt(27-29,43) [actual: +68]
 │    │    ├── limit hint: 252.15
 │    │    ├── inner-join (lookup promotion)
 │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_cdemo_sk:5!null ss_promo_sk:9!null ss_quantity:11 ss_list_price:13 ss_sales_price:14 ss_coupon_amt:20 cd_demo_sk:26!null cd_gender:27!null cd_marital_status:28!null cd_education_status:29!null i_item_sk:67!null i_item_id:68!null p_promo_sk:91!null p_channel_email:100 p_channel_event:105
 │    │    │    ├── key columns: [9] = [91]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── fd: ()-->(27-29), (67)-->(68), (91)-->(100,105), (9)==(91), (91)==(9), (3)==(67), (67)==(3), (5)==(26), (26)==(5)
 │    │    │    ├── ordering: +68 opt(27-29) [actual: +68]
 │    │    │    ├── limit hint: 1400.00
 │    │    │    ├── inner-join (lookup customer_demographics)
 │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_cdemo_sk:5!null ss_promo_sk:9 ss_quantity:11 ss_list_price:13 ss_sales_price:14 ss_coupon_amt:20 cd_demo_sk:26!null cd_gender:27!null cd_marital_status:28!null cd_education_status:29!null i_item_sk:67!null i_item_id:68!null
 │    │    │    │    ├── key columns: [5] = [26]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── fd: ()-->(27-29), (67)-->(68), (3)==(67), (67)==(3), (5)==(26), (26)==(5)
 │    │    │    │    ├── ordering: +68 opt(27-29) [actual: +68]
 │    │    │    │    ├── limit hint: 1500.00
 │    │    │    │    ├── inner-join (lookup store_sales)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_cdemo_sk:5 ss_promo_sk:9 ss_quantity:11 ss_list_price:13 ss_sales_price:14 ss_coupon_amt:20 i_item_sk:67!null i_item_id:68!null
 │    │    │    │    │    ├── key columns: [67] = [3]
 │    │    │    │    │    ├── fd: (67)-->(68), (3)==(67), (67)==(3)
 │    │    │    │    │    ├── ordering: +68
 │    │    │    │    │    ├── limit hint: 78300.00
 │    │    │    │    │    ├── sort
 │    │    │    │    │    │    ├── columns: i_item_sk:67!null i_item_id:68!null
 │    │    │    │    │    │    ├── key: (67)
 │    │    │    │    │    │    ├── fd: (67)-->(68)
 │    │    │    │    │    │    ├── ordering: +68
 │    │    │    │    │    │    ├── limit hint: 300.00
 │    │    │    │    │    │    └── scan item
 │    │    │    │    │    │         ├── columns: i_item_sk:67!null i_item_id:68!null
 │    │    │    │    │    │         ├── key: (67)
 │    │    │    │    │    │         └── fd: (67)-->(68)
 │    │    │    │    │    └── filters (true)
 │    │    │    │    └── filters
 │    │    │    │         ├── cd_gender:27 = 'F' [outer=(27), constraints=(/27: [/'F' - /'F']; tight), fd=()-->(27)]
 │    │    │    │         ├── cd_marital_status:28 = 'W' [outer=(28), constraints=(/28: [/'W' - /'W']; tight), fd=()-->(28)]
 │    │    │    │         └── cd_education_status:29 = 'College' [outer=(29), constraints=(/29: [/'College' - /'College']; tight), fd=()-->(29)]
 │    │    │    └── filters
 │    │    │         └── (p_channel_email:100 = 'N') OR (p_channel_event:105 = 'N') [outer=(100,105)]
 │    │    └── filters
 │    │         └── d_year:43 = 2001 [outer=(43), constraints=(/43: [/2001 - /2001]; tight), fd=()-->(43)]
 │    └── aggregations
 │         ├── avg [as=avg:112, outer=(11)]
 │         │    └── ss_quantity:11
 │         ├── avg [as=avg:113, outer=(13)]
 │         │    └── ss_list_price:13
 │         ├── avg [as=avg:114, outer=(20)]
 │         │    └── ss_coupon_amt:20
 │         └── avg [as=avg:115, outer=(14)]
 │              └── ss_sales_price:14
 └── 100

# --------------------------------------------------
# Q8
opt
	SELECT
		s_store_name, sum(ss_net_profit)
	FROM
		store_sales,
		date_dim,
		store,
		(
			SELECT
				ca_zip
			FROM
				(
					SELECT
						substr(ca_zip, 1, 5) AS ca_zip
					FROM
						customer_address
					WHERE
						substr(ca_zip, 1, 5)
						IN (
								'47602',
								'16704',
								'35863',
								'28577',
								'83910',
								'36201',
								'58412',
								'48162',
								'28055',
								'41419',
								'80332',
								'38607',
								'77817',
								'24891',
								'16226',
								'18410',
								'21231',
								'59345',
								'13918',
								'51089',
								'20317',
								'17167',
								'54585',
								'67881',
								'78366',
								'47770',
								'18360',
								'51717',
								'73108',
								'14440',
								'21800',
								'89338',
								'45859',
								'65501',
								'34948',
								'25973',
								'73219',
								'25333',
								'17291',
								'10374',
								'18829',
								'60736',
								'82620',
								'41351',
								'52094',
								'19326',
								'25214',
								'54207',
								'40936',
								'21814',
								'79077',
								'25178',
								'75742',
								'77454',
								'30621',
								'89193',
								'27369',
								'41232',
								'48567',
								'83041',
								'71948',
								'37119',
								'68341',
								'14073',
								'16891',
								'62878',
								'49130',
								'19833',
								'24286',
								'27700',
								'40979',
								'50412',
								'81504',
								'94835',
								'84844',
								'71954',
								'39503',
								'57649',
								'18434',
								'24987',
								'12350',
								'86379',
								'27413',
								'44529',
								'98569',
								'16515',
								'27287',
								'24255',
								'21094',
								'16005',
								'56436',
								'91110',
								'68293',
								'56455',
								'54558',
								'10298',
								'83647',
								'32754',
								'27052',
								'51766',
								'19444',
								'13869',
								'45645',
								'94791',
								'57631',
								'20712',
								'37788',
								'41807',
								'46507',
								'21727',
								'71836',
								'81070',
								'50632',
								'88086',
								'63991',
								'20244',
								'31655',
								'51782',
								'29818',
								'63792',
								'68605',
								'94898',
								'36430',
								'57025',
								'20601',
								'82080',
								'33869',
								'22728',
								'35834',
								'29086',
								'92645',
								'98584',
								'98072',
								'11652',
								'78093',
								'57553',
								'43830',
								'71144',
								'53565',
								'18700',
								'90209',
								'71256',
								'38353',
								'54364',
								'28571',
								'96560',
								'57839',
								'56355',
								'50679',
								'45266',
								'84680',
								'34306',
								'34972',
								'48530',
								'30106',
								'15371',
								'92380',
								'84247',
								'92292',
								'68852',
								'13338',
								'34594',
								'82602',
								'70073',
								'98069',
								'85066',
								'47289',
								'11686',
								'98862',
								'26217',
								'47529',
								'63294',
								'51793',
								'35926',
								'24227',
								'14196',
								'24594',
								'32489',
								'99060',
								'49472',
								'43432',
								'49211',
								'14312',
								'88137',
								'47369',
								'56877',
								'20534',
								'81755',
								'15794',
								'12318',
								'21060',
								'73134',
								'41255',
								'63073',
								'81003',
								'73873',
								'66057',
								'51184',
								'51195',
								'45676',
								'92696',
								'70450',
								'90669',
								'98338',
								'25264',
								'38919',
								'59226',
								'58581',
								'60298',
								'17895',
								'19489',
								'52301',
								'80846',
								'95464',
								'68770',
								'51634',
								'19988',
								'18367',
								'18421',
								'11618',
								'67975',
								'25494',
								'41352',
								'95430',
								'15734',
								'62585',
								'97173',
								'33773',
								'10425',
								'75675',
								'53535',
								'17879',
								'41967',
								'12197',
								'67998',
								'79658',
								'59130',
								'72592',
								'14851',
								'43933',
								'68101',
								'50636',
								'25717',
								'71286',
								'24660',
								'58058',
								'72991',
								'95042',
								'15543',
								'33122',
								'69280',
								'11912',
								'59386',
								'27642',
								'65177',
								'17672',
								'33467',
								'64592',
								'36335',
								'54010',
								'18767',
								'63193',
								'42361',
								'49254',
								'33113',
								'33159',
								'36479',
								'59080',
								'11855',
								'81963',
								'31016',
								'49140',
								'29392',
								'41836',
								'32958',
								'53163',
								'13844',
								'73146',
								'23952',
								'65148',
								'93498',
								'14530',
								'46131',
								'58454',
								'13376',
								'13378',
								'83986',
								'12320',
								'17193',
								'59852',
								'46081',
								'98533',
								'52389',
								'13086',
								'68843',
								'31013',
								'13261',
								'60560',
								'13443',
								'45533',
								'83583',
								'11489',
								'58218',
								'19753',
								'22911',
								'25115',
								'86709',
								'27156',
								'32669',
								'13123',
								'51933',
								'39214',
								'41331',
								'66943',
								'14155',
								'69998',
								'49101',
								'70070',
								'35076',
								'14242',
								'73021',
								'59494',
								'15782',
								'29752',
								'37914',
								'74686',
								'83086',
								'34473',
								'15751',
								'81084',
								'49230',
								'91894',
								'60624',
								'17819',
								'28810',
								'63180',
								'56224',
								'39459',
								'55233',
								'75752',
								'43639',
								'55349',
								'86057',
								'62361',
								'50788',
								'31830',
								'58062',
								'18218',
								'85761',
								'60083',
								'45484',
								'21204',
								'90229',
								'70041',
								'41162',
								'35390',
								'16364',
								'39500',
								'68908',
								'26689',
								'52868',
								'81335',
								'40146',
								'11340',
								'61527',
								'61794',
								'71997',
								'30415',
								'59004',
								'29450',
								'58117',
								'69952',
								'33562',
								'83833',
								'27385',
								'61860',
								'96435',
								'48333',
								'23065',
								'32961',
								'84919',
								'61997',
								'99132',
								'22815',
								'56600',
								'68730',
								'48017',
								'95694',
								'32919',
								'88217',
								'27116',
								'28239',
								'58032',
								'18884',
								'16791',
								'21343',
								'97462',
								'18569',
								'75660',
								'15475'
							)
					INTERSECT
						SELECT
							ca_zip
						FROM
							(
								SELECT
									substr(ca_zip, 1, 5)
										AS ca_zip,
									count(*) AS cnt
								FROM
									customer_address, customer
								WHERE
									ca_address_sk
									= c_current_addr_sk
									AND c_preferred_cust_flag
										= 'Y'
								GROUP BY
									ca_zip
								HAVING
									count(*) > 10
							)
								AS a1
				)
					AS a2
		)
			AS v1
	WHERE
		ss_store_sk = s_store_sk
		AND ss_sold_date_sk = d_date_sk
		AND d_qoy = 2
		AND d_year = 1998
		AND substr(s_zip, 1, 2) = substr(v1.ca_zip, 1, 2)
	GROUP BY
		s_store_name
	ORDER BY
		s_store_name
	LIMIT
		100;
----
top-k
 ├── columns: s_store_name:61 sum:142
 ├── internal-ordering: +61
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (61)
 ├── fd: (61)-->(142)
 ├── ordering: +61
 └── group-by (hash)
      ├── columns: s_store_name:61 sum:142
      ├── grouping columns: s_store_name:61
      ├── immutable
      ├── key: (61)
      ├── fd: (61)-->(142)
      ├── inner-join (hash)
      │    ├── columns: ss_sold_date_sk:1!null ss_store_sk:8!null ss_net_profit:23 d_date_sk:26!null d_year:32!null d_qoy:36!null s_store_sk:56!null s_store_name:61 column140:140!null column141:141!null
      │    ├── immutable
      │    ├── fd: ()-->(32,36), (56)-->(61,140), (1)==(26), (26)==(1), (140)==(141), (141)==(140), (8)==(56), (56)==(8)
      │    ├── inner-join (hash)
      │    │    ├── columns: ss_sold_date_sk:1!null ss_store_sk:8 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_qoy:36!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(32,36), (1)==(26), (26)==(1)
      │    │    ├── scan store_sales
      │    │    │    └── columns: ss_sold_date_sk:1 ss_store_sk:8 ss_net_profit:23
      │    │    ├── select
      │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_qoy:36!null
      │    │    │    ├── key: (26)
      │    │    │    ├── fd: ()-->(32,36)
      │    │    │    ├── scan date_dim
      │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_qoy:36
      │    │    │    │    ├── key: (26)
      │    │    │    │    └── fd: (26)-->(32,36)
      │    │    │    └── filters
      │    │    │         ├── d_qoy:36 = 2 [outer=(36), constraints=(/36: [/2 - /2]; tight), fd=()-->(36)]
      │    │    │         └── d_year:32 = 1998 [outer=(32), constraints=(/32: [/1998 - /1998]; tight), fd=()-->(32)]
      │    │    └── filters
      │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    ├── inner-join (hash)
      │    │    ├── columns: s_store_sk:56!null s_store_name:61 column140:140!null column141:141!null
      │    │    ├── immutable
      │    │    ├── fd: (56)-->(61,140), (140)==(141), (141)==(140)
      │    │    ├── project
      │    │    │    ├── columns: column141:141
      │    │    │    ├── immutable
      │    │    │    ├── intersect
      │    │    │    │    ├── columns: ca_zip:102
      │    │    │    │    ├── left columns: ca_zip:102
      │    │    │    │    ├── right columns: ca_zip:139
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (102)
      │    │    │    │    ├── project
      │    │    │    │    │    ├── columns: ca_zip:102
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: customer_address.ca_zip:96
      │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    ├── scan customer_address
      │    │    │    │    │    │    │    └── columns: customer_address.ca_zip:96
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── substr(customer_address.ca_zip:96, 1, 5) IN ('10298', '10374', '10425', '11340', '11489', '11618', '11652', '11686', '11855', '11912', '12197', '12318', '12320', '12350', '13086', '13123', '13261', '13338', '13376', '13378', '13443', '13844', '13869', '13918', '14073', '14155', '14196', '14242', '14312', '14440', '14530', '14851', '15371', '15475', '15543', '15734', '15751', '15782', '15794', '16005', '16226', '16364', '16515', '16704', '16791', '16891', '17167', '17193', '17291', '17672', '17819', '17879', '17895', '18218', '18360', '18367', '18410', '18421', '18434', '18569', '18700', '18767', '18829', '18884', '19326', '19444', '19489', '19753', '19833', '19988', '20244', '20317', '20534', '20601', '20712', '21060', '21094', '21204', '21231', '21343', '21727', '21800', '21814', '22728', '22815', '22911', '23065', '23952', '24227', '24255', '24286', '24594', '24660', '24891', '24987', '25115', '25178', '25214', '25264', '25333', '25494', '25717', '25973', '26217', '26689', '27052', '27116', '27156', '27287', '27369', '27385', '27413', '27642', '27700', '28055', '28239', '28571', '28577', '28810', '29086', '29392', '29450', '29752', '29818', '30106', '30415', '30621', '31013', '31016', '31655', '31830', '32489', '32669', '32754', '32919', '32958', '32961', '33113', '33122', '33159', '33467', '33562', '33773', '33869', '34306', '34473', '34594', '34948', '34972', '35076', '35390', '35834', '35863', '35926', '36201', '36335', '36430', '36479', '37119', '37788', '37914', '38353', '38607', '38919', '39214', '39459', '39500', '39503', '40146', '40936', '40979', '41162', '41232', '41255', '41331', '41351', '41352', '41419', '41807', '41836', '41967', '42361', '43432', '43639', '43830', '43933', '44529', '45266', '45484', '45533', '45645', '45676', '45859', '46081', '46131', '46507', '47289', '47369', '47529', '47602', '47770', '48017', '48162', '48333', '48530', '48567', '49101', '49130', '49140', '49211', '49230', '49254', '49472', '50412', '50632', '50636', '50679', '50788', '51089', '51184', '51195', '51634', '51717', '51766', '51782', '51793', '51933', '52094', '52301', '52389', '52868', '53163', '53535', '53565', '54010', '54207', '54364', '54558', '54585', '55233', '55349', '56224', '56355', '56436', '56455', '56600', '56877', '57025', '57553', '57631', '57649', '57839', '58032', '58058', '58062', '58117', '58218', '58412', '58454', '58581', '59004', '59080', '59130', '59226', '59345', '59386', '59494', '59852', '60083', '60298', '60560', '60624', '60736', '61527', '61794', '61860', '61997', '62361', '62585', '62878', '63073', '63180', '63193', '63294', '63792', '63991', '64592', '65148', '65177', '65501', '66057', '66943', '67881', '67975', '67998', '68101', '68293', '68341', '68605', '68730', '68770', '68843', '68852', '68908', '69280', '69952', '69998', '70041', '70070', '70073', '70450', '71144', '71256', '71286', '71836', '71948', '71954', '71997', '72592', '72991', '73021', '73108', '73134', '73146', '73219', '73873', '74686', '75660', '75675', '75742', '75752', '77454', '77817', '78093', '78366', '79077', '79658', '80332', '80846', '81003', '81070', '81084', '81335', '81504', '81755', '81963', '82080', '82602', '82620', '83041', '83086', '83583', '83647', '83833', '83910', '83986', '84247', '84680', '84844', '84919', '85066', '85761', '86057', '86379', '86709', '88086', '88137', '88217', '89193', '89338', '90209', '90229', '90669', '91110', '91894', '92292', '92380', '92645', '92696', '93498', '94791', '94835', '94898', '95042', '95430', '95464', '95694', '96435', '96560', '97173', '97462', '98069', '98072', '98338', '98533', '98569', '98584', '98862', '99060', '99132') [outer=(96), immutable]
      │    │    │    │    │    └── projections
      │    │    │    │    │         └── substr(customer_address.ca_zip:96, 1, 5) [as=ca_zip:102, outer=(96), immutable]
      │    │    │    │    └── project
      │    │    │    │         ├── columns: ca_zip:139
      │    │    │    │         ├── immutable
      │    │    │    │         ├── select
      │    │    │    │         │    ├── columns: customer_address.ca_zip:112 count_rows:138!null
      │    │    │    │         │    ├── key: (112)
      │    │    │    │         │    ├── fd: (112)-->(138)
      │    │    │    │         │    ├── group-by (hash)
      │    │    │    │         │    │    ├── columns: customer_address.ca_zip:112 count_rows:138!null
      │    │    │    │         │    │    ├── grouping columns: customer_address.ca_zip:112
      │    │    │    │         │    │    ├── key: (112)
      │    │    │    │         │    │    ├── fd: (112)-->(138)
      │    │    │    │         │    │    ├── inner-join (hash)
      │    │    │    │         │    │    │    ├── columns: ca_address_sk:103!null customer_address.ca_zip:112 c_current_addr_sk:122!null c_preferred_cust_flag:128!null
      │    │    │    │         │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    │    │         │    │    │    ├── fd: ()-->(128), (103)-->(112), (103)==(122), (122)==(103)
      │    │    │    │         │    │    │    ├── scan customer_address
      │    │    │    │         │    │    │    │    ├── columns: ca_address_sk:103!null customer_address.ca_zip:112
      │    │    │    │         │    │    │    │    ├── key: (103)
      │    │    │    │         │    │    │    │    └── fd: (103)-->(112)
      │    │    │    │         │    │    │    ├── select
      │    │    │    │         │    │    │    │    ├── columns: c_current_addr_sk:122 c_preferred_cust_flag:128!null
      │    │    │    │         │    │    │    │    ├── fd: ()-->(128)
      │    │    │    │         │    │    │    │    ├── scan customer
      │    │    │    │         │    │    │    │    │    └── columns: c_current_addr_sk:122 c_preferred_cust_flag:128
      │    │    │    │         │    │    │    │    └── filters
      │    │    │    │         │    │    │    │         └── c_preferred_cust_flag:128 = 'Y' [outer=(128), constraints=(/128: [/'Y' - /'Y']; tight), fd=()-->(128)]
      │    │    │    │         │    │    │    └── filters
      │    │    │    │         │    │    │         └── ca_address_sk:103 = c_current_addr_sk:122 [outer=(103,122), constraints=(/103: (/NULL - ]; /122: (/NULL - ]), fd=(103)==(122), (122)==(103)]
      │    │    │    │         │    │    └── aggregations
      │    │    │    │         │    │         └── count-rows [as=count_rows:138]
      │    │    │    │         │    └── filters
      │    │    │    │         │         └── count_rows:138 > 10 [outer=(138), constraints=(/138: [/11 - ]; tight)]
      │    │    │    │         └── projections
      │    │    │    │              └── substr(customer_address.ca_zip:112, 1, 5) [as=ca_zip:139, outer=(112), immutable]
      │    │    │    └── projections
      │    │    │         └── substr(ca_zip:102, 1, 2) [as=column141:141, outer=(102), immutable]
      │    │    ├── project
      │    │    │    ├── columns: column140:140 s_store_sk:56!null s_store_name:61
      │    │    │    ├── immutable
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: (56)-->(61,140)
      │    │    │    ├── scan store
      │    │    │    │    ├── columns: s_store_sk:56!null s_store_name:61 s_zip:81
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(61,81)
      │    │    │    └── projections
      │    │    │         └── substr(s_zip:81, 1, 2) [as=column140:140, outer=(81), immutable]
      │    │    └── filters
      │    │         └── column140:140 = column141:141 [outer=(140,141), constraints=(/140: (/NULL - ]; /141: (/NULL - ]), fd=(140)==(141), (141)==(140)]
      │    └── filters
      │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
      └── aggregations
           └── sum [as=sum:142, outer=(23)]
                └── ss_net_profit:23

# --------------------------------------------------
# Q9
opt
	SELECT
		CASE
		WHEN (
			SELECT
				count(*)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 1 AND 20
		)
		> 1071
		THEN (
			SELECT
				avg(ss_ext_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 1 AND 20
		)
		ELSE (
			SELECT
				avg(ss_net_paid_inc_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 1 AND 20
		)
		END
			AS bucket1,
		CASE
		WHEN (
			SELECT
				count(*)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 21 AND 40
		)
		> 39161
		THEN (
			SELECT
				avg(ss_ext_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 21 AND 40
		)
		ELSE (
			SELECT
				avg(ss_net_paid_inc_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 21 AND 40
		)
		END
			AS bucket2,
		CASE
		WHEN (
			SELECT
				count(*)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 41 AND 60
		)
		> 29434
		THEN (
			SELECT
				avg(ss_ext_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 41 AND 60
		)
		ELSE (
			SELECT
				avg(ss_net_paid_inc_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 41 AND 60
		)
		END
			AS bucket3,
		CASE
		WHEN (
			SELECT
				count(*)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 61 AND 80
		)
		> 6568
		THEN (
			SELECT
				avg(ss_ext_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 61 AND 80
		)
		ELSE (
			SELECT
				avg(ss_net_paid_inc_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 61 AND 80
		)
		END
			AS bucket4,
		CASE
		WHEN (
			SELECT
				count(*)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 81 AND 100
		)
		> 21216
		THEN (
			SELECT
				avg(ss_ext_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 81 AND 100
		)
		ELSE (
			SELECT
				avg(ss_net_paid_inc_tax)
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 81 AND 100
		)
		END
			AS bucket5
	FROM
		reason
	WHERE
		r_reason_sk = 1;
----
project
 ├── columns: bucket1:396 bucket2:397 bucket3:398 bucket4:399 bucket5:400
 ├── cardinality: [0 - 1]
 ├── key: ()
 ├── fd: ()-->(396-400)
 ├── scan reason
 │    ├── columns: r_reason_sk:1!null
 │    ├── constraint: /1: [/1 - /1]
 │    ├── cardinality: [0 - 1]
 │    ├── key: ()
 │    └── fd: ()-->(1)
 └── projections
      ├── case [as=bucket1:396, subquery]
      │    ├── true
      │    ├── when
      │    │    ├── gt
      │    │    │    ├── subquery
      │    │    │    │    └── scalar-group-by
      │    │    │    │         ├── columns: count_rows:31!null
      │    │    │    │         ├── cardinality: [1 - 1]
      │    │    │    │         ├── key: ()
      │    │    │    │         ├── fd: ()-->(31)
      │    │    │    │         ├── select
      │    │    │    │         │    ├── columns: ss_quantity:16!null
      │    │    │    │         │    ├── scan store_sales
      │    │    │    │         │    │    └── columns: ss_quantity:16
      │    │    │    │         │    └── filters
      │    │    │    │         │         └── (ss_quantity:16 >= 1) AND (ss_quantity:16 <= 20) [outer=(16), constraints=(/16: [/1 - /20]; tight)]
      │    │    │    │         └── aggregations
      │    │    │    │              └── count-rows [as=count_rows:31]
      │    │    │    └── 1071
      │    │    └── subquery
      │    │         └── scalar-group-by
      │    │              ├── columns: avg:83
      │    │              ├── cardinality: [1 - 1]
      │    │              ├── key: ()
      │    │              ├── fd: ()-->(83)
      │    │              ├── select
      │    │              │    ├── columns: ss_quantity:68!null ss_ext_tax:76
      │    │              │    ├── scan store_sales
      │    │              │    │    └── columns: ss_quantity:68 ss_ext_tax:76
      │    │              │    └── filters
      │    │              │         └── (ss_quantity:68 >= 1) AND (ss_quantity:68 <= 20) [outer=(68), constraints=(/68: [/1 - /20]; tight)]
      │    │              └── aggregations
      │    │                   └── avg [as=avg:83, outer=(76)]
      │    │                        └── ss_ext_tax:76
      │    └── subquery
      │         └── scalar-group-by
      │              ├── columns: avg:57
      │              ├── cardinality: [1 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(57)
      │              ├── select
      │              │    ├── columns: ss_quantity:42!null ss_net_paid_inc_tax:53
      │              │    ├── scan store_sales
      │              │    │    └── columns: ss_quantity:42 ss_net_paid_inc_tax:53
      │              │    └── filters
      │              │         └── (ss_quantity:42 >= 1) AND (ss_quantity:42 <= 20) [outer=(42), constraints=(/42: [/1 - /20]; tight)]
      │              └── aggregations
      │                   └── avg [as=avg:57, outer=(53)]
      │                        └── ss_net_paid_inc_tax:53
      ├── case [as=bucket2:397, subquery]
      │    ├── true
      │    ├── when
      │    │    ├── gt
      │    │    │    ├── subquery
      │    │    │    │    └── scalar-group-by
      │    │    │    │         ├── columns: count_rows:109!null
      │    │    │    │         ├── cardinality: [1 - 1]
      │    │    │    │         ├── key: ()
      │    │    │    │         ├── fd: ()-->(109)
      │    │    │    │         ├── select
      │    │    │    │         │    ├── columns: ss_quantity:94!null
      │    │    │    │         │    ├── scan store_sales
      │    │    │    │         │    │    └── columns: ss_quantity:94
      │    │    │    │         │    └── filters
      │    │    │    │         │         └── (ss_quantity:94 >= 21) AND (ss_quantity:94 <= 40) [outer=(94), constraints=(/94: [/21 - /40]; tight)]
      │    │    │    │         └── aggregations
      │    │    │    │              └── count-rows [as=count_rows:109]
      │    │    │    └── 39161
      │    │    └── subquery
      │    │         └── scalar-group-by
      │    │              ├── columns: avg:161
      │    │              ├── cardinality: [1 - 1]
      │    │              ├── key: ()
      │    │              ├── fd: ()-->(161)
      │    │              ├── select
      │    │              │    ├── columns: ss_quantity:146!null ss_ext_tax:154
      │    │              │    ├── scan store_sales
      │    │              │    │    └── columns: ss_quantity:146 ss_ext_tax:154
      │    │              │    └── filters
      │    │              │         └── (ss_quantity:146 >= 21) AND (ss_quantity:146 <= 40) [outer=(146), constraints=(/146: [/21 - /40]; tight)]
      │    │              └── aggregations
      │    │                   └── avg [as=avg:161, outer=(154)]
      │    │                        └── ss_ext_tax:154
      │    └── subquery
      │         └── scalar-group-by
      │              ├── columns: avg:135
      │              ├── cardinality: [1 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(135)
      │              ├── select
      │              │    ├── columns: ss_quantity:120!null ss_net_paid_inc_tax:131
      │              │    ├── scan store_sales
      │              │    │    └── columns: ss_quantity:120 ss_net_paid_inc_tax:131
      │              │    └── filters
      │              │         └── (ss_quantity:120 >= 21) AND (ss_quantity:120 <= 40) [outer=(120), constraints=(/120: [/21 - /40]; tight)]
      │              └── aggregations
      │                   └── avg [as=avg:135, outer=(131)]
      │                        └── ss_net_paid_inc_tax:131
      ├── case [as=bucket3:398, subquery]
      │    ├── true
      │    ├── when
      │    │    ├── gt
      │    │    │    ├── subquery
      │    │    │    │    └── scalar-group-by
      │    │    │    │         ├── columns: count_rows:187!null
      │    │    │    │         ├── cardinality: [1 - 1]
      │    │    │    │         ├── key: ()
      │    │    │    │         ├── fd: ()-->(187)
      │    │    │    │         ├── select
      │    │    │    │         │    ├── columns: ss_quantity:172!null
      │    │    │    │         │    ├── scan store_sales
      │    │    │    │         │    │    └── columns: ss_quantity:172
      │    │    │    │         │    └── filters
      │    │    │    │         │         └── (ss_quantity:172 >= 41) AND (ss_quantity:172 <= 60) [outer=(172), constraints=(/172: [/41 - /60]; tight)]
      │    │    │    │         └── aggregations
      │    │    │    │              └── count-rows [as=count_rows:187]
      │    │    │    └── 29434
      │    │    └── subquery
      │    │         └── scalar-group-by
      │    │              ├── columns: avg:239
      │    │              ├── cardinality: [1 - 1]
      │    │              ├── key: ()
      │    │              ├── fd: ()-->(239)
      │    │              ├── select
      │    │              │    ├── columns: ss_quantity:224!null ss_ext_tax:232
      │    │              │    ├── scan store_sales
      │    │              │    │    └── columns: ss_quantity:224 ss_ext_tax:232
      │    │              │    └── filters
      │    │              │         └── (ss_quantity:224 >= 41) AND (ss_quantity:224 <= 60) [outer=(224), constraints=(/224: [/41 - /60]; tight)]
      │    │              └── aggregations
      │    │                   └── avg [as=avg:239, outer=(232)]
      │    │                        └── ss_ext_tax:232
      │    └── subquery
      │         └── scalar-group-by
      │              ├── columns: avg:213
      │              ├── cardinality: [1 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(213)
      │              ├── select
      │              │    ├── columns: ss_quantity:198!null ss_net_paid_inc_tax:209
      │              │    ├── scan store_sales
      │              │    │    └── columns: ss_quantity:198 ss_net_paid_inc_tax:209
      │              │    └── filters
      │              │         └── (ss_quantity:198 >= 41) AND (ss_quantity:198 <= 60) [outer=(198), constraints=(/198: [/41 - /60]; tight)]
      │              └── aggregations
      │                   └── avg [as=avg:213, outer=(209)]
      │                        └── ss_net_paid_inc_tax:209
      ├── case [as=bucket4:399, subquery]
      │    ├── true
      │    ├── when
      │    │    ├── gt
      │    │    │    ├── subquery
      │    │    │    │    └── scalar-group-by
      │    │    │    │         ├── columns: count_rows:265!null
      │    │    │    │         ├── cardinality: [1 - 1]
      │    │    │    │         ├── key: ()
      │    │    │    │         ├── fd: ()-->(265)
      │    │    │    │         ├── select
      │    │    │    │         │    ├── columns: ss_quantity:250!null
      │    │    │    │         │    ├── scan store_sales
      │    │    │    │         │    │    └── columns: ss_quantity:250
      │    │    │    │         │    └── filters
      │    │    │    │         │         └── (ss_quantity:250 >= 61) AND (ss_quantity:250 <= 80) [outer=(250), constraints=(/250: [/61 - /80]; tight)]
      │    │    │    │         └── aggregations
      │    │    │    │              └── count-rows [as=count_rows:265]
      │    │    │    └── 6568
      │    │    └── subquery
      │    │         └── scalar-group-by
      │    │              ├── columns: avg:317
      │    │              ├── cardinality: [1 - 1]
      │    │              ├── key: ()
      │    │              ├── fd: ()-->(317)
      │    │              ├── select
      │    │              │    ├── columns: ss_quantity:302!null ss_ext_tax:310
      │    │              │    ├── scan store_sales
      │    │              │    │    └── columns: ss_quantity:302 ss_ext_tax:310
      │    │              │    └── filters
      │    │              │         └── (ss_quantity:302 >= 61) AND (ss_quantity:302 <= 80) [outer=(302), constraints=(/302: [/61 - /80]; tight)]
      │    │              └── aggregations
      │    │                   └── avg [as=avg:317, outer=(310)]
      │    │                        └── ss_ext_tax:310
      │    └── subquery
      │         └── scalar-group-by
      │              ├── columns: avg:291
      │              ├── cardinality: [1 - 1]
      │              ├── key: ()
      │              ├── fd: ()-->(291)
      │              ├── select
      │              │    ├── columns: ss_quantity:276!null ss_net_paid_inc_tax:287
      │              │    ├── scan store_sales
      │              │    │    └── columns: ss_quantity:276 ss_net_paid_inc_tax:287
      │              │    └── filters
      │              │         └── (ss_quantity:276 >= 61) AND (ss_quantity:276 <= 80) [outer=(276), constraints=(/276: [/61 - /80]; tight)]
      │              └── aggregations
      │                   └── avg [as=avg:291, outer=(287)]
      │                        └── ss_net_paid_inc_tax:287
      └── case [as=bucket5:400, subquery]
           ├── true
           ├── when
           │    ├── gt
           │    │    ├── subquery
           │    │    │    └── scalar-group-by
           │    │    │         ├── columns: count_rows:343!null
           │    │    │         ├── cardinality: [1 - 1]
           │    │    │         ├── key: ()
           │    │    │         ├── fd: ()-->(343)
           │    │    │         ├── select
           │    │    │         │    ├── columns: ss_quantity:328!null
           │    │    │         │    ├── scan store_sales
           │    │    │         │    │    └── columns: ss_quantity:328
           │    │    │         │    └── filters
           │    │    │         │         └── (ss_quantity:328 >= 81) AND (ss_quantity:328 <= 100) [outer=(328), constraints=(/328: [/81 - /100]; tight)]
           │    │    │         └── aggregations
           │    │    │              └── count-rows [as=count_rows:343]
           │    │    └── 21216
           │    └── subquery
           │         └── scalar-group-by
           │              ├── columns: avg:395
           │              ├── cardinality: [1 - 1]
           │              ├── key: ()
           │              ├── fd: ()-->(395)
           │              ├── select
           │              │    ├── columns: ss_quantity:380!null ss_ext_tax:388
           │              │    ├── scan store_sales
           │              │    │    └── columns: ss_quantity:380 ss_ext_tax:388
           │              │    └── filters
           │              │         └── (ss_quantity:380 >= 81) AND (ss_quantity:380 <= 100) [outer=(380), constraints=(/380: [/81 - /100]; tight)]
           │              └── aggregations
           │                   └── avg [as=avg:395, outer=(388)]
           │                        └── ss_ext_tax:388
           └── subquery
                └── scalar-group-by
                     ├── columns: avg:369
                     ├── cardinality: [1 - 1]
                     ├── key: ()
                     ├── fd: ()-->(369)
                     ├── select
                     │    ├── columns: ss_quantity:354!null ss_net_paid_inc_tax:365
                     │    ├── scan store_sales
                     │    │    └── columns: ss_quantity:354 ss_net_paid_inc_tax:365
                     │    └── filters
                     │         └── (ss_quantity:354 >= 81) AND (ss_quantity:354 <= 100) [outer=(354), constraints=(/354: [/81 - /100]; tight)]
                     └── aggregations
                          └── avg [as=avg:369, outer=(365)]
                               └── ss_net_paid_inc_tax:365

# --------------------------------------------------
# Q10
opt
	SELECT
		cd_gender,
		cd_marital_status,
		cd_education_status,
		count(*) AS cnt1,
		cd_purchase_estimate,
		count(*) AS cnt2,
		cd_credit_rating,
		count(*) AS cnt3,
		cd_dep_count,
		count(*) AS cnt4,
		cd_dep_employed_count,
		count(*) AS cnt5,
		cd_dep_college_count,
		count(*) AS cnt6
	FROM
		customer AS c,
		customer_address AS ca,
		customer_demographics
	WHERE
		c.c_current_addr_sk = ca.ca_address_sk
		AND ca_county
			IN (
					'Fairfield County',
					'Campbell County',
					'Washtenaw County',
					'Escambia County',
					'Cleburne County'
				)
		AND cd_demo_sk = c.c_current_cdemo_sk
		AND EXISTS(
				SELECT
					*
				FROM
					store_sales, date_dim
				WHERE
					c.c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 2001
					AND d_moy BETWEEN 3 AND (3 + 3)
			)
		AND (
				EXISTS(
					SELECT
						*
					FROM
						web_sales, date_dim
					WHERE
						c.c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
						AND d_year = 2001
						AND d_moy BETWEEN 3 AND (3 + 3)
				)
				OR EXISTS(
						SELECT
							*
						FROM
							catalog_sales, date_dim
						WHERE
							c.c_customer_sk
							= cs_ship_customer_sk
							AND cs_sold_date_sk = d_date_sk
							AND d_year = 2001
							AND d_moy BETWEEN 3 AND (3 + 3)
					)
			)
	GROUP BY
		cd_gender,
		cd_marital_status,
		cd_education_status,
		cd_purchase_estimate,
		cd_credit_rating,
		cd_dep_count,
		cd_dep_employed_count,
		cd_dep_college_count
	ORDER BY
		cd_gender,
		cd_marital_status,
		cd_education_status,
		cd_purchase_estimate,
		cd_credit_rating,
		cd_dep_count,
		cd_dep_employed_count,
		cd_dep_college_count
	LIMIT
		100;
----
top-k
 ├── columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cnt1:241!null cd_purchase_estimate:40 cnt2:241!null cd_credit_rating:41 cnt3:241!null cd_dep_count:42 cnt4:241!null cd_dep_employed_count:43 cnt5:241!null cd_dep_college_count:44 cnt6:241!null
 ├── internal-ordering: +37,+38,+39,+40,+41,+42,+43,+44
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (37-44)
 ├── fd: (37-44)-->(241)
 ├── ordering: +37,+38,+39,+40,+41,+42,+43,+44
 └── group-by (hash)
      ├── columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44 count_rows:241!null
      ├── grouping columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44
      ├── key: (37-44)
      ├── fd: (37-44)-->(241)
      ├── inner-join (lookup customer_demographics)
      │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3!null c_current_addr_sk:5!null ca_address_sk:21!null ca_county:28!null cd_demo_sk:36!null cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44
      │    ├── key columns: [3] = [36]
      │    ├── lookup columns are key
      │    ├── key: (1)
      │    ├── fd: (1)-->(3,5), (21)-->(28), (36)-->(37-44), (5)==(21), (21)==(5), (3)==(36), (36)==(3)
      │    ├── semi-join (hash)
      │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5!null ca_address_sk:21!null ca_county:28!null
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(3,5), (21)-->(28), (5)==(21), (21)==(5)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5!null ca_address_sk:21!null ca_county:28!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(3,5), (21)-->(28), (5)==(21), (21)==(5)
      │    │    │    ├── project
      │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │    ├── key: (1)
      │    │    │    │    ├── fd: (1)-->(3,5)
      │    │    │    │    └── select
      │    │    │    │         ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 exists:238!null canary_agg:239
      │    │    │    │         ├── key: (1)
      │    │    │    │         ├── fd: (1)-->(3,5,238,239)
      │    │    │    │         ├── group-by (hash)
      │    │    │    │         │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 exists:238!null canary_agg:239
      │    │    │    │         │    ├── grouping columns: c_customer_sk:1!null
      │    │    │    │         │    ├── key: (1)
      │    │    │    │         │    ├── fd: (1)-->(3,5,238,239)
      │    │    │    │         │    ├── right-join (hash)
      │    │    │    │         │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 cs_sold_date_sk:168 cs_ship_customer_sk:175 d_date_sk:204 d_year:210 d_moy:212 exists:238!null
      │    │    │    │         │    │    ├── fd: (1)-->(3,5,238), (204)-->(212), (168)==(204), (204)==(168)
      │    │    │    │         │    │    ├── inner-join (hash)
      │    │    │    │         │    │    │    ├── columns: cs_sold_date_sk:168!null cs_ship_customer_sk:175 d_date_sk:204!null d_year:210!null d_moy:212!null
      │    │    │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │         │    │    │    ├── fd: ()-->(210), (204)-->(212), (168)==(204), (204)==(168)
      │    │    │    │         │    │    │    ├── scan catalog_sales
      │    │    │    │         │    │    │    │    └── columns: cs_sold_date_sk:168 cs_ship_customer_sk:175
      │    │    │    │         │    │    │    ├── select
      │    │    │    │         │    │    │    │    ├── columns: d_date_sk:204!null d_year:210!null d_moy:212!null
      │    │    │    │         │    │    │    │    ├── key: (204)
      │    │    │    │         │    │    │    │    ├── fd: ()-->(210), (204)-->(212)
      │    │    │    │         │    │    │    │    ├── scan date_dim
      │    │    │    │         │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210 d_moy:212
      │    │    │    │         │    │    │    │    │    ├── key: (204)
      │    │    │    │         │    │    │    │    │    └── fd: (204)-->(210,212)
      │    │    │    │         │    │    │    │    └── filters
      │    │    │    │         │    │    │    │         ├── (d_moy:212 >= 3) AND (d_moy:212 <= 6) [outer=(212), constraints=(/212: [/3 - /6]; tight)]
      │    │    │    │         │    │    │    │         └── d_year:210 = 2001 [outer=(210), constraints=(/210: [/2001 - /2001]; tight), fd=()-->(210)]
      │    │    │    │         │    │    │    └── filters
      │    │    │    │         │    │    │         └── cs_sold_date_sk:168 = d_date_sk:204 [outer=(168,204), constraints=(/168: (/NULL - ]; /204: (/NULL - ]), fd=(168)==(204), (204)==(168)]
      │    │    │    │         │    │    ├── project
      │    │    │    │         │    │    │    ├── columns: exists:238!null c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │         │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    ├── fd: (1)-->(3,5,238)
      │    │    │    │         │    │    │    ├── group-by (hash)
      │    │    │    │         │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 canary_agg:237
      │    │    │    │         │    │    │    │    ├── grouping columns: c_customer_sk:1!null
      │    │    │    │         │    │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    │    ├── fd: (1)-->(3,5,237)
      │    │    │    │         │    │    │    │    ├── left-join (hash)
      │    │    │    │         │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 ws_sold_date_sk:102 ws_bill_customer_sk:106 d_date_sk:138 d_year:144 d_moy:146
      │    │    │    │         │    │    │    │    │    ├── multiplicity: left-rows(one-or-more), right-rows(zero-or-one)
      │    │    │    │         │    │    │    │    │    ├── fd: (1)-->(3,5), (138)-->(146), (102)==(138), (138)==(102)
      │    │    │    │         │    │    │    │    │    ├── scan customer [as=c]
      │    │    │    │         │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │         │    │    │    │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    │    │    │    └── fd: (1)-->(3,5)
      │    │    │    │         │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │         │    │    │    │    │    │    ├── columns: ws_sold_date_sk:102!null ws_bill_customer_sk:106 d_date_sk:138!null d_year:144!null d_moy:146!null
      │    │    │    │         │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │         │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(146), (102)==(138), (138)==(102)
      │    │    │    │         │    │    │    │    │    │    ├── scan web_sales
      │    │    │    │         │    │    │    │    │    │    │    └── columns: ws_sold_date_sk:102 ws_bill_customer_sk:106
      │    │    │    │         │    │    │    │    │    │    ├── select
      │    │    │    │         │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144!null d_moy:146!null
      │    │    │    │         │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │         │    │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(146)
      │    │    │    │         │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │         │    │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144 d_moy:146
      │    │    │    │         │    │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │         │    │    │    │    │    │    │    │    └── fd: (138)-->(144,146)
      │    │    │    │         │    │    │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │    │    │         ├── (d_moy:146 >= 3) AND (d_moy:146 <= 6) [outer=(146), constraints=(/146: [/3 - /6]; tight)]
      │    │    │    │         │    │    │    │    │    │    │         └── d_year:144 = 2001 [outer=(144), constraints=(/144: [/2001 - /2001]; tight), fd=()-->(144)]
      │    │    │    │         │    │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │    │         └── ws_sold_date_sk:102 = d_date_sk:138 [outer=(102,138), constraints=(/102: (/NULL - ]; /138: (/NULL - ]), fd=(102)==(138), (138)==(102)]
      │    │    │    │         │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │         └── c_customer_sk:1 = ws_bill_customer_sk:106 [outer=(1,106), constraints=(/1: (/NULL - ]; /106: (/NULL - ]), fd=(1)==(106), (106)==(1)]
      │    │    │    │         │    │    │    │    └── aggregations
      │    │    │    │         │    │    │    │         ├── const-not-null-agg [as=canary_agg:237, outer=(102)]
      │    │    │    │         │    │    │    │         │    └── ws_sold_date_sk:102
      │    │    │    │         │    │    │    │         ├── const-agg [as=c_current_cdemo_sk:3, outer=(3)]
      │    │    │    │         │    │    │    │         │    └── c_current_cdemo_sk:3
      │    │    │    │         │    │    │    │         └── const-agg [as=c_current_addr_sk:5, outer=(5)]
      │    │    │    │         │    │    │    │              └── c_current_addr_sk:5
      │    │    │    │         │    │    │    └── projections
      │    │    │    │         │    │    │         └── canary_agg:237 IS NOT NULL [as=exists:238, outer=(237)]
      │    │    │    │         │    │    └── filters
      │    │    │    │         │    │         └── c_customer_sk:1 = cs_ship_customer_sk:175 [outer=(1,175), constraints=(/1: (/NULL - ]; /175: (/NULL - ]), fd=(1)==(175), (175)==(1)]
      │    │    │    │         │    └── aggregations
      │    │    │    │         │         ├── const-not-null-agg [as=canary_agg:239, outer=(168)]
      │    │    │    │         │         │    └── cs_sold_date_sk:168
      │    │    │    │         │         ├── const-agg [as=c_current_cdemo_sk:3, outer=(3)]
      │    │    │    │         │         │    └── c_current_cdemo_sk:3
      │    │    │    │         │         ├── const-agg [as=c_current_addr_sk:5, outer=(5)]
      │    │    │    │         │         │    └── c_current_addr_sk:5
      │    │    │    │         │         └── const-agg [as=exists:238, outer=(238)]
      │    │    │    │         │              └── exists:238
      │    │    │    │         └── filters
      │    │    │    │              └── exists:238 OR (canary_agg:239 IS NOT NULL) [outer=(238,239)]
      │    │    │    ├── select
      │    │    │    │    ├── columns: ca_address_sk:21!null ca_county:28!null
      │    │    │    │    ├── key: (21)
      │    │    │    │    ├── fd: (21)-->(28)
      │    │    │    │    ├── scan customer_address [as=ca]
      │    │    │    │    │    ├── columns: ca_address_sk:21!null ca_county:28
      │    │    │    │    │    ├── key: (21)
      │    │    │    │    │    └── fd: (21)-->(28)
      │    │    │    │    └── filters
      │    │    │    │         └── ca_county:28 IN ('Campbell County', 'Cleburne County', 'Escambia County', 'Fairfield County', 'Washtenaw County') [outer=(28), constraints=(/28: [/'Campbell County' - /'Campbell County'] [/'Cleburne County' - /'Cleburne County'] [/'Escambia County' - /'Escambia County'] [/'Fairfield County' - /'Fairfield County'] [/'Washtenaw County' - /'Washtenaw County']; tight)]
      │    │    │    └── filters
      │    │    │         └── c_current_addr_sk:5 = ca_address_sk:21 [outer=(5,21), constraints=(/5: (/NULL - ]; /21: (/NULL - ]), fd=(5)==(21), (21)==(5)]
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:47!null ss_customer_sk:50 d_date_sk:72!null d_year:78!null d_moy:80!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(78), (72)-->(80), (47)==(72), (72)==(47)
      │    │    │    ├── scan store_sales
      │    │    │    │    └── columns: ss_sold_date_sk:47 ss_customer_sk:50
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_moy:80!null
      │    │    │    │    ├── key: (72)
      │    │    │    │    ├── fd: ()-->(78), (72)-->(80)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_moy:80
      │    │    │    │    │    ├── key: (72)
      │    │    │    │    │    └── fd: (72)-->(78,80)
      │    │    │    │    └── filters
      │    │    │    │         ├── (d_moy:80 >= 3) AND (d_moy:80 <= 6) [outer=(80), constraints=(/80: [/3 - /6]; tight)]
      │    │    │    │         └── d_year:78 = 2001 [outer=(78), constraints=(/78: [/2001 - /2001]; tight), fd=()-->(78)]
      │    │    │    └── filters
      │    │    │         └── ss_sold_date_sk:47 = d_date_sk:72 [outer=(47,72), constraints=(/47: (/NULL - ]; /72: (/NULL - ]), fd=(47)==(72), (72)==(47)]
      │    │    └── filters
      │    │         └── c_customer_sk:1 = ss_customer_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
      │    └── filters (true)
      └── aggregations
           └── count-rows [as=count_rows:241]

# --------------------------------------------------
# Q11
opt
	WITH
		year_total
			AS (
				SELECT
					c_customer_id AS customer_id,
					c_first_name AS customer_first_name,
					c_last_name AS customer_last_name,
					c_preferred_cust_flag
						AS customer_preferred_cust_flag,
					c_birth_country AS customer_birth_country,
					c_login AS customer_login,
					c_email_address AS customer_email_address,
					d_year AS dyear,
					sum(ss_ext_list_price - ss_ext_discount_amt)
						AS year_total,
					's' AS sale_type
				FROM
					customer, store_sales, date_dim
				WHERE
					c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
				GROUP BY
					c_customer_id,
					c_first_name,
					c_last_name,
					c_preferred_cust_flag,
					c_birth_country,
					c_login,
					c_email_address,
					d_year
				UNION ALL
					SELECT
						c_customer_id AS customer_id,
						c_first_name AS customer_first_name,
						c_last_name AS customer_last_name,
						c_preferred_cust_flag
							AS customer_preferred_cust_flag,
						c_birth_country
							AS customer_birth_country,
						c_login AS customer_login,
						c_email_address
							AS customer_email_address,
						d_year AS dyear,
						sum(
							ws_ext_list_price
							- ws_ext_discount_amt
						)
							AS year_total,
						'w' AS sale_type
					FROM
						customer, web_sales, date_dim
					WHERE
						c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
					GROUP BY
						c_customer_id,
						c_first_name,
						c_last_name,
						c_preferred_cust_flag,
						c_birth_country,
						c_login,
						c_email_address,
						d_year
			)
	SELECT
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_email_address
	FROM
		year_total AS t_s_firstyear,
		year_total AS t_s_secyear,
		year_total AS t_w_firstyear,
		year_total AS t_w_secyear
	WHERE
		t_s_secyear.customer_id = t_s_firstyear.customer_id
		AND t_s_firstyear.customer_id = t_w_secyear.customer_id
		AND t_s_firstyear.customer_id
			= t_w_firstyear.customer_id
		AND t_s_firstyear.sale_type = 's'
		AND t_w_firstyear.sale_type = 'w'
		AND t_s_secyear.sale_type = 's'
		AND t_w_secyear.sale_type = 'w'
		AND t_s_firstyear.dyear = 1998
		AND t_s_secyear.dyear = 1998 + 1
		AND t_w_firstyear.dyear = 1998
		AND t_w_secyear.dyear = 1998 + 1
		AND t_s_firstyear.year_total > 0
		AND t_w_firstyear.year_total > 0
		AND CASE
			WHEN t_w_firstyear.year_total > 0
			THEN t_w_secyear.year_total
			/ t_w_firstyear.year_total
			ELSE 0.0
			END
			> CASE
				WHEN t_s_firstyear.year_total > 0
				THEN t_s_secyear.year_total
				/ t_s_firstyear.year_total
				ELSE 0.0
				END
	ORDER BY
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name,
		t_s_secyear.customer_email_address
	LIMIT
		100;
----
with &1 (year_total)
 ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +188,+189,+190,+194
 ├── union-all
 │    ├── columns: customer_id:168!null customer_first_name:169 customer_last_name:170 customer_preferred_cust_flag:171 customer_birth_country:172 customer_login:173 customer_email_address:174 dyear:175 year_total:176 sale_type:177!null
 │    ├── left columns: c_customer_id:2 c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77 sale_type:78
 │    ├── right columns: c_customer_id:80 c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166 sale_type:167
 │    ├── immutable
 │    ├── project
 │    │    ├── columns: sale_type:78!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    ├── immutable
 │    │    ├── key: (2,9-11,15-17,52)
 │    │    ├── fd: ()-->(78), (2,9-11,15-17,52)-->(77)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52 sum:77
 │    │    │    ├── grouping columns: c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    ├── immutable
 │    │    │    ├── key: (2,9-11,15-17,52)
 │    │    │    ├── fd: (2,9-11,15-17,52)-->(77)
 │    │    │    ├── project
 │    │    │    │    ├── columns: column76:76 c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 d_year:52
 │    │    │    │    ├── immutable
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21!null ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_list_price:38 d_date_sk:46!null d_year:52
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (46)-->(52), (21)==(46), (46)==(21), (1)==(24), (24)==(1)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17 ss_sold_date_sk:21 ss_customer_sk:24!null ss_ext_discount_amt:35 ss_ext_list_price:38
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (1)-->(2,9-11,15-17), (1)==(24), (24)==(1)
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:21 ss_customer_sk:24 ss_ext_discount_amt:35 ss_ext_list_price:38
 │    │    │    │    │    │    ├── scan customer
 │    │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 c_preferred_cust_flag:11 c_birth_country:15 c_login:16 c_email_address:17
 │    │    │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    │    │    └── fd: (1)-->(2,9-11,15-17)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── c_customer_sk:1 = ss_customer_sk:24 [outer=(1,24), constraints=(/1: (/NULL - ]; /24: (/NULL - ]), fd=(1)==(24), (24)==(1)]
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:46!null d_year:52
 │    │    │    │    │    │    ├── key: (46)
 │    │    │    │    │    │    └── fd: (46)-->(52)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:21 = d_date_sk:46 [outer=(21,46), constraints=(/21: (/NULL - ]; /46: (/NULL - ]), fd=(21)==(46), (46)==(21)]
 │    │    │    │    └── projections
 │    │    │    │         └── ss_ext_list_price:38 - ss_ext_discount_amt:35 [as=column76:76, outer=(35,38), immutable]
 │    │    │    └── aggregations
 │    │    │         └── sum [as=sum:77, outer=(76)]
 │    │    │              └── column76:76
 │    │    └── projections
 │    │         └── 's' [as=sale_type:78]
 │    └── project
 │         ├── columns: sale_type:167!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │         ├── immutable
 │         ├── key: (80,87-89,93-95,141)
 │         ├── fd: ()-->(167), (80,87-89,93-95,141)-->(166)
 │         ├── group-by (hash)
 │         │    ├── columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141 sum:166
 │         │    ├── grouping columns: c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │         │    ├── immutable
 │         │    ├── key: (80,87-89,93-95,141)
 │         │    ├── fd: (80,87-89,93-95,141)-->(166)
 │         │    ├── project
 │         │    │    ├── columns: column165:165 c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 d_year:141
 │         │    │    ├── immutable
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 ws_sold_date_sk:99!null ws_bill_customer_sk:103!null ws_ext_discount_amt:121 ws_ext_list_price:124 d_date_sk:135!null d_year:141
 │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    ├── fd: (79)-->(80,87-89,93-95), (135)-->(141), (99)==(135), (135)==(99), (79)==(103), (103)==(79)
 │         │    │    │    ├── inner-join (hash)
 │         │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95 ws_sold_date_sk:99 ws_bill_customer_sk:103!null ws_ext_discount_amt:121 ws_ext_list_price:124
 │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    ├── fd: (79)-->(80,87-89,93-95), (79)==(103), (103)==(79)
 │         │    │    │    │    ├── scan web_sales
 │         │    │    │    │    │    └── columns: ws_sold_date_sk:99 ws_bill_customer_sk:103 ws_ext_discount_amt:121 ws_ext_list_price:124
 │         │    │    │    │    ├── scan customer
 │         │    │    │    │    │    ├── columns: c_customer_sk:79!null c_customer_id:80!null c_first_name:87 c_last_name:88 c_preferred_cust_flag:89 c_birth_country:93 c_login:94 c_email_address:95
 │         │    │    │    │    │    ├── key: (79)
 │         │    │    │    │    │    └── fd: (79)-->(80,87-89,93-95)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── c_customer_sk:79 = ws_bill_customer_sk:103 [outer=(79,103), constraints=(/79: (/NULL - ]; /103: (/NULL - ]), fd=(79)==(103), (103)==(79)]
 │         │    │    │    ├── scan date_dim
 │         │    │    │    │    ├── columns: d_date_sk:135!null d_year:141
 │         │    │    │    │    ├── key: (135)
 │         │    │    │    │    └── fd: (135)-->(141)
 │         │    │    │    └── filters
 │         │    │    │         └── ws_sold_date_sk:99 = d_date_sk:135 [outer=(99,135), constraints=(/99: (/NULL - ]; /135: (/NULL - ]), fd=(99)==(135), (135)==(99)]
 │         │    │    └── projections
 │         │    │         └── ws_ext_list_price:124 - ws_ext_discount_amt:121 [as=column165:165, outer=(121,124), immutable]
 │         │    └── aggregations
 │         │         └── sum [as=sum:166, outer=(165)]
 │         │              └── column165:165
 │         └── projections
 │              └── 'w' [as=sale_type:167]
 └── project
      ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +188,+189,+190,+194
      └── top-k
           ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
           ├── internal-ordering: +(178|188|198|208),+189,+190,+194 opt(185,187,195,197,205,207,215,217)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── fd: ()-->(185,187,195,197,205,207,215,217), (178)==(188,198,208), (188)==(178,198,208), (198)==(178,188,208), (208)==(178,188,198)
           ├── ordering: +(178|188|198|208),+189,+190,+194 opt(185,187,195,197,205,207,215,217) [actual: +178,+189,+190,+194]
           └── inner-join (hash)
                ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                ├── immutable
                ├── fd: ()-->(185,187,195,197,205,207,215,217), (178)==(188,198,208), (188)==(178,198,208), (198)==(178,188,208), (208)==(178,188,198)
                ├── select
                │    ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195!null year_total:196 sale_type:197!null
                │    ├── fd: ()-->(195,197)
                │    ├── with-scan &1 (year_total)
                │    │    ├── columns: customer_id:188!null customer_first_name:189 customer_last_name:190 customer_email_address:194 dyear:195 year_total:196 sale_type:197!null
                │    │    └── mapping:
                │    │         ├──  customer_id:168 => customer_id:188
                │    │         ├──  customer_first_name:169 => customer_first_name:189
                │    │         ├──  customer_last_name:170 => customer_last_name:190
                │    │         ├──  customer_email_address:174 => customer_email_address:194
                │    │         ├──  dyear:175 => dyear:195
                │    │         ├──  year_total:176 => year_total:196
                │    │         └──  sale_type:177 => sale_type:197
                │    └── filters
                │         ├── sale_type:197 = 's' [outer=(197), constraints=(/197: [/'s' - /'s']; tight), fd=()-->(197)]
                │         └── dyear:195 = 1999 [outer=(195), constraints=(/195: [/1999 - /1999]; tight), fd=()-->(195)]
                ├── inner-join (hash)
                │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                │    ├── immutable
                │    ├── fd: ()-->(185,187,205,207,215,217), (178)==(198,208), (198)==(178,208), (208)==(178,198)
                │    ├── select
                │    │    ├── columns: customer_id:208!null dyear:215!null year_total:216 sale_type:217!null
                │    │    ├── fd: ()-->(215,217)
                │    │    ├── with-scan &1 (year_total)
                │    │    │    ├── columns: customer_id:208!null dyear:215 year_total:216 sale_type:217!null
                │    │    │    └── mapping:
                │    │    │         ├──  customer_id:168 => customer_id:208
                │    │    │         ├──  dyear:175 => dyear:215
                │    │    │         ├──  year_total:176 => year_total:216
                │    │    │         └──  sale_type:177 => sale_type:217
                │    │    └── filters
                │    │         ├── sale_type:217 = 'w' [outer=(217), constraints=(/217: [/'w' - /'w']; tight), fd=()-->(217)]
                │    │         └── dyear:215 = 1999 [outer=(215), constraints=(/215: [/1999 - /1999]; tight), fd=()-->(215)]
                │    ├── inner-join (hash)
                │    │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null
                │    │    ├── immutable
                │    │    ├── fd: ()-->(185,187,205,207), (178)==(198), (198)==(178)
                │    │    ├── select
                │    │    │    ├── columns: customer_id:178!null dyear:185!null year_total:186!null sale_type:187!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(185,187)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:178!null dyear:185 year_total:186 sale_type:187!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:168 => customer_id:178
                │    │    │    │         ├──  dyear:175 => dyear:185
                │    │    │    │         ├──  year_total:176 => year_total:186
                │    │    │    │         └──  sale_type:177 => sale_type:187
                │    │    │    └── filters
                │    │    │         ├── sale_type:187 = 's' [outer=(187), constraints=(/187: [/'s' - /'s']; tight), fd=()-->(187)]
                │    │    │         ├── dyear:185 = 1998 [outer=(185), constraints=(/185: [/1998 - /1998]; tight), fd=()-->(185)]
                │    │    │         └── year_total:186 > 0 [outer=(186), immutable, constraints=(/186: (/0 - ]; tight)]
                │    │    ├── select
                │    │    │    ├── columns: customer_id:198!null dyear:205!null year_total:206!null sale_type:207!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(205,207)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:198!null dyear:205 year_total:206 sale_type:207!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:168 => customer_id:198
                │    │    │    │         ├──  dyear:175 => dyear:205
                │    │    │    │         ├──  year_total:176 => year_total:206
                │    │    │    │         └──  sale_type:177 => sale_type:207
                │    │    │    └── filters
                │    │    │         ├── sale_type:207 = 'w' [outer=(207), constraints=(/207: [/'w' - /'w']; tight), fd=()-->(207)]
                │    │    │         ├── dyear:205 = 1998 [outer=(205), constraints=(/205: [/1998 - /1998]; tight), fd=()-->(205)]
                │    │    │         └── year_total:206 > 0 [outer=(206), immutable, constraints=(/206: (/0 - ]; tight)]
                │    │    └── filters
                │    │         └── customer_id:178 = customer_id:198 [outer=(178,198), constraints=(/178: (/NULL - ]; /198: (/NULL - ]), fd=(178)==(198), (198)==(178)]
                │    └── filters
                │         └── customer_id:198 = customer_id:208 [outer=(198,208), constraints=(/198: (/NULL - ]; /208: (/NULL - ]), fd=(198)==(208), (208)==(198)]
                └── filters
                     ├── customer_id:188 = customer_id:198 [outer=(188,198), constraints=(/188: (/NULL - ]; /198: (/NULL - ]), fd=(188)==(198), (198)==(188)]
                     └── CASE WHEN year_total:206 > 0 THEN year_total:216 / year_total:206 ELSE 0.0 END > CASE WHEN year_total:186 > 0 THEN year_total:196 / year_total:186 ELSE 0.0 END [outer=(186,196,206,216), immutable]

# --------------------------------------------------
# Q12
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price,
		sum(ws_ext_sales_price) AS itemrevenue,
		sum(ws_ext_sales_price) * 100
		/ sum(sum(ws_ext_sales_price)) OVER (
				PARTITION BY i_class
			)
			AS revenueratio
	FROM
		web_sales, item, date_dim
	WHERE
		ws_item_sk = i_item_sk
		AND i_category IN ('Men', 'Books', 'Electronics')
		AND ws_sold_date_sk = d_date_sk
		AND d_date BETWEEN CAST('2001-06-15' AS DATE) AND (CAST('2001-06-15' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price
	ORDER BY
		i_category,
		i_class,
		i_item_id,
		i_item_desc,
		revenueratio
	LIMIT
		100;
----
top-k
 ├── columns: i_item_id:38!null i_item_desc:41 i_category:49!null i_class:47 i_current_price:42 itemrevenue:91 revenueratio:93
 ├── internal-ordering: +49,+47,+38,+41,+93
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (38,41,42,47,49)
 ├── fd: (38,41,42,47,49)-->(91,93)
 ├── ordering: +49,+47,+38,+41,+93
 └── project
      ├── columns: revenueratio:93 i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      ├── immutable
      ├── key: (38,41,42,47,49)
      ├── fd: (38,41,42,47,49)-->(91,93)
      ├── window partition=(47)
      │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91 sum:92
      │    ├── key: (38,41,42,47,49)
      │    ├── fd: (38,41,42,47,49)-->(91,92)
      │    ├── group-by (hash)
      │    │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      │    │    ├── grouping columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    ├── key: (38,41,42,47,49)
      │    │    ├── fd: (38,41,42,47,49)-->(91)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null d_date_sk:61!null d_date:63!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(38,41,42,47,49), (61)-->(63), (4)==(37), (37)==(4), (1)==(61), (61)==(1)
      │    │    │    ├── inner-join (lookup web_sales)
      │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    ├── key columns: [37] = [4]
      │    │    │    │    ├── fd: (37)-->(38,41,42,47,49), (4)==(37), (37)==(4)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    ├── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49
      │    │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    │    └── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── i_category:49 IN ('Books', 'Electronics', 'Men') [outer=(49), constraints=(/49: [/'Books' - /'Books'] [/'Electronics' - /'Electronics'] [/'Men' - /'Men']; tight)]
      │    │    │    │    └── filters (true)
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
      │    │    │    │    ├── key: (61)
      │    │    │    │    ├── fd: (61)-->(63)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
      │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    └── fd: (61)-->(63)
      │    │    │    │    └── filters
      │    │    │    │         └── (d_date:63 >= '2001-06-15') AND (d_date:63 <= '2001-07-15') [outer=(63), constraints=(/63: [/'2001-06-15' - /'2001-07-15']; tight)]
      │    │    │    └── filters
      │    │    │         └── ws_sold_date_sk:1 = d_date_sk:61 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
      │    │    └── aggregations
      │    │         └── sum [as=sum:91, outer=(24)]
      │    │              └── ws_ext_sales_price:24
      │    └── windows
      │         └── sum [as=sum:92, outer=(91)]
      │              └── sum:91
      └── projections
           └── (sum:91 * 100) / sum:92 [as=revenueratio:93, outer=(91,92), immutable]

# --------------------------------------------------
# Q13
opt
	SELECT
		avg(ss_quantity),
		avg(ss_ext_sales_price),
		avg(ss_ext_wholesale_cost),
		sum(ss_ext_wholesale_cost)
	FROM
		store_sales,
		store,
		customer_demographics,
		household_demographics,
		customer_address,
		date_dim
	WHERE
		s_store_sk = ss_store_sk
		AND ss_sold_date_sk = d_date_sk
		AND d_year = 2001
		AND (
				(
					ss_hdemo_sk = hd_demo_sk
					AND cd_demo_sk = ss_cdemo_sk
					AND cd_marital_status = 'M'
					AND cd_education_status = 'College'
					AND ss_sales_price BETWEEN 100.00 AND 150.00
					AND hd_dep_count = 3
				)
				OR (
						ss_hdemo_sk = hd_demo_sk
						AND cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'D'
						AND cd_education_status = 'Primary'
						AND ss_sales_price BETWEEN 50.00 AND 100.00
						AND hd_dep_count = 1
					)
				OR (
						ss_hdemo_sk = hd_demo_sk
						AND cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'W'
						AND cd_education_status = '2 yr Degree'
						AND ss_sales_price BETWEEN 150.00 AND 200.00
						AND hd_dep_count = 1
					)
			)
		AND (
				(
					ss_addr_sk = ca_address_sk
					AND ca_country = 'United States'
					AND ca_state IN ('IL', 'TN', 'TX')
					AND ss_net_profit BETWEEN 100 AND 200
				)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('WY', 'OH', 'ID')
						AND ss_net_profit BETWEEN 150 AND 300
					)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('MS', 'SC', 'IA')
						AND ss_net_profit BETWEEN 50 AND 250
					)
			);
----
scalar-group-by
 ├── columns: avg:120 avg:121 avg:122 sum:123
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(120-123)
 ├── inner-join (lookup customer_demographics)
 │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5!null ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14!null ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null cd_demo_sk:57!null cd_marital_status:59!null cd_education_status:60!null hd_demo_sk:68!null hd_dep_count:71!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    ├── key columns: [5] = [57]
 │    ├── lookup columns are key
 │    ├── immutable
 │    ├── fd: ()-->(85,96), (57)-->(59,60), (68)-->(71), (75)-->(83), (8)==(26), (26)==(8), (5)==(57), (57)==(5), (6)==(68), (68)==(6), (7)==(75), (75)==(7), (1)==(90), (90)==(1)
 │    ├── inner-join (hash)
 │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null hd_demo_sk:68!null hd_dep_count:71 ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── immutable
 │    │    ├── fd: ()-->(85,96), (68)-->(71), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7), (6)==(68), (68)==(6), (8)==(26), (26)==(8)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null s_store_sk:26!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── immutable
 │    │    │    ├── fd: ()-->(85,96), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7), (8)==(26), (26)==(8)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7!null ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23!null ca_address_sk:75!null ca_state:83!null ca_country:85!null d_date_sk:90!null d_year:96!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(85,96), (75)-->(83), (1)==(90), (90)==(1), (7)==(75), (75)==(7)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23 d_date_sk:90!null d_year:96!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: ()-->(96), (1)==(90), (90)==(1)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_cdemo_sk:5 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_ext_sales_price:16 ss_ext_wholesale_cost:17 ss_net_profit:23
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:90!null d_year:96!null
 │    │    │    │    │    │    ├── key: (90)
 │    │    │    │    │    │    ├── fd: ()-->(96)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:90!null d_year:96
 │    │    │    │    │    │    │    ├── key: (90)
 │    │    │    │    │    │    │    └── fd: (90)-->(96)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── d_year:96 = 2001 [outer=(96), constraints=(/96: [/2001 - /2001]; tight), fd=()-->(96)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:90 [outer=(1,90), constraints=(/1: (/NULL - ]; /90: (/NULL - ]), fd=(1)==(90), (90)==(1)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: ca_address_sk:75!null ca_state:83 ca_country:85!null
 │    │    │    │    │    ├── key: (75)
 │    │    │    │    │    ├── fd: ()-->(85), (75)-->(83)
 │    │    │    │    │    ├── scan customer_address
 │    │    │    │    │    │    ├── columns: ca_address_sk:75!null ca_state:83 ca_country:85
 │    │    │    │    │    │    ├── key: (75)
 │    │    │    │    │    │    └── fd: (75)-->(83,85)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ca_country:85 = 'United States' [outer=(85), constraints=(/85: [/'United States' - /'United States']; tight), fd=()-->(85)]
 │    │    │    │    └── filters
 │    │    │    │         ├── ss_addr_sk:7 = ca_address_sk:75 [outer=(7,75), constraints=(/7: (/NULL - ]; /75: (/NULL - ]), fd=(7)==(75), (75)==(7)]
 │    │    │    │         └── ((((ca_state:83 IN ('IL', 'TN', 'TX')) AND (ss_net_profit:23 >= 100)) AND (ss_net_profit:23 <= 200)) OR (((ca_state:83 IN ('ID', 'OH', 'WY')) AND (ss_net_profit:23 >= 150)) AND (ss_net_profit:23 <= 300))) OR (((ca_state:83 IN ('IA', 'MS', 'SC')) AND (ss_net_profit:23 >= 50)) AND (ss_net_profit:23 <= 250)) [outer=(23,83), immutable, constraints=(/23: [/50 - /300]; /83: [/'IA' - /'IA'] [/'ID' - /'ID'] [/'IL' - /'IL'] [/'MS' - /'MS'] [/'OH' - /'OH'] [/'SC' - /'SC'] [/'TN' - /'TN'] [/'TX' - /'TX'] [/'WY' - /'WY'])]
 │    │    │    ├── scan store
 │    │    │    │    ├── columns: s_store_sk:26!null
 │    │    │    │    └── key: (26)
 │    │    │    └── filters
 │    │    │         └── s_store_sk:26 = ss_store_sk:8 [outer=(8,26), constraints=(/8: (/NULL - ]; /26: (/NULL - ]), fd=(8)==(26), (26)==(8)]
 │    │    ├── scan household_demographics
 │    │    │    ├── columns: hd_demo_sk:68!null hd_dep_count:71
 │    │    │    ├── key: (68)
 │    │    │    └── fd: (68)-->(71)
 │    │    └── filters
 │    │         └── ss_hdemo_sk:6 = hd_demo_sk:68 [outer=(6,68), constraints=(/6: (/NULL - ]; /68: (/NULL - ]), fd=(6)==(68), (68)==(6)]
 │    └── filters
 │         └── ((((((cd_marital_status:59 = 'M') AND (cd_education_status:60 = 'College')) AND (ss_sales_price:14 >= 100.00)) AND (ss_sales_price:14 <= 150.00)) AND (hd_dep_count:71 = 3)) OR (((((cd_marital_status:59 = 'D') AND (cd_education_status:60 = 'Primary')) AND (ss_sales_price:14 >= 50.00)) AND (ss_sales_price:14 <= 100.00)) AND (hd_dep_count:71 = 1))) OR (((((cd_marital_status:59 = 'W') AND (cd_education_status:60 = '2 yr Degree')) AND (ss_sales_price:14 >= 150.00)) AND (ss_sales_price:14 <= 200.00)) AND (hd_dep_count:71 = 1)) [outer=(14,59,60,71), immutable, constraints=(/14: [/50.00 - /200.00]; /59: [/'D' - /'D'] [/'M' - /'M'] [/'W' - /'W']; /60: [/'2 yr Degree' - /'2 yr Degree'] [/'College' - /'College'] [/'Primary' - /'Primary']; /71: [/1 - /1] [/3 - /3])]
 └── aggregations
      ├── avg [as=avg:120, outer=(11)]
      │    └── ss_quantity:11
      ├── avg [as=avg:121, outer=(16)]
      │    └── ss_ext_sales_price:16
      ├── avg [as=avg:122, outer=(17)]
      │    └── ss_ext_wholesale_cost:17
      └── sum [as=sum:123, outer=(17)]
           └── ss_ext_wholesale_cost:17

# --------------------------------------------------
# Q14
# TODO: adjust the query to work with CRDB.
# opt
# 	WITH
# 		cross_items
# 			AS (
# 				SELECT
# 					i_item_sk AS ss_item_sk
# 				FROM
# 					item,
# 					(
# 						SELECT
# 							iss.i_brand_id AS brand_id,
# 							iss.i_class_id AS class_id,
# 							iss.i_category_id AS category_id
# 						FROM
# 							store_sales,
# 							item AS iss,
# 							date_dim AS d1
# 						WHERE
# 							ss_item_sk = iss.i_item_sk
# 							AND ss_sold_date_sk = d1.d_date_sk
# 							AND d1.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								ics.i_brand_id,
# 								ics.i_class_id,
# 								ics.i_category_id
# 							FROM
# 								catalog_sales,
# 								item AS ics,
# 								date_dim AS d2
# 							WHERE
# 								cs_item_sk = ics.i_item_sk
# 								AND cs_sold_date_sk
# 									= d2.d_date_sk
# 								AND d2.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								iws.i_brand_id,
# 								iws.i_class_id,
# 								iws.i_category_id
# 							FROM
# 								web_sales,
# 								item AS iws,
# 								date_dim AS d3
# 							WHERE
# 								ws_item_sk = iws.i_item_sk
# 								AND ws_sold_date_sk
# 									= d3.d_date_sk
# 								AND d3.d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 				WHERE
# 					i_brand_id = brand_id
# 					AND i_class_id = class_id
# 					AND i_category_id = category_id
# 			),
# 		avg_sales
# 			AS (
# 				SELECT
# 					avg(quantity * list_price) AS average_sales
# 				FROM
# 					(
# 						SELECT
# 							ss_quantity AS quantity,
# 							ss_list_price AS list_price
# 						FROM
# 							store_sales, date_dim
# 						WHERE
# 							ss_sold_date_sk = d_date_sk
# 							AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								cs_quantity AS quantity,
# 								cs_list_price AS list_price
# 							FROM
# 								catalog_sales, date_dim
# 							WHERE
# 								cs_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								ws_quantity AS quantity,
# 								ws_list_price AS list_price
# 							FROM
# 								web_sales, date_dim
# 							WHERE
# 								ws_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 			)
# 	SELECT
# 		channel,
# 		i_brand_id,
# 		i_class_id,
# 		i_category_id,
# 		sum(sales),
# 		sum(number_sales)
# 	FROM
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_year = 1999 + 2
# 				AND d_moy = 11
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 			UNION ALL
# 				SELECT
# 					'catalog' AS channel,
# 					i_brand_id,
# 					i_class_id,
# 					i_category_id,
# 					sum(cs_quantity * cs_list_price) AS sales,
# 					count(*) AS number_sales
# 				FROM
# 					catalog_sales, item, date_dim
# 				WHERE
# 					cs_item_sk
# 					IN (SELECT ss_item_sk FROM cross_items)
# 					AND cs_item_sk = i_item_sk
# 					AND cs_sold_date_sk = d_date_sk
# 					AND d_year = 1999 + 2
# 					AND d_moy = 11
# 				GROUP BY
# 					i_brand_id, i_class_id, i_category_id
# 				HAVING
# 					sum(cs_quantity * cs_list_price)
# 					> (SELECT average_sales FROM avg_sales)
# 			UNION ALL
# 				SELECT
# 					'web' AS channel,
# 					i_brand_id,
# 					i_class_id,
# 					i_category_id,
# 					sum(ws_quantity * ws_list_price) AS sales,
# 					count(*) AS number_sales
# 				FROM
# 					web_sales, item, date_dim
# 				WHERE
# 					ws_item_sk
# 					IN (SELECT ss_item_sk FROM cross_items)
# 					AND ws_item_sk = i_item_sk
# 					AND ws_sold_date_sk = d_date_sk
# 					AND d_year = 1999 + 2
# 					AND d_moy = 11
# 				GROUP BY
# 					i_brand_id, i_class_id, i_category_id
# 				HAVING
# 					sum(ws_quantity * ws_list_price)
# 					> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS y
# 	GROUP BY
# 		rollup(channel, i_brand_id, i_class_id, i_category_id)
# 	ORDER BY
# 		channel, i_brand_id, i_class_id, i_category_id
# 	LIMIT
# 		100;
# 	WITH
# 		cross_items
# 			AS (
# 				SELECT
# 					i_item_sk AS ss_item_sk
# 				FROM
# 					item,
# 					(
# 						SELECT
# 							iss.i_brand_id AS brand_id,
# 							iss.i_class_id AS class_id,
# 							iss.i_category_id AS category_id
# 						FROM
# 							store_sales,
# 							item AS iss,
# 							date_dim AS d1
# 						WHERE
# 							ss_item_sk = iss.i_item_sk
# 							AND ss_sold_date_sk = d1.d_date_sk
# 							AND d1.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								ics.i_brand_id,
# 								ics.i_class_id,
# 								ics.i_category_id
# 							FROM
# 								catalog_sales,
# 								item AS ics,
# 								date_dim AS d2
# 							WHERE
# 								cs_item_sk = ics.i_item_sk
# 								AND cs_sold_date_sk
# 									= d2.d_date_sk
# 								AND d2.d_year BETWEEN 1999 AND (1999 + 2)
# 						INTERSECT
# 							SELECT
# 								iws.i_brand_id,
# 								iws.i_class_id,
# 								iws.i_category_id
# 							FROM
# 								web_sales,
# 								item AS iws,
# 								date_dim AS d3
# 							WHERE
# 								ws_item_sk = iws.i_item_sk
# 								AND ws_sold_date_sk
# 									= d3.d_date_sk
# 								AND d3.d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 				WHERE
# 					i_brand_id = brand_id
# 					AND i_class_id = class_id
# 					AND i_category_id = category_id
# 			),
# 		avg_sales
# 			AS (
# 				SELECT
# 					avg(quantity * list_price) AS average_sales
# 				FROM
# 					(
# 						SELECT
# 							ss_quantity AS quantity,
# 							ss_list_price AS list_price
# 						FROM
# 							store_sales, date_dim
# 						WHERE
# 							ss_sold_date_sk = d_date_sk
# 							AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								cs_quantity AS quantity,
# 								cs_list_price AS list_price
# 							FROM
# 								catalog_sales, date_dim
# 							WHERE
# 								cs_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 						UNION ALL
# 							SELECT
# 								ws_quantity AS quantity,
# 								ws_list_price AS list_price
# 							FROM
# 								web_sales, date_dim
# 							WHERE
# 								ws_sold_date_sk = d_date_sk
# 								AND d_year BETWEEN 1999 AND (1999 + 2)
# 					)
# 						AS x
# 			)
# 	SELECT
# 		this_year.channel AS ty_channel,
# 		this_year.i_brand_id AS ty_brand,
# 		this_year.i_class_id AS ty_class,
# 		this_year.i_category_id AS ty_category,
# 		this_year.sales AS ty_sales,
# 		this_year.number_sales AS ty_number_sales,
# 		last_year.channel AS ly_channel,
# 		last_year.i_brand_id AS ly_brand,
# 		last_year.i_class_id AS ly_class,
# 		last_year.i_category_id AS ly_category,
# 		last_year.sales AS ly_sales,
# 		last_year.number_sales AS ly_number_sales
# 	FROM
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_week_seq
# 					= (
# 							SELECT
# 								d_week_seq
# 							FROM
# 								date_dim
# 							WHERE
# 								d_year = 1999 + 1
# 								AND d_moy = 12
# 								AND d_dom = 3
# 						)
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS this_year,
# 		(
# 			SELECT
# 				'store' AS channel,
# 				i_brand_id,
# 				i_class_id,
# 				i_category_id,
# 				sum(ss_quantity * ss_list_price) AS sales,
# 				count(*) AS number_sales
# 			FROM
# 				store_sales, item, date_dim
# 			WHERE
# 				ss_item_sk
# 				IN (SELECT ss_item_sk FROM cross_items)
# 				AND ss_item_sk = i_item_sk
# 				AND ss_sold_date_sk = d_date_sk
# 				AND d_week_seq
# 					= (
# 							SELECT
# 								d_week_seq
# 							FROM
# 								date_dim
# 							WHERE
# 								d_year = 1999
# 								AND d_moy = 12
# 								AND d_dom = 3
# 						)
# 			GROUP BY
# 				i_brand_id, i_class_id, i_category_id
# 			HAVING
# 				sum(ss_quantity * ss_list_price)
# 				> (SELECT average_sales FROM avg_sales)
# 		)
# 			AS last_year
# 	WHERE
# 		this_year.i_brand_id = last_year.i_brand_id
# 		AND this_year.i_class_id = last_year.i_class_id
# 		AND this_year.i_category_id = last_year.i_category_id
# 	ORDER BY
# 		this_year.channel,
# 		this_year.i_brand_id,
# 		this_year.i_class_id,
# 		this_year.i_category_id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q15
opt
	SELECT
		ca_zip, sum(cs_sales_price)
	FROM
		catalog_sales, customer, customer_address, date_dim
	WHERE
		cs_bill_customer_sk = c_customer_sk
		AND c_current_addr_sk = ca_address_sk
		AND (
				substr(ca_zip, 1, 5)
				IN (
						'85669',
						'86197',
						'88274',
						'83405',
						'86475',
						'85392',
						'85460',
						'80348',
						'81792'
					)
				OR ca_state IN ('CA', 'WA', 'GA')
				OR cs_sales_price > 500
			)
		AND cs_sold_date_sk = d_date_sk
		AND d_qoy = 2
		AND d_year = 2001
	GROUP BY
		ca_zip
	ORDER BY
		ca_zip
	LIMIT
		100;
----
top-k
 ├── columns: ca_zip:66 sum:102
 ├── internal-ordering: +66
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (66)
 ├── fd: (66)-->(102)
 ├── ordering: +66
 └── group-by (hash)
      ├── columns: ca_zip:66 sum:102
      ├── grouping columns: ca_zip:66
      ├── immutable
      ├── key: (66)
      ├── fd: (66)-->(102)
      ├── inner-join (hash)
      │    ├── columns: cs_sold_date_sk:1!null cs_bill_customer_sk:4!null cs_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_state:65 ca_zip:66 d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── immutable
      │    ├── fd: ()-->(78,82), (37)-->(41), (57)-->(65,66), (41)==(57), (57)==(41), (4)==(37), (37)==(4), (1)==(72), (72)==(1)
      │    ├── inner-join (hash)
      │    │    ├── columns: cs_sold_date_sk:1!null cs_bill_customer_sk:4 cs_sales_price:22 d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(78,82), (1)==(72), (72)==(1)
      │    │    ├── scan catalog_sales
      │    │    │    └── columns: cs_sold_date_sk:1 cs_bill_customer_sk:4 cs_sales_price:22
      │    │    ├── select
      │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    │    ├── key: (72)
      │    │    │    ├── fd: ()-->(78,82)
      │    │    │    ├── scan date_dim
      │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_qoy:82
      │    │    │    │    ├── key: (72)
      │    │    │    │    └── fd: (72)-->(78,82)
      │    │    │    └── filters
      │    │    │         ├── d_qoy:82 = 2 [outer=(82), constraints=(/82: [/2 - /2]; tight), fd=()-->(82)]
      │    │    │         └── d_year:78 = 2001 [outer=(78), constraints=(/78: [/2001 - /2001]; tight), fd=()-->(78)]
      │    │    └── filters
      │    │         └── cs_sold_date_sk:1 = d_date_sk:72 [outer=(1,72), constraints=(/1: (/NULL - ]; /72: (/NULL - ]), fd=(1)==(72), (72)==(1)]
      │    ├── inner-join (hash)
      │    │    ├── columns: c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_state:65 ca_zip:66
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── key: (37)
      │    │    ├── fd: (37)-->(41), (57)-->(65,66), (41)==(57), (57)==(41)
      │    │    ├── scan customer
      │    │    │    ├── columns: c_customer_sk:37!null c_current_addr_sk:41
      │    │    │    ├── key: (37)
      │    │    │    └── fd: (37)-->(41)
      │    │    ├── scan customer_address
      │    │    │    ├── columns: ca_address_sk:57!null ca_state:65 ca_zip:66
      │    │    │    ├── key: (57)
      │    │    │    └── fd: (57)-->(65,66)
      │    │    └── filters
      │    │         └── c_current_addr_sk:41 = ca_address_sk:57 [outer=(41,57), constraints=(/41: (/NULL - ]; /57: (/NULL - ]), fd=(41)==(57), (57)==(41)]
      │    └── filters
      │         ├── cs_bill_customer_sk:4 = c_customer_sk:37 [outer=(4,37), constraints=(/4: (/NULL - ]; /37: (/NULL - ]), fd=(4)==(37), (37)==(4)]
      │         └── ((substr(ca_zip:66, 1, 5) IN ('80348', '81792', '83405', '85392', '85460', '85669', '86197', '86475', '88274')) OR (ca_state:65 IN ('CA', 'GA', 'WA'))) OR (cs_sales_price:22 > 500) [outer=(22,65,66), immutable]
      └── aggregations
           └── sum [as=sum:102, outer=(22)]
                └── cs_sales_price:22

# --------------------------------------------------
# Q16
# NOTE: Added conversion of 60 days to an interval.
opt
	SELECT
		count(DISTINCT cs_order_number) AS "order count",
		sum(cs_ext_ship_cost) AS "total shipping cost",
		sum(cs_net_profit) AS "total net profit"
	FROM
		catalog_sales AS cs1,
		date_dim,
		customer_address,
		call_center
	WHERE
		d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + '60 days'::INTERVAL)
		AND cs1.cs_ship_date_sk = d_date_sk
		AND cs1.cs_ship_addr_sk = ca_address_sk
		AND ca_state = 'PA'
		AND cs1.cs_call_center_sk = cc_call_center_sk
		AND cc_county
			IN (
					'Williamson County',
					'Williamson County',
					'Williamson County',
					'Williamson County',
					'Williamson County'
				)
		AND EXISTS(
				SELECT
					*
				FROM
					catalog_sales AS cs2
				WHERE
					cs1.cs_order_number = cs2.cs_order_number
					AND cs1.cs_warehouse_sk
						!= cs2.cs_warehouse_sk
			)
		AND NOT
				EXISTS(
					SELECT
						*
					FROM
						catalog_returns AS cr1
					WHERE
						cs1.cs_order_number
						= cr1.cr_order_number
				)
	ORDER BY
		count(DISTINCT cs_order_number)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: "order count":182!null "total shipping cost":183 "total net profit":184
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(182-184)
 ├── semi-join (hash)
 │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11!null cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null cc_call_center_sk:82!null cc_county:107!null
 │    ├── fd: ()-->(75,107), (37)-->(39), (3)==(37), (37)==(3), (11)==(67), (67)==(11), (12)==(82), (82)==(12)
 │    ├── inner-join (lookup customer_address)
 │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11!null cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null cc_call_center_sk:82!null cc_county:107!null
 │    │    ├── key columns: [11] = [67]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(75,107), (37)-->(39), (12)==(82), (82)==(12), (11)==(67), (67)==(11), (3)==(37), (37)==(3)
 │    │    ├── anti-join (hash)
 │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null cc_call_center_sk:82!null cc_county:107!null
 │    │    │    ├── fd: ()-->(107), (37)-->(39), (12)==(82), (82)==(12), (3)==(37), (37)==(3)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12!null cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null cc_call_center_sk:82!null cc_county:107!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(107), (37)-->(39), (12)==(82), (82)==(12), (3)==(37), (37)==(3)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: cs1.cs_ship_date_sk:3!null cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12 cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34 d_date_sk:37!null d_date:39!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (37)-->(39), (3)==(37), (37)==(3)
 │    │    │    │    │    ├── scan catalog_sales [as=cs1]
 │    │    │    │    │    │    └── columns: cs1.cs_ship_date_sk:3 cs1.cs_ship_addr_sk:11 cs1.cs_call_center_sk:12 cs1.cs_warehouse_sk:15 cs1.cs_order_number:18!null cs1.cs_ext_ship_cost:29 cs1.cs_net_profit:34
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39!null
 │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    ├── fd: (37)-->(39)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39
 │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    └── fd: (37)-->(39)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (d_date:39 >= '2002-04-01') AND (d_date:39 <= '2002-05-31') [outer=(39), constraints=(/39: [/'2002-04-01' - /'2002-05-31']; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── cs1.cs_ship_date_sk:3 = d_date_sk:37 [outer=(3,37), constraints=(/3: (/NULL - ]; /37: (/NULL - ]), fd=(3)==(37), (37)==(3)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: cc_call_center_sk:82!null cc_county:107!null
 │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    ├── fd: ()-->(107)
 │    │    │    │    │    ├── scan call_center
 │    │    │    │    │    │    ├── columns: cc_call_center_sk:82!null cc_county:107
 │    │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    │    └── fd: (82)-->(107)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── cc_county:107 = 'Williamson County' [outer=(107), constraints=(/107: [/'Williamson County' - /'Williamson County']; tight), fd=()-->(107)]
 │    │    │    │    └── filters
 │    │    │    │         └── cs1.cs_call_center_sk:12 = cc_call_center_sk:82 [outer=(12,82), constraints=(/12: (/NULL - ]; /82: (/NULL - ]), fd=(12)==(82), (82)==(12)]
 │    │    │    ├── scan catalog_returns [as=cr1]
 │    │    │    │    └── columns: cr_order_number:167!null
 │    │    │    └── filters
 │    │    │         └── cs1.cs_order_number:18 = cr_order_number:167 [outer=(18,167), constraints=(/18: (/NULL - ]; /167: (/NULL - ]), fd=(18)==(167), (167)==(18)]
 │    │    └── filters
 │    │         └── ca_state:75 = 'PA' [outer=(75), constraints=(/75: [/'PA' - /'PA']; tight), fd=()-->(75)]
 │    ├── scan catalog_sales [as=cs2]
 │    │    └── columns: cs2.cs_warehouse_sk:129 cs2.cs_order_number:132!null
 │    └── filters
 │         ├── cs1.cs_order_number:18 = cs2.cs_order_number:132 [outer=(18,132), constraints=(/18: (/NULL - ]; /132: (/NULL - ]), fd=(18)==(132), (132)==(18)]
 │         └── cs1.cs_warehouse_sk:15 != cs2.cs_warehouse_sk:129 [outer=(15,129), constraints=(/15: (/NULL - ]; /129: (/NULL - ])]
 └── aggregations
      ├── agg-distinct [as=count:182, outer=(18)]
      │    └── count
      │         └── cs1.cs_order_number:18
      ├── sum [as=sum:183, outer=(29)]
      │    └── cs1.cs_ext_ship_cost:29
      └── sum [as=sum:184, outer=(34)]
           └── cs1.cs_net_profit:34

# --------------------------------------------------
# Q17
opt
	SELECT
		i_item_id,
		i_item_desc,
		s_state,
		count(ss_quantity) AS store_sales_quantitycount,
		avg(ss_quantity) AS store_sales_quantityave,
		stddev_samp(ss_quantity) AS store_sales_quantitystdev,
		stddev_samp(ss_quantity) / avg(ss_quantity)
			AS store_sales_quantitycov,
		count(sr_return_quantity)
			AS store_returns_quantitycount,
		avg(sr_return_quantity) AS store_returns_quantityave,
		stddev_samp(sr_return_quantity)
			AS store_returns_quantitystdev,
		stddev_samp(sr_return_quantity)
		/ avg(sr_return_quantity)
			AS store_returns_quantitycov,
		count(cs_quantity) AS catalog_sales_quantitycount,
		avg(cs_quantity) AS catalog_sales_quantityave,
		stddev_samp(cs_quantity) AS catalog_sales_quantitystdev,
		stddev_samp(cs_quantity) / avg(cs_quantity)
			AS catalog_sales_quantitycov
	FROM
		store_sales,
		store_returns,
		catalog_sales,
		date_dim AS d1,
		date_dim AS d2,
		date_dim AS d3,
		store,
		item
	WHERE
		d1.d_quarter_name = '2001Q1'
		AND d1.d_date_sk = ss_sold_date_sk
		AND i_item_sk = ss_item_sk
		AND s_store_sk = ss_store_sk
		AND ss_customer_sk = sr_customer_sk
		AND ss_item_sk = sr_item_sk
		AND ss_ticket_number = sr_ticket_number
		AND sr_returned_date_sk = d2.d_date_sk
		AND d2.d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')
		AND sr_customer_sk = cs_bill_customer_sk
		AND sr_item_sk = cs_item_sk
		AND cs_sold_date_sk = d3.d_date_sk
		AND d3.d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')
	GROUP BY
		i_item_id, i_item_desc, s_state
	ORDER BY
		i_item_id, i_item_desc, s_state
	LIMIT
		100;
----
project
 ├── columns: i_item_id:206!null i_item_desc:209 s_state:198 store_sales_quantitycount:229!null store_sales_quantityave:230 store_sales_quantitystdev:231 store_sales_quantitycov:238 store_returns_quantitycount:232!null store_returns_quantityave:233 store_returns_quantitystdev:234 store_returns_quantitycov:239 catalog_sales_quantitycount:235!null catalog_sales_quantityave:236 catalog_sales_quantitystdev:237 catalog_sales_quantitycov:240
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (198,206,209)
 ├── fd: (198,206,209)-->(229-237), (230,231)-->(238), (233,234)-->(239), (236,237)-->(240)
 ├── ordering: +206,+209,+198
 ├── top-k
 │    ├── columns: s_state:198 i_item_id:206!null i_item_desc:209 count:229!null avg:230 stddev_samp:231 count:232!null avg:233 stddev_samp:234 count:235!null avg:236 stddev_samp:237
 │    ├── internal-ordering: +206,+209,+198
 │    ├── k: 100
 │    ├── cardinality: [0 - 100]
 │    ├── key: (198,206,209)
 │    ├── fd: (198,206,209)-->(229-237)
 │    ├── ordering: +206,+209,+198
 │    └── group-by (hash)
 │         ├── columns: s_state:198 i_item_id:206!null i_item_desc:209 count:229!null avg:230 stddev_samp:231 count:232!null avg:233 stddev_samp:234 count:235!null avg:236 stddev_samp:237
 │         ├── grouping columns: s_state:198 i_item_id:206!null i_item_desc:209
 │         ├── key: (198,206,209)
 │         ├── fd: (198,206,209)-->(229-237)
 │         ├── inner-join (lookup item)
 │         │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null d3.d_date_sk:144!null d3.d_quarter_name:159!null s_store_sk:174!null s_state:198 i_item_sk:205!null i_item_id:206!null i_item_desc:209
 │         │    ├── key columns: [63] = [205]
 │         │    ├── lookup columns are key
 │         │    ├── fd: ()-->(99), (3,10)-->(1,4,8,11), (174)-->(198), (28,35)-->(26,29,36), (144)-->(159), (205)-->(206,209), (114)-->(129), (8)==(174), (174)==(8), (48)==(144), (144)==(48), (3)==(28,63,205), (28)==(3,63,205), (63)==(3,28,205), (205)==(3,28,63), (4)==(29,51), (29)==(4,51), (51)==(4,29), (26)==(114), (114)==(26), (10)==(35), (35)==(10), (1)==(84), (84)==(1)
 │         │    ├── inner-join (lookup date_dim [as=d3])
 │         │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null d3.d_date_sk:144!null d3.d_quarter_name:159!null s_store_sk:174!null s_state:198
 │         │    │    ├── key columns: [48] = [144]
 │         │    │    ├── lookup columns are key
 │         │    │    ├── fd: ()-->(99), (174)-->(198), (144)-->(159), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (48)==(144), (144)==(48), (8)==(174), (174)==(8)
 │         │    │    ├── inner-join (lookup catalog_sales)
 │         │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48 cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    ├── key columns: [28] = [63]
 │         │    │    │    ├── fd: ()-->(99), (174)-->(198), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
 │         │    │    │    ├── inner-join (lookup date_dim [as=d1])
 │         │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d1.d_date_sk:84!null d1.d_quarter_name:99!null d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    │    ├── key columns: [1] = [84]
 │         │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    ├── fd: ()-->(99), (174)-->(198), (114)-->(129), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
 │         │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null s_store_sk:174!null s_state:198
 │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    ├── fd: (174)-->(198), (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (8)==(174), (174)==(8)
 │         │    │    │    │    │    ├── inner-join (lookup store_sales)
 │         │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8 ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
 │         │    │    │    │    │    │    ├── lookup columns are key
 │         │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    ├── fd: (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10)
 │         │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    │    ├── fd: (28,35)-->(26,29,36), (114)-->(129), (26)==(114), (114)==(26)
 │         │    │    │    │    │    │    │    ├── scan store_returns
 │         │    │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26 sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36
 │         │    │    │    │    │    │    │    │    ├── key: (28,35)
 │         │    │    │    │    │    │    │    │    └── fd: (28,35)-->(26,29,36)
 │         │    │    │    │    │    │    │    ├── select
 │         │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_quarter_name:129!null
 │         │    │    │    │    │    │    │    │    ├── key: (114)
 │         │    │    │    │    │    │    │    │    ├── fd: (114)-->(129)
 │         │    │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
 │         │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_quarter_name:129
 │         │    │    │    │    │    │    │    │    │    ├── key: (114)
 │         │    │    │    │    │    │    │    │    │    └── fd: (114)-->(129)
 │         │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │         └── d2.d_quarter_name:129 IN ('2001Q1', '2001Q2', '2001Q3') [outer=(129), constraints=(/129: [/'2001Q1' - /'2001Q1'] [/'2001Q2' - /'2001Q2'] [/'2001Q3' - /'2001Q3']; tight)]
 │         │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │         └── sr_returned_date_sk:26 = d2.d_date_sk:114 [outer=(26,114), constraints=(/26: (/NULL - ]; /114: (/NULL - ]), fd=(26)==(114), (114)==(26)]
 │         │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │         └── ss_customer_sk:4 = sr_customer_sk:29 [outer=(4,29), constraints=(/4: (/NULL - ]; /29: (/NULL - ]), fd=(4)==(29), (29)==(4)]
 │         │    │    │    │    │    ├── scan store
 │         │    │    │    │    │    │    ├── columns: s_store_sk:174!null s_state:198
 │         │    │    │    │    │    │    ├── key: (174)
 │         │    │    │    │    │    │    └── fd: (174)-->(198)
 │         │    │    │    │    │    └── filters
 │         │    │    │    │    │         └── s_store_sk:174 = ss_store_sk:8 [outer=(8,174), constraints=(/8: (/NULL - ]; /174: (/NULL - ]), fd=(8)==(174), (174)==(8)]
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── d1.d_quarter_name:99 = '2001Q1' [outer=(99), constraints=(/99: [/'2001Q1' - /'2001Q1']; tight), fd=()-->(99)]
 │         │    │    │    └── filters
 │         │    │    │         └── sr_customer_sk:29 = cs_bill_customer_sk:51 [outer=(29,51), constraints=(/29: (/NULL - ]; /51: (/NULL - ]), fd=(29)==(51), (51)==(29)]
 │         │    │    └── filters
 │         │    │         └── d3.d_quarter_name:159 IN ('2001Q1', '2001Q2', '2001Q3') [outer=(159), constraints=(/159: [/'2001Q1' - /'2001Q1'] [/'2001Q2' - /'2001Q2'] [/'2001Q3' - /'2001Q3']; tight)]
 │         │    └── filters (true)
 │         └── aggregations
 │              ├── count [as=count:229, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── avg [as=avg:230, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── std-dev [as=stddev_samp:231, outer=(11)]
 │              │    └── ss_quantity:11
 │              ├── count [as=count:232, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── avg [as=avg:233, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── std-dev [as=stddev_samp:234, outer=(36)]
 │              │    └── sr_return_quantity:36
 │              ├── count [as=count:235, outer=(66)]
 │              │    └── cs_quantity:66
 │              ├── avg [as=avg:236, outer=(66)]
 │              │    └── cs_quantity:66
 │              └── std-dev [as=stddev_samp:237, outer=(66)]
 │                   └── cs_quantity:66
 └── projections
      ├── stddev_samp:231 / avg:230 [as=store_sales_quantitycov:238, outer=(230,231), immutable]
      ├── stddev_samp:234 / avg:233 [as=store_returns_quantitycov:239, outer=(233,234), immutable]
      └── stddev_samp:237 / avg:236 [as=catalog_sales_quantitycov:240, outer=(236,237), immutable]

# --------------------------------------------------
# Q18
# TODO: adjust the query to work with CRDB.
# opt
# 	SELECT
# 		i_item_id,
# 		ca_country,
# 		ca_state,
# 		ca_county,
# 		avg(CAST(cs_quantity AS DECIMAL(12,2))) AS agg1,
# 		avg(CAST(cs_list_price AS DECIMAL(12,2))) AS agg2,
# 		avg(CAST(cs_coupon_amt AS DECIMAL(12,2))) AS agg3,
# 		avg(CAST(cs_sales_price AS DECIMAL(12,2))) AS agg4,
# 		avg(CAST(cs_net_profit AS DECIMAL(12,2))) AS agg5,
# 		avg(CAST(c_birth_year AS DECIMAL(12,2))) AS agg6,
# 		avg(CAST(cd1.cd_dep_count AS DECIMAL(12,2))) AS agg7
# 	FROM
# 		catalog_sales,
# 		customer_demographics AS cd1,
# 		customer_demographics AS cd2,
# 		customer,
# 		customer_address,
# 		date_dim,
# 		item
# 	WHERE
# 		cs_sold_date_sk = d_date_sk
# 		AND cs_item_sk = i_item_sk
# 		AND cs_bill_cdemo_sk = cd1.cd_demo_sk
# 		AND cs_bill_customer_sk = c_customer_sk
# 		AND cd1.cd_gender = 'F'
# 		AND cd1.cd_education_status = 'Primary'
# 		AND c_current_cdemo_sk = cd2.cd_demo_sk
# 		AND c_current_addr_sk = ca_address_sk
# 		AND c_birth_month IN (1, 3, 7, 11, 10, 4)
# 		AND d_year = 2001
# 		AND ca_state
# 			IN ('AL', 'MO', 'TN', 'GA', 'MT', 'IN', 'CA')
# 	GROUP BY
# 		rollup(i_item_id, ca_country, ca_state, ca_county)
# 	ORDER BY
# 		ca_country, ca_state, ca_county, i_item_id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q19
opt
	SELECT
		i_brand_id AS brand_id,
		i_brand AS brand,
		i_manufact_id,
		i_manufact,
		sum(ss_ext_sales_price) AS ext_price
	FROM
		date_dim,
		store_sales,
		item,
		customer,
		customer_address,
		store
	WHERE
		d_date_sk = ss_sold_date_sk
		AND ss_item_sk = i_item_sk
		AND i_manager_id = 14
		AND d_moy = 11
		AND d_year = 2002
		AND ss_customer_sk = c_customer_sk
		AND c_current_addr_sk = ca_address_sk
		AND substr(ca_zip, 1, 5) != substr(s_zip, 1, 5)
		AND ss_store_sk = s_store_sk
	GROUP BY
		i_brand, i_brand_id, i_manufact_id, i_manufact
	ORDER BY
		ext_price DESC,
		i_brand,
		i_brand_id,
		i_manufact_id,
		i_manufact
	LIMIT
		100;
----
top-k
 ├── columns: brand_id:63 brand:64 i_manufact_id:69 i_manufact:70 ext_price:146
 ├── internal-ordering: -146,+64,+63,+69,+70
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (63,64,69,70)
 ├── fd: (63,64,69,70)-->(146)
 ├── ordering: -146,+64,+63,+69,+70
 └── group-by (hash)
      ├── columns: i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 sum:146
      ├── grouping columns: i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70
      ├── immutable
      ├── key: (63,64,69,70)
      ├── fd: (63,64,69,70)-->(146)
      ├── inner-join (lookup customer_address)
      │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34!null ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null c_customer_sk:80!null c_current_addr_sk:84!null ca_address_sk:100!null ca_zip:109 s_store_sk:115!null s_zip:140
      │    ├── key columns: [84] = [100]
      │    ├── lookup columns are key
      │    ├── immutable
      │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (80)-->(84), (100)-->(109), (115)-->(140), (33)==(56), (56)==(33), (84)==(100), (100)==(84), (34)==(80), (80)==(34), (38)==(115), (115)==(38), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup customer)
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34!null ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null c_customer_sk:80!null c_current_addr_sk:84 s_store_sk:115!null s_zip:140
      │    │    ├── key columns: [34] = [80]
      │    │    ├── lookup columns are key
      │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (80)-->(84), (115)-->(140), (38)==(115), (115)==(38), (34)==(80), (80)==(34), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null s_store_sk:115!null s_zip:140
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (115)-->(140), (38)==(115), (115)==(38), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38 ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(7,9,76), (56)-->(63,64,69,70), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_customer_sk:34 ss_store_sk:38 ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    │    ├── key columns: [56] = [33]
      │    │    │    │    │    ├── fd: ()-->(76), (56)-->(63,64,69,70), (33)==(56), (56)==(33)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76!null
      │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    ├── fd: ()-->(76), (56)-->(63,64,69,70)
      │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manufact_id:69 i_manufact:70 i_manager_id:76
      │    │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    │    └── fd: (56)-->(63,64,69,70,76)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── i_manager_id:76 = 14 [outer=(76), constraints=(/76: [/14 - /14]; tight), fd=()-->(76)]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null
      │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    ├── fd: ()-->(7,9)
      │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    └── fd: (1)-->(7,9)
      │    │    │    │    │    └── filters
      │    │    │    │    │         ├── d_moy:9 = 11 [outer=(9), constraints=(/9: [/11 - /11]; tight), fd=()-->(9)]
      │    │    │    │    │         └── d_year:7 = 2002 [outer=(7), constraints=(/7: [/2002 - /2002]; tight), fd=()-->(7)]
      │    │    │    │    └── filters
      │    │    │    │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      │    │    │    ├── scan store
      │    │    │    │    ├── columns: s_store_sk:115!null s_zip:140
      │    │    │    │    ├── key: (115)
      │    │    │    │    └── fd: (115)-->(140)
      │    │    │    └── filters
      │    │    │         └── ss_store_sk:38 = s_store_sk:115 [outer=(38,115), constraints=(/38: (/NULL - ]; /115: (/NULL - ]), fd=(38)==(115), (115)==(38)]
      │    │    └── filters (true)
      │    └── filters
      │         └── substr(ca_zip:109, 1, 5) != substr(s_zip:140, 1, 5) [outer=(109,140), immutable]
      └── aggregations
           └── sum [as=sum:146, outer=(46)]
                └── ss_ext_sales_price:46

# --------------------------------------------------
# Q20
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
	    i_item_id,
	    i_item_desc,
	    i_category,
	    i_class,
	    i_current_price,
	    sum(cs_ext_sales_price) AS itemrevenue,
	    sum(cs_ext_sales_price) * 100
	    / sum(sum(cs_ext_sales_price)) OVER (
	            PARTITION BY i_class
	        )
	        AS revenueratio
	FROM
	    catalog_sales, item, date_dim
	WHERE
	    cs_item_sk = i_item_sk
	    AND i_category IN ('Books', 'Music', 'Sports')
	    AND cs_sold_date_sk = d_date_sk
	    AND d_date BETWEEN CAST('2002-06-18' AS DATE) AND (CAST('2002-06-18' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
	    i_item_id,
	    i_item_desc,
	    i_category,
	    i_class,
	    i_current_price
	ORDER BY
	    i_category,
	    i_class,
	    i_item_id,
	    i_item_desc,
	    revenueratio
	LIMIT
	    100;
----
top-k
 ├── columns: i_item_id:38!null i_item_desc:41 i_category:49!null i_class:47 i_current_price:42 itemrevenue:91 revenueratio:93
 ├── internal-ordering: +49,+47,+38,+41,+93
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (38,41,42,47,49)
 ├── fd: (38,41,42,47,49)-->(91,93)
 ├── ordering: +49,+47,+38,+41,+93
 └── project
      ├── columns: revenueratio:93 i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      ├── immutable
      ├── key: (38,41,42,47,49)
      ├── fd: (38,41,42,47,49)-->(91,93)
      ├── window partition=(47)
      │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91 sum:92
      │    ├── key: (38,41,42,47,49)
      │    ├── fd: (38,41,42,47,49)-->(91,92)
      │    ├── group-by (hash)
      │    │    ├── columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null sum:91
      │    │    ├── grouping columns: i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    ├── key: (38,41,42,47,49)
      │    │    ├── fd: (38,41,42,47,49)-->(91)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: cs_sold_date_sk:1!null cs_item_sk:16!null cs_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null d_date_sk:61!null d_date:63!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(38,41,42,47,49), (61)-->(63), (16)==(37), (37)==(16), (1)==(61), (61)==(1)
      │    │    │    ├── inner-join (lookup catalog_sales)
      │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_item_sk:16!null cs_ext_sales_price:24 i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    ├── key columns: [37] = [16]
      │    │    │    │    ├── fd: (37)-->(38,41,42,47,49), (16)==(37), (37)==(16)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49!null
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    ├── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_item_id:38!null i_item_desc:41 i_current_price:42 i_class:47 i_category:49
      │    │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    │    └── fd: (37)-->(38,41,42,47,49)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── i_category:49 IN ('Books', 'Music', 'Sports') [outer=(49), constraints=(/49: [/'Books' - /'Books'] [/'Music' - /'Music'] [/'Sports' - /'Sports']; tight)]
      │    │    │    │    └── filters (true)
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
      │    │    │    │    ├── key: (61)
      │    │    │    │    ├── fd: (61)-->(63)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
      │    │    │    │    │    ├── key: (61)
      │    │    │    │    │    └── fd: (61)-->(63)
      │    │    │    │    └── filters
      │    │    │    │         └── (d_date:63 >= '2002-06-18') AND (d_date:63 <= '2002-07-18') [outer=(63), constraints=(/63: [/'2002-06-18' - /'2002-07-18']; tight)]
      │    │    │    └── filters
      │    │    │         └── cs_sold_date_sk:1 = d_date_sk:61 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
      │    │    └── aggregations
      │    │         └── sum [as=sum:91, outer=(24)]
      │    │              └── cs_ext_sales_price:24
      │    └── windows
      │         └── sum [as=sum:92, outer=(91)]
      │              └── sum:91
      └── projections
           └── (sum:91 * 100) / sum:92 [as=revenueratio:93, outer=(91,92), immutable]

# --------------------------------------------------
# Q21
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
		*
	FROM
		(
			SELECT
				w_warehouse_name,
				i_item_id,
				sum(
					CASE
					WHEN (
						CAST(d_date AS DATE)
						< CAST('1999-06-22' AS DATE)
					)
					THEN inv_quantity_on_hand
					ELSE 0
					END
				)
					AS inv_before,
				sum(
					CASE
					WHEN (
						CAST(d_date AS DATE)
						>= CAST('1999-06-22' AS DATE)
					)
					THEN inv_quantity_on_hand
					ELSE 0
					END
				)
					AS inv_after
			FROM
				inventory, warehouse, item, date_dim
			WHERE
				i_current_price BETWEEN 0.99 AND 1.49
				AND i_item_sk = inv_item_sk
				AND inv_warehouse_sk = w_warehouse_sk
				AND inv_date_sk = d_date_sk
				AND d_date BETWEEN (CAST('1999-06-22' AS DATE) - '30 days'::INTERVAL) AND (CAST('1999-06-22' AS DATE) + '30 days'::INTERVAL)
			GROUP BY
				w_warehouse_name, i_item_id
		)
			AS x
	WHERE
		(CASE WHEN inv_before > 0 THEN inv_after / inv_before ELSE NULL END) BETWEEN (2.0 / 3.0) AND (3.0 / 2.0)
	ORDER BY
		w_warehouse_name, i_item_id
	LIMIT
		100;
----
top-k
 ├── columns: w_warehouse_name:9 i_item_id:24!null inv_before:78 inv_after:80
 ├── internal-ordering: +9,+24
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (9,24)
 ├── fd: (9,24)-->(78,80)
 ├── ordering: +9,+24
 └── select
      ├── columns: w_warehouse_name:9 i_item_id:24!null sum:78 sum:80
      ├── immutable
      ├── key: (9,24)
      ├── fd: (9,24)-->(78,80)
      ├── group-by (hash)
      │    ├── columns: w_warehouse_name:9 i_item_id:24!null sum:78 sum:80
      │    ├── grouping columns: w_warehouse_name:9 i_item_id:24!null
      │    ├── immutable
      │    ├── key: (9,24)
      │    ├── fd: (9,24)-->(78,80)
      │    ├── project
      │    │    ├── columns: column77:77 column79:79 w_warehouse_name:9 i_item_id:24!null
      │    │    ├── immutable
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 w_warehouse_sk:7!null w_warehouse_name:9 i_item_sk:23!null i_item_id:24!null i_current_price:28!null d_date_sk:47!null d_date:49!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── immutable
      │    │    │    ├── key: (7,23,47)
      │    │    │    ├── fd: (1-3)-->(4), (7)-->(9), (23)-->(24,28), (47)-->(49), (3)==(7), (7)==(3), (2)==(23), (23)==(2), (1)==(47), (47)==(1)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 i_item_sk:23!null i_item_id:24!null i_current_price:28!null d_date_sk:47!null d_date:49!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (3,23,47)
      │    │    │    │    ├── fd: (23)-->(24,28), (1-3)-->(4), (47)-->(49), (1)==(47), (47)==(1), (2)==(23), (23)==(2)
      │    │    │    │    ├── inner-join (lookup inventory)
      │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 d_date_sk:47!null d_date:49!null
      │    │    │    │    │    ├── key columns: [47] = [1]
      │    │    │    │    │    ├── key: (2,3,47)
      │    │    │    │    │    ├── fd: (1-3)-->(4), (47)-->(49), (1)==(47), (47)==(1)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_date:49!null
      │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    ├── fd: (47)-->(49)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_date:49
      │    │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    │    └── fd: (47)-->(49)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── (d_date:49 >= '1999-05-23') AND (d_date:49 <= '1999-07-22') [outer=(49), constraints=(/49: [/'1999-05-23' - /'1999-07-22']; tight)]
      │    │    │    │    │    └── filters (true)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:23!null i_item_id:24!null i_current_price:28!null
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── key: (23)
      │    │    │    │    │    ├── fd: (23)-->(24,28)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:23!null i_item_id:24!null i_current_price:28
      │    │    │    │    │    │    ├── key: (23)
      │    │    │    │    │    │    └── fd: (23)-->(24,28)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── (i_current_price:28 >= 0.99) AND (i_current_price:28 <= 1.49) [outer=(28), immutable, constraints=(/28: [/0.99 - /1.49]; tight)]
      │    │    │    │    └── filters
      │    │    │    │         └── i_item_sk:23 = inv_item_sk:2 [outer=(2,23), constraints=(/2: (/NULL - ]; /23: (/NULL - ]), fd=(2)==(23), (23)==(2)]
      │    │    │    ├── scan warehouse
      │    │    │    │    ├── columns: w_warehouse_sk:7!null w_warehouse_name:9
      │    │    │    │    ├── key: (7)
      │    │    │    │    └── fd: (7)-->(9)
      │    │    │    └── filters
      │    │    │         └── inv_warehouse_sk:3 = w_warehouse_sk:7 [outer=(3,7), constraints=(/3: (/NULL - ]; /7: (/NULL - ]), fd=(3)==(7), (7)==(3)]
      │    │    └── projections
      │    │         ├── CASE WHEN d_date:49 < '1999-06-22' THEN inv_quantity_on_hand:4 ELSE 0 END [as=column77:77, outer=(4,49)]
      │    │         └── CASE WHEN d_date:49 >= '1999-06-22' THEN inv_quantity_on_hand:4 ELSE 0 END [as=column79:79, outer=(4,49)]
      │    └── aggregations
      │         ├── sum [as=sum:78, outer=(77)]
      │         │    └── column77:77
      │         └── sum [as=sum:80, outer=(79)]
      │              └── column79:79
      └── filters
           ├── CASE WHEN sum:78 > 0 THEN sum:80 / sum:78 ELSE CAST(NULL AS DECIMAL) END >= 0.66666666666666666667 [outer=(78,80), immutable]
           └── CASE WHEN sum:78 > 0 THEN sum:80 / sum:78 ELSE CAST(NULL AS DECIMAL) END <= 1.5000000000000000000 [outer=(78,80), immutable]

# --------------------------------------------------
# Q22
# TODO: adjust the query to work with CRDB.
# opt
# 	SELECT
# 		i_product_name,
# 		i_brand,
# 		i_class,
# 		i_category,
# 		avg(inv_quantity_on_hand) AS qoh
# 	FROM
# 		inventory, date_dim, item
# 	WHERE
# 		inv_date_sk = d_date_sk
# 		AND inv_item_sk = i_item_sk
# 		AND d_month_seq BETWEEN 1200 AND (1200 + 11)
# 	GROUP BY
# 		rollup(i_product_name, i_brand, i_class, i_category)
# 	ORDER BY
# 		qoh, i_product_name, i_brand, i_class, i_category
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q23
# NOTE: Q23 has two queries.
opt
	WITH
		frequent_ss_items
			AS (
				SELECT
					substr(i_item_desc, 1, 30) AS itemdesc,
					i_item_sk AS item_sk,
					d_date AS solddate,
					count(*) AS cnt
				FROM
					store_sales, date_dim, item
				WHERE
					ss_sold_date_sk = d_date_sk
					AND ss_item_sk = i_item_sk
					AND d_year
						IN (2000, 2000 + 1, 2000 + 2, 2000 + 3)
				GROUP BY
					substr(i_item_desc, 1, 30),
					i_item_sk,
					d_date
				HAVING
					count(*) > 4
			),
		max_store_sales
			AS (
				SELECT
					max(csales) AS tpcds_cmax
				FROM
					(
						SELECT
							c_customer_sk,
							sum(ss_quantity * ss_sales_price)
								AS csales
						FROM
							store_sales, customer, date_dim
						WHERE
							ss_customer_sk = c_customer_sk
							AND ss_sold_date_sk = d_date_sk
							AND d_year
								IN (
										2000,
										2000 + 1,
										2000 + 2,
										2000 + 3
									)
						GROUP BY
							c_customer_sk
					)
			),
		best_ss_customer
			AS (
				SELECT
					c_customer_sk,
					sum(ss_quantity * ss_sales_price) AS ssales
				FROM
					store_sales, customer
				WHERE
					ss_customer_sk = c_customer_sk
				GROUP BY
					c_customer_sk
				HAVING
					sum(ss_quantity * ss_sales_price)
					> 95 / 100.0
						* (SELECT * FROM max_store_sales)
			)
	SELECT
		sum(sales)
	FROM
		(
			SELECT
				cs_quantity * cs_list_price AS sales
			FROM
				catalog_sales, date_dim
			WHERE
				d_year = 2000
				AND d_moy = 7
				AND cs_sold_date_sk = d_date_sk
				AND cs_item_sk
					IN (SELECT item_sk FROM frequent_ss_items)
				AND cs_bill_customer_sk
					IN (
							SELECT
								c_customer_sk
							FROM
								best_ss_customer
						)
			UNION ALL
				SELECT
					ws_quantity * ws_list_price AS sales
				FROM
					web_sales, date_dim
				WHERE
					d_year = 2000
					AND d_moy = 7
					AND ws_sold_date_sk = d_date_sk
					AND ws_item_sk
						IN (
								SELECT
									item_sk
								FROM
									frequent_ss_items
							)
					AND ws_bill_customer_sk
						IN (
								SELECT
									c_customer_sk
								FROM
									best_ss_customer
							)
		)
	LIMIT
		100;
----
with &1 (frequent_ss_items)
 ├── columns: sum:359
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(359)
 ├── select
 │    ├── columns: d_date:28 i_item_sk:56!null count_rows:80!null column81:81
 │    ├── immutable
 │    ├── key: (28,56)
 │    ├── fd: (56)-->(81), (28,56)-->(80,81)
 │    ├── group-by (hash)
 │    │    ├── columns: d_date:28 i_item_sk:56!null count_rows:80!null column81:81
 │    │    ├── grouping columns: d_date:28 i_item_sk:56!null
 │    │    ├── immutable
 │    │    ├── key: (28,56)
 │    │    ├── fd: (56)-->(81), (28,56)-->(80,81)
 │    │    ├── project
 │    │    │    ├── columns: column81:81 d_date:28 i_item_sk:56!null
 │    │    │    ├── immutable
 │    │    │    ├── fd: (56)-->(81)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null d_date_sk:26!null d_date:28 d_year:32!null i_item_sk:56!null i_item_desc:60
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (26)-->(28,32), (56)-->(60), (1)==(26), (26)==(1), (3)==(56), (56)==(3)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null d_date_sk:26!null d_date:28 d_year:32!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (26)-->(28,32), (1)==(26), (26)==(1)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_item_sk:3!null
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_year:32!null
 │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    ├── fd: (26)-->(28,32)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_year:32
 │    │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    │    └── fd: (26)-->(28,32)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002, 2003) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002] [/2003 - /2003]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    │    │    ├── scan item
 │    │    │    │    │    ├── columns: i_item_sk:56!null i_item_desc:60
 │    │    │    │    │    ├── key: (56)
 │    │    │    │    │    └── fd: (56)-->(60)
 │    │    │    │    └── filters
 │    │    │    │         └── ss_item_sk:3 = i_item_sk:56 [outer=(3,56), constraints=(/3: (/NULL - ]; /56: (/NULL - ]), fd=(3)==(56), (56)==(3)]
 │    │    │    └── projections
 │    │    │         └── substr(i_item_desc:60, 1, 30) [as=column81:81, outer=(60), immutable]
 │    │    └── aggregations
 │    │         ├── count-rows [as=count_rows:80]
 │    │         └── const-agg [as=column81:81, outer=(81)]
 │    │              └── column81:81
 │    └── filters
 │         └── count_rows:80 > 4 [outer=(80), constraints=(/80: [/5 - ]; tight)]
 └── with &3 (best_ss_customer)
      ├── columns: sum:359
      ├── cardinality: [1 - 1]
      ├── immutable
      ├── key: ()
      ├── fd: ()-->(359)
      ├── select
      │    ├── columns: customer.c_customer_sk:185!null sum:206!null
      │    ├── immutable
      │    ├── key: (185)
      │    ├── fd: (185)-->(206)
      │    ├── group-by (hash)
      │    │    ├── columns: customer.c_customer_sk:185!null sum:206
      │    │    ├── grouping columns: customer.c_customer_sk:185!null
      │    │    ├── immutable
      │    │    ├── key: (185)
      │    │    ├── fd: (185)-->(206)
      │    │    ├── project
      │    │    │    ├── columns: column205:205 customer.c_customer_sk:185!null
      │    │    │    ├── immutable
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ss_customer_sk:163!null ss_quantity:170 ss_sales_price:173 customer.c_customer_sk:185!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: (163)==(185), (185)==(163)
      │    │    │    │    ├── scan store_sales
      │    │    │    │    │    └── columns: ss_customer_sk:163 ss_quantity:170 ss_sales_price:173
      │    │    │    │    ├── scan customer
      │    │    │    │    │    ├── columns: customer.c_customer_sk:185!null
      │    │    │    │    │    └── key: (185)
      │    │    │    │    └── filters
      │    │    │    │         └── ss_customer_sk:163 = customer.c_customer_sk:185 [outer=(163,185), constraints=(/163: (/NULL - ]; /185: (/NULL - ]), fd=(163)==(185), (185)==(163)]
      │    │    │    └── projections
      │    │    │         └── ss_quantity:170 * ss_sales_price:173 [as=column205:205, outer=(170,173), immutable]
      │    │    └── aggregations
      │    │         └── sum [as=sum:206, outer=(205)]
      │    │              └── column205:205
      │    └── filters
      │         └── gt [outer=(206), immutable, subquery, constraints=(/206: (/NULL - ])]
      │              ├── sum:206
      │              └── mult
      │                   ├── subquery
      │                   │    └── project
      │                   │         ├── columns: tpcds_cmax:207
      │                   │         ├── cardinality: [1 - 1]
      │                   │         ├── immutable
      │                   │         ├── key: ()
      │                   │         ├── fd: ()-->(207)
      │                   │         ├── scalar-group-by
      │                   │         │    ├── columns: max:159
      │                   │         │    ├── cardinality: [1 - 1]
      │                   │         │    ├── immutable
      │                   │         │    ├── key: ()
      │                   │         │    ├── fd: ()-->(159)
      │                   │         │    ├── group-by (hash)
      │                   │         │    │    ├── columns: customer.c_customer_sk:107!null sum:158
      │                   │         │    │    ├── grouping columns: customer.c_customer_sk:107!null
      │                   │         │    │    ├── immutable
      │                   │         │    │    ├── key: (107)
      │                   │         │    │    ├── fd: (107)-->(158)
      │                   │         │    │    ├── project
      │                   │         │    │    │    ├── columns: column157:157 customer.c_customer_sk:107!null
      │                   │         │    │    │    ├── immutable
      │                   │         │    │    │    ├── inner-join (hash)
      │                   │         │    │    │    │    ├── columns: ss_sold_date_sk:82!null ss_customer_sk:85!null ss_quantity:92 ss_sales_price:95 customer.c_customer_sk:107!null d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │                   │         │    │    │    │    ├── fd: (127)-->(133), (85)==(107), (107)==(85), (82)==(127), (127)==(82)
      │                   │         │    │    │    │    ├── inner-join (hash)
      │                   │         │    │    │    │    │    ├── columns: ss_sold_date_sk:82!null ss_customer_sk:85 ss_quantity:92 ss_sales_price:95 d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │                   │         │    │    │    │    │    ├── fd: (127)-->(133), (82)==(127), (127)==(82)
      │                   │         │    │    │    │    │    ├── scan store_sales
      │                   │         │    │    │    │    │    │    └── columns: ss_sold_date_sk:82 ss_customer_sk:85 ss_quantity:92 ss_sales_price:95
      │                   │         │    │    │    │    │    ├── select
      │                   │         │    │    │    │    │    │    ├── columns: d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    │    │    ├── key: (127)
      │                   │         │    │    │    │    │    │    ├── fd: (127)-->(133)
      │                   │         │    │    │    │    │    │    ├── scan date_dim
      │                   │         │    │    │    │    │    │    │    ├── columns: d_date_sk:127!null d_year:133
      │                   │         │    │    │    │    │    │    │    ├── key: (127)
      │                   │         │    │    │    │    │    │    │    └── fd: (127)-->(133)
      │                   │         │    │    │    │    │    │    └── filters
      │                   │         │    │    │    │    │    │         └── d_year:133 IN (2000, 2001, 2002, 2003) [outer=(133), constraints=(/133: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002] [/2003 - /2003]; tight)]
      │                   │         │    │    │    │    │    └── filters
      │                   │         │    │    │    │    │         └── ss_sold_date_sk:82 = d_date_sk:127 [outer=(82,127), constraints=(/82: (/NULL - ]; /127: (/NULL - ]), fd=(82)==(127), (127)==(82)]
      │                   │         │    │    │    │    ├── scan customer
      │                   │         │    │    │    │    │    ├── columns: customer.c_customer_sk:107!null
      │                   │         │    │    │    │    │    └── key: (107)
      │                   │         │    │    │    │    └── filters
      │                   │         │    │    │    │         └── ss_customer_sk:85 = customer.c_customer_sk:107 [outer=(85,107), constraints=(/85: (/NULL - ]; /107: (/NULL - ]), fd=(85)==(107), (107)==(85)]
      │                   │         │    │    │    └── projections
      │                   │         │    │    │         └── ss_quantity:92 * ss_sales_price:95 [as=column157:157, outer=(92,95), immutable]
      │                   │         │    │    └── aggregations
      │                   │         │    │         └── sum [as=sum:158, outer=(157)]
      │                   │         │    │              └── column157:157
      │                   │         │    └── aggregations
      │                   │         │         └── max [as=max:159, outer=(158)]
      │                   │         │              └── sum:158
      │                   │         └── projections
      │                   │              └── max:159 [as=tpcds_cmax:207, outer=(159)]
      │                   └── 0.95000000000000000000
      └── scalar-group-by
           ├── columns: sum:359
           ├── cardinality: [1 - 1]
           ├── immutable
           ├── key: ()
           ├── fd: ()-->(359)
           ├── union-all
           │    ├── columns: sales:358
           │    ├── left columns: sales:282
           │    ├── right columns: sales:357
           │    ├── immutable
           │    ├── project
           │    │    ├── columns: sales:282
           │    │    ├── immutable
           │    │    ├── project
           │    │    │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:244!null d_year:250!null d_moy:252!null
           │    │    │    ├── fd: ()-->(250,252), (208)==(244), (244)==(208)
           │    │    │    └── inner-join (hash)
           │    │    │         ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:244!null d_year:250!null d_moy:252!null item_sk:275!null
           │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │         ├── fd: ()-->(250,252), (208)==(244), (244)==(208), (223)==(275), (275)==(223)
           │    │    │         ├── semi-join (hash)
           │    │    │         │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:244!null d_year:250!null d_moy:252!null
           │    │    │         │    ├── fd: ()-->(250,252), (208)==(244), (244)==(208)
           │    │    │         │    ├── inner-join (hash)
           │    │    │         │    │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:244!null d_year:250!null d_moy:252!null
           │    │    │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │         │    │    ├── fd: ()-->(250,252), (208)==(244), (244)==(208)
           │    │    │         │    │    ├── scan catalog_sales
           │    │    │         │    │    │    └── columns: cs_sold_date_sk:208 cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228
           │    │    │         │    │    ├── select
           │    │    │         │    │    │    ├── columns: d_date_sk:244!null d_year:250!null d_moy:252!null
           │    │    │         │    │    │    ├── key: (244)
           │    │    │         │    │    │    ├── fd: ()-->(250,252)
           │    │    │         │    │    │    ├── scan date_dim
           │    │    │         │    │    │    │    ├── columns: d_date_sk:244!null d_year:250 d_moy:252
           │    │    │         │    │    │    │    ├── key: (244)
           │    │    │         │    │    │    │    └── fd: (244)-->(250,252)
           │    │    │         │    │    │    └── filters
           │    │    │         │    │    │         ├── d_year:250 = 2000 [outer=(250), constraints=(/250: [/2000 - /2000]; tight), fd=()-->(250)]
           │    │    │         │    │    │         └── d_moy:252 = 7 [outer=(252), constraints=(/252: [/7 - /7]; tight), fd=()-->(252)]
           │    │    │         │    │    └── filters
           │    │    │         │    │         └── cs_sold_date_sk:208 = d_date_sk:244 [outer=(208,244), constraints=(/208: (/NULL - ]; /244: (/NULL - ]), fd=(208)==(244), (244)==(208)]
           │    │    │         │    ├── with-scan &3 (best_ss_customer)
           │    │    │         │    │    ├── columns: c_customer_sk:278!null
           │    │    │         │    │    ├── mapping:
           │    │    │         │    │    │    └──  customer.c_customer_sk:185 => c_customer_sk:278
           │    │    │         │    │    └── key: (278)
           │    │    │         │    └── filters
           │    │    │         │         └── cs_bill_customer_sk:211 = c_customer_sk:278 [outer=(211,278), constraints=(/211: (/NULL - ]; /278: (/NULL - ]), fd=(211)==(278), (278)==(211)]
           │    │    │         ├── distinct-on
           │    │    │         │    ├── columns: item_sk:275!null
           │    │    │         │    ├── grouping columns: item_sk:275!null
           │    │    │         │    ├── key: (275)
           │    │    │         │    └── with-scan &1 (frequent_ss_items)
           │    │    │         │         ├── columns: item_sk:275!null
           │    │    │         │         └── mapping:
           │    │    │         │              └──  i_item_sk:56 => item_sk:275
           │    │    │         └── filters
           │    │    │              └── cs_item_sk:223 = item_sk:275 [outer=(223,275), constraints=(/223: (/NULL - ]; /275: (/NULL - ]), fd=(223)==(275), (275)==(223)]
           │    │    └── projections
           │    │         └── cs_quantity:226 * cs_list_price:228 [as=sales:282, outer=(226,228), immutable]
           │    └── project
           │         ├── columns: sales:357
           │         ├── immutable
           │         ├── project
           │         │    ├── columns: ws_sold_date_sk:283!null ws_item_sk:286!null ws_bill_customer_sk:287 ws_quantity:301 ws_list_price:303 d_date_sk:319!null d_year:325!null d_moy:327!null
           │         │    ├── fd: ()-->(325,327), (283)==(319), (319)==(283)
           │         │    └── inner-join (hash)
           │         │         ├── columns: ws_sold_date_sk:283!null ws_item_sk:286!null ws_bill_customer_sk:287 ws_quantity:301 ws_list_price:303 d_date_sk:319!null d_year:325!null d_moy:327!null item_sk:350!null
           │         │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │         │         ├── fd: ()-->(325,327), (283)==(319), (319)==(283), (286)==(350), (350)==(286)
           │         │         ├── semi-join (hash)
           │         │         │    ├── columns: ws_sold_date_sk:283!null ws_item_sk:286!null ws_bill_customer_sk:287 ws_quantity:301 ws_list_price:303 d_date_sk:319!null d_year:325!null d_moy:327!null
           │         │         │    ├── fd: ()-->(325,327), (283)==(319), (319)==(283)
           │         │         │    ├── inner-join (hash)
           │         │         │    │    ├── columns: ws_sold_date_sk:283!null ws_item_sk:286!null ws_bill_customer_sk:287 ws_quantity:301 ws_list_price:303 d_date_sk:319!null d_year:325!null d_moy:327!null
           │         │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │         │         │    │    ├── fd: ()-->(325,327), (283)==(319), (319)==(283)
           │         │         │    │    ├── scan web_sales
           │         │         │    │    │    └── columns: ws_sold_date_sk:283 ws_item_sk:286!null ws_bill_customer_sk:287 ws_quantity:301 ws_list_price:303
           │         │         │    │    ├── select
           │         │         │    │    │    ├── columns: d_date_sk:319!null d_year:325!null d_moy:327!null
           │         │         │    │    │    ├── key: (319)
           │         │         │    │    │    ├── fd: ()-->(325,327)
           │         │         │    │    │    ├── scan date_dim
           │         │         │    │    │    │    ├── columns: d_date_sk:319!null d_year:325 d_moy:327
           │         │         │    │    │    │    ├── key: (319)
           │         │         │    │    │    │    └── fd: (319)-->(325,327)
           │         │         │    │    │    └── filters
           │         │         │    │    │         ├── d_year:325 = 2000 [outer=(325), constraints=(/325: [/2000 - /2000]; tight), fd=()-->(325)]
           │         │         │    │    │         └── d_moy:327 = 7 [outer=(327), constraints=(/327: [/7 - /7]; tight), fd=()-->(327)]
           │         │         │    │    └── filters
           │         │         │    │         └── ws_sold_date_sk:283 = d_date_sk:319 [outer=(283,319), constraints=(/283: (/NULL - ]; /319: (/NULL - ]), fd=(283)==(319), (319)==(283)]
           │         │         │    ├── with-scan &3 (best_ss_customer)
           │         │         │    │    ├── columns: c_customer_sk:353!null
           │         │         │    │    ├── mapping:
           │         │         │    │    │    └──  customer.c_customer_sk:185 => c_customer_sk:353
           │         │         │    │    └── key: (353)
           │         │         │    └── filters
           │         │         │         └── ws_bill_customer_sk:287 = c_customer_sk:353 [outer=(287,353), constraints=(/287: (/NULL - ]; /353: (/NULL - ]), fd=(287)==(353), (353)==(287)]
           │         │         ├── distinct-on
           │         │         │    ├── columns: item_sk:350!null
           │         │         │    ├── grouping columns: item_sk:350!null
           │         │         │    ├── key: (350)
           │         │         │    └── with-scan &1 (frequent_ss_items)
           │         │         │         ├── columns: item_sk:350!null
           │         │         │         └── mapping:
           │         │         │              └──  i_item_sk:56 => item_sk:350
           │         │         └── filters
           │         │              └── ws_item_sk:286 = item_sk:350 [outer=(286,350), constraints=(/286: (/NULL - ]; /350: (/NULL - ]), fd=(286)==(350), (350)==(286)]
           │         └── projections
           │              └── ws_quantity:301 * ws_list_price:303 [as=sales:357, outer=(301,303), immutable]
           └── aggregations
                └── sum [as=sum:359, outer=(358)]
                     └── sales:358

opt
	WITH
		frequent_ss_items
			AS (
				SELECT
					substr(i_item_desc, 1, 30) AS itemdesc,
					i_item_sk AS item_sk,
					d_date AS solddate,
					count(*) AS cnt
				FROM
					store_sales, date_dim, item
				WHERE
					ss_sold_date_sk = d_date_sk
					AND ss_item_sk = i_item_sk
					AND d_year
						IN (2000, 2000 + 1, 2000 + 2, 2000 + 3)
				GROUP BY
					substr(i_item_desc, 1, 30),
					i_item_sk,
					d_date
				HAVING
					count(*) > 4
			),
		max_store_sales
			AS (
				SELECT
					max(csales) AS tpcds_cmax
				FROM
					(
						SELECT
							c_customer_sk,
							sum(ss_quantity * ss_sales_price)
								AS csales
						FROM
							store_sales, customer, date_dim
						WHERE
							ss_customer_sk = c_customer_sk
							AND ss_sold_date_sk = d_date_sk
							AND d_year
								IN (
										2000,
										2000 + 1,
										2000 + 2,
										2000 + 3
									)
						GROUP BY
							c_customer_sk
					)
			),
		best_ss_customer
			AS (
				SELECT
					c_customer_sk,
					sum(ss_quantity * ss_sales_price) AS ssales
				FROM
					store_sales, customer
				WHERE
					ss_customer_sk = c_customer_sk
				GROUP BY
					c_customer_sk
				HAVING
					sum(ss_quantity * ss_sales_price)
					> 95 / 100.0
						* (SELECT * FROM max_store_sales)
			)
	SELECT
		c_last_name, c_first_name, sales
	FROM
		(
			SELECT
				c_last_name,
				c_first_name,
				sum(cs_quantity * cs_list_price) AS sales
			FROM
				catalog_sales, customer, date_dim
			WHERE
				d_year = 2000
				AND d_moy = 7
				AND cs_sold_date_sk = d_date_sk
				AND cs_item_sk
					IN (SELECT item_sk FROM frequent_ss_items)
				AND cs_bill_customer_sk
					IN (
							SELECT
								c_customer_sk
							FROM
								best_ss_customer
						)
				AND cs_bill_customer_sk = c_customer_sk
			GROUP BY
				c_last_name, c_first_name
			UNION ALL
				SELECT
					c_last_name,
					c_first_name,
					sum(ws_quantity * ws_list_price) AS sales
				FROM
					web_sales, customer, date_dim
				WHERE
					d_year = 2000
					AND d_moy = 7
					AND ws_sold_date_sk = d_date_sk
					AND ws_item_sk
						IN (
								SELECT
									item_sk
								FROM
									frequent_ss_items
							)
					AND ws_bill_customer_sk
						IN (
								SELECT
									c_customer_sk
								FROM
									best_ss_customer
							)
					AND ws_bill_customer_sk = c_customer_sk
				GROUP BY
					c_last_name, c_first_name
		)
	ORDER BY
		c_last_name, c_first_name, sales
	LIMIT
		100;
----
with &1 (frequent_ss_items)
 ├── columns: c_last_name:400 c_first_name:401 sales:402
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +400,+401,+402
 ├── select
 │    ├── columns: d_date:28 i_item_sk:56!null count_rows:80!null column81:81
 │    ├── immutable
 │    ├── key: (28,56)
 │    ├── fd: (56)-->(81), (28,56)-->(80,81)
 │    ├── group-by (hash)
 │    │    ├── columns: d_date:28 i_item_sk:56!null count_rows:80!null column81:81
 │    │    ├── grouping columns: d_date:28 i_item_sk:56!null
 │    │    ├── immutable
 │    │    ├── key: (28,56)
 │    │    ├── fd: (56)-->(81), (28,56)-->(80,81)
 │    │    ├── project
 │    │    │    ├── columns: column81:81 d_date:28 i_item_sk:56!null
 │    │    │    ├── immutable
 │    │    │    ├── fd: (56)-->(81)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null d_date_sk:26!null d_date:28 d_year:32!null i_item_sk:56!null i_item_desc:60
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (26)-->(28,32), (56)-->(60), (1)==(26), (26)==(1), (3)==(56), (56)==(3)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null d_date_sk:26!null d_date:28 d_year:32!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (26)-->(28,32), (1)==(26), (26)==(1)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_item_sk:3!null
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_year:32!null
 │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    ├── fd: (26)-->(28,32)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_year:32
 │    │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    │    └── fd: (26)-->(28,32)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002, 2003) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002] [/2003 - /2003]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    │    │    ├── scan item
 │    │    │    │    │    ├── columns: i_item_sk:56!null i_item_desc:60
 │    │    │    │    │    ├── key: (56)
 │    │    │    │    │    └── fd: (56)-->(60)
 │    │    │    │    └── filters
 │    │    │    │         └── ss_item_sk:3 = i_item_sk:56 [outer=(3,56), constraints=(/3: (/NULL - ]; /56: (/NULL - ]), fd=(3)==(56), (56)==(3)]
 │    │    │    └── projections
 │    │    │         └── substr(i_item_desc:60, 1, 30) [as=column81:81, outer=(60), immutable]
 │    │    └── aggregations
 │    │         ├── count-rows [as=count_rows:80]
 │    │         └── const-agg [as=column81:81, outer=(81)]
 │    │              └── column81:81
 │    └── filters
 │         └── count_rows:80 > 4 [outer=(80), constraints=(/80: [/5 - ]; tight)]
 └── with &3 (best_ss_customer)
      ├── columns: c_last_name:400 c_first_name:401 sales:402
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +400,+401,+402
      ├── select
      │    ├── columns: customer.c_customer_sk:185!null sum:206!null
      │    ├── immutable
      │    ├── key: (185)
      │    ├── fd: (185)-->(206)
      │    ├── group-by (hash)
      │    │    ├── columns: customer.c_customer_sk:185!null sum:206
      │    │    ├── grouping columns: customer.c_customer_sk:185!null
      │    │    ├── immutable
      │    │    ├── key: (185)
      │    │    ├── fd: (185)-->(206)
      │    │    ├── project
      │    │    │    ├── columns: column205:205 customer.c_customer_sk:185!null
      │    │    │    ├── immutable
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ss_customer_sk:163!null ss_quantity:170 ss_sales_price:173 customer.c_customer_sk:185!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: (163)==(185), (185)==(163)
      │    │    │    │    ├── scan store_sales
      │    │    │    │    │    └── columns: ss_customer_sk:163 ss_quantity:170 ss_sales_price:173
      │    │    │    │    ├── scan customer
      │    │    │    │    │    ├── columns: customer.c_customer_sk:185!null
      │    │    │    │    │    └── key: (185)
      │    │    │    │    └── filters
      │    │    │    │         └── ss_customer_sk:163 = customer.c_customer_sk:185 [outer=(163,185), constraints=(/163: (/NULL - ]; /185: (/NULL - ]), fd=(163)==(185), (185)==(163)]
      │    │    │    └── projections
      │    │    │         └── ss_quantity:170 * ss_sales_price:173 [as=column205:205, outer=(170,173), immutable]
      │    │    └── aggregations
      │    │         └── sum [as=sum:206, outer=(205)]
      │    │              └── column205:205
      │    └── filters
      │         └── gt [outer=(206), immutable, subquery, constraints=(/206: (/NULL - ])]
      │              ├── sum:206
      │              └── mult
      │                   ├── subquery
      │                   │    └── project
      │                   │         ├── columns: tpcds_cmax:207
      │                   │         ├── cardinality: [1 - 1]
      │                   │         ├── immutable
      │                   │         ├── key: ()
      │                   │         ├── fd: ()-->(207)
      │                   │         ├── scalar-group-by
      │                   │         │    ├── columns: max:159
      │                   │         │    ├── cardinality: [1 - 1]
      │                   │         │    ├── immutable
      │                   │         │    ├── key: ()
      │                   │         │    ├── fd: ()-->(159)
      │                   │         │    ├── group-by (hash)
      │                   │         │    │    ├── columns: customer.c_customer_sk:107!null sum:158
      │                   │         │    │    ├── grouping columns: customer.c_customer_sk:107!null
      │                   │         │    │    ├── immutable
      │                   │         │    │    ├── key: (107)
      │                   │         │    │    ├── fd: (107)-->(158)
      │                   │         │    │    ├── project
      │                   │         │    │    │    ├── columns: column157:157 customer.c_customer_sk:107!null
      │                   │         │    │    │    ├── immutable
      │                   │         │    │    │    ├── inner-join (hash)
      │                   │         │    │    │    │    ├── columns: ss_sold_date_sk:82!null ss_customer_sk:85!null ss_quantity:92 ss_sales_price:95 customer.c_customer_sk:107!null d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │                   │         │    │    │    │    ├── fd: (127)-->(133), (85)==(107), (107)==(85), (82)==(127), (127)==(82)
      │                   │         │    │    │    │    ├── inner-join (hash)
      │                   │         │    │    │    │    │    ├── columns: ss_sold_date_sk:82!null ss_customer_sk:85 ss_quantity:92 ss_sales_price:95 d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │                   │         │    │    │    │    │    ├── fd: (127)-->(133), (82)==(127), (127)==(82)
      │                   │         │    │    │    │    │    ├── scan store_sales
      │                   │         │    │    │    │    │    │    └── columns: ss_sold_date_sk:82 ss_customer_sk:85 ss_quantity:92 ss_sales_price:95
      │                   │         │    │    │    │    │    ├── select
      │                   │         │    │    │    │    │    │    ├── columns: d_date_sk:127!null d_year:133!null
      │                   │         │    │    │    │    │    │    ├── key: (127)
      │                   │         │    │    │    │    │    │    ├── fd: (127)-->(133)
      │                   │         │    │    │    │    │    │    ├── scan date_dim
      │                   │         │    │    │    │    │    │    │    ├── columns: d_date_sk:127!null d_year:133
      │                   │         │    │    │    │    │    │    │    ├── key: (127)
      │                   │         │    │    │    │    │    │    │    └── fd: (127)-->(133)
      │                   │         │    │    │    │    │    │    └── filters
      │                   │         │    │    │    │    │    │         └── d_year:133 IN (2000, 2001, 2002, 2003) [outer=(133), constraints=(/133: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002] [/2003 - /2003]; tight)]
      │                   │         │    │    │    │    │    └── filters
      │                   │         │    │    │    │    │         └── ss_sold_date_sk:82 = d_date_sk:127 [outer=(82,127), constraints=(/82: (/NULL - ]; /127: (/NULL - ]), fd=(82)==(127), (127)==(82)]
      │                   │         │    │    │    │    ├── scan customer
      │                   │         │    │    │    │    │    ├── columns: customer.c_customer_sk:107!null
      │                   │         │    │    │    │    │    └── key: (107)
      │                   │         │    │    │    │    └── filters
      │                   │         │    │    │    │         └── ss_customer_sk:85 = customer.c_customer_sk:107 [outer=(85,107), constraints=(/85: (/NULL - ]; /107: (/NULL - ]), fd=(85)==(107), (107)==(85)]
      │                   │         │    │    │    └── projections
      │                   │         │    │    │         └── ss_quantity:92 * ss_sales_price:95 [as=column157:157, outer=(92,95), immutable]
      │                   │         │    │    └── aggregations
      │                   │         │    │         └── sum [as=sum:158, outer=(157)]
      │                   │         │    │              └── column157:157
      │                   │         │    └── aggregations
      │                   │         │         └── max [as=max:159, outer=(158)]
      │                   │         │              └── sum:158
      │                   │         └── projections
      │                   │              └── max:159 [as=tpcds_cmax:207, outer=(159)]
      │                   └── 0.95000000000000000000
      └── top-k
           ├── columns: c_last_name:400 c_first_name:401 sales:402
           ├── internal-ordering: +400,+401,+402
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── ordering: +400,+401,+402
           └── union-all
                ├── columns: c_last_name:400 c_first_name:401 sales:402
                ├── left columns: customer.c_last_name:253 customer.c_first_name:252 sum:303
                ├── right columns: customer.c_last_name:349 customer.c_first_name:348 sum:399
                ├── immutable
                ├── group-by (hash)
                │    ├── columns: customer.c_first_name:252 customer.c_last_name:253 sum:303
                │    ├── grouping columns: customer.c_first_name:252 customer.c_last_name:253
                │    ├── immutable
                │    ├── key: (252,253)
                │    ├── fd: (252,253)-->(303)
                │    ├── project
                │    │    ├── columns: column302:302 customer.c_first_name:252 customer.c_last_name:253
                │    │    ├── immutable
                │    │    ├── project
                │    │    │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211!null cs_item_sk:223!null cs_quantity:226 cs_list_price:228 customer.c_customer_sk:244!null customer.c_first_name:252 customer.c_last_name:253 d_date_sk:264!null d_year:270!null d_moy:272!null
                │    │    │    ├── fd: ()-->(270,272), (244)-->(252,253), (211)==(244), (244)==(211), (208)==(264), (264)==(208)
                │    │    │    └── inner-join (hash)
                │    │    │         ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211!null cs_item_sk:223!null cs_quantity:226 cs_list_price:228 customer.c_customer_sk:244!null customer.c_first_name:252 customer.c_last_name:253 d_date_sk:264!null d_year:270!null d_moy:272!null item_sk:295!null
                │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                │    │    │         ├── fd: ()-->(270,272), (244)-->(252,253), (208)==(264), (264)==(208), (211)==(244), (244)==(211), (223)==(295), (295)==(223)
                │    │    │         ├── inner-join (hash)
                │    │    │         │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211!null cs_item_sk:223!null cs_quantity:226 cs_list_price:228 customer.c_customer_sk:244!null customer.c_first_name:252 customer.c_last_name:253 d_date_sk:264!null d_year:270!null d_moy:272!null
                │    │    │         │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
                │    │    │         │    ├── fd: ()-->(270,272), (244)-->(252,253), (208)==(264), (264)==(208), (211)==(244), (244)==(211)
                │    │    │         │    ├── scan customer
                │    │    │         │    │    ├── columns: customer.c_customer_sk:244!null customer.c_first_name:252 customer.c_last_name:253
                │    │    │         │    │    ├── key: (244)
                │    │    │         │    │    └── fd: (244)-->(252,253)
                │    │    │         │    ├── semi-join (hash)
                │    │    │         │    │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:264!null d_year:270!null d_moy:272!null
                │    │    │         │    │    ├── fd: ()-->(270,272), (208)==(264), (264)==(208)
                │    │    │         │    │    ├── inner-join (hash)
                │    │    │         │    │    │    ├── columns: cs_sold_date_sk:208!null cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228 d_date_sk:264!null d_year:270!null d_moy:272!null
                │    │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                │    │    │         │    │    │    ├── fd: ()-->(270,272), (208)==(264), (264)==(208)
                │    │    │         │    │    │    ├── scan catalog_sales
                │    │    │         │    │    │    │    └── columns: cs_sold_date_sk:208 cs_bill_customer_sk:211 cs_item_sk:223!null cs_quantity:226 cs_list_price:228
                │    │    │         │    │    │    ├── select
                │    │    │         │    │    │    │    ├── columns: d_date_sk:264!null d_year:270!null d_moy:272!null
                │    │    │         │    │    │    │    ├── key: (264)
                │    │    │         │    │    │    │    ├── fd: ()-->(270,272)
                │    │    │         │    │    │    │    ├── scan date_dim
                │    │    │         │    │    │    │    │    ├── columns: d_date_sk:264!null d_year:270 d_moy:272
                │    │    │         │    │    │    │    │    ├── key: (264)
                │    │    │         │    │    │    │    │    └── fd: (264)-->(270,272)
                │    │    │         │    │    │    │    └── filters
                │    │    │         │    │    │    │         ├── d_year:270 = 2000 [outer=(270), constraints=(/270: [/2000 - /2000]; tight), fd=()-->(270)]
                │    │    │         │    │    │    │         └── d_moy:272 = 7 [outer=(272), constraints=(/272: [/7 - /7]; tight), fd=()-->(272)]
                │    │    │         │    │    │    └── filters
                │    │    │         │    │    │         └── cs_sold_date_sk:208 = d_date_sk:264 [outer=(208,264), constraints=(/208: (/NULL - ]; /264: (/NULL - ]), fd=(208)==(264), (264)==(208)]
                │    │    │         │    │    ├── with-scan &3 (best_ss_customer)
                │    │    │         │    │    │    ├── columns: c_customer_sk:298!null
                │    │    │         │    │    │    ├── mapping:
                │    │    │         │    │    │    │    └──  customer.c_customer_sk:185 => c_customer_sk:298
                │    │    │         │    │    │    └── key: (298)
                │    │    │         │    │    └── filters
                │    │    │         │    │         └── cs_bill_customer_sk:211 = c_customer_sk:298 [outer=(211,298), constraints=(/211: (/NULL - ]; /298: (/NULL - ]), fd=(211)==(298), (298)==(211)]
                │    │    │         │    └── filters
                │    │    │         │         └── cs_bill_customer_sk:211 = customer.c_customer_sk:244 [outer=(211,244), constraints=(/211: (/NULL - ]; /244: (/NULL - ]), fd=(211)==(244), (244)==(211)]
                │    │    │         ├── distinct-on
                │    │    │         │    ├── columns: item_sk:295!null
                │    │    │         │    ├── grouping columns: item_sk:295!null
                │    │    │         │    ├── key: (295)
                │    │    │         │    └── with-scan &1 (frequent_ss_items)
                │    │    │         │         ├── columns: item_sk:295!null
                │    │    │         │         └── mapping:
                │    │    │         │              └──  i_item_sk:56 => item_sk:295
                │    │    │         └── filters
                │    │    │              └── cs_item_sk:223 = item_sk:295 [outer=(223,295), constraints=(/223: (/NULL - ]; /295: (/NULL - ]), fd=(223)==(295), (295)==(223)]
                │    │    └── projections
                │    │         └── cs_quantity:226 * cs_list_price:228 [as=column302:302, outer=(226,228), immutable]
                │    └── aggregations
                │         └── sum [as=sum:303, outer=(302)]
                │              └── column302:302
                └── group-by (hash)
                     ├── columns: customer.c_first_name:348 customer.c_last_name:349 sum:399
                     ├── grouping columns: customer.c_first_name:348 customer.c_last_name:349
                     ├── immutable
                     ├── key: (348,349)
                     ├── fd: (348,349)-->(399)
                     ├── project
                     │    ├── columns: column398:398 customer.c_first_name:348 customer.c_last_name:349
                     │    ├── immutable
                     │    ├── inner-join (lookup customer)
                     │    │    ├── columns: ws_sold_date_sk:304!null ws_item_sk:307!null ws_bill_customer_sk:308!null ws_quantity:322 ws_list_price:324 customer.c_customer_sk:340!null customer.c_first_name:348 customer.c_last_name:349 d_date_sk:360!null d_year:366!null d_moy:368!null
                     │    │    ├── key columns: [308] = [340]
                     │    │    ├── lookup columns are key
                     │    │    ├── fd: ()-->(366,368), (340)-->(348,349), (308)==(340), (340)==(308), (304)==(360), (360)==(304)
                     │    │    ├── semi-join (hash)
                     │    │    │    ├── columns: ws_sold_date_sk:304!null ws_item_sk:307!null ws_bill_customer_sk:308 ws_quantity:322 ws_list_price:324 d_date_sk:360!null d_year:366!null d_moy:368!null
                     │    │    │    ├── fd: ()-->(366,368), (304)==(360), (360)==(304)
                     │    │    │    ├── project
                     │    │    │    │    ├── columns: ws_sold_date_sk:304!null ws_item_sk:307!null ws_bill_customer_sk:308 ws_quantity:322 ws_list_price:324 d_date_sk:360!null d_year:366!null d_moy:368!null
                     │    │    │    │    ├── fd: ()-->(366,368), (304)==(360), (360)==(304)
                     │    │    │    │    └── inner-join (hash)
                     │    │    │    │         ├── columns: ws_sold_date_sk:304!null ws_item_sk:307!null ws_bill_customer_sk:308 ws_quantity:322 ws_list_price:324 d_date_sk:360!null d_year:366!null d_moy:368!null item_sk:391!null
                     │    │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                     │    │    │    │         ├── fd: ()-->(366,368), (304)==(360), (360)==(304), (307)==(391), (391)==(307)
                     │    │    │    │         ├── inner-join (hash)
                     │    │    │    │         │    ├── columns: ws_sold_date_sk:304!null ws_item_sk:307!null ws_bill_customer_sk:308 ws_quantity:322 ws_list_price:324 d_date_sk:360!null d_year:366!null d_moy:368!null
                     │    │    │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                     │    │    │    │         │    ├── fd: ()-->(366,368), (304)==(360), (360)==(304)
                     │    │    │    │         │    ├── scan web_sales
                     │    │    │    │         │    │    └── columns: ws_sold_date_sk:304 ws_item_sk:307!null ws_bill_customer_sk:308 ws_quantity:322 ws_list_price:324
                     │    │    │    │         │    ├── select
                     │    │    │    │         │    │    ├── columns: d_date_sk:360!null d_year:366!null d_moy:368!null
                     │    │    │    │         │    │    ├── key: (360)
                     │    │    │    │         │    │    ├── fd: ()-->(366,368)
                     │    │    │    │         │    │    ├── scan date_dim
                     │    │    │    │         │    │    │    ├── columns: d_date_sk:360!null d_year:366 d_moy:368
                     │    │    │    │         │    │    │    ├── key: (360)
                     │    │    │    │         │    │    │    └── fd: (360)-->(366,368)
                     │    │    │    │         │    │    └── filters
                     │    │    │    │         │    │         ├── d_year:366 = 2000 [outer=(366), constraints=(/366: [/2000 - /2000]; tight), fd=()-->(366)]
                     │    │    │    │         │    │         └── d_moy:368 = 7 [outer=(368), constraints=(/368: [/7 - /7]; tight), fd=()-->(368)]
                     │    │    │    │         │    └── filters
                     │    │    │    │         │         └── ws_sold_date_sk:304 = d_date_sk:360 [outer=(304,360), constraints=(/304: (/NULL - ]; /360: (/NULL - ]), fd=(304)==(360), (360)==(304)]
                     │    │    │    │         ├── distinct-on
                     │    │    │    │         │    ├── columns: item_sk:391!null
                     │    │    │    │         │    ├── grouping columns: item_sk:391!null
                     │    │    │    │         │    ├── key: (391)
                     │    │    │    │         │    └── with-scan &1 (frequent_ss_items)
                     │    │    │    │         │         ├── columns: item_sk:391!null
                     │    │    │    │         │         └── mapping:
                     │    │    │    │         │              └──  i_item_sk:56 => item_sk:391
                     │    │    │    │         └── filters
                     │    │    │    │              └── ws_item_sk:307 = item_sk:391 [outer=(307,391), constraints=(/307: (/NULL - ]; /391: (/NULL - ]), fd=(307)==(391), (391)==(307)]
                     │    │    │    ├── with-scan &3 (best_ss_customer)
                     │    │    │    │    ├── columns: c_customer_sk:394!null
                     │    │    │    │    ├── mapping:
                     │    │    │    │    │    └──  customer.c_customer_sk:185 => c_customer_sk:394
                     │    │    │    │    └── key: (394)
                     │    │    │    └── filters
                     │    │    │         └── ws_bill_customer_sk:308 = c_customer_sk:394 [outer=(308,394), constraints=(/308: (/NULL - ]; /394: (/NULL - ]), fd=(308)==(394), (394)==(308)]
                     │    │    └── filters (true)
                     │    └── projections
                     │         └── ws_quantity:322 * ws_list_price:324 [as=column398:398, outer=(322,324), immutable]
                     └── aggregations
                          └── sum [as=sum:399, outer=(398)]
                               └── column398:398

# --------------------------------------------------
# Q24
# NOTE: Q24 has two queries.
opt
	WITH
		ssales
			AS (
				SELECT
					c_last_name,
					c_first_name,
					s_store_name,
					ca_state,
					s_state,
					i_color,
					i_current_price,
					i_manager_id,
					i_units,
					i_size,
					sum(ss_net_paid) AS netpaid
				FROM
					store_sales,
					store_returns,
					store,
					item,
					customer,
					customer_address
				WHERE
					ss_ticket_number = sr_ticket_number
					AND ss_item_sk = sr_item_sk
					AND ss_customer_sk = c_customer_sk
					AND ss_item_sk = i_item_sk
					AND ss_store_sk = s_store_sk
					AND c_current_addr_sk = ca_address_sk
					AND c_birth_country != upper(ca_country)
					AND s_zip = ca_zip
					AND s_market_id = 5
				GROUP BY
					c_last_name,
					c_first_name,
					s_store_name,
					ca_state,
					s_state,
					i_color,
					i_current_price,
					i_manager_id,
					i_units,
					i_size
			)
	SELECT
		c_last_name,
		c_first_name,
		s_store_name,
		sum(netpaid) AS paid
	FROM
		ssales
	WHERE
		i_color = 'aquamarine'
	GROUP BY
		c_last_name, c_first_name, s_store_name
	HAVING
		sum(netpaid) > (SELECT 0.05 * avg(netpaid) FROM ssales)
	ORDER BY
		c_last_name, c_first_name, s_store_name;
----
sort
 ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 paid:150!null
 ├── immutable
 ├── key: (139-141)
 ├── fd: (139-141)-->(150)
 ├── ordering: +139,+140,+141
 └── with &1 (ssales)
      ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150!null
      ├── immutable
      ├── key: (139-141)
      ├── fd: (139-141)-->(150)
      ├── group-by (hash)
      │    ├── columns: store.s_store_name:53 store.s_state:72 item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 customer.c_first_name:111 customer.c_last_name:112 customer_address.ca_state:131 sum:138
      │    ├── grouping columns: store.s_store_name:53 store.s_state:72 item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 customer.c_first_name:111 customer.c_last_name:112 customer_address.ca_state:131
      │    ├── immutable
      │    ├── key: (53,72,84,94,96,97,99,111,112,131)
      │    ├── fd: (53,72,84,94,96,97,99,111,112,131)-->(138)
      │    ├── inner-join (lookup item)
      │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73!null i_item_sk:79!null item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 c_customer_sk:103!null c_current_addr_sk:107!null customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117!null ca_address_sk:123!null customer_address.ca_state:131 ca_zip:132!null ca_country:133
      │    │    ├── key columns: [28] = [79]
      │    │    ├── lookup columns are key
      │    │    ├── immutable
      │    │    ├── key: (35,79)
      │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (79)-->(84,94,96,97,99), (48)-->(53,72,73), (103)-->(107,111,112,117), (123)-->(131-133), (3)==(28,79), (28)==(3,79), (79)==(3,28), (10)==(35), (35)==(10), (107)==(123), (123)==(107), (73)==(132), (132)==(73), (4)==(103), (103)==(4), (8)==(48), (48)==(8)
      │    │    ├── inner-join (lookup customer_address)
      │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73!null c_customer_sk:103!null c_current_addr_sk:107!null customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117!null ca_address_sk:123!null customer_address.ca_state:131 ca_zip:132!null ca_country:133
      │    │    │    ├── key columns: [107] = [123]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── immutable
      │    │    │    ├── key: (28,35)
      │    │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (48)-->(53,72,73), (103)-->(107,111,112,117), (123)-->(131-133), (107)==(123), (123)==(107), (73)==(132), (132)==(73), (4)==(103), (103)==(4), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    ├── inner-join (lookup customer)
      │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73 c_customer_sk:103!null c_current_addr_sk:107 customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117
      │    │    │    │    ├── key columns: [4] = [103]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: ()-->(58), (48)-->(53,72,73), (3,10)-->(4,8,21), (103)-->(107,111,112,117), (4)==(103), (103)==(4), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (48)-->(53,72,73), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8 ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null
      │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
      │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    ├── fd: (3,10)-->(4,8,21), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    │    ├── columns: sr_item_sk:28!null sr_ticket_number:35!null
      │    │    │    │    │    │    │    └── key: (28,35)
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73
      │    │    │    │    │    │    ├── key: (48)
      │    │    │    │    │    │    ├── fd: ()-->(58), (48)-->(53,72,73)
      │    │    │    │    │    │    ├── scan store
      │    │    │    │    │    │    │    ├── columns: s_store_sk:48!null store.s_store_name:53 s_market_id:58 store.s_state:72 s_zip:73
      │    │    │    │    │    │    │    ├── key: (48)
      │    │    │    │    │    │    │    └── fd: (48)-->(53,58,72,73)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── s_market_id:58 = 5 [outer=(58), constraints=(/58: [/5 - /5]; tight), fd=()-->(58)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ss_store_sk:8 = s_store_sk:48 [outer=(8,48), constraints=(/8: (/NULL - ]; /48: (/NULL - ]), fd=(8)==(48), (48)==(8)]
      │    │    │    │    └── filters (true)
      │    │    │    └── filters
      │    │    │         ├── c_birth_country:117 != upper(ca_country:133) [outer=(117,133), immutable, constraints=(/117: (/NULL - ])]
      │    │    │         └── s_zip:73 = ca_zip:132 [outer=(73,132), constraints=(/73: (/NULL - ]; /132: (/NULL - ]), fd=(73)==(132), (132)==(73)]
      │    │    └── filters (true)
      │    └── aggregations
      │         └── sum [as=sum:138, outer=(21)]
      │              └── ss_net_paid:21
      └── select
           ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150!null
           ├── immutable
           ├── key: (139-141)
           ├── fd: (139-141)-->(150)
           ├── group-by (hash)
           │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150
           │    ├── grouping columns: c_last_name:139 c_first_name:140 s_store_name:141
           │    ├── key: (139-141)
           │    ├── fd: (139-141)-->(150)
           │    ├── select
           │    │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 i_color:144!null netpaid:149
           │    │    ├── fd: ()-->(144)
           │    │    ├── with-scan &1 (ssales)
           │    │    │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 i_color:144 netpaid:149
           │    │    │    └── mapping:
           │    │    │         ├──  customer.c_last_name:112 => c_last_name:139
           │    │    │         ├──  customer.c_first_name:111 => c_first_name:140
           │    │    │         ├──  store.s_store_name:53 => s_store_name:141
           │    │    │         ├──  item.i_color:96 => i_color:144
           │    │    │         └──  sum:138 => netpaid:149
           │    │    └── filters
           │    │         └── i_color:144 = 'aquamarine' [outer=(144), constraints=(/144: [/'aquamarine' - /'aquamarine']; tight), fd=()-->(144)]
           │    └── aggregations
           │         └── sum [as=sum:150, outer=(149)]
           │              └── netpaid:149
           └── filters
                └── gt [outer=(150), immutable, subquery, constraints=(/150: (/NULL - ])]
                     ├── sum:150
                     └── subquery
                          └── project
                               ├── columns: "?column?":163
                               ├── cardinality: [1 - 1]
                               ├── immutable
                               ├── key: ()
                               ├── fd: ()-->(163)
                               ├── scalar-group-by
                               │    ├── columns: avg:162
                               │    ├── cardinality: [1 - 1]
                               │    ├── key: ()
                               │    ├── fd: ()-->(162)
                               │    ├── with-scan &1 (ssales)
                               │    │    ├── columns: netpaid:161
                               │    │    └── mapping:
                               │    │         └──  sum:138 => netpaid:161
                               │    └── aggregations
                               │         └── avg [as=avg:162, outer=(161)]
                               │              └── netpaid:161
                               └── projections
                                    └── avg:162 * 0.05 [as="?column?":163, outer=(162), immutable]

opt
	WITH
		ssales
			AS (
				SELECT
					c_last_name,
					c_first_name,
					s_store_name,
					ca_state,
					s_state,
					i_color,
					i_current_price,
					i_manager_id,
					i_units,
					i_size,
					sum(ss_net_paid) AS netpaid
				FROM
					store_sales,
					store_returns,
					store,
					item,
					customer,
					customer_address
				WHERE
					ss_ticket_number = sr_ticket_number
					AND ss_item_sk = sr_item_sk
					AND ss_customer_sk = c_customer_sk
					AND ss_item_sk = i_item_sk
					AND ss_store_sk = s_store_sk
					AND c_current_addr_sk = ca_address_sk
					AND c_birth_country != upper(ca_country)
					AND s_zip = ca_zip
					AND s_market_id = 5
				GROUP BY
					c_last_name,
					c_first_name,
					s_store_name,
					ca_state,
					s_state,
					i_color,
					i_current_price,
					i_manager_id,
					i_units,
					i_size
			)
	SELECT
		c_last_name,
		c_first_name,
		s_store_name,
		sum(netpaid) AS paid
	FROM
		ssales
	WHERE
		i_color = 'seashell'
	GROUP BY
		c_last_name, c_first_name, s_store_name
	HAVING
		sum(netpaid) > (SELECT 0.05 * avg(netpaid) FROM ssales)
	ORDER BY
		c_last_name, c_first_name, s_store_name;
----
sort
 ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 paid:150!null
 ├── immutable
 ├── key: (139-141)
 ├── fd: (139-141)-->(150)
 ├── ordering: +139,+140,+141
 └── with &1 (ssales)
      ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150!null
      ├── immutable
      ├── key: (139-141)
      ├── fd: (139-141)-->(150)
      ├── group-by (hash)
      │    ├── columns: store.s_store_name:53 store.s_state:72 item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 customer.c_first_name:111 customer.c_last_name:112 customer_address.ca_state:131 sum:138
      │    ├── grouping columns: store.s_store_name:53 store.s_state:72 item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 customer.c_first_name:111 customer.c_last_name:112 customer_address.ca_state:131
      │    ├── immutable
      │    ├── key: (53,72,84,94,96,97,99,111,112,131)
      │    ├── fd: (53,72,84,94,96,97,99,111,112,131)-->(138)
      │    ├── inner-join (lookup item)
      │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73!null i_item_sk:79!null item.i_current_price:84 item.i_size:94 item.i_color:96 item.i_units:97 item.i_manager_id:99 c_customer_sk:103!null c_current_addr_sk:107!null customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117!null ca_address_sk:123!null customer_address.ca_state:131 ca_zip:132!null ca_country:133
      │    │    ├── key columns: [28] = [79]
      │    │    ├── lookup columns are key
      │    │    ├── immutable
      │    │    ├── key: (35,79)
      │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (79)-->(84,94,96,97,99), (48)-->(53,72,73), (103)-->(107,111,112,117), (123)-->(131-133), (3)==(28,79), (28)==(3,79), (79)==(3,28), (10)==(35), (35)==(10), (107)==(123), (123)==(107), (73)==(132), (132)==(73), (4)==(103), (103)==(4), (8)==(48), (48)==(8)
      │    │    ├── inner-join (lookup customer_address)
      │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73!null c_customer_sk:103!null c_current_addr_sk:107!null customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117!null ca_address_sk:123!null customer_address.ca_state:131 ca_zip:132!null ca_country:133
      │    │    │    ├── key columns: [107] = [123]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── immutable
      │    │    │    ├── key: (28,35)
      │    │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (48)-->(53,72,73), (103)-->(107,111,112,117), (123)-->(131-133), (107)==(123), (123)==(107), (73)==(132), (132)==(73), (4)==(103), (103)==(4), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    ├── inner-join (lookup customer)
      │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73 c_customer_sk:103!null c_current_addr_sk:107 customer.c_first_name:111 customer.c_last_name:112 c_birth_country:117
      │    │    │    │    ├── key columns: [4] = [103]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: ()-->(58), (48)-->(53,72,73), (3,10)-->(4,8,21), (103)-->(107,111,112,117), (4)==(103), (103)==(4), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8!null ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    ├── fd: ()-->(58), (3,10)-->(4,8,21), (48)-->(53,72,73), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8 ss_ticket_number:10!null ss_net_paid:21 sr_item_sk:28!null sr_ticket_number:35!null
      │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
      │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    ├── fd: (3,10)-->(4,8,21), (10)==(35), (35)==(10), (3)==(28), (28)==(3)
      │    │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    │    ├── columns: sr_item_sk:28!null sr_ticket_number:35!null
      │    │    │    │    │    │    │    └── key: (28,35)
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: s_store_sk:48!null store.s_store_name:53 s_market_id:58!null store.s_state:72 s_zip:73
      │    │    │    │    │    │    ├── key: (48)
      │    │    │    │    │    │    ├── fd: ()-->(58), (48)-->(53,72,73)
      │    │    │    │    │    │    ├── scan store
      │    │    │    │    │    │    │    ├── columns: s_store_sk:48!null store.s_store_name:53 s_market_id:58 store.s_state:72 s_zip:73
      │    │    │    │    │    │    │    ├── key: (48)
      │    │    │    │    │    │    │    └── fd: (48)-->(53,58,72,73)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── s_market_id:58 = 5 [outer=(58), constraints=(/58: [/5 - /5]; tight), fd=()-->(58)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ss_store_sk:8 = s_store_sk:48 [outer=(8,48), constraints=(/8: (/NULL - ]; /48: (/NULL - ]), fd=(8)==(48), (48)==(8)]
      │    │    │    │    └── filters (true)
      │    │    │    └── filters
      │    │    │         ├── c_birth_country:117 != upper(ca_country:133) [outer=(117,133), immutable, constraints=(/117: (/NULL - ])]
      │    │    │         └── s_zip:73 = ca_zip:132 [outer=(73,132), constraints=(/73: (/NULL - ]; /132: (/NULL - ]), fd=(73)==(132), (132)==(73)]
      │    │    └── filters (true)
      │    └── aggregations
      │         └── sum [as=sum:138, outer=(21)]
      │              └── ss_net_paid:21
      └── select
           ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150!null
           ├── immutable
           ├── key: (139-141)
           ├── fd: (139-141)-->(150)
           ├── group-by (hash)
           │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 sum:150
           │    ├── grouping columns: c_last_name:139 c_first_name:140 s_store_name:141
           │    ├── key: (139-141)
           │    ├── fd: (139-141)-->(150)
           │    ├── select
           │    │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 i_color:144!null netpaid:149
           │    │    ├── fd: ()-->(144)
           │    │    ├── with-scan &1 (ssales)
           │    │    │    ├── columns: c_last_name:139 c_first_name:140 s_store_name:141 i_color:144 netpaid:149
           │    │    │    └── mapping:
           │    │    │         ├──  customer.c_last_name:112 => c_last_name:139
           │    │    │         ├──  customer.c_first_name:111 => c_first_name:140
           │    │    │         ├──  store.s_store_name:53 => s_store_name:141
           │    │    │         ├──  item.i_color:96 => i_color:144
           │    │    │         └──  sum:138 => netpaid:149
           │    │    └── filters
           │    │         └── i_color:144 = 'seashell' [outer=(144), constraints=(/144: [/'seashell' - /'seashell']; tight), fd=()-->(144)]
           │    └── aggregations
           │         └── sum [as=sum:150, outer=(149)]
           │              └── netpaid:149
           └── filters
                └── gt [outer=(150), immutable, subquery, constraints=(/150: (/NULL - ])]
                     ├── sum:150
                     └── subquery
                          └── project
                               ├── columns: "?column?":163
                               ├── cardinality: [1 - 1]
                               ├── immutable
                               ├── key: ()
                               ├── fd: ()-->(163)
                               ├── scalar-group-by
                               │    ├── columns: avg:162
                               │    ├── cardinality: [1 - 1]
                               │    ├── key: ()
                               │    ├── fd: ()-->(162)
                               │    ├── with-scan &1 (ssales)
                               │    │    ├── columns: netpaid:161
                               │    │    └── mapping:
                               │    │         └──  sum:138 => netpaid:161
                               │    └── aggregations
                               │         └── avg [as=avg:162, outer=(161)]
                               │              └── netpaid:161
                               └── projections
                                    └── avg:162 * 0.05 [as="?column?":163, outer=(162), immutable]

# --------------------------------------------------
# Q25
opt
	SELECT
		i_item_id,
		i_item_desc,
		s_store_id,
		s_store_name,
		max(ss_net_profit) AS store_sales_profit,
		max(sr_net_loss) AS store_returns_loss,
		max(cs_net_profit) AS catalog_sales_profit
	FROM
		store_sales,
		store_returns,
		catalog_sales,
		date_dim AS d1,
		date_dim AS d2,
		date_dim AS d3,
		store,
		item
	WHERE
		d1.d_moy = 4
		AND d1.d_year = 1999
		AND d1.d_date_sk = ss_sold_date_sk
		AND i_item_sk = ss_item_sk
		AND s_store_sk = ss_store_sk
		AND ss_customer_sk = sr_customer_sk
		AND ss_item_sk = sr_item_sk
		AND ss_ticket_number = sr_ticket_number
		AND sr_returned_date_sk = d2.d_date_sk
		AND d2.d_moy BETWEEN 4 AND 10
		AND d2.d_year = 1999
		AND sr_customer_sk = cs_bill_customer_sk
		AND sr_item_sk = cs_item_sk
		AND cs_sold_date_sk = d3.d_date_sk
		AND d3.d_moy BETWEEN 4 AND 10
		AND d3.d_year = 1999
	GROUP BY
		i_item_id, i_item_desc, s_store_id, s_store_name
	ORDER BY
		i_item_id, i_item_desc, s_store_id, s_store_name
	LIMIT
		100;
----
top-k
 ├── columns: i_item_id:206!null i_item_desc:209 s_store_id:175!null s_store_name:179 store_sales_profit:229 store_returns_loss:230 catalog_sales_profit:231
 ├── internal-ordering: +206,+209,+175,+179
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (175,179,206,209)
 ├── fd: (175,179,206,209)-->(229-231)
 ├── ordering: +206,+209,+175,+179
 └── group-by (hash)
      ├── columns: s_store_id:175!null s_store_name:179 i_item_id:206!null i_item_desc:209 max:229 max:230 max:231
      ├── grouping columns: s_store_id:175!null s_store_name:179 i_item_id:206!null i_item_desc:209
      ├── key: (175,179,206,209)
      ├── fd: (175,179,206,209)-->(229-231)
      ├── inner-join (lookup item)
      │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_net_profit:81 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null d3.d_date_sk:144!null d3.d_year:150!null d3.d_moy:152!null s_store_sk:174!null s_store_id:175!null s_store_name:179 i_item_sk:205!null i_item_id:206!null i_item_desc:209
      │    ├── key columns: [63] = [205]
      │    ├── lookup columns are key
      │    ├── fd: ()-->(90,92,120,150), (3,10)-->(1,4,8,23), (174)-->(175,179), (28,35)-->(26,29,45), (144)-->(152), (205)-->(206,209), (114)-->(122), (8)==(174), (174)==(8), (48)==(144), (144)==(48), (3)==(28,63,205), (28)==(3,63,205), (63)==(3,28,205), (205)==(3,28,63), (4)==(29,51), (29)==(4,51), (51)==(4,29), (26)==(114), (114)==(26), (10)==(35), (35)==(10), (1)==(84), (84)==(1)
      │    ├── inner-join (lookup date_dim [as=d3])
      │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_net_profit:81 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null d3.d_date_sk:144!null d3.d_year:150!null d3.d_moy:152!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    ├── key columns: [48] = [144]
      │    │    ├── lookup columns are key
      │    │    ├── fd: ()-->(90,92,120,150), (174)-->(175,179), (144)-->(152), (114)-->(122), (28,35)-->(26,29,45), (3,10)-->(1,4,8,23), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (48)==(144), (144)==(48), (8)==(174), (174)==(8)
      │    │    ├── inner-join (lookup catalog_sales)
      │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 cs_sold_date_sk:48 cs_bill_customer_sk:51!null cs_item_sk:63!null cs_net_profit:81 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    ├── key columns: [28] = [63]
      │    │    │    ├── fd: ()-->(90,92,120), (174)-->(175,179), (114)-->(122), (28,35)-->(26,29,45), (3,10)-->(1,4,8,23), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
      │    │    │    ├── inner-join (lookup date_dim [as=d1])
      │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    ├── key columns: [1] = [84]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: ()-->(90,92,120), (174)-->(175,179), (114)-->(122), (28,35)-->(26,29,45), (3,10)-->(1,4,8,23), (1)==(84), (84)==(1), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    ├── fd: ()-->(120), (174)-->(175,179), (3,10)-->(1,4,8,23), (28,35)-->(26,29,45), (114)-->(122), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (8)==(174), (174)==(8)
      │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8 ss_ticket_number:10!null ss_net_profit:23 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_net_loss:45 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
      │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    ├── fd: ()-->(120), (3,10)-->(1,4,8,23), (28,35)-->(26,29,45), (114)-->(122), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10)
      │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_net_loss:45 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    │    ├── fd: ()-->(120), (28,35)-->(26,29,45), (114)-->(122), (26)==(114), (114)==(26)
      │    │    │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26 sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_net_loss:45
      │    │    │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    │    │    └── fd: (28,35)-->(26,29,45)
      │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    │    │    ├── key: (114)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(120), (114)-->(122)
      │    │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
      │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_year:120 d2.d_moy:122
      │    │    │    │    │    │    │    │    │    ├── key: (114)
      │    │    │    │    │    │    │    │    │    └── fd: (114)-->(120,122)
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         ├── (d2.d_moy:122 >= 4) AND (d2.d_moy:122 <= 10) [outer=(122), constraints=(/122: [/4 - /10]; tight)]
      │    │    │    │    │    │    │    │         └── d2.d_year:120 = 1999 [outer=(120), constraints=(/120: [/1999 - /1999]; tight), fd=()-->(120)]
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── sr_returned_date_sk:26 = d2.d_date_sk:114 [outer=(26,114), constraints=(/26: (/NULL - ]; /114: (/NULL - ]), fd=(26)==(114), (114)==(26)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_customer_sk:4 = sr_customer_sk:29 [outer=(4,29), constraints=(/4: (/NULL - ]; /29: (/NULL - ]), fd=(4)==(29), (29)==(4)]
      │    │    │    │    │    ├── scan store
      │    │    │    │    │    │    ├── columns: s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    │    │    ├── key: (174)
      │    │    │    │    │    │    └── fd: (174)-->(175,179)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── s_store_sk:174 = ss_store_sk:8 [outer=(8,174), constraints=(/8: (/NULL - ]; /174: (/NULL - ]), fd=(8)==(174), (174)==(8)]
      │    │    │    │    └── filters
      │    │    │    │         ├── d1.d_moy:92 = 4 [outer=(92), constraints=(/92: [/4 - /4]; tight), fd=()-->(92)]
      │    │    │    │         └── d1.d_year:90 = 1999 [outer=(90), constraints=(/90: [/1999 - /1999]; tight), fd=()-->(90)]
      │    │    │    └── filters
      │    │    │         └── sr_customer_sk:29 = cs_bill_customer_sk:51 [outer=(29,51), constraints=(/29: (/NULL - ]; /51: (/NULL - ]), fd=(29)==(51), (51)==(29)]
      │    │    └── filters
      │    │         ├── (d3.d_moy:152 >= 4) AND (d3.d_moy:152 <= 10) [outer=(152), constraints=(/152: [/4 - /10]; tight)]
      │    │         └── d3.d_year:150 = 1999 [outer=(150), constraints=(/150: [/1999 - /1999]; tight), fd=()-->(150)]
      │    └── filters (true)
      └── aggregations
           ├── max [as=max:229, outer=(23)]
           │    └── ss_net_profit:23
           ├── max [as=max:230, outer=(45)]
           │    └── sr_net_loss:45
           └── max [as=max:231, outer=(81)]
                └── cs_net_profit:81

# --------------------------------------------------
# Q26
opt
	SELECT
		i_item_id,
		avg(cs_quantity) AS agg1,
		avg(cs_list_price) AS agg2,
		avg(cs_coupon_amt) AS agg3,
		avg(cs_sales_price) AS agg4
	FROM
		catalog_sales,
		customer_demographics,
		date_dim,
		item,
		promotion
	WHERE
		cs_sold_date_sk = d_date_sk
		AND cs_item_sk = i_item_sk
		AND cs_bill_cdemo_sk = cd_demo_sk
		AND cs_promo_sk = p_promo_sk
		AND cd_gender = 'M'
		AND cd_marital_status = 'W'
		AND cd_education_status = 'Unknown'
		AND (p_channel_email = 'N' OR p_channel_event = 'N')
		AND d_year = 2002
	GROUP BY
		i_item_id
	ORDER BY
		i_item_id
	LIMIT
		100;
----
limit
 ├── columns: i_item_id:79!null agg1:123 agg2:124 agg3:125 agg4:126
 ├── internal-ordering: +79
 ├── cardinality: [0 - 100]
 ├── key: (79)
 ├── fd: (79)-->(123-126)
 ├── ordering: +79
 ├── group-by (streaming)
 │    ├── columns: i_item_id:79!null avg:123 avg:124 avg:125 avg:126
 │    ├── grouping columns: i_item_id:79!null
 │    ├── key: (79)
 │    ├── fd: (79)-->(123-126)
 │    ├── ordering: +79
 │    ├── limit hint: 100.00
 │    ├── inner-join (lookup date_dim)
 │    │    ├── columns: cs_sold_date_sk:1!null cs_bill_cdemo_sk:5!null cs_item_sk:16!null cs_promo_sk:17!null cs_quantity:19 cs_list_price:21 cs_sales_price:22 cs_coupon_amt:28 cd_demo_sk:37!null cd_gender:38!null cd_marital_status:39!null cd_education_status:40!null d_date_sk:48!null d_year:54!null i_item_sk:78!null i_item_id:79!null p_promo_sk:102!null p_channel_email:111 p_channel_event:116
 │    │    ├── key columns: [1] = [48]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(38-40,54), (78)-->(79), (102)-->(111,116), (5)==(37), (37)==(5), (1)==(48), (48)==(1), (16)==(78), (78)==(16), (17)==(102), (102)==(17)
 │    │    ├── ordering: +79 opt(38-40,54) [actual: +79]
 │    │    ├── limit hint: 220.26
 │    │    ├── inner-join (lookup promotion)
 │    │    │    ├── columns: cs_sold_date_sk:1 cs_bill_cdemo_sk:5!null cs_item_sk:16!null cs_promo_sk:17!null cs_quantity:19 cs_list_price:21 cs_sales_price:22 cs_coupon_amt:28 cd_demo_sk:37!null cd_gender:38!null cd_marital_status:39!null cd_education_status:40!null i_item_sk:78!null i_item_id:79!null p_promo_sk:102!null p_channel_email:111 p_channel_event:116
 │    │    │    ├── key columns: [17] = [102]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── fd: ()-->(38-40), (78)-->(79), (102)-->(111,116), (17)==(102), (102)==(17), (16)==(78), (78)==(16), (5)==(37), (37)==(5)
 │    │    │    ├── ordering: +79 opt(38-40) [actual: +79]
 │    │    │    ├── limit hint: 1200.00
 │    │    │    ├── inner-join (lookup customer_demographics)
 │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_bill_cdemo_sk:5!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 cs_list_price:21 cs_sales_price:22 cs_coupon_amt:28 cd_demo_sk:37!null cd_gender:38!null cd_marital_status:39!null cd_education_status:40!null i_item_sk:78!null i_item_id:79!null
 │    │    │    │    ├── key columns: [5] = [37]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── fd: ()-->(38-40), (78)-->(79), (16)==(78), (78)==(16), (5)==(37), (37)==(5)
 │    │    │    │    ├── ordering: +79 opt(38-40) [actual: +79]
 │    │    │    │    ├── limit hint: 1300.00
 │    │    │    │    ├── inner-join (lookup catalog_sales)
 │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_bill_cdemo_sk:5 cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 cs_list_price:21 cs_sales_price:22 cs_coupon_amt:28 i_item_sk:78!null i_item_id:79!null
 │    │    │    │    │    ├── key columns: [78] = [16]
 │    │    │    │    │    ├── fd: (78)-->(79), (16)==(78), (78)==(16)
 │    │    │    │    │    ├── ordering: +79
 │    │    │    │    │    ├── limit hint: 51200.00
 │    │    │    │    │    ├── sort
 │    │    │    │    │    │    ├── columns: i_item_sk:78!null i_item_id:79!null
 │    │    │    │    │    │    ├── key: (78)
 │    │    │    │    │    │    ├── fd: (78)-->(79)
 │    │    │    │    │    │    ├── ordering: +79
 │    │    │    │    │    │    ├── limit hint: 400.00
 │    │    │    │    │    │    └── scan item
 │    │    │    │    │    │         ├── columns: i_item_sk:78!null i_item_id:79!null
 │    │    │    │    │    │         ├── key: (78)
 │    │    │    │    │    │         └── fd: (78)-->(79)
 │    │    │    │    │    └── filters (true)
 │    │    │    │    └── filters
 │    │    │    │         ├── cd_gender:38 = 'M' [outer=(38), constraints=(/38: [/'M' - /'M']; tight), fd=()-->(38)]
 │    │    │    │         ├── cd_marital_status:39 = 'W' [outer=(39), constraints=(/39: [/'W' - /'W']; tight), fd=()-->(39)]
 │    │    │    │         └── cd_education_status:40 = 'Unknown' [outer=(40), constraints=(/40: [/'Unknown' - /'Unknown']; tight), fd=()-->(40)]
 │    │    │    └── filters
 │    │    │         └── (p_channel_email:111 = 'N') OR (p_channel_event:116 = 'N') [outer=(111,116)]
 │    │    └── filters
 │    │         └── d_year:54 = 2002 [outer=(54), constraints=(/54: [/2002 - /2002]; tight), fd=()-->(54)]
 │    └── aggregations
 │         ├── avg [as=avg:123, outer=(19)]
 │         │    └── cs_quantity:19
 │         ├── avg [as=avg:124, outer=(21)]
 │         │    └── cs_list_price:21
 │         ├── avg [as=avg:125, outer=(28)]
 │         │    └── cs_coupon_amt:28
 │         └── avg [as=avg:126, outer=(22)]
 │              └── cs_sales_price:22
 └── 100

# --------------------------------------------------
# Q27
# TODO: adjust the query to work with CRDB.
# select  i_item_id,
#         s_state, grouping(s_state) g_state,
#         avg(ss_quantity) agg1,
#         avg(ss_list_price) agg2,
#         avg(ss_coupon_amt) agg3,
#         avg(ss_sales_price) agg4
#  from store_sales, customer_demographics, date_dim, store, item
#  where ss_sold_date_sk = d_date_sk and
#        ss_item_sk = i_item_sk and
#        ss_store_sk = s_store_sk and
#        ss_cdemo_sk = cd_demo_sk and
#        cd_gender = 'M' and
#        cd_marital_status = 'W' and
#        cd_education_status = 'Secondary' and
#        d_year = 1999 and
#        s_state in ('TN','TN', 'TN', 'TN', 'TN', 'TN')
#  group by rollup (i_item_id, s_state)
#  order by i_item_id
#          ,s_state
#  limit 100;
# ----

# --------------------------------------------------
# Q28
opt
	SELECT
		*
	FROM
		(
			SELECT
				avg(ss_list_price) AS b1_lp,
				count(ss_list_price) AS b1_cnt,
				count(DISTINCT ss_list_price) AS b1_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 0 AND 5
				AND (
						ss_list_price BETWEEN 107 AND (107 + 10)
						OR ss_coupon_amt BETWEEN 1319 AND (1319 + 1000)
						OR ss_wholesale_cost BETWEEN 60 AND (60 + 20)
					)
		)
			AS b1,
		(
			SELECT
				avg(ss_list_price) AS b2_lp,
				count(ss_list_price) AS b2_cnt,
				count(DISTINCT ss_list_price) AS b2_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 6 AND 10
				AND (
						ss_list_price BETWEEN 23 AND (23 + 10)
						OR ss_coupon_amt BETWEEN 825 AND (825 + 1000)
						OR ss_wholesale_cost BETWEEN 43 AND (43 + 20)
					)
		)
			AS b2,
		(
			SELECT
				avg(ss_list_price) AS b3_lp,
				count(ss_list_price) AS b3_cnt,
				count(DISTINCT ss_list_price) AS b3_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 11 AND 15
				AND (
						ss_list_price BETWEEN 74 AND (74 + 10)
						OR ss_coupon_amt BETWEEN 4381 AND (4381 + 1000)
						OR ss_wholesale_cost BETWEEN 57 AND (57 + 20)
					)
		)
			AS b3,
		(
			SELECT
				avg(ss_list_price) AS b4_lp,
				count(ss_list_price) AS b4_cnt,
				count(DISTINCT ss_list_price) AS b4_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 16 AND 20
				AND (
						ss_list_price BETWEEN 89 AND (89 + 10)
						OR ss_coupon_amt BETWEEN 3117 AND (3117 + 1000)
						OR ss_wholesale_cost BETWEEN 68 AND (68 + 20)
					)
		)
			AS b4,
		(
			SELECT
				avg(ss_list_price) AS b5_lp,
				count(ss_list_price) AS b5_cnt,
				count(DISTINCT ss_list_price) AS b5_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 21 AND 25
				AND (
						ss_list_price BETWEEN 58 AND (58 + 10)
						OR ss_coupon_amt BETWEEN 9402 AND (9402 + 1000)
						OR ss_wholesale_cost BETWEEN 38 AND (38 + 20)
					)
		)
			AS b5,
		(
			SELECT
				avg(ss_list_price) AS b6_lp,
				count(ss_list_price) AS b6_cnt,
				count(DISTINCT ss_list_price) AS b6_cntd
			FROM
				store_sales
			WHERE
				ss_quantity BETWEEN 26 AND 30
				AND (
						ss_list_price BETWEEN 64 AND (64 + 10)
						OR ss_coupon_amt BETWEEN 5792 AND (5792 + 1000)
						OR ss_wholesale_cost BETWEEN 73 AND (73 + 20)
					)
		)
			AS b6
	LIMIT
		100;
----
inner-join (cross)
 ├── columns: b1_lp:26 b1_cnt:27!null b1_cntd:28!null b2_lp:54 b2_cnt:55!null b2_cntd:56!null b3_lp:82 b3_cnt:83!null b3_cntd:84!null b4_lp:110 b4_cnt:111!null b4_cntd:112!null b5_lp:138 b5_cnt:139!null b5_cntd:140!null b6_lp:166 b6_cnt:167!null b6_cntd:168!null
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(26-28,54-56,82-84,110-112,138-140,166-168)
 ├── scalar-group-by
 │    ├── columns: avg:26 count:27!null count:28!null
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── key: ()
 │    ├── fd: ()-->(26-28)
 │    ├── select
 │    │    ├── columns: ss_quantity:11!null ss_wholesale_cost:12 ss_list_price:13 ss_coupon_amt:20
 │    │    ├── immutable
 │    │    ├── scan store_sales
 │    │    │    └── columns: ss_quantity:11 ss_wholesale_cost:12 ss_list_price:13 ss_coupon_amt:20
 │    │    └── filters
 │    │         ├── (ss_quantity:11 >= 0) AND (ss_quantity:11 <= 5) [outer=(11), constraints=(/11: [/0 - /5]; tight)]
 │    │         └── (((ss_list_price:13 >= 107) AND (ss_list_price:13 <= 117.00)) OR ((ss_coupon_amt:20 >= 1319) AND (ss_coupon_amt:20 <= 2319.00))) OR ((ss_wholesale_cost:12 >= 60) AND (ss_wholesale_cost:12 <= 80.00)) [outer=(12,13,20), immutable]
 │    └── aggregations
 │         ├── avg [as=avg:26, outer=(13)]
 │         │    └── ss_list_price:13
 │         ├── count [as=count:27, outer=(13)]
 │         │    └── ss_list_price:13
 │         └── agg-distinct [as=count:28, outer=(13)]
 │              └── count
 │                   └── ss_list_price:13
 ├── inner-join (cross)
 │    ├── columns: avg:54 count:55!null count:56!null avg:82 count:83!null count:84!null avg:110 count:111!null count:112!null avg:138 count:139!null count:140!null avg:166 count:167!null count:168!null
 │    ├── cardinality: [1 - 1]
 │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    ├── immutable
 │    ├── key: ()
 │    ├── fd: ()-->(54-56,82-84,110-112,138-140,166-168)
 │    ├── scalar-group-by
 │    │    ├── columns: avg:54 count:55!null count:56!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── immutable
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(54-56)
 │    │    ├── select
 │    │    │    ├── columns: ss_quantity:39!null ss_wholesale_cost:40 ss_list_price:41 ss_coupon_amt:48
 │    │    │    ├── immutable
 │    │    │    ├── scan store_sales
 │    │    │    │    └── columns: ss_quantity:39 ss_wholesale_cost:40 ss_list_price:41 ss_coupon_amt:48
 │    │    │    └── filters
 │    │    │         ├── (ss_quantity:39 >= 6) AND (ss_quantity:39 <= 10) [outer=(39), constraints=(/39: [/6 - /10]; tight)]
 │    │    │         └── (((ss_list_price:41 >= 23) AND (ss_list_price:41 <= 33.00)) OR ((ss_coupon_amt:48 >= 825) AND (ss_coupon_amt:48 <= 1825.00))) OR ((ss_wholesale_cost:40 >= 43) AND (ss_wholesale_cost:40 <= 63.00)) [outer=(40,41,48), immutable]
 │    │    └── aggregations
 │    │         ├── avg [as=avg:54, outer=(41)]
 │    │         │    └── ss_list_price:41
 │    │         ├── count [as=count:55, outer=(41)]
 │    │         │    └── ss_list_price:41
 │    │         └── agg-distinct [as=count:56, outer=(41)]
 │    │              └── count
 │    │                   └── ss_list_price:41
 │    ├── inner-join (cross)
 │    │    ├── columns: avg:82 count:83!null count:84!null avg:110 count:111!null count:112!null avg:138 count:139!null count:140!null avg:166 count:167!null count:168!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    ├── immutable
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(82-84,110-112,138-140,166-168)
 │    │    ├── scalar-group-by
 │    │    │    ├── columns: avg:82 count:83!null count:84!null
 │    │    │    ├── cardinality: [1 - 1]
 │    │    │    ├── immutable
 │    │    │    ├── key: ()
 │    │    │    ├── fd: ()-->(82-84)
 │    │    │    ├── select
 │    │    │    │    ├── columns: ss_quantity:67!null ss_wholesale_cost:68 ss_list_price:69 ss_coupon_amt:76
 │    │    │    │    ├── immutable
 │    │    │    │    ├── scan store_sales
 │    │    │    │    │    └── columns: ss_quantity:67 ss_wholesale_cost:68 ss_list_price:69 ss_coupon_amt:76
 │    │    │    │    └── filters
 │    │    │    │         ├── (ss_quantity:67 >= 11) AND (ss_quantity:67 <= 15) [outer=(67), constraints=(/67: [/11 - /15]; tight)]
 │    │    │    │         └── (((ss_list_price:69 >= 74) AND (ss_list_price:69 <= 84.00)) OR ((ss_coupon_amt:76 >= 4381) AND (ss_coupon_amt:76 <= 5381.00))) OR ((ss_wholesale_cost:68 >= 57) AND (ss_wholesale_cost:68 <= 77.00)) [outer=(68,69,76), immutable]
 │    │    │    └── aggregations
 │    │    │         ├── avg [as=avg:82, outer=(69)]
 │    │    │         │    └── ss_list_price:69
 │    │    │         ├── count [as=count:83, outer=(69)]
 │    │    │         │    └── ss_list_price:69
 │    │    │         └── agg-distinct [as=count:84, outer=(69)]
 │    │    │              └── count
 │    │    │                   └── ss_list_price:69
 │    │    ├── inner-join (cross)
 │    │    │    ├── columns: avg:110 count:111!null count:112!null avg:138 count:139!null count:140!null avg:166 count:167!null count:168!null
 │    │    │    ├── cardinality: [1 - 1]
 │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    ├── immutable
 │    │    │    ├── key: ()
 │    │    │    ├── fd: ()-->(110-112,138-140,166-168)
 │    │    │    ├── scalar-group-by
 │    │    │    │    ├── columns: avg:110 count:111!null count:112!null
 │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: ()
 │    │    │    │    ├── fd: ()-->(110-112)
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: ss_quantity:95!null ss_wholesale_cost:96 ss_list_price:97 ss_coupon_amt:104
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_quantity:95 ss_wholesale_cost:96 ss_list_price:97 ss_coupon_amt:104
 │    │    │    │    │    └── filters
 │    │    │    │    │         ├── (ss_quantity:95 >= 16) AND (ss_quantity:95 <= 20) [outer=(95), constraints=(/95: [/16 - /20]; tight)]
 │    │    │    │    │         └── (((ss_list_price:97 >= 89) AND (ss_list_price:97 <= 99.00)) OR ((ss_coupon_amt:104 >= 3117) AND (ss_coupon_amt:104 <= 4117.00))) OR ((ss_wholesale_cost:96 >= 68) AND (ss_wholesale_cost:96 <= 88.00)) [outer=(96,97,104), immutable]
 │    │    │    │    └── aggregations
 │    │    │    │         ├── avg [as=avg:110, outer=(97)]
 │    │    │    │         │    └── ss_list_price:97
 │    │    │    │         ├── count [as=count:111, outer=(97)]
 │    │    │    │         │    └── ss_list_price:97
 │    │    │    │         └── agg-distinct [as=count:112, outer=(97)]
 │    │    │    │              └── count
 │    │    │    │                   └── ss_list_price:97
 │    │    │    ├── inner-join (cross)
 │    │    │    │    ├── columns: avg:138 count:139!null count:140!null avg:166 count:167!null count:168!null
 │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: ()
 │    │    │    │    ├── fd: ()-->(138-140,166-168)
 │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    ├── columns: avg:138 count:139!null count:140!null
 │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── key: ()
 │    │    │    │    │    ├── fd: ()-->(138-140)
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: ss_quantity:123!null ss_wholesale_cost:124 ss_list_price:125 ss_coupon_amt:132
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_quantity:123 ss_wholesale_cost:124 ss_list_price:125 ss_coupon_amt:132
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         ├── (ss_quantity:123 >= 21) AND (ss_quantity:123 <= 25) [outer=(123), constraints=(/123: [/21 - /25]; tight)]
 │    │    │    │    │    │         └── (((ss_list_price:125 >= 58) AND (ss_list_price:125 <= 68.00)) OR ((ss_coupon_amt:132 >= 9402) AND (ss_coupon_amt:132 <= 10402.00))) OR ((ss_wholesale_cost:124 >= 38) AND (ss_wholesale_cost:124 <= 58.00)) [outer=(124,125,132), immutable]
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         ├── avg [as=avg:138, outer=(125)]
 │    │    │    │    │         │    └── ss_list_price:125
 │    │    │    │    │         ├── count [as=count:139, outer=(125)]
 │    │    │    │    │         │    └── ss_list_price:125
 │    │    │    │    │         └── agg-distinct [as=count:140, outer=(125)]
 │    │    │    │    │              └── count
 │    │    │    │    │                   └── ss_list_price:125
 │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    ├── columns: avg:166 count:167!null count:168!null
 │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── key: ()
 │    │    │    │    │    ├── fd: ()-->(166-168)
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: ss_quantity:151!null ss_wholesale_cost:152 ss_list_price:153 ss_coupon_amt:160
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_quantity:151 ss_wholesale_cost:152 ss_list_price:153 ss_coupon_amt:160
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         ├── (ss_quantity:151 >= 26) AND (ss_quantity:151 <= 30) [outer=(151), constraints=(/151: [/26 - /30]; tight)]
 │    │    │    │    │    │         └── (((ss_list_price:153 >= 64) AND (ss_list_price:153 <= 74.00)) OR ((ss_coupon_amt:160 >= 5792) AND (ss_coupon_amt:160 <= 6792.00))) OR ((ss_wholesale_cost:152 >= 73) AND (ss_wholesale_cost:152 <= 93.00)) [outer=(152,153,160), immutable]
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         ├── avg [as=avg:166, outer=(153)]
 │    │    │    │    │         │    └── ss_list_price:153
 │    │    │    │    │         ├── count [as=count:167, outer=(153)]
 │    │    │    │    │         │    └── ss_list_price:153
 │    │    │    │    │         └── agg-distinct [as=count:168, outer=(153)]
 │    │    │    │    │              └── count
 │    │    │    │    │                   └── ss_list_price:153
 │    │    │    │    └── filters (true)
 │    │    │    └── filters (true)
 │    │    └── filters (true)
 │    └── filters (true)
 └── filters (true)

# --------------------------------------------------
# Q29
opt
	SELECT
		i_item_id,
		i_item_desc,
		s_store_id,
		s_store_name,
		max(ss_quantity) AS store_sales_quantity,
		max(sr_return_quantity) AS store_returns_quantity,
		max(cs_quantity) AS catalog_sales_quantity
	FROM
		store_sales,
		store_returns,
		catalog_sales,
		date_dim AS d1,
		date_dim AS d2,
		date_dim AS d3,
		store,
		item
	WHERE
		d1.d_moy = 4
		AND d1.d_year = 1998
		AND d1.d_date_sk = ss_sold_date_sk
		AND i_item_sk = ss_item_sk
		AND s_store_sk = ss_store_sk
		AND ss_customer_sk = sr_customer_sk
		AND ss_item_sk = sr_item_sk
		AND ss_ticket_number = sr_ticket_number
		AND sr_returned_date_sk = d2.d_date_sk
		AND d2.d_moy BETWEEN 4 AND (4 + 3)
		AND d2.d_year = 1998
		AND sr_customer_sk = cs_bill_customer_sk
		AND sr_item_sk = cs_item_sk
		AND cs_sold_date_sk = d3.d_date_sk
		AND d3.d_year IN (1998, 1998 + 1, 1998 + 2)
	GROUP BY
		i_item_id, i_item_desc, s_store_id, s_store_name
	ORDER BY
		i_item_id, i_item_desc, s_store_id, s_store_name
	LIMIT
		100;
----
top-k
 ├── columns: i_item_id:206!null i_item_desc:209 s_store_id:175!null s_store_name:179 store_sales_quantity:229 store_returns_quantity:230 catalog_sales_quantity:231
 ├── internal-ordering: +206,+209,+175,+179
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (175,179,206,209)
 ├── fd: (175,179,206,209)-->(229-231)
 ├── ordering: +206,+209,+175,+179
 └── group-by (hash)
      ├── columns: s_store_id:175!null s_store_name:179 i_item_id:206!null i_item_desc:209 max:229 max:230 max:231
      ├── grouping columns: s_store_id:175!null s_store_name:179 i_item_id:206!null i_item_desc:209
      ├── key: (175,179,206,209)
      ├── fd: (175,179,206,209)-->(229-231)
      ├── inner-join (lookup item)
      │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null d3.d_date_sk:144!null d3.d_year:150!null s_store_sk:174!null s_store_id:175!null s_store_name:179 i_item_sk:205!null i_item_id:206!null i_item_desc:209
      │    ├── key columns: [63] = [205]
      │    ├── lookup columns are key
      │    ├── fd: ()-->(90,92,120), (3,10)-->(1,4,8,11), (174)-->(175,179), (28,35)-->(26,29,36), (144)-->(150), (205)-->(206,209), (114)-->(122), (8)==(174), (174)==(8), (48)==(144), (144)==(48), (3)==(28,63,205), (28)==(3,63,205), (63)==(3,28,205), (205)==(3,28,63), (4)==(29,51), (29)==(4,51), (51)==(4,29), (26)==(114), (114)==(26), (10)==(35), (35)==(10), (1)==(84), (84)==(1)
      │    ├── inner-join (lookup date_dim [as=d3])
      │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48!null cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null d3.d_date_sk:144!null d3.d_year:150!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    ├── key columns: [48] = [144]
      │    │    ├── lookup columns are key
      │    │    ├── fd: ()-->(90,92,120), (174)-->(175,179), (144)-->(150), (114)-->(122), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (48)==(144), (144)==(48), (8)==(174), (174)==(8)
      │    │    ├── inner-join (lookup catalog_sales)
      │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 cs_sold_date_sk:48 cs_bill_customer_sk:51!null cs_item_sk:63!null cs_quantity:66 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    ├── key columns: [28] = [63]
      │    │    │    ├── fd: ()-->(90,92,120), (174)-->(175,179), (114)-->(122), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29,51), (29)==(4,51), (51)==(4,29), (3)==(28,63), (28)==(3,63), (63)==(3,28), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
      │    │    │    ├── inner-join (lookup date_dim [as=d1])
      │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d1.d_date_sk:84!null d1.d_year:90!null d1.d_moy:92!null d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    ├── key columns: [1] = [84]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: ()-->(90,92,120), (174)-->(175,179), (114)-->(122), (28,35)-->(26,29,36), (3,10)-->(1,4,8,11), (1)==(84), (84)==(1), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (26)==(114), (114)==(26), (8)==(174), (174)==(8)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    ├── fd: ()-->(120), (174)-->(175,179), (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(122), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (8)==(174), (174)==(8)
      │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8 ss_ticket_number:10!null ss_quantity:11 sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    ├── key columns: [28 35] = [3 10]
      │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    ├── fd: ()-->(120), (3,10)-->(1,4,8,11), (28,35)-->(26,29,36), (114)-->(122), (26)==(114), (114)==(26), (4)==(29), (29)==(4), (3)==(28), (28)==(3), (10)==(35), (35)==(10)
      │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36 d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    │    ├── fd: ()-->(120), (28,35)-->(26,29,36), (114)-->(122), (26)==(114), (114)==(26)
      │    │    │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26 sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null sr_return_quantity:36
      │    │    │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    │    │    └── fd: (28,35)-->(26,29,36)
      │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_year:120!null d2.d_moy:122!null
      │    │    │    │    │    │    │    │    ├── key: (114)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(120), (114)-->(122)
      │    │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
      │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:114!null d2.d_year:120 d2.d_moy:122
      │    │    │    │    │    │    │    │    │    ├── key: (114)
      │    │    │    │    │    │    │    │    │    └── fd: (114)-->(120,122)
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         ├── (d2.d_moy:122 >= 4) AND (d2.d_moy:122 <= 7) [outer=(122), constraints=(/122: [/4 - /7]; tight)]
      │    │    │    │    │    │    │    │         └── d2.d_year:120 = 1998 [outer=(120), constraints=(/120: [/1998 - /1998]; tight), fd=()-->(120)]
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── sr_returned_date_sk:26 = d2.d_date_sk:114 [outer=(26,114), constraints=(/26: (/NULL - ]; /114: (/NULL - ]), fd=(26)==(114), (114)==(26)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_customer_sk:4 = sr_customer_sk:29 [outer=(4,29), constraints=(/4: (/NULL - ]; /29: (/NULL - ]), fd=(4)==(29), (29)==(4)]
      │    │    │    │    │    ├── scan store
      │    │    │    │    │    │    ├── columns: s_store_sk:174!null s_store_id:175!null s_store_name:179
      │    │    │    │    │    │    ├── key: (174)
      │    │    │    │    │    │    └── fd: (174)-->(175,179)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── s_store_sk:174 = ss_store_sk:8 [outer=(8,174), constraints=(/8: (/NULL - ]; /174: (/NULL - ]), fd=(8)==(174), (174)==(8)]
      │    │    │    │    └── filters
      │    │    │    │         ├── d1.d_moy:92 = 4 [outer=(92), constraints=(/92: [/4 - /4]; tight), fd=()-->(92)]
      │    │    │    │         └── d1.d_year:90 = 1998 [outer=(90), constraints=(/90: [/1998 - /1998]; tight), fd=()-->(90)]
      │    │    │    └── filters
      │    │    │         └── sr_customer_sk:29 = cs_bill_customer_sk:51 [outer=(29,51), constraints=(/29: (/NULL - ]; /51: (/NULL - ]), fd=(29)==(51), (51)==(29)]
      │    │    └── filters
      │    │         └── d3.d_year:150 IN (1998, 1999, 2000) [outer=(150), constraints=(/150: [/1998 - /1998] [/1999 - /1999] [/2000 - /2000]; tight)]
      │    └── filters (true)
      └── aggregations
           ├── max [as=max:229, outer=(11)]
           │    └── ss_quantity:11
           ├── max [as=max:230, outer=(36)]
           │    └── sr_return_quantity:36
           └── max [as=max:231, outer=(66)]
                └── cs_quantity:66

# --------------------------------------------------
# Q30
opt
	WITH
		customer_total_return
			AS (
				SELECT
					wr_returning_customer_sk AS ctr_customer_sk,
					ca_state AS ctr_state,
					sum(wr_return_amt) AS ctr_total_return
				FROM
					web_returns, date_dim, customer_address
				WHERE
					wr_returned_date_sk = d_date_sk
					AND d_year = 2000
					AND wr_returning_addr_sk = ca_address_sk
				GROUP BY
					wr_returning_customer_sk, ca_state
			)
	SELECT
		c_customer_id,
		c_salutation,
		c_first_name,
		c_last_name,
		c_preferred_cust_flag,
		c_birth_day,
		c_birth_month,
		c_birth_year,
		c_birth_country,
		c_login,
		c_email_address,
		c_last_review_date,
		ctr_total_return
	FROM
		customer_total_return AS ctr1,
		customer_address,
		customer
	WHERE
		ctr1.ctr_total_return
		> (
				SELECT
					avg(ctr_total_return) * 1.2
				FROM
					customer_total_return AS ctr2
				WHERE
					ctr1.ctr_state = ctr2.ctr_state
			)
		AND ca_address_sk = c_current_addr_sk
		AND ca_state = 'AR'
		AND ctr1.ctr_customer_sk = c_customer_sk
	ORDER BY
		c_customer_id,
		c_salutation,
		c_first_name,
		c_last_name,
		c_preferred_cust_flag,
		c_birth_day,
		c_birth_month,
		c_birth_year,
		c_birth_country,
		c_login,
		c_email_address,
		c_last_review_date,
		ctr_total_return
	LIMIT
		100;
----
with &1 (customer_total_return)
 ├── columns: c_customer_id:92!null c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108 ctr_total_return:75!null
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75
 ├── group-by (hash)
 │    ├── columns: wr_returning_customer_sk:8 ca_state:65 sum:72
 │    ├── grouping columns: wr_returning_customer_sk:8 ca_state:65
 │    ├── key: (8,65)
 │    ├── fd: (8,65)-->(72)
 │    ├── inner-join (hash)
 │    │    ├── columns: wr_returned_date_sk:1!null wr_returning_customer_sk:8 wr_returning_addr_sk:11!null wr_return_amt:16 d_date_sk:27!null d_year:33!null ca_address_sk:57!null ca_state:65
 │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │    │    ├── fd: ()-->(33), (57)-->(65), (1)==(27), (27)==(1), (11)==(57), (57)==(11)
 │    │    ├── scan customer_address
 │    │    │    ├── columns: ca_address_sk:57!null ca_state:65
 │    │    │    ├── key: (57)
 │    │    │    └── fd: (57)-->(65)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: wr_returned_date_sk:1!null wr_returning_customer_sk:8 wr_returning_addr_sk:11 wr_return_amt:16 d_date_sk:27!null d_year:33!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(33), (1)==(27), (27)==(1)
 │    │    │    ├── scan web_returns
 │    │    │    │    └── columns: wr_returned_date_sk:1 wr_returning_customer_sk:8 wr_returning_addr_sk:11 wr_return_amt:16
 │    │    │    ├── select
 │    │    │    │    ├── columns: d_date_sk:27!null d_year:33!null
 │    │    │    │    ├── key: (27)
 │    │    │    │    ├── fd: ()-->(33)
 │    │    │    │    ├── scan date_dim
 │    │    │    │    │    ├── columns: d_date_sk:27!null d_year:33
 │    │    │    │    │    ├── key: (27)
 │    │    │    │    │    └── fd: (27)-->(33)
 │    │    │    │    └── filters
 │    │    │    │         └── d_year:33 = 2000 [outer=(33), constraints=(/33: [/2000 - /2000]; tight), fd=()-->(33)]
 │    │    │    └── filters
 │    │    │         └── wr_returned_date_sk:1 = d_date_sk:27 [outer=(1,27), constraints=(/1: (/NULL - ]; /27: (/NULL - ]), fd=(1)==(27), (27)==(1)]
 │    │    └── filters
 │    │         └── wr_returning_addr_sk:11 = ca_address_sk:57 [outer=(11,57), constraints=(/11: (/NULL - ]; /57: (/NULL - ]), fd=(11)==(57), (57)==(11)]
 │    └── aggregations
 │         └── sum [as=sum:72, outer=(16)]
 │              └── wr_return_amt:16
 └── project
      ├── columns: ctr_total_return:75!null c_customer_id:92!null c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75
      └── limit
           ├── columns: ctr_customer_sk:73!null ctr_state:74!null ctr_total_return:75!null ca_address_sk:76!null ca_state:84!null c_customer_sk:91!null c_customer_id:92!null c_current_addr_sk:95!null c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108 avg:114!null
           ├── internal-ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75 opt(84)
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── key: (74,91)
           ├── fd: ()-->(84), (73,74)-->(75,114), (91)-->(92,95,98-108), (76)==(95), (95)==(76), (73)==(91), (91)==(73)
           ├── ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75 opt(84) [actual: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75]
           ├── inner-join (lookup customer_address)
           │    ├── columns: ctr_customer_sk:73!null ctr_state:74!null ctr_total_return:75!null ca_address_sk:76!null ca_state:84!null c_customer_sk:91!null c_customer_id:92!null c_current_addr_sk:95!null c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108 avg:114!null
           │    ├── key columns: [95] = [76]
           │    ├── lookup columns are key
           │    ├── immutable
           │    ├── key: (74,91)
           │    ├── fd: ()-->(84), (73,74)-->(75,114), (91)-->(92,95,98-108), (76)==(95), (95)==(76), (73)==(91), (91)==(73)
           │    ├── ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75 opt(84) [actual: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75]
           │    ├── limit hint: 100.00
           │    ├── sort
           │    │    ├── columns: ctr_customer_sk:73!null ctr_state:74!null ctr_total_return:75!null c_customer_sk:91!null c_customer_id:92!null c_current_addr_sk:95 c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108 avg:114!null
           │    │    ├── immutable
           │    │    ├── key: (74,91)
           │    │    ├── fd: (73,74)-->(75,114), (91)-->(92,95,98-108), (73)==(91), (91)==(73)
           │    │    ├── ordering: +92,+98,+99,+100,+101,+102,+103,+104,+105,+106,+107,+108,+75
           │    │    ├── limit hint: 300.00
           │    │    └── inner-join (lookup customer)
           │    │         ├── columns: ctr_customer_sk:73!null ctr_state:74!null ctr_total_return:75!null c_customer_sk:91!null c_customer_id:92!null c_current_addr_sk:95 c_salutation:98 c_first_name:99 c_last_name:100 c_preferred_cust_flag:101 c_birth_day:102 c_birth_month:103 c_birth_year:104 c_birth_country:105 c_login:106 c_email_address:107 c_last_review_date:108 avg:114!null
           │    │         ├── key columns: [73] = [91]
           │    │         ├── lookup columns are key
           │    │         ├── immutable
           │    │         ├── key: (74,91)
           │    │         ├── fd: (73,74)-->(75,114), (91)-->(92,95,98-108), (73)==(91), (91)==(73)
           │    │         ├── select
           │    │         │    ├── columns: ctr_customer_sk:73 ctr_state:74!null ctr_total_return:75!null avg:114!null
           │    │         │    ├── immutable
           │    │         │    ├── key: (73,74)
           │    │         │    ├── fd: (73,74)-->(75,114)
           │    │         │    ├── group-by (hash)
           │    │         │    │    ├── columns: ctr_customer_sk:73 ctr_state:74!null ctr_total_return:75 avg:114!null
           │    │         │    │    ├── grouping columns: ctr_customer_sk:73 ctr_state:74!null
           │    │         │    │    ├── immutable
           │    │         │    │    ├── key: (73,74)
           │    │         │    │    ├── fd: (73,74)-->(75,114)
           │    │         │    │    ├── inner-join (hash)
           │    │         │    │    │    ├── columns: ctr_customer_sk:73 ctr_state:74!null ctr_total_return:75 ctr_state:112!null ctr_total_return:113!null
           │    │         │    │    │    ├── immutable
           │    │         │    │    │    ├── fd: (73,74)-->(75), (74)==(112), (112)==(74)
           │    │         │    │    │    ├── with-scan &1 (customer_total_return)
           │    │         │    │    │    │    ├── columns: ctr_customer_sk:73 ctr_state:74 ctr_total_return:75
           │    │         │    │    │    │    ├── mapping:
           │    │         │    │    │    │    │    ├──  wr_returning_customer_sk:8 => ctr_customer_sk:73
           │    │         │    │    │    │    │    ├──  ca_state:65 => ctr_state:74
           │    │         │    │    │    │    │    └──  sum:72 => ctr_total_return:75
           │    │         │    │    │    │    ├── key: (73,74)
           │    │         │    │    │    │    └── fd: (73,74)-->(75)
           │    │         │    │    │    ├── select
           │    │         │    │    │    │    ├── columns: ctr_state:112 ctr_total_return:113!null
           │    │         │    │    │    │    ├── immutable
           │    │         │    │    │    │    ├── with-scan &1 (customer_total_return)
           │    │         │    │    │    │    │    ├── columns: ctr_state:112 ctr_total_return:113
           │    │         │    │    │    │    │    └── mapping:
           │    │         │    │    │    │    │         ├──  ca_state:65 => ctr_state:112
           │    │         │    │    │    │    │         └──  sum:72 => ctr_total_return:113
           │    │         │    │    │    │    └── filters
           │    │         │    │    │    │         └── ctr_total_return:113 IS NOT NULL [outer=(113), immutable, constraints=(/113: (/NULL - ]; tight)]
           │    │         │    │    │    └── filters
           │    │         │    │    │         └── ctr_state:74 = ctr_state:112 [outer=(74,112), constraints=(/74: (/NULL - ]; /112: (/NULL - ]), fd=(74)==(112), (112)==(74)]
           │    │         │    │    └── aggregations
           │    │         │    │         ├── avg [as=avg:114, outer=(113)]
           │    │         │    │         │    └── ctr_total_return:113
           │    │         │    │         └── const-agg [as=ctr_total_return:75, outer=(75)]
           │    │         │    │              └── ctr_total_return:75
           │    │         │    └── filters
           │    │         │         └── ctr_total_return:75 > (avg:114 * 1.2) [outer=(75,114), immutable, constraints=(/75: (/NULL - ])]
           │    │         └── filters (true)
           │    └── filters
           │         └── ca_state:84 = 'AR' [outer=(84), constraints=(/84: [/'AR' - /'AR']; tight), fd=()-->(84)]
           └── 100

# --------------------------------------------------
# Q31
opt
	WITH
		ss
			AS (
				SELECT
					ca_county,
					d_qoy,
					d_year,
					sum(ss_ext_sales_price) AS store_sales
				FROM
					store_sales, date_dim, customer_address
				WHERE
					ss_sold_date_sk = d_date_sk
					AND ss_addr_sk = ca_address_sk
				GROUP BY
					ca_county, d_qoy, d_year
			),
		ws
			AS (
				SELECT
					ca_county,
					d_qoy,
					d_year,
					sum(ws_ext_sales_price) AS web_sales
				FROM
					web_sales, date_dim, customer_address
				WHERE
					ws_sold_date_sk = d_date_sk
					AND ws_bill_addr_sk = ca_address_sk
				GROUP BY
					ca_county, d_qoy, d_year
			)
	SELECT
		ss1.ca_county,
		ss1.d_year,
		ws2.web_sales / ws1.web_sales AS web_q1_q2_increase,
		ss2.store_sales / ss1.store_sales
			AS store_q1_q2_increase,
		ws3.web_sales / ws2.web_sales AS web_q2_q3_increase,
		ss3.store_sales / ss2.store_sales
			AS store_q2_q3_increase
	FROM
		ss AS ss1,
		ss AS ss2,
		ss AS ss3,
		ws AS ws1,
		ws AS ws2,
		ws AS ws3
	WHERE
		ss1.d_qoy = 1
		AND ss1.d_year = 1999
		AND ss1.ca_county = ss2.ca_county
		AND ss2.d_qoy = 2
		AND ss2.d_year = 1999
		AND ss2.ca_county = ss3.ca_county
		AND ss3.d_qoy = 3
		AND ss3.d_year = 1999
		AND ss1.ca_county = ws1.ca_county
		AND ws1.d_qoy = 1
		AND ws1.d_year = 1999
		AND ws1.ca_county = ws2.ca_county
		AND ws2.d_qoy = 2
		AND ws2.d_year = 1999
		AND ws1.ca_county = ws3.ca_county
		AND ws3.d_qoy = 3
		AND ws3.d_year = 1999
		AND CASE
			WHEN ws1.web_sales > 0
			THEN ws2.web_sales / ws1.web_sales
			ELSE NULL
			END
			> CASE
				WHEN ss1.store_sales > 0
				THEN ss2.store_sales / ss1.store_sales
				ELSE NULL
				END
		AND CASE
			WHEN ws2.web_sales > 0
			THEN ws3.web_sales / ws2.web_sales
			ELSE NULL
			END
			> CASE
				WHEN ss2.store_sales > 0
				THEN ss3.store_sales / ss2.store_sales
				ELSE NULL
				END
	ORDER BY
		store_q2_q3_increase;
----
sort
 ├── columns: ca_county:154!null d_year:156!null web_q1_q2_increase:178 store_q1_q2_increase:179 web_q2_q3_increase:180 store_q2_q3_increase:181
 ├── immutable
 ├── key: (154)
 ├── fd: ()-->(156), (154)-->(178-181)
 ├── ordering: +181 opt(156) [actual: +181]
 └── with &1 (ss)
      ├── columns: ca_county:154!null d_year:156!null web_q1_q2_increase:178 store_q1_q2_increase:179 web_q2_q3_increase:180 store_q2_q3_increase:181
      ├── immutable
      ├── key: (154)
      ├── fd: ()-->(156), (154)-->(178-181)
      ├── group-by (hash)
      │    ├── columns: date_dim.d_year:32 date_dim.d_qoy:36 customer_address.ca_county:63 sum:71
      │    ├── grouping columns: date_dim.d_year:32 date_dim.d_qoy:36 customer_address.ca_county:63
      │    ├── key: (32,36,63)
      │    ├── fd: (32,36,63)-->(71)
      │    ├── inner-join (hash)
      │    │    ├── columns: ss_sold_date_sk:1!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null date_dim.d_year:32 date_dim.d_qoy:36 ca_address_sk:56!null customer_address.ca_county:63
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: (26)-->(32,36), (56)-->(63), (1)==(26), (26)==(1), (7)==(56), (56)==(7)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:1 ss_addr_sk:7!null ss_ext_sales_price:16 ca_address_sk:56!null customer_address.ca_county:63
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (56)-->(63), (7)==(56), (56)==(7)
      │    │    │    ├── scan store_sales
      │    │    │    │    └── columns: ss_sold_date_sk:1 ss_addr_sk:7 ss_ext_sales_price:16
      │    │    │    ├── scan customer_address
      │    │    │    │    ├── columns: ca_address_sk:56!null customer_address.ca_county:63
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(63)
      │    │    │    └── filters
      │    │    │         └── ss_addr_sk:7 = ca_address_sk:56 [outer=(7,56), constraints=(/7: (/NULL - ]; /56: (/NULL - ]), fd=(7)==(56), (56)==(7)]
      │    │    ├── scan date_dim
      │    │    │    ├── columns: d_date_sk:26!null date_dim.d_year:32 date_dim.d_qoy:36
      │    │    │    ├── key: (26)
      │    │    │    └── fd: (26)-->(32,36)
      │    │    └── filters
      │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    └── aggregations
      │         └── sum [as=sum:71, outer=(16)]
      │              └── ss_ext_sales_price:16
      └── with &2 (ws)
           ├── columns: ca_county:154!null d_year:156!null web_q1_q2_increase:178 store_q1_q2_increase:179 web_q2_q3_increase:180 store_q2_q3_increase:181
           ├── immutable
           ├── key: (154)
           ├── fd: ()-->(156), (154)-->(178-181)
           ├── group-by (hash)
           │    ├── columns: date_dim.d_year:114 date_dim.d_qoy:118 customer_address.ca_county:145 sum:153
           │    ├── grouping columns: date_dim.d_year:114 date_dim.d_qoy:118 customer_address.ca_county:145
           │    ├── key: (114,118,145)
           │    ├── fd: (114,118,145)-->(153)
           │    ├── inner-join (hash)
           │    │    ├── columns: ws_sold_date_sk:72!null ws_bill_addr_sk:79!null ws_ext_sales_price:95 d_date_sk:108!null date_dim.d_year:114 date_dim.d_qoy:118 ca_address_sk:138!null customer_address.ca_county:145
           │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    ├── fd: (108)-->(114,118), (138)-->(145), (72)==(108), (108)==(72), (79)==(138), (138)==(79)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: ws_sold_date_sk:72 ws_bill_addr_sk:79!null ws_ext_sales_price:95 ca_address_sk:138!null customer_address.ca_county:145
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: (138)-->(145), (79)==(138), (138)==(79)
           │    │    │    ├── scan web_sales
           │    │    │    │    └── columns: ws_sold_date_sk:72 ws_bill_addr_sk:79 ws_ext_sales_price:95
           │    │    │    ├── scan customer_address
           │    │    │    │    ├── columns: ca_address_sk:138!null customer_address.ca_county:145
           │    │    │    │    ├── key: (138)
           │    │    │    │    └── fd: (138)-->(145)
           │    │    │    └── filters
           │    │    │         └── ws_bill_addr_sk:79 = ca_address_sk:138 [outer=(79,138), constraints=(/79: (/NULL - ]; /138: (/NULL - ]), fd=(79)==(138), (138)==(79)]
           │    │    ├── scan date_dim
           │    │    │    ├── columns: d_date_sk:108!null date_dim.d_year:114 date_dim.d_qoy:118
           │    │    │    ├── key: (108)
           │    │    │    └── fd: (108)-->(114,118)
           │    │    └── filters
           │    │         └── ws_sold_date_sk:72 = d_date_sk:108 [outer=(72,108), constraints=(/72: (/NULL - ]; /108: (/NULL - ]), fd=(72)==(108), (108)==(72)]
           │    └── aggregations
           │         └── sum [as=sum:153, outer=(95)]
           │              └── ws_ext_sales_price:95
           └── project
                ├── columns: web_q1_q2_increase:178 store_q1_q2_increase:179 web_q2_q3_increase:180 store_q2_q3_increase:181 ca_county:154!null d_year:156!null
                ├── immutable
                ├── key: (154)
                ├── fd: ()-->(156), (154)-->(178-181)
                ├── inner-join (hash)
                │    ├── columns: ca_county:154!null d_qoy:155!null d_year:156!null store_sales:157 ca_county:158!null d_qoy:159!null d_year:160!null store_sales:161 ca_county:162!null d_qoy:163!null d_year:164!null store_sales:165 ca_county:166!null d_qoy:167!null d_year:168!null web_sales:169 ca_county:170!null d_qoy:171!null d_year:172!null web_sales:173 ca_county:174!null d_qoy:175!null d_year:176!null web_sales:177
                │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
                │    ├── immutable
                │    ├── key: (174)
                │    ├── fd: ()-->(155,156,159,160,163,164,167,168,171,172,175,176), (154)-->(157), (158)-->(161), (162)-->(165), (166)-->(169), (170)-->(173), (174)-->(177), (154)==(158,162,166,170,174), (158)==(154,162,166,170,174), (162)==(154,158,166,170,174), (166)==(154,158,162,170,174), (170)==(154,158,162,166,174), (174)==(154,158,162,166,170)
                │    ├── inner-join (hash)
                │    │    ├── columns: ca_county:154!null d_qoy:155!null d_year:156!null store_sales:157 ca_county:166!null d_qoy:167!null d_year:168!null web_sales:169
                │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
                │    │    ├── key: (166)
                │    │    ├── fd: ()-->(155,156,167,168), (154)-->(157), (166)-->(169), (154)==(166), (166)==(154)
                │    │    ├── select
                │    │    │    ├── columns: ca_county:154 d_qoy:155!null d_year:156!null store_sales:157
                │    │    │    ├── key: (154)
                │    │    │    ├── fd: ()-->(155,156), (154)-->(157)
                │    │    │    ├── with-scan &1 (ss)
                │    │    │    │    ├── columns: ca_county:154 d_qoy:155 d_year:156 store_sales:157
                │    │    │    │    ├── mapping:
                │    │    │    │    │    ├──  customer_address.ca_county:63 => ca_county:154
                │    │    │    │    │    ├──  date_dim.d_qoy:36 => d_qoy:155
                │    │    │    │    │    ├──  date_dim.d_year:32 => d_year:156
                │    │    │    │    │    └──  sum:71 => store_sales:157
                │    │    │    │    ├── key: (154-156)
                │    │    │    │    └── fd: (154-156)-->(157)
                │    │    │    └── filters
                │    │    │         ├── d_qoy:155 = 1 [outer=(155), constraints=(/155: [/1 - /1]; tight), fd=()-->(155)]
                │    │    │         └── d_year:156 = 1999 [outer=(156), constraints=(/156: [/1999 - /1999]; tight), fd=()-->(156)]
                │    │    ├── select
                │    │    │    ├── columns: ca_county:166 d_qoy:167!null d_year:168!null web_sales:169
                │    │    │    ├── key: (166)
                │    │    │    ├── fd: ()-->(167,168), (166)-->(169)
                │    │    │    ├── with-scan &2 (ws)
                │    │    │    │    ├── columns: ca_county:166 d_qoy:167 d_year:168 web_sales:169
                │    │    │    │    ├── mapping:
                │    │    │    │    │    ├──  customer_address.ca_county:145 => ca_county:166
                │    │    │    │    │    ├──  date_dim.d_qoy:118 => d_qoy:167
                │    │    │    │    │    ├──  date_dim.d_year:114 => d_year:168
                │    │    │    │    │    └──  sum:153 => web_sales:169
                │    │    │    │    ├── key: (166-168)
                │    │    │    │    └── fd: (166-168)-->(169)
                │    │    │    └── filters
                │    │    │         ├── d_qoy:167 = 1 [outer=(167), constraints=(/167: [/1 - /1]; tight), fd=()-->(167)]
                │    │    │         └── d_year:168 = 1999 [outer=(168), constraints=(/168: [/1999 - /1999]; tight), fd=()-->(168)]
                │    │    └── filters
                │    │         └── ca_county:154 = ca_county:166 [outer=(154,166), constraints=(/154: (/NULL - ]; /166: (/NULL - ]), fd=(154)==(166), (166)==(154)]
                │    ├── inner-join (hash)
                │    │    ├── columns: ca_county:158!null d_qoy:159!null d_year:160!null store_sales:161 ca_county:162!null d_qoy:163!null d_year:164!null store_sales:165 ca_county:170!null d_qoy:171!null d_year:172!null web_sales:173 ca_county:174!null d_qoy:175!null d_year:176!null web_sales:177
                │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
                │    │    ├── immutable
                │    │    ├── key: (174)
                │    │    ├── fd: ()-->(159,160,163,164,171,172,175,176), (158)-->(161), (162)-->(165), (170)-->(173), (174)-->(177), (158)==(162,170,174), (162)==(158,170,174), (170)==(158,162,174), (174)==(158,162,170)
                │    │    ├── inner-join (hash)
                │    │    │    ├── columns: ca_county:158!null d_qoy:159!null d_year:160!null store_sales:161 ca_county:162!null d_qoy:163!null d_year:164!null store_sales:165
                │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
                │    │    │    ├── key: (162)
                │    │    │    ├── fd: ()-->(159,160,163,164), (158)-->(161), (162)-->(165), (158)==(162), (162)==(158)
                │    │    │    ├── select
                │    │    │    │    ├── columns: ca_county:158 d_qoy:159!null d_year:160!null store_sales:161
                │    │    │    │    ├── key: (158)
                │    │    │    │    ├── fd: ()-->(159,160), (158)-->(161)
                │    │    │    │    ├── with-scan &1 (ss)
                │    │    │    │    │    ├── columns: ca_county:158 d_qoy:159 d_year:160 store_sales:161
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  customer_address.ca_county:63 => ca_county:158
                │    │    │    │    │    │    ├──  date_dim.d_qoy:36 => d_qoy:159
                │    │    │    │    │    │    ├──  date_dim.d_year:32 => d_year:160
                │    │    │    │    │    │    └──  sum:71 => store_sales:161
                │    │    │    │    │    ├── key: (158-160)
                │    │    │    │    │    └── fd: (158-160)-->(161)
                │    │    │    │    └── filters
                │    │    │    │         ├── d_qoy:159 = 2 [outer=(159), constraints=(/159: [/2 - /2]; tight), fd=()-->(159)]
                │    │    │    │         └── d_year:160 = 1999 [outer=(160), constraints=(/160: [/1999 - /1999]; tight), fd=()-->(160)]
                │    │    │    ├── select
                │    │    │    │    ├── columns: ca_county:162 d_qoy:163!null d_year:164!null store_sales:165
                │    │    │    │    ├── key: (162)
                │    │    │    │    ├── fd: ()-->(163,164), (162)-->(165)
                │    │    │    │    ├── with-scan &1 (ss)
                │    │    │    │    │    ├── columns: ca_county:162 d_qoy:163 d_year:164 store_sales:165
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  customer_address.ca_county:63 => ca_county:162
                │    │    │    │    │    │    ├──  date_dim.d_qoy:36 => d_qoy:163
                │    │    │    │    │    │    ├──  date_dim.d_year:32 => d_year:164
                │    │    │    │    │    │    └──  sum:71 => store_sales:165
                │    │    │    │    │    ├── key: (162-164)
                │    │    │    │    │    └── fd: (162-164)-->(165)
                │    │    │    │    └── filters
                │    │    │    │         ├── d_qoy:163 = 3 [outer=(163), constraints=(/163: [/3 - /3]; tight), fd=()-->(163)]
                │    │    │    │         └── d_year:164 = 1999 [outer=(164), constraints=(/164: [/1999 - /1999]; tight), fd=()-->(164)]
                │    │    │    └── filters
                │    │    │         └── ca_county:158 = ca_county:162 [outer=(158,162), constraints=(/158: (/NULL - ]; /162: (/NULL - ]), fd=(158)==(162), (162)==(158)]
                │    │    ├── inner-join (hash)
                │    │    │    ├── columns: ca_county:170!null d_qoy:171!null d_year:172!null web_sales:173 ca_county:174!null d_qoy:175!null d_year:176!null web_sales:177
                │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
                │    │    │    ├── key: (174)
                │    │    │    ├── fd: ()-->(171,172,175,176), (170)-->(173), (174)-->(177), (170)==(174), (174)==(170)
                │    │    │    ├── select
                │    │    │    │    ├── columns: ca_county:170 d_qoy:171!null d_year:172!null web_sales:173
                │    │    │    │    ├── key: (170)
                │    │    │    │    ├── fd: ()-->(171,172), (170)-->(173)
                │    │    │    │    ├── with-scan &2 (ws)
                │    │    │    │    │    ├── columns: ca_county:170 d_qoy:171 d_year:172 web_sales:173
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  customer_address.ca_county:145 => ca_county:170
                │    │    │    │    │    │    ├──  date_dim.d_qoy:118 => d_qoy:171
                │    │    │    │    │    │    ├──  date_dim.d_year:114 => d_year:172
                │    │    │    │    │    │    └──  sum:153 => web_sales:173
                │    │    │    │    │    ├── key: (170-172)
                │    │    │    │    │    └── fd: (170-172)-->(173)
                │    │    │    │    └── filters
                │    │    │    │         ├── d_qoy:171 = 2 [outer=(171), constraints=(/171: [/2 - /2]; tight), fd=()-->(171)]
                │    │    │    │         └── d_year:172 = 1999 [outer=(172), constraints=(/172: [/1999 - /1999]; tight), fd=()-->(172)]
                │    │    │    ├── select
                │    │    │    │    ├── columns: ca_county:174 d_qoy:175!null d_year:176!null web_sales:177
                │    │    │    │    ├── key: (174)
                │    │    │    │    ├── fd: ()-->(175,176), (174)-->(177)
                │    │    │    │    ├── with-scan &2 (ws)
                │    │    │    │    │    ├── columns: ca_county:174 d_qoy:175 d_year:176 web_sales:177
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  customer_address.ca_county:145 => ca_county:174
                │    │    │    │    │    │    ├──  date_dim.d_qoy:118 => d_qoy:175
                │    │    │    │    │    │    ├──  date_dim.d_year:114 => d_year:176
                │    │    │    │    │    │    └──  sum:153 => web_sales:177
                │    │    │    │    │    ├── key: (174-176)
                │    │    │    │    │    └── fd: (174-176)-->(177)
                │    │    │    │    └── filters
                │    │    │    │         ├── d_qoy:175 = 3 [outer=(175), constraints=(/175: [/3 - /3]; tight), fd=()-->(175)]
                │    │    │    │         └── d_year:176 = 1999 [outer=(176), constraints=(/176: [/1999 - /1999]; tight), fd=()-->(176)]
                │    │    │    └── filters
                │    │    │         └── ca_county:170 = ca_county:174 [outer=(170,174), constraints=(/170: (/NULL - ]; /174: (/NULL - ]), fd=(170)==(174), (174)==(170)]
                │    │    └── filters
                │    │         ├── CASE WHEN web_sales:173 > 0 THEN web_sales:177 / web_sales:173 ELSE CAST(NULL AS DECIMAL) END > CASE WHEN store_sales:161 > 0 THEN store_sales:165 / store_sales:161 ELSE CAST(NULL AS DECIMAL) END [outer=(161,165,173,177), immutable]
                │    │         └── ca_county:158 = ca_county:170 [outer=(158,170), constraints=(/158: (/NULL - ]; /170: (/NULL - ]), fd=(158)==(170), (170)==(158)]
                │    └── filters
                │         ├── ca_county:166 = ca_county:170 [outer=(166,170), constraints=(/166: (/NULL - ]; /170: (/NULL - ]), fd=(166)==(170), (170)==(166)]
                │         └── CASE WHEN web_sales:169 > 0 THEN web_sales:173 / web_sales:169 ELSE CAST(NULL AS DECIMAL) END > CASE WHEN store_sales:157 > 0 THEN store_sales:161 / store_sales:157 ELSE CAST(NULL AS DECIMAL) END [outer=(157,161,169,173), immutable]
                └── projections
                     ├── web_sales:173 / web_sales:169 [as=web_q1_q2_increase:178, outer=(169,173), immutable]
                     ├── store_sales:161 / store_sales:157 [as=store_q1_q2_increase:179, outer=(157,161), immutable]
                     ├── web_sales:177 / web_sales:173 [as=web_q2_q3_increase:180, outer=(173,177), immutable]
                     └── store_sales:165 / store_sales:161 [as=store_q2_q3_increase:181, outer=(161,165), immutable]

# --------------------------------------------------
# Q32
# NOTE: Added conversion of 90 days to an interval.
opt
	SELECT
		sum(cs_ext_discount_amt) AS "excess discount amount"
	FROM
		catalog_sales, item, date_dim
	WHERE
		i_manufact_id = 722
		AND i_item_sk = cs_item_sk
		AND d_date BETWEEN '2001-03-09' AND (CAST('2001-03-09' AS DATE) + '90 days'::INTERVAL)
		AND d_date_sk = cs_sold_date_sk
		AND cs_ext_discount_amt
			> (
					SELECT
						1.3 * avg(cs_ext_discount_amt)
					FROM
						catalog_sales, date_dim
					WHERE
						cs_item_sk = i_item_sk
						AND d_date BETWEEN '2001-03-09' AND (CAST('2001-03-09' AS DATE) + '90 days'::INTERVAL)
						AND d_date_sk = cs_sold_date_sk
				)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: "excess discount amount":159
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(159)
 ├── inner-join (lookup catalog_sales)
 │    ├── columns: cs_sold_date_sk:1!null cs_item_sk:16!null cs_ext_discount_amt:23!null i_item_sk:37!null d_date_sk:61!null "?column?":158!null
 │    ├── key columns: [37] = [16]
 │    ├── immutable
 │    ├── fd: (37,61)-->(158), (16)==(37), (37)==(16), (1)==(61), (61)==(1)
 │    ├── project
 │    │    ├── columns: "?column?":158!null i_item_sk:37!null d_date_sk:61!null
 │    │    ├── immutable
 │    │    ├── key: (37,61)
 │    │    ├── fd: (37,61)-->(158)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: i_item_sk:37!null d_date_sk:61!null avg:157!null
 │    │    │    ├── grouping columns: i_item_sk:37!null d_date_sk:61!null
 │    │    │    ├── immutable
 │    │    │    ├── key: (37,61)
 │    │    │    ├── fd: (37,61)-->(157)
 │    │    │    ├── inner-join (cross)
 │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null d_date_sk:61!null d_date:63!null cs_sold_date_sk:91!null cs_item_sk:106!null cs_ext_discount_amt:113!null d_date_sk:127!null d_date:129!null
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(50), (61)-->(63), (127)-->(129), (91)==(127), (127)==(91), (37)==(106), (106)==(37)
 │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null cs_sold_date_sk:91!null cs_item_sk:106!null cs_ext_discount_amt:113!null d_date_sk:127!null d_date:129!null
 │    │    │    │    │    ├── key columns: [91] = [127]
 │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── fd: ()-->(50), (127)-->(129), (91)==(127), (127)==(91), (37)==(106), (106)==(37)
 │    │    │    │    │    ├── inner-join (lookup catalog_sales)
 │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null cs_sold_date_sk:91 cs_item_sk:106!null cs_ext_discount_amt:113!null
 │    │    │    │    │    │    ├── key columns: [37] = [106]
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── fd: ()-->(50), (37)==(106), (106)==(37)
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null
 │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    ├── fd: ()-->(50)
 │    │    │    │    │    │    │    ├── scan item
 │    │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50
 │    │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    │    └── fd: (37)-->(50)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── i_manufact_id:50 = 722 [outer=(50), constraints=(/50: [/722 - /722]; tight), fd=()-->(50)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── cs_ext_discount_amt:113 IS NOT NULL [outer=(113), immutable, constraints=(/113: (/NULL - ]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (d_date:129 >= '2001-03-09') AND (d_date:129 <= '2001-06-07') [outer=(129), constraints=(/129: [/'2001-03-09' - /'2001-06-07']; tight)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
 │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    ├── fd: (61)-->(63)
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
 │    │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    │    └── fd: (61)-->(63)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (d_date:63 >= '2001-03-09') AND (d_date:63 <= '2001-06-07') [outer=(63), constraints=(/63: [/'2001-03-09' - /'2001-06-07']; tight)]
 │    │    │    │    └── filters (true)
 │    │    │    └── aggregations
 │    │    │         └── avg [as=avg:157, outer=(113)]
 │    │    │              └── cs_ext_discount_amt:113
 │    │    └── projections
 │    │         └── avg:157 * 1.3 [as="?column?":158, outer=(157), immutable]
 │    └── filters
 │         ├── d_date_sk:61 = cs_sold_date_sk:1 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
 │         └── cs_ext_discount_amt:23 > "?column?":158 [outer=(23,158), immutable, constraints=(/23: (/NULL - ]; /158: (/NULL - ])]
 └── aggregations
      └── sum [as=sum:159, outer=(23)]
           └── cs_ext_discount_amt:23

# --------------------------------------------------
# Q33
opt
	WITH
		ss
			AS (
				SELECT
					i_manufact_id,
					sum(ss_ext_sales_price) AS total_sales
				FROM
					store_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_manufact_id
					IN (
							SELECT
								i_manufact_id
							FROM
								item
							WHERE
								i_category IN ('Books',)
						)
					AND ss_item_sk = i_item_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 2001
					AND d_moy = 3
					AND ss_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_manufact_id
			),
		cs
			AS (
				SELECT
					i_manufact_id,
					sum(cs_ext_sales_price) AS total_sales
				FROM
					catalog_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_manufact_id
					IN (
							SELECT
								i_manufact_id
							FROM
								item
							WHERE
								i_category IN ('Books',)
						)
					AND cs_item_sk = i_item_sk
					AND cs_sold_date_sk = d_date_sk
					AND d_year = 2001
					AND d_moy = 3
					AND cs_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_manufact_id
			),
		ws
			AS (
				SELECT
					i_manufact_id,
					sum(ws_ext_sales_price) AS total_sales
				FROM
					web_sales, date_dim, customer_address, item
				WHERE
					i_manufact_id
					IN (
							SELECT
								i_manufact_id
							FROM
								item
							WHERE
								i_category IN ('Books',)
						)
					AND ws_item_sk = i_item_sk
					AND ws_sold_date_sk = d_date_sk
					AND d_year = 2001
					AND d_moy = 3
					AND ws_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_manufact_id
			)
	SELECT
		i_manufact_id, sum(total_sales) AS total_sales
	FROM
		(
			SELECT * FROM ss UNION ALL SELECT * FROM cs
			UNION ALL SELECT * FROM ws
		)
			AS tmp1
	GROUP BY
		i_manufact_id
	ORDER BY
		total_sales
	LIMIT
		100;
----
top-k
 ├── columns: i_manufact_id:391 total_sales:393
 ├── internal-ordering: +393
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (391)
 ├── fd: (391)-->(393)
 ├── ordering: +393
 └── group-by (hash)
      ├── columns: i_manufact_id:391 sum:393
      ├── grouping columns: i_manufact_id:391
      ├── immutable
      ├── key: (391)
      ├── fd: (391)-->(393)
      ├── union-all
      │    ├── columns: i_manufact_id:391 total_sales:392
      │    ├── left columns: i_manufact_id:387 total_sales:388
      │    ├── right columns: i_manufact_id:389 total_sales:390
      │    ├── immutable
      │    ├── union-all
      │    │    ├── columns: i_manufact_id:387 total_sales:388
      │    │    ├── left columns: i_manufact_id:383 total_sales:384
      │    │    ├── right columns: i_manufact_id:385 total_sales:386
      │    │    ├── immutable
      │    │    ├── project
      │    │    │    ├── columns: i_manufact_id:383 total_sales:384
      │    │    │    ├── immutable
      │    │    │    ├── key: (383)
      │    │    │    ├── fd: (383)-->(384)
      │    │    │    ├── group-by (hash)
      │    │    │    │    ├── columns: item.i_manufact_id:84 sum:120
      │    │    │    │    ├── grouping columns: item.i_manufact_id:84
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (84)
      │    │    │    │    ├── fd: (84)-->(120)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null ca_address_sk:56!null ca_gmt_offset:67!null i_item_sk:71!null item.i_manufact_id:84!null item.i_manufact_id:108!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── fd: ()-->(32,34,67), (71)-->(84), (3)==(71), (71)==(3), (7)==(56), (56)==(7), (1)==(26), (26)==(1), (84)==(108), (108)==(84)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null ca_address_sk:56!null ca_gmt_offset:67!null i_item_sk:71!null item.i_manufact_id:84
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    ├── fd: ()-->(32,34,67), (71)-->(84), (3)==(71), (71)==(3), (7)==(56), (56)==(7), (1)==(26), (26)==(1)
      │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null ca_address_sk:56!null ca_gmt_offset:67!null
      │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    ├── fd: ()-->(32,34,67), (1)==(26), (26)==(1), (7)==(56), (56)==(7)
      │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null
      │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(32,34), (1)==(26), (26)==(1)
      │    │    │    │    │    │    │    │    ├── scan store_sales
      │    │    │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16
      │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_moy:34!null
      │    │    │    │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    │    │    │    ├── fd: ()-->(32,34)
      │    │    │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_moy:34
      │    │    │    │    │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    │    │    │    │    └── fd: (26)-->(32,34)
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         ├── d_year:32 = 2001 [outer=(32), constraints=(/32: [/2001 - /2001]; tight), fd=()-->(32)]
      │    │    │    │    │    │    │    │    │         └── d_moy:34 = 3 [outer=(34), constraints=(/34: [/3 - /3]; tight), fd=()-->(34)]
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    ├── columns: ca_address_sk:56!null ca_gmt_offset:67!null
      │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(67)
      │    │    │    │    │    │    │    │    ├── scan customer_address
      │    │    │    │    │    │    │    │    │    ├── columns: ca_address_sk:56!null ca_gmt_offset:67
      │    │    │    │    │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    │    │    │    │    └── fd: (56)-->(67)
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── ca_gmt_offset:67 = -5 [outer=(67), immutable, constraints=(/67: [/-5 - /-5]; tight), fd=()-->(67)]
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── ss_addr_sk:7 = ca_address_sk:56 [outer=(7,56), constraints=(/7: (/NULL - ]; /56: (/NULL - ]), fd=(7)==(56), (56)==(7)]
      │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    ├── columns: i_item_sk:71!null item.i_manufact_id:84
      │    │    │    │    │    │    │    ├── key: (71)
      │    │    │    │    │    │    │    └── fd: (71)-->(84)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_item_sk:3 = i_item_sk:71 [outer=(3,71), constraints=(/3: (/NULL - ]; /71: (/NULL - ]), fd=(3)==(71), (71)==(3)]
      │    │    │    │    │    ├── distinct-on
      │    │    │    │    │    │    ├── columns: item.i_manufact_id:108
      │    │    │    │    │    │    ├── grouping columns: item.i_manufact_id:108
      │    │    │    │    │    │    ├── key: (108)
      │    │    │    │    │    │    └── select
      │    │    │    │    │    │         ├── columns: i_category:107!null item.i_manufact_id:108
      │    │    │    │    │    │         ├── fd: ()-->(107)
      │    │    │    │    │    │         ├── scan item
      │    │    │    │    │    │         │    └── columns: i_category:107 item.i_manufact_id:108
      │    │    │    │    │    │         └── filters
      │    │    │    │    │    │              └── i_category:107 = 'Books' [outer=(107), constraints=(/107: [/'Books' - /'Books']; tight), fd=()-->(107)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── item.i_manufact_id:84 = item.i_manufact_id:108 [outer=(84,108), constraints=(/84: (/NULL - ]; /108: (/NULL - ]), fd=(84)==(108), (108)==(84)]
      │    │    │    │    └── aggregations
      │    │    │    │         └── sum [as=sum:120, outer=(16)]
      │    │    │    │              └── ss_ext_sales_price:16
      │    │    │    └── projections
      │    │    │         ├── item.i_manufact_id:84 [as=i_manufact_id:383, outer=(84)]
      │    │    │         └── sum:120 [as=total_sales:384, outer=(120)]
      │    │    └── project
      │    │         ├── columns: i_manufact_id:385 total_sales:386
      │    │         ├── immutable
      │    │         ├── key: (385)
      │    │         ├── fd: (385)-->(386)
      │    │         ├── group-by (hash)
      │    │         │    ├── columns: item.i_manufact_id:215 sum:251
      │    │         │    ├── grouping columns: item.i_manufact_id:215
      │    │         │    ├── immutable
      │    │         │    ├── key: (215)
      │    │         │    ├── fd: (215)-->(251)
      │    │         │    ├── inner-join (hash)
      │    │         │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127!null cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null ca_address_sk:187!null ca_gmt_offset:198!null i_item_sk:202!null item.i_manufact_id:215!null item.i_manufact_id:239!null
      │    │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    ├── immutable
      │    │         │    │    ├── fd: ()-->(163,165,198), (202)-->(215), (136)==(202), (202)==(136), (127)==(187), (187)==(127), (121)==(157), (157)==(121), (215)==(239), (239)==(215)
      │    │         │    │    ├── inner-join (hash)
      │    │         │    │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127!null cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null ca_address_sk:187!null ca_gmt_offset:198!null i_item_sk:202!null item.i_manufact_id:215
      │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    ├── immutable
      │    │         │    │    │    ├── fd: ()-->(163,165,198), (202)-->(215), (136)==(202), (202)==(136), (127)==(187), (187)==(127), (121)==(157), (157)==(121)
      │    │         │    │    │    ├── inner-join (hash)
      │    │         │    │    │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127!null cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null ca_address_sk:187!null ca_gmt_offset:198!null
      │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    │    ├── immutable
      │    │         │    │    │    │    ├── fd: ()-->(163,165,198), (121)==(157), (157)==(121), (127)==(187), (187)==(127)
      │    │         │    │    │    │    ├── inner-join (hash)
      │    │         │    │    │    │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null
      │    │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    │    │    ├── fd: ()-->(163,165), (121)==(157), (157)==(121)
      │    │         │    │    │    │    │    ├── scan catalog_sales
      │    │         │    │    │    │    │    │    └── columns: cs_sold_date_sk:121 cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144
      │    │         │    │    │    │    │    ├── select
      │    │         │    │    │    │    │    │    ├── columns: d_date_sk:157!null d_year:163!null d_moy:165!null
      │    │         │    │    │    │    │    │    ├── key: (157)
      │    │         │    │    │    │    │    │    ├── fd: ()-->(163,165)
      │    │         │    │    │    │    │    │    ├── scan date_dim
      │    │         │    │    │    │    │    │    │    ├── columns: d_date_sk:157!null d_year:163 d_moy:165
      │    │         │    │    │    │    │    │    │    ├── key: (157)
      │    │         │    │    │    │    │    │    │    └── fd: (157)-->(163,165)
      │    │         │    │    │    │    │    │    └── filters
      │    │         │    │    │    │    │    │         ├── d_year:163 = 2001 [outer=(163), constraints=(/163: [/2001 - /2001]; tight), fd=()-->(163)]
      │    │         │    │    │    │    │    │         └── d_moy:165 = 3 [outer=(165), constraints=(/165: [/3 - /3]; tight), fd=()-->(165)]
      │    │         │    │    │    │    │    └── filters
      │    │         │    │    │    │    │         └── cs_sold_date_sk:121 = d_date_sk:157 [outer=(121,157), constraints=(/121: (/NULL - ]; /157: (/NULL - ]), fd=(121)==(157), (157)==(121)]
      │    │         │    │    │    │    ├── select
      │    │         │    │    │    │    │    ├── columns: ca_address_sk:187!null ca_gmt_offset:198!null
      │    │         │    │    │    │    │    ├── immutable
      │    │         │    │    │    │    │    ├── key: (187)
      │    │         │    │    │    │    │    ├── fd: ()-->(198)
      │    │         │    │    │    │    │    ├── scan customer_address
      │    │         │    │    │    │    │    │    ├── columns: ca_address_sk:187!null ca_gmt_offset:198
      │    │         │    │    │    │    │    │    ├── key: (187)
      │    │         │    │    │    │    │    │    └── fd: (187)-->(198)
      │    │         │    │    │    │    │    └── filters
      │    │         │    │    │    │    │         └── ca_gmt_offset:198 = -5 [outer=(198), immutable, constraints=(/198: [/-5 - /-5]; tight), fd=()-->(198)]
      │    │         │    │    │    │    └── filters
      │    │         │    │    │    │         └── cs_bill_addr_sk:127 = ca_address_sk:187 [outer=(127,187), constraints=(/127: (/NULL - ]; /187: (/NULL - ]), fd=(127)==(187), (187)==(127)]
      │    │         │    │    │    ├── scan item
      │    │         │    │    │    │    ├── columns: i_item_sk:202!null item.i_manufact_id:215
      │    │         │    │    │    │    ├── key: (202)
      │    │         │    │    │    │    └── fd: (202)-->(215)
      │    │         │    │    │    └── filters
      │    │         │    │    │         └── cs_item_sk:136 = i_item_sk:202 [outer=(136,202), constraints=(/136: (/NULL - ]; /202: (/NULL - ]), fd=(136)==(202), (202)==(136)]
      │    │         │    │    ├── distinct-on
      │    │         │    │    │    ├── columns: item.i_manufact_id:239
      │    │         │    │    │    ├── grouping columns: item.i_manufact_id:239
      │    │         │    │    │    ├── key: (239)
      │    │         │    │    │    └── select
      │    │         │    │    │         ├── columns: i_category:238!null item.i_manufact_id:239
      │    │         │    │    │         ├── fd: ()-->(238)
      │    │         │    │    │         ├── scan item
      │    │         │    │    │         │    └── columns: i_category:238 item.i_manufact_id:239
      │    │         │    │    │         └── filters
      │    │         │    │    │              └── i_category:238 = 'Books' [outer=(238), constraints=(/238: [/'Books' - /'Books']; tight), fd=()-->(238)]
      │    │         │    │    └── filters
      │    │         │    │         └── item.i_manufact_id:215 = item.i_manufact_id:239 [outer=(215,239), constraints=(/215: (/NULL - ]; /239: (/NULL - ]), fd=(215)==(239), (239)==(215)]
      │    │         │    └── aggregations
      │    │         │         └── sum [as=sum:251, outer=(144)]
      │    │         │              └── cs_ext_sales_price:144
      │    │         └── projections
      │    │              ├── item.i_manufact_id:215 [as=i_manufact_id:385, outer=(215)]
      │    │              └── sum:251 [as=total_sales:386, outer=(251)]
      │    └── project
      │         ├── columns: i_manufact_id:389 total_sales:390
      │         ├── immutable
      │         ├── key: (389)
      │         ├── fd: (389)-->(390)
      │         ├── group-by (hash)
      │         │    ├── columns: item.i_manufact_id:346 sum:382
      │         │    ├── grouping columns: item.i_manufact_id:346
      │         │    ├── immutable
      │         │    ├── key: (346)
      │         │    ├── fd: (346)-->(382)
      │         │    ├── inner-join (hash)
      │         │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259!null ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null ca_address_sk:318!null ca_gmt_offset:329!null i_item_sk:333!null item.i_manufact_id:346!null item.i_manufact_id:370!null
      │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    ├── immutable
      │         │    │    ├── fd: ()-->(294,296,329), (333)-->(346), (255)==(333), (333)==(255), (259)==(318), (318)==(259), (252)==(288), (288)==(252), (346)==(370), (370)==(346)
      │         │    │    ├── inner-join (hash)
      │         │    │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259!null ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null ca_address_sk:318!null ca_gmt_offset:329!null i_item_sk:333!null item.i_manufact_id:346
      │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    ├── immutable
      │         │    │    │    ├── fd: ()-->(294,296,329), (333)-->(346), (255)==(333), (333)==(255), (259)==(318), (318)==(259), (252)==(288), (288)==(252)
      │         │    │    │    ├── inner-join (hash)
      │         │    │    │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259!null ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null ca_address_sk:318!null ca_gmt_offset:329!null
      │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    │    ├── immutable
      │         │    │    │    │    ├── fd: ()-->(294,296,329), (252)==(288), (288)==(252), (259)==(318), (318)==(259)
      │         │    │    │    │    ├── inner-join (hash)
      │         │    │    │    │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null
      │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    │    │    ├── fd: ()-->(294,296), (252)==(288), (288)==(252)
      │         │    │    │    │    │    ├── scan web_sales
      │         │    │    │    │    │    │    └── columns: ws_sold_date_sk:252 ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275
      │         │    │    │    │    │    ├── select
      │         │    │    │    │    │    │    ├── columns: d_date_sk:288!null d_year:294!null d_moy:296!null
      │         │    │    │    │    │    │    ├── key: (288)
      │         │    │    │    │    │    │    ├── fd: ()-->(294,296)
      │         │    │    │    │    │    │    ├── scan date_dim
      │         │    │    │    │    │    │    │    ├── columns: d_date_sk:288!null d_year:294 d_moy:296
      │         │    │    │    │    │    │    │    ├── key: (288)
      │         │    │    │    │    │    │    │    └── fd: (288)-->(294,296)
      │         │    │    │    │    │    │    └── filters
      │         │    │    │    │    │    │         ├── d_year:294 = 2001 [outer=(294), constraints=(/294: [/2001 - /2001]; tight), fd=()-->(294)]
      │         │    │    │    │    │    │         └── d_moy:296 = 3 [outer=(296), constraints=(/296: [/3 - /3]; tight), fd=()-->(296)]
      │         │    │    │    │    │    └── filters
      │         │    │    │    │    │         └── ws_sold_date_sk:252 = d_date_sk:288 [outer=(252,288), constraints=(/252: (/NULL - ]; /288: (/NULL - ]), fd=(252)==(288), (288)==(252)]
      │         │    │    │    │    ├── select
      │         │    │    │    │    │    ├── columns: ca_address_sk:318!null ca_gmt_offset:329!null
      │         │    │    │    │    │    ├── immutable
      │         │    │    │    │    │    ├── key: (318)
      │         │    │    │    │    │    ├── fd: ()-->(329)
      │         │    │    │    │    │    ├── scan customer_address
      │         │    │    │    │    │    │    ├── columns: ca_address_sk:318!null ca_gmt_offset:329
      │         │    │    │    │    │    │    ├── key: (318)
      │         │    │    │    │    │    │    └── fd: (318)-->(329)
      │         │    │    │    │    │    └── filters
      │         │    │    │    │    │         └── ca_gmt_offset:329 = -5 [outer=(329), immutable, constraints=(/329: [/-5 - /-5]; tight), fd=()-->(329)]
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── ws_bill_addr_sk:259 = ca_address_sk:318 [outer=(259,318), constraints=(/259: (/NULL - ]; /318: (/NULL - ]), fd=(259)==(318), (318)==(259)]
      │         │    │    │    ├── scan item
      │         │    │    │    │    ├── columns: i_item_sk:333!null item.i_manufact_id:346
      │         │    │    │    │    ├── key: (333)
      │         │    │    │    │    └── fd: (333)-->(346)
      │         │    │    │    └── filters
      │         │    │    │         └── ws_item_sk:255 = i_item_sk:333 [outer=(255,333), constraints=(/255: (/NULL - ]; /333: (/NULL - ]), fd=(255)==(333), (333)==(255)]
      │         │    │    ├── distinct-on
      │         │    │    │    ├── columns: item.i_manufact_id:370
      │         │    │    │    ├── grouping columns: item.i_manufact_id:370
      │         │    │    │    ├── key: (370)
      │         │    │    │    └── select
      │         │    │    │         ├── columns: i_category:369!null item.i_manufact_id:370
      │         │    │    │         ├── fd: ()-->(369)
      │         │    │    │         ├── scan item
      │         │    │    │         │    └── columns: i_category:369 item.i_manufact_id:370
      │         │    │    │         └── filters
      │         │    │    │              └── i_category:369 = 'Books' [outer=(369), constraints=(/369: [/'Books' - /'Books']; tight), fd=()-->(369)]
      │         │    │    └── filters
      │         │    │         └── item.i_manufact_id:346 = item.i_manufact_id:370 [outer=(346,370), constraints=(/346: (/NULL - ]; /370: (/NULL - ]), fd=(346)==(370), (370)==(346)]
      │         │    └── aggregations
      │         │         └── sum [as=sum:382, outer=(275)]
      │         │              └── ws_ext_sales_price:275
      │         └── projections
      │              ├── item.i_manufact_id:346 [as=i_manufact_id:389, outer=(346)]
      │              └── sum:382 [as=total_sales:390, outer=(382)]
      └── aggregations
           └── sum [as=sum:393, outer=(392)]
                └── total_sales:392

# --------------------------------------------------
# Q34
opt
	SELECT
		c_last_name,
		c_first_name,
		c_salutation,
		c_preferred_cust_flag,
		ss_ticket_number,
		cnt
	FROM
		(
			SELECT
				ss_ticket_number,
				ss_customer_sk,
				count(*) AS cnt
			FROM
				store_sales,
				date_dim,
				store,
				household_demographics
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_store_sk = store.s_store_sk
				AND store_sales.ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND (
						date_dim.d_dom BETWEEN 1 AND 3
						OR date_dim.d_dom BETWEEN 25 AND 28
					)
				AND (
						household_demographics.hd_buy_potential
						= '1001-5000'
						OR household_demographics.hd_buy_potential
							= '0-500'
					)
				AND household_demographics.hd_vehicle_count > 0
				AND (
						CASE
						WHEN household_demographics.hd_vehicle_count
						> 0
						THEN household_demographics.hd_dep_count
						/ household_demographics.hd_vehicle_count
						ELSE NULL
						END
					)
					> 1.2
				AND date_dim.d_year
					IN (2000, 2000 + 1, 2000 + 2)
				AND store.s_county
					IN (
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County'
						)
			GROUP BY
				ss_ticket_number, ss_customer_sk
		)
			AS dn,
		customer
	WHERE
		ss_customer_sk = c_customer_sk AND cnt BETWEEN 15 AND 20
	ORDER BY
		c_last_name,
		c_first_name,
		c_salutation,
		c_preferred_cust_flag DESC,
		ss_ticket_number;
----
sort
 ├── columns: c_last_name:104 c_first_name:103 c_salutation:102 c_preferred_cust_flag:105 ss_ticket_number:10!null cnt:94!null
 ├── immutable
 ├── ordering: +104,+103,+102,-105,+10
 └── project
      ├── columns: ss_ticket_number:10!null count_rows:94!null c_salutation:102 c_first_name:103 c_last_name:104 c_preferred_cust_flag:105
      ├── immutable
      └── inner-join (lookup customer)
           ├── columns: ss_customer_sk:4!null ss_ticket_number:10!null count_rows:94!null c_customer_sk:95!null c_salutation:102 c_first_name:103 c_last_name:104 c_preferred_cust_flag:105
           ├── key columns: [4] = [95]
           ├── lookup columns are key
           ├── immutable
           ├── key: (10,95)
           ├── fd: (4,10)-->(94), (95)-->(102-105), (4)==(95), (95)==(4)
           ├── select
           │    ├── columns: ss_customer_sk:4 ss_ticket_number:10!null count_rows:94!null
           │    ├── immutable
           │    ├── key: (4,10)
           │    ├── fd: (4,10)-->(94)
           │    ├── group-by (hash)
           │    │    ├── columns: ss_customer_sk:4 ss_ticket_number:10!null count_rows:94!null
           │    │    ├── grouping columns: ss_customer_sk:4 ss_ticket_number:10!null
           │    │    ├── immutable
           │    │    ├── key: (4,10)
           │    │    ├── fd: (4,10)-->(94)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_store_sk:8!null ss_ticket_number:10!null d_date_sk:26!null d_year:32!null d_dom:35!null s_store_sk:56!null s_county:79!null hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── immutable
           │    │    │    ├── fd: ()-->(79), (26)-->(32,35), (87)-->(89-91), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6)
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_store_sk:8 ss_ticket_number:10!null d_date_sk:26!null d_year:32!null d_dom:35!null hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    ├── immutable
           │    │    │    │    ├── fd: (26)-->(32,35), (87)-->(89-91), (6)==(87), (87)==(6), (1)==(26), (26)==(1)
           │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6!null ss_store_sk:8 ss_ticket_number:10!null hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── fd: (87)-->(89-91), (6)==(87), (87)==(6)
           │    │    │    │    │    ├── scan store_sales
           │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6 ss_store_sk:8 ss_ticket_number:10!null
           │    │    │    │    │    ├── select
           │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    │    │    │    ├── immutable
           │    │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    │    ├── fd: (87)-->(89-91)
           │    │    │    │    │    │    ├── scan household_demographics
           │    │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_buy_potential:89 hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    │    │    └── fd: (87)-->(89-91)
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         ├── (hd_buy_potential:89 = '1001-5000') OR (hd_buy_potential:89 = '0-500') [outer=(89), constraints=(/89: [/'0-500' - /'0-500'] [/'1001-5000' - /'1001-5000']; tight)]
           │    │    │    │    │    │         ├── hd_vehicle_count:91 > 0 [outer=(91), constraints=(/91: [/1 - ]; tight)]
           │    │    │    │    │    │         └── CASE WHEN hd_vehicle_count:91 > 0 THEN hd_dep_count:90 / hd_vehicle_count:91 ELSE CAST(NULL AS DECIMAL) END > 1.2 [outer=(90,91), immutable]
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:87 [outer=(6,87), constraints=(/6: (/NULL - ]; /87: (/NULL - ]), fd=(6)==(87), (87)==(6)]
           │    │    │    │    ├── select
           │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_dom:35!null
           │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    ├── fd: (26)-->(32,35)
           │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_dom:35
           │    │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    │    └── fd: (26)-->(32,35)
           │    │    │    │    │    └── filters
           │    │    │    │    │         ├── ((d_dom:35 >= 1) AND (d_dom:35 <= 3)) OR ((d_dom:35 >= 25) AND (d_dom:35 <= 28)) [outer=(35), constraints=(/35: [/1 - /3] [/25 - /28]; tight)]
           │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002]; tight)]
           │    │    │    │    └── filters
           │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
           │    │    │    ├── select
           │    │    │    │    ├── columns: s_store_sk:56!null s_county:79!null
           │    │    │    │    ├── key: (56)
           │    │    │    │    ├── fd: ()-->(79)
           │    │    │    │    ├── scan store
           │    │    │    │    │    ├── columns: s_store_sk:56!null s_county:79
           │    │    │    │    │    ├── key: (56)
           │    │    │    │    │    └── fd: (56)-->(79)
           │    │    │    │    └── filters
           │    │    │    │         └── s_county:79 = 'Williamson County' [outer=(79), constraints=(/79: [/'Williamson County' - /'Williamson County']; tight), fd=()-->(79)]
           │    │    │    └── filters
           │    │    │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
           │    │    └── aggregations
           │    │         └── count-rows [as=count_rows:94]
           │    └── filters
           │         └── (count_rows:94 >= 15) AND (count_rows:94 <= 20) [outer=(94), constraints=(/94: [/15 - /20]; tight)]
           └── filters (true)

# --------------------------------------------------
# Q35
opt
	SELECT
		ca_state,
		cd_gender,
		cd_marital_status,
		cd_dep_count,
		count(*) AS cnt1,
		avg(cd_dep_count),
		stddev_samp(cd_dep_count),
		sum(cd_dep_count),
		cd_dep_employed_count,
		count(*) AS cnt2,
		avg(cd_dep_employed_count),
		stddev_samp(cd_dep_employed_count),
		sum(cd_dep_employed_count),
		cd_dep_college_count,
		count(*) AS cnt3,
		avg(cd_dep_college_count),
		stddev_samp(cd_dep_college_count),
		sum(cd_dep_college_count)
	FROM
		customer AS c,
		customer_address AS ca,
		customer_demographics
	WHERE
		c.c_current_addr_sk = ca.ca_address_sk
		AND cd_demo_sk = c.c_current_cdemo_sk
		AND EXISTS(
				SELECT
					*
				FROM
					store_sales, date_dim
				WHERE
					c.c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 1999
					AND d_qoy < 4
			)
		AND (
				EXISTS(
					SELECT
						*
					FROM
						web_sales, date_dim
					WHERE
						c.c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
						AND d_year = 1999
						AND d_qoy < 4
				)
				OR EXISTS(
						SELECT
							*
						FROM
							catalog_sales, date_dim
						WHERE
							c.c_customer_sk
							= cs_ship_customer_sk
							AND cs_sold_date_sk = d_date_sk
							AND d_year = 1999
							AND d_qoy < 4
					)
			)
	GROUP BY
		ca_state,
		cd_gender,
		cd_marital_status,
		cd_dep_count,
		cd_dep_employed_count,
		cd_dep_college_count
	ORDER BY
		ca_state,
		cd_gender,
		cd_marital_status,
		cd_dep_count,
		cd_dep_employed_count,
		cd_dep_college_count
	LIMIT
		100;
----
top-k
 ├── columns: ca_state:29 cd_gender:37 cd_marital_status:38 cd_dep_count:42 cnt1:241!null avg:242 stddev_samp:243 sum:244 cd_dep_employed_count:43 cnt2:241!null avg:245 stddev_samp:246 sum:247 cd_dep_college_count:44 cnt3:241!null avg:248 stddev_samp:249 sum:250
 ├── internal-ordering: +29,+37,+38,+42,+43,+44
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (29,37,38,42-44)
 ├── fd: (29,37,38,42-44)-->(241-250)
 ├── ordering: +29,+37,+38,+42,+43,+44
 └── group-by (hash)
      ├── columns: ca_state:29 cd_gender:37 cd_marital_status:38 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44 count_rows:241!null avg:242 stddev_samp:243 sum:244 avg:245 stddev_samp:246 sum:247 avg:248 stddev_samp:249 sum:250
      ├── grouping columns: ca_state:29 cd_gender:37 cd_marital_status:38 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44
      ├── key: (29,37,38,42-44)
      ├── fd: (29,37,38,42-44)-->(241-250)
      ├── inner-join (lookup customer_demographics)
      │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3!null c_current_addr_sk:5!null ca_address_sk:21!null ca_state:29 cd_demo_sk:36!null cd_gender:37 cd_marital_status:38 cd_dep_count:42 cd_dep_employed_count:43 cd_dep_college_count:44
      │    ├── key columns: [3] = [36]
      │    ├── lookup columns are key
      │    ├── key: (1)
      │    ├── fd: (1)-->(3,5), (21)-->(29), (36)-->(37,38,42-44), (5)==(21), (21)==(5), (3)==(36), (36)==(3)
      │    ├── semi-join (hash)
      │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5!null ca_address_sk:21!null ca_state:29
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(3,5), (21)-->(29), (5)==(21), (21)==(5)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5!null ca_address_sk:21!null ca_state:29
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(3,5), (21)-->(29), (5)==(21), (21)==(5)
      │    │    │    ├── project
      │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │    ├── key: (1)
      │    │    │    │    ├── fd: (1)-->(3,5)
      │    │    │    │    └── select
      │    │    │    │         ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 exists:238!null canary_agg:239
      │    │    │    │         ├── key: (1)
      │    │    │    │         ├── fd: (1)-->(3,5,238,239)
      │    │    │    │         ├── group-by (hash)
      │    │    │    │         │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 exists:238!null canary_agg:239
      │    │    │    │         │    ├── grouping columns: c_customer_sk:1!null
      │    │    │    │         │    ├── key: (1)
      │    │    │    │         │    ├── fd: (1)-->(3,5,238,239)
      │    │    │    │         │    ├── right-join (hash)
      │    │    │    │         │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 cs_sold_date_sk:168 cs_ship_customer_sk:175 d_date_sk:204 d_year:210 d_qoy:214 exists:238!null
      │    │    │    │         │    │    ├── fd: (1)-->(3,5,238), (204)-->(214), (168)==(204), (204)==(168)
      │    │    │    │         │    │    ├── inner-join (hash)
      │    │    │    │         │    │    │    ├── columns: cs_sold_date_sk:168!null cs_ship_customer_sk:175 d_date_sk:204!null d_year:210!null d_qoy:214!null
      │    │    │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │         │    │    │    ├── fd: ()-->(210), (204)-->(214), (168)==(204), (204)==(168)
      │    │    │    │         │    │    │    ├── scan catalog_sales
      │    │    │    │         │    │    │    │    └── columns: cs_sold_date_sk:168 cs_ship_customer_sk:175
      │    │    │    │         │    │    │    ├── select
      │    │    │    │         │    │    │    │    ├── columns: d_date_sk:204!null d_year:210!null d_qoy:214!null
      │    │    │    │         │    │    │    │    ├── key: (204)
      │    │    │    │         │    │    │    │    ├── fd: ()-->(210), (204)-->(214)
      │    │    │    │         │    │    │    │    ├── scan date_dim
      │    │    │    │         │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210 d_qoy:214
      │    │    │    │         │    │    │    │    │    ├── key: (204)
      │    │    │    │         │    │    │    │    │    └── fd: (204)-->(210,214)
      │    │    │    │         │    │    │    │    └── filters
      │    │    │    │         │    │    │    │         ├── d_year:210 = 1999 [outer=(210), constraints=(/210: [/1999 - /1999]; tight), fd=()-->(210)]
      │    │    │    │         │    │    │    │         └── d_qoy:214 < 4 [outer=(214), constraints=(/214: (/NULL - /3]; tight)]
      │    │    │    │         │    │    │    └── filters
      │    │    │    │         │    │    │         └── cs_sold_date_sk:168 = d_date_sk:204 [outer=(168,204), constraints=(/168: (/NULL - ]; /204: (/NULL - ]), fd=(168)==(204), (204)==(168)]
      │    │    │    │         │    │    ├── project
      │    │    │    │         │    │    │    ├── columns: exists:238!null c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │         │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    ├── fd: (1)-->(3,5,238)
      │    │    │    │         │    │    │    ├── group-by (hash)
      │    │    │    │         │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 canary_agg:237
      │    │    │    │         │    │    │    │    ├── grouping columns: c_customer_sk:1!null
      │    │    │    │         │    │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    │    ├── fd: (1)-->(3,5,237)
      │    │    │    │         │    │    │    │    ├── right-join (hash)
      │    │    │    │         │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5 ws_sold_date_sk:102 ws_bill_customer_sk:106 d_date_sk:138 d_year:144 d_qoy:148
      │    │    │    │         │    │    │    │    │    ├── fd: (1)-->(3,5), (138)-->(148), (102)==(138), (138)==(102)
      │    │    │    │         │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │         │    │    │    │    │    │    ├── columns: ws_sold_date_sk:102!null ws_bill_customer_sk:106 d_date_sk:138!null d_year:144!null d_qoy:148!null
      │    │    │    │         │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │         │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(148), (102)==(138), (138)==(102)
      │    │    │    │         │    │    │    │    │    │    ├── scan web_sales
      │    │    │    │         │    │    │    │    │    │    │    └── columns: ws_sold_date_sk:102 ws_bill_customer_sk:106
      │    │    │    │         │    │    │    │    │    │    ├── select
      │    │    │    │         │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144!null d_qoy:148!null
      │    │    │    │         │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │         │    │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(148)
      │    │    │    │         │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │         │    │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144 d_qoy:148
      │    │    │    │         │    │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │         │    │    │    │    │    │    │    │    └── fd: (138)-->(144,148)
      │    │    │    │         │    │    │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │    │    │         ├── d_year:144 = 1999 [outer=(144), constraints=(/144: [/1999 - /1999]; tight), fd=()-->(144)]
      │    │    │    │         │    │    │    │    │    │    │         └── d_qoy:148 < 4 [outer=(148), constraints=(/148: (/NULL - /3]; tight)]
      │    │    │    │         │    │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │    │         └── ws_sold_date_sk:102 = d_date_sk:138 [outer=(102,138), constraints=(/102: (/NULL - ]; /138: (/NULL - ]), fd=(102)==(138), (138)==(102)]
      │    │    │    │         │    │    │    │    │    ├── scan customer [as=c]
      │    │    │    │         │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │         │    │    │    │    │    │    ├── key: (1)
      │    │    │    │         │    │    │    │    │    │    └── fd: (1)-->(3,5)
      │    │    │    │         │    │    │    │    │    └── filters
      │    │    │    │         │    │    │    │    │         └── c_customer_sk:1 = ws_bill_customer_sk:106 [outer=(1,106), constraints=(/1: (/NULL - ]; /106: (/NULL - ]), fd=(1)==(106), (106)==(1)]
      │    │    │    │         │    │    │    │    └── aggregations
      │    │    │    │         │    │    │    │         ├── const-not-null-agg [as=canary_agg:237, outer=(102)]
      │    │    │    │         │    │    │    │         │    └── ws_sold_date_sk:102
      │    │    │    │         │    │    │    │         ├── const-agg [as=c_current_cdemo_sk:3, outer=(3)]
      │    │    │    │         │    │    │    │         │    └── c_current_cdemo_sk:3
      │    │    │    │         │    │    │    │         └── const-agg [as=c_current_addr_sk:5, outer=(5)]
      │    │    │    │         │    │    │    │              └── c_current_addr_sk:5
      │    │    │    │         │    │    │    └── projections
      │    │    │    │         │    │    │         └── canary_agg:237 IS NOT NULL [as=exists:238, outer=(237)]
      │    │    │    │         │    │    └── filters
      │    │    │    │         │    │         └── c_customer_sk:1 = cs_ship_customer_sk:175 [outer=(1,175), constraints=(/1: (/NULL - ]; /175: (/NULL - ]), fd=(1)==(175), (175)==(1)]
      │    │    │    │         │    └── aggregations
      │    │    │    │         │         ├── const-not-null-agg [as=canary_agg:239, outer=(168)]
      │    │    │    │         │         │    └── cs_sold_date_sk:168
      │    │    │    │         │         ├── const-agg [as=c_current_cdemo_sk:3, outer=(3)]
      │    │    │    │         │         │    └── c_current_cdemo_sk:3
      │    │    │    │         │         ├── const-agg [as=c_current_addr_sk:5, outer=(5)]
      │    │    │    │         │         │    └── c_current_addr_sk:5
      │    │    │    │         │         └── const-agg [as=exists:238, outer=(238)]
      │    │    │    │         │              └── exists:238
      │    │    │    │         └── filters
      │    │    │    │              └── exists:238 OR (canary_agg:239 IS NOT NULL) [outer=(238,239)]
      │    │    │    ├── scan customer_address [as=ca]
      │    │    │    │    ├── columns: ca_address_sk:21!null ca_state:29
      │    │    │    │    ├── key: (21)
      │    │    │    │    └── fd: (21)-->(29)
      │    │    │    └── filters
      │    │    │         └── c_current_addr_sk:5 = ca_address_sk:21 [outer=(5,21), constraints=(/5: (/NULL - ]; /21: (/NULL - ]), fd=(5)==(21), (21)==(5)]
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:47!null ss_customer_sk:50 d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(78), (72)-->(82), (47)==(72), (72)==(47)
      │    │    │    ├── scan store_sales
      │    │    │    │    └── columns: ss_sold_date_sk:47 ss_customer_sk:50
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_qoy:82!null
      │    │    │    │    ├── key: (72)
      │    │    │    │    ├── fd: ()-->(78), (72)-->(82)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_qoy:82
      │    │    │    │    │    ├── key: (72)
      │    │    │    │    │    └── fd: (72)-->(78,82)
      │    │    │    │    └── filters
      │    │    │    │         ├── d_year:78 = 1999 [outer=(78), constraints=(/78: [/1999 - /1999]; tight), fd=()-->(78)]
      │    │    │    │         └── d_qoy:82 < 4 [outer=(82), constraints=(/82: (/NULL - /3]; tight)]
      │    │    │    └── filters
      │    │    │         └── ss_sold_date_sk:47 = d_date_sk:72 [outer=(47,72), constraints=(/47: (/NULL - ]; /72: (/NULL - ]), fd=(47)==(72), (72)==(47)]
      │    │    └── filters
      │    │         └── c_customer_sk:1 = ss_customer_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
      │    └── filters (true)
      └── aggregations
           ├── count-rows [as=count_rows:241]
           ├── avg [as=avg:242, outer=(42)]
           │    └── cd_dep_count:42
           ├── std-dev [as=stddev_samp:243, outer=(42)]
           │    └── cd_dep_count:42
           ├── sum [as=sum:244, outer=(42)]
           │    └── cd_dep_count:42
           ├── avg [as=avg:245, outer=(43)]
           │    └── cd_dep_employed_count:43
           ├── std-dev [as=stddev_samp:246, outer=(43)]
           │    └── cd_dep_employed_count:43
           ├── sum [as=sum:247, outer=(43)]
           │    └── cd_dep_employed_count:43
           ├── avg [as=avg:248, outer=(44)]
           │    └── cd_dep_college_count:44
           ├── std-dev [as=stddev_samp:249, outer=(44)]
           │    └── cd_dep_college_count:44
           └── sum [as=sum:250, outer=(44)]
                └── cd_dep_college_count:44

# --------------------------------------------------
# Q36
# TODO: adjust the query to work with CRDB.
# opt
# select  
#     sum(ss_net_profit)/sum(ss_ext_sales_price) as gross_margin
#    ,i_category
#    ,i_class
#    ,grouping(i_category)+grouping(i_class) as lochierarchy
#    ,rank() over (
#  	partition by grouping(i_category)+grouping(i_class),
#  	case when grouping(i_class) = 0 then i_category end 
#  	order by sum(ss_net_profit)/sum(ss_ext_sales_price) asc) as rank_within_parent
#  from
#     store_sales
#    ,date_dim       d1
#    ,item
#    ,store
#  where
#     d1.d_year = 2000 
#  and d1.d_date_sk = ss_sold_date_sk
#  and i_item_sk  = ss_item_sk 
#  and s_store_sk  = ss_store_sk
#  and s_state in ('TN','TN','TN','TN',
#                  'TN','TN','TN','TN')
#  group by rollup(i_category,i_class)
#  order by
#    lochierarchy desc
#   ,case when lochierarchy = 0 then i_category end
#   ,rank_within_parent
#   limit 100;
# ----

# --------------------------------------------------
# Q37
# NOTE: Added conversion of 90 days to an interval.
opt
	SELECT
		i_item_id, i_item_desc, i_current_price
	FROM
		item, inventory, date_dim, catalog_sales
	WHERE
		i_current_price BETWEEN 29 AND (29 + 30)
		AND inv_item_sk = i_item_sk
		AND d_date_sk = inv_date_sk
		AND d_date BETWEEN CAST('2002-03-29' AS DATE) AND (CAST('2002-03-29' AS DATE) + '60 days'::INTERVAL)
		AND i_manufact_id IN (705, 742, 777, 944)
		AND inv_quantity_on_hand BETWEEN 100 AND 500
		AND cs_item_sk = i_item_sk
	GROUP BY
		i_item_id, i_item_desc, i_current_price
	ORDER BY
		i_item_id
	LIMIT
		100;
----
limit
 ├── columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 ├── internal-ordering: +2
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (2,5,6)
 ├── ordering: +2
 ├── distinct-on
 │    ├── columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 │    ├── grouping columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 │    ├── immutable
 │    ├── key: (2,5,6)
 │    ├── ordering: +2
 │    ├── limit hint: 100.00
 │    └── inner-join (lookup catalog_sales)
 │         ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null cs_item_sk:76!null
 │         ├── key columns: [26] = [76]
 │         ├── immutable
 │         ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26,76), (26)==(1,76), (76)==(1,26)
 │         ├── ordering: +2
 │         ├── limit hint: 385.21
 │         ├── sort
 │         │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │    ├── immutable
 │         │    ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26), (26)==(1)
 │         │    ├── ordering: +2
 │         │    ├── limit hint: 100.00
 │         │    └── inner-join (hash)
 │         │         ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │         ├── immutable
 │         │         ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26), (26)==(1)
 │         │         ├── inner-join (lookup inventory)
 │         │         │    ├── columns: inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │         │    ├── key columns: [31] = [25]
 │         │         │    ├── fd: (31)-->(33), (25)==(31), (31)==(25)
 │         │         │    ├── select
 │         │         │    │    ├── columns: d_date_sk:31!null d_date:33!null
 │         │         │    │    ├── key: (31)
 │         │         │    │    ├── fd: (31)-->(33)
 │         │         │    │    ├── scan date_dim
 │         │         │    │    │    ├── columns: d_date_sk:31!null d_date:33
 │         │         │    │    │    ├── key: (31)
 │         │         │    │    │    └── fd: (31)-->(33)
 │         │         │    │    └── filters
 │         │         │    │         └── (d_date:33 >= '2002-03-29') AND (d_date:33 <= '2002-05-28') [outer=(33), constraints=(/33: [/'2002-03-29' - /'2002-05-28']; tight)]
 │         │         │    └── filters
 │         │         │         └── (inv_quantity_on_hand:28 >= 100) AND (inv_quantity_on_hand:28 <= 500) [outer=(28), constraints=(/28: [/100 - /500]; tight)]
 │         │         ├── select
 │         │         │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null
 │         │         │    ├── immutable
 │         │         │    ├── key: (1)
 │         │         │    ├── fd: (1)-->(2,5,6,14)
 │         │         │    ├── scan item
 │         │         │    │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6 i_manufact_id:14
 │         │         │    │    ├── key: (1)
 │         │         │    │    └── fd: (1)-->(2,5,6,14)
 │         │         │    └── filters
 │         │         │         ├── (i_current_price:6 >= 29) AND (i_current_price:6 <= 59.00) [outer=(6), immutable, constraints=(/6: [/29 - /59.00]; tight)]
 │         │         │         └── i_manufact_id:14 IN (705, 742, 777, 944) [outer=(14), constraints=(/14: [/705 - /705] [/742 - /742] [/777 - /777] [/944 - /944]; tight)]
 │         │         └── filters
 │         │              └── i_item_sk:1 = inv_item_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │         └── filters (true)
 └── 100

# --------------------------------------------------
# Q38
opt
	SELECT
		count(*)
	FROM
		(
			SELECT
				DISTINCT c_last_name, c_first_name, d_date
			FROM
				store_sales, date_dim, customer
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_customer_sk
					= customer.c_customer_sk
				AND d_month_seq BETWEEN 1189 AND (1189 + 11)
			INTERSECT
				SELECT
					DISTINCT c_last_name, c_first_name, d_date
				FROM
					catalog_sales, date_dim, customer
				WHERE
					catalog_sales.cs_sold_date_sk
					= date_dim.d_date_sk
					AND catalog_sales.cs_bill_customer_sk
						= customer.c_customer_sk
					AND d_month_seq BETWEEN 1189 AND (1189 + 11)
			INTERSECT
				SELECT
					DISTINCT c_last_name, c_first_name, d_date
				FROM
					web_sales, date_dim, customer
				WHERE
					web_sales.ws_sold_date_sk
					= date_dim.d_date_sk
					AND web_sales.ws_bill_customer_sk
						= customer.c_customer_sk
					AND d_month_seq BETWEEN 1189 AND (1189 + 11)
		)
			AS hot_cust
	LIMIT
		100;
----
scalar-group-by
 ├── columns: count:248!null
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(248)
 ├── intersect-all
 │    ├── columns: c_last_name:65 c_first_name:64 d_date:28
 │    ├── left columns: c_last_name:65 c_first_name:64 d_date:28
 │    ├── right columns: c_last_name:237 c_first_name:236 d_date:200
 │    ├── key: (28,64,65)
 │    ├── intersect-all
 │    │    ├── columns: c_last_name:65 c_first_name:64 d_date:28
 │    │    ├── left columns: c_last_name:65 c_first_name:64 d_date:28
 │    │    ├── right columns: c_last_name:151 c_first_name:150 d_date:114
 │    │    ├── key: (28,64,65)
 │    │    ├── distinct-on
 │    │    │    ├── columns: d_date:28 c_first_name:64 c_last_name:65
 │    │    │    ├── grouping columns: d_date:28 c_first_name:64 c_last_name:65
 │    │    │    ├── key: (28,64,65)
 │    │    │    └── inner-join (hash)
 │    │    │         ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4!null d_date_sk:26!null d_date:28 d_month_seq:29!null c_customer_sk:56!null c_first_name:64 c_last_name:65
 │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         ├── fd: (26)-->(28,29), (56)-->(64,65), (1)==(26), (26)==(1), (4)==(56), (56)==(4)
 │    │    │         ├── inner-join (hash)
 │    │    │         │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 d_date_sk:26!null d_date:28 d_month_seq:29!null
 │    │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │    ├── fd: (26)-->(28,29), (1)==(26), (26)==(1)
 │    │    │         │    ├── scan store_sales
 │    │    │         │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4
 │    │    │         │    ├── select
 │    │    │         │    │    ├── columns: d_date_sk:26!null d_date:28 d_month_seq:29!null
 │    │    │         │    │    ├── key: (26)
 │    │    │         │    │    ├── fd: (26)-->(28,29)
 │    │    │         │    │    ├── scan date_dim
 │    │    │         │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_month_seq:29
 │    │    │         │    │    │    ├── key: (26)
 │    │    │         │    │    │    └── fd: (26)-->(28,29)
 │    │    │         │    │    └── filters
 │    │    │         │    │         └── (d_month_seq:29 >= 1189) AND (d_month_seq:29 <= 1200) [outer=(29), constraints=(/29: [/1189 - /1200]; tight)]
 │    │    │         │    └── filters
 │    │    │         │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    │         ├── scan customer
 │    │    │         │    ├── columns: c_customer_sk:56!null c_first_name:64 c_last_name:65
 │    │    │         │    ├── key: (56)
 │    │    │         │    └── fd: (56)-->(64,65)
 │    │    │         └── filters
 │    │    │              └── ss_customer_sk:4 = c_customer_sk:56 [outer=(4,56), constraints=(/4: (/NULL - ]; /56: (/NULL - ]), fd=(4)==(56), (56)==(4)]
 │    │    └── distinct-on
 │    │         ├── columns: d_date:114 c_first_name:150 c_last_name:151
 │    │         ├── grouping columns: d_date:114 c_first_name:150 c_last_name:151
 │    │         ├── key: (114,150,151)
 │    │         └── inner-join (hash)
 │    │              ├── columns: cs_sold_date_sk:76!null cs_bill_customer_sk:79!null d_date_sk:112!null d_date:114 d_month_seq:115!null c_customer_sk:142!null c_first_name:150 c_last_name:151
 │    │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │              ├── fd: (112)-->(114,115), (142)-->(150,151), (76)==(112), (112)==(76), (79)==(142), (142)==(79)
 │    │              ├── inner-join (hash)
 │    │              │    ├── columns: cs_sold_date_sk:76!null cs_bill_customer_sk:79 d_date_sk:112!null d_date:114 d_month_seq:115!null
 │    │              │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │              │    ├── fd: (112)-->(114,115), (76)==(112), (112)==(76)
 │    │              │    ├── scan catalog_sales
 │    │              │    │    └── columns: cs_sold_date_sk:76 cs_bill_customer_sk:79
 │    │              │    ├── select
 │    │              │    │    ├── columns: d_date_sk:112!null d_date:114 d_month_seq:115!null
 │    │              │    │    ├── key: (112)
 │    │              │    │    ├── fd: (112)-->(114,115)
 │    │              │    │    ├── scan date_dim
 │    │              │    │    │    ├── columns: d_date_sk:112!null d_date:114 d_month_seq:115
 │    │              │    │    │    ├── key: (112)
 │    │              │    │    │    └── fd: (112)-->(114,115)
 │    │              │    │    └── filters
 │    │              │    │         └── (d_month_seq:115 >= 1189) AND (d_month_seq:115 <= 1200) [outer=(115), constraints=(/115: [/1189 - /1200]; tight)]
 │    │              │    └── filters
 │    │              │         └── cs_sold_date_sk:76 = d_date_sk:112 [outer=(76,112), constraints=(/76: (/NULL - ]; /112: (/NULL - ]), fd=(76)==(112), (112)==(76)]
 │    │              ├── scan customer
 │    │              │    ├── columns: c_customer_sk:142!null c_first_name:150 c_last_name:151
 │    │              │    ├── key: (142)
 │    │              │    └── fd: (142)-->(150,151)
 │    │              └── filters
 │    │                   └── cs_bill_customer_sk:79 = c_customer_sk:142 [outer=(79,142), constraints=(/79: (/NULL - ]; /142: (/NULL - ]), fd=(79)==(142), (142)==(79)]
 │    └── distinct-on
 │         ├── columns: d_date:200 c_first_name:236 c_last_name:237
 │         ├── grouping columns: d_date:200 c_first_name:236 c_last_name:237
 │         ├── key: (200,236,237)
 │         └── inner-join (hash)
 │              ├── columns: ws_sold_date_sk:162!null ws_bill_customer_sk:166!null d_date_sk:198!null d_date:200 d_month_seq:201!null c_customer_sk:228!null c_first_name:236 c_last_name:237
 │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │              ├── fd: (198)-->(200,201), (228)-->(236,237), (162)==(198), (198)==(162), (166)==(228), (228)==(166)
 │              ├── inner-join (hash)
 │              │    ├── columns: ws_sold_date_sk:162!null ws_bill_customer_sk:166 d_date_sk:198!null d_date:200 d_month_seq:201!null
 │              │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │              │    ├── fd: (198)-->(200,201), (162)==(198), (198)==(162)
 │              │    ├── scan web_sales
 │              │    │    └── columns: ws_sold_date_sk:162 ws_bill_customer_sk:166
 │              │    ├── select
 │              │    │    ├── columns: d_date_sk:198!null d_date:200 d_month_seq:201!null
 │              │    │    ├── key: (198)
 │              │    │    ├── fd: (198)-->(200,201)
 │              │    │    ├── scan date_dim
 │              │    │    │    ├── columns: d_date_sk:198!null d_date:200 d_month_seq:201
 │              │    │    │    ├── key: (198)
 │              │    │    │    └── fd: (198)-->(200,201)
 │              │    │    └── filters
 │              │    │         └── (d_month_seq:201 >= 1189) AND (d_month_seq:201 <= 1200) [outer=(201), constraints=(/201: [/1189 - /1200]; tight)]
 │              │    └── filters
 │              │         └── ws_sold_date_sk:162 = d_date_sk:198 [outer=(162,198), constraints=(/162: (/NULL - ]; /198: (/NULL - ]), fd=(162)==(198), (198)==(162)]
 │              ├── scan customer
 │              │    ├── columns: c_customer_sk:228!null c_first_name:236 c_last_name:237
 │              │    ├── key: (228)
 │              │    └── fd: (228)-->(236,237)
 │              └── filters
 │                   └── ws_bill_customer_sk:166 = c_customer_sk:228 [outer=(166,228), constraints=(/166: (/NULL - ]; /228: (/NULL - ]), fd=(166)==(228), (228)==(166)]
 └── aggregations
      └── count-rows [as=count_rows:248]

# --------------------------------------------------
# Q39
# NOTE: Q39 has two queries.
opt
	WITH
		inv
			AS (
				SELECT
					w_warehouse_name,
					w_warehouse_sk,
					i_item_sk,
					d_moy,
					stdev,
					mean,
					CASE mean
					WHEN 0 THEN NULL
					ELSE stdev / mean
					END
						AS cov
				FROM
					(
						SELECT
							w_warehouse_name,
							w_warehouse_sk,
							i_item_sk,
							d_moy,
							stddev_samp(inv_quantity_on_hand)
								AS stdev,
							avg(inv_quantity_on_hand) AS mean
						FROM
							inventory, item, warehouse, date_dim
						WHERE
							inv_item_sk = i_item_sk
							AND inv_warehouse_sk
								= w_warehouse_sk
							AND inv_date_sk = d_date_sk
							AND d_year = 2000
						GROUP BY
							w_warehouse_name,
							w_warehouse_sk,
							i_item_sk,
							d_moy
					)
						AS foo
				WHERE
					CASE mean
					WHEN 0 THEN 0
					ELSE stdev / mean
					END
					> 1
			)
	SELECT
		inv1.w_warehouse_sk,
		inv1.i_item_sk,
		inv1.d_moy,
		inv1.mean,
		inv1.cov,
		inv2.w_warehouse_sk,
		inv2.i_item_sk,
		inv2.d_moy,
		inv2.mean,
		inv2.cov
	FROM
		inv AS inv1, inv AS inv2
	WHERE
		inv1.i_item_sk = inv2.i_item_sk
		AND inv1.w_warehouse_sk = inv2.w_warehouse_sk
		AND inv1.d_moy = 1
		AND inv2.d_moy = 1 + 1
	ORDER BY
		inv1.w_warehouse_sk,
		inv1.i_item_sk,
		inv1.d_moy,
		inv1.mean,
		inv1.cov,
		inv2.d_moy,
		inv2.mean,
		inv2.cov;
----
sort
 ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86 w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
 ├── immutable
 ├── key: (88,89)
 ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
 ├── ordering: +(81|88),+(82|89) opt(83,90) [actual: +81,+82]
 └── with &1 (inv)
      ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86 w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
      ├── immutable
      ├── key: (88,89)
      ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
      ├── project
      │    ├── columns: cov:79 item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    ├── immutable
      │    ├── key: (7,31,55)
      │    ├── fd: (31)-->(33), (7,31,55)-->(33,77-79)
      │    ├── select
      │    │    ├── columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    │    ├── immutable
      │    │    ├── key: (7,31,55)
      │    │    ├── fd: (31)-->(33), (7,31,55)-->(33,77,78)
      │    │    ├── group-by (hash)
      │    │    │    ├── columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    │    │    ├── grouping columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null date_dim.d_moy:55
      │    │    │    ├── key: (7,31,55)
      │    │    │    ├── fd: (31)-->(33), (7,31,55)-->(33,77,78)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── key: (7,31,47)
      │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (31)-->(33), (47)-->(55), (2)==(7), (7)==(2), (3)==(31), (31)==(3), (1)==(47), (47)==(1)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 item.i_item_sk:7!null d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (3,7,47)
      │    │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (47)-->(55), (1)==(47), (47)==(1), (2)==(7), (7)==(2)
      │    │    │    │    │    ├── inner-join (merge)
      │    │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    │    ├── left ordering: +1
      │    │    │    │    │    │    ├── right ordering: +47
      │    │    │    │    │    │    ├── key: (2,3,47)
      │    │    │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (47)-->(55), (1)==(47), (47)==(1)
      │    │    │    │    │    │    ├── scan inventory
      │    │    │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4
      │    │    │    │    │    │    │    ├── key: (1-3)
      │    │    │    │    │    │    │    ├── fd: (1-3)-->(4)
      │    │    │    │    │    │    │    └── ordering: +1
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    │    ├── fd: ()-->(53), (47)-->(55)
      │    │    │    │    │    │    │    ├── ordering: +47 opt(53) [actual: +47]
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_year:53 date_dim.d_moy:55
      │    │    │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    │    │    ├── fd: (47)-->(53,55)
      │    │    │    │    │    │    │    │    └── ordering: +47
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── d_year:53 = 2000 [outer=(53), constraints=(/53: [/2000 - /2000]; tight), fd=()-->(53)]
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: item.i_item_sk:7!null
      │    │    │    │    │    │    └── key: (7)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── inv_item_sk:2 = item.i_item_sk:7 [outer=(2,7), constraints=(/2: (/NULL - ]; /7: (/NULL - ]), fd=(2)==(7), (7)==(2)]
      │    │    │    │    ├── scan warehouse
      │    │    │    │    │    ├── columns: warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33
      │    │    │    │    │    ├── key: (31)
      │    │    │    │    │    └── fd: (31)-->(33)
      │    │    │    │    └── filters
      │    │    │    │         └── inv_warehouse_sk:3 = warehouse.w_warehouse_sk:31 [outer=(3,31), constraints=(/3: (/NULL - ]; /31: (/NULL - ]), fd=(3)==(31), (31)==(3)]
      │    │    │    └── aggregations
      │    │    │         ├── std-dev [as=stddev_samp:77, outer=(4)]
      │    │    │         │    └── inv_quantity_on_hand:4
      │    │    │         ├── avg [as=avg:78, outer=(4)]
      │    │    │         │    └── inv_quantity_on_hand:4
      │    │    │         └── const-agg [as=warehouse.w_warehouse_name:33, outer=(33)]
      │    │    │              └── warehouse.w_warehouse_name:33
      │    │    └── filters
      │    │         └── CASE avg:78 WHEN 0 THEN 0 ELSE stddev_samp:77 / avg:78 END > 1 [outer=(77,78), immutable]
      │    └── projections
      │         └── CASE avg:78 WHEN 0 THEN CAST(NULL AS DECIMAL) ELSE stddev_samp:77 / avg:78 END [as=cov:79, outer=(77,78), immutable]
      └── inner-join (hash)
           ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86 w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
           ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
           ├── key: (88,89)
           ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
           ├── select
           │    ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86
           │    ├── key: (81,82)
           │    ├── fd: ()-->(83), (81,82)-->(85,86)
           │    ├── with-scan &1 (inv)
           │    │    ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83 mean:85 cov:86
           │    │    ├── mapping:
           │    │    │    ├──  warehouse.w_warehouse_sk:31 => w_warehouse_sk:81
           │    │    │    ├──  item.i_item_sk:7 => i_item_sk:82
           │    │    │    ├──  date_dim.d_moy:55 => d_moy:83
           │    │    │    ├──  avg:78 => mean:85
           │    │    │    └──  cov:79 => cov:86
           │    │    ├── key: (81-83)
           │    │    └── fd: (81-83)-->(85,86)
           │    └── filters
           │         └── d_moy:83 = 1 [outer=(83), constraints=(/83: [/1 - /1]; tight), fd=()-->(83)]
           ├── select
           │    ├── columns: w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
           │    ├── key: (88,89)
           │    ├── fd: ()-->(90), (88,89)-->(92,93)
           │    ├── with-scan &1 (inv)
           │    │    ├── columns: w_warehouse_sk:88!null i_item_sk:89!null d_moy:90 mean:92 cov:93
           │    │    ├── mapping:
           │    │    │    ├──  warehouse.w_warehouse_sk:31 => w_warehouse_sk:88
           │    │    │    ├──  item.i_item_sk:7 => i_item_sk:89
           │    │    │    ├──  date_dim.d_moy:55 => d_moy:90
           │    │    │    ├──  avg:78 => mean:92
           │    │    │    └──  cov:79 => cov:93
           │    │    ├── key: (88-90)
           │    │    └── fd: (88-90)-->(92,93)
           │    └── filters
           │         └── d_moy:90 = 2 [outer=(90), constraints=(/90: [/2 - /2]; tight), fd=()-->(90)]
           └── filters
                ├── i_item_sk:82 = i_item_sk:89 [outer=(82,89), constraints=(/82: (/NULL - ]; /89: (/NULL - ]), fd=(82)==(89), (89)==(82)]
                └── w_warehouse_sk:81 = w_warehouse_sk:88 [outer=(81,88), constraints=(/81: (/NULL - ]; /88: (/NULL - ]), fd=(81)==(88), (88)==(81)]

opt
	WITH
		inv
			AS (
				SELECT
					w_warehouse_name,
					w_warehouse_sk,
					i_item_sk,
					d_moy,
					stdev,
					mean,
					CASE mean
					WHEN 0 THEN NULL
					ELSE stdev / mean
					END
						AS cov
				FROM
					(
						SELECT
							w_warehouse_name,
							w_warehouse_sk,
							i_item_sk,
							d_moy,
							stddev_samp(inv_quantity_on_hand)
								AS stdev,
							avg(inv_quantity_on_hand) AS mean
						FROM
							inventory, item, warehouse, date_dim
						WHERE
							inv_item_sk = i_item_sk
							AND inv_warehouse_sk
								= w_warehouse_sk
							AND inv_date_sk = d_date_sk
							AND d_year = 2000
						GROUP BY
							w_warehouse_name,
							w_warehouse_sk,
							i_item_sk,
							d_moy
					)
						AS foo
				WHERE
					CASE mean
					WHEN 0 THEN 0
					ELSE stdev / mean
					END
					> 1
			)
	SELECT
		inv1.w_warehouse_sk,
		inv1.i_item_sk,
		inv1.d_moy,
		inv1.mean,
		inv1.cov,
		inv2.w_warehouse_sk,
		inv2.i_item_sk,
		inv2.d_moy,
		inv2.mean,
		inv2.cov
	FROM
		inv AS inv1, inv AS inv2
	WHERE
		inv1.i_item_sk = inv2.i_item_sk
		AND inv1.w_warehouse_sk = inv2.w_warehouse_sk
		AND inv1.d_moy = 1
		AND inv2.d_moy = 1 + 1
		AND inv1.cov > 1.5
	ORDER BY
		inv1.w_warehouse_sk,
		inv1.i_item_sk,
		inv1.d_moy,
		inv1.mean,
		inv1.cov,
		inv2.d_moy,
		inv2.mean,
		inv2.cov;
----
sort
 ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86!null w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
 ├── immutable
 ├── key: (88,89)
 ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
 ├── ordering: +(81|88),+(82|89) opt(83,90) [actual: +81,+82]
 └── with &1 (inv)
      ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86!null w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
      ├── immutable
      ├── key: (88,89)
      ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
      ├── project
      │    ├── columns: cov:79 item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    ├── immutable
      │    ├── key: (7,31,55)
      │    ├── fd: (31)-->(33), (7,31,55)-->(33,77-79)
      │    ├── select
      │    │    ├── columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    │    ├── immutable
      │    │    ├── key: (7,31,55)
      │    │    ├── fd: (31)-->(33), (7,31,55)-->(33,77,78)
      │    │    ├── group-by (hash)
      │    │    │    ├── columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 date_dim.d_moy:55 stddev_samp:77 avg:78
      │    │    │    ├── grouping columns: item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null date_dim.d_moy:55
      │    │    │    ├── key: (7,31,55)
      │    │    │    ├── fd: (31)-->(33), (7,31,55)-->(33,77,78)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 item.i_item_sk:7!null warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33 d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── key: (7,31,47)
      │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (31)-->(33), (47)-->(55), (2)==(7), (7)==(2), (3)==(31), (31)==(3), (1)==(47), (47)==(1)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 item.i_item_sk:7!null d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (3,7,47)
      │    │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (47)-->(55), (1)==(47), (47)==(1), (2)==(7), (7)==(2)
      │    │    │    │    │    ├── inner-join (merge)
      │    │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4 d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    │    ├── left ordering: +1
      │    │    │    │    │    │    ├── right ordering: +47
      │    │    │    │    │    │    ├── key: (2,3,47)
      │    │    │    │    │    │    ├── fd: ()-->(53), (1-3)-->(4), (47)-->(55), (1)==(47), (47)==(1)
      │    │    │    │    │    │    ├── scan inventory
      │    │    │    │    │    │    │    ├── columns: inv_date_sk:1!null inv_item_sk:2!null inv_warehouse_sk:3!null inv_quantity_on_hand:4
      │    │    │    │    │    │    │    ├── key: (1-3)
      │    │    │    │    │    │    │    ├── fd: (1-3)-->(4)
      │    │    │    │    │    │    │    └── ordering: +1
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_year:53!null date_dim.d_moy:55
      │    │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    │    ├── fd: ()-->(53), (47)-->(55)
      │    │    │    │    │    │    │    ├── ordering: +47 opt(53) [actual: +47]
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:47!null d_year:53 date_dim.d_moy:55
      │    │    │    │    │    │    │    │    ├── key: (47)
      │    │    │    │    │    │    │    │    ├── fd: (47)-->(53,55)
      │    │    │    │    │    │    │    │    └── ordering: +47
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── d_year:53 = 2000 [outer=(53), constraints=(/53: [/2000 - /2000]; tight), fd=()-->(53)]
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: item.i_item_sk:7!null
      │    │    │    │    │    │    └── key: (7)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── inv_item_sk:2 = item.i_item_sk:7 [outer=(2,7), constraints=(/2: (/NULL - ]; /7: (/NULL - ]), fd=(2)==(7), (7)==(2)]
      │    │    │    │    ├── scan warehouse
      │    │    │    │    │    ├── columns: warehouse.w_warehouse_sk:31!null warehouse.w_warehouse_name:33
      │    │    │    │    │    ├── key: (31)
      │    │    │    │    │    └── fd: (31)-->(33)
      │    │    │    │    └── filters
      │    │    │    │         └── inv_warehouse_sk:3 = warehouse.w_warehouse_sk:31 [outer=(3,31), constraints=(/3: (/NULL - ]; /31: (/NULL - ]), fd=(3)==(31), (31)==(3)]
      │    │    │    └── aggregations
      │    │    │         ├── std-dev [as=stddev_samp:77, outer=(4)]
      │    │    │         │    └── inv_quantity_on_hand:4
      │    │    │         ├── avg [as=avg:78, outer=(4)]
      │    │    │         │    └── inv_quantity_on_hand:4
      │    │    │         └── const-agg [as=warehouse.w_warehouse_name:33, outer=(33)]
      │    │    │              └── warehouse.w_warehouse_name:33
      │    │    └── filters
      │    │         └── CASE avg:78 WHEN 0 THEN 0 ELSE stddev_samp:77 / avg:78 END > 1 [outer=(77,78), immutable]
      │    └── projections
      │         └── CASE avg:78 WHEN 0 THEN CAST(NULL AS DECIMAL) ELSE stddev_samp:77 / avg:78 END [as=cov:79, outer=(77,78), immutable]
      └── inner-join (hash)
           ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86!null w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
           ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
           ├── immutable
           ├── key: (88,89)
           ├── fd: ()-->(83,90), (81,82)-->(85,86), (88,89)-->(92,93), (82)==(89), (89)==(82), (81)==(88), (88)==(81)
           ├── select
           │    ├── columns: w_warehouse_sk:88!null i_item_sk:89!null d_moy:90!null mean:92 cov:93
           │    ├── key: (88,89)
           │    ├── fd: ()-->(90), (88,89)-->(92,93)
           │    ├── with-scan &1 (inv)
           │    │    ├── columns: w_warehouse_sk:88!null i_item_sk:89!null d_moy:90 mean:92 cov:93
           │    │    ├── mapping:
           │    │    │    ├──  warehouse.w_warehouse_sk:31 => w_warehouse_sk:88
           │    │    │    ├──  item.i_item_sk:7 => i_item_sk:89
           │    │    │    ├──  date_dim.d_moy:55 => d_moy:90
           │    │    │    ├──  avg:78 => mean:92
           │    │    │    └──  cov:79 => cov:93
           │    │    ├── key: (88-90)
           │    │    └── fd: (88-90)-->(92,93)
           │    └── filters
           │         └── d_moy:90 = 2 [outer=(90), constraints=(/90: [/2 - /2]; tight), fd=()-->(90)]
           ├── select
           │    ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83!null mean:85 cov:86!null
           │    ├── immutable
           │    ├── key: (81,82)
           │    ├── fd: ()-->(83), (81,82)-->(85,86)
           │    ├── with-scan &1 (inv)
           │    │    ├── columns: w_warehouse_sk:81!null i_item_sk:82!null d_moy:83 mean:85 cov:86
           │    │    ├── mapping:
           │    │    │    ├──  warehouse.w_warehouse_sk:31 => w_warehouse_sk:81
           │    │    │    ├──  item.i_item_sk:7 => i_item_sk:82
           │    │    │    ├──  date_dim.d_moy:55 => d_moy:83
           │    │    │    ├──  avg:78 => mean:85
           │    │    │    └──  cov:79 => cov:86
           │    │    ├── key: (81-83)
           │    │    └── fd: (81-83)-->(85,86)
           │    └── filters
           │         ├── d_moy:83 = 1 [outer=(83), constraints=(/83: [/1 - /1]; tight), fd=()-->(83)]
           │         └── cov:86 > 1.5 [outer=(86), immutable, constraints=(/86: (/1.5 - ]; tight)]
           └── filters
                ├── i_item_sk:82 = i_item_sk:89 [outer=(82,89), constraints=(/82: (/NULL - ]; /89: (/NULL - ]), fd=(82)==(89), (89)==(82)]
                └── w_warehouse_sk:81 = w_warehouse_sk:88 [outer=(81,88), constraints=(/81: (/NULL - ]; /88: (/NULL - ]), fd=(81)==(88), (88)==(81)]

# --------------------------------------------------
# Q40
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
		w_state,
		i_item_id,
		sum(
			CASE
			WHEN (
				CAST(d_date AS DATE)
				< CAST('2001-05-02' AS DATE)
			)
			THEN cs_sales_price - COALESCE(cr_refunded_cash, 0)
			ELSE 0
			END
		)
			AS sales_before,
		sum(
			CASE
			WHEN (
				CAST(d_date AS DATE)
				>= CAST('2001-05-02' AS DATE)
			)
			THEN cs_sales_price - COALESCE(cr_refunded_cash, 0)
			ELSE 0
			END
		)
			AS sales_after
	FROM
		catalog_sales
		LEFT JOIN catalog_returns ON
				cs_order_number = cr_order_number
				AND cs_item_sk = cr_item_sk,
		warehouse,
		item,
		date_dim
	WHERE
		i_current_price BETWEEN 0.99 AND 1.49
		AND i_item_sk = cs_item_sk
		AND cs_warehouse_sk = w_warehouse_sk
		AND cs_sold_date_sk = d_date_sk
		AND d_date BETWEEN (CAST('2001-05-02' AS DATE) - '30 days'::INTERVAL) AND (CAST('2001-05-02' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
		w_state, i_item_id
	ORDER BY
		w_state, i_item_id
	LIMIT
		100;
----
limit
 ├── columns: w_state:76 i_item_id:83!null sales_before:137 sales_after:139
 ├── internal-ordering: +76,+83
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (76,83)
 ├── fd: (76,83)-->(137,139)
 ├── ordering: +76,+83
 ├── group-by (streaming)
 │    ├── columns: w_state:76 i_item_id:83!null sum:137 sum:139
 │    ├── grouping columns: w_state:76 i_item_id:83!null
 │    ├── immutable
 │    ├── key: (76,83)
 │    ├── fd: (76,83)-->(137,139)
 │    ├── ordering: +76,+83
 │    ├── limit hint: 100.00
 │    ├── project
 │    │    ├── columns: column136:136 column138:138 w_state:76 i_item_id:83!null
 │    │    ├── immutable
 │    │    ├── ordering: +76,+83
 │    │    ├── limit hint: 238.98
 │    │    ├── left-join (lookup catalog_returns)
 │    │    │    ├── columns: cs_sold_date_sk:1!null cs_warehouse_sk:15!null cs_item_sk:16!null cs_order_number:18!null cs_sales_price:22 cr_item_sk:39 cr_order_number:53 cr_refunded_cash:60 w_warehouse_sk:66!null w_state:76 i_item_sk:82!null i_item_id:83!null i_current_price:87!null d_date_sk:106!null d_date:108!null
 │    │    │    ├── key columns: [16 18] = [39 53]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── immutable
 │    │    │    ├── key: (18,82)
 │    │    │    ├── fd: (16,18)-->(1,15,22,39,53,60), (39,53)-->(60), (66)-->(76), (82)-->(83,87), (106)-->(108), (15)==(66), (66)==(15), (16)==(82), (82)==(16), (1)==(106), (106)==(1)
 │    │    │    ├── ordering: +76,+83
 │    │    │    ├── limit hint: 238.98
 │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_warehouse_sk:15!null cs_item_sk:16!null cs_order_number:18!null cs_sales_price:22 w_warehouse_sk:66!null w_state:76 i_item_sk:82!null i_item_id:83!null i_current_price:87!null d_date_sk:106!null d_date:108!null
 │    │    │    │    ├── key columns: [1] = [106]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: (18,82)
 │    │    │    │    ├── fd: (66)-->(76), (82)-->(83,87), (16,18)-->(1,15,22), (106)-->(108), (1)==(106), (106)==(1), (16)==(82), (82)==(16), (15)==(66), (66)==(15)
 │    │    │    │    ├── ordering: +76,+83
 │    │    │    │    ├── limit hint: 300.00
 │    │    │    │    ├── sort
 │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_warehouse_sk:15!null cs_item_sk:16!null cs_order_number:18!null cs_sales_price:22 w_warehouse_sk:66!null w_state:76 i_item_sk:82!null i_item_id:83!null i_current_price:87!null
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── key: (18,82)
 │    │    │    │    │    ├── fd: (66)-->(76), (16,18)-->(1,15,22), (82)-->(83,87), (16)==(82), (82)==(16), (15)==(66), (66)==(15)
 │    │    │    │    │    ├── ordering: +76,+83
 │    │    │    │    │    ├── limit hint: 9000.00
 │    │    │    │    │    └── inner-join (hash)
 │    │    │    │    │         ├── columns: cs_sold_date_sk:1 cs_warehouse_sk:15!null cs_item_sk:16!null cs_order_number:18!null cs_sales_price:22 w_warehouse_sk:66!null w_state:76 i_item_sk:82!null i_item_id:83!null i_current_price:87!null
 │    │    │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         ├── immutable
 │    │    │    │    │         ├── key: (18,82)
 │    │    │    │    │         ├── fd: (66)-->(76), (16,18)-->(1,15,22), (82)-->(83,87), (16)==(82), (82)==(16), (15)==(66), (66)==(15)
 │    │    │    │    │         ├── inner-join (lookup catalog_sales)
 │    │    │    │    │         │    ├── columns: cs_sold_date_sk:1 cs_warehouse_sk:15 cs_item_sk:16!null cs_order_number:18!null cs_sales_price:22 i_item_sk:82!null i_item_id:83!null i_current_price:87!null
 │    │    │    │    │         │    ├── key columns: [82] = [16]
 │    │    │    │    │         │    ├── immutable
 │    │    │    │    │         │    ├── key: (18,82)
 │    │    │    │    │         │    ├── fd: (16,18)-->(1,15,22), (82)-->(83,87), (16)==(82), (82)==(16)
 │    │    │    │    │         │    ├── select
 │    │    │    │    │         │    │    ├── columns: i_item_sk:82!null i_item_id:83!null i_current_price:87!null
 │    │    │    │    │         │    │    ├── immutable
 │    │    │    │    │         │    │    ├── key: (82)
 │    │    │    │    │         │    │    ├── fd: (82)-->(83,87)
 │    │    │    │    │         │    │    ├── scan item
 │    │    │    │    │         │    │    │    ├── columns: i_item_sk:82!null i_item_id:83!null i_current_price:87
 │    │    │    │    │         │    │    │    ├── key: (82)
 │    │    │    │    │         │    │    │    └── fd: (82)-->(83,87)
 │    │    │    │    │         │    │    └── filters
 │    │    │    │    │         │    │         └── (i_current_price:87 >= 0.99) AND (i_current_price:87 <= 1.49) [outer=(87), immutable, constraints=(/87: [/0.99 - /1.49]; tight)]
 │    │    │    │    │         │    └── filters (true)
 │    │    │    │    │         ├── scan warehouse
 │    │    │    │    │         │    ├── columns: w_warehouse_sk:66!null w_state:76
 │    │    │    │    │         │    ├── key: (66)
 │    │    │    │    │         │    └── fd: (66)-->(76)
 │    │    │    │    │         └── filters
 │    │    │    │    │              └── cs_warehouse_sk:15 = w_warehouse_sk:66 [outer=(15,66), constraints=(/15: (/NULL - ]; /66: (/NULL - ]), fd=(15)==(66), (66)==(15)]
 │    │    │    │    └── filters
 │    │    │    │         └── (d_date:108 >= '2001-04-02') AND (d_date:108 <= '2001-06-01') [outer=(108), constraints=(/108: [/'2001-04-02' - /'2001-06-01']; tight)]
 │    │    │    └── filters (true)
 │    │    └── projections
 │    │         ├── CASE WHEN d_date:108 < '2001-05-02' THEN cs_sales_price:22 - COALESCE(cr_refunded_cash:60::DECIMAL, 0) ELSE 0 END [as=column136:136, outer=(22,60,108), immutable]
 │    │         └── CASE WHEN d_date:108 >= '2001-05-02' THEN cs_sales_price:22 - COALESCE(cr_refunded_cash:60::DECIMAL, 0) ELSE 0 END [as=column138:138, outer=(22,60,108), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:137, outer=(136)]
 │         │    └── column136:136
 │         └── sum [as=sum:139, outer=(138)]
 │              └── column138:138
 └── 100

# --------------------------------------------------
# Q41
opt
	SELECT
		DISTINCT i_product_name
	FROM
		item AS i1
	WHERE
		i_manufact_id BETWEEN 704 AND (704 + 40)
		AND (
				SELECT
					count(*) AS item_cnt
				FROM
					item
				WHERE
					(
						i_manufact = i1.i_manufact
						AND (
								(
									i_category = 'Women'
									AND (
											i_color = 'forest'
											OR i_color = 'lime'
										)
									AND (
											i_units = 'Pallet'
											OR i_units = 'Pound'
										)
									AND (
											i_size = 'economy'
											OR i_size = 'small'
										)
								)
								OR (
										i_category = 'Women'
										AND (
												i_color = 'navy'
												OR i_color
													= 'slate'
											)
										AND (
												i_units
												= 'Gross'
												OR i_units
													= 'Bunch'
											)
										AND (
												i_size
												= 'extra large'
												OR i_size
													= 'petite'
											)
									)
								OR (
										i_category = 'Men'
										AND (
												i_color
												= 'powder'
												OR i_color
													= 'sky'
											)
										AND (
												i_units
												= 'Dozen'
												OR i_units
													= 'Lb'
											)
										AND (
												i_size = 'N/A'
												OR i_size
													= 'large'
											)
									)
								OR (
										i_category = 'Men'
										AND (
												i_color
												= 'maroon'
												OR i_color
													= 'smoke'
											)
										AND (
												i_units
												= 'Ounce'
												OR i_units
													= 'Case'
											)
										AND (
												i_size
												= 'economy'
												OR i_size
													= 'small'
											)
									)
							)
					)
					OR (
							i_manufact = i1.i_manufact
							AND (
									(
										i_category = 'Women'
										AND (
												i_color = 'dark'
												OR i_color
													= 'aquamarine'
											)
										AND (
												i_units = 'Ton'
												OR i_units
													= 'Tbl'
											)
										AND (
												i_size
												= 'economy'
												OR i_size
													= 'small'
											)
									)
									OR (
											i_category = 'Women'
											AND (
													i_color
													= 'frosted'
													OR i_color
														= 'plum'
												)
											AND (
													i_units
													= 'Dram'
													OR i_units
														= 'Box'
												)
											AND (
													i_size
													= 'extra large'
													OR i_size
														= 'petite'
												)
										)
									OR (
											i_category = 'Men'
											AND (
													i_color
													= 'papaya'
													OR i_color
														= 'peach'
												)
											AND (
													i_units
													= 'Bundle'
													OR i_units
														= 'Carton'
												)
											AND (
													i_size
													= 'N/A'
													OR i_size
														= 'large'
												)
										)
									OR (
											i_category = 'Men'
											AND (
													i_color
													= 'firebrick'
													OR i_color
														= 'sienna'
												)
											AND (
													i_units
													= 'Cup'
													OR i_units
														= 'Each'
												)
											AND (
													i_size
													= 'economy'
													OR i_size
														= 'small'
												)
										)
								)
						)
			)
			> 0
	ORDER BY
		i_product_name
	LIMIT
		100;
----
top-k
 ├── columns: i_product_name:22
 ├── internal-ordering: +22
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (22)
 ├── ordering: +22
 └── distinct-on
      ├── columns: i1.i_product_name:22
      ├── grouping columns: i1.i_product_name:22
      ├── key: (22)
      └── select
           ├── columns: i1.i_item_sk:1!null i1.i_product_name:22 count_rows:49!null
           ├── key: (1)
           ├── fd: (1)-->(22,49)
           ├── group-by (hash)
           │    ├── columns: i1.i_item_sk:1!null i1.i_product_name:22 count_rows:49!null
           │    ├── grouping columns: i1.i_item_sk:1!null
           │    ├── key: (1)
           │    ├── fd: (1)-->(22,49)
           │    ├── left-join (hash)
           │    │    ├── columns: i1.i_item_sk:1!null i1.i_manufact_id:14!null i1.i_manufact:15 i1.i_product_name:22 item.i_category:37 item.i_manufact:39 item.i_size:40 item.i_color:42 item.i_units:43
           │    │    ├── fd: (1)-->(14,15,22)
           │    │    ├── select
           │    │    │    ├── columns: i1.i_item_sk:1!null i1.i_manufact_id:14!null i1.i_manufact:15 i1.i_product_name:22
           │    │    │    ├── key: (1)
           │    │    │    ├── fd: (1)-->(14,15,22)
           │    │    │    ├── scan item [as=i1]
           │    │    │    │    ├── columns: i1.i_item_sk:1!null i1.i_manufact_id:14 i1.i_manufact:15 i1.i_product_name:22
           │    │    │    │    ├── key: (1)
           │    │    │    │    └── fd: (1)-->(14,15,22)
           │    │    │    └── filters
           │    │    │         └── (i1.i_manufact_id:14 >= 704) AND (i1.i_manufact_id:14 <= 744) [outer=(14), constraints=(/14: [/704 - /744]; tight)]
           │    │    ├── select
           │    │    │    ├── columns: item.i_category:37!null item.i_manufact:39 item.i_size:40!null item.i_color:42!null item.i_units:43!null
           │    │    │    ├── scan item
           │    │    │    │    └── columns: item.i_category:37 item.i_manufact:39 item.i_size:40 item.i_color:42 item.i_units:43
           │    │    │    └── filters
           │    │    │         └── ((((item.i_category:37 = 'Women') AND (((((item.i_color:42 = 'forest') OR (item.i_color:42 = 'lime')) AND ((item.i_units:43 = 'Pallet') OR (item.i_units:43 = 'Pound'))) AND ((item.i_size:40 = 'economy') OR (item.i_size:40 = 'small'))) OR ((((item.i_color:42 = 'navy') OR (item.i_color:42 = 'slate')) AND ((item.i_units:43 = 'Gross') OR (item.i_units:43 = 'Bunch'))) AND ((item.i_size:40 = 'extra large') OR (item.i_size:40 = 'petite'))))) OR ((((item.i_category:37 = 'Men') AND ((item.i_color:42 = 'powder') OR (item.i_color:42 = 'sky'))) AND ((item.i_units:43 = 'Dozen') OR (item.i_units:43 = 'Lb'))) AND ((item.i_size:40 = 'N/A') OR (item.i_size:40 = 'large')))) OR ((((item.i_category:37 = 'Men') AND ((item.i_color:42 = 'maroon') OR (item.i_color:42 = 'smoke'))) AND ((item.i_units:43 = 'Ounce') OR (item.i_units:43 = 'Case'))) AND ((item.i_size:40 = 'economy') OR (item.i_size:40 = 'small')))) OR ((((item.i_category:37 = 'Women') AND (((((item.i_color:42 = 'dark') OR (item.i_color:42 = 'aquamarine')) AND ((item.i_units:43 = 'Ton') OR (item.i_units:43 = 'Tbl'))) AND ((item.i_size:40 = 'economy') OR (item.i_size:40 = 'small'))) OR ((((item.i_color:42 = 'frosted') OR (item.i_color:42 = 'plum')) AND ((item.i_units:43 = 'Dram') OR (item.i_units:43 = 'Box'))) AND ((item.i_size:40 = 'extra large') OR (item.i_size:40 = 'petite'))))) OR ((((item.i_category:37 = 'Men') AND ((item.i_color:42 = 'papaya') OR (item.i_color:42 = 'peach'))) AND ((item.i_units:43 = 'Bundle') OR (item.i_units:43 = 'Carton'))) AND ((item.i_size:40 = 'N/A') OR (item.i_size:40 = 'large')))) OR ((((item.i_category:37 = 'Men') AND ((item.i_color:42 = 'firebrick') OR (item.i_color:42 = 'sienna'))) AND ((item.i_units:43 = 'Cup') OR (item.i_units:43 = 'Each'))) AND ((item.i_size:40 = 'economy') OR (item.i_size:40 = 'small')))) [outer=(37,40,42,43), constraints=(/37: [/'Men' - /'Men'] [/'Women' - /'Women']; /40: [/'N/A' - /'N/A'] [/'economy' - /'economy'] [/'extra large' - /'extra large'] [/'large' - /'large'] [/'petite' - /'petite'] [/'small' - /'small']; /42: [/'aquamarine' - /'aquamarine'] [/'dark' - /'dark'] [/'firebrick' - /'firebrick'] [/'forest' - /'forest'] [/'frosted' - /'frosted'] [/'lime' - /'lime'] [/'maroon' - /'maroon'] [/'navy' - /'navy'] [/'papaya' - /'papaya'] [/'peach' - /'peach'] [/'plum' - /'plum'] [/'powder' - /'powder'] [/'sienna' - /'sienna'] [/'sky' - /'sky'] [/'slate' - /'slate'] [/'smoke' - /'smoke']; /43: [/'Box' - /'Box'] [/'Bunch' - /'Bunch'] [/'Bundle' - /'Bundle'] [/'Carton' - /'Carton'] [/'Case' - /'Case'] [/'Cup' - /'Cup'] [/'Dozen' - /'Dozen'] [/'Dram' - /'Dram'] [/'Each' - /'Each'] [/'Gross' - /'Gross'] [/'Lb' - /'Lb'] [/'Ounce' - /'Ounce'] [/'Pallet' - /'Pallet'] [/'Pound' - /'Pound'] [/'Tbl' - /'Tbl'] [/'Ton' - /'Ton'])]
           │    │    └── filters
           │    │         └── item.i_manufact:39 = i1.i_manufact:15 [outer=(15,39), constraints=(/15: (/NULL - ]; /39: (/NULL - ]), fd=(15)==(39), (39)==(15)]
           │    └── aggregations
           │         ├── count [as=count_rows:49, outer=(37)]
           │         │    └── item.i_category:37
           │         └── const-agg [as=i1.i_product_name:22, outer=(22)]
           │              └── i1.i_product_name:22
           └── filters
                └── count_rows:49 > 0 [outer=(49), constraints=(/49: [/1 - ]; tight)]

# --------------------------------------------------
# Q42
opt
	SELECT
		dt.d_year,
		item.i_category_id,
		item.i_category,
		sum(ss_ext_sales_price)
	FROM
		date_dim AS dt, store_sales, item
	WHERE
		dt.d_date_sk = store_sales.ss_sold_date_sk
		AND store_sales.ss_item_sk = item.i_item_sk
		AND item.i_manager_id = 1
		AND dt.d_moy = 11
		AND dt.d_year = 1998
	GROUP BY
		dt.d_year, item.i_category_id, item.i_category
	ORDER BY
		sum(ss_ext_sales_price) DESC,
		dt.d_year,
		item.i_category_id,
		item.i_category
	LIMIT
		100;
----
top-k
 ├── columns: d_year:7!null i_category_id:67 i_category:68 sum:80
 ├── internal-ordering: -80,+67,+68 opt(7)
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (67,68)
 ├── fd: ()-->(7), (67,68)-->(7,80)
 ├── ordering: -80,+67,+68 opt(7) [actual: -80,+67,+68]
 └── group-by (hash)
      ├── columns: d_year:7!null i_category_id:67 i_category:68 sum:80
      ├── grouping columns: i_category_id:67 i_category:68
      ├── key: (67,68)
      ├── fd: ()-->(7), (67,68)-->(7,80)
      ├── inner-join (hash)
      │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_category_id:67 i_category:68 i_manager_id:76!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── fd: ()-->(7,9,76), (56)-->(67,68), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup store_sales)
      │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_category_id:67 i_category:68 i_manager_id:76!null
      │    │    ├── key columns: [56] = [33]
      │    │    ├── fd: ()-->(76), (56)-->(67,68), (33)==(56), (56)==(33)
      │    │    ├── select
      │    │    │    ├── columns: i_item_sk:56!null i_category_id:67 i_category:68 i_manager_id:76!null
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: ()-->(76), (56)-->(67,68)
      │    │    │    ├── scan item
      │    │    │    │    ├── columns: i_item_sk:56!null i_category_id:67 i_category:68 i_manager_id:76
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(67,68,76)
      │    │    │    └── filters
      │    │    │         └── i_manager_id:76 = 1 [outer=(76), constraints=(/76: [/1 - /1]; tight), fd=()-->(76)]
      │    │    └── filters (true)
      │    ├── select
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null
      │    │    ├── key: (1)
      │    │    ├── fd: ()-->(7,9)
      │    │    ├── scan date_dim [as=dt]
      │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    ├── key: (1)
      │    │    │    └── fd: (1)-->(7,9)
      │    │    └── filters
      │    │         ├── d_moy:9 = 11 [outer=(9), constraints=(/9: [/11 - /11]; tight), fd=()-->(9)]
      │    │         └── d_year:7 = 1998 [outer=(7), constraints=(/7: [/1998 - /1998]; tight), fd=()-->(7)]
      │    └── filters
      │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      └── aggregations
           ├── sum [as=sum:80, outer=(46)]
           │    └── ss_ext_sales_price:46
           └── const-agg [as=d_year:7, outer=(7)]
                └── d_year:7

# --------------------------------------------------
# Q43
opt
	SELECT
		s_store_name,
		s_store_id,
		sum(
			CASE
			WHEN (d_day_name = 'Sunday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS sun_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Monday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS mon_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Tuesday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS tue_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Wednesday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS wed_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Thursday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS thu_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Friday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS fri_sales,
		sum(
			CASE
			WHEN (d_day_name = 'Saturday') THEN ss_sales_price
			ELSE NULL
			END
		)
			AS sat_sales
	FROM
		date_dim, store_sales, store
	WHERE
		d_date_sk = ss_sold_date_sk
		AND s_store_sk = ss_store_sk
		AND s_gmt_offset = -5
		AND d_year = 2000
	GROUP BY
		s_store_name, s_store_id
	ORDER BY
		s_store_name,
		s_store_id,
		sun_sales,
		mon_sales,
		tue_sales,
		wed_sales,
		thu_sales,
		fri_sales,
		sat_sales
	LIMIT
		100;
----
top-k
 ├── columns: s_store_name:61 s_store_id:57!null sun_sales:88 mon_sales:90 tue_sales:92 wed_sales:94 thu_sales:96 fri_sales:98 sat_sales:100
 ├── internal-ordering: +61,+57
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (57,61)
 ├── fd: (57,61)-->(88,90,92,94,96,98,100)
 ├── ordering: +61,+57
 └── group-by (hash)
      ├── columns: s_store_id:57!null s_store_name:61 sum:88 sum:90 sum:92 sum:94 sum:96 sum:98 sum:100
      ├── grouping columns: s_store_id:57!null s_store_name:61
      ├── immutable
      ├── key: (57,61)
      ├── fd: (57,61)-->(88,90,92,94,96,98,100)
      ├── project
      │    ├── columns: column87:87 column89:89 column91:91 column93:93 column95:95 column97:97 column99:99 s_store_id:57!null s_store_name:61
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_day_name:15 ss_sold_date_sk:31!null ss_store_sk:38!null ss_sales_price:44 s_store_sk:56!null s_store_id:57!null s_store_name:61 s_gmt_offset:83!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── immutable
      │    │    ├── fd: ()-->(7,83), (1)-->(15), (56)-->(57,61), (38)==(56), (56)==(38), (1)==(31), (31)==(1)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_day_name:15 ss_sold_date_sk:31!null ss_store_sk:38 ss_sales_price:44
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(7), (1)-->(15), (1)==(31), (31)==(1)
      │    │    │    ├── scan store_sales
      │    │    │    │    └── columns: ss_sold_date_sk:31 ss_store_sk:38 ss_sales_price:44
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:1!null d_year:7!null d_day_name:15
      │    │    │    │    ├── key: (1)
      │    │    │    │    ├── fd: ()-->(7), (1)-->(15)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_day_name:15
      │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    └── fd: (1)-->(7,15)
      │    │    │    │    └── filters
      │    │    │    │         └── d_year:7 = 2000 [outer=(7), constraints=(/7: [/2000 - /2000]; tight), fd=()-->(7)]
      │    │    │    └── filters
      │    │    │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      │    │    ├── select
      │    │    │    ├── columns: s_store_sk:56!null s_store_id:57!null s_store_name:61 s_gmt_offset:83!null
      │    │    │    ├── immutable
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: ()-->(83), (56)-->(57,61)
      │    │    │    ├── scan store
      │    │    │    │    ├── columns: s_store_sk:56!null s_store_id:57!null s_store_name:61 s_gmt_offset:83
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(57,61,83)
      │    │    │    └── filters
      │    │    │         └── s_gmt_offset:83 = -5 [outer=(83), immutable, constraints=(/83: [/-5 - /-5]; tight), fd=()-->(83)]
      │    │    └── filters
      │    │         └── s_store_sk:56 = ss_store_sk:38 [outer=(38,56), constraints=(/38: (/NULL - ]; /56: (/NULL - ]), fd=(38)==(56), (56)==(38)]
      │    └── projections
      │         ├── CASE WHEN d_day_name:15 = 'Sunday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column87:87, outer=(15,44), immutable]
      │         ├── CASE WHEN d_day_name:15 = 'Monday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column89:89, outer=(15,44), immutable]
      │         ├── CASE WHEN d_day_name:15 = 'Tuesday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column91:91, outer=(15,44), immutable]
      │         ├── CASE WHEN d_day_name:15 = 'Wednesday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column93:93, outer=(15,44), immutable]
      │         ├── CASE WHEN d_day_name:15 = 'Thursday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column95:95, outer=(15,44), immutable]
      │         ├── CASE WHEN d_day_name:15 = 'Friday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column97:97, outer=(15,44), immutable]
      │         └── CASE WHEN d_day_name:15 = 'Saturday' THEN ss_sales_price:44::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column99:99, outer=(15,44), immutable]
      └── aggregations
           ├── sum [as=sum:88, outer=(87)]
           │    └── column87:87
           ├── sum [as=sum:90, outer=(89)]
           │    └── column89:89
           ├── sum [as=sum:92, outer=(91)]
           │    └── column91:91
           ├── sum [as=sum:94, outer=(93)]
           │    └── column93:93
           ├── sum [as=sum:96, outer=(95)]
           │    └── column95:95
           ├── sum [as=sum:98, outer=(97)]
           │    └── column97:97
           └── sum [as=sum:100, outer=(99)]
                └── column99:99

# --------------------------------------------------
# Q44
opt
	SELECT
		asceding.rnk,
		i1.i_product_name AS best_performing,
		i2.i_product_name AS worst_performing
	FROM
		(
			SELECT
				*
			FROM
				(
					SELECT
						item_sk,
						rank() OVER (ORDER BY rank_col ASC)
							AS rnk
					FROM
						(
							SELECT
								ss_item_sk AS item_sk,
								avg(ss_net_profit) AS rank_col
							FROM
								store_sales AS ss1
							WHERE
								ss_store_sk = 4
							GROUP BY
								ss_item_sk
							HAVING
								avg(ss_net_profit)
								> 0.9
									* (
											SELECT
												avg(
													ss_net_profit
												)
													AS rank_col
											FROM
												store_sales
											WHERE
												ss_store_sk = 4
												AND ss_hdemo_sk
													IS NULL
											GROUP BY
												ss_store_sk
										)
						)
							AS v1
				)
					AS v11
			WHERE
				rnk < 11
		)
			AS asceding,
		(
			SELECT
				*
			FROM
				(
					SELECT
						item_sk,
						rank() OVER (ORDER BY rank_col DESC)
							AS rnk
					FROM
						(
							SELECT
								ss_item_sk AS item_sk,
								avg(ss_net_profit) AS rank_col
							FROM
								store_sales AS ss1
							WHERE
								ss_store_sk = 4
							GROUP BY
								ss_item_sk
							HAVING
								avg(ss_net_profit)
								> 0.9
									* (
											SELECT
												avg(
													ss_net_profit
												)
													AS rank_col
											FROM
												store_sales
											WHERE
												ss_store_sk = 4
												AND ss_hdemo_sk
													IS NULL
											GROUP BY
												ss_store_sk
										)
						)
							AS v2
				)
					AS v21
			WHERE
				rnk < 11
		)
			AS descending,
		item AS i1,
		item AS i2
	WHERE
		asceding.rnk = descending.rnk
		AND i1.i_item_sk = asceding.item_sk
		AND i2.i_item_sk = descending.item_sk
	ORDER BY
		asceding.rnk
	LIMIT
		100;
----
project
 ├── columns: rnk:53!null best_performing:130 worst_performing:154
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +53
 └── limit
      ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null i1.i_item_sk:109!null i1.i_product_name:130 i2.i_item_sk:133!null i2.i_product_name:154
      ├── internal-ordering: +(53|107)
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── key: (109,133)
      ├── fd: (3)-->(26,53), (57)-->(80,107), (133)-->(154), (109)-->(130), (26)==(54), (54)==(26), (80)==(108), (108)==(80), (57)==(133), (133)==(57), (53)==(107), (107)==(53), (3)==(109), (109)==(3)
      ├── ordering: +(53|107) [actual: +53]
      ├── inner-join (lookup item [as=i1])
      │    ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null i1.i_item_sk:109!null i1.i_product_name:130 i2.i_item_sk:133!null i2.i_product_name:154
      │    ├── key columns: [3] = [109]
      │    ├── lookup columns are key
      │    ├── immutable
      │    ├── key: (109,133)
      │    ├── fd: (3)-->(26,53), (57)-->(80,107), (133)-->(154), (109)-->(130), (26)==(54), (54)==(26), (80)==(108), (108)==(80), (57)==(133), (133)==(57), (53)==(107), (107)==(53), (3)==(109), (109)==(3)
      │    ├── ordering: +(53|107) [actual: +53]
      │    ├── limit hint: 100.00
      │    ├── inner-join (lookup item [as=i2])
      │    │    ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null i2.i_item_sk:133!null i2.i_product_name:154
      │    │    ├── key columns: [57] = [133]
      │    │    ├── lookup columns are key
      │    │    ├── immutable
      │    │    ├── key: (3,133)
      │    │    ├── fd: (3)-->(26,53), (57)-->(80,107), (133)-->(154), (26)==(54), (54)==(26), (80)==(108), (108)==(80), (57)==(133), (133)==(57), (53)==(107), (107)==(53)
      │    │    ├── ordering: +(53|107) [actual: +53]
      │    │    ├── limit hint: 100.00
      │    │    ├── sort
      │    │    │    ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null
      │    │    │    ├── immutable
      │    │    │    ├── key: (3,57)
      │    │    │    ├── fd: (3)-->(26,53), (57)-->(80,107), (26)==(54), (54)==(26), (80)==(108), (108)==(80), (53)==(107), (107)==(53)
      │    │    │    ├── ordering: +(53|107) [actual: +53]
      │    │    │    ├── limit hint: 100.00
      │    │    │    └── inner-join (hash)
      │    │    │         ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null
      │    │    │         ├── immutable
      │    │    │         ├── key: (3,57)
      │    │    │         ├── fd: (3)-->(26,53), (57)-->(80,107), (26)==(54), (54)==(26), (80)==(108), (108)==(80), (53)==(107), (107)==(53)
      │    │    │         ├── select
      │    │    │         │    ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53!null rank_1_orderby_1_1:54!null
      │    │    │         │    ├── immutable
      │    │    │         │    ├── key: (3)
      │    │    │         │    ├── fd: (3)-->(26,53), (26)==(54), (54)==(26)
      │    │    │         │    ├── window partition=() ordering=+(26|54)
      │    │    │         │    │    ├── columns: ss1.ss_item_sk:3!null avg:26!null rank:53 rank_1_orderby_1_1:54!null
      │    │    │         │    │    ├── immutable
      │    │    │         │    │    ├── key: (3)
      │    │    │         │    │    ├── fd: (3)-->(26,53), (26)==(54), (54)==(26)
      │    │    │         │    │    ├── project
      │    │    │         │    │    │    ├── columns: rank_1_orderby_1_1:54!null ss1.ss_item_sk:3!null avg:26!null
      │    │    │         │    │    │    ├── immutable
      │    │    │         │    │    │    ├── key: (3)
      │    │    │         │    │    │    ├── fd: (3)-->(26), (26)==(54), (54)==(26)
      │    │    │         │    │    │    ├── select
      │    │    │         │    │    │    │    ├── columns: ss1.ss_item_sk:3!null avg:26!null
      │    │    │         │    │    │    │    ├── immutable
      │    │    │         │    │    │    │    ├── key: (3)
      │    │    │         │    │    │    │    ├── fd: (3)-->(26)
      │    │    │         │    │    │    │    ├── group-by (streaming)
      │    │    │         │    │    │    │    │    ├── columns: ss1.ss_item_sk:3!null avg:26
      │    │    │         │    │    │    │    │    ├── grouping columns: ss1.ss_item_sk:3!null
      │    │    │         │    │    │    │    │    ├── internal-ordering: +3 opt(8)
      │    │    │         │    │    │    │    │    ├── key: (3)
      │    │    │         │    │    │    │    │    ├── fd: (3)-->(26)
      │    │    │         │    │    │    │    │    ├── select
      │    │    │         │    │    │    │    │    │    ├── columns: ss1.ss_item_sk:3!null ss1.ss_store_sk:8!null ss1.ss_net_profit:23
      │    │    │         │    │    │    │    │    │    ├── fd: ()-->(8)
      │    │    │         │    │    │    │    │    │    ├── ordering: +3 opt(8) [actual: +3]
      │    │    │         │    │    │    │    │    │    ├── scan store_sales [as=ss1]
      │    │    │         │    │    │    │    │    │    │    ├── columns: ss1.ss_item_sk:3!null ss1.ss_store_sk:8 ss1.ss_net_profit:23
      │    │    │         │    │    │    │    │    │    │    └── ordering: +3
      │    │    │         │    │    │    │    │    │    └── filters
      │    │    │         │    │    │    │    │    │         └── ss1.ss_store_sk:8 = 4 [outer=(8), constraints=(/8: [/4 - /4]; tight), fd=()-->(8)]
      │    │    │         │    │    │    │    │    └── aggregations
      │    │    │         │    │    │    │    │         └── avg [as=avg:26, outer=(23)]
      │    │    │         │    │    │    │    │              └── ss1.ss_net_profit:23
      │    │    │         │    │    │    │    └── filters
      │    │    │         │    │    │    │         └── gt [outer=(26), immutable, subquery, constraints=(/26: (/NULL - ])]
      │    │    │         │    │    │    │              ├── avg:26
      │    │    │         │    │    │    │              └── mult
      │    │    │         │    │    │    │                   ├── subquery
      │    │    │         │    │    │    │                   │    └── group-by (streaming)
      │    │    │         │    │    │    │                   │         ├── columns: avg:52
      │    │    │         │    │    │    │                   │         ├── cardinality: [0 - 1]
      │    │    │         │    │    │    │                   │         ├── key: ()
      │    │    │         │    │    │    │                   │         ├── fd: ()-->(52)
      │    │    │         │    │    │    │                   │         ├── select
      │    │    │         │    │    │    │                   │         │    ├── columns: store_sales.ss_hdemo_sk:32 store_sales.ss_store_sk:34!null store_sales.ss_net_profit:49
      │    │    │         │    │    │    │                   │         │    ├── fd: ()-->(32,34)
      │    │    │         │    │    │    │                   │         │    ├── scan store_sales
      │    │    │         │    │    │    │                   │         │    │    └── columns: store_sales.ss_hdemo_sk:32 store_sales.ss_store_sk:34 store_sales.ss_net_profit:49
      │    │    │         │    │    │    │                   │         │    └── filters
      │    │    │         │    │    │    │                   │         │         ├── store_sales.ss_store_sk:34 = 4 [outer=(34), constraints=(/34: [/4 - /4]; tight), fd=()-->(34)]
      │    │    │         │    │    │    │                   │         │         └── store_sales.ss_hdemo_sk:32 IS NULL [outer=(32), constraints=(/32: [/NULL - /NULL]; tight), fd=()-->(32)]
      │    │    │         │    │    │    │                   │         └── aggregations
      │    │    │         │    │    │    │                   │              └── avg [as=avg:52, outer=(49)]
      │    │    │         │    │    │    │                   │                   └── store_sales.ss_net_profit:49
      │    │    │         │    │    │    │                   └── 0.9
      │    │    │         │    │    │    └── projections
      │    │    │         │    │    │         └── avg:26 [as=rank_1_orderby_1_1:54, outer=(26)]
      │    │    │         │    │    └── windows
      │    │    │         │    │         └── rank [as=rank:53]
      │    │    │         │    └── filters
      │    │    │         │         └── rank:53 < 11 [outer=(53), constraints=(/53: (/NULL - /10]; tight)]
      │    │    │         ├── select
      │    │    │         │    ├── columns: ss1.ss_item_sk:57!null avg:80!null rank:107!null rank_1_orderby_1_1:108!null
      │    │    │         │    ├── immutable
      │    │    │         │    ├── key: (57)
      │    │    │         │    ├── fd: (57)-->(80,107), (80)==(108), (108)==(80)
      │    │    │         │    ├── window partition=() ordering=-(80|108)
      │    │    │         │    │    ├── columns: ss1.ss_item_sk:57!null avg:80!null rank:107 rank_1_orderby_1_1:108!null
      │    │    │         │    │    ├── immutable
      │    │    │         │    │    ├── key: (57)
      │    │    │         │    │    ├── fd: (57)-->(80,107), (80)==(108), (108)==(80)
      │    │    │         │    │    ├── project
      │    │    │         │    │    │    ├── columns: rank_1_orderby_1_1:108!null ss1.ss_item_sk:57!null avg:80!null
      │    │    │         │    │    │    ├── immutable
      │    │    │         │    │    │    ├── key: (57)
      │    │    │         │    │    │    ├── fd: (57)-->(80), (80)==(108), (108)==(80)
      │    │    │         │    │    │    ├── select
      │    │    │         │    │    │    │    ├── columns: ss1.ss_item_sk:57!null avg:80!null
      │    │    │         │    │    │    │    ├── immutable
      │    │    │         │    │    │    │    ├── key: (57)
      │    │    │         │    │    │    │    ├── fd: (57)-->(80)
      │    │    │         │    │    │    │    ├── group-by (streaming)
      │    │    │         │    │    │    │    │    ├── columns: ss1.ss_item_sk:57!null avg:80
      │    │    │         │    │    │    │    │    ├── grouping columns: ss1.ss_item_sk:57!null
      │    │    │         │    │    │    │    │    ├── internal-ordering: +57 opt(62)
      │    │    │         │    │    │    │    │    ├── key: (57)
      │    │    │         │    │    │    │    │    ├── fd: (57)-->(80)
      │    │    │         │    │    │    │    │    ├── select
      │    │    │         │    │    │    │    │    │    ├── columns: ss1.ss_item_sk:57!null ss1.ss_store_sk:62!null ss1.ss_net_profit:77
      │    │    │         │    │    │    │    │    │    ├── fd: ()-->(62)
      │    │    │         │    │    │    │    │    │    ├── ordering: +57 opt(62) [actual: +57]
      │    │    │         │    │    │    │    │    │    ├── scan store_sales [as=ss1]
      │    │    │         │    │    │    │    │    │    │    ├── columns: ss1.ss_item_sk:57!null ss1.ss_store_sk:62 ss1.ss_net_profit:77
      │    │    │         │    │    │    │    │    │    │    └── ordering: +57
      │    │    │         │    │    │    │    │    │    └── filters
      │    │    │         │    │    │    │    │    │         └── ss1.ss_store_sk:62 = 4 [outer=(62), constraints=(/62: [/4 - /4]; tight), fd=()-->(62)]
      │    │    │         │    │    │    │    │    └── aggregations
      │    │    │         │    │    │    │    │         └── avg [as=avg:80, outer=(77)]
      │    │    │         │    │    │    │    │              └── ss1.ss_net_profit:77
      │    │    │         │    │    │    │    └── filters
      │    │    │         │    │    │    │         └── gt [outer=(80), immutable, subquery, constraints=(/80: (/NULL - ])]
      │    │    │         │    │    │    │              ├── avg:80
      │    │    │         │    │    │    │              └── mult
      │    │    │         │    │    │    │                   ├── subquery
      │    │    │         │    │    │    │                   │    └── group-by (streaming)
      │    │    │         │    │    │    │                   │         ├── columns: avg:106
      │    │    │         │    │    │    │                   │         ├── cardinality: [0 - 1]
      │    │    │         │    │    │    │                   │         ├── key: ()
      │    │    │         │    │    │    │                   │         ├── fd: ()-->(106)
      │    │    │         │    │    │    │                   │         ├── select
      │    │    │         │    │    │    │                   │         │    ├── columns: store_sales.ss_hdemo_sk:86 store_sales.ss_store_sk:88!null store_sales.ss_net_profit:103
      │    │    │         │    │    │    │                   │         │    ├── fd: ()-->(86,88)
      │    │    │         │    │    │    │                   │         │    ├── scan store_sales
      │    │    │         │    │    │    │                   │         │    │    └── columns: store_sales.ss_hdemo_sk:86 store_sales.ss_store_sk:88 store_sales.ss_net_profit:103
      │    │    │         │    │    │    │                   │         │    └── filters
      │    │    │         │    │    │    │                   │         │         ├── store_sales.ss_store_sk:88 = 4 [outer=(88), constraints=(/88: [/4 - /4]; tight), fd=()-->(88)]
      │    │    │         │    │    │    │                   │         │         └── store_sales.ss_hdemo_sk:86 IS NULL [outer=(86), constraints=(/86: [/NULL - /NULL]; tight), fd=()-->(86)]
      │    │    │         │    │    │    │                   │         └── aggregations
      │    │    │         │    │    │    │                   │              └── avg [as=avg:106, outer=(103)]
      │    │    │         │    │    │    │                   │                   └── store_sales.ss_net_profit:103
      │    │    │         │    │    │    │                   └── 0.9
      │    │    │         │    │    │    └── projections
      │    │    │         │    │    │         └── avg:80 [as=rank_1_orderby_1_1:108, outer=(80)]
      │    │    │         │    │    └── windows
      │    │    │         │    │         └── rank [as=rank:107]
      │    │    │         │    └── filters
      │    │    │         │         └── rank:107 < 11 [outer=(107), constraints=(/107: (/NULL - /10]; tight)]
      │    │    │         └── filters
      │    │    │              └── rank:53 = rank:107 [outer=(53,107), constraints=(/53: (/NULL - ]; /107: (/NULL - ]), fd=(53)==(107), (107)==(53)]
      │    │    └── filters (true)
      │    └── filters (true)
      └── 100

# --------------------------------------------------
# Q45
opt
	SELECT
		ca_zip, ca_city, sum(ws_sales_price)
	FROM
		web_sales, customer, customer_address, date_dim, item
	WHERE
		ws_bill_customer_sk = c_customer_sk
		AND c_current_addr_sk = ca_address_sk
		AND ws_item_sk = i_item_sk
		AND (
				substr(ca_zip, 1, 5)
				IN (
						'85669',
						'86197',
						'88274',
						'83405',
						'86475',
						'85392',
						'85460',
						'80348',
						'81792'
					)
				OR i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_item_sk
								IN (
										2,
										3,
										5,
										7,
										11,
										13,
										17,
										19,
										23,
										29
									)
						)
			)
		AND ws_sold_date_sk = d_date_sk
		AND d_qoy = 1
		AND d_year = 2000
	GROUP BY
		ca_zip, ca_city
	ORDER BY
		ca_zip, ca_city
	LIMIT
		100;
----
limit
 ├── columns: ca_zip:66 ca_city:63 sum:150
 ├── internal-ordering: +66,+63
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (63,66)
 ├── fd: (63,66)-->(150)
 ├── ordering: +66,+63
 ├── group-by (streaming)
 │    ├── columns: ca_city:63 ca_zip:66 sum:150
 │    ├── grouping columns: ca_city:63 ca_zip:66
 │    ├── immutable
 │    ├── key: (63,66)
 │    ├── fd: (63,66)-->(150)
 │    ├── ordering: +66,+63
 │    ├── limit hint: 100.00
 │    ├── inner-join (lookup item)
 │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_bill_customer_sk:5!null ws_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_city:63 ca_zip:66 d_date_sk:72!null d_year:78!null d_qoy:82!null i_item_sk:102!null i_item_id:103!null
 │    │    ├── key columns: [4] = [102]
 │    │    ├── lookup columns are key
 │    │    ├── immutable
 │    │    ├── fd: ()-->(78,82), (37)-->(41), (57)-->(63,66), (102)-->(103), (41)==(57), (57)==(41), (5)==(37), (37)==(5), (4)==(102), (102)==(4), (1)==(72), (72)==(1)
 │    │    ├── ordering: +66,+63 opt(78,82) [actual: +66,+63]
 │    │    ├── limit hint: 267.43
 │    │    ├── sort
 │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_bill_customer_sk:5!null ws_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_city:63 ca_zip:66 d_date_sk:72!null d_year:78!null d_qoy:82!null
 │    │    │    ├── fd: ()-->(78,82), (57)-->(63,66), (37)-->(41), (1)==(72), (72)==(1), (5)==(37), (37)==(5), (41)==(57), (57)==(41)
 │    │    │    ├── ordering: +66,+63 opt(78,82) [actual: +66,+63]
 │    │    │    ├── limit hint: 200.00
 │    │    │    └── inner-join (hash)
 │    │    │         ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_bill_customer_sk:5!null ws_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41!null ca_address_sk:57!null ca_city:63 ca_zip:66 d_date_sk:72!null d_year:78!null d_qoy:82!null
 │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         ├── fd: ()-->(78,82), (57)-->(63,66), (37)-->(41), (1)==(72), (72)==(1), (5)==(37), (37)==(5), (41)==(57), (57)==(41)
 │    │    │         ├── inner-join (hash)
 │    │    │         │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_bill_customer_sk:5!null ws_sales_price:22 c_customer_sk:37!null c_current_addr_sk:41 d_date_sk:72!null d_year:78!null d_qoy:82!null
 │    │    │         │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │    │    │         │    ├── fd: ()-->(78,82), (37)-->(41), (1)==(72), (72)==(1), (5)==(37), (37)==(5)
 │    │    │         │    ├── scan customer
 │    │    │         │    │    ├── columns: c_customer_sk:37!null c_current_addr_sk:41
 │    │    │         │    │    ├── key: (37)
 │    │    │         │    │    └── fd: (37)-->(41)
 │    │    │         │    ├── inner-join (hash)
 │    │    │         │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_bill_customer_sk:5 ws_sales_price:22 d_date_sk:72!null d_year:78!null d_qoy:82!null
 │    │    │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │    │    ├── fd: ()-->(78,82), (1)==(72), (72)==(1)
 │    │    │         │    │    ├── scan web_sales
 │    │    │         │    │    │    └── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_bill_customer_sk:5 ws_sales_price:22
 │    │    │         │    │    ├── select
 │    │    │         │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_qoy:82!null
 │    │    │         │    │    │    ├── key: (72)
 │    │    │         │    │    │    ├── fd: ()-->(78,82)
 │    │    │         │    │    │    ├── scan date_dim
 │    │    │         │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_qoy:82
 │    │    │         │    │    │    │    ├── key: (72)
 │    │    │         │    │    │    │    └── fd: (72)-->(78,82)
 │    │    │         │    │    │    └── filters
 │    │    │         │    │    │         ├── d_qoy:82 = 1 [outer=(82), constraints=(/82: [/1 - /1]; tight), fd=()-->(82)]
 │    │    │         │    │    │         └── d_year:78 = 2000 [outer=(78), constraints=(/78: [/2000 - /2000]; tight), fd=()-->(78)]
 │    │    │         │    │    └── filters
 │    │    │         │    │         └── ws_sold_date_sk:1 = d_date_sk:72 [outer=(1,72), constraints=(/1: (/NULL - ]; /72: (/NULL - ]), fd=(1)==(72), (72)==(1)]
 │    │    │         │    └── filters
 │    │    │         │         └── ws_bill_customer_sk:5 = c_customer_sk:37 [outer=(5,37), constraints=(/5: (/NULL - ]; /37: (/NULL - ]), fd=(5)==(37), (37)==(5)]
 │    │    │         ├── scan customer_address
 │    │    │         │    ├── columns: ca_address_sk:57!null ca_city:63 ca_zip:66
 │    │    │         │    ├── key: (57)
 │    │    │         │    └── fd: (57)-->(63,66)
 │    │    │         └── filters
 │    │    │              └── c_current_addr_sk:41 = ca_address_sk:57 [outer=(41,57), constraints=(/41: (/NULL - ]; /57: (/NULL - ]), fd=(41)==(57), (57)==(41)]
 │    │    └── filters
 │    │         └── or [outer=(66,103), immutable, correlated-subquery]
 │    │              ├── substr(ca_zip:66, 1, 5) IN ('80348', '81792', '83405', '85392', '85460', '85669', '86197', '86475', '88274')
 │    │              └── any: eq
 │    │                   ├── project
 │    │                   │    ├── columns: i_item_id:127!null
 │    │                   │    ├── cardinality: [0 - 10]
 │    │                   │    └── scan item
 │    │                   │         ├── columns: i_item_sk:126!null i_item_id:127!null
 │    │                   │         ├── constraint: /126
 │    │                   │         │    ├── [/2 - /3]
 │    │                   │         │    ├── [/5 - /5]
 │    │                   │         │    ├── [/7 - /7]
 │    │                   │         │    ├── [/11 - /11]
 │    │                   │         │    ├── [/13 - /13]
 │    │                   │         │    ├── [/17 - /17]
 │    │                   │         │    ├── [/19 - /19]
 │    │                   │         │    ├── [/23 - /23]
 │    │                   │         │    └── [/29 - /29]
 │    │                   │         ├── cardinality: [0 - 10]
 │    │                   │         ├── key: (126)
 │    │                   │         └── fd: (126)-->(127)
 │    │                   └── i_item_id:103
 │    └── aggregations
 │         └── sum [as=sum:150, outer=(22)]
 │              └── ws_sales_price:22
 └── 100

# --------------------------------------------------
# Q46
opt
	SELECT
		c_last_name,
		c_first_name,
		ca_city,
		bought_city,
		ss_ticket_number,
		amt,
		profit
	FROM
		(
			SELECT
				ss_ticket_number,
				ss_customer_sk,
				ca_city AS bought_city,
				sum(ss_coupon_amt) AS amt,
				sum(ss_net_profit) AS profit
			FROM
				store_sales,
				date_dim,
				store,
				household_demographics,
				customer_address
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_store_sk = store.s_store_sk
				AND store_sales.ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND store_sales.ss_addr_sk
					= customer_address.ca_address_sk
				AND (
						household_demographics.hd_dep_count = 8
						OR household_demographics.hd_vehicle_count
							= 0
					)
				AND date_dim.d_dow IN (6, 0)
				AND date_dim.d_year
					IN (2000, 2000 + 1, 2000 + 2)
				AND store.s_city
					IN (
							'Midway',
							'Fairview',
							'Fairview',
							'Fairview',
							'Fairview'
						)
			GROUP BY
				ss_ticket_number,
				ss_customer_sk,
				ss_addr_sk,
				ca_city
		)
			AS dn,
		customer,
		customer_address AS current_addr
	WHERE
		ss_customer_sk = c_customer_sk
		AND customer.c_current_addr_sk
			= current_addr.ca_address_sk
		AND current_addr.ca_city != bought_city
	ORDER BY
		c_last_name,
		c_first_name,
		ca_city,
		bought_city,
		ss_ticket_number
	LIMIT
		100;
----
project
 ├── columns: c_last_name:120 c_first_name:119 ca_city:137!null bought_city:100!null ss_ticket_number:10!null amt:109 profit:110
 ├── cardinality: [0 - 100]
 ├── ordering: +120,+119,+137,+100,+10
 └── top-k
      ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100!null sum:109 sum:110 c_customer_sk:111!null c_current_addr_sk:115!null c_first_name:119 c_last_name:120 current_addr.ca_address_sk:131!null current_addr.ca_city:137!null
      ├── internal-ordering: +120,+119,+137,+100,+10
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── key: (7,10,111)
      ├── fd: (7)-->(100), (4,7,10)-->(100,109,110), (111)-->(115,119,120), (131)-->(137), (115)==(131), (131)==(115), (4)==(111), (111)==(4)
      ├── ordering: +120,+119,+137,+100,+10
      └── inner-join (hash)
           ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100!null sum:109 sum:110 c_customer_sk:111!null c_current_addr_sk:115!null c_first_name:119 c_last_name:120 current_addr.ca_address_sk:131!null current_addr.ca_city:137!null
           ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           ├── key: (7,10,111)
           ├── fd: (7)-->(100), (4,7,10)-->(100,109,110), (111)-->(115,119,120), (131)-->(137), (115)==(131), (131)==(115), (4)==(111), (111)==(4)
           ├── inner-join (hash)
           │    ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100 sum:109 sum:110 c_customer_sk:111!null c_current_addr_sk:115 c_first_name:119 c_last_name:120
           │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
           │    ├── key: (7,10,111)
           │    ├── fd: (7)-->(100), (4,7,10)-->(100,109,110), (111)-->(115,119,120), (4)==(111), (111)==(4)
           │    ├── scan customer
           │    │    ├── columns: c_customer_sk:111!null c_current_addr_sk:115 c_first_name:119 c_last_name:120
           │    │    ├── key: (111)
           │    │    └── fd: (111)-->(115,119,120)
           │    ├── group-by (hash)
           │    │    ├── columns: ss_customer_sk:4 ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100 sum:109 sum:110
           │    │    ├── grouping columns: ss_customer_sk:4 ss_addr_sk:7!null ss_ticket_number:10!null
           │    │    ├── key: (4,7,10)
           │    │    ├── fd: (7)-->(100), (4,7,10)-->(100,109,110)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null s_store_sk:56!null s_city:78!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91 customer_address.ca_address_sk:94!null customer_address.ca_city:100
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: (26)-->(32,33), (56)-->(78), (87)-->(90,91), (94)-->(100), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6), (7)==(94), (94)==(7)
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8!null ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null s_store_sk:56!null s_city:78!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    ├── fd: (26)-->(32,33), (56)-->(78), (87)-->(90,91), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6)
           │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    ├── fd: (26)-->(32,33), (87)-->(90,91), (6)==(87), (87)==(6), (1)==(26), (26)==(1)
           │    │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null
           │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    │    ├── fd: (26)-->(32,33), (1)==(26), (26)==(1)
           │    │    │    │    │    │    ├── scan store_sales
           │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23
           │    │    │    │    │    │    ├── select
           │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_dow:33!null
           │    │    │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    │    │    ├── fd: (26)-->(32,33)
           │    │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_dow:33
           │    │    │    │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    │    │    │    └── fd: (26)-->(32,33)
           │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │         ├── d_dow:33 IN (0, 6) [outer=(33), constraints=(/33: [/0 - /0] [/6 - /6]; tight)]
           │    │    │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002]; tight)]
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
           │    │    │    │    │    ├── select
           │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    │    ├── fd: (87)-->(90,91)
           │    │    │    │    │    │    ├── scan household_demographics
           │    │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    │    │    └── fd: (87)-->(90,91)
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── (hd_dep_count:90 = 8) OR (hd_vehicle_count:91 = 0) [outer=(90,91)]
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:87 [outer=(6,87), constraints=(/6: (/NULL - ]; /87: (/NULL - ]), fd=(6)==(87), (87)==(6)]
           │    │    │    │    ├── select
           │    │    │    │    │    ├── columns: s_store_sk:56!null s_city:78!null
           │    │    │    │    │    ├── key: (56)
           │    │    │    │    │    ├── fd: (56)-->(78)
           │    │    │    │    │    ├── scan store
           │    │    │    │    │    │    ├── columns: s_store_sk:56!null s_city:78
           │    │    │    │    │    │    ├── key: (56)
           │    │    │    │    │    │    └── fd: (56)-->(78)
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── s_city:78 IN ('Fairview', 'Midway') [outer=(78), constraints=(/78: [/'Fairview' - /'Fairview'] [/'Midway' - /'Midway']; tight)]
           │    │    │    │    └── filters
           │    │    │    │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
           │    │    │    ├── scan customer_address
           │    │    │    │    ├── columns: customer_address.ca_address_sk:94!null customer_address.ca_city:100
           │    │    │    │    ├── key: (94)
           │    │    │    │    └── fd: (94)-->(100)
           │    │    │    └── filters
           │    │    │         └── ss_addr_sk:7 = customer_address.ca_address_sk:94 [outer=(7,94), constraints=(/7: (/NULL - ]; /94: (/NULL - ]), fd=(7)==(94), (94)==(7)]
           │    │    └── aggregations
           │    │         ├── sum [as=sum:109, outer=(20)]
           │    │         │    └── ss_coupon_amt:20
           │    │         ├── sum [as=sum:110, outer=(23)]
           │    │         │    └── ss_net_profit:23
           │    │         └── const-agg [as=customer_address.ca_city:100, outer=(100)]
           │    │              └── customer_address.ca_city:100
           │    └── filters
           │         └── ss_customer_sk:4 = c_customer_sk:111 [outer=(4,111), constraints=(/4: (/NULL - ]; /111: (/NULL - ]), fd=(4)==(111), (111)==(4)]
           ├── scan customer_address [as=current_addr]
           │    ├── columns: current_addr.ca_address_sk:131!null current_addr.ca_city:137
           │    ├── key: (131)
           │    └── fd: (131)-->(137)
           └── filters
                ├── c_current_addr_sk:115 = current_addr.ca_address_sk:131 [outer=(115,131), constraints=(/115: (/NULL - ]; /131: (/NULL - ]), fd=(115)==(131), (131)==(115)]
                └── current_addr.ca_city:137 != customer_address.ca_city:100 [outer=(100,137), constraints=(/100: (/NULL - ]; /137: (/NULL - ])]

# --------------------------------------------------
# Q47
opt
	WITH
		v1
			AS (
				SELECT
					i_category,
					i_brand,
					s_store_name,
					s_company_name,
					d_year,
					d_moy,
					sum(ss_sales_price) AS sum_sales,
					avg(sum(ss_sales_price)) OVER (
						PARTITION BY
							i_category,
							i_brand,
							s_store_name,
							s_company_name,
							d_year
					)
						AS avg_monthly_sales,
					rank() OVER (
						PARTITION BY
							i_category,
							i_brand,
							s_store_name,
							s_company_name
						ORDER BY
							d_year, d_moy
					)
						AS rn
				FROM
					item, store_sales, date_dim, store
				WHERE
					ss_item_sk = i_item_sk
					AND ss_sold_date_sk = d_date_sk
					AND ss_store_sk = s_store_sk
					AND (
							d_year = 2000
							OR (
									d_year = 2000 - 1
									AND d_moy = 12
								)
							OR (d_year = 2000 + 1 AND d_moy = 1)
						)
				GROUP BY
					i_category,
					i_brand,
					s_store_name,
					s_company_name,
					d_year,
					d_moy
			),
		v2
			AS (
				SELECT
					v1.s_store_name,
					v1.s_company_name,
					v1.d_year,
					v1.avg_monthly_sales,
					v1.sum_sales,
					v1_lag.sum_sales AS psum,
					v1_lead.sum_sales AS nsum
				FROM
					v1, v1 AS v1_lag, v1 AS v1_lead
				WHERE
					v1.i_category = v1_lag.i_category
					AND v1.i_category = v1_lead.i_category
					AND v1.i_brand = v1_lag.i_brand
					AND v1.i_brand = v1_lead.i_brand
					AND v1.s_store_name = v1_lag.s_store_name
					AND v1.s_store_name = v1_lead.s_store_name
					AND v1.s_company_name
						= v1_lag.s_company_name
					AND v1.s_company_name
						= v1_lead.s_company_name
					AND v1.rn = v1_lag.rn + 1
					AND v1.rn = v1_lead.rn - 1
			)
	SELECT
		*
	FROM
		v2
	WHERE
		d_year = 2000
		AND avg_monthly_sales > 0
		AND CASE
			WHEN avg_monthly_sales > 0
			THEN abs(sum_sales - avg_monthly_sales)
			/ avg_monthly_sales
			ELSE NULL
			END
			> 0.1
	ORDER BY
		sum_sales - avg_monthly_sales, nsum
	LIMIT
		100;
----
with &1 (v1)
 ├── columns: s_store_name:144!null s_company_name:145!null d_year:146!null avg_monthly_sales:147!null sum_sales:148 psum:149 nsum:150  [hidden: column151:151]
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── fd: ()-->(146), (147,148)-->(151)
 ├── ordering: +151,+150 opt(146) [actual: +151,+150]
 ├── window partition=(9,13,85,97) ordering=+56,+58 opt(9,13,85,97)
 │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:56!null date_dim.d_moy:58 store.s_store_name:85 store.s_company_name:97 sum:111 avg:112 rank:113
 │    ├── key: (9,13,56,58,85,97)
 │    ├── fd: (9,13,56,58,85,97)-->(111-113)
 │    ├── window partition=(9,13,56,85,97)
 │    │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:56!null date_dim.d_moy:58 store.s_store_name:85 store.s_company_name:97 sum:111 avg:112
 │    │    ├── key: (9,13,56,58,85,97)
 │    │    ├── fd: (9,13,56,58,85,97)-->(111,112)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:56!null date_dim.d_moy:58 store.s_store_name:85 store.s_company_name:97 sum:111
 │    │    │    ├── grouping columns: item.i_brand:9 item.i_category:13 date_dim.d_year:56!null date_dim.d_moy:58 store.s_store_name:85 store.s_company_name:97
 │    │    │    ├── key: (9,13,56,58,85,97)
 │    │    │    ├── fd: (9,13,56,58,85,97)-->(111)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: i_item_sk:1!null item.i_brand:9 item.i_category:13 ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32!null ss_sales_price:38 d_date_sk:50!null date_dim.d_year:56!null date_dim.d_moy:58 s_store_sk:80!null store.s_store_name:85 store.s_company_name:97
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (1)-->(9,13), (50)-->(56,58), (80)-->(85,97), (25)==(50), (50)==(25), (32)==(80), (80)==(32), (1)==(27), (27)==(1)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32!null ss_sales_price:38 d_date_sk:50!null date_dim.d_year:56!null date_dim.d_moy:58 s_store_sk:80!null store.s_store_name:85 store.s_company_name:97
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (50)-->(56,58), (80)-->(85,97), (25)==(50), (50)==(25), (32)==(80), (80)==(32)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38 d_date_sk:50!null date_dim.d_year:56!null date_dim.d_moy:58
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (50)-->(56,58), (25)==(50), (50)==(25)
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:25 ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: d_date_sk:50!null date_dim.d_year:56!null date_dim.d_moy:58
 │    │    │    │    │    │    │    ├── key: (50)
 │    │    │    │    │    │    │    ├── fd: (50)-->(56,58)
 │    │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    │    ├── columns: d_date_sk:50!null date_dim.d_year:56 date_dim.d_moy:58
 │    │    │    │    │    │    │    │    ├── key: (50)
 │    │    │    │    │    │    │    │    └── fd: (50)-->(56,58)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ((date_dim.d_year:56 = 2000) OR ((date_dim.d_year:56 = 1999) AND (date_dim.d_moy:58 = 12))) OR ((date_dim.d_year:56 = 2001) AND (date_dim.d_moy:58 = 1)) [outer=(56,58), constraints=(/56: [/1999 - /1999] [/2000 - /2000] [/2001 - /2001])]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_sold_date_sk:25 = d_date_sk:50 [outer=(25,50), constraints=(/25: (/NULL - ]; /50: (/NULL - ]), fd=(25)==(50), (50)==(25)]
 │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    ├── columns: s_store_sk:80!null store.s_store_name:85 store.s_company_name:97
 │    │    │    │    │    │    ├── key: (80)
 │    │    │    │    │    │    └── fd: (80)-->(85,97)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_store_sk:32 = s_store_sk:80 [outer=(32,80), constraints=(/32: (/NULL - ]; /80: (/NULL - ]), fd=(32)==(80), (80)==(32)]
 │    │    │    │    ├── scan item
 │    │    │    │    │    ├── columns: i_item_sk:1!null item.i_brand:9 item.i_category:13
 │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    └── fd: (1)-->(9,13)
 │    │    │    │    └── filters
 │    │    │    │         └── ss_item_sk:27 = i_item_sk:1 [outer=(1,27), constraints=(/1: (/NULL - ]; /27: (/NULL - ]), fd=(1)==(27), (27)==(1)]
 │    │    │    └── aggregations
 │    │    │         └── sum [as=sum:111, outer=(38)]
 │    │    │              └── ss_sales_price:38
 │    │    └── windows
 │    │         └── avg [as=avg:112, outer=(111)]
 │    │              └── sum:111
 │    └── windows
 │         └── rank [as=rank:113]
 └── top-k
      ├── columns: s_store_name:144!null s_company_name:145!null d_year:146!null avg_monthly_sales:147!null sum_sales:148 psum:149 nsum:150 column151:151
      ├── internal-ordering: +151,+150 opt(146)
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── fd: ()-->(146), (147,148)-->(151)
      ├── ordering: +151,+150 opt(146) [actual: +151,+150]
      └── project
           ├── columns: column151:151 s_store_name:144!null s_company_name:145!null d_year:146!null avg_monthly_sales:147!null sum_sales:148 psum:149 nsum:150
           ├── immutable
           ├── fd: ()-->(146), (147,148)-->(151)
           ├── project
           │    ├── columns: s_store_name:144!null s_company_name:145!null d_year:146!null avg_monthly_sales:147!null sum_sales:148 psum:149 nsum:150
           │    ├── immutable
           │    ├── fd: ()-->(146)
           │    ├── inner-join (hash)
           │    │    ├── columns: i_category:114!null i_brand:115!null s_store_name:116!null s_company_name:117!null d_year:118!null sum_sales:120 avg_monthly_sales:121!null rn:122!null i_category:123!null i_brand:124!null s_store_name:125!null s_company_name:126!null sum_sales:129 sum_sales:138 column141:141!null
           │    │    ├── immutable
           │    │    ├── fd: ()-->(118), (114)==(123), (123)==(114), (115)==(124), (124)==(115), (116)==(125), (125)==(116), (117)==(126), (126)==(117), (122)==(141), (141)==(122)
           │    │    ├── select
           │    │    │    ├── columns: i_category:114 i_brand:115 s_store_name:116 s_company_name:117 d_year:118!null sum_sales:120 avg_monthly_sales:121!null rn:122
           │    │    │    ├── immutable
           │    │    │    ├── fd: ()-->(118)
           │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    ├── columns: i_category:114 i_brand:115 s_store_name:116 s_company_name:117 d_year:118!null sum_sales:120 avg_monthly_sales:121 rn:122
           │    │    │    │    └── mapping:
           │    │    │    │         ├──  item.i_category:13 => i_category:114
           │    │    │    │         ├──  item.i_brand:9 => i_brand:115
           │    │    │    │         ├──  store.s_store_name:85 => s_store_name:116
           │    │    │    │         ├──  store.s_company_name:97 => s_company_name:117
           │    │    │    │         ├──  date_dim.d_year:56 => d_year:118
           │    │    │    │         ├──  sum:111 => sum_sales:120
           │    │    │    │         ├──  avg:112 => avg_monthly_sales:121
           │    │    │    │         └──  rank:113 => rn:122
           │    │    │    └── filters
           │    │    │         ├── d_year:118 = 2000 [outer=(118), constraints=(/118: [/2000 - /2000]; tight), fd=()-->(118)]
           │    │    │         ├── avg_monthly_sales:121 > 0 [outer=(121), immutable, constraints=(/121: (/0 - ]; tight)]
           │    │    │         └── CASE WHEN avg_monthly_sales:121 > 0 THEN abs(sum_sales:120 - avg_monthly_sales:121) / avg_monthly_sales:121 ELSE CAST(NULL AS DECIMAL) END > 0.1 [outer=(120,121), immutable]
           │    │    ├── project
           │    │    │    ├── columns: column141:141 i_category:123!null i_brand:124!null s_store_name:125!null s_company_name:126!null sum_sales:129 sum_sales:138
           │    │    │    ├── immutable
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: i_category:123!null i_brand:124!null s_store_name:125!null s_company_name:126!null sum_sales:129 rn:131 i_category:132!null i_brand:133!null s_store_name:134!null s_company_name:135!null sum_sales:138 column142:142!null column143:143!null
           │    │    │    │    ├── immutable
           │    │    │    │    ├── fd: (131)-->(142), (123)==(132), (132)==(123), (124)==(133), (133)==(124), (125)==(134), (134)==(125), (126)==(135), (135)==(126), (142)==(143), (143)==(142)
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: column142:142 i_category:123 i_brand:124 s_store_name:125 s_company_name:126 sum_sales:129 rn:131
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── fd: (131)-->(142)
           │    │    │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    │    │    ├── columns: i_category:123 i_brand:124 s_store_name:125 s_company_name:126 sum_sales:129 rn:131
           │    │    │    │    │    │    └── mapping:
           │    │    │    │    │    │         ├──  item.i_category:13 => i_category:123
           │    │    │    │    │    │         ├──  item.i_brand:9 => i_brand:124
           │    │    │    │    │    │         ├──  store.s_store_name:85 => s_store_name:125
           │    │    │    │    │    │         ├──  store.s_company_name:97 => s_company_name:126
           │    │    │    │    │    │         ├──  sum:111 => sum_sales:129
           │    │    │    │    │    │         └──  rank:113 => rn:131
           │    │    │    │    │    └── projections
           │    │    │    │    │         └── rn:131 + 1 [as=column142:142, outer=(131), immutable]
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: column143:143 i_category:132 i_brand:133 s_store_name:134 s_company_name:135 sum_sales:138
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    │    │    ├── columns: i_category:132 i_brand:133 s_store_name:134 s_company_name:135 sum_sales:138 rn:140
           │    │    │    │    │    │    └── mapping:
           │    │    │    │    │    │         ├──  item.i_category:13 => i_category:132
           │    │    │    │    │    │         ├──  item.i_brand:9 => i_brand:133
           │    │    │    │    │    │         ├──  store.s_store_name:85 => s_store_name:134
           │    │    │    │    │    │         ├──  store.s_company_name:97 => s_company_name:135
           │    │    │    │    │    │         ├──  sum:111 => sum_sales:138
           │    │    │    │    │    │         └──  rank:113 => rn:140
           │    │    │    │    │    └── projections
           │    │    │    │    │         └── rn:140 - 1 [as=column143:143, outer=(140), immutable]
           │    │    │    │    └── filters
           │    │    │    │         ├── i_category:123 = i_category:132 [outer=(123,132), constraints=(/123: (/NULL - ]; /132: (/NULL - ]), fd=(123)==(132), (132)==(123)]
           │    │    │    │         ├── i_brand:124 = i_brand:133 [outer=(124,133), constraints=(/124: (/NULL - ]; /133: (/NULL - ]), fd=(124)==(133), (133)==(124)]
           │    │    │    │         ├── s_store_name:125 = s_store_name:134 [outer=(125,134), constraints=(/125: (/NULL - ]; /134: (/NULL - ]), fd=(125)==(134), (134)==(125)]
           │    │    │    │         ├── s_company_name:126 = s_company_name:135 [outer=(126,135), constraints=(/126: (/NULL - ]; /135: (/NULL - ]), fd=(126)==(135), (135)==(126)]
           │    │    │    │         └── column142:142 = column143:143 [outer=(142,143), constraints=(/142: (/NULL - ]; /143: (/NULL - ]), fd=(142)==(143), (143)==(142)]
           │    │    │    └── projections
           │    │    │         └── rn:131 + 1 [as=column141:141, outer=(131), immutable]
           │    │    └── filters
           │    │         ├── i_category:114 = i_category:123 [outer=(114,123), constraints=(/114: (/NULL - ]; /123: (/NULL - ]), fd=(114)==(123), (123)==(114)]
           │    │         ├── i_brand:115 = i_brand:124 [outer=(115,124), constraints=(/115: (/NULL - ]; /124: (/NULL - ]), fd=(115)==(124), (124)==(115)]
           │    │         ├── s_store_name:116 = s_store_name:125 [outer=(116,125), constraints=(/116: (/NULL - ]; /125: (/NULL - ]), fd=(116)==(125), (125)==(116)]
           │    │         ├── s_company_name:117 = s_company_name:126 [outer=(117,126), constraints=(/117: (/NULL - ]; /126: (/NULL - ]), fd=(117)==(126), (126)==(117)]
           │    │         └── rn:122 = column141:141 [outer=(122,141), constraints=(/122: (/NULL - ]; /141: (/NULL - ]), fd=(122)==(141), (141)==(122)]
           │    └── projections
           │         ├── s_store_name:116 [as=s_store_name:144, outer=(116)]
           │         ├── s_company_name:117 [as=s_company_name:145, outer=(117)]
           │         ├── d_year:118 [as=d_year:146, outer=(118)]
           │         ├── avg_monthly_sales:121 [as=avg_monthly_sales:147, outer=(121)]
           │         ├── sum_sales:120 [as=sum_sales:148, outer=(120)]
           │         ├── sum_sales:129 [as=psum:149, outer=(129)]
           │         └── sum_sales:138 [as=nsum:150, outer=(138)]
           └── projections
                └── sum_sales:148 - avg_monthly_sales:147 [as=column151:151, outer=(147,148), immutable]

# --------------------------------------------------
# Q48
opt
	SELECT
		sum(ss_quantity)
	FROM
		store_sales,
		store,
		customer_demographics,
		customer_address,
		date_dim
	WHERE
		s_store_sk = ss_store_sk
		AND ss_sold_date_sk = d_date_sk
		AND d_year = 2001
		AND (
				(
					cd_demo_sk = ss_cdemo_sk
					AND cd_marital_status = 'S'
					AND cd_education_status = 'Secondary'
					AND ss_sales_price BETWEEN 100.00 AND 150.00
				)
				OR (
						cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'M'
						AND cd_education_status = '2 yr Degree'
						AND ss_sales_price BETWEEN 50.00 AND 100.00
					)
				OR (
						cd_demo_sk = ss_cdemo_sk
						AND cd_marital_status = 'D'
						AND cd_education_status
							= 'Advanced Degree'
						AND ss_sales_price BETWEEN 150.00 AND 200.00
					)
			)
		AND (
				(
					ss_addr_sk = ca_address_sk
					AND ca_country = 'United States'
					AND ca_state IN ('ND', 'NY', 'SD')
					AND ss_net_profit BETWEEN 0 AND 2000
				)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('MD', 'GA', 'KS')
						AND ss_net_profit BETWEEN 150 AND 3000
					)
				OR (
						ss_addr_sk = ca_address_sk
						AND ca_country = 'United States'
						AND ca_state IN ('CO', 'MN', 'NC')
						AND ss_net_profit BETWEEN 50 AND 25000
					)
			);
----
scalar-group-by
 ├── columns: sum:113
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(113)
 ├── inner-join (lookup customer_demographics)
 │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5!null ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14!null ss_net_profit:23!null s_store_sk:26!null cd_demo_sk:57!null cd_marital_status:59!null cd_education_status:60!null ca_address_sk:68!null ca_state:76!null ca_country:78!null d_date_sk:83!null d_year:89!null
 │    ├── key columns: [5] = [57]
 │    ├── lookup columns are key
 │    ├── immutable
 │    ├── fd: ()-->(78,89), (57)-->(59,60), (68)-->(76), (8)==(26), (26)==(8), (5)==(57), (57)==(5), (7)==(68), (68)==(7), (1)==(83), (83)==(1)
 │    ├── inner-join (hash)
 │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_addr_sk:7!null ss_store_sk:8!null ss_quantity:11 ss_sales_price:14 ss_net_profit:23!null s_store_sk:26!null ca_address_sk:68!null ca_state:76!null ca_country:78!null d_date_sk:83!null d_year:89!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── immutable
 │    │    ├── fd: ()-->(78,89), (68)-->(76), (1)==(83), (83)==(1), (7)==(68), (68)==(7), (8)==(26), (26)==(8)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_addr_sk:7!null ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_net_profit:23!null ca_address_sk:68!null ca_state:76!null ca_country:78!null d_date_sk:83!null d_year:89!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── immutable
 │    │    │    ├── fd: ()-->(78,89), (68)-->(76), (1)==(83), (83)==(1), (7)==(68), (68)==(7)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_cdemo_sk:5 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_net_profit:23 d_date_sk:83!null d_year:89!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(89), (1)==(83), (83)==(1)
 │    │    │    │    ├── scan store_sales
 │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_cdemo_sk:5 ss_addr_sk:7 ss_store_sk:8 ss_quantity:11 ss_sales_price:14 ss_net_profit:23
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: d_date_sk:83!null d_year:89!null
 │    │    │    │    │    ├── key: (83)
 │    │    │    │    │    ├── fd: ()-->(89)
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:83!null d_year:89
 │    │    │    │    │    │    ├── key: (83)
 │    │    │    │    │    │    └── fd: (83)-->(89)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── d_year:89 = 2001 [outer=(89), constraints=(/89: [/2001 - /2001]; tight), fd=()-->(89)]
 │    │    │    │    └── filters
 │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:83 [outer=(1,83), constraints=(/1: (/NULL - ]; /83: (/NULL - ]), fd=(1)==(83), (83)==(1)]
 │    │    │    ├── select
 │    │    │    │    ├── columns: ca_address_sk:68!null ca_state:76 ca_country:78!null
 │    │    │    │    ├── key: (68)
 │    │    │    │    ├── fd: ()-->(78), (68)-->(76)
 │    │    │    │    ├── scan customer_address
 │    │    │    │    │    ├── columns: ca_address_sk:68!null ca_state:76 ca_country:78
 │    │    │    │    │    ├── key: (68)
 │    │    │    │    │    └── fd: (68)-->(76,78)
 │    │    │    │    └── filters
 │    │    │    │         └── ca_country:78 = 'United States' [outer=(78), constraints=(/78: [/'United States' - /'United States']; tight), fd=()-->(78)]
 │    │    │    └── filters
 │    │    │         ├── ss_addr_sk:7 = ca_address_sk:68 [outer=(7,68), constraints=(/7: (/NULL - ]; /68: (/NULL - ]), fd=(7)==(68), (68)==(7)]
 │    │    │         └── ((((ca_state:76 IN ('ND', 'NY', 'SD')) AND (ss_net_profit:23 >= 0)) AND (ss_net_profit:23 <= 2000)) OR (((ca_state:76 IN ('GA', 'KS', 'MD')) AND (ss_net_profit:23 >= 150)) AND (ss_net_profit:23 <= 3000))) OR (((ca_state:76 IN ('CO', 'MN', 'NC')) AND (ss_net_profit:23 >= 50)) AND (ss_net_profit:23 <= 25000)) [outer=(23,76), immutable, constraints=(/23: [/0 - /25000]; /76: [/'CO' - /'CO'] [/'GA' - /'GA'] [/'KS' - /'KS'] [/'MD' - /'MD'] [/'MN' - /'MN'] [/'NC' - /'NC'] [/'ND' - /'ND'] [/'NY' - /'NY'] [/'SD' - /'SD'])]
 │    │    ├── scan store
 │    │    │    ├── columns: s_store_sk:26!null
 │    │    │    └── key: (26)
 │    │    └── filters
 │    │         └── s_store_sk:26 = ss_store_sk:8 [outer=(8,26), constraints=(/8: (/NULL - ]; /26: (/NULL - ]), fd=(8)==(26), (26)==(8)]
 │    └── filters
 │         └── (((((cd_marital_status:59 = 'S') AND (cd_education_status:60 = 'Secondary')) AND (ss_sales_price:14 >= 100.00)) AND (ss_sales_price:14 <= 150.00)) OR ((((cd_marital_status:59 = 'M') AND (cd_education_status:60 = '2 yr Degree')) AND (ss_sales_price:14 >= 50.00)) AND (ss_sales_price:14 <= 100.00))) OR ((((cd_marital_status:59 = 'D') AND (cd_education_status:60 = 'Advanced Degree')) AND (ss_sales_price:14 >= 150.00)) AND (ss_sales_price:14 <= 200.00)) [outer=(14,59,60), immutable, constraints=(/14: [/50.00 - /200.00]; /59: [/'D' - /'D'] [/'M' - /'M'] [/'S' - /'S']; /60: [/'2 yr Degree' - /'2 yr Degree'] [/'Advanced Degree' - /'Advanced Degree'] [/'Secondary' - /'Secondary'])]
 └── aggregations
      └── sum [as=sum:113, outer=(11)]
           └── ss_quantity:11

# --------------------------------------------------
# Q49
opt
	SELECT
		channel, item, return_ratio, return_rank, currency_rank
	FROM
		(
			SELECT
				'web' AS channel,
				web.item,
				web.return_ratio,
				web.return_rank,
				web.currency_rank
			FROM
				(
					SELECT
						item,
						return_ratio,
						currency_ratio,
						rank() OVER (ORDER BY return_ratio)
							AS return_rank,
						rank() OVER (ORDER BY currency_ratio)
							AS currency_rank
					FROM
						(
							SELECT
								ws.ws_item_sk AS item,
								CAST(
									sum(
										COALESCE(
											wr.wr_return_quantity,
											0
										)
									)
										AS DECIMAL(15,4)
								)
								/ CAST(
										sum(
											COALESCE(
												ws.ws_quantity,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									AS return_ratio,
								CAST(
									sum(
										COALESCE(
											wr.wr_return_amt,
											0
										)
									)
										AS DECIMAL(15,4)
								)
								/ CAST(
										sum(
											COALESCE(
												ws.ws_net_paid,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									AS currency_ratio
							FROM
								web_sales AS ws
								LEFT JOIN web_returns AS wr ON
										ws.ws_order_number
										= wr.wr_order_number
										AND ws.ws_item_sk
											= wr.wr_item_sk,
								date_dim
							WHERE
								wr.wr_return_amt > 10000
								AND ws.ws_net_profit > 1
								AND ws.ws_net_paid > 0
								AND ws.ws_quantity > 0
								AND ws_sold_date_sk = d_date_sk
								AND d_year = 1998
								AND d_moy = 11
							GROUP BY
								ws.ws_item_sk
						)
							AS in_web
				)
					AS web
			WHERE
				web.return_rank <= 10 OR web.currency_rank <= 10
			UNION
				SELECT
					'catalog' AS channel,
					catalog.item,
					catalog.return_ratio,
					catalog.return_rank,
					catalog.currency_rank
				FROM
					(
						SELECT
							item,
							return_ratio,
							currency_ratio,
							rank() OVER (ORDER BY return_ratio)
								AS return_rank,
							rank() OVER (
								ORDER BY currency_ratio
							)
								AS currency_rank
						FROM
							(
								SELECT
									cs.cs_item_sk AS item,
									CAST(
										sum(
											COALESCE(
												cr.cr_return_quantity,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									/ CAST(
											sum(
												COALESCE(
													cs.cs_quantity,
													0
												)
											)
												AS DECIMAL(15,4)
										)
										AS return_ratio,
									CAST(
										sum(
											COALESCE(
												cr.cr_return_amount,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									/ CAST(
											sum(
												COALESCE(
													cs.cs_net_paid,
													0
												)
											)
												AS DECIMAL(15,4)
										)
										AS currency_ratio
								FROM
									catalog_sales AS cs
									LEFT JOIN catalog_returns
											AS cr ON
											cs.cs_order_number
											= cr.cr_order_number
											AND cs.cs_item_sk
												= cr.cr_item_sk,
									date_dim
								WHERE
									cr.cr_return_amount > 10000
									AND cs.cs_net_profit > 1
									AND cs.cs_net_paid > 0
									AND cs.cs_quantity > 0
									AND cs_sold_date_sk
										= d_date_sk
									AND d_year = 1998
									AND d_moy = 11
								GROUP BY
									cs.cs_item_sk
							)
								AS in_cat
					)
						AS catalog
				WHERE
					catalog.return_rank <= 10
					OR catalog.currency_rank <= 10
			UNION
				SELECT
					'store' AS channel,
					store.item,
					store.return_ratio,
					store.return_rank,
					store.currency_rank
				FROM
					(
						SELECT
							item,
							return_ratio,
							currency_ratio,
							rank() OVER (ORDER BY return_ratio)
								AS return_rank,
							rank() OVER (
								ORDER BY currency_ratio
							)
								AS currency_rank
						FROM
							(
								SELECT
									sts.ss_item_sk AS item,
									CAST(
										sum(
											COALESCE(
												sr.sr_return_quantity,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									/ CAST(
											sum(
												COALESCE(
													sts.ss_quantity,
													0
												)
											)
												AS DECIMAL(15,4)
										)
										AS return_ratio,
									CAST(
										sum(
											COALESCE(
												sr.sr_return_amt,
												0
											)
										)
											AS DECIMAL(15,4)
									)
									/ CAST(
											sum(
												COALESCE(
													sts.ss_net_paid,
													0
												)
											)
												AS DECIMAL(15,4)
										)
										AS currency_ratio
								FROM
									store_sales AS sts
									LEFT JOIN store_returns
											AS sr ON
											sts.ss_ticket_number
											= sr.sr_ticket_number
											AND sts.ss_item_sk
												= sr.sr_item_sk,
									date_dim
								WHERE
									sr.sr_return_amt > 10000
									AND sts.ss_net_profit > 1
									AND sts.ss_net_paid > 0
									AND sts.ss_quantity > 0
									AND ss_sold_date_sk
										= d_date_sk
									AND d_year = 1998
									AND d_moy = 11
								GROUP BY
									sts.ss_item_sk
							)
								AS in_store
					)
						AS store
				WHERE
					store.return_rank <= 10
					OR store.currency_rank <= 10
		)
	ORDER BY
		1, 4, 5, 2
	LIMIT
		100;
----
limit
 ├── columns: channel:315!null item:316!null return_ratio:317 return_rank:318 currency_rank:319
 ├── internal-ordering: +315,+318,+319,+316
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (315-319)
 ├── ordering: +315,+318,+319,+316
 ├── union
 │    ├── columns: channel:315!null item:316!null return_ratio:317 return_rank:318 currency_rank:319
 │    ├── left columns: channel:218 item:219 return_ratio:220 return_rank:221 currency_rank:222
 │    ├── right columns: channel:314 ss_item_sk:225 return_ratio:308 rank:310 rank:311
 │    ├── immutable
 │    ├── key: (315-319)
 │    ├── ordering: +315,+318,+319,+316
 │    ├── limit hint: 100.00
 │    ├── union
 │    │    ├── columns: channel:218!null item:219!null return_ratio:220 return_rank:221 currency_rank:222
 │    │    ├── left columns: channel:107 ws_item_sk:4 return_ratio:101 rank:103 rank:104
 │    │    ├── right columns: channel:217 cs_item_sk:123 return_ratio:211 rank:213 rank:214
 │    │    ├── immutable
 │    │    ├── key: (218-222)
 │    │    ├── ordering: +218,+221,+222,+219,+220
 │    │    ├── limit hint: 100.00
 │    │    ├── sort
 │    │    │    ├── columns: ws_item_sk:4!null return_ratio:101 rank:103 rank:104 channel:107!null
 │    │    │    ├── immutable
 │    │    │    ├── key: (4)
 │    │    │    ├── fd: ()-->(107), (4)-->(101,103,104)
 │    │    │    ├── ordering: +103,+104,+4 opt(107) [actual: +103,+104,+4]
 │    │    │    ├── limit hint: 100.00
 │    │    │    └── project
 │    │    │         ├── columns: channel:107!null ws_item_sk:4!null return_ratio:101 rank:103 rank:104
 │    │    │         ├── immutable
 │    │    │         ├── key: (4)
 │    │    │         ├── fd: ()-->(107), (4)-->(101,103,104)
 │    │    │         ├── select
 │    │    │         │    ├── columns: ws_item_sk:4!null return_ratio:101 currency_ratio:102 rank:103 rank:104 rank_1_orderby_1_1:105 rank_2_orderby_1_1:106
 │    │    │         │    ├── immutable
 │    │    │         │    ├── key: (4)
 │    │    │         │    ├── fd: (4)-->(101-104), (101)==(105), (105)==(101), (102)==(106), (106)==(102)
 │    │    │         │    ├── window partition=() ordering=+(102|106)
 │    │    │         │    │    ├── columns: ws_item_sk:4!null return_ratio:101 currency_ratio:102 rank:103 rank:104 rank_1_orderby_1_1:105 rank_2_orderby_1_1:106
 │    │    │         │    │    ├── immutable
 │    │    │         │    │    ├── key: (4)
 │    │    │         │    │    ├── fd: (4)-->(101-104), (101)==(105), (105)==(101), (102)==(106), (106)==(102)
 │    │    │         │    │    ├── window partition=() ordering=+(101|105)
 │    │    │         │    │    │    ├── columns: ws_item_sk:4!null return_ratio:101 currency_ratio:102 rank:103 rank_1_orderby_1_1:105 rank_2_orderby_1_1:106
 │    │    │         │    │    │    ├── immutable
 │    │    │         │    │    │    ├── key: (4)
 │    │    │         │    │    │    ├── fd: (4)-->(101-103), (101)==(105), (105)==(101), (102)==(106), (106)==(102)
 │    │    │         │    │    │    ├── project
 │    │    │         │    │    │    │    ├── columns: rank_1_orderby_1_1:105 rank_2_orderby_1_1:106 ws_item_sk:4!null return_ratio:101 currency_ratio:102
 │    │    │         │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    ├── key: (4)
 │    │    │         │    │    │    │    ├── fd: (4)-->(101,102), (101)==(105), (105)==(101), (102)==(106), (106)==(102)
 │    │    │         │    │    │    │    ├── project
 │    │    │         │    │    │    │    │    ├── columns: return_ratio:101 currency_ratio:102 ws_item_sk:4!null
 │    │    │         │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    ├── key: (4)
 │    │    │         │    │    │    │    │    ├── fd: (4)-->(101,102)
 │    │    │         │    │    │    │    │    ├── group-by (streaming)
 │    │    │         │    │    │    │    │    │    ├── columns: ws_item_sk:4!null sum:94 sum:96 sum:98 sum:100
 │    │    │         │    │    │    │    │    │    ├── grouping columns: ws_item_sk:4!null
 │    │    │         │    │    │    │    │    │    ├── internal-ordering: +4
 │    │    │         │    │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    │    ├── key: (4)
 │    │    │         │    │    │    │    │    │    ├── fd: (4)-->(94,96,98,100)
 │    │    │         │    │    │    │    │    │    ├── project
 │    │    │         │    │    │    │    │    │    │    ├── columns: column93:93 column95:95 column97:97 column99:99 ws_item_sk:4!null
 │    │    │         │    │    │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    │    │    ├── ordering: +4
 │    │    │         │    │    │    │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │         │    │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_order_number:18!null ws_quantity:19!null ws_net_paid:30!null ws_net_profit:34!null wr_item_sk:39!null wr_order_number:50!null wr_return_quantity:51 wr_return_amt:52!null d_date_sk:63!null d_year:69!null d_moy:71!null
 │    │    │         │    │    │    │    │    │    │    │    ├── key columns: [1] = [63]
 │    │    │         │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    │    │    │    ├── key: (39,50)
 │    │    │         │    │    │    │    │    │    │    │    ├── fd: ()-->(69,71), (4,18)-->(1,19,30,34), (39,50)-->(51,52), (18)==(50), (50)==(18), (4)==(39), (39)==(4), (1)==(63), (63)==(1)
 │    │    │         │    │    │    │    │    │    │    │    ├── ordering: +(4|39) opt(69,71) [actual: +39]
 │    │    │         │    │    │    │    │    │    │    │    ├── inner-join (lookup web_sales [as=ws])
 │    │    │         │    │    │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_order_number:18!null ws_quantity:19!null ws_net_paid:30!null ws_net_profit:34!null wr_item_sk:39!null wr_order_number:50!null wr_return_quantity:51 wr_return_amt:52!null
 │    │    │         │    │    │    │    │    │    │    │    │    ├── key columns: [39 50] = [4 18]
 │    │    │         │    │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    │    │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    │    │    │    │    ├── key: (39,50)
 │    │    │         │    │    │    │    │    │    │    │    │    ├── fd: (4,18)-->(1,19,30,34), (39,50)-->(51,52), (18)==(50), (50)==(18), (4)==(39), (39)==(4)
 │    │    │         │    │    │    │    │    │    │    │    │    ├── ordering: +(4|39) [actual: +39]
 │    │    │         │    │    │    │    │    │    │    │    │    ├── select
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── columns: wr_item_sk:39!null wr_order_number:50!null wr_return_quantity:51 wr_return_amt:52!null
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── immutable
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── key: (39,50)
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── fd: (39,50)-->(51,52)
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── ordering: +39
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── scan web_returns [as=wr]
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── columns: wr_item_sk:39!null wr_order_number:50!null wr_return_quantity:51 wr_return_amt:52
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── key: (39,50)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── fd: (39,50)-->(51,52)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    └── ordering: +39
 │    │    │         │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │    │    │    │    │    │         └── wr_return_amt:52 > 10000 [outer=(52), immutable, constraints=(/52: (/10000 - ]; tight)]
 │    │    │         │    │    │    │    │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │    │    │    │    │         ├── ws_net_profit:34 > 1 [outer=(34), immutable, constraints=(/34: (/1 - ]; tight)]
 │    │    │         │    │    │    │    │    │    │    │    │         ├── ws_net_paid:30 > 0 [outer=(30), immutable, constraints=(/30: (/0 - ]; tight)]
 │    │    │         │    │    │    │    │    │    │    │    │         └── ws_quantity:19 > 0 [outer=(19), constraints=(/19: [/1 - ]; tight)]
 │    │    │         │    │    │    │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │    │    │    │         ├── d_year:69 = 1998 [outer=(69), constraints=(/69: [/1998 - /1998]; tight), fd=()-->(69)]
 │    │    │         │    │    │    │    │    │    │    │         └── d_moy:71 = 11 [outer=(71), constraints=(/71: [/11 - /11]; tight), fd=()-->(71)]
 │    │    │         │    │    │    │    │    │    │    └── projections
 │    │    │         │    │    │    │    │    │    │         ├── COALESCE(wr_return_quantity:51, 0) [as=column93:93, outer=(51)]
 │    │    │         │    │    │    │    │    │    │         ├── COALESCE(ws_quantity:19, 0) [as=column95:95, outer=(19)]
 │    │    │         │    │    │    │    │    │    │         ├── COALESCE(wr_return_amt:52::DECIMAL, 0) [as=column97:97, outer=(52), immutable]
 │    │    │         │    │    │    │    │    │    │         └── COALESCE(ws_net_paid:30::DECIMAL, 0) [as=column99:99, outer=(30), immutable]
 │    │    │         │    │    │    │    │    │    └── aggregations
 │    │    │         │    │    │    │    │    │         ├── sum [as=sum:94, outer=(93)]
 │    │    │         │    │    │    │    │    │         │    └── column93:93
 │    │    │         │    │    │    │    │    │         ├── sum [as=sum:96, outer=(95)]
 │    │    │         │    │    │    │    │    │         │    └── column95:95
 │    │    │         │    │    │    │    │    │         ├── sum [as=sum:98, outer=(97)]
 │    │    │         │    │    │    │    │    │         │    └── column97:97
 │    │    │         │    │    │    │    │    │         └── sum [as=sum:100, outer=(99)]
 │    │    │         │    │    │    │    │    │              └── column99:99
 │    │    │         │    │    │    │    │    └── projections
 │    │    │         │    │    │    │    │         ├── sum:94::DECIMAL(15,4) / sum:96::DECIMAL(15,4) [as=return_ratio:101, outer=(94,96), immutable]
 │    │    │         │    │    │    │    │         └── sum:98::DECIMAL(15,4) / sum:100::DECIMAL(15,4) [as=currency_ratio:102, outer=(98,100), immutable]
 │    │    │         │    │    │    │    └── projections
 │    │    │         │    │    │    │         ├── return_ratio:101 [as=rank_1_orderby_1_1:105, outer=(101)]
 │    │    │         │    │    │    │         └── currency_ratio:102 [as=rank_2_orderby_1_1:106, outer=(102)]
 │    │    │         │    │    │    └── windows
 │    │    │         │    │    │         └── rank [as=rank:103]
 │    │    │         │    │    └── windows
 │    │    │         │    │         └── rank [as=rank:104]
 │    │    │         │    └── filters
 │    │    │         │         └── (rank:103 <= 10) OR (rank:104 <= 10) [outer=(103,104)]
 │    │    │         └── projections
 │    │    │              └── 'web' [as=channel:107]
 │    │    └── sort
 │    │         ├── columns: cs_item_sk:123!null return_ratio:211 rank:213 rank:214 channel:217!null
 │    │         ├── immutable
 │    │         ├── key: (123)
 │    │         ├── fd: ()-->(217), (123)-->(211,213,214)
 │    │         ├── ordering: +213,+214,+123 opt(217) [actual: +213,+214,+123]
 │    │         ├── limit hint: 100.00
 │    │         └── project
 │    │              ├── columns: channel:217!null cs_item_sk:123!null return_ratio:211 rank:213 rank:214
 │    │              ├── immutable
 │    │              ├── key: (123)
 │    │              ├── fd: ()-->(217), (123)-->(211,213,214)
 │    │              ├── select
 │    │              │    ├── columns: cs_item_sk:123!null return_ratio:211 currency_ratio:212 rank:213 rank:214 rank_1_orderby_1_1:215 rank_2_orderby_1_1:216
 │    │              │    ├── immutable
 │    │              │    ├── key: (123)
 │    │              │    ├── fd: (123)-->(211-214), (211)==(215), (215)==(211), (212)==(216), (216)==(212)
 │    │              │    ├── window partition=() ordering=+(212|216)
 │    │              │    │    ├── columns: cs_item_sk:123!null return_ratio:211 currency_ratio:212 rank:213 rank:214 rank_1_orderby_1_1:215 rank_2_orderby_1_1:216
 │    │              │    │    ├── immutable
 │    │              │    │    ├── key: (123)
 │    │              │    │    ├── fd: (123)-->(211-214), (211)==(215), (215)==(211), (212)==(216), (216)==(212)
 │    │              │    │    ├── window partition=() ordering=+(211|215)
 │    │              │    │    │    ├── columns: cs_item_sk:123!null return_ratio:211 currency_ratio:212 rank:213 rank_1_orderby_1_1:215 rank_2_orderby_1_1:216
 │    │              │    │    │    ├── immutable
 │    │              │    │    │    ├── key: (123)
 │    │              │    │    │    ├── fd: (123)-->(211-213), (211)==(215), (215)==(211), (212)==(216), (216)==(212)
 │    │              │    │    │    ├── project
 │    │              │    │    │    │    ├── columns: rank_1_orderby_1_1:215 rank_2_orderby_1_1:216 cs_item_sk:123!null return_ratio:211 currency_ratio:212
 │    │              │    │    │    │    ├── immutable
 │    │              │    │    │    │    ├── key: (123)
 │    │              │    │    │    │    ├── fd: (123)-->(211,212), (211)==(215), (215)==(211), (212)==(216), (216)==(212)
 │    │              │    │    │    │    ├── project
 │    │              │    │    │    │    │    ├── columns: return_ratio:211 currency_ratio:212 cs_item_sk:123!null
 │    │              │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    ├── key: (123)
 │    │              │    │    │    │    │    ├── fd: (123)-->(211,212)
 │    │              │    │    │    │    │    ├── group-by (streaming)
 │    │              │    │    │    │    │    │    ├── columns: cs_item_sk:123!null sum:204 sum:206 sum:208 sum:210
 │    │              │    │    │    │    │    │    ├── grouping columns: cs_item_sk:123!null
 │    │              │    │    │    │    │    │    ├── internal-ordering: +123
 │    │              │    │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    │    ├── key: (123)
 │    │              │    │    │    │    │    │    ├── fd: (123)-->(204,206,208,210)
 │    │              │    │    │    │    │    │    ├── project
 │    │              │    │    │    │    │    │    │    ├── columns: column203:203 column205:205 column207:207 column209:209 cs_item_sk:123!null
 │    │              │    │    │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    │    │    ├── ordering: +123
 │    │              │    │    │    │    │    │    │    ├── inner-join (lookup date_dim)
 │    │              │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:108!null cs_item_sk:123!null cs_order_number:125!null cs_quantity:126!null cs_net_paid:137!null cs_net_profit:141!null cr_item_sk:146!null cr_order_number:160!null cr_return_quantity:161 cr_return_amount:162!null d_date_sk:173!null d_year:179!null d_moy:181!null
 │    │              │    │    │    │    │    │    │    │    ├── key columns: [108] = [173]
 │    │              │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │              │    │    │    │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    │    │    │    ├── key: (146,160)
 │    │              │    │    │    │    │    │    │    │    ├── fd: ()-->(179,181), (123,125)-->(108,126,137,141), (146,160)-->(161,162), (125)==(160), (160)==(125), (123)==(146), (146)==(123), (108)==(173), (173)==(108)
 │    │              │    │    │    │    │    │    │    │    ├── ordering: +(123|146) opt(179,181) [actual: +146]
 │    │              │    │    │    │    │    │    │    │    ├── inner-join (lookup catalog_sales [as=cs])
 │    │              │    │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:108 cs_item_sk:123!null cs_order_number:125!null cs_quantity:126!null cs_net_paid:137!null cs_net_profit:141!null cr_item_sk:146!null cr_order_number:160!null cr_return_quantity:161 cr_return_amount:162!null
 │    │              │    │    │    │    │    │    │    │    │    ├── key columns: [146 160] = [123 125]
 │    │              │    │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │              │    │    │    │    │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    │    │    │    │    ├── key: (146,160)
 │    │              │    │    │    │    │    │    │    │    │    ├── fd: (123,125)-->(108,126,137,141), (146,160)-->(161,162), (125)==(160), (160)==(125), (123)==(146), (146)==(123)
 │    │              │    │    │    │    │    │    │    │    │    ├── ordering: +(123|146) [actual: +146]
 │    │              │    │    │    │    │    │    │    │    │    ├── select
 │    │              │    │    │    │    │    │    │    │    │    │    ├── columns: cr_item_sk:146!null cr_order_number:160!null cr_return_quantity:161 cr_return_amount:162!null
 │    │              │    │    │    │    │    │    │    │    │    │    ├── immutable
 │    │              │    │    │    │    │    │    │    │    │    │    ├── key: (146,160)
 │    │              │    │    │    │    │    │    │    │    │    │    ├── fd: (146,160)-->(161,162)
 │    │              │    │    │    │    │    │    │    │    │    │    ├── ordering: +146
 │    │              │    │    │    │    │    │    │    │    │    │    ├── scan catalog_returns [as=cr]
 │    │              │    │    │    │    │    │    │    │    │    │    │    ├── columns: cr_item_sk:146!null cr_order_number:160!null cr_return_quantity:161 cr_return_amount:162
 │    │              │    │    │    │    │    │    │    │    │    │    │    ├── key: (146,160)
 │    │              │    │    │    │    │    │    │    │    │    │    │    ├── fd: (146,160)-->(161,162)
 │    │              │    │    │    │    │    │    │    │    │    │    │    └── ordering: +146
 │    │              │    │    │    │    │    │    │    │    │    │    └── filters
 │    │              │    │    │    │    │    │    │    │    │    │         └── cr_return_amount:162 > 10000 [outer=(162), immutable, constraints=(/162: (/10000 - ]; tight)]
 │    │              │    │    │    │    │    │    │    │    │    └── filters
 │    │              │    │    │    │    │    │    │    │    │         ├── cs_net_profit:141 > 1 [outer=(141), immutable, constraints=(/141: (/1 - ]; tight)]
 │    │              │    │    │    │    │    │    │    │    │         ├── cs_net_paid:137 > 0 [outer=(137), immutable, constraints=(/137: (/0 - ]; tight)]
 │    │              │    │    │    │    │    │    │    │    │         └── cs_quantity:126 > 0 [outer=(126), constraints=(/126: [/1 - ]; tight)]
 │    │              │    │    │    │    │    │    │    │    └── filters
 │    │              │    │    │    │    │    │    │    │         ├── d_year:179 = 1998 [outer=(179), constraints=(/179: [/1998 - /1998]; tight), fd=()-->(179)]
 │    │              │    │    │    │    │    │    │    │         └── d_moy:181 = 11 [outer=(181), constraints=(/181: [/11 - /11]; tight), fd=()-->(181)]
 │    │              │    │    │    │    │    │    │    └── projections
 │    │              │    │    │    │    │    │    │         ├── COALESCE(cr_return_quantity:161, 0) [as=column203:203, outer=(161)]
 │    │              │    │    │    │    │    │    │         ├── COALESCE(cs_quantity:126, 0) [as=column205:205, outer=(126)]
 │    │              │    │    │    │    │    │    │         ├── COALESCE(cr_return_amount:162::DECIMAL, 0) [as=column207:207, outer=(162), immutable]
 │    │              │    │    │    │    │    │    │         └── COALESCE(cs_net_paid:137::DECIMAL, 0) [as=column209:209, outer=(137), immutable]
 │    │              │    │    │    │    │    │    └── aggregations
 │    │              │    │    │    │    │    │         ├── sum [as=sum:204, outer=(203)]
 │    │              │    │    │    │    │    │         │    └── column203:203
 │    │              │    │    │    │    │    │         ├── sum [as=sum:206, outer=(205)]
 │    │              │    │    │    │    │    │         │    └── column205:205
 │    │              │    │    │    │    │    │         ├── sum [as=sum:208, outer=(207)]
 │    │              │    │    │    │    │    │         │    └── column207:207
 │    │              │    │    │    │    │    │         └── sum [as=sum:210, outer=(209)]
 │    │              │    │    │    │    │    │              └── column209:209
 │    │              │    │    │    │    │    └── projections
 │    │              │    │    │    │    │         ├── sum:204::DECIMAL(15,4) / sum:206::DECIMAL(15,4) [as=return_ratio:211, outer=(204,206), immutable]
 │    │              │    │    │    │    │         └── sum:208::DECIMAL(15,4) / sum:210::DECIMAL(15,4) [as=currency_ratio:212, outer=(208,210), immutable]
 │    │              │    │    │    │    └── projections
 │    │              │    │    │    │         ├── return_ratio:211 [as=rank_1_orderby_1_1:215, outer=(211)]
 │    │              │    │    │    │         └── currency_ratio:212 [as=rank_2_orderby_1_1:216, outer=(212)]
 │    │              │    │    │    └── windows
 │    │              │    │    │         └── rank [as=rank:213]
 │    │              │    │    └── windows
 │    │              │    │         └── rank [as=rank:214]
 │    │              │    └── filters
 │    │              │         └── (rank:213 <= 10) OR (rank:214 <= 10) [outer=(213,214)]
 │    │              └── projections
 │    │                   └── 'catalog' [as=channel:217]
 │    └── sort
 │         ├── columns: ss_item_sk:225!null return_ratio:308 rank:310 rank:311 channel:314!null
 │         ├── immutable
 │         ├── key: (225)
 │         ├── fd: ()-->(314), (225)-->(308,310,311)
 │         ├── ordering: +310,+311,+225 opt(314) [actual: +310,+311,+225]
 │         ├── limit hint: 100.00
 │         └── project
 │              ├── columns: channel:314!null ss_item_sk:225!null return_ratio:308 rank:310 rank:311
 │              ├── immutable
 │              ├── key: (225)
 │              ├── fd: ()-->(314), (225)-->(308,310,311)
 │              ├── select
 │              │    ├── columns: ss_item_sk:225!null return_ratio:308 currency_ratio:309 rank:310 rank:311 rank_1_orderby_1_1:312 rank_2_orderby_1_1:313
 │              │    ├── immutable
 │              │    ├── key: (225)
 │              │    ├── fd: (225)-->(308-311), (308)==(312), (312)==(308), (309)==(313), (313)==(309)
 │              │    ├── window partition=() ordering=+(309|313)
 │              │    │    ├── columns: ss_item_sk:225!null return_ratio:308 currency_ratio:309 rank:310 rank:311 rank_1_orderby_1_1:312 rank_2_orderby_1_1:313
 │              │    │    ├── immutable
 │              │    │    ├── key: (225)
 │              │    │    ├── fd: (225)-->(308-311), (308)==(312), (312)==(308), (309)==(313), (313)==(309)
 │              │    │    ├── window partition=() ordering=+(308|312)
 │              │    │    │    ├── columns: ss_item_sk:225!null return_ratio:308 currency_ratio:309 rank:310 rank_1_orderby_1_1:312 rank_2_orderby_1_1:313
 │              │    │    │    ├── immutable
 │              │    │    │    ├── key: (225)
 │              │    │    │    ├── fd: (225)-->(308-310), (308)==(312), (312)==(308), (309)==(313), (313)==(309)
 │              │    │    │    ├── project
 │              │    │    │    │    ├── columns: rank_1_orderby_1_1:312 rank_2_orderby_1_1:313 ss_item_sk:225!null return_ratio:308 currency_ratio:309
 │              │    │    │    │    ├── immutable
 │              │    │    │    │    ├── key: (225)
 │              │    │    │    │    ├── fd: (225)-->(308,309), (308)==(312), (312)==(308), (309)==(313), (313)==(309)
 │              │    │    │    │    ├── project
 │              │    │    │    │    │    ├── columns: return_ratio:308 currency_ratio:309 ss_item_sk:225!null
 │              │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    ├── key: (225)
 │              │    │    │    │    │    ├── fd: (225)-->(308,309)
 │              │    │    │    │    │    ├── group-by (streaming)
 │              │    │    │    │    │    │    ├── columns: ss_item_sk:225!null sum:301 sum:303 sum:305 sum:307
 │              │    │    │    │    │    │    ├── grouping columns: ss_item_sk:225!null
 │              │    │    │    │    │    │    ├── internal-ordering: +225
 │              │    │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    │    ├── key: (225)
 │              │    │    │    │    │    │    ├── fd: (225)-->(301,303,305,307)
 │              │    │    │    │    │    │    ├── project
 │              │    │    │    │    │    │    │    ├── columns: column300:300 column302:302 column304:304 column306:306 ss_item_sk:225!null
 │              │    │    │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    │    │    ├── ordering: +225
 │              │    │    │    │    │    │    │    ├── inner-join (lookup date_dim)
 │              │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:223!null ss_item_sk:225!null ss_ticket_number:232!null ss_quantity:233!null ss_net_paid:243!null ss_net_profit:245!null sr_item_sk:250!null sr_ticket_number:257!null sr_return_quantity:258 sr_return_amt:259!null d_date_sk:270!null d_year:276!null d_moy:278!null
 │              │    │    │    │    │    │    │    │    ├── key columns: [223] = [270]
 │              │    │    │    │    │    │    │    │    ├── lookup columns are key
 │              │    │    │    │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    │    │    │    ├── key: (250,257)
 │              │    │    │    │    │    │    │    │    ├── fd: ()-->(276,278), (225,232)-->(223,233,243,245), (250,257)-->(258,259), (232)==(257), (257)==(232), (225)==(250), (250)==(225), (223)==(270), (270)==(223)
 │              │    │    │    │    │    │    │    │    ├── ordering: +(225|250) opt(276,278) [actual: +250]
 │              │    │    │    │    │    │    │    │    ├── inner-join (lookup store_sales [as=sts])
 │              │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:223 ss_item_sk:225!null ss_ticket_number:232!null ss_quantity:233!null ss_net_paid:243!null ss_net_profit:245!null sr_item_sk:250!null sr_ticket_number:257!null sr_return_quantity:258 sr_return_amt:259!null
 │              │    │    │    │    │    │    │    │    │    ├── key columns: [250 257] = [225 232]
 │              │    │    │    │    │    │    │    │    │    ├── lookup columns are key
 │              │    │    │    │    │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    │    │    │    │    ├── key: (250,257)
 │              │    │    │    │    │    │    │    │    │    ├── fd: (225,232)-->(223,233,243,245), (250,257)-->(258,259), (232)==(257), (257)==(232), (225)==(250), (250)==(225)
 │              │    │    │    │    │    │    │    │    │    ├── ordering: +(225|250) [actual: +250]
 │              │    │    │    │    │    │    │    │    │    ├── select
 │              │    │    │    │    │    │    │    │    │    │    ├── columns: sr_item_sk:250!null sr_ticket_number:257!null sr_return_quantity:258 sr_return_amt:259!null
 │              │    │    │    │    │    │    │    │    │    │    ├── immutable
 │              │    │    │    │    │    │    │    │    │    │    ├── key: (250,257)
 │              │    │    │    │    │    │    │    │    │    │    ├── fd: (250,257)-->(258,259)
 │              │    │    │    │    │    │    │    │    │    │    ├── ordering: +250
 │              │    │    │    │    │    │    │    │    │    │    ├── scan store_returns [as=sr]
 │              │    │    │    │    │    │    │    │    │    │    │    ├── columns: sr_item_sk:250!null sr_ticket_number:257!null sr_return_quantity:258 sr_return_amt:259
 │              │    │    │    │    │    │    │    │    │    │    │    ├── key: (250,257)
 │              │    │    │    │    │    │    │    │    │    │    │    ├── fd: (250,257)-->(258,259)
 │              │    │    │    │    │    │    │    │    │    │    │    └── ordering: +250
 │              │    │    │    │    │    │    │    │    │    │    └── filters
 │              │    │    │    │    │    │    │    │    │    │         └── sr_return_amt:259 > 10000 [outer=(259), immutable, constraints=(/259: (/10000 - ]; tight)]
 │              │    │    │    │    │    │    │    │    │    └── filters
 │              │    │    │    │    │    │    │    │    │         ├── ss_net_profit:245 > 1 [outer=(245), immutable, constraints=(/245: (/1 - ]; tight)]
 │              │    │    │    │    │    │    │    │    │         ├── ss_net_paid:243 > 0 [outer=(243), immutable, constraints=(/243: (/0 - ]; tight)]
 │              │    │    │    │    │    │    │    │    │         └── ss_quantity:233 > 0 [outer=(233), constraints=(/233: [/1 - ]; tight)]
 │              │    │    │    │    │    │    │    │    └── filters
 │              │    │    │    │    │    │    │    │         ├── d_year:276 = 1998 [outer=(276), constraints=(/276: [/1998 - /1998]; tight), fd=()-->(276)]
 │              │    │    │    │    │    │    │    │         └── d_moy:278 = 11 [outer=(278), constraints=(/278: [/11 - /11]; tight), fd=()-->(278)]
 │              │    │    │    │    │    │    │    └── projections
 │              │    │    │    │    │    │    │         ├── COALESCE(sr_return_quantity:258, 0) [as=column300:300, outer=(258)]
 │              │    │    │    │    │    │    │         ├── COALESCE(ss_quantity:233, 0) [as=column302:302, outer=(233)]
 │              │    │    │    │    │    │    │         ├── COALESCE(sr_return_amt:259::DECIMAL, 0) [as=column304:304, outer=(259), immutable]
 │              │    │    │    │    │    │    │         └── COALESCE(ss_net_paid:243::DECIMAL, 0) [as=column306:306, outer=(243), immutable]
 │              │    │    │    │    │    │    └── aggregations
 │              │    │    │    │    │    │         ├── sum [as=sum:301, outer=(300)]
 │              │    │    │    │    │    │         │    └── column300:300
 │              │    │    │    │    │    │         ├── sum [as=sum:303, outer=(302)]
 │              │    │    │    │    │    │         │    └── column302:302
 │              │    │    │    │    │    │         ├── sum [as=sum:305, outer=(304)]
 │              │    │    │    │    │    │         │    └── column304:304
 │              │    │    │    │    │    │         └── sum [as=sum:307, outer=(306)]
 │              │    │    │    │    │    │              └── column306:306
 │              │    │    │    │    │    └── projections
 │              │    │    │    │    │         ├── sum:301::DECIMAL(15,4) / sum:303::DECIMAL(15,4) [as=return_ratio:308, outer=(301,303), immutable]
 │              │    │    │    │    │         └── sum:305::DECIMAL(15,4) / sum:307::DECIMAL(15,4) [as=currency_ratio:309, outer=(305,307), immutable]
 │              │    │    │    │    └── projections
 │              │    │    │    │         ├── return_ratio:308 [as=rank_1_orderby_1_1:312, outer=(308)]
 │              │    │    │    │         └── currency_ratio:309 [as=rank_2_orderby_1_1:313, outer=(309)]
 │              │    │    │    └── windows
 │              │    │    │         └── rank [as=rank:310]
 │              │    │    └── windows
 │              │    │         └── rank [as=rank:311]
 │              │    └── filters
 │              │         └── (rank:310 <= 10) OR (rank:311 <= 10) [outer=(310,311)]
 │              └── projections
 │                   └── 'store' [as=channel:314]
 └── 100

# --------------------------------------------------
# Q50
opt
	SELECT
		s_store_name,
		s_company_id,
		s_street_number,
		s_street_name,
		s_street_type,
		s_suite_number,
		s_city,
		s_county,
		s_state,
		s_zip,
		sum(
			CASE
			WHEN (sr_returned_date_sk - ss_sold_date_sk <= 30)
			THEN 1
			ELSE 0
			END
		)
			AS "30 days",
		sum(
			CASE
			WHEN sr_returned_date_sk - ss_sold_date_sk > 30
			AND sr_returned_date_sk - ss_sold_date_sk <= 60
			THEN 1
			ELSE 0
			END
		)
			AS "31-60 days",
		sum(
			CASE
			WHEN sr_returned_date_sk - ss_sold_date_sk > 60
			AND sr_returned_date_sk - ss_sold_date_sk <= 90
			THEN 1
			ELSE 0
			END
		)
			AS "61-90 days",
		sum(
			CASE
			WHEN sr_returned_date_sk - ss_sold_date_sk > 90
			AND sr_returned_date_sk - ss_sold_date_sk <= 120
			THEN 1
			ELSE 0
			END
		)
			AS "91-120 days",
		sum(
			CASE
			WHEN (sr_returned_date_sk - ss_sold_date_sk > 120)
			THEN 1
			ELSE 0
			END
		)
			AS ">120 days"
	FROM
		store_sales,
		store_returns,
		store,
		date_dim AS d1,
		date_dim AS d2
	WHERE
		d2.d_year = 2001
		AND d2.d_moy = 8
		AND ss_ticket_number = sr_ticket_number
		AND ss_item_sk = sr_item_sk
		AND ss_sold_date_sk = d1.d_date_sk
		AND sr_returned_date_sk = d2.d_date_sk
		AND ss_customer_sk = sr_customer_sk
		AND ss_store_sk = s_store_sk
	GROUP BY
		s_store_name,
		s_company_id,
		s_street_number,
		s_street_name,
		s_street_type,
		s_suite_number,
		s_city,
		s_county,
		s_state,
		s_zip
	ORDER BY
		s_store_name,
		s_company_id,
		s_street_number,
		s_street_name,
		s_street_type,
		s_suite_number,
		s_city,
		s_county,
		s_state,
		s_zip
	LIMIT
		100;
----
top-k
 ├── columns: s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73 "30 days":140!null "31-60 days":142!null "61-90 days":144!null "91-120 days":146!null ">120 days":148!null
 ├── internal-ordering: +53,+64,+66,+67,+68,+69,+70,+71,+72,+73
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (53,64,66-73)
 ├── fd: (53,64,66-73)-->(140,142,144,146,148)
 ├── ordering: +53,+64,+66,+67,+68,+69,+70,+71,+72,+73
 └── group-by (hash)
      ├── columns: s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73 sum:140!null sum:142!null sum:144!null sum:146!null sum:148!null
      ├── grouping columns: s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73
      ├── immutable
      ├── key: (53,64,66-73)
      ├── fd: (53,64,66-73)-->(140,142,144,146,148)
      ├── project
      │    ├── columns: column139:139!null column141:141!null column143:143!null column145:145!null column147:147!null s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73
      │    ├── immutable
      │    ├── inner-join (lookup date_dim [as=d1])
      │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null s_store_sk:48!null s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73 d1.d_date_sk:79!null d2.d_date_sk:109!null d2.d_year:115!null d2.d_moy:117!null
      │    │    ├── key columns: [1] = [79]
      │    │    ├── lookup columns are key
      │    │    ├── key: (28,35)
      │    │    ├── fd: ()-->(115,117), (3,10)-->(1,4,8), (28,35)-->(26,29), (48)-->(53,64,66-73), (26)==(109), (109)==(26), (10)==(35), (35)==(10), (3)==(28), (28)==(3), (4)==(29), (29)==(4), (1)==(79), (79)==(1), (8)==(48), (48)==(8)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_ticket_number:10!null sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null s_store_sk:48!null s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73 d2.d_date_sk:109!null d2.d_year:115!null d2.d_moy:117!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── key: (28,35)
      │    │    │    ├── fd: ()-->(115,117), (28,35)-->(26,29), (3,10)-->(1,4,8), (48)-->(53,64,66-73), (8)==(48), (48)==(8), (10)==(35), (35)==(10), (3)==(28), (28)==(3), (4)==(29), (29)==(4), (26)==(109), (109)==(26)
      │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8 ss_ticket_number:10!null sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29!null sr_ticket_number:35!null d2.d_date_sk:109!null d2.d_year:115!null d2.d_moy:117!null
      │    │    │    │    ├── key columns: [28 35] = [3 10]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: ()-->(115,117), (3,10)-->(1,4,8), (28,35)-->(26,29), (26)==(109), (109)==(26), (10)==(35), (35)==(10), (3)==(28), (28)==(3), (4)==(29), (29)==(4)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: sr_returned_date_sk:26!null sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null d2.d_date_sk:109!null d2.d_year:115!null d2.d_moy:117!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    ├── fd: ()-->(115,117), (28,35)-->(26,29), (26)==(109), (109)==(26)
      │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    ├── columns: sr_returned_date_sk:26 sr_item_sk:28!null sr_customer_sk:29 sr_ticket_number:35!null
      │    │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    │    └── fd: (28,35)-->(26,29)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d2.d_date_sk:109!null d2.d_year:115!null d2.d_moy:117!null
      │    │    │    │    │    │    ├── key: (109)
      │    │    │    │    │    │    ├── fd: ()-->(115,117)
      │    │    │    │    │    │    ├── scan date_dim [as=d2]
      │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:109!null d2.d_year:115 d2.d_moy:117
      │    │    │    │    │    │    │    ├── key: (109)
      │    │    │    │    │    │    │    └── fd: (109)-->(115,117)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         ├── d2.d_year:115 = 2001 [outer=(115), constraints=(/115: [/2001 - /2001]; tight), fd=()-->(115)]
      │    │    │    │    │    │         └── d2.d_moy:117 = 8 [outer=(117), constraints=(/117: [/8 - /8]; tight), fd=()-->(117)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── sr_returned_date_sk:26 = d2.d_date_sk:109 [outer=(26,109), constraints=(/26: (/NULL - ]; /109: (/NULL - ]), fd=(26)==(109), (109)==(26)]
      │    │    │    │    └── filters
      │    │    │    │         └── ss_customer_sk:4 = sr_customer_sk:29 [outer=(4,29), constraints=(/4: (/NULL - ]; /29: (/NULL - ]), fd=(4)==(29), (29)==(4)]
      │    │    │    ├── scan store
      │    │    │    │    ├── columns: s_store_sk:48!null s_store_name:53 s_company_id:64 s_street_number:66 s_street_name:67 s_street_type:68 s_suite_number:69 s_city:70 s_county:71 s_state:72 s_zip:73
      │    │    │    │    ├── key: (48)
      │    │    │    │    └── fd: (48)-->(53,64,66-73)
      │    │    │    └── filters
      │    │    │         └── ss_store_sk:8 = s_store_sk:48 [outer=(8,48), constraints=(/8: (/NULL - ]; /48: (/NULL - ]), fd=(8)==(48), (48)==(8)]
      │    │    └── filters (true)
      │    └── projections
      │         ├── CASE WHEN (sr_returned_date_sk:26 - ss_sold_date_sk:1) <= 30 THEN 1 ELSE 0 END [as=column139:139, outer=(1,26), immutable]
      │         ├── CASE WHEN ((sr_returned_date_sk:26 - ss_sold_date_sk:1) > 30) AND ((sr_returned_date_sk:26 - ss_sold_date_sk:1) <= 60) THEN 1 ELSE 0 END [as=column141:141, outer=(1,26), immutable]
      │         ├── CASE WHEN ((sr_returned_date_sk:26 - ss_sold_date_sk:1) > 60) AND ((sr_returned_date_sk:26 - ss_sold_date_sk:1) <= 90) THEN 1 ELSE 0 END [as=column143:143, outer=(1,26), immutable]
      │         ├── CASE WHEN ((sr_returned_date_sk:26 - ss_sold_date_sk:1) > 90) AND ((sr_returned_date_sk:26 - ss_sold_date_sk:1) <= 120) THEN 1 ELSE 0 END [as=column145:145, outer=(1,26), immutable]
      │         └── CASE WHEN (sr_returned_date_sk:26 - ss_sold_date_sk:1) > 120 THEN 1 ELSE 0 END [as=column147:147, outer=(1,26), immutable]
      └── aggregations
           ├── sum [as=sum:140, outer=(139)]
           │    └── column139:139
           ├── sum [as=sum:142, outer=(141)]
           │    └── column141:141
           ├── sum [as=sum:144, outer=(143)]
           │    └── column143:143
           ├── sum [as=sum:146, outer=(145)]
           │    └── column145:145
           └── sum [as=sum:148, outer=(147)]
                └── column147:147

# --------------------------------------------------
# Q51
opt
	WITH
		web_v1
			AS (
				SELECT
					ws_item_sk AS item_sk,
					d_date,
					sum(sum(ws_sales_price)) OVER (
						PARTITION BY
							ws_item_sk
						ORDER BY
							d_date
						ROWS
							BETWEEN
								UNBOUNDED PRECEDING
							AND
								CURRENT ROW
					)
						AS cume_sales
				FROM
					web_sales, date_dim
				WHERE
					ws_sold_date_sk = d_date_sk
					AND d_month_seq BETWEEN 1212 AND (1212 + 11)
					AND ws_item_sk IS NOT NULL
				GROUP BY
					ws_item_sk, d_date
			),
		store_v1
			AS (
				SELECT
					ss_item_sk AS item_sk,
					d_date,
					sum(sum(ss_sales_price)) OVER (
						PARTITION BY
							ss_item_sk
						ORDER BY
							d_date
						ROWS
							BETWEEN
								UNBOUNDED PRECEDING
							AND
								CURRENT ROW
					)
						AS cume_sales
				FROM
					store_sales, date_dim
				WHERE
					ss_sold_date_sk = d_date_sk
					AND d_month_seq BETWEEN 1212 AND (1212 + 11)
					AND ss_item_sk IS NOT NULL
				GROUP BY
					ss_item_sk, d_date
			)
	SELECT
		*
	FROM
		(
			SELECT
				item_sk,
				d_date,
				web_sales,
				store_sales,
				max(web_sales) OVER (
					PARTITION BY
						item_sk
					ORDER BY
						d_date
					ROWS
						BETWEEN
							UNBOUNDED PRECEDING
						AND
							CURRENT ROW
				)
					AS web_cumulative,
				max(store_sales) OVER (
					PARTITION BY
						item_sk
					ORDER BY
						d_date
					ROWS
						BETWEEN
							UNBOUNDED PRECEDING
						AND
							CURRENT ROW
				)
					AS store_cumulative
			FROM
				(
					SELECT
						CASE
						WHEN web.item_sk IS NOT NULL
						THEN web.item_sk
						ELSE store.item_sk
						END
							AS item_sk,
						CASE
						WHEN web.d_date IS NOT NULL
						THEN web.d_date
						ELSE store.d_date
						END
							AS d_date,
						web.cume_sales AS web_sales,
						store.cume_sales AS store_sales
					FROM
						web_v1 AS web
						FULL JOIN store_v1 AS store ON
								web.item_sk = store.item_sk
								AND web.d_date = store.d_date
				)
					AS x
		)
			AS y
	WHERE
		web_cumulative > store_cumulative
	ORDER BY
		item_sk, d_date
	LIMIT
		100;
----
project
 ├── columns: item_sk:132 d_date:133 web_sales:128 store_sales:131 web_cumulative:134!null store_cumulative:135!null
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +132,+133
 └── top-k
      ├── columns: cume_sales:128 cume_sales:131 item_sk:132 d_date:133 max:134!null max:135!null max_1_partition_1:136 max_1_orderby_1_1:137
      ├── internal-ordering: +(132|136),+(133|137)
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── fd: (132)==(136), (136)==(132), (133)==(137), (137)==(133)
      ├── ordering: +(132|136),+(133|137) [actual: +132,+133]
      └── select
           ├── columns: cume_sales:128 cume_sales:131 item_sk:132 d_date:133 max:134!null max:135!null max_1_partition_1:136 max_1_orderby_1_1:137
           ├── immutable
           ├── fd: (132)==(136), (136)==(132), (133)==(137), (137)==(133)
           ├── window partition=(136) ordering=+(133|137) opt(132,136)
           │    ├── columns: cume_sales:128 cume_sales:131 item_sk:132 d_date:133 max:134 max:135 max_1_partition_1:136 max_1_orderby_1_1:137
           │    ├── fd: (132)==(136), (136)==(132), (133)==(137), (137)==(133)
           │    ├── project
           │    │    ├── columns: max_1_partition_1:136 max_1_orderby_1_1:137 cume_sales:128 cume_sales:131 item_sk:132 d_date:133
           │    │    ├── fd: (132)==(136), (136)==(132), (133)==(137), (137)==(133)
           │    │    ├── project
           │    │    │    ├── columns: item_sk:132 d_date:133 cume_sales:128 cume_sales:131
           │    │    │    ├── full-join (hash)
           │    │    │    │    ├── columns: item_sk:126 d_date:127 cume_sales:128 item_sk:129 d_date:130 cume_sales:131
           │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
           │    │    │    │    ├── key: (126,127,129,130)
           │    │    │    │    ├── fd: (126,127)-->(128), (129,130)-->(131)
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: item_sk:129!null d_date:130 cume_sales:131
           │    │    │    │    │    ├── key: (129,130)
           │    │    │    │    │    ├── fd: (129,130)-->(131)
           │    │    │    │    │    ├── window partition=(71) ordering=+96 opt(71)
           │    │    │    │    │    │    ├── columns: ss_item_sk:71!null date_dim.d_date:96 sum:124 sum:125
           │    │    │    │    │    │    ├── key: (71,96)
           │    │    │    │    │    │    ├── fd: (71,96)-->(124,125)
           │    │    │    │    │    │    ├── group-by (hash)
           │    │    │    │    │    │    │    ├── columns: ss_item_sk:71!null date_dim.d_date:96 sum:124
           │    │    │    │    │    │    │    ├── grouping columns: ss_item_sk:71!null date_dim.d_date:96
           │    │    │    │    │    │    │    ├── key: (71,96)
           │    │    │    │    │    │    │    ├── fd: (71,96)-->(124)
           │    │    │    │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:69!null ss_item_sk:71!null ss_sales_price:82 d_date_sk:94!null date_dim.d_date:96 d_month_seq:97!null
           │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    │    │    │    ├── fd: (94)-->(96,97), (69)==(94), (94)==(69)
           │    │    │    │    │    │    │    │    ├── scan store_sales
           │    │    │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:69 ss_item_sk:71!null ss_sales_price:82
           │    │    │    │    │    │    │    │    ├── select
           │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:94!null date_dim.d_date:96 d_month_seq:97!null
           │    │    │    │    │    │    │    │    │    ├── key: (94)
           │    │    │    │    │    │    │    │    │    ├── fd: (94)-->(96,97)
           │    │    │    │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:94!null date_dim.d_date:96 d_month_seq:97
           │    │    │    │    │    │    │    │    │    │    ├── key: (94)
           │    │    │    │    │    │    │    │    │    │    └── fd: (94)-->(96,97)
           │    │    │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │    │    │         └── (d_month_seq:97 >= 1212) AND (d_month_seq:97 <= 1223) [outer=(97), constraints=(/97: [/1212 - /1223]; tight)]
           │    │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │    │         └── ss_sold_date_sk:69 = d_date_sk:94 [outer=(69,94), constraints=(/69: (/NULL - ]; /94: (/NULL - ]), fd=(69)==(94), (94)==(69)]
           │    │    │    │    │    │    │    └── aggregations
           │    │    │    │    │    │    │         └── sum [as=sum:124, outer=(82)]
           │    │    │    │    │    │    │              └── ss_sales_price:82
           │    │    │    │    │    │    └── windows
           │    │    │    │    │    │         └── sum [as=sum:125, frame="rows from unbounded to current-row", outer=(124)]
           │    │    │    │    │    │              └── sum:124
           │    │    │    │    │    └── projections
           │    │    │    │    │         ├── ss_item_sk:71 [as=item_sk:129, outer=(71)]
           │    │    │    │    │         ├── date_dim.d_date:96 [as=d_date:130, outer=(96)]
           │    │    │    │    │         └── sum:125 [as=cume_sales:131, outer=(125)]
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: item_sk:126!null d_date:127 cume_sales:128
           │    │    │    │    │    ├── key: (126,127)
           │    │    │    │    │    ├── fd: (126,127)-->(128)
           │    │    │    │    │    ├── window partition=(4) ordering=+39 opt(4)
           │    │    │    │    │    │    ├── columns: ws_item_sk:4!null date_dim.d_date:39 sum:67 sum:68
           │    │    │    │    │    │    ├── key: (4,39)
           │    │    │    │    │    │    ├── fd: (4,39)-->(67,68)
           │    │    │    │    │    │    ├── group-by (hash)
           │    │    │    │    │    │    │    ├── columns: ws_item_sk:4!null date_dim.d_date:39 sum:67
           │    │    │    │    │    │    │    ├── grouping columns: ws_item_sk:4!null date_dim.d_date:39
           │    │    │    │    │    │    │    ├── key: (4,39)
           │    │    │    │    │    │    │    ├── fd: (4,39)-->(67)
           │    │    │    │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_sales_price:22 d_date_sk:37!null date_dim.d_date:39 d_month_seq:40!null
           │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    │    │    │    ├── fd: (37)-->(39,40), (1)==(37), (37)==(1)
           │    │    │    │    │    │    │    │    ├── scan web_sales
           │    │    │    │    │    │    │    │    │    └── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_sales_price:22
           │    │    │    │    │    │    │    │    ├── select
           │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:37!null date_dim.d_date:39 d_month_seq:40!null
           │    │    │    │    │    │    │    │    │    ├── key: (37)
           │    │    │    │    │    │    │    │    │    ├── fd: (37)-->(39,40)
           │    │    │    │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:37!null date_dim.d_date:39 d_month_seq:40
           │    │    │    │    │    │    │    │    │    │    ├── key: (37)
           │    │    │    │    │    │    │    │    │    │    └── fd: (37)-->(39,40)
           │    │    │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │    │    │         └── (d_month_seq:40 >= 1212) AND (d_month_seq:40 <= 1223) [outer=(40), constraints=(/40: [/1212 - /1223]; tight)]
           │    │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │    │         └── ws_sold_date_sk:1 = d_date_sk:37 [outer=(1,37), constraints=(/1: (/NULL - ]; /37: (/NULL - ]), fd=(1)==(37), (37)==(1)]
           │    │    │    │    │    │    │    └── aggregations
           │    │    │    │    │    │    │         └── sum [as=sum:67, outer=(22)]
           │    │    │    │    │    │    │              └── ws_sales_price:22
           │    │    │    │    │    │    └── windows
           │    │    │    │    │    │         └── sum [as=sum:68, frame="rows from unbounded to current-row", outer=(67)]
           │    │    │    │    │    │              └── sum:67
           │    │    │    │    │    └── projections
           │    │    │    │    │         ├── ws_item_sk:4 [as=item_sk:126, outer=(4)]
           │    │    │    │    │         ├── date_dim.d_date:39 [as=d_date:127, outer=(39)]
           │    │    │    │    │         └── sum:68 [as=cume_sales:128, outer=(68)]
           │    │    │    │    └── filters
           │    │    │    │         ├── item_sk:126 = item_sk:129 [outer=(126,129), constraints=(/126: (/NULL - ]; /129: (/NULL - ]), fd=(126)==(129), (129)==(126)]
           │    │    │    │         └── d_date:127 = d_date:130 [outer=(127,130), constraints=(/127: (/NULL - ]; /130: (/NULL - ]), fd=(127)==(130), (130)==(127)]
           │    │    │    └── projections
           │    │    │         ├── CASE WHEN item_sk:126 IS NOT NULL THEN item_sk:126 ELSE item_sk:129 END [as=item_sk:132, outer=(126,129)]
           │    │    │         └── CASE WHEN d_date:127 IS NOT NULL THEN d_date:127 ELSE d_date:130 END [as=d_date:133, outer=(127,130)]
           │    │    └── projections
           │    │         ├── item_sk:132 [as=max_1_partition_1:136, outer=(132)]
           │    │         └── d_date:133 [as=max_1_orderby_1_1:137, outer=(133)]
           │    └── windows
           │         ├── max [as=max:134, frame="rows from unbounded to current-row", outer=(128)]
           │         │    └── cume_sales:128
           │         └── max [as=max:135, frame="rows from unbounded to current-row", outer=(131)]
           │              └── cume_sales:131
           └── filters
                └── max:134 > max:135 [outer=(134,135), immutable, constraints=(/134: (/NULL - ]; /135: (/NULL - ])]

# --------------------------------------------------
# Q52
opt
	SELECT
		dt.d_year,
		item.i_brand_id AS brand_id,
		item.i_brand AS brand,
		sum(ss_ext_sales_price) AS ext_price
	FROM
		date_dim AS dt, store_sales, item
	WHERE
		dt.d_date_sk = store_sales.ss_sold_date_sk
		AND store_sales.ss_item_sk = item.i_item_sk
		AND item.i_manager_id = 1
		AND dt.d_moy = 12
		AND dt.d_year = 2000
	GROUP BY
		dt.d_year, item.i_brand, item.i_brand_id
	ORDER BY
		dt.d_year, ext_price DESC, brand_id
	LIMIT
		100;
----
top-k
 ├── columns: d_year:7!null brand_id:63 brand:64 ext_price:80
 ├── internal-ordering: -80,+63 opt(7)
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (63,64)
 ├── fd: ()-->(7), (63,64)-->(7,80)
 ├── ordering: -80,+63 opt(7) [actual: -80,+63]
 └── group-by (hash)
      ├── columns: d_year:7!null i_brand_id:63 i_brand:64 sum:80
      ├── grouping columns: i_brand_id:63 i_brand:64
      ├── key: (63,64)
      ├── fd: ()-->(7), (63,64)-->(7,80)
      ├── inner-join (hash)
      │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── fd: ()-->(7,9,76), (56)-->(63,64), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup store_sales)
      │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    │    ├── key columns: [56] = [33]
      │    │    ├── fd: ()-->(76), (56)-->(63,64), (33)==(56), (56)==(33)
      │    │    ├── select
      │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: ()-->(76), (56)-->(63,64)
      │    │    │    ├── scan item
      │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(63,64,76)
      │    │    │    └── filters
      │    │    │         └── i_manager_id:76 = 1 [outer=(76), constraints=(/76: [/1 - /1]; tight), fd=()-->(76)]
      │    │    └── filters (true)
      │    ├── select
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null
      │    │    ├── key: (1)
      │    │    ├── fd: ()-->(7,9)
      │    │    ├── scan date_dim [as=dt]
      │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    ├── key: (1)
      │    │    │    └── fd: (1)-->(7,9)
      │    │    └── filters
      │    │         ├── d_moy:9 = 12 [outer=(9), constraints=(/9: [/12 - /12]; tight), fd=()-->(9)]
      │    │         └── d_year:7 = 2000 [outer=(7), constraints=(/7: [/2000 - /2000]; tight), fd=()-->(7)]
      │    └── filters
      │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      └── aggregations
           ├── sum [as=sum:80, outer=(46)]
           │    └── ss_ext_sales_price:46
           └── const-agg [as=d_year:7, outer=(7)]
                └── d_year:7

# --------------------------------------------------
# Q53
opt
	SELECT
		*
	FROM
		(
			SELECT
				i_manufact_id,
				sum(ss_sales_price) AS sum_sales,
				avg(sum(ss_sales_price)) OVER (
					PARTITION BY i_manufact_id
				)
					AS avg_quarterly_sales
			FROM
				item, store_sales, date_dim, store
			WHERE
				ss_item_sk = i_item_sk
				AND ss_sold_date_sk = d_date_sk
				AND ss_store_sk = s_store_sk
				AND d_month_seq
					IN (
							1186,
							1186 + 1,
							1186 + 2,
							1186 + 3,
							1186 + 4,
							1186 + 5,
							1186 + 6,
							1186 + 7,
							1186 + 8,
							1186 + 9,
							1186 + 10,
							1186 + 11
						)
				AND (
						(
							i_category
							IN (
									'Books',
									'Children',
									'Electronics'
								)
							AND i_class
								IN (
										'personal',
										'portable',
										'reference',
										'self-help'
									)
							AND i_brand
								IN (
										'scholaramalgamalg #14',
										'scholaramalgamalg #7',
										'exportiunivamalg #9',
										'scholaramalgamalg #9'
									)
						)
						OR (
								i_category
								IN ('Women', 'Music', 'Men')
								AND i_class
									IN (
											'accessories',
											'classical',
											'fragrances',
											'pants'
										)
								AND i_brand
									IN (
											'amalgimporto #1',
											'edu packscholar #1',
											'exportiimporto #1',
											'importoamalg #1'
										)
							)
					)
			GROUP BY
				i_manufact_id, d_qoy
		)
			AS tmp1
	WHERE
		CASE
		WHEN avg_quarterly_sales > 0
		THEN abs(sum_sales - avg_quarterly_sales)
		/ avg_quarterly_sales
		ELSE NULL
		END
		> 0.1
	ORDER BY
		avg_quarterly_sales, sum_sales, i_manufact_id
	LIMIT
		100;
----
project
 ├── columns: i_manufact_id:14 sum_sales:111 avg_quarterly_sales:112
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +112,+111,+14
 └── top-k
      ├── columns: i_manufact_id:14 d_qoy:60 sum:111 avg:112
      ├── internal-ordering: +112,+111,+14
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── key: (14,60)
      ├── fd: (14,60)-->(111,112)
      ├── ordering: +112,+111,+14
      └── select
           ├── columns: i_manufact_id:14 d_qoy:60 sum:111 avg:112
           ├── immutable
           ├── key: (14,60)
           ├── fd: (14,60)-->(111,112)
           ├── window partition=(14)
           │    ├── columns: i_manufact_id:14 d_qoy:60 sum:111 avg:112
           │    ├── key: (14,60)
           │    ├── fd: (14,60)-->(111,112)
           │    ├── group-by (hash)
           │    │    ├── columns: i_manufact_id:14 d_qoy:60 sum:111
           │    │    ├── grouping columns: i_manufact_id:14 d_qoy:60
           │    │    ├── key: (14,60)
           │    │    ├── fd: (14,60)-->(111)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manufact_id:14 ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32!null ss_sales_price:38 d_date_sk:50!null d_month_seq:53!null d_qoy:60 s_store_sk:80!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: (1)-->(9,11,13,14), (50)-->(53,60), (25)==(50), (50)==(25), (32)==(80), (80)==(32), (1)==(27), (27)==(1)
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manufact_id:14 ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38 d_date_sk:50!null d_month_seq:53!null d_qoy:60
           │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    ├── fd: (1)-->(9,11,13,14), (50)-->(53,60), (25)==(50), (50)==(25), (1)==(27), (27)==(1)
           │    │    │    │    ├── inner-join (lookup store_sales)
           │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manufact_id:14 ss_sold_date_sk:25 ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38
           │    │    │    │    │    ├── key columns: [1] = [27]
           │    │    │    │    │    ├── fd: (1)-->(9,11,13,14), (1)==(27), (27)==(1)
           │    │    │    │    │    ├── select
           │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manufact_id:14
           │    │    │    │    │    │    ├── key: (1)
           │    │    │    │    │    │    ├── fd: (1)-->(9,11,13,14)
           │    │    │    │    │    │    ├── scan item
           │    │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11 i_category:13 i_manufact_id:14
           │    │    │    │    │    │    │    ├── key: (1)
           │    │    │    │    │    │    │    └── fd: (1)-->(9,11,13,14)
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── (((i_category:13 IN ('Books', 'Children', 'Electronics')) AND (i_class:11 IN ('personal', 'portable', 'reference', 'self-help'))) AND (i_brand:9 IN ('exportiunivamalg #9', 'scholaramalgamalg #14', 'scholaramalgamalg #7', 'scholaramalgamalg #9'))) OR (((i_category:13 IN ('Men', 'Music', 'Women')) AND (i_class:11 IN ('accessories', 'classical', 'fragrances', 'pants'))) AND (i_brand:9 IN ('amalgimporto #1', 'edu packscholar #1', 'exportiimporto #1', 'importoamalg #1'))) [outer=(9,11,13), constraints=(/9: [/'amalgimporto #1' - /'amalgimporto #1'] [/'edu packscholar #1' - /'edu packscholar #1'] [/'exportiimporto #1' - /'exportiimporto #1'] [/'exportiunivamalg #9' - /'exportiunivamalg #9'] [/'importoamalg #1' - /'importoamalg #1'] [/'scholaramalgamalg #14' - /'scholaramalgamalg #14'] [/'scholaramalgamalg #7' - /'scholaramalgamalg #7'] [/'scholaramalgamalg #9' - /'scholaramalgamalg #9']; /11: [/'accessories' - /'accessories'] [/'classical' - /'classical'] [/'fragrances' - /'fragrances'] [/'pants' - /'pants'] [/'personal' - /'personal'] [/'portable' - /'portable'] [/'reference' - /'reference'] [/'self-help' - /'self-help']; /13: [/'Books' - /'Books'] [/'Children' - /'Children'] [/'Electronics' - /'Electronics'] [/'Men' - /'Men'] [/'Music' - /'Music'] [/'Women' - /'Women'])]
           │    │    │    │    │    └── filters (true)
           │    │    │    │    ├── select
           │    │    │    │    │    ├── columns: d_date_sk:50!null d_month_seq:53!null d_qoy:60
           │    │    │    │    │    ├── key: (50)
           │    │    │    │    │    ├── fd: (50)-->(53,60)
           │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_month_seq:53 d_qoy:60
           │    │    │    │    │    │    ├── key: (50)
           │    │    │    │    │    │    └── fd: (50)-->(53,60)
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── d_month_seq:53 IN (1186, 1187, 1188, 1189, 1190, 1191, 1192, 1193, 1194, 1195, 1196, 1197) [outer=(53), constraints=(/53: [/1186 - /1186] [/1187 - /1187] [/1188 - /1188] [/1189 - /1189] [/1190 - /1190] [/1191 - /1191] [/1192 - /1192] [/1193 - /1193] [/1194 - /1194] [/1195 - /1195] [/1196 - /1196] [/1197 - /1197]; tight)]
           │    │    │    │    └── filters
           │    │    │    │         └── ss_sold_date_sk:25 = d_date_sk:50 [outer=(25,50), constraints=(/25: (/NULL - ]; /50: (/NULL - ]), fd=(25)==(50), (50)==(25)]
           │    │    │    ├── scan store
           │    │    │    │    ├── columns: s_store_sk:80!null
           │    │    │    │    └── key: (80)
           │    │    │    └── filters
           │    │    │         └── ss_store_sk:32 = s_store_sk:80 [outer=(32,80), constraints=(/32: (/NULL - ]; /80: (/NULL - ]), fd=(32)==(80), (80)==(32)]
           │    │    └── aggregations
           │    │         └── sum [as=sum:111, outer=(38)]
           │    │              └── ss_sales_price:38
           │    └── windows
           │         └── avg [as=avg:112, outer=(111)]
           │              └── sum:111
           └── filters
                └── CASE WHEN avg:112 > 0 THEN abs(sum:111 - avg:112) / avg:112 ELSE CAST(NULL AS DECIMAL) END > 0.1 [outer=(111,112), immutable]

# --------------------------------------------------
# Q54
opt
	WITH
		my_customers
			AS (
				SELECT
					DISTINCT c_customer_sk, c_current_addr_sk
				FROM
					(
						SELECT
							cs_sold_date_sk AS sold_date_sk,
							cs_bill_customer_sk AS customer_sk,
							cs_item_sk AS item_sk
						FROM
							catalog_sales
						UNION ALL
							SELECT
								ws_sold_date_sk AS sold_date_sk,
								ws_bill_customer_sk
									AS customer_sk,
								ws_item_sk AS item_sk
							FROM
								web_sales
					)
						AS cs_or_ws_sales,
					item,
					date_dim,
					customer
				WHERE
					sold_date_sk = d_date_sk
					AND item_sk = i_item_sk
					AND i_category = 'Music'
					AND i_class = 'country'
					AND c_customer_sk
						= cs_or_ws_sales.customer_sk
					AND d_moy = 1
					AND d_year = 1999
			),
		my_revenue
			AS (
				SELECT
					c_customer_sk,
					sum(ss_ext_sales_price) AS revenue
				FROM
					my_customers,
					store_sales,
					customer_address,
					store,
					date_dim
				WHERE
					c_current_addr_sk = ca_address_sk
					AND ca_county = s_county
					AND ca_state = s_state
					AND ss_sold_date_sk = d_date_sk
					AND c_customer_sk = ss_customer_sk
					AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE (d_year = 1999) AND (d_moy = 1)) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE (d_year = 1999) AND (d_moy = 1))
				GROUP BY
					c_customer_sk
			),
		segments
			AS (
				SELECT
					CAST((revenue / 50) AS INT8) AS segment
				FROM
					my_revenue
			)
	SELECT
		segment,
		count(*) AS num_customers,
		segment * 50 AS segment_base
	FROM
		segments
	GROUP BY
		segment
	ORDER BY
		segment, num_customers
	LIMIT
		100;
----
project
 ├── columns: segment:319 num_customers:320!null segment_base:321
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (319)
 ├── fd: (319)-->(320,321)
 ├── ordering: +319
 ├── limit
 │    ├── columns: segment:319 count_rows:320!null
 │    ├── internal-ordering: +319
 │    ├── cardinality: [0 - 100]
 │    ├── immutable
 │    ├── key: (319)
 │    ├── fd: (319)-->(320)
 │    ├── ordering: +319
 │    ├── group-by (streaming)
 │    │    ├── columns: segment:319 count_rows:320!null
 │    │    ├── grouping columns: segment:319
 │    │    ├── immutable
 │    │    ├── key: (319)
 │    │    ├── fd: (319)-->(320)
 │    │    ├── ordering: +319
 │    │    ├── limit hint: 100.00
 │    │    ├── sort
 │    │    │    ├── columns: segment:319
 │    │    │    ├── immutable
 │    │    │    ├── ordering: +319
 │    │    │    └── project
 │    │    │         ├── columns: segment:319
 │    │    │         ├── immutable
 │    │    │         ├── group-by (hash)
 │    │    │         │    ├── columns: c_customer_sk:150!null sum:315
 │    │    │         │    ├── grouping columns: c_customer_sk:150!null
 │    │    │         │    ├── immutable
 │    │    │         │    ├── key: (150)
 │    │    │         │    ├── fd: (150)-->(315)
 │    │    │         │    ├── project
 │    │    │         │    │    ├── columns: c_customer_sk:150!null ss_ext_sales_price:167
 │    │    │         │    │    ├── immutable
 │    │    │         │    │    ├── inner-join (lookup date_dim)
 │    │    │         │    │    │    ├── columns: customer.c_customer_sk:130!null customer.c_current_addr_sk:134!null ss_sold_date_sk:152!null ss_customer_sk:155!null ss_ext_sales_price:167 ca_address_sk:177!null ca_county:184!null ca_state:185!null s_county:215!null s_state:216!null d_date_sk:223!null d_month_seq:226!null
 │    │    │         │    │    │    ├── key columns: [152] = [223]
 │    │    │         │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    ├── immutable
 │    │    │         │    │    │    ├── fd: (130)-->(134), (223)-->(226), (177)-->(184,185), (152)==(223), (223)==(152), (130)==(155), (155)==(130), (184)==(215), (215)==(184), (185)==(216), (216)==(185), (134)==(177), (177)==(134)
 │    │    │         │    │    │    ├── inner-join (hash)
 │    │    │         │    │    │    │    ├── columns: customer.c_customer_sk:130!null customer.c_current_addr_sk:134!null ss_sold_date_sk:152 ss_customer_sk:155!null ss_ext_sales_price:167 ca_address_sk:177!null ca_county:184!null ca_state:185!null s_county:215!null s_state:216!null
 │    │    │         │    │    │    │    ├── fd: (130)-->(134), (177)-->(184,185), (184)==(215), (215)==(184), (185)==(216), (216)==(185), (134)==(177), (177)==(134), (130)==(155), (155)==(130)
 │    │    │         │    │    │    │    ├── scan store_sales
 │    │    │         │    │    │    │    │    └── columns: ss_sold_date_sk:152 ss_customer_sk:155 ss_ext_sales_price:167
 │    │    │         │    │    │    │    ├── inner-join (hash)
 │    │    │         │    │    │    │    │    ├── columns: customer.c_customer_sk:130!null customer.c_current_addr_sk:134!null ca_address_sk:177!null ca_county:184!null ca_state:185!null s_county:215!null s_state:216!null
 │    │    │         │    │    │    │    │    ├── fd: (130)-->(134), (177)-->(184,185), (184)==(215), (215)==(184), (185)==(216), (216)==(185), (134)==(177), (177)==(134)
 │    │    │         │    │    │    │    │    ├── scan store
 │    │    │         │    │    │    │    │    │    └── columns: s_county:215 s_state:216
 │    │    │         │    │    │    │    │    ├── inner-join (lookup customer_address)
 │    │    │         │    │    │    │    │    │    ├── columns: customer.c_customer_sk:130!null customer.c_current_addr_sk:134!null ca_address_sk:177!null ca_county:184 ca_state:185
 │    │    │         │    │    │    │    │    │    ├── key columns: [134] = [177]
 │    │    │         │    │    │    │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    │    │    │    ├── key: (130)
 │    │    │         │    │    │    │    │    │    ├── fd: (130)-->(134), (177)-->(184,185), (134)==(177), (177)==(134)
 │    │    │         │    │    │    │    │    │    ├── distinct-on
 │    │    │         │    │    │    │    │    │    │    ├── columns: customer.c_customer_sk:130!null customer.c_current_addr_sk:134
 │    │    │         │    │    │    │    │    │    │    ├── grouping columns: customer.c_customer_sk:130!null
 │    │    │         │    │    │    │    │    │    │    ├── key: (130)
 │    │    │         │    │    │    │    │    │    │    ├── fd: (130)-->(134)
 │    │    │         │    │    │    │    │    │    │    ├── inner-join (lookup customer)
 │    │    │         │    │    │    │    │    │    │    │    ├── columns: sold_date_sk:73!null customer_sk:74!null item_sk:75!null i_item_sk:76!null i_class:86!null i_category:88!null d_date_sk:100!null d_year:106!null d_moy:108!null customer.c_customer_sk:130!null customer.c_current_addr_sk:134
 │    │    │         │    │    │    │    │    │    │    │    ├── key columns: [74] = [130]
 │    │    │         │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    │    │    │    │    │    ├── fd: ()-->(86,88,106,108), (130)-->(134), (75)==(76), (76)==(75), (73)==(100), (100)==(73), (74)==(130), (130)==(74)
 │    │    │         │    │    │    │    │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │         │    │    │    │    │    │    │    │    │    ├── columns: sold_date_sk:73!null customer_sk:74 item_sk:75!null i_item_sk:76!null i_class:86!null i_category:88!null d_date_sk:100!null d_year:106!null d_moy:108!null
 │    │    │         │    │    │    │    │    │    │    │    │    ├── key columns: [73] = [100]
 │    │    │         │    │    │    │    │    │    │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    │    │    │    │    │    │    ├── fd: ()-->(86,88,106,108), (75)==(76), (76)==(75), (73)==(100), (100)==(73)
 │    │    │         │    │    │    │    │    │    │    │    │    ├── inner-join (merge)
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── columns: sold_date_sk:73 customer_sk:74 item_sk:75!null i_item_sk:76!null i_class:86!null i_category:88!null
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── left ordering: +75
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── right ordering: +76
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(86,88), (75)==(76), (76)==(75)
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── union-all
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── columns: sold_date_sk:73 customer_sk:74 item_sk:75!null
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── left columns: cs_sold_date_sk:1 cs_bill_customer_sk:4 cs_item_sk:16
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── right columns: ws_sold_date_sk:37 ws_bill_customer_sk:41 ws_item_sk:40
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── ordering: +75
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── scan catalog_sales
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_bill_customer_sk:4 cs_item_sk:16!null
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    └── ordering: +16
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    └── scan web_sales
 │    │    │         │    │    │    │    │    │    │    │    │    │    │         ├── columns: ws_sold_date_sk:37 ws_item_sk:40!null ws_bill_customer_sk:41
 │    │    │         │    │    │    │    │    │    │    │    │    │    │         └── ordering: +40
 │    │    │         │    │    │    │    │    │    │    │    │    │    ├── select
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:76!null i_class:86!null i_category:88!null
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── key: (76)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(86,88)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── ordering: +76 opt(86,88) [actual: +76]
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    ├── scan item
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:76!null i_class:86 i_category:88
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (76)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (76)-->(86,88)
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    │    └── ordering: +76
 │    │    │         │    │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │    │    │    │    │    │    │         ├── i_category:88 = 'Music' [outer=(88), constraints=(/88: [/'Music' - /'Music']; tight), fd=()-->(88)]
 │    │    │         │    │    │    │    │    │    │    │    │    │    │         └── i_class:86 = 'country' [outer=(86), constraints=(/86: [/'country' - /'country']; tight), fd=()-->(86)]
 │    │    │         │    │    │    │    │    │    │    │    │    │    └── filters (true)
 │    │    │         │    │    │    │    │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │    │    │    │    │         ├── d_moy:108 = 1 [outer=(108), constraints=(/108: [/1 - /1]; tight), fd=()-->(108)]
 │    │    │         │    │    │    │    │    │    │    │    │         └── d_year:106 = 1999 [outer=(106), constraints=(/106: [/1999 - /1999]; tight), fd=()-->(106)]
 │    │    │         │    │    │    │    │    │    │    │    └── filters (true)
 │    │    │         │    │    │    │    │    │    │    └── aggregations
 │    │    │         │    │    │    │    │    │    │         └── const-agg [as=customer.c_current_addr_sk:134, outer=(134)]
 │    │    │         │    │    │    │    │    │    │              └── customer.c_current_addr_sk:134
 │    │    │         │    │    │    │    │    │    └── filters (true)
 │    │    │         │    │    │    │    │    └── filters
 │    │    │         │    │    │    │    │         ├── ca_county:184 = s_county:215 [outer=(184,215), constraints=(/184: (/NULL - ]; /215: (/NULL - ]), fd=(184)==(215), (215)==(184)]
 │    │    │         │    │    │    │    │         └── ca_state:185 = s_state:216 [outer=(185,216), constraints=(/185: (/NULL - ]; /216: (/NULL - ]), fd=(185)==(216), (216)==(185)]
 │    │    │         │    │    │    │    └── filters
 │    │    │         │    │    │    │         └── customer.c_customer_sk:130 = ss_customer_sk:155 [outer=(130,155), constraints=(/130: (/NULL - ]; /155: (/NULL - ]), fd=(130)==(155), (155)==(130)]
 │    │    │         │    │    │    └── filters
 │    │    │         │    │    │         ├── ge [outer=(226), immutable, subquery, constraints=(/226: (/NULL - ])]
 │    │    │         │    │    │         │    ├── d_month_seq:226
 │    │    │         │    │    │         │    └── subquery
 │    │    │         │    │    │         │         └── max1-row
 │    │    │         │    │    │         │              ├── columns: "?column?":283
 │    │    │         │    │    │         │              ├── error: "more than one row returned by a subquery used as an expression"
 │    │    │         │    │    │         │              ├── cardinality: [0 - 1]
 │    │    │         │    │    │         │              ├── immutable
 │    │    │         │    │    │         │              ├── key: ()
 │    │    │         │    │    │         │              ├── fd: ()-->(283)
 │    │    │         │    │    │         │              └── distinct-on
 │    │    │         │    │    │         │                   ├── columns: "?column?":283
 │    │    │         │    │    │         │                   ├── grouping columns: "?column?":283
 │    │    │         │    │    │         │                   ├── immutable
 │    │    │         │    │    │         │                   ├── key: (283)
 │    │    │         │    │    │         │                   └── project
 │    │    │         │    │    │         │                        ├── columns: "?column?":283
 │    │    │         │    │    │         │                        ├── immutable
 │    │    │         │    │    │         │                        ├── select
 │    │    │         │    │    │         │                        │    ├── columns: d_month_seq:256 d_year:259!null d_moy:261!null
 │    │    │         │    │    │         │                        │    ├── fd: ()-->(259,261)
 │    │    │         │    │    │         │                        │    ├── scan date_dim
 │    │    │         │    │    │         │                        │    │    └── columns: d_month_seq:256 d_year:259 d_moy:261
 │    │    │         │    │    │         │                        │    └── filters
 │    │    │         │    │    │         │                        │         ├── d_year:259 = 1999 [outer=(259), constraints=(/259: [/1999 - /1999]; tight), fd=()-->(259)]
 │    │    │         │    │    │         │                        │         └── d_moy:261 = 1 [outer=(261), constraints=(/261: [/1 - /1]; tight), fd=()-->(261)]
 │    │    │         │    │    │         │                        └── projections
 │    │    │         │    │    │         │                             └── d_month_seq:256 + 1 [as="?column?":283, outer=(256), immutable]
 │    │    │         │    │    │         └── le [outer=(226), immutable, subquery, constraints=(/226: (/NULL - ])]
 │    │    │         │    │    │              ├── d_month_seq:226
 │    │    │         │    │    │              └── subquery
 │    │    │         │    │    │                   └── max1-row
 │    │    │         │    │    │                        ├── columns: "?column?":314
 │    │    │         │    │    │                        ├── error: "more than one row returned by a subquery used as an expression"
 │    │    │         │    │    │                        ├── cardinality: [0 - 1]
 │    │    │         │    │    │                        ├── immutable
 │    │    │         │    │    │                        ├── key: ()
 │    │    │         │    │    │                        ├── fd: ()-->(314)
 │    │    │         │    │    │                        └── distinct-on
 │    │    │         │    │    │                             ├── columns: "?column?":314
 │    │    │         │    │    │                             ├── grouping columns: "?column?":314
 │    │    │         │    │    │                             ├── immutable
 │    │    │         │    │    │                             ├── key: (314)
 │    │    │         │    │    │                             └── project
 │    │    │         │    │    │                                  ├── columns: "?column?":314
 │    │    │         │    │    │                                  ├── immutable
 │    │    │         │    │    │                                  ├── select
 │    │    │         │    │    │                                  │    ├── columns: d_month_seq:287 d_year:290!null d_moy:292!null
 │    │    │         │    │    │                                  │    ├── fd: ()-->(290,292)
 │    │    │         │    │    │                                  │    ├── scan date_dim
 │    │    │         │    │    │                                  │    │    └── columns: d_month_seq:287 d_year:290 d_moy:292
 │    │    │         │    │    │                                  │    └── filters
 │    │    │         │    │    │                                  │         ├── d_year:290 = 1999 [outer=(290), constraints=(/290: [/1999 - /1999]; tight), fd=()-->(290)]
 │    │    │         │    │    │                                  │         └── d_moy:292 = 1 [outer=(292), constraints=(/292: [/1 - /1]; tight), fd=()-->(292)]
 │    │    │         │    │    │                                  └── projections
 │    │    │         │    │    │                                       └── d_month_seq:287 + 3 [as="?column?":314, outer=(287), immutable]
 │    │    │         │    │    └── projections
 │    │    │         │    │         └── customer.c_customer_sk:130 [as=c_customer_sk:150, outer=(130)]
 │    │    │         │    └── aggregations
 │    │    │         │         └── sum [as=sum:315, outer=(167)]
 │    │    │         │              └── ss_ext_sales_price:167
 │    │    │         └── projections
 │    │    │              └── (sum:315 / 50)::INT8 [as=segment:319, outer=(315), immutable]
 │    │    └── aggregations
 │    │         └── count-rows [as=count_rows:320]
 │    └── 100
 └── projections
      └── segment:319 * 50 [as=segment_base:321, outer=(319), immutable]

# --------------------------------------------------
# Q55
opt
	SELECT
		i_brand_id AS brand_id,
		i_brand AS brand,
		sum(ss_ext_sales_price) AS ext_price
	FROM
		date_dim, store_sales, item
	WHERE
		d_date_sk = ss_sold_date_sk
		AND ss_item_sk = i_item_sk
		AND i_manager_id = 52
		AND d_moy = 11
		AND d_year = 2000
	GROUP BY
		i_brand, i_brand_id
	ORDER BY
		ext_price DESC, i_brand_id
	LIMIT
		100;
----
top-k
 ├── columns: brand_id:63 brand:64 ext_price:80
 ├── internal-ordering: -80,+63
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (63,64)
 ├── fd: (63,64)-->(80)
 ├── ordering: -80,+63
 └── group-by (hash)
      ├── columns: i_brand_id:63 i_brand:64 sum:80
      ├── grouping columns: i_brand_id:63 i_brand:64
      ├── key: (63,64)
      ├── fd: (63,64)-->(80)
      ├── inner-join (hash)
      │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null ss_sold_date_sk:31!null ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── fd: ()-->(7,9,76), (56)-->(63,64), (33)==(56), (56)==(33), (1)==(31), (31)==(1)
      │    ├── inner-join (lookup store_sales)
      │    │    ├── columns: ss_sold_date_sk:31 ss_item_sk:33!null ss_ext_sales_price:46 i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    │    ├── key columns: [56] = [33]
      │    │    ├── fd: ()-->(76), (56)-->(63,64), (33)==(56), (56)==(33)
      │    │    ├── select
      │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76!null
      │    │    │    ├── key: (56)
      │    │    │    ├── fd: ()-->(76), (56)-->(63,64)
      │    │    │    ├── scan item
      │    │    │    │    ├── columns: i_item_sk:56!null i_brand_id:63 i_brand:64 i_manager_id:76
      │    │    │    │    ├── key: (56)
      │    │    │    │    └── fd: (56)-->(63,64,76)
      │    │    │    └── filters
      │    │    │         └── i_manager_id:76 = 52 [outer=(76), constraints=(/76: [/52 - /52]; tight), fd=()-->(76)]
      │    │    └── filters (true)
      │    ├── select
      │    │    ├── columns: d_date_sk:1!null d_year:7!null d_moy:9!null
      │    │    ├── key: (1)
      │    │    ├── fd: ()-->(7,9)
      │    │    ├── scan date_dim
      │    │    │    ├── columns: d_date_sk:1!null d_year:7 d_moy:9
      │    │    │    ├── key: (1)
      │    │    │    └── fd: (1)-->(7,9)
      │    │    └── filters
      │    │         ├── d_moy:9 = 11 [outer=(9), constraints=(/9: [/11 - /11]; tight), fd=()-->(9)]
      │    │         └── d_year:7 = 2000 [outer=(7), constraints=(/7: [/2000 - /2000]; tight), fd=()-->(7)]
      │    └── filters
      │         └── d_date_sk:1 = ss_sold_date_sk:31 [outer=(1,31), constraints=(/1: (/NULL - ]; /31: (/NULL - ]), fd=(1)==(31), (31)==(1)]
      └── aggregations
           └── sum [as=sum:80, outer=(46)]
                └── ss_ext_sales_price:46

# --------------------------------------------------
# Q56
opt
	WITH
		ss
			AS (
				SELECT
					i_item_id,
					sum(ss_ext_sales_price) AS total_sales
				FROM
					store_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_color
								IN ('powder', 'orchid', 'pink')
						)
					AND ss_item_sk = i_item_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 3
					AND ss_addr_sk = ca_address_sk
					AND ca_gmt_offset = -6
				GROUP BY
					i_item_id
			),
		cs
			AS (
				SELECT
					i_item_id,
					sum(cs_ext_sales_price) AS total_sales
				FROM
					catalog_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_color
								IN ('powder', 'orchid', 'pink')
						)
					AND cs_item_sk = i_item_sk
					AND cs_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 3
					AND cs_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -6
				GROUP BY
					i_item_id
			),
		ws
			AS (
				SELECT
					i_item_id,
					sum(ws_ext_sales_price) AS total_sales
				FROM
					web_sales, date_dim, customer_address, item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_color
								IN ('powder', 'orchid', 'pink')
						)
					AND ws_item_sk = i_item_sk
					AND ws_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 3
					AND ws_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -6
				GROUP BY
					i_item_id
			)
	SELECT
		i_item_id, sum(total_sales) AS total_sales
	FROM
		(
			SELECT * FROM ss UNION ALL SELECT * FROM cs
			UNION ALL SELECT * FROM ws
		)
			AS tmp1
	GROUP BY
		i_item_id
	ORDER BY
		total_sales, i_item_id
	LIMIT
		100;
----
top-k
 ├── columns: i_item_id:391!null total_sales:393
 ├── internal-ordering: +393,+391
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (391)
 ├── fd: (391)-->(393)
 ├── ordering: +393,+391
 └── group-by (hash)
      ├── columns: i_item_id:391!null sum:393
      ├── grouping columns: i_item_id:391!null
      ├── immutable
      ├── key: (391)
      ├── fd: (391)-->(393)
      ├── union-all
      │    ├── columns: i_item_id:391!null total_sales:392
      │    ├── left columns: i_item_id:387 total_sales:388
      │    ├── right columns: i_item_id:389 total_sales:390
      │    ├── immutable
      │    ├── union-all
      │    │    ├── columns: i_item_id:387!null total_sales:388
      │    │    ├── left columns: i_item_id:383 total_sales:384
      │    │    ├── right columns: i_item_id:385 total_sales:386
      │    │    ├── immutable
      │    │    ├── project
      │    │    │    ├── columns: i_item_id:383!null total_sales:384
      │    │    │    ├── immutable
      │    │    │    ├── key: (383)
      │    │    │    ├── fd: (383)-->(384)
      │    │    │    ├── group-by (hash)
      │    │    │    │    ├── columns: item.i_item_id:72!null sum:120
      │    │    │    │    ├── grouping columns: item.i_item_id:72!null
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (72)
      │    │    │    │    ├── fd: (72)-->(120)
      │    │    │    │    ├── inner-join (lookup customer_address)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null ca_address_sk:56!null ca_gmt_offset:67!null i_item_sk:71!null item.i_item_id:72!null
      │    │    │    │    │    ├── key columns: [7] = [56]
      │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── fd: ()-->(32,34,67), (71)-->(72), (1)==(26), (26)==(1), (7)==(56), (56)==(7), (3)==(71), (71)==(3)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null i_item_sk:71!null item.i_item_id:72!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── fd: ()-->(32,34), (71)-->(72), (3)==(71), (71)==(3), (1)==(26), (26)==(1)
      │    │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16 i_item_sk:71!null item.i_item_id:72!null
      │    │    │    │    │    │    │    ├── key columns: [71] = [3]
      │    │    │    │    │    │    │    ├── fd: (71)-->(72), (3)==(71), (71)==(3)
      │    │    │    │    │    │    │    ├── semi-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: i_item_sk:71!null item.i_item_id:72!null
      │    │    │    │    │    │    │    │    ├── key: (71)
      │    │    │    │    │    │    │    │    ├── fd: (71)-->(72)
      │    │    │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:71!null item.i_item_id:72!null
      │    │    │    │    │    │    │    │    │    ├── key: (71)
      │    │    │    │    │    │    │    │    │    └── fd: (71)-->(72)
      │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    ├── columns: item.i_item_id:96!null i_color:112!null
      │    │    │    │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    │    │    │    └── columns: item.i_item_id:96!null i_color:112
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         └── i_color:112 IN ('orchid', 'pink', 'powder') [outer=(112), constraints=(/112: [/'orchid' - /'orchid'] [/'pink' - /'pink'] [/'powder' - /'powder']; tight)]
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── item.i_item_id:72 = item.i_item_id:96 [outer=(72,96), constraints=(/72: (/NULL - ]; /96: (/NULL - ]), fd=(72)==(96), (96)==(72)]
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_moy:34!null
      │    │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    │    ├── fd: ()-->(32,34)
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_moy:34
      │    │    │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    │    │    └── fd: (26)-->(32,34)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         ├── d_year:32 = 2000 [outer=(32), constraints=(/32: [/2000 - /2000]; tight), fd=()-->(32)]
      │    │    │    │    │    │    │         └── d_moy:34 = 3 [outer=(34), constraints=(/34: [/3 - /3]; tight), fd=()-->(34)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ca_gmt_offset:67 = -6 [outer=(67), immutable, constraints=(/67: [/-6 - /-6]; tight), fd=()-->(67)]
      │    │    │    │    └── aggregations
      │    │    │    │         └── sum [as=sum:120, outer=(16)]
      │    │    │    │              └── ss_ext_sales_price:16
      │    │    │    └── projections
      │    │    │         ├── item.i_item_id:72 [as=i_item_id:383, outer=(72)]
      │    │    │         └── sum:120 [as=total_sales:384, outer=(120)]
      │    │    └── project
      │    │         ├── columns: i_item_id:385!null total_sales:386
      │    │         ├── immutable
      │    │         ├── key: (385)
      │    │         ├── fd: (385)-->(386)
      │    │         ├── group-by (hash)
      │    │         │    ├── columns: item.i_item_id:203!null sum:251
      │    │         │    ├── grouping columns: item.i_item_id:203!null
      │    │         │    ├── immutable
      │    │         │    ├── key: (203)
      │    │         │    ├── fd: (203)-->(251)
      │    │         │    ├── inner-join (lookup customer_address)
      │    │         │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127!null cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null ca_address_sk:187!null ca_gmt_offset:198!null i_item_sk:202!null item.i_item_id:203!null
      │    │         │    │    ├── key columns: [127] = [187]
      │    │         │    │    ├── lookup columns are key
      │    │         │    │    ├── immutable
      │    │         │    │    ├── fd: ()-->(163,165,198), (202)-->(203), (121)==(157), (157)==(121), (127)==(187), (187)==(127), (136)==(202), (202)==(136)
      │    │         │    │    ├── inner-join (hash)
      │    │         │    │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null i_item_sk:202!null item.i_item_id:203!null
      │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    ├── fd: ()-->(163,165), (202)-->(203), (136)==(202), (202)==(136), (121)==(157), (157)==(121)
      │    │         │    │    │    ├── inner-join (lookup catalog_sales)
      │    │         │    │    │    │    ├── columns: cs_sold_date_sk:121 cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144 i_item_sk:202!null item.i_item_id:203!null
      │    │         │    │    │    │    ├── key columns: [202] = [136]
      │    │         │    │    │    │    ├── fd: (202)-->(203), (136)==(202), (202)==(136)
      │    │         │    │    │    │    ├── semi-join (hash)
      │    │         │    │    │    │    │    ├── columns: i_item_sk:202!null item.i_item_id:203!null
      │    │         │    │    │    │    │    ├── key: (202)
      │    │         │    │    │    │    │    ├── fd: (202)-->(203)
      │    │         │    │    │    │    │    ├── scan item
      │    │         │    │    │    │    │    │    ├── columns: i_item_sk:202!null item.i_item_id:203!null
      │    │         │    │    │    │    │    │    ├── key: (202)
      │    │         │    │    │    │    │    │    └── fd: (202)-->(203)
      │    │         │    │    │    │    │    ├── select
      │    │         │    │    │    │    │    │    ├── columns: item.i_item_id:227!null i_color:243!null
      │    │         │    │    │    │    │    │    ├── scan item
      │    │         │    │    │    │    │    │    │    └── columns: item.i_item_id:227!null i_color:243
      │    │         │    │    │    │    │    │    └── filters
      │    │         │    │    │    │    │    │         └── i_color:243 IN ('orchid', 'pink', 'powder') [outer=(243), constraints=(/243: [/'orchid' - /'orchid'] [/'pink' - /'pink'] [/'powder' - /'powder']; tight)]
      │    │         │    │    │    │    │    └── filters
      │    │         │    │    │    │    │         └── item.i_item_id:203 = item.i_item_id:227 [outer=(203,227), constraints=(/203: (/NULL - ]; /227: (/NULL - ]), fd=(203)==(227), (227)==(203)]
      │    │         │    │    │    │    └── filters (true)
      │    │         │    │    │    ├── select
      │    │         │    │    │    │    ├── columns: d_date_sk:157!null d_year:163!null d_moy:165!null
      │    │         │    │    │    │    ├── key: (157)
      │    │         │    │    │    │    ├── fd: ()-->(163,165)
      │    │         │    │    │    │    ├── scan date_dim
      │    │         │    │    │    │    │    ├── columns: d_date_sk:157!null d_year:163 d_moy:165
      │    │         │    │    │    │    │    ├── key: (157)
      │    │         │    │    │    │    │    └── fd: (157)-->(163,165)
      │    │         │    │    │    │    └── filters
      │    │         │    │    │    │         ├── d_year:163 = 2000 [outer=(163), constraints=(/163: [/2000 - /2000]; tight), fd=()-->(163)]
      │    │         │    │    │    │         └── d_moy:165 = 3 [outer=(165), constraints=(/165: [/3 - /3]; tight), fd=()-->(165)]
      │    │         │    │    │    └── filters
      │    │         │    │    │         └── cs_sold_date_sk:121 = d_date_sk:157 [outer=(121,157), constraints=(/121: (/NULL - ]; /157: (/NULL - ]), fd=(121)==(157), (157)==(121)]
      │    │         │    │    └── filters
      │    │         │    │         └── ca_gmt_offset:198 = -6 [outer=(198), immutable, constraints=(/198: [/-6 - /-6]; tight), fd=()-->(198)]
      │    │         │    └── aggregations
      │    │         │         └── sum [as=sum:251, outer=(144)]
      │    │         │              └── cs_ext_sales_price:144
      │    │         └── projections
      │    │              ├── item.i_item_id:203 [as=i_item_id:385, outer=(203)]
      │    │              └── sum:251 [as=total_sales:386, outer=(251)]
      │    └── project
      │         ├── columns: i_item_id:389!null total_sales:390
      │         ├── immutable
      │         ├── key: (389)
      │         ├── fd: (389)-->(390)
      │         ├── group-by (hash)
      │         │    ├── columns: item.i_item_id:334!null sum:382
      │         │    ├── grouping columns: item.i_item_id:334!null
      │         │    ├── immutable
      │         │    ├── key: (334)
      │         │    ├── fd: (334)-->(382)
      │         │    ├── inner-join (lookup customer_address)
      │         │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259!null ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null ca_address_sk:318!null ca_gmt_offset:329!null i_item_sk:333!null item.i_item_id:334!null
      │         │    │    ├── key columns: [259] = [318]
      │         │    │    ├── lookup columns are key
      │         │    │    ├── immutable
      │         │    │    ├── fd: ()-->(294,296,329), (333)-->(334), (252)==(288), (288)==(252), (259)==(318), (318)==(259), (255)==(333), (333)==(255)
      │         │    │    ├── inner-join (hash)
      │         │    │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null i_item_sk:333!null item.i_item_id:334!null
      │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    │    ├── fd: ()-->(294,296), (333)-->(334), (255)==(333), (333)==(255), (252)==(288), (288)==(252)
      │         │    │    │    ├── inner-join (lookup web_sales)
      │         │    │    │    │    ├── columns: ws_sold_date_sk:252 ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275 i_item_sk:333!null item.i_item_id:334!null
      │         │    │    │    │    ├── key columns: [333] = [255]
      │         │    │    │    │    ├── fd: (333)-->(334), (255)==(333), (333)==(255)
      │         │    │    │    │    ├── semi-join (hash)
      │         │    │    │    │    │    ├── columns: i_item_sk:333!null item.i_item_id:334!null
      │         │    │    │    │    │    ├── key: (333)
      │         │    │    │    │    │    ├── fd: (333)-->(334)
      │         │    │    │    │    │    ├── scan item
      │         │    │    │    │    │    │    ├── columns: i_item_sk:333!null item.i_item_id:334!null
      │         │    │    │    │    │    │    ├── key: (333)
      │         │    │    │    │    │    │    └── fd: (333)-->(334)
      │         │    │    │    │    │    ├── select
      │         │    │    │    │    │    │    ├── columns: item.i_item_id:358!null i_color:374!null
      │         │    │    │    │    │    │    ├── scan item
      │         │    │    │    │    │    │    │    └── columns: item.i_item_id:358!null i_color:374
      │         │    │    │    │    │    │    └── filters
      │         │    │    │    │    │    │         └── i_color:374 IN ('orchid', 'pink', 'powder') [outer=(374), constraints=(/374: [/'orchid' - /'orchid'] [/'pink' - /'pink'] [/'powder' - /'powder']; tight)]
      │         │    │    │    │    │    └── filters
      │         │    │    │    │    │         └── item.i_item_id:334 = item.i_item_id:358 [outer=(334,358), constraints=(/334: (/NULL - ]; /358: (/NULL - ]), fd=(334)==(358), (358)==(334)]
      │         │    │    │    │    └── filters (true)
      │         │    │    │    ├── select
      │         │    │    │    │    ├── columns: d_date_sk:288!null d_year:294!null d_moy:296!null
      │         │    │    │    │    ├── key: (288)
      │         │    │    │    │    ├── fd: ()-->(294,296)
      │         │    │    │    │    ├── scan date_dim
      │         │    │    │    │    │    ├── columns: d_date_sk:288!null d_year:294 d_moy:296
      │         │    │    │    │    │    ├── key: (288)
      │         │    │    │    │    │    └── fd: (288)-->(294,296)
      │         │    │    │    │    └── filters
      │         │    │    │    │         ├── d_year:294 = 2000 [outer=(294), constraints=(/294: [/2000 - /2000]; tight), fd=()-->(294)]
      │         │    │    │    │         └── d_moy:296 = 3 [outer=(296), constraints=(/296: [/3 - /3]; tight), fd=()-->(296)]
      │         │    │    │    └── filters
      │         │    │    │         └── ws_sold_date_sk:252 = d_date_sk:288 [outer=(252,288), constraints=(/252: (/NULL - ]; /288: (/NULL - ]), fd=(252)==(288), (288)==(252)]
      │         │    │    └── filters
      │         │    │         └── ca_gmt_offset:329 = -6 [outer=(329), immutable, constraints=(/329: [/-6 - /-6]; tight), fd=()-->(329)]
      │         │    └── aggregations
      │         │         └── sum [as=sum:382, outer=(275)]
      │         │              └── ws_ext_sales_price:275
      │         └── projections
      │              ├── item.i_item_id:334 [as=i_item_id:389, outer=(334)]
      │              └── sum:382 [as=total_sales:390, outer=(382)]
      └── aggregations
           └── sum [as=sum:393, outer=(392)]
                └── total_sales:392

# --------------------------------------------------
# Q57
opt
	WITH
		v1
			AS (
				SELECT
					i_category,
					i_brand,
					cc_name,
					d_year,
					d_moy,
					sum(cs_sales_price) AS sum_sales,
					avg(sum(cs_sales_price)) OVER (
						PARTITION BY
							i_category, i_brand, cc_name, d_year
					)
						AS avg_monthly_sales,
					rank() OVER (
						PARTITION BY
							i_category, i_brand, cc_name
						ORDER BY
							d_year, d_moy
					)
						AS rn
				FROM
					item, catalog_sales, date_dim, call_center
				WHERE
					cs_item_sk = i_item_sk
					AND cs_sold_date_sk = d_date_sk
					AND cc_call_center_sk = cs_call_center_sk
					AND (
							d_year = 2001
							OR (
									d_year = 2001 - 1
									AND d_moy = 12
								)
							OR (d_year = 2001 + 1 AND d_moy = 1)
						)
				GROUP BY
					i_category, i_brand, cc_name, d_year, d_moy
			),
		v2
			AS (
				SELECT
					v1.i_category,
					v1.i_brand,
					v1.cc_name,
					v1.d_year,
					v1.avg_monthly_sales,
					v1.sum_sales,
					v1_lag.sum_sales AS psum,
					v1_lead.sum_sales AS nsum
				FROM
					v1, v1 AS v1_lag, v1 AS v1_lead
				WHERE
					v1.i_category = v1_lag.i_category
					AND v1.i_category = v1_lead.i_category
					AND v1.i_brand = v1_lag.i_brand
					AND v1.i_brand = v1_lead.i_brand
					AND v1.cc_name = v1_lag.cc_name
					AND v1.cc_name = v1_lead.cc_name
					AND v1.rn = v1_lag.rn + 1
					AND v1.rn = v1_lead.rn - 1
			)
	SELECT
		*
	FROM
		v2
	WHERE
		d_year = 2001
		AND avg_monthly_sales > 0
		AND CASE
			WHEN avg_monthly_sales > 0
			THEN abs(sum_sales - avg_monthly_sales)
			/ avg_monthly_sales
			ELSE NULL
			END
			> 0.1
	ORDER BY
		sum_sales - avg_monthly_sales, avg_monthly_sales
	LIMIT
		100;
----
with &1 (v1)
 ├── columns: i_category:154!null i_brand:155!null cc_name:156!null d_year:157!null avg_monthly_sales:158!null sum_sales:159 psum:160 nsum:161  [hidden: column162:162]
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── fd: ()-->(157), (158,159)-->(162)
 ├── ordering: +162,+158 opt(157) [actual: +162,+158]
 ├── window partition=(9,13,97) ordering=+67,+69 opt(9,13,97)
 │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:67!null date_dim.d_moy:69 call_center.cc_name:97 sum:124 avg:125 rank:126
 │    ├── key: (9,13,67,69,97)
 │    ├── fd: (9,13,67,69,97)-->(124-126)
 │    ├── window partition=(9,13,67,97)
 │    │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:67!null date_dim.d_moy:69 call_center.cc_name:97 sum:124 avg:125
 │    │    ├── key: (9,13,67,69,97)
 │    │    ├── fd: (9,13,67,69,97)-->(124,125)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: item.i_brand:9 item.i_category:13 date_dim.d_year:67!null date_dim.d_moy:69 call_center.cc_name:97 sum:124
 │    │    │    ├── grouping columns: item.i_brand:9 item.i_category:13 date_dim.d_year:67!null date_dim.d_moy:69 call_center.cc_name:97
 │    │    │    ├── key: (9,13,67,69,97)
 │    │    │    ├── fd: (9,13,67,69,97)-->(124)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: i_item_sk:1!null item.i_brand:9 item.i_category:13 cs_sold_date_sk:25!null cs_call_center_sk:36!null cs_item_sk:40!null cs_sales_price:46 d_date_sk:61!null date_dim.d_year:67!null date_dim.d_moy:69 cc_call_center_sk:91!null call_center.cc_name:97
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (1)-->(9,13), (61)-->(67,69), (91)-->(97), (25)==(61), (61)==(25), (36)==(91), (91)==(36), (1)==(40), (40)==(1)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: cs_sold_date_sk:25!null cs_call_center_sk:36!null cs_item_sk:40!null cs_sales_price:46 d_date_sk:61!null date_dim.d_year:67!null date_dim.d_moy:69 cc_call_center_sk:91!null call_center.cc_name:97
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (61)-->(67,69), (91)-->(97), (25)==(61), (61)==(25), (36)==(91), (91)==(36)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: cs_sold_date_sk:25!null cs_call_center_sk:36 cs_item_sk:40!null cs_sales_price:46 d_date_sk:61!null date_dim.d_year:67!null date_dim.d_moy:69
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (61)-->(67,69), (25)==(61), (61)==(25)
 │    │    │    │    │    │    ├── scan catalog_sales
 │    │    │    │    │    │    │    └── columns: cs_sold_date_sk:25 cs_call_center_sk:36 cs_item_sk:40!null cs_sales_price:46
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: d_date_sk:61!null date_dim.d_year:67!null date_dim.d_moy:69
 │    │    │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    │    │    ├── fd: (61)-->(67,69)
 │    │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    │    ├── columns: d_date_sk:61!null date_dim.d_year:67 date_dim.d_moy:69
 │    │    │    │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    │    │    │    └── fd: (61)-->(67,69)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ((date_dim.d_year:67 = 2001) OR ((date_dim.d_year:67 = 2000) AND (date_dim.d_moy:69 = 12))) OR ((date_dim.d_year:67 = 2002) AND (date_dim.d_moy:69 = 1)) [outer=(67,69), constraints=(/67: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002])]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── cs_sold_date_sk:25 = d_date_sk:61 [outer=(25,61), constraints=(/25: (/NULL - ]; /61: (/NULL - ]), fd=(25)==(61), (61)==(25)]
 │    │    │    │    │    ├── scan call_center
 │    │    │    │    │    │    ├── columns: cc_call_center_sk:91!null call_center.cc_name:97
 │    │    │    │    │    │    ├── key: (91)
 │    │    │    │    │    │    └── fd: (91)-->(97)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── cc_call_center_sk:91 = cs_call_center_sk:36 [outer=(36,91), constraints=(/36: (/NULL - ]; /91: (/NULL - ]), fd=(36)==(91), (91)==(36)]
 │    │    │    │    ├── scan item
 │    │    │    │    │    ├── columns: i_item_sk:1!null item.i_brand:9 item.i_category:13
 │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    └── fd: (1)-->(9,13)
 │    │    │    │    └── filters
 │    │    │    │         └── cs_item_sk:40 = i_item_sk:1 [outer=(1,40), constraints=(/1: (/NULL - ]; /40: (/NULL - ]), fd=(1)==(40), (40)==(1)]
 │    │    │    └── aggregations
 │    │    │         └── sum [as=sum:124, outer=(46)]
 │    │    │              └── cs_sales_price:46
 │    │    └── windows
 │    │         └── avg [as=avg:125, outer=(124)]
 │    │              └── sum:124
 │    └── windows
 │         └── rank [as=rank:126]
 └── top-k
      ├── columns: i_category:154!null i_brand:155!null cc_name:156!null d_year:157!null avg_monthly_sales:158!null sum_sales:159 psum:160 nsum:161 column162:162
      ├── internal-ordering: +162,+158 opt(157)
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── fd: ()-->(157), (158,159)-->(162)
      ├── ordering: +162,+158 opt(157) [actual: +162,+158]
      └── project
           ├── columns: column162:162 i_category:154!null i_brand:155!null cc_name:156!null d_year:157!null avg_monthly_sales:158!null sum_sales:159 psum:160 nsum:161
           ├── immutable
           ├── fd: ()-->(157), (158,159)-->(162)
           ├── project
           │    ├── columns: i_category:154!null i_brand:155!null cc_name:156!null d_year:157!null avg_monthly_sales:158!null sum_sales:159 psum:160 nsum:161
           │    ├── immutable
           │    ├── fd: ()-->(157)
           │    ├── inner-join (hash)
           │    │    ├── columns: i_category:127!null i_brand:128!null cc_name:129!null d_year:130!null sum_sales:132 avg_monthly_sales:133!null rn:134!null i_category:135!null i_brand:136!null cc_name:137!null sum_sales:140 sum_sales:148 column151:151!null
           │    │    ├── immutable
           │    │    ├── fd: ()-->(130), (127)==(135), (135)==(127), (128)==(136), (136)==(128), (129)==(137), (137)==(129), (134)==(151), (151)==(134)
           │    │    ├── select
           │    │    │    ├── columns: i_category:127 i_brand:128 cc_name:129 d_year:130!null sum_sales:132 avg_monthly_sales:133!null rn:134
           │    │    │    ├── immutable
           │    │    │    ├── fd: ()-->(130)
           │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    ├── columns: i_category:127 i_brand:128 cc_name:129 d_year:130!null sum_sales:132 avg_monthly_sales:133 rn:134
           │    │    │    │    └── mapping:
           │    │    │    │         ├──  item.i_category:13 => i_category:127
           │    │    │    │         ├──  item.i_brand:9 => i_brand:128
           │    │    │    │         ├──  call_center.cc_name:97 => cc_name:129
           │    │    │    │         ├──  date_dim.d_year:67 => d_year:130
           │    │    │    │         ├──  sum:124 => sum_sales:132
           │    │    │    │         ├──  avg:125 => avg_monthly_sales:133
           │    │    │    │         └──  rank:126 => rn:134
           │    │    │    └── filters
           │    │    │         ├── d_year:130 = 2001 [outer=(130), constraints=(/130: [/2001 - /2001]; tight), fd=()-->(130)]
           │    │    │         ├── avg_monthly_sales:133 > 0 [outer=(133), immutable, constraints=(/133: (/0 - ]; tight)]
           │    │    │         └── CASE WHEN avg_monthly_sales:133 > 0 THEN abs(sum_sales:132 - avg_monthly_sales:133) / avg_monthly_sales:133 ELSE CAST(NULL AS DECIMAL) END > 0.1 [outer=(132,133), immutable]
           │    │    ├── project
           │    │    │    ├── columns: column151:151 i_category:135!null i_brand:136!null cc_name:137!null sum_sales:140 sum_sales:148
           │    │    │    ├── immutable
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: i_category:135!null i_brand:136!null cc_name:137!null sum_sales:140 rn:142 i_category:143!null i_brand:144!null cc_name:145!null sum_sales:148 column152:152!null column153:153!null
           │    │    │    │    ├── immutable
           │    │    │    │    ├── fd: (142)-->(152), (135)==(143), (143)==(135), (136)==(144), (144)==(136), (137)==(145), (145)==(137), (152)==(153), (153)==(152)
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: column152:152 i_category:135 i_brand:136 cc_name:137 sum_sales:140 rn:142
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── fd: (142)-->(152)
           │    │    │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    │    │    ├── columns: i_category:135 i_brand:136 cc_name:137 sum_sales:140 rn:142
           │    │    │    │    │    │    └── mapping:
           │    │    │    │    │    │         ├──  item.i_category:13 => i_category:135
           │    │    │    │    │    │         ├──  item.i_brand:9 => i_brand:136
           │    │    │    │    │    │         ├──  call_center.cc_name:97 => cc_name:137
           │    │    │    │    │    │         ├──  sum:124 => sum_sales:140
           │    │    │    │    │    │         └──  rank:126 => rn:142
           │    │    │    │    │    └── projections
           │    │    │    │    │         └── rn:142 + 1 [as=column152:152, outer=(142), immutable]
           │    │    │    │    ├── project
           │    │    │    │    │    ├── columns: column153:153 i_category:143 i_brand:144 cc_name:145 sum_sales:148
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── with-scan &1 (v1)
           │    │    │    │    │    │    ├── columns: i_category:143 i_brand:144 cc_name:145 sum_sales:148 rn:150
           │    │    │    │    │    │    └── mapping:
           │    │    │    │    │    │         ├──  item.i_category:13 => i_category:143
           │    │    │    │    │    │         ├──  item.i_brand:9 => i_brand:144
           │    │    │    │    │    │         ├──  call_center.cc_name:97 => cc_name:145
           │    │    │    │    │    │         ├──  sum:124 => sum_sales:148
           │    │    │    │    │    │         └──  rank:126 => rn:150
           │    │    │    │    │    └── projections
           │    │    │    │    │         └── rn:150 - 1 [as=column153:153, outer=(150), immutable]
           │    │    │    │    └── filters
           │    │    │    │         ├── i_category:135 = i_category:143 [outer=(135,143), constraints=(/135: (/NULL - ]; /143: (/NULL - ]), fd=(135)==(143), (143)==(135)]
           │    │    │    │         ├── i_brand:136 = i_brand:144 [outer=(136,144), constraints=(/136: (/NULL - ]; /144: (/NULL - ]), fd=(136)==(144), (144)==(136)]
           │    │    │    │         ├── cc_name:137 = cc_name:145 [outer=(137,145), constraints=(/137: (/NULL - ]; /145: (/NULL - ]), fd=(137)==(145), (145)==(137)]
           │    │    │    │         └── column152:152 = column153:153 [outer=(152,153), constraints=(/152: (/NULL - ]; /153: (/NULL - ]), fd=(152)==(153), (153)==(152)]
           │    │    │    └── projections
           │    │    │         └── rn:142 + 1 [as=column151:151, outer=(142), immutable]
           │    │    └── filters
           │    │         ├── i_category:127 = i_category:135 [outer=(127,135), constraints=(/127: (/NULL - ]; /135: (/NULL - ]), fd=(127)==(135), (135)==(127)]
           │    │         ├── i_brand:128 = i_brand:136 [outer=(128,136), constraints=(/128: (/NULL - ]; /136: (/NULL - ]), fd=(128)==(136), (136)==(128)]
           │    │         ├── cc_name:129 = cc_name:137 [outer=(129,137), constraints=(/129: (/NULL - ]; /137: (/NULL - ]), fd=(129)==(137), (137)==(129)]
           │    │         └── rn:134 = column151:151 [outer=(134,151), constraints=(/134: (/NULL - ]; /151: (/NULL - ]), fd=(134)==(151), (151)==(134)]
           │    └── projections
           │         ├── i_category:127 [as=i_category:154, outer=(127)]
           │         ├── i_brand:128 [as=i_brand:155, outer=(128)]
           │         ├── cc_name:129 [as=cc_name:156, outer=(129)]
           │         ├── d_year:130 [as=d_year:157, outer=(130)]
           │         ├── avg_monthly_sales:133 [as=avg_monthly_sales:158, outer=(133)]
           │         ├── sum_sales:132 [as=sum_sales:159, outer=(132)]
           │         ├── sum_sales:140 [as=psum:160, outer=(140)]
           │         └── sum_sales:148 [as=nsum:161, outer=(148)]
           └── projections
                └── sum_sales:159 - avg_monthly_sales:158 [as=column162:162, outer=(158,159), immutable]

# --------------------------------------------------
# Q58
opt
	WITH
		ss_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(ss_ext_sales_price) AS ss_item_rev
				FROM
					store_sales, item, date_dim
				WHERE
					ss_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									= (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												= '2001-06-16'
										)
							)
					AND ss_sold_date_sk = d_date_sk
				GROUP BY
					i_item_id
			),
		cs_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(cs_ext_sales_price) AS cs_item_rev
				FROM
					catalog_sales, item, date_dim
				WHERE
					cs_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									= (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												= '2001-06-16'
										)
							)
					AND cs_sold_date_sk = d_date_sk
				GROUP BY
					i_item_id
			),
		ws_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(ws_ext_sales_price) AS ws_item_rev
				FROM
					web_sales, item, date_dim
				WHERE
					ws_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									= (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												= '2001-06-16'
										)
							)
					AND ws_sold_date_sk = d_date_sk
				GROUP BY
					i_item_id
			)
	SELECT
		ss_items.item_id,
		ss_item_rev,
		ss_item_rev
		/ ((ss_item_rev + cs_item_rev + ws_item_rev) / 3)
		* 100
			AS ss_dev,
		cs_item_rev,
		cs_item_rev
		/ ((ss_item_rev + cs_item_rev + ws_item_rev) / 3)
		* 100
			AS cs_dev,
		ws_item_rev,
		ws_item_rev
		/ ((ss_item_rev + cs_item_rev + ws_item_rev) / 3)
		* 100
			AS ws_dev,
		(ss_item_rev + cs_item_rev + ws_item_rev) / 3 AS average
	FROM
		ss_items, cs_items, ws_items
	WHERE
		ss_items.item_id = cs_items.item_id
		AND ss_items.item_id = ws_items.item_id
		AND ss_item_rev BETWEEN (0.9 * cs_item_rev) AND (1.1 * cs_item_rev)
		AND ss_item_rev BETWEEN (0.9 * ws_item_rev) AND (1.1 * ws_item_rev)
		AND cs_item_rev BETWEEN (0.9 * ss_item_rev) AND (1.1 * ss_item_rev)
		AND cs_item_rev BETWEEN (0.9 * ws_item_rev) AND (1.1 * ws_item_rev)
		AND ws_item_rev BETWEEN (0.9 * ss_item_rev) AND (1.1 * ss_item_rev)
		AND ws_item_rev BETWEEN (0.9 * cs_item_rev) AND (1.1 * cs_item_rev)
	ORDER BY
		item_id, ss_item_rev
	LIMIT
		100;
----
project
 ├── columns: item_id:446!null ss_item_rev:447!null ss_dev:464!null cs_item_rev:449!null cs_dev:465!null ws_item_rev:451!null ws_dev:466!null average:467!null
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (446)
 ├── fd: (446)-->(447,449,451), (447,449,451)-->(464-467)
 ├── ordering: +446
 ├── top-k
 │    ├── columns: item_id:446!null ss_item_rev:447!null item_id:448!null cs_item_rev:449!null ws_item_rev:451!null column456:456!null column457:457!null column458:458!null column459:459!null column460:460!null column461:461!null column462:462!null column463:463!null
 │    ├── internal-ordering: +(446|448)
 │    ├── k: 100
 │    ├── cardinality: [0 - 100]
 │    ├── immutable
 │    ├── key: (448)
 │    ├── fd: (446)-->(447), (447)-->(460-463), (448)-->(449,451), (449)-->(456,457), (451)-->(458,459), (446)==(448), (448)==(446)
 │    ├── ordering: +(446|448) [actual: +446]
 │    └── inner-join (hash)
 │         ├── columns: item_id:446!null ss_item_rev:447!null item_id:448!null cs_item_rev:449!null ws_item_rev:451!null column456:456!null column457:457!null column458:458!null column459:459!null column460:460!null column461:461!null column462:462!null column463:463!null
 │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
 │         ├── immutable
 │         ├── key: (448)
 │         ├── fd: (446)-->(447), (447)-->(460-463), (448)-->(449,451), (449)-->(456,457), (451)-->(458,459), (446)==(448), (448)==(446)
 │         ├── project
 │         │    ├── columns: column463:463 column462:462 column461:461 column460:460 item_id:446!null ss_item_rev:447
 │         │    ├── immutable
 │         │    ├── key: (446)
 │         │    ├── fd: (446)-->(447), (447)-->(460-463)
 │         │    ├── project
 │         │    │    ├── columns: item_id:446!null ss_item_rev:447
 │         │    │    ├── key: (446)
 │         │    │    ├── fd: (446)-->(447)
 │         │    │    ├── group-by (hash)
 │         │    │    │    ├── columns: i_item_id:27!null sum:141
 │         │    │    │    ├── grouping columns: i_item_id:27!null
 │         │    │    │    ├── key: (27)
 │         │    │    │    ├── fd: (27)-->(141)
 │         │    │    │    ├── inner-join (hash)
 │         │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_ext_sales_price:16 i_item_sk:26!null i_item_id:27!null d_date_sk:50!null d_date:52
 │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    ├── fd: (26)-->(27), (50)-->(52), (3)==(26), (26)==(3), (1)==(50), (50)==(1)
 │         │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_ext_sales_price:16 d_date_sk:50!null d_date:52
 │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    ├── fd: (50)-->(52), (1)==(50), (50)==(1)
 │         │    │    │    │    │    ├── scan store_sales
 │         │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_ext_sales_price:16
 │         │    │    │    │    │    ├── semi-join (hash)
 │         │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_date:52
 │         │    │    │    │    │    │    ├── key: (50)
 │         │    │    │    │    │    │    ├── fd: (50)-->(52)
 │         │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_date:52
 │         │    │    │    │    │    │    │    ├── key: (50)
 │         │    │    │    │    │    │    │    └── fd: (50)-->(52)
 │         │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    ├── columns: d_date:82 d_week_seq:84!null d_week_seq:114!null
 │         │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    ├── fd: ()-->(84,114), (84)==(114), (114)==(84)
 │         │    │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    │    └── columns: d_date:82 d_week_seq:84
 │         │    │    │    │    │    │    │    ├── max1-row
 │         │    │    │    │    │    │    │    │    ├── columns: d_week_seq:114
 │         │    │    │    │    │    │    │    │    ├── error: "more than one row returned by a subquery used as an expression"
 │         │    │    │    │    │    │    │    │    ├── cardinality: [0 - 1]
 │         │    │    │    │    │    │    │    │    ├── key: ()
 │         │    │    │    │    │    │    │    │    ├── fd: ()-->(114)
 │         │    │    │    │    │    │    │    │    └── project
 │         │    │    │    │    │    │    │    │         ├── columns: d_week_seq:114
 │         │    │    │    │    │    │    │    │         └── select
 │         │    │    │    │    │    │    │    │              ├── columns: d_date:112!null d_week_seq:114
 │         │    │    │    │    │    │    │    │              ├── fd: ()-->(112)
 │         │    │    │    │    │    │    │    │              ├── scan date_dim
 │         │    │    │    │    │    │    │    │              │    └── columns: d_date:112 d_week_seq:114
 │         │    │    │    │    │    │    │    │              └── filters
 │         │    │    │    │    │    │    │    │                   └── d_date:112 = '2001-06-16' [outer=(112), constraints=(/112: [/'2001-06-16' - /'2001-06-16']; tight), fd=()-->(112)]
 │         │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │         └── d_week_seq:84 = d_week_seq:114 [outer=(84,114), constraints=(/84: (/NULL - ]; /114: (/NULL - ]), fd=(84)==(114), (114)==(84)]
 │         │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │         └── d_date:52 = d_date:82 [outer=(52,82), constraints=(/52: (/NULL - ]; /82: (/NULL - ]), fd=(52)==(82), (82)==(52)]
 │         │    │    │    │    │    └── filters
 │         │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
 │         │    │    │    │    ├── scan item
 │         │    │    │    │    │    ├── columns: i_item_sk:26!null i_item_id:27!null
 │         │    │    │    │    │    ├── key: (26)
 │         │    │    │    │    │    └── fd: (26)-->(27)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── ss_item_sk:3 = i_item_sk:26 [outer=(3,26), constraints=(/3: (/NULL - ]; /26: (/NULL - ]), fd=(3)==(26), (26)==(3)]
 │         │    │    │    └── aggregations
 │         │    │    │         └── sum [as=sum:141, outer=(16)]
 │         │    │    │              └── ss_ext_sales_price:16
 │         │    │    └── projections
 │         │    │         ├── i_item_id:27 [as=item_id:446, outer=(27)]
 │         │    │         └── sum:141 [as=ss_item_rev:447, outer=(141)]
 │         │    └── projections
 │         │         ├── ss_item_rev:447 * 1.1 [as=column463:463, outer=(447), immutable]
 │         │         ├── ss_item_rev:447 * 0.9 [as=column462:462, outer=(447), immutable]
 │         │         ├── ss_item_rev:447 * 1.1 [as=column461:461, outer=(447), immutable]
 │         │         └── ss_item_rev:447 * 0.9 [as=column460:460, outer=(447), immutable]
 │         ├── project
 │         │    ├── columns: column459:459!null column458:458!null column457:457!null column456:456!null item_id:448!null cs_item_rev:449!null ws_item_rev:451!null
 │         │    ├── immutable
 │         │    ├── key: (448)
 │         │    ├── fd: (448)-->(449,451), (449)-->(456,457), (451)-->(458,459)
 │         │    ├── inner-join (hash)
 │         │    │    ├── columns: item_id:448!null cs_item_rev:449!null item_id:450!null ws_item_rev:451!null column452:452!null column453:453!null column454:454!null column455:455!null
 │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
 │         │    │    ├── immutable
 │         │    │    ├── key: (450)
 │         │    │    ├── fd: (448)-->(449), (449)-->(454,455), (450)-->(451), (451)-->(452,453), (448)==(450), (450)==(448)
 │         │    │    ├── project
 │         │    │    │    ├── columns: column455:455 column454:454 item_id:448!null cs_item_rev:449
 │         │    │    │    ├── immutable
 │         │    │    │    ├── key: (448)
 │         │    │    │    ├── fd: (448)-->(449), (449)-->(454,455)
 │         │    │    │    ├── project
 │         │    │    │    │    ├── columns: item_id:448!null cs_item_rev:449
 │         │    │    │    │    ├── key: (448)
 │         │    │    │    │    ├── fd: (448)-->(449)
 │         │    │    │    │    ├── group-by (hash)
 │         │    │    │    │    │    ├── columns: i_item_id:179!null sum:293
 │         │    │    │    │    │    ├── grouping columns: i_item_id:179!null
 │         │    │    │    │    │    ├── key: (179)
 │         │    │    │    │    │    ├── fd: (179)-->(293)
 │         │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    ├── columns: cs_sold_date_sk:142!null cs_item_sk:157!null cs_ext_sales_price:165 i_item_sk:178!null i_item_id:179!null d_date_sk:202!null d_date:204
 │         │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │         │    │    │    │    │    │    ├── fd: (178)-->(179), (202)-->(204), (157)==(178), (178)==(157), (142)==(202), (202)==(142)
 │         │    │    │    │    │    │    ├── scan item
 │         │    │    │    │    │    │    │    ├── columns: i_item_sk:178!null i_item_id:179!null
 │         │    │    │    │    │    │    │    ├── key: (178)
 │         │    │    │    │    │    │    │    └── fd: (178)-->(179)
 │         │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:142!null cs_item_sk:157!null cs_ext_sales_price:165 d_date_sk:202!null d_date:204
 │         │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    ├── fd: (202)-->(204), (142)==(202), (202)==(142)
 │         │    │    │    │    │    │    │    ├── scan catalog_sales
 │         │    │    │    │    │    │    │    │    └── columns: cs_sold_date_sk:142 cs_item_sk:157!null cs_ext_sales_price:165
 │         │    │    │    │    │    │    │    ├── semi-join (hash)
 │         │    │    │    │    │    │    │    │    ├── columns: d_date_sk:202!null d_date:204
 │         │    │    │    │    │    │    │    │    ├── key: (202)
 │         │    │    │    │    │    │    │    │    ├── fd: (202)-->(204)
 │         │    │    │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:202!null d_date:204
 │         │    │    │    │    │    │    │    │    │    ├── key: (202)
 │         │    │    │    │    │    │    │    │    │    └── fd: (202)-->(204)
 │         │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    │    │    ├── columns: d_date:234 d_week_seq:236!null d_week_seq:266!null
 │         │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    │    │    ├── fd: ()-->(236,266), (236)==(266), (266)==(236)
 │         │    │    │    │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    │    └── columns: d_date:234 d_week_seq:236
 │         │    │    │    │    │    │    │    │    │    ├── max1-row
 │         │    │    │    │    │    │    │    │    │    │    ├── columns: d_week_seq:266
 │         │    │    │    │    │    │    │    │    │    │    ├── error: "more than one row returned by a subquery used as an expression"
 │         │    │    │    │    │    │    │    │    │    │    ├── cardinality: [0 - 1]
 │         │    │    │    │    │    │    │    │    │    │    ├── key: ()
 │         │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(266)
 │         │    │    │    │    │    │    │    │    │    │    └── project
 │         │    │    │    │    │    │    │    │    │    │         ├── columns: d_week_seq:266
 │         │    │    │    │    │    │    │    │    │    │         └── select
 │         │    │    │    │    │    │    │    │    │    │              ├── columns: d_date:264!null d_week_seq:266
 │         │    │    │    │    │    │    │    │    │    │              ├── fd: ()-->(264)
 │         │    │    │    │    │    │    │    │    │    │              ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    │              │    └── columns: d_date:264 d_week_seq:266
 │         │    │    │    │    │    │    │    │    │    │              └── filters
 │         │    │    │    │    │    │    │    │    │    │                   └── d_date:264 = '2001-06-16' [outer=(264), constraints=(/264: [/'2001-06-16' - /'2001-06-16']; tight), fd=()-->(264)]
 │         │    │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │    │         └── d_week_seq:236 = d_week_seq:266 [outer=(236,266), constraints=(/236: (/NULL - ]; /266: (/NULL - ]), fd=(236)==(266), (266)==(236)]
 │         │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │         └── d_date:204 = d_date:234 [outer=(204,234), constraints=(/204: (/NULL - ]; /234: (/NULL - ]), fd=(204)==(234), (234)==(204)]
 │         │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │         └── cs_sold_date_sk:142 = d_date_sk:202 [outer=(142,202), constraints=(/142: (/NULL - ]; /202: (/NULL - ]), fd=(142)==(202), (202)==(142)]
 │         │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │         └── cs_item_sk:157 = i_item_sk:178 [outer=(157,178), constraints=(/157: (/NULL - ]; /178: (/NULL - ]), fd=(157)==(178), (178)==(157)]
 │         │    │    │    │    │    └── aggregations
 │         │    │    │    │    │         └── sum [as=sum:293, outer=(165)]
 │         │    │    │    │    │              └── cs_ext_sales_price:165
 │         │    │    │    │    └── projections
 │         │    │    │    │         ├── i_item_id:179 [as=item_id:448, outer=(179)]
 │         │    │    │    │         └── sum:293 [as=cs_item_rev:449, outer=(293)]
 │         │    │    │    └── projections
 │         │    │    │         ├── cs_item_rev:449 * 1.1 [as=column455:455, outer=(449), immutable]
 │         │    │    │         └── cs_item_rev:449 * 0.9 [as=column454:454, outer=(449), immutable]
 │         │    │    ├── project
 │         │    │    │    ├── columns: column453:453 column452:452 item_id:450!null ws_item_rev:451
 │         │    │    │    ├── immutable
 │         │    │    │    ├── key: (450)
 │         │    │    │    ├── fd: (450)-->(451), (451)-->(452,453)
 │         │    │    │    ├── project
 │         │    │    │    │    ├── columns: item_id:450!null ws_item_rev:451
 │         │    │    │    │    ├── key: (450)
 │         │    │    │    │    ├── fd: (450)-->(451)
 │         │    │    │    │    ├── group-by (hash)
 │         │    │    │    │    │    ├── columns: i_item_id:331!null sum:445
 │         │    │    │    │    │    ├── grouping columns: i_item_id:331!null
 │         │    │    │    │    │    ├── key: (331)
 │         │    │    │    │    │    ├── fd: (331)-->(445)
 │         │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    ├── columns: ws_sold_date_sk:294!null ws_item_sk:297!null ws_ext_sales_price:317 i_item_sk:330!null i_item_id:331!null d_date_sk:354!null d_date:356
 │         │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │         │    │    │    │    │    │    ├── fd: (330)-->(331), (354)-->(356), (297)==(330), (330)==(297), (294)==(354), (354)==(294)
 │         │    │    │    │    │    │    ├── scan item
 │         │    │    │    │    │    │    │    ├── columns: i_item_sk:330!null i_item_id:331!null
 │         │    │    │    │    │    │    │    ├── key: (330)
 │         │    │    │    │    │    │    │    └── fd: (330)-->(331)
 │         │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:294!null ws_item_sk:297!null ws_ext_sales_price:317 d_date_sk:354!null d_date:356
 │         │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    ├── fd: (354)-->(356), (294)==(354), (354)==(294)
 │         │    │    │    │    │    │    │    ├── scan web_sales
 │         │    │    │    │    │    │    │    │    └── columns: ws_sold_date_sk:294 ws_item_sk:297!null ws_ext_sales_price:317
 │         │    │    │    │    │    │    │    ├── semi-join (hash)
 │         │    │    │    │    │    │    │    │    ├── columns: d_date_sk:354!null d_date:356
 │         │    │    │    │    │    │    │    │    ├── key: (354)
 │         │    │    │    │    │    │    │    │    ├── fd: (354)-->(356)
 │         │    │    │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    ├── columns: d_date_sk:354!null d_date:356
 │         │    │    │    │    │    │    │    │    │    ├── key: (354)
 │         │    │    │    │    │    │    │    │    │    └── fd: (354)-->(356)
 │         │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │         │    │    │    │    │    │    │    │    │    ├── columns: d_date:386 d_week_seq:388!null d_week_seq:418!null
 │         │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    │    │    │    │    │    │    ├── fd: ()-->(388,418), (388)==(418), (418)==(388)
 │         │    │    │    │    │    │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    │    └── columns: d_date:386 d_week_seq:388
 │         │    │    │    │    │    │    │    │    │    ├── max1-row
 │         │    │    │    │    │    │    │    │    │    │    ├── columns: d_week_seq:418
 │         │    │    │    │    │    │    │    │    │    │    ├── error: "more than one row returned by a subquery used as an expression"
 │         │    │    │    │    │    │    │    │    │    │    ├── cardinality: [0 - 1]
 │         │    │    │    │    │    │    │    │    │    │    ├── key: ()
 │         │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(418)
 │         │    │    │    │    │    │    │    │    │    │    └── project
 │         │    │    │    │    │    │    │    │    │    │         ├── columns: d_week_seq:418
 │         │    │    │    │    │    │    │    │    │    │         └── select
 │         │    │    │    │    │    │    │    │    │    │              ├── columns: d_date:416!null d_week_seq:418
 │         │    │    │    │    │    │    │    │    │    │              ├── fd: ()-->(416)
 │         │    │    │    │    │    │    │    │    │    │              ├── scan date_dim
 │         │    │    │    │    │    │    │    │    │    │              │    └── columns: d_date:416 d_week_seq:418
 │         │    │    │    │    │    │    │    │    │    │              └── filters
 │         │    │    │    │    │    │    │    │    │    │                   └── d_date:416 = '2001-06-16' [outer=(416), constraints=(/416: [/'2001-06-16' - /'2001-06-16']; tight), fd=()-->(416)]
 │         │    │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │    │         └── d_week_seq:388 = d_week_seq:418 [outer=(388,418), constraints=(/388: (/NULL - ]; /418: (/NULL - ]), fd=(388)==(418), (418)==(388)]
 │         │    │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │    │         └── d_date:356 = d_date:386 [outer=(356,386), constraints=(/356: (/NULL - ]; /386: (/NULL - ]), fd=(356)==(386), (386)==(356)]
 │         │    │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │    │         └── ws_sold_date_sk:294 = d_date_sk:354 [outer=(294,354), constraints=(/294: (/NULL - ]; /354: (/NULL - ]), fd=(294)==(354), (354)==(294)]
 │         │    │    │    │    │    │    └── filters
 │         │    │    │    │    │    │         └── ws_item_sk:297 = i_item_sk:330 [outer=(297,330), constraints=(/297: (/NULL - ]; /330: (/NULL - ]), fd=(297)==(330), (330)==(297)]
 │         │    │    │    │    │    └── aggregations
 │         │    │    │    │    │         └── sum [as=sum:445, outer=(317)]
 │         │    │    │    │    │              └── ws_ext_sales_price:317
 │         │    │    │    │    └── projections
 │         │    │    │    │         ├── i_item_id:331 [as=item_id:450, outer=(331)]
 │         │    │    │    │         └── sum:445 [as=ws_item_rev:451, outer=(445)]
 │         │    │    │    └── projections
 │         │    │    │         ├── ws_item_rev:451 * 1.1 [as=column453:453, outer=(451), immutable]
 │         │    │    │         └── ws_item_rev:451 * 0.9 [as=column452:452, outer=(451), immutable]
 │         │    │    └── filters
 │         │    │         ├── item_id:448 = item_id:450 [outer=(448,450), constraints=(/448: (/NULL - ]; /450: (/NULL - ]), fd=(448)==(450), (450)==(448)]
 │         │    │         ├── cs_item_rev:449 >= column452:452 [outer=(449,452), immutable, constraints=(/449: (/NULL - ]; /452: (/NULL - ])]
 │         │    │         ├── cs_item_rev:449 <= column453:453 [outer=(449,453), immutable, constraints=(/449: (/NULL - ]; /453: (/NULL - ])]
 │         │    │         ├── column454:454 <= ws_item_rev:451 [outer=(451,454), immutable, constraints=(/451: (/NULL - ]; /454: (/NULL - ])]
 │         │    │         └── column455:455 >= ws_item_rev:451 [outer=(451,455), immutable, constraints=(/451: (/NULL - ]; /455: (/NULL - ])]
 │         │    └── projections
 │         │         ├── ws_item_rev:451 * 1.1 [as=column459:459, outer=(451), immutable]
 │         │         ├── ws_item_rev:451 * 0.9 [as=column458:458, outer=(451), immutable]
 │         │         ├── cs_item_rev:449 * 1.1 [as=column457:457, outer=(449), immutable]
 │         │         └── cs_item_rev:449 * 0.9 [as=column456:456, outer=(449), immutable]
 │         └── filters
 │              ├── item_id:446 = item_id:448 [outer=(446,448), constraints=(/446: (/NULL - ]; /448: (/NULL - ]), fd=(446)==(448), (448)==(446)]
 │              ├── ss_item_rev:447 >= column456:456 [outer=(447,456), immutable, constraints=(/447: (/NULL - ]; /456: (/NULL - ])]
 │              ├── ss_item_rev:447 <= column457:457 [outer=(447,457), immutable, constraints=(/447: (/NULL - ]; /457: (/NULL - ])]
 │              ├── ss_item_rev:447 >= column458:458 [outer=(447,458), immutable, constraints=(/447: (/NULL - ]; /458: (/NULL - ])]
 │              ├── ss_item_rev:447 <= column459:459 [outer=(447,459), immutable, constraints=(/447: (/NULL - ]; /459: (/NULL - ])]
 │              ├── column460:460 <= cs_item_rev:449 [outer=(449,460), immutable, constraints=(/449: (/NULL - ]; /460: (/NULL - ])]
 │              ├── column461:461 >= cs_item_rev:449 [outer=(449,461), immutable, constraints=(/449: (/NULL - ]; /461: (/NULL - ])]
 │              ├── column462:462 <= ws_item_rev:451 [outer=(451,462), immutable, constraints=(/451: (/NULL - ]; /462: (/NULL - ])]
 │              └── column463:463 >= ws_item_rev:451 [outer=(451,463), immutable, constraints=(/451: (/NULL - ]; /463: (/NULL - ])]
 └── projections
      ├── (ss_item_rev:447 / ((ws_item_rev:451 + (ss_item_rev:447 + cs_item_rev:449)) / 3)) * 100 [as=ss_dev:464, outer=(447,449,451), immutable]
      ├── (cs_item_rev:449 / ((ws_item_rev:451 + (ss_item_rev:447 + cs_item_rev:449)) / 3)) * 100 [as=cs_dev:465, outer=(447,449,451), immutable]
      ├── (ws_item_rev:451 / ((ws_item_rev:451 + (ss_item_rev:447 + cs_item_rev:449)) / 3)) * 100 [as=ws_dev:466, outer=(447,449,451), immutable]
      └── (ws_item_rev:451 + (ss_item_rev:447 + cs_item_rev:449)) / 3 [as=average:467, outer=(447,449,451), immutable]

# --------------------------------------------------
# Q59
opt
	WITH
		wss
			AS (
				SELECT
					d_week_seq,
					ss_store_sk,
					sum(
						CASE
						WHEN (d_day_name = 'Sunday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS sun_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Monday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS mon_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Tuesday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS tue_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Wednesday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS wed_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Thursday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS thu_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Friday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS fri_sales,
					sum(
						CASE
						WHEN (d_day_name = 'Saturday')
						THEN ss_sales_price
						ELSE NULL
						END
					)
						AS sat_sales
				FROM
					store_sales, date_dim
				WHERE
					d_date_sk = ss_sold_date_sk
				GROUP BY
					d_week_seq, ss_store_sk
			)
	SELECT
		s_store_name1,
		s_store_id1,
		d_week_seq1,
		sun_sales1 / sun_sales2,
		mon_sales1 / mon_sales2,
		tue_sales1 / tue_sales2,
		wed_sales1 / wed_sales2,
		thu_sales1 / thu_sales2,
		fri_sales1 / fri_sales2,
		sat_sales1 / sat_sales2
	FROM
		(
			SELECT
				s_store_name AS s_store_name1,
				wss.d_week_seq AS d_week_seq1,
				s_store_id AS s_store_id1,
				sun_sales AS sun_sales1,
				mon_sales AS mon_sales1,
				tue_sales AS tue_sales1,
				wed_sales AS wed_sales1,
				thu_sales AS thu_sales1,
				fri_sales AS fri_sales1,
				sat_sales AS sat_sales1
			FROM
				wss, store, date_dim AS d
			WHERE
				d.d_week_seq = wss.d_week_seq
				AND ss_store_sk = s_store_sk
				AND d_month_seq BETWEEN 1195 AND (1195 + 11)
		)
			AS y,
		(
			SELECT
				s_store_name AS s_store_name2,
				wss.d_week_seq AS d_week_seq2,
				s_store_id AS s_store_id2,
				sun_sales AS sun_sales2,
				mon_sales AS mon_sales2,
				tue_sales AS tue_sales2,
				wed_sales AS wed_sales2,
				thu_sales AS thu_sales2,
				fri_sales AS fri_sales2,
				sat_sales AS sat_sales2
			FROM
				wss, store, date_dim AS d
			WHERE
				d.d_week_seq = wss.d_week_seq
				AND ss_store_sk = s_store_sk
				AND d_month_seq BETWEEN (1195 + 12) AND (1195 + 23)
		)
			AS x
	WHERE
		s_store_id1 = s_store_id2
		AND d_week_seq1 = d_week_seq2 - 52
	ORDER BY
		s_store_name1, s_store_id1, d_week_seq1
	LIMIT
		100;
----
with &1 (wss)
 ├── columns: s_store_name1:84 s_store_id1:80!null d_week_seq1:70!null "?column?":211 "?column?":212 "?column?":213 "?column?":214 "?column?":215 "?column?":216 "?column?":217
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +84,+80,+70
 ├── group-by (hash)
 │    ├── columns: store_sales.ss_store_sk:8 date_dim.d_week_seq:30 sum:57 sum:59 sum:61 sum:63 sum:65 sum:67 sum:69
 │    ├── grouping columns: store_sales.ss_store_sk:8 date_dim.d_week_seq:30
 │    ├── immutable
 │    ├── key: (8,30)
 │    ├── fd: (8,30)-->(57,59,61,63,65,67,69)
 │    ├── project
 │    │    ├── columns: column56:56 column58:58 column60:60 column62:62 column64:64 column66:66 column68:68 store_sales.ss_store_sk:8 date_dim.d_week_seq:30
 │    │    ├── immutable
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_date_sk:1!null store_sales.ss_store_sk:8 ss_sales_price:14 date_dim.d_date_sk:26!null date_dim.d_week_seq:30 date_dim.d_day_name:40
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: (26)-->(30,40), (1)==(26), (26)==(1)
 │    │    │    ├── scan store_sales
 │    │    │    │    └── columns: ss_sold_date_sk:1 store_sales.ss_store_sk:8 ss_sales_price:14
 │    │    │    ├── scan date_dim
 │    │    │    │    ├── columns: date_dim.d_date_sk:26!null date_dim.d_week_seq:30 date_dim.d_day_name:40
 │    │    │    │    ├── key: (26)
 │    │    │    │    └── fd: (26)-->(30,40)
 │    │    │    └── filters
 │    │    │         └── date_dim.d_date_sk:26 = ss_sold_date_sk:1 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    └── projections
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Sunday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column56:56, outer=(14,40), immutable]
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Monday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column58:58, outer=(14,40), immutable]
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Tuesday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column60:60, outer=(14,40), immutable]
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Wednesday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column62:62, outer=(14,40), immutable]
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Thursday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column64:64, outer=(14,40), immutable]
 │    │         ├── CASE WHEN date_dim.d_day_name:40 = 'Friday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column66:66, outer=(14,40), immutable]
 │    │         └── CASE WHEN date_dim.d_day_name:40 = 'Saturday' THEN ss_sales_price:14::DECIMAL ELSE CAST(NULL AS DECIMAL) END [as=column68:68, outer=(14,40), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:57, outer=(56)]
 │         │    └── column56:56
 │         ├── sum [as=sum:59, outer=(58)]
 │         │    └── column58:58
 │         ├── sum [as=sum:61, outer=(60)]
 │         │    └── column60:60
 │         ├── sum [as=sum:63, outer=(62)]
 │         │    └── column62:62
 │         ├── sum [as=sum:65, outer=(64)]
 │         │    └── column64:64
 │         ├── sum [as=sum:67, outer=(66)]
 │         │    └── column66:66
 │         └── sum [as=sum:69, outer=(68)]
 │              └── column68:68
 └── project
      ├── columns: "?column?":211 "?column?":212 "?column?":213 "?column?":214 "?column?":215 "?column?":216 "?column?":217 d_week_seq:70!null s_store_id:80!null s_store_name:84
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +84,+80,+70
      ├── top-k
      │    ├── columns: d_week_seq:70!null ss_store_sk:71!null sun_sales:72 mon_sales:73 tue_sales:74 wed_sales:75 thu_sales:76 fri_sales:77 sat_sales:78 s_store_sk:79!null s_store_id:80!null s_store_name:84 d.d_month_seq:113!null d.d_week_seq:114!null sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148 s_store_id:150!null column210:210!null
      │    ├── internal-ordering: +84,+(80|150),+(70|114|210)
      │    ├── k: 100
      │    ├── cardinality: [0 - 100]
      │    ├── immutable
      │    ├── fd: (70,71)-->(72-78), (79)-->(80,84), (71)==(79), (79)==(71), (70)==(114,210), (114)==(70,210), (210)==(70,114), (80)==(150), (150)==(80)
      │    ├── ordering: +84,+(80|150),+(70|114|210) [actual: +84,+80,+70]
      │    └── inner-join (hash)
      │         ├── columns: d_week_seq:70!null ss_store_sk:71!null sun_sales:72 mon_sales:73 tue_sales:74 wed_sales:75 thu_sales:76 fri_sales:77 sat_sales:78 s_store_sk:79!null s_store_id:80!null s_store_name:84 d.d_month_seq:113!null d.d_week_seq:114!null sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148 s_store_id:150!null column210:210!null
      │         ├── immutable
      │         ├── fd: (70,71)-->(72-78), (79)-->(80,84), (71)==(79), (79)==(71), (70)==(114,210), (114)==(70,210), (210)==(70,114), (80)==(150), (150)==(80)
      │         ├── inner-join (hash)
      │         │    ├── columns: d_week_seq:70!null ss_store_sk:71!null sun_sales:72 mon_sales:73 tue_sales:74 wed_sales:75 thu_sales:76 fri_sales:77 sat_sales:78 s_store_sk:79!null s_store_id:80!null s_store_name:84 d.d_month_seq:113!null d.d_week_seq:114!null
      │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    ├── fd: (70,71)-->(72-78), (79)-->(80,84), (71)==(79), (79)==(71), (70)==(114), (114)==(70)
      │         │    ├── inner-join (hash)
      │         │    │    ├── columns: d_week_seq:70!null ss_store_sk:71 sun_sales:72 mon_sales:73 tue_sales:74 wed_sales:75 thu_sales:76 fri_sales:77 sat_sales:78 d.d_month_seq:113!null d.d_week_seq:114!null
      │         │    │    ├── fd: (70,71)-->(72-78), (70)==(114), (114)==(70)
      │         │    │    ├── with-scan &1 (wss)
      │         │    │    │    ├── columns: d_week_seq:70 ss_store_sk:71 sun_sales:72 mon_sales:73 tue_sales:74 wed_sales:75 thu_sales:76 fri_sales:77 sat_sales:78
      │         │    │    │    ├── mapping:
      │         │    │    │    │    ├──  date_dim.d_week_seq:30 => d_week_seq:70
      │         │    │    │    │    ├──  store_sales.ss_store_sk:8 => ss_store_sk:71
      │         │    │    │    │    ├──  sum:57 => sun_sales:72
      │         │    │    │    │    ├──  sum:59 => mon_sales:73
      │         │    │    │    │    ├──  sum:61 => tue_sales:74
      │         │    │    │    │    ├──  sum:63 => wed_sales:75
      │         │    │    │    │    ├──  sum:65 => thu_sales:76
      │         │    │    │    │    ├──  sum:67 => fri_sales:77
      │         │    │    │    │    └──  sum:69 => sat_sales:78
      │         │    │    │    ├── key: (70,71)
      │         │    │    │    └── fd: (70,71)-->(72-78)
      │         │    │    ├── select
      │         │    │    │    ├── columns: d.d_month_seq:113!null d.d_week_seq:114
      │         │    │    │    ├── scan date_dim [as=d]
      │         │    │    │    │    └── columns: d.d_month_seq:113 d.d_week_seq:114
      │         │    │    │    └── filters
      │         │    │    │         └── (d.d_month_seq:113 >= 1195) AND (d.d_month_seq:113 <= 1206) [outer=(113), constraints=(/113: [/1195 - /1206]; tight)]
      │         │    │    └── filters
      │         │    │         └── d.d_week_seq:114 = d_week_seq:70 [outer=(70,114), constraints=(/70: (/NULL - ]; /114: (/NULL - ]), fd=(70)==(114), (114)==(70)]
      │         │    ├── scan store
      │         │    │    ├── columns: s_store_sk:79!null s_store_id:80!null s_store_name:84
      │         │    │    ├── key: (79)
      │         │    │    └── fd: (79)-->(80,84)
      │         │    └── filters
      │         │         └── ss_store_sk:71 = s_store_sk:79 [outer=(71,79), constraints=(/71: (/NULL - ]; /79: (/NULL - ]), fd=(71)==(79), (79)==(71)]
      │         ├── project
      │         │    ├── columns: column210:210!null sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148 s_store_id:150!null
      │         │    ├── immutable
      │         │    ├── inner-join (hash)
      │         │    │    ├── columns: d_week_seq:140!null ss_store_sk:141!null sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148 s_store_sk:149!null s_store_id:150!null d.d_month_seq:183!null d.d_week_seq:184!null
      │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │         │    │    ├── fd: (140,141)-->(142-148), (149)-->(150), (141)==(149), (149)==(141), (140)==(184), (184)==(140)
      │         │    │    ├── inner-join (hash)
      │         │    │    │    ├── columns: d_week_seq:140!null ss_store_sk:141 sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148 d.d_month_seq:183!null d.d_week_seq:184!null
      │         │    │    │    ├── fd: (140,141)-->(142-148), (140)==(184), (184)==(140)
      │         │    │    │    ├── with-scan &1 (wss)
      │         │    │    │    │    ├── columns: d_week_seq:140 ss_store_sk:141 sun_sales:142 mon_sales:143 tue_sales:144 wed_sales:145 thu_sales:146 fri_sales:147 sat_sales:148
      │         │    │    │    │    ├── mapping:
      │         │    │    │    │    │    ├──  date_dim.d_week_seq:30 => d_week_seq:140
      │         │    │    │    │    │    ├──  store_sales.ss_store_sk:8 => ss_store_sk:141
      │         │    │    │    │    │    ├──  sum:57 => sun_sales:142
      │         │    │    │    │    │    ├──  sum:59 => mon_sales:143
      │         │    │    │    │    │    ├──  sum:61 => tue_sales:144
      │         │    │    │    │    │    ├──  sum:63 => wed_sales:145
      │         │    │    │    │    │    ├──  sum:65 => thu_sales:146
      │         │    │    │    │    │    ├──  sum:67 => fri_sales:147
      │         │    │    │    │    │    └──  sum:69 => sat_sales:148
      │         │    │    │    │    ├── key: (140,141)
      │         │    │    │    │    └── fd: (140,141)-->(142-148)
      │         │    │    │    ├── select
      │         │    │    │    │    ├── columns: d.d_month_seq:183!null d.d_week_seq:184
      │         │    │    │    │    ├── scan date_dim [as=d]
      │         │    │    │    │    │    └── columns: d.d_month_seq:183 d.d_week_seq:184
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── (d.d_month_seq:183 >= 1207) AND (d.d_month_seq:183 <= 1218) [outer=(183), constraints=(/183: [/1207 - /1218]; tight)]
      │         │    │    │    └── filters
      │         │    │    │         └── d.d_week_seq:184 = d_week_seq:140 [outer=(140,184), constraints=(/140: (/NULL - ]; /184: (/NULL - ]), fd=(140)==(184), (184)==(140)]
      │         │    │    ├── scan store
      │         │    │    │    ├── columns: s_store_sk:149!null s_store_id:150!null
      │         │    │    │    ├── key: (149)
      │         │    │    │    └── fd: (149)-->(150)
      │         │    │    └── filters
      │         │    │         └── ss_store_sk:141 = s_store_sk:149 [outer=(141,149), constraints=(/141: (/NULL - ]; /149: (/NULL - ]), fd=(141)==(149), (149)==(141)]
      │         │    └── projections
      │         │         └── d_week_seq:140 - 52 [as=column210:210, outer=(140), immutable]
      │         └── filters
      │              ├── s_store_id:80 = s_store_id:150 [outer=(80,150), constraints=(/80: (/NULL - ]; /150: (/NULL - ]), fd=(80)==(150), (150)==(80)]
      │              └── d_week_seq:70 = column210:210 [outer=(70,210), constraints=(/70: (/NULL - ]; /210: (/NULL - ]), fd=(70)==(210), (210)==(70)]
      └── projections
           ├── sun_sales:72 / sun_sales:142 [as="?column?":211, outer=(72,142), immutable]
           ├── mon_sales:73 / mon_sales:143 [as="?column?":212, outer=(73,143), immutable]
           ├── tue_sales:74 / tue_sales:144 [as="?column?":213, outer=(74,144), immutable]
           ├── wed_sales:75 / wed_sales:145 [as="?column?":214, outer=(75,145), immutable]
           ├── thu_sales:76 / thu_sales:146 [as="?column?":215, outer=(76,146), immutable]
           ├── fri_sales:77 / fri_sales:147 [as="?column?":216, outer=(77,147), immutable]
           └── sat_sales:78 / sat_sales:148 [as="?column?":217, outer=(78,148), immutable]

# --------------------------------------------------
# Q60
opt
	WITH
		ss
			AS (
				SELECT
					i_item_id,
					sum(ss_ext_sales_price) AS total_sales
				FROM
					store_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_category IN ('Jewelry',)
						)
					AND ss_item_sk = i_item_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 10
					AND ss_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_item_id
			),
		cs
			AS (
				SELECT
					i_item_id,
					sum(cs_ext_sales_price) AS total_sales
				FROM
					catalog_sales,
					date_dim,
					customer_address,
					item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_category IN ('Jewelry',)
						)
					AND cs_item_sk = i_item_sk
					AND cs_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 10
					AND cs_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_item_id
			),
		ws
			AS (
				SELECT
					i_item_id,
					sum(ws_ext_sales_price) AS total_sales
				FROM
					web_sales, date_dim, customer_address, item
				WHERE
					i_item_id
					IN (
							SELECT
								i_item_id
							FROM
								item
							WHERE
								i_category IN ('Jewelry',)
						)
					AND ws_item_sk = i_item_sk
					AND ws_sold_date_sk = d_date_sk
					AND d_year = 2000
					AND d_moy = 10
					AND ws_bill_addr_sk = ca_address_sk
					AND ca_gmt_offset = -5
				GROUP BY
					i_item_id
			)
	SELECT
		i_item_id, sum(total_sales) AS total_sales
	FROM
		(
			SELECT * FROM ss UNION ALL SELECT * FROM cs
			UNION ALL SELECT * FROM ws
		)
			AS tmp1
	GROUP BY
		i_item_id
	ORDER BY
		i_item_id, total_sales
	LIMIT
		100;
----
limit
 ├── columns: i_item_id:391!null total_sales:393
 ├── internal-ordering: +391
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (391)
 ├── fd: (391)-->(393)
 ├── ordering: +391
 ├── group-by (streaming)
 │    ├── columns: i_item_id:391!null sum:393
 │    ├── grouping columns: i_item_id:391!null
 │    ├── immutable
 │    ├── key: (391)
 │    ├── fd: (391)-->(393)
 │    ├── ordering: +391
 │    ├── limit hint: 100.00
 │    ├── union-all
 │    │    ├── columns: i_item_id:391!null total_sales:392
 │    │    ├── left columns: i_item_id:387 total_sales:388
 │    │    ├── right columns: i_item_id:389 total_sales:390
 │    │    ├── immutable
 │    │    ├── ordering: +391
 │    │    ├── limit hint: 100.00
 │    │    ├── union-all
 │    │    │    ├── columns: i_item_id:387!null total_sales:388
 │    │    │    ├── left columns: i_item_id:383 total_sales:384
 │    │    │    ├── right columns: i_item_id:385 total_sales:386
 │    │    │    ├── immutable
 │    │    │    ├── ordering: +387
 │    │    │    ├── limit hint: 100.00
 │    │    │    ├── project
 │    │    │    │    ├── columns: i_item_id:383!null total_sales:384
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: (383)
 │    │    │    │    ├── fd: (383)-->(384)
 │    │    │    │    ├── ordering: +383
 │    │    │    │    ├── limit hint: 100.00
 │    │    │    │    ├── group-by (streaming)
 │    │    │    │    │    ├── columns: item.i_item_id:72!null sum:120
 │    │    │    │    │    ├── grouping columns: item.i_item_id:72!null
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── key: (72)
 │    │    │    │    │    ├── fd: (72)-->(120)
 │    │    │    │    │    ├── ordering: +72
 │    │    │    │    │    ├── limit hint: 100.00
 │    │    │    │    │    ├── inner-join (lookup customer_address)
 │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7!null ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null ca_address_sk:56!null ca_gmt_offset:67!null i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    ├── key columns: [7] = [56]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── fd: ()-->(32,34,67), (71)-->(72), (1)==(26), (26)==(1), (7)==(56), (56)==(7), (3)==(71), (71)==(3)
 │    │    │    │    │    │    ├── ordering: +72 opt(32,34,67) [actual: +72]
 │    │    │    │    │    │    ├── limit hint: 440.78
 │    │    │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16 d_date_sk:26!null d_year:32!null d_moy:34!null i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    │    ├── key columns: [1] = [26]
 │    │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    │    ├── fd: ()-->(32,34), (71)-->(72), (3)==(71), (71)==(3), (1)==(26), (26)==(1)
 │    │    │    │    │    │    │    ├── ordering: +72 opt(32,34) [actual: +72]
 │    │    │    │    │    │    │    ├── limit hint: 1000.00
 │    │    │    │    │    │    │    ├── inner-join (lookup store_sales)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_addr_sk:7 ss_ext_sales_price:16 i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    │    │    ├── key columns: [71] = [3]
 │    │    │    │    │    │    │    │    ├── fd: (71)-->(72), (3)==(71), (71)==(3)
 │    │    │    │    │    │    │    │    ├── ordering: +72
 │    │    │    │    │    │    │    │    ├── limit hint: 62600.00
 │    │    │    │    │    │    │    │    ├── sort
 │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    │    │    │    ├── key: (71)
 │    │    │    │    │    │    │    │    │    ├── fd: (71)-->(72)
 │    │    │    │    │    │    │    │    │    ├── ordering: +72
 │    │    │    │    │    │    │    │    │    ├── limit hint: 300.00
 │    │    │    │    │    │    │    │    │    └── semi-join (hash)
 │    │    │    │    │    │    │    │    │         ├── columns: i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    │    │    │         ├── key: (71)
 │    │    │    │    │    │    │    │    │         ├── fd: (71)-->(72)
 │    │    │    │    │    │    │    │    │         ├── scan item
 │    │    │    │    │    │    │    │    │         │    ├── columns: i_item_sk:71!null item.i_item_id:72!null
 │    │    │    │    │    │    │    │    │         │    ├── key: (71)
 │    │    │    │    │    │    │    │    │         │    └── fd: (71)-->(72)
 │    │    │    │    │    │    │    │    │         ├── select
 │    │    │    │    │    │    │    │    │         │    ├── columns: item.i_item_id:96!null i_category:107!null
 │    │    │    │    │    │    │    │    │         │    ├── fd: ()-->(107)
 │    │    │    │    │    │    │    │    │         │    ├── scan item
 │    │    │    │    │    │    │    │    │         │    │    └── columns: item.i_item_id:96!null i_category:107
 │    │    │    │    │    │    │    │    │         │    └── filters
 │    │    │    │    │    │    │    │    │         │         └── i_category:107 = 'Jewelry' [outer=(107), constraints=(/107: [/'Jewelry' - /'Jewelry']; tight), fd=()-->(107)]
 │    │    │    │    │    │    │    │    │         └── filters
 │    │    │    │    │    │    │    │    │              └── item.i_item_id:72 = item.i_item_id:96 [outer=(72,96), constraints=(/72: (/NULL - ]; /96: (/NULL - ]), fd=(72)==(96), (96)==(72)]
 │    │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         ├── d_year:32 = 2000 [outer=(32), constraints=(/32: [/2000 - /2000]; tight), fd=()-->(32)]
 │    │    │    │    │    │    │         └── d_moy:34 = 10 [outer=(34), constraints=(/34: [/10 - /10]; tight), fd=()-->(34)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ca_gmt_offset:67 = -5 [outer=(67), immutable, constraints=(/67: [/-5 - /-5]; tight), fd=()-->(67)]
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── sum [as=sum:120, outer=(16)]
 │    │    │    │    │              └── ss_ext_sales_price:16
 │    │    │    │    └── projections
 │    │    │    │         ├── item.i_item_id:72 [as=i_item_id:383, outer=(72)]
 │    │    │    │         └── sum:120 [as=total_sales:384, outer=(120)]
 │    │    │    └── project
 │    │    │         ├── columns: i_item_id:385!null total_sales:386
 │    │    │         ├── immutable
 │    │    │         ├── key: (385)
 │    │    │         ├── fd: (385)-->(386)
 │    │    │         ├── ordering: +385
 │    │    │         ├── limit hint: 100.00
 │    │    │         ├── group-by (streaming)
 │    │    │         │    ├── columns: item.i_item_id:203!null sum:251
 │    │    │         │    ├── grouping columns: item.i_item_id:203!null
 │    │    │         │    ├── immutable
 │    │    │         │    ├── key: (203)
 │    │    │         │    ├── fd: (203)-->(251)
 │    │    │         │    ├── ordering: +203
 │    │    │         │    ├── limit hint: 100.00
 │    │    │         │    ├── inner-join (lookup customer_address)
 │    │    │         │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127!null cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null ca_address_sk:187!null ca_gmt_offset:198!null i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    ├── key columns: [127] = [187]
 │    │    │         │    │    ├── lookup columns are key
 │    │    │         │    │    ├── immutable
 │    │    │         │    │    ├── fd: ()-->(163,165,198), (202)-->(203), (121)==(157), (157)==(121), (127)==(187), (187)==(127), (136)==(202), (202)==(136)
 │    │    │         │    │    ├── ordering: +203 opt(163,165,198) [actual: +203]
 │    │    │         │    │    ├── limit hint: 392.35
 │    │    │         │    │    ├── inner-join (lookup date_dim)
 │    │    │         │    │    │    ├── columns: cs_sold_date_sk:121!null cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144 d_date_sk:157!null d_year:163!null d_moy:165!null i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    │    ├── key columns: [121] = [157]
 │    │    │         │    │    │    ├── lookup columns are key
 │    │    │         │    │    │    ├── fd: ()-->(163,165), (202)-->(203), (136)==(202), (202)==(136), (121)==(157), (157)==(121)
 │    │    │         │    │    │    ├── ordering: +203 opt(163,165) [actual: +203]
 │    │    │         │    │    │    ├── limit hint: 500.00
 │    │    │         │    │    │    ├── inner-join (lookup catalog_sales)
 │    │    │         │    │    │    │    ├── columns: cs_sold_date_sk:121 cs_bill_addr_sk:127 cs_item_sk:136!null cs_ext_sales_price:144 i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    │    │    ├── key columns: [202] = [136]
 │    │    │         │    │    │    │    ├── fd: (202)-->(203), (136)==(202), (202)==(136)
 │    │    │         │    │    │    │    ├── ordering: +203
 │    │    │         │    │    │    │    ├── limit hint: 30300.00
 │    │    │         │    │    │    │    ├── sort
 │    │    │         │    │    │    │    │    ├── columns: i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    │    │    │    ├── key: (202)
 │    │    │         │    │    │    │    │    ├── fd: (202)-->(203)
 │    │    │         │    │    │    │    │    ├── ordering: +203
 │    │    │         │    │    │    │    │    ├── limit hint: 300.00
 │    │    │         │    │    │    │    │    └── semi-join (hash)
 │    │    │         │    │    │    │    │         ├── columns: i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    │    │    │         ├── key: (202)
 │    │    │         │    │    │    │    │         ├── fd: (202)-->(203)
 │    │    │         │    │    │    │    │         ├── scan item
 │    │    │         │    │    │    │    │         │    ├── columns: i_item_sk:202!null item.i_item_id:203!null
 │    │    │         │    │    │    │    │         │    ├── key: (202)
 │    │    │         │    │    │    │    │         │    └── fd: (202)-->(203)
 │    │    │         │    │    │    │    │         ├── select
 │    │    │         │    │    │    │    │         │    ├── columns: item.i_item_id:227!null i_category:238!null
 │    │    │         │    │    │    │    │         │    ├── fd: ()-->(238)
 │    │    │         │    │    │    │    │         │    ├── scan item
 │    │    │         │    │    │    │    │         │    │    └── columns: item.i_item_id:227!null i_category:238
 │    │    │         │    │    │    │    │         │    └── filters
 │    │    │         │    │    │    │    │         │         └── i_category:238 = 'Jewelry' [outer=(238), constraints=(/238: [/'Jewelry' - /'Jewelry']; tight), fd=()-->(238)]
 │    │    │         │    │    │    │    │         └── filters
 │    │    │         │    │    │    │    │              └── item.i_item_id:203 = item.i_item_id:227 [outer=(203,227), constraints=(/203: (/NULL - ]; /227: (/NULL - ]), fd=(203)==(227), (227)==(203)]
 │    │    │         │    │    │    │    └── filters (true)
 │    │    │         │    │    │    └── filters
 │    │    │         │    │    │         ├── d_year:163 = 2000 [outer=(163), constraints=(/163: [/2000 - /2000]; tight), fd=()-->(163)]
 │    │    │         │    │    │         └── d_moy:165 = 10 [outer=(165), constraints=(/165: [/10 - /10]; tight), fd=()-->(165)]
 │    │    │         │    │    └── filters
 │    │    │         │    │         └── ca_gmt_offset:198 = -5 [outer=(198), immutable, constraints=(/198: [/-5 - /-5]; tight), fd=()-->(198)]
 │    │    │         │    └── aggregations
 │    │    │         │         └── sum [as=sum:251, outer=(144)]
 │    │    │         │              └── cs_ext_sales_price:144
 │    │    │         └── projections
 │    │    │              ├── item.i_item_id:203 [as=i_item_id:385, outer=(203)]
 │    │    │              └── sum:251 [as=total_sales:386, outer=(251)]
 │    │    └── project
 │    │         ├── columns: i_item_id:389!null total_sales:390
 │    │         ├── immutable
 │    │         ├── key: (389)
 │    │         ├── fd: (389)-->(390)
 │    │         ├── ordering: +389
 │    │         ├── limit hint: 100.00
 │    │         ├── group-by (streaming)
 │    │         │    ├── columns: item.i_item_id:334!null sum:382
 │    │         │    ├── grouping columns: item.i_item_id:334!null
 │    │         │    ├── immutable
 │    │         │    ├── key: (334)
 │    │         │    ├── fd: (334)-->(382)
 │    │         │    ├── ordering: +334
 │    │         │    ├── limit hint: 100.00
 │    │         │    ├── inner-join (lookup customer_address)
 │    │         │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259!null ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null ca_address_sk:318!null ca_gmt_offset:329!null i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    ├── key columns: [259] = [318]
 │    │         │    │    ├── lookup columns are key
 │    │         │    │    ├── immutable
 │    │         │    │    ├── fd: ()-->(294,296,329), (333)-->(334), (252)==(288), (288)==(252), (259)==(318), (318)==(259), (255)==(333), (333)==(255)
 │    │         │    │    ├── ordering: +334 opt(294,296,329) [actual: +334]
 │    │         │    │    ├── limit hint: 411.85
 │    │         │    │    ├── inner-join (lookup date_dim)
 │    │         │    │    │    ├── columns: ws_sold_date_sk:252!null ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275 d_date_sk:288!null d_year:294!null d_moy:296!null i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    │    ├── key columns: [252] = [288]
 │    │         │    │    │    ├── lookup columns are key
 │    │         │    │    │    ├── fd: ()-->(294,296), (333)-->(334), (255)==(333), (333)==(255), (252)==(288), (288)==(252)
 │    │         │    │    │    ├── ordering: +334 opt(294,296) [actual: +334]
 │    │         │    │    │    ├── limit hint: 300.00
 │    │         │    │    │    ├── inner-join (lookup web_sales)
 │    │         │    │    │    │    ├── columns: ws_sold_date_sk:252 ws_item_sk:255!null ws_bill_addr_sk:259 ws_ext_sales_price:275 i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    │    │    ├── key columns: [333] = [255]
 │    │         │    │    │    │    ├── fd: (333)-->(334), (255)==(333), (333)==(255)
 │    │         │    │    │    │    ├── ordering: +334
 │    │         │    │    │    │    ├── limit hint: 18000.00
 │    │         │    │    │    │    ├── sort
 │    │         │    │    │    │    │    ├── columns: i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    │    │    │    ├── key: (333)
 │    │         │    │    │    │    │    ├── fd: (333)-->(334)
 │    │         │    │    │    │    │    ├── ordering: +334
 │    │         │    │    │    │    │    ├── limit hint: 300.00
 │    │         │    │    │    │    │    └── semi-join (hash)
 │    │         │    │    │    │    │         ├── columns: i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    │    │    │         ├── key: (333)
 │    │         │    │    │    │    │         ├── fd: (333)-->(334)
 │    │         │    │    │    │    │         ├── scan item
 │    │         │    │    │    │    │         │    ├── columns: i_item_sk:333!null item.i_item_id:334!null
 │    │         │    │    │    │    │         │    ├── key: (333)
 │    │         │    │    │    │    │         │    └── fd: (333)-->(334)
 │    │         │    │    │    │    │         ├── select
 │    │         │    │    │    │    │         │    ├── columns: item.i_item_id:358!null i_category:369!null
 │    │         │    │    │    │    │         │    ├── fd: ()-->(369)
 │    │         │    │    │    │    │         │    ├── scan item
 │    │         │    │    │    │    │         │    │    └── columns: item.i_item_id:358!null i_category:369
 │    │         │    │    │    │    │         │    └── filters
 │    │         │    │    │    │    │         │         └── i_category:369 = 'Jewelry' [outer=(369), constraints=(/369: [/'Jewelry' - /'Jewelry']; tight), fd=()-->(369)]
 │    │         │    │    │    │    │         └── filters
 │    │         │    │    │    │    │              └── item.i_item_id:334 = item.i_item_id:358 [outer=(334,358), constraints=(/334: (/NULL - ]; /358: (/NULL - ]), fd=(334)==(358), (358)==(334)]
 │    │         │    │    │    │    └── filters (true)
 │    │         │    │    │    └── filters
 │    │         │    │    │         ├── d_year:294 = 2000 [outer=(294), constraints=(/294: [/2000 - /2000]; tight), fd=()-->(294)]
 │    │         │    │    │         └── d_moy:296 = 10 [outer=(296), constraints=(/296: [/10 - /10]; tight), fd=()-->(296)]
 │    │         │    │    └── filters
 │    │         │    │         └── ca_gmt_offset:329 = -5 [outer=(329), immutable, constraints=(/329: [/-5 - /-5]; tight), fd=()-->(329)]
 │    │         │    └── aggregations
 │    │         │         └── sum [as=sum:382, outer=(275)]
 │    │         │              └── ws_ext_sales_price:275
 │    │         └── projections
 │    │              ├── item.i_item_id:334 [as=i_item_id:389, outer=(334)]
 │    │              └── sum:382 [as=total_sales:390, outer=(382)]
 │    └── aggregations
 │         └── sum [as=sum:393, outer=(392)]
 │              └── total_sales:392
 └── 100

# --------------------------------------------------
# Q61
opt
	SELECT
		promotions,
		total,
		CAST(promotions AS DECIMAL(15,4))
		/ CAST(total AS DECIMAL(15,4))
		* 100
	FROM
		(
			SELECT
				sum(ss_ext_sales_price) AS promotions
			FROM
				store_sales,
				store,
				promotion,
				date_dim,
				customer,
				customer_address,
				item
			WHERE
				ss_sold_date_sk = d_date_sk
				AND ss_store_sk = s_store_sk
				AND ss_promo_sk = p_promo_sk
				AND ss_customer_sk = c_customer_sk
				AND ca_address_sk = c_current_addr_sk
				AND ss_item_sk = i_item_sk
				AND ca_gmt_offset = -7
				AND i_category = 'Home'
				AND (
						p_channel_dmail = 'Y'
						OR p_channel_email = 'Y'
						OR p_channel_tv = 'Y'
					)
				AND s_gmt_offset = -7
				AND d_year = 2000
				AND d_moy = 12
		)
			AS promotional_sales,
		(
			SELECT
				sum(ss_ext_sales_price) AS total
			FROM
				store_sales,
				store,
				date_dim,
				customer,
				customer_address,
				item
			WHERE
				ss_sold_date_sk = d_date_sk
				AND ss_store_sk = s_store_sk
				AND ss_customer_sk = c_customer_sk
				AND ca_address_sk = c_current_addr_sk
				AND ss_item_sk = i_item_sk
				AND ca_gmt_offset = -7
				AND i_category = 'Home'
				AND s_gmt_offset = -7
				AND d_year = 2000
				AND d_moy = 12
		)
			AS all_sales
	ORDER BY
		promotions, total
	LIMIT
		100;
----
project
 ├── columns: promotions:167 total:313 "?column?":314
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(167,313,314)
 ├── inner-join (cross)
 │    ├── columns: sum:167 sum:313
 │    ├── cardinality: [1 - 1]
 │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    ├── immutable
 │    ├── key: ()
 │    ├── fd: ()-->(167,313)
 │    ├── scalar-group-by
 │    │    ├── columns: sum:167
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── immutable
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(167)
 │    │    ├── inner-join (lookup promotion)
 │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_promo_sk:9!null ss_ext_sales_price:16 s_store_sk:26!null s_gmt_offset:53!null p_promo_sk:57!null p_channel_dmail:65 p_channel_email:66 p_channel_tv:68 d_date_sk:78!null d_year:84!null d_moy:86!null c_customer_sk:108!null c_current_addr_sk:112!null ca_address_sk:128!null ca_gmt_offset:139!null i_item_sk:143!null i_category:155!null
 │    │    │    ├── key columns: [9] = [57]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── immutable
 │    │    │    ├── fd: ()-->(53,84,86,139,155), (57)-->(65,66,68), (108)-->(112), (8)==(26), (26)==(8), (9)==(57), (57)==(9), (1)==(78), (78)==(1), (112)==(128), (128)==(112), (4)==(108), (108)==(4), (3)==(143), (143)==(3)
 │    │    │    ├── inner-join (lookup customer_address)
 │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_promo_sk:9 ss_ext_sales_price:16 s_store_sk:26!null s_gmt_offset:53!null d_date_sk:78!null d_year:84!null d_moy:86!null c_customer_sk:108!null c_current_addr_sk:112!null ca_address_sk:128!null ca_gmt_offset:139!null i_item_sk:143!null i_category:155!null
 │    │    │    │    ├── key columns: [112] = [128]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(53,84,86,139,155), (108)-->(112), (3)==(143), (143)==(3), (4)==(108), (108)==(4), (112)==(128), (128)==(112), (1)==(78), (78)==(1), (8)==(26), (26)==(8)
 │    │    │    │    ├── inner-join (lookup customer)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4!null ss_store_sk:8!null ss_promo_sk:9 ss_ext_sales_price:16 s_store_sk:26!null s_gmt_offset:53!null d_date_sk:78!null d_year:84!null d_moy:86!null c_customer_sk:108!null c_current_addr_sk:112 i_item_sk:143!null i_category:155!null
 │    │    │    │    │    ├── key columns: [4] = [108]
 │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── fd: ()-->(53,84,86,155), (108)-->(112), (3)==(143), (143)==(3), (4)==(108), (108)==(4), (1)==(78), (78)==(1), (8)==(26), (26)==(8)
 │    │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8!null ss_promo_sk:9 ss_ext_sales_price:16 s_store_sk:26!null s_gmt_offset:53!null d_date_sk:78!null d_year:84!null d_moy:86!null i_item_sk:143!null i_category:155!null
 │    │    │    │    │    │    ├── key columns: [1] = [78]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── fd: ()-->(53,84,86,155), (3)==(143), (143)==(3), (1)==(78), (78)==(1), (8)==(26), (26)==(8)
 │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8!null ss_promo_sk:9 ss_ext_sales_price:16 s_store_sk:26!null s_gmt_offset:53!null i_item_sk:143!null i_category:155!null
 │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    │    ├── fd: ()-->(53,155), (3)==(143), (143)==(3), (8)==(26), (26)==(8)
 │    │    │    │    │    │    │    ├── inner-join (lookup store_sales)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4 ss_store_sk:8 ss_promo_sk:9 ss_ext_sales_price:16 i_item_sk:143!null i_category:155!null
 │    │    │    │    │    │    │    │    ├── key columns: [143] = [3]
 │    │    │    │    │    │    │    │    ├── fd: ()-->(155), (3)==(143), (143)==(3)
 │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:143!null i_category:155!null
 │    │    │    │    │    │    │    │    │    ├── key: (143)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(155)
 │    │    │    │    │    │    │    │    │    ├── scan item
 │    │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:143!null i_category:155
 │    │    │    │    │    │    │    │    │    │    ├── key: (143)
 │    │    │    │    │    │    │    │    │    │    └── fd: (143)-->(155)
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── i_category:155 = 'Home' [outer=(155), constraints=(/155: [/'Home' - /'Home']; tight), fd=()-->(155)]
 │    │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: s_store_sk:26!null s_gmt_offset:53!null
 │    │    │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(53)
 │    │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:26!null s_gmt_offset:53
 │    │    │    │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    │    │    │    └── fd: (26)-->(53)
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── s_gmt_offset:53 = -7 [outer=(53), immutable, constraints=(/53: [/-7 - /-7]; tight), fd=()-->(53)]
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ss_store_sk:8 = s_store_sk:26 [outer=(8,26), constraints=(/8: (/NULL - ]; /26: (/NULL - ]), fd=(8)==(26), (26)==(8)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         ├── d_year:84 = 2000 [outer=(84), constraints=(/84: [/2000 - /2000]; tight), fd=()-->(84)]
 │    │    │    │    │    │         └── d_moy:86 = 12 [outer=(86), constraints=(/86: [/12 - /12]; tight), fd=()-->(86)]
 │    │    │    │    │    └── filters (true)
 │    │    │    │    └── filters
 │    │    │    │         └── ca_gmt_offset:139 = -7 [outer=(139), immutable, constraints=(/139: [/-7 - /-7]; tight), fd=()-->(139)]
 │    │    │    └── filters
 │    │    │         └── ((p_channel_dmail:65 = 'Y') OR (p_channel_email:66 = 'Y')) OR (p_channel_tv:68 = 'Y') [outer=(65,66,68)]
 │    │    └── aggregations
 │    │         └── sum [as=sum:167, outer=(16)]
 │    │              └── ss_ext_sales_price:16
 │    ├── scalar-group-by
 │    │    ├── columns: sum:313
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── immutable
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(313)
 │    │    ├── inner-join (lookup customer_address)
 │    │    │    ├── columns: ss_sold_date_sk:168!null ss_item_sk:170!null ss_customer_sk:171!null ss_store_sk:175!null ss_ext_sales_price:183 s_store_sk:193!null s_gmt_offset:220!null d_date_sk:224!null d_year:230!null d_moy:232!null c_customer_sk:254!null c_current_addr_sk:258!null ca_address_sk:274!null ca_gmt_offset:285!null i_item_sk:289!null i_category:301!null
 │    │    │    ├── key columns: [258] = [274]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── immutable
 │    │    │    ├── fd: ()-->(220,230,232,285,301), (254)-->(258), (175)==(193), (193)==(175), (168)==(224), (224)==(168), (258)==(274), (274)==(258), (171)==(254), (254)==(171), (170)==(289), (289)==(170)
 │    │    │    ├── inner-join (lookup customer)
 │    │    │    │    ├── columns: ss_sold_date_sk:168!null ss_item_sk:170!null ss_customer_sk:171!null ss_store_sk:175!null ss_ext_sales_price:183 s_store_sk:193!null s_gmt_offset:220!null d_date_sk:224!null d_year:230!null d_moy:232!null c_customer_sk:254!null c_current_addr_sk:258 i_item_sk:289!null i_category:301!null
 │    │    │    │    ├── key columns: [171] = [254]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(220,230,232,301), (254)-->(258), (170)==(289), (289)==(170), (171)==(254), (254)==(171), (168)==(224), (224)==(168), (175)==(193), (193)==(175)
 │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:168!null ss_item_sk:170!null ss_customer_sk:171 ss_store_sk:175!null ss_ext_sales_price:183 s_store_sk:193!null s_gmt_offset:220!null d_date_sk:224!null d_year:230!null d_moy:232!null i_item_sk:289!null i_category:301!null
 │    │    │    │    │    ├── key columns: [168] = [224]
 │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── fd: ()-->(220,230,232,301), (170)==(289), (289)==(170), (168)==(224), (224)==(168), (175)==(193), (193)==(175)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: ss_sold_date_sk:168 ss_item_sk:170!null ss_customer_sk:171 ss_store_sk:175!null ss_ext_sales_price:183 s_store_sk:193!null s_gmt_offset:220!null i_item_sk:289!null i_category:301!null
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── fd: ()-->(220,301), (170)==(289), (289)==(170), (175)==(193), (193)==(175)
 │    │    │    │    │    │    ├── inner-join (lookup store_sales)
 │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:168 ss_item_sk:170!null ss_customer_sk:171 ss_store_sk:175 ss_ext_sales_price:183 i_item_sk:289!null i_category:301!null
 │    │    │    │    │    │    │    ├── key columns: [289] = [170]
 │    │    │    │    │    │    │    ├── fd: ()-->(301), (170)==(289), (289)==(170)
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: i_item_sk:289!null i_category:301!null
 │    │    │    │    │    │    │    │    ├── key: (289)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(301)
 │    │    │    │    │    │    │    │    ├── scan item
 │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:289!null i_category:301
 │    │    │    │    │    │    │    │    │    ├── key: (289)
 │    │    │    │    │    │    │    │    │    └── fd: (289)-->(301)
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── i_category:301 = 'Home' [outer=(301), constraints=(/301: [/'Home' - /'Home']; tight), fd=()-->(301)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: s_store_sk:193!null s_gmt_offset:220!null
 │    │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    │    ├── key: (193)
 │    │    │    │    │    │    │    ├── fd: ()-->(220)
 │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    ├── columns: s_store_sk:193!null s_gmt_offset:220
 │    │    │    │    │    │    │    │    ├── key: (193)
 │    │    │    │    │    │    │    │    └── fd: (193)-->(220)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── s_gmt_offset:220 = -7 [outer=(220), immutable, constraints=(/220: [/-7 - /-7]; tight), fd=()-->(220)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_store_sk:175 = s_store_sk:193 [outer=(175,193), constraints=(/175: (/NULL - ]; /193: (/NULL - ]), fd=(175)==(193), (193)==(175)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         ├── d_year:230 = 2000 [outer=(230), constraints=(/230: [/2000 - /2000]; tight), fd=()-->(230)]
 │    │    │    │    │         └── d_moy:232 = 12 [outer=(232), constraints=(/232: [/12 - /12]; tight), fd=()-->(232)]
 │    │    │    │    └── filters (true)
 │    │    │    └── filters
 │    │    │         └── ca_gmt_offset:285 = -7 [outer=(285), immutable, constraints=(/285: [/-7 - /-7]; tight), fd=()-->(285)]
 │    │    └── aggregations
 │    │         └── sum [as=sum:313, outer=(183)]
 │    │              └── ss_ext_sales_price:183
 │    └── filters (true)
 └── projections
      └── (sum:167::DECIMAL(15,4) / sum:313::DECIMAL(15,4)) * 100 [as="?column?":314, outer=(167,313), immutable]

# --------------------------------------------------
# Q62
opt
	SELECT
		substr(w_warehouse_name, 1, 20),
		sm_type,
		web_name,
		sum(
			CASE
			WHEN (ws_ship_date_sk - ws_sold_date_sk <= 30)
			THEN 1
			ELSE 0
			END
		)
			AS "30 days",
		sum(
			CASE
			WHEN ws_ship_date_sk - ws_sold_date_sk > 30
			AND ws_ship_date_sk - ws_sold_date_sk <= 60
			THEN 1
			ELSE 0
			END
		)
			AS "31-60 days",
		sum(
			CASE
			WHEN ws_ship_date_sk - ws_sold_date_sk > 60
			AND ws_ship_date_sk - ws_sold_date_sk <= 90
			THEN 1
			ELSE 0
			END
		)
			AS "61-90 days",
		sum(
			CASE
			WHEN ws_ship_date_sk - ws_sold_date_sk > 90
			AND ws_ship_date_sk - ws_sold_date_sk <= 120
			THEN 1
			ELSE 0
			END
		)
			AS "91-120 days",
		sum(
			CASE
			WHEN (ws_ship_date_sk - ws_sold_date_sk > 120)
			THEN 1
			ELSE 0
			END
		)
			AS ">120 days"
	FROM
		web_sales, warehouse, ship_mode, web_site, date_dim
	WHERE
		d_month_seq BETWEEN 1223 AND (1223 + 11)
		AND ws_ship_date_sk = d_date_sk
		AND ws_warehouse_sk = w_warehouse_sk
		AND ws_ship_mode_sk = sm_ship_mode_sk
		AND ws_web_site_sk = web_site_sk
	GROUP BY
		substr(w_warehouse_name, 1, 20), sm_type, web_name
	ORDER BY
		substr(w_warehouse_name, 1, 20), sm_type, web_name
	LIMIT
		100;
----
top-k
 ├── columns: substr:129 sm_type:55 web_name:65 "30 days":120 "31-60 days":122 "61-90 days":124 "91-120 days":126 ">120 days":128
 ├── internal-ordering: +129,+55,+65
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (55,65,129)
 ├── fd: (55,65,129)-->(120,122,124,126,128)
 ├── ordering: +129,+55,+65
 └── group-by (hash)
      ├── columns: sm_type:55 web_name:65 sum:120 sum:122 sum:124 sum:126 sum:128 column129:129
      ├── grouping columns: sm_type:55 web_name:65 column129:129
      ├── immutable
      ├── key: (55,65,129)
      ├── fd: (55,65,129)-->(120,122,124,126,128)
      ├── project
      │    ├── columns: column119:119 column121:121 column123:123 column125:125 column127:127 column129:129 sm_type:55 web_name:65
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: ws_sold_date_sk:1 ws_ship_date_sk:3!null ws_web_site_sk:14!null ws_ship_mode_sk:15!null ws_warehouse_sk:16!null w_warehouse_sk:37!null w_warehouse_name:39 sm_ship_mode_sk:53!null sm_type:55 web_site_sk:61!null web_name:65 d_date_sk:89!null d_month_seq:92!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: (37)-->(39), (53)-->(55), (61)-->(65), (89)-->(92), (16)==(37), (37)==(16), (15)==(53), (53)==(15), (14)==(61), (61)==(14), (3)==(89), (89)==(3)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ws_sold_date_sk:1 ws_ship_date_sk:3!null ws_web_site_sk:14 ws_ship_mode_sk:15!null ws_warehouse_sk:16!null w_warehouse_sk:37!null w_warehouse_name:39 sm_ship_mode_sk:53!null sm_type:55 d_date_sk:89!null d_month_seq:92!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(39), (53)-->(55), (89)-->(92), (3)==(89), (89)==(3), (15)==(53), (53)==(15), (16)==(37), (37)==(16)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_ship_date_sk:3!null ws_web_site_sk:14 ws_ship_mode_sk:15 ws_warehouse_sk:16!null w_warehouse_sk:37!null w_warehouse_name:39 d_date_sk:89!null d_month_seq:92!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: (37)-->(39), (89)-->(92), (3)==(89), (89)==(3), (16)==(37), (37)==(16)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_ship_date_sk:3!null ws_web_site_sk:14 ws_ship_mode_sk:15 ws_warehouse_sk:16 d_date_sk:89!null d_month_seq:92!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: (89)-->(92), (3)==(89), (89)==(3)
      │    │    │    │    │    ├── scan web_sales
      │    │    │    │    │    │    └── columns: ws_sold_date_sk:1 ws_ship_date_sk:3 ws_web_site_sk:14 ws_ship_mode_sk:15 ws_warehouse_sk:16
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:89!null d_month_seq:92!null
      │    │    │    │    │    │    ├── key: (89)
      │    │    │    │    │    │    ├── fd: (89)-->(92)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:89!null d_month_seq:92
      │    │    │    │    │    │    │    ├── key: (89)
      │    │    │    │    │    │    │    └── fd: (89)-->(92)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── (d_month_seq:92 >= 1223) AND (d_month_seq:92 <= 1234) [outer=(92), constraints=(/92: [/1223 - /1234]; tight)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ws_ship_date_sk:3 = d_date_sk:89 [outer=(3,89), constraints=(/3: (/NULL - ]; /89: (/NULL - ]), fd=(3)==(89), (89)==(3)]
      │    │    │    │    ├── scan warehouse
      │    │    │    │    │    ├── columns: w_warehouse_sk:37!null w_warehouse_name:39
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    └── fd: (37)-->(39)
      │    │    │    │    └── filters
      │    │    │    │         └── ws_warehouse_sk:16 = w_warehouse_sk:37 [outer=(16,37), constraints=(/16: (/NULL - ]; /37: (/NULL - ]), fd=(16)==(37), (37)==(16)]
      │    │    │    ├── scan ship_mode
      │    │    │    │    ├── columns: sm_ship_mode_sk:53!null sm_type:55
      │    │    │    │    ├── key: (53)
      │    │    │    │    └── fd: (53)-->(55)
      │    │    │    └── filters
      │    │    │         └── ws_ship_mode_sk:15 = sm_ship_mode_sk:53 [outer=(15,53), constraints=(/15: (/NULL - ]; /53: (/NULL - ]), fd=(15)==(53), (53)==(15)]
      │    │    ├── scan web_site
      │    │    │    ├── columns: web_site_sk:61!null web_name:65
      │    │    │    ├── key: (61)
      │    │    │    └── fd: (61)-->(65)
      │    │    └── filters
      │    │         └── ws_web_site_sk:14 = web_site_sk:61 [outer=(14,61), constraints=(/14: (/NULL - ]; /61: (/NULL - ]), fd=(14)==(61), (61)==(14)]
      │    └── projections
      │         ├── CASE WHEN (ws_ship_date_sk:3 - ws_sold_date_sk:1) <= 30 THEN 1 ELSE 0 END [as=column119:119, outer=(1,3), immutable]
      │         ├── CASE WHEN ((ws_ship_date_sk:3 - ws_sold_date_sk:1) > 30) AND ((ws_ship_date_sk:3 - ws_sold_date_sk:1) <= 60) THEN 1 ELSE 0 END [as=column121:121, outer=(1,3), immutable]
      │         ├── CASE WHEN ((ws_ship_date_sk:3 - ws_sold_date_sk:1) > 60) AND ((ws_ship_date_sk:3 - ws_sold_date_sk:1) <= 90) THEN 1 ELSE 0 END [as=column123:123, outer=(1,3), immutable]
      │         ├── CASE WHEN ((ws_ship_date_sk:3 - ws_sold_date_sk:1) > 90) AND ((ws_ship_date_sk:3 - ws_sold_date_sk:1) <= 120) THEN 1 ELSE 0 END [as=column125:125, outer=(1,3), immutable]
      │         ├── CASE WHEN (ws_ship_date_sk:3 - ws_sold_date_sk:1) > 120 THEN 1 ELSE 0 END [as=column127:127, outer=(1,3), immutable]
      │         └── substr(w_warehouse_name:39, 1, 20) [as=column129:129, outer=(39), immutable]
      └── aggregations
           ├── sum [as=sum:120, outer=(119)]
           │    └── column119:119
           ├── sum [as=sum:122, outer=(121)]
           │    └── column121:121
           ├── sum [as=sum:124, outer=(123)]
           │    └── column123:123
           ├── sum [as=sum:126, outer=(125)]
           │    └── column125:125
           └── sum [as=sum:128, outer=(127)]
                └── column127:127

# --------------------------------------------------
# Q63
opt
	SELECT
		*
	FROM
		(
			SELECT
				i_manager_id,
				sum(ss_sales_price) AS sum_sales,
				avg(sum(ss_sales_price)) OVER (
					PARTITION BY i_manager_id
				)
					AS avg_monthly_sales
			FROM
				item, store_sales, date_dim, store
			WHERE
				ss_item_sk = i_item_sk
				AND ss_sold_date_sk = d_date_sk
				AND ss_store_sk = s_store_sk
				AND d_month_seq
					IN (
							1222,
							1222 + 1,
							1222 + 2,
							1222 + 3,
							1222 + 4,
							1222 + 5,
							1222 + 6,
							1222 + 7,
							1222 + 8,
							1222 + 9,
							1222 + 10,
							1222 + 11
						)
				AND (
						(
							i_category
							IN (
									'Books',
									'Children',
									'Electronics'
								)
							AND i_class
								IN (
										'personal',
										'portable',
										'reference',
										'self-help'
									)
							AND i_brand
								IN (
										'scholaramalgamalg #14',
										'scholaramalgamalg #7',
										'exportiunivamalg #9',
										'scholaramalgamalg #9'
									)
						)
						OR (
								i_category
								IN ('Women', 'Music', 'Men')
								AND i_class
									IN (
											'accessories',
											'classical',
											'fragrances',
											'pants'
										)
								AND i_brand
									IN (
											'amalgimporto #1',
											'edu packscholar #1',
											'exportiimporto #1',
											'importoamalg #1'
										)
							)
					)
			GROUP BY
				i_manager_id, d_moy
		)
			AS tmp1
	WHERE
		CASE
		WHEN avg_monthly_sales > 0
		THEN abs(sum_sales - avg_monthly_sales)
		/ avg_monthly_sales
		ELSE NULL
		END
		> 0.1
	ORDER BY
		i_manager_id, avg_monthly_sales, sum_sales
	LIMIT
		100;
----
project
 ├── columns: i_manager_id:21 sum_sales:111 avg_monthly_sales:112
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +21,+112,+111
 └── top-k
      ├── columns: i_manager_id:21 d_moy:58 sum:111 avg:112
      ├── internal-ordering: +21,+112,+111
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── key: (21,58)
      ├── fd: (21,58)-->(111,112)
      ├── ordering: +21,+112,+111
      └── select
           ├── columns: i_manager_id:21 d_moy:58 sum:111 avg:112
           ├── immutable
           ├── key: (21,58)
           ├── fd: (21,58)-->(111,112)
           ├── window partition=(21)
           │    ├── columns: i_manager_id:21 d_moy:58 sum:111 avg:112
           │    ├── key: (21,58)
           │    ├── fd: (21,58)-->(111,112)
           │    ├── group-by (hash)
           │    │    ├── columns: i_manager_id:21 d_moy:58 sum:111
           │    │    ├── grouping columns: i_manager_id:21 d_moy:58
           │    │    ├── key: (21,58)
           │    │    ├── fd: (21,58)-->(111)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manager_id:21 ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32!null ss_sales_price:38 d_date_sk:50!null d_month_seq:53!null d_moy:58 s_store_sk:80!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: (1)-->(9,11,13,21), (50)-->(53,58), (25)==(50), (50)==(25), (32)==(80), (80)==(32), (1)==(27), (27)==(1)
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manager_id:21 ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38 d_date_sk:50!null d_month_seq:53!null d_moy:58
           │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    ├── fd: (1)-->(9,11,13,21), (50)-->(53,58), (25)==(50), (50)==(25), (1)==(27), (27)==(1)
           │    │    │    │    ├── inner-join (lookup store_sales)
           │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manager_id:21 ss_sold_date_sk:25 ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38
           │    │    │    │    │    ├── key columns: [1] = [27]
           │    │    │    │    │    ├── fd: (1)-->(9,11,13,21), (1)==(27), (27)==(1)
           │    │    │    │    │    ├── select
           │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9!null i_class:11!null i_category:13!null i_manager_id:21
           │    │    │    │    │    │    ├── key: (1)
           │    │    │    │    │    │    ├── fd: (1)-->(9,11,13,21)
           │    │    │    │    │    │    ├── scan item
           │    │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11 i_category:13 i_manager_id:21
           │    │    │    │    │    │    │    ├── key: (1)
           │    │    │    │    │    │    │    └── fd: (1)-->(9,11,13,21)
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── (((i_category:13 IN ('Books', 'Children', 'Electronics')) AND (i_class:11 IN ('personal', 'portable', 'reference', 'self-help'))) AND (i_brand:9 IN ('exportiunivamalg #9', 'scholaramalgamalg #14', 'scholaramalgamalg #7', 'scholaramalgamalg #9'))) OR (((i_category:13 IN ('Men', 'Music', 'Women')) AND (i_class:11 IN ('accessories', 'classical', 'fragrances', 'pants'))) AND (i_brand:9 IN ('amalgimporto #1', 'edu packscholar #1', 'exportiimporto #1', 'importoamalg #1'))) [outer=(9,11,13), constraints=(/9: [/'amalgimporto #1' - /'amalgimporto #1'] [/'edu packscholar #1' - /'edu packscholar #1'] [/'exportiimporto #1' - /'exportiimporto #1'] [/'exportiunivamalg #9' - /'exportiunivamalg #9'] [/'importoamalg #1' - /'importoamalg #1'] [/'scholaramalgamalg #14' - /'scholaramalgamalg #14'] [/'scholaramalgamalg #7' - /'scholaramalgamalg #7'] [/'scholaramalgamalg #9' - /'scholaramalgamalg #9']; /11: [/'accessories' - /'accessories'] [/'classical' - /'classical'] [/'fragrances' - /'fragrances'] [/'pants' - /'pants'] [/'personal' - /'personal'] [/'portable' - /'portable'] [/'reference' - /'reference'] [/'self-help' - /'self-help']; /13: [/'Books' - /'Books'] [/'Children' - /'Children'] [/'Electronics' - /'Electronics'] [/'Men' - /'Men'] [/'Music' - /'Music'] [/'Women' - /'Women'])]
           │    │    │    │    │    └── filters (true)
           │    │    │    │    ├── select
           │    │    │    │    │    ├── columns: d_date_sk:50!null d_month_seq:53!null d_moy:58
           │    │    │    │    │    ├── key: (50)
           │    │    │    │    │    ├── fd: (50)-->(53,58)
           │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_month_seq:53 d_moy:58
           │    │    │    │    │    │    ├── key: (50)
           │    │    │    │    │    │    └── fd: (50)-->(53,58)
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── d_month_seq:53 IN (1222, 1223, 1224, 1225, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233) [outer=(53), constraints=(/53: [/1222 - /1222] [/1223 - /1223] [/1224 - /1224] [/1225 - /1225] [/1226 - /1226] [/1227 - /1227] [/1228 - /1228] [/1229 - /1229] [/1230 - /1230] [/1231 - /1231] [/1232 - /1232] [/1233 - /1233]; tight)]
           │    │    │    │    └── filters
           │    │    │    │         └── ss_sold_date_sk:25 = d_date_sk:50 [outer=(25,50), constraints=(/25: (/NULL - ]; /50: (/NULL - ]), fd=(25)==(50), (50)==(25)]
           │    │    │    ├── scan store
           │    │    │    │    ├── columns: s_store_sk:80!null
           │    │    │    │    └── key: (80)
           │    │    │    └── filters
           │    │    │         └── ss_store_sk:32 = s_store_sk:80 [outer=(32,80), constraints=(/32: (/NULL - ]; /80: (/NULL - ]), fd=(32)==(80), (80)==(32)]
           │    │    └── aggregations
           │    │         └── sum [as=sum:111, outer=(38)]
           │    │              └── ss_sales_price:38
           │    └── windows
           │         └── avg [as=avg:112, outer=(111)]
           │              └── sum:111
           └── filters
                └── CASE WHEN avg:112 > 0 THEN abs(sum:111 - avg:112) / avg:112 ELSE CAST(NULL AS DECIMAL) END > 0.1 [outer=(111,112), immutable]

# --------------------------------------------------
# Q64
opt
	WITH
		cs_ui
			AS (
				SELECT
					cs_item_sk,
					sum(cs_ext_list_price) AS sale,
					sum(
						cr_refunded_cash
						+ cr_reversed_charge
						+ cr_store_credit
					)
						AS refund
				FROM
					catalog_sales, catalog_returns
				WHERE
					cs_item_sk = cr_item_sk
					AND cs_order_number = cr_order_number
				GROUP BY
					cs_item_sk
				HAVING
					sum(cs_ext_list_price)
					> 2
						* sum(
								cr_refunded_cash
								+ cr_reversed_charge
								+ cr_store_credit
							)
			),
		cross_sales
			AS (
				SELECT
					i_product_name AS product_name,
					i_item_sk AS item_sk,
					s_store_name AS store_name,
					s_zip AS store_zip,
					ad1.ca_street_number AS b_street_number,
					ad1.ca_street_name AS b_street_name,
					ad1.ca_city AS b_city,
					ad1.ca_zip AS b_zip,
					ad2.ca_street_number AS c_street_number,
					ad2.ca_street_name AS c_street_name,
					ad2.ca_city AS c_city,
					ad2.ca_zip AS c_zip,
					d1.d_year AS syear,
					d2.d_year AS fsyear,
					d3.d_year AS s2year,
					count(*) AS cnt,
					sum(ss_wholesale_cost) AS s1,
					sum(ss_list_price) AS s2,
					sum(ss_coupon_amt) AS s3
				FROM
					store_sales,
					store_returns,
					cs_ui,
					date_dim AS d1,
					date_dim AS d2,
					date_dim AS d3,
					store,
					customer,
					customer_demographics AS cd1,
					customer_demographics AS cd2,
					promotion,
					household_demographics AS hd1,
					household_demographics AS hd2,
					customer_address AS ad1,
					customer_address AS ad2,
					income_band AS ib1,
					income_band AS ib2,
					item
				WHERE
					ss_store_sk = s_store_sk
					AND ss_sold_date_sk = d1.d_date_sk
					AND ss_customer_sk = c_customer_sk
					AND ss_cdemo_sk = cd1.cd_demo_sk
					AND ss_hdemo_sk = hd1.hd_demo_sk
					AND ss_addr_sk = ad1.ca_address_sk
					AND ss_item_sk = i_item_sk
					AND ss_item_sk = sr_item_sk
					AND ss_ticket_number = sr_ticket_number
					AND ss_item_sk = cs_ui.cs_item_sk
					AND c_current_cdemo_sk = cd2.cd_demo_sk
					AND c_current_hdemo_sk = hd2.hd_demo_sk
					AND c_current_addr_sk = ad2.ca_address_sk
					AND c_first_sales_date_sk = d2.d_date_sk
					AND c_first_shipto_date_sk = d3.d_date_sk
					AND ss_promo_sk = p_promo_sk
					AND hd1.hd_income_band_sk
						= ib1.ib_income_band_sk
					AND hd2.hd_income_band_sk
						= ib2.ib_income_band_sk
					AND cd1.cd_marital_status
						!= cd2.cd_marital_status
					AND i_color
						IN (
								'orange',
								'lace',
								'lawn',
								'misty',
								'blush',
								'pink'
							)
					AND i_current_price BETWEEN 48 AND (48 + 10)
					AND i_current_price BETWEEN (48 + 1) AND (48 + 15)
				GROUP BY
					i_product_name,
					i_item_sk,
					s_store_name,
					s_zip,
					ad1.ca_street_number,
					ad1.ca_street_name,
					ad1.ca_city,
					ad1.ca_zip,
					ad2.ca_street_number,
					ad2.ca_street_name,
					ad2.ca_city,
					ad2.ca_zip,
					d1.d_year,
					d2.d_year,
					d3.d_year
			)
	SELECT
		cs1.product_name,
		cs1.store_name,
		cs1.store_zip,
		cs1.b_street_number,
		cs1.b_street_name,
		cs1.b_city,
		cs1.b_zip,
		cs1.c_street_number,
		cs1.c_street_name,
		cs1.c_city,
		cs1.c_zip,
		cs1.syear,
		cs1.cnt,
		cs1.s1 AS s11,
		cs1.s2 AS s21,
		cs1.s3 AS s31,
		cs2.s1 AS s12,
		cs2.s2 AS s22,
		cs2.s3 AS s32,
		cs2.syear,
		cs2.cnt
	FROM
		cross_sales AS cs1, cross_sales AS cs2
	WHERE
		cs1.item_sk = cs2.item_sk
		AND cs1.syear = 1999
		AND cs2.syear = 1999 + 1
		AND cs2.cnt <= cs1.cnt
		AND cs1.store_name = cs2.store_name
		AND cs1.store_zip = cs2.store_zip
	ORDER BY
		cs1.product_name,
		cs1.store_name,
		cs2.cnt,
		cs1.s1,
		cs2.s1;
----
sort
 ├── columns: product_name:385 store_name:387!null store_zip:388!null b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397!null cnt:400!null s11:401 s21:402 s31:403 s12:420 s22:421 s32:422 syear:416!null cnt:419!null
 ├── immutable
 ├── fd: ()-->(397,416)
 ├── ordering: +385,+387,+419,+401,+420 opt(397,416) [actual: +385,+387,+419,+401,+420]
 └── with &2 (cross_sales)
      ├── columns: product_name:385 store_name:387!null store_zip:388!null b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397!null cnt:400!null s1:401 s2:402 s3:403 syear:416!null cnt:419!null s1:420 s2:421 s3:422
      ├── immutable
      ├── fd: ()-->(397,416)
      ├── group-by (hash)
      │    ├── columns: d1.d_year:125 d2.d_year:155 d3.d_year:185 s_store_name:214 s_zip:234 ad1.ca_street_number:319 ad1.ca_street_name:320 ad1.ca_city:323 ad1.ca_zip:326 ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 i_item_sk:357!null i_product_name:378 count_rows:381!null sum:382 sum:383 sum:384
      │    ├── grouping columns: d1.d_year:125 d2.d_year:155 d3.d_year:185 s_store_name:214 s_zip:234 ad1.ca_street_number:319 ad1.ca_street_name:320 ad1.ca_city:323 ad1.ca_zip:326 ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 i_item_sk:357!null
      │    ├── immutable
      │    ├── key: (125,155,185,214,234,319,320,323,326,334,335,338,341,357)
      │    ├── fd: (357)-->(378), (125,155,185,214,234,319,320,323,326,334,335,338,341,357)-->(378,381-384)
      │    ├── inner-join (hash)
      │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69!null ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74!null ss_addr_sk:75!null ss_store_sk:76!null ss_promo_sk:77!null ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d1.d_date_sk:119!null d1.d_year:125 d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 s_store_sk:209!null s_store_name:214 s_zip:234 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null p_promo_sk:282!null hd1.hd_demo_sk:303!null hd1.hd_income_band_sk:304!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad1.ca_address_sk:317!null ad1.ca_street_number:319 ad1.ca_street_name:320 ad1.ca_city:323 ad1.ca_zip:326 ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib1.ib_income_band_sk:347!null ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    ├── immutable
      │    │    ├── key: (103,357)
      │    │    ├── fd: (71,78)-->(69,72-77,80,81,88), (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (303)-->(304), (317)-->(319,320,323,326), (209)-->(214,234), (119)-->(125), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (304)==(347), (347)==(304), (74)==(303), (303)==(74), (75)==(317), (317)==(75), (77)==(282), (282)==(77), (76)==(209), (209)==(76), (69)==(119), (119)==(69)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: hd1.hd_demo_sk:303!null hd1.hd_income_band_sk:304!null ib1.ib_income_band_sk:347!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── key: (303)
      │    │    │    ├── fd: (303)-->(304), (304)==(347), (347)==(304)
      │    │    │    ├── scan household_demographics [as=hd1]
      │    │    │    │    ├── columns: hd1.hd_demo_sk:303!null hd1.hd_income_band_sk:304
      │    │    │    │    ├── key: (303)
      │    │    │    │    └── fd: (303)-->(304)
      │    │    │    ├── scan income_band [as=ib1]
      │    │    │    │    ├── columns: ib1.ib_income_band_sk:347!null
      │    │    │    │    └── key: (347)
      │    │    │    └── filters
      │    │    │         └── hd1.hd_income_band_sk:304 = ib1.ib_income_band_sk:347 [outer=(304,347), constraints=(/304: (/NULL - ]; /347: (/NULL - ]), fd=(304)==(347), (347)==(304)]
      │    │    ├── inner-join (lookup date_dim [as=d1])
      │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69!null ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75!null ss_store_sk:76!null ss_promo_sk:77!null ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d1.d_date_sk:119!null d1.d_year:125 d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 s_store_sk:209!null s_store_name:214 s_zip:234 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null p_promo_sk:282!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad1.ca_address_sk:317!null ad1.ca_street_number:319 ad1.ca_street_name:320 ad1.ca_city:323 ad1.ca_zip:326 ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    ├── key columns: [69] = [119]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── immutable
      │    │    │    ├── key: (103,357)
      │    │    │    ├── fd: (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (317)-->(319,320,323,326), (209)-->(214,234), (71,78)-->(69,72-77,80,81,88), (119)-->(125), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (69)==(119), (119)==(69), (76)==(209), (209)==(76), (77)==(282), (282)==(77), (75)==(317), (317)==(75), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (78)==(103), (103)==(78)
      │    │    │    ├── inner-join (lookup customer_address [as=ad1])
      │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75!null ss_store_sk:76!null ss_promo_sk:77!null ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 s_store_sk:209!null s_store_name:214 s_zip:234 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null p_promo_sk:282!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad1.ca_address_sk:317!null ad1.ca_street_number:319 ad1.ca_street_name:320 ad1.ca_city:323 ad1.ca_zip:326 ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    ├── key columns: [75] = [317]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (103,357)
      │    │    │    │    ├── fd: (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (317)-->(319,320,323,326), (71,78)-->(69,72-77,80,81,88), (209)-->(214,234), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (76)==(209), (209)==(76), (77)==(282), (282)==(77), (75)==(317), (317)==(75), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76!null ss_promo_sk:77!null ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 s_store_sk:209!null s_store_name:214 s_zip:234 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null p_promo_sk:282!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── key: (103,357)
      │    │    │    │    │    ├── fd: (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (71,78)-->(69,72-77,80,81,88), (209)-->(214,234), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (76)==(209), (209)==(76), (77)==(282), (282)==(77), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76 ss_promo_sk:77!null ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null p_promo_sk:282!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    ├── key: (103,357)
      │    │    │    │    │    │    ├── fd: (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (71,78)-->(69,72-77,80,81,88), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (77)==(282), (282)==(77), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (149)==(246), (246)==(149), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78)
      │    │    │    │    │    │    ├── inner-join (lookup customer_address [as=ad2])
      │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76 ss_promo_sk:77 ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244!null c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ad2.ca_address_sk:332!null ad2.ca_street_number:334 ad2.ca_street_name:335 ad2.ca_city:338 ad2.ca_zip:341 ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    │    │    │    ├── key columns: [244] = [332]
      │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    ├── key: (103,357)
      │    │    │    │    │    │    │    ├── fd: (71,78)-->(69,72-77,80,81,88), (16)-->(66,68), (357)-->(362,374,378), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (332)-->(334,335,338,341), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (244)==(332), (332)==(244), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (72)==(240), (240)==(72), (73)==(260), (260)==(73)
      │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72!null ss_cdemo_sk:73!null ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76 ss_promo_sk:77 ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    ├── key: (103,357)
      │    │    │    │    │    │    │    │    ├── fd: (16)-->(66,68), (357)-->(362,374,378), (71,78)-->(69,72-77,80,81,88), (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (179)==(245), (245)==(179), (149)==(246), (246)==(149), (72)==(240), (240)==(72), (73)==(260), (260)==(73), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78)
      │    │    │    │    │    │    │    │    ├── inner-join (cross)
      │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd1.cd_demo_sk:260!null cd1.cd_marital_status:262!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    ├── key: (240,260)
      │    │    │    │    │    │    │    │    │    ├── fd: (149)-->(155), (179)-->(185), (240)-->(242-246), (260)-->(262), (271)-->(273), (310)-->(311), (242)==(271), (271)==(242), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (179)==(245), (245)==(179), (149)==(246), (246)==(149)
      │    │    │    │    │    │    │    │    │    ├── scan customer_demographics [as=cd1]
      │    │    │    │    │    │    │    │    │    │    ├── columns: cd1.cd_demo_sk:260!null cd1.cd_marital_status:262
      │    │    │    │    │    │    │    │    │    │    ├── key: (260)
      │    │    │    │    │    │    │    │    │    │    └── fd: (260)-->(262)
      │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242!null c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null cd2.cd_demo_sk:271!null cd2.cd_marital_status:273 hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │    │    │    │    │    │    │    │    │    ├── key: (240)
      │    │    │    │    │    │    │    │    │    │    ├── fd: (149)-->(155), (179)-->(185), (271)-->(273), (240)-->(242-246), (310)-->(311), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (242)==(271), (271)==(242), (179)==(245), (245)==(179), (149)==(246), (246)==(149)
      │    │    │    │    │    │    │    │    │    │    ├── scan customer_demographics [as=cd2]
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: cd2.cd_demo_sk:271!null cd2.cd_marital_status:273
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (271)
      │    │    │    │    │    │    │    │    │    │    │    └── fd: (271)-->(273)
      │    │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:149!null d2.d_year:155 d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242 c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245!null c_first_sales_date_sk:246!null hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (240)
      │    │    │    │    │    │    │    │    │    │    │    ├── fd: (149)-->(155), (179)-->(185), (240)-->(242-246), (310)-->(311), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (179)==(245), (245)==(179), (149)==(246), (246)==(149)
      │    │    │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: d3.d_date_sk:179!null d3.d_year:185 c_customer_sk:240!null c_current_cdemo_sk:242 c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245!null c_first_sales_date_sk:246 hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (240)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (179)-->(185), (240)-->(242-246), (310)-->(311), (311)==(352), (352)==(311), (243)==(310), (310)==(243), (179)==(245), (245)==(179)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: c_customer_sk:240!null c_current_cdemo_sk:242 c_current_hdemo_sk:243!null c_current_addr_sk:244 c_first_shipto_date_sk:245 c_first_sales_date_sk:246 hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (240)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (240)-->(242-246), (310)-->(311), (311)==(352), (352)==(311), (243)==(310), (310)==(243)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── scan customer
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: c_customer_sk:240!null c_current_cdemo_sk:242 c_current_hdemo_sk:243 c_current_addr_sk:244 c_first_shipto_date_sk:245 c_first_sales_date_sk:246
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (240)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (240)-->(242-246)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311!null ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (310)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (310)-->(311), (311)==(352), (352)==(311)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── scan household_demographics [as=hd2]
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd2.hd_demo_sk:310!null hd2.hd_income_band_sk:311
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (310)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (310)-->(311)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── scan income_band [as=ib2]
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: ib2.ib_income_band_sk:352!null
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── key: (352)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │    │    │    │         └── hd2.hd_income_band_sk:311 = ib2.ib_income_band_sk:352 [outer=(311,352), constraints=(/311: (/NULL - ]; /352: (/NULL - ]), fd=(311)==(352), (352)==(311)]
      │    │    │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │    │    │         └── c_current_hdemo_sk:243 = hd2.hd_demo_sk:310 [outer=(243,310), constraints=(/243: (/NULL - ]; /310: (/NULL - ]), fd=(243)==(310), (310)==(243)]
      │    │    │    │    │    │    │    │    │    │    │    │    ├── scan date_dim [as=d3]
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: d3.d_date_sk:179!null d3.d_year:185
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (179)
      │    │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (179)-->(185)
      │    │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │    │         └── c_first_shipto_date_sk:245 = d3.d_date_sk:179 [outer=(179,245), constraints=(/179: (/NULL - ]; /245: (/NULL - ]), fd=(179)==(245), (245)==(179)]
      │    │    │    │    │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
      │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:149!null d2.d_year:155
      │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (149)
      │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (149)-->(155)
      │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │         └── c_first_sales_date_sk:246 = d2.d_date_sk:149 [outer=(149,246), constraints=(/149: (/NULL - ]; /246: (/NULL - ]), fd=(149)==(246), (246)==(149)]
      │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │         └── c_current_cdemo_sk:242 = cd2.cd_demo_sk:271 [outer=(242,271), constraints=(/242: (/NULL - ]; /271: (/NULL - ]), fd=(242)==(271), (271)==(242)]
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         └── cd1.cd_marital_status:262 != cd2.cd_marital_status:273 [outer=(262,273), constraints=(/262: (/NULL - ]; /273: (/NULL - ])]
      │    │    │    │    │    │    │    │    ├── inner-join (lookup item)
      │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72 ss_cdemo_sk:73 ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76 ss_promo_sk:77 ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null i_item_sk:357!null i_current_price:362!null i_color:374!null i_product_name:378
      │    │    │    │    │    │    │    │    │    ├── key columns: [16] = [357]
      │    │    │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    ├── key: (103,357)
      │    │    │    │    │    │    │    │    │    ├── fd: (71,78)-->(69,72-77,80,81,88), (16)-->(66,68), (357)-->(362,374,378), (16)==(71,96,357), (71)==(16,96,357), (96)==(16,71,357), (357)==(16,71,96), (78)==(103), (103)==(78)
      │    │    │    │    │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 ss_sold_date_sk:69 ss_item_sk:71!null ss_customer_sk:72 ss_cdemo_sk:73 ss_hdemo_sk:74 ss_addr_sk:75 ss_store_sk:76 ss_promo_sk:77 ss_ticket_number:78!null ss_wholesale_cost:80 ss_list_price:81 ss_coupon_amt:88 sr_item_sk:96!null sr_ticket_number:103!null
      │    │    │    │    │    │    │    │    │    │    ├── key columns: [96 103] = [71 78]
      │    │    │    │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    │    ├── key: (96,103)
      │    │    │    │    │    │    │    │    │    │    ├── fd: (71,78)-->(69,72-77,80,81,88), (16)-->(66,68), (16)==(71,96), (71)==(16,96), (96)==(16,71), (78)==(103), (103)==(78)
      │    │    │    │    │    │    │    │    │    │    ├── inner-join (lookup store_returns)
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68 sr_item_sk:96!null sr_ticket_number:103!null
      │    │    │    │    │    │    │    │    │    │    │    ├── key columns: [16] = [96]
      │    │    │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (96,103)
      │    │    │    │    │    │    │    │    │    │    │    ├── fd: (16)-->(66,68), (16)==(96), (96)==(16)
      │    │    │    │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66!null sum:68
      │    │    │    │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (16)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (16)-->(66,68)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── group-by (streaming)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null sum:66 sum:68
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── grouping columns: catalog_sales.cs_item_sk:16!null
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── internal-ordering: +16
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (16)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (16)-->(66,68)
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── project
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: column67:67 catalog_sales.cs_item_sk:16!null cs_ext_list_price:26
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── ordering: +16
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── inner-join (lookup catalog_sales)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: catalog_sales.cs_item_sk:16!null cs_order_number:18!null cs_ext_list_price:26 cr_item_sk:39!null cr_order_number:53!null cr_refunded_cash:60 cr_reversed_charge:61 cr_store_credit:62
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key columns: [39 53] = [16 18]
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (39,53)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (16,18)-->(26), (39,53)-->(60-62), (16)==(39), (39)==(16), (18)==(53), (53)==(18)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── ordering: +(16|39) [actual: +39]
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── scan catalog_returns
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: cr_item_sk:39!null cr_order_number:53!null cr_refunded_cash:60 cr_reversed_charge:61 cr_store_credit:62
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (39,53)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: (39,53)-->(60-62)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── ordering: +39
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── projections
      │    │    │    │    │    │    │    │    │    │    │    │    │    │         └── cr_store_credit:62 + (cr_refunded_cash:60 + cr_reversed_charge:61) [as=column67:67, outer=(60-62), immutable]
      │    │    │    │    │    │    │    │    │    │    │    │    │    └── aggregations
      │    │    │    │    │    │    │    │    │    │    │    │    │         ├── sum [as=sum:66, outer=(26)]
      │    │    │    │    │    │    │    │    │    │    │    │    │         │    └── cs_ext_list_price:26
      │    │    │    │    │    │    │    │    │    │    │    │    │         └── sum [as=sum:68, outer=(67)]
      │    │    │    │    │    │    │    │    │    │    │    │    │              └── column67:67
      │    │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │    │         └── sum:66 > (sum:68 * 2) [outer=(66,68), immutable, constraints=(/66: (/NULL - ])]
      │    │    │    │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         ├── (((i_current_price:362 >= 48) AND (i_current_price:362 <= 58.00)) AND (i_current_price:362 >= 49.00)) AND (i_current_price:362 <= 63.00) [outer=(362), immutable, constraints=(/362: [/49.00 - /58.00]; tight)]
      │    │    │    │    │    │    │    │    │         └── i_color:374 IN ('blush', 'lace', 'lawn', 'misty', 'orange', 'pink') [outer=(374), constraints=(/374: [/'blush' - /'blush'] [/'lace' - /'lace'] [/'lawn' - /'lawn'] [/'misty' - /'misty'] [/'orange' - /'orange'] [/'pink' - /'pink']; tight)]
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         ├── ss_customer_sk:72 = c_customer_sk:240 [outer=(72,240), constraints=(/72: (/NULL - ]; /240: (/NULL - ]), fd=(72)==(240), (240)==(72)]
      │    │    │    │    │    │    │    │         └── ss_cdemo_sk:73 = cd1.cd_demo_sk:260 [outer=(73,260), constraints=(/73: (/NULL - ]; /260: (/NULL - ]), fd=(73)==(260), (260)==(73)]
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    ├── scan promotion
      │    │    │    │    │    │    │    ├── columns: p_promo_sk:282!null
      │    │    │    │    │    │    │    └── key: (282)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_promo_sk:77 = p_promo_sk:282 [outer=(77,282), constraints=(/77: (/NULL - ]; /282: (/NULL - ]), fd=(77)==(282), (282)==(77)]
      │    │    │    │    │    ├── scan store
      │    │    │    │    │    │    ├── columns: s_store_sk:209!null s_store_name:214 s_zip:234
      │    │    │    │    │    │    ├── key: (209)
      │    │    │    │    │    │    └── fd: (209)-->(214,234)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ss_store_sk:76 = s_store_sk:209 [outer=(76,209), constraints=(/76: (/NULL - ]; /209: (/NULL - ]), fd=(76)==(209), (209)==(76)]
      │    │    │    │    └── filters (true)
      │    │    │    └── filters (true)
      │    │    └── filters
      │    │         └── ss_hdemo_sk:74 = hd1.hd_demo_sk:303 [outer=(74,303), constraints=(/74: (/NULL - ]; /303: (/NULL - ]), fd=(74)==(303), (303)==(74)]
      │    └── aggregations
      │         ├── count-rows [as=count_rows:381]
      │         ├── sum [as=sum:382, outer=(80)]
      │         │    └── ss_wholesale_cost:80
      │         ├── sum [as=sum:383, outer=(81)]
      │         │    └── ss_list_price:81
      │         ├── sum [as=sum:384, outer=(88)]
      │         │    └── ss_coupon_amt:88
      │         └── const-agg [as=i_product_name:378, outer=(378)]
      │              └── i_product_name:378
      └── project
           ├── columns: product_name:385 store_name:387!null store_zip:388!null b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397!null cnt:400!null s1:401 s2:402 s3:403 syear:416!null cnt:419!null s1:420 s2:421 s3:422
           ├── fd: ()-->(397,416)
           └── inner-join (hash)
                ├── columns: product_name:385 item_sk:386!null store_name:387!null store_zip:388!null b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397!null cnt:400!null s1:401 s2:402 s3:403 item_sk:405!null store_name:406!null store_zip:407!null syear:416!null cnt:419!null s1:420 s2:421 s3:422
                ├── fd: ()-->(397,416), (386)-->(385), (386)==(405), (405)==(386), (387)==(406), (406)==(387), (388)==(407), (407)==(388)
                ├── select
                │    ├── columns: product_name:385 item_sk:386!null store_name:387 store_zip:388 b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397!null cnt:400!null s1:401 s2:402 s3:403
                │    ├── fd: ()-->(397), (386)-->(385)
                │    ├── with-scan &2 (cross_sales)
                │    │    ├── columns: product_name:385 item_sk:386!null store_name:387 store_zip:388 b_street_number:389 b_street_name:390 b_city:391 b_zip:392 c_street_number:393 c_street_name:394 c_city:395 c_zip:396 syear:397 cnt:400!null s1:401 s2:402 s3:403
                │    │    ├── mapping:
                │    │    │    ├──  i_product_name:378 => product_name:385
                │    │    │    ├──  i_item_sk:357 => item_sk:386
                │    │    │    ├──  s_store_name:214 => store_name:387
                │    │    │    ├──  s_zip:234 => store_zip:388
                │    │    │    ├──  ad1.ca_street_number:319 => b_street_number:389
                │    │    │    ├──  ad1.ca_street_name:320 => b_street_name:390
                │    │    │    ├──  ad1.ca_city:323 => b_city:391
                │    │    │    ├──  ad1.ca_zip:326 => b_zip:392
                │    │    │    ├──  ad2.ca_street_number:334 => c_street_number:393
                │    │    │    ├──  ad2.ca_street_name:335 => c_street_name:394
                │    │    │    ├──  ad2.ca_city:338 => c_city:395
                │    │    │    ├──  ad2.ca_zip:341 => c_zip:396
                │    │    │    ├──  d1.d_year:125 => syear:397
                │    │    │    ├──  count_rows:381 => cnt:400
                │    │    │    ├──  sum:382 => s1:401
                │    │    │    ├──  sum:383 => s2:402
                │    │    │    └──  sum:384 => s3:403
                │    │    └── fd: (386)-->(385)
                │    └── filters
                │         └── syear:397 = 1999 [outer=(397), constraints=(/397: [/1999 - /1999]; tight), fd=()-->(397)]
                ├── select
                │    ├── columns: item_sk:405!null store_name:406 store_zip:407 syear:416!null cnt:419!null s1:420 s2:421 s3:422
                │    ├── fd: ()-->(416)
                │    ├── with-scan &2 (cross_sales)
                │    │    ├── columns: item_sk:405!null store_name:406 store_zip:407 syear:416 cnt:419!null s1:420 s2:421 s3:422
                │    │    └── mapping:
                │    │         ├──  i_item_sk:357 => item_sk:405
                │    │         ├──  s_store_name:214 => store_name:406
                │    │         ├──  s_zip:234 => store_zip:407
                │    │         ├──  d1.d_year:125 => syear:416
                │    │         ├──  count_rows:381 => cnt:419
                │    │         ├──  sum:382 => s1:420
                │    │         ├──  sum:383 => s2:421
                │    │         └──  sum:384 => s3:422
                │    └── filters
                │         └── syear:416 = 2000 [outer=(416), constraints=(/416: [/2000 - /2000]; tight), fd=()-->(416)]
                └── filters
                     ├── item_sk:386 = item_sk:405 [outer=(386,405), constraints=(/386: (/NULL - ]; /405: (/NULL - ]), fd=(386)==(405), (405)==(386)]
                     ├── cnt:419 <= cnt:400 [outer=(400,419), constraints=(/400: (/NULL - ]; /419: (/NULL - ])]
                     ├── store_name:387 = store_name:406 [outer=(387,406), constraints=(/387: (/NULL - ]; /406: (/NULL - ]), fd=(387)==(406), (406)==(387)]
                     └── store_zip:388 = store_zip:407 [outer=(388,407), constraints=(/388: (/NULL - ]; /407: (/NULL - ]), fd=(388)==(407), (407)==(388)]

# --------------------------------------------------
# Q65
opt
	SELECT
		s_store_name,
		i_item_desc,
		sc.revenue,
		i_current_price,
		i_wholesale_cost,
		i_brand
	FROM
		store,
		item,
		(
			SELECT
				ss_store_sk, avg(revenue) AS ave
			FROM
				(
					SELECT
						ss_store_sk,
						ss_item_sk,
						sum(ss_sales_price) AS revenue
					FROM
						store_sales, date_dim
					WHERE
						ss_sold_date_sk = d_date_sk
						AND d_month_seq BETWEEN 1176 AND (1176 + 11)
					GROUP BY
						ss_store_sk, ss_item_sk
				)
					AS sa
			GROUP BY
				ss_store_sk
		)
			AS sb,
		(
			SELECT
				ss_store_sk,
				ss_item_sk,
				sum(ss_sales_price) AS revenue
			FROM
				store_sales, date_dim
			WHERE
				ss_sold_date_sk = d_date_sk
				AND d_month_seq BETWEEN 1176 AND (1176 + 11)
			GROUP BY
				ss_store_sk, ss_item_sk
		)
			AS sc
	WHERE
		sb.ss_store_sk = sc.ss_store_sk
		AND sc.revenue <= 0.1 * sb.ave
		AND s_store_sk = sc.ss_store_sk
		AND i_item_sk = sc.ss_item_sk
	ORDER BY
		s_store_name, i_item_desc
	LIMIT
		100;
----
project
 ├── columns: s_store_name:6 i_item_desc:36 revenue:168!null i_current_price:37 i_wholesale_cost:38 i_brand:40
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +6,+36
 └── top-k
      ├── columns: s_store_sk:1!null s_store_name:6 i_item_sk:32!null i_item_desc:36 i_current_price:37 i_wholesale_cost:38 i_brand:40 ss_store_sk:63!null ss_item_sk:115!null ss_store_sk:120!null sum:168!null column169:169!null
      ├── internal-ordering: +6,+36
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── key: (115,120)
      ├── fd: (1)-->(6), (32)-->(36-38,40), (63)-->(169), (115,120)-->(168), (1)==(63,120), (63)==(1,120), (120)==(1,63), (32)==(115), (115)==(32)
      ├── ordering: +6,+36
      └── inner-join (hash)
           ├── columns: s_store_sk:1!null s_store_name:6 i_item_sk:32!null i_item_desc:36 i_current_price:37 i_wholesale_cost:38 i_brand:40 ss_store_sk:63!null ss_item_sk:115!null ss_store_sk:120!null sum:168!null column169:169!null
           ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           ├── immutable
           ├── key: (115,120)
           ├── fd: (1)-->(6), (32)-->(36-38,40), (63)-->(169), (115,120)-->(168), (1)==(63,120), (63)==(1,120), (120)==(1,63), (32)==(115), (115)==(32)
           ├── inner-join (hash)
           │    ├── columns: s_store_sk:1!null s_store_name:6 ss_store_sk:63!null ss_item_sk:115!null ss_store_sk:120!null sum:168!null column169:169!null
           │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    ├── immutable
           │    ├── key: (115,120)
           │    ├── fd: (1)-->(6), (63)-->(169), (115,120)-->(168), (1)==(63,120), (63)==(1,120), (120)==(1,63)
           │    ├── group-by (hash)
           │    │    ├── columns: ss_item_sk:115!null ss_store_sk:120 sum:168
           │    │    ├── grouping columns: ss_item_sk:115!null ss_store_sk:120
           │    │    ├── key: (115,120)
           │    │    ├── fd: (115,120)-->(168)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: ss_sold_date_sk:113!null ss_item_sk:115!null ss_store_sk:120 ss_sales_price:126 d_date_sk:138!null d_month_seq:141!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: (138)-->(141), (113)==(138), (138)==(113)
           │    │    │    ├── scan store_sales
           │    │    │    │    └── columns: ss_sold_date_sk:113 ss_item_sk:115!null ss_store_sk:120 ss_sales_price:126
           │    │    │    ├── select
           │    │    │    │    ├── columns: d_date_sk:138!null d_month_seq:141!null
           │    │    │    │    ├── key: (138)
           │    │    │    │    ├── fd: (138)-->(141)
           │    │    │    │    ├── scan date_dim
           │    │    │    │    │    ├── columns: d_date_sk:138!null d_month_seq:141
           │    │    │    │    │    ├── key: (138)
           │    │    │    │    │    └── fd: (138)-->(141)
           │    │    │    │    └── filters
           │    │    │    │         └── (d_month_seq:141 >= 1176) AND (d_month_seq:141 <= 1187) [outer=(141), constraints=(/141: [/1176 - /1187]; tight)]
           │    │    │    └── filters
           │    │    │         └── ss_sold_date_sk:113 = d_date_sk:138 [outer=(113,138), constraints=(/113: (/NULL - ]; /138: (/NULL - ]), fd=(113)==(138), (138)==(113)]
           │    │    └── aggregations
           │    │         └── sum [as=sum:168, outer=(126)]
           │    │              └── ss_sales_price:126
           │    ├── inner-join (hash)
           │    │    ├── columns: s_store_sk:1!null s_store_name:6 ss_store_sk:63!null column169:169
           │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
           │    │    ├── immutable
           │    │    ├── key: (63)
           │    │    ├── fd: (1)-->(6), (63)-->(169), (1)==(63), (63)==(1)
           │    │    ├── scan store
           │    │    │    ├── columns: s_store_sk:1!null s_store_name:6
           │    │    │    ├── key: (1)
           │    │    │    └── fd: (1)-->(6)
           │    │    ├── project
           │    │    │    ├── columns: column169:169 ss_store_sk:63
           │    │    │    ├── immutable
           │    │    │    ├── key: (63)
           │    │    │    ├── fd: (63)-->(169)
           │    │    │    ├── group-by (hash)
           │    │    │    │    ├── columns: ss_store_sk:63 avg:112
           │    │    │    │    ├── grouping columns: ss_store_sk:63
           │    │    │    │    ├── key: (63)
           │    │    │    │    ├── fd: (63)-->(112)
           │    │    │    │    ├── group-by (hash)
           │    │    │    │    │    ├── columns: ss_item_sk:58!null ss_store_sk:63 sum:111
           │    │    │    │    │    ├── grouping columns: ss_item_sk:58!null ss_store_sk:63
           │    │    │    │    │    ├── key: (58,63)
           │    │    │    │    │    ├── fd: (58,63)-->(111)
           │    │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    │    ├── columns: ss_sold_date_sk:56!null ss_item_sk:58!null ss_store_sk:63 ss_sales_price:69 d_date_sk:81!null d_month_seq:84!null
           │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    │    ├── fd: (81)-->(84), (56)==(81), (81)==(56)
           │    │    │    │    │    │    ├── scan store_sales
           │    │    │    │    │    │    │    └── columns: ss_sold_date_sk:56 ss_item_sk:58!null ss_store_sk:63 ss_sales_price:69
           │    │    │    │    │    │    ├── select
           │    │    │    │    │    │    │    ├── columns: d_date_sk:81!null d_month_seq:84!null
           │    │    │    │    │    │    │    ├── key: (81)
           │    │    │    │    │    │    │    ├── fd: (81)-->(84)
           │    │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    │    ├── columns: d_date_sk:81!null d_month_seq:84
           │    │    │    │    │    │    │    │    ├── key: (81)
           │    │    │    │    │    │    │    │    └── fd: (81)-->(84)
           │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │         └── (d_month_seq:84 >= 1176) AND (d_month_seq:84 <= 1187) [outer=(84), constraints=(/84: [/1176 - /1187]; tight)]
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── ss_sold_date_sk:56 = d_date_sk:81 [outer=(56,81), constraints=(/56: (/NULL - ]; /81: (/NULL - ]), fd=(56)==(81), (81)==(56)]
           │    │    │    │    │    └── aggregations
           │    │    │    │    │         └── sum [as=sum:111, outer=(69)]
           │    │    │    │    │              └── ss_sales_price:69
           │    │    │    │    └── aggregations
           │    │    │    │         └── avg [as=avg:112, outer=(111)]
           │    │    │    │              └── sum:111
           │    │    │    └── projections
           │    │    │         └── avg:112 * 0.1 [as=column169:169, outer=(112), immutable]
           │    │    └── filters
           │    │         └── s_store_sk:1 = ss_store_sk:63 [outer=(1,63), constraints=(/1: (/NULL - ]; /63: (/NULL - ]), fd=(1)==(63), (63)==(1)]
           │    └── filters
           │         ├── ss_store_sk:63 = ss_store_sk:120 [outer=(63,120), constraints=(/63: (/NULL - ]; /120: (/NULL - ]), fd=(63)==(120), (120)==(63)]
           │         └── column169:169 >= sum:168 [outer=(168,169), immutable, constraints=(/168: (/NULL - ]; /169: (/NULL - ])]
           ├── scan item
           │    ├── columns: i_item_sk:32!null i_item_desc:36 i_current_price:37 i_wholesale_cost:38 i_brand:40
           │    ├── key: (32)
           │    └── fd: (32)-->(36-38,40)
           └── filters
                └── i_item_sk:32 = ss_item_sk:115 [outer=(32,115), constraints=(/32: (/NULL - ]; /115: (/NULL - ]), fd=(32)==(115), (115)==(32)]

# --------------------------------------------------
# Q66
opt
	SELECT
		w_warehouse_name,
		w_warehouse_sq_ft,
		w_city,
		w_county,
		w_state,
		w_country,
		ship_carriers,
		year,
		sum(jan_sales) AS jan_sales,
		sum(feb_sales) AS feb_sales,
		sum(mar_sales) AS mar_sales,
		sum(apr_sales) AS apr_sales,
		sum(may_sales) AS may_sales,
		sum(jun_sales) AS jun_sales,
		sum(jul_sales) AS jul_sales,
		sum(aug_sales) AS aug_sales,
		sum(sep_sales) AS sep_sales,
		sum(oct_sales) AS oct_sales,
		sum(nov_sales) AS nov_sales,
		sum(dec_sales) AS dec_sales,
		sum(jan_sales / w_warehouse_sq_ft)
			AS jan_sales_per_sq_foot,
		sum(feb_sales / w_warehouse_sq_ft)
			AS feb_sales_per_sq_foot,
		sum(mar_sales / w_warehouse_sq_ft)
			AS mar_sales_per_sq_foot,
		sum(apr_sales / w_warehouse_sq_ft)
			AS apr_sales_per_sq_foot,
		sum(may_sales / w_warehouse_sq_ft)
			AS may_sales_per_sq_foot,
		sum(jun_sales / w_warehouse_sq_ft)
			AS jun_sales_per_sq_foot,
		sum(jul_sales / w_warehouse_sq_ft)
			AS jul_sales_per_sq_foot,
		sum(aug_sales / w_warehouse_sq_ft)
			AS aug_sales_per_sq_foot,
		sum(sep_sales / w_warehouse_sq_ft)
			AS sep_sales_per_sq_foot,
		sum(oct_sales / w_warehouse_sq_ft)
			AS oct_sales_per_sq_foot,
		sum(nov_sales / w_warehouse_sq_ft)
			AS nov_sales_per_sq_foot,
		sum(dec_sales / w_warehouse_sq_ft)
			AS dec_sales_per_sq_foot,
		sum(jan_net) AS jan_net,
		sum(feb_net) AS feb_net,
		sum(mar_net) AS mar_net,
		sum(apr_net) AS apr_net,
		sum(may_net) AS may_net,
		sum(jun_net) AS jun_net,
		sum(jul_net) AS jul_net,
		sum(aug_net) AS aug_net,
		sum(sep_net) AS sep_net,
		sum(oct_net) AS oct_net,
		sum(nov_net) AS nov_net,
		sum(dec_net) AS dec_net
	FROM
		(
			SELECT
				w_warehouse_name,
				w_warehouse_sq_ft,
				w_city,
				w_county,
				w_state,
				w_country,
				'ORIENTAL' || ',' || 'BOXBUNDLES'
					AS ship_carriers,
				d_year AS year,
				sum(
					CASE
					WHEN d_moy = 1
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS jan_sales,
				sum(
					CASE
					WHEN d_moy = 2
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS feb_sales,
				sum(
					CASE
					WHEN d_moy = 3
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS mar_sales,
				sum(
					CASE
					WHEN d_moy = 4
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS apr_sales,
				sum(
					CASE
					WHEN d_moy = 5
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS may_sales,
				sum(
					CASE
					WHEN d_moy = 6
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS jun_sales,
				sum(
					CASE
					WHEN d_moy = 7
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS jul_sales,
				sum(
					CASE
					WHEN d_moy = 8
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS aug_sales,
				sum(
					CASE
					WHEN d_moy = 9
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS sep_sales,
				sum(
					CASE
					WHEN d_moy = 10
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS oct_sales,
				sum(
					CASE
					WHEN d_moy = 11
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS nov_sales,
				sum(
					CASE
					WHEN d_moy = 12
					THEN ws_ext_sales_price * ws_quantity
					ELSE 0
					END
				)
					AS dec_sales,
				sum(
					CASE
					WHEN d_moy = 1
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS jan_net,
				sum(
					CASE
					WHEN d_moy = 2
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS feb_net,
				sum(
					CASE
					WHEN d_moy = 3
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS mar_net,
				sum(
					CASE
					WHEN d_moy = 4
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS apr_net,
				sum(
					CASE
					WHEN d_moy = 5
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS may_net,
				sum(
					CASE
					WHEN d_moy = 6
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS jun_net,
				sum(
					CASE
					WHEN d_moy = 7
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS jul_net,
				sum(
					CASE
					WHEN d_moy = 8
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS aug_net,
				sum(
					CASE
					WHEN d_moy = 9
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS sep_net,
				sum(
					CASE
					WHEN d_moy = 10
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS oct_net,
				sum(
					CASE
					WHEN d_moy = 11
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS nov_net,
				sum(
					CASE
					WHEN d_moy = 12
					THEN ws_net_paid_inc_ship * ws_quantity
					ELSE 0
					END
				)
					AS dec_net
			FROM
				web_sales,
				warehouse,
				date_dim,
				time_dim,
				ship_mode
			WHERE
				ws_warehouse_sk = w_warehouse_sk
				AND ws_sold_date_sk = d_date_sk
				AND ws_sold_time_sk = t_time_sk
				AND ws_ship_mode_sk = sm_ship_mode_sk
				AND d_year = 2001
				AND t_time BETWEEN 42970 AND (42970 + 28800)
				AND sm_carrier IN ('ORIENTAL', 'BOXBUNDLES')
			GROUP BY
				w_warehouse_name,
				w_warehouse_sq_ft,
				w_city,
				w_county,
				w_state,
				w_country,
				d_year
			UNION ALL
				SELECT
					w_warehouse_name,
					w_warehouse_sq_ft,
					w_city,
					w_county,
					w_state,
					w_country,
					'ORIENTAL' || ',' || 'BOXBUNDLES'
						AS ship_carriers,
					d_year AS year,
					sum(
						CASE
						WHEN d_moy = 1
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS jan_sales,
					sum(
						CASE
						WHEN d_moy = 2
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS feb_sales,
					sum(
						CASE
						WHEN d_moy = 3
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS mar_sales,
					sum(
						CASE
						WHEN d_moy = 4
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS apr_sales,
					sum(
						CASE
						WHEN d_moy = 5
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS may_sales,
					sum(
						CASE
						WHEN d_moy = 6
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS jun_sales,
					sum(
						CASE
						WHEN d_moy = 7
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS jul_sales,
					sum(
						CASE
						WHEN d_moy = 8
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS aug_sales,
					sum(
						CASE
						WHEN d_moy = 9
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS sep_sales,
					sum(
						CASE
						WHEN d_moy = 10
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS oct_sales,
					sum(
						CASE
						WHEN d_moy = 11
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS nov_sales,
					sum(
						CASE
						WHEN d_moy = 12
						THEN cs_ext_list_price * cs_quantity
						ELSE 0
						END
					)
						AS dec_sales,
					sum(
						CASE
						WHEN d_moy = 1
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS jan_net,
					sum(
						CASE
						WHEN d_moy = 2
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS feb_net,
					sum(
						CASE
						WHEN d_moy = 3
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS mar_net,
					sum(
						CASE
						WHEN d_moy = 4
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS apr_net,
					sum(
						CASE
						WHEN d_moy = 5
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS may_net,
					sum(
						CASE
						WHEN d_moy = 6
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS jun_net,
					sum(
						CASE
						WHEN d_moy = 7
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS jul_net,
					sum(
						CASE
						WHEN d_moy = 8
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS aug_net,
					sum(
						CASE
						WHEN d_moy = 9
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS sep_net,
					sum(
						CASE
						WHEN d_moy = 10
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS oct_net,
					sum(
						CASE
						WHEN d_moy = 11
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS nov_net,
					sum(
						CASE
						WHEN d_moy = 12
						THEN cs_net_paid * cs_quantity
						ELSE 0
						END
					)
						AS dec_net
				FROM
					catalog_sales,
					warehouse,
					date_dim,
					time_dim,
					ship_mode
				WHERE
					cs_warehouse_sk = w_warehouse_sk
					AND cs_sold_date_sk = d_date_sk
					AND cs_sold_time_sk = t_time_sk
					AND cs_ship_mode_sk = sm_ship_mode_sk
					AND d_year = 2001
					AND t_time BETWEEN 42970 AND (42970 + 28800)
					AND sm_carrier IN ('ORIENTAL', 'BOXBUNDLES')
				GROUP BY
					w_warehouse_name,
					w_warehouse_sq_ft,
					w_city,
					w_county,
					w_state,
					w_country,
					d_year
		)
			AS x
	GROUP BY
		w_warehouse_name,
		w_warehouse_sq_ft,
		w_city,
		w_county,
		w_state,
		w_country,
		ship_carriers,
		year
	ORDER BY
		w_warehouse_name
	LIMIT
		100;
----
limit
 ├── columns: w_warehouse_name:303 w_warehouse_sq_ft:304 w_city:305 w_county:306 w_state:307 w_country:308 ship_carriers:309!null year:310!null jan_sales:335 feb_sales:336 mar_sales:337 apr_sales:338 may_sales:339 jun_sales:340 jul_sales:341 aug_sales:342 sep_sales:343 oct_sales:344 nov_sales:345 dec_sales:346 jan_sales_per_sq_foot:348 feb_sales_per_sq_foot:350 mar_sales_per_sq_foot:352 apr_sales_per_sq_foot:354 may_sales_per_sq_foot:356 jun_sales_per_sq_foot:358 jul_sales_per_sq_foot:360 aug_sales_per_sq_foot:362 sep_sales_per_sq_foot:364 oct_sales_per_sq_foot:366 nov_sales_per_sq_foot:368 dec_sales_per_sq_foot:370 jan_net:371 feb_net:372 mar_net:373 apr_net:374 may_net:375 jun_net:376 jul_net:377 aug_net:378 sep_net:379 oct_net:380 nov_net:381 dec_net:382
 ├── internal-ordering: +303
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (303-310)
 ├── fd: (303-310)-->(335-346,348,350,352,354,356,358,360,362,364,366,368,370-382)
 ├── ordering: +303
 ├── group-by (partial streaming)
 │    ├── columns: w_warehouse_name:303 w_warehouse_sq_ft:304 w_city:305 w_county:306 w_state:307 w_country:308 ship_carriers:309!null year:310!null sum:335 sum:336 sum:337 sum:338 sum:339 sum:340 sum:341 sum:342 sum:343 sum:344 sum:345 sum:346 sum:348 sum:350 sum:352 sum:354 sum:356 sum:358 sum:360 sum:362 sum:364 sum:366 sum:368 sum:370 sum:371 sum:372 sum:373 sum:374 sum:375 sum:376 sum:377 sum:378 sum:379 sum:380 sum:381 sum:382
 │    ├── grouping columns: w_warehouse_name:303 w_warehouse_sq_ft:304 w_city:305 w_county:306 w_state:307 w_country:308 ship_carriers:309!null year:310!null
 │    ├── immutable
 │    ├── key: (303-310)
 │    ├── fd: (303-310)-->(335-346,348,350,352,354,356,358,360,362,364,366,368,370-382)
 │    ├── ordering: +303
 │    ├── limit hint: 100.00
 │    ├── project
 │    │    ├── columns: column347:347 column349:349 column351:351 column353:353 column355:355 column357:357 column359:359 column361:361 column363:363 column365:365 column367:367 column369:369 w_warehouse_name:303 w_warehouse_sq_ft:304 w_city:305 w_county:306 w_state:307 w_country:308 ship_carriers:309!null year:310!null jan_sales:311 feb_sales:312 mar_sales:313 apr_sales:314 may_sales:315 jun_sales:316 jul_sales:317 aug_sales:318 sep_sales:319 oct_sales:320 nov_sales:321 dec_sales:322 jan_net:323 feb_net:324 mar_net:325 apr_net:326 may_net:327 jun_net:328 jul_net:329 aug_net:330 sep_net:331 oct_net:332 nov_net:333 dec_net:334
 │    │    ├── immutable
 │    │    ├── fd: (304,311)-->(347), (304,312)-->(349), (304,313)-->(351), (304,314)-->(353), (304,315)-->(355), (304,316)-->(357), (304,317)-->(359), (304,318)-->(361), (304,319)-->(363), (304,320)-->(365), (304,321)-->(367), (304,322)-->(369)
 │    │    ├── ordering: +303
 │    │    ├── union-all
 │    │    │    ├── columns: w_warehouse_name:303 w_warehouse_sq_ft:304 w_city:305 w_county:306 w_state:307 w_country:308 ship_carriers:309!null year:310!null jan_sales:311 feb_sales:312 mar_sales:313 apr_sales:314 may_sales:315 jun_sales:316 jul_sales:317 aug_sales:318 sep_sales:319 oct_sales:320 nov_sales:321 dec_sales:322 jan_net:323 feb_net:324 mar_net:325 apr_net:326 may_net:327 jun_net:328 jul_net:329 aug_net:330 sep_net:331 oct_net:332 nov_net:333 dec_net:334
 │    │    │    ├── left columns: warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 ship_carriers:151 d_year:59 sum:104 sum:106 sum:108 sum:110 sum:112 sum:114 sum:116 sum:118 sum:120 sum:122 sum:124 sum:126 sum:128 sum:130 sum:132 sum:134 sum:136 sum:138 sum:140 sum:142 sum:144 sum:146 sum:148 sum:150
 │    │    │    ├── right columns: warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 ship_carriers:302 d_year:210 sum:255 sum:257 sum:259 sum:261 sum:263 sum:265 sum:267 sum:269 sum:271 sum:273 sum:275 sum:277 sum:279 sum:281 sum:283 sum:285 sum:287 sum:289 sum:291 sum:293 sum:295 sum:297 sum:299 sum:301
 │    │    │    ├── immutable
 │    │    │    ├── ordering: +303
 │    │    │    ├── project
 │    │    │    │    ├── columns: ship_carriers:151!null warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 d_year:59!null sum:104 sum:106 sum:108 sum:110 sum:112 sum:114 sum:116 sum:118 sum:120 sum:122 sum:124 sum:126 sum:128 sum:130 sum:132 sum:134 sum:136 sum:138 sum:140 sum:142 sum:144 sum:146 sum:148 sum:150
 │    │    │    │    ├── immutable
 │    │    │    │    ├── key: (39,40,45-47,49)
 │    │    │    │    ├── fd: ()-->(59,151), (39,40,45-47,49)-->(104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150)
 │    │    │    │    ├── ordering: +39 opt(59,151) [actual: +39]
 │    │    │    │    ├── sort
 │    │    │    │    │    ├── columns: warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 d_year:59!null sum:104 sum:106 sum:108 sum:110 sum:112 sum:114 sum:116 sum:118 sum:120 sum:122 sum:124 sum:126 sum:128 sum:130 sum:132 sum:134 sum:136 sum:138 sum:140 sum:142 sum:144 sum:146 sum:148 sum:150
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── key: (39,40,45-47,49)
 │    │    │    │    │    ├── fd: ()-->(59), (39,40,45-47,49)-->(59,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150)
 │    │    │    │    │    ├── ordering: +39 opt(59) [actual: +39]
 │    │    │    │    │    └── group-by (hash)
 │    │    │    │    │         ├── columns: warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 d_year:59!null sum:104 sum:106 sum:108 sum:110 sum:112 sum:114 sum:116 sum:118 sum:120 sum:122 sum:124 sum:126 sum:128 sum:130 sum:132 sum:134 sum:136 sum:138 sum:140 sum:142 sum:144 sum:146 sum:148 sum:150
 │    │    │    │    │         ├── grouping columns: warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49
 │    │    │    │    │         ├── immutable
 │    │    │    │    │         ├── key: (39,40,45-47,49)
 │    │    │    │    │         ├── fd: ()-->(59), (39,40,45-47,49)-->(59,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150)
 │    │    │    │    │         ├── project
 │    │    │    │    │         │    ├── columns: column103:103 column105:105 column107:107 column109:109 column111:111 column113:113 column115:115 column117:117 column119:119 column121:121 column123:123 column125:125 column127:127 column129:129 column131:131 column133:133 column135:135 column137:137 column139:139 column141:141 column143:143 column145:145 column147:147 column149:149 warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 d_year:59!null
 │    │    │    │    │         │    ├── immutable
 │    │    │    │    │         │    ├── fd: ()-->(59)
 │    │    │    │    │         │    ├── inner-join (hash)
 │    │    │    │    │         │    │    ├── columns: ws_sold_date_sk:1!null ws_sold_time_sk:2!null ws_ship_mode_sk:15!null ws_warehouse_sk:16!null ws_quantity:19 ws_ext_sales_price:24 ws_net_paid_inc_ship:32 w_warehouse_sk:37!null warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49 d_date_sk:53!null d_year:59!null d_moy:61 t_time_sk:83!null t_time:85!null sm_ship_mode_sk:95!null sm_carrier:99!null
 │    │    │    │    │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         │    │    ├── fd: ()-->(59), (37)-->(39,40,45-47,49), (53)-->(61), (83)-->(85), (95)-->(99), (16)==(37), (37)==(16), (1)==(53), (53)==(1), (2)==(83), (83)==(2), (15)==(95), (95)==(15)
 │    │    │    │    │         │    │    ├── inner-join (hash)
 │    │    │    │    │         │    │    │    ├── columns: ws_sold_date_sk:1!null ws_sold_time_sk:2!null ws_ship_mode_sk:15!null ws_warehouse_sk:16 ws_quantity:19 ws_ext_sales_price:24 ws_net_paid_inc_ship:32 d_date_sk:53!null d_year:59!null d_moy:61 t_time_sk:83!null t_time:85!null sm_ship_mode_sk:95!null sm_carrier:99!null
 │    │    │    │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         │    │    │    ├── fd: ()-->(59), (53)-->(61), (83)-->(85), (95)-->(99), (15)==(95), (95)==(15), (2)==(83), (83)==(2), (1)==(53), (53)==(1)
 │    │    │    │    │         │    │    │    ├── inner-join (hash)
 │    │    │    │    │         │    │    │    │    ├── columns: ws_sold_date_sk:1!null ws_sold_time_sk:2 ws_ship_mode_sk:15!null ws_warehouse_sk:16 ws_quantity:19 ws_ext_sales_price:24 ws_net_paid_inc_ship:32 d_date_sk:53!null d_year:59!null d_moy:61 sm_ship_mode_sk:95!null sm_carrier:99!null
 │    │    │    │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         │    │    │    │    ├── fd: ()-->(59), (53)-->(61), (95)-->(99), (15)==(95), (95)==(15), (1)==(53), (53)==(1)
 │    │    │    │    │         │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │         │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_sold_time_sk:2 ws_ship_mode_sk:15!null ws_warehouse_sk:16 ws_quantity:19 ws_ext_sales_price:24 ws_net_paid_inc_ship:32 sm_ship_mode_sk:95!null sm_carrier:99!null
 │    │    │    │    │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         │    │    │    │    │    ├── fd: (95)-->(99), (15)==(95), (95)==(15)
 │    │    │    │    │         │    │    │    │    │    ├── scan web_sales
 │    │    │    │    │         │    │    │    │    │    │    └── columns: ws_sold_date_sk:1 ws_sold_time_sk:2 ws_ship_mode_sk:15 ws_warehouse_sk:16 ws_quantity:19 ws_ext_sales_price:24 ws_net_paid_inc_ship:32
 │    │    │    │    │         │    │    │    │    │    ├── select
 │    │    │    │    │         │    │    │    │    │    │    ├── columns: sm_ship_mode_sk:95!null sm_carrier:99!null
 │    │    │    │    │         │    │    │    │    │    │    ├── key: (95)
 │    │    │    │    │         │    │    │    │    │    │    ├── fd: (95)-->(99)
 │    │    │    │    │         │    │    │    │    │    │    ├── scan ship_mode
 │    │    │    │    │         │    │    │    │    │    │    │    ├── columns: sm_ship_mode_sk:95!null sm_carrier:99
 │    │    │    │    │         │    │    │    │    │    │    │    ├── key: (95)
 │    │    │    │    │         │    │    │    │    │    │    │    └── fd: (95)-->(99)
 │    │    │    │    │         │    │    │    │    │    │    └── filters
 │    │    │    │    │         │    │    │    │    │    │         └── sm_carrier:99 IN ('BOXBUNDLES', 'ORIENTAL') [outer=(99), constraints=(/99: [/'BOXBUNDLES' - /'BOXBUNDLES'] [/'ORIENTAL' - /'ORIENTAL']; tight)]
 │    │    │    │    │         │    │    │    │    │    └── filters
 │    │    │    │    │         │    │    │    │    │         └── ws_ship_mode_sk:15 = sm_ship_mode_sk:95 [outer=(15,95), constraints=(/15: (/NULL - ]; /95: (/NULL - ]), fd=(15)==(95), (95)==(15)]
 │    │    │    │    │         │    │    │    │    ├── select
 │    │    │    │    │         │    │    │    │    │    ├── columns: d_date_sk:53!null d_year:59!null d_moy:61
 │    │    │    │    │         │    │    │    │    │    ├── key: (53)
 │    │    │    │    │         │    │    │    │    │    ├── fd: ()-->(59), (53)-->(61)
 │    │    │    │    │         │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │         │    │    │    │    │    │    ├── columns: d_date_sk:53!null d_year:59 d_moy:61
 │    │    │    │    │         │    │    │    │    │    │    ├── key: (53)
 │    │    │    │    │         │    │    │    │    │    │    └── fd: (53)-->(59,61)
 │    │    │    │    │         │    │    │    │    │    └── filters
 │    │    │    │    │         │    │    │    │    │         └── d_year:59 = 2001 [outer=(59), constraints=(/59: [/2001 - /2001]; tight), fd=()-->(59)]
 │    │    │    │    │         │    │    │    │    └── filters
 │    │    │    │    │         │    │    │    │         └── ws_sold_date_sk:1 = d_date_sk:53 [outer=(1,53), constraints=(/1: (/NULL - ]; /53: (/NULL - ]), fd=(1)==(53), (53)==(1)]
 │    │    │    │    │         │    │    │    ├── select
 │    │    │    │    │         │    │    │    │    ├── columns: t_time_sk:83!null t_time:85!null
 │    │    │    │    │         │    │    │    │    ├── key: (83)
 │    │    │    │    │         │    │    │    │    ├── fd: (83)-->(85)
 │    │    │    │    │         │    │    │    │    ├── scan time_dim
 │    │    │    │    │         │    │    │    │    │    ├── columns: t_time_sk:83!null t_time:85
 │    │    │    │    │         │    │    │    │    │    ├── key: (83)
 │    │    │    │    │         │    │    │    │    │    └── fd: (83)-->(85)
 │    │    │    │    │         │    │    │    │    └── filters
 │    │    │    │    │         │    │    │    │         └── (t_time:85 >= 42970) AND (t_time:85 <= 71770) [outer=(85), constraints=(/85: [/42970 - /71770]; tight)]
 │    │    │    │    │         │    │    │    └── filters
 │    │    │    │    │         │    │    │         └── ws_sold_time_sk:2 = t_time_sk:83 [outer=(2,83), constraints=(/2: (/NULL - ]; /83: (/NULL - ]), fd=(2)==(83), (83)==(2)]
 │    │    │    │    │         │    │    ├── scan warehouse
 │    │    │    │    │         │    │    │    ├── columns: w_warehouse_sk:37!null warehouse.w_warehouse_name:39 warehouse.w_warehouse_sq_ft:40 warehouse.w_city:45 warehouse.w_county:46 warehouse.w_state:47 warehouse.w_country:49
 │    │    │    │    │         │    │    │    ├── key: (37)
 │    │    │    │    │         │    │    │    └── fd: (37)-->(39,40,45-47,49)
 │    │    │    │    │         │    │    └── filters
 │    │    │    │    │         │    │         └── ws_warehouse_sk:16 = w_warehouse_sk:37 [outer=(16,37), constraints=(/16: (/NULL - ]; /37: (/NULL - ]), fd=(16)==(37), (37)==(16)]
 │    │    │    │    │         │    └── projections
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 1 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column103:103, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 2 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column105:105, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 3 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column107:107, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 4 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column109:109, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 5 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column111:111, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 6 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column113:113, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 7 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column115:115, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 8 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column117:117, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 9 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column119:119, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 10 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column121:121, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 11 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column123:123, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 12 THEN ws_ext_sales_price:24 * ws_quantity:19 ELSE 0 END [as=column125:125, outer=(19,24,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 1 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column127:127, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 2 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column129:129, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 3 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column131:131, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 4 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column133:133, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 5 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column135:135, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 6 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column137:137, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 7 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column139:139, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 8 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column141:141, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 9 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column143:143, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 10 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column145:145, outer=(19,32,61), immutable]
 │    │    │    │    │         │         ├── CASE WHEN d_moy:61 = 11 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column147:147, outer=(19,32,61), immutable]
 │    │    │    │    │         │         └── CASE WHEN d_moy:61 = 12 THEN ws_net_paid_inc_ship:32 * ws_quantity:19 ELSE 0 END [as=column149:149, outer=(19,32,61), immutable]
 │    │    │    │    │         └── aggregations
 │    │    │    │    │              ├── sum [as=sum:104, outer=(103)]
 │    │    │    │    │              │    └── column103:103
 │    │    │    │    │              ├── sum [as=sum:106, outer=(105)]
 │    │    │    │    │              │    └── column105:105
 │    │    │    │    │              ├── sum [as=sum:108, outer=(107)]
 │    │    │    │    │              │    └── column107:107
 │    │    │    │    │              ├── sum [as=sum:110, outer=(109)]
 │    │    │    │    │              │    └── column109:109
 │    │    │    │    │              ├── sum [as=sum:112, outer=(111)]
 │    │    │    │    │              │    └── column111:111
 │    │    │    │    │              ├── sum [as=sum:114, outer=(113)]
 │    │    │    │    │              │    └── column113:113
 │    │    │    │    │              ├── sum [as=sum:116, outer=(115)]
 │    │    │    │    │              │    └── column115:115
 │    │    │    │    │              ├── sum [as=sum:118, outer=(117)]
 │    │    │    │    │              │    └── column117:117
 │    │    │    │    │              ├── sum [as=sum:120, outer=(119)]
 │    │    │    │    │              │    └── column119:119
 │    │    │    │    │              ├── sum [as=sum:122, outer=(121)]
 │    │    │    │    │              │    └── column121:121
 │    │    │    │    │              ├── sum [as=sum:124, outer=(123)]
 │    │    │    │    │              │    └── column123:123
 │    │    │    │    │              ├── sum [as=sum:126, outer=(125)]
 │    │    │    │    │              │    └── column125:125
 │    │    │    │    │              ├── sum [as=sum:128, outer=(127)]
 │    │    │    │    │              │    └── column127:127
 │    │    │    │    │              ├── sum [as=sum:130, outer=(129)]
 │    │    │    │    │              │    └── column129:129
 │    │    │    │    │              ├── sum [as=sum:132, outer=(131)]
 │    │    │    │    │              │    └── column131:131
 │    │    │    │    │              ├── sum [as=sum:134, outer=(133)]
 │    │    │    │    │              │    └── column133:133
 │    │    │    │    │              ├── sum [as=sum:136, outer=(135)]
 │    │    │    │    │              │    └── column135:135
 │    │    │    │    │              ├── sum [as=sum:138, outer=(137)]
 │    │    │    │    │              │    └── column137:137
 │    │    │    │    │              ├── sum [as=sum:140, outer=(139)]
 │    │    │    │    │              │    └── column139:139
 │    │    │    │    │              ├── sum [as=sum:142, outer=(141)]
 │    │    │    │    │              │    └── column141:141
 │    │    │    │    │              ├── sum [as=sum:144, outer=(143)]
 │    │    │    │    │              │    └── column143:143
 │    │    │    │    │              ├── sum [as=sum:146, outer=(145)]
 │    │    │    │    │              │    └── column145:145
 │    │    │    │    │              ├── sum [as=sum:148, outer=(147)]
 │    │    │    │    │              │    └── column147:147
 │    │    │    │    │              ├── sum [as=sum:150, outer=(149)]
 │    │    │    │    │              │    └── column149:149
 │    │    │    │    │              └── const-agg [as=d_year:59, outer=(59)]
 │    │    │    │    │                   └── d_year:59
 │    │    │    │    └── projections
 │    │    │    │         └── 'ORIENTAL,BOXBUNDLES' [as=ship_carriers:151]
 │    │    │    └── project
 │    │    │         ├── columns: ship_carriers:302!null warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 d_year:210!null sum:255 sum:257 sum:259 sum:261 sum:263 sum:265 sum:267 sum:269 sum:271 sum:273 sum:275 sum:277 sum:279 sum:281 sum:283 sum:285 sum:287 sum:289 sum:291 sum:293 sum:295 sum:297 sum:299 sum:301
 │    │    │         ├── immutable
 │    │    │         ├── key: (190,191,196-198,200)
 │    │    │         ├── fd: ()-->(210,302), (190,191,196-198,200)-->(255,257,259,261,263,265,267,269,271,273,275,277,279,281,283,285,287,289,291,293,295,297,299,301)
 │    │    │         ├── ordering: +190 opt(210,302) [actual: +190]
 │    │    │         ├── sort
 │    │    │         │    ├── columns: warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 d_year:210!null sum:255 sum:257 sum:259 sum:261 sum:263 sum:265 sum:267 sum:269 sum:271 sum:273 sum:275 sum:277 sum:279 sum:281 sum:283 sum:285 sum:287 sum:289 sum:291 sum:293 sum:295 sum:297 sum:299 sum:301
 │    │    │         │    ├── immutable
 │    │    │         │    ├── key: (190,191,196-198,200)
 │    │    │         │    ├── fd: ()-->(210), (190,191,196-198,200)-->(210,255,257,259,261,263,265,267,269,271,273,275,277,279,281,283,285,287,289,291,293,295,297,299,301)
 │    │    │         │    ├── ordering: +190 opt(210) [actual: +190]
 │    │    │         │    └── group-by (hash)
 │    │    │         │         ├── columns: warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 d_year:210!null sum:255 sum:257 sum:259 sum:261 sum:263 sum:265 sum:267 sum:269 sum:271 sum:273 sum:275 sum:277 sum:279 sum:281 sum:283 sum:285 sum:287 sum:289 sum:291 sum:293 sum:295 sum:297 sum:299 sum:301
 │    │    │         │         ├── grouping columns: warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200
 │    │    │         │         ├── immutable
 │    │    │         │         ├── key: (190,191,196-198,200)
 │    │    │         │         ├── fd: ()-->(210), (190,191,196-198,200)-->(210,255,257,259,261,263,265,267,269,271,273,275,277,279,281,283,285,287,289,291,293,295,297,299,301)
 │    │    │         │         ├── project
 │    │    │         │         │    ├── columns: column254:254 column256:256 column258:258 column260:260 column262:262 column264:264 column266:266 column268:268 column270:270 column272:272 column274:274 column276:276 column278:278 column280:280 column282:282 column284:284 column286:286 column288:288 column290:290 column292:292 column294:294 column296:296 column298:298 column300:300 warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 d_year:210!null
 │    │    │         │         │    ├── immutable
 │    │    │         │         │    ├── fd: ()-->(210)
 │    │    │         │         │    ├── inner-join (hash)
 │    │    │         │         │    │    ├── columns: cs_sold_date_sk:152!null cs_sold_time_sk:153!null cs_ship_mode_sk:165!null cs_warehouse_sk:166!null cs_quantity:170 cs_ext_list_price:177 cs_net_paid:181 w_warehouse_sk:188!null warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200 d_date_sk:204!null d_year:210!null d_moy:212 t_time_sk:234!null t_time:236!null sm_ship_mode_sk:246!null sm_carrier:250!null
 │    │    │         │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │         │    │    ├── fd: ()-->(210), (188)-->(190,191,196-198,200), (204)-->(212), (234)-->(236), (246)-->(250), (166)==(188), (188)==(166), (152)==(204), (204)==(152), (153)==(234), (234)==(153), (165)==(246), (246)==(165)
 │    │    │         │         │    │    ├── inner-join (hash)
 │    │    │         │         │    │    │    ├── columns: cs_sold_date_sk:152!null cs_sold_time_sk:153!null cs_ship_mode_sk:165!null cs_warehouse_sk:166 cs_quantity:170 cs_ext_list_price:177 cs_net_paid:181 d_date_sk:204!null d_year:210!null d_moy:212 t_time_sk:234!null t_time:236!null sm_ship_mode_sk:246!null sm_carrier:250!null
 │    │    │         │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │         │    │    │    ├── fd: ()-->(210), (204)-->(212), (234)-->(236), (246)-->(250), (165)==(246), (246)==(165), (153)==(234), (234)==(153), (152)==(204), (204)==(152)
 │    │    │         │         │    │    │    ├── inner-join (hash)
 │    │    │         │         │    │    │    │    ├── columns: cs_sold_date_sk:152!null cs_sold_time_sk:153 cs_ship_mode_sk:165!null cs_warehouse_sk:166 cs_quantity:170 cs_ext_list_price:177 cs_net_paid:181 d_date_sk:204!null d_year:210!null d_moy:212 sm_ship_mode_sk:246!null sm_carrier:250!null
 │    │    │         │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │         │    │    │    │    ├── fd: ()-->(210), (204)-->(212), (246)-->(250), (165)==(246), (246)==(165), (152)==(204), (204)==(152)
 │    │    │         │         │    │    │    │    ├── inner-join (hash)
 │    │    │         │         │    │    │    │    │    ├── columns: cs_sold_date_sk:152 cs_sold_time_sk:153 cs_ship_mode_sk:165!null cs_warehouse_sk:166 cs_quantity:170 cs_ext_list_price:177 cs_net_paid:181 sm_ship_mode_sk:246!null sm_carrier:250!null
 │    │    │         │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │         │    │    │    │    │    ├── fd: (246)-->(250), (165)==(246), (246)==(165)
 │    │    │         │         │    │    │    │    │    ├── scan catalog_sales
 │    │    │         │         │    │    │    │    │    │    └── columns: cs_sold_date_sk:152 cs_sold_time_sk:153 cs_ship_mode_sk:165 cs_warehouse_sk:166 cs_quantity:170 cs_ext_list_price:177 cs_net_paid:181
 │    │    │         │         │    │    │    │    │    ├── select
 │    │    │         │         │    │    │    │    │    │    ├── columns: sm_ship_mode_sk:246!null sm_carrier:250!null
 │    │    │         │         │    │    │    │    │    │    ├── key: (246)
 │    │    │         │         │    │    │    │    │    │    ├── fd: (246)-->(250)
 │    │    │         │         │    │    │    │    │    │    ├── scan ship_mode
 │    │    │         │         │    │    │    │    │    │    │    ├── columns: sm_ship_mode_sk:246!null sm_carrier:250
 │    │    │         │         │    │    │    │    │    │    │    ├── key: (246)
 │    │    │         │         │    │    │    │    │    │    │    └── fd: (246)-->(250)
 │    │    │         │         │    │    │    │    │    │    └── filters
 │    │    │         │         │    │    │    │    │    │         └── sm_carrier:250 IN ('BOXBUNDLES', 'ORIENTAL') [outer=(250), constraints=(/250: [/'BOXBUNDLES' - /'BOXBUNDLES'] [/'ORIENTAL' - /'ORIENTAL']; tight)]
 │    │    │         │         │    │    │    │    │    └── filters
 │    │    │         │         │    │    │    │    │         └── cs_ship_mode_sk:165 = sm_ship_mode_sk:246 [outer=(165,246), constraints=(/165: (/NULL - ]; /246: (/NULL - ]), fd=(165)==(246), (246)==(165)]
 │    │    │         │         │    │    │    │    ├── select
 │    │    │         │         │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210!null d_moy:212
 │    │    │         │         │    │    │    │    │    ├── key: (204)
 │    │    │         │         │    │    │    │    │    ├── fd: ()-->(210), (204)-->(212)
 │    │    │         │         │    │    │    │    │    ├── scan date_dim
 │    │    │         │         │    │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210 d_moy:212
 │    │    │         │         │    │    │    │    │    │    ├── key: (204)
 │    │    │         │         │    │    │    │    │    │    └── fd: (204)-->(210,212)
 │    │    │         │         │    │    │    │    │    └── filters
 │    │    │         │         │    │    │    │    │         └── d_year:210 = 2001 [outer=(210), constraints=(/210: [/2001 - /2001]; tight), fd=()-->(210)]
 │    │    │         │         │    │    │    │    └── filters
 │    │    │         │         │    │    │    │         └── cs_sold_date_sk:152 = d_date_sk:204 [outer=(152,204), constraints=(/152: (/NULL - ]; /204: (/NULL - ]), fd=(152)==(204), (204)==(152)]
 │    │    │         │         │    │    │    ├── select
 │    │    │         │         │    │    │    │    ├── columns: t_time_sk:234!null t_time:236!null
 │    │    │         │         │    │    │    │    ├── key: (234)
 │    │    │         │         │    │    │    │    ├── fd: (234)-->(236)
 │    │    │         │         │    │    │    │    ├── scan time_dim
 │    │    │         │         │    │    │    │    │    ├── columns: t_time_sk:234!null t_time:236
 │    │    │         │         │    │    │    │    │    ├── key: (234)
 │    │    │         │         │    │    │    │    │    └── fd: (234)-->(236)
 │    │    │         │         │    │    │    │    └── filters
 │    │    │         │         │    │    │    │         └── (t_time:236 >= 42970) AND (t_time:236 <= 71770) [outer=(236), constraints=(/236: [/42970 - /71770]; tight)]
 │    │    │         │         │    │    │    └── filters
 │    │    │         │         │    │    │         └── cs_sold_time_sk:153 = t_time_sk:234 [outer=(153,234), constraints=(/153: (/NULL - ]; /234: (/NULL - ]), fd=(153)==(234), (234)==(153)]
 │    │    │         │         │    │    ├── scan warehouse
 │    │    │         │         │    │    │    ├── columns: w_warehouse_sk:188!null warehouse.w_warehouse_name:190 warehouse.w_warehouse_sq_ft:191 warehouse.w_city:196 warehouse.w_county:197 warehouse.w_state:198 warehouse.w_country:200
 │    │    │         │         │    │    │    ├── key: (188)
 │    │    │         │         │    │    │    └── fd: (188)-->(190,191,196-198,200)
 │    │    │         │         │    │    └── filters
 │    │    │         │         │    │         └── cs_warehouse_sk:166 = w_warehouse_sk:188 [outer=(166,188), constraints=(/166: (/NULL - ]; /188: (/NULL - ]), fd=(166)==(188), (188)==(166)]
 │    │    │         │         │    └── projections
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 1 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column254:254, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 2 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column256:256, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 3 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column258:258, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 4 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column260:260, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 5 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column262:262, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 6 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column264:264, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 7 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column266:266, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 8 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column268:268, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 9 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column270:270, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 10 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column272:272, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 11 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column274:274, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 12 THEN cs_ext_list_price:177 * cs_quantity:170 ELSE 0 END [as=column276:276, outer=(170,177,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 1 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column278:278, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 2 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column280:280, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 3 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column282:282, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 4 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column284:284, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 5 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column286:286, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 6 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column288:288, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 7 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column290:290, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 8 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column292:292, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 9 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column294:294, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 10 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column296:296, outer=(170,181,212), immutable]
 │    │    │         │         │         ├── CASE WHEN d_moy:212 = 11 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column298:298, outer=(170,181,212), immutable]
 │    │    │         │         │         └── CASE WHEN d_moy:212 = 12 THEN cs_net_paid:181 * cs_quantity:170 ELSE 0 END [as=column300:300, outer=(170,181,212), immutable]
 │    │    │         │         └── aggregations
 │    │    │         │              ├── sum [as=sum:255, outer=(254)]
 │    │    │         │              │    └── column254:254
 │    │    │         │              ├── sum [as=sum:257, outer=(256)]
 │    │    │         │              │    └── column256:256
 │    │    │         │              ├── sum [as=sum:259, outer=(258)]
 │    │    │         │              │    └── column258:258
 │    │    │         │              ├── sum [as=sum:261, outer=(260)]
 │    │    │         │              │    └── column260:260
 │    │    │         │              ├── sum [as=sum:263, outer=(262)]
 │    │    │         │              │    └── column262:262
 │    │    │         │              ├── sum [as=sum:265, outer=(264)]
 │    │    │         │              │    └── column264:264
 │    │    │         │              ├── sum [as=sum:267, outer=(266)]
 │    │    │         │              │    └── column266:266
 │    │    │         │              ├── sum [as=sum:269, outer=(268)]
 │    │    │         │              │    └── column268:268
 │    │    │         │              ├── sum [as=sum:271, outer=(270)]
 │    │    │         │              │    └── column270:270
 │    │    │         │              ├── sum [as=sum:273, outer=(272)]
 │    │    │         │              │    └── column272:272
 │    │    │         │              ├── sum [as=sum:275, outer=(274)]
 │    │    │         │              │    └── column274:274
 │    │    │         │              ├── sum [as=sum:277, outer=(276)]
 │    │    │         │              │    └── column276:276
 │    │    │         │              ├── sum [as=sum:279, outer=(278)]
 │    │    │         │              │    └── column278:278
 │    │    │         │              ├── sum [as=sum:281, outer=(280)]
 │    │    │         │              │    └── column280:280
 │    │    │         │              ├── sum [as=sum:283, outer=(282)]
 │    │    │         │              │    └── column282:282
 │    │    │         │              ├── sum [as=sum:285, outer=(284)]
 │    │    │         │              │    └── column284:284
 │    │    │         │              ├── sum [as=sum:287, outer=(286)]
 │    │    │         │              │    └── column286:286
 │    │    │         │              ├── sum [as=sum:289, outer=(288)]
 │    │    │         │              │    └── column288:288
 │    │    │         │              ├── sum [as=sum:291, outer=(290)]
 │    │    │         │              │    └── column290:290
 │    │    │         │              ├── sum [as=sum:293, outer=(292)]
 │    │    │         │              │    └── column292:292
 │    │    │         │              ├── sum [as=sum:295, outer=(294)]
 │    │    │         │              │    └── column294:294
 │    │    │         │              ├── sum [as=sum:297, outer=(296)]
 │    │    │         │              │    └── column296:296
 │    │    │         │              ├── sum [as=sum:299, outer=(298)]
 │    │    │         │              │    └── column298:298
 │    │    │         │              ├── sum [as=sum:301, outer=(300)]
 │    │    │         │              │    └── column300:300
 │    │    │         │              └── const-agg [as=d_year:210, outer=(210)]
 │    │    │         │                   └── d_year:210
 │    │    │         └── projections
 │    │    │              └── 'ORIENTAL,BOXBUNDLES' [as=ship_carriers:302]
 │    │    └── projections
 │    │         ├── jan_sales:311 / w_warehouse_sq_ft:304 [as=column347:347, outer=(304,311), immutable]
 │    │         ├── feb_sales:312 / w_warehouse_sq_ft:304 [as=column349:349, outer=(304,312), immutable]
 │    │         ├── mar_sales:313 / w_warehouse_sq_ft:304 [as=column351:351, outer=(304,313), immutable]
 │    │         ├── apr_sales:314 / w_warehouse_sq_ft:304 [as=column353:353, outer=(304,314), immutable]
 │    │         ├── may_sales:315 / w_warehouse_sq_ft:304 [as=column355:355, outer=(304,315), immutable]
 │    │         ├── jun_sales:316 / w_warehouse_sq_ft:304 [as=column357:357, outer=(304,316), immutable]
 │    │         ├── jul_sales:317 / w_warehouse_sq_ft:304 [as=column359:359, outer=(304,317), immutable]
 │    │         ├── aug_sales:318 / w_warehouse_sq_ft:304 [as=column361:361, outer=(304,318), immutable]
 │    │         ├── sep_sales:319 / w_warehouse_sq_ft:304 [as=column363:363, outer=(304,319), immutable]
 │    │         ├── oct_sales:320 / w_warehouse_sq_ft:304 [as=column365:365, outer=(304,320), immutable]
 │    │         ├── nov_sales:321 / w_warehouse_sq_ft:304 [as=column367:367, outer=(304,321), immutable]
 │    │         └── dec_sales:322 / w_warehouse_sq_ft:304 [as=column369:369, outer=(304,322), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:335, outer=(311)]
 │         │    └── jan_sales:311
 │         ├── sum [as=sum:336, outer=(312)]
 │         │    └── feb_sales:312
 │         ├── sum [as=sum:337, outer=(313)]
 │         │    └── mar_sales:313
 │         ├── sum [as=sum:338, outer=(314)]
 │         │    └── apr_sales:314
 │         ├── sum [as=sum:339, outer=(315)]
 │         │    └── may_sales:315
 │         ├── sum [as=sum:340, outer=(316)]
 │         │    └── jun_sales:316
 │         ├── sum [as=sum:341, outer=(317)]
 │         │    └── jul_sales:317
 │         ├── sum [as=sum:342, outer=(318)]
 │         │    └── aug_sales:318
 │         ├── sum [as=sum:343, outer=(319)]
 │         │    └── sep_sales:319
 │         ├── sum [as=sum:344, outer=(320)]
 │         │    └── oct_sales:320
 │         ├── sum [as=sum:345, outer=(321)]
 │         │    └── nov_sales:321
 │         ├── sum [as=sum:346, outer=(322)]
 │         │    └── dec_sales:322
 │         ├── sum [as=sum:348, outer=(347)]
 │         │    └── column347:347
 │         ├── sum [as=sum:350, outer=(349)]
 │         │    └── column349:349
 │         ├── sum [as=sum:352, outer=(351)]
 │         │    └── column351:351
 │         ├── sum [as=sum:354, outer=(353)]
 │         │    └── column353:353
 │         ├── sum [as=sum:356, outer=(355)]
 │         │    └── column355:355
 │         ├── sum [as=sum:358, outer=(357)]
 │         │    └── column357:357
 │         ├── sum [as=sum:360, outer=(359)]
 │         │    └── column359:359
 │         ├── sum [as=sum:362, outer=(361)]
 │         │    └── column361:361
 │         ├── sum [as=sum:364, outer=(363)]
 │         │    └── column363:363
 │         ├── sum [as=sum:366, outer=(365)]
 │         │    └── column365:365
 │         ├── sum [as=sum:368, outer=(367)]
 │         │    └── column367:367
 │         ├── sum [as=sum:370, outer=(369)]
 │         │    └── column369:369
 │         ├── sum [as=sum:371, outer=(323)]
 │         │    └── jan_net:323
 │         ├── sum [as=sum:372, outer=(324)]
 │         │    └── feb_net:324
 │         ├── sum [as=sum:373, outer=(325)]
 │         │    └── mar_net:325
 │         ├── sum [as=sum:374, outer=(326)]
 │         │    └── apr_net:326
 │         ├── sum [as=sum:375, outer=(327)]
 │         │    └── may_net:327
 │         ├── sum [as=sum:376, outer=(328)]
 │         │    └── jun_net:328
 │         ├── sum [as=sum:377, outer=(329)]
 │         │    └── jul_net:329
 │         ├── sum [as=sum:378, outer=(330)]
 │         │    └── aug_net:330
 │         ├── sum [as=sum:379, outer=(331)]
 │         │    └── sep_net:331
 │         ├── sum [as=sum:380, outer=(332)]
 │         │    └── oct_net:332
 │         ├── sum [as=sum:381, outer=(333)]
 │         │    └── nov_net:333
 │         └── sum [as=sum:382, outer=(334)]
 │              └── dec_net:334
 └── 100

# --------------------------------------------------
# Q67
# TODO: adjust the query to work with CRDB.
# opt
# 	SELECT
# 		*
# 	FROM
# 		(
# 			SELECT
# 				i_category,
# 				i_class,
# 				i_brand,
# 				i_product_name,
# 				d_year,
# 				d_qoy,
# 				d_moy,
# 				s_store_id,
# 				sumsales,
# 				rank() OVER (
# 					PARTITION BY
# 						i_category
# 					ORDER BY
# 						sumsales DESC
# 				)
# 					AS rk
# 			FROM
# 				(
# 					SELECT
# 						i_category,
# 						i_class,
# 						i_brand,
# 						i_product_name,
# 						d_year,
# 						d_qoy,
# 						d_moy,
# 						s_store_id,
# 						sum(
# 							COALESCE(
# 								ss_sales_price * ss_quantity,
# 								0
# 							)
# 						)
# 							AS sumsales
# 					FROM
# 						store_sales, date_dim, store, item
# 					WHERE
# 						ss_sold_date_sk = d_date_sk
# 						AND ss_item_sk = i_item_sk
# 						AND ss_store_sk = s_store_sk
# 						AND d_month_seq BETWEEN 1217 AND (1217 + 11)
# 					GROUP BY
# 						rollup(
# 							i_category,
# 							i_class,
# 							i_brand,
# 							i_product_name,
# 							d_year,
# 							d_qoy,
# 							d_moy,
# 							s_store_id
# 						)
# 				)
# 					AS dw1
# 		)
# 			AS dw2
# 	WHERE
# 		rk <= 100
# 	ORDER BY
# 		i_category,
# 		i_class,
# 		i_brand,
# 		i_product_name,
# 		d_year,
# 		d_qoy,
# 		d_moy,
# 		s_store_id,
# 		sumsales,
# 		rk
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q68
opt
	SELECT
		c_last_name,
		c_first_name,
		ca_city,
		bought_city,
		ss_ticket_number,
		extended_price,
		extended_tax,
		list_price
	FROM
		(
			SELECT
				ss_ticket_number,
				ss_customer_sk,
				ca_city AS bought_city,
				sum(ss_ext_sales_price) AS extended_price,
				sum(ss_ext_list_price) AS list_price,
				sum(ss_ext_tax) AS extended_tax
			FROM
				store_sales,
				date_dim,
				store,
				household_demographics,
				customer_address
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_store_sk = store.s_store_sk
				AND store_sales.ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND store_sales.ss_addr_sk
					= customer_address.ca_address_sk
				AND date_dim.d_dom BETWEEN 1 AND 2
				AND (
						household_demographics.hd_dep_count = 3
						OR household_demographics.hd_vehicle_count
							= 4
					)
				AND date_dim.d_year
					IN (1998, 1998 + 1, 1998 + 2)
				AND store.s_city IN ('Fairview', 'Midway')
			GROUP BY
				ss_ticket_number,
				ss_customer_sk,
				ss_addr_sk,
				ca_city
		)
			AS dn,
		customer,
		customer_address AS current_addr
	WHERE
		ss_customer_sk = c_customer_sk
		AND customer.c_current_addr_sk
			= current_addr.ca_address_sk
		AND current_addr.ca_city != bought_city
	ORDER BY
		c_last_name, ss_ticket_number
	LIMIT
		100;
----
project
 ├── columns: c_last_name:121 c_first_name:120 ca_city:138!null bought_city:100!null ss_ticket_number:10!null extended_price:109 extended_tax:111 list_price:110
 ├── cardinality: [0 - 100]
 ├── ordering: +121,+10
 └── limit
      ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100!null sum:109 sum:110 sum:111 c_customer_sk:112!null c_current_addr_sk:116!null c_first_name:120 c_last_name:121 current_addr.ca_address_sk:132!null current_addr.ca_city:138!null
      ├── internal-ordering: +121,+10
      ├── cardinality: [0 - 100]
      ├── key: (7,10,112)
      ├── fd: (7)-->(100), (4,7,10)-->(100,109-111), (112)-->(116,120,121), (132)-->(138), (116)==(132), (132)==(116), (4)==(112), (112)==(4)
      ├── ordering: +121,+10
      ├── inner-join (lookup customer_address [as=current_addr])
      │    ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100!null sum:109 sum:110 sum:111 c_customer_sk:112!null c_current_addr_sk:116!null c_first_name:120 c_last_name:121 current_addr.ca_address_sk:132!null current_addr.ca_city:138!null
      │    ├── key columns: [116] = [132]
      │    ├── lookup columns are key
      │    ├── key: (7,10,112)
      │    ├── fd: (7)-->(100), (4,7,10)-->(100,109-111), (112)-->(116,120,121), (132)-->(138), (116)==(132), (132)==(116), (4)==(112), (112)==(4)
      │    ├── ordering: +121,+10
      │    ├── limit hint: 100.00
      │    ├── sort
      │    │    ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100 sum:109 sum:110 sum:111 c_customer_sk:112!null c_current_addr_sk:116 c_first_name:120 c_last_name:121
      │    │    ├── key: (7,10,112)
      │    │    ├── fd: (7)-->(100), (4,7,10)-->(100,109-111), (112)-->(116,120,121), (4)==(112), (112)==(4)
      │    │    ├── ordering: +121,+10
      │    │    ├── limit hint: 200.00
      │    │    └── inner-join (hash)
      │    │         ├── columns: ss_customer_sk:4!null ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100 sum:109 sum:110 sum:111 c_customer_sk:112!null c_current_addr_sk:116 c_first_name:120 c_last_name:121
      │    │         ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │         ├── key: (7,10,112)
      │    │         ├── fd: (7)-->(100), (4,7,10)-->(100,109-111), (112)-->(116,120,121), (4)==(112), (112)==(4)
      │    │         ├── scan customer
      │    │         │    ├── columns: c_customer_sk:112!null c_current_addr_sk:116 c_first_name:120 c_last_name:121
      │    │         │    ├── key: (112)
      │    │         │    └── fd: (112)-->(116,120,121)
      │    │         ├── group-by (hash)
      │    │         │    ├── columns: ss_customer_sk:4 ss_addr_sk:7!null ss_ticket_number:10!null customer_address.ca_city:100 sum:109 sum:110 sum:111
      │    │         │    ├── grouping columns: ss_customer_sk:4 ss_addr_sk:7!null ss_ticket_number:10!null
      │    │         │    ├── key: (4,7,10)
      │    │         │    ├── fd: (7)-->(100), (4,7,10)-->(100,109-111)
      │    │         │    ├── inner-join (hash)
      │    │         │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7!null ss_store_sk:8!null ss_ticket_number:10!null ss_ext_sales_price:16 ss_ext_list_price:18 ss_ext_tax:19 d_date_sk:26!null d_year:32!null d_dom:35!null s_store_sk:56!null s_city:78!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91 customer_address.ca_address_sk:94!null customer_address.ca_city:100
      │    │         │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │    │         │    │    ├── fd: (26)-->(32,35), (56)-->(78), (87)-->(90,91), (94)-->(100), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6), (7)==(94), (94)==(7)
      │    │         │    │    ├── scan customer_address
      │    │         │    │    │    ├── columns: customer_address.ca_address_sk:94!null customer_address.ca_city:100
      │    │         │    │    │    ├── key: (94)
      │    │         │    │    │    └── fd: (94)-->(100)
      │    │         │    │    ├── inner-join (hash)
      │    │         │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8!null ss_ticket_number:10!null ss_ext_sales_price:16 ss_ext_list_price:18 ss_ext_tax:19 d_date_sk:26!null d_year:32!null d_dom:35!null s_store_sk:56!null s_city:78!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    ├── fd: (26)-->(32,35), (56)-->(78), (87)-->(90,91), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6)
      │    │         │    │    │    ├── inner-join (hash)
      │    │         │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_ext_sales_price:16 ss_ext_list_price:18 ss_ext_tax:19 d_date_sk:26!null d_year:32!null d_dom:35!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    │    ├── fd: (26)-->(32,35), (87)-->(90,91), (6)==(87), (87)==(6), (1)==(26), (26)==(1)
      │    │         │    │    │    │    ├── inner-join (hash)
      │    │         │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_ext_sales_price:16 ss_ext_list_price:18 ss_ext_tax:19 d_date_sk:26!null d_year:32!null d_dom:35!null
      │    │         │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │         │    │    │    │    │    ├── fd: (26)-->(32,35), (1)==(26), (26)==(1)
      │    │         │    │    │    │    │    ├── scan store_sales
      │    │         │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_ext_sales_price:16 ss_ext_list_price:18 ss_ext_tax:19
      │    │         │    │    │    │    │    ├── select
      │    │         │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_dom:35!null
      │    │         │    │    │    │    │    │    ├── key: (26)
      │    │         │    │    │    │    │    │    ├── fd: (26)-->(32,35)
      │    │         │    │    │    │    │    │    ├── scan date_dim
      │    │         │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_dom:35
      │    │         │    │    │    │    │    │    │    ├── key: (26)
      │    │         │    │    │    │    │    │    │    └── fd: (26)-->(32,35)
      │    │         │    │    │    │    │    │    └── filters
      │    │         │    │    │    │    │    │         ├── (d_dom:35 >= 1) AND (d_dom:35 <= 2) [outer=(35), constraints=(/35: [/1 - /2]; tight)]
      │    │         │    │    │    │    │    │         └── d_year:32 IN (1998, 1999, 2000) [outer=(32), constraints=(/32: [/1998 - /1998] [/1999 - /1999] [/2000 - /2000]; tight)]
      │    │         │    │    │    │    │    └── filters
      │    │         │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    │         │    │    │    │    ├── select
      │    │         │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │         │    │    │    │    │    ├── key: (87)
      │    │         │    │    │    │    │    ├── fd: (87)-->(90,91)
      │    │         │    │    │    │    │    ├── scan household_demographics
      │    │         │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │         │    │    │    │    │    │    ├── key: (87)
      │    │         │    │    │    │    │    │    └── fd: (87)-->(90,91)
      │    │         │    │    │    │    │    └── filters
      │    │         │    │    │    │    │         └── (hd_dep_count:90 = 3) OR (hd_vehicle_count:91 = 4) [outer=(90,91)]
      │    │         │    │    │    │    └── filters
      │    │         │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:87 [outer=(6,87), constraints=(/6: (/NULL - ]; /87: (/NULL - ]), fd=(6)==(87), (87)==(6)]
      │    │         │    │    │    ├── select
      │    │         │    │    │    │    ├── columns: s_store_sk:56!null s_city:78!null
      │    │         │    │    │    │    ├── key: (56)
      │    │         │    │    │    │    ├── fd: (56)-->(78)
      │    │         │    │    │    │    ├── scan store
      │    │         │    │    │    │    │    ├── columns: s_store_sk:56!null s_city:78
      │    │         │    │    │    │    │    ├── key: (56)
      │    │         │    │    │    │    │    └── fd: (56)-->(78)
      │    │         │    │    │    │    └── filters
      │    │         │    │    │    │         └── s_city:78 IN ('Fairview', 'Midway') [outer=(78), constraints=(/78: [/'Fairview' - /'Fairview'] [/'Midway' - /'Midway']; tight)]
      │    │         │    │    │    └── filters
      │    │         │    │    │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
      │    │         │    │    └── filters
      │    │         │    │         └── ss_addr_sk:7 = customer_address.ca_address_sk:94 [outer=(7,94), constraints=(/7: (/NULL - ]; /94: (/NULL - ]), fd=(7)==(94), (94)==(7)]
      │    │         │    └── aggregations
      │    │         │         ├── sum [as=sum:109, outer=(16)]
      │    │         │         │    └── ss_ext_sales_price:16
      │    │         │         ├── sum [as=sum:110, outer=(18)]
      │    │         │         │    └── ss_ext_list_price:18
      │    │         │         ├── sum [as=sum:111, outer=(19)]
      │    │         │         │    └── ss_ext_tax:19
      │    │         │         └── const-agg [as=customer_address.ca_city:100, outer=(100)]
      │    │         │              └── customer_address.ca_city:100
      │    │         └── filters
      │    │              └── ss_customer_sk:4 = c_customer_sk:112 [outer=(4,112), constraints=(/4: (/NULL - ]; /112: (/NULL - ]), fd=(4)==(112), (112)==(4)]
      │    └── filters
      │         └── current_addr.ca_city:138 != customer_address.ca_city:100 [outer=(100,138), constraints=(/100: (/NULL - ]; /138: (/NULL - ])]
      └── 100

# --------------------------------------------------
# Q69
opt
	SELECT
		cd_gender,
		cd_marital_status,
		cd_education_status,
		count(*) AS cnt1,
		cd_purchase_estimate,
		count(*) AS cnt2,
		cd_credit_rating,
		count(*) AS cnt3
	FROM
		customer AS c,
		customer_address AS ca,
		customer_demographics
	WHERE
		c.c_current_addr_sk = ca.ca_address_sk
		AND ca_state IN ('IL', 'TX', 'ME')
		AND cd_demo_sk = c.c_current_cdemo_sk
		AND EXISTS(
				SELECT
					*
				FROM
					store_sales, date_dim
				WHERE
					c.c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year = 2002
					AND d_moy BETWEEN 1 AND (1 + 2)
			)
		AND (
				NOT
					EXISTS(
						SELECT
							*
						FROM
							web_sales, date_dim
						WHERE
							c.c_customer_sk
							= ws_bill_customer_sk
							AND ws_sold_date_sk = d_date_sk
							AND d_year = 2002
							AND d_moy BETWEEN 1 AND (1 + 2)
					)
				AND NOT
						EXISTS(
							SELECT
								*
							FROM
								catalog_sales, date_dim
							WHERE
								c.c_customer_sk
								= cs_ship_customer_sk
								AND cs_sold_date_sk = d_date_sk
								AND d_year = 2002
								AND d_moy BETWEEN 1 AND (1 + 2)
						)
			)
	GROUP BY
		cd_gender,
		cd_marital_status,
		cd_education_status,
		cd_purchase_estimate,
		cd_credit_rating
	ORDER BY
		cd_gender,
		cd_marital_status,
		cd_education_status,
		cd_purchase_estimate,
		cd_credit_rating
	LIMIT
		100;
----
top-k
 ├── columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cnt1:237!null cd_purchase_estimate:40 cnt2:237!null cd_credit_rating:41 cnt3:237!null
 ├── internal-ordering: +37,+38,+39,+40,+41
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (37-41)
 ├── fd: (37-41)-->(237)
 ├── ordering: +37,+38,+39,+40,+41
 └── group-by (hash)
      ├── columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41 count_rows:237!null
      ├── grouping columns: cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41
      ├── key: (37-41)
      ├── fd: (37-41)-->(237)
      ├── semi-join (hash)
      │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3!null c_current_addr_sk:5!null ca_address_sk:21!null ca_state:29!null cd_demo_sk:36!null cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41
      │    ├── key: (1)
      │    ├── fd: (1)-->(3,5), (21)-->(29), (36)-->(37-41), (5)==(21), (21)==(5), (3)==(36), (36)==(3)
      │    ├── inner-join (lookup customer_address [as=ca])
      │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3!null c_current_addr_sk:5!null ca_address_sk:21!null ca_state:29!null cd_demo_sk:36!null cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41
      │    │    ├── key columns: [5] = [21]
      │    │    ├── lookup columns are key
      │    │    ├── key: (1)
      │    │    ├── fd: (21)-->(29), (1)-->(3,5), (36)-->(37-41), (3)==(36), (36)==(3), (5)==(21), (21)==(5)
      │    │    ├── inner-join (lookup customer_demographics)
      │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3!null c_current_addr_sk:5 cd_demo_sk:36!null cd_gender:37 cd_marital_status:38 cd_education_status:39 cd_purchase_estimate:40 cd_credit_rating:41
      │    │    │    ├── key columns: [3] = [36]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(3,5), (36)-->(37-41), (3)==(36), (36)==(3)
      │    │    │    ├── anti-join (hash)
      │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │    ├── key: (1)
      │    │    │    │    ├── fd: (1)-->(3,5)
      │    │    │    │    ├── anti-join (hash)
      │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    ├── fd: (1)-->(3,5)
      │    │    │    │    │    ├── scan customer [as=c]
      │    │    │    │    │    │    ├── columns: c_customer_sk:1!null c_current_cdemo_sk:3 c_current_addr_sk:5
      │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    └── fd: (1)-->(3,5)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: ws_sold_date_sk:102!null ws_bill_customer_sk:106 d_date_sk:138!null d_year:144!null d_moy:146!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(146), (102)==(138), (138)==(102)
      │    │    │    │    │    │    ├── scan web_sales
      │    │    │    │    │    │    │    └── columns: ws_sold_date_sk:102 ws_bill_customer_sk:106
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144!null d_moy:146!null
      │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │    │    │    │    ├── fd: ()-->(144), (138)-->(146)
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:138!null d_year:144 d_moy:146
      │    │    │    │    │    │    │    │    ├── key: (138)
      │    │    │    │    │    │    │    │    └── fd: (138)-->(144,146)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         ├── (d_moy:146 >= 1) AND (d_moy:146 <= 3) [outer=(146), constraints=(/146: [/1 - /3]; tight)]
      │    │    │    │    │    │    │         └── d_year:144 = 2002 [outer=(144), constraints=(/144: [/2002 - /2002]; tight), fd=()-->(144)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ws_sold_date_sk:102 = d_date_sk:138 [outer=(102,138), constraints=(/102: (/NULL - ]; /138: (/NULL - ]), fd=(102)==(138), (138)==(102)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── c_customer_sk:1 = ws_bill_customer_sk:106 [outer=(1,106), constraints=(/1: (/NULL - ]; /106: (/NULL - ]), fd=(1)==(106), (106)==(1)]
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: cs_sold_date_sk:168!null cs_ship_customer_sk:175 d_date_sk:204!null d_year:210!null d_moy:212!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: ()-->(210), (204)-->(212), (168)==(204), (204)==(168)
      │    │    │    │    │    ├── scan catalog_sales
      │    │    │    │    │    │    └── columns: cs_sold_date_sk:168 cs_ship_customer_sk:175
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210!null d_moy:212!null
      │    │    │    │    │    │    ├── key: (204)
      │    │    │    │    │    │    ├── fd: ()-->(210), (204)-->(212)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:204!null d_year:210 d_moy:212
      │    │    │    │    │    │    │    ├── key: (204)
      │    │    │    │    │    │    │    └── fd: (204)-->(210,212)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         ├── (d_moy:212 >= 1) AND (d_moy:212 <= 3) [outer=(212), constraints=(/212: [/1 - /3]; tight)]
      │    │    │    │    │    │         └── d_year:210 = 2002 [outer=(210), constraints=(/210: [/2002 - /2002]; tight), fd=()-->(210)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── cs_sold_date_sk:168 = d_date_sk:204 [outer=(168,204), constraints=(/168: (/NULL - ]; /204: (/NULL - ]), fd=(168)==(204), (204)==(168)]
      │    │    │    │    └── filters
      │    │    │    │         └── c_customer_sk:1 = cs_ship_customer_sk:175 [outer=(1,175), constraints=(/1: (/NULL - ]; /175: (/NULL - ]), fd=(1)==(175), (175)==(1)]
      │    │    │    └── filters (true)
      │    │    └── filters
      │    │         └── ca_state:29 IN ('IL', 'ME', 'TX') [outer=(29), constraints=(/29: [/'IL' - /'IL'] [/'ME' - /'ME'] [/'TX' - /'TX']; tight)]
      │    ├── inner-join (hash)
      │    │    ├── columns: ss_sold_date_sk:47!null ss_customer_sk:50 d_date_sk:72!null d_year:78!null d_moy:80!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(78), (72)-->(80), (47)==(72), (72)==(47)
      │    │    ├── scan store_sales
      │    │    │    └── columns: ss_sold_date_sk:47 ss_customer_sk:50
      │    │    ├── select
      │    │    │    ├── columns: d_date_sk:72!null d_year:78!null d_moy:80!null
      │    │    │    ├── key: (72)
      │    │    │    ├── fd: ()-->(78), (72)-->(80)
      │    │    │    ├── scan date_dim
      │    │    │    │    ├── columns: d_date_sk:72!null d_year:78 d_moy:80
      │    │    │    │    ├── key: (72)
      │    │    │    │    └── fd: (72)-->(78,80)
      │    │    │    └── filters
      │    │    │         ├── (d_moy:80 >= 1) AND (d_moy:80 <= 3) [outer=(80), constraints=(/80: [/1 - /3]; tight)]
      │    │    │         └── d_year:78 = 2002 [outer=(78), constraints=(/78: [/2002 - /2002]; tight), fd=()-->(78)]
      │    │    └── filters
      │    │         └── ss_sold_date_sk:47 = d_date_sk:72 [outer=(47,72), constraints=(/47: (/NULL - ]; /72: (/NULL - ]), fd=(47)==(72), (72)==(47)]
      │    └── filters
      │         └── c_customer_sk:1 = ss_customer_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
      └── aggregations
           └── count-rows [as=count_rows:237]

# --------------------------------------------------
# Q70
# TODO: adjust the query to work with CRDB.
# opt
# select  
#     sum(ss_net_profit) as total_sum
#    ,s_state
#    ,s_county
#    ,grouping(s_state)+grouping(s_county) as lochierarchy
#    ,rank() over (
#  	partition by grouping(s_state)+grouping(s_county),
#  	case when grouping(s_county) = 0 then s_state end 
#  	order by sum(ss_net_profit) desc) as rank_within_parent
#  from
#     store_sales
#    ,date_dim       d1
#    ,store
#  where
#     d1.d_month_seq between 1220 and 1220+11
#  and d1.d_date_sk = ss_sold_date_sk
#  and s_store_sk  = ss_store_sk
#  and s_state in
#              ( select s_state
#                from  (select s_state as s_state,
#  			    rank() over ( partition by s_state order by sum(ss_net_profit) desc) as ranking
#                       from   store_sales, store, date_dim
#                       where  d_month_seq between 1220 and 1220+11
#  			    and d_date_sk = ss_sold_date_sk
#  			    and s_store_sk  = ss_store_sk
#                       group by s_state
#                      ) tmp1 
#                where ranking <= 5
#              )
#  group by rollup(s_state,s_county)
#  order by
#    lochierarchy desc
#   ,case when lochierarchy = 0 then s_state end
#   ,rank_within_parent
#  limit 100;
# ----

# --------------------------------------------------
# Q71
# NOTE: this query has been modified by appending two extra columns to
# ORDER BY clause so that it had deterministic output.
opt
	SELECT
		i_brand_id AS brand_id,
		i_brand AS brand,
		t_hour,
		t_minute,
		sum(ext_price) AS ext_price
	FROM
		item,
		(
			SELECT
				ws_ext_sales_price AS ext_price,
				ws_sold_date_sk AS sold_date_sk,
				ws_item_sk AS sold_item_sk,
				ws_sold_time_sk AS time_sk
			FROM
				web_sales, date_dim
			WHERE
				d_date_sk = ws_sold_date_sk
				AND d_moy = 12
				AND d_year = 2002
			UNION ALL
				SELECT
					cs_ext_sales_price AS ext_price,
					cs_sold_date_sk AS sold_date_sk,
					cs_item_sk AS sold_item_sk,
					cs_sold_time_sk AS time_sk
				FROM
					catalog_sales, date_dim
				WHERE
					d_date_sk = cs_sold_date_sk
					AND d_moy = 12
					AND d_year = 2002
			UNION ALL
				SELECT
					ss_ext_sales_price AS ext_price,
					ss_sold_date_sk AS sold_date_sk,
					ss_item_sk AS sold_item_sk,
					ss_sold_time_sk AS time_sk
				FROM
					store_sales, date_dim
				WHERE
					d_date_sk = ss_sold_date_sk
					AND d_moy = 12
					AND d_year = 2002
		)
			AS tmp,
		time_dim
	WHERE
		sold_item_sk = i_item_sk
		AND i_manager_id = 1
		AND time_sk = t_time_sk
		AND (
				t_meal_time = 'breakfast'
				OR t_meal_time = 'dinner'
			)
	GROUP BY
		i_brand, i_brand_id, t_hour, t_minute
	ORDER BY
		ext_price DESC, i_brand_id, t_hour, t_minute;
----
sort
 ├── columns: brand_id:8 brand:9 t_hour:223 t_minute:224 ext_price:232
 ├── key: (8,9,223,224)
 ├── fd: (8,9,223,224)-->(232)
 ├── ordering: -232,+8,+223,+224
 └── group-by (hash)
      ├── columns: i_brand_id:8 i_brand:9 t_hour:223 t_minute:224 sum:232
      ├── grouping columns: i_brand_id:8 i_brand:9 t_hour:223 t_minute:224
      ├── key: (8,9,223,224)
      ├── fd: (8,9,223,224)-->(232)
      ├── inner-join (lookup time_dim)
      │    ├── columns: i_item_sk:1!null i_brand_id:8 i_brand:9 i_manager_id:21!null ext_price:216 sold_item_sk:218!null time_sk:219!null t_time_sk:220!null t_hour:223 t_minute:224 t_meal_time:229!null
      │    ├── key columns: [219] = [220]
      │    ├── lookup columns are key
      │    ├── fd: ()-->(21), (1)-->(8,9), (220)-->(223,224,229), (219)==(220), (220)==(219), (1)==(218), (218)==(1)
      │    ├── inner-join (hash)
      │    │    ├── columns: i_item_sk:1!null i_brand_id:8 i_brand:9 i_manager_id:21!null ext_price:216 sold_item_sk:218!null time_sk:219
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: ()-->(21), (1)-->(8,9), (1)==(218), (218)==(1)
      │    │    ├── union-all
      │    │    │    ├── columns: ext_price:216 sold_item_sk:218!null time_sk:219
      │    │    │    ├── left columns: ext_price:157 sold_item_sk:159 time_sk:160
      │    │    │    ├── right columns: ss_ext_sales_price:176 ss_item_sk:163 ss_sold_time_sk:162
      │    │    │    ├── union-all
      │    │    │    │    ├── columns: ext_price:157 sold_item_sk:159!null time_sk:160
      │    │    │    │    ├── left columns: ws_ext_sales_price:48 ws_item_sk:28 ws_sold_time_sk:26
      │    │    │    │    ├── right columns: cs_ext_sales_price:114 cs_item_sk:106 cs_sold_time_sk:92
      │    │    │    │    ├── project
      │    │    │    │    │    ├── columns: ws_sold_time_sk:26 ws_item_sk:28!null ws_ext_sales_price:48
      │    │    │    │    │    └── inner-join (hash)
      │    │    │    │    │         ├── columns: ws_sold_date_sk:25!null ws_sold_time_sk:26 ws_item_sk:28!null ws_ext_sales_price:48 d_date_sk:61!null d_year:67!null d_moy:69!null
      │    │    │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │         ├── fd: ()-->(67,69), (25)==(61), (61)==(25)
      │    │    │    │    │         ├── scan web_sales
      │    │    │    │    │         │    └── columns: ws_sold_date_sk:25 ws_sold_time_sk:26 ws_item_sk:28!null ws_ext_sales_price:48
      │    │    │    │    │         ├── select
      │    │    │    │    │         │    ├── columns: d_date_sk:61!null d_year:67!null d_moy:69!null
      │    │    │    │    │         │    ├── key: (61)
      │    │    │    │    │         │    ├── fd: ()-->(67,69)
      │    │    │    │    │         │    ├── scan date_dim
      │    │    │    │    │         │    │    ├── columns: d_date_sk:61!null d_year:67 d_moy:69
      │    │    │    │    │         │    │    ├── key: (61)
      │    │    │    │    │         │    │    └── fd: (61)-->(67,69)
      │    │    │    │    │         │    └── filters
      │    │    │    │    │         │         ├── d_moy:69 = 12 [outer=(69), constraints=(/69: [/12 - /12]; tight), fd=()-->(69)]
      │    │    │    │    │         │         └── d_year:67 = 2002 [outer=(67), constraints=(/67: [/2002 - /2002]; tight), fd=()-->(67)]
      │    │    │    │    │         └── filters
      │    │    │    │    │              └── d_date_sk:61 = ws_sold_date_sk:25 [outer=(25,61), constraints=(/25: (/NULL - ]; /61: (/NULL - ]), fd=(25)==(61), (61)==(25)]
      │    │    │    │    └── project
      │    │    │    │         ├── columns: cs_sold_time_sk:92 cs_item_sk:106!null cs_ext_sales_price:114
      │    │    │    │         └── inner-join (hash)
      │    │    │    │              ├── columns: cs_sold_date_sk:91!null cs_sold_time_sk:92 cs_item_sk:106!null cs_ext_sales_price:114 d_date_sk:127!null d_year:133!null d_moy:135!null
      │    │    │    │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │              ├── fd: ()-->(133,135), (91)==(127), (127)==(91)
      │    │    │    │              ├── scan catalog_sales
      │    │    │    │              │    └── columns: cs_sold_date_sk:91 cs_sold_time_sk:92 cs_item_sk:106!null cs_ext_sales_price:114
      │    │    │    │              ├── select
      │    │    │    │              │    ├── columns: d_date_sk:127!null d_year:133!null d_moy:135!null
      │    │    │    │              │    ├── key: (127)
      │    │    │    │              │    ├── fd: ()-->(133,135)
      │    │    │    │              │    ├── scan date_dim
      │    │    │    │              │    │    ├── columns: d_date_sk:127!null d_year:133 d_moy:135
      │    │    │    │              │    │    ├── key: (127)
      │    │    │    │              │    │    └── fd: (127)-->(133,135)
      │    │    │    │              │    └── filters
      │    │    │    │              │         ├── d_moy:135 = 12 [outer=(135), constraints=(/135: [/12 - /12]; tight), fd=()-->(135)]
      │    │    │    │              │         └── d_year:133 = 2002 [outer=(133), constraints=(/133: [/2002 - /2002]; tight), fd=()-->(133)]
      │    │    │    │              └── filters
      │    │    │    │                   └── d_date_sk:127 = cs_sold_date_sk:91 [outer=(91,127), constraints=(/91: (/NULL - ]; /127: (/NULL - ]), fd=(91)==(127), (127)==(91)]
      │    │    │    └── project
      │    │    │         ├── columns: ss_sold_time_sk:162 ss_item_sk:163!null ss_ext_sales_price:176
      │    │    │         └── inner-join (hash)
      │    │    │              ├── columns: ss_sold_date_sk:161!null ss_sold_time_sk:162 ss_item_sk:163!null ss_ext_sales_price:176 d_date_sk:186!null d_year:192!null d_moy:194!null
      │    │    │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │              ├── fd: ()-->(192,194), (161)==(186), (186)==(161)
      │    │    │              ├── scan store_sales
      │    │    │              │    └── columns: ss_sold_date_sk:161 ss_sold_time_sk:162 ss_item_sk:163!null ss_ext_sales_price:176
      │    │    │              ├── select
      │    │    │              │    ├── columns: d_date_sk:186!null d_year:192!null d_moy:194!null
      │    │    │              │    ├── key: (186)
      │    │    │              │    ├── fd: ()-->(192,194)
      │    │    │              │    ├── scan date_dim
      │    │    │              │    │    ├── columns: d_date_sk:186!null d_year:192 d_moy:194
      │    │    │              │    │    ├── key: (186)
      │    │    │              │    │    └── fd: (186)-->(192,194)
      │    │    │              │    └── filters
      │    │    │              │         ├── d_moy:194 = 12 [outer=(194), constraints=(/194: [/12 - /12]; tight), fd=()-->(194)]
      │    │    │              │         └── d_year:192 = 2002 [outer=(192), constraints=(/192: [/2002 - /2002]; tight), fd=()-->(192)]
      │    │    │              └── filters
      │    │    │                   └── d_date_sk:186 = ss_sold_date_sk:161 [outer=(161,186), constraints=(/161: (/NULL - ]; /186: (/NULL - ]), fd=(161)==(186), (186)==(161)]
      │    │    ├── select
      │    │    │    ├── columns: i_item_sk:1!null i_brand_id:8 i_brand:9 i_manager_id:21!null
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: ()-->(21), (1)-->(8,9)
      │    │    │    ├── scan item
      │    │    │    │    ├── columns: i_item_sk:1!null i_brand_id:8 i_brand:9 i_manager_id:21
      │    │    │    │    ├── key: (1)
      │    │    │    │    └── fd: (1)-->(8,9,21)
      │    │    │    └── filters
      │    │    │         └── i_manager_id:21 = 1 [outer=(21), constraints=(/21: [/1 - /1]; tight), fd=()-->(21)]
      │    │    └── filters
      │    │         └── sold_item_sk:218 = i_item_sk:1 [outer=(1,218), constraints=(/1: (/NULL - ]; /218: (/NULL - ]), fd=(1)==(218), (218)==(1)]
      │    └── filters
      │         └── (t_meal_time:229 = 'breakfast') OR (t_meal_time:229 = 'dinner') [outer=(229), constraints=(/229: [/'breakfast' - /'breakfast'] [/'dinner' - /'dinner']; tight)]
      └── aggregations
           └── sum [as=sum:232, outer=(216)]
                └── ext_price:216

# --------------------------------------------------
# Q72
opt
	SELECT
		i_item_desc,
		w_warehouse_name,
		d1.d_week_seq,
		sum(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END)
			AS no_promo,
		sum(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END)
			AS promo,
		count(*) AS total_cnt
	FROM
		catalog_sales
		JOIN inventory ON cs_item_sk = inv_item_sk
		JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk
		JOIN item ON i_item_sk = cs_item_sk
		JOIN customer_demographics ON
				cs_bill_cdemo_sk = cd_demo_sk
		JOIN household_demographics ON
				cs_bill_hdemo_sk = hd_demo_sk
		JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk
		JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk
		JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk
		LEFT JOIN promotion ON cs_promo_sk = p_promo_sk
		LEFT JOIN catalog_returns ON
				cr_item_sk = cs_item_sk
				AND cr_order_number = cs_order_number
	WHERE
		d1.d_week_seq = d2.d_week_seq
		AND inv_quantity_on_hand < cs_quantity
		AND d3.d_date > d1.d_date + 5
		AND hd_buy_potential = '1001-5000'
		AND d1.d_year = 1998
		AND cd_marital_status = 'S'
	GROUP BY
		i_item_desc, w_warehouse_name, d1.d_week_seq
	ORDER BY
		total_cnt DESC,
		i_item_desc,
		w_warehouse_name,
		d_week_seq
	LIMIT
		100;
----
top-k
 ├── columns: i_item_desc:63 w_warehouse_name:45 d_week_seq:105!null no_promo:243!null promo:245!null total_cnt:246!null
 ├── internal-ordering: -246,+63,+45,+105
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (45,63,105)
 ├── fd: (45,63,105)-->(243,245,246)
 ├── ordering: -246,+63,+45,+105
 └── group-by (hash)
      ├── columns: w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null sum:243!null sum:245!null count_rows:246!null
      ├── grouping columns: w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null
      ├── immutable
      ├── key: (45,63,105)
      ├── fd: (45,63,105)-->(243,245,246)
      ├── project
      │    ├── columns: column242:242!null column244:244!null w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null
      │    ├── immutable
      │    ├── left-join (hash)
      │    │    ├── columns: cs_ship_date_sk:3!null cs_promo_sk:17 w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null d3.d_date_sk:161!null d3.d_date:163!null p_promo_sk:191 column241:241!null
      │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
      │    │    ├── immutable
      │    │    ├── fd: (161)-->(163), (3)==(161), (161)==(3)
      │    │    ├── inner-join (lookup date_dim [as=d3])
      │    │    │    ├── columns: cs_ship_date_sk:3!null cs_promo_sk:17 w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null d3.d_date_sk:161!null d3.d_date:163!null column241:241!null
      │    │    │    ├── key columns: [3] = [161]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── immutable
      │    │    │    ├── fd: (161)-->(163), (3)==(161), (161)==(3)
      │    │    │    ├── project
      │    │    │    │    ├── columns: column241:241 cs_ship_date_sk:3 cs_promo_sk:17 w_warehouse_name:45 i_item_desc:63 d1.d_week_seq:105!null
      │    │    │    │    ├── immutable
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5!null cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19!null inv_date_sk:37!null inv_item_sk:38!null inv_warehouse_sk:39!null inv_quantity_on_hand:40!null w_warehouse_sk:43!null w_warehouse_name:45 i_item_sk:59!null i_item_desc:63 cd_demo_sk:83!null cd_marital_status:85!null hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105!null d1.d_year:107!null d2.d_date_sk:131!null d2.d_week_seq:135!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: ()-->(85,96,107), (37-39)-->(40), (43)-->(45), (59)-->(63), (101)-->(103,105), (131)-->(135), (16)==(38,59), (38)==(16,59), (59)==(16,38), (39)==(43), (43)==(39), (5)==(83), (83)==(5), (6)==(94), (94)==(6), (1)==(101), (101)==(1), (37)==(131), (131)==(37), (105)==(135), (135)==(105)
      │    │    │    │    │    ├── inner-join (lookup inventory)
      │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5!null cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19!null inv_date_sk:37!null inv_item_sk:38!null inv_warehouse_sk:39!null inv_quantity_on_hand:40!null i_item_sk:59!null i_item_desc:63 cd_demo_sk:83!null cd_marital_status:85!null hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105!null d1.d_year:107!null d2.d_date_sk:131!null d2.d_week_seq:135!null
      │    │    │    │    │    │    ├── key columns: [131 16] = [37 38]
      │    │    │    │    │    │    ├── fd: ()-->(85,96,107), (37-39)-->(40), (59)-->(63), (101)-->(103,105), (131)-->(135), (105)==(135), (135)==(105), (1)==(101), (101)==(1), (6)==(94), (94)==(6), (5)==(83), (83)==(5), (16)==(38,59), (38)==(16,59), (59)==(16,38), (37)==(131), (131)==(37)
      │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5!null cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 i_item_sk:59!null i_item_desc:63 cd_demo_sk:83!null cd_marital_status:85!null hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105!null d1.d_year:107!null d2.d_date_sk:131!null d2.d_week_seq:135!null
      │    │    │    │    │    │    │    ├── fd: ()-->(85,96,107), (59)-->(63), (101)-->(103,105), (131)-->(135), (105)==(135), (135)==(105), (1)==(101), (101)==(1), (6)==(94), (94)==(6), (5)==(83), (83)==(5), (16)==(59), (59)==(16)
      │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5!null cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 i_item_sk:59!null i_item_desc:63 cd_demo_sk:83!null cd_marital_status:85!null hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105 d1.d_year:107!null
      │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    ├── fd: ()-->(85,96,107), (59)-->(63), (101)-->(103,105), (1)==(101), (101)==(1), (6)==(94), (94)==(6), (5)==(83), (83)==(5), (16)==(59), (59)==(16)
      │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5!null cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 cd_demo_sk:83!null cd_marital_status:85!null hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105 d1.d_year:107!null
      │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    ├── fd: ()-->(85,96,107), (101)-->(103,105), (1)==(101), (101)==(1), (6)==(94), (94)==(6), (5)==(83), (83)==(5)
      │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_ship_date_sk:3 cs_bill_cdemo_sk:5 cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 hd_demo_sk:94!null hd_buy_potential:96!null d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105 d1.d_year:107!null
      │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(96,107), (101)-->(103,105), (1)==(101), (101)==(1), (6)==(94), (94)==(6)
      │    │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_ship_date_sk:3 cs_bill_cdemo_sk:5 cs_bill_hdemo_sk:6!null cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19 hd_demo_sk:94!null hd_buy_potential:96!null
      │    │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(96), (6)==(94), (94)==(6)
      │    │    │    │    │    │    │    │    │    │    │    ├── scan catalog_sales
      │    │    │    │    │    │    │    │    │    │    │    │    └── columns: cs_sold_date_sk:1 cs_ship_date_sk:3 cs_bill_cdemo_sk:5 cs_bill_hdemo_sk:6 cs_item_sk:16!null cs_promo_sk:17 cs_quantity:19
      │    │    │    │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:94!null hd_buy_potential:96!null
      │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (94)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(96)
      │    │    │    │    │    │    │    │    │    │    │    │    ├── scan household_demographics
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:94!null hd_buy_potential:96
      │    │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (94)
      │    │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (94)-->(96)
      │    │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │    │         └── hd_buy_potential:96 = '1001-5000' [outer=(96), constraints=(/96: [/'1001-5000' - /'1001-5000']; tight), fd=()-->(96)]
      │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │         └── cs_bill_hdemo_sk:6 = hd_demo_sk:94 [outer=(6,94), constraints=(/6: (/NULL - ]; /94: (/NULL - ]), fd=(6)==(94), (94)==(6)]
      │    │    │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105 d1.d_year:107!null
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (101)
      │    │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(107), (101)-->(103,105)
      │    │    │    │    │    │    │    │    │    │    │    ├── scan date_dim [as=d1]
      │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: d1.d_date_sk:101!null d1.d_date:103 d1.d_week_seq:105 d1.d_year:107
      │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (101)
      │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (101)-->(103,105,107)
      │    │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │    │         └── d1.d_year:107 = 1998 [outer=(107), constraints=(/107: [/1998 - /1998]; tight), fd=()-->(107)]
      │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │         └── cs_sold_date_sk:1 = d1.d_date_sk:101 [outer=(1,101), constraints=(/1: (/NULL - ]; /101: (/NULL - ]), fd=(1)==(101), (101)==(1)]
      │    │    │    │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    │    │    │    ├── columns: cd_demo_sk:83!null cd_marital_status:85!null
      │    │    │    │    │    │    │    │    │    │    ├── key: (83)
      │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(85)
      │    │    │    │    │    │    │    │    │    │    ├── scan customer_demographics
      │    │    │    │    │    │    │    │    │    │    │    ├── columns: cd_demo_sk:83!null cd_marital_status:85
      │    │    │    │    │    │    │    │    │    │    │    ├── key: (83)
      │    │    │    │    │    │    │    │    │    │    │    └── fd: (83)-->(85)
      │    │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │    │         └── cd_marital_status:85 = 'S' [outer=(85), constraints=(/85: [/'S' - /'S']; tight), fd=()-->(85)]
      │    │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │    │         └── cs_bill_cdemo_sk:5 = cd_demo_sk:83 [outer=(5,83), constraints=(/5: (/NULL - ]; /83: (/NULL - ]), fd=(5)==(83), (83)==(5)]
      │    │    │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:59!null i_item_desc:63
      │    │    │    │    │    │    │    │    │    ├── key: (59)
      │    │    │    │    │    │    │    │    │    └── fd: (59)-->(63)
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── i_item_sk:59 = cs_item_sk:16 [outer=(16,59), constraints=(/16: (/NULL - ]; /59: (/NULL - ]), fd=(16)==(59), (59)==(16)]
      │    │    │    │    │    │    │    ├── scan date_dim [as=d2]
      │    │    │    │    │    │    │    │    ├── columns: d2.d_date_sk:131!null d2.d_week_seq:135
      │    │    │    │    │    │    │    │    ├── key: (131)
      │    │    │    │    │    │    │    │    └── fd: (131)-->(135)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── d1.d_week_seq:105 = d2.d_week_seq:135 [outer=(105,135), constraints=(/105: (/NULL - ]; /135: (/NULL - ]), fd=(105)==(135), (135)==(105)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── inv_quantity_on_hand:40 < cs_quantity:19 [outer=(19,40), constraints=(/19: (/NULL - ]; /40: (/NULL - ])]
      │    │    │    │    │    ├── scan warehouse
      │    │    │    │    │    │    ├── columns: w_warehouse_sk:43!null w_warehouse_name:45
      │    │    │    │    │    │    ├── key: (43)
      │    │    │    │    │    │    └── fd: (43)-->(45)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── w_warehouse_sk:43 = inv_warehouse_sk:39 [outer=(39,43), constraints=(/39: (/NULL - ]; /43: (/NULL - ]), fd=(39)==(43), (43)==(39)]
      │    │    │    │    └── projections
      │    │    │    │         └── d1.d_date:103 + 5 [as=column241:241, outer=(103), immutable]
      │    │    │    └── filters
      │    │    │         └── column241:241 < d3.d_date:163 [outer=(163,241), constraints=(/163: (/NULL - ]; /241: (/NULL - ])]
      │    │    ├── scan promotion
      │    │    │    ├── columns: p_promo_sk:191!null
      │    │    │    └── key: (191)
      │    │    └── filters
      │    │         └── cs_promo_sk:17 = p_promo_sk:191 [outer=(17,191), constraints=(/17: (/NULL - ]; /191: (/NULL - ]), fd=(17)==(191), (191)==(17)]
      │    └── projections
      │         ├── CASE WHEN p_promo_sk:191 IS NULL THEN 1 ELSE 0 END [as=column242:242, outer=(191)]
      │         └── CASE WHEN p_promo_sk:191 IS NOT NULL THEN 1 ELSE 0 END [as=column244:244, outer=(191)]
      └── aggregations
           ├── sum [as=sum:243, outer=(242)]
           │    └── column242:242
           ├── sum [as=sum:245, outer=(244)]
           │    └── column244:244
           └── count-rows [as=count_rows:246]

# --------------------------------------------------
# Q73
opt
	SELECT
		c_last_name,
		c_first_name,
		c_salutation,
		c_preferred_cust_flag,
		ss_ticket_number,
		cnt
	FROM
		(
			SELECT
				ss_ticket_number,
				ss_customer_sk,
				count(*) AS cnt
			FROM
				store_sales,
				date_dim,
				store,
				household_demographics
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_store_sk = store.s_store_sk
				AND store_sales.ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND date_dim.d_dom BETWEEN 1 AND 2
				AND (
						household_demographics.hd_buy_potential
						= '1001-5000'
						OR household_demographics.hd_buy_potential
							= '5001-10000'
					)
				AND household_demographics.hd_vehicle_count > 0
				AND CASE
					WHEN household_demographics.hd_vehicle_count
					> 0
					THEN household_demographics.hd_dep_count
					/ household_demographics.hd_vehicle_count
					ELSE NULL
					END
					> 1
				AND date_dim.d_year
					IN (2000, 2000 + 1, 2000 + 2)
				AND store.s_county
					IN (
							'Williamson County',
							'Williamson County',
							'Williamson County',
							'Williamson County'
						)
			GROUP BY
				ss_ticket_number, ss_customer_sk
		)
			AS dj,
		customer
	WHERE
		ss_customer_sk = c_customer_sk AND cnt BETWEEN 1 AND 5
	ORDER BY
		cnt DESC, c_last_name ASC;
----
sort
 ├── columns: c_last_name:104 c_first_name:103 c_salutation:102 c_preferred_cust_flag:105 ss_ticket_number:10!null cnt:94!null
 ├── immutable
 ├── ordering: -94,+104
 └── project
      ├── columns: ss_ticket_number:10!null count_rows:94!null c_salutation:102 c_first_name:103 c_last_name:104 c_preferred_cust_flag:105
      ├── immutable
      └── inner-join (lookup customer)
           ├── columns: ss_customer_sk:4!null ss_ticket_number:10!null count_rows:94!null c_customer_sk:95!null c_salutation:102 c_first_name:103 c_last_name:104 c_preferred_cust_flag:105
           ├── key columns: [4] = [95]
           ├── lookup columns are key
           ├── immutable
           ├── key: (10,95)
           ├── fd: (4,10)-->(94), (95)-->(102-105), (4)==(95), (95)==(4)
           ├── select
           │    ├── columns: ss_customer_sk:4 ss_ticket_number:10!null count_rows:94!null
           │    ├── immutable
           │    ├── key: (4,10)
           │    ├── fd: (4,10)-->(94)
           │    ├── group-by (hash)
           │    │    ├── columns: ss_customer_sk:4 ss_ticket_number:10!null count_rows:94!null
           │    │    ├── grouping columns: ss_customer_sk:4 ss_ticket_number:10!null
           │    │    ├── immutable
           │    │    ├── key: (4,10)
           │    │    ├── fd: (4,10)-->(94)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_store_sk:8!null ss_ticket_number:10!null d_date_sk:26!null d_year:32!null d_dom:35!null s_store_sk:56!null s_county:79!null hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── immutable
           │    │    │    ├── fd: ()-->(79), (26)-->(32,35), (87)-->(89-91), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6)
           │    │    │    ├── inner-join (hash)
           │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_store_sk:8 ss_ticket_number:10!null d_date_sk:26!null d_year:32!null d_dom:35!null hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    ├── immutable
           │    │    │    │    ├── fd: (26)-->(32,35), (87)-->(89-91), (6)==(87), (87)==(6), (1)==(26), (26)==(1)
           │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6 ss_store_sk:8 ss_ticket_number:10!null d_date_sk:26!null d_year:32!null d_dom:35!null
           │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    ├── fd: (26)-->(32,35), (1)==(26), (26)==(1)
           │    │    │    │    │    ├── scan store_sales
           │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6 ss_store_sk:8 ss_ticket_number:10!null
           │    │    │    │    │    ├── select
           │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_dom:35!null
           │    │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    │    ├── fd: (26)-->(32,35)
           │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_dom:35
           │    │    │    │    │    │    │    ├── key: (26)
           │    │    │    │    │    │    │    └── fd: (26)-->(32,35)
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         ├── (d_dom:35 >= 1) AND (d_dom:35 <= 2) [outer=(35), constraints=(/35: [/1 - /2]; tight)]
           │    │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002]; tight)]
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
           │    │    │    │    ├── select
           │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_buy_potential:89!null hd_dep_count:90 hd_vehicle_count:91!null
           │    │    │    │    │    ├── immutable
           │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    ├── fd: (87)-->(89-91)
           │    │    │    │    │    ├── scan household_demographics
           │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_buy_potential:89 hd_dep_count:90 hd_vehicle_count:91
           │    │    │    │    │    │    ├── key: (87)
           │    │    │    │    │    │    └── fd: (87)-->(89-91)
           │    │    │    │    │    └── filters
           │    │    │    │    │         ├── (hd_buy_potential:89 = '1001-5000') OR (hd_buy_potential:89 = '5001-10000') [outer=(89), constraints=(/89: [/'1001-5000' - /'1001-5000'] [/'5001-10000' - /'5001-10000']; tight)]
           │    │    │    │    │         ├── hd_vehicle_count:91 > 0 [outer=(91), constraints=(/91: [/1 - ]; tight)]
           │    │    │    │    │         └── CASE WHEN hd_vehicle_count:91 > 0 THEN hd_dep_count:90 / hd_vehicle_count:91 ELSE CAST(NULL AS DECIMAL) END > 1 [outer=(90,91), immutable]
           │    │    │    │    └── filters
           │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:87 [outer=(6,87), constraints=(/6: (/NULL - ]; /87: (/NULL - ]), fd=(6)==(87), (87)==(6)]
           │    │    │    ├── select
           │    │    │    │    ├── columns: s_store_sk:56!null s_county:79!null
           │    │    │    │    ├── key: (56)
           │    │    │    │    ├── fd: ()-->(79)
           │    │    │    │    ├── scan store
           │    │    │    │    │    ├── columns: s_store_sk:56!null s_county:79
           │    │    │    │    │    ├── key: (56)
           │    │    │    │    │    └── fd: (56)-->(79)
           │    │    │    │    └── filters
           │    │    │    │         └── s_county:79 = 'Williamson County' [outer=(79), constraints=(/79: [/'Williamson County' - /'Williamson County']; tight), fd=()-->(79)]
           │    │    │    └── filters
           │    │    │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
           │    │    └── aggregations
           │    │         └── count-rows [as=count_rows:94]
           │    └── filters
           │         └── (count_rows:94 >= 1) AND (count_rows:94 <= 5) [outer=(94), constraints=(/94: [/1 - /5]; tight)]
           └── filters (true)

# --------------------------------------------------
# Q74
opt
	WITH
		year_total
			AS (
				SELECT
					c_customer_id AS customer_id,
					c_first_name AS customer_first_name,
					c_last_name AS customer_last_name,
					d_year AS year,
					max(ss_net_paid) AS year_total,
					's' AS sale_type
				FROM
					customer, store_sales, date_dim
				WHERE
					c_customer_sk = ss_customer_sk
					AND ss_sold_date_sk = d_date_sk
					AND d_year IN (1999, 1999 + 1)
				GROUP BY
					c_customer_id,
					c_first_name,
					c_last_name,
					d_year
				UNION ALL
					SELECT
						c_customer_id AS customer_id,
						c_first_name AS customer_first_name,
						c_last_name AS customer_last_name,
						d_year AS year,
						max(ws_net_paid) AS year_total,
						'w' AS sale_type
					FROM
						customer, web_sales, date_dim
					WHERE
						c_customer_sk = ws_bill_customer_sk
						AND ws_sold_date_sk = d_date_sk
						AND d_year IN (1999, 1999 + 1)
					GROUP BY
						c_customer_id,
						c_first_name,
						c_last_name,
						d_year
			)
	SELECT
		t_s_secyear.customer_id,
		t_s_secyear.customer_first_name,
		t_s_secyear.customer_last_name
	FROM
		year_total AS t_s_firstyear,
		year_total AS t_s_secyear,
		year_total AS t_w_firstyear,
		year_total AS t_w_secyear
	WHERE
		t_s_secyear.customer_id = t_s_firstyear.customer_id
		AND t_s_firstyear.customer_id = t_w_secyear.customer_id
		AND t_s_firstyear.customer_id
			= t_w_firstyear.customer_id
		AND t_s_firstyear.sale_type = 's'
		AND t_w_firstyear.sale_type = 'w'
		AND t_s_secyear.sale_type = 's'
		AND t_w_secyear.sale_type = 'w'
		AND t_s_firstyear.year = 1999
		AND t_s_secyear.year = 1999 + 1
		AND t_w_firstyear.year = 1999
		AND t_w_secyear.year = 1999 + 1
		AND t_s_firstyear.year_total > 0
		AND t_w_firstyear.year_total > 0
		AND CASE
			WHEN t_w_firstyear.year_total > 0
			THEN t_w_secyear.year_total
			/ t_w_firstyear.year_total
			ELSE NULL
			END
			> CASE
				WHEN t_s_firstyear.year_total > 0
				THEN t_s_secyear.year_total
				/ t_s_firstyear.year_total
				ELSE NULL
				END
	ORDER BY
		1, 3, 2
	LIMIT
		100;
----
with &1 (year_total)
 ├── columns: customer_id:178!null customer_first_name:179 customer_last_name:180
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +178,+180,+179
 ├── union-all
 │    ├── columns: customer_id:166!null customer_first_name:167 customer_last_name:168 year:169!null year_total:170 sale_type:171!null
 │    ├── left columns: c_customer_id:2 c_first_name:9 c_last_name:10 d_year:52 max:76 sale_type:77
 │    ├── right columns: c_customer_id:79 c_first_name:86 c_last_name:87 d_year:140 max:164 sale_type:165
 │    ├── project
 │    │    ├── columns: sale_type:77!null c_customer_id:2!null c_first_name:9 c_last_name:10 d_year:52!null max:76
 │    │    ├── key: (2,9,10,52)
 │    │    ├── fd: ()-->(77), (2,9,10,52)-->(76)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: c_customer_id:2!null c_first_name:9 c_last_name:10 d_year:52!null max:76
 │    │    │    ├── grouping columns: c_customer_id:2!null c_first_name:9 c_last_name:10 d_year:52!null
 │    │    │    ├── key: (2,9,10,52)
 │    │    │    ├── fd: (2,9,10,52)-->(76)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10 ss_sold_date_sk:21!null ss_customer_sk:24!null ss_net_paid:41 d_date_sk:46!null d_year:52!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (1)-->(2,9,10), (46)-->(52), (21)==(46), (46)==(21), (1)==(24), (24)==(1)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_date_sk:21!null ss_customer_sk:24 ss_net_paid:41 d_date_sk:46!null d_year:52!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (46)-->(52), (21)==(46), (46)==(21)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_date_sk:21 ss_customer_sk:24 ss_net_paid:41
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:46!null d_year:52!null
 │    │    │    │    │    │    ├── key: (46)
 │    │    │    │    │    │    ├── fd: (46)-->(52)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:46!null d_year:52
 │    │    │    │    │    │    │    ├── key: (46)
 │    │    │    │    │    │    │    └── fd: (46)-->(52)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── d_year:52 IN (1999, 2000) [outer=(52), constraints=(/52: [/1999 - /1999] [/2000 - /2000]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_date_sk:21 = d_date_sk:46 [outer=(21,46), constraints=(/21: (/NULL - ]; /46: (/NULL - ]), fd=(21)==(46), (46)==(21)]
 │    │    │    │    ├── scan customer
 │    │    │    │    │    ├── columns: c_customer_sk:1!null c_customer_id:2!null c_first_name:9 c_last_name:10
 │    │    │    │    │    ├── key: (1)
 │    │    │    │    │    └── fd: (1)-->(2,9,10)
 │    │    │    │    └── filters
 │    │    │    │         └── c_customer_sk:1 = ss_customer_sk:24 [outer=(1,24), constraints=(/1: (/NULL - ]; /24: (/NULL - ]), fd=(1)==(24), (24)==(1)]
 │    │    │    └── aggregations
 │    │    │         └── max [as=max:76, outer=(41)]
 │    │    │              └── ss_net_paid:41
 │    │    └── projections
 │    │         └── 's' [as=sale_type:77]
 │    └── project
 │         ├── columns: sale_type:165!null c_customer_id:79!null c_first_name:86 c_last_name:87 d_year:140!null max:164
 │         ├── key: (79,86,87,140)
 │         ├── fd: ()-->(165), (79,86,87,140)-->(164)
 │         ├── group-by (hash)
 │         │    ├── columns: c_customer_id:79!null c_first_name:86 c_last_name:87 d_year:140!null max:164
 │         │    ├── grouping columns: c_customer_id:79!null c_first_name:86 c_last_name:87 d_year:140!null
 │         │    ├── key: (79,86,87,140)
 │         │    ├── fd: (79,86,87,140)-->(164)
 │         │    ├── inner-join (hash)
 │         │    │    ├── columns: c_customer_sk:78!null c_customer_id:79!null c_first_name:86 c_last_name:87 ws_sold_date_sk:98!null ws_bill_customer_sk:102!null ws_net_paid:127 d_date_sk:134!null d_year:140!null
 │         │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    ├── fd: (78)-->(79,86,87), (134)-->(140), (98)==(134), (134)==(98), (78)==(102), (102)==(78)
 │         │    │    ├── inner-join (hash)
 │         │    │    │    ├── columns: ws_sold_date_sk:98!null ws_bill_customer_sk:102 ws_net_paid:127 d_date_sk:134!null d_year:140!null
 │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │    │    │    ├── fd: (134)-->(140), (98)==(134), (134)==(98)
 │         │    │    │    ├── scan web_sales
 │         │    │    │    │    └── columns: ws_sold_date_sk:98 ws_bill_customer_sk:102 ws_net_paid:127
 │         │    │    │    ├── select
 │         │    │    │    │    ├── columns: d_date_sk:134!null d_year:140!null
 │         │    │    │    │    ├── key: (134)
 │         │    │    │    │    ├── fd: (134)-->(140)
 │         │    │    │    │    ├── scan date_dim
 │         │    │    │    │    │    ├── columns: d_date_sk:134!null d_year:140
 │         │    │    │    │    │    ├── key: (134)
 │         │    │    │    │    │    └── fd: (134)-->(140)
 │         │    │    │    │    └── filters
 │         │    │    │    │         └── d_year:140 IN (1999, 2000) [outer=(140), constraints=(/140: [/1999 - /1999] [/2000 - /2000]; tight)]
 │         │    │    │    └── filters
 │         │    │    │         └── ws_sold_date_sk:98 = d_date_sk:134 [outer=(98,134), constraints=(/98: (/NULL - ]; /134: (/NULL - ]), fd=(98)==(134), (134)==(98)]
 │         │    │    ├── scan customer
 │         │    │    │    ├── columns: c_customer_sk:78!null c_customer_id:79!null c_first_name:86 c_last_name:87
 │         │    │    │    ├── key: (78)
 │         │    │    │    └── fd: (78)-->(79,86,87)
 │         │    │    └── filters
 │         │    │         └── c_customer_sk:78 = ws_bill_customer_sk:102 [outer=(78,102), constraints=(/78: (/NULL - ]; /102: (/NULL - ]), fd=(78)==(102), (102)==(78)]
 │         │    └── aggregations
 │         │         └── max [as=max:164, outer=(127)]
 │         │              └── ws_net_paid:127
 │         └── projections
 │              └── 'w' [as=sale_type:165]
 └── project
      ├── columns: customer_id:178!null customer_first_name:179 customer_last_name:180
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── ordering: +178,+180,+179
      └── top-k
           ├── columns: customer_id:172!null year:175!null year_total:176!null sale_type:177!null customer_id:178!null customer_first_name:179 customer_last_name:180 year:181!null year_total:182 sale_type:183!null customer_id:184!null year:187!null year_total:188!null sale_type:189!null customer_id:190!null year:193!null year_total:194 sale_type:195!null
           ├── internal-ordering: +(172|178|184|190),+180,+179 opt(175,177,181,183,187,189,193,195)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── fd: ()-->(175,177,181,183,187,189,193,195), (172)==(178,184,190), (178)==(172,184,190), (184)==(172,178,190), (190)==(172,178,184)
           ├── ordering: +(172|178|184|190),+180,+179 opt(175,177,181,183,187,189,193,195) [actual: +172,+180,+179]
           └── inner-join (hash)
                ├── columns: customer_id:172!null year:175!null year_total:176!null sale_type:177!null customer_id:178!null customer_first_name:179 customer_last_name:180 year:181!null year_total:182 sale_type:183!null customer_id:184!null year:187!null year_total:188!null sale_type:189!null customer_id:190!null year:193!null year_total:194 sale_type:195!null
                ├── immutable
                ├── fd: ()-->(175,177,181,183,187,189,193,195), (172)==(178,184,190), (178)==(172,184,190), (184)==(172,178,190), (190)==(172,178,184)
                ├── select
                │    ├── columns: customer_id:178!null customer_first_name:179 customer_last_name:180 year:181!null year_total:182 sale_type:183!null
                │    ├── fd: ()-->(181,183)
                │    ├── with-scan &1 (year_total)
                │    │    ├── columns: customer_id:178!null customer_first_name:179 customer_last_name:180 year:181!null year_total:182 sale_type:183!null
                │    │    └── mapping:
                │    │         ├──  customer_id:166 => customer_id:178
                │    │         ├──  customer_first_name:167 => customer_first_name:179
                │    │         ├──  customer_last_name:168 => customer_last_name:180
                │    │         ├──  year:169 => year:181
                │    │         ├──  year_total:170 => year_total:182
                │    │         └──  sale_type:171 => sale_type:183
                │    └── filters
                │         ├── sale_type:183 = 's' [outer=(183), constraints=(/183: [/'s' - /'s']; tight), fd=()-->(183)]
                │         └── year:181 = 2000 [outer=(181), constraints=(/181: [/2000 - /2000]; tight), fd=()-->(181)]
                ├── inner-join (hash)
                │    ├── columns: customer_id:172!null year:175!null year_total:176!null sale_type:177!null customer_id:184!null year:187!null year_total:188!null sale_type:189!null customer_id:190!null year:193!null year_total:194 sale_type:195!null
                │    ├── immutable
                │    ├── fd: ()-->(175,177,187,189,193,195), (172)==(184,190), (184)==(172,190), (190)==(172,184)
                │    ├── select
                │    │    ├── columns: customer_id:190!null year:193!null year_total:194 sale_type:195!null
                │    │    ├── fd: ()-->(193,195)
                │    │    ├── with-scan &1 (year_total)
                │    │    │    ├── columns: customer_id:190!null year:193!null year_total:194 sale_type:195!null
                │    │    │    └── mapping:
                │    │    │         ├──  customer_id:166 => customer_id:190
                │    │    │         ├──  year:169 => year:193
                │    │    │         ├──  year_total:170 => year_total:194
                │    │    │         └──  sale_type:171 => sale_type:195
                │    │    └── filters
                │    │         ├── sale_type:195 = 'w' [outer=(195), constraints=(/195: [/'w' - /'w']; tight), fd=()-->(195)]
                │    │         └── year:193 = 2000 [outer=(193), constraints=(/193: [/2000 - /2000]; tight), fd=()-->(193)]
                │    ├── inner-join (hash)
                │    │    ├── columns: customer_id:172!null year:175!null year_total:176!null sale_type:177!null customer_id:184!null year:187!null year_total:188!null sale_type:189!null
                │    │    ├── immutable
                │    │    ├── fd: ()-->(175,177,187,189), (172)==(184), (184)==(172)
                │    │    ├── select
                │    │    │    ├── columns: customer_id:172!null year:175!null year_total:176!null sale_type:177!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(175,177)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:172!null year:175!null year_total:176 sale_type:177!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:166 => customer_id:172
                │    │    │    │         ├──  year:169 => year:175
                │    │    │    │         ├──  year_total:170 => year_total:176
                │    │    │    │         └──  sale_type:171 => sale_type:177
                │    │    │    └── filters
                │    │    │         ├── sale_type:177 = 's' [outer=(177), constraints=(/177: [/'s' - /'s']; tight), fd=()-->(177)]
                │    │    │         ├── year:175 = 1999 [outer=(175), constraints=(/175: [/1999 - /1999]; tight), fd=()-->(175)]
                │    │    │         └── year_total:176 > 0 [outer=(176), immutable, constraints=(/176: (/0 - ]; tight)]
                │    │    ├── select
                │    │    │    ├── columns: customer_id:184!null year:187!null year_total:188!null sale_type:189!null
                │    │    │    ├── immutable
                │    │    │    ├── fd: ()-->(187,189)
                │    │    │    ├── with-scan &1 (year_total)
                │    │    │    │    ├── columns: customer_id:184!null year:187!null year_total:188 sale_type:189!null
                │    │    │    │    └── mapping:
                │    │    │    │         ├──  customer_id:166 => customer_id:184
                │    │    │    │         ├──  year:169 => year:187
                │    │    │    │         ├──  year_total:170 => year_total:188
                │    │    │    │         └──  sale_type:171 => sale_type:189
                │    │    │    └── filters
                │    │    │         ├── sale_type:189 = 'w' [outer=(189), constraints=(/189: [/'w' - /'w']; tight), fd=()-->(189)]
                │    │    │         ├── year:187 = 1999 [outer=(187), constraints=(/187: [/1999 - /1999]; tight), fd=()-->(187)]
                │    │    │         └── year_total:188 > 0 [outer=(188), immutable, constraints=(/188: (/0 - ]; tight)]
                │    │    └── filters
                │    │         └── customer_id:172 = customer_id:184 [outer=(172,184), constraints=(/172: (/NULL - ]; /184: (/NULL - ]), fd=(172)==(184), (184)==(172)]
                │    └── filters
                │         └── customer_id:184 = customer_id:190 [outer=(184,190), constraints=(/184: (/NULL - ]; /190: (/NULL - ]), fd=(184)==(190), (190)==(184)]
                └── filters
                     ├── customer_id:178 = customer_id:184 [outer=(178,184), constraints=(/178: (/NULL - ]; /184: (/NULL - ]), fd=(178)==(184), (184)==(178)]
                     └── CASE WHEN year_total:188 > 0 THEN year_total:194 / year_total:188 ELSE CAST(NULL AS DECIMAL) END > CASE WHEN year_total:176 > 0 THEN year_total:182 / year_total:176 ELSE CAST(NULL AS DECIMAL) END [outer=(176,182,188,194), immutable]

# --------------------------------------------------
# Q75
opt
	WITH
		all_sales
			AS (
				SELECT
					d_year,
					i_brand_id,
					i_class_id,
					i_category_id,
					i_manufact_id,
					sum(sales_cnt) AS sales_cnt,
					sum(sales_amt) AS sales_amt
				FROM
					(
						SELECT
							d_year,
							i_brand_id,
							i_class_id,
							i_category_id,
							i_manufact_id,
							cs_quantity
							- COALESCE(cr_return_quantity, 0)
								AS sales_cnt,
							cs_ext_sales_price
							- COALESCE(cr_return_amount, 0.0)
								AS sales_amt
						FROM
							catalog_sales
							JOIN item ON i_item_sk = cs_item_sk
							JOIN date_dim ON
									d_date_sk = cs_sold_date_sk
							LEFT JOIN catalog_returns ON
									cs_order_number
									= cr_order_number
									AND cs_item_sk = cr_item_sk
						WHERE
							i_category = 'Sports'
						UNION
							SELECT
								d_year,
								i_brand_id,
								i_class_id,
								i_category_id,
								i_manufact_id,
								ss_quantity
								- COALESCE(
										sr_return_quantity,
										0
									)
									AS sales_cnt,
								ss_ext_sales_price
								- COALESCE(sr_return_amt, 0.0)
									AS sales_amt
							FROM
								store_sales
								JOIN item ON
										i_item_sk = ss_item_sk
								JOIN date_dim ON
										d_date_sk
										= ss_sold_date_sk
								LEFT JOIN store_returns ON
										ss_ticket_number
										= sr_ticket_number
										AND ss_item_sk
											= sr_item_sk
							WHERE
								i_category = 'Sports'
						UNION
							SELECT
								d_year,
								i_brand_id,
								i_class_id,
								i_category_id,
								i_manufact_id,
								ws_quantity
								- COALESCE(
										wr_return_quantity,
										0
									)
									AS sales_cnt,
								ws_ext_sales_price
								- COALESCE(wr_return_amt, 0.0)
									AS sales_amt
							FROM
								web_sales
								JOIN item ON
										i_item_sk = ws_item_sk
								JOIN date_dim ON
										d_date_sk
										= ws_sold_date_sk
								LEFT JOIN web_returns ON
										ws_order_number
										= wr_order_number
										AND ws_item_sk
											= wr_item_sk
							WHERE
								i_category = 'Sports'
					)
						AS sales_detail
				GROUP BY
					d_year,
					i_brand_id,
					i_class_id,
					i_category_id,
					i_manufact_id
			)
	SELECT
		prev_yr.d_year AS prev_year,
		curr_yr.d_year AS year,
		curr_yr.i_brand_id,
		curr_yr.i_class_id,
		curr_yr.i_category_id,
		curr_yr.i_manufact_id,
		prev_yr.sales_cnt AS prev_yr_cnt,
		curr_yr.sales_cnt AS curr_yr_cnt,
		curr_yr.sales_cnt - prev_yr.sales_cnt AS sales_cnt_diff,
		curr_yr.sales_amt - prev_yr.sales_amt AS sales_amt_diff
	FROM
		all_sales AS curr_yr, all_sales AS prev_yr
	WHERE
		curr_yr.i_brand_id = prev_yr.i_brand_id
		AND curr_yr.i_class_id = prev_yr.i_class_id
		AND curr_yr.i_category_id = prev_yr.i_category_id
		AND curr_yr.i_manufact_id = prev_yr.i_manufact_id
		AND curr_yr.d_year = 2002
		AND prev_yr.d_year = 2002 - 1
		AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2))
			/ CAST(prev_yr.sales_cnt AS DECIMAL(17,2))
			< 0.9
	ORDER BY
		sales_cnt_diff, sales_amt_diff
	LIMIT
		100;
----
with &1 (all_sales)
 ├── columns: prev_year:366!null year:359!null i_brand_id:360!null i_class_id:361!null i_category_id:362!null i_manufact_id:363!null prev_yr_cnt:371 curr_yr_cnt:364 sales_cnt_diff:373 sales_amt_diff:374
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (360-363)
 ├── fd: ()-->(359,366), (360-363)-->(364,371,374), (364,371)-->(373)
 ├── ordering: +373,+374 opt(359,366) [actual: +373,+374]
 ├── group-by (hash)
 │    ├── columns: d_year:350 i_brand_id:351 i_class_id:352 i_category_id:353 i_manufact_id:354 sum:357 sum:358
 │    ├── grouping columns: d_year:350 i_brand_id:351 i_class_id:352 i_category_id:353 i_manufact_id:354
 │    ├── immutable
 │    ├── key: (350-354)
 │    ├── fd: (350-354)-->(357,358)
 │    ├── union
 │    │    ├── columns: d_year:350 i_brand_id:351 i_class_id:352 i_category_id:353 i_manufact_id:354 sales_cnt:355 sales_amt:356
 │    │    ├── left columns: d_year:225 i_brand_id:226 i_class_id:227 i_category_id:228 i_manufact_id:229 sales_cnt:230 sales_amt:231
 │    │    ├── right columns: date_dim.d_year:298 item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 item.i_manufact_id:281 sales_cnt:348 sales_amt:349
 │    │    ├── immutable
 │    │    ├── key: (350-356)
 │    │    ├── union
 │    │    │    ├── columns: d_year:225 i_brand_id:226 i_class_id:227 i_category_id:228 i_manufact_id:229 sales_cnt:230 sales_amt:231
 │    │    │    ├── left columns: date_dim.d_year:67 item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 item.i_manufact_id:50 sales_cnt:120 sales_amt:121
 │    │    │    ├── right columns: date_dim.d_year:177 item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 item.i_manufact_id:160 sales_cnt:223 sales_amt:224
 │    │    │    ├── immutable
 │    │    │    ├── key: (225-231)
 │    │    │    ├── project
 │    │    │    │    ├── columns: sales_cnt:120 sales_amt:121 item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 item.i_manufact_id:50 date_dim.d_year:67
 │    │    │    │    ├── immutable
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: cs_sold_date_sk:1!null cs_item_sk:16!null cs_order_number:18!null cs_quantity:19 cs_ext_sales_price:24 i_item_sk:37!null item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 i_category:49!null item.i_manufact_id:50 d_date_sk:61!null date_dim.d_year:67 cr_item_sk:93 cr_order_number:107 cr_return_quantity:108 cr_return_amount:109
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── key: (18,37)
 │    │    │    │    │    ├── fd: ()-->(49), (16,18)-->(1,19,24), (37)-->(44,46,48,50), (61)-->(67), (93,107)-->(108,109), (18,37)-->(93,107-109), (16)==(37), (37)==(16), (1)==(61), (61)==(1)
 │    │    │    │    │    ├── right-join (merge)
 │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_item_sk:16!null cs_order_number:18!null cs_quantity:19 cs_ext_sales_price:24 i_item_sk:37!null item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 i_category:49!null item.i_manufact_id:50 cr_item_sk:93 cr_order_number:107 cr_return_quantity:108 cr_return_amount:109
 │    │    │    │    │    │    ├── left ordering: +93,+107
 │    │    │    │    │    │    ├── right ordering: +16,+18
 │    │    │    │    │    │    ├── key: (18,37)
 │    │    │    │    │    │    ├── fd: ()-->(49), (37)-->(44,46,48,50), (16,18)-->(1,19,24,93,107-109), (93,107)-->(108,109), (16)==(37), (37)==(16)
 │    │    │    │    │    │    ├── scan catalog_returns
 │    │    │    │    │    │    │    ├── columns: cr_item_sk:93!null cr_order_number:107!null cr_return_quantity:108 cr_return_amount:109
 │    │    │    │    │    │    │    ├── key: (93,107)
 │    │    │    │    │    │    │    ├── fd: (93,107)-->(108,109)
 │    │    │    │    │    │    │    └── ordering: +93,+107
 │    │    │    │    │    │    ├── inner-join (lookup catalog_sales)
 │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_item_sk:16!null cs_order_number:18!null cs_quantity:19 cs_ext_sales_price:24 i_item_sk:37!null item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 i_category:49!null item.i_manufact_id:50
 │    │    │    │    │    │    │    ├── key columns: [37] = [16]
 │    │    │    │    │    │    │    ├── key: (18,37)
 │    │    │    │    │    │    │    ├── fd: ()-->(49), (16,18)-->(1,19,24), (37)-->(44,46,48,50), (16)==(37), (37)==(16)
 │    │    │    │    │    │    │    ├── ordering: +(16|37),+18 opt(49) [actual: +37,+18]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 i_category:49!null item.i_manufact_id:50
 │    │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(49), (37)-->(44,46,48,50)
 │    │    │    │    │    │    │    │    ├── ordering: +37 opt(49) [actual: +37]
 │    │    │    │    │    │    │    │    ├── scan item
 │    │    │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null item.i_brand_id:44 item.i_class_id:46 item.i_category_id:48 i_category:49 item.i_manufact_id:50
 │    │    │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    │    │    ├── fd: (37)-->(44,46,48-50)
 │    │    │    │    │    │    │    │    │    └── ordering: +37
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── i_category:49 = 'Sports' [outer=(49), constraints=(/49: [/'Sports' - /'Sports']; tight), fd=()-->(49)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:61!null date_dim.d_year:67
 │    │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    │    └── fd: (61)-->(67)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── d_date_sk:61 = cs_sold_date_sk:1 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
 │    │    │    │    └── projections
 │    │    │    │         ├── cs_quantity:19 - COALESCE(cr_return_quantity:108, 0) [as=sales_cnt:120, outer=(19,108), immutable]
 │    │    │    │         └── cs_ext_sales_price:24 - COALESCE(cr_return_amount:109::DECIMAL, 0.0) [as=sales_amt:121, outer=(24,109), immutable]
 │    │    │    └── project
 │    │    │         ├── columns: sales_cnt:223 sales_amt:224 item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 item.i_manufact_id:160 date_dim.d_year:177
 │    │    │         ├── immutable
 │    │    │         ├── inner-join (hash)
 │    │    │         │    ├── columns: ss_sold_date_sk:122!null ss_item_sk:124!null ss_ticket_number:131!null ss_quantity:132 ss_ext_sales_price:137 i_item_sk:147!null item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 i_category:159!null item.i_manufact_id:160 d_date_sk:171!null date_dim.d_year:177 sr_item_sk:203 sr_ticket_number:210 sr_return_quantity:211 sr_return_amt:212
 │    │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │    ├── key: (131,147)
 │    │    │         │    ├── fd: ()-->(159), (124,131)-->(122,132,137), (147)-->(154,156,158,160), (171)-->(177), (203,210)-->(211,212), (131,147)-->(203,210-212), (124)==(147), (147)==(124), (122)==(171), (171)==(122)
 │    │    │         │    ├── right-join (merge)
 │    │    │         │    │    ├── columns: ss_sold_date_sk:122 ss_item_sk:124!null ss_ticket_number:131!null ss_quantity:132 ss_ext_sales_price:137 i_item_sk:147!null item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 i_category:159!null item.i_manufact_id:160 sr_item_sk:203 sr_ticket_number:210 sr_return_quantity:211 sr_return_amt:212
 │    │    │         │    │    ├── left ordering: +203,+210
 │    │    │         │    │    ├── right ordering: +124,+131
 │    │    │         │    │    ├── key: (131,147)
 │    │    │         │    │    ├── fd: ()-->(159), (147)-->(154,156,158,160), (124,131)-->(122,132,137,203,210-212), (203,210)-->(211,212), (124)==(147), (147)==(124)
 │    │    │         │    │    ├── scan store_returns
 │    │    │         │    │    │    ├── columns: sr_item_sk:203!null sr_ticket_number:210!null sr_return_quantity:211 sr_return_amt:212
 │    │    │         │    │    │    ├── key: (203,210)
 │    │    │         │    │    │    ├── fd: (203,210)-->(211,212)
 │    │    │         │    │    │    └── ordering: +203,+210
 │    │    │         │    │    ├── inner-join (lookup store_sales)
 │    │    │         │    │    │    ├── columns: ss_sold_date_sk:122 ss_item_sk:124!null ss_ticket_number:131!null ss_quantity:132 ss_ext_sales_price:137 i_item_sk:147!null item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 i_category:159!null item.i_manufact_id:160
 │    │    │         │    │    │    ├── key columns: [147] = [124]
 │    │    │         │    │    │    ├── key: (131,147)
 │    │    │         │    │    │    ├── fd: ()-->(159), (124,131)-->(122,132,137), (147)-->(154,156,158,160), (124)==(147), (147)==(124)
 │    │    │         │    │    │    ├── ordering: +(124|147),+131 opt(159) [actual: +147,+131]
 │    │    │         │    │    │    ├── select
 │    │    │         │    │    │    │    ├── columns: i_item_sk:147!null item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 i_category:159!null item.i_manufact_id:160
 │    │    │         │    │    │    │    ├── key: (147)
 │    │    │         │    │    │    │    ├── fd: ()-->(159), (147)-->(154,156,158,160)
 │    │    │         │    │    │    │    ├── ordering: +147 opt(159) [actual: +147]
 │    │    │         │    │    │    │    ├── scan item
 │    │    │         │    │    │    │    │    ├── columns: i_item_sk:147!null item.i_brand_id:154 item.i_class_id:156 item.i_category_id:158 i_category:159 item.i_manufact_id:160
 │    │    │         │    │    │    │    │    ├── key: (147)
 │    │    │         │    │    │    │    │    ├── fd: (147)-->(154,156,158-160)
 │    │    │         │    │    │    │    │    └── ordering: +147
 │    │    │         │    │    │    │    └── filters
 │    │    │         │    │    │    │         └── i_category:159 = 'Sports' [outer=(159), constraints=(/159: [/'Sports' - /'Sports']; tight), fd=()-->(159)]
 │    │    │         │    │    │    └── filters (true)
 │    │    │         │    │    └── filters (true)
 │    │    │         │    ├── scan date_dim
 │    │    │         │    │    ├── columns: d_date_sk:171!null date_dim.d_year:177
 │    │    │         │    │    ├── key: (171)
 │    │    │         │    │    └── fd: (171)-->(177)
 │    │    │         │    └── filters
 │    │    │         │         └── d_date_sk:171 = ss_sold_date_sk:122 [outer=(122,171), constraints=(/122: (/NULL - ]; /171: (/NULL - ]), fd=(122)==(171), (171)==(122)]
 │    │    │         └── projections
 │    │    │              ├── ss_quantity:132 - COALESCE(sr_return_quantity:211, 0) [as=sales_cnt:223, outer=(132,211), immutable]
 │    │    │              └── ss_ext_sales_price:137 - COALESCE(sr_return_amt:212::DECIMAL, 0.0) [as=sales_amt:224, outer=(137,212), immutable]
 │    │    └── project
 │    │         ├── columns: sales_cnt:348 sales_amt:349 item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 item.i_manufact_id:281 date_dim.d_year:298
 │    │         ├── immutable
 │    │         ├── inner-join (hash)
 │    │         │    ├── columns: ws_sold_date_sk:232!null ws_item_sk:235!null ws_order_number:249!null ws_quantity:250 ws_ext_sales_price:255 i_item_sk:268!null item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 i_category:280!null item.i_manufact_id:281 d_date_sk:292!null date_dim.d_year:298 wr_item_sk:324 wr_order_number:335 wr_return_quantity:336 wr_return_amt:337
 │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    ├── key: (249,268)
 │    │         │    ├── fd: ()-->(280), (235,249)-->(232,250,255), (268)-->(275,277,279,281), (292)-->(298), (324,335)-->(336,337), (249,268)-->(324,335-337), (235)==(268), (268)==(235), (232)==(292), (292)==(232)
 │    │         │    ├── right-join (merge)
 │    │         │    │    ├── columns: ws_sold_date_sk:232 ws_item_sk:235!null ws_order_number:249!null ws_quantity:250 ws_ext_sales_price:255 i_item_sk:268!null item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 i_category:280!null item.i_manufact_id:281 wr_item_sk:324 wr_order_number:335 wr_return_quantity:336 wr_return_amt:337
 │    │         │    │    ├── left ordering: +324,+335
 │    │         │    │    ├── right ordering: +235,+249
 │    │         │    │    ├── key: (249,268)
 │    │         │    │    ├── fd: ()-->(280), (268)-->(275,277,279,281), (235,249)-->(232,250,255,324,335-337), (324,335)-->(336,337), (235)==(268), (268)==(235)
 │    │         │    │    ├── scan web_returns
 │    │         │    │    │    ├── columns: wr_item_sk:324!null wr_order_number:335!null wr_return_quantity:336 wr_return_amt:337
 │    │         │    │    │    ├── key: (324,335)
 │    │         │    │    │    ├── fd: (324,335)-->(336,337)
 │    │         │    │    │    └── ordering: +324,+335
 │    │         │    │    ├── inner-join (lookup web_sales)
 │    │         │    │    │    ├── columns: ws_sold_date_sk:232 ws_item_sk:235!null ws_order_number:249!null ws_quantity:250 ws_ext_sales_price:255 i_item_sk:268!null item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 i_category:280!null item.i_manufact_id:281
 │    │         │    │    │    ├── key columns: [268] = [235]
 │    │         │    │    │    ├── key: (249,268)
 │    │         │    │    │    ├── fd: ()-->(280), (235,249)-->(232,250,255), (268)-->(275,277,279,281), (235)==(268), (268)==(235)
 │    │         │    │    │    ├── ordering: +(235|268),+249 opt(280) [actual: +268,+249]
 │    │         │    │    │    ├── select
 │    │         │    │    │    │    ├── columns: i_item_sk:268!null item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 i_category:280!null item.i_manufact_id:281
 │    │         │    │    │    │    ├── key: (268)
 │    │         │    │    │    │    ├── fd: ()-->(280), (268)-->(275,277,279,281)
 │    │         │    │    │    │    ├── ordering: +268 opt(280) [actual: +268]
 │    │         │    │    │    │    ├── scan item
 │    │         │    │    │    │    │    ├── columns: i_item_sk:268!null item.i_brand_id:275 item.i_class_id:277 item.i_category_id:279 i_category:280 item.i_manufact_id:281
 │    │         │    │    │    │    │    ├── key: (268)
 │    │         │    │    │    │    │    ├── fd: (268)-->(275,277,279-281)
 │    │         │    │    │    │    │    └── ordering: +268
 │    │         │    │    │    │    └── filters
 │    │         │    │    │    │         └── i_category:280 = 'Sports' [outer=(280), constraints=(/280: [/'Sports' - /'Sports']; tight), fd=()-->(280)]
 │    │         │    │    │    └── filters (true)
 │    │         │    │    └── filters (true)
 │    │         │    ├── scan date_dim
 │    │         │    │    ├── columns: d_date_sk:292!null date_dim.d_year:298
 │    │         │    │    ├── key: (292)
 │    │         │    │    └── fd: (292)-->(298)
 │    │         │    └── filters
 │    │         │         └── d_date_sk:292 = ws_sold_date_sk:232 [outer=(232,292), constraints=(/232: (/NULL - ]; /292: (/NULL - ]), fd=(232)==(292), (292)==(232)]
 │    │         └── projections
 │    │              ├── ws_quantity:250 - COALESCE(wr_return_quantity:336, 0) [as=sales_cnt:348, outer=(250,336), immutable]
 │    │              └── ws_ext_sales_price:255 - COALESCE(wr_return_amt:337::DECIMAL, 0.0) [as=sales_amt:349, outer=(255,337), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:357, outer=(355)]
 │         │    └── sales_cnt:355
 │         └── sum [as=sum:358, outer=(356)]
 │              └── sales_amt:356
 └── top-k
      ├── columns: d_year:359!null i_brand_id:360!null i_class_id:361!null i_category_id:362!null i_manufact_id:363!null sales_cnt:364 d_year:366!null sales_cnt:371 sales_cnt_diff:373 sales_amt_diff:374
      ├── internal-ordering: +373,+374 opt(359,366)
      ├── k: 100
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── key: (360-363)
      ├── fd: ()-->(359,366), (360-363)-->(364,371,374), (364,371)-->(373)
      ├── ordering: +373,+374 opt(359,366) [actual: +373,+374]
      └── project
           ├── columns: sales_cnt_diff:373 sales_amt_diff:374 d_year:359!null i_brand_id:360!null i_class_id:361!null i_category_id:362!null i_manufact_id:363!null sales_cnt:364 d_year:366!null sales_cnt:371
           ├── immutable
           ├── key: (360-363)
           ├── fd: ()-->(359,366), (360-363)-->(364,371,374), (364,371)-->(373)
           ├── inner-join (hash)
           │    ├── columns: d_year:359!null i_brand_id:360!null i_class_id:361!null i_category_id:362!null i_manufact_id:363!null sales_cnt:364 sales_amt:365 d_year:366!null i_brand_id:367!null i_class_id:368!null i_category_id:369!null i_manufact_id:370!null sales_cnt:371 sales_amt:372
           │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
           │    ├── immutable
           │    ├── key: (367-370)
           │    ├── fd: ()-->(359,366), (360-363)-->(364,365), (367-370)-->(371,372), (360)==(367), (367)==(360), (361)==(368), (368)==(361), (362)==(369), (369)==(362), (363)==(370), (370)==(363)
           │    ├── select
           │    │    ├── columns: d_year:359!null i_brand_id:360 i_class_id:361 i_category_id:362 i_manufact_id:363 sales_cnt:364 sales_amt:365
           │    │    ├── key: (360-363)
           │    │    ├── fd: ()-->(359), (360-363)-->(364,365)
           │    │    ├── with-scan &1 (all_sales)
           │    │    │    ├── columns: d_year:359 i_brand_id:360 i_class_id:361 i_category_id:362 i_manufact_id:363 sales_cnt:364 sales_amt:365
           │    │    │    ├── mapping:
           │    │    │    │    ├──  d_year:350 => d_year:359
           │    │    │    │    ├──  i_brand_id:351 => i_brand_id:360
           │    │    │    │    ├──  i_class_id:352 => i_class_id:361
           │    │    │    │    ├──  i_category_id:353 => i_category_id:362
           │    │    │    │    ├──  i_manufact_id:354 => i_manufact_id:363
           │    │    │    │    ├──  sum:357 => sales_cnt:364
           │    │    │    │    └──  sum:358 => sales_amt:365
           │    │    │    ├── key: (359-363)
           │    │    │    └── fd: (359-363)-->(364,365)
           │    │    └── filters
           │    │         └── d_year:359 = 2002 [outer=(359), constraints=(/359: [/2002 - /2002]; tight), fd=()-->(359)]
           │    ├── select
           │    │    ├── columns: d_year:366!null i_brand_id:367 i_class_id:368 i_category_id:369 i_manufact_id:370 sales_cnt:371 sales_amt:372
           │    │    ├── key: (367-370)
           │    │    ├── fd: ()-->(366), (367-370)-->(371,372)
           │    │    ├── with-scan &1 (all_sales)
           │    │    │    ├── columns: d_year:366 i_brand_id:367 i_class_id:368 i_category_id:369 i_manufact_id:370 sales_cnt:371 sales_amt:372
           │    │    │    ├── mapping:
           │    │    │    │    ├──  d_year:350 => d_year:366
           │    │    │    │    ├──  i_brand_id:351 => i_brand_id:367
           │    │    │    │    ├──  i_class_id:352 => i_class_id:368
           │    │    │    │    ├──  i_category_id:353 => i_category_id:369
           │    │    │    │    ├──  i_manufact_id:354 => i_manufact_id:370
           │    │    │    │    ├──  sum:357 => sales_cnt:371
           │    │    │    │    └──  sum:358 => sales_amt:372
           │    │    │    ├── key: (366-370)
           │    │    │    └── fd: (366-370)-->(371,372)
           │    │    └── filters
           │    │         └── d_year:366 = 2001 [outer=(366), constraints=(/366: [/2001 - /2001]; tight), fd=()-->(366)]
           │    └── filters
           │         ├── i_brand_id:360 = i_brand_id:367 [outer=(360,367), constraints=(/360: (/NULL - ]; /367: (/NULL - ]), fd=(360)==(367), (367)==(360)]
           │         ├── i_class_id:361 = i_class_id:368 [outer=(361,368), constraints=(/361: (/NULL - ]; /368: (/NULL - ]), fd=(361)==(368), (368)==(361)]
           │         ├── i_category_id:362 = i_category_id:369 [outer=(362,369), constraints=(/362: (/NULL - ]; /369: (/NULL - ]), fd=(362)==(369), (369)==(362)]
           │         ├── i_manufact_id:363 = i_manufact_id:370 [outer=(363,370), constraints=(/363: (/NULL - ]; /370: (/NULL - ]), fd=(363)==(370), (370)==(363)]
           │         └── (sales_cnt:364::DECIMAL(17,2) / sales_cnt:371::DECIMAL(17,2)) < 0.9 [outer=(364,371), immutable]
           └── projections
                ├── sales_cnt:364 - sales_cnt:371 [as=sales_cnt_diff:373, outer=(364,371), immutable]
                └── sales_amt:365 - sales_amt:372 [as=sales_amt_diff:374, outer=(365,372), immutable]

# --------------------------------------------------
# Q76
opt
	SELECT
		channel,
		col_name,
		d_year,
		d_qoy,
		i_category,
		count(*) AS sales_cnt,
		sum(ext_sales_price) AS sales_amt
	FROM
		(
			SELECT
				'store' AS channel,
				'ss_customer_sk' AS col_name,
				d_year,
				d_qoy,
				i_category,
				ss_ext_sales_price AS ext_sales_price
			FROM
				store_sales, item, date_dim
			WHERE
				ss_customer_sk IS NULL
				AND ss_sold_date_sk = d_date_sk
				AND ss_item_sk = i_item_sk
			UNION ALL
				SELECT
					'web' AS channel,
					'ws_promo_sk' AS col_name,
					d_year,
					d_qoy,
					i_category,
					ws_ext_sales_price AS ext_sales_price
				FROM
					web_sales, item, date_dim
				WHERE
					ws_promo_sk IS NULL
					AND ws_sold_date_sk = d_date_sk
					AND ws_item_sk = i_item_sk
			UNION ALL
				SELECT
					'catalog' AS channel,
					'cs_bill_customer_sk' AS col_name,
					d_year,
					d_qoy,
					i_category,
					cs_ext_sales_price AS ext_sales_price
				FROM
					catalog_sales, item, date_dim
				WHERE
					cs_bill_customer_sk IS NULL
					AND cs_sold_date_sk = d_date_sk
					AND cs_item_sk = i_item_sk
		)
			AS foo
	GROUP BY
		channel, col_name, d_year, d_qoy, i_category
	ORDER BY
		channel, col_name, d_year, d_qoy, i_category
	LIMIT
		100;
----
top-k
 ├── columns: channel:272!null col_name:273!null d_year:274 d_qoy:275 i_category:276 sales_cnt:278!null sales_amt:279
 ├── internal-ordering: +272,+273,+274,+275,+276
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── key: (272-276)
 ├── fd: (272-276)-->(278,279)
 ├── ordering: +272,+273,+274,+275,+276
 └── group-by (hash)
      ├── columns: channel:272!null col_name:273!null d_year:274 d_qoy:275 i_category:276 count_rows:278!null sum:279
      ├── grouping columns: channel:272!null col_name:273!null d_year:274 d_qoy:275 i_category:276
      ├── key: (272-276)
      ├── fd: (272-276)-->(278,279)
      ├── union-all
      │    ├── columns: channel:272!null col_name:273!null d_year:274 d_qoy:275 i_category:276 ext_sales_price:277
      │    ├── left columns: channel:174 col_name:175 d_year:176 d_qoy:177 i_category:178 ext_sales_price:179
      │    ├── right columns: channel:270 col_name:271 date_dim.d_year:246 date_dim.d_qoy:250 item.i_category:228 cs_ext_sales_price:203
      │    ├── union-all
      │    │    ├── columns: channel:174!null col_name:175!null d_year:176 d_qoy:177 i_category:178 ext_sales_price:179
      │    │    ├── left columns: channel:80 col_name:81 date_dim.d_year:56 date_dim.d_qoy:60 item.i_category:38 ss_ext_sales_price:16
      │    │    ├── right columns: channel:172 col_name:173 date_dim.d_year:148 date_dim.d_qoy:152 item.i_category:130 ws_ext_sales_price:105
      │    │    ├── project
      │    │    │    ├── columns: channel:80!null col_name:81!null ss_ext_sales_price:16 item.i_category:38 date_dim.d_year:56 date_dim.d_qoy:60
      │    │    │    ├── fd: ()-->(80,81)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4 ss_ext_sales_price:16 i_item_sk:26!null item.i_category:38 d_date_sk:50!null date_dim.d_year:56 date_dim.d_qoy:60
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(4), (26)-->(38), (50)-->(56,60), (3)==(26), (26)==(3), (1)==(50), (50)==(1)
      │    │    │    │    ├── inner-join (merge)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4 ss_ext_sales_price:16 i_item_sk:26!null item.i_category:38
      │    │    │    │    │    ├── left ordering: +3
      │    │    │    │    │    ├── right ordering: +26
      │    │    │    │    │    ├── fd: ()-->(4), (26)-->(38), (3)==(26), (26)==(3)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4 ss_ext_sales_price:16
      │    │    │    │    │    │    ├── fd: ()-->(4)
      │    │    │    │    │    │    ├── ordering: +3 opt(4) [actual: +3]
      │    │    │    │    │    │    ├── scan store_sales
      │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4 ss_ext_sales_price:16
      │    │    │    │    │    │    │    └── ordering: +3
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_customer_sk:4 IS NULL [outer=(4), constraints=(/4: [/NULL - /NULL]; tight), fd=()-->(4)]
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:26!null item.i_category:38
      │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    ├── fd: (26)-->(38)
      │    │    │    │    │    │    └── ordering: +26
      │    │    │    │    │    └── filters (true)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:50!null date_dim.d_year:56 date_dim.d_qoy:60
      │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    └── fd: (50)-->(56,60)
      │    │    │    │    └── filters
      │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
      │    │    │    └── projections
      │    │    │         ├── 'store' [as=channel:80]
      │    │    │         └── 'ss_customer_sk' [as=col_name:81]
      │    │    └── project
      │    │         ├── columns: channel:172!null col_name:173!null ws_ext_sales_price:105 item.i_category:130 date_dim.d_year:148 date_dim.d_qoy:152
      │    │         ├── fd: ()-->(172,173)
      │    │         ├── inner-join (lookup date_dim)
      │    │         │    ├── columns: ws_sold_date_sk:82!null ws_item_sk:85!null ws_promo_sk:98 ws_ext_sales_price:105 i_item_sk:118!null item.i_category:130 d_date_sk:142!null date_dim.d_year:148 date_dim.d_qoy:152
      │    │         │    ├── key columns: [82] = [142]
      │    │         │    ├── lookup columns are key
      │    │         │    ├── fd: ()-->(98), (118)-->(130), (142)-->(148,152), (85)==(118), (118)==(85), (82)==(142), (142)==(82)
      │    │         │    ├── inner-join (lookup item)
      │    │         │    │    ├── columns: ws_sold_date_sk:82 ws_item_sk:85!null ws_promo_sk:98 ws_ext_sales_price:105 i_item_sk:118!null item.i_category:130
      │    │         │    │    ├── key columns: [85] = [118]
      │    │         │    │    ├── lookup columns are key
      │    │         │    │    ├── fd: ()-->(98), (118)-->(130), (85)==(118), (118)==(85)
      │    │         │    │    ├── select
      │    │         │    │    │    ├── columns: ws_sold_date_sk:82 ws_item_sk:85!null ws_promo_sk:98 ws_ext_sales_price:105
      │    │         │    │    │    ├── fd: ()-->(98)
      │    │         │    │    │    ├── scan web_sales
      │    │         │    │    │    │    └── columns: ws_sold_date_sk:82 ws_item_sk:85!null ws_promo_sk:98 ws_ext_sales_price:105
      │    │         │    │    │    └── filters
      │    │         │    │    │         └── ws_promo_sk:98 IS NULL [outer=(98), constraints=(/98: [/NULL - /NULL]; tight), fd=()-->(98)]
      │    │         │    │    └── filters (true)
      │    │         │    └── filters (true)
      │    │         └── projections
      │    │              ├── 'web' [as=channel:172]
      │    │              └── 'ws_promo_sk' [as=col_name:173]
      │    └── project
      │         ├── columns: channel:270!null col_name:271!null cs_ext_sales_price:203 item.i_category:228 date_dim.d_year:246 date_dim.d_qoy:250
      │         ├── fd: ()-->(270,271)
      │         ├── inner-join (hash)
      │         │    ├── columns: cs_sold_date_sk:180!null cs_bill_customer_sk:183 cs_item_sk:195!null cs_ext_sales_price:203 i_item_sk:216!null item.i_category:228 d_date_sk:240!null date_dim.d_year:246 date_dim.d_qoy:250
      │         │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      │         │    ├── fd: ()-->(183), (216)-->(228), (240)-->(246,250), (195)==(216), (216)==(195), (180)==(240), (240)==(180)
      │         │    ├── scan date_dim
      │         │    │    ├── columns: d_date_sk:240!null date_dim.d_year:246 date_dim.d_qoy:250
      │         │    │    ├── key: (240)
      │         │    │    └── fd: (240)-->(246,250)
      │         │    ├── inner-join (merge)
      │         │    │    ├── columns: cs_sold_date_sk:180 cs_bill_customer_sk:183 cs_item_sk:195!null cs_ext_sales_price:203 i_item_sk:216!null item.i_category:228
      │         │    │    ├── left ordering: +216
      │         │    │    ├── right ordering: +195
      │         │    │    ├── fd: ()-->(183), (216)-->(228), (195)==(216), (216)==(195)
      │         │    │    ├── scan item
      │         │    │    │    ├── columns: i_item_sk:216!null item.i_category:228
      │         │    │    │    ├── key: (216)
      │         │    │    │    ├── fd: (216)-->(228)
      │         │    │    │    └── ordering: +216
      │         │    │    ├── select
      │         │    │    │    ├── columns: cs_sold_date_sk:180 cs_bill_customer_sk:183 cs_item_sk:195!null cs_ext_sales_price:203
      │         │    │    │    ├── fd: ()-->(183)
      │         │    │    │    ├── ordering: +195 opt(183) [actual: +195]
      │         │    │    │    ├── scan catalog_sales
      │         │    │    │    │    ├── columns: cs_sold_date_sk:180 cs_bill_customer_sk:183 cs_item_sk:195!null cs_ext_sales_price:203
      │         │    │    │    │    └── ordering: +195
      │         │    │    │    └── filters
      │         │    │    │         └── cs_bill_customer_sk:183 IS NULL [outer=(183), constraints=(/183: [/NULL - /NULL]; tight), fd=()-->(183)]
      │         │    │    └── filters (true)
      │         │    └── filters
      │         │         └── cs_sold_date_sk:180 = d_date_sk:240 [outer=(180,240), constraints=(/180: (/NULL - ]; /240: (/NULL - ]), fd=(180)==(240), (240)==(180)]
      │         └── projections
      │              ├── 'catalog' [as=channel:270]
      │              └── 'cs_bill_customer_sk' [as=col_name:271]
      └── aggregations
           ├── count-rows [as=count_rows:278]
           └── sum [as=sum:279, outer=(277)]
                └── ext_sales_price:277

# --------------------------------------------------
# Q77
# NOTE: Added conversion of 30 days to an interval.
# TODO: adjust the query to work with CRDB.
# opt
# 	WITH
# 		ss
# 			AS (
# 				SELECT
# 					s_store_sk,
# 					sum(ss_ext_sales_price) AS sales,
# 					sum(ss_net_profit) AS profit
# 				FROM
# 					store_sales, date_dim, store
# 				WHERE
# 					ss_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 					AND ss_store_sk = s_store_sk
# 				GROUP BY
# 					s_store_sk
# 			),
# 		sr
# 			AS (
# 				SELECT
# 					s_store_sk,
# 					sum(sr_return_amt) AS returns,
# 					sum(sr_net_loss) AS profit_loss
# 				FROM
# 					store_returns, date_dim, store
# 				WHERE
# 					sr_returned_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 					AND sr_store_sk = s_store_sk
# 				GROUP BY
# 					s_store_sk
# 			),
# 		cs
# 			AS (
# 				SELECT
# 					cs_call_center_sk,
# 					sum(cs_ext_sales_price) AS sales,
# 					sum(cs_net_profit) AS profit
# 				FROM
# 					catalog_sales, date_dim
# 				WHERE
# 					cs_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 				GROUP BY
# 					cs_call_center_sk
# 			),
# 		cr
# 			AS (
# 				SELECT
# 					cr_call_center_sk,
# 					sum(cr_return_amount) AS returns,
# 					sum(cr_net_loss) AS profit_loss
# 				FROM
# 					catalog_returns, date_dim
# 				WHERE
# 					cr_returned_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 				GROUP BY
# 					cr_call_center_sk
# 			),
# 		ws
# 			AS (
# 				SELECT
# 					wp_web_page_sk,
# 					sum(ws_ext_sales_price) AS sales,
# 					sum(ws_net_profit) AS profit
# 				FROM
# 					web_sales, date_dim, web_page
# 				WHERE
# 					ws_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 					AND ws_web_page_sk = wp_web_page_sk
# 				GROUP BY
# 					wp_web_page_sk
# 			),
# 		wr
# 			AS (
# 				SELECT
# 					wp_web_page_sk,
# 					sum(wr_return_amt) AS returns,
# 					sum(wr_net_loss) AS profit_loss
# 				FROM
# 					web_returns, date_dim, web_page
# 				WHERE
# 					wr_returned_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2000-08-10' AS DATE) AND (CAST('2000-08-10' AS DATE) + '30 days'::INTERVAL)
# 					AND wr_web_page_sk = wp_web_page_sk
# 				GROUP BY
# 					wp_web_page_sk
# 			)
# 	SELECT
# 		channel,
# 		id,
# 		sum(sales) AS sales,
# 		sum(returns) AS returns,
# 		sum(profit) AS profit
# 	FROM
# 		(
# 			SELECT
# 				'store channel' AS channel,
# 				ss.s_store_sk AS id,
# 				sales,
# 				COALESCE(returns, 0) AS returns,
# 				profit - COALESCE(profit_loss, 0) AS profit
# 			FROM
# 				ss LEFT JOIN sr ON ss.s_store_sk = sr.s_store_sk
# 			UNION ALL
# 				SELECT
# 					'catalog channel' AS channel,
# 					cs_call_center_sk AS id,
# 					sales,
# 					returns,
# 					profit - profit_loss AS profit
# 				FROM
# 					cs, cr
# 			UNION ALL
# 				SELECT
# 					'web channel' AS channel,
# 					ws.wp_web_page_sk AS id,
# 					sales,
# 					COALESCE(returns, 0) AS returns,
# 					profit - COALESCE(profit_loss, 0) AS profit
# 				FROM
# 					ws
# 					LEFT JOIN wr ON
# 							ws.wp_web_page_sk
# 							= wr.wp_web_page_sk
# 		)
# 			AS x
# 	GROUP BY
# 		rollup(channel, id)
# 	ORDER BY
# 		channel, id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q78
opt
	WITH
		ws
			AS (
				SELECT
					d_year AS ws_sold_year,
					ws_item_sk,
					ws_bill_customer_sk AS ws_customer_sk,
					sum(ws_quantity) AS ws_qty,
					sum(ws_wholesale_cost) AS ws_wc,
					sum(ws_sales_price) AS ws_sp
				FROM
					web_sales
					LEFT JOIN web_returns ON
							wr_order_number = ws_order_number
							AND ws_item_sk = wr_item_sk
					JOIN date_dim ON ws_sold_date_sk = d_date_sk
				WHERE
					wr_order_number IS NULL
				GROUP BY
					d_year, ws_item_sk, ws_bill_customer_sk
			),
		cs
			AS (
				SELECT
					d_year AS cs_sold_year,
					cs_item_sk,
					cs_bill_customer_sk AS cs_customer_sk,
					sum(cs_quantity) AS cs_qty,
					sum(cs_wholesale_cost) AS cs_wc,
					sum(cs_sales_price) AS cs_sp
				FROM
					catalog_sales
					LEFT JOIN catalog_returns ON
							cr_order_number = cs_order_number
							AND cs_item_sk = cr_item_sk
					JOIN date_dim ON cs_sold_date_sk = d_date_sk
				WHERE
					cr_order_number IS NULL
				GROUP BY
					d_year, cs_item_sk, cs_bill_customer_sk
			),
		ss
			AS (
				SELECT
					d_year AS ss_sold_year,
					ss_item_sk,
					ss_customer_sk,
					sum(ss_quantity) AS ss_qty,
					sum(ss_wholesale_cost) AS ss_wc,
					sum(ss_sales_price) AS ss_sp
				FROM
					store_sales
					LEFT JOIN store_returns ON
							sr_ticket_number = ss_ticket_number
							AND ss_item_sk = sr_item_sk
					JOIN date_dim ON ss_sold_date_sk = d_date_sk
				WHERE
					sr_ticket_number IS NULL
				GROUP BY
					d_year, ss_item_sk, ss_customer_sk
			)
	SELECT
		ss_customer_sk,
		round(
			ss_qty
			/ (COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0)),
			2
		)
			AS ratio,
		ss_qty AS store_qty,
		ss_wc AS store_wholesale_cost,
		ss_sp AS store_sales_price,
		COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0)
			AS other_chan_qty,
		COALESCE(ws_wc, 0) + COALESCE(cs_wc, 0)
			AS other_chan_wholesale_cost,
		COALESCE(ws_sp, 0) + COALESCE(cs_sp, 0)
			AS other_chan_sales_price
	FROM
		ss
		LEFT JOIN ws ON
				ws_sold_year = ss_sold_year
				AND ws_item_sk = ss_item_sk
				AND ws_customer_sk = ss_customer_sk
		LEFT JOIN cs ON
				cs_sold_year = ss_sold_year
				AND cs_item_sk = ss_item_sk
				AND cs_customer_sk = ss_customer_sk
	WHERE
		(COALESCE(ws_qty, 0) > 0 OR COALESCE(cs_qty, 0) > 0)
		AND ss_sold_year = 1998
	ORDER BY
		ss_customer_sk,
		ss_qty DESC,
		ss_wc DESC,
		ss_sp DESC,
		other_chan_qty,
		other_chan_wholesale_cost,
		other_chan_sales_price,
		ratio
	LIMIT
		100;
----
top-k
 ├── columns: ss_customer_sk:276 ratio:292 store_qty:277 store_wholesale_cost:278 store_sales_price:279 other_chan_qty:293 other_chan_wholesale_cost:294 other_chan_sales_price:295
 ├── internal-ordering: +276,-277,-278,-279,+293,+294,+295,+292
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +276,-277,-278,-279,+293,+294,+295,+292
 └── project
      ├── columns: ratio:292 other_chan_qty:293 other_chan_wholesale_cost:294 other_chan_sales_price:295 ss_customer_sk:276 ss_qty:277 ss_wc:278 ss_sp:279
      ├── immutable
      ├── project
      │    ├── columns: ss_customer_sk:276 ss_qty:277 ss_wc:278 ss_sp:279 cs_qty:289 cs_wc:290 cs_sp:291 ws_qty:283 ws_wc:284 ws_sp:285
      │    ├── immutable
      │    ├── select
      │    │    ├── columns: web_sales.ws_item_sk:4 ws_bill_customer_sk:5 d_year:69 sum:93 sum:94 sum:95 cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111 d_year:167 sum:191 sum:192 sum:193 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 d_year:247!null sum:271 sum:272 sum:273
      │    │    ├── immutable
      │    │    ├── key: (196,197)
      │    │    ├── fd: ()-->(247), (196,197)-->(4,5,69,93-95,99,111,167,191-193,271-273), (4,5)-->(69,93-95), (99,111)-->(167,191-193)
      │    │    ├── left-join (hash)
      │    │    │    ├── columns: web_sales.ws_item_sk:4 ws_bill_customer_sk:5 d_year:69 sum:93 sum:94 sum:95 cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111 d_year:167 sum:191 sum:192 sum:193 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 d_year:247!null sum:271 sum:272 sum:273
      │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-one)
      │    │    │    ├── key: (196,197)
      │    │    │    ├── fd: ()-->(247), (196,197)-->(4,5,69,93-95,99,111,167,191-193,271-273), (4,5)-->(69,93-95), (99,111)-->(167,191-193)
      │    │    │    ├── left-join (hash)
      │    │    │    │    ├── columns: web_sales.ws_item_sk:4 ws_bill_customer_sk:5 d_year:69 sum:93 sum:94 sum:95 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 d_year:247!null sum:271 sum:272 sum:273
      │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-one)
      │    │    │    │    ├── key: (196,197)
      │    │    │    │    ├── fd: ()-->(247), (196,197)-->(4,5,69,93-95,271-273), (4,5)-->(69,93-95)
      │    │    │    │    ├── group-by (hash)
      │    │    │    │    │    ├── columns: store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 d_year:247!null sum:271 sum:272 sum:273
      │    │    │    │    │    ├── grouping columns: store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197
      │    │    │    │    │    ├── key: (196,197)
      │    │    │    │    │    ├── fd: ()-->(247), (196,197)-->(247,271-273)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: ss_sold_date_sk:194!null store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 ss_ticket_number:203!null ss_quantity:204 ss_wholesale_cost:205 ss_sales_price:207 sr_item_sk:221 sr_ticket_number:228 d_date_sk:241!null d_year:247!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── key: (196,203)
      │    │    │    │    │    │    ├── fd: ()-->(228,247), (196,203)-->(194,197,204,205,207,221), (194)==(241), (241)==(194)
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:194 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 ss_ticket_number:203!null ss_quantity:204 ss_wholesale_cost:205 ss_sales_price:207 sr_item_sk:221 sr_ticket_number:228
      │    │    │    │    │    │    │    ├── key: (196,203)
      │    │    │    │    │    │    │    ├── fd: ()-->(228), (196,203)-->(194,197,204,205,207,221)
      │    │    │    │    │    │    │    ├── left-join (merge)
      │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:194 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 ss_ticket_number:203!null ss_quantity:204 ss_wholesale_cost:205 ss_sales_price:207 sr_item_sk:221 sr_ticket_number:228
      │    │    │    │    │    │    │    │    ├── left ordering: +196,+203
      │    │    │    │    │    │    │    │    ├── right ordering: +221,+228
      │    │    │    │    │    │    │    │    ├── key: (196,203)
      │    │    │    │    │    │    │    │    ├── fd: (196,203)-->(194,197,204,205,207,221,228)
      │    │    │    │    │    │    │    │    ├── scan store_sales
      │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_date_sk:194 store_sales.ss_item_sk:196!null store_sales.ss_customer_sk:197 ss_ticket_number:203!null ss_quantity:204 ss_wholesale_cost:205 ss_sales_price:207
      │    │    │    │    │    │    │    │    │    ├── key: (196,203)
      │    │    │    │    │    │    │    │    │    ├── fd: (196,203)-->(194,197,204,205,207)
      │    │    │    │    │    │    │    │    │    └── ordering: +196,+203
      │    │    │    │    │    │    │    │    ├── scan store_returns
      │    │    │    │    │    │    │    │    │    ├── columns: sr_item_sk:221!null sr_ticket_number:228!null
      │    │    │    │    │    │    │    │    │    ├── key: (221,228)
      │    │    │    │    │    │    │    │    │    └── ordering: +221,+228
      │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── sr_ticket_number:228 IS NULL [outer=(228), constraints=(/228: [/NULL - /NULL]; tight), fd=()-->(228)]
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:241!null d_year:247!null
      │    │    │    │    │    │    │    ├── key: (241)
      │    │    │    │    │    │    │    ├── fd: ()-->(247)
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:241!null d_year:247
      │    │    │    │    │    │    │    │    ├── key: (241)
      │    │    │    │    │    │    │    │    └── fd: (241)-->(247)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── d_year:247 = 1998 [outer=(247), constraints=(/247: [/1998 - /1998]; tight), fd=()-->(247)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ss_sold_date_sk:194 = d_date_sk:241 [outer=(194,241), constraints=(/194: (/NULL - ]; /241: (/NULL - ]), fd=(194)==(241), (241)==(194)]
      │    │    │    │    │    └── aggregations
      │    │    │    │    │         ├── sum [as=sum:271, outer=(204)]
      │    │    │    │    │         │    └── ss_quantity:204
      │    │    │    │    │         ├── sum [as=sum:272, outer=(205)]
      │    │    │    │    │         │    └── ss_wholesale_cost:205
      │    │    │    │    │         ├── sum [as=sum:273, outer=(207)]
      │    │    │    │    │         │    └── ss_sales_price:207
      │    │    │    │    │         └── const-agg [as=d_year:247, outer=(247)]
      │    │    │    │    │              └── d_year:247
      │    │    │    │    ├── group-by (hash)
      │    │    │    │    │    ├── columns: web_sales.ws_item_sk:4!null ws_bill_customer_sk:5 d_year:69!null sum:93 sum:94 sum:95
      │    │    │    │    │    ├── grouping columns: web_sales.ws_item_sk:4!null ws_bill_customer_sk:5
      │    │    │    │    │    ├── key: (4,5)
      │    │    │    │    │    ├── fd: ()-->(69), (4,5)-->(69,93-95)
      │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1!null web_sales.ws_item_sk:4!null ws_bill_customer_sk:5 ws_order_number:18!null ws_quantity:19 ws_wholesale_cost:20 ws_sales_price:22 wr_item_sk:39 wr_order_number:50 d_date_sk:63!null d_year:69!null
      │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    ├── key: (4,18)
      │    │    │    │    │    │    ├── fd: ()-->(50,69), (4,18)-->(1,5,19,20,22,39), (1)==(63), (63)==(1)
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 web_sales.ws_item_sk:4!null ws_bill_customer_sk:5 ws_order_number:18!null ws_quantity:19 ws_wholesale_cost:20 ws_sales_price:22 wr_item_sk:39 wr_order_number:50
      │    │    │    │    │    │    │    ├── key: (4,18)
      │    │    │    │    │    │    │    ├── fd: ()-->(50), (4,18)-->(1,5,19,20,22,39)
      │    │    │    │    │    │    │    ├── left-join (merge)
      │    │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 web_sales.ws_item_sk:4!null ws_bill_customer_sk:5 ws_order_number:18!null ws_quantity:19 ws_wholesale_cost:20 ws_sales_price:22 wr_item_sk:39 wr_order_number:50
      │    │    │    │    │    │    │    │    ├── left ordering: +4,+18
      │    │    │    │    │    │    │    │    ├── right ordering: +39,+50
      │    │    │    │    │    │    │    │    ├── key: (4,18)
      │    │    │    │    │    │    │    │    ├── fd: (4,18)-->(1,5,19,20,22,39,50)
      │    │    │    │    │    │    │    │    ├── scan web_sales
      │    │    │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 web_sales.ws_item_sk:4!null ws_bill_customer_sk:5 ws_order_number:18!null ws_quantity:19 ws_wholesale_cost:20 ws_sales_price:22
      │    │    │    │    │    │    │    │    │    ├── key: (4,18)
      │    │    │    │    │    │    │    │    │    ├── fd: (4,18)-->(1,5,19,20,22)
      │    │    │    │    │    │    │    │    │    └── ordering: +4,+18
      │    │    │    │    │    │    │    │    ├── scan web_returns
      │    │    │    │    │    │    │    │    │    ├── columns: wr_item_sk:39!null wr_order_number:50!null
      │    │    │    │    │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    │    │    │    │    └── ordering: +39,+50
      │    │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── wr_order_number:50 IS NULL [outer=(50), constraints=(/50: [/NULL - /NULL]; tight), fd=()-->(50)]
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: d_date_sk:63!null d_year:69!null
      │    │    │    │    │    │    │    ├── key: (63)
      │    │    │    │    │    │    │    ├── fd: ()-->(69)
      │    │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    │    ├── columns: d_date_sk:63!null d_year:69
      │    │    │    │    │    │    │    │    ├── key: (63)
      │    │    │    │    │    │    │    │    └── fd: (63)-->(69)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── d_year:69 = 1998 [outer=(69), constraints=(/69: [/1998 - /1998]; tight), fd=()-->(69)]
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── ws_sold_date_sk:1 = d_date_sk:63 [outer=(1,63), constraints=(/1: (/NULL - ]; /63: (/NULL - ]), fd=(1)==(63), (63)==(1)]
      │    │    │    │    │    └── aggregations
      │    │    │    │    │         ├── sum [as=sum:93, outer=(19)]
      │    │    │    │    │         │    └── ws_quantity:19
      │    │    │    │    │         ├── sum [as=sum:94, outer=(20)]
      │    │    │    │    │         │    └── ws_wholesale_cost:20
      │    │    │    │    │         ├── sum [as=sum:95, outer=(22)]
      │    │    │    │    │         │    └── ws_sales_price:22
      │    │    │    │    │         └── const-agg [as=d_year:69, outer=(69)]
      │    │    │    │    │              └── d_year:69
      │    │    │    │    └── filters
      │    │    │    │         ├── d_year:69 = d_year:247 [outer=(69,247), constraints=(/69: (/NULL - ]; /247: (/NULL - ]), fd=(69)==(247), (247)==(69)]
      │    │    │    │         ├── web_sales.ws_item_sk:4 = store_sales.ss_item_sk:196 [outer=(4,196), constraints=(/4: (/NULL - ]; /196: (/NULL - ]), fd=(4)==(196), (196)==(4)]
      │    │    │    │         └── ws_bill_customer_sk:5 = store_sales.ss_customer_sk:197 [outer=(5,197), constraints=(/5: (/NULL - ]; /197: (/NULL - ]), fd=(5)==(197), (197)==(5)]
      │    │    │    ├── group-by (hash)
      │    │    │    │    ├── columns: cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null d_year:167!null sum:191 sum:192 sum:193
      │    │    │    │    ├── grouping columns: cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null
      │    │    │    │    ├── key: (99,111)
      │    │    │    │    ├── fd: ()-->(167), (99,111)-->(167,191-193)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: cs_sold_date_sk:96!null cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null cs_order_number:113!null cs_quantity:114 cs_wholesale_cost:115 cs_sales_price:117 cr_item_sk:134 cr_order_number:148 d_date_sk:161!null d_year:167!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── key: (111,113)
      │    │    │    │    │    ├── fd: ()-->(148,167), (111,113)-->(96,99,114,115,117,134), (96)==(161), (161)==(96)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: cs_sold_date_sk:96 cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null cs_order_number:113!null cs_quantity:114 cs_wholesale_cost:115 cs_sales_price:117 cr_item_sk:134 cr_order_number:148
      │    │    │    │    │    │    ├── key: (111,113)
      │    │    │    │    │    │    ├── fd: ()-->(148), (111,113)-->(96,99,114,115,117,134)
      │    │    │    │    │    │    ├── left-join (merge)
      │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:96 cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null cs_order_number:113!null cs_quantity:114 cs_wholesale_cost:115 cs_sales_price:117 cr_item_sk:134 cr_order_number:148
      │    │    │    │    │    │    │    ├── left ordering: +111,+113
      │    │    │    │    │    │    │    ├── right ordering: +134,+148
      │    │    │    │    │    │    │    ├── key: (111,113)
      │    │    │    │    │    │    │    ├── fd: (111,113)-->(96,99,114,115,117,134,148)
      │    │    │    │    │    │    │    ├── scan catalog_sales
      │    │    │    │    │    │    │    │    ├── columns: cs_sold_date_sk:96 cs_bill_customer_sk:99 catalog_sales.cs_item_sk:111!null cs_order_number:113!null cs_quantity:114 cs_wholesale_cost:115 cs_sales_price:117
      │    │    │    │    │    │    │    │    ├── key: (111,113)
      │    │    │    │    │    │    │    │    ├── fd: (111,113)-->(96,99,114,115,117)
      │    │    │    │    │    │    │    │    └── ordering: +111,+113
      │    │    │    │    │    │    │    ├── scan catalog_returns
      │    │    │    │    │    │    │    │    ├── columns: cr_item_sk:134!null cr_order_number:148!null
      │    │    │    │    │    │    │    │    ├── key: (134,148)
      │    │    │    │    │    │    │    │    └── ordering: +134,+148
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── cr_order_number:148 IS NULL [outer=(148), constraints=(/148: [/NULL - /NULL]; tight), fd=()-->(148)]
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:161!null d_year:167!null
      │    │    │    │    │    │    ├── key: (161)
      │    │    │    │    │    │    ├── fd: ()-->(167)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:161!null d_year:167
      │    │    │    │    │    │    │    ├── key: (161)
      │    │    │    │    │    │    │    └── fd: (161)-->(167)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── d_year:167 = 1998 [outer=(167), constraints=(/167: [/1998 - /1998]; tight), fd=()-->(167)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── cs_sold_date_sk:96 = d_date_sk:161 [outer=(96,161), constraints=(/96: (/NULL - ]; /161: (/NULL - ]), fd=(96)==(161), (161)==(96)]
      │    │    │    │    └── aggregations
      │    │    │    │         ├── sum [as=sum:191, outer=(114)]
      │    │    │    │         │    └── cs_quantity:114
      │    │    │    │         ├── sum [as=sum:192, outer=(115)]
      │    │    │    │         │    └── cs_wholesale_cost:115
      │    │    │    │         ├── sum [as=sum:193, outer=(117)]
      │    │    │    │         │    └── cs_sales_price:117
      │    │    │    │         └── const-agg [as=d_year:167, outer=(167)]
      │    │    │    │              └── d_year:167
      │    │    │    └── filters
      │    │    │         ├── d_year:167 = d_year:247 [outer=(167,247), constraints=(/167: (/NULL - ]; /247: (/NULL - ]), fd=(167)==(247), (247)==(167)]
      │    │    │         ├── catalog_sales.cs_item_sk:111 = store_sales.ss_item_sk:196 [outer=(111,196), constraints=(/111: (/NULL - ]; /196: (/NULL - ]), fd=(111)==(196), (196)==(111)]
      │    │    │         └── cs_bill_customer_sk:99 = store_sales.ss_customer_sk:197 [outer=(99,197), constraints=(/99: (/NULL - ]; /197: (/NULL - ]), fd=(99)==(197), (197)==(99)]
      │    │    └── filters
      │    │         └── (COALESCE(sum:93, 0) > 0) OR (COALESCE(sum:191, 0) > 0) [outer=(93,191), immutable]
      │    └── projections
      │         ├── store_sales.ss_customer_sk:197 [as=ss_customer_sk:276, outer=(197)]
      │         ├── sum:271 [as=ss_qty:277, outer=(271)]
      │         ├── sum:272 [as=ss_wc:278, outer=(272)]
      │         ├── sum:273 [as=ss_sp:279, outer=(273)]
      │         ├── sum:191 [as=cs_qty:289, outer=(191)]
      │         ├── sum:192 [as=cs_wc:290, outer=(192)]
      │         ├── sum:193 [as=cs_sp:291, outer=(193)]
      │         ├── sum:93 [as=ws_qty:283, outer=(93)]
      │         ├── sum:94 [as=ws_wc:284, outer=(94)]
      │         └── sum:95 [as=ws_sp:285, outer=(95)]
      └── projections
           ├── round(ss_qty:277 / (COALESCE(ws_qty:283, 0) + COALESCE(cs_qty:289, 0)), 2) [as=ratio:292, outer=(277,283,289), immutable]
           ├── COALESCE(ws_qty:283, 0) + COALESCE(cs_qty:289, 0) [as=other_chan_qty:293, outer=(283,289), immutable]
           ├── COALESCE(ws_wc:284, 0) + COALESCE(cs_wc:290, 0) [as=other_chan_wholesale_cost:294, outer=(284,290), immutable]
           └── COALESCE(ws_sp:285, 0) + COALESCE(cs_sp:291, 0) [as=other_chan_sales_price:295, outer=(285,291), immutable]

# --------------------------------------------------
# Q79
# NOTE: this query has been modified by appending one extra column to
# ORDER BY clause so that it had deterministic output.
opt
	SELECT
		c_last_name,
		c_first_name,
		substr(s_city, 1, 30),
		ss_ticket_number,
		amt,
		profit
	FROM
		(
			SELECT
				ss_ticket_number,
				ss_customer_sk,
				store.s_city,
				sum(ss_coupon_amt) AS amt,
				sum(ss_net_profit) AS profit
			FROM
				store_sales,
				date_dim,
				store,
				household_demographics
			WHERE
				store_sales.ss_sold_date_sk = date_dim.d_date_sk
				AND store_sales.ss_store_sk = store.s_store_sk
				AND store_sales.ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND (
						household_demographics.hd_dep_count = 7
						OR household_demographics.hd_vehicle_count
							> -1
					)
				AND date_dim.d_dow = 1
				AND date_dim.d_year
					IN (2000, 2000 + 1, 2000 + 2)
				AND store.s_number_employees BETWEEN 200 AND 295
			GROUP BY
				ss_ticket_number,
				ss_customer_sk,
				ss_addr_sk,
				store.s_city
		)
			AS ms,
		customer
	WHERE
		ss_customer_sk = c_customer_sk
	ORDER BY
		c_last_name, c_first_name, substr(s_city, 1, 30), profit, ss_ticket_number
	LIMIT
		100;
----
top-k
 ├── columns: c_last_name:105 c_first_name:104 substr:116 ss_ticket_number:10!null amt:94 profit:95
 ├── internal-ordering: +105,+104,+116,+95,+10
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +105,+104,+116,+95,+10
 └── project
      ├── columns: substr:116 ss_ticket_number:10!null sum:94 sum:95 c_first_name:104 c_last_name:105
      ├── immutable
      ├── inner-join (hash)
      │    ├── columns: ss_customer_sk:4!null ss_addr_sk:7 ss_ticket_number:10!null s_city:78 sum:94 sum:95 c_customer_sk:96!null c_first_name:104 c_last_name:105
      │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    ├── key: (7,10,78,96)
      │    ├── fd: (4,7,10,78)-->(94,95), (96)-->(104,105), (4)==(96), (96)==(4)
      │    ├── group-by (hash)
      │    │    ├── columns: ss_customer_sk:4 ss_addr_sk:7 ss_ticket_number:10!null s_city:78 sum:94 sum:95
      │    │    ├── grouping columns: ss_customer_sk:4 ss_addr_sk:7 ss_ticket_number:10!null s_city:78
      │    │    ├── key: (4,7,10,78)
      │    │    ├── fd: (4,7,10,78)-->(94,95)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8!null ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null s_store_sk:56!null s_number_employees:62!null s_city:78 hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: ()-->(33), (26)-->(32), (56)-->(62,78), (87)-->(90,91), (1)==(26), (26)==(1), (8)==(56), (56)==(8), (6)==(87), (87)==(6)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6!null ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(33), (26)-->(32), (87)-->(90,91), (6)==(87), (87)==(6), (1)==(26), (26)==(1)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23 d_date_sk:26!null d_year:32!null d_dow:33!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: ()-->(33), (26)-->(32), (1)==(26), (26)==(1)
      │    │    │    │    │    ├── scan store_sales
      │    │    │    │    │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4 ss_hdemo_sk:6 ss_addr_sk:7 ss_store_sk:8 ss_ticket_number:10!null ss_coupon_amt:20 ss_net_profit:23
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32!null d_dow:33!null
      │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    ├── fd: ()-->(33), (26)-->(32)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:26!null d_year:32 d_dow:33
      │    │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    │    └── fd: (26)-->(32,33)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         ├── d_dow:33 = 1 [outer=(33), constraints=(/33: [/1 - /1]; tight), fd=()-->(33)]
      │    │    │    │    │    │         └── d_year:32 IN (2000, 2001, 2002) [outer=(32), constraints=(/32: [/2000 - /2000] [/2001 - /2001] [/2002 - /2002]; tight)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │    │    │    │    ├── key: (87)
      │    │    │    │    │    ├── fd: (87)-->(90,91)
      │    │    │    │    │    ├── scan household_demographics
      │    │    │    │    │    │    ├── columns: hd_demo_sk:87!null hd_dep_count:90 hd_vehicle_count:91
      │    │    │    │    │    │    ├── key: (87)
      │    │    │    │    │    │    └── fd: (87)-->(90,91)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── (hd_dep_count:90 = 7) OR (hd_vehicle_count:91 > -1) [outer=(90,91)]
      │    │    │    │    └── filters
      │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:87 [outer=(6,87), constraints=(/6: (/NULL - ]; /87: (/NULL - ]), fd=(6)==(87), (87)==(6)]
      │    │    │    ├── select
      │    │    │    │    ├── columns: s_store_sk:56!null s_number_employees:62!null s_city:78
      │    │    │    │    ├── key: (56)
      │    │    │    │    ├── fd: (56)-->(62,78)
      │    │    │    │    ├── scan store
      │    │    │    │    │    ├── columns: s_store_sk:56!null s_number_employees:62 s_city:78
      │    │    │    │    │    ├── key: (56)
      │    │    │    │    │    └── fd: (56)-->(62,78)
      │    │    │    │    └── filters
      │    │    │    │         └── (s_number_employees:62 >= 200) AND (s_number_employees:62 <= 295) [outer=(62), constraints=(/62: [/200 - /295]; tight)]
      │    │    │    └── filters
      │    │    │         └── ss_store_sk:8 = s_store_sk:56 [outer=(8,56), constraints=(/8: (/NULL - ]; /56: (/NULL - ]), fd=(8)==(56), (56)==(8)]
      │    │    └── aggregations
      │    │         ├── sum [as=sum:94, outer=(20)]
      │    │         │    └── ss_coupon_amt:20
      │    │         └── sum [as=sum:95, outer=(23)]
      │    │              └── ss_net_profit:23
      │    ├── scan customer
      │    │    ├── columns: c_customer_sk:96!null c_first_name:104 c_last_name:105
      │    │    ├── key: (96)
      │    │    └── fd: (96)-->(104,105)
      │    └── filters
      │         └── ss_customer_sk:4 = c_customer_sk:96 [outer=(4,96), constraints=(/4: (/NULL - ]; /96: (/NULL - ]), fd=(4)==(96), (96)==(4)]
      └── projections
           └── substr(s_city:78, 1, 30) [as=substr:116, outer=(78), immutable]

# --------------------------------------------------
# Q80
# NOTE: Added conversion of 30 days to an interval.
# TODO: adjust the query to work with CRDB.
# opt
# 	WITH
# 		ssr
# 			AS (
# 				SELECT
# 					s_store_id AS store_id,
# 					sum(ss_ext_sales_price) AS sales,
# 					sum(COALESCE(sr_return_amt, 0)) AS returns,
# 					sum(
# 						ss_net_profit - COALESCE(sr_net_loss, 0)
# 					)
# 						AS profit
# 				FROM
# 					store_sales
# 					LEFT JOIN store_returns ON
# 							ss_item_sk = sr_item_sk
# 							AND ss_ticket_number
# 								= sr_ticket_number,
# 					date_dim,
# 					store,
# 					item,
# 					promotion
# 				WHERE
# 					ss_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2002-08-14' AS DATE) AND (CAST('2002-08-14' AS DATE) + '30 days'::INTERVAL)
# 					AND ss_store_sk = s_store_sk
# 					AND ss_item_sk = i_item_sk
# 					AND i_current_price > 50
# 					AND ss_promo_sk = p_promo_sk
# 					AND p_channel_tv = 'N'
# 				GROUP BY
# 					s_store_id
# 			),
# 		csr
# 			AS (
# 				SELECT
# 					cp_catalog_page_id AS catalog_page_id,
# 					sum(cs_ext_sales_price) AS sales,
# 					sum(COALESCE(cr_return_amount, 0))
# 						AS returns,
# 					sum(
# 						cs_net_profit - COALESCE(cr_net_loss, 0)
# 					)
# 						AS profit
# 				FROM
# 					catalog_sales
# 					LEFT JOIN catalog_returns ON
# 							cs_item_sk = cr_item_sk
# 							AND cs_order_number
# 								= cr_order_number,
# 					date_dim,
# 					catalog_page,
# 					item,
# 					promotion
# 				WHERE
# 					cs_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2002-08-14' AS DATE) AND (CAST('2002-08-14' AS DATE) + '30 days'::INTERVAL)
# 					AND cs_catalog_page_sk = cp_catalog_page_sk
# 					AND cs_item_sk = i_item_sk
# 					AND i_current_price > 50
# 					AND cs_promo_sk = p_promo_sk
# 					AND p_channel_tv = 'N'
# 				GROUP BY
# 					cp_catalog_page_id
# 			),
# 		wsr
# 			AS (
# 				SELECT
# 					web_site_id,
# 					sum(ws_ext_sales_price) AS sales,
# 					sum(COALESCE(wr_return_amt, 0)) AS returns,
# 					sum(
# 						ws_net_profit - COALESCE(wr_net_loss, 0)
# 					)
# 						AS profit
# 				FROM
# 					web_sales
# 					LEFT JOIN web_returns ON
# 							ws_item_sk = wr_item_sk
# 							AND ws_order_number
# 								= wr_order_number,
# 					date_dim,
# 					web_site,
# 					item,
# 					promotion
# 				WHERE
# 					ws_sold_date_sk = d_date_sk
# 					AND d_date BETWEEN CAST('2002-08-14' AS DATE) AND (CAST('2002-08-14' AS DATE) + '30 days'::INTERVAL)
# 					AND ws_web_site_sk = web_site_sk
# 					AND ws_item_sk = i_item_sk
# 					AND i_current_price > 50
# 					AND ws_promo_sk = p_promo_sk
# 					AND p_channel_tv = 'N'
# 				GROUP BY
# 					web_site_id
# 			)
# 	SELECT
# 		channel,
# 		id,
# 		sum(sales) AS sales,
# 		sum(returns) AS returns,
# 		sum(profit) AS profit
# 	FROM
# 		(
# 			SELECT
# 				'store channel' AS channel,
# 				'store' || store_id AS id,
# 				sales,
# 				returns,
# 				profit
# 			FROM
# 				ssr
# 			UNION ALL
# 				SELECT
# 					'catalog channel' AS channel,
# 					'catalog_page' || catalog_page_id AS id,
# 					sales,
# 					returns,
# 					profit
# 				FROM
# 					csr
# 			UNION ALL
# 				SELECT
# 					'web channel' AS channel,
# 					'web_site' || web_site_id AS id,
# 					sales,
# 					returns,
# 					profit
# 				FROM
# 					wsr
# 		)
# 			AS x
# 	GROUP BY
# 		rollup(channel, id)
# 	ORDER BY
# 		channel, id
# 	LIMIT
# 		100;
# ----

# --------------------------------------------------
# Q81
opt
	WITH
		customer_total_return
			AS (
				SELECT
					cr_returning_customer_sk AS ctr_customer_sk,
					ca_state AS ctr_state,
					sum(cr_return_amt_inc_tax)
						AS ctr_total_return
				FROM
					catalog_returns, date_dim, customer_address
				WHERE
					cr_returned_date_sk = d_date_sk
					AND d_year = 2001
					AND cr_returning_addr_sk = ca_address_sk
				GROUP BY
					cr_returning_customer_sk, ca_state
			)
	SELECT
		c_customer_id,
		c_salutation,
		c_first_name,
		c_last_name,
		ca_street_number,
		ca_street_name,
		ca_street_type,
		ca_suite_number,
		ca_city,
		ca_county,
		ca_state,
		ca_zip,
		ca_country,
		ca_gmt_offset,
		ca_location_type,
		ctr_total_return
	FROM
		customer_total_return AS ctr1,
		customer_address,
		customer
	WHERE
		ctr1.ctr_total_return
		> (
				SELECT
					avg(ctr_total_return) * 1.2
				FROM
					customer_total_return AS ctr2
				WHERE
					ctr1.ctr_state = ctr2.ctr_state
			)
		AND ca_address_sk = c_current_addr_sk
		AND ca_state = 'TN'
		AND ctr1.ctr_customer_sk = c_customer_sk
	ORDER BY
		c_customer_id,
		c_salutation,
		c_first_name,
		c_last_name,
		ca_street_number,
		ca_street_name,
		ca_street_type,
		ca_suite_number,
		ca_city,
		ca_county,
		ca_state,
		ca_zip,
		ca_country,
		ca_gmt_offset,
		ca_location_type,
		ctr_total_return
	LIMIT
		100;
----
with &1 (customer_total_return)
 ├── columns: c_customer_id:95!null c_salutation:101 c_first_name:102 c_last_name:103 ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87!null ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91 ctr_total_return:78!null
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── fd: ()-->(87)
 ├── ordering: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78 opt(87) [actual: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78]
 ├── group-by (hash)
 │    ├── columns: cr_returning_customer_sk:8 ca_state:68 sum:75
 │    ├── grouping columns: cr_returning_customer_sk:8 ca_state:68
 │    ├── key: (8,68)
 │    ├── fd: (8,68)-->(75)
 │    ├── inner-join (hash)
 │    │    ├── columns: cr_returned_date_sk:1!null cr_returning_customer_sk:8 cr_returning_addr_sk:11!null cr_return_amt_inc_tax:21 d_date_sk:30!null d_year:36!null ca_address_sk:60!null ca_state:68
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── fd: ()-->(36), (60)-->(68), (1)==(30), (30)==(1), (11)==(60), (60)==(11)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: cr_returned_date_sk:1!null cr_returning_customer_sk:8 cr_returning_addr_sk:11 cr_return_amt_inc_tax:21 d_date_sk:30!null d_year:36!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(36), (1)==(30), (30)==(1)
 │    │    │    ├── scan catalog_returns
 │    │    │    │    └── columns: cr_returned_date_sk:1 cr_returning_customer_sk:8 cr_returning_addr_sk:11 cr_return_amt_inc_tax:21
 │    │    │    ├── select
 │    │    │    │    ├── columns: d_date_sk:30!null d_year:36!null
 │    │    │    │    ├── key: (30)
 │    │    │    │    ├── fd: ()-->(36)
 │    │    │    │    ├── scan date_dim
 │    │    │    │    │    ├── columns: d_date_sk:30!null d_year:36
 │    │    │    │    │    ├── key: (30)
 │    │    │    │    │    └── fd: (30)-->(36)
 │    │    │    │    └── filters
 │    │    │    │         └── d_year:36 = 2001 [outer=(36), constraints=(/36: [/2001 - /2001]; tight), fd=()-->(36)]
 │    │    │    └── filters
 │    │    │         └── cr_returned_date_sk:1 = d_date_sk:30 [outer=(1,30), constraints=(/1: (/NULL - ]; /30: (/NULL - ]), fd=(1)==(30), (30)==(1)]
 │    │    ├── scan customer_address
 │    │    │    ├── columns: ca_address_sk:60!null ca_state:68
 │    │    │    ├── key: (60)
 │    │    │    └── fd: (60)-->(68)
 │    │    └── filters
 │    │         └── cr_returning_addr_sk:11 = ca_address_sk:60 [outer=(11,60), constraints=(/11: (/NULL - ]; /60: (/NULL - ]), fd=(11)==(60), (60)==(11)]
 │    └── aggregations
 │         └── sum [as=sum:75, outer=(21)]
 │              └── cr_return_amt_inc_tax:21
 └── project
      ├── columns: ctr_total_return:78!null ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87!null ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91 c_customer_id:95!null c_salutation:101 c_first_name:102 c_last_name:103
      ├── cardinality: [0 - 100]
      ├── immutable
      ├── fd: ()-->(87)
      ├── ordering: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78 opt(87) [actual: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78]
      └── top-k
           ├── columns: ctr_customer_sk:76!null ctr_state:77!null ctr_total_return:78!null ca_address_sk:79!null ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87!null ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91 c_customer_sk:94!null c_customer_id:95!null c_current_addr_sk:98!null c_salutation:101 c_first_name:102 c_last_name:103 avg:117!null
           ├── internal-ordering: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78 opt(87)
           ├── k: 100
           ├── cardinality: [0 - 100]
           ├── immutable
           ├── key: (77,94)
           ├── fd: ()-->(87), (76,77)-->(78,117), (79)-->(81-86,88-91), (94)-->(95,98,101-103), (79)==(98), (98)==(79), (76)==(94), (94)==(76)
           ├── ordering: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78 opt(87) [actual: +95,+101,+102,+103,+81,+82,+83,+84,+85,+86,+88,+89,+90,+91,+78]
           └── inner-join (hash)
                ├── columns: ctr_customer_sk:76!null ctr_state:77!null ctr_total_return:78!null ca_address_sk:79!null ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87!null ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91 c_customer_sk:94!null c_customer_id:95!null c_current_addr_sk:98!null c_salutation:101 c_first_name:102 c_last_name:103 avg:117!null
                ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
                ├── immutable
                ├── key: (77,94)
                ├── fd: ()-->(87), (76,77)-->(78,117), (79)-->(81-86,88-91), (94)-->(95,98,101-103), (79)==(98), (98)==(79), (76)==(94), (94)==(76)
                ├── inner-join (lookup customer)
                │    ├── columns: ctr_customer_sk:76!null ctr_state:77!null ctr_total_return:78!null c_customer_sk:94!null c_customer_id:95!null c_current_addr_sk:98 c_salutation:101 c_first_name:102 c_last_name:103 avg:117!null
                │    ├── key columns: [76] = [94]
                │    ├── lookup columns are key
                │    ├── immutable
                │    ├── key: (77,94)
                │    ├── fd: (76,77)-->(78,117), (94)-->(95,98,101-103), (76)==(94), (94)==(76)
                │    ├── select
                │    │    ├── columns: ctr_customer_sk:76 ctr_state:77!null ctr_total_return:78!null avg:117!null
                │    │    ├── immutable
                │    │    ├── key: (76,77)
                │    │    ├── fd: (76,77)-->(78,117)
                │    │    ├── group-by (hash)
                │    │    │    ├── columns: ctr_customer_sk:76 ctr_state:77!null ctr_total_return:78 avg:117!null
                │    │    │    ├── grouping columns: ctr_customer_sk:76 ctr_state:77!null
                │    │    │    ├── immutable
                │    │    │    ├── key: (76,77)
                │    │    │    ├── fd: (76,77)-->(78,117)
                │    │    │    ├── inner-join (hash)
                │    │    │    │    ├── columns: ctr_customer_sk:76 ctr_state:77!null ctr_total_return:78 ctr_state:115!null ctr_total_return:116!null
                │    │    │    │    ├── immutable
                │    │    │    │    ├── fd: (76,77)-->(78), (77)==(115), (115)==(77)
                │    │    │    │    ├── with-scan &1 (customer_total_return)
                │    │    │    │    │    ├── columns: ctr_customer_sk:76 ctr_state:77 ctr_total_return:78
                │    │    │    │    │    ├── mapping:
                │    │    │    │    │    │    ├──  cr_returning_customer_sk:8 => ctr_customer_sk:76
                │    │    │    │    │    │    ├──  ca_state:68 => ctr_state:77
                │    │    │    │    │    │    └──  sum:75 => ctr_total_return:78
                │    │    │    │    │    ├── key: (76,77)
                │    │    │    │    │    └── fd: (76,77)-->(78)
                │    │    │    │    ├── select
                │    │    │    │    │    ├── columns: ctr_state:115 ctr_total_return:116!null
                │    │    │    │    │    ├── immutable
                │    │    │    │    │    ├── with-scan &1 (customer_total_return)
                │    │    │    │    │    │    ├── columns: ctr_state:115 ctr_total_return:116
                │    │    │    │    │    │    └── mapping:
                │    │    │    │    │    │         ├──  ca_state:68 => ctr_state:115
                │    │    │    │    │    │         └──  sum:75 => ctr_total_return:116
                │    │    │    │    │    └── filters
                │    │    │    │    │         └── ctr_total_return:116 IS NOT NULL [outer=(116), immutable, constraints=(/116: (/NULL - ]; tight)]
                │    │    │    │    └── filters
                │    │    │    │         └── ctr_state:77 = ctr_state:115 [outer=(77,115), constraints=(/77: (/NULL - ]; /115: (/NULL - ]), fd=(77)==(115), (115)==(77)]
                │    │    │    └── aggregations
                │    │    │         ├── avg [as=avg:117, outer=(116)]
                │    │    │         │    └── ctr_total_return:116
                │    │    │         └── const-agg [as=ctr_total_return:78, outer=(78)]
                │    │    │              └── ctr_total_return:78
                │    │    └── filters
                │    │         └── ctr_total_return:78 > (avg:117 * 1.2) [outer=(78,117), immutable, constraints=(/78: (/NULL - ])]
                │    └── filters (true)
                ├── select
                │    ├── columns: ca_address_sk:79!null ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87!null ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91
                │    ├── key: (79)
                │    ├── fd: ()-->(87), (79)-->(81-86,88-91)
                │    ├── scan customer_address
                │    │    ├── columns: ca_address_sk:79!null ca_street_number:81 ca_street_name:82 ca_street_type:83 ca_suite_number:84 ca_city:85 ca_county:86 ca_state:87 ca_zip:88 ca_country:89 ca_gmt_offset:90 ca_location_type:91
                │    │    ├── key: (79)
                │    │    └── fd: (79)-->(81-91)
                │    └── filters
                │         └── ca_state:87 = 'TN' [outer=(87), constraints=(/87: [/'TN' - /'TN']; tight), fd=()-->(87)]
                └── filters
                     └── ca_address_sk:79 = c_current_addr_sk:98 [outer=(79,98), constraints=(/79: (/NULL - ]; /98: (/NULL - ]), fd=(79)==(98), (98)==(79)]

# --------------------------------------------------
# Q82
# NOTE: Added conversion of 60 days to an interval.
opt
	SELECT
		i_item_id, i_item_desc, i_current_price
	FROM
		item, inventory, date_dim, store_sales
	WHERE
		i_current_price BETWEEN 58 AND (58 + 30)
		AND inv_item_sk = i_item_sk
		AND d_date_sk = inv_date_sk
		AND d_date BETWEEN CAST('2001-01-13' AS DATE) AND (CAST('2001-01-13' AS DATE) + '60 days'::INTERVAL)
		AND i_manufact_id IN (259, 559, 580, 485)
		AND inv_quantity_on_hand BETWEEN 100 AND 500
		AND ss_item_sk = i_item_sk
	GROUP BY
		i_item_id, i_item_desc, i_current_price
	ORDER BY
		i_item_id
	LIMIT
		100;
----
limit
 ├── columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 ├── internal-ordering: +2
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (2,5,6)
 ├── ordering: +2
 ├── distinct-on
 │    ├── columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 │    ├── grouping columns: i_item_id:2!null i_item_desc:5 i_current_price:6!null
 │    ├── immutable
 │    ├── key: (2,5,6)
 │    ├── ordering: +2
 │    ├── limit hint: 100.00
 │    └── inner-join (lookup store_sales)
 │         ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null ss_item_sk:63!null
 │         ├── key columns: [26] = [63]
 │         ├── immutable
 │         ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26,63), (26)==(1,63), (63)==(1,26)
 │         ├── ordering: +2
 │         ├── limit hint: 385.21
 │         ├── sort
 │         │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │    ├── immutable
 │         │    ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26), (26)==(1)
 │         │    ├── ordering: +2
 │         │    ├── limit hint: 100.00
 │         │    └── inner-join (hash)
 │         │         ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │         │         ├── immutable
 │         │         ├── fd: (1)-->(2,5,6,14), (31)-->(33), (25)==(31), (31)==(25), (1)==(26), (26)==(1)
 │         │         ├── inner-join (lookup inventory)
 │         │         │    ├── columns: inv_date_sk:25!null inv_item_sk:26!null inv_quantity_on_hand:28!null d_date_sk:31!null d_date:33!null
 │         │         │    ├── key columns: [31] = [25]
 │         │         │    ├── fd: (31)-->(33), (25)==(31), (31)==(25)
 │         │         │    ├── select
 │         │         │    │    ├── columns: d_date_sk:31!null d_date:33!null
 │         │         │    │    ├── key: (31)
 │         │         │    │    ├── fd: (31)-->(33)
 │         │         │    │    ├── scan date_dim
 │         │         │    │    │    ├── columns: d_date_sk:31!null d_date:33
 │         │         │    │    │    ├── key: (31)
 │         │         │    │    │    └── fd: (31)-->(33)
 │         │         │    │    └── filters
 │         │         │    │         └── (d_date:33 >= '2001-01-13') AND (d_date:33 <= '2001-03-14') [outer=(33), constraints=(/33: [/'2001-01-13' - /'2001-03-14']; tight)]
 │         │         │    └── filters
 │         │         │         └── (inv_quantity_on_hand:28 >= 100) AND (inv_quantity_on_hand:28 <= 500) [outer=(28), constraints=(/28: [/100 - /500]; tight)]
 │         │         ├── select
 │         │         │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6!null i_manufact_id:14!null
 │         │         │    ├── immutable
 │         │         │    ├── key: (1)
 │         │         │    ├── fd: (1)-->(2,5,6,14)
 │         │         │    ├── scan item
 │         │         │    │    ├── columns: i_item_sk:1!null i_item_id:2!null i_item_desc:5 i_current_price:6 i_manufact_id:14
 │         │         │    │    ├── key: (1)
 │         │         │    │    └── fd: (1)-->(2,5,6,14)
 │         │         │    └── filters
 │         │         │         ├── (i_current_price:6 >= 58) AND (i_current_price:6 <= 88.00) [outer=(6), immutable, constraints=(/6: [/58 - /88.00]; tight)]
 │         │         │         └── i_manufact_id:14 IN (259, 485, 559, 580) [outer=(14), constraints=(/14: [/259 - /259] [/485 - /485] [/559 - /559] [/580 - /580]; tight)]
 │         │         └── filters
 │         │              └── i_item_sk:1 = inv_item_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │         └── filters (true)
 └── 100

# --------------------------------------------------
# Q83
opt
	WITH
		sr_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(sr_return_quantity) AS sr_item_qty
				FROM
					store_returns, item, date_dim
				WHERE
					sr_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									IN (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												IN (
														'2001-07-13',
														'2001-09-10',
														'2001-11-16'
													)
										)
							)
					AND sr_returned_date_sk = d_date_sk
				GROUP BY
					i_item_id
			),
		cr_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(cr_return_quantity) AS cr_item_qty
				FROM
					catalog_returns, item, date_dim
				WHERE
					cr_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									IN (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												IN (
														'2001-07-13',
														'2001-09-10',
														'2001-11-16'
													)
										)
							)
					AND cr_returned_date_sk = d_date_sk
				GROUP BY
					i_item_id
			),
		wr_items
			AS (
				SELECT
					i_item_id AS item_id,
					sum(wr_return_quantity) AS wr_item_qty
				FROM
					web_returns, item, date_dim
				WHERE
					wr_item_sk = i_item_sk
					AND d_date
						IN (
								SELECT
									d_date
								FROM
									date_dim
								WHERE
									d_week_seq
									IN (
											SELECT
												d_week_seq
											FROM
												date_dim
											WHERE
												d_date
												IN (
														'2001-07-13',
														'2001-09-10',
														'2001-11-16'
													)
										)
							)
					AND wr_returned_date_sk = d_date_sk
				GROUP BY
					i_item_id
			)
	SELECT
		sr_items.item_id,
		sr_item_qty,
		sr_item_qty
		/ (sr_item_qty + cr_item_qty + wr_item_qty)
		/ 3.0
		* 100
			AS sr_dev,
		cr_item_qty,
		cr_item_qty
		/ (sr_item_qty + cr_item_qty + wr_item_qty)
		/ 3.0
		* 100
			AS cr_dev,
		wr_item_qty,
		wr_item_qty
		/ (sr_item_qty + cr_item_qty + wr_item_qty)
		/ 3.0
		* 100
			AS wr_dev,
		(sr_item_qty + cr_item_qty + wr_item_qty) / 3.0
			AS average
	FROM
		sr_items, cr_items, wr_items
	WHERE
		sr_items.item_id = cr_items.item_id
		AND sr_items.item_id = wr_items.item_id
	ORDER BY
		sr_items.item_id, sr_item_qty
	LIMIT
		100;
----
project
 ├── columns: item_id:429!null sr_item_qty:430 sr_dev:435 cr_item_qty:432 cr_dev:436 wr_item_qty:434 wr_dev:437 average:438
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (429)
 ├── fd: (429)-->(430,432,434), (430,432,434)-->(435-438)
 ├── ordering: +429
 ├── project
 │    ├── columns: wr_item_qty:434 cr_item_qty:432 item_id:429!null sr_item_qty:430
 │    ├── cardinality: [0 - 100]
 │    ├── key: (429)
 │    ├── fd: (429)-->(430,432,434)
 │    ├── ordering: +429
 │    ├── top-k
 │    │    ├── columns: i_item_id:24!null sum:139 i_item_id:170!null sum:285 i_item_id:313!null sum:428
 │    │    ├── internal-ordering: +(24|170|313)
 │    │    ├── k: 100
 │    │    ├── cardinality: [0 - 100]
 │    │    ├── key: (313)
 │    │    ├── fd: (24)-->(139), (170)-->(285), (313)-->(428), (24)==(170,313), (170)==(24,313), (313)==(24,170)
 │    │    ├── ordering: +(24|170|313) [actual: +24]
 │    │    └── inner-join (hash)
 │    │         ├── columns: i_item_id:24!null sum:139 i_item_id:170!null sum:285 i_item_id:313!null sum:428
 │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
 │    │         ├── key: (313)
 │    │         ├── fd: (24)-->(139), (170)-->(285), (313)-->(428), (24)==(170,313), (170)==(24,313), (313)==(24,170)
 │    │         ├── group-by (hash)
 │    │         │    ├── columns: i_item_id:24!null sum:139
 │    │         │    ├── grouping columns: i_item_id:24!null
 │    │         │    ├── key: (24)
 │    │         │    ├── fd: (24)-->(139)
 │    │         │    ├── inner-join (hash)
 │    │         │    │    ├── columns: sr_returned_date_sk:1!null sr_item_sk:3!null sr_return_quantity:11 i_item_sk:23!null i_item_id:24!null d_date_sk:47!null d_date:49
 │    │         │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │    │         │    │    ├── fd: (23)-->(24), (47)-->(49), (3)==(23), (23)==(3), (1)==(47), (47)==(1)
 │    │         │    │    ├── scan item
 │    │         │    │    │    ├── columns: i_item_sk:23!null i_item_id:24!null
 │    │         │    │    │    ├── key: (23)
 │    │         │    │    │    └── fd: (23)-->(24)
 │    │         │    │    ├── inner-join (hash)
 │    │         │    │    │    ├── columns: sr_returned_date_sk:1!null sr_item_sk:3!null sr_return_quantity:11 d_date_sk:47!null d_date:49
 │    │         │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    │    │    ├── fd: (47)-->(49), (1)==(47), (47)==(1)
 │    │         │    │    │    ├── scan store_returns
 │    │         │    │    │    │    └── columns: sr_returned_date_sk:1 sr_item_sk:3!null sr_return_quantity:11
 │    │         │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    ├── columns: d_date_sk:47!null d_date:49
 │    │         │    │    │    │    ├── key: (47)
 │    │         │    │    │    │    ├── fd: (47)-->(49)
 │    │         │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    ├── columns: d_date_sk:47!null d_date:49
 │    │         │    │    │    │    │    ├── key: (47)
 │    │         │    │    │    │    │    └── fd: (47)-->(49)
 │    │         │    │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    │    ├── columns: d_date:79 d_week_seq:81
 │    │         │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    └── columns: d_date:79 d_week_seq:81
 │    │         │    │    │    │    │    ├── select
 │    │         │    │    │    │    │    │    ├── columns: d_date:109!null d_week_seq:111
 │    │         │    │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    │    └── columns: d_date:109 d_week_seq:111
 │    │         │    │    │    │    │    │    └── filters
 │    │         │    │    │    │    │    │         └── d_date:109 IN ('2001-07-13', '2001-09-10', '2001-11-16') [outer=(109), constraints=(/109: [/'2001-07-13' - /'2001-07-13'] [/'2001-09-10' - /'2001-09-10'] [/'2001-11-16' - /'2001-11-16']; tight)]
 │    │         │    │    │    │    │    └── filters
 │    │         │    │    │    │    │         └── d_week_seq:81 = d_week_seq:111 [outer=(81,111), constraints=(/81: (/NULL - ]; /111: (/NULL - ]), fd=(81)==(111), (111)==(81)]
 │    │         │    │    │    │    └── filters
 │    │         │    │    │    │         └── d_date:49 = d_date:79 [outer=(49,79), constraints=(/49: (/NULL - ]; /79: (/NULL - ]), fd=(49)==(79), (79)==(49)]
 │    │         │    │    │    └── filters
 │    │         │    │    │         └── sr_returned_date_sk:1 = d_date_sk:47 [outer=(1,47), constraints=(/1: (/NULL - ]; /47: (/NULL - ]), fd=(1)==(47), (47)==(1)]
 │    │         │    │    └── filters
 │    │         │    │         └── sr_item_sk:3 = i_item_sk:23 [outer=(3,23), constraints=(/3: (/NULL - ]; /23: (/NULL - ]), fd=(3)==(23), (23)==(3)]
 │    │         │    └── aggregations
 │    │         │         └── sum [as=sum:139, outer=(11)]
 │    │         │              └── sr_return_quantity:11
 │    │         ├── inner-join (hash)
 │    │         │    ├── columns: i_item_id:170!null sum:285 i_item_id:313!null sum:428
 │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-one)
 │    │         │    ├── key: (313)
 │    │         │    ├── fd: (170)-->(285), (313)-->(428), (170)==(313), (313)==(170)
 │    │         │    ├── group-by (hash)
 │    │         │    │    ├── columns: i_item_id:170!null sum:285
 │    │         │    │    ├── grouping columns: i_item_id:170!null
 │    │         │    │    ├── key: (170)
 │    │         │    │    ├── fd: (170)-->(285)
 │    │         │    │    ├── inner-join (lookup item)
 │    │         │    │    │    ├── columns: cr_returned_date_sk:140!null cr_item_sk:142!null cr_return_quantity:157 i_item_sk:169!null i_item_id:170!null d_date_sk:193!null d_date:195
 │    │         │    │    │    ├── key columns: [142] = [169]
 │    │         │    │    │    ├── lookup columns are key
 │    │         │    │    │    ├── fd: (169)-->(170), (193)-->(195), (142)==(169), (169)==(142), (140)==(193), (193)==(140)
 │    │         │    │    │    ├── inner-join (hash)
 │    │         │    │    │    │    ├── columns: cr_returned_date_sk:140!null cr_item_sk:142!null cr_return_quantity:157 d_date_sk:193!null d_date:195
 │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    │    │    │    ├── fd: (193)-->(195), (140)==(193), (193)==(140)
 │    │         │    │    │    │    ├── scan catalog_returns
 │    │         │    │    │    │    │    └── columns: cr_returned_date_sk:140 cr_item_sk:142!null cr_return_quantity:157
 │    │         │    │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    │    ├── columns: d_date_sk:193!null d_date:195
 │    │         │    │    │    │    │    ├── key: (193)
 │    │         │    │    │    │    │    ├── fd: (193)-->(195)
 │    │         │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    ├── columns: d_date_sk:193!null d_date:195
 │    │         │    │    │    │    │    │    ├── key: (193)
 │    │         │    │    │    │    │    │    └── fd: (193)-->(195)
 │    │         │    │    │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    │    │    ├── columns: d_date:225 d_week_seq:227
 │    │         │    │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    │    └── columns: d_date:225 d_week_seq:227
 │    │         │    │    │    │    │    │    ├── select
 │    │         │    │    │    │    │    │    │    ├── columns: d_date:255!null d_week_seq:257
 │    │         │    │    │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    │    │    └── columns: d_date:255 d_week_seq:257
 │    │         │    │    │    │    │    │    │    └── filters
 │    │         │    │    │    │    │    │    │         └── d_date:255 IN ('2001-07-13', '2001-09-10', '2001-11-16') [outer=(255), constraints=(/255: [/'2001-07-13' - /'2001-07-13'] [/'2001-09-10' - /'2001-09-10'] [/'2001-11-16' - /'2001-11-16']; tight)]
 │    │         │    │    │    │    │    │    └── filters
 │    │         │    │    │    │    │    │         └── d_week_seq:227 = d_week_seq:257 [outer=(227,257), constraints=(/227: (/NULL - ]; /257: (/NULL - ]), fd=(227)==(257), (257)==(227)]
 │    │         │    │    │    │    │    └── filters
 │    │         │    │    │    │    │         └── d_date:195 = d_date:225 [outer=(195,225), constraints=(/195: (/NULL - ]; /225: (/NULL - ]), fd=(195)==(225), (225)==(195)]
 │    │         │    │    │    │    └── filters
 │    │         │    │    │    │         └── cr_returned_date_sk:140 = d_date_sk:193 [outer=(140,193), constraints=(/140: (/NULL - ]; /193: (/NULL - ]), fd=(140)==(193), (193)==(140)]
 │    │         │    │    │    └── filters (true)
 │    │         │    │    └── aggregations
 │    │         │    │         └── sum [as=sum:285, outer=(157)]
 │    │         │    │              └── cr_return_quantity:157
 │    │         │    ├── group-by (hash)
 │    │         │    │    ├── columns: i_item_id:313!null sum:428
 │    │         │    │    ├── grouping columns: i_item_id:313!null
 │    │         │    │    ├── key: (313)
 │    │         │    │    ├── fd: (313)-->(428)
 │    │         │    │    ├── inner-join (lookup item)
 │    │         │    │    │    ├── columns: wr_returned_date_sk:286!null wr_item_sk:288!null wr_return_quantity:300 i_item_sk:312!null i_item_id:313!null d_date_sk:336!null d_date:338
 │    │         │    │    │    ├── key columns: [288] = [312]
 │    │         │    │    │    ├── lookup columns are key
 │    │         │    │    │    ├── fd: (312)-->(313), (336)-->(338), (288)==(312), (312)==(288), (286)==(336), (336)==(286)
 │    │         │    │    │    ├── inner-join (hash)
 │    │         │    │    │    │    ├── columns: wr_returned_date_sk:286!null wr_item_sk:288!null wr_return_quantity:300 d_date_sk:336!null d_date:338
 │    │         │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │         │    │    │    │    ├── fd: (336)-->(338), (286)==(336), (336)==(286)
 │    │         │    │    │    │    ├── scan web_returns
 │    │         │    │    │    │    │    └── columns: wr_returned_date_sk:286 wr_item_sk:288!null wr_return_quantity:300
 │    │         │    │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    │    ├── columns: d_date_sk:336!null d_date:338
 │    │         │    │    │    │    │    ├── key: (336)
 │    │         │    │    │    │    │    ├── fd: (336)-->(338)
 │    │         │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    ├── columns: d_date_sk:336!null d_date:338
 │    │         │    │    │    │    │    │    ├── key: (336)
 │    │         │    │    │    │    │    │    └── fd: (336)-->(338)
 │    │         │    │    │    │    │    ├── semi-join (hash)
 │    │         │    │    │    │    │    │    ├── columns: d_date:368 d_week_seq:370
 │    │         │    │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    │    └── columns: d_date:368 d_week_seq:370
 │    │         │    │    │    │    │    │    ├── select
 │    │         │    │    │    │    │    │    │    ├── columns: d_date:398!null d_week_seq:400
 │    │         │    │    │    │    │    │    │    ├── scan date_dim
 │    │         │    │    │    │    │    │    │    │    └── columns: d_date:398 d_week_seq:400
 │    │         │    │    │    │    │    │    │    └── filters
 │    │         │    │    │    │    │    │    │         └── d_date:398 IN ('2001-07-13', '2001-09-10', '2001-11-16') [outer=(398), constraints=(/398: [/'2001-07-13' - /'2001-07-13'] [/'2001-09-10' - /'2001-09-10'] [/'2001-11-16' - /'2001-11-16']; tight)]
 │    │         │    │    │    │    │    │    └── filters
 │    │         │    │    │    │    │    │         └── d_week_seq:370 = d_week_seq:400 [outer=(370,400), constraints=(/370: (/NULL - ]; /400: (/NULL - ]), fd=(370)==(400), (400)==(370)]
 │    │         │    │    │    │    │    └── filters
 │    │         │    │    │    │    │         └── d_date:338 = d_date:368 [outer=(338,368), constraints=(/338: (/NULL - ]; /368: (/NULL - ]), fd=(338)==(368), (368)==(338)]
 │    │         │    │    │    │    └── filters
 │    │         │    │    │    │         └── wr_returned_date_sk:286 = d_date_sk:336 [outer=(286,336), constraints=(/286: (/NULL - ]; /336: (/NULL - ]), fd=(286)==(336), (336)==(286)]
 │    │         │    │    │    └── filters (true)
 │    │         │    │    └── aggregations
 │    │         │    │         └── sum [as=sum:428, outer=(300)]
 │    │         │    │              └── wr_return_quantity:300
 │    │         │    └── filters
 │    │         │         └── i_item_id:170 = i_item_id:313 [outer=(170,313), constraints=(/170: (/NULL - ]; /313: (/NULL - ]), fd=(170)==(313), (313)==(170)]
 │    │         └── filters
 │    │              └── i_item_id:24 = i_item_id:170 [outer=(24,170), constraints=(/24: (/NULL - ]; /170: (/NULL - ]), fd=(24)==(170), (170)==(24)]
 │    └── projections
 │         ├── sum:428 [as=wr_item_qty:434, outer=(428)]
 │         ├── sum:285 [as=cr_item_qty:432, outer=(285)]
 │         ├── i_item_id:24 [as=item_id:429, outer=(24)]
 │         └── sum:139 [as=sr_item_qty:430, outer=(139)]
 └── projections
      ├── ((sr_item_qty:430 / (wr_item_qty:434 + (sr_item_qty:430 + cr_item_qty:432))) / 3.0) * 100 [as=sr_dev:435, outer=(430,432,434), immutable]
      ├── ((cr_item_qty:432 / (wr_item_qty:434 + (sr_item_qty:430 + cr_item_qty:432))) / 3.0) * 100 [as=cr_dev:436, outer=(430,432,434), immutable]
      ├── ((wr_item_qty:434 / (wr_item_qty:434 + (sr_item_qty:430 + cr_item_qty:432))) / 3.0) * 100 [as=wr_dev:437, outer=(430,432,434), immutable]
      └── (wr_item_qty:434 + (sr_item_qty:430 + cr_item_qty:432)) / 3.0 [as=average:438, outer=(430,432,434), immutable]

# --------------------------------------------------
# Q84
opt
	SELECT
		c_customer_id AS customer_id,
		COALESCE(c_last_name, '')
		|| ', '
		|| COALESCE(c_first_name, '')
			AS customername
	FROM
		customer,
		customer_address,
		customer_demographics,
		household_demographics,
		income_band,
		store_returns
	WHERE
		ca_city = 'Woodland'
		AND c_current_addr_sk = ca_address_sk
		AND ib_lower_bound >= 60306
		AND ib_upper_bound <= 60306 + 50000
		AND ib_income_band_sk = hd_income_band_sk
		AND cd_demo_sk = c_current_cdemo_sk
		AND hd_demo_sk = c_current_hdemo_sk
		AND sr_cdemo_sk = cd_demo_sk
	ORDER BY
		c_customer_id
	LIMIT
		100;
----
project
 ├── columns: customer_id:2!null customername:81
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +2
 ├── limit
 │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4!null c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null cd_demo_sk:36!null hd_demo_sk:47!null hd_income_band_sk:48!null ib_income_band_sk:54!null ib_lower_bound:55!null ib_upper_bound:56!null sr_cdemo_sk:63!null
 │    ├── internal-ordering: +2 opt(27)
 │    ├── cardinality: [0 - 100]
 │    ├── fd: ()-->(27), (47)-->(48), (54)-->(55,56), (5)==(21), (21)==(5), (3)==(36,63), (36)==(3,63), (63)==(3,36), (48)==(54), (54)==(48), (4)==(47), (47)==(4)
 │    ├── ordering: +2 opt(27) [actual: +2]
 │    ├── inner-join (lookup income_band)
 │    │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4!null c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null cd_demo_sk:36!null hd_demo_sk:47!null hd_income_band_sk:48!null ib_income_band_sk:54!null ib_lower_bound:55!null ib_upper_bound:56!null sr_cdemo_sk:63!null
 │    │    ├── key columns: [48] = [54]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(27), (47)-->(48), (54)-->(55,56), (5)==(21), (21)==(5), (3)==(36,63), (36)==(3,63), (63)==(3,36), (48)==(54), (54)==(48), (4)==(47), (47)==(4)
 │    │    ├── ordering: +2 opt(27) [actual: +2]
 │    │    ├── limit hint: 100.00
 │    │    ├── inner-join (lookup customer_demographics)
 │    │    │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4!null c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null cd_demo_sk:36!null hd_demo_sk:47!null hd_income_band_sk:48 sr_cdemo_sk:63!null
 │    │    │    ├── key columns: [63] = [36]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── fd: ()-->(27), (47)-->(48), (4)==(47), (47)==(4), (3)==(36,63), (36)==(3,63), (63)==(3,36), (5)==(21), (21)==(5)
 │    │    │    ├── ordering: +2 opt(27) [actual: +2]
 │    │    │    ├── limit hint: 100.00
 │    │    │    ├── inner-join (lookup household_demographics)
 │    │    │    │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4!null c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null hd_demo_sk:47!null hd_income_band_sk:48 sr_cdemo_sk:63!null
 │    │    │    │    ├── key columns: [4] = [47]
 │    │    │    │    ├── lookup columns are key
 │    │    │    │    ├── fd: ()-->(27), (47)-->(48), (4)==(47), (47)==(4), (3)==(63), (63)==(3), (5)==(21), (21)==(5)
 │    │    │    │    ├── ordering: +2 opt(27) [actual: +2]
 │    │    │    │    ├── limit hint: 100.00
 │    │    │    │    ├── sort
 │    │    │    │    │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4 c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null sr_cdemo_sk:63!null
 │    │    │    │    │    ├── fd: ()-->(27), (3)==(63), (63)==(3), (5)==(21), (21)==(5)
 │    │    │    │    │    ├── ordering: +2 opt(27) [actual: +2]
 │    │    │    │    │    ├── limit hint: 100.00
 │    │    │    │    │    └── inner-join (hash)
 │    │    │    │    │         ├── columns: c_customer_id:2!null c_current_cdemo_sk:3!null c_current_hdemo_sk:4 c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null sr_cdemo_sk:63!null
 │    │    │    │    │         ├── fd: ()-->(27), (3)==(63), (63)==(3), (5)==(21), (21)==(5)
 │    │    │    │    │         ├── scan store_returns
 │    │    │    │    │         │    └── columns: sr_cdemo_sk:63
 │    │    │    │    │         ├── inner-join (hash)
 │    │    │    │    │         │    ├── columns: c_customer_id:2!null c_current_cdemo_sk:3 c_current_hdemo_sk:4 c_current_addr_sk:5!null c_first_name:9 c_last_name:10 ca_address_sk:21!null ca_city:27!null
 │    │    │    │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │         │    ├── fd: ()-->(27), (5)==(21), (21)==(5)
 │    │    │    │    │         │    ├── scan customer
 │    │    │    │    │         │    │    └── columns: c_customer_id:2!null c_current_cdemo_sk:3 c_current_hdemo_sk:4 c_current_addr_sk:5 c_first_name:9 c_last_name:10
 │    │    │    │    │         │    ├── select
 │    │    │    │    │         │    │    ├── columns: ca_address_sk:21!null ca_city:27!null
 │    │    │    │    │         │    │    ├── key: (21)
 │    │    │    │    │         │    │    ├── fd: ()-->(27)
 │    │    │    │    │         │    │    ├── scan customer_address
 │    │    │    │    │         │    │    │    ├── columns: ca_address_sk:21!null ca_city:27
 │    │    │    │    │         │    │    │    ├── key: (21)
 │    │    │    │    │         │    │    │    └── fd: (21)-->(27)
 │    │    │    │    │         │    │    └── filters
 │    │    │    │    │         │    │         └── ca_city:27 = 'Woodland' [outer=(27), constraints=(/27: [/'Woodland' - /'Woodland']; tight), fd=()-->(27)]
 │    │    │    │    │         │    └── filters
 │    │    │    │    │         │         └── c_current_addr_sk:5 = ca_address_sk:21 [outer=(5,21), constraints=(/5: (/NULL - ]; /21: (/NULL - ]), fd=(5)==(21), (21)==(5)]
 │    │    │    │    │         └── filters
 │    │    │    │    │              └── c_current_cdemo_sk:3 = sr_cdemo_sk:63 [outer=(3,63), constraints=(/3: (/NULL - ]; /63: (/NULL - ]), fd=(3)==(63), (63)==(3)]
 │    │    │    │    └── filters (true)
 │    │    │    └── filters (true)
 │    │    └── filters
 │    │         ├── ib_lower_bound:55 >= 60306 [outer=(55), constraints=(/55: [/60306 - ]; tight)]
 │    │         └── ib_upper_bound:56 <= 110306 [outer=(56), constraints=(/56: (/NULL - /110306]; tight)]
 │    └── 100
 └── projections
      └── (COALESCE(c_last_name:10::BPCHAR, '') || ', ') || COALESCE(c_first_name:9::BPCHAR, '') [as=customername:81, outer=(9,10), immutable]

# --------------------------------------------------
# Q85
opt
	SELECT
		substr(r_reason_desc, 1, 20),
		avg(ws_quantity),
		avg(wr_refunded_cash),
		avg(wr_fee)
	FROM
		web_sales,
		web_returns,
		web_page,
		customer_demographics AS cd1,
		customer_demographics AS cd2,
		customer_address,
		date_dim,
		reason
	WHERE
		ws_web_page_sk = wp_web_page_sk
		AND ws_item_sk = wr_item_sk
		AND ws_order_number = wr_order_number
		AND ws_sold_date_sk = d_date_sk
		AND d_year = 1998
		AND cd1.cd_demo_sk = wr_refunded_cdemo_sk
		AND cd2.cd_demo_sk = wr_returning_cdemo_sk
		AND ca_address_sk = wr_refunded_addr_sk
		AND r_reason_sk = wr_reason_sk
		AND (
				(
					cd1.cd_marital_status = 'D'
					AND cd1.cd_marital_status
						= cd2.cd_marital_status
					AND cd1.cd_education_status = 'Primary'
					AND cd1.cd_education_status
						= cd2.cd_education_status
					AND ws_sales_price BETWEEN 100.00 AND 150.00
				)
				OR (
						cd1.cd_marital_status = 'S'
						AND cd1.cd_marital_status
							= cd2.cd_marital_status
						AND cd1.cd_education_status = 'College'
						AND cd1.cd_education_status
							= cd2.cd_education_status
						AND ws_sales_price BETWEEN 50.00 AND 100.00
					)
				OR (
						cd1.cd_marital_status = 'U'
						AND cd1.cd_marital_status
							= cd2.cd_marital_status
						AND cd1.cd_education_status
							= 'Advanced Degree'
						AND cd1.cd_education_status
							= cd2.cd_education_status
						AND ws_sales_price BETWEEN 150.00 AND 200.00
					)
			)
		AND (
				(
					ca_country = 'United States'
					AND ca_state IN ('NC', 'TX', 'IA')
					AND ws_net_profit BETWEEN 100 AND 200
				)
				OR (
						ca_country = 'United States'
						AND ca_state IN ('WI', 'WV', 'GA')
						AND ws_net_profit BETWEEN 150 AND 300
					)
				OR (
						ca_country = 'United States'
						AND ca_state IN ('OK', 'VA', 'KY')
						AND ws_net_profit BETWEEN 50 AND 250
					)
			)
	GROUP BY
		r_reason_desc
	ORDER BY
		substr(r_reason_desc, 1, 20),
		avg(ws_quantity),
		avg(wr_refunded_cash),
		avg(wr_fee)
	LIMIT
		100;
----
top-k
 ├── columns: substr:154 avg:151 avg:152 avg:153
 ├── internal-ordering: +154,+151,+152,+153
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── ordering: +154,+151,+152,+153
 └── project
      ├── columns: substr:154 avg:151 avg:152 avg:153
      ├── immutable
      ├── group-by (hash)
      │    ├── columns: r_reason_desc:148 avg:151 avg:152 avg:153
      │    ├── grouping columns: r_reason_desc:148
      │    ├── immutable
      │    ├── key: (148)
      │    ├── fd: (148)-->(151-153)
      │    ├── inner-join (lookup customer_address)
      │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_web_page_sk:13!null ws_order_number:18!null ws_quantity:19 ws_sales_price:22!null ws_net_profit:34!null wr_item_sk:39!null wr_refunded_cdemo_sk:41!null wr_refunded_addr_sk:43!null wr_returning_cdemo_sk:45!null wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 wp_web_page_sk:63!null cd1.cd_demo_sk:79!null cd1.cd_marital_status:81!null cd1.cd_education_status:82!null cd2.cd_demo_sk:90!null cd2.cd_marital_status:92!null cd2.cd_education_status:93!null ca_address_sk:101!null ca_state:109!null ca_country:111!null d_date_sk:116!null d_year:122!null r_reason_sk:146!null r_reason_desc:148
      │    │    ├── key columns: [43] = [101]
      │    │    ├── lookup columns are key
      │    │    ├── immutable
      │    │    ├── key: (39,50)
      │    │    ├── fd: ()-->(111,122), (4,18)-->(1,13,19,22,34), (39,50)-->(41,43,45,49,55,57), (79)-->(81,82), (90)-->(92,93), (101)-->(109), (146)-->(148), (81)==(92), (92)==(81), (82)==(93), (93)==(82), (41)==(79), (79)==(41), (45)==(90), (90)==(45), (43)==(101), (101)==(43), (49)==(146), (146)==(49), (4)==(39), (39)==(4), (18)==(50), (50)==(18), (1)==(116), (116)==(1), (13)==(63), (63)==(13)
      │    │    ├── inner-join (lookup web_page)
      │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_web_page_sk:13!null ws_order_number:18!null ws_quantity:19 ws_sales_price:22!null ws_net_profit:34 wr_item_sk:39!null wr_refunded_cdemo_sk:41!null wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45!null wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 wp_web_page_sk:63!null cd1.cd_demo_sk:79!null cd1.cd_marital_status:81!null cd1.cd_education_status:82!null cd2.cd_demo_sk:90!null cd2.cd_marital_status:92!null cd2.cd_education_status:93!null d_date_sk:116!null d_year:122!null r_reason_sk:146!null r_reason_desc:148
      │    │    │    ├── key columns: [13] = [63]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── immutable
      │    │    │    ├── key: (39,50)
      │    │    │    ├── fd: ()-->(122), (79)-->(81,82), (90)-->(92,93), (146)-->(148), (39,50)-->(41,43,45,49,55,57), (4,18)-->(1,13,19,22,34), (13)==(63), (63)==(13), (1)==(116), (116)==(1), (4)==(39), (39)==(4), (18)==(50), (50)==(18), (49)==(146), (146)==(49), (45)==(90), (90)==(45), (81)==(92), (92)==(81), (82)==(93), (93)==(82), (41)==(79), (79)==(41)
      │    │    │    ├── inner-join (lookup date_dim)
      │    │    │    │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_web_page_sk:13 ws_order_number:18!null ws_quantity:19 ws_sales_price:22!null ws_net_profit:34 wr_item_sk:39!null wr_refunded_cdemo_sk:41!null wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45!null wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 cd1.cd_demo_sk:79!null cd1.cd_marital_status:81!null cd1.cd_education_status:82!null cd2.cd_demo_sk:90!null cd2.cd_marital_status:92!null cd2.cd_education_status:93!null d_date_sk:116!null d_year:122!null r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    ├── key columns: [1] = [116]
      │    │    │    │    ├── lookup columns are key
      │    │    │    │    ├── immutable
      │    │    │    │    ├── key: (39,50)
      │    │    │    │    ├── fd: ()-->(122), (79)-->(81,82), (90)-->(92,93), (146)-->(148), (39,50)-->(41,43,45,49,55,57), (4,18)-->(1,13,19,22,34), (1)==(116), (116)==(1), (4)==(39), (39)==(4), (18)==(50), (50)==(18), (49)==(146), (146)==(49), (45)==(90), (90)==(45), (81)==(92), (92)==(81), (82)==(93), (93)==(82), (41)==(79), (79)==(41)
      │    │    │    │    ├── inner-join (lookup customer_demographics [as=cd2])
      │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_web_page_sk:13 ws_order_number:18!null ws_quantity:19 ws_sales_price:22!null ws_net_profit:34 wr_item_sk:39!null wr_refunded_cdemo_sk:41!null wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45!null wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 cd1.cd_demo_sk:79!null cd1.cd_marital_status:81!null cd1.cd_education_status:82!null cd2.cd_demo_sk:90!null cd2.cd_marital_status:92!null cd2.cd_education_status:93!null r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    │    ├── key columns: [45] = [90]
      │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    ├── immutable
      │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    ├── fd: (4,18)-->(1,13,19,22,34), (79)-->(81,82), (90)-->(92,93), (39,50)-->(41,43,45,49,55,57), (146)-->(148), (49)==(146), (146)==(49), (45)==(90), (90)==(45), (81)==(92), (92)==(81), (82)==(93), (93)==(82), (41)==(79), (79)==(41), (4)==(39), (39)==(4), (18)==(50), (50)==(18)
      │    │    │    │    │    ├── inner-join (lookup customer_demographics [as=cd1])
      │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_web_page_sk:13 ws_order_number:18!null ws_quantity:19 ws_sales_price:22!null ws_net_profit:34 wr_item_sk:39!null wr_refunded_cdemo_sk:41!null wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45 wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 cd1.cd_demo_sk:79!null cd1.cd_marital_status:81!null cd1.cd_education_status:82!null r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    │    │    ├── key columns: [41] = [79]
      │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    ├── immutable
      │    │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    │    ├── fd: (4,18)-->(1,13,19,22,34), (79)-->(81,82), (39,50)-->(41,43,45,49,55,57), (146)-->(148), (49)==(146), (146)==(49), (41)==(79), (79)==(41), (4)==(39), (39)==(4), (18)==(50), (50)==(18)
      │    │    │    │    │    │    ├── inner-join (lookup web_sales)
      │    │    │    │    │    │    │    ├── columns: ws_sold_date_sk:1 ws_item_sk:4!null ws_web_page_sk:13 ws_order_number:18!null ws_quantity:19 ws_sales_price:22 ws_net_profit:34 wr_item_sk:39!null wr_refunded_cdemo_sk:41 wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45 wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    │    │    │    ├── key columns: [39 50] = [4 18]
      │    │    │    │    │    │    │    ├── lookup columns are key
      │    │    │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    │    │    ├── fd: (4,18)-->(1,13,19,22,34), (39,50)-->(41,43,45,49,55,57), (146)-->(148), (49)==(146), (146)==(49), (4)==(39), (39)==(4), (18)==(50), (50)==(18)
      │    │    │    │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    │    │    │    ├── columns: wr_item_sk:39!null wr_refunded_cdemo_sk:41 wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45 wr_reason_sk:49!null wr_order_number:50!null wr_fee:55 wr_refunded_cash:57 r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    │    │    │    ├── fd: (39,50)-->(41,43,45,49,55,57), (146)-->(148), (49)==(146), (146)==(49)
      │    │    │    │    │    │    │    │    ├── scan web_returns
      │    │    │    │    │    │    │    │    │    ├── columns: wr_item_sk:39!null wr_refunded_cdemo_sk:41 wr_refunded_addr_sk:43 wr_returning_cdemo_sk:45 wr_reason_sk:49 wr_order_number:50!null wr_fee:55 wr_refunded_cash:57
      │    │    │    │    │    │    │    │    │    ├── key: (39,50)
      │    │    │    │    │    │    │    │    │    └── fd: (39,50)-->(41,43,45,49,55,57)
      │    │    │    │    │    │    │    │    ├── scan reason
      │    │    │    │    │    │    │    │    │    ├── columns: r_reason_sk:146!null r_reason_desc:148
      │    │    │    │    │    │    │    │    │    ├── key: (146)
      │    │    │    │    │    │    │    │    │    └── fd: (146)-->(148)
      │    │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │    │         └── r_reason_sk:146 = wr_reason_sk:49 [outer=(49,146), constraints=(/49: (/NULL - ]; /146: (/NULL - ]), fd=(49)==(146), (146)==(49)]
      │    │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── (((((cd1.cd_marital_status:81 = 'D') AND (cd1.cd_education_status:82 = 'Primary')) AND (ws_sales_price:22 >= 100.00)) AND (ws_sales_price:22 <= 150.00)) OR ((((cd1.cd_marital_status:81 = 'S') AND (cd1.cd_education_status:82 = 'College')) AND (ws_sales_price:22 >= 50.00)) AND (ws_sales_price:22 <= 100.00))) OR ((((cd1.cd_marital_status:81 = 'U') AND (cd1.cd_education_status:82 = 'Advanced Degree')) AND (ws_sales_price:22 >= 150.00)) AND (ws_sales_price:22 <= 200.00)) [outer=(22,81,82), immutable, constraints=(/22: [/50.00 - /200.00]; /81: [/'D' - /'D'] [/'S' - /'S'] [/'U' - /'U']; /82: [/'Advanced Degree' - /'Advanced Degree'] [/'College' - /'College'] [/'Primary' - /'Primary'])]
      │    │    │    │    │    └── filters
      │    │    │    │    │         ├── cd1.cd_marital_status:81 = cd2.cd_marital_status:92 [outer=(81,92), constraints=(/81: (/NULL - ]; /92: (/NULL - ]), fd=(81)==(92), (92)==(81)]
      │    │    │    │    │         └── cd1.cd_education_status:82 = cd2.cd_education_status:93 [outer=(82,93), constraints=(/82: (/NULL - ]; /93: (/NULL - ]), fd=(82)==(93), (93)==(82)]
      │    │    │    │    └── filters
      │    │    │    │         └── d_year:122 = 1998 [outer=(122), constraints=(/122: [/1998 - /1998]; tight), fd=()-->(122)]
      │    │    │    └── filters (true)
      │    │    └── filters
      │    │         ├── ((((ca_state:109 IN ('IA', 'NC', 'TX')) AND (ws_net_profit:34 >= 100)) AND (ws_net_profit:34 <= 200)) OR (((ca_state:109 IN ('GA', 'WI', 'WV')) AND (ws_net_profit:34 >= 150)) AND (ws_net_profit:34 <= 300))) OR (((ca_state:109 IN ('KY', 'OK', 'VA')) AND (ws_net_profit:34 >= 50)) AND (ws_net_profit:34 <= 250)) [outer=(34,109), immutable, constraints=(/34: [/50 - /300]; /109: [/'GA' - /'GA'] [/'IA' - /'IA'] [/'KY' - /'KY'] [/'NC' - /'NC'] [/'OK' - /'OK'] [/'TX' - /'TX'] [/'VA' - /'VA'] [/'WI' - /'WI'] [/'WV' - /'WV'])]
      │    │         └── ca_country:111 = 'United States' [outer=(111), constraints=(/111: [/'United States' - /'United States']; tight), fd=()-->(111)]
      │    └── aggregations
      │         ├── avg [as=avg:151, outer=(19)]
      │         │    └── ws_quantity:19
      │         ├── avg [as=avg:152, outer=(57)]
      │         │    └── wr_refunded_cash:57
      │         └── avg [as=avg:153, outer=(55)]
      │              └── wr_fee:55
      └── projections
           └── substr(r_reason_desc:148, 1, 20) [as=substr:154, outer=(148), immutable]

# --------------------------------------------------
# Q86
# TODO: adjust the query to work with CRDB.
# opt
# select   
#     sum(ws_net_paid) as total_sum
#    ,i_category
#    ,i_class
#    ,grouping(i_category)+grouping(i_class) as lochierarchy
#    ,rank() over (
#  	partition by grouping(i_category)+grouping(i_class),
#  	case when grouping(i_class) = 0 then i_category end 
#  	order by sum(ws_net_paid) desc) as rank_within_parent
#  from
#     web_sales
#    ,date_dim       d1
#    ,item
#  where
#     d1.d_month_seq between 1186 and 1186+11
#  and d1.d_date_sk = ws_sold_date_sk
#  and i_item_sk  = ws_item_sk
#  group by rollup(i_category,i_class)
#  order by
#    lochierarchy desc,
#    case when lochierarchy = 0 then i_category end,
#    rank_within_parent
#  limit 100;
# ----

# --------------------------------------------------
# Q87
opt
	SELECT
		count(*)
	FROM
		(
			(
				SELECT
					DISTINCT c_last_name, c_first_name, d_date
				FROM
					store_sales, date_dim, customer
				WHERE
					store_sales.ss_sold_date_sk
					= date_dim.d_date_sk
					AND store_sales.ss_customer_sk
						= customer.c_customer_sk
					AND d_month_seq BETWEEN 1202 AND (1202 + 11)
			)
			EXCEPT
				(
					SELECT
						DISTINCT
						c_last_name,
						c_first_name,
						d_date
					FROM
						catalog_sales, date_dim, customer
					WHERE
						catalog_sales.cs_sold_date_sk
						= date_dim.d_date_sk
						AND catalog_sales.cs_bill_customer_sk
							= customer.c_customer_sk
						AND d_month_seq BETWEEN 1202 AND (1202 + 11)
				)
			EXCEPT
				(
					SELECT
						DISTINCT
						c_last_name,
						c_first_name,
						d_date
					FROM
						web_sales, date_dim, customer
					WHERE
						web_sales.ws_sold_date_sk
						= date_dim.d_date_sk
						AND web_sales.ws_bill_customer_sk
							= customer.c_customer_sk
						AND d_month_seq BETWEEN 1202 AND (1202 + 11)
				)
		)
			AS cool_cust;
----
scalar-group-by
 ├── columns: count:248!null
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(248)
 ├── except-all
 │    ├── columns: c_last_name:65 c_first_name:64 d_date:28
 │    ├── left columns: c_last_name:65 c_first_name:64 d_date:28
 │    ├── right columns: c_last_name:237 c_first_name:236 d_date:200
 │    ├── key: (28,64,65)
 │    ├── except-all
 │    │    ├── columns: c_last_name:65 c_first_name:64 d_date:28
 │    │    ├── left columns: c_last_name:65 c_first_name:64 d_date:28
 │    │    ├── right columns: c_last_name:151 c_first_name:150 d_date:114
 │    │    ├── key: (28,64,65)
 │    │    ├── distinct-on
 │    │    │    ├── columns: d_date:28 c_first_name:64 c_last_name:65
 │    │    │    ├── grouping columns: d_date:28 c_first_name:64 c_last_name:65
 │    │    │    ├── key: (28,64,65)
 │    │    │    └── inner-join (hash)
 │    │    │         ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4!null d_date_sk:26!null d_date:28 d_month_seq:29!null c_customer_sk:56!null c_first_name:64 c_last_name:65
 │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         ├── fd: (26)-->(28,29), (56)-->(64,65), (1)==(26), (26)==(1), (4)==(56), (56)==(4)
 │    │    │         ├── inner-join (hash)
 │    │    │         │    ├── columns: ss_sold_date_sk:1!null ss_customer_sk:4 d_date_sk:26!null d_date:28 d_month_seq:29!null
 │    │    │         │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │         │    ├── fd: (26)-->(28,29), (1)==(26), (26)==(1)
 │    │    │         │    ├── scan store_sales
 │    │    │         │    │    └── columns: ss_sold_date_sk:1 ss_customer_sk:4
 │    │    │         │    ├── select
 │    │    │         │    │    ├── columns: d_date_sk:26!null d_date:28 d_month_seq:29!null
 │    │    │         │    │    ├── key: (26)
 │    │    │         │    │    ├── fd: (26)-->(28,29)
 │    │    │         │    │    ├── scan date_dim
 │    │    │         │    │    │    ├── columns: d_date_sk:26!null d_date:28 d_month_seq:29
 │    │    │         │    │    │    ├── key: (26)
 │    │    │         │    │    │    └── fd: (26)-->(28,29)
 │    │    │         │    │    └── filters
 │    │    │         │    │         └── (d_month_seq:29 >= 1202) AND (d_month_seq:29 <= 1213) [outer=(29), constraints=(/29: [/1202 - /1213]; tight)]
 │    │    │         │    └── filters
 │    │    │         │         └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    │         ├── scan customer
 │    │    │         │    ├── columns: c_customer_sk:56!null c_first_name:64 c_last_name:65
 │    │    │         │    ├── key: (56)
 │    │    │         │    └── fd: (56)-->(64,65)
 │    │    │         └── filters
 │    │    │              └── ss_customer_sk:4 = c_customer_sk:56 [outer=(4,56), constraints=(/4: (/NULL - ]; /56: (/NULL - ]), fd=(4)==(56), (56)==(4)]
 │    │    └── distinct-on
 │    │         ├── columns: d_date:114 c_first_name:150 c_last_name:151
 │    │         ├── grouping columns: d_date:114 c_first_name:150 c_last_name:151
 │    │         ├── key: (114,150,151)
 │    │         └── inner-join (hash)
 │    │              ├── columns: cs_sold_date_sk:76!null cs_bill_customer_sk:79!null d_date_sk:112!null d_date:114 d_month_seq:115!null c_customer_sk:142!null c_first_name:150 c_last_name:151
 │    │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │              ├── fd: (112)-->(114,115), (142)-->(150,151), (76)==(112), (112)==(76), (79)==(142), (142)==(79)
 │    │              ├── inner-join (hash)
 │    │              │    ├── columns: cs_sold_date_sk:76!null cs_bill_customer_sk:79 d_date_sk:112!null d_date:114 d_month_seq:115!null
 │    │              │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │              │    ├── fd: (112)-->(114,115), (76)==(112), (112)==(76)
 │    │              │    ├── scan catalog_sales
 │    │              │    │    └── columns: cs_sold_date_sk:76 cs_bill_customer_sk:79
 │    │              │    ├── select
 │    │              │    │    ├── columns: d_date_sk:112!null d_date:114 d_month_seq:115!null
 │    │              │    │    ├── key: (112)
 │    │              │    │    ├── fd: (112)-->(114,115)
 │    │              │    │    ├── scan date_dim
 │    │              │    │    │    ├── columns: d_date_sk:112!null d_date:114 d_month_seq:115
 │    │              │    │    │    ├── key: (112)
 │    │              │    │    │    └── fd: (112)-->(114,115)
 │    │              │    │    └── filters
 │    │              │    │         └── (d_month_seq:115 >= 1202) AND (d_month_seq:115 <= 1213) [outer=(115), constraints=(/115: [/1202 - /1213]; tight)]
 │    │              │    └── filters
 │    │              │         └── cs_sold_date_sk:76 = d_date_sk:112 [outer=(76,112), constraints=(/76: (/NULL - ]; /112: (/NULL - ]), fd=(76)==(112), (112)==(76)]
 │    │              ├── scan customer
 │    │              │    ├── columns: c_customer_sk:142!null c_first_name:150 c_last_name:151
 │    │              │    ├── key: (142)
 │    │              │    └── fd: (142)-->(150,151)
 │    │              └── filters
 │    │                   └── cs_bill_customer_sk:79 = c_customer_sk:142 [outer=(79,142), constraints=(/79: (/NULL - ]; /142: (/NULL - ]), fd=(79)==(142), (142)==(79)]
 │    └── distinct-on
 │         ├── columns: d_date:200 c_first_name:236 c_last_name:237
 │         ├── grouping columns: d_date:200 c_first_name:236 c_last_name:237
 │         ├── key: (200,236,237)
 │         └── inner-join (hash)
 │              ├── columns: ws_sold_date_sk:162!null ws_bill_customer_sk:166!null d_date_sk:198!null d_date:200 d_month_seq:201!null c_customer_sk:228!null c_first_name:236 c_last_name:237
 │              ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │              ├── fd: (198)-->(200,201), (228)-->(236,237), (162)==(198), (198)==(162), (166)==(228), (228)==(166)
 │              ├── inner-join (hash)
 │              │    ├── columns: ws_sold_date_sk:162!null ws_bill_customer_sk:166 d_date_sk:198!null d_date:200 d_month_seq:201!null
 │              │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │              │    ├── fd: (198)-->(200,201), (162)==(198), (198)==(162)
 │              │    ├── scan web_sales
 │              │    │    └── columns: ws_sold_date_sk:162 ws_bill_customer_sk:166
 │              │    ├── select
 │              │    │    ├── columns: d_date_sk:198!null d_date:200 d_month_seq:201!null
 │              │    │    ├── key: (198)
 │              │    │    ├── fd: (198)-->(200,201)
 │              │    │    ├── scan date_dim
 │              │    │    │    ├── columns: d_date_sk:198!null d_date:200 d_month_seq:201
 │              │    │    │    ├── key: (198)
 │              │    │    │    └── fd: (198)-->(200,201)
 │              │    │    └── filters
 │              │    │         └── (d_month_seq:201 >= 1202) AND (d_month_seq:201 <= 1213) [outer=(201), constraints=(/201: [/1202 - /1213]; tight)]
 │              │    └── filters
 │              │         └── ws_sold_date_sk:162 = d_date_sk:198 [outer=(162,198), constraints=(/162: (/NULL - ]; /198: (/NULL - ]), fd=(162)==(198), (198)==(162)]
 │              ├── scan customer
 │              │    ├── columns: c_customer_sk:228!null c_first_name:236 c_last_name:237
 │              │    ├── key: (228)
 │              │    └── fd: (228)-->(236,237)
 │              └── filters
 │                   └── ws_bill_customer_sk:166 = c_customer_sk:228 [outer=(166,228), constraints=(/166: (/NULL - ]; /228: (/NULL - ]), fd=(166)==(228), (228)==(166)]
 └── aggregations
      └── count-rows [as=count_rows:248]

# --------------------------------------------------
# Q88
opt
	SELECT
		*
	FROM
		(
			SELECT
				count(*) AS h8_30_to_9
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 8
				AND time_dim.t_minute >= 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s1,
		(
			SELECT
				count(*) AS h9_to_9_30
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 9
				AND time_dim.t_minute < 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s2,
		(
			SELECT
				count(*) AS h9_30_to_10
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 9
				AND time_dim.t_minute >= 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s3,
		(
			SELECT
				count(*) AS h10_to_10_30
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 10
				AND time_dim.t_minute < 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s4,
		(
			SELECT
				count(*) AS h10_30_to_11
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 10
				AND time_dim.t_minute >= 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s5,
		(
			SELECT
				count(*) AS h11_to_11_30
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 11
				AND time_dim.t_minute < 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s6,
		(
			SELECT
				count(*) AS h11_30_to_12
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 11
				AND time_dim.t_minute >= 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s7,
		(
			SELECT
				count(*) AS h12_to_12_30
			FROM
				store_sales,
				household_demographics,
				time_dim,
				store
			WHERE
				ss_sold_time_sk = time_dim.t_time_sk
				AND ss_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ss_store_sk = s_store_sk
				AND time_dim.t_hour = 12
				AND time_dim.t_minute < 30
				AND (
						(
							household_demographics.hd_dep_count
							= 0
							AND household_demographics.hd_vehicle_count
								<= 0 + 2
						)
						OR (
								household_demographics.hd_dep_count
								= -1
								AND household_demographics.hd_vehicle_count
									<= -1 + 2
							)
						OR (
								household_demographics.hd_dep_count
								= 3
								AND household_demographics.hd_vehicle_count
									<= 3 + 2
							)
					)
				AND store.s_store_name = 'ese'
		)
			AS s8;
----
inner-join (cross)
 ├── columns: h8_30_to_9:76!null h9_to_9_30:152!null h9_30_to_10:228!null h10_to_10_30:304!null h10_30_to_11:380!null h11_to_11_30:456!null h11_30_to_12:532!null h12_to_12_30:608!null
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── key: ()
 ├── fd: ()-->(76,152,228,304,380,456,532,608)
 ├── scalar-group-by
 │    ├── columns: count_rows:76!null
 │    ├── cardinality: [1 - 1]
 │    ├── key: ()
 │    ├── fd: ()-->(76)
 │    ├── inner-join (hash)
 │    │    ├── columns: ss_sold_time_sk:2!null ss_hdemo_sk:6!null ss_store_sk:8!null hd_demo_sk:26!null hd_dep_count:29!null hd_vehicle_count:30!null t_time_sk:33!null t_hour:36!null t_minute:37!null s_store_sk:45!null s_store_name:50!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── fd: ()-->(36,50), (26)-->(29,30), (33)-->(37), (6)==(26), (26)==(6), (2)==(33), (33)==(2), (8)==(45), (45)==(8)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_time_sk:2!null ss_hdemo_sk:6!null ss_store_sk:8 hd_demo_sk:26!null hd_dep_count:29!null hd_vehicle_count:30!null t_time_sk:33!null t_hour:36!null t_minute:37!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(36), (26)-->(29,30), (33)-->(37), (6)==(26), (26)==(6), (2)==(33), (33)==(2)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_time_sk:2 ss_hdemo_sk:6!null ss_store_sk:8 hd_demo_sk:26!null hd_dep_count:29!null hd_vehicle_count:30!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (26)-->(29,30), (6)==(26), (26)==(6)
 │    │    │    │    ├── scan store_sales
 │    │    │    │    │    └── columns: ss_sold_time_sk:2 ss_hdemo_sk:6 ss_store_sk:8
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: hd_demo_sk:26!null hd_dep_count:29!null hd_vehicle_count:30!null
 │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    ├── fd: (26)-->(29,30)
 │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    ├── columns: hd_demo_sk:26!null hd_dep_count:29 hd_vehicle_count:30
 │    │    │    │    │    │    ├── key: (26)
 │    │    │    │    │    │    └── fd: (26)-->(29,30)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (((hd_dep_count:29 = 0) AND (hd_vehicle_count:30 <= 2)) OR ((hd_dep_count:29 = -1) AND (hd_vehicle_count:30 <= 1))) OR ((hd_dep_count:29 = 3) AND (hd_vehicle_count:30 <= 5)) [outer=(29,30), constraints=(/29: [/-1 - /-1] [/0 - /0] [/3 - /3]; /30: (/NULL - /5])]
 │    │    │    │    └── filters
 │    │    │    │         └── ss_hdemo_sk:6 = hd_demo_sk:26 [outer=(6,26), constraints=(/6: (/NULL - ]; /26: (/NULL - ]), fd=(6)==(26), (26)==(6)]
 │    │    │    ├── select
 │    │    │    │    ├── columns: t_time_sk:33!null t_hour:36!null t_minute:37!null
 │    │    │    │    ├── key: (33)
 │    │    │    │    ├── fd: ()-->(36), (33)-->(37)
 │    │    │    │    ├── scan time_dim
 │    │    │    │    │    ├── columns: t_time_sk:33!null t_hour:36 t_minute:37
 │    │    │    │    │    ├── key: (33)
 │    │    │    │    │    └── fd: (33)-->(36,37)
 │    │    │    │    └── filters
 │    │    │    │         ├── t_hour:36 = 8 [outer=(36), constraints=(/36: [/8 - /8]; tight), fd=()-->(36)]
 │    │    │    │         └── t_minute:37 >= 30 [outer=(37), constraints=(/37: [/30 - ]; tight)]
 │    │    │    └── filters
 │    │    │         └── ss_sold_time_sk:2 = t_time_sk:33 [outer=(2,33), constraints=(/2: (/NULL - ]; /33: (/NULL - ]), fd=(2)==(33), (33)==(2)]
 │    │    ├── select
 │    │    │    ├── columns: s_store_sk:45!null s_store_name:50!null
 │    │    │    ├── key: (45)
 │    │    │    ├── fd: ()-->(50)
 │    │    │    ├── scan store
 │    │    │    │    ├── columns: s_store_sk:45!null s_store_name:50
 │    │    │    │    ├── key: (45)
 │    │    │    │    └── fd: (45)-->(50)
 │    │    │    └── filters
 │    │    │         └── s_store_name:50 = 'ese' [outer=(50), constraints=(/50: [/'ese' - /'ese']; tight), fd=()-->(50)]
 │    │    └── filters
 │    │         └── ss_store_sk:8 = s_store_sk:45 [outer=(8,45), constraints=(/8: (/NULL - ]; /45: (/NULL - ]), fd=(8)==(45), (45)==(8)]
 │    └── aggregations
 │         └── count-rows [as=count_rows:76]
 ├── inner-join (cross)
 │    ├── columns: count_rows:152!null count_rows:228!null count_rows:304!null count_rows:380!null count_rows:456!null count_rows:532!null count_rows:608!null
 │    ├── cardinality: [1 - 1]
 │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    ├── key: ()
 │    ├── fd: ()-->(152,228,304,380,456,532,608)
 │    ├── scalar-group-by
 │    │    ├── columns: count_rows:152!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(152)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_time_sk:78!null ss_hdemo_sk:82!null ss_store_sk:84!null hd_demo_sk:102!null hd_dep_count:105!null hd_vehicle_count:106!null t_time_sk:109!null t_hour:112!null t_minute:113!null s_store_sk:121!null s_store_name:126!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(112,126), (102)-->(105,106), (109)-->(113), (82)==(102), (102)==(82), (78)==(109), (109)==(78), (84)==(121), (121)==(84)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_time_sk:78!null ss_hdemo_sk:82!null ss_store_sk:84 hd_demo_sk:102!null hd_dep_count:105!null hd_vehicle_count:106!null t_time_sk:109!null t_hour:112!null t_minute:113!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(112), (102)-->(105,106), (109)-->(113), (82)==(102), (102)==(82), (78)==(109), (109)==(78)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_time_sk:78 ss_hdemo_sk:82!null ss_store_sk:84 hd_demo_sk:102!null hd_dep_count:105!null hd_vehicle_count:106!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (102)-->(105,106), (82)==(102), (102)==(82)
 │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    └── columns: ss_sold_time_sk:78 ss_hdemo_sk:82 ss_store_sk:84
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: hd_demo_sk:102!null hd_dep_count:105!null hd_vehicle_count:106!null
 │    │    │    │    │    │    ├── key: (102)
 │    │    │    │    │    │    ├── fd: (102)-->(105,106)
 │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    ├── columns: hd_demo_sk:102!null hd_dep_count:105 hd_vehicle_count:106
 │    │    │    │    │    │    │    ├── key: (102)
 │    │    │    │    │    │    │    └── fd: (102)-->(105,106)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (((hd_dep_count:105 = 0) AND (hd_vehicle_count:106 <= 2)) OR ((hd_dep_count:105 = -1) AND (hd_vehicle_count:106 <= 1))) OR ((hd_dep_count:105 = 3) AND (hd_vehicle_count:106 <= 5)) [outer=(105,106), constraints=(/105: [/-1 - /-1] [/0 - /0] [/3 - /3]; /106: (/NULL - /5])]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_hdemo_sk:82 = hd_demo_sk:102 [outer=(82,102), constraints=(/82: (/NULL - ]; /102: (/NULL - ]), fd=(82)==(102), (102)==(82)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: t_time_sk:109!null t_hour:112!null t_minute:113!null
 │    │    │    │    │    ├── key: (109)
 │    │    │    │    │    ├── fd: ()-->(112), (109)-->(113)
 │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    ├── columns: t_time_sk:109!null t_hour:112 t_minute:113
 │    │    │    │    │    │    ├── key: (109)
 │    │    │    │    │    │    └── fd: (109)-->(112,113)
 │    │    │    │    │    └── filters
 │    │    │    │    │         ├── t_hour:112 = 9 [outer=(112), constraints=(/112: [/9 - /9]; tight), fd=()-->(112)]
 │    │    │    │    │         └── t_minute:113 < 30 [outer=(113), constraints=(/113: (/NULL - /29]; tight)]
 │    │    │    │    └── filters
 │    │    │    │         └── ss_sold_time_sk:78 = t_time_sk:109 [outer=(78,109), constraints=(/78: (/NULL - ]; /109: (/NULL - ]), fd=(78)==(109), (109)==(78)]
 │    │    │    ├── select
 │    │    │    │    ├── columns: s_store_sk:121!null s_store_name:126!null
 │    │    │    │    ├── key: (121)
 │    │    │    │    ├── fd: ()-->(126)
 │    │    │    │    ├── scan store
 │    │    │    │    │    ├── columns: s_store_sk:121!null s_store_name:126
 │    │    │    │    │    ├── key: (121)
 │    │    │    │    │    └── fd: (121)-->(126)
 │    │    │    │    └── filters
 │    │    │    │         └── s_store_name:126 = 'ese' [outer=(126), constraints=(/126: [/'ese' - /'ese']; tight), fd=()-->(126)]
 │    │    │    └── filters
 │    │    │         └── ss_store_sk:84 = s_store_sk:121 [outer=(84,121), constraints=(/84: (/NULL - ]; /121: (/NULL - ]), fd=(84)==(121), (121)==(84)]
 │    │    └── aggregations
 │    │         └── count-rows [as=count_rows:152]
 │    ├── inner-join (cross)
 │    │    ├── columns: count_rows:228!null count_rows:304!null count_rows:380!null count_rows:456!null count_rows:532!null count_rows:608!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(228,304,380,456,532,608)
 │    │    ├── scalar-group-by
 │    │    │    ├── columns: count_rows:228!null
 │    │    │    ├── cardinality: [1 - 1]
 │    │    │    ├── key: ()
 │    │    │    ├── fd: ()-->(228)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ss_sold_time_sk:154!null ss_hdemo_sk:158!null ss_store_sk:160!null hd_demo_sk:178!null hd_dep_count:181!null hd_vehicle_count:182!null t_time_sk:185!null t_hour:188!null t_minute:189!null s_store_sk:197!null s_store_name:202!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(188,202), (178)-->(181,182), (185)-->(189), (158)==(178), (178)==(158), (154)==(185), (185)==(154), (160)==(197), (197)==(160)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_time_sk:154!null ss_hdemo_sk:158!null ss_store_sk:160 hd_demo_sk:178!null hd_dep_count:181!null hd_vehicle_count:182!null t_time_sk:185!null t_hour:188!null t_minute:189!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: ()-->(188), (178)-->(181,182), (185)-->(189), (158)==(178), (178)==(158), (154)==(185), (185)==(154)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: ss_sold_time_sk:154 ss_hdemo_sk:158!null ss_store_sk:160 hd_demo_sk:178!null hd_dep_count:181!null hd_vehicle_count:182!null
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: (178)-->(181,182), (158)==(178), (178)==(158)
 │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:154 ss_hdemo_sk:158 ss_store_sk:160
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: hd_demo_sk:178!null hd_dep_count:181!null hd_vehicle_count:182!null
 │    │    │    │    │    │    │    ├── key: (178)
 │    │    │    │    │    │    │    ├── fd: (178)-->(181,182)
 │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:178!null hd_dep_count:181 hd_vehicle_count:182
 │    │    │    │    │    │    │    │    ├── key: (178)
 │    │    │    │    │    │    │    │    └── fd: (178)-->(181,182)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── (((hd_dep_count:181 = 0) AND (hd_vehicle_count:182 <= 2)) OR ((hd_dep_count:181 = -1) AND (hd_vehicle_count:182 <= 1))) OR ((hd_dep_count:181 = 3) AND (hd_vehicle_count:182 <= 5)) [outer=(181,182), constraints=(/181: [/-1 - /-1] [/0 - /0] [/3 - /3]; /182: (/NULL - /5])]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_hdemo_sk:158 = hd_demo_sk:178 [outer=(158,178), constraints=(/158: (/NULL - ]; /178: (/NULL - ]), fd=(158)==(178), (178)==(158)]
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: t_time_sk:185!null t_hour:188!null t_minute:189!null
 │    │    │    │    │    │    ├── key: (185)
 │    │    │    │    │    │    ├── fd: ()-->(188), (185)-->(189)
 │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    ├── columns: t_time_sk:185!null t_hour:188 t_minute:189
 │    │    │    │    │    │    │    ├── key: (185)
 │    │    │    │    │    │    │    └── fd: (185)-->(188,189)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         ├── t_hour:188 = 9 [outer=(188), constraints=(/188: [/9 - /9]; tight), fd=()-->(188)]
 │    │    │    │    │    │         └── t_minute:189 >= 30 [outer=(189), constraints=(/189: [/30 - ]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_sold_time_sk:154 = t_time_sk:185 [outer=(154,185), constraints=(/154: (/NULL - ]; /185: (/NULL - ]), fd=(154)==(185), (185)==(154)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: s_store_sk:197!null s_store_name:202!null
 │    │    │    │    │    ├── key: (197)
 │    │    │    │    │    ├── fd: ()-->(202)
 │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    ├── columns: s_store_sk:197!null s_store_name:202
 │    │    │    │    │    │    ├── key: (197)
 │    │    │    │    │    │    └── fd: (197)-->(202)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── s_store_name:202 = 'ese' [outer=(202), constraints=(/202: [/'ese' - /'ese']; tight), fd=()-->(202)]
 │    │    │    │    └── filters
 │    │    │    │         └── ss_store_sk:160 = s_store_sk:197 [outer=(160,197), constraints=(/160: (/NULL - ]; /197: (/NULL - ]), fd=(160)==(197), (197)==(160)]
 │    │    │    └── aggregations
 │    │    │         └── count-rows [as=count_rows:228]
 │    │    ├── inner-join (cross)
 │    │    │    ├── columns: count_rows:304!null count_rows:380!null count_rows:456!null count_rows:532!null count_rows:608!null
 │    │    │    ├── cardinality: [1 - 1]
 │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    ├── key: ()
 │    │    │    ├── fd: ()-->(304,380,456,532,608)
 │    │    │    ├── scalar-group-by
 │    │    │    │    ├── columns: count_rows:304!null
 │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    ├── key: ()
 │    │    │    │    ├── fd: ()-->(304)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ss_sold_time_sk:230!null ss_hdemo_sk:234!null ss_store_sk:236!null hd_demo_sk:254!null hd_dep_count:257!null hd_vehicle_count:258!null t_time_sk:261!null t_hour:264!null t_minute:265!null s_store_sk:273!null s_store_name:278!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: ()-->(264,278), (254)-->(257,258), (261)-->(265), (234)==(254), (254)==(234), (230)==(261), (261)==(230), (236)==(273), (273)==(236)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: ss_sold_time_sk:230!null ss_hdemo_sk:234!null ss_store_sk:236 hd_demo_sk:254!null hd_dep_count:257!null hd_vehicle_count:258!null t_time_sk:261!null t_hour:264!null t_minute:265!null
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: ()-->(264), (254)-->(257,258), (261)-->(265), (234)==(254), (254)==(234), (230)==(261), (261)==(230)
 │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:230 ss_hdemo_sk:234!null ss_store_sk:236 hd_demo_sk:254!null hd_dep_count:257!null hd_vehicle_count:258!null
 │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    ├── fd: (254)-->(257,258), (234)==(254), (254)==(234)
 │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:230 ss_hdemo_sk:234 ss_store_sk:236
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:254!null hd_dep_count:257!null hd_vehicle_count:258!null
 │    │    │    │    │    │    │    │    ├── key: (254)
 │    │    │    │    │    │    │    │    ├── fd: (254)-->(257,258)
 │    │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:254!null hd_dep_count:257 hd_vehicle_count:258
 │    │    │    │    │    │    │    │    │    ├── key: (254)
 │    │    │    │    │    │    │    │    │    └── fd: (254)-->(257,258)
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── (((hd_dep_count:257 = 0) AND (hd_vehicle_count:258 <= 2)) OR ((hd_dep_count:257 = -1) AND (hd_vehicle_count:258 <= 1))) OR ((hd_dep_count:257 = 3) AND (hd_vehicle_count:258 <= 5)) [outer=(257,258), constraints=(/257: [/-1 - /-1] [/0 - /0] [/3 - /3]; /258: (/NULL - /5])]
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ss_hdemo_sk:234 = hd_demo_sk:254 [outer=(234,254), constraints=(/234: (/NULL - ]; /254: (/NULL - ]), fd=(234)==(254), (254)==(234)]
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: t_time_sk:261!null t_hour:264!null t_minute:265!null
 │    │    │    │    │    │    │    ├── key: (261)
 │    │    │    │    │    │    │    ├── fd: ()-->(264), (261)-->(265)
 │    │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    │    ├── columns: t_time_sk:261!null t_hour:264 t_minute:265
 │    │    │    │    │    │    │    │    ├── key: (261)
 │    │    │    │    │    │    │    │    └── fd: (261)-->(264,265)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         ├── t_hour:264 = 10 [outer=(264), constraints=(/264: [/10 - /10]; tight), fd=()-->(264)]
 │    │    │    │    │    │    │         └── t_minute:265 < 30 [outer=(265), constraints=(/265: (/NULL - /29]; tight)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_sold_time_sk:230 = t_time_sk:261 [outer=(230,261), constraints=(/230: (/NULL - ]; /261: (/NULL - ]), fd=(230)==(261), (261)==(230)]
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: s_store_sk:273!null s_store_name:278!null
 │    │    │    │    │    │    ├── key: (273)
 │    │    │    │    │    │    ├── fd: ()-->(278)
 │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    ├── columns: s_store_sk:273!null s_store_name:278
 │    │    │    │    │    │    │    ├── key: (273)
 │    │    │    │    │    │    │    └── fd: (273)-->(278)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── s_store_name:278 = 'ese' [outer=(278), constraints=(/278: [/'ese' - /'ese']; tight), fd=()-->(278)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ss_store_sk:236 = s_store_sk:273 [outer=(236,273), constraints=(/236: (/NULL - ]; /273: (/NULL - ]), fd=(236)==(273), (273)==(236)]
 │    │    │    │    └── aggregations
 │    │    │    │         └── count-rows [as=count_rows:304]
 │    │    │    ├── inner-join (cross)
 │    │    │    │    ├── columns: count_rows:380!null count_rows:456!null count_rows:532!null count_rows:608!null
 │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    │    ├── key: ()
 │    │    │    │    ├── fd: ()-->(380,456,532,608)
 │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    ├── columns: count_rows:380!null
 │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    ├── key: ()
 │    │    │    │    │    ├── fd: ()-->(380)
 │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    ├── columns: ss_sold_time_sk:306!null ss_hdemo_sk:310!null ss_store_sk:312!null hd_demo_sk:330!null hd_dep_count:333!null hd_vehicle_count:334!null t_time_sk:337!null t_hour:340!null t_minute:341!null s_store_sk:349!null s_store_name:354!null
 │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    ├── fd: ()-->(340,354), (330)-->(333,334), (337)-->(341), (310)==(330), (330)==(310), (306)==(337), (337)==(306), (312)==(349), (349)==(312)
 │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:306!null ss_hdemo_sk:310!null ss_store_sk:312 hd_demo_sk:330!null hd_dep_count:333!null hd_vehicle_count:334!null t_time_sk:337!null t_hour:340!null t_minute:341!null
 │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    ├── fd: ()-->(340), (330)-->(333,334), (337)-->(341), (310)==(330), (330)==(310), (306)==(337), (337)==(306)
 │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:306 ss_hdemo_sk:310!null ss_store_sk:312 hd_demo_sk:330!null hd_dep_count:333!null hd_vehicle_count:334!null
 │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    ├── fd: (330)-->(333,334), (310)==(330), (330)==(310)
 │    │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:306 ss_hdemo_sk:310 ss_store_sk:312
 │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:330!null hd_dep_count:333!null hd_vehicle_count:334!null
 │    │    │    │    │    │    │    │    │    ├── key: (330)
 │    │    │    │    │    │    │    │    │    ├── fd: (330)-->(333,334)
 │    │    │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:330!null hd_dep_count:333 hd_vehicle_count:334
 │    │    │    │    │    │    │    │    │    │    ├── key: (330)
 │    │    │    │    │    │    │    │    │    │    └── fd: (330)-->(333,334)
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── (((hd_dep_count:333 = 0) AND (hd_vehicle_count:334 <= 2)) OR ((hd_dep_count:333 = -1) AND (hd_vehicle_count:334 <= 1))) OR ((hd_dep_count:333 = 3) AND (hd_vehicle_count:334 <= 5)) [outer=(333,334), constraints=(/333: [/-1 - /-1] [/0 - /0] [/3 - /3]; /334: (/NULL - /5])]
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── ss_hdemo_sk:310 = hd_demo_sk:330 [outer=(310,330), constraints=(/310: (/NULL - ]; /330: (/NULL - ]), fd=(310)==(330), (330)==(310)]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: t_time_sk:337!null t_hour:340!null t_minute:341!null
 │    │    │    │    │    │    │    │    ├── key: (337)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(340), (337)-->(341)
 │    │    │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:337!null t_hour:340 t_minute:341
 │    │    │    │    │    │    │    │    │    ├── key: (337)
 │    │    │    │    │    │    │    │    │    └── fd: (337)-->(340,341)
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         ├── t_hour:340 = 10 [outer=(340), constraints=(/340: [/10 - /10]; tight), fd=()-->(340)]
 │    │    │    │    │    │    │    │         └── t_minute:341 >= 30 [outer=(341), constraints=(/341: [/30 - ]; tight)]
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ss_sold_time_sk:306 = t_time_sk:337 [outer=(306,337), constraints=(/306: (/NULL - ]; /337: (/NULL - ]), fd=(306)==(337), (337)==(306)]
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: s_store_sk:349!null s_store_name:354!null
 │    │    │    │    │    │    │    ├── key: (349)
 │    │    │    │    │    │    │    ├── fd: ()-->(354)
 │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    ├── columns: s_store_sk:349!null s_store_name:354
 │    │    │    │    │    │    │    │    ├── key: (349)
 │    │    │    │    │    │    │    │    └── fd: (349)-->(354)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── s_store_name:354 = 'ese' [outer=(354), constraints=(/354: [/'ese' - /'ese']; tight), fd=()-->(354)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ss_store_sk:312 = s_store_sk:349 [outer=(312,349), constraints=(/312: (/NULL - ]; /349: (/NULL - ]), fd=(312)==(349), (349)==(312)]
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── count-rows [as=count_rows:380]
 │    │    │    │    ├── inner-join (cross)
 │    │    │    │    │    ├── columns: count_rows:456!null count_rows:532!null count_rows:608!null
 │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    │    │    ├── key: ()
 │    │    │    │    │    ├── fd: ()-->(456,532,608)
 │    │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    │    ├── columns: count_rows:456!null
 │    │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    │    ├── key: ()
 │    │    │    │    │    │    ├── fd: ()-->(456)
 │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:382!null ss_hdemo_sk:386!null ss_store_sk:388!null hd_demo_sk:406!null hd_dep_count:409!null hd_vehicle_count:410!null t_time_sk:413!null t_hour:416!null t_minute:417!null s_store_sk:425!null s_store_name:430!null
 │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    ├── fd: ()-->(416,430), (406)-->(409,410), (413)-->(417), (386)==(406), (406)==(386), (382)==(413), (413)==(382), (388)==(425), (425)==(388)
 │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:382!null ss_hdemo_sk:386!null ss_store_sk:388 hd_demo_sk:406!null hd_dep_count:409!null hd_vehicle_count:410!null t_time_sk:413!null t_hour:416!null t_minute:417!null
 │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(416), (406)-->(409,410), (413)-->(417), (386)==(406), (406)==(386), (382)==(413), (413)==(382)
 │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:382 ss_hdemo_sk:386!null ss_store_sk:388 hd_demo_sk:406!null hd_dep_count:409!null hd_vehicle_count:410!null
 │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    │    ├── fd: (406)-->(409,410), (386)==(406), (406)==(386)
 │    │    │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:382 ss_hdemo_sk:386 ss_store_sk:388
 │    │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:406!null hd_dep_count:409!null hd_vehicle_count:410!null
 │    │    │    │    │    │    │    │    │    │    ├── key: (406)
 │    │    │    │    │    │    │    │    │    │    ├── fd: (406)-->(409,410)
 │    │    │    │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:406!null hd_dep_count:409 hd_vehicle_count:410
 │    │    │    │    │    │    │    │    │    │    │    ├── key: (406)
 │    │    │    │    │    │    │    │    │    │    │    └── fd: (406)-->(409,410)
 │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │         └── (((hd_dep_count:409 = 0) AND (hd_vehicle_count:410 <= 2)) OR ((hd_dep_count:409 = -1) AND (hd_vehicle_count:410 <= 1))) OR ((hd_dep_count:409 = 3) AND (hd_vehicle_count:410 <= 5)) [outer=(409,410), constraints=(/409: [/-1 - /-1] [/0 - /0] [/3 - /3]; /410: (/NULL - /5])]
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── ss_hdemo_sk:386 = hd_demo_sk:406 [outer=(386,406), constraints=(/386: (/NULL - ]; /406: (/NULL - ]), fd=(386)==(406), (406)==(386)]
 │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:413!null t_hour:416!null t_minute:417!null
 │    │    │    │    │    │    │    │    │    ├── key: (413)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(416), (413)-->(417)
 │    │    │    │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:413!null t_hour:416 t_minute:417
 │    │    │    │    │    │    │    │    │    │    ├── key: (413)
 │    │    │    │    │    │    │    │    │    │    └── fd: (413)-->(416,417)
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         ├── t_hour:416 = 11 [outer=(416), constraints=(/416: [/11 - /11]; tight), fd=()-->(416)]
 │    │    │    │    │    │    │    │    │         └── t_minute:417 < 30 [outer=(417), constraints=(/417: (/NULL - /29]; tight)]
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── ss_sold_time_sk:382 = t_time_sk:413 [outer=(382,413), constraints=(/382: (/NULL - ]; /413: (/NULL - ]), fd=(382)==(413), (413)==(382)]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── columns: s_store_sk:425!null s_store_name:430!null
 │    │    │    │    │    │    │    │    ├── key: (425)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(430)
 │    │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:425!null s_store_name:430
 │    │    │    │    │    │    │    │    │    ├── key: (425)
 │    │    │    │    │    │    │    │    │    └── fd: (425)-->(430)
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── s_store_name:430 = 'ese' [outer=(430), constraints=(/430: [/'ese' - /'ese']; tight), fd=()-->(430)]
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── ss_store_sk:388 = s_store_sk:425 [outer=(388,425), constraints=(/388: (/NULL - ]; /425: (/NULL - ]), fd=(388)==(425), (425)==(388)]
 │    │    │    │    │    │    └── aggregations
 │    │    │    │    │    │         └── count-rows [as=count_rows:456]
 │    │    │    │    │    ├── inner-join (cross)
 │    │    │    │    │    │    ├── columns: count_rows:532!null count_rows:608!null
 │    │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    │    │    │    │    ├── key: ()
 │    │    │    │    │    │    ├── fd: ()-->(532,608)
 │    │    │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    │    │    ├── columns: count_rows:532!null
 │    │    │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    │    │    ├── key: ()
 │    │    │    │    │    │    │    ├── fd: ()-->(532)
 │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:458!null ss_hdemo_sk:462!null ss_store_sk:464!null hd_demo_sk:482!null hd_dep_count:485!null hd_vehicle_count:486!null t_time_sk:489!null t_hour:492!null t_minute:493!null s_store_sk:501!null s_store_name:506!null
 │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(492,506), (482)-->(485,486), (489)-->(493), (462)==(482), (482)==(462), (458)==(489), (489)==(458), (464)==(501), (501)==(464)
 │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:458!null ss_hdemo_sk:462!null ss_store_sk:464 hd_demo_sk:482!null hd_dep_count:485!null hd_vehicle_count:486!null t_time_sk:489!null t_hour:492!null t_minute:493!null
 │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(492), (482)-->(485,486), (489)-->(493), (462)==(482), (482)==(462), (458)==(489), (489)==(458)
 │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:458 ss_hdemo_sk:462!null ss_store_sk:464 hd_demo_sk:482!null hd_dep_count:485!null hd_vehicle_count:486!null
 │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    │    │    ├── fd: (482)-->(485,486), (462)==(482), (482)==(462)
 │    │    │    │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:458 ss_hdemo_sk:462 ss_store_sk:464
 │    │    │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:482!null hd_dep_count:485!null hd_vehicle_count:486!null
 │    │    │    │    │    │    │    │    │    │    │    ├── key: (482)
 │    │    │    │    │    │    │    │    │    │    │    ├── fd: (482)-->(485,486)
 │    │    │    │    │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:482!null hd_dep_count:485 hd_vehicle_count:486
 │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (482)
 │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (482)-->(485,486)
 │    │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │    │         └── (((hd_dep_count:485 = 0) AND (hd_vehicle_count:486 <= 2)) OR ((hd_dep_count:485 = -1) AND (hd_vehicle_count:486 <= 1))) OR ((hd_dep_count:485 = 3) AND (hd_vehicle_count:486 <= 5)) [outer=(485,486), constraints=(/485: [/-1 - /-1] [/0 - /0] [/3 - /3]; /486: (/NULL - /5])]
 │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │         └── ss_hdemo_sk:462 = hd_demo_sk:482 [outer=(462,482), constraints=(/462: (/NULL - ]; /482: (/NULL - ]), fd=(462)==(482), (482)==(462)]
 │    │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:489!null t_hour:492!null t_minute:493!null
 │    │    │    │    │    │    │    │    │    │    ├── key: (489)
 │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(492), (489)-->(493)
 │    │    │    │    │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:489!null t_hour:492 t_minute:493
 │    │    │    │    │    │    │    │    │    │    │    ├── key: (489)
 │    │    │    │    │    │    │    │    │    │    │    └── fd: (489)-->(492,493)
 │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │         ├── t_hour:492 = 11 [outer=(492), constraints=(/492: [/11 - /11]; tight), fd=()-->(492)]
 │    │    │    │    │    │    │    │    │    │         └── t_minute:493 >= 30 [outer=(493), constraints=(/493: [/30 - ]; tight)]
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── ss_sold_time_sk:458 = t_time_sk:489 [outer=(458,489), constraints=(/458: (/NULL - ]; /489: (/NULL - ]), fd=(458)==(489), (489)==(458)]
 │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:501!null s_store_name:506!null
 │    │    │    │    │    │    │    │    │    ├── key: (501)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(506)
 │    │    │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:501!null s_store_name:506
 │    │    │    │    │    │    │    │    │    │    ├── key: (501)
 │    │    │    │    │    │    │    │    │    │    └── fd: (501)-->(506)
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── s_store_name:506 = 'ese' [outer=(506), constraints=(/506: [/'ese' - /'ese']; tight), fd=()-->(506)]
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── ss_store_sk:464 = s_store_sk:501 [outer=(464,501), constraints=(/464: (/NULL - ]; /501: (/NULL - ]), fd=(464)==(501), (501)==(464)]
 │    │    │    │    │    │    │    └── aggregations
 │    │    │    │    │    │    │         └── count-rows [as=count_rows:532]
 │    │    │    │    │    │    ├── scalar-group-by
 │    │    │    │    │    │    │    ├── columns: count_rows:608!null
 │    │    │    │    │    │    │    ├── cardinality: [1 - 1]
 │    │    │    │    │    │    │    ├── key: ()
 │    │    │    │    │    │    │    ├── fd: ()-->(608)
 │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:534!null ss_hdemo_sk:538!null ss_store_sk:540!null hd_demo_sk:558!null hd_dep_count:561!null hd_vehicle_count:562!null t_time_sk:565!null t_hour:568!null t_minute:569!null s_store_sk:577!null s_store_name:582!null
 │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(568,582), (558)-->(561,562), (565)-->(569), (538)==(558), (558)==(538), (534)==(565), (565)==(534), (540)==(577), (577)==(540)
 │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:534!null ss_hdemo_sk:538!null ss_store_sk:540 hd_demo_sk:558!null hd_dep_count:561!null hd_vehicle_count:562!null t_time_sk:565!null t_hour:568!null t_minute:569!null
 │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(568), (558)-->(561,562), (565)-->(569), (538)==(558), (558)==(538), (534)==(565), (565)==(534)
 │    │    │    │    │    │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    │    │    │    │    │    ├── columns: ss_sold_time_sk:534 ss_hdemo_sk:538!null ss_store_sk:540 hd_demo_sk:558!null hd_dep_count:561!null hd_vehicle_count:562!null
 │    │    │    │    │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    │    │    │    │    │    ├── fd: (558)-->(561,562), (538)==(558), (558)==(538)
 │    │    │    │    │    │    │    │    │    │    ├── scan store_sales
 │    │    │    │    │    │    │    │    │    │    │    └── columns: ss_sold_time_sk:534 ss_hdemo_sk:538 ss_store_sk:540
 │    │    │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:558!null hd_dep_count:561!null hd_vehicle_count:562!null
 │    │    │    │    │    │    │    │    │    │    │    ├── key: (558)
 │    │    │    │    │    │    │    │    │    │    │    ├── fd: (558)-->(561,562)
 │    │    │    │    │    │    │    │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    │    │    │    │    │    │    │    ├── columns: hd_demo_sk:558!null hd_dep_count:561 hd_vehicle_count:562
 │    │    │    │    │    │    │    │    │    │    │    │    ├── key: (558)
 │    │    │    │    │    │    │    │    │    │    │    │    └── fd: (558)-->(561,562)
 │    │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │    │         └── (((hd_dep_count:561 = 0) AND (hd_vehicle_count:562 <= 2)) OR ((hd_dep_count:561 = -1) AND (hd_vehicle_count:562 <= 1))) OR ((hd_dep_count:561 = 3) AND (hd_vehicle_count:562 <= 5)) [outer=(561,562), constraints=(/561: [/-1 - /-1] [/0 - /0] [/3 - /3]; /562: (/NULL - /5])]
 │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │         └── ss_hdemo_sk:538 = hd_demo_sk:558 [outer=(538,558), constraints=(/538: (/NULL - ]; /558: (/NULL - ]), fd=(538)==(558), (558)==(538)]
 │    │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:565!null t_hour:568!null t_minute:569!null
 │    │    │    │    │    │    │    │    │    │    ├── key: (565)
 │    │    │    │    │    │    │    │    │    │    ├── fd: ()-->(568), (565)-->(569)
 │    │    │    │    │    │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    │    │    │    │    │    ├── columns: t_time_sk:565!null t_hour:568 t_minute:569
 │    │    │    │    │    │    │    │    │    │    │    ├── key: (565)
 │    │    │    │    │    │    │    │    │    │    │    └── fd: (565)-->(568,569)
 │    │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │    │         ├── t_hour:568 = 12 [outer=(568), constraints=(/568: [/12 - /12]; tight), fd=()-->(568)]
 │    │    │    │    │    │    │    │    │    │         └── t_minute:569 < 30 [outer=(569), constraints=(/569: (/NULL - /29]; tight)]
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── ss_sold_time_sk:534 = t_time_sk:565 [outer=(534,565), constraints=(/534: (/NULL - ]; /565: (/NULL - ]), fd=(534)==(565), (565)==(534)]
 │    │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:577!null s_store_name:582!null
 │    │    │    │    │    │    │    │    │    ├── key: (577)
 │    │    │    │    │    │    │    │    │    ├── fd: ()-->(582)
 │    │    │    │    │    │    │    │    │    ├── scan store
 │    │    │    │    │    │    │    │    │    │    ├── columns: s_store_sk:577!null s_store_name:582
 │    │    │    │    │    │    │    │    │    │    ├── key: (577)
 │    │    │    │    │    │    │    │    │    │    └── fd: (577)-->(582)
 │    │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │    │         └── s_store_name:582 = 'ese' [outer=(582), constraints=(/582: [/'ese' - /'ese']; tight), fd=()-->(582)]
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         └── ss_store_sk:540 = s_store_sk:577 [outer=(540,577), constraints=(/540: (/NULL - ]; /577: (/NULL - ]), fd=(540)==(577), (577)==(540)]
 │    │    │    │    │    │    │    └── aggregations
 │    │    │    │    │    │    │         └── count-rows [as=count_rows:608]
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    └── filters (true)
 │    │    │    │    └── filters (true)
 │    │    │    └── filters (true)
 │    │    └── filters (true)
 │    └── filters (true)
 └── filters (true)

# --------------------------------------------------
# Q89
opt
	SELECT
		*
	FROM
		(
			SELECT
				i_category,
				i_class,
				i_brand,
				s_store_name,
				s_company_name,
				d_moy,
				sum(ss_sales_price) AS sum_sales,
				avg(sum(ss_sales_price)) OVER (
					PARTITION BY
						i_category,
						i_brand,
						s_store_name,
						s_company_name
				)
					AS avg_monthly_sales
			FROM
				item, store_sales, date_dim, store
			WHERE
				ss_item_sk = i_item_sk
				AND ss_sold_date_sk = d_date_sk
				AND ss_store_sk = s_store_sk
				AND d_year IN (2001,)
				AND (
						(
							i_category
							IN (
									'Books',
									'Children',
									'Electronics'
								)
							AND i_class
								IN (
										'history',
										'school-uniforms',
										'audio'
									)
						)
						OR (
								i_category
								IN ('Men', 'Sports', 'Shoes')
								AND i_class
									IN (
											'pants',
											'tennis',
											'womens'
										)
							)
					)
			GROUP BY
				i_category,
				i_class,
				i_brand,
				s_store_name,
				s_company_name,
				d_moy
		)
			AS tmp1
	WHERE
		CASE
		WHEN (avg_monthly_sales != 0)
		THEN (
			abs(sum_sales - avg_monthly_sales)
			/ avg_monthly_sales
		)
		ELSE NULL
		END
		> 0.1
	ORDER BY
		sum_sales - avg_monthly_sales, s_store_name
	LIMIT
		100;
----
top-k
 ├── columns: i_category:13!null i_class:11!null i_brand:9 s_store_name:85 s_company_name:97 d_moy:58 sum_sales:111 avg_monthly_sales:112  [hidden: column113:113]
 ├── internal-ordering: +113,+85
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (9,11,13,58,85,97)
 ├── fd: (9,11,13,58,85,97)-->(111,112), (111,112)-->(113)
 ├── ordering: +113,+85
 └── project
      ├── columns: column113:113 i_brand:9 i_class:11!null i_category:13!null d_moy:58 s_store_name:85 s_company_name:97 sum:111 avg:112
      ├── immutable
      ├── key: (9,11,13,58,85,97)
      ├── fd: (9,11,13,58,85,97)-->(111,112), (111,112)-->(113)
      ├── select
      │    ├── columns: i_brand:9 i_class:11!null i_category:13!null d_moy:58 s_store_name:85 s_company_name:97 sum:111 avg:112
      │    ├── immutable
      │    ├── key: (9,11,13,58,85,97)
      │    ├── fd: (9,11,13,58,85,97)-->(111,112)
      │    ├── window partition=(9,13,85,97)
      │    │    ├── columns: i_brand:9 i_class:11!null i_category:13!null d_moy:58 s_store_name:85 s_company_name:97 sum:111 avg:112
      │    │    ├── key: (9,11,13,58,85,97)
      │    │    ├── fd: (9,11,13,58,85,97)-->(111,112)
      │    │    ├── group-by (hash)
      │    │    │    ├── columns: i_brand:9 i_class:11!null i_category:13!null d_moy:58 s_store_name:85 s_company_name:97 sum:111
      │    │    │    ├── grouping columns: i_brand:9 i_class:11!null i_category:13!null d_moy:58 s_store_name:85 s_company_name:97
      │    │    │    ├── key: (9,11,13,58,85,97)
      │    │    │    ├── fd: (9,11,13,58,85,97)-->(111)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11!null i_category:13!null ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32!null ss_sales_price:38 d_date_sk:50!null d_year:56!null d_moy:58 s_store_sk:80!null s_store_name:85 s_company_name:97
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(56), (1)-->(9,11,13), (50)-->(58), (80)-->(85,97), (25)==(50), (50)==(25), (32)==(80), (80)==(32), (1)==(27), (27)==(1)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11!null i_category:13!null ss_sold_date_sk:25!null ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38 d_date_sk:50!null d_year:56!null d_moy:58
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: ()-->(56), (1)-->(9,11,13), (50)-->(58), (25)==(50), (50)==(25), (1)==(27), (27)==(1)
      │    │    │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11!null i_category:13!null ss_sold_date_sk:25 ss_item_sk:27!null ss_store_sk:32 ss_sales_price:38
      │    │    │    │    │    │    ├── key columns: [1] = [27]
      │    │    │    │    │    │    ├── fd: (1)-->(9,11,13), (1)==(27), (27)==(1)
      │    │    │    │    │    │    ├── select
      │    │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11!null i_category:13!null
      │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    ├── fd: (1)-->(9,11,13)
      │    │    │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    │    │    ├── columns: i_item_sk:1!null i_brand:9 i_class:11 i_category:13
      │    │    │    │    │    │    │    │    ├── key: (1)
      │    │    │    │    │    │    │    │    └── fd: (1)-->(9,11,13)
      │    │    │    │    │    │    │    └── filters
      │    │    │    │    │    │    │         └── ((i_category:13 IN ('Books', 'Children', 'Electronics')) AND (i_class:11 IN ('audio', 'history', 'school-uniforms'))) OR ((i_category:13 IN ('Men', 'Shoes', 'Sports')) AND (i_class:11 IN ('pants', 'tennis', 'womens'))) [outer=(11,13), constraints=(/11: [/'audio' - /'audio'] [/'history' - /'history'] [/'pants' - /'pants'] [/'school-uniforms' - /'school-uniforms'] [/'tennis' - /'tennis'] [/'womens' - /'womens']; /13: [/'Books' - /'Books'] [/'Children' - /'Children'] [/'Electronics' - /'Electronics'] [/'Men' - /'Men'] [/'Shoes' - /'Shoes'] [/'Sports' - /'Sports'])]
      │    │    │    │    │    │    └── filters (true)
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_year:56!null d_moy:58
      │    │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    │    ├── fd: ()-->(56), (50)-->(58)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:50!null d_year:56 d_moy:58
      │    │    │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    │    │    └── fd: (50)-->(56,58)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── d_year:56 = 2001 [outer=(56), constraints=(/56: [/2001 - /2001]; tight), fd=()-->(56)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ss_sold_date_sk:25 = d_date_sk:50 [outer=(25,50), constraints=(/25: (/NULL - ]; /50: (/NULL - ]), fd=(25)==(50), (50)==(25)]
      │    │    │    │    ├── scan store
      │    │    │    │    │    ├── columns: s_store_sk:80!null s_store_name:85 s_company_name:97
      │    │    │    │    │    ├── key: (80)
      │    │    │    │    │    └── fd: (80)-->(85,97)
      │    │    │    │    └── filters
      │    │    │    │         └── ss_store_sk:32 = s_store_sk:80 [outer=(32,80), constraints=(/32: (/NULL - ]; /80: (/NULL - ]), fd=(32)==(80), (80)==(32)]
      │    │    │    └── aggregations
      │    │    │         └── sum [as=sum:111, outer=(38)]
      │    │    │              └── ss_sales_price:38
      │    │    └── windows
      │    │         └── avg [as=avg:112, outer=(111)]
      │    │              └── sum:111
      │    └── filters
      │         └── CASE WHEN avg:112 != 0 THEN abs(sum:111 - avg:112) / avg:112 ELSE CAST(NULL AS DECIMAL) END > 0.1 [outer=(111,112), immutable]
      └── projections
           └── sum:111 - avg:112 [as=column113:113, outer=(111,112), immutable]

# --------------------------------------------------
# Q90
opt
	SELECT
		CAST(amc AS DECIMAL(15,4)) / CAST(pmc AS DECIMAL(15,4))
			AS am_pm_ratio
	FROM
		(
			SELECT
				count(*) AS amc
			FROM
				web_sales,
				household_demographics,
				time_dim,
				web_page
			WHERE
				ws_sold_time_sk = time_dim.t_time_sk
				AND ws_ship_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ws_web_page_sk = web_page.wp_web_page_sk
				AND time_dim.t_hour BETWEEN 12 AND (12 + 1)
				AND household_demographics.hd_dep_count = 6
				AND web_page.wp_char_count BETWEEN 5000 AND 5200
		)
			AS at,
		(
			SELECT
				count(*) AS pmc
			FROM
				web_sales,
				household_demographics,
				time_dim,
				web_page
			WHERE
				ws_sold_time_sk = time_dim.t_time_sk
				AND ws_ship_hdemo_sk
					= household_demographics.hd_demo_sk
				AND ws_web_page_sk = web_page.wp_web_page_sk
				AND time_dim.t_hour BETWEEN 14 AND (14 + 1)
				AND household_demographics.hd_dep_count = 6
				AND web_page.wp_char_count BETWEEN 5000 AND 5200
		)
			AS pt
	ORDER BY
		am_pm_ratio
	LIMIT
		100;
----
project
 ├── columns: am_pm_ratio:145!null
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(145)
 ├── inner-join (cross)
 │    ├── columns: count_rows:72!null count_rows:144!null
 │    ├── cardinality: [1 - 1]
 │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    ├── key: ()
 │    ├── fd: ()-->(72,144)
 │    ├── scalar-group-by
 │    │    ├── columns: count_rows:72!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(72)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ws_sold_time_sk:2!null ws_ship_hdemo_sk:11!null ws_web_page_sk:13!null hd_demo_sk:37!null hd_dep_count:40!null t_time_sk:44!null t_hour:47!null wp_web_page_sk:56!null wp_char_count:66!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(40), (44)-->(47), (56)-->(66), (11)==(37), (37)==(11), (2)==(44), (44)==(2), (13)==(56), (56)==(13)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ws_sold_time_sk:2!null ws_ship_hdemo_sk:11 ws_web_page_sk:13!null t_time_sk:44!null t_hour:47!null wp_web_page_sk:56!null wp_char_count:66!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (44)-->(47), (56)-->(66), (13)==(56), (56)==(13), (2)==(44), (44)==(2)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ws_sold_time_sk:2 ws_ship_hdemo_sk:11 ws_web_page_sk:13!null wp_web_page_sk:56!null wp_char_count:66!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (56)-->(66), (13)==(56), (56)==(13)
 │    │    │    │    │    ├── scan web_sales
 │    │    │    │    │    │    └── columns: ws_sold_time_sk:2 ws_ship_hdemo_sk:11 ws_web_page_sk:13
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: wp_web_page_sk:56!null wp_char_count:66!null
 │    │    │    │    │    │    ├── key: (56)
 │    │    │    │    │    │    ├── fd: (56)-->(66)
 │    │    │    │    │    │    ├── scan web_page
 │    │    │    │    │    │    │    ├── columns: wp_web_page_sk:56!null wp_char_count:66
 │    │    │    │    │    │    │    ├── key: (56)
 │    │    │    │    │    │    │    └── fd: (56)-->(66)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (wp_char_count:66 >= 5000) AND (wp_char_count:66 <= 5200) [outer=(66), constraints=(/66: [/5000 - /5200]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ws_web_page_sk:13 = wp_web_page_sk:56 [outer=(13,56), constraints=(/13: (/NULL - ]; /56: (/NULL - ]), fd=(13)==(56), (56)==(13)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: t_time_sk:44!null t_hour:47!null
 │    │    │    │    │    ├── key: (44)
 │    │    │    │    │    ├── fd: (44)-->(47)
 │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    ├── columns: t_time_sk:44!null t_hour:47
 │    │    │    │    │    │    ├── key: (44)
 │    │    │    │    │    │    └── fd: (44)-->(47)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (t_hour:47 >= 12) AND (t_hour:47 <= 13) [outer=(47), constraints=(/47: [/12 - /13]; tight)]
 │    │    │    │    └── filters
 │    │    │    │         └── ws_sold_time_sk:2 = t_time_sk:44 [outer=(2,44), constraints=(/2: (/NULL - ]; /44: (/NULL - ]), fd=(2)==(44), (44)==(2)]
 │    │    │    ├── select
 │    │    │    │    ├── columns: hd_demo_sk:37!null hd_dep_count:40!null
 │    │    │    │    ├── key: (37)
 │    │    │    │    ├── fd: ()-->(40)
 │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    ├── columns: hd_demo_sk:37!null hd_dep_count:40
 │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    └── fd: (37)-->(40)
 │    │    │    │    └── filters
 │    │    │    │         └── hd_dep_count:40 = 6 [outer=(40), constraints=(/40: [/6 - /6]; tight), fd=()-->(40)]
 │    │    │    └── filters
 │    │    │         └── ws_ship_hdemo_sk:11 = hd_demo_sk:37 [outer=(11,37), constraints=(/11: (/NULL - ]; /37: (/NULL - ]), fd=(11)==(37), (37)==(11)]
 │    │    └── aggregations
 │    │         └── count-rows [as=count_rows:72]
 │    ├── scalar-group-by
 │    │    ├── columns: count_rows:144!null
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(144)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ws_sold_time_sk:74!null ws_ship_hdemo_sk:83!null ws_web_page_sk:85!null hd_demo_sk:109!null hd_dep_count:112!null t_time_sk:116!null t_hour:119!null wp_web_page_sk:128!null wp_char_count:138!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(112), (116)-->(119), (128)-->(138), (83)==(109), (109)==(83), (74)==(116), (116)==(74), (85)==(128), (128)==(85)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ws_sold_time_sk:74!null ws_ship_hdemo_sk:83 ws_web_page_sk:85!null t_time_sk:116!null t_hour:119!null wp_web_page_sk:128!null wp_char_count:138!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: (116)-->(119), (128)-->(138), (85)==(128), (128)==(85), (74)==(116), (116)==(74)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ws_sold_time_sk:74 ws_ship_hdemo_sk:83 ws_web_page_sk:85!null wp_web_page_sk:128!null wp_char_count:138!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (128)-->(138), (85)==(128), (128)==(85)
 │    │    │    │    │    ├── scan web_sales
 │    │    │    │    │    │    └── columns: ws_sold_time_sk:74 ws_ship_hdemo_sk:83 ws_web_page_sk:85
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: wp_web_page_sk:128!null wp_char_count:138!null
 │    │    │    │    │    │    ├── key: (128)
 │    │    │    │    │    │    ├── fd: (128)-->(138)
 │    │    │    │    │    │    ├── scan web_page
 │    │    │    │    │    │    │    ├── columns: wp_web_page_sk:128!null wp_char_count:138
 │    │    │    │    │    │    │    ├── key: (128)
 │    │    │    │    │    │    │    └── fd: (128)-->(138)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (wp_char_count:138 >= 5000) AND (wp_char_count:138 <= 5200) [outer=(138), constraints=(/138: [/5000 - /5200]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ws_web_page_sk:85 = wp_web_page_sk:128 [outer=(85,128), constraints=(/85: (/NULL - ]; /128: (/NULL - ]), fd=(85)==(128), (128)==(85)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: t_time_sk:116!null t_hour:119!null
 │    │    │    │    │    ├── key: (116)
 │    │    │    │    │    ├── fd: (116)-->(119)
 │    │    │    │    │    ├── scan time_dim
 │    │    │    │    │    │    ├── columns: t_time_sk:116!null t_hour:119
 │    │    │    │    │    │    ├── key: (116)
 │    │    │    │    │    │    └── fd: (116)-->(119)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (t_hour:119 >= 14) AND (t_hour:119 <= 15) [outer=(119), constraints=(/119: [/14 - /15]; tight)]
 │    │    │    │    └── filters
 │    │    │    │         └── ws_sold_time_sk:74 = t_time_sk:116 [outer=(74,116), constraints=(/74: (/NULL - ]; /116: (/NULL - ]), fd=(74)==(116), (116)==(74)]
 │    │    │    ├── select
 │    │    │    │    ├── columns: hd_demo_sk:109!null hd_dep_count:112!null
 │    │    │    │    ├── key: (109)
 │    │    │    │    ├── fd: ()-->(112)
 │    │    │    │    ├── scan household_demographics
 │    │    │    │    │    ├── columns: hd_demo_sk:109!null hd_dep_count:112
 │    │    │    │    │    ├── key: (109)
 │    │    │    │    │    └── fd: (109)-->(112)
 │    │    │    │    └── filters
 │    │    │    │         └── hd_dep_count:112 = 6 [outer=(112), constraints=(/112: [/6 - /6]; tight), fd=()-->(112)]
 │    │    │    └── filters
 │    │    │         └── ws_ship_hdemo_sk:83 = hd_demo_sk:109 [outer=(83,109), constraints=(/83: (/NULL - ]; /109: (/NULL - ]), fd=(83)==(109), (109)==(83)]
 │    │    └── aggregations
 │    │         └── count-rows [as=count_rows:144]
 │    └── filters (true)
 └── projections
      └── count_rows:72::DECIMAL(15,4) / count_rows:144::DECIMAL(15,4) [as=am_pm_ratio:145, outer=(72,144), immutable]

# --------------------------------------------------
# Q91
opt
	SELECT
		cc_call_center_id AS call_center,
		cc_name AS call_center_name,
		cc_manager AS manager,
		sum(cr_net_loss) AS returns_loss
	FROM
		call_center,
		catalog_returns,
		date_dim,
		customer,
		customer_address,
		customer_demographics,
		household_demographics
	WHERE
		cr_call_center_sk = cc_call_center_sk
		AND cr_returned_date_sk = d_date_sk
		AND cr_returning_customer_sk = c_customer_sk
		AND cd_demo_sk = c_current_cdemo_sk
		AND hd_demo_sk = c_current_hdemo_sk
		AND ca_address_sk = c_current_addr_sk
		AND d_year = 2000
		AND d_moy = 12
		AND (
				(
					cd_marital_status = 'M'
					AND cd_education_status = 'Unknown'
				)
				OR (
						cd_marital_status = 'W'
						AND cd_education_status
							= 'Advanced Degree'
					)
			)
		AND hd_buy_potential LIKE 'Unknown%'
		AND ca_gmt_offset = -7
	GROUP BY
		cc_call_center_id,
		cc_name,
		cc_manager,
		cd_marital_status,
		cd_education_status
	ORDER BY
		sum(cr_net_loss) DESC;
----
sort
 ├── columns: call_center:2!null call_center_name:7 manager:12 returns_loss:146
 ├── immutable
 ├── ordering: -146
 └── project
      ├── columns: cc_call_center_id:2!null cc_name:7 cc_manager:12 sum:146
      ├── immutable
      └── group-by (hash)
           ├── columns: cc_call_center_id:2!null cc_name:7 cc_manager:12 cd_marital_status:130!null cd_education_status:131!null sum:146
           ├── grouping columns: cc_call_center_id:2!null cc_name:7 cc_manager:12 cd_marital_status:130!null cd_education_status:131!null
           ├── immutable
           ├── key: (2,7,12,130,131)
           ├── fd: (2,7,12,130,131)-->(146)
           ├── inner-join (lookup customer_demographics)
           │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12 cr_returned_date_sk:34!null cr_returning_customer_sk:41!null cr_call_center_sk:45!null cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null c_customer_sk:93!null c_current_cdemo_sk:95!null c_current_hdemo_sk:96!null c_current_addr_sk:97!null ca_address_sk:113!null ca_gmt_offset:124!null cd_demo_sk:128!null cd_marital_status:130!null cd_education_status:131!null hd_demo_sk:139!null hd_buy_potential:141!null
           │    ├── key columns: [95] = [128]
           │    ├── lookup columns are key
           │    ├── immutable
           │    ├── fd: ()-->(69,71,124), (1)-->(2,7,12), (93)-->(95-97), (128)-->(130,131), (139)-->(141), (34)==(63), (63)==(34), (97)==(113), (113)==(97), (95)==(128), (128)==(95), (96)==(139), (139)==(96), (41)==(93), (93)==(41), (1)==(45), (45)==(1)
           │    ├── inner-join (lookup customer_address)
           │    │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12 cr_returned_date_sk:34!null cr_returning_customer_sk:41!null cr_call_center_sk:45!null cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null c_customer_sk:93!null c_current_cdemo_sk:95 c_current_hdemo_sk:96!null c_current_addr_sk:97!null ca_address_sk:113!null ca_gmt_offset:124!null hd_demo_sk:139!null hd_buy_potential:141!null
           │    │    ├── key columns: [97] = [113]
           │    │    ├── lookup columns are key
           │    │    ├── immutable
           │    │    ├── fd: ()-->(69,71,124), (1)-->(2,7,12), (93)-->(95-97), (139)-->(141), (96)==(139), (139)==(96), (97)==(113), (113)==(97), (41)==(93), (93)==(41), (34)==(63), (63)==(34), (1)==(45), (45)==(1)
           │    │    ├── inner-join (hash)
           │    │    │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12 cr_returned_date_sk:34!null cr_returning_customer_sk:41!null cr_call_center_sk:45!null cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null c_customer_sk:93!null c_current_cdemo_sk:95 c_current_hdemo_sk:96!null c_current_addr_sk:97 hd_demo_sk:139!null hd_buy_potential:141!null
           │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    ├── fd: ()-->(69,71), (1)-->(2,7,12), (93)-->(95-97), (139)-->(141), (96)==(139), (139)==(96), (41)==(93), (93)==(41), (34)==(63), (63)==(34), (1)==(45), (45)==(1)
           │    │    │    ├── inner-join (lookup customer)
           │    │    │    │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12 cr_returned_date_sk:34!null cr_returning_customer_sk:41!null cr_call_center_sk:45!null cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null c_customer_sk:93!null c_current_cdemo_sk:95 c_current_hdemo_sk:96 c_current_addr_sk:97
           │    │    │    │    ├── key columns: [41] = [93]
           │    │    │    │    ├── lookup columns are key
           │    │    │    │    ├── fd: ()-->(69,71), (1)-->(2,7,12), (93)-->(95-97), (41)==(93), (93)==(41), (34)==(63), (63)==(34), (1)==(45), (45)==(1)
           │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12 cr_returned_date_sk:34!null cr_returning_customer_sk:41 cr_call_center_sk:45!null cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null
           │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    ├── fd: ()-->(69,71), (1)-->(2,7,12), (34)==(63), (63)==(34), (1)==(45), (45)==(1)
           │    │    │    │    │    ├── inner-join (hash)
           │    │    │    │    │    │    ├── columns: cr_returned_date_sk:34!null cr_returning_customer_sk:41 cr_call_center_sk:45 cr_net_loss:60 d_date_sk:63!null d_year:69!null d_moy:71!null
           │    │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
           │    │    │    │    │    │    ├── fd: ()-->(69,71), (34)==(63), (63)==(34)
           │    │    │    │    │    │    ├── scan catalog_returns
           │    │    │    │    │    │    │    └── columns: cr_returned_date_sk:34 cr_returning_customer_sk:41 cr_call_center_sk:45 cr_net_loss:60
           │    │    │    │    │    │    ├── select
           │    │    │    │    │    │    │    ├── columns: d_date_sk:63!null d_year:69!null d_moy:71!null
           │    │    │    │    │    │    │    ├── key: (63)
           │    │    │    │    │    │    │    ├── fd: ()-->(69,71)
           │    │    │    │    │    │    │    ├── scan date_dim
           │    │    │    │    │    │    │    │    ├── columns: d_date_sk:63!null d_year:69 d_moy:71
           │    │    │    │    │    │    │    │    ├── key: (63)
           │    │    │    │    │    │    │    │    └── fd: (63)-->(69,71)
           │    │    │    │    │    │    │    └── filters
           │    │    │    │    │    │    │         ├── d_year:69 = 2000 [outer=(69), constraints=(/69: [/2000 - /2000]; tight), fd=()-->(69)]
           │    │    │    │    │    │    │         └── d_moy:71 = 12 [outer=(71), constraints=(/71: [/12 - /12]; tight), fd=()-->(71)]
           │    │    │    │    │    │    └── filters
           │    │    │    │    │    │         └── cr_returned_date_sk:34 = d_date_sk:63 [outer=(34,63), constraints=(/34: (/NULL - ]; /63: (/NULL - ]), fd=(34)==(63), (63)==(34)]
           │    │    │    │    │    ├── scan call_center
           │    │    │    │    │    │    ├── columns: cc_call_center_sk:1!null cc_call_center_id:2!null cc_name:7 cc_manager:12
           │    │    │    │    │    │    ├── key: (1)
           │    │    │    │    │    │    └── fd: (1)-->(2,7,12)
           │    │    │    │    │    └── filters
           │    │    │    │    │         └── cr_call_center_sk:45 = cc_call_center_sk:1 [outer=(1,45), constraints=(/1: (/NULL - ]; /45: (/NULL - ]), fd=(1)==(45), (45)==(1)]
           │    │    │    │    └── filters (true)
           │    │    │    ├── select
           │    │    │    │    ├── columns: hd_demo_sk:139!null hd_buy_potential:141!null
           │    │    │    │    ├── key: (139)
           │    │    │    │    ├── fd: (139)-->(141)
           │    │    │    │    ├── scan household_demographics
           │    │    │    │    │    ├── columns: hd_demo_sk:139!null hd_buy_potential:141
           │    │    │    │    │    ├── key: (139)
           │    │    │    │    │    └── fd: (139)-->(141)
           │    │    │    │    └── filters
           │    │    │    │         └── hd_buy_potential:141 LIKE 'Unknown%' [outer=(141), constraints=(/141: [/'Unknown' - /'Unknowo'); tight)]
           │    │    │    └── filters
           │    │    │         └── hd_demo_sk:139 = c_current_hdemo_sk:96 [outer=(96,139), constraints=(/96: (/NULL - ]; /139: (/NULL - ]), fd=(96)==(139), (139)==(96)]
           │    │    └── filters
           │    │         └── ca_gmt_offset:124 = -7 [outer=(124), immutable, constraints=(/124: [/-7 - /-7]; tight), fd=()-->(124)]
           │    └── filters
           │         └── ((cd_marital_status:130 = 'M') AND (cd_education_status:131 = 'Unknown')) OR ((cd_marital_status:130 = 'W') AND (cd_education_status:131 = 'Advanced Degree')) [outer=(130,131), constraints=(/130: [/'M' - /'M'] [/'W' - /'W']; /131: [/'Advanced Degree' - /'Advanced Degree'] [/'Unknown' - /'Unknown'])]
           └── aggregations
                └── sum [as=sum:146, outer=(60)]
                     └── cr_net_loss:60

# --------------------------------------------------
# Q92
# NOTE: Added conversion of 90 days to an interval.
opt
	SELECT
		sum(ws_ext_discount_amt) AS "Excess Discount Amount"
	FROM
		web_sales, item, date_dim
	WHERE
		i_manufact_id = 714
		AND i_item_sk = ws_item_sk
		AND d_date BETWEEN '2000-02-01' AND (CAST('2000-02-01' AS DATE) + '90 days'::INTERVAL)
		AND d_date_sk = ws_sold_date_sk
		AND ws_ext_discount_amt
			> (
					SELECT
						1.3 * avg(ws_ext_discount_amt)
					FROM
						web_sales, date_dim
					WHERE
						ws_item_sk = i_item_sk
						AND d_date BETWEEN '2000-02-01' AND (CAST('2000-02-01' AS DATE) + '90 days'::INTERVAL)
						AND d_date_sk = ws_sold_date_sk
				)
	ORDER BY
		sum(ws_ext_discount_amt)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: "Excess Discount Amount":159
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── key: ()
 ├── fd: ()-->(159)
 ├── inner-join (lookup web_sales)
 │    ├── columns: ws_sold_date_sk:1!null ws_item_sk:4!null ws_ext_discount_amt:23!null i_item_sk:37!null d_date_sk:61!null "?column?":158!null
 │    ├── key columns: [37] = [4]
 │    ├── immutable
 │    ├── fd: (37,61)-->(158), (4)==(37), (37)==(4), (1)==(61), (61)==(1)
 │    ├── project
 │    │    ├── columns: "?column?":158!null i_item_sk:37!null d_date_sk:61!null
 │    │    ├── immutable
 │    │    ├── key: (37,61)
 │    │    ├── fd: (37,61)-->(158)
 │    │    ├── group-by (hash)
 │    │    │    ├── columns: i_item_sk:37!null d_date_sk:61!null avg:157!null
 │    │    │    ├── grouping columns: i_item_sk:37!null d_date_sk:61!null
 │    │    │    ├── immutable
 │    │    │    ├── key: (37,61)
 │    │    │    ├── fd: (37,61)-->(157)
 │    │    │    ├── inner-join (cross)
 │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null d_date_sk:61!null d_date:63!null ws_sold_date_sk:91!null ws_item_sk:94!null ws_ext_discount_amt:113!null d_date_sk:127!null d_date:129!null
 │    │    │    │    ├── immutable
 │    │    │    │    ├── fd: ()-->(50), (61)-->(63), (127)-->(129), (91)==(127), (127)==(91), (37)==(94), (94)==(37)
 │    │    │    │    ├── inner-join (lookup date_dim)
 │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null ws_sold_date_sk:91!null ws_item_sk:94!null ws_ext_discount_amt:113!null d_date_sk:127!null d_date:129!null
 │    │    │    │    │    ├── key columns: [91] = [127]
 │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    ├── immutable
 │    │    │    │    │    ├── fd: ()-->(50), (127)-->(129), (91)==(127), (127)==(91), (37)==(94), (94)==(37)
 │    │    │    │    │    ├── inner-join (lookup web_sales)
 │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null ws_sold_date_sk:91 ws_item_sk:94!null ws_ext_discount_amt:113!null
 │    │    │    │    │    │    ├── key columns: [37] = [94]
 │    │    │    │    │    │    ├── immutable
 │    │    │    │    │    │    ├── fd: ()-->(50), (37)==(94), (94)==(37)
 │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50!null
 │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    ├── fd: ()-->(50)
 │    │    │    │    │    │    │    ├── scan item
 │    │    │    │    │    │    │    │    ├── columns: i_item_sk:37!null i_manufact_id:50
 │    │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    │    └── fd: (37)-->(50)
 │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │         └── i_manufact_id:50 = 714 [outer=(50), constraints=(/50: [/714 - /714]; tight), fd=()-->(50)]
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── ws_ext_discount_amt:113 IS NOT NULL [outer=(113), immutable, constraints=(/113: (/NULL - ]; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (d_date:129 >= '2000-02-01') AND (d_date:129 <= '2000-05-01') [outer=(129), constraints=(/129: [/'2000-02-01' - /'2000-05-01']; tight)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63!null
 │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    ├── fd: (61)-->(63)
 │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    ├── columns: d_date_sk:61!null d_date:63
 │    │    │    │    │    │    ├── key: (61)
 │    │    │    │    │    │    └── fd: (61)-->(63)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── (d_date:63 >= '2000-02-01') AND (d_date:63 <= '2000-05-01') [outer=(63), constraints=(/63: [/'2000-02-01' - /'2000-05-01']; tight)]
 │    │    │    │    └── filters (true)
 │    │    │    └── aggregations
 │    │    │         └── avg [as=avg:157, outer=(113)]
 │    │    │              └── ws_ext_discount_amt:113
 │    │    └── projections
 │    │         └── avg:157 * 1.3 [as="?column?":158, outer=(157), immutable]
 │    └── filters
 │         ├── d_date_sk:61 = ws_sold_date_sk:1 [outer=(1,61), constraints=(/1: (/NULL - ]; /61: (/NULL - ]), fd=(1)==(61), (61)==(1)]
 │         └── ws_ext_discount_amt:23 > "?column?":158 [outer=(23,158), immutable, constraints=(/23: (/NULL - ]; /158: (/NULL - ])]
 └── aggregations
      └── sum [as=sum:159, outer=(23)]
           └── ws_ext_discount_amt:23

# --------------------------------------------------
# Q93
opt
	SELECT
		ss_customer_sk, sum(act_sales) AS sumsales
	FROM
		(
			SELECT
				ss_item_sk,
				ss_ticket_number,
				ss_customer_sk,
				CASE
				WHEN sr_return_quantity IS NOT NULL
				THEN (ss_quantity - sr_return_quantity)
				* ss_sales_price
				ELSE (ss_quantity * ss_sales_price)
				END
					AS act_sales
			FROM
				store_sales
				LEFT JOIN store_returns ON
						sr_item_sk = ss_item_sk
						AND sr_ticket_number = ss_ticket_number,
				reason
			WHERE
				sr_reason_sk = r_reason_sk
				AND r_reason_desc = 'reason 58'
		)
			AS t
	GROUP BY
		ss_customer_sk
	ORDER BY
		sumsales, ss_customer_sk
	LIMIT
		100;
----
top-k
 ├── columns: ss_customer_sk:4 sumsales:54
 ├── internal-ordering: +54,+4
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (4)
 ├── fd: (4)-->(54)
 ├── ordering: +54,+4
 └── group-by (hash)
      ├── columns: ss_customer_sk:4 sum:54
      ├── grouping columns: ss_customer_sk:4
      ├── immutable
      ├── key: (4)
      ├── fd: (4)-->(54)
      ├── project
      │    ├── columns: act_sales:53 ss_customer_sk:4
      │    ├── immutable
      │    ├── inner-join (lookup store_sales)
      │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4 ss_ticket_number:10!null ss_quantity:11 ss_sales_price:14 sr_item_sk:28!null sr_reason_sk:34!null sr_ticket_number:35!null sr_return_quantity:36 r_reason_sk:48!null r_reason_desc:50!null
      │    │    ├── key columns: [28 35] = [3 10]
      │    │    ├── lookup columns are key
      │    │    ├── key: (28,35)
      │    │    ├── fd: ()-->(50), (3,10)-->(4,11,14), (28,35)-->(34,36), (3)==(28), (28)==(3), (10)==(35), (35)==(10), (34)==(48), (48)==(34)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: sr_item_sk:28!null sr_reason_sk:34!null sr_ticket_number:35!null sr_return_quantity:36 r_reason_sk:48!null r_reason_desc:50!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── key: (28,35)
      │    │    │    ├── fd: ()-->(50), (28,35)-->(34,36), (34)==(48), (48)==(34)
      │    │    │    ├── select
      │    │    │    │    ├── columns: sr_item_sk:28!null sr_reason_sk:34!null sr_ticket_number:35!null sr_return_quantity:36
      │    │    │    │    ├── key: (28,35)
      │    │    │    │    ├── fd: (28,35)-->(34,36)
      │    │    │    │    ├── scan store_returns
      │    │    │    │    │    ├── columns: sr_item_sk:28!null sr_reason_sk:34 sr_ticket_number:35!null sr_return_quantity:36
      │    │    │    │    │    ├── key: (28,35)
      │    │    │    │    │    └── fd: (28,35)-->(34,36)
      │    │    │    │    └── filters
      │    │    │    │         └── sr_reason_sk:34 IS NOT NULL [outer=(34), constraints=(/34: (/NULL - ]; tight)]
      │    │    │    ├── select
      │    │    │    │    ├── columns: r_reason_sk:48!null r_reason_desc:50!null
      │    │    │    │    ├── key: (48)
      │    │    │    │    ├── fd: ()-->(50)
      │    │    │    │    ├── scan reason
      │    │    │    │    │    ├── columns: r_reason_sk:48!null r_reason_desc:50
      │    │    │    │    │    ├── key: (48)
      │    │    │    │    │    └── fd: (48)-->(50)
      │    │    │    │    └── filters
      │    │    │    │         └── r_reason_desc:50 = 'reason 58' [outer=(50), constraints=(/50: [/'reason 58' - /'reason 58']; tight), fd=()-->(50)]
      │    │    │    └── filters
      │    │    │         └── sr_reason_sk:34 = r_reason_sk:48 [outer=(34,48), constraints=(/34: (/NULL - ]; /48: (/NULL - ]), fd=(34)==(48), (48)==(34)]
      │    │    └── filters (true)
      │    └── projections
      │         └── CASE WHEN sr_return_quantity:36 IS NOT NULL THEN ss_sales_price:14 * (ss_quantity:11 - sr_return_quantity:36) ELSE ss_quantity:11 * ss_sales_price:14 END [as=act_sales:53, outer=(11,14,36), immutable]
      └── aggregations
           └── sum [as=sum:54, outer=(53)]
                └── act_sales:53

# --------------------------------------------------
# Q94
# NOTE: Added conversion of 60 days to an interval.
opt
	SELECT
		count(DISTINCT ws_order_number) AS "order count",
		sum(ws_ext_ship_cost) AS "total shipping cost",
		sum(ws_net_profit) AS "total net profit"
	FROM
		web_sales AS ws1, date_dim, customer_address, web_site
	WHERE
		d_date BETWEEN '2002-5-01' AND (CAST('2002-5-01' AS DATE) + '60 days'::INTERVAL)
		AND ws1.ws_ship_date_sk = d_date_sk
		AND ws1.ws_ship_addr_sk = ca_address_sk
		AND ca_state = 'OK'
		AND ws1.ws_web_site_sk = web_site_sk
		AND web_company_name = 'pri'
		AND EXISTS(
				SELECT
					*
				FROM
					web_sales AS ws2
				WHERE
					ws1.ws_order_number = ws2.ws_order_number
					AND ws1.ws_warehouse_sk
						!= ws2.ws_warehouse_sk
			)
		AND NOT
				EXISTS(
					SELECT
						*
					FROM
						web_returns AS wr1
					WHERE
						ws1.ws_order_number
						= wr1.wr_order_number
				)
	ORDER BY
		count(DISTINCT ws_order_number)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: "order count":174!null "total shipping cost":175 "total net profit":176
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(174-176)
 ├── semi-join (hash)
 │    ├── columns: ws1.ws_ship_date_sk:3!null ws1.ws_ship_addr_sk:12!null ws1.ws_web_site_sk:14!null ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null web_site_sk:82!null web_company_name:96!null
 │    ├── fd: ()-->(75,96), (37)-->(39), (3)==(37), (37)==(3), (12)==(67), (67)==(12), (14)==(82), (82)==(14)
 │    ├── inner-join (lookup customer_address)
 │    │    ├── columns: ws1.ws_ship_date_sk:3!null ws1.ws_ship_addr_sk:12!null ws1.ws_web_site_sk:14!null ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34 d_date_sk:37!null d_date:39!null ca_address_sk:67!null ca_state:75!null web_site_sk:82!null web_company_name:96!null
 │    │    ├── key columns: [12] = [67]
 │    │    ├── lookup columns are key
 │    │    ├── fd: ()-->(75,96), (37)-->(39), (14)==(82), (82)==(14), (12)==(67), (67)==(12), (3)==(37), (37)==(3)
 │    │    ├── anti-join (hash)
 │    │    │    ├── columns: ws1.ws_ship_date_sk:3!null ws1.ws_ship_addr_sk:12 ws1.ws_web_site_sk:14!null ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34 d_date_sk:37!null d_date:39!null web_site_sk:82!null web_company_name:96!null
 │    │    │    ├── fd: ()-->(96), (37)-->(39), (14)==(82), (82)==(14), (3)==(37), (37)==(3)
 │    │    │    ├── inner-join (hash)
 │    │    │    │    ├── columns: ws1.ws_ship_date_sk:3!null ws1.ws_ship_addr_sk:12 ws1.ws_web_site_sk:14!null ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34 d_date_sk:37!null d_date:39!null web_site_sk:82!null web_company_name:96!null
 │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    ├── fd: ()-->(96), (37)-->(39), (14)==(82), (82)==(14), (3)==(37), (37)==(3)
 │    │    │    │    ├── inner-join (hash)
 │    │    │    │    │    ├── columns: ws1.ws_ship_date_sk:3!null ws1.ws_ship_addr_sk:12 ws1.ws_web_site_sk:14 ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34 d_date_sk:37!null d_date:39!null
 │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │    │    ├── fd: (37)-->(39), (3)==(37), (37)==(3)
 │    │    │    │    │    ├── scan web_sales [as=ws1]
 │    │    │    │    │    │    └── columns: ws1.ws_ship_date_sk:3 ws1.ws_ship_addr_sk:12 ws1.ws_web_site_sk:14 ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null ws1.ws_ext_ship_cost:29 ws1.ws_net_profit:34
 │    │    │    │    │    ├── select
 │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39!null
 │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    ├── fd: (37)-->(39)
 │    │    │    │    │    │    ├── scan date_dim
 │    │    │    │    │    │    │    ├── columns: d_date_sk:37!null d_date:39
 │    │    │    │    │    │    │    ├── key: (37)
 │    │    │    │    │    │    │    └── fd: (37)-->(39)
 │    │    │    │    │    │    └── filters
 │    │    │    │    │    │         └── (d_date:39 >= '2002-05-01') AND (d_date:39 <= '2002-06-30') [outer=(39), constraints=(/39: [/'2002-05-01' - /'2002-06-30']; tight)]
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── ws1.ws_ship_date_sk:3 = d_date_sk:37 [outer=(3,37), constraints=(/3: (/NULL - ]; /37: (/NULL - ]), fd=(3)==(37), (37)==(3)]
 │    │    │    │    ├── select
 │    │    │    │    │    ├── columns: web_site_sk:82!null web_company_name:96!null
 │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    ├── fd: ()-->(96)
 │    │    │    │    │    ├── scan web_site
 │    │    │    │    │    │    ├── columns: web_site_sk:82!null web_company_name:96
 │    │    │    │    │    │    ├── key: (82)
 │    │    │    │    │    │    └── fd: (82)-->(96)
 │    │    │    │    │    └── filters
 │    │    │    │    │         └── web_company_name:96 = 'pri' [outer=(96), constraints=(/96: [/'pri' - /'pri']; tight), fd=()-->(96)]
 │    │    │    │    └── filters
 │    │    │    │         └── ws1.ws_web_site_sk:14 = web_site_sk:82 [outer=(14,82), constraints=(/14: (/NULL - ]; /82: (/NULL - ]), fd=(14)==(82), (82)==(14)]
 │    │    │    ├── scan web_returns [as=wr1]
 │    │    │    │    └── columns: wr_order_number:159!null
 │    │    │    └── filters
 │    │    │         └── ws1.ws_order_number:18 = wr_order_number:159 [outer=(18,159), constraints=(/18: (/NULL - ]; /159: (/NULL - ]), fd=(18)==(159), (159)==(18)]
 │    │    └── filters
 │    │         └── ca_state:75 = 'OK' [outer=(75), constraints=(/75: [/'OK' - /'OK']; tight), fd=()-->(75)]
 │    ├── scan web_sales [as=ws2]
 │    │    └── columns: ws2.ws_warehouse_sk:125 ws2.ws_order_number:127!null
 │    └── filters
 │         ├── ws1.ws_order_number:18 = ws2.ws_order_number:127 [outer=(18,127), constraints=(/18: (/NULL - ]; /127: (/NULL - ]), fd=(18)==(127), (127)==(18)]
 │         └── ws1.ws_warehouse_sk:16 != ws2.ws_warehouse_sk:125 [outer=(16,125), constraints=(/16: (/NULL - ]; /125: (/NULL - ])]
 └── aggregations
      ├── agg-distinct [as=count:174, outer=(18)]
      │    └── count
      │         └── ws1.ws_order_number:18
      ├── sum [as=sum:175, outer=(29)]
      │    └── ws1.ws_ext_ship_cost:29
      └── sum [as=sum:176, outer=(34)]
           └── ws1.ws_net_profit:34

# --------------------------------------------------
# Q95
# NOTE: Added conversion of 60 days to an interval.
opt
	WITH
		ws_wh
			AS (
				SELECT
					ws1.ws_order_number,
					ws1.ws_warehouse_sk AS wh1,
					ws2.ws_warehouse_sk AS wh2
				FROM
					web_sales AS ws1, web_sales AS ws2
				WHERE
					ws1.ws_order_number = ws2.ws_order_number
					AND ws1.ws_warehouse_sk
						!= ws2.ws_warehouse_sk
			)
	SELECT
		count(DISTINCT ws_order_number) AS "order count",
		sum(ws_ext_ship_cost) AS "total shipping cost",
		sum(ws_net_profit) AS "total net profit"
	FROM
		web_sales AS ws1, date_dim, customer_address, web_site
	WHERE
		d_date BETWEEN '2001-4-01' AND (CAST('2001-4-01' AS DATE) + '60 days'::INTERVAL)
		AND ws1.ws_ship_date_sk = d_date_sk
		AND ws1.ws_ship_addr_sk = ca_address_sk
		AND ca_state = 'VA'
		AND ws1.ws_web_site_sk = web_site_sk
		AND web_company_name = 'pri'
		AND ws1.ws_order_number
			IN (SELECT ws_order_number FROM ws_wh)
		AND ws1.ws_order_number
			IN (
					SELECT
						wr_order_number
					FROM
						web_returns, ws_wh
					WHERE
						wr_order_number = ws_wh.ws_order_number
				)
	ORDER BY
		count(DISTINCT ws_order_number)
	LIMIT
		100;
----
with &1 (ws_wh)
 ├── columns: "order count":216!null "total shipping cost":217 "total net profit":218
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(216-218)
 ├── project
 │    ├── columns: ws1.ws_warehouse_sk:16!null ws1.ws_order_number:18!null ws2.ws_warehouse_sk:52!null
 │    └── inner-join (hash)
 │         ├── columns: ws1.ws_warehouse_sk:16!null ws1.ws_order_number:18!null ws2.ws_warehouse_sk:52!null ws2.ws_order_number:54!null
 │         ├── fd: (18)==(54), (54)==(18)
 │         ├── scan web_sales [as=ws1]
 │         │    └── columns: ws1.ws_warehouse_sk:16 ws1.ws_order_number:18!null
 │         ├── scan web_sales [as=ws2]
 │         │    └── columns: ws2.ws_warehouse_sk:52 ws2.ws_order_number:54!null
 │         └── filters
 │              ├── ws1.ws_order_number:18 = ws2.ws_order_number:54 [outer=(18,54), constraints=(/18: (/NULL - ]; /54: (/NULL - ]), fd=(18)==(54), (54)==(18)]
 │              └── ws1.ws_warehouse_sk:16 != ws2.ws_warehouse_sk:52 [outer=(16,52), constraints=(/16: (/NULL - ]; /52: (/NULL - ])]
 └── scalar-group-by
      ├── columns: count:216!null sum:217 sum:218
      ├── cardinality: [1 - 1]
      ├── key: ()
      ├── fd: ()-->(216-218)
      ├── semi-join (hash)
      │    ├── columns: ws1.ws_ship_date_sk:75!null ws1.ws_ship_addr_sk:84!null ws1.ws_web_site_sk:86!null ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106 d_date_sk:109!null d_date:111!null ca_address_sk:139!null ca_state:147!null web_site_sk:154!null web_company_name:168!null
      │    ├── fd: ()-->(147,168), (109)-->(111), (75)==(109), (109)==(75), (84)==(139), (139)==(84), (86)==(154), (154)==(86)
      │    ├── semi-join (hash)
      │    │    ├── columns: ws1.ws_ship_date_sk:75!null ws1.ws_ship_addr_sk:84!null ws1.ws_web_site_sk:86!null ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106 d_date_sk:109!null d_date:111!null ca_address_sk:139!null ca_state:147!null web_site_sk:154!null web_company_name:168!null
      │    │    ├── fd: ()-->(147,168), (109)-->(111), (86)==(154), (154)==(86), (84)==(139), (139)==(84), (75)==(109), (109)==(75)
      │    │    ├── inner-join (lookup customer_address)
      │    │    │    ├── columns: ws1.ws_ship_date_sk:75!null ws1.ws_ship_addr_sk:84!null ws1.ws_web_site_sk:86!null ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106 d_date_sk:109!null d_date:111!null ca_address_sk:139!null ca_state:147!null web_site_sk:154!null web_company_name:168!null
      │    │    │    ├── key columns: [84] = [139]
      │    │    │    ├── lookup columns are key
      │    │    │    ├── fd: ()-->(147,168), (109)-->(111), (86)==(154), (154)==(86), (84)==(139), (139)==(84), (75)==(109), (109)==(75)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: ws1.ws_ship_date_sk:75!null ws1.ws_ship_addr_sk:84 ws1.ws_web_site_sk:86!null ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106 d_date_sk:109!null d_date:111!null web_site_sk:154!null web_company_name:168!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: ()-->(168), (109)-->(111), (86)==(154), (154)==(86), (75)==(109), (109)==(75)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: ws1.ws_ship_date_sk:75!null ws1.ws_ship_addr_sk:84 ws1.ws_web_site_sk:86 ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106 d_date_sk:109!null d_date:111!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: (109)-->(111), (75)==(109), (109)==(75)
      │    │    │    │    │    ├── scan web_sales [as=ws1]
      │    │    │    │    │    │    └── columns: ws1.ws_ship_date_sk:75 ws1.ws_ship_addr_sk:84 ws1.ws_web_site_sk:86 ws1.ws_order_number:90!null ws1.ws_ext_ship_cost:101 ws1.ws_net_profit:106
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:109!null d_date:111!null
      │    │    │    │    │    │    ├── key: (109)
      │    │    │    │    │    │    ├── fd: (109)-->(111)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:109!null d_date:111
      │    │    │    │    │    │    │    ├── key: (109)
      │    │    │    │    │    │    │    └── fd: (109)-->(111)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── (d_date:111 >= '2001-04-01') AND (d_date:111 <= '2001-05-31') [outer=(111), constraints=(/111: [/'2001-04-01' - /'2001-05-31']; tight)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── ws1.ws_ship_date_sk:75 = d_date_sk:109 [outer=(75,109), constraints=(/75: (/NULL - ]; /109: (/NULL - ]), fd=(75)==(109), (109)==(75)]
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: web_site_sk:154!null web_company_name:168!null
      │    │    │    │    │    ├── key: (154)
      │    │    │    │    │    ├── fd: ()-->(168)
      │    │    │    │    │    ├── scan web_site
      │    │    │    │    │    │    ├── columns: web_site_sk:154!null web_company_name:168
      │    │    │    │    │    │    ├── key: (154)
      │    │    │    │    │    │    └── fd: (154)-->(168)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── web_company_name:168 = 'pri' [outer=(168), constraints=(/168: [/'pri' - /'pri']; tight), fd=()-->(168)]
      │    │    │    │    └── filters
      │    │    │    │         └── ws1.ws_web_site_sk:86 = web_site_sk:154 [outer=(86,154), constraints=(/86: (/NULL - ]; /154: (/NULL - ]), fd=(86)==(154), (154)==(86)]
      │    │    │    └── filters
      │    │    │         └── ca_state:147 = 'VA' [outer=(147), constraints=(/147: [/'VA' - /'VA']; tight), fd=()-->(147)]
      │    │    ├── with-scan &1 (ws_wh)
      │    │    │    ├── columns: ws_order_number:182!null
      │    │    │    └── mapping:
      │    │    │         └──  ws1.ws_order_number:18 => ws_order_number:182
      │    │    └── filters
      │    │         └── ws1.ws_order_number:90 = ws_order_number:182 [outer=(90,182), constraints=(/90: (/NULL - ]; /182: (/NULL - ]), fd=(90)==(182), (182)==(90)]
      │    ├── inner-join (hash)
      │    │    ├── columns: wr_order_number:198!null ws_order_number:211!null
      │    │    ├── fd: (198)==(211), (211)==(198)
      │    │    ├── with-scan &1 (ws_wh)
      │    │    │    ├── columns: ws_order_number:211!null
      │    │    │    └── mapping:
      │    │    │         └──  ws1.ws_order_number:18 => ws_order_number:211
      │    │    ├── scan web_returns
      │    │    │    └── columns: wr_order_number:198!null
      │    │    └── filters
      │    │         └── wr_order_number:198 = ws_order_number:211 [outer=(198,211), constraints=(/198: (/NULL - ]; /211: (/NULL - ]), fd=(198)==(211), (211)==(198)]
      │    └── filters
      │         └── ws1.ws_order_number:90 = wr_order_number:198 [outer=(90,198), constraints=(/90: (/NULL - ]; /198: (/NULL - ]), fd=(90)==(198), (198)==(90)]
      └── aggregations
           ├── agg-distinct [as=count:216, outer=(90)]
           │    └── count
           │         └── ws1.ws_order_number:90
           ├── sum [as=sum:217, outer=(101)]
           │    └── ws1.ws_ext_ship_cost:101
           └── sum [as=sum:218, outer=(106)]
                └── ws1.ws_net_profit:106

# --------------------------------------------------
# Q96
opt
	SELECT
		count(*)
	FROM
		store_sales, household_demographics, time_dim, store
	WHERE
		ss_sold_time_sk = time_dim.t_time_sk
		AND ss_hdemo_sk = household_demographics.hd_demo_sk
		AND ss_store_sk = s_store_sk
		AND time_dim.t_hour = 8
		AND time_dim.t_minute >= 30
		AND household_demographics.hd_dep_count = 0
		AND store.s_store_name = 'ese'
	ORDER BY
		count(*)
	LIMIT
		100;
----
scalar-group-by
 ├── columns: count:76!null
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(76)
 ├── inner-join (hash)
 │    ├── columns: ss_sold_time_sk:2!null ss_hdemo_sk:6!null ss_store_sk:8!null hd_demo_sk:26!null hd_dep_count:29!null t_time_sk:33!null t_hour:36!null t_minute:37!null s_store_sk:45!null s_store_name:50!null
 │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    ├── fd: ()-->(29,36,50), (33)-->(37), (6)==(26), (26)==(6), (2)==(33), (33)==(2), (8)==(45), (45)==(8)
 │    ├── inner-join (hash)
 │    │    ├── columns: ss_sold_time_sk:2!null ss_hdemo_sk:6!null ss_store_sk:8 hd_demo_sk:26!null hd_dep_count:29!null t_time_sk:33!null t_hour:36!null t_minute:37!null
 │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    ├── fd: ()-->(29,36), (33)-->(37), (6)==(26), (26)==(6), (2)==(33), (33)==(2)
 │    │    ├── inner-join (hash)
 │    │    │    ├── columns: ss_sold_time_sk:2!null ss_hdemo_sk:6 ss_store_sk:8 t_time_sk:33!null t_hour:36!null t_minute:37!null
 │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    ├── fd: ()-->(36), (33)-->(37), (2)==(33), (33)==(2)
 │    │    │    ├── scan store_sales
 │    │    │    │    └── columns: ss_sold_time_sk:2 ss_hdemo_sk:6 ss_store_sk:8
 │    │    │    ├── select
 │    │    │    │    ├── columns: t_time_sk:33!null t_hour:36!null t_minute:37!null
 │    │    │    │    ├── key: (33)
 │    │    │    │    ├── fd: ()-->(36), (33)-->(37)
 │    │    │    │    ├── scan time_dim
 │    │    │    │    │    ├── columns: t_time_sk:33!null t_hour:36 t_minute:37
 │    │    │    │    │    ├── key: (33)
 │    │    │    │    │    └── fd: (33)-->(36,37)
 │    │    │    │    └── filters
 │    │    │    │         ├── t_hour:36 = 8 [outer=(36), constraints=(/36: [/8 - /8]; tight), fd=()-->(36)]
 │    │    │    │         └── t_minute:37 >= 30 [outer=(37), constraints=(/37: [/30 - ]; tight)]
 │    │    │    └── filters
 │    │    │         └── ss_sold_time_sk:2 = t_time_sk:33 [outer=(2,33), constraints=(/2: (/NULL - ]; /33: (/NULL - ]), fd=(2)==(33), (33)==(2)]
 │    │    ├── select
 │    │    │    ├── columns: hd_demo_sk:26!null hd_dep_count:29!null
 │    │    │    ├── key: (26)
 │    │    │    ├── fd: ()-->(29)
 │    │    │    ├── scan household_demographics
 │    │    │    │    ├── columns: hd_demo_sk:26!null hd_dep_count:29
 │    │    │    │    ├── key: (26)
 │    │    │    │    └── fd: (26)-->(29)
 │    │    │    └── filters
 │    │    │         └── hd_dep_count:29 = 0 [outer=(29), constraints=(/29: [/0 - /0]; tight), fd=()-->(29)]
 │    │    └── filters
 │    │         └── ss_hdemo_sk:6 = hd_demo_sk:26 [outer=(6,26), constraints=(/6: (/NULL - ]; /26: (/NULL - ]), fd=(6)==(26), (26)==(6)]
 │    ├── select
 │    │    ├── columns: s_store_sk:45!null s_store_name:50!null
 │    │    ├── key: (45)
 │    │    ├── fd: ()-->(50)
 │    │    ├── scan store
 │    │    │    ├── columns: s_store_sk:45!null s_store_name:50
 │    │    │    ├── key: (45)
 │    │    │    └── fd: (45)-->(50)
 │    │    └── filters
 │    │         └── s_store_name:50 = 'ese' [outer=(50), constraints=(/50: [/'ese' - /'ese']; tight), fd=()-->(50)]
 │    └── filters
 │         └── ss_store_sk:8 = s_store_sk:45 [outer=(8,45), constraints=(/8: (/NULL - ]; /45: (/NULL - ]), fd=(8)==(45), (45)==(8)]
 └── aggregations
      └── count-rows [as=count_rows:76]

# --------------------------------------------------
# Q97
opt
	WITH
		ssci
			AS (
				SELECT
					ss_customer_sk AS customer_sk,
					ss_item_sk AS item_sk
				FROM
					store_sales, date_dim
				WHERE
					ss_sold_date_sk = d_date_sk
					AND d_month_seq BETWEEN 1199 AND (1199 + 11)
				GROUP BY
					ss_customer_sk, ss_item_sk
			),
		csci
			AS (
				SELECT
					cs_bill_customer_sk AS customer_sk,
					cs_item_sk AS item_sk
				FROM
					catalog_sales, date_dim
				WHERE
					cs_sold_date_sk = d_date_sk
					AND d_month_seq BETWEEN 1199 AND (1199 + 11)
				GROUP BY
					cs_bill_customer_sk, cs_item_sk
			)
	SELECT
		sum(
			CASE
			WHEN ssci.customer_sk IS NOT NULL
			AND csci.customer_sk IS NULL
			THEN 1
			ELSE 0
			END
		)
			AS store_only,
		sum(
			CASE
			WHEN ssci.customer_sk IS NULL
			AND csci.customer_sk IS NOT NULL
			THEN 1
			ELSE 0
			END
		)
			AS catalog_only,
		sum(
			CASE
			WHEN ssci.customer_sk IS NOT NULL
			AND csci.customer_sk IS NOT NULL
			THEN 1
			ELSE 0
			END
		)
			AS store_and_catalog
	FROM
		ssci
		FULL JOIN csci ON
				ssci.customer_sk = csci.customer_sk
				AND ssci.item_sk = csci.item_sk
	LIMIT
		100;
----
scalar-group-by
 ├── columns: store_only:127 catalog_only:129 store_and_catalog:131
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(127,129,131)
 ├── project
 │    ├── columns: column126:126!null column128:128!null column130:130!null
 │    ├── full-join (hash)
 │    │    ├── columns: customer_sk:122 item_sk:123 customer_sk:124 item_sk:125
 │    │    ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 │    │    ├── key: (122-125)
 │    │    ├── project
 │    │    │    ├── columns: customer_sk:122 item_sk:123!null
 │    │    │    ├── key: (122,123)
 │    │    │    ├── distinct-on
 │    │    │    │    ├── columns: ss_item_sk:3!null ss_customer_sk:4
 │    │    │    │    ├── grouping columns: ss_item_sk:3!null ss_customer_sk:4
 │    │    │    │    ├── key: (3,4)
 │    │    │    │    └── inner-join (hash)
 │    │    │    │         ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_customer_sk:4 d_date_sk:26!null d_month_seq:29!null
 │    │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │         ├── fd: (26)-->(29), (1)==(26), (26)==(1)
 │    │    │    │         ├── scan store_sales
 │    │    │    │         │    └── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_customer_sk:4
 │    │    │    │         ├── select
 │    │    │    │         │    ├── columns: d_date_sk:26!null d_month_seq:29!null
 │    │    │    │         │    ├── key: (26)
 │    │    │    │         │    ├── fd: (26)-->(29)
 │    │    │    │         │    ├── scan date_dim
 │    │    │    │         │    │    ├── columns: d_date_sk:26!null d_month_seq:29
 │    │    │    │         │    │    ├── key: (26)
 │    │    │    │         │    │    └── fd: (26)-->(29)
 │    │    │    │         │    └── filters
 │    │    │    │         │         └── (d_month_seq:29 >= 1199) AND (d_month_seq:29 <= 1210) [outer=(29), constraints=(/29: [/1199 - /1210]; tight)]
 │    │    │    │         └── filters
 │    │    │    │              └── ss_sold_date_sk:1 = d_date_sk:26 [outer=(1,26), constraints=(/1: (/NULL - ]; /26: (/NULL - ]), fd=(1)==(26), (26)==(1)]
 │    │    │    └── projections
 │    │    │         ├── ss_customer_sk:4 [as=customer_sk:122, outer=(4)]
 │    │    │         └── ss_item_sk:3 [as=item_sk:123, outer=(3)]
 │    │    ├── project
 │    │    │    ├── columns: customer_sk:124 item_sk:125!null
 │    │    │    ├── key: (124,125)
 │    │    │    ├── distinct-on
 │    │    │    │    ├── columns: cs_bill_customer_sk:59 cs_item_sk:71!null
 │    │    │    │    ├── grouping columns: cs_bill_customer_sk:59 cs_item_sk:71!null
 │    │    │    │    ├── key: (59,71)
 │    │    │    │    └── inner-join (hash)
 │    │    │    │         ├── columns: cs_sold_date_sk:56!null cs_bill_customer_sk:59 cs_item_sk:71!null d_date_sk:92!null d_month_seq:95!null
 │    │    │    │         ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
 │    │    │    │         ├── fd: (92)-->(95), (56)==(92), (92)==(56)
 │    │    │    │         ├── scan catalog_sales
 │    │    │    │         │    └── columns: cs_sold_date_sk:56 cs_bill_customer_sk:59 cs_item_sk:71!null
 │    │    │    │         ├── select
 │    │    │    │         │    ├── columns: d_date_sk:92!null d_month_seq:95!null
 │    │    │    │         │    ├── key: (92)
 │    │    │    │         │    ├── fd: (92)-->(95)
 │    │    │    │         │    ├── scan date_dim
 │    │    │    │         │    │    ├── columns: d_date_sk:92!null d_month_seq:95
 │    │    │    │         │    │    ├── key: (92)
 │    │    │    │         │    │    └── fd: (92)-->(95)
 │    │    │    │         │    └── filters
 │    │    │    │         │         └── (d_month_seq:95 >= 1199) AND (d_month_seq:95 <= 1210) [outer=(95), constraints=(/95: [/1199 - /1210]; tight)]
 │    │    │    │         └── filters
 │    │    │    │              └── cs_sold_date_sk:56 = d_date_sk:92 [outer=(56,92), constraints=(/56: (/NULL - ]; /92: (/NULL - ]), fd=(56)==(92), (92)==(56)]
 │    │    │    └── projections
 │    │    │         ├── cs_bill_customer_sk:59 [as=customer_sk:124, outer=(59)]
 │    │    │         └── cs_item_sk:71 [as=item_sk:125, outer=(71)]
 │    │    └── filters
 │    │         ├── customer_sk:122 = customer_sk:124 [outer=(122,124), constraints=(/122: (/NULL - ]; /124: (/NULL - ]), fd=(122)==(124), (124)==(122)]
 │    │         └── item_sk:123 = item_sk:125 [outer=(123,125), constraints=(/123: (/NULL - ]; /125: (/NULL - ]), fd=(123)==(125), (125)==(123)]
 │    └── projections
 │         ├── CASE WHEN (customer_sk:122 IS NOT NULL) AND (customer_sk:124 IS NULL) THEN 1 ELSE 0 END [as=column126:126, outer=(122,124)]
 │         ├── CASE WHEN (customer_sk:122 IS NULL) AND (customer_sk:124 IS NOT NULL) THEN 1 ELSE 0 END [as=column128:128, outer=(122,124)]
 │         └── CASE WHEN (customer_sk:122 IS NOT NULL) AND (customer_sk:124 IS NOT NULL) THEN 1 ELSE 0 END [as=column130:130, outer=(122,124)]
 └── aggregations
      ├── sum [as=sum:127, outer=(126)]
      │    └── column126:126
      ├── sum [as=sum:129, outer=(128)]
      │    └── column128:128
      └── sum [as=sum:131, outer=(130)]
           └── column130:130

# --------------------------------------------------
# Q98
# NOTE: Added conversion of 30 days to an interval.
opt
	SELECT
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price,
		sum(ss_ext_sales_price) AS itemrevenue,
		sum(ss_ext_sales_price) * 100
		/ sum(sum(ss_ext_sales_price)) OVER (
				PARTITION BY i_class
			)
			AS revenueratio
	FROM
		store_sales, item, date_dim
	WHERE
		ss_item_sk = i_item_sk
		AND i_category IN ('Men', 'Sports', 'Jewelry')
		AND ss_sold_date_sk = d_date_sk
		AND d_date BETWEEN CAST('1999-02-05' AS DATE) AND (CAST('1999-02-05' AS DATE) + '30 days'::INTERVAL)
	GROUP BY
		i_item_id,
		i_item_desc,
		i_category,
		i_class,
		i_current_price
	ORDER BY
		i_category,
		i_class,
		i_item_id,
		i_item_desc,
		revenueratio;
----
sort
 ├── columns: i_item_id:27!null i_item_desc:30 i_category:38!null i_class:36 i_current_price:31 itemrevenue:80 revenueratio:82
 ├── immutable
 ├── key: (27,30,31,36,38)
 ├── fd: (27,30,31,36,38)-->(80,82)
 ├── ordering: +38,+36,+27,+30,+82
 └── project
      ├── columns: revenueratio:82 i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null sum:80
      ├── immutable
      ├── key: (27,30,31,36,38)
      ├── fd: (27,30,31,36,38)-->(80,82)
      ├── window partition=(36)
      │    ├── columns: i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null sum:80 sum:81
      │    ├── key: (27,30,31,36,38)
      │    ├── fd: (27,30,31,36,38)-->(80,81)
      │    ├── group-by (hash)
      │    │    ├── columns: i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null sum:80
      │    │    ├── grouping columns: i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null
      │    │    ├── key: (27,30,31,36,38)
      │    │    ├── fd: (27,30,31,36,38)-->(80)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: ss_sold_date_sk:1!null ss_item_sk:3!null ss_ext_sales_price:16 i_item_sk:26!null i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null d_date_sk:50!null d_date:52!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (26)-->(27,30,31,36,38), (50)-->(52), (3)==(26), (26)==(3), (1)==(50), (50)==(1)
      │    │    │    ├── inner-join (lookup store_sales)
      │    │    │    │    ├── columns: ss_sold_date_sk:1 ss_item_sk:3!null ss_ext_sales_price:16 i_item_sk:26!null i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null
      │    │    │    │    ├── key columns: [26] = [3]
      │    │    │    │    ├── fd: (26)-->(27,30,31,36,38), (3)==(26), (26)==(3)
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: i_item_sk:26!null i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38!null
      │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    ├── fd: (26)-->(27,30,31,36,38)
      │    │    │    │    │    ├── scan item
      │    │    │    │    │    │    ├── columns: i_item_sk:26!null i_item_id:27!null i_item_desc:30 i_current_price:31 i_class:36 i_category:38
      │    │    │    │    │    │    ├── key: (26)
      │    │    │    │    │    │    └── fd: (26)-->(27,30,31,36,38)
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── i_category:38 IN ('Jewelry', 'Men', 'Sports') [outer=(38), constraints=(/38: [/'Jewelry' - /'Jewelry'] [/'Men' - /'Men'] [/'Sports' - /'Sports']; tight)]
      │    │    │    │    └── filters (true)
      │    │    │    ├── select
      │    │    │    │    ├── columns: d_date_sk:50!null d_date:52!null
      │    │    │    │    ├── key: (50)
      │    │    │    │    ├── fd: (50)-->(52)
      │    │    │    │    ├── scan date_dim
      │    │    │    │    │    ├── columns: d_date_sk:50!null d_date:52
      │    │    │    │    │    ├── key: (50)
      │    │    │    │    │    └── fd: (50)-->(52)
      │    │    │    │    └── filters
      │    │    │    │         └── (d_date:52 >= '1999-02-05') AND (d_date:52 <= '1999-03-07') [outer=(52), constraints=(/52: [/'1999-02-05' - /'1999-03-07']; tight)]
      │    │    │    └── filters
      │    │    │         └── ss_sold_date_sk:1 = d_date_sk:50 [outer=(1,50), constraints=(/1: (/NULL - ]; /50: (/NULL - ]), fd=(1)==(50), (50)==(1)]
      │    │    └── aggregations
      │    │         └── sum [as=sum:80, outer=(16)]
      │    │              └── ss_ext_sales_price:16
      │    └── windows
      │         └── sum [as=sum:81, outer=(80)]
      │              └── sum:80
      └── projections
           └── (sum:80 * 100) / sum:81 [as=revenueratio:82, outer=(80,81), immutable]

# --------------------------------------------------
# Q99
opt
	SELECT
		substr(w_warehouse_name, 1, 20),
		sm_type,
		cc_name,
		sum(
			CASE
			WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30)
			THEN 1
			ELSE 0
			END
		)
			AS "30 days",
		sum(
			CASE
			WHEN cs_ship_date_sk - cs_sold_date_sk > 30
			AND cs_ship_date_sk - cs_sold_date_sk <= 60
			THEN 1
			ELSE 0
			END
		)
			AS "31-60 days",
		sum(
			CASE
			WHEN cs_ship_date_sk - cs_sold_date_sk > 60
			AND cs_ship_date_sk - cs_sold_date_sk <= 90
			THEN 1
			ELSE 0
			END
		)
			AS "61-90 days",
		sum(
			CASE
			WHEN cs_ship_date_sk - cs_sold_date_sk > 90
			AND cs_ship_date_sk - cs_sold_date_sk <= 120
			THEN 1
			ELSE 0
			END
		)
			AS "91-120 days",
		sum(
			CASE
			WHEN (cs_ship_date_sk - cs_sold_date_sk > 120)
			THEN 1
			ELSE 0
			END
		)
			AS ">120 days"
	FROM
		catalog_sales,
		warehouse,
		ship_mode,
		call_center,
		date_dim
	WHERE
		d_month_seq BETWEEN 1194 AND (1194 + 11)
		AND cs_ship_date_sk = d_date_sk
		AND cs_warehouse_sk = w_warehouse_sk
		AND cs_ship_mode_sk = sm_ship_mode_sk
		AND cs_call_center_sk = cc_call_center_sk
	GROUP BY
		substr(w_warehouse_name, 1, 20), sm_type, cc_name
	ORDER BY
		substr(w_warehouse_name, 1, 20), sm_type, cc_name
	LIMIT
		100;
----
top-k
 ├── columns: substr:134 sm_type:55 cc_name:67 "30 days":125 "31-60 days":127 "61-90 days":129 "91-120 days":131 ">120 days":133
 ├── internal-ordering: +134,+55,+67
 ├── k: 100
 ├── cardinality: [0 - 100]
 ├── immutable
 ├── key: (55,67,134)
 ├── fd: (55,67,134)-->(125,127,129,131,133)
 ├── ordering: +134,+55,+67
 └── group-by (hash)
      ├── columns: sm_type:55 cc_name:67 sum:125 sum:127 sum:129 sum:131 sum:133 column134:134
      ├── grouping columns: sm_type:55 cc_name:67 column134:134
      ├── immutable
      ├── key: (55,67,134)
      ├── fd: (55,67,134)-->(125,127,129,131,133)
      ├── project
      │    ├── columns: column124:124 column126:126 column128:128 column130:130 column132:132 column134:134 sm_type:55 cc_name:67
      │    ├── immutable
      │    ├── inner-join (hash)
      │    │    ├── columns: cs_sold_date_sk:1 cs_ship_date_sk:3!null cs_call_center_sk:12!null cs_ship_mode_sk:14!null cs_warehouse_sk:15!null w_warehouse_sk:37!null w_warehouse_name:39 sm_ship_mode_sk:53!null sm_type:55 cc_call_center_sk:61!null cc_name:67 d_date_sk:94!null d_month_seq:97!null
      │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    ├── fd: (37)-->(39), (53)-->(55), (61)-->(67), (94)-->(97), (15)==(37), (37)==(15), (14)==(53), (53)==(14), (12)==(61), (61)==(12), (3)==(94), (94)==(3)
      │    │    ├── inner-join (hash)
      │    │    │    ├── columns: cs_sold_date_sk:1 cs_ship_date_sk:3!null cs_call_center_sk:12 cs_ship_mode_sk:14!null cs_warehouse_sk:15!null w_warehouse_sk:37!null w_warehouse_name:39 sm_ship_mode_sk:53!null sm_type:55 d_date_sk:94!null d_month_seq:97!null
      │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    ├── fd: (37)-->(39), (53)-->(55), (94)-->(97), (3)==(94), (94)==(3), (14)==(53), (53)==(14), (15)==(37), (37)==(15)
      │    │    │    ├── inner-join (hash)
      │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_ship_date_sk:3!null cs_call_center_sk:12 cs_ship_mode_sk:14 cs_warehouse_sk:15!null w_warehouse_sk:37!null w_warehouse_name:39 d_date_sk:94!null d_month_seq:97!null
      │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    ├── fd: (37)-->(39), (94)-->(97), (3)==(94), (94)==(3), (15)==(37), (37)==(15)
      │    │    │    │    ├── inner-join (hash)
      │    │    │    │    │    ├── columns: cs_sold_date_sk:1 cs_ship_date_sk:3!null cs_call_center_sk:12 cs_ship_mode_sk:14 cs_warehouse_sk:15 d_date_sk:94!null d_month_seq:97!null
      │    │    │    │    │    ├── multiplicity: left-rows(zero-or-one), right-rows(zero-or-more)
      │    │    │    │    │    ├── fd: (94)-->(97), (3)==(94), (94)==(3)
      │    │    │    │    │    ├── scan catalog_sales
      │    │    │    │    │    │    └── columns: cs_sold_date_sk:1 cs_ship_date_sk:3 cs_call_center_sk:12 cs_ship_mode_sk:14 cs_warehouse_sk:15
      │    │    │    │    │    ├── select
      │    │    │    │    │    │    ├── columns: d_date_sk:94!null d_month_seq:97!null
      │    │    │    │    │    │    ├── key: (94)
      │    │    │    │    │    │    ├── fd: (94)-->(97)
      │    │    │    │    │    │    ├── scan date_dim
      │    │    │    │    │    │    │    ├── columns: d_date_sk:94!null d_month_seq:97
      │    │    │    │    │    │    │    ├── key: (94)
      │    │    │    │    │    │    │    └── fd: (94)-->(97)
      │    │    │    │    │    │    └── filters
      │    │    │    │    │    │         └── (d_month_seq:97 >= 1194) AND (d_month_seq:97 <= 1205) [outer=(97), constraints=(/97: [/1194 - /1205]; tight)]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── cs_ship_date_sk:3 = d_date_sk:94 [outer=(3,94), constraints=(/3: (/NULL - ]; /94: (/NULL - ]), fd=(3)==(94), (94)==(3)]
      │    │    │    │    ├── scan warehouse
      │    │    │    │    │    ├── columns: w_warehouse_sk:37!null w_warehouse_name:39
      │    │    │    │    │    ├── key: (37)
      │    │    │    │    │    └── fd: (37)-->(39)
      │    │    │    │    └── filters
      │    │    │    │         └── cs_warehouse_sk:15 = w_warehouse_sk:37 [outer=(15,37), constraints=(/15: (/NULL - ]; /37: (/NULL - ]), fd=(15)==(37), (37)==(15)]
      │    │    │    ├── scan ship_mode
      │    │    │    │    ├── columns: sm_ship_mode_sk:53!null sm_type:55
      │    │    │    │    ├── key: (53)
      │    │    │    │    └── fd: (53)-->(55)
      │    │    │    └── filters
      │    │    │         └── cs_ship_mode_sk:14 = sm_ship_mode_sk:53 [outer=(14,53), constraints=(/14: (/NULL - ]; /53: (/NULL - ]), fd=(14)==(53), (53)==(14)]
      │    │    ├── scan call_center
      │    │    │    ├── columns: cc_call_center_sk:61!null cc_name:67
      │    │    │    ├── key: (61)
      │    │    │    └── fd: (61)-->(67)
      │    │    └── filters
      │    │         └── cs_call_center_sk:12 = cc_call_center_sk:61 [outer=(12,61), constraints=(/12: (/NULL - ]; /61: (/NULL - ]), fd=(12)==(61), (61)==(12)]
      │    └── projections
      │         ├── CASE WHEN (cs_ship_date_sk:3 - cs_sold_date_sk:1) <= 30 THEN 1 ELSE 0 END [as=column124:124, outer=(1,3), immutable]
      │         ├── CASE WHEN ((cs_ship_date_sk:3 - cs_sold_date_sk:1) > 30) AND ((cs_ship_date_sk:3 - cs_sold_date_sk:1) <= 60) THEN 1 ELSE 0 END [as=column126:126, outer=(1,3), immutable]
      │         ├── CASE WHEN ((cs_ship_date_sk:3 - cs_sold_date_sk:1) > 60) AND ((cs_ship_date_sk:3 - cs_sold_date_sk:1) <= 90) THEN 1 ELSE 0 END [as=column128:128, outer=(1,3), immutable]
      │         ├── CASE WHEN ((cs_ship_date_sk:3 - cs_sold_date_sk:1) > 90) AND ((cs_ship_date_sk:3 - cs_sold_date_sk:1) <= 120) THEN 1 ELSE 0 END [as=column130:130, outer=(1,3), immutable]
      │         ├── CASE WHEN (cs_ship_date_sk:3 - cs_sold_date_sk:1) > 120 THEN 1 ELSE 0 END [as=column132:132, outer=(1,3), immutable]
      │         └── substr(w_warehouse_name:39, 1, 20) [as=column134:134, outer=(39), immutable]
      └── aggregations
           ├── sum [as=sum:125, outer=(124)]
           │    └── column124:124
           ├── sum [as=sum:127, outer=(126)]
           │    └── column126:126
           ├── sum [as=sum:129, outer=(128)]
           │    └── column128:128
           ├── sum [as=sum:131, outer=(130)]
           │    └── column130:130
           └── sum [as=sum:133, outer=(132)]
                └── column132:132
