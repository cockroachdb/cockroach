exec-ddl
CREATE TABLE abcde (
    a INT NOT NULL,
    b INT,
    c INT DEFAULT (10),
    d INT AS (b + c + 1) STORED,
    e INT AS (a) STORED
)
----

exec-ddl
CREATE TABLE xyz (
    x TEXT PRIMARY KEY,
    y INT8,
    z FLOAT8
)
----

exec-ddl
CREATE TABLE uv (
    u DECIMAL,
    v BYTES
)
----

exec-ddl
CREATE TABLE mutation (
    m INT PRIMARY KEY,
    n INT,
    "o:write-only" INT DEFAULT(10),
    "p:write-only" INT AS (o + n) STORED,
    "q:delete-only" INT AS (m * p) STORED,
    CHECK (m > 0)
)
----

exec-ddl
CREATE TABLE checks (
    a INT PRIMARY KEY CHECK (a > 0),
    b INT,
    c INT,
    d INT AS (c + 1) STORED,
    CHECK (b < d)
)
----

exec-ddl
CREATE TABLE decimals (
    a DECIMAL(10,0) PRIMARY KEY CHECK (round(a) = a),
    b DECIMAL(5,1)[] CHECK (b[0] > 1),
    c DECIMAL(10,1) DEFAULT (1.23),
    d DECIMAL(10,1) AS (a+c) STORED
)
----

# Unknown target table.
build
INSERT INTO unknown VALUES (1, 2, 3)
----
error (42P01): no data source matches prefix: "unknown"

# ------------------------------------------------------------------------------
# Tests without target column names.
# ------------------------------------------------------------------------------

# Specify values for all non-hidden columns.
build
INSERT INTO abcde VALUES (1, 2, 3)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11!null column1:7!null column2:8!null column3:9!null column10:10
      ├── project
      │    ├── columns: column10:10 column1:7!null column2:8!null column3:9!null
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    └── (1, 2, 3)
      │    └── projections
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column2:8 + column3:9) + 1 [as=column11:11]

# Don't specify values for null or default columns.
build
INSERT INTO abcde VALUES (1)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column8:8 => b:2
 │    ├── column9:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column8:8 column9:9!null column10:10
      ├── project
      │    ├── columns: column8:8 column9:9!null column10:10 column1:7!null
      │    ├── values
      │    │    ├── columns: column1:7!null
      │    │    └── (1,)
      │    └── projections
      │         ├── NULL::INT8 [as=column8:8]
      │         ├── 10 [as=column9:9]
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column8:8 + column9:9) + 1 [as=column11:11]

# Ordered input.
build
INSERT INTO abcde SELECT y FROM xyz ORDER BY y, z LIMIT 10
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── y:8 => a:1
 │    ├── column10:10 => b:2
 │    ├── column11:11 => c:3
 │    ├── column13:13 => d:4
 │    ├── y:8 => e:5
 │    └── column12:12 => rowid:6
 └── project
      ├── columns: column13:13 y:8 column10:10 column11:11!null column12:12
      ├── project
      │    ├── columns: column10:10 column11:11!null column12:12 y:8
      │    ├── limit
      │    │    ├── columns: y:8 z:9
      │    │    ├── internal-ordering: +8,+9
      │    │    ├── sort
      │    │    │    ├── columns: y:8 z:9
      │    │    │    ├── ordering: +8,+9
      │    │    │    ├── limit hint: 10.00
      │    │    │    └── project
      │    │    │         ├── columns: y:8 z:9
      │    │    │         └── scan xyz
      │    │    │              └── columns: x:7!null y:8 z:9
      │    │    └── 10
      │    └── projections
      │         ├── NULL::INT8 [as=column10:10]
      │         ├── 10 [as=column11:11]
      │         └── unique_rowid() [as=column12:12]
      └── projections
           └── (column10:10 + column11:11) + 1 [as=column13:13]

# Ignore ORDER BY without LIMIT.
build
INSERT INTO abcde SELECT y FROM xyz ORDER BY y, z
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── y:8 => a:1
 │    ├── column10:10 => b:2
 │    ├── column11:11 => c:3
 │    ├── column13:13 => d:4
 │    ├── y:8 => e:5
 │    └── column12:12 => rowid:6
 └── project
      ├── columns: column13:13 y:8 column10:10 column11:11!null column12:12
      ├── project
      │    ├── columns: column10:10 column11:11!null column12:12 y:8
      │    ├── project
      │    │    ├── columns: y:8 z:9
      │    │    └── scan xyz
      │    │         └── columns: x:7!null y:8 z:9
      │    └── projections
      │         ├── NULL::INT8 [as=column10:10]
      │         ├── 10 [as=column11:11]
      │         └── unique_rowid() [as=column12:12]
      └── projections
           └── (column10:10 + column11:11) + 1 [as=column13:13]

# Use placeholders.
build
INSERT INTO xyz VALUES ($1, $2, $3)
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:4 => x:1
 │    ├── column2:5 => y:2
 │    └── column3:6 => z:3
 └── values
      ├── columns: column1:4 column2:5 column3:6
      └── ($1, $2, $3)

# Null expressions.
build
INSERT INTO abcde VALUES (2, null, null)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column2:8 column3:9 column10:10
      ├── project
      │    ├── columns: column10:10 column1:7!null column2:8 column3:9
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8 column3:9
      │    │    └── (2, NULL::INT8, NULL::INT8)
      │    └── projections
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column2:8 + column3:9) + 1 [as=column11:11]

# Duplicate expressions.
build
INSERT INTO abcde SELECT 2, $1 + 1, $1 + 1
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── "?column?":7 => a:1
 │    ├── "?column?":8 => b:2
 │    ├── "?column?":8 => c:3
 │    ├── column10:10 => d:4
 │    ├── "?column?":7 => e:5
 │    └── column9:9 => rowid:6
 └── project
      ├── columns: column10:10 "?column?":7!null "?column?":8 column9:9
      ├── project
      │    ├── columns: column9:9 "?column?":7!null "?column?":8
      │    ├── project
      │    │    ├── columns: "?column?":7!null "?column?":8
      │    │    ├── values
      │    │    │    └── ()
      │    │    └── projections
      │    │         ├── 2 [as="?column?":7]
      │    │         └── $1 + 1 [as="?column?":8]
      │    └── projections
      │         └── unique_rowid() [as=column9:9]
      └── projections
           └── ("?column?":8 + "?column?":8) + 1 [as=column10:10]

# Use DEFAULT VALUES.
build
INSERT INTO uv DEFAULT VALUES
----
insert uv
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column4:4 => u:1
 │    ├── column5:5 => v:2
 │    └── column6:6 => rowid:3
 └── project
      ├── columns: column4:4 column5:5 column6:6
      ├── values
      │    └── ()
      └── projections
           ├── NULL::DECIMAL [as=column4:4]
           ├── NULL::BYTES [as=column5:5]
           └── unique_rowid() [as=column6:6]

# Use DEFAULT expressions in VALUES expression.
build
INSERT INTO abcde ((VALUES (1, DEFAULT, 2), (2, 3, 4), (3, 2, DEFAULT), (4, DEFAULT, DEFAULT)))
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column2:8 column3:9!null column10:10
      ├── project
      │    ├── columns: column10:10 column1:7!null column2:8 column3:9!null
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8 column3:9!null
      │    │    ├── (1, NULL::INT8, 2)
      │    │    ├── (2, 3, 4)
      │    │    ├── (3, 2, 10)
      │    │    └── (4, NULL::INT8, 10)
      │    └── projections
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column2:8 + column3:9) + 1 [as=column11:11]

# Use DEFAULT expressions in VALUES expression wrapped by WITH clause (error).
build
INSERT INTO abcde WITH a AS (SELECT 1) VALUES (1, DEFAULT, 2)
----
error (42601): DEFAULT can only appear in a VALUES list within INSERT or on the right side of a SET

# Too many values.
build
INSERT INTO xyz VALUES ('foo', 2, 3, 4)
----
error (42601): INSERT has more expressions than target columns, 4 expressions for 3 targets

# Return values from insert.
build
INSERT INTO abcde SELECT 1 RETURNING *
----
project
 ├── columns: a:1!null b:2 c:3!null d:4 e:5!null
 └── insert abcde
      ├── columns: a:1!null b:2 c:3!null d:4 e:5!null rowid:6!null
      ├── insert-mapping:
      │    ├── "?column?":7 => a:1
      │    ├── column8:8 => b:2
      │    ├── column9:9 => c:3
      │    ├── column11:11 => d:4
      │    ├── "?column?":7 => e:5
      │    └── column10:10 => rowid:6
      └── project
           ├── columns: column11:11 "?column?":7!null column8:8 column9:9!null column10:10
           ├── project
           │    ├── columns: column8:8 column9:9!null column10:10 "?column?":7!null
           │    ├── project
           │    │    ├── columns: "?column?":7!null
           │    │    ├── values
           │    │    │    └── ()
           │    │    └── projections
           │    │         └── 1 [as="?column?":7]
           │    └── projections
           │         ├── NULL::INT8 [as=column8:8]
           │         ├── 10 [as=column9:9]
           │         └── unique_rowid() [as=column10:10]
           └── projections
                └── (column8:8 + column9:9) + 1 [as=column11:11]

# Return values from aliased table.
build
INSERT INTO abcde AS foo SELECT 1 RETURNING foo.a + 1, foo.b * foo.c
----
project
 ├── columns: "?column?":12!null "?column?":13
 ├── insert foo
 │    ├── columns: a:1!null b:2 c:3!null d:4 e:5!null rowid:6!null
 │    ├── insert-mapping:
 │    │    ├── "?column?":7 => a:1
 │    │    ├── column8:8 => b:2
 │    │    ├── column9:9 => c:3
 │    │    ├── column11:11 => d:4
 │    │    ├── "?column?":7 => e:5
 │    │    └── column10:10 => rowid:6
 │    └── project
 │         ├── columns: column11:11 "?column?":7!null column8:8 column9:9!null column10:10
 │         ├── project
 │         │    ├── columns: column8:8 column9:9!null column10:10 "?column?":7!null
 │         │    ├── project
 │         │    │    ├── columns: "?column?":7!null
 │         │    │    ├── values
 │         │    │    │    └── ()
 │         │    │    └── projections
 │         │    │         └── 1 [as="?column?":7]
 │         │    └── projections
 │         │         ├── NULL::INT8 [as=column8:8]
 │         │         ├── 10 [as=column9:9]
 │         │         └── unique_rowid() [as=column10:10]
 │         └── projections
 │              └── (column8:8 + column9:9) + 1 [as=column11:11]
 └── projections
      ├── a:1 + 1 [as="?column?":12]
      └── b:2 * c:3 [as="?column?":13]

# Use returning INSERT as a FROM expression.
build
SELECT * FROM [INSERT INTO abcde VALUES (1) RETURNING *]
----
with &1
 ├── columns: a:12!null b:13 c:14!null d:15 e:16!null
 ├── project
 │    ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5!null
 │    └── insert abcde
 │         ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5!null rowid:6!null
 │         ├── insert-mapping:
 │         │    ├── column1:7 => abcde.a:1
 │         │    ├── column8:8 => abcde.b:2
 │         │    ├── column9:9 => abcde.c:3
 │         │    ├── column11:11 => abcde.d:4
 │         │    ├── column1:7 => abcde.e:5
 │         │    └── column10:10 => rowid:6
 │         └── project
 │              ├── columns: column11:11 column1:7!null column8:8 column9:9!null column10:10
 │              ├── project
 │              │    ├── columns: column8:8 column9:9!null column10:10 column1:7!null
 │              │    ├── values
 │              │    │    ├── columns: column1:7!null
 │              │    │    └── (1,)
 │              │    └── projections
 │              │         ├── NULL::INT8 [as=column8:8]
 │              │         ├── 10 [as=column9:9]
 │              │         └── unique_rowid() [as=column10:10]
 │              └── projections
 │                   └── (column8:8 + column9:9) + 1 [as=column11:11]
 └── with-scan &1
      ├── columns: a:12!null b:13 c:14!null d:15 e:16!null
      └── mapping:
           ├──  abcde.a:1 => a:12
           ├──  abcde.b:2 => b:13
           ├──  abcde.c:3 => c:14
           ├──  abcde.d:4 => d:15
           └──  abcde.e:5 => e:16

# Try to use aggregate function in RETURNING clause.
build
INSERT INTO abcde VALUES (1) RETURNING sum(a)
----
error (42803): sum(): aggregate functions are not allowed in RETURNING

# Try to use SRF in RETURNING clause.
build
INSERT INTO abcde VALUES (1) RETURNING generate_series(1, 10)
----
error (0A000): generate_series(): generator functions are not allowed in RETURNING

# Try to use non-returning INSERT as expression.
build
SELECT * FROM [INSERT INTO abcde VALUES (1)]
----
error (42703): statement source "INSERT INTO abcde VALUES (1)" does not return any columns

# Use CTE with multiple variables.
build
WITH a AS (SELECT y, y+1 FROM xyz) INSERT INTO abcde SELECT * FROM a
----
with &1 (a)
 ├── project
 │    ├── columns: "?column?":4 xyz.y:2
 │    ├── scan xyz
 │    │    └── columns: x:1!null xyz.y:2 z:3
 │    └── projections
 │         └── xyz.y:2 + 1 [as="?column?":4]
 └── insert abcde
      ├── columns: <none>
      ├── insert-mapping:
      │    ├── y:11 => a:5
      │    ├── "?column?":12 => b:6
      │    ├── column13:13 => c:7
      │    ├── column15:15 => d:8
      │    ├── y:11 => e:9
      │    └── column14:14 => rowid:10
      └── project
           ├── columns: column15:15 y:11 "?column?":12 column13:13!null column14:14
           ├── project
           │    ├── columns: column13:13!null column14:14 y:11 "?column?":12
           │    ├── with-scan &1 (a)
           │    │    ├── columns: y:11 "?column?":12
           │    │    └── mapping:
           │    │         ├──  xyz.y:2 => y:11
           │    │         └──  "?column?":4 => "?column?":12
           │    └── projections
           │         ├── 10 [as=column13:13]
           │         └── unique_rowid() [as=column14:14]
           └── projections
                └── ("?column?":12 + column13:13) + 1 [as=column15:15]

# Use CTE with multiple variables.
build
WITH a AS (SELECT y, y+1 FROM xyz), b AS (SELECT y+1, y FROM xyz)
INSERT INTO abcde TABLE a UNION TABLE b
----
with &1 (a)
 ├── project
 │    ├── columns: "?column?":4 xyz.y:2
 │    ├── scan xyz
 │    │    └── columns: x:1!null xyz.y:2 z:3
 │    └── projections
 │         └── xyz.y:2 + 1 [as="?column?":4]
 └── with &2 (b)
      ├── project
      │    ├── columns: "?column?":8 xyz.y:6
      │    ├── scan xyz
      │    │    └── columns: x:5!null xyz.y:6 z:7
      │    └── projections
      │         └── xyz.y:6 + 1 [as="?column?":8]
      └── insert abcde
           ├── columns: <none>
           ├── insert-mapping:
           │    ├── y:19 => a:9
           │    ├── "?column?":20 => b:10
           │    ├── column21:21 => c:11
           │    ├── column23:23 => d:12
           │    ├── y:19 => e:13
           │    └── column22:22 => rowid:14
           └── project
                ├── columns: column23:23 y:19 "?column?":20 column21:21!null column22:22
                ├── project
                │    ├── columns: column21:21!null column22:22 y:19 "?column?":20
                │    ├── union
                │    │    ├── columns: y:19 "?column?":20
                │    │    ├── left columns: y:15 "?column?":16
                │    │    ├── right columns: "?column?":17 y:18
                │    │    ├── with-scan &1 (a)
                │    │    │    ├── columns: y:15 "?column?":16
                │    │    │    └── mapping:
                │    │    │         ├──  xyz.y:2 => y:15
                │    │    │         └──  "?column?":4 => "?column?":16
                │    │    └── with-scan &2 (b)
                │    │         ├── columns: "?column?":17 y:18
                │    │         └── mapping:
                │    │              ├──  "?column?":8 => "?column?":17
                │    │              └──  xyz.y:6 => y:18
                │    └── projections
                │         ├── 10 [as=column21:21]
                │         └── unique_rowid() [as=column22:22]
                └── projections
                     └── ("?column?":20 + column21:21) + 1 [as=column23:23]

# Non-referenced CTE with mutation.
build
WITH cte AS (SELECT b FROM [INSERT INTO abcde VALUES (1) RETURNING *]) INSERT INTO abcde VALUES (1)
----
with &1
 ├── project
 │    ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5!null
 │    └── insert abcde
 │         ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5!null rowid:6!null
 │         ├── insert-mapping:
 │         │    ├── column1:7 => abcde.a:1
 │         │    ├── column8:8 => abcde.b:2
 │         │    ├── column9:9 => abcde.c:3
 │         │    ├── column11:11 => abcde.d:4
 │         │    ├── column1:7 => abcde.e:5
 │         │    └── column10:10 => rowid:6
 │         └── project
 │              ├── columns: column11:11 column1:7!null column8:8 column9:9!null column10:10
 │              ├── project
 │              │    ├── columns: column8:8 column9:9!null column10:10 column1:7!null
 │              │    ├── values
 │              │    │    ├── columns: column1:7!null
 │              │    │    └── (1,)
 │              │    └── projections
 │              │         ├── NULL::INT8 [as=column8:8]
 │              │         ├── 10 [as=column9:9]
 │              │         └── unique_rowid() [as=column10:10]
 │              └── projections
 │                   └── (column8:8 + column9:9) + 1 [as=column11:11]
 └── with &2 (cte)
      ├── project
      │    ├── columns: b:13
      │    └── with-scan &1
      │         ├── columns: a:12!null b:13 c:14!null d:15 e:16!null
      │         └── mapping:
      │              ├──  abcde.a:1 => a:12
      │              ├──  abcde.b:2 => b:13
      │              ├──  abcde.c:3 => c:14
      │              ├──  abcde.d:4 => d:15
      │              └──  abcde.e:5 => e:16
      └── insert abcde
           ├── columns: <none>
           ├── insert-mapping:
           │    ├── column1:23 => abcde.a:17
           │    ├── column24:24 => abcde.b:18
           │    ├── column25:25 => abcde.c:19
           │    ├── column27:27 => abcde.d:20
           │    ├── column1:23 => abcde.e:21
           │    └── column26:26 => rowid:22
           └── project
                ├── columns: column27:27 column1:23!null column24:24 column25:25!null column26:26
                ├── project
                │    ├── columns: column24:24 column25:25!null column26:26 column1:23!null
                │    ├── values
                │    │    ├── columns: column1:23!null
                │    │    └── (1,)
                │    └── projections
                │         ├── NULL::INT8 [as=column24:24]
                │         ├── 10 [as=column25:25]
                │         └── unique_rowid() [as=column26:26]
                └── projections
                     └── (column24:24 + column25:25) + 1 [as=column27:27]

# Insert CTE that returns no columns.
build
WITH cte AS (INSERT INTO abcde VALUES (1)) SELECT * FROM cte
----
error (0A000): WITH clause "cte" does not return any columns

# Use SRF in RETURNING clause.
build
INSERT INTO abcde VALUES (1) RETURNING generate_series(1, 100)
----
error (0A000): generate_series(): generator functions are not allowed in RETURNING

# ------------------------------------------------------------------------------
# Tests with target column names.
# ------------------------------------------------------------------------------

# Specify values for all non-computed columns.
build
INSERT INTO abcde (c, b, a) VALUES (1, 2, 3)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column3:9 => a:1
 │    ├── column2:8 => b:2
 │    ├── column1:7 => c:3
 │    ├── column11:11 => d:4
 │    ├── column3:9 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11!null column1:7!null column2:8!null column3:9!null column10:10
      ├── project
      │    ├── columns: column10:10 column1:7!null column2:8!null column3:9!null
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    └── (1, 2, 3)
      │    └── projections
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column2:8 + column1:7) + 1 [as=column11:11]

# Don't specify values for null or default columns.
build
INSERT INTO abcde (a) VALUES (1)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column8:8 => b:2
 │    ├── column9:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column8:8 column9:9!null column10:10
      ├── project
      │    ├── columns: column8:8 column9:9!null column10:10 column1:7!null
      │    ├── values
      │    │    ├── columns: column1:7!null
      │    │    └── (1,)
      │    └── projections
      │         ├── NULL::INT8 [as=column8:8]
      │         ├── 10 [as=column9:9]
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column8:8 + column9:9) + 1 [as=column11:11]

# Insert value into hidden rowid column.
build
INSERT INTO abcde (a, rowid) VALUES (1, 2) RETURNING *
----
project
 ├── columns: a:1!null b:2 c:3!null d:4 e:5!null
 └── insert abcde
      ├── columns: a:1!null b:2 c:3!null d:4 e:5!null rowid:6!null
      ├── insert-mapping:
      │    ├── column1:7 => a:1
      │    ├── column9:9 => b:2
      │    ├── column10:10 => c:3
      │    ├── column11:11 => d:4
      │    ├── column1:7 => e:5
      │    └── column2:8 => rowid:6
      └── project
           ├── columns: column11:11 column1:7!null column2:8!null column9:9 column10:10!null
           ├── project
           │    ├── columns: column9:9 column10:10!null column1:7!null column2:8!null
           │    ├── values
           │    │    ├── columns: column1:7!null column2:8!null
           │    │    └── (1, 2)
           │    └── projections
           │         ├── NULL::INT8 [as=column9:9]
           │         └── 10 [as=column10:10]
           └── projections
                └── (column9:9 + column10:10) + 1 [as=column11:11]

# Use DEFAULT expressions in VALUES expression.
build
INSERT INTO abcde (c, b, a, rowid)
VALUES (DEFAULT, DEFAULT, 1, DEFAULT), (3, 2, 1, DEFAULT), (DEFAULT, DEFAULT, 2, 100)
RETURNING *, rowid
----
insert abcde
 ├── columns: a:1!null b:2 c:3!null d:4 e:5!null rowid:6!null
 ├── insert-mapping:
 │    ├── column3:9 => a:1
 │    ├── column2:8 => b:2
 │    ├── column1:7 => c:3
 │    ├── column11:11 => d:4
 │    ├── column3:9 => e:5
 │    └── column4:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column2:8 column3:9!null column4:10
      ├── values
      │    ├── columns: column1:7!null column2:8 column3:9!null column4:10
      │    ├── (10, NULL::INT8, 1, unique_rowid())
      │    ├── (3, 2, 1, unique_rowid())
      │    └── (10, NULL::INT8, 2, 100)
      └── projections
           └── (column2:8 + column1:7) + 1 [as=column11:11]

# Verify that there is no compile-time error when trying to insert a NULL
# DEFAULT value into a not-null column (it will fail at runtime).
build
INSERT INTO abcde (a) VALUES (DEFAULT)
----
insert abcde
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column8:8 => b:2
 │    ├── column9:9 => c:3
 │    ├── column11:11 => d:4
 │    ├── column1:7 => e:5
 │    └── column10:10 => rowid:6
 └── project
      ├── columns: column11:11 column1:7 column8:8 column9:9!null column10:10
      ├── project
      │    ├── columns: column8:8 column9:9!null column10:10 column1:7
      │    ├── values
      │    │    ├── columns: column1:7
      │    │    └── (NULL::INT8,)
      │    └── projections
      │         ├── NULL::INT8 [as=column8:8]
      │         ├── 10 [as=column9:9]
      │         └── unique_rowid() [as=column10:10]
      └── projections
           └── (column8:8 + column9:9) + 1 [as=column11:11]

# Mismatched type.
build
INSERT INTO xyz (x) VALUES (10)
----
error (42804): value type int doesn't match type string of column "x"

# Try to insert into computed column.
build
INSERT INTO abcde (a, b, c, d) VALUES (1, 2, 3, 4)
----
error (55000): cannot write directly to computed column "d"

# Try to insert DEFAULT expression into computed column.
build
INSERT INTO abcde (a, d) VALUES (1, DEFAULT)
----
error (55000): cannot write directly to computed column "d"

# Too many values.
build
INSERT INTO abcde (a, b) VALUES (1, 2, 3)
----
error (42601): INSERT has more expressions than target columns, 3 expressions for 2 targets

# Too few values.
build
INSERT INTO abcde (a, b) VALUES (1)
----
error (42601): INSERT has more target columns than expressions, 1 expressions for 2 targets

# Duplicate column name.
build
INSERT INTO abcde (a, b, a) VALUES (1, 2, 3)
----
error (42601): multiple assignments to the same column "a"

# Undefined column name.
build
INSERT INTO abcde (a, unk) VALUES (1, 2)
----
error (42703): column "unk" does not exist

# Return values from insert.
build
INSERT INTO abcde (b, a) SELECT x::int, y FROM xyz RETURNING *
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4!null e:5
 └── insert abcde
      ├── columns: a:1!null b:2!null c:3!null d:4!null e:5 rowid:6!null
      ├── insert-mapping:
      │    ├── y:8 => a:1
      │    ├── x:10 => b:2
      │    ├── column11:11 => c:3
      │    ├── column13:13 => d:4
      │    ├── y:8 => e:5
      │    └── column12:12 => rowid:6
      └── project
           ├── columns: column13:13!null y:8 x:10!null column11:11!null column12:12
           ├── project
           │    ├── columns: column11:11!null column12:12 y:8 x:10!null
           │    ├── project
           │    │    ├── columns: x:10!null y:8
           │    │    ├── scan xyz
           │    │    │    └── columns: xyz.x:7!null y:8 z:9
           │    │    └── projections
           │    │         └── xyz.x:7::INT8 [as=x:10]
           │    └── projections
           │         ├── 10 [as=column11:11]
           │         └── unique_rowid() [as=column12:12]
           └── projections
                └── (x:10 + column11:11) + 1 [as=column13:13]

# Return hidden column.
build
INSERT INTO abcde (rowid, a) VALUES (1, 2) RETURNING *, rowid
----
insert abcde
 ├── columns: a:1!null b:2 c:3!null d:4 e:5!null rowid:6!null
 ├── insert-mapping:
 │    ├── column2:8 => a:1
 │    ├── column9:9 => b:2
 │    ├── column10:10 => c:3
 │    ├── column11:11 => d:4
 │    ├── column2:8 => e:5
 │    └── column1:7 => rowid:6
 └── project
      ├── columns: column11:11 column1:7!null column2:8!null column9:9 column10:10!null
      ├── project
      │    ├── columns: column9:9 column10:10!null column1:7!null column2:8!null
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8!null
      │    │    └── (1, 2)
      │    └── projections
      │         ├── NULL::INT8 [as=column9:9]
      │         └── 10 [as=column10:10]
      └── projections
           └── (column9:9 + column10:10) + 1 [as=column11:11]

# Use returning INSERT as a FROM expression.
build
SELECT * FROM [INSERT INTO abcde (a, b) SELECT y+1, y FROM xyz RETURNING *]
----
with &1
 ├── columns: a:14!null b:15 c:16!null d:17 e:18
 ├── project
 │    ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5
 │    └── insert abcde
 │         ├── columns: abcde.a:1!null abcde.b:2 abcde.c:3!null abcde.d:4 abcde.e:5 rowid:6!null
 │         ├── insert-mapping:
 │         │    ├── "?column?":10 => abcde.a:1
 │         │    ├── y:8 => abcde.b:2
 │         │    ├── column11:11 => abcde.c:3
 │         │    ├── column13:13 => abcde.d:4
 │         │    ├── "?column?":10 => abcde.e:5
 │         │    └── column12:12 => rowid:6
 │         └── project
 │              ├── columns: column13:13 y:8 "?column?":10 column11:11!null column12:12
 │              ├── project
 │              │    ├── columns: column11:11!null column12:12 y:8 "?column?":10
 │              │    ├── project
 │              │    │    ├── columns: "?column?":10 y:8
 │              │    │    ├── scan xyz
 │              │    │    │    └── columns: x:7!null y:8 z:9
 │              │    │    └── projections
 │              │    │         └── y:8 + 1 [as="?column?":10]
 │              │    └── projections
 │              │         ├── 10 [as=column11:11]
 │              │         └── unique_rowid() [as=column12:12]
 │              └── projections
 │                   └── (y:8 + column11:11) + 1 [as=column13:13]
 └── with-scan &1
      ├── columns: a:14!null b:15 c:16!null d:17 e:18
      └── mapping:
           ├──  abcde.a:1 => a:14
           ├──  abcde.b:2 => b:15
           ├──  abcde.c:3 => c:16
           ├──  abcde.d:4 => d:17
           └──  abcde.e:5 => e:18

# ------------------------------------------------------------------------------
# Propagate desired INSERT types.
# ------------------------------------------------------------------------------

# Propagate types to VALUES.
build
INSERT INTO xyz VALUES ($1, $2 + 1, $3 + 1)
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:4 => x:1
 │    ├── column2:5 => y:2
 │    └── column3:6 => z:3
 └── values
      ├── columns: column1:4 column2:5 column3:6
      └── ($1, $2 + 1, $3 + 1.0)

# Propagate types to VALUES (named columns).
build
INSERT INTO xyz (z, y, x) VALUES ($1 + 1, $2 + 1, $3)
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column3:6 => x:1
 │    ├── column2:5 => y:2
 │    └── column1:4 => z:3
 └── values
      ├── columns: column1:4 column2:5 column3:6
      └── ($1 + 1.0, $2 + 1, $3)

# Propagate types to projection list.
build
INSERT INTO xyz ((SELECT $1, $2 + 1, $3 + 1))
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── "?column?":4 => x:1
 │    ├── "?column?":5 => y:2
 │    └── "?column?":6 => z:3
 └── project
      ├── columns: "?column?":4 "?column?":5 "?column?":6
      ├── values
      │    └── ()
      └── projections
           ├── $1 [as="?column?":4]
           ├── $2 + 1 [as="?column?":5]
           └── $3 + 1.0 [as="?column?":6]

# Propagate types to projection list (named columns).
build
INSERT INTO xyz (x, y, z) SELECT $1, $2 + 1, $3 + 1
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── "?column?":4 => x:1
 │    ├── "?column?":5 => y:2
 │    └── "?column?":6 => z:3
 └── project
      ├── columns: "?column?":4 "?column?":5 "?column?":6
      ├── values
      │    └── ()
      └── projections
           ├── $1 [as="?column?":4]
           ├── $2 + 1 [as="?column?":5]
           └── $3 + 1.0 [as="?column?":6]

# Propagate types to UNION.
build
INSERT INTO xyz (SELECT $1, $2 + 1, $3 + 1) UNION ALL (SELECT $1, $2 + 1, $3 + 1)
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── "?column?":10 => x:1
 │    ├── "?column?":11 => y:2
 │    └── "?column?":12 => z:3
 └── union-all
      ├── columns: "?column?":10 "?column?":11 "?column?":12
      ├── left columns: "?column?":4 "?column?":5 "?column?":6
      ├── right columns: "?column?":7 "?column?":8 "?column?":9
      ├── project
      │    ├── columns: "?column?":4 "?column?":5 "?column?":6
      │    ├── values
      │    │    └── ()
      │    └── projections
      │         ├── $1 [as="?column?":4]
      │         ├── $2 + 1 [as="?column?":5]
      │         └── $3 + 1.0 [as="?column?":6]
      └── project
           ├── columns: "?column?":7 "?column?":8 "?column?":9
           ├── values
           │    └── ()
           └── projections
                ├── $1 [as="?column?":7]
                ├── $2 + 1 [as="?column?":8]
                └── $3 + 1.0 [as="?column?":9]

# Propagate types to UNION (named columns).
build
INSERT INTO xyz (x, z, y) SELECT $1, $2 + 1, $3 + 1 UNION ALL SELECT $1, $2 + 1, $3 + 1
----
insert xyz
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── "?column?":10 => x:1
 │    ├── "?column?":12 => y:2
 │    └── "?column?":11 => z:3
 └── union-all
      ├── columns: "?column?":10 "?column?":11 "?column?":12
      ├── left columns: "?column?":4 "?column?":5 "?column?":6
      ├── right columns: "?column?":7 "?column?":8 "?column?":9
      ├── project
      │    ├── columns: "?column?":4 "?column?":5 "?column?":6
      │    ├── values
      │    │    └── ()
      │    └── projections
      │         ├── $1 [as="?column?":4]
      │         ├── $2 + 1.0 [as="?column?":5]
      │         └── $3 + 1 [as="?column?":6]
      └── project
           ├── columns: "?column?":7 "?column?":8 "?column?":9
           ├── values
           │    └── ()
           └── projections
                ├── $1 [as="?column?":7]
                ├── $2 + 1.0 [as="?column?":8]
                └── $3 + 1 [as="?column?":9]

# ------------------------------------------------------------------------------
# Tests with mutation columns.
# ------------------------------------------------------------------------------

# Test mutation columns with default and computed values.
build
INSERT INTO mutation (m, n) VALUES (1, 2)
----
insert mutation
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:6 => m:1
 │    ├── column2:7 => n:2
 │    ├── column8:8 => o:3
 │    └── column9:9 => p:4
 ├── check columns: check1:10
 └── project
      ├── columns: check1:10!null column1:6!null column2:7!null column8:8!null column9:9!null
      ├── project
      │    ├── columns: column9:9!null column1:6!null column2:7!null column8:8!null
      │    ├── project
      │    │    ├── columns: column8:8!null column1:6!null column2:7!null
      │    │    ├── values
      │    │    │    ├── columns: column1:6!null column2:7!null
      │    │    │    └── (1, 2)
      │    │    └── projections
      │    │         └── 10 [as=column8:8]
      │    └── projections
      │         └── column8:8 + column2:7 [as=column9:9]
      └── projections
           └── column1:6 > 0 [as=check1:10]

# Use RETURNING clause and ensure that mutation columns aren't projected.
build
INSERT INTO mutation (m, n) VALUES (1, 2) RETURNING *
----
insert mutation
 ├── columns: m:1!null n:2!null
 ├── insert-mapping:
 │    ├── column1:6 => m:1
 │    ├── column2:7 => n:2
 │    ├── column8:8 => o:3
 │    └── column9:9 => p:4
 ├── check columns: check1:10
 └── project
      ├── columns: check1:10!null column1:6!null column2:7!null column8:8!null column9:9!null
      ├── project
      │    ├── columns: column9:9!null column1:6!null column2:7!null column8:8!null
      │    ├── project
      │    │    ├── columns: column8:8!null column1:6!null column2:7!null
      │    │    ├── values
      │    │    │    ├── columns: column1:6!null column2:7!null
      │    │    │    └── (1, 2)
      │    │    └── projections
      │    │         └── 10 [as=column8:8]
      │    └── projections
      │         └── column8:8 + column2:7 [as=column9:9]
      └── projections
           └── column1:6 > 0 [as=check1:10]

# Try to reference write-only mutation column in RETURNING clause.
build
INSERT INTO mutation (m, n) VALUES (1, 2) RETURNING o
----
error (42703): column "o" does not exist

# Try to reference delete-only mutation column in RETURNING clause.
build
INSERT INTO mutation (m, n) VALUES (1, 2) RETURNING p
----
error (42703): column "p" does not exist

# Try to insert into mutation column.
build
INSERT INTO mutation (m, n, p) VALUES (1, 2, 3)
----
error (42703): column "p" does not exist

# ------------------------------------------------------------------------------
# Test check constraints.
# ------------------------------------------------------------------------------

# Insert constants.
build
INSERT INTO checks (a, b, c) VALUES (1, 2, 3)
----
insert checks
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    ├── column3:7 => c:3
 │    └── column8:8 => d:4
 ├── check columns: check1:9 check2:10
 └── project
      ├── columns: check1:9!null check2:10!null column1:5!null column2:6!null column3:7!null column8:8!null
      ├── project
      │    ├── columns: column8:8!null column1:5!null column2:6!null column3:7!null
      │    ├── values
      │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    └── (1, 2, 3)
      │    └── projections
      │         └── column3:7 + 1 [as=column8:8]
      └── projections
           ├── column2:6 < column8:8 [as=check1:9]
           └── column1:5 > 0 [as=check2:10]

# Insert results of SELECT.
build
INSERT INTO checks SELECT a, b, c FROM abcde
----
insert checks
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── abcde.a:5 => checks.a:1
 │    ├── abcde.b:6 => checks.b:2
 │    ├── abcde.c:7 => checks.c:3
 │    └── column11:11 => checks.d:4
 ├── check columns: check1:12 check2:13
 └── project
      ├── columns: check1:12 check2:13!null abcde.a:5!null abcde.b:6 abcde.c:7 column11:11
      ├── project
      │    ├── columns: column11:11 abcde.a:5!null abcde.b:6 abcde.c:7
      │    ├── project
      │    │    ├── columns: abcde.a:5!null abcde.b:6 abcde.c:7
      │    │    └── scan abcde
      │    │         ├── columns: abcde.a:5!null abcde.b:6 abcde.c:7 abcde.d:8 e:9 rowid:10!null
      │    │         └── computed column expressions
      │    │              ├── abcde.d:8
      │    │              │    └── (abcde.b:6 + abcde.c:7) + 1
      │    │              └── e:9
      │    │                   └── abcde.a:5
      │    └── projections
      │         └── abcde.c:7 + 1 [as=column11:11]
      └── projections
           ├── abcde.b:6 < column11:11 [as=check1:12]
           └── abcde.a:5 > 0 [as=check2:13]

# ------------------------------------------------------------------------------
# Test decimal column rounding.
# ------------------------------------------------------------------------------

build
INSERT INTO decimals (a, b) VALUES (1.1, ARRAY[0.95, NULL, 15])
----
insert decimals
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── a:8 => decimals.a:1
 │    ├── b:9 => decimals.b:2
 │    ├── c:10 => decimals.c:3
 │    └── d:12 => decimals.d:4
 ├── check columns: check1:13 check2:14
 └── project
      ├── columns: check1:13 check2:14 a:8 b:9 c:10 d:12
      ├── project
      │    ├── columns: d:12 a:8 b:9 c:10
      │    ├── project
      │    │    ├── columns: column11:11 a:8 b:9 c:10
      │    │    ├── project
      │    │    │    ├── columns: a:8 b:9 c:10
      │    │    │    ├── project
      │    │    │    │    ├── columns: column7:7!null column1:5!null column2:6
      │    │    │    │    ├── values
      │    │    │    │    │    ├── columns: column1:5!null column2:6
      │    │    │    │    │    └── (1.1, ARRAY[0.95,NULL,15])
      │    │    │    │    └── projections
      │    │    │    │         └── 1.23 [as=column7:7]
      │    │    │    └── projections
      │    │    │         ├── crdb_internal.round_decimal_values(column1:5, 0) [as=a:8]
      │    │    │         ├── crdb_internal.round_decimal_values(column2:6, 1) [as=b:9]
      │    │    │         └── crdb_internal.round_decimal_values(column7:7, 1) [as=c:10]
      │    │    └── projections
      │    │         └── a:8 + c:10 [as=column11:11]
      │    └── projections
      │         └── crdb_internal.round_decimal_values(column11:11, 1) [as=d:12]
      └── projections
           ├── round(a:8) = a:8 [as=check1:13]
           └── b:9[0] > 1 [as=check2:14]

# Regression test for #38293; the default values should be separate projections.
exec-ddl
CREATE TABLE defvals (
    id SERIAL NOT NULL PRIMARY KEY,
    arr1 STRING(100) ARRAY NOT NULL DEFAULT ARRAY[],
    arr2 INT ARRAY NOT NULL DEFAULT ARRAY[]
)
----

build
INSERT INTO defvals(id) VALUES (1)
----
insert defvals
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:4 => id:1
 │    ├── column5:5 => arr1:2
 │    └── column6:6 => arr2:3
 └── project
      ├── columns: column5:5!null column6:6!null column1:4!null
      ├── values
      │    ├── columns: column1:4!null
      │    └── (1,)
      └── projections
           ├── ARRAY[] [as=column5:5]
           └── ARRAY[] [as=column6:6]

exec-ddl
CREATE TABLE defvals2 (
    id SERIAL NOT NULL PRIMARY KEY,
    arr1 STRING(100) ARRAY NOT NULL DEFAULT ARRAY[NULL],
    arr2 INT ARRAY NOT NULL DEFAULT ARRAY[NULL]
)
----

build
INSERT INTO defvals2(id) VALUES (1)
----
insert defvals2
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:4 => id:1
 │    ├── column5:5 => arr1:2
 │    └── column6:6 => arr2:3
 └── project
      ├── columns: column5:5 column6:6 column1:4!null
      ├── values
      │    ├── columns: column1:4!null
      │    └── (1,)
      └── projections
           ├── ARRAY[NULL] [as=column5:5]
           └── ARRAY[NULL] [as=column6:6]

# ------------------------------------------------------------------------------
# Test partial index column values.
# ------------------------------------------------------------------------------

exec-ddl
CREATE TABLE partial_indexes (
    a INT PRIMARY KEY,
    b INT,
    c STRING,
    INDEX (b),
    INDEX (b) WHERE c = 'foo',
    INDEX (c) WHERE a > b AND c = 'bar'
)
----

build
INSERT INTO partial_indexes VALUES (2, 1, 'bar')
----
insert partial_indexes
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:4 => a:1
 │    ├── column2:5 => b:2
 │    └── column3:6 => c:3
 ├── partial index put columns: partial_index_put1:7 partial_index_put2:8
 └── project
      ├── columns: partial_index_put1:7!null partial_index_put2:8!null column1:4!null column2:5!null column3:6!null
      ├── values
      │    ├── columns: column1:4!null column2:5!null column3:6!null
      │    └── (2, 1, 'bar')
      └── projections
           ├── column3:6 = 'foo' [as=partial_index_put1:7]
           └── (column1:4 > column2:5) AND (column3:6 = 'bar') [as=partial_index_put2:8]
