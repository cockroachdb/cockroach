exec-ddl
CREATE TABLE t (
  k INT PRIMARY KEY,
  i INT,
  s STRING
)
----

exec-ddl
CREATE PROCEDURE my_upsert(arg_k INT, new_i INT, new_s STRING) AS $$
  DECLARE
    c INT;
  BEGIN
    SELECT count(*) INTO c FROM t WHERE k = arg_k;
    IF c > 0 THEN
      UPDATE t SET i = new_i, s = new_s WHERE k = arg_k;
    ELSE
      INSERT INTO t VALUES (arg_k, new_i, new_s);
    END IF;
  END
$$ LANGUAGE PLpgSQL
----

build format=show-scalars
CALL my_upsert(1, 10, 'foo')
----
call
 └── procedure: my_upsert
      ├── args
      │    ├── const: 1
      │    ├── const: 10
      │    └── const: 'foo'
      ├── params: arg_k:1 new_i:2 new_s:3
      └── body
           └── limit
                ├── columns: "_stmt_exec_1":59
                ├── project
                │    ├── columns: "_stmt_exec_1":59
                │    ├── barrier
                │    │    ├── columns: c:4
                │    │    └── project
                │    │         ├── columns: c:4
                │    │         ├── values
                │    │         │    └── tuple
                │    │         └── projections
                │    │              └── cast: INT8 [as=c:4]
                │    │                   └── null
                │    └── projections
                │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":59]
                │              ├── args
                │              │    ├── variable: arg_k:1
                │              │    ├── variable: new_i:2
                │              │    ├── variable: new_s:3
                │              │    └── variable: c:4
                │              ├── params: arg_k:5 new_i:6 new_s:7 c:8
                │              └── body
                │                   └── project
                │                        ├── columns: "_stmt_exec_ret_2":58
                │                        ├── barrier
                │                        │    ├── columns: c:57
                │                        │    └── project
                │                        │         ├── columns: c:57
                │                        │         ├── right-join (cross)
                │                        │         │    ├── columns: count_rows:14
                │                        │         │    ├── limit
                │                        │         │    │    ├── columns: count_rows:14!null
                │                        │         │    │    ├── scalar-group-by
                │                        │         │    │    │    ├── columns: count_rows:14!null
                │                        │         │    │    │    ├── project
                │                        │         │    │    │    │    └── select
                │                        │         │    │    │    │         ├── columns: k:9!null i:10 s:11 crdb_internal_mvcc_timestamp:12 tableoid:13
                │                        │         │    │    │    │         ├── scan t
                │                        │         │    │    │    │         │    └── columns: k:9!null i:10 s:11 crdb_internal_mvcc_timestamp:12 tableoid:13
                │                        │         │    │    │    │         └── filters
                │                        │         │    │    │    │              └── eq
                │                        │         │    │    │    │                   ├── variable: k:9
                │                        │         │    │    │    │                   └── variable: arg_k:5
                │                        │         │    │    │    └── aggregations
                │                        │         │    │    │         └── count-rows [as=count_rows:14]
                │                        │         │    │    └── const: 1
                │                        │         │    ├── values
                │                        │         │    │    └── tuple
                │                        │         │    └── filters (true)
                │                        │         └── projections
                │                        │              └── variable: count_rows:14 [as=c:57]
                │                        └── projections
                │                             └── udf: _stmt_exec_ret_2 [as="_stmt_exec_ret_2":58]
                │                                  ├── args
                │                                  │    ├── variable: arg_k:5
                │                                  │    ├── variable: new_i:6
                │                                  │    ├── variable: new_s:7
                │                                  │    └── variable: c:57
                │                                  ├── params: arg_k:15 new_i:16 new_s:17 c:18
                │                                  └── body
                │                                       └── project
                │                                            ├── columns: stmt_if_7:56
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── case [as=stmt_if_7:56]
                │                                                      ├── true
                │                                                      ├── when
                │                                                      │    ├── gt
                │                                                      │    │    ├── variable: c:18
                │                                                      │    │    └── const: 0
                │                                                      │    └── subquery
                │                                                      │         └── project
                │                                                      │              ├── columns: "_stmt_exec_5":41
                │                                                      │              ├── values
                │                                                      │              │    └── tuple
                │                                                      │              └── projections
                │                                                      │                   └── udf: _stmt_exec_5 [as="_stmt_exec_5":41]
                │                                                      │                        ├── args
                │                                                      │                        │    ├── variable: arg_k:15
                │                                                      │                        │    ├── variable: new_i:16
                │                                                      │                        │    ├── variable: new_s:17
                │                                                      │                        │    └── variable: c:18
                │                                                      │                        ├── params: arg_k:24 new_i:25 new_s:26 c:27
                │                                                      │                        └── body
                │                                                      │                             ├── update t
                │                                                      │                             │    ├── columns: <none>
                │                                                      │                             │    ├── fetch columns: k:33 i:34 s:35
                │                                                      │                             │    ├── update-mapping:
                │                                                      │                             │    │    ├── i_new:38 => i:29
                │                                                      │                             │    │    └── s_new:39 => s:30
                │                                                      │                             │    └── project
                │                                                      │                             │         ├── columns: i_new:38 s_new:39 k:33!null i:34 s:35 crdb_internal_mvcc_timestamp:36 tableoid:37
                │                                                      │                             │         ├── select
                │                                                      │                             │         │    ├── columns: k:33!null i:34 s:35 crdb_internal_mvcc_timestamp:36 tableoid:37
                │                                                      │                             │         │    ├── scan t
                │                                                      │                             │         │    │    └── columns: k:33!null i:34 s:35 crdb_internal_mvcc_timestamp:36 tableoid:37
                │                                                      │                             │         │    └── filters
                │                                                      │                             │         │         └── eq
                │                                                      │                             │         │              ├── variable: k:33
                │                                                      │                             │         │              └── variable: arg_k:24
                │                                                      │                             │         └── projections
                │                                                      │                             │              ├── variable: new_i:25 [as=i_new:38]
                │                                                      │                             │              └── variable: new_s:26 [as=s_new:39]
                │                                                      │                             └── project
                │                                                      │                                  ├── columns: stmt_if_3:40
                │                                                      │                                  ├── values
                │                                                      │                                  │    └── tuple
                │                                                      │                                  └── projections
                │                                                      │                                       └── udf: stmt_if_3 [as=stmt_if_3:40]
                │                                                      │                                            ├── args
                │                                                      │                                            │    ├── variable: arg_k:24
                │                                                      │                                            │    ├── variable: new_i:25
                │                                                      │                                            │    ├── variable: new_s:26
                │                                                      │                                            │    └── variable: c:27
                │                                                      │                                            ├── params: arg_k:19 new_i:20 new_s:21 c:22
                │                                                      │                                            └── body
                │                                                      │                                                 └── project
                │                                                      │                                                      ├── columns: stmt_return_4:23
                │                                                      │                                                      ├── values
                │                                                      │                                                      │    └── tuple
                │                                                      │                                                      └── projections
                │                                                      │                                                           └── cast: VOID [as=stmt_return_4:23]
                │                                                      │                                                                └── null
                │                                                      └── subquery
                │                                                           └── project
                │                                                                ├── columns: "_stmt_exec_6":55
                │                                                                ├── values
                │                                                                │    └── tuple
                │                                                                └── projections
                │                                                                     └── udf: _stmt_exec_6 [as="_stmt_exec_6":55]
                │                                                                          ├── args
                │                                                                          │    ├── variable: arg_k:15
                │                                                                          │    ├── variable: new_i:16
                │                                                                          │    ├── variable: new_s:17
                │                                                                          │    └── variable: c:18
                │                                                                          ├── params: arg_k:42 new_i:43 new_s:44 c:45
                │                                                                          └── body
                │                                                                               ├── insert t
                │                                                                               │    ├── columns: <none>
                │                                                                               │    ├── insert-mapping:
                │                                                                               │    │    ├── column1:51 => k:46
                │                                                                               │    │    ├── column2:52 => i:47
                │                                                                               │    │    └── column3:53 => s:48
                │                                                                               │    └── values
                │                                                                               │         ├── columns: column1:51 column2:52 column3:53
                │                                                                               │         └── tuple
                │                                                                               │              ├── variable: arg_k:42
                │                                                                               │              ├── variable: new_i:43
                │                                                                               │              └── variable: new_s:44
                │                                                                               └── project
                │                                                                                    ├── columns: stmt_if_3:54
                │                                                                                    ├── values
                │                                                                                    │    └── tuple
                │                                                                                    └── projections
                │                                                                                         └── udf: stmt_if_3 [as=stmt_if_3:54]
                │                                                                                              ├── args
                │                                                                                              │    ├── variable: arg_k:42
                │                                                                                              │    ├── variable: new_i:43
                │                                                                                              │    ├── variable: new_s:44
                │                                                                                              │    └── variable: c:45
                │                                                                                              ├── params: arg_k:19 new_i:20 new_s:21 c:22
                │                                                                                              └── body
                │                                                                                                   └── project
                │                                                                                                        ├── columns: stmt_return_4:23
                │                                                                                                        ├── values
                │                                                                                                        │    └── tuple
                │                                                                                                        └── projections
                │                                                                                                             └── cast: VOID [as=stmt_return_4:23]
                │                                                                                                                  └── null
                └── const: 1
