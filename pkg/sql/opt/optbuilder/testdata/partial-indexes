exec-ddl
CREATE TABLE partial_indexes (
    a INT PRIMARY KEY,
    b INT,
    c STRING,
    UNIQUE (b, c),
    INDEX (b),
    INDEX (b) WHERE c = 'foo',
    INDEX (c) WHERE a > b AND c = 'bar',
    INDEX "b:delete-only" (b) WHERE c = 'delete-only',
    INDEX "b:write-only" (b) WHERE c = 'write-only'
)
----

exec-ddl
CREATE TABLE uniq (
    a INT PRIMARY KEY,
    b INT,
    c STRING,
    UNIQUE INDEX (b) WHERE c = 'foo'
)
----

exec-ddl
CREATE TABLE comp (
    a INT PRIMARY KEY,
    b INT,
    c STRING,
    d STRING AS (lower(c)) VIRTUAL,
    e STRING AS (upper(c)) STORED,
    INDEX (b) WHERE d = 'foo',
    INDEX (b) WHERE e = 'FOO'
)
----

exec-ddl
CREATE TABLE ambig (
    partial_index_put1 INT,
    partial_index_del1 INT,
    UNIQUE INDEX (partial_index_put1) WHERE partial_index_put1 > 0,
    UNIQUE INDEX (partial_index_del1) WHERE partial_index_del1 > 0
)
----

# -- SELECT tests --

# Populate table metadata with partial index predicates.
build
SELECT a FROM partial_indexes
----
project
 ├── columns: a:1!null
 └── scan partial_indexes
      ├── columns: a:1!null b:2 c:3 crdb_internal_mvcc_timestamp:4
      └── partial index predicates
           ├── secondary: filters
           │    └── c:3 = 'foo'
           ├── secondary: filters
           │    └── (a:1 > b:2) AND (c:3 = 'bar')
           ├── b: filters
           │    └── c:3 = 'delete-only'
           └── b: filters
                └── c:3 = 'write-only'

# Inline virtual computed column expressions in partial index predicates in
# table metadata. Do not inline stored computed column expressions.
build
SELECT a FROM comp
----
project
 ├── columns: a:1!null
 └── project
      ├── columns: d:4 a:1!null b:2 c:3 e:5 crdb_internal_mvcc_timestamp:6
      ├── scan comp
      │    ├── columns: a:1!null b:2 c:3 e:5 crdb_internal_mvcc_timestamp:6
      │    ├── computed column expressions
      │    │    ├── d:4
      │    │    │    └── lower(c:3)
      │    │    └── e:5
      │    │         └── upper(c:3)
      │    └── partial index predicates
      │         ├── secondary: filters
      │         │    └── lower(c:3) = 'foo'
      │         └── secondary: filters
      │              └── e:5 = 'FOO'
      └── projections
           └── lower(c:3) [as=d:4]

# -- INSERT tests --

build
INSERT INTO partial_indexes VALUES (2, 1, 'bar')
----
insert partial_indexes
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:8 partial_index_put2:9 partial_index_put3:10 partial_index_put4:11
 └── project
      ├── columns: partial_index_put1:8!null partial_index_put2:9!null partial_index_put3:10!null partial_index_put4:11!null column1:5!null column2:6!null column3:7!null
      ├── values
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    └── (2, 1, 'bar')
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:8]
           ├── (column1:5 > column2:6) AND (column3:7 = 'bar') [as=partial_index_put2:9]
           ├── column3:7 = 'delete-only' [as=partial_index_put3:10]
           └── column3:7 = 'write-only' [as=partial_index_put4:11]

# Do not error with "column reference is ambiguous" when table column names
# match synthesized column names.
build
INSERT INTO ambig (partial_index_put1) VALUES (1)
----
insert ambig
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:5 => ambig.partial_index_put1:1
 │    ├── column6:6 => partial_index_del1:2
 │    └── column7:7 => rowid:3
 ├── partial index put columns: partial_index_put1:8 partial_index_put2:9
 └── project
      ├── columns: partial_index_put1:8!null partial_index_put2:9 column1:5!null column6:6 column7:7
      ├── project
      │    ├── columns: column6:6 column7:7 column1:5!null
      │    ├── values
      │    │    ├── columns: column1:5!null
      │    │    └── (1,)
      │    └── projections
      │         ├── NULL::INT8 [as=column6:6]
      │         └── unique_rowid() [as=column7:7]
      └── projections
           ├── column1:5 > 0 [as=partial_index_put1:8]
           └── column6:6 > 0 [as=partial_index_put2:9]

build
INSERT INTO comp (a, b, c) VALUES (2, 1, 'Foo')
----
insert comp
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:12 partial_index_put2:13
 └── project
      ├── columns: partial_index_put1:12 partial_index_put2:13 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      ├── project
      │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    ├── values
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    └── (2, 1, 'Foo')
      │    └── projections
      │         ├── lower(column3:9) [as=column10:10]
      │         └── upper(column3:9) [as=column11:11]
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:12]
           └── column11:11 = 'FOO' [as=partial_index_put2:13]

# Regression test for issue #52546. Building partial index predicate expressions
# that are only a single column reference should not panic.

exec-ddl
CREATE TABLE t52546 (a INT, b BOOL, INDEX (a) WHERE b)
----

build
INSERT INTO t52546 VALUES (1, true)
----
insert t52546
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column7:7 => rowid:3
 ├── partial index put columns: column2:6
 └── project
      ├── columns: column7:7 column1:5!null column2:6!null
      ├── values
      │    ├── columns: column1:5!null column2:6!null
      │    └── (1, true)
      └── projections
           └── unique_rowid() [as=column7:7]

# -- DELETE tests --

build
DELETE FROM partial_indexes
----
delete partial_indexes
 ├── columns: <none>
 ├── fetch columns: a:5 b:6 c:7
 ├── partial index del columns: partial_index_del1:9 partial_index_del2:10 partial_index_del3:11 partial_index_del4:12
 └── project
      ├── columns: partial_index_del1:9 partial_index_del2:10 partial_index_del3:11 partial_index_del4:12 a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      ├── scan partial_indexes
      │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    └── partial index predicates
      │         ├── secondary: filters
      │         │    └── c:7 = 'foo'
      │         ├── secondary: filters
      │         │    └── (a:5 > b:6) AND (c:7 = 'bar')
      │         ├── b: filters
      │         │    └── c:7 = 'delete-only'
      │         └── b: filters
      │              └── c:7 = 'write-only'
      └── projections
           ├── c:7 = 'foo' [as=partial_index_del1:9]
           ├── (a:5 > b:6) AND (c:7 = 'bar') [as=partial_index_del2:10]
           ├── c:7 = 'delete-only' [as=partial_index_del3:11]
           └── c:7 = 'write-only' [as=partial_index_del4:12]

# Do not error with "column reference is ambiguous" when table column names
# match synthesized column names.
build
DELETE FROM ambig WHERE partial_index_del1 = 5
----
delete ambig
 ├── columns: <none>
 ├── fetch columns: partial_index_put1:5 ambig.partial_index_del1:6 rowid:7
 ├── partial index del columns: partial_index_del1:9 partial_index_del2:10
 └── project
      ├── columns: partial_index_del1:9 partial_index_del2:10!null partial_index_put1:5 ambig.partial_index_del1:6!null rowid:7!null crdb_internal_mvcc_timestamp:8
      ├── select
      │    ├── columns: partial_index_put1:5 ambig.partial_index_del1:6!null rowid:7!null crdb_internal_mvcc_timestamp:8
      │    ├── scan ambig
      │    │    ├── columns: partial_index_put1:5 ambig.partial_index_del1:6 rowid:7!null crdb_internal_mvcc_timestamp:8
      │    │    └── partial index predicates
      │    │         ├── secondary: filters
      │    │         │    └── partial_index_put1:5 > 0
      │    │         └── secondary: filters
      │    │              └── ambig.partial_index_del1:6 > 0
      │    └── filters
      │         └── ambig.partial_index_del1:6 = 5
      └── projections
           ├── partial_index_put1:5 > 0 [as=partial_index_del1:9]
           └── ambig.partial_index_del1:6 > 0 [as=partial_index_del2:10]

build
DELETE FROM comp
----
delete comp
 ├── columns: <none>
 ├── fetch columns: a:7 b:8 c:9 d:10 e:11
 ├── partial index del columns: partial_index_del1:13 partial_index_del2:14
 └── project
      ├── columns: partial_index_del1:13 partial_index_del2:14 a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12
      ├── project
      │    ├── columns: d:10 a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    ├── scan comp
      │    │    ├── columns: a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    │    ├── computed column expressions
      │    │    │    ├── d:10
      │    │    │    │    └── lower(c:9)
      │    │    │    └── e:11
      │    │    │         └── upper(c:9)
      │    │    └── partial index predicates
      │    │         ├── secondary: filters
      │    │         │    └── lower(c:9) = 'foo'
      │    │         └── secondary: filters
      │    │              └── e:11 = 'FOO'
      │    └── projections
      │         └── lower(c:9) [as=d:10]
      └── projections
           ├── d:10 = 'foo' [as=partial_index_del1:13]
           └── e:11 = 'FOO' [as=partial_index_del2:14]

# -- UPDATE tests --

build
UPDATE partial_indexes SET a = 1
----
update partial_indexes
 ├── columns: <none>
 ├── fetch columns: a:5 b:6 c:7
 ├── update-mapping:
 │    └── a_new:9 => a:1
 ├── partial index put columns: partial_index_put1:10 partial_index_put2:11 partial_index_put3:13 partial_index_put4:14
 ├── partial index del columns: partial_index_put1:10 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14
 └── project
      ├── columns: partial_index_put1:10 partial_index_put2:11 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14 a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 a_new:9!null
      ├── project
      │    ├── columns: a_new:9!null a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    ├── scan partial_indexes
      │    │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    │    └── partial index predicates
      │    │         ├── secondary: filters
      │    │         │    └── c:7 = 'foo'
      │    │         ├── secondary: filters
      │    │         │    └── (a:5 > b:6) AND (c:7 = 'bar')
      │    │         ├── b: filters
      │    │         │    └── c:7 = 'delete-only'
      │    │         └── b: filters
      │    │              └── c:7 = 'write-only'
      │    └── projections
      │         └── 1 [as=a_new:9]
      └── projections
           ├── c:7 = 'foo' [as=partial_index_put1:10]
           ├── (a_new:9 > b:6) AND (c:7 = 'bar') [as=partial_index_put2:11]
           ├── (a:5 > b:6) AND (c:7 = 'bar') [as=partial_index_del2:12]
           ├── c:7 = 'delete-only' [as=partial_index_put3:13]
           └── c:7 = 'write-only' [as=partial_index_put4:14]

build
UPDATE partial_indexes SET a = a + 5 RETURNING *
----
update partial_indexes
 ├── columns: a:1!null b:2 c:3
 ├── fetch columns: a:5 b:6 c:7
 ├── update-mapping:
 │    └── a_new:9 => a:1
 ├── partial index put columns: partial_index_put1:10 partial_index_put2:11 partial_index_put3:13 partial_index_put4:14
 ├── partial index del columns: partial_index_put1:10 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14
 └── project
      ├── columns: partial_index_put1:10 partial_index_put2:11 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14 a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 a_new:9!null
      ├── project
      │    ├── columns: a_new:9!null a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    ├── scan partial_indexes
      │    │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    │    └── partial index predicates
      │    │         ├── secondary: filters
      │    │         │    └── c:7 = 'foo'
      │    │         ├── secondary: filters
      │    │         │    └── (a:5 > b:6) AND (c:7 = 'bar')
      │    │         ├── b: filters
      │    │         │    └── c:7 = 'delete-only'
      │    │         └── b: filters
      │    │              └── c:7 = 'write-only'
      │    └── projections
      │         └── a:5 + 5 [as=a_new:9]
      └── projections
           ├── c:7 = 'foo' [as=partial_index_put1:10]
           ├── (a_new:9 > b:6) AND (c:7 = 'bar') [as=partial_index_put2:11]
           ├── (a:5 > b:6) AND (c:7 = 'bar') [as=partial_index_del2:12]
           ├── c:7 = 'delete-only' [as=partial_index_put3:13]
           └── c:7 = 'write-only' [as=partial_index_put4:14]

build
UPDATE partial_indexes SET a = v.a FROM (VALUES (1), (2)) AS v(a) WHERE partial_indexes.a = v.a
----
update partial_indexes
 ├── columns: <none>
 ├── fetch columns: a:5 b:6 c:7
 ├── update-mapping:
 │    └── column1:9 => a:1
 ├── partial index put columns: partial_index_put1:10 partial_index_put2:11 partial_index_put3:13 partial_index_put4:14
 ├── partial index del columns: partial_index_put1:10 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14
 └── project
      ├── columns: partial_index_put1:10 partial_index_put2:11 partial_index_del2:12 partial_index_put3:13 partial_index_put4:14 a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 column1:9!null
      ├── distinct-on
      │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 column1:9!null
      │    ├── grouping columns: a:5!null
      │    ├── select
      │    │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 column1:9!null
      │    │    ├── inner-join (cross)
      │    │    │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8 column1:9!null
      │    │    │    ├── scan partial_indexes
      │    │    │    │    ├── columns: a:5!null b:6 c:7 crdb_internal_mvcc_timestamp:8
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── c:7 = 'foo'
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── (a:5 > b:6) AND (c:7 = 'bar')
      │    │    │    │         ├── b: filters
      │    │    │    │         │    └── c:7 = 'delete-only'
      │    │    │    │         └── b: filters
      │    │    │    │              └── c:7 = 'write-only'
      │    │    │    ├── values
      │    │    │    │    ├── columns: column1:9!null
      │    │    │    │    ├── (1,)
      │    │    │    │    └── (2,)
      │    │    │    └── filters (true)
      │    │    └── filters
      │    │         └── a:5 = column1:9
      │    └── aggregations
      │         ├── first-agg [as=b:6]
      │         │    └── b:6
      │         ├── first-agg [as=c:7]
      │         │    └── c:7
      │         ├── first-agg [as=crdb_internal_mvcc_timestamp:8]
      │         │    └── crdb_internal_mvcc_timestamp:8
      │         └── first-agg [as=column1:9]
      │              └── column1:9
      └── projections
           ├── c:7 = 'foo' [as=partial_index_put1:10]
           ├── (column1:9 > b:6) AND (c:7 = 'bar') [as=partial_index_put2:11]
           ├── (a:5 > b:6) AND (c:7 = 'bar') [as=partial_index_del2:12]
           ├── c:7 = 'delete-only' [as=partial_index_put3:13]
           └── c:7 = 'write-only' [as=partial_index_put4:14]

# Do not error with "column reference is ambiguous" when table column names
# match synthesized column names.
build
UPDATE ambig SET partial_index_put1 = 1, partial_index_del1 = 2 WHERE partial_index_put1 = 10 and partial_index_del1 = 20
----
update ambig
 ├── columns: <none>
 ├── fetch columns: ambig.partial_index_put1:5 ambig.partial_index_del1:6 rowid:7
 ├── update-mapping:
 │    ├── partial_index_put1_new:9 => ambig.partial_index_put1:1
 │    └── partial_index_del1_new:10 => ambig.partial_index_del1:2
 ├── partial index put columns: partial_index_put1:11 partial_index_put2:13
 ├── partial index del columns: partial_index_del1:12 partial_index_del2:14
 └── project
      ├── columns: partial_index_put1:11!null partial_index_del1:12!null partial_index_put2:13!null partial_index_del2:14!null ambig.partial_index_put1:5!null ambig.partial_index_del1:6!null rowid:7!null crdb_internal_mvcc_timestamp:8 partial_index_put1_new:9!null partial_index_del1_new:10!null
      ├── project
      │    ├── columns: partial_index_put1_new:9!null partial_index_del1_new:10!null ambig.partial_index_put1:5!null ambig.partial_index_del1:6!null rowid:7!null crdb_internal_mvcc_timestamp:8
      │    ├── select
      │    │    ├── columns: ambig.partial_index_put1:5!null ambig.partial_index_del1:6!null rowid:7!null crdb_internal_mvcc_timestamp:8
      │    │    ├── scan ambig
      │    │    │    ├── columns: ambig.partial_index_put1:5 ambig.partial_index_del1:6 rowid:7!null crdb_internal_mvcc_timestamp:8
      │    │    │    └── partial index predicates
      │    │    │         ├── secondary: filters
      │    │    │         │    └── ambig.partial_index_put1:5 > 0
      │    │    │         └── secondary: filters
      │    │    │              └── ambig.partial_index_del1:6 > 0
      │    │    └── filters
      │    │         └── (ambig.partial_index_put1:5 = 10) AND (ambig.partial_index_del1:6 = 20)
      │    └── projections
      │         ├── 1 [as=partial_index_put1_new:9]
      │         └── 2 [as=partial_index_del1_new:10]
      └── projections
           ├── partial_index_put1_new:9 > 0 [as=partial_index_put1:11]
           ├── ambig.partial_index_put1:5 > 0 [as=partial_index_del1:12]
           ├── partial_index_del1_new:10 > 0 [as=partial_index_put2:13]
           └── ambig.partial_index_del1:6 > 0 [as=partial_index_del2:14]

build
UPDATE comp SET b = 1
----
update comp
 ├── columns: <none>
 ├── fetch columns: a:7 b:8 c:9 d:10 e:11
 ├── update-mapping:
 │    └── b_new:13 => b:2
 ├── partial index put columns: partial_index_put1:16 partial_index_put2:17
 ├── partial index del columns: partial_index_put1:16 partial_index_put2:17
 └── project
      ├── columns: partial_index_put1:16 partial_index_put2:17 a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12 b_new:13!null column14:14 column15:15
      ├── project
      │    ├── columns: column14:14 column15:15 a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12 b_new:13!null
      │    ├── project
      │    │    ├── columns: b_new:13!null a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12
      │    │    ├── project
      │    │    │    ├── columns: d:10 a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    │    │    ├── scan comp
      │    │    │    │    ├── columns: a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    │    │    │    ├── computed column expressions
      │    │    │    │    │    ├── d:10
      │    │    │    │    │    │    └── lower(c:9)
      │    │    │    │    │    └── e:11
      │    │    │    │    │         └── upper(c:9)
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── lower(c:9) = 'foo'
      │    │    │    │         └── secondary: filters
      │    │    │    │              └── e:11 = 'FOO'
      │    │    │    └── projections
      │    │    │         └── lower(c:9) [as=d:10]
      │    │    └── projections
      │    │         └── 1 [as=b_new:13]
      │    └── projections
      │         ├── lower(c:9) [as=column14:14]
      │         └── upper(c:9) [as=column15:15]
      └── projections
           ├── d:10 = 'foo' [as=partial_index_put1:16]
           └── e:11 = 'FOO' [as=partial_index_put2:17]

build
UPDATE comp SET c = 'Bar'
----
update comp
 ├── columns: <none>
 ├── fetch columns: a:7 b:8 c:9 d:10 e:11
 ├── update-mapping:
 │    ├── c_new:13 => c:3
 │    ├── column14:14 => d:4
 │    └── column15:15 => e:5
 ├── partial index put columns: partial_index_put1:16 partial_index_put2:18
 ├── partial index del columns: partial_index_del1:17 partial_index_del2:19
 └── project
      ├── columns: partial_index_put1:16 partial_index_del1:17 partial_index_put2:18 partial_index_del2:19 a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12 c_new:13!null column14:14 column15:15
      ├── project
      │    ├── columns: column14:14 column15:15 a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12 c_new:13!null
      │    ├── project
      │    │    ├── columns: c_new:13!null a:7!null b:8 c:9 d:10 e:11 crdb_internal_mvcc_timestamp:12
      │    │    ├── project
      │    │    │    ├── columns: d:10 a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    │    │    ├── scan comp
      │    │    │    │    ├── columns: a:7!null b:8 c:9 e:11 crdb_internal_mvcc_timestamp:12
      │    │    │    │    ├── computed column expressions
      │    │    │    │    │    ├── d:10
      │    │    │    │    │    │    └── lower(c:9)
      │    │    │    │    │    └── e:11
      │    │    │    │    │         └── upper(c:9)
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── lower(c:9) = 'foo'
      │    │    │    │         └── secondary: filters
      │    │    │    │              └── e:11 = 'FOO'
      │    │    │    └── projections
      │    │    │         └── lower(c:9) [as=d:10]
      │    │    └── projections
      │    │         └── 'Bar' [as=c_new:13]
      │    └── projections
      │         ├── lower(c_new:13) [as=column14:14]
      │         └── upper(c_new:13) [as=column15:15]
      └── projections
           ├── column14:14 = 'foo' [as=partial_index_put1:16]
           ├── d:10 = 'foo' [as=partial_index_del1:17]
           ├── column15:15 = 'FOO' [as=partial_index_put2:18]
           └── e:11 = 'FOO' [as=partial_index_del2:19]

# Regression test for #61520. The new value for column a (project as b:8) should
# be in-scope when building the partial index PUT expression when the value in
# the FROM clause must be rounded.

exec-ddl
CREATE TABLE t61520 (
  a DECIMAL(10, 2),
  INDEX (a) WHERE a > 0
)
----

build
UPDATE t61520 t SET a = v.b FROM (VALUES (1.0)) v(b) WHERE t.a = v.b RETURNING a, b
----
project
 ├── columns: a:1 b:7
 └── update t61520 [as=t]
      ├── columns: a:1 rowid:2!null column1:7
      ├── fetch columns: a:4 rowid:5
      ├── update-mapping:
      │    └── b:8 => a:1
      ├── partial index put columns: partial_index_put1:9
      ├── partial index del columns: partial_index_del1:10
      └── project
           ├── columns: partial_index_put1:9 partial_index_del1:10!null a:4!null rowid:5!null crdb_internal_mvcc_timestamp:6 column1:7!null b:8
           ├── project
           │    ├── columns: b:8 a:4!null rowid:5!null crdb_internal_mvcc_timestamp:6 column1:7!null
           │    ├── select
           │    │    ├── columns: a:4!null rowid:5!null crdb_internal_mvcc_timestamp:6 column1:7!null
           │    │    ├── inner-join (cross)
           │    │    │    ├── columns: a:4 rowid:5!null crdb_internal_mvcc_timestamp:6 column1:7!null
           │    │    │    ├── scan t61520 [as=t]
           │    │    │    │    ├── columns: a:4 rowid:5!null crdb_internal_mvcc_timestamp:6
           │    │    │    │    └── partial index predicates
           │    │    │    │         └── secondary: filters
           │    │    │    │              └── a:4 > 0
           │    │    │    ├── values
           │    │    │    │    ├── columns: column1:7!null
           │    │    │    │    └── (1.0,)
           │    │    │    └── filters (true)
           │    │    └── filters
           │    │         └── a:4 = column1:7
           │    └── projections
           │         └── crdb_internal.round_decimal_values(column1:7, 2) [as=b:8]
           └── projections
                ├── b:8 > 0 [as=partial_index_put1:9]
                └── a:4 > 0 [as=partial_index_del1:10]

# -- UPSERT / INSERT ON CONFLICT tests --

build
INSERT INTO partial_indexes VALUES (2, 1, 'bar') ON CONFLICT DO NOTHING
----
insert partial_indexes
 ├── columns: <none>
 ├── arbiter indexes: primary secondary
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:16 partial_index_put2:17 partial_index_put3:18 partial_index_put4:19
 └── project
      ├── columns: partial_index_put1:16!null partial_index_put2:17!null partial_index_put3:18!null partial_index_put4:19!null column1:5!null column2:6!null column3:7!null
      ├── upsert-distinct-on
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    ├── grouping columns: column2:6!null column3:7!null
      │    ├── upsert-distinct-on
      │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    ├── grouping columns: column1:5!null
      │    │    ├── anti-join (hash)
      │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    ├── anti-join (hash)
      │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    ├── values
      │    │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    │    └── (2, 1, 'bar')
      │    │    │    │    ├── scan partial_indexes
      │    │    │    │    │    ├── columns: a:8!null b:9 c:10
      │    │    │    │    │    └── partial index predicates
      │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │         │    └── c:10 = 'foo'
      │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │         │    └── (a:8 > b:9) AND (c:10 = 'bar')
      │    │    │    │    │         ├── b: filters
      │    │    │    │    │         │    └── c:10 = 'delete-only'
      │    │    │    │    │         └── b: filters
      │    │    │    │    │              └── c:10 = 'write-only'
      │    │    │    │    └── filters
      │    │    │    │         └── column1:5 = a:8
      │    │    │    ├── scan partial_indexes
      │    │    │    │    ├── columns: a:12!null b:13 c:14
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── c:14 = 'foo'
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── (a:12 > b:13) AND (c:14 = 'bar')
      │    │    │    │         ├── b: filters
      │    │    │    │         │    └── c:14 = 'delete-only'
      │    │    │    │         └── b: filters
      │    │    │    │              └── c:14 = 'write-only'
      │    │    │    └── filters
      │    │    │         ├── column2:6 = b:13
      │    │    │         └── column3:7 = c:14
      │    │    └── aggregations
      │    │         ├── first-agg [as=column2:6]
      │    │         │    └── column2:6
      │    │         └── first-agg [as=column3:7]
      │    │              └── column3:7
      │    └── aggregations
      │         └── first-agg [as=column1:5]
      │              └── column1:5
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:16]
           ├── (column1:5 > column2:6) AND (column3:7 = 'bar') [as=partial_index_put2:17]
           ├── column3:7 = 'delete-only' [as=partial_index_put3:18]
           └── column3:7 = 'write-only' [as=partial_index_put4:19]

build
INSERT INTO partial_indexes VALUES (2, 1, 'bar') ON CONFLICT (b, c) DO UPDATE SET b = partial_indexes.b + 1, c = 'baz'
----
upsert partial_indexes
 ├── columns: <none>
 ├── arbiter indexes: secondary
 ├── canary column: a:8
 ├── fetch columns: a:8 b:9 c:10
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── update-mapping:
 │    ├── upsert_b:15 => b:2
 │    └── upsert_c:16 => c:3
 ├── partial index put columns: partial_index_put1:17 partial_index_put2:19 partial_index_put3:21 partial_index_put4:23
 ├── partial index del columns: partial_index_del1:18 partial_index_del2:20 partial_index_del3:22 partial_index_del4:24
 └── project
      ├── columns: partial_index_put1:17!null partial_index_del1:18 partial_index_put2:19 partial_index_del2:20 partial_index_put3:21!null partial_index_del3:22 partial_index_put4:23!null partial_index_del4:24 column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11 b_new:12 c_new:13!null upsert_a:14 upsert_b:15 upsert_c:16!null
      ├── project
      │    ├── columns: upsert_a:14 upsert_b:15 upsert_c:16!null column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11 b_new:12 c_new:13!null
      │    ├── project
      │    │    ├── columns: b_new:12 c_new:13!null column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    │    ├── left-join (hash)
      │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    │    │    ├── ensure-upsert-distinct-on
      │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    ├── grouping columns: column2:6!null column3:7!null
      │    │    │    │    ├── values
      │    │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    │    └── (2, 1, 'bar')
      │    │    │    │    └── aggregations
      │    │    │    │         └── first-agg [as=column1:5]
      │    │    │    │              └── column1:5
      │    │    │    ├── scan partial_indexes
      │    │    │    │    ├── columns: a:8!null b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── c:10 = 'foo'
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── (a:8 > b:9) AND (c:10 = 'bar')
      │    │    │    │         ├── b: filters
      │    │    │    │         │    └── c:10 = 'delete-only'
      │    │    │    │         └── b: filters
      │    │    │    │              └── c:10 = 'write-only'
      │    │    │    └── filters
      │    │    │         ├── column2:6 = b:9
      │    │    │         └── column3:7 = c:10
      │    │    └── projections
      │    │         ├── b:9 + 1 [as=b_new:12]
      │    │         └── 'baz' [as=c_new:13]
      │    └── projections
      │         ├── CASE WHEN a:8 IS NULL THEN column1:5 ELSE a:8 END [as=upsert_a:14]
      │         ├── CASE WHEN a:8 IS NULL THEN column2:6 ELSE b_new:12 END [as=upsert_b:15]
      │         └── CASE WHEN a:8 IS NULL THEN column3:7 ELSE c_new:13 END [as=upsert_c:16]
      └── projections
           ├── upsert_c:16 = 'foo' [as=partial_index_put1:17]
           ├── c:10 = 'foo' [as=partial_index_del1:18]
           ├── (upsert_a:14 > upsert_b:15) AND (upsert_c:16 = 'bar') [as=partial_index_put2:19]
           ├── (a:8 > b:9) AND (c:10 = 'bar') [as=partial_index_del2:20]
           ├── upsert_c:16 = 'delete-only' [as=partial_index_put3:21]
           ├── c:10 = 'delete-only' [as=partial_index_del3:22]
           ├── upsert_c:16 = 'write-only' [as=partial_index_put4:23]
           └── c:10 = 'write-only' [as=partial_index_del4:24]

build
UPSERT INTO partial_indexes VALUES (2, 1, 'bar')
----
upsert partial_indexes
 ├── columns: <none>
 ├── arbiter indexes: primary
 ├── canary column: a:8
 ├── fetch columns: a:8 b:9 c:10
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── update-mapping:
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:13 partial_index_put2:15 partial_index_put3:17 partial_index_put4:19
 ├── partial index del columns: partial_index_del1:14 partial_index_del2:16 partial_index_del3:18 partial_index_del4:20
 └── project
      ├── columns: partial_index_put1:13!null partial_index_del1:14 partial_index_put2:15 partial_index_del2:16 partial_index_put3:17!null partial_index_del3:18 partial_index_put4:19!null partial_index_del4:20 column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11 upsert_a:12
      ├── project
      │    ├── columns: upsert_a:12 column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    ├── left-join (hash)
      │    │    ├── columns: column1:5!null column2:6!null column3:7!null a:8 b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    │    ├── ensure-upsert-distinct-on
      │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    ├── grouping columns: column1:5!null
      │    │    │    ├── values
      │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    └── (2, 1, 'bar')
      │    │    │    └── aggregations
      │    │    │         ├── first-agg [as=column2:6]
      │    │    │         │    └── column2:6
      │    │    │         └── first-agg [as=column3:7]
      │    │    │              └── column3:7
      │    │    ├── scan partial_indexes
      │    │    │    ├── columns: a:8!null b:9 c:10 crdb_internal_mvcc_timestamp:11
      │    │    │    └── partial index predicates
      │    │    │         ├── secondary: filters
      │    │    │         │    └── c:10 = 'foo'
      │    │    │         ├── secondary: filters
      │    │    │         │    └── (a:8 > b:9) AND (c:10 = 'bar')
      │    │    │         ├── b: filters
      │    │    │         │    └── c:10 = 'delete-only'
      │    │    │         └── b: filters
      │    │    │              └── c:10 = 'write-only'
      │    │    └── filters
      │    │         └── column1:5 = a:8
      │    └── projections
      │         └── CASE WHEN a:8 IS NULL THEN column1:5 ELSE a:8 END [as=upsert_a:12]
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:13]
           ├── c:10 = 'foo' [as=partial_index_del1:14]
           ├── (upsert_a:12 > column2:6) AND (column3:7 = 'bar') [as=partial_index_put2:15]
           ├── (a:8 > b:9) AND (c:10 = 'bar') [as=partial_index_del2:16]
           ├── column3:7 = 'delete-only' [as=partial_index_put3:17]
           ├── c:10 = 'delete-only' [as=partial_index_del3:18]
           ├── column3:7 = 'write-only' [as=partial_index_put4:19]
           └── c:10 = 'write-only' [as=partial_index_del4:20]

# Columns referenced in the SET expression are ambiguous without a table name.
# Is it the value of the column being inserted or the value of the column
# currently in the table?
build
INSERT INTO partial_indexes (a, b, c) VALUES (1, 1, 'foo') ON CONFLICT (a) DO UPDATE SET b = b + 1
----
error (42702): column reference "b" is ambiguous (candidates: excluded.b, partial_indexes.b)

build
INSERT INTO comp VALUES (2, 1, 'Foo') ON CONFLICT DO NOTHING
----
insert comp
 ├── columns: <none>
 ├── arbiter indexes: primary
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:18 partial_index_put2:19
 └── project
      ├── columns: partial_index_put1:18 partial_index_put2:19 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      ├── upsert-distinct-on
      │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    ├── grouping columns: column1:7!null
      │    ├── anti-join (hash)
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    ├── project
      │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    │    │    ├── values
      │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    │    │    └── (2, 1, 'Foo')
      │    │    │    └── projections
      │    │    │         ├── lower(column3:9) [as=column10:10]
      │    │    │         └── upper(column3:9) [as=column11:11]
      │    │    ├── project
      │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16
      │    │    │    ├── scan comp
      │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16
      │    │    │    │    ├── computed column expressions
      │    │    │    │    │    ├── d:15
      │    │    │    │    │    │    └── lower(c:14)
      │    │    │    │    │    └── e:16
      │    │    │    │    │         └── upper(c:14)
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── lower(c:14) = 'foo'
      │    │    │    │         └── secondary: filters
      │    │    │    │              └── e:16 = 'FOO'
      │    │    │    └── projections
      │    │    │         └── lower(c:14) [as=d:15]
      │    │    └── filters
      │    │         └── column1:7 = a:12
      │    └── aggregations
      │         ├── first-agg [as=column2:8]
      │         │    └── column2:8
      │         ├── first-agg [as=column3:9]
      │         │    └── column3:9
      │         ├── first-agg [as=column10:10]
      │         │    └── column10:10
      │         └── first-agg [as=column11:11]
      │              └── column11:11
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:18]
           └── column11:11 = 'FOO' [as=partial_index_put2:19]

build
INSERT INTO comp VALUES (2, 1, 'Foo') ON CONFLICT (a) DO UPDATE SET b = comp.b + 1, c = 'Bar'
----
upsert comp
 ├── columns: <none>
 ├── arbiter indexes: primary
 ├── canary column: a:12
 ├── fetch columns: a:12 b:13 c:14 d:15 e:16
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── update-mapping:
 │    ├── upsert_b:23 => b:2
 │    ├── upsert_c:24 => c:3
 │    ├── upsert_d:25 => d:4
 │    └── upsert_e:26 => e:5
 ├── partial index put columns: partial_index_put1:27 partial_index_put2:29
 ├── partial index del columns: partial_index_del1:28 partial_index_del2:30
 └── project
      ├── columns: partial_index_put1:27 partial_index_del1:28 partial_index_put2:29 partial_index_del2:30 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17 b_new:18 c_new:19!null column20:20 column21:21 upsert_a:22 upsert_b:23 upsert_c:24!null upsert_d:25 upsert_e:26
      ├── project
      │    ├── columns: upsert_a:22 upsert_b:23 upsert_c:24!null upsert_d:25 upsert_e:26 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17 b_new:18 c_new:19!null column20:20 column21:21
      │    ├── project
      │    │    ├── columns: column20:20 column21:21 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17 b_new:18 c_new:19!null
      │    │    ├── project
      │    │    │    ├── columns: b_new:18 c_new:19!null column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    ├── left-join (hash)
      │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    │    ├── ensure-upsert-distinct-on
      │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    │    │    │    ├── grouping columns: column1:7!null
      │    │    │    │    │    ├── project
      │    │    │    │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    │    │    │    │    │    ├── values
      │    │    │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    │    │    │    │    │    └── (2, 1, 'Foo')
      │    │    │    │    │    │    └── projections
      │    │    │    │    │    │         ├── lower(column3:9) [as=column10:10]
      │    │    │    │    │    │         └── upper(column3:9) [as=column11:11]
      │    │    │    │    │    └── aggregations
      │    │    │    │    │         ├── first-agg [as=column2:8]
      │    │    │    │    │         │    └── column2:8
      │    │    │    │    │         ├── first-agg [as=column3:9]
      │    │    │    │    │         │    └── column3:9
      │    │    │    │    │         ├── first-agg [as=column10:10]
      │    │    │    │    │         │    └── column10:10
      │    │    │    │    │         └── first-agg [as=column11:11]
      │    │    │    │    │              └── column11:11
      │    │    │    │    ├── project
      │    │    │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    │    │    ├── scan comp
      │    │    │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    │    │    │    ├── computed column expressions
      │    │    │    │    │    │    │    ├── d:15
      │    │    │    │    │    │    │    │    └── lower(c:14)
      │    │    │    │    │    │    │    └── e:16
      │    │    │    │    │    │    │         └── upper(c:14)
      │    │    │    │    │    │    └── partial index predicates
      │    │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │    │         │    └── lower(c:14) = 'foo'
      │    │    │    │    │    │         └── secondary: filters
      │    │    │    │    │    │              └── e:16 = 'FOO'
      │    │    │    │    │    └── projections
      │    │    │    │    │         └── lower(c:14) [as=d:15]
      │    │    │    │    └── filters
      │    │    │    │         └── column1:7 = a:12
      │    │    │    └── projections
      │    │    │         ├── b:13 + 1 [as=b_new:18]
      │    │    │         └── 'Bar' [as=c_new:19]
      │    │    └── projections
      │    │         ├── lower(c_new:19) [as=column20:20]
      │    │         └── upper(c_new:19) [as=column21:21]
      │    └── projections
      │         ├── CASE WHEN a:12 IS NULL THEN column1:7 ELSE a:12 END [as=upsert_a:22]
      │         ├── CASE WHEN a:12 IS NULL THEN column2:8 ELSE b_new:18 END [as=upsert_b:23]
      │         ├── CASE WHEN a:12 IS NULL THEN column3:9 ELSE c_new:19 END [as=upsert_c:24]
      │         ├── CASE WHEN a:12 IS NULL THEN column10:10 ELSE column20:20 END [as=upsert_d:25]
      │         └── CASE WHEN a:12 IS NULL THEN column11:11 ELSE column21:21 END [as=upsert_e:26]
      └── projections
           ├── upsert_d:25 = 'foo' [as=partial_index_put1:27]
           ├── d:15 = 'foo' [as=partial_index_del1:28]
           ├── upsert_e:26 = 'FOO' [as=partial_index_put2:29]
           └── e:16 = 'FOO' [as=partial_index_del2:30]

build
UPSERT INTO comp VALUES (2, 1, 'Foo')
----
upsert comp
 ├── columns: <none>
 ├── arbiter indexes: primary
 ├── canary column: a:12
 ├── fetch columns: a:12 b:13 c:14 d:15 e:16
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── update-mapping:
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:19 partial_index_put2:21
 ├── partial index del columns: partial_index_del1:20 partial_index_del2:22
 └── project
      ├── columns: partial_index_put1:19 partial_index_del1:20 partial_index_put2:21 partial_index_del2:22 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17 upsert_a:18
      ├── project
      │    ├── columns: upsert_a:18 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17
      │    ├── left-join (hash)
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:12 b:13 c:14 d:15 e:16 crdb_internal_mvcc_timestamp:17
      │    │    ├── ensure-upsert-distinct-on
      │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    │    ├── grouping columns: column1:7!null
      │    │    │    ├── project
      │    │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    │    │    │    ├── values
      │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    │    │    │    └── (2, 1, 'Foo')
      │    │    │    │    └── projections
      │    │    │    │         ├── lower(column3:9) [as=column10:10]
      │    │    │    │         └── upper(column3:9) [as=column11:11]
      │    │    │    └── aggregations
      │    │    │         ├── first-agg [as=column2:8]
      │    │    │         │    └── column2:8
      │    │    │         ├── first-agg [as=column3:9]
      │    │    │         │    └── column3:9
      │    │    │         ├── first-agg [as=column10:10]
      │    │    │         │    └── column10:10
      │    │    │         └── first-agg [as=column11:11]
      │    │    │              └── column11:11
      │    │    ├── project
      │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    ├── scan comp
      │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16 crdb_internal_mvcc_timestamp:17
      │    │    │    │    ├── computed column expressions
      │    │    │    │    │    ├── d:15
      │    │    │    │    │    │    └── lower(c:14)
      │    │    │    │    │    └── e:16
      │    │    │    │    │         └── upper(c:14)
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── lower(c:14) = 'foo'
      │    │    │    │         └── secondary: filters
      │    │    │    │              └── e:16 = 'FOO'
      │    │    │    └── projections
      │    │    │         └── lower(c:14) [as=d:15]
      │    │    └── filters
      │    │         └── column1:7 = a:12
      │    └── projections
      │         └── CASE WHEN a:12 IS NULL THEN column1:7 ELSE a:12 END [as=upsert_a:18]
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:19]
           ├── d:15 = 'foo' [as=partial_index_del1:20]
           ├── column11:11 = 'FOO' [as=partial_index_put2:21]
           └── e:16 = 'FOO' [as=partial_index_del2:22]

build
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT DO NOTHING
----
insert uniq
 ├── columns: <none>
 ├── arbiter indexes: primary secondary
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:17
 └── project
      ├── columns: partial_index_put1:17!null column1:5!null column2:6!null column3:7!null
      ├── project
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    └── upsert-distinct-on
      │         ├── columns: column1:5!null column2:6!null column3:7!null arbiter_secondary_distinct:16
      │         ├── grouping columns: column2:6!null arbiter_secondary_distinct:16
      │         ├── project
      │         │    ├── columns: arbiter_secondary_distinct:16 column1:5!null column2:6!null column3:7!null
      │         │    ├── upsert-distinct-on
      │         │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │    ├── grouping columns: column1:5!null
      │         │    │    ├── anti-join (hash)
      │         │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │    │    ├── anti-join (hash)
      │         │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │    │    │    ├── values
      │         │    │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │    │    │    │    └── (1, 1, 'bar')
      │         │    │    │    │    ├── scan uniq
      │         │    │    │    │    │    ├── columns: a:8!null b:9 c:10
      │         │    │    │    │    │    └── partial index predicates
      │         │    │    │    │    │         └── secondary: filters
      │         │    │    │    │    │              └── c:10 = 'foo'
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── column1:5 = a:8
      │         │    │    │    ├── select
      │         │    │    │    │    ├── columns: a:12!null b:13 c:14!null
      │         │    │    │    │    ├── scan uniq
      │         │    │    │    │    │    ├── columns: a:12!null b:13 c:14
      │         │    │    │    │    │    └── partial index predicates
      │         │    │    │    │    │         └── secondary: filters
      │         │    │    │    │    │              └── c:14 = 'foo'
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── c:14 = 'foo'
      │         │    │    │    └── filters
      │         │    │    │         ├── column2:6 = b:13
      │         │    │    │         └── column3:7 = 'foo'
      │         │    │    └── aggregations
      │         │    │         ├── first-agg [as=column2:6]
      │         │    │         │    └── column2:6
      │         │    │         └── first-agg [as=column3:7]
      │         │    │              └── column3:7
      │         │    └── projections
      │         │         └── (column3:7 = 'foo') OR NULL::BOOL [as=arbiter_secondary_distinct:16]
      │         └── aggregations
      │              ├── first-agg [as=column1:5]
      │              │    └── column1:5
      │              └── first-agg [as=column3:7]
      │                   └── column3:7
      └── projections
           └── column3:7 = 'foo' [as=partial_index_put1:17]

exec-ddl
CREATE UNIQUE INDEX u2 ON uniq (b) WHERE c = 'bar'
----

# Build scans for both partial indexes when the arbiter predicate implies them.
build
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE c = 'foo' AND c = 'bar' DO NOTHING
----
insert uniq
 ├── columns: <none>
 ├── arbiter indexes: secondary u2
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:18 partial_index_put2:19
 └── project
      ├── columns: partial_index_put1:18!null partial_index_put2:19!null column1:5!null column2:6!null column3:7!null
      ├── project
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    └── upsert-distinct-on
      │         ├── columns: column1:5!null column2:6!null column3:7!null arbiter_u2_distinct:17
      │         ├── grouping columns: column2:6!null arbiter_u2_distinct:17
      │         ├── project
      │         │    ├── columns: arbiter_u2_distinct:17 column1:5!null column2:6!null column3:7!null
      │         │    ├── project
      │         │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │    └── upsert-distinct-on
      │         │    │         ├── columns: column1:5!null column2:6!null column3:7!null arbiter_secondary_distinct:16
      │         │    │         ├── grouping columns: column2:6!null arbiter_secondary_distinct:16
      │         │    │         ├── project
      │         │    │         │    ├── columns: arbiter_secondary_distinct:16 column1:5!null column2:6!null column3:7!null
      │         │    │         │    ├── anti-join (hash)
      │         │    │         │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │         │    │    ├── anti-join (hash)
      │         │    │         │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │         │    │    │    ├── values
      │         │    │         │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │         │    │         │    │    │    │    └── (1, 1, 'bar')
      │         │    │         │    │    │    ├── select
      │         │    │         │    │    │    │    ├── columns: a:8!null b:9 c:10!null
      │         │    │         │    │    │    │    ├── scan uniq
      │         │    │         │    │    │    │    │    ├── columns: a:8!null b:9 c:10
      │         │    │         │    │    │    │    │    └── partial index predicates
      │         │    │         │    │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │    │         │    └── c:10 = 'foo'
      │         │    │         │    │    │    │    │         └── u2: filters
      │         │    │         │    │    │    │    │              └── c:10 = 'bar'
      │         │    │         │    │    │    │    └── filters
      │         │    │         │    │    │    │         └── c:10 = 'foo'
      │         │    │         │    │    │    └── filters
      │         │    │         │    │    │         ├── column2:6 = b:9
      │         │    │         │    │    │         └── column3:7 = 'foo'
      │         │    │         │    │    ├── select
      │         │    │         │    │    │    ├── columns: a:12!null b:13 c:14!null
      │         │    │         │    │    │    ├── scan uniq
      │         │    │         │    │    │    │    ├── columns: a:12!null b:13 c:14
      │         │    │         │    │    │    │    └── partial index predicates
      │         │    │         │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │         │    └── c:14 = 'foo'
      │         │    │         │    │    │    │         └── u2: filters
      │         │    │         │    │    │    │              └── c:14 = 'bar'
      │         │    │         │    │    │    └── filters
      │         │    │         │    │    │         └── c:14 = 'bar'
      │         │    │         │    │    └── filters
      │         │    │         │    │         ├── column2:6 = b:13
      │         │    │         │    │         └── column3:7 = 'bar'
      │         │    │         │    └── projections
      │         │    │         │         └── (column3:7 = 'foo') OR NULL::BOOL [as=arbiter_secondary_distinct:16]
      │         │    │         └── aggregations
      │         │    │              ├── first-agg [as=column1:5]
      │         │    │              │    └── column1:5
      │         │    │              └── first-agg [as=column3:7]
      │         │    │                   └── column3:7
      │         │    └── projections
      │         │         └── (column3:7 = 'bar') OR NULL::BOOL [as=arbiter_u2_distinct:17]
      │         └── aggregations
      │              ├── first-agg [as=column1:5]
      │              │    └── column1:5
      │              └── first-agg [as=column3:7]
      │                   └── column3:7
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:18]
           └── column3:7 = 'bar' [as=partial_index_put2:19]

# Error when no arbiter is found because the arbiter predicate in the query
# (non-existent in this case) does not imply any unique partial index predicates
# on the conflict column. Note that we use the "norm" directive instead of
# "build" to ensure that partial index predicates are fully normalized when
# choosing arbiter indexes.
norm
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) DO NOTHING
----
error (42P10): there is no unique or exclusion constraint matching the ON CONFLICT specification

exec-ddl
CREATE UNIQUE INDEX u3 ON uniq (b)
----

# If there is a non-partial unique index, then it is the only arbiter.
build
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE c = 'foo' AND c = 'bar' DO NOTHING
----
insert uniq
 ├── columns: <none>
 ├── arbiter indexes: u3
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:12 partial_index_put2:13
 └── project
      ├── columns: partial_index_put1:12!null partial_index_put2:13!null column1:5!null column2:6!null column3:7!null
      ├── upsert-distinct-on
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    ├── grouping columns: column2:6!null
      │    ├── anti-join (hash)
      │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    ├── values
      │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    └── (1, 1, 'bar')
      │    │    ├── scan uniq
      │    │    │    ├── columns: a:8!null b:9 c:10
      │    │    │    └── partial index predicates
      │    │    │         ├── secondary: filters
      │    │    │         │    └── c:10 = 'foo'
      │    │    │         └── u2: filters
      │    │    │              └── c:10 = 'bar'
      │    │    └── filters
      │    │         └── column2:6 = b:9
      │    └── aggregations
      │         ├── first-agg [as=column1:5]
      │         │    └── column1:5
      │         └── first-agg [as=column3:7]
      │              └── column3:7
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:12]
           └── column3:7 = 'bar' [as=partial_index_put2:13]

exec-ddl
DROP INDEX u3
----

exec-ddl
CREATE UNIQUE INDEX u4 ON uniq (b) WHERE 1 = 1
----

# If there is a pseudo-partial unique index, then it is the only arbiter. Note
# that the "opt" test directive is used here rather than "build". This is
# because "build" disables optimization like constant-folding. This causes the
# predicate of the pseudo-partial index, (1 = 1), to not fold to an empty
# FiltersExpr (which is equivalent to true). The mutationBuilder.arbiterIndexes
# function therefore cannot detect that the index is pseudo-partial. The "opt"
# directive does not disable optimizations, resulting in more accurate
# representation of real-world behavior and allowing the output of this test to
# reflect that the pseudo-partial index is the only arbiter.
opt
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE c = 'foo' AND c = 'bar' DO NOTHING
----
insert uniq
 ├── columns: <none>
 ├── arbiter indexes: u4
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── partial index put columns: partial_index_put1:13 partial_index_put2:14 partial_index_put3:15
 └── project
      ├── columns: partial_index_put1:13!null partial_index_put2:14!null partial_index_put3:15!null column1:5!null column2:6!null column3:7!null
      ├── anti-join (cross)
      │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    ├── values
      │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    └── (1, 1, 'bar')
      │    ├── select
      │    │    ├── columns: b:9!null
      │    │    ├── scan uniq@u4,partial
      │    │    │    └── columns: b:9
      │    │    └── filters
      │    │         └── b:9 = 1
      │    └── filters (true)
      └── projections
           ├── column3:7 = 'foo' [as=partial_index_put1:13]
           ├── column3:7 = 'bar' [as=partial_index_put2:14]
           └── true [as=partial_index_put3:15]

exec-ddl
DROP INDEX u4
----

# Error when two arbiter indexes are found for ON CONFLICT DO UPDATE.
build
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE c = 'foo' AND c = 'bar' DO UPDATE SET b = 10
----
error (0A000): unimplemented: there are multiple unique or exclusion constraints matching the ON CONFLICT specification

build
INSERT INTO uniq VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE c = 'foo' DO UPDATE SET b = 10
----
upsert uniq
 ├── columns: <none>
 ├── arbiter indexes: secondary
 ├── canary column: a:9
 ├── fetch columns: a:9 b:10 c:11
 ├── insert-mapping:
 │    ├── column1:5 => a:1
 │    ├── column2:6 => b:2
 │    └── column3:7 => c:3
 ├── update-mapping:
 │    └── upsert_b:15 => b:2
 ├── partial index put columns: partial_index_put1:17 partial_index_put2:19
 ├── partial index del columns: partial_index_del1:18 partial_index_del2:20
 └── project
      ├── columns: partial_index_put1:17 partial_index_del1:18 partial_index_put2:19 partial_index_del2:20 column1:5!null column2:6!null column3:7!null a:9 b:10 c:11 crdb_internal_mvcc_timestamp:12 b_new:13!null upsert_a:14 upsert_b:15!null upsert_c:16
      ├── project
      │    ├── columns: upsert_a:14 upsert_b:15!null upsert_c:16 column1:5!null column2:6!null column3:7!null a:9 b:10 c:11 crdb_internal_mvcc_timestamp:12 b_new:13!null
      │    ├── project
      │    │    ├── columns: b_new:13!null column1:5!null column2:6!null column3:7!null a:9 b:10 c:11 crdb_internal_mvcc_timestamp:12
      │    │    ├── left-join (hash)
      │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null a:9 b:10 c:11 crdb_internal_mvcc_timestamp:12
      │    │    │    ├── project
      │    │    │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │    └── ensure-upsert-distinct-on
      │    │    │    │         ├── columns: column1:5!null column2:6!null column3:7!null arbiter_secondary_distinct:8
      │    │    │    │         ├── grouping columns: column2:6!null arbiter_secondary_distinct:8
      │    │    │    │         ├── project
      │    │    │    │         │    ├── columns: arbiter_secondary_distinct:8 column1:5!null column2:6!null column3:7!null
      │    │    │    │         │    ├── values
      │    │    │    │         │    │    ├── columns: column1:5!null column2:6!null column3:7!null
      │    │    │    │         │    │    └── (1, 1, 'bar')
      │    │    │    │         │    └── projections
      │    │    │    │         │         └── (column3:7 = 'foo') OR NULL::BOOL [as=arbiter_secondary_distinct:8]
      │    │    │    │         └── aggregations
      │    │    │    │              ├── first-agg [as=column1:5]
      │    │    │    │              │    └── column1:5
      │    │    │    │              └── first-agg [as=column3:7]
      │    │    │    │                   └── column3:7
      │    │    │    ├── select
      │    │    │    │    ├── columns: a:9!null b:10 c:11!null crdb_internal_mvcc_timestamp:12
      │    │    │    │    ├── scan uniq
      │    │    │    │    │    ├── columns: a:9!null b:10 c:11 crdb_internal_mvcc_timestamp:12
      │    │    │    │    │    └── partial index predicates
      │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │         │    └── c:11 = 'foo'
      │    │    │    │    │         └── u2: filters
      │    │    │    │    │              └── c:11 = 'bar'
      │    │    │    │    └── filters
      │    │    │    │         └── c:11 = 'foo'
      │    │    │    └── filters
      │    │    │         ├── column2:6 = b:10
      │    │    │         └── column3:7 = 'foo'
      │    │    └── projections
      │    │         └── 10 [as=b_new:13]
      │    └── projections
      │         ├── CASE WHEN a:9 IS NULL THEN column1:5 ELSE a:9 END [as=upsert_a:14]
      │         ├── CASE WHEN a:9 IS NULL THEN column2:6 ELSE b_new:13 END [as=upsert_b:15]
      │         └── CASE WHEN a:9 IS NULL THEN column3:7 ELSE c:11 END [as=upsert_c:16]
      └── projections
           ├── upsert_c:16 = 'foo' [as=partial_index_put1:17]
           ├── c:11 = 'foo' [as=partial_index_del1:18]
           ├── upsert_c:16 = 'bar' [as=partial_index_put2:19]
           └── c:11 = 'bar' [as=partial_index_del2:20]

# Do not error with "column reference is ambiguous" when table column names
# match synthesized column names.
build
INSERT INTO ambig VALUES (1, 2)
ON CONFLICT (partial_index_put1) WHERE partial_index_put1 > 0 AND partial_index_del1 > 0
DO UPDATE SET partial_index_put1 = 10, partial_index_del1 = 20
----
upsert ambig
 ├── columns: <none>
 ├── arbiter indexes: secondary
 ├── canary column: rowid:11
 ├── fetch columns: ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11
 ├── insert-mapping:
 │    ├── column1:5 => ambig.partial_index_put1:1
 │    ├── column2:6 => ambig.partial_index_del1:2
 │    └── column7:7 => rowid:3
 ├── update-mapping:
 │    ├── upsert_partial_index_put1:15 => ambig.partial_index_put1:1
 │    └── upsert_partial_index_del1:16 => ambig.partial_index_del1:2
 ├── partial index put columns: partial_index_put1:18 partial_index_put2:20
 ├── partial index del columns: partial_index_del1:19 partial_index_del2:21
 └── project
      ├── columns: partial_index_put1:18!null partial_index_del1:19 partial_index_put2:20!null partial_index_del2:21 column1:5!null column2:6!null column7:7 ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11 crdb_internal_mvcc_timestamp:12 partial_index_put1_new:13!null partial_index_del1_new:14!null upsert_partial_index_put1:15!null upsert_partial_index_del1:16!null upsert_rowid:17
      ├── project
      │    ├── columns: upsert_partial_index_put1:15!null upsert_partial_index_del1:16!null upsert_rowid:17 column1:5!null column2:6!null column7:7 ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11 crdb_internal_mvcc_timestamp:12 partial_index_put1_new:13!null partial_index_del1_new:14!null
      │    ├── project
      │    │    ├── columns: partial_index_put1_new:13!null partial_index_del1_new:14!null column1:5!null column2:6!null column7:7 ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11 crdb_internal_mvcc_timestamp:12
      │    │    ├── left-join (hash)
      │    │    │    ├── columns: column1:5!null column2:6!null column7:7 ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11 crdb_internal_mvcc_timestamp:12
      │    │    │    ├── project
      │    │    │    │    ├── columns: column1:5!null column2:6!null column7:7
      │    │    │    │    └── ensure-upsert-distinct-on
      │    │    │    │         ├── columns: column1:5!null column2:6!null column7:7 arbiter_secondary_distinct:8
      │    │    │    │         ├── grouping columns: column1:5!null arbiter_secondary_distinct:8
      │    │    │    │         ├── project
      │    │    │    │         │    ├── columns: arbiter_secondary_distinct:8 column1:5!null column2:6!null column7:7
      │    │    │    │         │    ├── project
      │    │    │    │         │    │    ├── columns: column7:7 column1:5!null column2:6!null
      │    │    │    │         │    │    ├── values
      │    │    │    │         │    │    │    ├── columns: column1:5!null column2:6!null
      │    │    │    │         │    │    │    └── (1, 2)
      │    │    │    │         │    │    └── projections
      │    │    │    │         │    │         └── unique_rowid() [as=column7:7]
      │    │    │    │         │    └── projections
      │    │    │    │         │         └── (column1:5 > 0) OR NULL::BOOL [as=arbiter_secondary_distinct:8]
      │    │    │    │         └── aggregations
      │    │    │    │              ├── first-agg [as=column2:6]
      │    │    │    │              │    └── column2:6
      │    │    │    │              └── first-agg [as=column7:7]
      │    │    │    │                   └── column7:7
      │    │    │    ├── select
      │    │    │    │    ├── columns: ambig.partial_index_put1:9!null ambig.partial_index_del1:10 rowid:11!null crdb_internal_mvcc_timestamp:12
      │    │    │    │    ├── scan ambig
      │    │    │    │    │    ├── columns: ambig.partial_index_put1:9 ambig.partial_index_del1:10 rowid:11!null crdb_internal_mvcc_timestamp:12
      │    │    │    │    │    └── partial index predicates
      │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │         │    └── ambig.partial_index_put1:9 > 0
      │    │    │    │    │         └── secondary: filters
      │    │    │    │    │              └── ambig.partial_index_del1:10 > 0
      │    │    │    │    └── filters
      │    │    │    │         └── ambig.partial_index_put1:9 > 0
      │    │    │    └── filters
      │    │    │         ├── column1:5 = ambig.partial_index_put1:9
      │    │    │         └── column1:5 > 0
      │    │    └── projections
      │    │         ├── 10 [as=partial_index_put1_new:13]
      │    │         └── 20 [as=partial_index_del1_new:14]
      │    └── projections
      │         ├── CASE WHEN rowid:11 IS NULL THEN column1:5 ELSE partial_index_put1_new:13 END [as=upsert_partial_index_put1:15]
      │         ├── CASE WHEN rowid:11 IS NULL THEN column2:6 ELSE partial_index_del1_new:14 END [as=upsert_partial_index_del1:16]
      │         └── CASE WHEN rowid:11 IS NULL THEN column7:7 ELSE rowid:11 END [as=upsert_rowid:17]
      └── projections
           ├── upsert_partial_index_put1:15 > 0 [as=partial_index_put1:18]
           ├── ambig.partial_index_put1:9 > 0 [as=partial_index_del1:19]
           ├── upsert_partial_index_del1:16 > 0 [as=partial_index_put2:20]
           └── ambig.partial_index_del1:10 > 0 [as=partial_index_del2:21]

exec-ddl
CREATE UNIQUE INDEX u1 ON comp (b) WHERE d = 'foo'
----

build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT DO NOTHING
----
insert comp
 ├── columns: <none>
 ├── arbiter indexes: primary u1
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:25 partial_index_put2:26 partial_index_put1:25
 └── project
      ├── columns: partial_index_put1:25 partial_index_put2:26 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      ├── project
      │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    └── upsert-distinct-on
      │         ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 arbiter_u1_distinct:24
      │         ├── grouping columns: column2:8!null arbiter_u1_distinct:24
      │         ├── project
      │         │    ├── columns: arbiter_u1_distinct:24 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    ├── upsert-distinct-on
      │         │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │    ├── grouping columns: column1:7!null
      │         │    │    ├── anti-join (hash)
      │         │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │    │    ├── anti-join (hash)
      │         │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │    │    │    ├── project
      │         │    │    │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │         │    │    │    │    │    ├── values
      │         │    │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │         │    │    │    │    │    │    └── (1, 1, 'bar')
      │         │    │    │    │    │    └── projections
      │         │    │    │    │    │         ├── lower(column3:9) [as=column10:10]
      │         │    │    │    │    │         └── upper(column3:9) [as=column11:11]
      │         │    │    │    │    ├── project
      │         │    │    │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16
      │         │    │    │    │    │    ├── scan comp
      │         │    │    │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16
      │         │    │    │    │    │    │    ├── computed column expressions
      │         │    │    │    │    │    │    │    ├── d:15
      │         │    │    │    │    │    │    │    │    └── lower(c:14)
      │         │    │    │    │    │    │    │    └── e:16
      │         │    │    │    │    │    │    │         └── upper(c:14)
      │         │    │    │    │    │    │    └── partial index predicates
      │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │    │    │    │    │         │    └── lower(c:14) = 'foo'
      │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │    │    │    │    │         │    └── e:16 = 'FOO'
      │         │    │    │    │    │    │         └── u1: filters
      │         │    │    │    │    │    │              └── lower(c:14) = 'foo'
      │         │    │    │    │    │    └── projections
      │         │    │    │    │    │         └── lower(c:14) [as=d:15]
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── column1:7 = a:12
      │         │    │    │    ├── select
      │         │    │    │    │    ├── columns: a:18!null b:19 c:20 d:21!null e:22
      │         │    │    │    │    ├── project
      │         │    │    │    │    │    ├── columns: d:21 a:18!null b:19 c:20 e:22
      │         │    │    │    │    │    ├── scan comp
      │         │    │    │    │    │    │    ├── columns: a:18!null b:19 c:20 e:22
      │         │    │    │    │    │    │    ├── computed column expressions
      │         │    │    │    │    │    │    │    ├── d:21
      │         │    │    │    │    │    │    │    │    └── lower(c:20)
      │         │    │    │    │    │    │    │    └── e:22
      │         │    │    │    │    │    │    │         └── upper(c:20)
      │         │    │    │    │    │    │    └── partial index predicates
      │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │    │    │    │    │         │    └── lower(c:20) = 'foo'
      │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │    │    │    │    │         │    └── e:22 = 'FOO'
      │         │    │    │    │    │    │         └── u1: filters
      │         │    │    │    │    │    │              └── lower(c:20) = 'foo'
      │         │    │    │    │    │    └── projections
      │         │    │    │    │    │         └── lower(c:20) [as=d:21]
      │         │    │    │    │    └── filters
      │         │    │    │    │         └── d:21 = 'foo'
      │         │    │    │    └── filters
      │         │    │    │         ├── column2:8 = b:19
      │         │    │    │         └── column10:10 = 'foo'
      │         │    │    └── aggregations
      │         │    │         ├── first-agg [as=column2:8]
      │         │    │         │    └── column2:8
      │         │    │         ├── first-agg [as=column3:9]
      │         │    │         │    └── column3:9
      │         │    │         ├── first-agg [as=column10:10]
      │         │    │         │    └── column10:10
      │         │    │         └── first-agg [as=column11:11]
      │         │    │              └── column11:11
      │         │    └── projections
      │         │         └── (column10:10 = 'foo') OR NULL::BOOL [as=arbiter_u1_distinct:24]
      │         └── aggregations
      │              ├── first-agg [as=column1:7]
      │              │    └── column1:7
      │              ├── first-agg [as=column3:9]
      │              │    └── column3:9
      │              ├── first-agg [as=column10:10]
      │              │    └── column10:10
      │              └── first-agg [as=column11:11]
      │                   └── column11:11
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:25]
           └── column11:11 = 'FOO' [as=partial_index_put2:26]

exec-ddl
CREATE UNIQUE INDEX u2 ON comp (b) WHERE e = 'bar'
----

# Build scans for both partial indexes with virtual column references in the
# predicate when the arbiter predicate implies them.
build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE d = 'foo' AND e = 'bar' DO NOTHING
----
insert comp
 ├── columns: <none>
 ├── arbiter indexes: u1 u2
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:26 partial_index_put2:27 partial_index_put1:26 partial_index_put4:28
 └── project
      ├── columns: partial_index_put1:26 partial_index_put2:27 partial_index_put4:28 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      ├── project
      │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    └── upsert-distinct-on
      │         ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 arbiter_u2_distinct:25
      │         ├── grouping columns: column2:8!null arbiter_u2_distinct:25
      │         ├── project
      │         │    ├── columns: arbiter_u2_distinct:25 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    ├── project
      │         │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │    └── upsert-distinct-on
      │         │    │         ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 arbiter_u1_distinct:24
      │         │    │         ├── grouping columns: column2:8!null arbiter_u1_distinct:24
      │         │    │         ├── project
      │         │    │         │    ├── columns: arbiter_u1_distinct:24 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │         │    ├── anti-join (hash)
      │         │    │         │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │         │    │    ├── anti-join (hash)
      │         │    │         │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │         │    │         │    │    │    ├── project
      │         │    │         │    │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │         │    │         │    │    │    │    ├── values
      │         │    │         │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │         │    │         │    │    │    │    │    └── (1, 1, 'bar')
      │         │    │         │    │    │    │    └── projections
      │         │    │         │    │    │    │         ├── lower(column3:9) [as=column10:10]
      │         │    │         │    │    │    │         └── upper(column3:9) [as=column11:11]
      │         │    │         │    │    │    ├── select
      │         │    │         │    │    │    │    ├── columns: a:12!null b:13 c:14 d:15!null e:16
      │         │    │         │    │    │    │    ├── project
      │         │    │         │    │    │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16
      │         │    │         │    │    │    │    │    ├── scan comp
      │         │    │         │    │    │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16
      │         │    │         │    │    │    │    │    │    ├── computed column expressions
      │         │    │         │    │    │    │    │    │    │    ├── d:15
      │         │    │         │    │    │    │    │    │    │    │    └── lower(c:14)
      │         │    │         │    │    │    │    │    │    │    └── e:16
      │         │    │         │    │    │    │    │    │    │         └── upper(c:14)
      │         │    │         │    │    │    │    │    │    └── partial index predicates
      │         │    │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │    │    │         │    └── lower(c:14) = 'foo'
      │         │    │         │    │    │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │    │    │         │    └── e:16 = 'FOO'
      │         │    │         │    │    │    │    │    │         ├── u1: filters
      │         │    │         │    │    │    │    │    │         │    └── lower(c:14) = 'foo'
      │         │    │         │    │    │    │    │    │         └── u2: filters
      │         │    │         │    │    │    │    │    │              └── e:16 = 'bar'
      │         │    │         │    │    │    │    │    └── projections
      │         │    │         │    │    │    │    │         └── lower(c:14) [as=d:15]
      │         │    │         │    │    │    │    └── filters
      │         │    │         │    │    │    │         └── d:15 = 'foo'
      │         │    │         │    │    │    └── filters
      │         │    │         │    │    │         ├── column2:8 = b:13
      │         │    │         │    │    │         └── column10:10 = 'foo'
      │         │    │         │    │    ├── select
      │         │    │         │    │    │    ├── columns: a:18!null b:19 c:20 d:21 e:22!null
      │         │    │         │    │    │    ├── project
      │         │    │         │    │    │    │    ├── columns: d:21 a:18!null b:19 c:20 e:22
      │         │    │         │    │    │    │    ├── scan comp
      │         │    │         │    │    │    │    │    ├── columns: a:18!null b:19 c:20 e:22
      │         │    │         │    │    │    │    │    ├── computed column expressions
      │         │    │         │    │    │    │    │    │    ├── d:21
      │         │    │         │    │    │    │    │    │    │    └── lower(c:20)
      │         │    │         │    │    │    │    │    │    └── e:22
      │         │    │         │    │    │    │    │    │         └── upper(c:20)
      │         │    │         │    │    │    │    │    └── partial index predicates
      │         │    │         │    │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │    │         │    └── lower(c:20) = 'foo'
      │         │    │         │    │    │    │    │         ├── secondary: filters
      │         │    │         │    │    │    │    │         │    └── e:22 = 'FOO'
      │         │    │         │    │    │    │    │         ├── u1: filters
      │         │    │         │    │    │    │    │         │    └── lower(c:20) = 'foo'
      │         │    │         │    │    │    │    │         └── u2: filters
      │         │    │         │    │    │    │    │              └── e:22 = 'bar'
      │         │    │         │    │    │    │    └── projections
      │         │    │         │    │    │    │         └── lower(c:20) [as=d:21]
      │         │    │         │    │    │    └── filters
      │         │    │         │    │    │         └── e:22 = 'bar'
      │         │    │         │    │    └── filters
      │         │    │         │    │         ├── column2:8 = b:19
      │         │    │         │    │         └── column11:11 = 'bar'
      │         │    │         │    └── projections
      │         │    │         │         └── (column10:10 = 'foo') OR NULL::BOOL [as=arbiter_u1_distinct:24]
      │         │    │         └── aggregations
      │         │    │              ├── first-agg [as=column1:7]
      │         │    │              │    └── column1:7
      │         │    │              ├── first-agg [as=column3:9]
      │         │    │              │    └── column3:9
      │         │    │              ├── first-agg [as=column10:10]
      │         │    │              │    └── column10:10
      │         │    │              └── first-agg [as=column11:11]
      │         │    │                   └── column11:11
      │         │    └── projections
      │         │         └── (column11:11 = 'bar') OR NULL::BOOL [as=arbiter_u2_distinct:25]
      │         └── aggregations
      │              ├── first-agg [as=column1:7]
      │              │    └── column1:7
      │              ├── first-agg [as=column3:9]
      │              │    └── column3:9
      │              ├── first-agg [as=column10:10]
      │              │    └── column10:10
      │              └── first-agg [as=column11:11]
      │                   └── column11:11
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:26]
           ├── column11:11 = 'FOO' [as=partial_index_put2:27]
           └── column11:11 = 'bar' [as=partial_index_put4:28]

# Error when no arbiter is found because the arbiter predicate in the query
# (non-existent in this case) does not imply any unique partial index predicates
# on the conflict column.  Note that we use the "norm" directive instead of
# "build" to ensure that partial index predicates are fully normalized when
# choosing arbiter indexes.
build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT (b) DO NOTHING
----
error (42P10): there is no unique or exclusion constraint matching the ON CONFLICT specification

exec-ddl
CREATE UNIQUE INDEX u3 ON comp (b)
----

# If there is a non-partial unique index, then it is the only arbiter.
build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE d = 'foo' AND e = 'bar' DO NOTHING
----
insert comp
 ├── columns: <none>
 ├── arbiter indexes: u3
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── partial index put columns: partial_index_put1:18 partial_index_put2:19 partial_index_put1:18 partial_index_put4:20
 └── project
      ├── columns: partial_index_put1:18 partial_index_put2:19 partial_index_put4:20 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      ├── upsert-distinct-on
      │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    ├── grouping columns: column2:8!null
      │    ├── anti-join (hash)
      │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    ├── project
      │    │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    │    │    ├── values
      │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    │    │    └── (1, 1, 'bar')
      │    │    │    └── projections
      │    │    │         ├── lower(column3:9) [as=column10:10]
      │    │    │         └── upper(column3:9) [as=column11:11]
      │    │    ├── project
      │    │    │    ├── columns: d:15 a:12!null b:13 c:14 e:16
      │    │    │    ├── scan comp
      │    │    │    │    ├── columns: a:12!null b:13 c:14 e:16
      │    │    │    │    ├── computed column expressions
      │    │    │    │    │    ├── d:15
      │    │    │    │    │    │    └── lower(c:14)
      │    │    │    │    │    └── e:16
      │    │    │    │    │         └── upper(c:14)
      │    │    │    │    └── partial index predicates
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── lower(c:14) = 'foo'
      │    │    │    │         ├── secondary: filters
      │    │    │    │         │    └── e:16 = 'FOO'
      │    │    │    │         ├── u1: filters
      │    │    │    │         │    └── lower(c:14) = 'foo'
      │    │    │    │         └── u2: filters
      │    │    │    │              └── e:16 = 'bar'
      │    │    │    └── projections
      │    │    │         └── lower(c:14) [as=d:15]
      │    │    └── filters
      │    │         └── column2:8 = b:13
      │    └── aggregations
      │         ├── first-agg [as=column1:7]
      │         │    └── column1:7
      │         ├── first-agg [as=column3:9]
      │         │    └── column3:9
      │         ├── first-agg [as=column10:10]
      │         │    └── column10:10
      │         └── first-agg [as=column11:11]
      │              └── column11:11
      └── projections
           ├── column10:10 = 'foo' [as=partial_index_put1:18]
           ├── column11:11 = 'FOO' [as=partial_index_put2:19]
           └── column11:11 = 'bar' [as=partial_index_put4:20]

exec-ddl
DROP INDEX u3
----

# Error when two arbiter indexes are found for ON CONFLICT DO UPDATE.
build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE d = 'foo' AND e = 'bar' DO UPDATE SET b = 10
----
error (0A000): unimplemented: there are multiple unique or exclusion constraints matching the ON CONFLICT specification

build
INSERT INTO comp VALUES (1, 1, 'bar') ON CONFLICT (b) WHERE d = 'foo' DO UPDATE SET b = 10
----
upsert comp
 ├── columns: <none>
 ├── arbiter indexes: u1
 ├── canary column: a:13
 ├── fetch columns: a:13 b:14 c:15 d:16 e:17
 ├── insert-mapping:
 │    ├── column1:7 => a:1
 │    ├── column2:8 => b:2
 │    ├── column3:9 => c:3
 │    ├── column10:10 => d:4
 │    └── column11:11 => e:5
 ├── update-mapping:
 │    └── upsert_b:23 => b:2
 ├── partial index put columns: partial_index_put1:27 partial_index_put2:29 partial_index_put1:27 partial_index_put4:31
 ├── partial index del columns: partial_index_del1:28 partial_index_del2:30 partial_index_del1:28 partial_index_del4:32
 └── project
      ├── columns: partial_index_put1:27 partial_index_del1:28 partial_index_put2:29 partial_index_del2:30 partial_index_put4:31 partial_index_del4:32 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:13 b:14 c:15 d:16 e:17 crdb_internal_mvcc_timestamp:18 b_new:19!null column20:20 column21:21 upsert_a:22 upsert_b:23!null upsert_c:24 upsert_d:25 upsert_e:26
      ├── project
      │    ├── columns: upsert_a:22 upsert_b:23!null upsert_c:24 upsert_d:25 upsert_e:26 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:13 b:14 c:15 d:16 e:17 crdb_internal_mvcc_timestamp:18 b_new:19!null column20:20 column21:21
      │    ├── project
      │    │    ├── columns: column20:20 column21:21 column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:13 b:14 c:15 d:16 e:17 crdb_internal_mvcc_timestamp:18 b_new:19!null
      │    │    ├── project
      │    │    │    ├── columns: b_new:19!null column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:13 b:14 c:15 d:16 e:17 crdb_internal_mvcc_timestamp:18
      │    │    │    ├── left-join (hash)
      │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 a:13 b:14 c:15 d:16 e:17 crdb_internal_mvcc_timestamp:18
      │    │    │    │    ├── project
      │    │    │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    │    │    │    └── ensure-upsert-distinct-on
      │    │    │    │    │         ├── columns: column1:7!null column2:8!null column3:9!null column10:10 column11:11 arbiter_u1_distinct:12
      │    │    │    │    │         ├── grouping columns: column2:8!null arbiter_u1_distinct:12
      │    │    │    │    │         ├── project
      │    │    │    │    │         │    ├── columns: arbiter_u1_distinct:12 column1:7!null column2:8!null column3:9!null column10:10 column11:11
      │    │    │    │    │         │    ├── project
      │    │    │    │    │         │    │    ├── columns: column10:10 column11:11 column1:7!null column2:8!null column3:9!null
      │    │    │    │    │         │    │    ├── values
      │    │    │    │    │         │    │    │    ├── columns: column1:7!null column2:8!null column3:9!null
      │    │    │    │    │         │    │    │    └── (1, 1, 'bar')
      │    │    │    │    │         │    │    └── projections
      │    │    │    │    │         │    │         ├── lower(column3:9) [as=column10:10]
      │    │    │    │    │         │    │         └── upper(column3:9) [as=column11:11]
      │    │    │    │    │         │    └── projections
      │    │    │    │    │         │         └── (column10:10 = 'foo') OR NULL::BOOL [as=arbiter_u1_distinct:12]
      │    │    │    │    │         └── aggregations
      │    │    │    │    │              ├── first-agg [as=column1:7]
      │    │    │    │    │              │    └── column1:7
      │    │    │    │    │              ├── first-agg [as=column3:9]
      │    │    │    │    │              │    └── column3:9
      │    │    │    │    │              ├── first-agg [as=column10:10]
      │    │    │    │    │              │    └── column10:10
      │    │    │    │    │              └── first-agg [as=column11:11]
      │    │    │    │    │                   └── column11:11
      │    │    │    │    ├── select
      │    │    │    │    │    ├── columns: a:13!null b:14 c:15 d:16!null e:17 crdb_internal_mvcc_timestamp:18
      │    │    │    │    │    ├── project
      │    │    │    │    │    │    ├── columns: d:16 a:13!null b:14 c:15 e:17 crdb_internal_mvcc_timestamp:18
      │    │    │    │    │    │    ├── scan comp
      │    │    │    │    │    │    │    ├── columns: a:13!null b:14 c:15 e:17 crdb_internal_mvcc_timestamp:18
      │    │    │    │    │    │    │    ├── computed column expressions
      │    │    │    │    │    │    │    │    ├── d:16
      │    │    │    │    │    │    │    │    │    └── lower(c:15)
      │    │    │    │    │    │    │    │    └── e:17
      │    │    │    │    │    │    │    │         └── upper(c:15)
      │    │    │    │    │    │    │    └── partial index predicates
      │    │    │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │    │    │         │    └── lower(c:15) = 'foo'
      │    │    │    │    │    │    │         ├── secondary: filters
      │    │    │    │    │    │    │         │    └── e:17 = 'FOO'
      │    │    │    │    │    │    │         ├── u1: filters
      │    │    │    │    │    │    │         │    └── lower(c:15) = 'foo'
      │    │    │    │    │    │    │         └── u2: filters
      │    │    │    │    │    │    │              └── e:17 = 'bar'
      │    │    │    │    │    │    └── projections
      │    │    │    │    │    │         └── lower(c:15) [as=d:16]
      │    │    │    │    │    └── filters
      │    │    │    │    │         └── d:16 = 'foo'
      │    │    │    │    └── filters
      │    │    │    │         ├── column2:8 = b:14
      │    │    │    │         └── column10:10 = 'foo'
      │    │    │    └── projections
      │    │    │         └── 10 [as=b_new:19]
      │    │    └── projections
      │    │         ├── lower(c:15) [as=column20:20]
      │    │         └── upper(c:15) [as=column21:21]
      │    └── projections
      │         ├── CASE WHEN a:13 IS NULL THEN column1:7 ELSE a:13 END [as=upsert_a:22]
      │         ├── CASE WHEN a:13 IS NULL THEN column2:8 ELSE b_new:19 END [as=upsert_b:23]
      │         ├── CASE WHEN a:13 IS NULL THEN column3:9 ELSE c:15 END [as=upsert_c:24]
      │         ├── CASE WHEN a:13 IS NULL THEN column10:10 ELSE d:16 END [as=upsert_d:25]
      │         └── CASE WHEN a:13 IS NULL THEN column11:11 ELSE e:17 END [as=upsert_e:26]
      └── projections
           ├── upsert_d:25 = 'foo' [as=partial_index_put1:27]
           ├── d:16 = 'foo' [as=partial_index_del1:28]
           ├── upsert_e:26 = 'FOO' [as=partial_index_put2:29]
           ├── e:17 = 'FOO' [as=partial_index_del2:30]
           ├── upsert_e:26 = 'bar' [as=partial_index_put4:31]
           └── e:17 = 'bar' [as=partial_index_del4:32]
