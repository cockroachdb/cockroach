exec-ddl
CREATE TABLE xy (x INT, y INT);
----

exec-ddl
CREATE TABLE kv (k INT PRIMARY KEY, v INT);
----

exec-ddl
CREATE TABLE txn_timestamps (ts TIMESTAMP);
----

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  BEGIN
    RETURN a;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:2
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:2]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_return_1:1
                     ├── project
                     │    ├── columns: stmt_return_1:1
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── f.a:$1 [as=stmt_return_1:1]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  BEGIN
    RETURN a + b;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:2
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:2]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_return_1:1
                     ├── project
                     │    ├── columns: stmt_return_1:1
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── plus [as=stmt_return_1:1]
                     │              ├── f.a:$1
                     │              └── f.b:$2
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:3
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:3]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_return_1:2
                     ├── project
                     │    ├── columns: stmt_return_1:2
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── variable: c:1 [as=stmt_return_1:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT := 0;
  BEGIN
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:3
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:3]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_return_1:2!null
                     ├── project
                     │    ├── columns: stmt_return_1:2!null
                     │    ├── project
                     │    │    ├── columns: c:1!null
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── const: 0 [as=c:1]
                     │    └── projections
                     │         └── variable: c:1 [as=stmt_return_1:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    c := 0;
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_return_1:3!null
                     ├── project
                     │    ├── columns: stmt_return_1:3!null
                     │    ├── project
                     │    │    ├── columns: c:2!null
                     │    │    ├── project
                     │    │    │    ├── columns: c:1
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── cast: INT8 [as=c:1]
                     │    │    │              └── null
                     │    │    └── projections
                     │    │         └── const: 0 [as=c:2]
                     │    └── projections
                     │         └── variable: c:2 [as=stmt_return_1:3]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    IF a < b THEN
      c := a;
    END IF;
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:7
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:7]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_if_3:6
                     ├── project
                     │    ├── columns: stmt_if_3:6
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── case [as=stmt_if_3:6]
                     │              ├── true
                     │              ├── when
                     │              │    ├── lt
                     │              │    │    ├── f.a:$1
                     │              │    │    └── f.b:$2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_if_1:4
                     │              │              ├── project
                     │              │              │    ├── columns: c:3
                     │              │              │    ├── values
                     │              │              │    │    └── tuple
                     │              │              │    └── projections
                     │              │              │         └── f.a:$1 [as=c:3]
                     │              │              └── projections
                     │              │                   └── udf: stmt_if_1 [as=stmt_if_1:4]
                     │              │                        ├── tail-call
                     │              │                        ├── args
                     │              │                        │    ├── $1: f.a:$1
                     │              │                        │    └── $2: variable: c:3
                     │              │                        └── body
                     │              │                             └── project
                     │              │                                  ├── columns: stmt_return_2:2
                     │              │                                  ├── values
                     │              │                                  │    └── tuple
                     │              │                                  └── projections
                     │              │                                       └── stmt_if.c:$2 [as=stmt_return_2:2]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_if_1:5
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:5]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: f.a:$1
                     │                                  │    └── $2: variable: c:1
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_2:2
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── stmt_if.c:$2 [as=stmt_return_2:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    IF a < b THEN
      c := a;
    ELSE
      c := b;
    END IF;
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:8
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:8]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_if_3:7
                     ├── project
                     │    ├── columns: stmt_if_3:7
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── case [as=stmt_if_3:7]
                     │              ├── true
                     │              ├── when
                     │              │    ├── lt
                     │              │    │    ├── f.a:$1
                     │              │    │    └── f.b:$2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_if_1:4
                     │              │              ├── project
                     │              │              │    ├── columns: c:3
                     │              │              │    ├── values
                     │              │              │    │    └── tuple
                     │              │              │    └── projections
                     │              │              │         └── f.a:$1 [as=c:3]
                     │              │              └── projections
                     │              │                   └── udf: stmt_if_1 [as=stmt_if_1:4]
                     │              │                        ├── tail-call
                     │              │                        ├── args
                     │              │                        │    ├── $1: f.a:$1
                     │              │                        │    └── $2: variable: c:3
                     │              │                        └── body
                     │              │                             └── project
                     │              │                                  ├── columns: stmt_return_2:2
                     │              │                                  ├── values
                     │              │                                  │    └── tuple
                     │              │                                  └── projections
                     │              │                                       └── stmt_if.c:$2 [as=stmt_return_2:2]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_if_1:6
                     │                        ├── project
                     │                        │    ├── columns: c:5
                     │                        │    ├── values
                     │                        │    │    └── tuple
                     │                        │    └── projections
                     │                        │         └── f.b:$2 [as=c:5]
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:6]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: f.a:$1
                     │                                  │    └── $2: variable: c:5
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_2:2
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── stmt_if.c:$2 [as=stmt_return_2:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    IF a < b THEN
      c := a;
    ELSE
      RETURN 100;
    END IF;
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:7
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:7]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_if_4:6
                     ├── project
                     │    ├── columns: stmt_if_4:6
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── case [as=stmt_if_4:6]
                     │              ├── true
                     │              ├── when
                     │              │    ├── lt
                     │              │    │    ├── f.a:$1
                     │              │    │    └── f.b:$2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_if_1:4
                     │              │              ├── project
                     │              │              │    ├── columns: c:3
                     │              │              │    ├── values
                     │              │              │    │    └── tuple
                     │              │              │    └── projections
                     │              │              │         └── f.a:$1 [as=c:3]
                     │              │              └── projections
                     │              │                   └── udf: stmt_if_1 [as=stmt_if_1:4]
                     │              │                        ├── tail-call
                     │              │                        ├── args
                     │              │                        │    ├── $1: f.a:$1
                     │              │                        │    └── $2: variable: c:3
                     │              │                        └── body
                     │              │                             └── project
                     │              │                                  ├── columns: stmt_return_2:2
                     │              │                                  ├── values
                     │              │                                  │    └── tuple
                     │              │                                  └── projections
                     │              │                                       └── stmt_if.c:$2 [as=stmt_return_2:2]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_return_3:5!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 100 [as=stmt_return_3:5]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    IF a < b THEN
      RETURN 100;
    ELSE
      c := b;
    END IF;
    RETURN c;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:7
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:7]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_if_4:6
                     ├── project
                     │    ├── columns: stmt_if_4:6
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── case [as=stmt_if_4:6]
                     │              ├── true
                     │              ├── when
                     │              │    ├── lt
                     │              │    │    ├── f.a:$1
                     │              │    │    └── f.b:$2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_return_3:3!null
                     │              │              ├── values
                     │              │              │    └── tuple
                     │              │              └── projections
                     │              │                   └── const: 100 [as=stmt_return_3:3]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_if_1:5
                     │                        ├── project
                     │                        │    ├── columns: c:4
                     │                        │    ├── values
                     │                        │    │    └── tuple
                     │                        │    └── projections
                     │                        │         └── f.b:$2 [as=c:4]
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:5]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: f.a:$1
                     │                                  │    └── $2: variable: c:4
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_2:2
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── stmt_if.c:$2 [as=stmt_return_2:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    c INT;
  BEGIN
    IF a < b THEN
      RETURN 100;
    ELSE
      RETURN 0;
    END IF;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:8
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:8]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_if_7:7
                     ├── project
                     │    ├── columns: stmt_if_7:7
                     │    ├── project
                     │    │    ├── columns: c:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=c:1]
                     │    │              └── null
                     │    └── projections
                     │         └── case [as=stmt_if_7:7]
                     │              ├── true
                     │              ├── when
                     │              │    ├── lt
                     │              │    │    ├── f.a:$1
                     │              │    │    └── f.b:$2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_return_5:5!null
                     │              │              ├── values
                     │              │              │    └── tuple
                     │              │              └── projections
                     │              │                   └── const: 100 [as=stmt_return_5:5]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_return_6:6!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_6:6]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    i INT := a;
  BEGIN
    LOOP
      RETURN 100;
    END LOOP;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:7
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:7]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_loop_5:6
                     ├── project
                     │    ├── columns: stmt_loop_5:6
                     │    ├── project
                     │    │    ├── columns: i:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_5 [as=stmt_loop_5:6]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    └── $2: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_return_6:5!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 100 [as=stmt_return_6:5]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    i INT := a;
  BEGIN
    LOOP
      IF a < b THEN
        RETURN 0;
      END IF;
      RETURN 100;
    END LOOP;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:10
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:10]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_loop_5:9
                     ├── project
                     │    ├── columns: stmt_loop_5:9
                     │    ├── project
                     │    │    ├── columns: i:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_5 [as=stmt_loop_5:9]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    └── $2: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_9:8
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_9:8]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── lt
                     │                                  │    │    ├── stmt_loop.a:$0
                     │                                  │    │    └── stmt_loop.b:$1
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: stmt_return_8:6!null
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── const: 0 [as=stmt_return_8:6]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_6:7
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_6 [as=stmt_if_6:7]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.a:$0
                     │                                                      │    └── $2: stmt_loop.i:$2
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_return_7:5!null
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── const: 100 [as=stmt_return_7:5]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    i INT := a;
  BEGIN
    LOOP
      IF i >= b THEN EXIT; END IF;
      IF i = 8 THEN RETURN 100; END IF;
      i := i + 1;
    END LOOP;
    RETURN i;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 2);
----
project
 ├── columns: f:12
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:12]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 2
           └── body
                └── limit
                     ├── columns: stmt_loop_3:11
                     ├── project
                     │    ├── columns: stmt_loop_3:11
                     │    ├── project
                     │    │    ├── columns: i:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:11]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    └── $2: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_8:10
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_8:10]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$2
                     │                                  │    │    └── stmt_loop.b:$1
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:8
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:8]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.a:$0
                     │                                  │                        │    └── $2: stmt_loop.i:$2
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_return_2:2
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── loop_exit.i:$2 [as=stmt_return_2:2]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:9
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:9]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.a:$0
                     │                                                      │    └── $2: stmt_loop.i:$2
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_if_7:7
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── case [as=stmt_if_7:7]
                     │                                                                          ├── true
                     │                                                                          ├── when
                     │                                                                          │    ├── eq
                     │                                                                          │    │    ├── stmt_if.i:$2
                     │                                                                          │    │    └── const: 8
                     │                                                                          │    └── subquery
                     │                                                                          │         ├── tail-call
                     │                                                                          │         └── project
                     │                                                                          │              ├── columns: stmt_return_6:5!null
                     │                                                                          │              ├── values
                     │                                                                          │              │    └── tuple
                     │                                                                          │              └── projections
                     │                                                                          │                   └── const: 100 [as=stmt_return_6:5]
                     │                                                                          └── subquery
                     │                                                                               ├── tail-call
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_if_5:6
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: stmt_if_5 [as=stmt_if_5:6]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    ├── $1: stmt_if.a:$0
                     │                                                                                              │    └── $2: stmt_if.i:$2
                     │                                                                                              └── body
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_loop_3:4
                     │                                                                                                        ├── project
                     │                                                                                                        │    ├── columns: i:3
                     │                                                                                                        │    ├── values
                     │                                                                                                        │    │    └── tuple
                     │                                                                                                        │    └── projections
                     │                                                                                                        │         └── plus [as=i:3]
                     │                                                                                                        │              ├── stmt_if.i:$2
                     │                                                                                                        │              └── const: 1
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: stmt_loop_3 [as=stmt_loop_3:4]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    ├── $1: stmt_if.a:$0
                     │                                                                                                                  │    └── $2: variable: i:3
                     │                                                                                                                  └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    i INT := a;
  BEGIN
    LOOP
      IF i >= b THEN EXIT; END IF;
      i := i + 1;
    END LOOP;
    RETURN i;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 5);
----
project
 ├── columns: f:9
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:9]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:8
                     ├── project
                     │    ├── columns: stmt_loop_3:8
                     │    ├── project
                     │    │    ├── columns: i:1
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:8]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    └── $2: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_5:7
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_5:7]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$2
                     │                                  │    │    └── stmt_loop.b:$1
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:5
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:5]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.a:$0
                     │                                  │                        │    └── $2: stmt_loop.i:$2
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_return_2:2
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── loop_exit.i:$2 [as=stmt_return_2:2]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:6
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:6]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.a:$0
                     │                                                      │    └── $2: stmt_loop.i:$2
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_loop_3:4
                     │                                                                ├── project
                     │                                                                │    ├── columns: i:3
                     │                                                                │    ├── values
                     │                                                                │    │    └── tuple
                     │                                                                │    └── projections
                     │                                                                │         └── plus [as=i:3]
                     │                                                                │              ├── stmt_if.i:$2
                     │                                                                │              └── const: 1
                     │                                                                └── projections
                     │                                                                     └── udf: stmt_loop_3 [as=stmt_loop_3:4]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    ├── $1: stmt_if.a:$0
                     │                                                                          │    └── $2: variable: i:3
                     │                                                                          └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := a;
  BEGIN
    IF a IS NOT NULL AND b is NOT NULL THEN
      LOOP
        IF i >= b THEN EXIT; END IF;
        sum := sum + i;
        i := i + 1;
      END LOOP;
    END IF;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0, 0);
----
project
 ├── columns: f:14
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:14]
           ├── args
           │    ├── $1: const: 0
           │    └── $2: const: 0
           └── body
                └── limit
                     ├── columns: stmt_if_7:13
                     ├── project
                     │    ├── columns: stmt_if_7:13
                     │    ├── project
                     │    │    ├── columns: i:2 sum:1!null
                     │    │    ├── project
                     │    │    │    ├── columns: sum:1!null
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── const: 0 [as=sum:1]
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:2]
                     │    └── projections
                     │         └── case [as=stmt_if_7:13]
                     │              ├── true
                     │              ├── when
                     │              │    ├── and
                     │              │    │    ├── is-not
                     │              │    │    │    ├── f.a:$1
                     │              │    │    │    └── null
                     │              │    │    └── is-not
                     │              │    │         ├── f.b:$2
                     │              │    │         └── null
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_loop_4:11
                     │              │              ├── values
                     │              │              │    └── tuple
                     │              │              └── projections
                     │              │                   └── udf: stmt_loop_4 [as=stmt_loop_4:11]
                     │              │                        ├── tail-call
                     │              │                        ├── args
                     │              │                        │    ├── $1: f.a:$1
                     │              │                        │    ├── $2: variable: sum:1
                     │              │                        │    └── $3: variable: i:2
                     │              │                        └── body
                     │              │                             └── project
                     │              │                                  ├── columns: stmt_if_6:10
                     │              │                                  ├── values
                     │              │                                  │    └── tuple
                     │              │                                  └── projections
                     │              │                                       └── case [as=stmt_if_6:10]
                     │              │                                            ├── true
                     │              │                                            ├── when
                     │              │                                            │    ├── ge
                     │              │                                            │    │    ├── stmt_loop.i:$3
                     │              │                                            │    │    └── stmt_loop.b:$1
                     │              │                                            │    └── subquery
                     │              │                                            │         ├── tail-call
                     │              │                                            │         └── project
                     │              │                                            │              ├── columns: loop_exit_3:8
                     │              │                                            │              ├── values
                     │              │                                            │              │    └── tuple
                     │              │                                            │              └── projections
                     │              │                                            │                   └── udf: loop_exit_3 [as=loop_exit_3:8]
                     │              │                                            │                        ├── tail-call
                     │              │                                            │                        ├── args
                     │              │                                            │                        │    ├── $1: stmt_loop.a:$0
                     │              │                                            │                        │    └── $2: stmt_loop.sum:$2
                     │              │                                            │                        └── body
                     │              │                                            │                             └── project
                     │              │                                            │                                  ├── columns: stmt_if_1:4
                     │              │                                            │                                  ├── values
                     │              │                                            │                                  │    └── tuple
                     │              │                                            │                                  └── projections
                     │              │                                            │                                       └── udf: stmt_if_1 [as=stmt_if_1:4]
                     │              │                                            │                                            ├── tail-call
                     │              │                                            │                                            ├── args
                     │              │                                            │                                            │    ├── $1: loop_exit.a:$0
                     │              │                                            │                                            │    └── $2: loop_exit.sum:$2
                     │              │                                            │                                            └── body
                     │              │                                            │                                                 └── project
                     │              │                                            │                                                      ├── columns: stmt_return_2:3
                     │              │                                            │                                                      ├── values
                     │              │                                            │                                                      │    └── tuple
                     │              │                                            │                                                      └── projections
                     │              │                                            │                                                           └── stmt_if.sum:$2 [as=stmt_return_2:3]
                     │              │                                            └── subquery
                     │              │                                                 ├── tail-call
                     │              │                                                 └── project
                     │              │                                                      ├── columns: stmt_if_5:9
                     │              │                                                      ├── values
                     │              │                                                      │    └── tuple
                     │              │                                                      └── projections
                     │              │                                                           └── udf: stmt_if_5 [as=stmt_if_5:9]
                     │              │                                                                ├── tail-call
                     │              │                                                                ├── args
                     │              │                                                                │    ├── $1: stmt_loop.a:$0
                     │              │                                                                │    └── $2: stmt_loop.sum:$2
                     │              │                                                                └── body
                     │              │                                                                     └── project
                     │              │                                                                          ├── columns: stmt_loop_4:7
                     │              │                                                                          ├── project
                     │              │                                                                          │    ├── columns: i:6 sum:5
                     │              │                                                                          │    ├── project
                     │              │                                                                          │    │    ├── columns: sum:5
                     │              │                                                                          │    │    ├── values
                     │              │                                                                          │    │    │    └── tuple
                     │              │                                                                          │    │    └── projections
                     │              │                                                                          │    │         └── plus [as=sum:5]
                     │              │                                                                          │    │              ├── stmt_if.sum:$2
                     │              │                                                                          │    │              └── stmt_if.i:$3
                     │              │                                                                          │    └── projections
                     │              │                                                                          │         └── plus [as=i:6]
                     │              │                                                                          │              ├── stmt_if.i:$3
                     │              │                                                                          │              └── const: 1
                     │              │                                                                          └── projections
                     │              │                                                                               └── udf: stmt_loop_4 [as=stmt_loop_4:7]
                     │              │                                                                                    ├── tail-call
                     │              │                                                                                    ├── args
                     │              │                                                                                    │    ├── $1: stmt_if.a:$0
                     │              │                                                                                    │    ├── $2: variable: sum:5
                     │              │                                                                                    │    └── $3: variable: i:6
                     │              │                                                                                    └── recursive-call
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_if_1:12
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:12]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: f.a:$1
                     │                                  │    ├── $2: variable: sum:1
                     │                                  │    └── $3: variable: i:2
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_2:3
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── stmt_if.sum:$2 [as=stmt_return_2:3]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := a;
  BEGIN
    LOOP
      IF i >= b THEN EXIT; END IF;
      IF i = 2 THEN
        i := i + 1;
        CONTINUE;
      END IF;
      sum := sum + i;
      i := i + 1;
    END LOOP;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(5, -5);
----
project
 ├── columns: f:15
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:15]
           ├── args
           │    ├── $1: const: 5
           │    └── $2: const: -5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:14
                     ├── project
                     │    ├── columns: stmt_loop_3:14
                     │    ├── project
                     │    │    ├── columns: i:2 sum:1!null
                     │    │    ├── project
                     │    │    │    ├── columns: sum:1!null
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── const: 0 [as=sum:1]
                     │    │    └── projections
                     │    │         └── f.a:$1 [as=i:2]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:14]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    ├── $2: variable: sum:1
                     │              │    └── $3: variable: i:2
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_7:13
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_7:13]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$3
                     │                                  │    │    └── stmt_loop.b:$1
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:11
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:11]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.a:$0
                     │                                  │                        │    └── $2: stmt_loop.sum:$2
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_return_2:3
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── loop_exit.sum:$2 [as=stmt_return_2:3]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:12
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:12]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.a:$0
                     │                                                      │    └── $2: stmt_loop.sum:$2
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_if_6:10
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── case [as=stmt_if_6:10]
                     │                                                                          ├── true
                     │                                                                          ├── when
                     │                                                                          │    ├── eq
                     │                                                                          │    │    ├── stmt_if.i:$3
                     │                                                                          │    │    └── const: 2
                     │                                                                          │    └── subquery
                     │                                                                          │         ├── tail-call
                     │                                                                          │         └── project
                     │                                                                          │              ├── columns: stmt_loop_3:8
                     │                                                                          │              ├── project
                     │                                                                          │              │    ├── columns: i:7
                     │                                                                          │              │    ├── values
                     │                                                                          │              │    │    └── tuple
                     │                                                                          │              │    └── projections
                     │                                                                          │              │         └── plus [as=i:7]
                     │                                                                          │              │              ├── stmt_if.i:$3
                     │                                                                          │              │              └── const: 1
                     │                                                                          │              └── projections
                     │                                                                          │                   └── udf: stmt_loop_3 [as=stmt_loop_3:8]
                     │                                                                          │                        ├── tail-call
                     │                                                                          │                        ├── args
                     │                                                                          │                        │    ├── $1: stmt_if.a:$0
                     │                                                                          │                        │    └── $2: stmt_if.sum:$2
                     │                                                                          │                        └── recursive-call
                     │                                                                          └── subquery
                     │                                                                               ├── tail-call
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_if_5:9
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: stmt_if_5 [as=stmt_if_5:9]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    ├── $1: stmt_if.a:$0
                     │                                                                                              │    └── $2: stmt_if.sum:$2
                     │                                                                                              └── body
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_loop_3:6
                     │                                                                                                        ├── project
                     │                                                                                                        │    ├── columns: i:5 sum:4
                     │                                                                                                        │    ├── project
                     │                                                                                                        │    │    ├── columns: sum:4
                     │                                                                                                        │    │    ├── values
                     │                                                                                                        │    │    │    └── tuple
                     │                                                                                                        │    │    └── projections
                     │                                                                                                        │    │         └── plus [as=sum:4]
                     │                                                                                                        │    │              ├── stmt_if.sum:$2
                     │                                                                                                        │    │              └── stmt_if.i:$3
                     │                                                                                                        │    └── projections
                     │                                                                                                        │         └── plus [as=i:5]
                     │                                                                                                        │              ├── stmt_if.i:$3
                     │                                                                                                        │              └── const: 1
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: stmt_loop_3 [as=stmt_loop_3:6]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    ├── $1: stmt_if.a:$0
                     │                                                                                                                  │    ├── $2: variable: sum:4
                     │                                                                                                                  │    └── $3: variable: i:5
                     │                                                                                                                  └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(a INT, b INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := a;
    j INT;
  BEGIN
    LOOP
      IF i >= b THEN EXIT; END IF;
      j := 0;
      LOOP
        IF j >= i THEN EXIT; END IF;
        sum := sum + j;
        j := j + 1;
      END LOOP;
      i := i + 1;
    END LOOP;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(1, 5)
----
project
 ├── columns: f:19
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:19]
           ├── args
           │    ├── $1: const: 1
           │    └── $2: const: 5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:18
                     ├── project
                     │    ├── columns: stmt_loop_3:18
                     │    ├── project
                     │    │    ├── columns: j:3 sum:1!null i:2
                     │    │    ├── project
                     │    │    │    ├── columns: i:2 sum:1!null
                     │    │    │    ├── project
                     │    │    │    │    ├── columns: sum:1!null
                     │    │    │    │    ├── values
                     │    │    │    │    │    └── tuple
                     │    │    │    │    └── projections
                     │    │    │    │         └── const: 0 [as=sum:1]
                     │    │    │    └── projections
                     │    │    │         └── f.a:$1 [as=i:2]
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=j:3]
                     │    │              └── null
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:18]
                     │              ├── args
                     │              │    ├── $1: f.a:$1
                     │              │    ├── $2: variable: sum:1
                     │              │    ├── $3: variable: i:2
                     │              │    └── $4: variable: j:3
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_9:17
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_9:17]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$3
                     │                                  │    │    └── stmt_loop.b:$1
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:15
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:15]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.a:$0
                     │                                  │                        │    └── $2: stmt_loop.sum:$2
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_return_2:4
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── loop_exit.sum:$2 [as=stmt_return_2:4]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:16
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:16]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.a:$0
                     │                                                      │    └── $2: stmt_loop.sum:$2
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_loop_6:14
                     │                                                                ├── project
                     │                                                                │    ├── columns: j:5!null
                     │                                                                │    ├── values
                     │                                                                │    │    └── tuple
                     │                                                                │    └── projections
                     │                                                                │         └── const: 0 [as=j:5]
                     │                                                                └── projections
                     │                                                                     └── udf: stmt_loop_6 [as=stmt_loop_6:14]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    ├── $1: stmt_if.a:$0
                     │                                                                          │    └── $2: stmt_if.sum:$2
                     │                                                                          └── body
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_if_8:13
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── case [as=stmt_if_8:13]
                     │                                                                                              ├── true
                     │                                                                                              ├── when
                     │                                                                                              │    ├── ge
                     │                                                                                              │    │    ├── stmt_loop.j:$4
                     │                                                                                              │    │    └── stmt_loop.i:$3
                     │                                                                                              │    └── subquery
                     │                                                                                              │         ├── tail-call
                     │                                                                                              │         └── project
                     │                                                                                              │              ├── columns: loop_exit_5:11
                     │                                                                                              │              ├── values
                     │                                                                                              │              │    └── tuple
                     │                                                                                              │              └── projections
                     │                                                                                              │                   └── udf: loop_exit_5 [as=loop_exit_5:11]
                     │                                                                                              │                        ├── tail-call
                     │                                                                                              │                        ├── args
                     │                                                                                              │                        │    ├── $1: stmt_loop.a:$0
                     │                                                                                              │                        │    └── $2: stmt_loop.sum:$2
                     │                                                                                              │                        └── body
                     │                                                                                              │                             └── project
                     │                                                                                              │                                  ├── columns: stmt_loop_3:7
                     │                                                                                              │                                  ├── project
                     │                                                                                              │                                  │    ├── columns: i:6
                     │                                                                                              │                                  │    ├── values
                     │                                                                                              │                                  │    │    └── tuple
                     │                                                                                              │                                  │    └── projections
                     │                                                                                              │                                  │         └── plus [as=i:6]
                     │                                                                                              │                                  │              ├── loop_exit.i:$3
                     │                                                                                              │                                  │              └── const: 1
                     │                                                                                              │                                  └── projections
                     │                                                                                              │                                       └── udf: stmt_loop_3 [as=stmt_loop_3:7]
                     │                                                                                              │                                            ├── tail-call
                     │                                                                                              │                                            ├── args
                     │                                                                                              │                                            │    ├── $1: loop_exit.a:$0
                     │                                                                                              │                                            │    └── $2: loop_exit.sum:$2
                     │                                                                                              │                                            └── recursive-call
                     │                                                                                              └── subquery
                     │                                                                                                   ├── tail-call
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_if_7:12
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: stmt_if_7 [as=stmt_if_7:12]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    ├── $1: stmt_loop.a:$0
                     │                                                                                                                  │    └── $2: stmt_loop.sum:$2
                     │                                                                                                                  └── body
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: stmt_loop_6:10
                     │                                                                                                                            ├── project
                     │                                                                                                                            │    ├── columns: j:9 sum:8
                     │                                                                                                                            │    ├── project
                     │                                                                                                                            │    │    ├── columns: sum:8
                     │                                                                                                                            │    │    ├── values
                     │                                                                                                                            │    │    │    └── tuple
                     │                                                                                                                            │    │    └── projections
                     │                                                                                                                            │    │         └── plus [as=sum:8]
                     │                                                                                                                            │    │              ├── stmt_if.sum:$2
                     │                                                                                                                            │    │              └── stmt_if.j:$4
                     │                                                                                                                            │    └── projections
                     │                                                                                                                            │         └── plus [as=j:9]
                     │                                                                                                                            │              ├── stmt_if.j:$4
                     │                                                                                                                            │              └── const: 1
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── udf: stmt_loop_6 [as=stmt_loop_6:10]
                     │                                                                                                                                      ├── tail-call
                     │                                                                                                                                      ├── args
                     │                                                                                                                                      │    ├── $1: stmt_if.a:$0
                     │                                                                                                                                      │    ├── $2: variable: sum:8
                     │                                                                                                                                      │    └── $3: stmt_if.i:$3
                     │                                                                                                                                      └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := 0;
  BEGIN
    WHILE i < n LOOP
      sum := sum + i;
      i := i + 1;
    END LOOP;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(5)
----
project
 ├── columns: f:11
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:11]
           ├── args
           │    └── $1: const: 5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:10
                     ├── project
                     │    ├── columns: stmt_loop_3:10
                     │    ├── project
                     │    │    ├── columns: i:2!null sum:1!null
                     │    │    ├── project
                     │    │    │    ├── columns: sum:1!null
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── const: 0 [as=sum:1]
                     │    │    └── projections
                     │    │         └── const: 0 [as=i:2]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:10]
                     │              ├── args
                     │              │    ├── $1: f.n:$1
                     │              │    ├── $2: variable: sum:1
                     │              │    └── $3: variable: i:2
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_5:9
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_5:9]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── lt
                     │                                  │    │    ├── stmt_loop.i:$2
                     │                                  │    │    └── stmt_loop.n:$0
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: stmt_if_4:7
                     │                                  │              ├── project
                     │                                  │              │    ├── columns: i:6 sum:5
                     │                                  │              │    ├── project
                     │                                  │              │    │    ├── columns: sum:5
                     │                                  │              │    │    ├── values
                     │                                  │              │    │    │    └── tuple
                     │                                  │              │    │    └── projections
                     │                                  │              │    │         └── plus [as=sum:5]
                     │                                  │              │    │              ├── stmt_loop.sum:$1
                     │                                  │              │    │              └── stmt_loop.i:$2
                     │                                  │              │    └── projections
                     │                                  │              │         └── plus [as=i:6]
                     │                                  │              │              ├── stmt_loop.i:$2
                     │                                  │              │              └── const: 1
                     │                                  │              └── projections
                     │                                  │                   └── udf: stmt_if_4 [as=stmt_if_4:7]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.n:$0
                     │                                  │                        │    ├── $2: variable: sum:5
                     │                                  │                        │    └── $3: variable: i:6
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_loop_3:4
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── udf: stmt_loop_3 [as=stmt_loop_3:4]
                     │                                  │                                            ├── tail-call
                     │                                  │                                            ├── args
                     │                                  │                                            │    ├── $1: stmt_if.n:$0
                     │                                  │                                            │    └── $2: stmt_if.sum:$1
                     │                                  │                                            └── recursive-call
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: loop_exit_1:8
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: loop_exit_1 [as=loop_exit_1:8]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.n:$0
                     │                                                      │    └── $2: stmt_loop.sum:$1
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_return_2:3
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── loop_exit.sum:$1 [as=stmt_return_2:3]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := 0;
  BEGIN
    LOOP
      EXIT WHEN i > n;
      sum := sum + i;
      i := i + 1;
    END LOOP;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(5)
----
project
 ├── columns: f:11
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:11]
           ├── args
           │    └── $1: const: 5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:10
                     ├── project
                     │    ├── columns: stmt_loop_3:10
                     │    ├── project
                     │    │    ├── columns: i:2!null sum:1!null
                     │    │    ├── project
                     │    │    │    ├── columns: sum:1!null
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── const: 0 [as=sum:1]
                     │    │    └── projections
                     │    │         └── const: 0 [as=i:2]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:10]
                     │              ├── args
                     │              │    ├── $1: f.n:$1
                     │              │    ├── $2: variable: sum:1
                     │              │    └── $3: variable: i:2
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_5:9
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_5:9]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── gt
                     │                                  │    │    ├── stmt_loop.i:$2
                     │                                  │    │    └── stmt_loop.n:$0
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:7
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:7]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.n:$0
                     │                                  │                        │    └── $2: stmt_loop.sum:$1
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_return_2:3
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── loop_exit.sum:$1 [as=stmt_return_2:3]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:8
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:8]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.n:$0
                     │                                                      │    └── $2: stmt_loop.sum:$1
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_loop_3:6
                     │                                                                ├── project
                     │                                                                │    ├── columns: i:5 sum:4
                     │                                                                │    ├── project
                     │                                                                │    │    ├── columns: sum:4
                     │                                                                │    │    ├── values
                     │                                                                │    │    │    └── tuple
                     │                                                                │    │    └── projections
                     │                                                                │    │         └── plus [as=sum:4]
                     │                                                                │    │              ├── stmt_if.sum:$1
                     │                                                                │    │              └── stmt_if.i:$2
                     │                                                                │    └── projections
                     │                                                                │         └── plus [as=i:5]
                     │                                                                │              ├── stmt_if.i:$2
                     │                                                                │              └── const: 1
                     │                                                                └── projections
                     │                                                                     └── udf: stmt_loop_3 [as=stmt_loop_3:6]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    ├── $1: stmt_if.n:$0
                     │                                                                          │    ├── $2: variable: sum:4
                     │                                                                          │    └── $3: variable: i:5
                     │                                                                          └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS INT AS $$
  DECLARE
    sum INT := 0;
    i INT := 0;
  BEGIN
    LOOP
      CONTINUE WHEN i % 2 = 0;
      sum := sum + i;
      i := i + 1;
    END LOOP;
    RETURN sum;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(5)
----
project
 ├── columns: f:11
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:11]
           ├── args
           │    └── $1: const: 5
           └── body
                └── limit
                     ├── columns: stmt_loop_3:10
                     ├── project
                     │    ├── columns: stmt_loop_3:10
                     │    ├── project
                     │    │    ├── columns: i:2!null sum:1!null
                     │    │    ├── project
                     │    │    │    ├── columns: sum:1!null
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── const: 0 [as=sum:1]
                     │    │    └── projections
                     │    │         └── const: 0 [as=i:2]
                     │    └── projections
                     │         └── udf: stmt_loop_3 [as=stmt_loop_3:10]
                     │              ├── args
                     │              │    ├── $1: f.n:$1
                     │              │    ├── $2: variable: sum:1
                     │              │    └── $3: variable: i:2
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_5:9
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_5:9]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── eq
                     │                                  │    │    ├── mod
                     │                                  │    │    │    ├── stmt_loop.i:$2
                     │                                  │    │    │    └── const: 2
                     │                                  │    │    └── const: 0
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: stmt_loop_3:7
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: stmt_loop_3 [as=stmt_loop_3:7]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    ├── $1: stmt_loop.n:$0
                     │                                  │                        │    └── $2: stmt_loop.sum:$1
                     │                                  │                        └── recursive-call
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_4:8
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_4 [as=stmt_if_4:8]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: stmt_loop.n:$0
                     │                                                      │    └── $2: stmt_loop.sum:$1
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_loop_3:6
                     │                                                                ├── project
                     │                                                                │    ├── columns: i:5 sum:4
                     │                                                                │    ├── project
                     │                                                                │    │    ├── columns: sum:4
                     │                                                                │    │    ├── values
                     │                                                                │    │    │    └── tuple
                     │                                                                │    │    └── projections
                     │                                                                │    │         └── plus [as=sum:4]
                     │                                                                │    │              ├── stmt_if.sum:$1
                     │                                                                │    │              └── stmt_if.i:$2
                     │                                                                │    └── projections
                     │                                                                │         └── plus [as=i:5]
                     │                                                                │              ├── stmt_if.i:$2
                     │                                                                │              └── const: 1
                     │                                                                └── projections
                     │                                                                     └── udf: stmt_loop_3 [as=stmt_loop_3:6]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    ├── $1: stmt_if.n:$0
                     │                                                                          │    ├── $2: variable: sum:4
                     │                                                                          │    └── $3: variable: i:5
                     │                                                                          └── recursive-call
                     └── const: 1

# Testing RAISE statements.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE DEBUG 'foo';
    RAISE LOG 'foo';
    RAISE INFO 'foo';
    RAISE NOTICE 'foo';
    RAISE WARNING 'foo';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:12
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:12]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":11
                     ├── project
                     │    ├── columns: "_stmt_raise_1":11
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":11]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'DEBUG1'
                     │                   │              ├── const: 'foo'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_3":10
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_raise_3 [as="_stmt_raise_3":10]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_4:2
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:2]
                     │                                       │              ├── const: 'LOG'
                     │                                       │              ├── const: 'foo'
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: '00000'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_5":9
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_5 [as="_stmt_raise_5":9]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_6:3
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:3]
                     │                                                           │              ├── const: 'INFO'
                     │                                                           │              ├── const: 'foo'
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":8
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":8]
                     │                                                                          ├── tail-call
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:4
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:4]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── const: 'foo'
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '00000'
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_raise_9":7
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_raise_9 [as="_stmt_raise_9":7]
                     │                                                                                              ├── tail-call
                     │                                                                                              └── body
                     │                                                                                                   ├── project
                     │                                                                                                   │    ├── columns: stmt_raise_10:5
                     │                                                                                                   │    ├── values
                     │                                                                                                   │    │    └── tuple
                     │                                                                                                   │    └── projections
                     │                                                                                                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:5]
                     │                                                                                                   │              ├── const: 'WARNING'
                     │                                                                                                   │              ├── const: 'foo'
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              └── const: '00000'
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_return_11:6!null
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── const: 0 [as=stmt_return_11:6]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE NOTICE '%', 1;
    RAISE NOTICE 'foo: %, %, %', 1, 2, 3;
    RAISE NOTICE '%%';
    RAISE NOTICE '%%%', 1;
    RAISE NOTICE '%%%foo%% bar%%%% %% %%%% ba%z%', 1, 2, 3;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:12
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:12]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":11
                     ├── project
                     │    ├── columns: "_stmt_raise_1":11
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":11]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── concat
                     │                   │              │    ├── concat
                     │                   │              │    │    ├── const: ''
                     │                   │              │    │    └── coalesce
                     │                   │              │    │         ├── cast: STRING
                     │                   │              │    │         │    └── const: 1
                     │                   │              │    │         └── const: '<NULL>'
                     │                   │              │    └── const: ''
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_3":10
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_raise_3 [as="_stmt_raise_3":10]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_4:2
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:2]
                     │                                       │              ├── const: 'NOTICE'
                     │                                       │              ├── concat
                     │                                       │              │    ├── concat
                     │                                       │              │    │    ├── concat
                     │                                       │              │    │    │    ├── concat
                     │                                       │              │    │    │    │    ├── concat
                     │                                       │              │    │    │    │    │    ├── concat
                     │                                       │              │    │    │    │    │    │    ├── const: 'foo: '
                     │                                       │              │    │    │    │    │    │    └── coalesce
                     │                                       │              │    │    │    │    │    │         ├── cast: STRING
                     │                                       │              │    │    │    │    │    │         │    └── const: 1
                     │                                       │              │    │    │    │    │    │         └── const: '<NULL>'
                     │                                       │              │    │    │    │    │    └── const: ', '
                     │                                       │              │    │    │    │    └── coalesce
                     │                                       │              │    │    │    │         ├── cast: STRING
                     │                                       │              │    │    │    │         │    └── const: 2
                     │                                       │              │    │    │    │         └── const: '<NULL>'
                     │                                       │              │    │    │    └── const: ', '
                     │                                       │              │    │    └── coalesce
                     │                                       │              │    │         ├── cast: STRING
                     │                                       │              │    │         │    └── const: 3
                     │                                       │              │    │         └── const: '<NULL>'
                     │                                       │              │    └── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: '00000'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_5":9
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_5 [as="_stmt_raise_5":9]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_6:3
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:3]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── concat
                     │                                                           │              │    ├── concat
                     │                                                           │              │    │    ├── const: ''
                     │                                                           │              │    │    └── const: '%'
                     │                                                           │              │    └── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":8
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":8]
                     │                                                                          ├── tail-call
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:4
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:4]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── concat
                     │                                                                               │              │    ├── concat
                     │                                                                               │              │    │    ├── concat
                     │                                                                               │              │    │    │    ├── concat
                     │                                                                               │              │    │    │    │    ├── const: ''
                     │                                                                               │              │    │    │    │    └── const: '%'
                     │                                                                               │              │    │    │    └── const: ''
                     │                                                                               │              │    │    └── coalesce
                     │                                                                               │              │    │         ├── cast: STRING
                     │                                                                               │              │    │         │    └── const: 1
                     │                                                                               │              │    │         └── const: '<NULL>'
                     │                                                                               │              │    └── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '00000'
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_raise_9":7
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_raise_9 [as="_stmt_raise_9":7]
                     │                                                                                              ├── tail-call
                     │                                                                                              └── body
                     │                                                                                                   ├── project
                     │                                                                                                   │    ├── columns: stmt_raise_10:5
                     │                                                                                                   │    ├── values
                     │                                                                                                   │    │    └── tuple
                     │                                                                                                   │    └── projections
                     │                                                                                                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:5]
                     │                                                                                                   │              ├── const: 'NOTICE'
                     │                                                                                                   │              ├── concat
                     │                                                                                                   │              │    ├── concat
                     │                                                                                                   │              │    │    ├── concat
                     │                                                                                                   │              │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── concat
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    ├── const: ''
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: ''
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── coalesce
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │         ├── cast: STRING
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │         │    └── const: 1
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │         └── const: '<NULL>'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: 'foo'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: ' bar'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    │    └── const: ''
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    │    └── const: ' '
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    │    │    └── const: ' '
                     │                                                                                                   │              │    │    │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    │    │    └── const: ''
                     │                                                                                                   │              │    │    │    │    │    │    └── const: '%'
                     │                                                                                                   │              │    │    │    │    │    └── const: ' ba'
                     │                                                                                                   │              │    │    │    │    └── coalesce
                     │                                                                                                   │              │    │    │    │         ├── cast: STRING
                     │                                                                                                   │              │    │    │    │         │    └── const: 2
                     │                                                                                                   │              │    │    │    │         └── const: '<NULL>'
                     │                                                                                                   │              │    │    │    └── const: 'z'
                     │                                                                                                   │              │    │    └── coalesce
                     │                                                                                                   │              │    │         ├── cast: STRING
                     │                                                                                                   │              │    │         │    └── const: 3
                     │                                                                                                   │              │    │         └── const: '<NULL>'
                     │                                                                                                   │              │    └── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              └── const: '00000'
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_return_11:6!null
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── const: 0 [as=stmt_return_11:6]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE NOTICE division_by_zero;
    RAISE NOTICE null_value_not_allowed;
    RAISE NOTICE reading_sql_data_not_permitted;
    RAISE NOTICE SQLSTATE '22012';
    RAISE NOTICE SQLSTATE '22004';
    RAISE NOTICE SQLSTATE '39004';
    RAISE NOTICE SQLSTATE '2F004';
    RAISE NOTICE SQLSTATE '38004';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:18
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:18]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":17
                     ├── project
                     │    ├── columns: "_stmt_raise_1":17
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":17]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── const: 'division_by_zero'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: 'division_by_zero'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_3":16
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_raise_3 [as="_stmt_raise_3":16]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_4:2
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:2]
                     │                                       │              ├── const: 'NOTICE'
                     │                                       │              ├── const: 'null_value_not_allowed'
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: 'null_value_not_allowed'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_5":15
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_5 [as="_stmt_raise_5":15]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_6:3
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:3]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── const: 'reading_sql_data_not_permitted'
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: 'reading_sql_data_not_permitted'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":14
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":14]
                     │                                                                          ├── tail-call
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:4
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:4]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── const: '22012'
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '22012'
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_raise_9":13
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_raise_9 [as="_stmt_raise_9":13]
                     │                                                                                              ├── tail-call
                     │                                                                                              └── body
                     │                                                                                                   ├── project
                     │                                                                                                   │    ├── columns: stmt_raise_10:5
                     │                                                                                                   │    ├── values
                     │                                                                                                   │    │    └── tuple
                     │                                                                                                   │    └── projections
                     │                                                                                                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:5]
                     │                                                                                                   │              ├── const: 'NOTICE'
                     │                                                                                                   │              ├── const: '22004'
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              └── const: '22004'
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: "_stmt_raise_11":12
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: _stmt_raise_11 [as="_stmt_raise_11":12]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  └── body
                     │                                                                                                                       ├── project
                     │                                                                                                                       │    ├── columns: stmt_raise_12:6
                     │                                                                                                                       │    ├── values
                     │                                                                                                                       │    │    └── tuple
                     │                                                                                                                       │    └── projections
                     │                                                                                                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_12:6]
                     │                                                                                                                       │              ├── const: 'NOTICE'
                     │                                                                                                                       │              ├── const: '39004'
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              └── const: '39004'
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: "_stmt_raise_13":11
                     │                                                                                                                            ├── values
                     │                                                                                                                            │    └── tuple
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── udf: _stmt_raise_13 [as="_stmt_raise_13":11]
                     │                                                                                                                                      ├── tail-call
                     │                                                                                                                                      └── body
                     │                                                                                                                                           ├── project
                     │                                                                                                                                           │    ├── columns: stmt_raise_14:7
                     │                                                                                                                                           │    ├── values
                     │                                                                                                                                           │    │    └── tuple
                     │                                                                                                                                           │    └── projections
                     │                                                                                                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_14:7]
                     │                                                                                                                                           │              ├── const: 'NOTICE'
                     │                                                                                                                                           │              ├── const: '2F004'
                     │                                                                                                                                           │              ├── const: ''
                     │                                                                                                                                           │              ├── const: ''
                     │                                                                                                                                           │              └── const: '2F004'
                     │                                                                                                                                           └── project
                     │                                                                                                                                                ├── columns: "_stmt_raise_15":10
                     │                                                                                                                                                ├── values
                     │                                                                                                                                                │    └── tuple
                     │                                                                                                                                                └── projections
                     │                                                                                                                                                     └── udf: _stmt_raise_15 [as="_stmt_raise_15":10]
                     │                                                                                                                                                          ├── tail-call
                     │                                                                                                                                                          └── body
                     │                                                                                                                                                               ├── project
                     │                                                                                                                                                               │    ├── columns: stmt_raise_16:8
                     │                                                                                                                                                               │    ├── values
                     │                                                                                                                                                               │    │    └── tuple
                     │                                                                                                                                                               │    └── projections
                     │                                                                                                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_16:8]
                     │                                                                                                                                                               │              ├── const: 'NOTICE'
                     │                                                                                                                                                               │              ├── const: '38004'
                     │                                                                                                                                                               │              ├── const: ''
                     │                                                                                                                                                               │              ├── const: ''
                     │                                                                                                                                                               │              └── const: '38004'
                     │                                                                                                                                                               └── project
                     │                                                                                                                                                                    ├── columns: stmt_return_17:9!null
                     │                                                                                                                                                                    ├── values
                     │                                                                                                                                                                    │    └── tuple
                     │                                                                                                                                                                    └── projections
                     │                                                                                                                                                                         └── const: 0 [as=stmt_return_17:9]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE NOTICE USING MESSAGE = 'foo';
    RAISE NOTICE USING MESSAGE = format('%s %s!','Hello','World');
    RAISE NOTICE USING MESSAGE = 'foo', DETAIL = 'bar', HINT = 'baz';
    RAISE NOTICE 'foo' USING ERRCODE = 'division_by_zero';
    RAISE NOTICE 'foo' USING ERRCODE = '22012';
    -- If no message is specified, the error code is used.
    RAISE NOTICE USING ERRCODE = 'division_by_zero';
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:14
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:14]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":13
                     ├── project
                     │    ├── columns: "_stmt_raise_1":13
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":13]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── const: 'foo'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_3":12
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_raise_3 [as="_stmt_raise_3":12]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_4:2
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:2]
                     │                                       │              ├── const: 'NOTICE'
                     │                                       │              ├── function: format
                     │                                       │              │    ├── const: '%s %s!'
                     │                                       │              │    ├── const: 'Hello'
                     │                                       │              │    └── const: 'World'
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: '00000'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_5":11
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_5 [as="_stmt_raise_5":11]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_6:3
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:3]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── const: 'foo'
                     │                                                           │              ├── const: 'bar'
                     │                                                           │              ├── const: 'baz'
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":10
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":10]
                     │                                                                          ├── tail-call
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:4
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:4]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── const: 'foo'
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: 'division_by_zero'
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_raise_9":9
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_raise_9 [as="_stmt_raise_9":9]
                     │                                                                                              ├── tail-call
                     │                                                                                              └── body
                     │                                                                                                   ├── project
                     │                                                                                                   │    ├── columns: stmt_raise_10:5
                     │                                                                                                   │    ├── values
                     │                                                                                                   │    │    └── tuple
                     │                                                                                                   │    └── projections
                     │                                                                                                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:5]
                     │                                                                                                   │              ├── const: 'NOTICE'
                     │                                                                                                   │              ├── const: 'foo'
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              └── const: '22012'
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: "_stmt_raise_11":8
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: _stmt_raise_11 [as="_stmt_raise_11":8]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  └── body
                     │                                                                                                                       ├── project
                     │                                                                                                                       │    ├── columns: stmt_raise_12:6
                     │                                                                                                                       │    ├── values
                     │                                                                                                                       │    │    └── tuple
                     │                                                                                                                       │    └── projections
                     │                                                                                                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_12:6]
                     │                                                                                                                       │              ├── const: 'NOTICE'
                     │                                                                                                                       │              ├── const: 'division_by_zero'
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              └── const: 'division_by_zero'
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: stmt_return_13:7!null
                     │                                                                                                                            ├── values
                     │                                                                                                                            │    └── tuple
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── const: 0 [as=stmt_return_13:7]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT := 0;
  BEGIN
    RAISE NOTICE '1: i = %', i;
    i := 100;
    RAISE NOTICE '2: i = %', i;
    i := (SELECT count(*) FROM xy);
    RAISE NOTICE '3: i = %', i;
    RAISE NOTICE 'max_x: %', (SELECT max(x) FROM xy);
    return i;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:25
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:25]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":24
                     ├── project
                     │    ├── columns: "_stmt_raise_1":24
                     │    ├── barrier
                     │    │    ├── columns: i:1!null
                     │    │    └── project
                     │    │         ├── columns: i:1!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 0 [as=i:1]
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":24]
                     │              ├── args
                     │              │    └── $1: variable: i:1
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:2
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:2]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── concat
                     │                   │              │    ├── concat
                     │                   │              │    │    ├── const: '1: i = '
                     │                   │              │    │    └── coalesce
                     │                   │              │    │         ├── cast: STRING
                     │                   │              │    │         │    └── _stmt_raise.i:$0
                     │                   │              │    │         └── const: '<NULL>'
                     │                   │              │    └── const: ''
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_3":23
                     │                        ├── barrier
                     │                        │    ├── columns: i:3!null
                     │                        │    └── project
                     │                        │         ├── columns: i:3!null
                     │                        │         ├── values
                     │                        │         │    └── tuple
                     │                        │         └── projections
                     │                        │              └── const: 100 [as=i:3]
                     │                        └── projections
                     │                             └── udf: _stmt_raise_3 [as="_stmt_raise_3":23]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    └── $1: variable: i:3
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_4:4
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:4]
                     │                                       │              ├── const: 'NOTICE'
                     │                                       │              ├── concat
                     │                                       │              │    ├── concat
                     │                                       │              │    │    ├── const: '2: i = '
                     │                                       │              │    │    └── coalesce
                     │                                       │              │    │         ├── cast: STRING
                     │                                       │              │    │         │    └── _stmt_raise.i:$0
                     │                                       │              │    │         └── const: '<NULL>'
                     │                                       │              │    └── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: '00000'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_5":22
                     │                                            ├── barrier
                     │                                            │    ├── columns: i:11
                     │                                            │    └── project
                     │                                            │         ├── columns: i:11
                     │                                            │         ├── values
                     │                                            │         │    └── tuple
                     │                                            │         └── projections
                     │                                            │              └── subquery [as=i:11]
                     │                                            │                   └── max1-row
                     │                                            │                        ├── columns: count_rows:10!null
                     │                                            │                        └── scalar-group-by
                     │                                            │                             ├── columns: count_rows:10!null
                     │                                            │                             ├── project
                     │                                            │                             │    └── scan xy
                     │                                            │                             │         └── columns: x:5 y:6 rowid:7!null crdb_internal_mvcc_timestamp:8 tableoid:9
                     │                                            │                             └── aggregations
                     │                                            │                                  └── count-rows [as=count_rows:10]
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_5 [as="_stmt_raise_5":22]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: variable: i:11
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_6:12
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:12]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── concat
                     │                                                           │              │    ├── concat
                     │                                                           │              │    │    ├── const: '3: i = '
                     │                                                           │              │    │    └── coalesce
                     │                                                           │              │    │         ├── cast: STRING
                     │                                                           │              │    │         │    └── _stmt_raise.i:$0
                     │                                                           │              │    │         └── const: '<NULL>'
                     │                                                           │              │    └── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":21
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":21]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: _stmt_raise.i:$0
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:19
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:19]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── concat
                     │                                                                               │              │    ├── concat
                     │                                                                               │              │    │    ├── const: 'max_x: '
                     │                                                                               │              │    │    └── coalesce
                     │                                                                               │              │    │         ├── cast: STRING
                     │                                                                               │              │    │         │    └── subquery
                     │                                                                               │              │    │         │         └── max1-row
                     │                                                                               │              │    │         │              ├── columns: max:18
                     │                                                                               │              │    │         │              └── scalar-group-by
                     │                                                                               │              │    │         │                   ├── columns: max:18
                     │                                                                               │              │    │         │                   ├── project
                     │                                                                               │              │    │         │                   │    ├── columns: x:13
                     │                                                                               │              │    │         │                   │    └── scan xy
                     │                                                                               │              │    │         │                   │         └── columns: x:13 y:14 rowid:15!null crdb_internal_mvcc_timestamp:16 tableoid:17
                     │                                                                               │              │    │         │                   └── aggregations
                     │                                                                               │              │    │         │                        └── max [as=max:18]
                     │                                                                               │              │    │         │                             └── variable: x:13
                     │                                                                               │              │    │         └── const: '<NULL>'
                     │                                                                               │              │    └── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '00000'
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_return_9:20
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── _stmt_raise.i:$0 [as=stmt_return_9:20]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT := 0;
  BEGIN
    LOOP
      IF i >= 5 THEN EXIT; END IF;
      RAISE NOTICE 'i = %', i;
      i := i + 1;
    END LOOP;
    RAISE NOTICE 'finished with i = %', i;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:13
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:13]
           └── body
                └── limit
                     ├── columns: stmt_loop_5:12
                     ├── project
                     │    ├── columns: stmt_loop_5:12
                     │    ├── barrier
                     │    │    ├── columns: i:1!null
                     │    │    └── project
                     │    │         ├── columns: i:1!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 0 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_5 [as=stmt_loop_5:12]
                     │              ├── args
                     │              │    └── $1: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_9:11
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_9:11]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$0
                     │                                  │    │    └── const: 5
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:9
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:9]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    └── $1: stmt_loop.i:$0
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: "_stmt_raise_2":4
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── udf: _stmt_raise_2 [as="_stmt_raise_2":4]
                     │                                  │                                            ├── tail-call
                     │                                  │                                            ├── args
                     │                                  │                                            │    └── $1: loop_exit.i:$0
                     │                                  │                                            └── body
                     │                                  │                                                 ├── project
                     │                                  │                                                 │    ├── columns: stmt_raise_3:2
                     │                                  │                                                 │    ├── values
                     │                                  │                                                 │    │    └── tuple
                     │                                  │                                                 │    └── projections
                     │                                  │                                                 │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_3:2]
                     │                                  │                                                 │              ├── const: 'NOTICE'
                     │                                  │                                                 │              ├── concat
                     │                                  │                                                 │              │    ├── concat
                     │                                  │                                                 │              │    │    ├── const: 'finished with i = '
                     │                                  │                                                 │              │    │    └── coalesce
                     │                                  │                                                 │              │    │         ├── cast: STRING
                     │                                  │                                                 │              │    │         │    └── _stmt_raise.i:$0
                     │                                  │                                                 │              │    │         └── const: '<NULL>'
                     │                                  │                                                 │              │    └── const: ''
                     │                                  │                                                 │              ├── const: ''
                     │                                  │                                                 │              ├── const: ''
                     │                                  │                                                 │              └── const: '00000'
                     │                                  │                                                 └── project
                     │                                  │                                                      ├── columns: stmt_return_4:3!null
                     │                                  │                                                      ├── values
                     │                                  │                                                      │    └── tuple
                     │                                  │                                                      └── projections
                     │                                  │                                                           └── const: 0 [as=stmt_return_4:3]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_6:10
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_6 [as=stmt_if_6:10]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: stmt_loop.i:$0
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_7":8
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_7 [as="_stmt_raise_7":8]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: stmt_if.i:$0
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_8:5
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:5]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── concat
                     │                                                                               │              │    ├── concat
                     │                                                                               │              │    │    ├── const: 'i = '
                     │                                                                               │              │    │    └── coalesce
                     │                                                                               │              │    │         ├── cast: STRING
                     │                                                                               │              │    │         │    └── _stmt_raise.i:$0
                     │                                                                               │              │    │         └── const: '<NULL>'
                     │                                                                               │              │    └── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '00000'
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_loop_5:7
                     │                                                                                    ├── project
                     │                                                                                    │    ├── columns: i:6
                     │                                                                                    │    ├── values
                     │                                                                                    │    │    └── tuple
                     │                                                                                    │    └── projections
                     │                                                                                    │         └── plus [as=i:6]
                     │                                                                                    │              ├── _stmt_raise.i:$0
                     │                                                                                    │              └── const: 1
                     │                                                                                    └── projections
                     │                                                                                         └── udf: stmt_loop_5 [as=stmt_loop_5:7]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    └── $1: variable: i:6
                     │                                                                                              └── recursive-call
                     └── const: 1

# Testing RAISE statement with EXCEPTION log level.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION 'foo';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: 'foo'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: 'P0001'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION division_by_zero;
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: 'division_by_zero'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: 'division_by_zero'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION SQLSTATE '22012';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: '22012'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '22012'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT := 0;
  BEGIN
    LOOP
      IF i >= 5 THEN EXIT; END IF;
      IF i = 3 THEN
        RAISE EXCEPTION 'i = %', i;
      END IF;
      RAISE NOTICE 'i = %', i;
      i := i + 1;
    END LOOP;
    RAISE NOTICE 'finished with i = %', i;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:18
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:18]
           └── body
                └── limit
                     ├── columns: stmt_loop_5:17
                     ├── project
                     │    ├── columns: stmt_loop_5:17
                     │    ├── barrier
                     │    │    ├── columns: i:1!null
                     │    │    └── project
                     │    │         ├── columns: i:1!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 0 [as=i:1]
                     │    └── projections
                     │         └── udf: stmt_loop_5 [as=stmt_loop_5:17]
                     │              ├── args
                     │              │    └── $1: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_13:16
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── case [as=stmt_if_13:16]
                     │                                  ├── true
                     │                                  ├── when
                     │                                  │    ├── ge
                     │                                  │    │    ├── stmt_loop.i:$0
                     │                                  │    │    └── const: 5
                     │                                  │    └── subquery
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: loop_exit_1:14
                     │                                  │              ├── values
                     │                                  │              │    └── tuple
                     │                                  │              └── projections
                     │                                  │                   └── udf: loop_exit_1 [as=loop_exit_1:14]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    └── $1: stmt_loop.i:$0
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: "_stmt_raise_2":4
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple
                     │                                  │                                  └── projections
                     │                                  │                                       └── udf: _stmt_raise_2 [as="_stmt_raise_2":4]
                     │                                  │                                            ├── tail-call
                     │                                  │                                            ├── args
                     │                                  │                                            │    └── $1: loop_exit.i:$0
                     │                                  │                                            └── body
                     │                                  │                                                 ├── project
                     │                                  │                                                 │    ├── columns: stmt_raise_3:2
                     │                                  │                                                 │    ├── values
                     │                                  │                                                 │    │    └── tuple
                     │                                  │                                                 │    └── projections
                     │                                  │                                                 │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_3:2]
                     │                                  │                                                 │              ├── const: 'NOTICE'
                     │                                  │                                                 │              ├── concat
                     │                                  │                                                 │              │    ├── concat
                     │                                  │                                                 │              │    │    ├── const: 'finished with i = '
                     │                                  │                                                 │              │    │    └── coalesce
                     │                                  │                                                 │              │    │         ├── cast: STRING
                     │                                  │                                                 │              │    │         │    └── _stmt_raise.i:$0
                     │                                  │                                                 │              │    │         └── const: '<NULL>'
                     │                                  │                                                 │              │    └── const: ''
                     │                                  │                                                 │              ├── const: ''
                     │                                  │                                                 │              ├── const: ''
                     │                                  │                                                 │              └── const: '00000'
                     │                                  │                                                 └── project
                     │                                  │                                                      ├── columns: stmt_return_4:3!null
                     │                                  │                                                      ├── values
                     │                                  │                                                      │    └── tuple
                     │                                  │                                                      └── projections
                     │                                  │                                                           └── const: 0 [as=stmt_return_4:3]
                     │                                  └── subquery
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: stmt_if_6:15
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: stmt_if_6 [as=stmt_if_6:15]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: stmt_loop.i:$0
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: stmt_if_12:13
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── case [as=stmt_if_12:13]
                     │                                                                          ├── true
                     │                                                                          ├── when
                     │                                                                          │    ├── eq
                     │                                                                          │    │    ├── stmt_if.i:$0
                     │                                                                          │    │    └── const: 3
                     │                                                                          │    └── subquery
                     │                                                                          │         ├── tail-call
                     │                                                                          │         └── project
                     │                                                                          │              ├── columns: "_stmt_raise_10":11
                     │                                                                          │              ├── values
                     │                                                                          │              │    └── tuple
                     │                                                                          │              └── projections
                     │                                                                          │                   └── udf: _stmt_raise_10 [as="_stmt_raise_10":11]
                     │                                                                          │                        ├── tail-call
                     │                                                                          │                        ├── args
                     │                                                                          │                        │    └── $1: stmt_if.i:$0
                     │                                                                          │                        └── body
                     │                                                                          │                             ├── project
                     │                                                                          │                             │    ├── columns: stmt_raise_11:9
                     │                                                                          │                             │    ├── values
                     │                                                                          │                             │    │    └── tuple
                     │                                                                          │                             │    └── projections
                     │                                                                          │                             │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_11:9]
                     │                                                                          │                             │              ├── const: 'ERROR'
                     │                                                                          │                             │              ├── concat
                     │                                                                          │                             │              │    ├── concat
                     │                                                                          │                             │              │    │    ├── const: 'i = '
                     │                                                                          │                             │              │    │    └── coalesce
                     │                                                                          │                             │              │    │         ├── cast: STRING
                     │                                                                          │                             │              │    │         │    └── _stmt_raise.i:$0
                     │                                                                          │                             │              │    │         └── const: '<NULL>'
                     │                                                                          │                             │              │    └── const: ''
                     │                                                                          │                             │              ├── const: ''
                     │                                                                          │                             │              ├── const: ''
                     │                                                                          │                             │              └── const: 'P0001'
                     │                                                                          │                             └── project
                     │                                                                          │                                  ├── columns: stmt_if_7:10
                     │                                                                          │                                  ├── values
                     │                                                                          │                                  │    └── tuple
                     │                                                                          │                                  └── projections
                     │                                                                          │                                       └── udf: stmt_if_7 [as=stmt_if_7:10]
                     │                                                                          │                                            ├── tail-call
                     │                                                                          │                                            ├── args
                     │                                                                          │                                            │    └── $1: _stmt_raise.i:$0
                     │                                                                          │                                            └── body
                     │                                                                          │                                                 └── project
                     │                                                                          │                                                      ├── columns: "_stmt_raise_8":8
                     │                                                                          │                                                      ├── values
                     │                                                                          │                                                      │    └── tuple
                     │                                                                          │                                                      └── projections
                     │                                                                          │                                                           └── udf: _stmt_raise_8 [as="_stmt_raise_8":8]
                     │                                                                          │                                                                ├── tail-call
                     │                                                                          │                                                                ├── args
                     │                                                                          │                                                                │    └── $1: stmt_if.i:$0
                     │                                                                          │                                                                └── body
                     │                                                                          │                                                                     ├── project
                     │                                                                          │                                                                     │    ├── columns: stmt_raise_9:5
                     │                                                                          │                                                                     │    ├── values
                     │                                                                          │                                                                     │    │    └── tuple
                     │                                                                          │                                                                     │    └── projections
                     │                                                                          │                                                                     │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_9:5]
                     │                                                                          │                                                                     │              ├── const: 'NOTICE'
                     │                                                                          │                                                                     │              ├── concat
                     │                                                                          │                                                                     │              │    ├── concat
                     │                                                                          │                                                                     │              │    │    ├── const: 'i = '
                     │                                                                          │                                                                     │              │    │    └── coalesce
                     │                                                                          │                                                                     │              │    │         ├── cast: STRING
                     │                                                                          │                                                                     │              │    │         │    └── _stmt_raise.i:$0
                     │                                                                          │                                                                     │              │    │         └── const: '<NULL>'
                     │                                                                          │                                                                     │              │    └── const: ''
                     │                                                                          │                                                                     │              ├── const: ''
                     │                                                                          │                                                                     │              ├── const: ''
                     │                                                                          │                                                                     │              └── const: '00000'
                     │                                                                          │                                                                     └── project
                     │                                                                          │                                                                          ├── columns: stmt_loop_5:7
                     │                                                                          │                                                                          ├── project
                     │                                                                          │                                                                          │    ├── columns: i:6
                     │                                                                          │                                                                          │    ├── values
                     │                                                                          │                                                                          │    │    └── tuple
                     │                                                                          │                                                                          │    └── projections
                     │                                                                          │                                                                          │         └── plus [as=i:6]
                     │                                                                          │                                                                          │              ├── _stmt_raise.i:$0
                     │                                                                          │                                                                          │              └── const: 1
                     │                                                                          │                                                                          └── projections
                     │                                                                          │                                                                               └── udf: stmt_loop_5 [as=stmt_loop_5:7]
                     │                                                                          │                                                                                    ├── tail-call
                     │                                                                          │                                                                                    ├── args
                     │                                                                          │                                                                                    │    └── $1: variable: i:6
                     │                                                                          │                                                                                    └── recursive-call
                     │                                                                          └── subquery
                     │                                                                               ├── tail-call
                     │                                                                               └── project
                     │                                                                                    ├── columns: stmt_if_7:12
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: stmt_if_7 [as=stmt_if_7:12]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    └── $1: stmt_if.i:$0
                     │                                                                                              └── body
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: "_stmt_raise_8":8
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: _stmt_raise_8 [as="_stmt_raise_8":8]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    └── $1: stmt_if.i:$0
                     │                                                                                                                  └── body
                     │                                                                                                                       ├── project
                     │                                                                                                                       │    ├── columns: stmt_raise_9:5
                     │                                                                                                                       │    ├── values
                     │                                                                                                                       │    │    └── tuple
                     │                                                                                                                       │    └── projections
                     │                                                                                                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_9:5]
                     │                                                                                                                       │              ├── const: 'NOTICE'
                     │                                                                                                                       │              ├── concat
                     │                                                                                                                       │              │    ├── concat
                     │                                                                                                                       │              │    │    ├── const: 'i = '
                     │                                                                                                                       │              │    │    └── coalesce
                     │                                                                                                                       │              │    │         ├── cast: STRING
                     │                                                                                                                       │              │    │         │    └── _stmt_raise.i:$0
                     │                                                                                                                       │              │    │         └── const: '<NULL>'
                     │                                                                                                                       │              │    └── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              └── const: '00000'
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: stmt_loop_5:7
                     │                                                                                                                            ├── project
                     │                                                                                                                            │    ├── columns: i:6
                     │                                                                                                                            │    ├── values
                     │                                                                                                                            │    │    └── tuple
                     │                                                                                                                            │    └── projections
                     │                                                                                                                            │         └── plus [as=i:6]
                     │                                                                                                                            │              ├── _stmt_raise.i:$0
                     │                                                                                                                            │              └── const: 1
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── udf: stmt_loop_5 [as=stmt_loop_5:7]
                     │                                                                                                                                      ├── tail-call
                     │                                                                                                                                      ├── args
                     │                                                                                                                                      │    └── $1: variable: i:6
                     │                                                                                                                                      └── recursive-call
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION USING ERRCODE = 'division_by_zero';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: 'division_by_zero'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: 'division_by_zero'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION USING ERRCODE = '22012';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: '22012'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '22012'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE EXCEPTION USING DETAIL = 'use default errcode for the code and message';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: 'P0001'
                     │                   │              ├── const: 'use default errcode for the code and message'
                     │                   │              ├── const: ''
                     │                   │              └── const: 'P0001'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE 'foo';
    return 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:4
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:4]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":3
                     ├── project
                     │    ├── columns: "_stmt_raise_1":3
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":3]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1]
                     │                   │              ├── const: 'ERROR'
                     │                   │              ├── const: 'foo'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: 'P0001'
                     │                   └── project
                     │                        ├── columns: stmt_return_3:2!null
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── const: 0 [as=stmt_return_3:2]
                     └── const: 1

# Testing IF statements with ELSIF branches.
exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS INT AS $$
  DECLARE
    i INT := -1;
  BEGIN
    IF n = 0 THEN
      RETURN 0;
    ELSIF n = 1 THEN
      i := 100;
    ELSIF n = 2 THEN
      i := 200;
      RETURN i;
    END IF;
    RETURN i;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0);
----
project
 ├── columns: f:10
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:10]
           ├── args
           │    └── $1: const: 0
           └── body
                └── limit
                     ├── columns: stmt_if_5:9
                     ├── project
                     │    ├── columns: stmt_if_5:9
                     │    ├── project
                     │    │    ├── columns: i:1!null
                     │    │    ├── values
                     │    │    │    └── tuple
                     │    │    └── projections
                     │    │         └── const: -1 [as=i:1]
                     │    └── projections
                     │         └── case [as=stmt_if_5:9]
                     │              ├── true
                     │              ├── when
                     │              │    ├── eq
                     │              │    │    ├── f.n:$1
                     │              │    │    └── const: 0
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_return_3:3!null
                     │              │              ├── values
                     │              │              │    └── tuple
                     │              │              └── projections
                     │              │                   └── const: 0 [as=stmt_return_3:3]
                     │              ├── when
                     │              │    ├── eq
                     │              │    │    ├── f.n:$1
                     │              │    │    └── const: 1
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_if_1:5
                     │              │              ├── project
                     │              │              │    ├── columns: i:4!null
                     │              │              │    ├── values
                     │              │              │    │    └── tuple
                     │              │              │    └── projections
                     │              │              │         └── const: 100 [as=i:4]
                     │              │              └── projections
                     │              │                   └── udf: stmt_if_1 [as=stmt_if_1:5]
                     │              │                        ├── tail-call
                     │              │                        ├── args
                     │              │                        │    ├── $1: f.n:$1
                     │              │                        │    └── $2: variable: i:4
                     │              │                        └── body
                     │              │                             └── project
                     │              │                                  ├── columns: stmt_return_2:2
                     │              │                                  ├── values
                     │              │                                  │    └── tuple
                     │              │                                  └── projections
                     │              │                                       └── stmt_if.i:$1 [as=stmt_return_2:2]
                     │              ├── when
                     │              │    ├── eq
                     │              │    │    ├── f.n:$1
                     │              │    │    └── const: 2
                     │              │    └── subquery
                     │              │         └── project
                     │              │              ├── columns: stmt_return_4:7!null
                     │              │              ├── project
                     │              │              │    ├── columns: i:6!null
                     │              │              │    ├── values
                     │              │              │    │    └── tuple
                     │              │              │    └── projections
                     │              │              │         └── const: 200 [as=i:6]
                     │              │              └── projections
                     │              │                   └── variable: i:6 [as=stmt_return_4:7]
                     │              └── subquery
                     │                   └── project
                     │                        ├── columns: stmt_if_1:8
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:8]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: f.n:$1
                     │                                  │    └── $2: variable: i:1
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_2:2
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── stmt_if.i:$1 [as=stmt_return_2:2]
                     └── const: 1

# Testing EXCEPTION blocks.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RETURN 1 // 0;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN 100;
    WHEN invalid_regular_expression THEN
      RETURN 200;
    WHEN SQLSTATE '2200C' THEN
      RETURN 300;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:6
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:6]
           └── body
                └── limit
                     ├── columns: nested_block_7:5
                     ├── project
                     │    ├── columns: nested_block_7:5
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: nested_block_7 [as=nested_block_7:5]
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_return_8:4!null
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── floor-div [as=stmt_return_8:4]
                     │              │                   ├── const: 1
                     │              │                   └── const: 0
                     │              └── exception-handler
                     │                   ├── SQLSTATE '22012'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_2:1!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 100 [as=stmt_return_2:1]
                     │                   ├── SQLSTATE '2201B'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_4:2!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 200 [as=stmt_return_4:2]
                     │                   └── SQLSTATE '2200C'
                     │                        └── project
                     │                             ├── columns: stmt_return_6:3!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: 300 [as=stmt_return_6:3]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(i INT) RETURNS INT AS $$
  BEGIN
    IF i > 0 THEN
      RETURN 1 // 0;
    ELSE
      RETURN sqrt(i::FLOAT)::INT;
    END IF;
  EXCEPTION
    WHEN SQLSTATE '22012' OR indicator_overflow THEN
      RETURN 100;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0);
----
project
 ├── columns: f:9
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:9]
           ├── args
           │    └── $1: const: 0
           └── body
                └── limit
                     ├── columns: nested_block_3:8
                     ├── project
                     │    ├── columns: nested_block_3:8
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: nested_block_3 [as=nested_block_3:8]
                     │              ├── args
                     │              │    └── $1: f.i:$1
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_if_10:7
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── case [as=stmt_if_10:7]
                     │              │                   ├── true
                     │              │                   ├── when
                     │              │                   │    ├── gt
                     │              │                   │    │    ├── nested_block.i:$0
                     │              │                   │    │    └── const: 0
                     │              │                   │    └── subquery
                     │              │                   │         ├── tail-call
                     │              │                   │         └── project
                     │              │                   │              ├── columns: stmt_return_8:5!null
                     │              │                   │              ├── values
                     │              │                   │              │    └── tuple
                     │              │                   │              └── projections
                     │              │                   │                   └── floor-div [as=stmt_return_8:5]
                     │              │                   │                        ├── const: 1
                     │              │                   │                        └── const: 0
                     │              │                   └── subquery
                     │              │                        ├── tail-call
                     │              │                        └── project
                     │              │                             ├── columns: stmt_return_9:6
                     │              │                             ├── values
                     │              │                             │    └── tuple
                     │              │                             └── projections
                     │              │                                  └── cast: INT8 [as=stmt_return_9:6]
                     │              │                                       └── function: sqrt
                     │              │                                            └── cast: FLOAT8
                     │              │                                                 └── nested_block.i:$0
                     │              └── exception-handler
                     │                   ├── SQLSTATE '22012'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_2:1!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 100 [as=stmt_return_2:1]
                     │                   └── SQLSTATE '22022'
                     │                        └── project
                     │                             ├── columns: stmt_return_2:1!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: 100 [as=stmt_return_2:1]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(i INT) RETURNS INT AS $$
  BEGIN
    IF i > 0 THEN
      RETURN 1 // 0;
    ELSE
      RETURN sqrt(i::FLOAT)::INT;
    END IF;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN 100;
    WHEN SQLSTATE '22022' THEN
      RETURN -1;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0);
----
project
 ├── columns: f:10
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:10]
           ├── args
           │    └── $1: const: 0
           └── body
                └── limit
                     ├── columns: nested_block_5:9
                     ├── project
                     │    ├── columns: nested_block_5:9
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: nested_block_5 [as=nested_block_5:9]
                     │              ├── args
                     │              │    └── $1: f.i:$1
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_if_12:8
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── case [as=stmt_if_12:8]
                     │              │                   ├── true
                     │              │                   ├── when
                     │              │                   │    ├── gt
                     │              │                   │    │    ├── nested_block.i:$0
                     │              │                   │    │    └── const: 0
                     │              │                   │    └── subquery
                     │              │                   │         ├── tail-call
                     │              │                   │         └── project
                     │              │                   │              ├── columns: stmt_return_10:6!null
                     │              │                   │              ├── values
                     │              │                   │              │    └── tuple
                     │              │                   │              └── projections
                     │              │                   │                   └── floor-div [as=stmt_return_10:6]
                     │              │                   │                        ├── const: 1
                     │              │                   │                        └── const: 0
                     │              │                   └── subquery
                     │              │                        ├── tail-call
                     │              │                        └── project
                     │              │                             ├── columns: stmt_return_11:7
                     │              │                             ├── values
                     │              │                             │    └── tuple
                     │              │                             └── projections
                     │              │                                  └── cast: INT8 [as=stmt_return_11:7]
                     │              │                                       └── function: sqrt
                     │              │                                            └── cast: FLOAT8
                     │              │                                                 └── nested_block.i:$0
                     │              └── exception-handler
                     │                   ├── SQLSTATE '22012'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_2:1!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 100 [as=stmt_return_2:1]
                     │                   └── SQLSTATE '22022'
                     │                        └── project
                     │                             ├── columns: stmt_return_4:2!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: -1 [as=stmt_return_4:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RAISE division_by_zero;
    RETURN 0;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN 101;
    WHEN SQLSTATE '22P02' THEN
      RETURN 102;
    WHEN invalid_binary_representation THEN
      RETURN 103;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:8
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:8]
           └── body
                └── limit
                     ├── columns: nested_block_7:7
                     ├── project
                     │    ├── columns: nested_block_7:7
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: nested_block_7 [as=nested_block_7:7]
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: "_stmt_raise_8":6
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── udf: _stmt_raise_8 [as="_stmt_raise_8":6]
                     │              │                   ├── tail-call
                     │              │                   └── body
                     │              │                        ├── project
                     │              │                        │    ├── columns: stmt_raise_9:4
                     │              │                        │    ├── values
                     │              │                        │    │    └── tuple
                     │              │                        │    └── projections
                     │              │                        │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_9:4]
                     │              │                        │              ├── const: 'ERROR'
                     │              │                        │              ├── const: 'division_by_zero'
                     │              │                        │              ├── const: ''
                     │              │                        │              ├── const: ''
                     │              │                        │              └── const: 'division_by_zero'
                     │              │                        └── project
                     │              │                             ├── columns: stmt_return_10:5!null
                     │              │                             ├── values
                     │              │                             │    └── tuple
                     │              │                             └── projections
                     │              │                                  └── const: 0 [as=stmt_return_10:5]
                     │              └── exception-handler
                     │                   ├── SQLSTATE '22012'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_2:1!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 101 [as=stmt_return_2:1]
                     │                   ├── SQLSTATE '22P02'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_4:2!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: 102 [as=stmt_return_4:2]
                     │                   └── SQLSTATE '22P03'
                     │                        └── project
                     │                             ├── columns: stmt_return_6:3!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: 103 [as=stmt_return_6:3]
                     └── const: 1

# The exception block does not catch errors thrown during variable declaration.
exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS INT AS $$
  DECLARE
    i INT := 100 // n;
  BEGIN
    RETURN i;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN 101;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0);
----
project
 ├── columns: f:5
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:5]
           ├── args
           │    └── $1: const: 0
           └── body
                └── limit
                     ├── columns: nested_block_3:4
                     ├── project
                     │    ├── columns: nested_block_3:4
                     │    ├── barrier
                     │    │    ├── columns: i:1
                     │    │    └── project
                     │    │         ├── columns: i:1
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── floor-div [as=i:1]
                     │    │                   ├── const: 100
                     │    │                   └── f.n:$1
                     │    └── projections
                     │         └── udf: nested_block_3 [as=nested_block_3:4]
                     │              ├── args
                     │              │    ├── $1: f.n:$1
                     │              │    └── $2: variable: i:1
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_return_4:3
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── nested_block.i:$1 [as=stmt_return_4:3]
                     │              └── exception-handler
                     │                   └── SQLSTATE '22012'
                     │                        └── project
                     │                             ├── columns: stmt_return_2:2!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: 101 [as=stmt_return_2:2]
                     └── const: 1

# Each variable assignment is wrapped in an exception handler.
exec-ddl
CREATE OR REPLACE FUNCTION f(i INT, j INT, k INT) RETURNS INT AS $$
  DECLARE
    x INT := 0;
  BEGIN
    x := 1 // i;
    x := 2 // j;
    x := 3 // k;
    RETURN x;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN x;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0, 0, 0);
----
project
 ├── columns: f:34
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:34]
           ├── args
           │    ├── const: 0
           │    ├── const: 0
           │    └── const: 0
           ├── params: i:1 j:2 k:3
           └── body
                └── limit
                     ├── columns: nested_block_3:33
                     ├── project
                     │    ├── columns: nested_block_3:33
                     │    ├── barrier
                     │    │    ├── columns: x:4!null
                     │    │    └── project
                     │    │         ├── columns: x:4!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 0 [as=x:4]
                     │    └── projections
                     │         └── udf: nested_block_3 [as=nested_block_3:33]
                     │              ├── args
                     │              │    ├── variable: i:1
                     │              │    ├── variable: j:2
                     │              │    ├── variable: k:3
                     │              │    └── variable: x:4
                     │              ├── params: i:10 j:11 k:12 x:13
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: assign_exception_block_4:32
                     │              │         ├── barrier
                     │              │         │    ├── columns: x:14
                     │              │         │    └── project
                     │              │         │         ├── columns: x:14
                     │              │         │         ├── values
                     │              │         │         │    └── tuple
                     │              │         │         └── projections
                     │              │         │              └── floor-div [as=x:14]
                     │              │         │                   ├── const: 1
                     │              │         │                   └── variable: i:10
                     │              │         └── projections
                     │              │              └── udf: assign_exception_block_4 [as=assign_exception_block_4:32]
                     │              │                   ├── tail-call
                     │              │                   ├── args
                     │              │                   │    ├── variable: i:10
                     │              │                   │    ├── variable: j:11
                     │              │                   │    ├── variable: k:12
                     │              │                   │    └── variable: x:14
                     │              │                   ├── params: i:15 j:16 k:17 x:18
                     │              │                   └── body
                     │              │                        └── project
                     │              │                             ├── columns: assign_exception_block_5:31
                     │              │                             ├── barrier
                     │              │                             │    ├── columns: x:19
                     │              │                             │    └── project
                     │              │                             │         ├── columns: x:19
                     │              │                             │         ├── values
                     │              │                             │         │    └── tuple
                     │              │                             │         └── projections
                     │              │                             │              └── floor-div [as=x:19]
                     │              │                             │                   ├── const: 2
                     │              │                             │                   └── variable: j:16
                     │              │                             └── projections
                     │              │                                  └── udf: assign_exception_block_5 [as=assign_exception_block_5:31]
                     │              │                                       ├── tail-call
                     │              │                                       ├── args
                     │              │                                       │    ├── variable: i:15
                     │              │                                       │    ├── variable: j:16
                     │              │                                       │    ├── variable: k:17
                     │              │                                       │    └── variable: x:19
                     │              │                                       ├── params: i:20 j:21 k:22 x:23
                     │              │                                       └── body
                     │              │                                            └── project
                     │              │                                                 ├── columns: assign_exception_block_6:30
                     │              │                                                 ├── barrier
                     │              │                                                 │    ├── columns: x:24
                     │              │                                                 │    └── project
                     │              │                                                 │         ├── columns: x:24
                     │              │                                                 │         ├── values
                     │              │                                                 │         │    └── tuple
                     │              │                                                 │         └── projections
                     │              │                                                 │              └── floor-div [as=x:24]
                     │              │                                                 │                   ├── const: 3
                     │              │                                                 │                   └── variable: k:22
                     │              │                                                 └── projections
                     │              │                                                      └── udf: assign_exception_block_6 [as=assign_exception_block_6:30]
                     │              │                                                           ├── tail-call
                     │              │                                                           ├── args
                     │              │                                                           │    ├── variable: i:20
                     │              │                                                           │    ├── variable: j:21
                     │              │                                                           │    ├── variable: k:22
                     │              │                                                           │    └── variable: x:24
                     │              │                                                           ├── params: i:25 j:26 k:27 x:28
                     │              │                                                           └── body
                     │              │                                                                └── project
                     │              │                                                                     ├── columns: stmt_return_7:29
                     │              │                                                                     ├── values
                     │              │                                                                     │    └── tuple
                     │              │                                                                     └── projections
                     │              │                                                                          └── variable: x:28 [as=stmt_return_7:29]
                     │              └── exception-handler
                     │                   └── SQLSTATE '22012'
                     │                        └── project
                     │                             ├── columns: stmt_return_2:9
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── variable: x:8 [as=stmt_return_2:9]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(i INT) RETURNS INT AS $$
  DECLARE
    x INT;
  BEGIN
    IF i = 0 THEN
      x := 100;
      RAISE division_by_zero;
    ELSE
      x := 200;
      RAISE division_by_zero;
    END IF;
    RETURN 0;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN x;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0);
----
project
 ├── columns: f:16
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:16]
           ├── args
           │    └── $1: const: 0
           └── body
                └── limit
                     ├── columns: nested_block_3:15
                     ├── project
                     │    ├── columns: nested_block_3:15
                     │    ├── barrier
                     │    │    ├── columns: x:1
                     │    │    └── project
                     │    │         ├── columns: x:1
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── cast: INT8 [as=x:1]
                     │    │                   └── null
                     │    └── projections
                     │         └── udf: nested_block_3 [as=nested_block_3:15]
                     │              ├── args
                     │              │    ├── $1: f.i:$1
                     │              │    └── $2: variable: x:1
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_if_12:14
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── case [as=stmt_if_12:14]
                     │              │                   ├── true
                     │              │                   ├── when
                     │              │                   │    ├── eq
                     │              │                   │    │    ├── nested_block.i:$0
                     │              │                   │    │    └── const: 0
                     │              │                   │    └── subquery
                     │              │                   │         ├── tail-call
                     │              │                   │         └── project
                     │              │                   │              ├── columns: assign_exception_block_6:8
                     │              │                   │              ├── barrier
                     │              │                   │              │    ├── columns: x:4!null
                     │              │                   │              │    └── project
                     │              │                   │              │         ├── columns: x:4!null
                     │              │                   │              │         ├── values
                     │              │                   │              │         │    └── tuple
                     │              │                   │              │         └── projections
                     │              │                   │              │              └── const: 100 [as=x:4]
                     │              │                   │              └── projections
                     │              │                   │                   └── udf: assign_exception_block_6 [as=assign_exception_block_6:8]
                     │              │                   │                        ├── tail-call
                     │              │                   │                        ├── args
                     │              │                   │                        │    ├── $1: nested_block.i:$0
                     │              │                   │                        │    └── $2: variable: x:4
                     │              │                   │                        └── body
                     │              │                   │                             └── project
                     │              │                   │                                  ├── columns: "_stmt_raise_7":7
                     │              │                   │                                  ├── values
                     │              │                   │                                  │    └── tuple
                     │              │                   │                                  └── projections
                     │              │                   │                                       └── udf: _stmt_raise_7 [as="_stmt_raise_7":7]
                     │              │                   │                                            ├── tail-call
                     │              │                   │                                            ├── args
                     │              │                   │                                            │    ├── $1: assign_exception_block.i:$0
                     │              │                   │                                            │    └── $2: assign_exception_block.x:$1
                     │              │                   │                                            └── body
                     │              │                   │                                                 ├── project
                     │              │                   │                                                 │    ├── columns: stmt_raise_8:5
                     │              │                   │                                                 │    ├── values
                     │              │                   │                                                 │    │    └── tuple
                     │              │                   │                                                 │    └── projections
                     │              │                   │                                                 │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:5]
                     │              │                   │                                                 │              ├── const: 'ERROR'
                     │              │                   │                                                 │              ├── const: 'division_by_zero'
                     │              │                   │                                                 │              ├── const: ''
                     │              │                   │                                                 │              ├── const: ''
                     │              │                   │                                                 │              └── const: 'division_by_zero'
                     │              │                   │                                                 └── project
                     │              │                   │                                                      ├── columns: stmt_if_4:6
                     │              │                   │                                                      ├── values
                     │              │                   │                                                      │    └── tuple
                     │              │                   │                                                      └── projections
                     │              │                   │                                                           └── udf: stmt_if_4 [as=stmt_if_4:6]
                     │              │                   │                                                                ├── tail-call
                     │              │                   │                                                                ├── args
                     │              │                   │                                                                │    ├── $1: _stmt_raise.i:$0
                     │              │                   │                                                                │    └── $2: _stmt_raise.x:$1
                     │              │                   │                                                                └── body
                     │              │                   │                                                                     └── project
                     │              │                   │                                                                          ├── columns: stmt_return_5:3!null
                     │              │                   │                                                                          ├── values
                     │              │                   │                                                                          │    └── tuple
                     │              │                   │                                                                          └── projections
                     │              │                   │                                                                               └── const: 0 [as=stmt_return_5:3]
                     │              │                   └── subquery
                     │              │                        ├── tail-call
                     │              │                        └── project
                     │              │                             ├── columns: assign_exception_block_9:13
                     │              │                             ├── barrier
                     │              │                             │    ├── columns: x:9!null
                     │              │                             │    └── project
                     │              │                             │         ├── columns: x:9!null
                     │              │                             │         ├── values
                     │              │                             │         │    └── tuple
                     │              │                             │         └── projections
                     │              │                             │              └── const: 200 [as=x:9]
                     │              │                             └── projections
                     │              │                                  └── udf: assign_exception_block_9 [as=assign_exception_block_9:13]
                     │              │                                       ├── tail-call
                     │              │                                       ├── args
                     │              │                                       │    ├── $1: nested_block.i:$0
                     │              │                                       │    └── $2: variable: x:9
                     │              │                                       └── body
                     │              │                                            └── project
                     │              │                                                 ├── columns: "_stmt_raise_10":12
                     │              │                                                 ├── values
                     │              │                                                 │    └── tuple
                     │              │                                                 └── projections
                     │              │                                                      └── udf: _stmt_raise_10 [as="_stmt_raise_10":12]
                     │              │                                                           ├── tail-call
                     │              │                                                           ├── args
                     │              │                                                           │    ├── $1: assign_exception_block.i:$0
                     │              │                                                           │    └── $2: assign_exception_block.x:$1
                     │              │                                                           └── body
                     │              │                                                                ├── project
                     │              │                                                                │    ├── columns: stmt_raise_11:10
                     │              │                                                                │    ├── values
                     │              │                                                                │    │    └── tuple
                     │              │                                                                │    └── projections
                     │              │                                                                │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_11:10]
                     │              │                                                                │              ├── const: 'ERROR'
                     │              │                                                                │              ├── const: 'division_by_zero'
                     │              │                                                                │              ├── const: ''
                     │              │                                                                │              ├── const: ''
                     │              │                                                                │              └── const: 'division_by_zero'
                     │              │                                                                └── project
                     │              │                                                                     ├── columns: stmt_if_4:11
                     │              │                                                                     ├── values
                     │              │                                                                     │    └── tuple
                     │              │                                                                     └── projections
                     │              │                                                                          └── udf: stmt_if_4 [as=stmt_if_4:11]
                     │              │                                                                               ├── tail-call
                     │              │                                                                               ├── args
                     │              │                                                                               │    ├── $1: _stmt_raise.i:$0
                     │              │                                                                               │    └── $2: _stmt_raise.x:$1
                     │              │                                                                               └── body
                     │              │                                                                                    └── project
                     │              │                                                                                         ├── columns: stmt_return_5:3!null
                     │              │                                                                                         ├── values
                     │              │                                                                                         │    └── tuple
                     │              │                                                                                         └── projections
                     │              │                                                                                              └── const: 0 [as=stmt_return_5:3]
                     │              └── exception-handler
                     │                   └── SQLSTATE '22012'
                     │                        └── project
                     │                             ├── columns: stmt_return_2:2
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── exception_handler.x:$1 [as=stmt_return_2:2]
                     └── const: 1

exec-ddl
CREATE OR REPLACE FUNCTION f(n INT, a INT) RETURNS INT AS $$
  DECLARE
    x INT;
    i INT := 0;
  BEGIN
    LOOP IF i >= n THEN EXIT; END IF;
      x := 1 // (i - a);
      i := i + 1;
    END LOOP;
    RETURN -1;
  EXCEPTION
    WHEN division_by_zero THEN
      RETURN i;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f(0, 0);
----
project
 ├── columns: f:15
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:15]
           ├── args
           │    ├── $1: const: 0
           │    └── $2: const: 0
           └── body
                └── limit
                     ├── columns: nested_block_3:14
                     ├── project
                     │    ├── columns: nested_block_3:14
                     │    ├── barrier
                     │    │    ├── columns: x:1 i:2!null
                     │    │    └── project
                     │    │         ├── columns: i:2!null x:1
                     │    │         ├── project
                     │    │         │    ├── columns: x:1
                     │    │         │    ├── values
                     │    │         │    │    └── tuple
                     │    │         │    └── projections
                     │    │         │         └── cast: INT8 [as=x:1]
                     │    │         │              └── null
                     │    │         └── projections
                     │    │              └── const: 0 [as=i:2]
                     │    └── projections
                     │         └── udf: nested_block_3 [as=nested_block_3:14]
                     │              ├── args
                     │              │    ├── $1: f.n:$1
                     │              │    ├── $2: variable: x:1
                     │              │    └── $3: variable: i:2
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_loop_6:13
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── udf: stmt_loop_6 [as=stmt_loop_6:13]
                     │              │                   ├── tail-call
                     │              │                   ├── args
                     │              │                   │    ├── $1: nested_block.n:$0
                     │              │                   │    └── $2: nested_block.x:$2
                     │              │                   └── body
                     │              │                        └── project
                     │              │                             ├── columns: stmt_if_10:12
                     │              │                             ├── values
                     │              │                             │    └── tuple
                     │              │                             └── projections
                     │              │                                  └── case [as=stmt_if_10:12]
                     │              │                                       ├── true
                     │              │                                       ├── when
                     │              │                                       │    ├── ge
                     │              │                                       │    │    ├── stmt_loop.i:$3
                     │              │                                       │    │    └── stmt_loop.n:$0
                     │              │                                       │    └── subquery
                     │              │                                       │         ├── tail-call
                     │              │                                       │         └── project
                     │              │                                       │              ├── columns: loop_exit_4:10
                     │              │                                       │              ├── values
                     │              │                                       │              │    └── tuple
                     │              │                                       │              └── projections
                     │              │                                       │                   └── udf: loop_exit_4 [as=loop_exit_4:10]
                     │              │                                       │                        ├── tail-call
                     │              │                                       │                        ├── args
                     │              │                                       │                        │    ├── $1: stmt_loop.n:$0
                     │              │                                       │                        │    └── $2: stmt_loop.x:$2
                     │              │                                       │                        └── body
                     │              │                                       │                             └── project
                     │              │                                       │                                  ├── columns: stmt_return_5:4!null
                     │              │                                       │                                  ├── values
                     │              │                                       │                                  │    └── tuple
                     │              │                                       │                                  └── projections
                     │              │                                       │                                       └── const: -1 [as=stmt_return_5:4]
                     │              │                                       └── subquery
                     │              │                                            ├── tail-call
                     │              │                                            └── project
                     │              │                                                 ├── columns: stmt_if_7:11
                     │              │                                                 ├── values
                     │              │                                                 │    └── tuple
                     │              │                                                 └── projections
                     │              │                                                      └── udf: stmt_if_7 [as=stmt_if_7:11]
                     │              │                                                           ├── tail-call
                     │              │                                                           ├── args
                     │              │                                                           │    ├── $1: stmt_loop.n:$0
                     │              │                                                           │    └── $2: stmt_loop.x:$2
                     │              │                                                           └── body
                     │              │                                                                └── project
                     │              │                                                                     ├── columns: assign_exception_block_8:9
                     │              │                                                                     ├── barrier
                     │              │                                                                     │    ├── columns: x:5
                     │              │                                                                     │    └── project
                     │              │                                                                     │         ├── columns: x:5
                     │              │                                                                     │         ├── values
                     │              │                                                                     │         │    └── tuple
                     │              │                                                                     │         └── projections
                     │              │                                                                     │              └── floor-div [as=x:5]
                     │              │                                                                     │                   ├── const: 1
                     │              │                                                                     │                   └── minus
                     │              │                                                                     │                        ├── stmt_if.i:$3
                     │              │                                                                     │                        └── stmt_if.a:$1
                     │              │                                                                     └── projections
                     │              │                                                                          └── udf: assign_exception_block_8 [as=assign_exception_block_8:9]
                     │              │                                                                               ├── tail-call
                     │              │                                                                               ├── args
                     │              │                                                                               │    ├── $1: stmt_if.n:$0
                     │              │                                                                               │    ├── $2: variable: x:5
                     │              │                                                                               │    └── $3: stmt_if.i:$3
                     │              │                                                                               └── body
                     │              │                                                                                    └── project
                     │              │                                                                                         ├── columns: assign_exception_block_9:8
                     │              │                                                                                         ├── barrier
                     │              │                                                                                         │    ├── columns: i:6
                     │              │                                                                                         │    └── project
                     │              │                                                                                         │         ├── columns: i:6
                     │              │                                                                                         │         ├── values
                     │              │                                                                                         │         │    └── tuple
                     │              │                                                                                         │         └── projections
                     │              │                                                                                         │              └── plus [as=i:6]
                     │              │                                                                                         │                   ├── assign_exception_block.i:$3
                     │              │                                                                                         │                   └── const: 1
                     │              │                                                                                         └── projections
                     │              │                                                                                              └── udf: assign_exception_block_9 [as=assign_exception_block_9:8]
                     │              │                                                                                                   ├── tail-call
                     │              │                                                                                                   ├── args
                     │              │                                                                                                   │    ├── $1: assign_exception_block.n:$0
                     │              │                                                                                                   │    └── $2: assign_exception_block.x:$2
                     │              │                                                                                                   └── body
                     │              │                                                                                                        └── project
                     │              │                                                                                                             ├── columns: stmt_loop_6:7
                     │              │                                                                                                             ├── values
                     │              │                                                                                                             │    └── tuple
                     │              │                                                                                                             └── projections
                     │              │                                                                                                                  └── udf: stmt_loop_6 [as=stmt_loop_6:7]
                     │              │                                                                                                                       ├── tail-call
                     │              │                                                                                                                       ├── args
                     │              │                                                                                                                       │    ├── $1: assign_exception_block.n:$0
                     │              │                                                                                                                       │    └── $2: assign_exception_block.x:$2
                     │              │                                                                                                                       └── recursive-call
                     │              └── exception-handler
                     │                   └── SQLSTATE '22012'
                     │                        └── project
                     │                             ├── columns: stmt_return_2:3
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── exception_handler.i:$3 [as=stmt_return_2:3]
                     └── const: 1

# Testing SQL statement execution.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    INSERT INTO kv VALUES (100, 100);
    DELETE FROM kv WHERE k = 100;
    INSERT INTO kv VALUES (100, 100);
    RETURN (SELECT v FROM kv WHERE k = 100);
  END
$$ LANGUAGE PLpgSQL;
----

# TODO(#115681): add norm rule to fold the non-output body statements of nested
# routines.
build format=show-scalars
SELECT f();
----
project
 ├── columns: f:29
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:29]
           └── body
                └── limit
                     ├── columns: "_stmt_exec_1":28
                     ├── project
                     │    ├── columns: "_stmt_exec_1":28
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":28]
                     │              └── body
                     │                   ├── insert kv
                     │                   │    ├── columns: <none>
                     │                   │    ├── insert-mapping:
                     │                   │    │    ├── column1:5 => k:1
                     │                   │    │    └── column2:6 => v:2
                     │                   │    └── values
                     │                   │         ├── columns: column1:5!null column2:6!null
                     │                   │         └── tuple
                     │                   │              ├── const: 100
                     │                   │              └── const: 100
                     │                   └── project
                     │                        ├── columns: "_stmt_exec_2":27
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_exec_2 [as="_stmt_exec_2":27]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       ├── delete kv
                     │                                       │    ├── columns: <none>
                     │                                       │    ├── fetch columns: k:11 v:12
                     │                                       │    └── select
                     │                                       │         ├── columns: k:11!null v:12 crdb_internal_mvcc_timestamp:13 tableoid:14
                     │                                       │         ├── scan kv
                     │                                       │         │    ├── columns: k:11!null v:12 crdb_internal_mvcc_timestamp:13 tableoid:14
                     │                                       │         │    └── flags: avoid-full-scan
                     │                                       │         └── filters
                     │                                       │              └── eq
                     │                                       │                   ├── variable: k:11
                     │                                       │                   └── const: 100
                     │                                       └── project
                     │                                            ├── columns: "_stmt_exec_3":26
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_exec_3 [as="_stmt_exec_3":26]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── insert kv
                     │                                                           │    ├── columns: <none>
                     │                                                           │    ├── insert-mapping:
                     │                                                           │    │    ├── column1:19 => k:15
                     │                                                           │    │    └── column2:20 => v:16
                     │                                                           │    └── values
                     │                                                           │         ├── columns: column1:19!null column2:20!null
                     │                                                           │         └── tuple
                     │                                                           │              ├── const: 100
                     │                                                           │              └── const: 100
                     │                                                           └── project
                     │                                                                ├── columns: stmt_return_4:25
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── subquery [as=stmt_return_4:25]
                     │                                                                          ├── tail-call
                     │                                                                          └── max1-row
                     │                                                                               ├── columns: v:22
                     │                                                                               └── project
                     │                                                                                    ├── columns: v:22
                     │                                                                                    └── select
                     │                                                                                         ├── columns: k:21!null v:22 crdb_internal_mvcc_timestamp:23 tableoid:24
                     │                                                                                         ├── scan kv
                     │                                                                                         │    └── columns: k:21!null v:22 crdb_internal_mvcc_timestamp:23 tableoid:24
                     │                                                                                         └── filters
                     │                                                                                              └── eq
                     │                                                                                                   ├── variable: k:21
                     │                                                                                                   └── const: 100
                     └── const: 1

# Testing SELECT INTO.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT;
    j INT;
  BEGIN
    SELECT x, y INTO i, j FROM xy ORDER BY x DESC;
    RETURN i + j;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:17
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:17]
           └── body
                └── limit
                     ├── columns: "_stmt_exec_1":16
                     ├── project
                     │    ├── columns: "_stmt_exec_1":16
                     │    ├── project
                     │    │    ├── columns: j:2 i:1
                     │    │    ├── project
                     │    │    │    ├── columns: i:1
                     │    │    │    ├── values
                     │    │    │    │    └── tuple
                     │    │    │    └── projections
                     │    │    │         └── cast: INT8 [as=i:1]
                     │    │    │              └── null
                     │    │    └── projections
                     │    │         └── cast: INT8 [as=j:2]
                     │    │              └── null
                     │    └── projections
                     │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":16]
                     │              ├── args
                     │              │    ├── variable: i:1
                     │              │    └── variable: j:2
                     │              ├── params: i:3 j:4
                     │              └── body
                     │                   └── project
                     │                        ├── columns: "_stmt_exec_ret_2":15
                     │                        ├── project
                     │                        │    ├── columns: i:13 j:14
                     │                        │    ├── right-join (cross)
                     │                        │    │    ├── columns: x:5 y:6
                     │                        │    │    ├── limit
                     │                        │    │    │    ├── columns: x:5 y:6
                     │                        │    │    │    ├── internal-ordering: -5
                     │                        │    │    │    ├── project
                     │                        │    │    │    │    ├── columns: x:5 y:6
                     │                        │    │    │    │    └── scan xy
                     │                        │    │    │    │         └── columns: x:5 y:6 rowid:7!null crdb_internal_mvcc_timestamp:8 tableoid:9
                     │                        │    │    │    └── const: 1
                     │                        │    │    ├── values
                     │                        │    │    │    └── tuple
                     │                        │    │    └── filters (true)
                     │                        │    └── projections
                     │                        │         ├── variable: x:5 [as=i:13]
                     │                        │         └── variable: y:6 [as=j:14]
                     │                        └── projections
                     │                             └── udf: _stmt_exec_ret_2 [as="_stmt_exec_ret_2":15]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── variable: i:13
                     │                                  │    └── variable: j:14
                     │                                  ├── params: i:10 j:11
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: stmt_return_3:12
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── plus [as=stmt_return_3:12]
                     │                                                      ├── variable: i:10
                     │                                                      └── variable: j:11
                     └── const: 1

# It is possible to reference a previous value of a target variable in a
# SELECT INTO statement (note the "x < i" filter).
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT;
  BEGIN
    SELECT x INTO i FROM xy ORDER BY x DESC;
    RAISE NOTICE 'i = %', i;
    SELECT x INTO i FROM xy WHERE x < i ORDER BY x DESC;
    RAISE NOTICE 'i = %', i;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:23
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:23]
           └── body
                └── limit
                     ├── columns: "_stmt_exec_1":22
                     ├── project
                     │    ├── columns: "_stmt_exec_1":22
                     │    ├── barrier
                     │    │    ├── columns: i:1
                     │    │    └── project
                     │    │         ├── columns: i:1
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── cast: INT8 [as=i:1]
                     │    │                   └── null
                     │    └── projections
                     │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":22]
                     │              ├── args
                     │              │    └── $1: variable: i:1
                     │              └── body
                     │                   └── project
                     │                        ├── columns: "_stmt_exec_ret_2":21
                     │                        ├── barrier
                     │                        │    ├── columns: i:20
                     │                        │    └── project
                     │                        │         ├── columns: i:20
                     │                        │         ├── right-join (cross)
                     │                        │         │    ├── columns: x:2
                     │                        │         │    ├── limit
                     │                        │         │    │    ├── columns: x:2
                     │                        │         │    │    ├── internal-ordering: -2
                     │                        │         │    │    ├── project
                     │                        │         │    │    │    ├── columns: x:2
                     │                        │         │    │    │    └── scan xy
                     │                        │         │    │    │         └── columns: x:2 y:3 rowid:4!null crdb_internal_mvcc_timestamp:5 tableoid:6
                     │                        │         │    │    └── const: 1
                     │                        │         │    ├── values
                     │                        │         │    │    └── tuple
                     │                        │         │    └── filters (true)
                     │                        │         └── projections
                     │                        │              └── variable: x:2 [as=i:20]
                     │                        └── projections
                     │                             └── udf: _stmt_exec_ret_2 [as="_stmt_exec_ret_2":21]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    └── $1: variable: i:20
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_3":19
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_3 [as="_stmt_raise_3":19]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: _stmt_exec_ret.i:$0
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_4:7
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_4:7]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── concat
                     │                                                           │              │    ├── concat
                     │                                                           │              │    │    ├── const: 'i = '
                     │                                                           │              │    │    └── coalesce
                     │                                                           │              │    │         ├── cast: STRING
                     │                                                           │              │    │         │    └── _stmt_raise.i:$0
                     │                                                           │              │    │         └── const: '<NULL>'
                     │                                                           │              │    └── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_exec_5":18
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_exec_5 [as="_stmt_exec_5":18]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: _stmt_raise.i:$0
                     │                                                                          └── body
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_exec_ret_6":17
                     │                                                                                    ├── barrier
                     │                                                                                    │    ├── columns: i:16
                     │                                                                                    │    └── project
                     │                                                                                    │         ├── columns: i:16
                     │                                                                                    │         ├── right-join (cross)
                     │                                                                                    │         │    ├── columns: x:8
                     │                                                                                    │         │    ├── limit
                     │                                                                                    │         │    │    ├── columns: x:8!null
                     │                                                                                    │         │    │    ├── internal-ordering: -8
                     │                                                                                    │         │    │    ├── project
                     │                                                                                    │         │    │    │    ├── columns: x:8!null
                     │                                                                                    │         │    │    │    └── select
                     │                                                                                    │         │    │    │         ├── columns: x:8!null y:9 rowid:10!null crdb_internal_mvcc_timestamp:11 tableoid:12
                     │                                                                                    │         │    │    │         ├── scan xy
                     │                                                                                    │         │    │    │         │    └── columns: x:8 y:9 rowid:10!null crdb_internal_mvcc_timestamp:11 tableoid:12
                     │                                                                                    │         │    │    │         └── filters
                     │                                                                                    │         │    │    │              └── lt
                     │                                                                                    │         │    │    │                   ├── variable: x:8
                     │                                                                                    │         │    │    │                   └── _stmt_exec.i:$0
                     │                                                                                    │         │    │    └── const: 1
                     │                                                                                    │         │    ├── values
                     │                                                                                    │         │    │    └── tuple
                     │                                                                                    │         │    └── filters (true)
                     │                                                                                    │         └── projections
                     │                                                                                    │              └── variable: x:8 [as=i:16]
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_exec_ret_6 [as="_stmt_exec_ret_6":17]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    └── $1: variable: i:16
                     │                                                                                              └── body
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: "_stmt_raise_7":15
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: _stmt_raise_7 [as="_stmt_raise_7":15]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    └── $1: _stmt_exec_ret.i:$0
                     │                                                                                                                  └── body
                     │                                                                                                                       ├── project
                     │                                                                                                                       │    ├── columns: stmt_raise_8:13
                     │                                                                                                                       │    ├── values
                     │                                                                                                                       │    │    └── tuple
                     │                                                                                                                       │    └── projections
                     │                                                                                                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:13]
                     │                                                                                                                       │              ├── const: 'NOTICE'
                     │                                                                                                                       │              ├── concat
                     │                                                                                                                       │              │    ├── concat
                     │                                                                                                                       │              │    │    ├── const: 'i = '
                     │                                                                                                                       │              │    │    └── coalesce
                     │                                                                                                                       │              │    │         ├── cast: STRING
                     │                                                                                                                       │              │    │         │    └── _stmt_raise.i:$0
                     │                                                                                                                       │              │    │         └── const: '<NULL>'
                     │                                                                                                                       │              │    └── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              ├── const: ''
                     │                                                                                                                       │              └── const: '00000'
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: stmt_return_9:14!null
                     │                                                                                                                            ├── values
                     │                                                                                                                            │    └── tuple
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── const: 0 [as=stmt_return_9:14]
                     └── const: 1

# Testing OPEN statement.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
  BEGIN
    OPEN curs FOR SELECT 1;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
error (42601): "curs" is not a known variable

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT := 3;
    curs REFCURSOR := 'foo';
  BEGIN
    OPEN curs FOR SELECT * FROM xy WHERE x = i;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
error (42601): "curs" is not a known variable

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
    curs2 REFCURSOR := 'bar';
    curs3 REFCURSOR := 'baz';
  BEGIN
    OPEN curs FOR SELECT 1;
    OPEN curs2 FOR SELECT 2;
    OPEN curs3 FOR SELECT 3;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
error (42601): "curs" is not a known variable

# Testing CLOSE statement.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
  BEGIN
    OPEN curs FOR SELECT 1;
    CLOSE curs;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-all
SELECT f();
----
error (42601): "curs" is not a known variable

# Combined exception block and cursors.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
  BEGIN
    OPEN curs FOR SELECT 1;
    RETURN 1 // 0;
  EXCEPTION
    WHEN division_by_zero THEN
      OPEN curs FOR SELECT 2;
      RETURN -1;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
error (42601): "curs" is not a known variable

# Testing FETCH/MOVE.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
    x INT;
  BEGIN
    OPEN curs FOR SELECT * FROM xy ORDER BY x;
    FETCH curs INTO x;
    RETURN x;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-all
SELECT f();
----
error (42601): "curs" is not a known variable

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    curs REFCURSOR := 'foo';
  BEGIN
    OPEN curs FOR SELECT * FROM xy ORDER BY x;
    MOVE curs;
    RETURN 0;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
error (42601): "curs" is not a known variable

# Case with a FETCH into a composite-typed variable.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS xy LANGUAGE PLpgSQL AS $$
  DECLARE
    foo xy;
    bar REFCURSOR;
  BEGIN
    OPEN bar FOR SELECT 1, 2;
    FETCH bar INTO foo;
    RETURN foo;
  END;
$$;
----

build format=(show-scalars,show-types)
SELECT f();
----
error (42601): "bar" is not a known variable

# Correctly display the OTHERS branch.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
    RETURN 1 // 0;
  EXCEPTION
    WHEN assert_failure THEN
      RETURN -1;
    WHEN OTHERS THEN
      RETURN -2;
    WHEN query_canceled THEN
      RETURN -3;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:6
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:6]
           └── body
                └── limit
                     ├── columns: nested_block_7:5
                     ├── project
                     │    ├── columns: nested_block_7:5
                     │    ├── values
                     │    │    └── tuple
                     │    └── projections
                     │         └── udf: nested_block_7 [as=nested_block_7:5]
                     │              ├── body
                     │              │    └── project
                     │              │         ├── columns: stmt_return_8:4!null
                     │              │         ├── values
                     │              │         │    └── tuple
                     │              │         └── projections
                     │              │              └── floor-div [as=stmt_return_8:4]
                     │              │                   ├── const: 1
                     │              │                   └── const: 0
                     │              └── exception-handler
                     │                   ├── SQLSTATE 'P0004'
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_2:1!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: -1 [as=stmt_return_2:1]
                     │                   ├── OTHERS
                     │                   │    └── project
                     │                   │         ├── columns: stmt_return_4:2!null
                     │                   │         ├── values
                     │                   │         │    └── tuple
                     │                   │         └── projections
                     │                   │              └── const: -2 [as=stmt_return_4:2]
                     │                   └── SQLSTATE '57014'
                     │                        └── project
                     │                             ├── columns: stmt_return_6:3!null
                     │                             ├── values
                     │                             │    └── tuple
                     │                             └── projections
                     │                                  └── const: -3 [as=stmt_return_6:3]
                     └── const: 1

# Project a typed NULL for the end-of-function RAISE statement.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  BEGIN
  END
$$ LANGUAGE PLpgSQL;
----

build format=(show-scalars,show-types)
SELECT f();
----
project
 ├── columns: f:4(int)
 ├── values
 │    └── tuple [type=tuple]
 └── projections
      └── udf: f [as=f:4, type=int]
           └── body
                └── limit
                     ├── columns: "_end_of_function_1":3(int)
                     ├── project
                     │    ├── columns: "_end_of_function_1":3(int)
                     │    ├── values
                     │    │    └── tuple [type=tuple]
                     │    └── projections
                     │         └── udf: _end_of_function_1 [as="_end_of_function_1":3, type=int]
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:1(int)
                     │                   │    ├── values
                     │                   │    │    └── tuple [type=tuple]
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:1, type=int]
                     │                   │              ├── const: 'ERROR' [type=string]
                     │                   │              ├── const: 'control reached end of function without RETURN' [type=string]
                     │                   │              ├── const: '' [type=string]
                     │                   │              ├── const: '' [type=string]
                     │                   │              └── const: '2F005' [type=string]
                     │                   └── project
                     │                        ├── columns: end_of_function_3:2(int)
                     │                        ├── values
                     │                        │    └── tuple [type=tuple]
                     │                        └── projections
                     │                             └── null [as=end_of_function_3:2, type=int]
                     └── const: 1 [type=int]

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT AS $$
  DECLARE
    i INT := 0;
  BEGIN
    WHILE i < 10 LOOP
      i := i + 1;
    END LOOP;
  END
$$ LANGUAGE PLpgSQL;
----

build format=(show-scalars,show-types)
SELECT f();
----
project
 ├── columns: f:11(int)
 ├── values
 │    └── tuple [type=tuple]
 └── projections
      └── udf: f [as=f:11, type=int]
           └── body
                └── limit
                     ├── columns: stmt_loop_5:10(int)
                     ├── project
                     │    ├── columns: stmt_loop_5:10(int)
                     │    ├── barrier
                     │    │    ├── columns: i:1(int!null)
                     │    │    └── project
                     │    │         ├── columns: i:1(int!null)
                     │    │         ├── values
                     │    │         │    └── tuple [type=tuple]
                     │    │         └── projections
                     │    │              └── const: 0 [as=i:1, type=int]
                     │    └── projections
                     │         └── udf: stmt_loop_5 [as=stmt_loop_5:10, type=int]
                     │              ├── args
                     │              │    └── $1: variable: i:1 [type=int]
                     │              └── body
                     │                   └── project
                     │                        ├── columns: stmt_if_7:9(int)
                     │                        ├── values
                     │                        │    └── tuple [type=tuple]
                     │                        └── projections
                     │                             └── case [as=stmt_if_7:9, type=int]
                     │                                  ├── true [type=bool]
                     │                                  ├── when [type=int]
                     │                                  │    ├── lt [type=bool]
                     │                                  │    │    ├── stmt_loop.i:$0
                     │                                  │    │    └── const: 10 [type=int]
                     │                                  │    └── subquery [type=int]
                     │                                  │         ├── tail-call
                     │                                  │         └── project
                     │                                  │              ├── columns: stmt_if_6:7(int)
                     │                                  │              ├── project
                     │                                  │              │    ├── columns: i:6(int)
                     │                                  │              │    ├── values
                     │                                  │              │    │    └── tuple [type=tuple]
                     │                                  │              │    └── projections
                     │                                  │              │         └── plus [as=i:6, type=int]
                     │                                  │              │              ├── stmt_loop.i:$0
                     │                                  │              │              └── const: 1 [type=int]
                     │                                  │              └── projections
                     │                                  │                   └── udf: stmt_if_6 [as=stmt_if_6:7, type=int]
                     │                                  │                        ├── tail-call
                     │                                  │                        ├── args
                     │                                  │                        │    └── $1: variable: i:6 [type=int]
                     │                                  │                        └── body
                     │                                  │                             └── project
                     │                                  │                                  ├── columns: stmt_loop_5:5(int)
                     │                                  │                                  ├── values
                     │                                  │                                  │    └── tuple [type=tuple]
                     │                                  │                                  └── projections
                     │                                  │                                       └── udf: stmt_loop_5 [as=stmt_loop_5:5, type=int]
                     │                                  │                                            ├── tail-call
                     │                                  │                                            ├── args
                     │                                  │                                            │    └── $1: stmt_if.i:$0
                     │                                  │                                            └── recursive-call
                     │                                  └── subquery [type=int]
                     │                                       ├── tail-call
                     │                                       └── project
                     │                                            ├── columns: loop_exit_1:8(int)
                     │                                            ├── values
                     │                                            │    └── tuple [type=tuple]
                     │                                            └── projections
                     │                                                 └── udf: loop_exit_1 [as=loop_exit_1:8, type=int]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: stmt_loop.i:$0
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: "_end_of_function_2":4(int)
                     │                                                                ├── values
                     │                                                                │    └── tuple [type=tuple]
                     │                                                                └── projections
                     │                                                                     └── udf: _end_of_function_2 [as="_end_of_function_2":4, type=int]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: loop_exit.i:$0
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_3:2(int)
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple [type=tuple]
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_3:2, type=int]
                     │                                                                               │              ├── const: 'ERROR' [type=string]
                     │                                                                               │              ├── const: 'control reached end of function without RETURN' [type=string]
                     │                                                                               │              ├── const: '' [type=string]
                     │                                                                               │              ├── const: '' [type=string]
                     │                                                                               │              └── const: '2F005' [type=string]
                     │                                                                               └── project
                     │                                                                                    ├── columns: end_of_function_4:3(int)
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple [type=tuple]
                     │                                                                                    └── projections
                     │                                                                                         └── null [as=end_of_function_4:3, type=int]
                     └── const: 1 [type=int]

# Infer return type for a RECORD-returning routine.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS RECORD AS $$
  BEGIN
    RETURN ROW(False);
  END
$$ LANGUAGE PLpgSQL;
----

build format=(show-scalars,show-types)
SELECT f();
----
project
 ├── columns: f:2(tuple{bool})
 ├── values
 │    └── tuple [type=tuple]
 └── projections
      └── udf: f [as=f:2, type=tuple{bool}]
           └── body
                └── limit
                     ├── columns: stmt_return_1:1(tuple{bool}!null)
                     ├── project
                     │    ├── columns: stmt_return_1:1(tuple{bool}!null)
                     │    ├── values
                     │    │    └── tuple [type=tuple]
                     │    └── projections
                     │         └── tuple [as=stmt_return_1:1, type=tuple{bool}]
                     │              └── false [type=bool]
                     └── const: 1 [type=int]

# Regression test for #114826 - ensure that SQL statements return at least one
# row.
exec-ddl
CREATE TABLE t114826 (a INT);
----

exec-ddl
CREATE FUNCTION f114826() RETURNS INT AS $$
  DECLARE
    found INT;
  BEGIN
    RAISE NOTICE 'HERE 1';
    SELECT a INTO found FROM t114826 WHERE a = 3;
    RAISE NOTICE 'HERE 2';
    INSERT INTO t114826 (SELECT * FROM t114826) RETURNING a INTO found;
    RAISE NOTICE 'HERE 3';
    RETURN 10;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT f114826();
----
project
 ├── columns: f114826:28
 ├── values
 │    └── tuple
 └── projections
      └── udf: f114826 [as=f114826:28]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":27
                     ├── project
                     │    ├── columns: "_stmt_raise_1":27
                     │    ├── barrier
                     │    │    ├── columns: found:1
                     │    │    └── project
                     │    │         ├── columns: found:1
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── cast: INT8 [as=found:1]
                     │    │                   └── null
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":27]
                     │              ├── args
                     │              │    └── $1: variable: found:1
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:2
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:2]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── const: 'HERE 1'
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_exec_3":26
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_exec_3 [as="_stmt_exec_3":26]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    └── $1: _stmt_raise.found:$0
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: "_stmt_exec_ret_4":25
                     │                                            ├── barrier
                     │                                            │    ├── columns: found:24
                     │                                            │    └── project
                     │                                            │         ├── columns: found:24
                     │                                            │         ├── right-join (cross)
                     │                                            │         │    ├── columns: a:3
                     │                                            │         │    ├── limit
                     │                                            │         │    │    ├── columns: a:3!null
                     │                                            │         │    │    ├── project
                     │                                            │         │    │    │    ├── columns: a:3!null
                     │                                            │         │    │    │    └── select
                     │                                            │         │    │    │         ├── columns: a:3!null rowid:4!null crdb_internal_mvcc_timestamp:5 tableoid:6
                     │                                            │         │    │    │         ├── scan t114826
                     │                                            │         │    │    │         │    └── columns: a:3 rowid:4!null crdb_internal_mvcc_timestamp:5 tableoid:6
                     │                                            │         │    │    │         └── filters
                     │                                            │         │    │    │              └── eq
                     │                                            │         │    │    │                   ├── variable: a:3
                     │                                            │         │    │    │                   └── const: 3
                     │                                            │         │    │    └── const: 1
                     │                                            │         │    ├── values
                     │                                            │         │    │    └── tuple
                     │                                            │         │    └── filters (true)
                     │                                            │         └── projections
                     │                                            │              └── variable: a:3 [as=found:24]
                     │                                            └── projections
                     │                                                 └── udf: _stmt_exec_ret_4 [as="_stmt_exec_ret_4":25]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: variable: found:24
                     │                                                      └── body
                     │                                                           └── project
                     │                                                                ├── columns: "_stmt_raise_5":23
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: _stmt_raise_5 [as="_stmt_raise_5":23]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: _stmt_exec_ret.found:$0
                     │                                                                          └── body
                     │                                                                               ├── project
                     │                                                                               │    ├── columns: stmt_raise_6:7
                     │                                                                               │    ├── values
                     │                                                                               │    │    └── tuple
                     │                                                                               │    └── projections
                     │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_6:7]
                     │                                                                               │              ├── const: 'NOTICE'
                     │                                                                               │              ├── const: 'HERE 2'
                     │                                                                               │              ├── const: ''
                     │                                                                               │              ├── const: ''
                     │                                                                               │              └── const: '00000'
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_exec_7":22
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_exec_7 [as="_stmt_exec_7":22]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    └── $1: _stmt_raise.found:$0
                     │                                                                                              └── body
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: "_stmt_exec_ret_8":21
                     │                                                                                                        ├── barrier
                     │                                                                                                        │    ├── columns: found:20
                     │                                                                                                        │    └── project
                     │                                                                                                        │         ├── columns: found:20
                     │                                                                                                        │         ├── right-join (cross)
                     │                                                                                                        │         │    ├── columns: a:8
                     │                                                                                                        │         │    ├── barrier
                     │                                                                                                        │         │    │    ├── columns: a:8
                     │                                                                                                        │         │    │    └── limit
                     │                                                                                                        │         │    │         ├── columns: a:8
                     │                                                                                                        │         │    │         ├── project
                     │                                                                                                        │         │    │         │    ├── columns: a:8
                     │                                                                                                        │         │    │         │    └── insert t114826
                     │                                                                                                        │         │    │         │         ├── columns: a:8 rowid:9!null
                     │                                                                                                        │         │    │         │         ├── insert-mapping:
                     │                                                                                                        │         │    │         │         │    ├── a:12 => a:8
                     │                                                                                                        │         │    │         │         │    └── rowid_default:16 => rowid:9
                     │                                                                                                        │         │    │         │         ├── return-mapping:
                     │                                                                                                        │         │    │         │         │    ├── a:12 => a:8
                     │                                                                                                        │         │    │         │         │    └── rowid_default:16 => rowid:9
                     │                                                                                                        │         │    │         │         └── project
                     │                                                                                                        │         │    │         │              ├── columns: rowid_default:16 a:12
                     │                                                                                                        │         │    │         │              ├── project
                     │                                                                                                        │         │    │         │              │    ├── columns: a:12
                     │                                                                                                        │         │    │         │              │    └── scan t114826
                     │                                                                                                        │         │    │         │              │         └── columns: a:12 rowid:13!null crdb_internal_mvcc_timestamp:14 tableoid:15
                     │                                                                                                        │         │    │         │              └── projections
                     │                                                                                                        │         │    │         │                   └── function: unique_rowid [as=rowid_default:16]
                     │                                                                                                        │         │    │         └── const: 1
                     │                                                                                                        │         │    ├── values
                     │                                                                                                        │         │    │    └── tuple
                     │                                                                                                        │         │    └── filters (true)
                     │                                                                                                        │         └── projections
                     │                                                                                                        │              └── variable: a:8 [as=found:20]
                     │                                                                                                        └── projections
                     │                                                                                                             └── udf: _stmt_exec_ret_8 [as="_stmt_exec_ret_8":21]
                     │                                                                                                                  ├── tail-call
                     │                                                                                                                  ├── args
                     │                                                                                                                  │    └── $1: variable: found:20
                     │                                                                                                                  └── body
                     │                                                                                                                       └── project
                     │                                                                                                                            ├── columns: "_stmt_raise_9":19
                     │                                                                                                                            ├── values
                     │                                                                                                                            │    └── tuple
                     │                                                                                                                            └── projections
                     │                                                                                                                                 └── udf: _stmt_raise_9 [as="_stmt_raise_9":19]
                     │                                                                                                                                      ├── tail-call
                     │                                                                                                                                      ├── args
                     │                                                                                                                                      │    └── $1: _stmt_exec_ret.found:$0
                     │                                                                                                                                      └── body
                     │                                                                                                                                           ├── project
                     │                                                                                                                                           │    ├── columns: stmt_raise_10:17
                     │                                                                                                                                           │    ├── values
                     │                                                                                                                                           │    │    └── tuple
                     │                                                                                                                                           │    └── projections
                     │                                                                                                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:17]
                     │                                                                                                                                           │              ├── const: 'NOTICE'
                     │                                                                                                                                           │              ├── const: 'HERE 3'
                     │                                                                                                                                           │              ├── const: ''
                     │                                                                                                                                           │              ├── const: ''
                     │                                                                                                                                           │              └── const: '00000'
                     │                                                                                                                                           └── project
                     │                                                                                                                                                ├── columns: stmt_return_11:18!null
                     │                                                                                                                                                ├── values
                     │                                                                                                                                                │    └── tuple
                     │                                                                                                                                                └── projections
                     │                                                                                                                                                     └── const: 10 [as=stmt_return_11:18]
                     └── const: 1

# Regression test for #119492 - don't push the in scope for non-root blocks.
# Doing so drops the expression that had been built up to that point.
exec-ddl
CREATE FUNCTION somefunc() RETURNS integer AS $$
DECLARE
    outer_quantity integer := 30;
BEGIN
    RAISE NOTICE 'Quantity here is %', outer_quantity;  -- Prints 30
    outer_quantity := 50;
    --
    -- Create a subblock
    --
    DECLARE
        inner_quantity integer := 80;
    BEGIN
        RAISE NOTICE 'Quantity here is %', inner_quantity;  -- Prints 80
        RAISE NOTICE 'Outer quantity here is %', outer_quantity;  -- Prints 50
    END;

    RAISE NOTICE 'Quantity here is %', outer_quantity;  -- Prints 50

    RETURN outer_quantity;
END;
$$ LANGUAGE plpgsql;
----

build format=show-scalars
SELECT somefunc();
----
project
 ├── columns: somefunc:14
 ├── values
 │    └── tuple
 └── projections
      └── udf: somefunc [as=somefunc:14]
           └── body
                └── limit
                     ├── columns: "_stmt_raise_1":13
                     ├── project
                     │    ├── columns: "_stmt_raise_1":13
                     │    ├── barrier
                     │    │    ├── columns: outer_quantity:1!null
                     │    │    └── project
                     │    │         ├── columns: outer_quantity:1!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 30 [as=outer_quantity:1]
                     │    └── projections
                     │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":13]
                     │              ├── args
                     │              │    └── $1: variable: outer_quantity:1
                     │              └── body
                     │                   ├── project
                     │                   │    ├── columns: stmt_raise_2:2
                     │                   │    ├── values
                     │                   │    │    └── tuple
                     │                   │    └── projections
                     │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:2]
                     │                   │              ├── const: 'NOTICE'
                     │                   │              ├── concat
                     │                   │              │    ├── concat
                     │                   │              │    │    ├── const: 'Quantity here is '
                     │                   │              │    │    └── coalesce
                     │                   │              │    │         ├── cast: STRING
                     │                   │              │    │         │    └── _stmt_raise.outer_quantity:$0
                     │                   │              │    │         └── const: '<NULL>'
                     │                   │              │    └── const: ''
                     │                   │              ├── const: ''
                     │                   │              ├── const: ''
                     │                   │              └── const: '00000'
                     │                   └── project
                     │                        ├── columns: "_stmt_raise_7":12
                     │                        ├── barrier
                     │                        │    ├── columns: outer_quantity:3!null inner_quantity:7!null
                     │                        │    └── project
                     │                        │         ├── columns: inner_quantity:7!null outer_quantity:3!null
                     │                        │         ├── project
                     │                        │         │    ├── columns: outer_quantity:3!null
                     │                        │         │    ├── values
                     │                        │         │    │    └── tuple
                     │                        │         │    └── projections
                     │                        │         │         └── const: 50 [as=outer_quantity:3]
                     │                        │         └── projections
                     │                        │              └── const: 80 [as=inner_quantity:7]
                     │                        └── projections
                     │                             └── udf: _stmt_raise_7 [as="_stmt_raise_7":12]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    ├── $1: variable: outer_quantity:3
                     │                                  │    └── $2: variable: inner_quantity:7
                     │                                  └── body
                     │                                       ├── project
                     │                                       │    ├── columns: stmt_raise_8:8
                     │                                       │    ├── values
                     │                                       │    │    └── tuple
                     │                                       │    └── projections
                     │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_8:8]
                     │                                       │              ├── const: 'NOTICE'
                     │                                       │              ├── concat
                     │                                       │              │    ├── concat
                     │                                       │              │    │    ├── const: 'Quantity here is '
                     │                                       │              │    │    └── coalesce
                     │                                       │              │    │         ├── cast: STRING
                     │                                       │              │    │         │    └── _stmt_raise.inner_quantity:$1
                     │                                       │              │    │         └── const: '<NULL>'
                     │                                       │              │    └── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              ├── const: ''
                     │                                       │              └── const: '00000'
                     │                                       └── project
                     │                                            ├── columns: "_stmt_raise_9":11
                     │                                            ├── values
                     │                                            │    └── tuple
                     │                                            └── projections
                     │                                                 └── udf: _stmt_raise_9 [as="_stmt_raise_9":11]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    ├── $1: _stmt_raise.outer_quantity:$0
                     │                                                      │    └── $2: _stmt_raise.inner_quantity:$1
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_10:9
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_10:9]
                     │                                                           │              ├── const: 'NOTICE'
                     │                                                           │              ├── concat
                     │                                                           │              │    ├── concat
                     │                                                           │              │    │    ├── const: 'Outer quantity here is '
                     │                                                           │              │    │    └── coalesce
                     │                                                           │              │    │         ├── cast: STRING
                     │                                                           │              │    │         │    └── _stmt_raise.outer_quantity:$0
                     │                                                           │              │    │         └── const: '<NULL>'
                     │                                                           │              │    └── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              ├── const: ''
                     │                                                           │              └── const: '00000'
                     │                                                           └── project
                     │                                                                ├── columns: post_nested_block_3:10
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── udf: post_nested_block_3 [as=post_nested_block_3:10]
                     │                                                                          ├── tail-call
                     │                                                                          ├── args
                     │                                                                          │    └── $1: _stmt_raise.outer_quantity:$0
                     │                                                                          └── body
                     │                                                                               └── project
                     │                                                                                    ├── columns: "_stmt_raise_4":6
                     │                                                                                    ├── values
                     │                                                                                    │    └── tuple
                     │                                                                                    └── projections
                     │                                                                                         └── udf: _stmt_raise_4 [as="_stmt_raise_4":6]
                     │                                                                                              ├── tail-call
                     │                                                                                              ├── args
                     │                                                                                              │    └── $1: post_nested_block.outer_quantity:$0
                     │                                                                                              └── body
                     │                                                                                                   ├── project
                     │                                                                                                   │    ├── columns: stmt_raise_5:4
                     │                                                                                                   │    ├── values
                     │                                                                                                   │    │    └── tuple
                     │                                                                                                   │    └── projections
                     │                                                                                                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_5:4]
                     │                                                                                                   │              ├── const: 'NOTICE'
                     │                                                                                                   │              ├── concat
                     │                                                                                                   │              │    ├── concat
                     │                                                                                                   │              │    │    ├── const: 'Quantity here is '
                     │                                                                                                   │              │    │    └── coalesce
                     │                                                                                                   │              │    │         ├── cast: STRING
                     │                                                                                                   │              │    │         │    └── _stmt_raise.outer_quantity:$0
                     │                                                                                                   │              │    │         └── const: '<NULL>'
                     │                                                                                                   │              │    └── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              ├── const: ''
                     │                                                                                                   │              └── const: '00000'
                     │                                                                                                   └── project
                     │                                                                                                        ├── columns: stmt_return_6:5
                     │                                                                                                        ├── values
                     │                                                                                                        │    └── tuple
                     │                                                                                                        └── projections
                     │                                                                                                             └── _stmt_raise.outer_quantity:$0 [as=stmt_return_6:5]
                     └── const: 1

# Use TxnControlExpr to COMMIT or ROLLBACK the current transaction, then
# continue from the new transaction.
exec-ddl
CREATE OR REPLACE PROCEDURE p() LANGUAGE PLpgSQL AS $$
  BEGIN
    INSERT INTO txn_timestamps VALUES (now());
    COMMIT;
    INSERT INTO txn_timestamps VALUES (now());
    ROLLBACK;
    INSERT INTO txn_timestamps VALUES (now());
  END;
$$;
----

build format=show-scalars
CALL p();
----
call
 └── procedure: p
      └── body
           └── limit
                ├── columns: "_stmt_exec_1":24
                ├── project
                │    ├── columns: "_stmt_exec_1":24
                │    ├── values
                │    │    └── tuple
                │    └── projections
                │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":24]
                │              └── body
                │                   ├── insert txn_timestamps
                │                   │    ├── columns: <none>
                │                   │    ├── insert-mapping:
                │                   │    │    ├── column1:5 => ts:1
                │                   │    │    └── rowid_default:6 => rowid:2
                │                   │    └── project
                │                   │         ├── columns: rowid_default:6 column1:5
                │                   │         ├── values
                │                   │         │    ├── columns: column1:5
                │                   │         │    └── tuple
                │                   │         │         └── function: now
                │                   │         └── projections
                │                   │              └── function: unique_rowid [as=rowid_default:6]
                │                   └── project
                │                        ├── columns: "_stmt_commit_2":23
                │                        ├── barrier
                │                        │    └── values
                │                        │         └── tuple
                │                        └── projections
                │                             └── COMMIT; CALL _stmt_commit_2 [as="_stmt_commit_2":23]
                │                                  └── body
                │                                       └── project
                │                                            ├── columns: "_stmt_exec_3":22
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── udf: _stmt_exec_3 [as="_stmt_exec_3":22]
                │                                                      ├── tail-call
                │                                                      └── body
                │                                                           ├── insert txn_timestamps
                │                                                           │    ├── columns: <none>
                │                                                           │    ├── insert-mapping:
                │                                                           │    │    ├── column1:11 => ts:7
                │                                                           │    │    └── rowid_default:12 => rowid:8
                │                                                           │    └── project
                │                                                           │         ├── columns: rowid_default:12 column1:11
                │                                                           │         ├── values
                │                                                           │         │    ├── columns: column1:11
                │                                                           │         │    └── tuple
                │                                                           │         │         └── function: now
                │                                                           │         └── projections
                │                                                           │              └── function: unique_rowid [as=rowid_default:12]
                │                                                           └── project
                │                                                                ├── columns: "_stmt_rollback_4":21
                │                                                                ├── barrier
                │                                                                │    └── values
                │                                                                │         └── tuple
                │                                                                └── projections
                │                                                                     └── ROLLBACK; CALL _stmt_rollback_4 [as="_stmt_rollback_4":21]
                │                                                                          └── body
                │                                                                               └── project
                │                                                                                    ├── columns: "_stmt_exec_5":20
                │                                                                                    ├── values
                │                                                                                    │    └── tuple
                │                                                                                    └── projections
                │                                                                                         └── udf: _stmt_exec_5 [as="_stmt_exec_5":20]
                │                                                                                              ├── tail-call
                │                                                                                              └── body
                │                                                                                                   ├── insert txn_timestamps
                │                                                                                                   │    ├── columns: <none>
                │                                                                                                   │    ├── insert-mapping:
                │                                                                                                   │    │    ├── column1:17 => ts:13
                │                                                                                                   │    │    └── rowid_default:18 => rowid:14
                │                                                                                                   │    └── project
                │                                                                                                   │         ├── columns: rowid_default:18 column1:17
                │                                                                                                   │         ├── values
                │                                                                                                   │         │    ├── columns: column1:17
                │                                                                                                   │         │    └── tuple
                │                                                                                                   │         │         └── function: now
                │                                                                                                   │         └── projections
                │                                                                                                   │              └── function: unique_rowid [as=rowid_default:18]
                │                                                                                                   └── project
                │                                                                                                        ├── columns: "_implicit_return":19
                │                                                                                                        ├── values
                │                                                                                                        │    └── tuple
                │                                                                                                        └── projections
                │                                                                                                             └── cast: VOID [as="_implicit_return":19]
                │                                                                                                                  └── null
                └── const: 1

# Regression test for #120692 - don't reset the concrete type for each block in
# a RECORD-returning PL/pgSQL function.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS RECORD AS $$
BEGIN
  IF true THEN
    RETURN (1:::INT8, NULL, -1.0:::DECIMAL);
  ELSIF false THEN
    BEGIN
      RETURN (1:::INT8, 1.0:::DECIMAL, NULL);
    END;
  END IF;
END;
$$ LANGUAGE PLpgSQL;
----

build format=(show-scalars,show-types)
SELECT f();
----
project
 ├── columns: f:9(tuple{int, unknown, decimal})
 ├── values
 │    └── tuple [type=tuple]
 └── projections
      └── udf: f [as=f:9, type=tuple{int, unknown, decimal}]
           └── body
                └── limit
                     ├── columns: stmt_if_8:8(tuple{int, unknown, decimal})
                     ├── project
                     │    ├── columns: stmt_if_8:8(tuple{int, unknown, decimal})
                     │    ├── values
                     │    │    └── tuple [type=tuple]
                     │    └── projections
                     │         └── case [as=stmt_if_8:8, type=tuple{int, unknown, decimal}]
                     │              ├── true [type=bool]
                     │              ├── when [type=tuple{int, unknown, decimal}]
                     │              │    ├── true [type=bool]
                     │              │    └── subquery [type=tuple{int, unknown, decimal}]
                     │              │         └── project
                     │              │              ├── columns: stmt_return_5:4(tuple{int, unknown, decimal})
                     │              │              ├── values
                     │              │              │    └── tuple [type=tuple]
                     │              │              └── projections
                     │              │                   └── tuple [as=stmt_return_5:4, type=tuple{int, unknown, decimal}]
                     │              │                        ├── const: 1 [type=int]
                     │              │                        ├── null [type=unknown]
                     │              │                        └── unary-minus [type=decimal]
                     │              │                             └── const: 1.0 [type=decimal]
                     │              ├── when [type=tuple{int, unknown, decimal}]
                     │              │    ├── false [type=bool]
                     │              │    └── subquery [type=tuple{int, unknown, decimal}]
                     │              │         └── project
                     │              │              ├── columns: stmt_return_7:6(tuple{int, unknown, decimal})
                     │              │              ├── values
                     │              │              │    └── tuple [type=tuple]
                     │              │              └── projections
                     │              │                   └── cast: RECORD [as=stmt_return_7:6, type=tuple{int, unknown, decimal}]
                     │              │                        └── cast: STRING [type=string]
                     │              │                             └── tuple [type=tuple{int, decimal, unknown}]
                     │              │                                  ├── const: 1 [type=int]
                     │              │                                  ├── const: 1.0 [type=decimal]
                     │              │                                  └── null [type=unknown]
                     │              └── subquery [type=tuple{int, unknown, decimal}]
                     │                   └── project
                     │                        ├── columns: stmt_if_1:7(tuple{int, unknown, decimal})
                     │                        ├── values
                     │                        │    └── tuple [type=tuple]
                     │                        └── projections
                     │                             └── udf: stmt_if_1 [as=stmt_if_1:7, type=tuple{int, unknown, decimal}]
                     │                                  ├── tail-call
                     │                                  └── body
                     │                                       └── project
                     │                                            ├── columns: "_end_of_function_2":3(tuple{int, unknown, decimal})
                     │                                            ├── values
                     │                                            │    └── tuple [type=tuple]
                     │                                            └── projections
                     │                                                 └── udf: _end_of_function_2 [as="_end_of_function_2":3, type=tuple{int, unknown, decimal}]
                     │                                                      ├── tail-call
                     │                                                      └── body
                     │                                                           ├── project
                     │                                                           │    ├── columns: stmt_raise_3:1(int)
                     │                                                           │    ├── values
                     │                                                           │    │    └── tuple [type=tuple]
                     │                                                           │    └── projections
                     │                                                           │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_3:1, type=int]
                     │                                                           │              ├── const: 'ERROR' [type=string]
                     │                                                           │              ├── const: 'control reached end of function without RETURN' [type=string]
                     │                                                           │              ├── const: '' [type=string]
                     │                                                           │              ├── const: '' [type=string]
                     │                                                           │              └── const: '2F005' [type=string]
                     │                                                           └── project
                     │                                                                ├── columns: end_of_function_4:2(tuple{int, unknown, decimal})
                     │                                                                ├── values
                     │                                                                │    └── tuple [type=tuple]
                     │                                                                └── projections
                     │                                                                     └── null [as=end_of_function_4:2, type=tuple{int, unknown, decimal}]
                     └── const: 1 [type=int]

# Regression test for #120916 - the nested call should not have the "tail-call"
# property, because it isn't a terminal statement.
exec-ddl
CREATE OR REPLACE FUNCTION f_nested(x INT) RETURNS INT AS $$
  BEGIN
    x := x * 2;
    RETURN x;
  END
$$ LANGUAGE PLpgSQL;
----

exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS RECORD AS $$
  DECLARE
    a INT := -2;
  BEGIN
    a := f_nested(a);
    RAISE NOTICE 'here';
    RETURN (a, -a);
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
SELECT * FROM f() AS g(x INT, y INT);
----
project-set
 ├── columns: x:10 y:11
 ├── values
 │    └── tuple
 └── zip
      └── udf: f
           └── body
                └── project
                     ├── columns: column8:8 column9:9
                     ├── limit
                     │    ├── columns: "_stmt_raise_1":7
                     │    ├── project
                     │    │    ├── columns: "_stmt_raise_1":7
                     │    │    ├── barrier
                     │    │    │    ├── columns: a:4
                     │    │    │    └── barrier
                     │    │    │         ├── columns: a:4
                     │    │    │         └── project
                     │    │    │              ├── columns: a:4
                     │    │    │              ├── barrier
                     │    │    │              │    ├── columns: a:1!null
                     │    │    │              │    └── project
                     │    │    │              │         ├── columns: a:1!null
                     │    │    │              │         ├── values
                     │    │    │              │         │    └── tuple
                     │    │    │              │         └── projections
                     │    │    │              │              └── const: -2 [as=a:1]
                     │    │    │              └── projections
                     │    │    │                   └── udf: f_nested [as=a:4]
                     │    │    │                        ├── args
                     │    │    │                        │    └── $1: variable: a:1
                     │    │    │                        └── body
                     │    │    │                             └── limit
                     │    │    │                                  ├── columns: stmt_return_1:3
                     │    │    │                                  ├── project
                     │    │    │                                  │    ├── columns: stmt_return_1:3
                     │    │    │                                  │    ├── project
                     │    │    │                                  │    │    ├── columns: x:2
                     │    │    │                                  │    │    ├── values
                     │    │    │                                  │    │    │    └── tuple
                     │    │    │                                  │    │    └── projections
                     │    │    │                                  │    │         └── mult [as=x:2]
                     │    │    │                                  │    │              ├── f_nested.x:$1
                     │    │    │                                  │    │              └── const: 2
                     │    │    │                                  │    └── projections
                     │    │    │                                  │         └── variable: x:2 [as=stmt_return_1:3]
                     │    │    │                                  └── const: 1
                     │    │    └── projections
                     │    │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":7]
                     │    │              ├── args
                     │    │              │    └── $1: variable: a:4
                     │    │              └── body
                     │    │                   ├── project
                     │    │                   │    ├── columns: stmt_raise_2:5
                     │    │                   │    ├── values
                     │    │                   │    │    └── tuple
                     │    │                   │    └── projections
                     │    │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:5]
                     │    │                   │              ├── const: 'NOTICE'
                     │    │                   │              ├── const: 'here'
                     │    │                   │              ├── const: ''
                     │    │                   │              ├── const: ''
                     │    │                   │              └── const: '00000'
                     │    │                   └── project
                     │    │                        ├── columns: stmt_return_3:6
                     │    │                        ├── values
                     │    │                        │    └── tuple
                     │    │                        └── projections
                     │    │                             └── tuple [as=stmt_return_3:6]
                     │    │                                  ├── _stmt_raise.a:$0
                     │    │                                  └── unary-minus
                     │    │                                       └── _stmt_raise.a:$0
                     │    └── const: 1
                     └── projections
                          ├── column-access: 0 [as=column8:8]
                          │    └── variable: "_stmt_raise_1":7
                          └── column-access: 1 [as=column9:9]
                               └── variable: "_stmt_raise_1":7

# Integer-range FOR loop.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT LANGUAGE PLpgSQL AS $$
  BEGIN
    FOR i IN 1..3 LOOP
      RAISE NOTICE 'i: %', i;
    END LOOP;
    RAISE NOTICE 'DONE';
    RETURN 0;
  END
$$;
----

# Use "norm" so it's easier to see the structure of the loop.
norm format=show-scalars
SELECT f();
----
values
 ├── columns: f:20
 └── tuple
      └── udf: f
           └── body
                └── project
                     ├── columns: stmt_loop_6:19
                     ├── barrier
                     │    ├── columns: "_loop_lower":4!null "_loop_upper":5!null "_loop_step":6!null "_loop_counter":8!null i:9!null
                     │    └── project
                     │         ├── columns: i:9!null "_loop_counter":8!null "_loop_lower":4!null "_loop_upper":5!null "_loop_step":6!null
                     │         ├── barrier
                     │         │    ├── columns: "_loop_lower":4!null "_loop_upper":5!null "_loop_step":6!null "_plpgsql_runtime_check_5":7
                     │         │    └── values
                     │         │         ├── columns: "_loop_lower":4!null "_loop_upper":5!null "_loop_step":6!null "_plpgsql_runtime_check_5":7
                     │         │         └── tuple
                     │         │              ├── const: 1
                     │         │              ├── const: 3
                     │         │              ├── const: 1
                     │         │              └── null
                     │         └── projections
                     │              ├── variable: "_loop_lower":4 [as=i:9]
                     │              └── variable: "_loop_lower":4 [as="_loop_counter":8]
                     └── projections
                          └── udf: stmt_loop_6 [as=stmt_loop_6:19]
                               ├── tail-call
                               ├── args
                               │    ├── $1: variable: i:9
                               │    └── $2: variable: "_loop_lower":4
                               └── body
                                    └── values
                                         ├── columns: stmt_if_11:15
                                         └── tuple
                                              └── case
                                                   ├── true
                                                   ├── when
                                                   │    ├── le
                                                   │    │    ├── stmt_loop.:$4
                                                   │    │    └── stmt_loop.:$2
                                                   │    └── udf: _stmt_raise_9
                                                   │         ├── tail-call
                                                   │         ├── args
                                                   │         │    ├── $1: stmt_loop.i:$0
                                                   │         │    └── $2: stmt_loop.:$1
                                                   │         └── body
                                                   │              ├── values
                                                   │              │    ├── columns: stmt_raise_10:11
                                                   │              │    └── tuple
                                                   │              │         └── function: crdb_internal.plpgsql_raise
                                                   │              │              ├── const: 'NOTICE'
                                                   │              │              ├── concat
                                                   │              │              │    ├── concat
                                                   │              │              │    │    ├── const: 'i: '
                                                   │              │              │    │    └── coalesce
                                                   │              │              │    │         ├── cast: STRING
                                                   │              │              │    │         │    └── _stmt_raise.i:$0
                                                   │              │              │    │         └── const: '<NULL>'
                                                   │              │              │    └── const: ''
                                                   │              │              ├── const: ''
                                                   │              │              ├── const: ''
                                                   │              │              └── const: '00000'
                                                   │              └── values
                                                   │                   ├── columns: stmt_if_8:12
                                                   │                   └── tuple
                                                   │                        └── udf: stmt_if_8
                                                   │                             ├── tail-call
                                                   │                             ├── args
                                                   │                             │    ├── $1: _stmt_raise.i:$0
                                                   │                             │    └── $2: _stmt_raise.:$1
                                                   │                             └── body
                                                   │                                  └── values
                                                   │                                       ├── columns: stmt_loop_inc_7:10
                                                   │                                       └── tuple
                                                   │                                            └── udf: stmt_loop_inc_7
                                                   │                                                 ├── tail-call
                                                   │                                                 ├── args
                                                   │                                                 │    ├── $1: stmt_if.i:$0
                                                   │                                                 │    └── $2: stmt_if.:$1
                                                   │                                                 └── body
                                                   │                                                      └── project
                                                   │                                                           ├── columns: stmt_loop_6:18
                                                   │                                                           ├── barrier
                                                   │                                                           │    ├── columns: "_loop_counter":16 i:17
                                                   │                                                           │    └── project
                                                   │                                                           │         ├── columns: i:17 "_loop_counter":16
                                                   │                                                           │         ├── values
                                                   │                                                           │         │    ├── columns: "_loop_counter":16
                                                   │                                                           │         │    └── tuple
                                                   │                                                           │         │         └── plus
                                                   │                                                           │         │              ├── stmt_loop.:$4
                                                   │                                                           │         │              └── stmt_loop.:$3
                                                   │                                                           │         └── projections
                                                   │                                                           │              └── variable: "_loop_counter":16 [as=i:17]
                                                   │                                                           └── projections
                                                   │                                                                └── udf: stmt_loop_6 [as=stmt_loop_6:18]
                                                   │                                                                     ├── tail-call
                                                   │                                                                     ├── args
                                                   │                                                                     │    ├── $1: variable: i:17
                                                   │                                                                     │    └── $2: stmt_loop_inc.:$1
                                                   │                                                                     └── recursive-call
                                                   └── udf: loop_exit_1
                                                        ├── tail-call
                                                        └── body
                                                             └── values
                                                                  ├── columns: "_stmt_raise_2":3
                                                                  └── tuple
                                                                       └── udf: _stmt_raise_2
                                                                            ├── tail-call
                                                                            └── body
                                                                                 ├── values
                                                                                 │    ├── columns: stmt_raise_3:1
                                                                                 │    └── tuple
                                                                                 │         └── function: crdb_internal.plpgsql_raise
                                                                                 │              ├── const: 'NOTICE'
                                                                                 │              ├── const: 'DONE'
                                                                                 │              ├── const: ''
                                                                                 │              ├── const: ''
                                                                                 │              └── const: '00000'
                                                                                 └── values
                                                                                      ├── columns: stmt_return_4:2!null
                                                                                      └── tuple
                                                                                           └── const: 0

# DO statements execute a PL/pgSQL code block inline. This is effectively an
# anonymous function with no arguments.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT LANGUAGE PLpgSQL AS $outer$
  DECLARE
    x INT := 1000;
  BEGIN
    INSERT INTO kv VALUES (x, x);
    DO $$
      DECLARE
        x INT := 3000;
      BEGIN
        RAISE NOTICE 'hello';
        INSERT INTO kv VALUES (x, x);
      END
    $$;
    x := 2000;
    INSERT INTO kv VALUES (x, x);
    RETURN 0;
  END
$outer$;
----

build format=show-scalars
SELECT f();
----
project
 ├── columns: f:30
 ├── values
 │    └── tuple
 └── projections
      └── udf: f [as=f:30]
           └── body
                └── limit
                     ├── columns: "_stmt_exec_1":29
                     ├── project
                     │    ├── columns: "_stmt_exec_1":29
                     │    ├── barrier
                     │    │    ├── columns: x:1!null
                     │    │    └── project
                     │    │         ├── columns: x:1!null
                     │    │         ├── values
                     │    │         │    └── tuple
                     │    │         └── projections
                     │    │              └── const: 1000 [as=x:1]
                     │    └── projections
                     │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":29]
                     │              ├── args
                     │              │    └── $1: variable: x:1
                     │              └── body
                     │                   ├── insert kv
                     │                   │    ├── columns: <none>
                     │                   │    ├── insert-mapping:
                     │                   │    │    ├── column1:6 => k:2
                     │                   │    │    └── column2:7 => v:3
                     │                   │    └── values
                     │                   │         ├── columns: column1:6 column2:7
                     │                   │         └── tuple
                     │                   │              ├── _stmt_exec.x:$0
                     │                   │              └── _stmt_exec.x:$0
                     │                   └── project
                     │                        ├── columns: "_stmt_do_2":28
                     │                        ├── values
                     │                        │    └── tuple
                     │                        └── projections
                     │                             └── udf: _stmt_do_2 [as="_stmt_do_2":28]
                     │                                  ├── tail-call
                     │                                  ├── args
                     │                                  │    └── $1: _stmt_exec.x:$0
                     │                                  └── body
                     │                                       ├── limit
                     │                                       │    ├── columns: "_stmt_raise_1":18
                     │                                       │    ├── project
                     │                                       │    │    ├── columns: "_stmt_raise_1":18
                     │                                       │    │    ├── barrier
                     │                                       │    │    │    ├── columns: x:8!null
                     │                                       │    │    │    └── project
                     │                                       │    │    │         ├── columns: x:8!null
                     │                                       │    │    │         ├── values
                     │                                       │    │    │         │    └── tuple
                     │                                       │    │    │         └── projections
                     │                                       │    │    │              └── const: 3000 [as=x:8]
                     │                                       │    │    └── projections
                     │                                       │    │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":18]
                     │                                       │    │              ├── args
                     │                                       │    │              │    └── $1: variable: x:8
                     │                                       │    │              └── body
                     │                                       │    │                   ├── project
                     │                                       │    │                   │    ├── columns: stmt_raise_2:9
                     │                                       │    │                   │    ├── values
                     │                                       │    │                   │    │    └── tuple
                     │                                       │    │                   │    └── projections
                     │                                       │    │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:9]
                     │                                       │    │                   │              ├── const: 'NOTICE'
                     │                                       │    │                   │              ├── const: 'hello'
                     │                                       │    │                   │              ├── const: ''
                     │                                       │    │                   │              ├── const: ''
                     │                                       │    │                   │              └── const: '00000'
                     │                                       │    │                   └── project
                     │                                       │    │                        ├── columns: "_stmt_exec_3":17
                     │                                       │    │                        ├── values
                     │                                       │    │                        │    └── tuple
                     │                                       │    │                        └── projections
                     │                                       │    │                             └── udf: _stmt_exec_3 [as="_stmt_exec_3":17]
                     │                                       │    │                                  ├── tail-call
                     │                                       │    │                                  ├── args
                     │                                       │    │                                  │    └── $1: _stmt_raise.x:$0
                     │                                       │    │                                  └── body
                     │                                       │    │                                       ├── insert kv
                     │                                       │    │                                       │    ├── columns: <none>
                     │                                       │    │                                       │    ├── insert-mapping:
                     │                                       │    │                                       │    │    ├── column1:14 => k:10
                     │                                       │    │                                       │    │    └── column2:15 => v:11
                     │                                       │    │                                       │    └── values
                     │                                       │    │                                       │         ├── columns: column1:14 column2:15
                     │                                       │    │                                       │         └── tuple
                     │                                       │    │                                       │              ├── _stmt_exec.x:$0
                     │                                       │    │                                       │              └── _stmt_exec.x:$0
                     │                                       │    │                                       └── project
                     │                                       │    │                                            ├── columns: "_implicit_return":16
                     │                                       │    │                                            ├── values
                     │                                       │    │                                            │    └── tuple
                     │                                       │    │                                            └── projections
                     │                                       │    │                                                 └── cast: VOID [as="_implicit_return":16]
                     │                                       │    │                                                      └── null
                     │                                       │    └── const: 1
                     │                                       └── project
                     │                                            ├── columns: "_stmt_exec_3":27
                     │                                            ├── barrier
                     │                                            │    ├── columns: x:19!null
                     │                                            │    └── project
                     │                                            │         ├── columns: x:19!null
                     │                                            │         ├── values
                     │                                            │         │    └── tuple
                     │                                            │         └── projections
                     │                                            │              └── const: 2000 [as=x:19]
                     │                                            └── projections
                     │                                                 └── udf: _stmt_exec_3 [as="_stmt_exec_3":27]
                     │                                                      ├── tail-call
                     │                                                      ├── args
                     │                                                      │    └── $1: variable: x:19
                     │                                                      └── body
                     │                                                           ├── insert kv
                     │                                                           │    ├── columns: <none>
                     │                                                           │    ├── insert-mapping:
                     │                                                           │    │    ├── column1:24 => k:20
                     │                                                           │    │    └── column2:25 => v:21
                     │                                                           │    └── values
                     │                                                           │         ├── columns: column1:24 column2:25
                     │                                                           │         └── tuple
                     │                                                           │              ├── _stmt_exec.x:$0
                     │                                                           │              └── _stmt_exec.x:$0
                     │                                                           └── project
                     │                                                                ├── columns: stmt_return_4:26!null
                     │                                                                ├── values
                     │                                                                │    └── tuple
                     │                                                                └── projections
                     │                                                                     └── const: 0 [as=stmt_return_4:26]
                     └── const: 1

# Embedded SQL statements/expressions can contain CTEs.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT LANGUAGE PLpgSQL AS $$
  DECLARE
    x INT := (WITH foo AS MATERIALIZED (SELECT random()) SELECT * FROM foo);
  BEGIN
    INSERT INTO kv (WITH foo AS (SELECT x, x) SELECT * FROM foo);
    FOR i IN 1..3 LOOP
        RAISE NOTICE 'hello';
        x := (WITH foo AS MATERIALIZED (SELECT i + random()::INT) SELECT * FROM foo);
        WITH foo AS (INSERT INTO kv VALUES (x, x) RETURNING k, v) INSERT INTO kv (SELECT * FROM foo);
    END LOOP;
    x := (WITH foo AS MATERIALIZED (SELECT random()::INT * x) SELECT * FROM foo);
    INSERT INTO kv VALUES (x, x);
    RETURN 0;
  END
$$;
----

build format=show-scalars
SELECT f();
----
error (42703): column "x" does not exist

# Case with an outer CTE.
exec-ddl
CREATE OR REPLACE FUNCTION f() RETURNS INT LANGUAGE PLpgSQL AS $$
  DECLARE
    x INT;
  BEGIN
    x := (WITH foo AS MATERIALIZED (SELECT random()::INT * 100) SELECT * FROM foo);
    RETURN x;
  END
$$;
----

build format=show-scalars
WITH foo AS MATERIALIZED (SELECT random() * 2) SELECT f() FROM foo;
----
with &1 (foo)
 ├── columns: f:9
 ├── materialized
 ├── project
 │    ├── columns: "?column?":1
 │    ├── values
 │    │    └── tuple
 │    └── projections
 │         └── mult [as="?column?":1]
 │              ├── function: random
 │              └── const: 2.0
 └── project
      ├── columns: f:9
      ├── with-scan &1 (foo)
      │    ├── columns: "?column?":2
      │    └── mapping:
      │         └──  "?column?":1 => "?column?":2
      └── projections
           └── udf: f [as=f:9]
                └── body
                     └── limit
                          ├── columns: stmt_return_1:8
                          ├── project
                          │    ├── columns: stmt_return_1:8
                          │    ├── barrier
                          │    │    ├── columns: x:7
                          │    │    └── project
                          │    │         ├── columns: x:7
                          │    │         ├── barrier
                          │    │         │    ├── columns: x:3
                          │    │         │    └── project
                          │    │         │         ├── columns: x:3
                          │    │         │         ├── values
                          │    │         │         │    └── tuple
                          │    │         │         └── projections
                          │    │         │              └── cast: INT8 [as=x:3]
                          │    │         │                   └── null
                          │    │         └── projections
                          │    │              └── subquery [as=x:7]
                          │    │                   └── with &2 (foo)
                          │    │                        ├── columns: column6:6
                          │    │                        ├── materialized
                          │    │                        ├── project
                          │    │                        │    ├── columns: "?column?":4
                          │    │                        │    ├── values
                          │    │                        │    │    └── tuple
                          │    │                        │    └── projections
                          │    │                        │         └── mult [as="?column?":4]
                          │    │                        │              ├── cast: INT8
                          │    │                        │              │    └── function: random
                          │    │                        │              └── const: 100
                          │    │                        └── values
                          │    │                             ├── columns: column6:6
                          │    │                             └── tuple
                          │    │                                  └── subquery
                          │    │                                       └── max1-row
                          │    │                                            ├── columns: "?column?":5
                          │    │                                            └── with-scan &2 (foo)
                          │    │                                                 ├── columns: "?column?":5
                          │    │                                                 └── mapping:
                          │    │                                                      └──  "?column?":4 => "?column?":5
                          │    └── projections
                          │         └── variable: x:7 [as=stmt_return_1:8]
                          └── const: 1

# Set-returning function. Note the "add-to-srf-result" body statements.
# Also note that the sub-routines are all tail-calls apart from the outermost,
# since its result is not directly used by "f".
exec-ddl
CREATE OR REPLACE FUNCTION f(n INT) RETURNS SETOF INT LANGUAGE PLpgSQL AS $$
  DECLARE
    i INT := 0;
  BEGIN
    RETURN QUERY SELECT random()::INT * 100;
    WHILE i <= n LOOP
      RETURN NEXT i;
      i := i + 1;
    END LOOP;
  END
$$;
----

build format=show-scalars
SELECT f(3);
----
project-set
 ├── columns: f:13
 ├── values
 │    └── tuple
 └── zip
      └── udf: f
           ├── args
           │    └── $1: const: 3
           └── body
                └── project
                     ├── columns: return_next_1:12
                     ├── barrier
                     │    ├── columns: i:1!null
                     │    └── project
                     │         ├── columns: i:1!null
                     │         ├── values
                     │         │    └── tuple
                     │         └── projections
                     │              └── const: 0 [as=i:1]
                     └── projections
                          └── udf: return_next_1 [as=return_next_1:12]
                               ├── args
                               │    ├── $1: f.n:$1
                               │    └── $2: variable: i:1
                               └── body
                                    ├── add-to-srf-result
                                    │    └── project
                                    │         ├── columns: "?column?":2
                                    │         ├── values
                                    │         │    └── tuple
                                    │         └── projections
                                    │              └── mult [as="?column?":2]
                                    │                   ├── cast: INT8
                                    │                   │    └── function: random
                                    │                   └── const: 100
                                    └── project
                                         ├── columns: stmt_loop_3:11
                                         ├── values
                                         │    └── tuple
                                         └── projections
                                              └── udf: stmt_loop_3 [as=stmt_loop_3:11]
                                                   ├── tail-call
                                                   ├── args
                                                   │    ├── $1: return_next.n:$0
                                                   │    └── $2: return_next.i:$1
                                                   └── body
                                                        └── project
                                                             ├── columns: stmt_if_7:10
                                                             ├── values
                                                             │    └── tuple
                                                             └── projections
                                                                  └── case [as=stmt_if_7:10]
                                                                       ├── true
                                                                       ├── when
                                                                       │    ├── le
                                                                       │    │    ├── stmt_loop.i:$1
                                                                       │    │    └── stmt_loop.n:$0
                                                                       │    └── subquery
                                                                       │         ├── tail-call
                                                                       │         └── project
                                                                       │              ├── columns: return_next_5:8
                                                                       │              ├── values
                                                                       │              │    └── tuple
                                                                       │              └── projections
                                                                       │                   └── udf: return_next_5 [as=return_next_5:8]
                                                                       │                        ├── tail-call
                                                                       │                        ├── args
                                                                       │                        │    ├── $1: stmt_loop.n:$0
                                                                       │                        │    └── $2: stmt_loop.i:$1
                                                                       │                        └── body
                                                                       │                             ├── add-to-srf-result
                                                                       │                             │    └── project
                                                                       │                             │         ├── columns: stmt_return_next_6:5
                                                                       │                             │         ├── values
                                                                       │                             │         │    └── tuple
                                                                       │                             │         └── projections
                                                                       │                             │              └── return_next.i:$1 [as=stmt_return_next_6:5]
                                                                       │                             └── project
                                                                       │                                  ├── columns: stmt_if_4:7
                                                                       │                                  ├── project
                                                                       │                                  │    ├── columns: i:6
                                                                       │                                  │    ├── values
                                                                       │                                  │    │    └── tuple
                                                                       │                                  │    └── projections
                                                                       │                                  │         └── plus [as=i:6]
                                                                       │                                  │              ├── return_next.i:$1
                                                                       │                                  │              └── const: 1
                                                                       │                                  └── projections
                                                                       │                                       └── udf: stmt_if_4 [as=stmt_if_4:7]
                                                                       │                                            ├── tail-call
                                                                       │                                            ├── args
                                                                       │                                            │    ├── $1: return_next.n:$0
                                                                       │                                            │    └── $2: variable: i:6
                                                                       │                                            └── body
                                                                       │                                                 └── project
                                                                       │                                                      ├── columns: stmt_loop_3:4
                                                                       │                                                      ├── values
                                                                       │                                                      │    └── tuple
                                                                       │                                                      └── projections
                                                                       │                                                           └── udf: stmt_loop_3 [as=stmt_loop_3:4]
                                                                       │                                                                ├── tail-call
                                                                       │                                                                ├── args
                                                                       │                                                                │    ├── $1: stmt_if.n:$0
                                                                       │                                                                │    └── $2: stmt_if.i:$1
                                                                       │                                                                └── recursive-call
                                                                       └── subquery
                                                                            ├── tail-call
                                                                            └── project
                                                                                 ├── columns: loop_exit_2:9
                                                                                 ├── values
                                                                                 │    └── tuple
                                                                                 └── projections
                                                                                      └── udf: loop_exit_2 [as=loop_exit_2:9]
                                                                                           ├── tail-call
                                                                                           ├── args
                                                                                           │    ├── $1: stmt_loop.n:$0
                                                                                           │    └── $2: stmt_loop.i:$1
                                                                                           └── body
                                                                                                └── project
                                                                                                     ├── columns: "_implicit_return":3
                                                                                                     ├── values
                                                                                                     │    └── tuple
                                                                                                     └── projections
                                                                                                          └── cast: VOID [as="_implicit_return":3]
                                                                                                               └── null
