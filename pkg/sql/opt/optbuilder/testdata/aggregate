# tests adapted from logictest -- aggregate

exec-ddl
CREATE TABLE t.kv (
  k INT PRIMARY KEY,
  v INT,
  w INT,
  s STRING
)
----
TABLE kv
 ├── k int not null
 ├── v int
 ├── w int
 ├── s string
 └── INDEX primary
      └── k int not null

build
SELECT MIN(1), MAX(1), COUNT(1), SUM_INT(1), AVG(1), SUM(1), STDDEV(1),
  VARIANCE(1), BOOL_AND(true), BOOL_AND(false), XOR_AGG(b'\x01') FROM t.kv
----
group-by
 ├── columns: column6:6(int) column8:8(int) column10:10(int) column12:12(int) column14:14(decimal) column16:16(decimal) column18:18(decimal) column20:20(decimal) column22:22(bool) column24:24(bool) column26:26(bytes)
 ├── project
 │    ├── columns: column5:5(int) column7:7(int) column9:9(int) column11:11(int) column13:13(int) column15:15(int) column17:17(int) column19:19(int) column21:21(bool) column23:23(bool) column25:25(bytes)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── const: 1 [type=int]
 │         ├── true [type=bool]
 │         ├── false [type=bool]
 │         └── const: '\x01' [type=bytes]
 └── aggregations [outer=(5,7,9,11,13,15,17,19,21,23,25)]
      ├── function: min [type=int, outer=(5)]
      │    └── variable: column5 [type=int, outer=(5)]
      ├── function: max [type=int, outer=(7)]
      │    └── variable: column7 [type=int, outer=(7)]
      ├── function: count [type=int, outer=(9)]
      │    └── variable: column9 [type=int, outer=(9)]
      ├── function: sum_int [type=int, outer=(11)]
      │    └── variable: column11 [type=int, outer=(11)]
      ├── function: avg [type=decimal, outer=(13)]
      │    └── variable: column13 [type=int, outer=(13)]
      ├── function: sum [type=decimal, outer=(15)]
      │    └── variable: column15 [type=int, outer=(15)]
      ├── function: stddev [type=decimal, outer=(17)]
      │    └── variable: column17 [type=int, outer=(17)]
      ├── function: variance [type=decimal, outer=(19)]
      │    └── variable: column19 [type=int, outer=(19)]
      ├── function: bool_and [type=bool, outer=(21)]
      │    └── variable: column21 [type=bool, outer=(21)]
      ├── function: bool_and [type=bool, outer=(23)]
      │    └── variable: column23 [type=bool, outer=(23)]
      └── function: xor_agg [type=bytes, outer=(25)]
           └── variable: column25 [type=bytes, outer=(25)]

build
SELECT MIN(v), MAX(v), COUNT(v), SUM_INT(1), AVG(v), SUM(v), STDDEV(v),
  VARIANCE(v), BOOL_AND(v = 1), BOOL_AND(v = 1), XOR_AGG(s::bytes) FROM kv
----
group-by
 ├── columns: column5:5(int) column6:6(int) column7:7(int) column9:9(int) column10:10(decimal) column11:11(decimal) column12:12(decimal) column13:13(decimal) column15:15(bool) column17:17(bool) column19:19(bytes)
 ├── project
 │    ├── columns: kv.v:2(int) kv.v:2(int) kv.v:2(int) column8:8(int) kv.v:2(int) kv.v:2(int) kv.v:2(int) kv.v:2(int) column14:14(bool) column16:16(bool) column18:18(bytes)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(2,4)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── const: 1 [type=int]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── eq [type=bool, outer=(2)]
 │         │    ├── variable: kv.v [type=int, outer=(2)]
 │         │    └── const: 1 [type=int]
 │         ├── eq [type=bool, outer=(2)]
 │         │    ├── variable: kv.v [type=int, outer=(2)]
 │         │    └── const: 1 [type=int]
 │         └── cast: bytes [type=bytes, outer=(4)]
 │              └── variable: kv.s [type=string, outer=(4)]
 └── aggregations [outer=(2,8,14,16,18)]
      ├── function: min [type=int, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: max [type=int, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: count [type=int, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: sum_int [type=int, outer=(8)]
      │    └── variable: column8 [type=int, outer=(8)]
      ├── function: avg [type=decimal, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: sum [type=decimal, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: stddev [type=decimal, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: variance [type=decimal, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: bool_and [type=bool, outer=(14)]
      │    └── variable: column14 [type=bool, outer=(14)]
      ├── function: bool_and [type=bool, outer=(16)]
      │    └── variable: column16 [type=bool, outer=(16)]
      └── function: xor_agg [type=bytes, outer=(18)]
           └── variable: column18 [type=bytes, outer=(18)]

build
SELECT MIN(1), COUNT(1), MAX(1), SUM_INT(1), AVG(1)::float, SUM(1), STDDEV(1),
  VARIANCE(1)::float, BOOL_AND(true), BOOL_OR(true), TO_HEX(XOR_AGG(b'\x01'))
----
project
 ├── columns: column2:2(int) column4:4(int) column6:6(int) column8:8(int) column11:11(float) column13:13(decimal) column15:15(decimal) column18:18(float) column20:20(bool) column22:22(bool) column25:25(string)
 ├── group-by
 │    ├── columns: column2:2(int) column4:4(int) column6:6(int) column8:8(int) column10:10(decimal) column13:13(decimal) column15:15(decimal) column17:17(decimal) column20:20(bool) column22:22(bool) column24:24(bytes)
 │    ├── project
 │    │    ├── columns: column1:1(int) column3:3(int) column5:5(int) column7:7(int) column9:9(int) column12:12(int) column14:14(int) column16:16(int) column19:19(bool) column21:21(bool) column23:23(bytes)
 │    │    ├── values
 │    │    │    └── tuple [type=tuple{}]
 │    │    └── projections
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── const: 1 [type=int]
 │    │         ├── true [type=bool]
 │    │         ├── true [type=bool]
 │    │         └── const: '\x01' [type=bytes]
 │    └── aggregations [outer=(1,3,5,7,9,12,14,16,19,21,23)]
 │         ├── function: min [type=int, outer=(1)]
 │         │    └── variable: column1 [type=int, outer=(1)]
 │         ├── function: count [type=int, outer=(3)]
 │         │    └── variable: column3 [type=int, outer=(3)]
 │         ├── function: max [type=int, outer=(5)]
 │         │    └── variable: column5 [type=int, outer=(5)]
 │         ├── function: sum_int [type=int, outer=(7)]
 │         │    └── variable: column7 [type=int, outer=(7)]
 │         ├── function: avg [type=decimal, outer=(9)]
 │         │    └── variable: column9 [type=int, outer=(9)]
 │         ├── function: sum [type=decimal, outer=(12)]
 │         │    └── variable: column12 [type=int, outer=(12)]
 │         ├── function: stddev [type=decimal, outer=(14)]
 │         │    └── variable: column14 [type=int, outer=(14)]
 │         ├── function: variance [type=decimal, outer=(16)]
 │         │    └── variable: column16 [type=int, outer=(16)]
 │         ├── function: bool_and [type=bool, outer=(19)]
 │         │    └── variable: column19 [type=bool, outer=(19)]
 │         ├── function: bool_or [type=bool, outer=(21)]
 │         │    └── variable: column21 [type=bool, outer=(21)]
 │         └── function: xor_agg [type=bytes, outer=(23)]
 │              └── variable: column23 [type=bytes, outer=(23)]
 └── projections [outer=(2,4,6,8,10,13,15,17,20,22,24)]
      ├── variable: column2 [type=int, outer=(2)]
      ├── variable: column4 [type=int, outer=(4)]
      ├── variable: column6 [type=int, outer=(6)]
      ├── variable: column8 [type=int, outer=(8)]
      ├── cast: float [type=float, outer=(10)]
      │    └── variable: column10 [type=decimal, outer=(10)]
      ├── variable: column13 [type=decimal, outer=(13)]
      ├── variable: column15 [type=decimal, outer=(15)]
      ├── cast: float [type=float, outer=(17)]
      │    └── variable: column17 [type=decimal, outer=(17)]
      ├── variable: column20 [type=bool, outer=(20)]
      ├── variable: column22 [type=bool, outer=(22)]
      └── function: to_hex [type=string, outer=(24)]
           └── variable: column24 [type=bytes, outer=(24)]

build
SELECT ARRAY_AGG(1) FROM t.kv
----
group-by
 ├── columns: column6:6(int[])
 ├── project
 │    ├── columns: column5:5(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections
 │         └── const: 1 [type=int]
 └── aggregations [outer=(5)]
      └── function: array_agg [type=int[], outer=(5)]
           └── variable: column5 [type=int, outer=(5)]

build
SELECT JSON_AGG(v) FROM t.kv
----
group-by
 ├── columns: column5:5(jsonb)
 ├── project
 │    ├── columns: kv.v:2(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(2)]
 │         └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(2)]
      └── function: json_agg [type=jsonb, outer=(2)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT JSONB_AGG(1)
----
group-by
 ├── columns: column2:2(jsonb)
 ├── project
 │    ├── columns: column1:1(int)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         └── const: 1 [type=int]
 └── aggregations [outer=(1)]
      └── function: jsonb_agg [type=jsonb, outer=(1)]
           └── variable: column1 [type=int, outer=(1)]

# Even with no aggregate functions, grouping occurs in the presence of GROUP BY.
build
SELECT 1 FROM t.kv GROUP BY v
----
project
 ├── columns: column5:5(int)
 ├── group-by
 │    ├── columns: kv.v:2(int)
 │    ├── grouping columns: kv.v:2(int)
 │    ├── project
 │    │    ├── columns: kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(2)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations
 └── projections
      └── const: 1 [type=int]

# This should ideally return {NULL}, but this is a pathological case, and
# Postgres has the same behavior, so it's sufficient for now.
build
SELECT ARRAY_AGG(NULL)
----
error: ambiguous call: array_agg(unknown), candidates are:
array_agg(int) -> int[]
array_agg(float) -> float[]
array_agg(decimal) -> decimal[]
array_agg(string) -> string[]
array_agg(bytes) -> bytes[]
array_agg(date) -> date[]
array_agg(time) -> time[]
array_agg(timestamp) -> timestamp[]
array_agg(timestamptz) -> timestamptz[]
array_agg(interval) -> interval[]
array_agg(uuid) -> uuid[]
array_agg(inet) -> inet[]
array_agg(oid) -> oid[]
array_agg(bool) -> bool[]

# With an explicit cast, this works as expected.
build
SELECT ARRAY_AGG(NULL::TEXT)
----
group-by
 ├── columns: column2:2(string[])
 ├── project
 │    ├── columns: column1:1(string)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         └── cast: string [type=string]
 │              └── null [type=unknown]
 └── aggregations [outer=(1)]
      └── function: array_agg [type=string[], outer=(1)]
           └── variable: column1 [type=string, outer=(1)]

build
SELECT COUNT(*), k FROM t.kv
----
error: column "t.kv.k" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT COUNT(*) FROM t.kv GROUP BY s < 5
----
error: unsupported comparison operator: <string> < <int>

build
SELECT COUNT(*), k FROM t.kv GROUP BY k
----
project
 ├── columns: column5:5(int) k:1(int!null)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) column5:5(int)
 │    ├── grouping columns: kv.k:1(int!null)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1)]
 │    │         └── variable: kv.k [type=int, outer=(1)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(1,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.k [type=int, outer=(1)]

# GROUP BY specified using column index works.
build
SELECT COUNT(*), k FROM t.kv GROUP BY 2
----
project
 ├── columns: column5:5(int) k:1(int!null)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) column5:5(int)
 │    ├── grouping columns: kv.k:1(int!null)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1)]
 │    │         └── variable: kv.k [type=int, outer=(1)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(1,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.k [type=int, outer=(1)]

build
SELECT COUNT(*), k FROM t.kv GROUP BY 5
----
error: GROUP BY position 5 is not in select list

build
SELECT COUNT(*), k FROM t.kv GROUP BY 0
----
error: GROUP BY position 0 is not in select list

build
SELECT 1 GROUP BY 'a'
----
error: non-integer constant in GROUP BY: 'a'

# Qualifying a name in the SELECT, the GROUP BY, both or neither should not affect validation.
build
SELECT COUNT(*), kv.s FROM t.kv GROUP BY s
----
project
 ├── columns: column5:5(int) s:4(string)
 ├── group-by
 │    ├── columns: kv.s:4(string) column5:5(int)
 │    ├── grouping columns: kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(4,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.s [type=string, outer=(4)]

build
SELECT COUNT(*), s FROM t.kv GROUP BY kv.s
----
project
 ├── columns: column5:5(int) s:4(string)
 ├── group-by
 │    ├── columns: kv.s:4(string) column5:5(int)
 │    ├── grouping columns: kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(4,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.s [type=string, outer=(4)]

build
SELECT COUNT(*), kv.s FROM t.kv GROUP BY kv.s
----
project
 ├── columns: column5:5(int) s:4(string)
 ├── group-by
 │    ├── columns: kv.s:4(string) column5:5(int)
 │    ├── grouping columns: kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(4,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.s [type=string, outer=(4)]

build
SELECT COUNT(*), s FROM t.kv GROUP BY s
----
project
 ├── columns: column5:5(int) s:4(string)
 ├── group-by
 │    ├── columns: kv.s:4(string) column5:5(int)
 │    ├── grouping columns: kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(4,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.s [type=string, outer=(4)]

# Grouping by more than one column works.
build
SELECT v, COUNT(*), w FROM t.kv GROUP BY v, w
----
project
 ├── columns: v:2(int) column5:5(int) w:3(int)
 ├── group-by
 │    ├── columns: kv.v:2(int) kv.w:3(int) column5:5(int)
 │    ├── grouping columns: kv.v:2(int) kv.w:3(int)
 │    ├── project
 │    │    ├── columns: kv.v:2(int) kv.w:3(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(2,3)]
 │    │         ├── variable: kv.v [type=int, outer=(2)]
 │    │         └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(2,3,5)]
      ├── variable: kv.v [type=int, outer=(2)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.w [type=int, outer=(3)]

# Grouping by more than one column using column numbers works.
build
SELECT v, COUNT(*), w FROM t.kv GROUP BY 1, 3
----
project
 ├── columns: v:2(int) column5:5(int) w:3(int)
 ├── group-by
 │    ├── columns: kv.v:2(int) kv.w:3(int) column5:5(int)
 │    ├── grouping columns: kv.v:2(int) kv.w:3(int)
 │    ├── project
 │    │    ├── columns: kv.v:2(int) kv.w:3(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(2,3)]
 │    │         ├── variable: kv.v [type=int, outer=(2)]
 │    │         └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(2,3,5)]
      ├── variable: kv.v [type=int, outer=(2)]
      ├── variable: column5 [type=int, outer=(5)]
      └── variable: kv.w [type=int, outer=(3)]

# Selecting and grouping on a function expression works.
build
SELECT COUNT(*), UPPER(s) FROM t.kv GROUP BY UPPER(s)
----
project
 ├── columns: column6:6(int) column5:5(string)
 ├── group-by
 │    ├── columns: column5:5(string) column6:6(int)
 │    ├── grouping columns: column5:5(string)
 │    ├── project
 │    │    ├── columns: column5:5(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── function: upper [type=string, outer=(4)]
 │    │              └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(5,6)]
      ├── variable: column6 [type=int, outer=(6)]
      └── variable: column5 [type=string, outer=(5)]

# Selecting and grouping on a constant works.
build
SELECT COUNT(*) FROM t.kv GROUP BY 1+2
----
project
 ├── columns: column6:6(int)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── grouping columns: column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections
 │    │         └── const: 3 [type=int]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(6)]
      └── variable: column6 [type=int, outer=(6)]

build
SELECT COUNT(*) FROM t.kv GROUP BY length('abc')
----
project
 ├── columns: column6:6(int)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── grouping columns: column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections
 │    │         └── function: length [type=int]
 │    │              └── const: 'abc' [type=string]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(6)]
      └── variable: column6 [type=int, outer=(6)]

# Selecting a function of something which is grouped works.
build
SELECT COUNT(*), UPPER(s) FROM t.kv GROUP BY s
----
project
 ├── columns: column5:5(int) column6:6(string)
 ├── group-by
 │    ├── columns: kv.s:4(string) column5:5(int)
 │    ├── grouping columns: kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(4,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── function: upper [type=string, outer=(4)]
           └── variable: kv.s [type=string, outer=(4)]

# Selecting a value that is not grouped, even if a function of it it, does not work.
build
SELECT COUNT(*), s FROM t.kv GROUP BY UPPER(s)
----
error: column "t.kv.s" must appear in the GROUP BY clause or be used in an aggregate function

# Selecting and grouping on a more complex expression works.
build
SELECT COUNT(*), k+v FROM t.kv GROUP BY k+v
----
project
 ├── columns: column6:6(int) column5:5(int)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── grouping columns: column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,2)]
 │    │         └── plus [type=int, outer=(1,2)]
 │    │              ├── variable: kv.k [type=int, outer=(1)]
 │    │              └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(5,6)]
      ├── variable: column6 [type=int, outer=(6)]
      └── variable: column5 [type=int, outer=(5)]


# Selecting a more complex expression, made up of things which are each grouped, works.
build
SELECT COUNT(*), k+v FROM t.kv GROUP BY k, v
----
project
 ├── columns: column5:5(int) column6:6(int)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) kv.v:2(int) column5:5(int)
 │    ├── grouping columns: kv.k:1(int!null) kv.v:2(int)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,2)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(1,2,5)]
      ├── variable: column5 [type=int, outer=(5)]
      └── plus [type=int, outer=(1,2)]
           ├── variable: kv.k [type=int, outer=(1)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT COUNT(*), k+v FROM t.kv GROUP BY k
----
error: column "t.kv.v" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT COUNT(*), k+v FROM t.kv GROUP BY v
----
error: column "t.kv.k" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT COUNT(*), v/(k+v) FROM t.kv GROUP BY k+v
----
error: column "t.kv.v" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT k FROM t.kv WHERE AVG(k) > 1
----
error: aggregate function is not allowed in this context

build
SELECT MAX(AVG(k)) FROM t.kv
----
error: aggregate function cannot be nested within another aggregate function

# Test case from #2761.
build
SELECT count(kv.k) AS count_1, kv.v + kv.w AS lx FROM t.kv GROUP BY kv.v + kv.w
----
project
 ├── columns: count_1:6(int) lx:5(int)
 ├── group-by
 │    ├── columns: column5:5(int) count_1:6(int)
 │    ├── grouping columns: column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int) kv.k:1(int!null)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── plus [type=int, outer=(2,3)]
 │    │         │    ├── variable: kv.v [type=int, outer=(2)]
 │    │         │    └── variable: kv.w [type=int, outer=(3)]
 │    │         └── variable: kv.k [type=int, outer=(1)]
 │    └── aggregations [outer=(1)]
 │         └── function: count [type=int, outer=(1)]
 │              └── variable: kv.k [type=int, outer=(1)]
 └── projections [outer=(5,6)]
      ├── variable: count_1 [type=int, outer=(6)]
      └── variable: column5 [type=int, outer=(5)]

build
SELECT COUNT(*)
----
group-by
 ├── columns: column1:1(int)
 ├── values
 │    └── tuple [type=tuple{}]
 └── aggregations
      └── function: count_rows [type=int]

build
SELECT COUNT(k) from t.kv
----
group-by
 ├── columns: column5:5(int)
 ├── project
 │    ├── columns: kv.k:1(int!null)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1)]
 │         └── variable: kv.k [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: count [type=int, outer=(1)]
           └── variable: kv.k [type=int, outer=(1)]

build
SELECT COUNT(1)
----
group-by
 ├── columns: column2:2(int)
 ├── project
 │    ├── columns: column1:1(int)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         └── const: 1 [type=int]
 └── aggregations [outer=(1)]
      └── function: count [type=int, outer=(1)]
           └── variable: column1 [type=int, outer=(1)]

build
SELECT COUNT(1) from t.kv
----
group-by
 ├── columns: column6:6(int)
 ├── project
 │    ├── columns: column5:5(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections
 │         └── const: 1 [type=int]
 └── aggregations [outer=(5)]
      └── function: count [type=int, outer=(5)]
           └── variable: column5 [type=int, outer=(5)]

build
SELECT COUNT(k, v) FROM t.kv
----
error: unknown signature: count(int, int)

build
SELECT COUNT(*), COUNT(k), COUNT(kv.v) FROM t.kv
----
group-by
 ├── columns: column5:5(int) column6:6(int) column7:7(int)
 ├── project
 │    ├── columns: kv.k:1(int!null) kv.v:2(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1,2)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(1,2)]
      ├── function: count_rows [type=int]
      ├── function: count [type=int, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      └── function: count [type=int, outer=(2)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT COUNT(kv.*) FROM t.kv
----
group-by
 ├── columns: column6:6(int)
 ├── project
 │    ├── columns: column5:5(tuple{int, int, int, string})
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1-4)]
 │         └── tuple [type=tuple{int, int, int, string}, outer=(1-4)]
 │              ├── variable: kv.k [type=int, outer=(1)]
 │              ├── variable: kv.v [type=int, outer=(2)]
 │              ├── variable: kv.w [type=int, outer=(3)]
 │              └── variable: kv.s [type=string, outer=(4)]
 └── aggregations [outer=(5)]
      └── function: count [type=int, outer=(5)]
           └── variable: column5 [type=tuple{int, int, int, string}, outer=(5)]

build
SELECT COUNT((k, v)) FROM t.kv
----
group-by
 ├── columns: column6:6(int)
 ├── project
 │    ├── columns: column5:5(tuple{int, int})
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1,2)]
 │         └── tuple [type=tuple{int, int}, outer=(1,2)]
 │              ├── variable: kv.k [type=int, outer=(1)]
 │              └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(5)]
      └── function: count [type=int, outer=(5)]
           └── variable: column5 [type=tuple{int, int}, outer=(5)]

build
SELECT COUNT(k)+COUNT(kv.v) FROM t.kv
----
project
 ├── columns: column7:7(int)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,2)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations [outer=(1,2)]
 │         ├── function: count [type=int, outer=(1)]
 │         │    └── variable: kv.k [type=int, outer=(1)]
 │         └── function: count [type=int, outer=(2)]
 │              └── variable: kv.v [type=int, outer=(2)]
 └── projections [outer=(5,6)]
      └── plus [type=int, outer=(5,6)]
           ├── variable: column5 [type=int, outer=(5)]
           └── variable: column6 [type=int, outer=(6)]

build
SELECT COUNT(NULL::int), COUNT((NULL, NULL))
----
group-by
 ├── columns: column2:2(int) column4:4(int)
 ├── project
 │    ├── columns: column1:1(int) column3:3(tuple{unknown, unknown})
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── cast: int [type=int]
 │         │    └── null [type=unknown]
 │         └── tuple [type=tuple{unknown, unknown}]
 │              ├── null [type=unknown]
 │              └── null [type=unknown]
 └── aggregations [outer=(1,3)]
      ├── function: count [type=int, outer=(1)]
      │    └── variable: column1 [type=int, outer=(1)]
      └── function: count [type=int, outer=(3)]
           └── variable: column3 [type=tuple{unknown, unknown}, outer=(3)]

build
SELECT MIN(k), MAX(k), MIN(v), MAX(v) FROM t.kv
----
group-by
 ├── columns: column5:5(int) column6:6(int) column7:7(int) column8:8(int)
 ├── project
 │    ├── columns: kv.k:1(int!null) kv.k:1(int!null) kv.v:2(int) kv.v:2(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1,2)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(1,2)]
      ├── function: min [type=int, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      ├── function: max [type=int, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      ├── function: min [type=int, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      └── function: max [type=int, outer=(2)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT MIN(k), MAX(k), MIN(v), MAX(v) FROM t.kv WHERE k > 8
----
group-by
 ├── columns: column5:5(int) column6:6(int) column7:7(int) column8:8(int)
 ├── project
 │    ├── columns: kv.k:1(int!null) kv.k:1(int!null) kv.v:2(int) kv.v:2(int)
 │    ├── select
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── gt [type=bool, outer=(1)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── const: 8 [type=int]
 │    └── projections [outer=(1,2)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(1,2)]
      ├── function: min [type=int, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      ├── function: max [type=int, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      ├── function: min [type=int, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      └── function: max [type=int, outer=(2)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT array_agg(s) FROM t.kv WHERE s IS NULL
----
group-by
 ├── columns: column5:5(string[])
 ├── project
 │    ├── columns: kv.s:4(string)
 │    ├── select
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── is [type=bool, outer=(4)]
 │    │         ├── variable: kv.s [type=string, outer=(4)]
 │    │         └── null [type=unknown]
 │    └── projections [outer=(4)]
 │         └── variable: kv.s [type=string, outer=(4)]
 └── aggregations [outer=(4)]
      └── function: array_agg [type=string[], outer=(4)]
           └── variable: kv.s [type=string, outer=(4)]

build
SELECT AVG(k), AVG(v), SUM(k), SUM(v) FROM t.kv
----
group-by
 ├── columns: column5:5(decimal) column6:6(decimal) column7:7(decimal) column8:8(decimal)
 ├── project
 │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.k:1(int!null) kv.v:2(int)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1,2)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         ├── variable: kv.v [type=int, outer=(2)]
 │         ├── variable: kv.k [type=int, outer=(1)]
 │         └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(1,2)]
      ├── function: avg [type=decimal, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      ├── function: avg [type=decimal, outer=(2)]
      │    └── variable: kv.v [type=int, outer=(2)]
      ├── function: sum [type=decimal, outer=(1)]
      │    └── variable: kv.k [type=int, outer=(1)]
      └── function: sum [type=decimal, outer=(2)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT AVG(k::decimal), AVG(v::decimal), SUM(k::decimal), SUM(v::decimal) FROM kv
----
group-by
 ├── columns: column6:6(decimal) column8:8(decimal) column10:10(decimal) column12:12(decimal)
 ├── project
 │    ├── columns: column5:5(decimal) column7:7(decimal) column9:9(decimal) column11:11(decimal)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── projections [outer=(1,2)]
 │         ├── cast: decimal [type=decimal, outer=(1)]
 │         │    └── variable: kv.k [type=int, outer=(1)]
 │         ├── cast: decimal [type=decimal, outer=(2)]
 │         │    └── variable: kv.v [type=int, outer=(2)]
 │         ├── cast: decimal [type=decimal, outer=(1)]
 │         │    └── variable: kv.k [type=int, outer=(1)]
 │         └── cast: decimal [type=decimal, outer=(2)]
 │              └── variable: kv.v [type=int, outer=(2)]
 └── aggregations [outer=(5,7,9,11)]
      ├── function: avg [type=decimal, outer=(5)]
      │    └── variable: column5 [type=decimal, outer=(5)]
      ├── function: avg [type=decimal, outer=(7)]
      │    └── variable: column7 [type=decimal, outer=(7)]
      ├── function: sum [type=decimal, outer=(9)]
      │    └── variable: column9 [type=decimal, outer=(9)]
      └── function: sum [type=decimal, outer=(11)]
           └── variable: column11 [type=decimal, outer=(11)]

build
SELECT AVG(k) * 2.0 + MAX(v)::DECIMAL FROM kv
----
project
 ├── columns: column7:7(decimal)
 ├── group-by
 │    ├── columns: column5:5(decimal) column6:6(int)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,2)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations [outer=(1,2)]
 │         ├── function: avg [type=decimal, outer=(1)]
 │         │    └── variable: kv.k [type=int, outer=(1)]
 │         └── function: max [type=int, outer=(2)]
 │              └── variable: kv.v [type=int, outer=(2)]
 └── projections [outer=(5,6)]
      └── plus [type=decimal, outer=(5,6)]
           ├── mult [type=decimal, outer=(5)]
           │    ├── variable: column5 [type=decimal, outer=(5)]
           │    └── const: 2.0 [type=decimal]
           └── cast: decimal [type=decimal, outer=(6)]
                └── variable: column6 [type=int, outer=(6)]

build
SELECT AVG(k) * 2.0 + MAX(v)::DECIMAL FROM kv WHERE w*2 = k
----
project
 ├── columns: column7:7(decimal)
 ├── group-by
 │    ├── columns: column5:5(decimal) column6:6(int)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int)
 │    │    ├── select
 │    │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    │    ├── scan
 │    │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    │    └── eq [type=bool, outer=(1,3)]
 │    │    │         ├── mult [type=int, outer=(3)]
 │    │    │         │    ├── variable: kv.w [type=int, outer=(3)]
 │    │    │         │    └── const: 2 [type=int]
 │    │    │         └── variable: kv.k [type=int, outer=(1)]
 │    │    └── projections [outer=(1,2)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations [outer=(1,2)]
 │         ├── function: avg [type=decimal, outer=(1)]
 │         │    └── variable: kv.k [type=int, outer=(1)]
 │         └── function: max [type=int, outer=(2)]
 │              └── variable: kv.v [type=int, outer=(2)]
 └── projections [outer=(5,6)]
      └── plus [type=decimal, outer=(5,6)]
           ├── mult [type=decimal, outer=(5)]
           │    ├── variable: column5 [type=decimal, outer=(5)]
           │    └── const: 2.0 [type=decimal]
           └── cast: decimal [type=decimal, outer=(6)]
                └── variable: column6 [type=int, outer=(6)]

exec-ddl
CREATE TABLE t.abc (
  a CHAR PRIMARY KEY,
  b FLOAT,
  c BOOLEAN,
  d DECIMAL
)
----
TABLE abc
 ├── a string not null
 ├── b float
 ├── c bool
 ├── d decimal
 └── INDEX primary
      └── a string not null

build
SELECT MIN(a), MIN(b), MIN(c), MIN(d) FROM t.abc
----
group-by
 ├── columns: column5:5(string) column6:6(float) column7:7(bool) column8:8(decimal)
 ├── scan
 │    └── columns: abc.a:1(string!null) abc.b:2(float) abc.c:3(bool) abc.d:4(decimal)
 └── aggregations [outer=(1-4)]
      ├── function: min [type=string, outer=(1)]
      │    └── variable: abc.a [type=string, outer=(1)]
      ├── function: min [type=float, outer=(2)]
      │    └── variable: abc.b [type=float, outer=(2)]
      ├── function: min [type=bool, outer=(3)]
      │    └── variable: abc.c [type=bool, outer=(3)]
      └── function: min [type=decimal, outer=(4)]
           └── variable: abc.d [type=decimal, outer=(4)]

build
SELECT MAX(a), MAX(b), MAX(c), MAX(d) FROM t.abc
----
group-by
 ├── columns: column5:5(string) column6:6(float) column7:7(bool) column8:8(decimal)
 ├── scan
 │    └── columns: abc.a:1(string!null) abc.b:2(float) abc.c:3(bool) abc.d:4(decimal)
 └── aggregations [outer=(1-4)]
      ├── function: max [type=string, outer=(1)]
      │    └── variable: abc.a [type=string, outer=(1)]
      ├── function: max [type=float, outer=(2)]
      │    └── variable: abc.b [type=float, outer=(2)]
      ├── function: max [type=bool, outer=(3)]
      │    └── variable: abc.c [type=bool, outer=(3)]
      └── function: max [type=decimal, outer=(4)]
           └── variable: abc.d [type=decimal, outer=(4)]

build
SELECT AVG(b), SUM(b), AVG(d), SUM(d) FROM t.abc
----
group-by
 ├── columns: column5:5(float) column6:6(float) column7:7(decimal) column8:8(decimal)
 ├── project
 │    ├── columns: abc.b:2(float) abc.b:2(float) abc.d:4(decimal) abc.d:4(decimal)
 │    ├── scan
 │    │    └── columns: abc.a:1(string!null) abc.b:2(float) abc.c:3(bool) abc.d:4(decimal)
 │    └── projections [outer=(2,4)]
 │         ├── variable: abc.b [type=float, outer=(2)]
 │         ├── variable: abc.b [type=float, outer=(2)]
 │         ├── variable: abc.d [type=decimal, outer=(4)]
 │         └── variable: abc.d [type=decimal, outer=(4)]
 └── aggregations [outer=(2,4)]
      ├── function: avg [type=float, outer=(2)]
      │    └── variable: abc.b [type=float, outer=(2)]
      ├── function: sum [type=float, outer=(2)]
      │    └── variable: abc.b [type=float, outer=(2)]
      ├── function: avg [type=decimal, outer=(4)]
      │    └── variable: abc.d [type=decimal, outer=(4)]
      └── function: sum [type=decimal, outer=(4)]
           └── variable: abc.d [type=decimal, outer=(4)]

# Verify summing of intervals
exec-ddl
CREATE TABLE t.intervals (
  a INTERVAL PRIMARY KEY
)
----
TABLE intervals
 ├── a interval not null
 └── INDEX primary
      └── a interval not null

build
SELECT SUM(a) FROM t.intervals
----
group-by
 ├── columns: column2:2(interval)
 ├── scan
 │    └── columns: intervals.a:1(interval!null)
 └── aggregations [outer=(1)]
      └── function: sum [type=interval, outer=(1)]
           └── variable: intervals.a [type=interval, outer=(1)]

build
SELECT AVG(a) FROM t.abc
----
error: unknown signature: avg(string)

build
SELECT AVG(c) FROM t.abc
----
error: unknown signature: avg(bool)

build
SELECT AVG((a,c)) FROM t.abc
----
error: unknown signature: avg(tuple{string, bool})

build
SELECT SUM(a) FROM t.abc
----
error: unknown signature: sum(string)

build
SELECT SUM(c) FROM t.abc
----
error: unknown signature: sum(bool)

build
SELECT SUM((a,c)) FROM t.abc
----
error: unknown signature: sum(tuple{string, bool})

exec-ddl
CREATE TABLE t.xyz (
  x INT PRIMARY KEY,
  y INT,
  z FLOAT,
  INDEX xy (x, y),
  INDEX zyx (z, y, x),
  FAMILY (x),
  FAMILY (y),
  FAMILY (z)
)
----
TABLE xyz
 ├── x int not null
 ├── y int
 ├── z float
 ├── INDEX primary
 │    └── x int not null
 ├── INDEX xy
 │    ├── x int not null
 │    └── y int
 └── INDEX zyx
      ├── z float
      ├── y int
      └── x int not null

build
SELECT MIN(x) FROM t.xyz
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── scan
 │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: min [type=int, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT MIN(x) FROM t.xyz WHERE x in (0, 4, 7)
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── in [type=bool, outer=(1)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         └── tuple [type=tuple{int, int, int}]
 │    │              ├── const: 0 [type=int]
 │    │              ├── const: 4 [type=int]
 │    │              └── const: 7 [type=int]
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: min [type=int, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT MAX(x) FROM t.xyz
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── scan
 │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: max [type=int, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT MAX(y) FROM t.xyz WHERE x = 1
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.y:2(int)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(1)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         └── const: 1 [type=int]
 │    └── projections [outer=(2)]
 │         └── variable: xyz.y [type=int, outer=(2)]
 └── aggregations [outer=(2)]
      └── function: max [type=int, outer=(2)]
           └── variable: xyz.y [type=int, outer=(2)]

build
SELECT MIN(y) FROM t.xyz WHERE x = 7
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.y:2(int)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(1)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         └── const: 7 [type=int]
 │    └── projections [outer=(2)]
 │         └── variable: xyz.y [type=int, outer=(2)]
 └── aggregations [outer=(2)]
      └── function: min [type=int, outer=(2)]
           └── variable: xyz.y [type=int, outer=(2)]

build
SELECT MIN(x) FROM t.xyz WHERE (y, z) = (2, 3.0)
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(2,3)]
 │    │         ├── tuple [type=tuple{int, float}, outer=(2,3)]
 │    │         │    ├── variable: xyz.y [type=int, outer=(2)]
 │    │         │    └── variable: xyz.z [type=float, outer=(3)]
 │    │         └── tuple [type=tuple{int, float}]
 │    │              ├── const: 2 [type=int]
 │    │              └── const: 3.0 [type=float]
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: min [type=int, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT MAX(x) FROM t.xyz WHERE (z, y) = (3.0, 2)
----
group-by
 ├── columns: column4:4(int)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(2,3)]
 │    │         ├── tuple [type=tuple{float, int}, outer=(2,3)]
 │    │         │    ├── variable: xyz.z [type=float, outer=(3)]
 │    │         │    └── variable: xyz.y [type=int, outer=(2)]
 │    │         └── tuple [type=tuple{float, int}]
 │    │              ├── const: 3.0 [type=float]
 │    │              └── const: 2 [type=int]
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: max [type=int, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]


# VARIANCE/STDDEV

build
SELECT VARIANCE(x), VARIANCE(y::decimal), round(VARIANCE(z), 14) FROM xyz
----
project
 ├── columns: column4:4(decimal) column6:6(decimal) column8:8(float)
 ├── group-by
 │    ├── columns: column4:4(decimal) column6:6(decimal) column7:7(float)
 │    ├── project
 │    │    ├── columns: xyz.x:1(int!null) column5:5(decimal) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         ├── cast: decimal [type=decimal, outer=(2)]
 │    │         │    └── variable: xyz.y [type=int, outer=(2)]
 │    │         └── variable: xyz.z [type=float, outer=(3)]
 │    └── aggregations [outer=(1,3,5)]
 │         ├── function: variance [type=decimal, outer=(1)]
 │         │    └── variable: xyz.x [type=int, outer=(1)]
 │         ├── function: variance [type=decimal, outer=(5)]
 │         │    └── variable: column5 [type=decimal, outer=(5)]
 │         └── function: variance [type=float, outer=(3)]
 │              └── variable: xyz.z [type=float, outer=(3)]
 └── projections [outer=(4,6,7)]
      ├── variable: column4 [type=decimal, outer=(4)]
      ├── variable: column6 [type=decimal, outer=(6)]
      └── function: round [type=float, outer=(7)]
           ├── variable: column7 [type=float, outer=(7)]
           └── const: 14 [type=int]

build
SELECT VARIANCE(x) FROM t.xyz WHERE x = 10
----
group-by
 ├── columns: column4:4(decimal)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(1)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         └── const: 10 [type=int]
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: variance [type=decimal, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT STDDEV(x), STDDEV(y::decimal), round(STDDEV(z), 14) FROM xyz
----
project
 ├── columns: column4:4(decimal) column6:6(decimal) column8:8(float)
 ├── group-by
 │    ├── columns: column4:4(decimal) column6:6(decimal) column7:7(float)
 │    ├── project
 │    │    ├── columns: xyz.x:1(int!null) column5:5(decimal) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         ├── cast: decimal [type=decimal, outer=(2)]
 │    │         │    └── variable: xyz.y [type=int, outer=(2)]
 │    │         └── variable: xyz.z [type=float, outer=(3)]
 │    └── aggregations [outer=(1,3,5)]
 │         ├── function: stddev [type=decimal, outer=(1)]
 │         │    └── variable: xyz.x [type=int, outer=(1)]
 │         ├── function: stddev [type=decimal, outer=(5)]
 │         │    └── variable: column5 [type=decimal, outer=(5)]
 │         └── function: stddev [type=float, outer=(3)]
 │              └── variable: xyz.z [type=float, outer=(3)]
 └── projections [outer=(4,6,7)]
      ├── variable: column4 [type=decimal, outer=(4)]
      ├── variable: column6 [type=decimal, outer=(6)]
      └── function: round [type=float, outer=(7)]
           ├── variable: column7 [type=float, outer=(7)]
           └── const: 14 [type=int]

build
SELECT STDDEV(x) FROM t.xyz WHERE x = 1
----
group-by
 ├── columns: column4:4(decimal)
 ├── project
 │    ├── columns: xyz.x:1(int!null)
 │    ├── select
 │    │    ├── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    ├── scan
 │    │    │    └── columns: xyz.x:1(int!null) xyz.y:2(int) xyz.z:3(float)
 │    │    └── eq [type=bool, outer=(1)]
 │    │         ├── variable: xyz.x [type=int, outer=(1)]
 │    │         └── const: 1 [type=int]
 │    └── projections [outer=(1)]
 │         └── variable: xyz.x [type=int, outer=(1)]
 └── aggregations [outer=(1)]
      └── function: stddev [type=decimal, outer=(1)]
           └── variable: xyz.x [type=int, outer=(1)]

build
SELECT AVG(1::int)::float, AVG(2::float)::float, AVG(3::decimal)::float
----
project
 ├── columns: column3:3(float) column6:6(float) column9:9(float)
 ├── group-by
 │    ├── columns: column2:2(decimal) column5:5(float) column8:8(decimal)
 │    ├── project
 │    │    ├── columns: column1:1(int) column4:4(float) column7:7(decimal)
 │    │    ├── values
 │    │    │    └── tuple [type=tuple{}]
 │    │    └── projections
 │    │         ├── cast: int [type=int]
 │    │         │    └── const: 1 [type=int]
 │    │         ├── cast: float [type=float]
 │    │         │    └── const: 2.0 [type=float]
 │    │         └── cast: decimal [type=decimal]
 │    │              └── const: 3 [type=decimal]
 │    └── aggregations [outer=(1,4,7)]
 │         ├── function: avg [type=decimal, outer=(1)]
 │         │    └── variable: column1 [type=int, outer=(1)]
 │         ├── function: avg [type=float, outer=(4)]
 │         │    └── variable: column4 [type=float, outer=(4)]
 │         └── function: avg [type=decimal, outer=(7)]
 │              └── variable: column7 [type=decimal, outer=(7)]
 └── projections [outer=(2,5,8)]
      ├── cast: float [type=float, outer=(2)]
      │    └── variable: column2 [type=decimal, outer=(2)]
      ├── cast: float [type=float, outer=(5)]
      │    └── variable: column5 [type=float, outer=(5)]
      └── cast: float [type=float, outer=(8)]
           └── variable: column8 [type=decimal, outer=(8)]

build
SELECT COUNT(2::int), COUNT(3::float), COUNT(4::decimal)
----
group-by
 ├── columns: column2:2(int) column4:4(int) column6:6(int)
 ├── project
 │    ├── columns: column1:1(int) column3:3(float) column5:5(decimal)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── cast: int [type=int]
 │         │    └── const: 2 [type=int]
 │         ├── cast: float [type=float]
 │         │    └── const: 3.0 [type=float]
 │         └── cast: decimal [type=decimal]
 │              └── const: 4 [type=decimal]
 └── aggregations [outer=(1,3,5)]
      ├── function: count [type=int, outer=(1)]
      │    └── variable: column1 [type=int, outer=(1)]
      ├── function: count [type=int, outer=(3)]
      │    └── variable: column3 [type=float, outer=(3)]
      └── function: count [type=int, outer=(5)]
           └── variable: column5 [type=decimal, outer=(5)]

build
SELECT SUM(1::int), SUM(2::float), SUM(3::decimal)
----
group-by
 ├── columns: column2:2(decimal) column4:4(float) column6:6(decimal)
 ├── project
 │    ├── columns: column1:1(int) column3:3(float) column5:5(decimal)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── cast: int [type=int]
 │         │    └── const: 1 [type=int]
 │         ├── cast: float [type=float]
 │         │    └── const: 2.0 [type=float]
 │         └── cast: decimal [type=decimal]
 │              └── const: 3 [type=decimal]
 └── aggregations [outer=(1,3,5)]
      ├── function: sum [type=decimal, outer=(1)]
      │    └── variable: column1 [type=int, outer=(1)]
      ├── function: sum [type=float, outer=(3)]
      │    └── variable: column3 [type=float, outer=(3)]
      └── function: sum [type=decimal, outer=(5)]
           └── variable: column5 [type=decimal, outer=(5)]

build
SELECT VARIANCE(1::int), VARIANCE(1::float), VARIANCE(1::decimal)
----
group-by
 ├── columns: column2:2(decimal) column4:4(float) column6:6(decimal)
 ├── project
 │    ├── columns: column1:1(int) column3:3(float) column5:5(decimal)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── cast: int [type=int]
 │         │    └── const: 1 [type=int]
 │         ├── cast: float [type=float]
 │         │    └── const: 1.0 [type=float]
 │         └── cast: decimal [type=decimal]
 │              └── const: 1 [type=decimal]
 └── aggregations [outer=(1,3,5)]
      ├── function: variance [type=decimal, outer=(1)]
      │    └── variable: column1 [type=int, outer=(1)]
      ├── function: variance [type=float, outer=(3)]
      │    └── variable: column3 [type=float, outer=(3)]
      └── function: variance [type=decimal, outer=(5)]
           └── variable: column5 [type=decimal, outer=(5)]

build
SELECT STDDEV(1::int), STDDEV(1::float), STDDEV(1::decimal)
----
group-by
 ├── columns: column2:2(decimal) column4:4(float) column6:6(decimal)
 ├── project
 │    ├── columns: column1:1(int) column3:3(float) column5:5(decimal)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── cast: int [type=int]
 │         │    └── const: 1 [type=int]
 │         ├── cast: float [type=float]
 │         │    └── const: 1.0 [type=float]
 │         └── cast: decimal [type=decimal]
 │              └── const: 1 [type=decimal]
 └── aggregations [outer=(1,3,5)]
      ├── function: stddev [type=decimal, outer=(1)]
      │    └── variable: column1 [type=int, outer=(1)]
      ├── function: stddev [type=float, outer=(3)]
      │    └── variable: column3 [type=float, outer=(3)]
      └── function: stddev [type=decimal, outer=(5)]
           └── variable: column5 [type=decimal, outer=(5)]

exec-ddl
CREATE TABLE t.bools (b BOOL)
----
TABLE bools
 ├── b bool
 ├── rowid int not null (hidden)
 └── INDEX primary
      └── rowid int not null (hidden)

build
SELECT BOOL_AND(b), BOOL_OR(b) FROM t.bools
----
group-by
 ├── columns: column3:3(bool) column4:4(bool)
 ├── project
 │    ├── columns: bools.b:1(bool) bools.b:1(bool)
 │    ├── scan
 │    │    └── columns: bools.b:1(bool) bools.rowid:2(int!null)
 │    └── projections [outer=(1)]
 │         ├── variable: bools.b [type=bool, outer=(1)]
 │         └── variable: bools.b [type=bool, outer=(1)]
 └── aggregations [outer=(1)]
      ├── function: bool_and [type=bool, outer=(1)]
      │    └── variable: bools.b [type=bool, outer=(1)]
      └── function: bool_or [type=bool, outer=(1)]
           └── variable: bools.b [type=bool, outer=(1)]


# Tests with * inside GROUP BY.
build
SELECT 1 FROM t.kv GROUP BY kv.*;
----
project
 ├── columns: column5:5(int)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    ├── grouping columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    ├── scan
 │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    └── aggregations
 └── projections
      └── const: 1 [type=int]

exec-ddl
CREATE TABLE t.xor_bytes (a bytes, b int, c int)
----
TABLE xor_bytes
 ├── a bytes
 ├── b int
 ├── c int
 ├── rowid int not null (hidden)
 └── INDEX primary
      └── rowid int not null (hidden)

build
SELECT TO_HEX(XOR_AGG(a)), XOR_AGG(c) FROM t.xor_bytes
----
project
 ├── columns: column6:6(string) column7:7(int)
 ├── group-by
 │    ├── columns: column5:5(bytes) column7:7(int)
 │    ├── project
 │    │    ├── columns: xor_bytes.a:1(bytes) xor_bytes.c:3(int)
 │    │    ├── scan
 │    │    │    └── columns: xor_bytes.a:1(bytes) xor_bytes.b:2(int) xor_bytes.c:3(int) xor_bytes.rowid:4(int!null)
 │    │    └── projections [outer=(1,3)]
 │    │         ├── variable: xor_bytes.a [type=bytes, outer=(1)]
 │    │         └── variable: xor_bytes.c [type=int, outer=(3)]
 │    └── aggregations [outer=(1,3)]
 │         ├── function: xor_agg [type=bytes, outer=(1)]
 │         │    └── variable: xor_bytes.a [type=bytes, outer=(1)]
 │         └── function: xor_agg [type=int, outer=(3)]
 │              └── variable: xor_bytes.c [type=int, outer=(3)]
 └── projections [outer=(5,7)]
      ├── function: to_hex [type=string, outer=(5)]
      │    └── variable: column5 [type=bytes, outer=(5)]
      └── variable: column7 [type=int, outer=(7)]

build
SELECT MAX(true), MIN(true)
----
group-by
 ├── columns: column2:2(bool) column4:4(bool)
 ├── project
 │    ├── columns: column1:1(bool) column3:3(bool)
 │    ├── values
 │    │    └── tuple [type=tuple{}]
 │    └── projections
 │         ├── true [type=bool]
 │         └── true [type=bool]
 └── aggregations [outer=(1,3)]
      ├── function: max [type=bool, outer=(1)]
      │    └── variable: column1 [type=bool, outer=(1)]
      └── function: min [type=bool, outer=(3)]
           └── variable: column3 [type=bool, outer=(3)]

exec-ddl
CREATE TABLE t.ab (
  a INT PRIMARY KEY,
  b INT,
  FAMILY (a),
  FAMILY (b)
)
----
TABLE ab
 ├── a int not null
 ├── b int
 └── INDEX primary
      └── a int not null

exec-ddl
CREATE TABLE t.xy(x STRING, y STRING);
----
TABLE xy
 ├── x string
 ├── y string
 ├── rowid int not null (hidden)
 └── INDEX primary
      └── rowid int not null (hidden)

# Grouping and rendering tuples.
build
SELECT (b, a) FROM t.ab GROUP BY (b, a)
----
project
 ├── columns: column3:3(tuple{int, int})
 ├── group-by
 │    ├── columns: ab.a:1(int!null) ab.b:2(int)
 │    ├── grouping columns: ab.a:1(int!null) ab.b:2(int)
 │    ├── project
 │    │    ├── columns: ab.b:2(int) ab.a:1(int!null)
 │    │    ├── scan
 │    │    │    └── columns: ab.a:1(int!null) ab.b:2(int)
 │    │    └── projections [outer=(1,2)]
 │    │         ├── variable: ab.b [type=int, outer=(2)]
 │    │         └── variable: ab.a [type=int, outer=(1)]
 │    └── aggregations
 └── projections [outer=(1,2)]
      └── tuple [type=tuple{int, int}, outer=(1,2)]
           ├── variable: ab.b [type=int, outer=(2)]
           └── variable: ab.a [type=int, outer=(1)]

build
SELECT MIN(y), (b, a)
 FROM t.ab, t.xy GROUP BY (x, (a, b))
----
project
 ├── columns: column6:6(string) column7:7(tuple{int, int})
 ├── group-by
 │    ├── columns: ab.a:1(int!null) ab.b:2(int) xy.x:3(string) column6:6(string)
 │    ├── grouping columns: ab.a:1(int!null) ab.b:2(int) xy.x:3(string)
 │    ├── project
 │    │    ├── columns: xy.x:3(string) ab.a:1(int!null) ab.b:2(int) xy.y:4(string)
 │    │    ├── inner-join
 │    │    │    ├── columns: ab.a:1(int!null) ab.b:2(int) xy.x:3(string) xy.y:4(string) xy.rowid:5(int!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: ab.a:1(int!null) ab.b:2(int)
 │    │    │    ├── scan
 │    │    │    │    └── columns: xy.x:3(string) xy.y:4(string) xy.rowid:5(int!null)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1-4)]
 │    │         ├── variable: xy.x [type=string, outer=(3)]
 │    │         ├── variable: ab.a [type=int, outer=(1)]
 │    │         ├── variable: ab.b [type=int, outer=(2)]
 │    │         └── variable: xy.y [type=string, outer=(4)]
 │    └── aggregations [outer=(4)]
 │         └── function: min [type=string, outer=(4)]
 │              └── variable: xy.y [type=string, outer=(4)]
 └── projections [outer=(1,2,6)]
      ├── variable: column6 [type=string, outer=(6)]
      └── tuple [type=tuple{int, int}, outer=(1,2)]
           ├── variable: ab.b [type=int, outer=(2)]
           └── variable: ab.a [type=int, outer=(1)]

build
SELECT (k+v)/(v+w) FROM t.kv GROUP BY k+v, v+w;
----
project
 ├── columns: column7:7(decimal)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── grouping columns: column5:5(int) column6:6(int)
 │    ├── project
 │    │    ├── columns: column5:5(int) column6:6(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── plus [type=int, outer=(1,2)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── variable: kv.v [type=int, outer=(2)]
 │    │         └── plus [type=int, outer=(2,3)]
 │    │              ├── variable: kv.v [type=int, outer=(2)]
 │    │              └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations
 └── projections [outer=(1-3)]
      └── div [type=decimal, outer=(1-3)]
           ├── plus [type=int, outer=(1,2)]
           │    ├── variable: kv.k [type=int, outer=(1)]
           │    └── variable: kv.v [type=int, outer=(2)]
           └── plus [type=int, outer=(2,3)]
                ├── variable: kv.v [type=int, outer=(2)]
                └── variable: kv.w [type=int, outer=(3)]

# Check that everything still works with differently qualified names
build
SELECT SUM(t.kv.w), t.kv.v FROM t.kv GROUP BY v, kv.k * w
----
project
 ├── columns: column6:6(decimal) v:2(int)
 ├── group-by
 │    ├── columns: kv.v:2(int) column5:5(int) column6:6(decimal)
 │    ├── grouping columns: kv.v:2(int) column5:5(int)
 │    ├── project
 │    │    ├── columns: kv.v:2(int) column5:5(int) kv.w:3(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── variable: kv.v [type=int, outer=(2)]
 │    │         ├── mult [type=int, outer=(1,3)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── variable: kv.w [type=int, outer=(3)]
 │    │         └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations [outer=(3)]
 │         └── function: sum [type=decimal, outer=(3)]
 │              └── variable: kv.w [type=int, outer=(3)]
 └── projections [outer=(2,6)]
      ├── variable: column6 [type=decimal, outer=(6)]
      └── variable: kv.v [type=int, outer=(2)]

build
SELECT SUM(t.kv.w), LOWER(s), t.kv.v + k * t.kv.w, t.kv.v FROM t.kv GROUP BY v, LOWER(kv.s), kv.k * w
----
project
 ├── columns: column7:7(decimal) column5:5(string) column8:8(int) v:2(int)
 ├── group-by
 │    ├── columns: kv.v:2(int) column5:5(string) column6:6(int) column7:7(decimal)
 │    ├── grouping columns: kv.v:2(int) column5:5(string) column6:6(int)
 │    ├── project
 │    │    ├── columns: kv.v:2(int) column5:5(string) column6:6(int) kv.w:3(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-4)]
 │    │         ├── variable: kv.v [type=int, outer=(2)]
 │    │         ├── function: lower [type=string, outer=(4)]
 │    │         │    └── variable: kv.s [type=string, outer=(4)]
 │    │         ├── mult [type=int, outer=(1,3)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── variable: kv.w [type=int, outer=(3)]
 │    │         └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations [outer=(3)]
 │         └── function: sum [type=decimal, outer=(3)]
 │              └── variable: kv.w [type=int, outer=(3)]
 └── projections [outer=(1-3,5,7)]
      ├── variable: column7 [type=decimal, outer=(7)]
      ├── variable: column5 [type=string, outer=(5)]
      ├── plus [type=int, outer=(1-3)]
      │    ├── variable: kv.v [type=int, outer=(2)]
      │    └── mult [type=int, outer=(1,3)]
      │         ├── variable: kv.k [type=int, outer=(1)]
      │         └── variable: kv.w [type=int, outer=(3)]
      └── variable: kv.v [type=int, outer=(2)]

# Check all the different types of scalar expressions as group by columns
build
SELECT b1.b AND abc.c AND b2.b FROM bools b1, bools b2, abc GROUP BY b1.b AND abc.c, b2.b
----
project
 ├── columns: column10:10(bool)
 ├── group-by
 │    ├── columns: bools.b:3(bool) column9:9(bool)
 │    ├── grouping columns: bools.b:3(bool) column9:9(bool)
 │    ├── project
 │    │    ├── columns: column9:9(bool) bools.b:3(bool)
 │    │    ├── inner-join
 │    │    │    ├── columns: bools.b:1(bool) bools.rowid:2(int!null) bools.b:3(bool) bools.rowid:4(int!null) abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    ├── inner-join
 │    │    │    │    ├── columns: bools.b:1(bool) bools.rowid:2(int!null) bools.b:3(bool) bools.rowid:4(int!null)
 │    │    │    │    ├── scan
 │    │    │    │    │    └── columns: bools.b:1(bool) bools.rowid:2(int!null)
 │    │    │    │    ├── scan
 │    │    │    │    │    └── columns: bools.b:3(bool) bools.rowid:4(int!null)
 │    │    │    │    └── true [type=bool]
 │    │    │    ├── scan
 │    │    │    │    └── columns: abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1,3,7)]
 │    │         ├── and [type=bool, outer=(1,7)]
 │    │         │    ├── variable: bools.b [type=bool, outer=(1)]
 │    │         │    └── variable: abc.c [type=bool, outer=(7)]
 │    │         └── variable: bools.b [type=bool, outer=(3)]
 │    └── aggregations
 └── projections [outer=(1,3,7)]
      └── and [type=bool, outer=(1,3,7)]
           ├── and [type=bool, outer=(1,7)]
           │    ├── variable: bools.b [type=bool, outer=(1)]
           │    └── variable: abc.c [type=bool, outer=(7)]
           └── variable: bools.b [type=bool, outer=(3)]

build
SELECT b1.b AND abc.c AND abc.c FROM bools b1, bools b2, abc GROUP BY b1.b AND abc.c, b2.b
----
error: column "abc.c" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT b1.b OR abc.c OR b2.b FROM bools b1, bools b2, abc GROUP BY b1.b OR abc.c, b2.b
----
project
 ├── columns: column10:10(bool)
 ├── group-by
 │    ├── columns: bools.b:3(bool) column9:9(bool)
 │    ├── grouping columns: bools.b:3(bool) column9:9(bool)
 │    ├── project
 │    │    ├── columns: column9:9(bool) bools.b:3(bool)
 │    │    ├── inner-join
 │    │    │    ├── columns: bools.b:1(bool) bools.rowid:2(int!null) bools.b:3(bool) bools.rowid:4(int!null) abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    ├── inner-join
 │    │    │    │    ├── columns: bools.b:1(bool) bools.rowid:2(int!null) bools.b:3(bool) bools.rowid:4(int!null)
 │    │    │    │    ├── scan
 │    │    │    │    │    └── columns: bools.b:1(bool) bools.rowid:2(int!null)
 │    │    │    │    ├── scan
 │    │    │    │    │    └── columns: bools.b:3(bool) bools.rowid:4(int!null)
 │    │    │    │    └── true [type=bool]
 │    │    │    ├── scan
 │    │    │    │    └── columns: abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1,3,7)]
 │    │         ├── or [type=bool, outer=(1,7)]
 │    │         │    ├── variable: bools.b [type=bool, outer=(1)]
 │    │         │    └── variable: abc.c [type=bool, outer=(7)]
 │    │         └── variable: bools.b [type=bool, outer=(3)]
 │    └── aggregations
 └── projections [outer=(1,3,7)]
      └── or [type=bool, outer=(1,3,7)]
           ├── or [type=bool, outer=(1,7)]
           │    ├── variable: bools.b [type=bool, outer=(1)]
           │    └── variable: abc.c [type=bool, outer=(7)]
           └── variable: bools.b [type=bool, outer=(3)]

build
SELECT b1.b OR abc.c OR abc.c FROM bools b1, bools b2, abc GROUP BY b1.b OR abc.c, b2.b
----
error: column "abc.c" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT k % w % v FROM kv GROUP BY k % w, v
----
project
 ├── columns: column6:6(int)
 ├── group-by
 │    ├── columns: kv.v:2(int) column5:5(int)
 │    ├── grouping columns: kv.v:2(int) column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int) kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── mod [type=int, outer=(1,3)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── variable: kv.w [type=int, outer=(3)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations
 └── projections [outer=(1-3)]
      └── mod [type=int, outer=(1-3)]
           ├── mod [type=int, outer=(1,3)]
           │    ├── variable: kv.k [type=int, outer=(1)]
           │    └── variable: kv.w [type=int, outer=(3)]
           └── variable: kv.v [type=int, outer=(2)]

build
SELECT CONCAT(CONCAT(s, a), a) FROM kv, abc GROUP BY CONCAT(s, a), a
----
project
 ├── columns: column10:10(string)
 ├── group-by
 │    ├── columns: abc.a:5(string!null) column9:9(string)
 │    ├── grouping columns: abc.a:5(string!null) column9:9(string)
 │    ├── project
 │    │    ├── columns: column9:9(string) abc.a:5(string!null)
 │    │    ├── inner-join
 │    │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string) abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    ├── scan
 │    │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    │    ├── scan
 │    │    │    │    └── columns: abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(4,5)]
 │    │         ├── function: concat [type=string, outer=(4,5)]
 │    │         │    ├── variable: kv.s [type=string, outer=(4)]
 │    │         │    └── variable: abc.a [type=string, outer=(5)]
 │    │         └── variable: abc.a [type=string, outer=(5)]
 │    └── aggregations
 └── projections [outer=(4,5)]
      └── function: concat [type=string, outer=(4,5)]
           ├── function: concat [type=string, outer=(4,5)]
           │    ├── variable: kv.s [type=string, outer=(4)]
           │    └── variable: abc.a [type=string, outer=(5)]
           └── variable: abc.a [type=string, outer=(5)]

build
SELECT CONCAT(CONCAT(s, a), s) FROM kv, abc GROUP BY CONCAT(s, a), a
----
error: column "kv.s" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT k < w AND v != 5 FROM kv GROUP BY k < w, v
----
project
 ├── columns: column6:6(bool)
 ├── group-by
 │    ├── columns: kv.v:2(int) column5:5(bool)
 │    ├── grouping columns: kv.v:2(int) column5:5(bool)
 │    ├── project
 │    │    ├── columns: column5:5(bool) kv.v:2(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1-3)]
 │    │         ├── lt [type=bool, outer=(1,3)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── variable: kv.w [type=int, outer=(3)]
 │    │         └── variable: kv.v [type=int, outer=(2)]
 │    └── aggregations
 └── projections [outer=(1-3)]
      └── and [type=bool, outer=(1-3)]
           ├── lt [type=bool, outer=(1,3)]
           │    ├── variable: kv.k [type=int, outer=(1)]
           │    └── variable: kv.w [type=int, outer=(3)]
           └── ne [type=bool, outer=(2)]
                ├── variable: kv.v [type=int, outer=(2)]
                └── const: 5 [type=int]

build
SELECT k < w AND k < v FROM kv GROUP BY k < w, v
----
error: column "kv.k" must appear in the GROUP BY clause or be used in an aggregate function

exec-ddl
CREATE TABLE foo (bar JSON, baz JSON)
----
TABLE foo
 ├── bar jsonb
 ├── baz jsonb
 ├── rowid int not null (hidden)
 └── INDEX primary
      └── rowid int not null (hidden)

build
SELECT a.bar @> b.baz AND b.baz @> b.baz FROM foo AS a, foo AS b GROUP BY a.bar @> b.baz, b.baz
----
project
 ├── columns: column8:8(bool)
 ├── group-by
 │    ├── columns: foo.baz:5(jsonb) column7:7(bool)
 │    ├── grouping columns: foo.baz:5(jsonb) column7:7(bool)
 │    ├── project
 │    │    ├── columns: column7:7(bool) foo.baz:5(jsonb)
 │    │    ├── inner-join
 │    │    │    ├── columns: foo.bar:1(jsonb) foo.baz:2(jsonb) foo.rowid:3(int!null) foo.bar:4(jsonb) foo.baz:5(jsonb) foo.rowid:6(int!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: foo.bar:1(jsonb) foo.baz:2(jsonb) foo.rowid:3(int!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: foo.bar:4(jsonb) foo.baz:5(jsonb) foo.rowid:6(int!null)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1,5)]
 │    │         ├── contains [type=bool, outer=(1,5)]
 │    │         │    ├── variable: foo.bar [type=jsonb, outer=(1)]
 │    │         │    └── variable: foo.baz [type=jsonb, outer=(5)]
 │    │         └── variable: foo.baz [type=jsonb, outer=(5)]
 │    └── aggregations
 └── projections [outer=(1,5)]
      └── and [type=bool, outer=(1,5)]
           ├── contains [type=bool, outer=(1,5)]
           │    ├── variable: foo.bar [type=jsonb, outer=(1)]
           │    └── variable: foo.baz [type=jsonb, outer=(5)]
           └── contains [type=bool, outer=(5)]
                ├── variable: foo.baz [type=jsonb, outer=(5)]
                └── variable: foo.baz [type=jsonb, outer=(5)]

build
SELECT a.bar @> b.baz AND b.baz @> b.baz FROM foo AS a, foo AS b GROUP BY b.baz <@ a.bar, b.baz
----
error: column "foo.bar" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT b.baz <@ a.bar AND b.baz <@ b.baz FROM foo AS a, foo AS b GROUP BY b.baz <@ a.bar, b.baz
----
project
 ├── columns: column8:8(bool)
 ├── group-by
 │    ├── columns: foo.baz:5(jsonb) column7:7(bool)
 │    ├── grouping columns: foo.baz:5(jsonb) column7:7(bool)
 │    ├── project
 │    │    ├── columns: column7:7(bool) foo.baz:5(jsonb)
 │    │    ├── inner-join
 │    │    │    ├── columns: foo.bar:1(jsonb) foo.baz:2(jsonb) foo.rowid:3(int!null) foo.bar:4(jsonb) foo.baz:5(jsonb) foo.rowid:6(int!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: foo.bar:1(jsonb) foo.baz:2(jsonb) foo.rowid:3(int!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: foo.bar:4(jsonb) foo.baz:5(jsonb) foo.rowid:6(int!null)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1,5)]
 │    │         ├── contains [type=bool, outer=(1,5)]
 │    │         │    ├── variable: foo.bar [type=jsonb, outer=(1)]
 │    │         │    └── variable: foo.baz [type=jsonb, outer=(5)]
 │    │         └── variable: foo.baz [type=jsonb, outer=(5)]
 │    └── aggregations
 └── projections [outer=(1,5)]
      └── and [type=bool, outer=(1,5)]
           ├── contains [type=bool, outer=(1,5)]
           │    ├── variable: foo.bar [type=jsonb, outer=(1)]
           │    └── variable: foo.baz [type=jsonb, outer=(5)]
           └── contains [type=bool, outer=(5)]
                ├── variable: foo.baz [type=jsonb, outer=(5)]
                └── variable: foo.baz [type=jsonb, outer=(5)]

exec-ddl
CREATE TABLE times (t time PRIMARY KEY)
----
TABLE times
 ├── t time not null
 └── INDEX primary
      └── t time not null

build
SELECT date_trunc('second', a.t) - date_trunc('minute', b.t) FROM times a, times b
  GROUP BY date_trunc('second', a.t), date_trunc('minute', b.t)
----
project
 ├── columns: column5:5(interval)
 ├── group-by
 │    ├── columns: column3:3(interval) column4:4(interval)
 │    ├── grouping columns: column3:3(interval) column4:4(interval)
 │    ├── project
 │    │    ├── columns: column3:3(interval) column4:4(interval)
 │    │    ├── inner-join
 │    │    │    ├── columns: times.t:1(time!null) times.t:2(time!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: times.t:1(time!null)
 │    │    │    ├── scan
 │    │    │    │    └── columns: times.t:2(time!null)
 │    │    │    └── true [type=bool]
 │    │    └── projections [outer=(1,2)]
 │    │         ├── function: date_trunc [type=interval, outer=(1)]
 │    │         │    ├── const: 'second' [type=string]
 │    │         │    └── variable: times.t [type=time, outer=(1)]
 │    │         └── function: date_trunc [type=interval, outer=(2)]
 │    │              ├── const: 'minute' [type=string]
 │    │              └── variable: times.t [type=time, outer=(2)]
 │    └── aggregations
 └── projections [outer=(1,2)]
      └── minus [type=interval, outer=(1,2)]
           ├── function: date_trunc [type=interval, outer=(1)]
           │    ├── const: 'second' [type=string]
           │    └── variable: times.t [type=time, outer=(1)]
           └── function: date_trunc [type=interval, outer=(2)]
                ├── const: 'minute' [type=string]
                └── variable: times.t [type=time, outer=(2)]

build
SELECT date_trunc('second', a.t) - date_trunc('second', b.t) FROM times a, times b
  GROUP BY date_trunc('second', a.t), date_trunc('minute', b.t)
----
error: column "times.t" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT NOT b FROM bools GROUP BY NOT b
----
group-by
 ├── columns: column3:3(bool)
 ├── grouping columns: column3:3(bool)
 ├── project
 │    ├── columns: column3:3(bool)
 │    ├── scan
 │    │    └── columns: bools.b:1(bool) bools.rowid:2(int!null)
 │    └── projections [outer=(1)]
 │         └── not [type=bool, outer=(1)]
 │              └── variable: bools.b [type=bool, outer=(1)]
 └── aggregations

build
SELECT b FROM bools GROUP BY NOT b
----
error: column "bools.b" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT NOT b FROM bools GROUP BY b
----
project
 ├── columns: column3:3(bool)
 ├── group-by
 │    ├── columns: bools.b:1(bool)
 │    ├── grouping columns: bools.b:1(bool)
 │    ├── project
 │    │    ├── columns: bools.b:1(bool)
 │    │    ├── scan
 │    │    │    └── columns: bools.b:1(bool) bools.rowid:2(int!null)
 │    │    └── projections [outer=(1)]
 │    │         └── variable: bools.b [type=bool, outer=(1)]
 │    └── aggregations
 └── projections [outer=(1)]
      └── not [type=bool, outer=(1)]
           └── variable: bools.b [type=bool, outer=(1)]

build
SELECT +k * (-w) FROM kv GROUP BY +k, -w
----
project
 ├── columns: column7:7(int)
 ├── group-by
 │    ├── columns: column5:5(int) column6:6(int)
 │    ├── grouping columns: column5:5(int) column6:6(int)
 │    ├── project
 │    │    ├── columns: column5:5(int) column6:6(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,3)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── unary-minus [type=int, outer=(3)]
 │    │              └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations
 └── projections [outer=(1,3)]
      └── mult [type=int, outer=(1,3)]
           ├── variable: kv.k [type=int, outer=(1)]
           └── unary-minus [type=int, outer=(3)]
                └── variable: kv.w [type=int, outer=(3)]

build
SELECT k * (-w) FROM kv GROUP BY +k, -w
----
error: column "kv.k" must appear in the GROUP BY clause or be used in an aggregate function

build
SELECT +k * (-w) FROM kv GROUP BY k, w
----
project
 ├── columns: column5:5(int)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) kv.w:3(int)
 │    ├── grouping columns: kv.k:1(int!null) kv.w:3(int)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.w:3(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,3)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.w [type=int, outer=(3)]
 │    └── aggregations
 └── projections [outer=(1,3)]
      └── mult [type=int, outer=(1,3)]
           ├── variable: kv.k [type=int, outer=(1)]
           └── unary-minus [type=int, outer=(3)]
                └── variable: kv.w [type=int, outer=(3)]

build 
SELECT 1 + MIN(v*2) FROM kv GROUP BY k+3
----
project
 ├── columns: column8:8(int)
 ├── group-by
 │    ├── columns: column5:5(int) column7:7(int)
 │    ├── grouping columns: column5:5(int)
 │    ├── project
 │    │    ├── columns: column5:5(int) column6:6(int)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1,2)]
 │    │         ├── plus [type=int, outer=(1)]
 │    │         │    ├── variable: kv.k [type=int, outer=(1)]
 │    │         │    └── const: 3 [type=int]
 │    │         └── mult [type=int, outer=(2)]
 │    │              ├── variable: kv.v [type=int, outer=(2)]
 │    │              └── const: 2 [type=int]
 │    └── aggregations [outer=(6)]
 │         └── function: min [type=int, outer=(6)]
 │              └── variable: column6 [type=int, outer=(6)]
 └── projections [outer=(7)]
      └── plus [type=int, outer=(7)]
           ├── const: 1 [type=int]
           └── variable: column7 [type=int, outer=(7)]

build
SELECT count(*) FROM kv GROUP BY k, k
----
project
 ├── columns: column5:5(int)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) column5:5(int)
 │    ├── grouping columns: kv.k:1(int!null)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.k:1(int!null)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(1)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         └── variable: kv.k [type=int, outer=(1)]
 │    └── aggregations
 │         └── function: count_rows [type=int]
 └── projections [outer=(5)]
      └── variable: column5 [type=int, outer=(5)]

build
SELECT COUNT(UPPER(s)) FROM t.kv GROUP BY UPPER(s)
----
project
 ├── columns: column7:7(int)
 ├── group-by
 │    ├── columns: column5:5(string) column7:7(int)
 │    ├── grouping columns: column5:5(string)
 │    ├── project
 │    │    ├── columns: column5:5(string) column6:6(string)
 │    │    ├── scan
 │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    └── projections [outer=(4)]
 │    │         ├── function: upper [type=string, outer=(4)]
 │    │         │    └── variable: kv.s [type=string, outer=(4)]
 │    │         └── function: upper [type=string, outer=(4)]
 │    │              └── variable: kv.s [type=string, outer=(4)]
 │    └── aggregations [outer=(6)]
 │         └── function: count [type=int, outer=(6)]
 │              └── variable: column6 [type=string, outer=(6)]
 └── projections [outer=(7)]
      └── variable: column7 [type=int, outer=(7)]

build
SELECT SUM(abc.d) FROM t.kv JOIN t.abc ON kv.k >= abc.d GROUP BY kv.*
----
project
 ├── columns: column9:9(decimal)
 ├── group-by
 │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string) column9:9(decimal)
 │    ├── grouping columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    ├── project
 │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string) abc.d:8(decimal)
 │    │    ├── inner-join
 │    │    │    ├── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string) abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    ├── scan
 │    │    │    │    └── columns: kv.k:1(int!null) kv.v:2(int) kv.w:3(int) kv.s:4(string)
 │    │    │    ├── scan
 │    │    │    │    └── columns: abc.a:5(string!null) abc.b:6(float) abc.c:7(bool) abc.d:8(decimal)
 │    │    │    └── ge [type=bool, outer=(1,8)]
 │    │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │    │         └── variable: abc.d [type=decimal, outer=(8)]
 │    │    └── projections [outer=(1-4,8)]
 │    │         ├── variable: kv.k [type=int, outer=(1)]
 │    │         ├── variable: kv.v [type=int, outer=(2)]
 │    │         ├── variable: kv.w [type=int, outer=(3)]
 │    │         ├── variable: kv.s [type=string, outer=(4)]
 │    │         └── variable: abc.d [type=decimal, outer=(8)]
 │    └── aggregations [outer=(8)]
 │         └── function: sum [type=decimal, outer=(8)]
 │              └── variable: abc.d [type=decimal, outer=(8)]
 └── projections [outer=(9)]
      └── variable: column9 [type=decimal, outer=(9)]
