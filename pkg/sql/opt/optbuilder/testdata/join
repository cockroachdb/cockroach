# tests adapted from logictest -- join

exec-ddl
CREATE TABLE onecolumn (x INT)
----

build
SELECT * FROM onecolumn AS a(x) CROSS JOIN onecolumn AS b(y)
----
project
 ├── columns: x:1 y:4
 └── inner-join (cross)
      ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters (true)

# Check that name resolution chokes on ambiguity when it needs to.
build
SELECT x FROM onecolumn AS a, onecolumn AS b
----
error (42702): column reference "x" is ambiguous (candidates: a.x, b.x)

# Check that name resolution does not choke on ambiguity if an
# unqualified column name is requested and there is an anonymous
# source providing this name in addition to two or more named sources
# that also provide it.
build
SELECT x FROM (SELECT 1 AS x), onecolumn AS a, onecolumn AS b
----
project
 ├── columns: x:1!null
 └── inner-join (cross)
      ├── columns: x:1!null a.x:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      ├── project
      │    ├── columns: x:1!null
      │    ├── values
      │    │    └── ()
      │    └── projections
      │         └── 1 [as=x:1]
      ├── inner-join (cross)
      │    ├── columns: a.x:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      │    ├── scan onecolumn [as=a]
      │    │    └── columns: a.x:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      │    ├── scan onecolumn [as=b]
      │    │    └── columns: b.x:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      │    └── filters (true)
      └── filters (true)

build
SELECT * FROM onecolumn AS a(x) JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1!null y:4!null
 └── inner-join (hash)
      ├── columns: x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a JOIN onecolumn as b USING(x) ORDER BY x
----
sort
 ├── columns: x:1!null
 ├── ordering: +1
 └── project
      ├── columns: a.x:1!null
      └── inner-join (hash)
           ├── columns: a.x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan onecolumn [as=b]
           │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a NATURAL JOIN onecolumn as b
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: a.x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a(x) LEFT OUTER JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1 y:4
 └── left-join (hash)
      ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a LEFT OUTER JOIN onecolumn AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:1
 ├── ordering: +1
 └── project
      ├── columns: a.x:1
      └── left-join (hash)
           ├── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan onecolumn [as=b]
           │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── a.x:1 = b.x:4

# Check that ORDER BY chokes on ambiguity if no table less columns
# were introduced by USING. (#12239)
build
SELECT * FROM onecolumn AS a, onecolumn AS b ORDER BY x
----
error (42P09): ORDER BY "x" is ambiguous

build
SELECT * FROM (SELECT x, x FROM onecolumn) AS a JOIN onecolumn AS b USING (x)
----
error (42701): common column name "x" appears more than once in left table

build
SELECT * FROM onecolumn AS a JOIN (SELECT x, x FROM onecolumn) AS b USING (x)
----
error (42701): common column name "x" appears more than once in right table

build
SELECT * FROM (SELECT x, x FROM onecolumn) AS a NATURAL JOIN onecolumn AS b
----
error (42701): common column name "x" appears more than once in left table

build
SELECT * FROM onecolumn AS a NATURAL JOIN (SELECT x, x FROM onecolumn) AS b
----
error (42701): common column name "x" appears more than once in right table

build
SELECT * FROM onecolumn AS a NATURAL LEFT OUTER JOIN onecolumn AS b
----
project
 ├── columns: x:1
 └── left-join (hash)
      ├── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a(x) RIGHT OUTER JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1 y:4
 └── right-join (hash)
      ├── columns: x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a RIGHT OUTER JOIN onecolumn AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:4
 ├── ordering: +4
 └── project
      ├── columns: b.x:4
      └── right-join (hash)
           ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan onecolumn [as=b]
           │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a NATURAL RIGHT OUTER JOIN onecolumn AS b
----
project
 ├── columns: x:4
 └── right-join (hash)
      ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

exec-ddl
CREATE TABLE onecolumn_w(w INT)
----

build
SELECT * FROM onecolumn AS a NATURAL JOIN onecolumn_w as b
----
project
 ├── columns: x:1 w:4
 └── inner-join (cross)
      ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 w:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn_w [as=b]
      │    └── columns: w:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters (true)

exec-ddl
CREATE TABLE othercolumn (x INT)
----

build
SELECT * FROM onecolumn AS a FULL OUTER JOIN othercolumn AS b ON a.x = b.x ORDER BY a.x,b.x
----
sort
 ├── columns: x:1 x:4
 ├── ordering: +1,+4
 └── project
      ├── columns: a.x:1 b.x:4
      └── full-join (hash)
           ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan othercolumn [as=b]
           │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a FULL OUTER JOIN othercolumn AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:7
 ├── ordering: +7
 └── project
      ├── columns: x:7
      └── project
           ├── columns: x:7 a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── full-join (hash)
           │    ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           │    ├── scan onecolumn [as=a]
           │    │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           │    ├── scan othercolumn [as=b]
           │    │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           │    └── filters
           │         └── a.x:1 = b.x:4
           └── projections
                └── COALESCE(a.x:1, b.x:4) [as=x:7]

# Check that the source columns can be selected separately from the
# USING column (#12033).
build
SELECT x AS s, a.x, b.x FROM onecolumn AS a FULL OUTER JOIN othercolumn AS b USING(x) ORDER BY s
----
sort
 ├── columns: s:7 x:1 x:4
 ├── ordering: +7
 └── project
      ├── columns: a.x:1 b.x:4 x:7
      └── project
           ├── columns: x:7 a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── full-join (hash)
           │    ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           │    ├── scan onecolumn [as=a]
           │    │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           │    ├── scan othercolumn [as=b]
           │    │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           │    └── filters
           │         └── a.x:1 = b.x:4
           └── projections
                └── COALESCE(a.x:1, b.x:4) [as=x:7]

build
SELECT * FROM onecolumn AS a NATURAL FULL OUTER JOIN othercolumn AS b ORDER BY x
----
sort
 ├── columns: x:7
 ├── ordering: +7
 └── project
      ├── columns: x:7
      └── project
           ├── columns: x:7 a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── full-join (hash)
           │    ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           │    ├── scan onecolumn [as=a]
           │    │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           │    ├── scan othercolumn [as=b]
           │    │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           │    └── filters
           │         └── a.x:1 = b.x:4
           └── projections
                └── COALESCE(a.x:1, b.x:4) [as=x:7]

# Check that a limit on the JOIN's result do not cause rows from the
# JOIN operands to become invisible to the JOIN.
build
SELECT * FROM (SELECT x FROM onecolumn ORDER BY x DESC) NATURAL JOIN (VALUES (42)) AS v(x) LIMIT 1
----
limit
 ├── columns: x:1!null
 ├── project
 │    ├── columns: x:1!null
 │    ├── limit hint: 1.00
 │    └── inner-join (hash)
 │         ├── columns: x:1!null column1:4!null
 │         ├── limit hint: 1.00
 │         ├── project
 │         │    ├── columns: x:1
 │         │    └── scan onecolumn
 │         │         └── columns: x:1 rowid:2!null crdb_internal_mvcc_timestamp:3
 │         ├── values
 │         │    ├── columns: column1:4!null
 │         │    └── (42,)
 │         └── filters
 │              └── x:1 = column1:4
 └── 1

exec-ddl
CREATE TABLE empty (x INT)
----

build
SELECT * FROM onecolumn AS a(x) CROSS JOIN empty AS b(y)
----
project
 ├── columns: x:1 y:4
 └── inner-join (cross)
      ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan empty [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters (true)

build
SELECT * FROM empty AS a CROSS JOIN onecolumn AS b
----
project
 ├── columns: x:1 x:4
 └── inner-join (cross)
      ├── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan empty [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters (true)

build
SELECT * FROM onecolumn AS a(x) JOIN empty AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1!null y:4!null
 └── inner-join (hash)
      ├── columns: x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan empty [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a JOIN empty AS b USING(x)
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: a.x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan empty [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM empty AS a(x) JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1!null y:4!null
 └── inner-join (hash)
      ├── columns: x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan empty [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM empty AS a JOIN onecolumn AS b USING(x)
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: a.x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan empty [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a(x) LEFT OUTER JOIN empty AS b(y) ON a.x = b.y ORDER BY a.x
----
sort
 ├── columns: x:1 y:4
 ├── ordering: +1
 └── project
      ├── columns: x:1 y:4
      └── left-join (hash)
           ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan empty [as=b]
           │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── x:1 = y:4

build
SELECT * FROM onecolumn AS a LEFT OUTER JOIN empty AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:1
 ├── ordering: +1
 └── project
      ├── columns: a.x:1
      └── left-join (hash)
           ├── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan empty [as=b]
           │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── a.x:1 = b.x:4

build
SELECT * FROM empty AS a(x) LEFT OUTER JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1 y:4
 └── left-join (hash)
      ├── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
      ├── scan empty [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM empty AS a LEFT OUTER JOIN onecolumn AS b USING(x)
----
project
 ├── columns: x:1
 └── left-join (hash)
      ├── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
      ├── scan empty [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM onecolumn AS a(x) RIGHT OUTER JOIN empty AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1 y:4
 └── right-join (hash)
      ├── columns: x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan empty [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a RIGHT OUTER JOIN empty AS b USING(x)
----
project
 ├── columns: x:4
 └── right-join (hash)
      ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan empty [as=b]
      │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── a.x:1 = b.x:4

build
SELECT * FROM empty AS a(x) FULL OUTER JOIN onecolumn AS b(y) ON a.x = b.y ORDER BY b.y
----
sort
 ├── columns: x:1 y:4
 ├── ordering: +4
 └── project
      ├── columns: x:1 y:4
      └── full-join (hash)
           ├── columns: x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan empty [as=a]
           │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan onecolumn [as=b]
           │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── x:1 = y:4

build
SELECT * FROM empty AS a FULL OUTER JOIN onecolumn AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:7
 ├── ordering: +7
 └── project
      ├── columns: x:7
      └── project
           ├── columns: x:7 a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── full-join (hash)
           │    ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           │    ├── scan empty [as=a]
           │    │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           │    ├── scan onecolumn [as=b]
           │    │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           │    └── filters
           │         └── a.x:1 = b.x:4
           └── projections
                └── COALESCE(a.x:1, b.x:4) [as=x:7]

build
SELECT * FROM onecolumn AS a(x) FULL OUTER JOIN empty AS b(y) ON a.x = b.y ORDER BY a.x
----
sort
 ├── columns: x:1 y:4
 ├── ordering: +1
 └── project
      ├── columns: x:1 y:4
      └── full-join (hash)
           ├── columns: x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── scan onecolumn [as=a]
           │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan empty [as=b]
           │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           └── filters
                └── x:1 = y:4

build
SELECT * FROM onecolumn AS a FULL OUTER JOIN empty AS b USING(x) ORDER BY x
----
sort
 ├── columns: x:7
 ├── ordering: +7
 └── project
      ├── columns: x:7
      └── project
           ├── columns: x:7 a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           ├── full-join (hash)
           │    ├── columns: a.x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.x:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
           │    ├── scan onecolumn [as=a]
           │    │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           │    ├── scan empty [as=b]
           │    │    └── columns: b.x:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
           │    └── filters
           │         └── a.x:1 = b.x:4
           └── projections
                └── COALESCE(a.x:1, b.x:4) [as=x:7]

exec-ddl
CREATE TABLE twocolumn (x INT, y INT)
----

# Natural joins with partial match
build
SELECT * FROM onecolumn NATURAL JOIN twocolumn
----
project
 ├── columns: x:1!null y:5
 └── inner-join (hash)
      ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4!null y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn
      │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn
      │    └── columns: twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      └── filters
           └── onecolumn.x:1 = twocolumn.x:4

build
SELECT * FROM onecolumn JOIN twocolumn USING(x)
----
project
 ├── columns: x:1!null y:5
 └── inner-join (hash)
      ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4!null y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn
      │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn
      │    └── columns: twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      └── filters
           └── onecolumn.x:1 = twocolumn.x:4

build
SELECT * FROM twocolumn AS a JOIN twocolumn AS b ON a.x = b.y
----
project
 ├── columns: x:1!null y:2 x:5 y:6!null
 └── inner-join (hash)
      ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.y:6!null b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 = b.y:6

build
SELECT * FROM twocolumn AS a JOIN twocolumn AS b ON a.x = a.y
----
project
 ├── columns: x:1!null y:2!null x:5 y:6
 └── inner-join (cross)
      ├── columns: a.x:1!null a.y:2!null a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 = a.y:2

build
SELECT * FROM onecolumn AS a JOIN twocolumn AS b ON ((a.x)) = ((b.y))
----
project
 ├── columns: x:1!null x:4 y:5!null
 └── inner-join (hash)
      ├── columns: a.x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.x:4 y:5!null b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn [as=a]
      │    └── columns: a.x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:4 y:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      └── filters
           └── a.x:1 = y:5

build
SELECT * FROM onecolumn JOIN twocolumn ON onecolumn.x = twocolumn.y
----
project
 ├── columns: x:1!null x:4 y:5!null
 └── inner-join (hash)
      ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4 y:5!null twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn
      │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn
      │    └── columns: twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      └── filters
           └── onecolumn.x:1 = y:5

# Inner join with filter predicate
build
SELECT * FROM twocolumn AS a JOIN twocolumn AS b ON a.x = 44
----
project
 ├── columns: x:1!null y:2 x:5 y:6
 └── inner-join (cross)
      ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 = 44

build
SELECT o.x, t.y FROM onecolumn o INNER JOIN twocolumn t ON (o.x=t.x AND t.y=53)
----
project
 ├── columns: x:1!null y:5!null
 └── inner-join (cross)
      ├── columns: o.x:1!null o.rowid:2!null o.crdb_internal_mvcc_timestamp:3 t.x:4!null y:5!null t.rowid:6!null t.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn [as=o]
      │    └── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn [as=t]
      │    └── columns: t.x:4 y:5 t.rowid:6!null t.crdb_internal_mvcc_timestamp:7
      └── filters
           └── (o.x:1 = t.x:4) AND (y:5 = 53)

# Outer joins with filter predicate
build
SELECT o.x, t.y FROM onecolumn o LEFT OUTER JOIN twocolumn t ON (o.x=t.x AND t.y=53)
----
project
 ├── columns: x:1 y:5
 └── left-join (cross)
      ├── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3 t.x:4 y:5 t.rowid:6 t.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn [as=o]
      │    └── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn [as=t]
      │    └── columns: t.x:4 y:5 t.rowid:6!null t.crdb_internal_mvcc_timestamp:7
      └── filters
           └── (o.x:1 = t.x:4) AND (y:5 = 53)

build
SELECT o.x, t.y FROM onecolumn o LEFT OUTER JOIN twocolumn t ON (o.x=t.x AND o.x=44)
----
project
 ├── columns: x:1 y:5
 └── left-join (cross)
      ├── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3 t.x:4 y:5 t.rowid:6 t.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn [as=o]
      │    └── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn [as=t]
      │    └── columns: t.x:4 y:5 t.rowid:6!null t.crdb_internal_mvcc_timestamp:7
      └── filters
           └── (o.x:1 = t.x:4) AND (o.x:1 = 44)

build
SELECT o.x, t.y FROM onecolumn o LEFT OUTER JOIN twocolumn t ON (o.x=t.x AND t.x=44)
----
project
 ├── columns: x:1 y:5
 └── left-join (cross)
      ├── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3 t.x:4 y:5 t.rowid:6 t.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn [as=o]
      │    └── columns: o.x:1 o.rowid:2!null o.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn [as=t]
      │    └── columns: t.x:4 y:5 t.rowid:6!null t.crdb_internal_mvcc_timestamp:7
      └── filters
           └── (o.x:1 = t.x:4) AND (t.x:4 = 44)

build
SELECT x, a.x, b.y FROM (SELECT * FROM onecolumn AS a NATURAL JOIN twocolumn AS b) AS q
----
error (42P01): no data source matches prefix: a in this context

build
SELECT x, a.x, b.y FROM (SELECT * FROM onecolumn AS a NATURAL JOIN twocolumn AS b)
----
error (42P01): no data source matches prefix: a in this context


## Simple test cases for inner, left, right, and outer joins

exec-ddl
CREATE TABLE a (i int)
----

exec-ddl
CREATE TABLE b (i int, b bool)
----

build
SELECT * FROM a INNER JOIN b ON a.i = b.i
----
project
 ├── columns: i:1!null i:4!null b:5
 └── inner-join (hash)
      ├── columns: a.i:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.i:4!null b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      ├── scan a
      │    └── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan b
      │    └── columns: b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      └── filters
           └── a.i:1 = b.i:4

build
SELECT * FROM a LEFT OUTER JOIN b ON a.i = b.i
----
project
 ├── columns: i:1 i:4 b:5
 └── left-join (hash)
      ├── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 b.i:4 b:5 b.rowid:6 b.crdb_internal_mvcc_timestamp:7
      ├── scan a
      │    └── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan b
      │    └── columns: b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
      └── filters
           └── a.i:1 = b.i:4

build
SELECT * FROM a RIGHT OUTER JOIN b ON a.i = b.i ORDER BY b.i, b.b
----
sort
 ├── columns: i:1 i:4 b:5
 ├── ordering: +4,+5
 └── project
      ├── columns: a.i:1 b.i:4 b:5
      └── right-join (hash)
           ├── columns: a.i:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
           ├── scan a
           │    └── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan b
           │    └── columns: b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
           └── filters
                └── a.i:1 = b.i:4

build
SELECT * FROM a FULL OUTER JOIN b ON a.i = b.i ORDER BY b.i, b.b
----
sort
 ├── columns: i:1 i:4 b:5
 ├── ordering: +4,+5
 └── project
      ├── columns: a.i:1 b.i:4 b:5
      └── full-join (hash)
           ├── columns: a.i:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.i:4 b:5 b.rowid:6 b.crdb_internal_mvcc_timestamp:7
           ├── scan a
           │    └── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan b
           │    └── columns: b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
           └── filters
                └── a.i:1 = b.i:4

# Full outer join with filter predicate
build
SELECT * FROM a FULL OUTER JOIN b ON (a.i = b.i and a.i>2) ORDER BY a.i, b.i
----
sort
 ├── columns: i:1 i:4 b:5
 ├── ordering: +1,+4
 └── project
      ├── columns: a.i:1 b.i:4 b:5
      └── full-join (cross)
           ├── columns: a.i:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 b.i:4 b:5 b.rowid:6 b.crdb_internal_mvcc_timestamp:7
           ├── scan a
           │    └── columns: a.i:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
           ├── scan b
           │    └── columns: b.i:4 b:5 b.rowid:6!null b.crdb_internal_mvcc_timestamp:7
           └── filters
                └── (a.i:1 = b.i:4) AND (a.i:1 > 2)

# Check column orders and names.
build
SELECT * FROM (onecolumn CROSS JOIN twocolumn JOIN onecolumn AS a(b) ON a.b=twocolumn.x JOIN twocolumn AS c(d,e) ON a.b=c.d AND c.d=onecolumn.x) ORDER BY 1 LIMIT 1
----
limit
 ├── columns: x:1!null x:4!null y:5 b:8!null d:11!null e:12
 ├── internal-ordering: +1
 ├── ordering: +1
 ├── sort
 │    ├── columns: onecolumn.x:1!null twocolumn.x:4!null y:5 b:8!null d:11!null e:12
 │    ├── ordering: +1
 │    ├── limit hint: 1.00
 │    └── project
 │         ├── columns: onecolumn.x:1!null twocolumn.x:4!null y:5 b:8!null d:11!null e:12
 │         └── inner-join (cross)
 │              ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4!null y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7 b:8!null a.rowid:9!null a.crdb_internal_mvcc_timestamp:10 d:11!null e:12 c.rowid:13!null c.crdb_internal_mvcc_timestamp:14
 │              ├── inner-join (hash)
 │              │    ├── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4!null y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7 b:8!null a.rowid:9!null a.crdb_internal_mvcc_timestamp:10
 │              │    ├── inner-join (cross)
 │              │    │    ├── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
 │              │    │    ├── scan onecolumn
 │              │    │    │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
 │              │    │    ├── scan twocolumn
 │              │    │    │    └── columns: twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
 │              │    │    └── filters (true)
 │              │    ├── scan onecolumn [as=a]
 │              │    │    └── columns: b:8 a.rowid:9!null a.crdb_internal_mvcc_timestamp:10
 │              │    └── filters
 │              │         └── b:8 = twocolumn.x:4
 │              ├── scan twocolumn [as=c]
 │              │    └── columns: d:11 e:12 c.rowid:13!null c.crdb_internal_mvcc_timestamp:14
 │              └── filters
 │                   └── (b:8 = d:11) AND (d:11 = onecolumn.x:1)
 └── 1

# Check sub-queries in ON conditions.
build
SELECT * FROM onecolumn JOIN twocolumn ON twocolumn.x = onecolumn.x AND onecolumn.x IN (SELECT x FROM twocolumn WHERE y >= 52)
----
project
 ├── columns: x:1!null x:4!null y:5
 └── inner-join (cross)
      ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 twocolumn.x:4!null y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      ├── scan onecolumn
      │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
      ├── scan twocolumn
      │    └── columns: twocolumn.x:4 y:5 twocolumn.rowid:6!null twocolumn.crdb_internal_mvcc_timestamp:7
      └── filters
           └── and
                ├── twocolumn.x:4 = onecolumn.x:1
                └── any: eq
                     ├── project
                     │    ├── columns: twocolumn.x:8
                     │    └── select
                     │         ├── columns: twocolumn.x:8 y:9!null twocolumn.rowid:10!null twocolumn.crdb_internal_mvcc_timestamp:11
                     │         ├── scan twocolumn
                     │         │    └── columns: twocolumn.x:8 y:9 twocolumn.rowid:10!null twocolumn.crdb_internal_mvcc_timestamp:11
                     │         └── filters
                     │              └── y:9 >= 52
                     └── onecolumn.x:1

# Check sub-queries as data sources.
build
SELECT * FROM onecolumn JOIN (VALUES (41),(42),(43)) AS a(x) USING(x)
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: x:1!null rowid:2!null crdb_internal_mvcc_timestamp:3 column1:4!null
      ├── scan onecolumn
      │    └── columns: x:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── values
      │    ├── columns: column1:4!null
      │    ├── (41,)
      │    ├── (42,)
      │    └── (43,)
      └── filters
           └── x:1 = column1:4

build
SELECT * FROM onecolumn JOIN (SELECT x + 2 AS x FROM onecolumn) USING(x)
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: onecolumn.x:1!null rowid:2!null crdb_internal_mvcc_timestamp:3 x:7!null
      ├── scan onecolumn
      │    └── columns: onecolumn.x:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── project
      │    ├── columns: x:7
      │    ├── scan onecolumn
      │    │    └── columns: onecolumn.x:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      │    └── projections
      │         └── onecolumn.x:4 + 2 [as=x:7]
      └── filters
           └── onecolumn.x:1 = x:7

# Check that a single column can have multiple table aliases.
build
SELECT * FROM (twocolumn AS a JOIN twocolumn AS b USING(x) JOIN twocolumn AS c USING(x)) ORDER BY x LIMIT 1
----
limit
 ├── columns: x:1!null y:2 y:6 y:10
 ├── internal-ordering: +1
 ├── ordering: +1
 ├── sort
 │    ├── columns: a.x:1!null a.y:2 b.y:6 c.y:10
 │    ├── ordering: +1
 │    ├── limit hint: 1.00
 │    └── project
 │         ├── columns: a.x:1!null a.y:2 b.y:6 c.y:10
 │         └── inner-join (hash)
 │              ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8 c.x:9!null c.y:10 c.rowid:11!null c.crdb_internal_mvcc_timestamp:12
 │              ├── inner-join (hash)
 │              │    ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
 │              │    ├── scan twocolumn [as=a]
 │              │    │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
 │              │    ├── scan twocolumn [as=b]
 │              │    │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
 │              │    └── filters
 │              │         └── a.x:1 = b.x:5
 │              ├── scan twocolumn [as=c]
 │              │    └── columns: c.x:9 c.y:10 c.rowid:11!null c.crdb_internal_mvcc_timestamp:12
 │              └── filters
 │                   └── a.x:1 = c.x:9
 └── 1

build
SELECT a.x AS s, b.x, c.x, a.y, b.y, c.y FROM (twocolumn AS a JOIN twocolumn AS b USING(x) JOIN twocolumn AS c USING(x)) ORDER BY s
----
sort
 ├── columns: s:1!null x:5!null x:9!null y:2 y:6 y:10
 ├── ordering: +1
 └── project
      ├── columns: a.x:1!null a.y:2 b.x:5!null b.y:6 c.x:9!null c.y:10
      └── inner-join (hash)
           ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8 c.x:9!null c.y:10 c.rowid:11!null c.crdb_internal_mvcc_timestamp:12
           ├── inner-join (hash)
           │    ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
           │    ├── scan twocolumn [as=a]
           │    │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
           │    ├── scan twocolumn [as=b]
           │    │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
           │    └── filters
           │         └── a.x:1 = b.x:5
           ├── scan twocolumn [as=c]
           │    └── columns: c.x:9 c.y:10 c.rowid:11!null c.crdb_internal_mvcc_timestamp:12
           └── filters
                └── a.x:1 = c.x:9

build
SELECT * FROM (onecolumn AS a JOIN onecolumn AS b USING(y))
----
error (42703): column "y" specified in USING clause does not exist in left table

build
SELECT * FROM (onecolumn AS a JOIN onecolumn AS b USING(x, x))
----
error (42701): column name "x" appears more than once in USING clause

exec-ddl
CREATE TABLE othertype (x TEXT)
----

build
SELECT * FROM (onecolumn AS a JOIN othertype AS b USING(x))
----
error (42804): JOIN/USING types int for left and string for right cannot be matched for column "x"

build
SELECT * FROM (onecolumn JOIN onecolumn USING(x))
----
error (42712): source name "onecolumn" specified more than once (missing AS clause)

build
SELECT * FROM (onecolumn JOIN twocolumn USING(x) JOIN onecolumn USING(x))
----
error (42712): source name "onecolumn" specified more than once (missing AS clause)

# Check that star expansion works across anonymous sources.
build
SELECT * FROM (SELECT * FROM onecolumn), (SELECT * FROM onecolumn)
----
inner-join (cross)
 ├── columns: x:1 x:4
 ├── project
 │    ├── columns: x:1
 │    └── scan onecolumn
 │         └── columns: x:1 rowid:2!null crdb_internal_mvcc_timestamp:3
 ├── project
 │    ├── columns: x:4
 │    └── scan onecolumn
 │         └── columns: x:4 rowid:5!null crdb_internal_mvcc_timestamp:6
 └── filters (true)

# Check that anonymous sources are properly looked up without ambiguity.
build
SELECT x FROM (onecolumn JOIN othercolumn USING (x)) JOIN (onecolumn AS a JOIN othercolumn AS b USING(x)) USING(x)
----
project
 ├── columns: x:1!null
 └── inner-join (hash)
      ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 othercolumn.x:4!null othercolumn.rowid:5!null othercolumn.crdb_internal_mvcc_timestamp:6 a.x:7!null a.rowid:8!null a.crdb_internal_mvcc_timestamp:9 b.x:10!null b.rowid:11!null b.crdb_internal_mvcc_timestamp:12
      ├── inner-join (hash)
      │    ├── columns: onecolumn.x:1!null onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3 othercolumn.x:4!null othercolumn.rowid:5!null othercolumn.crdb_internal_mvcc_timestamp:6
      │    ├── scan onecolumn
      │    │    └── columns: onecolumn.x:1 onecolumn.rowid:2!null onecolumn.crdb_internal_mvcc_timestamp:3
      │    ├── scan othercolumn
      │    │    └── columns: othercolumn.x:4 othercolumn.rowid:5!null othercolumn.crdb_internal_mvcc_timestamp:6
      │    └── filters
      │         └── onecolumn.x:1 = othercolumn.x:4
      ├── inner-join (hash)
      │    ├── columns: a.x:7!null a.rowid:8!null a.crdb_internal_mvcc_timestamp:9 b.x:10!null b.rowid:11!null b.crdb_internal_mvcc_timestamp:12
      │    ├── scan onecolumn [as=a]
      │    │    └── columns: a.x:7 a.rowid:8!null a.crdb_internal_mvcc_timestamp:9
      │    ├── scan othercolumn [as=b]
      │    │    └── columns: b.x:10 b.rowid:11!null b.crdb_internal_mvcc_timestamp:12
      │    └── filters
      │         └── a.x:7 = b.x:10
      └── filters
           └── onecolumn.x:1 = a.x:7

# Check that multiple anonymous sources cause proper ambiguity errors.
build
SELECT x FROM (SELECT * FROM onecolumn), (SELECT * FROM onecolumn)
----
error (42702): column reference "x" is ambiguous (candidates: <anonymous>.x)

build
SELECT * FROM (onecolumn AS a JOIN onecolumn AS b ON x > 32)
----
error (42702): column reference "x" is ambiguous (candidates: a.x, b.x)

build
SELECT * FROM (onecolumn AS a JOIN onecolumn AS b ON a.y > y)
----
error (42703): column "a.y" does not exist

# THe following queries verify that only the necessary columns are scanned.
build
SELECT a.x, b.y FROM twocolumn AS a, twocolumn AS b
----
project
 ├── columns: x:1 y:6
 └── inner-join (cross)
      ├── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters (true)

build
SELECT b.y FROM (twocolumn AS a JOIN twocolumn AS b USING(x))
----
project
 ├── columns: y:6
 └── inner-join (hash)
      ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 = b.x:5

build
SELECT b.y FROM (twocolumn AS a JOIN twocolumn AS b ON a.x = b.x)
----
project
 ├── columns: y:6
 └── inner-join (hash)
      ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5!null b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 = b.x:5

build
SELECT a.x FROM (twocolumn AS a JOIN twocolumn AS b ON a.x < b.y)
----
project
 ├── columns: x:1!null
 └── inner-join (cross)
      ├── columns: a.x:1!null a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4 b.x:5 b.y:6!null b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      ├── scan twocolumn [as=a]
      │    └── columns: a.x:1 a.y:2 a.rowid:3!null a.crdb_internal_mvcc_timestamp:4
      ├── scan twocolumn [as=b]
      │    └── columns: b.x:5 b.y:6 b.rowid:7!null b.crdb_internal_mvcc_timestamp:8
      └── filters
           └── a.x:1 < b.y:6

build
SELECT * FROM (SELECT * FROM (VALUES (9, 1), (8, 2)) AS a (u, k) ORDER BY k)
  INNER JOIN (VALUES (1, 1), (2, 2)) AS b (k, w) USING (k) ORDER BY u
----
sort
 ├── columns: k:2!null u:1!null w:4!null
 ├── ordering: +1
 └── project
      ├── columns: column1:1!null column2:2!null column2:4!null
      └── inner-join (hash)
           ├── columns: column1:1!null column2:2!null column1:3!null column2:4!null
           ├── values
           │    ├── columns: column1:1!null column2:2!null
           │    ├── (9, 1)
           │    └── (8, 2)
           ├── values
           │    ├── columns: column1:3!null column2:4!null
           │    ├── (1, 1)
           │    └── (2, 2)
           └── filters
                └── column2:2 = column1:3

# Tests for filter propagation through joins.

exec-ddl
CREATE TABLE square (n INT PRIMARY KEY, sq INT)
----

exec-ddl
CREATE TABLE pairs (a INT, b INT)
----

# The filter expression becomes an equality constraint.
build
SELECT * FROM pairs, square WHERE pairs.b = square.n
----
project
 ├── columns: a:1 b:2!null n:5!null sq:6
 └── select
      ├── columns: a:1 b:2!null rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      ├── inner-join (cross)
      │    ├── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    ├── scan pairs
      │    │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
      │    ├── scan square
      │    │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    └── filters (true)
      └── filters
           └── b:2 = n:5

# The filter expression becomes an ON predicate.
build
SELECT * FROM pairs, square WHERE pairs.a + pairs.b = square.sq
----
project
 ├── columns: a:1 b:2 n:5!null sq:6
 └── select
      ├── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      ├── inner-join (cross)
      │    ├── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    ├── scan pairs
      │    │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
      │    ├── scan square
      │    │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    └── filters (true)
      └── filters
           └── (a:1 + b:2) = sq:6

# Query similar to the one above, but the filter refers to a rendered
# expression and can't "break through". See the comment for propagateFilters
# in fitler_opt.go for all the details.
build
SELECT a, b, n, sq FROM (SELECT a, b, a + b AS sum, n, sq FROM pairs, square) WHERE sum = sq
----
project
 ├── columns: a:1 b:2 n:5!null sq:6!null
 └── select
      ├── columns: a:1 b:2 n:5!null sq:6!null sum:8!null
      ├── project
      │    ├── columns: sum:8 a:1 b:2 n:5!null sq:6
      │    ├── inner-join (cross)
      │    │    ├── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    │    ├── scan pairs
      │    │    │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
      │    │    ├── scan square
      │    │    │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    │    └── filters (true)
      │    └── projections
      │         └── a:1 + b:2 [as=sum:8]
      └── filters
           └── sum:8 = sq:6

# The filter expression must stay on top of the outer join.
build
SELECT * FROM pairs FULL OUTER JOIN square ON pairs.a + pairs.b = square.sq
----
project
 ├── columns: a:1 b:2 n:5 sq:6
 └── full-join (cross)
      ├── columns: a:1 b:2 rowid:3 pairs.crdb_internal_mvcc_timestamp:4 n:5 sq:6 square.crdb_internal_mvcc_timestamp:7
      ├── scan pairs
      │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
      ├── scan square
      │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      └── filters
           └── (a:1 + b:2) = sq:6

build
SELECT * FROM pairs FULL OUTER JOIN square ON pairs.a + pairs.b = square.sq WHERE pairs.b%2 <> square.sq%2
----
project
 ├── columns: a:1 b:2 n:5 sq:6
 └── select
      ├── columns: a:1 b:2 rowid:3 pairs.crdb_internal_mvcc_timestamp:4 n:5 sq:6 square.crdb_internal_mvcc_timestamp:7
      ├── full-join (cross)
      │    ├── columns: a:1 b:2 rowid:3 pairs.crdb_internal_mvcc_timestamp:4 n:5 sq:6 square.crdb_internal_mvcc_timestamp:7
      │    ├── scan pairs
      │    │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
      │    ├── scan square
      │    │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
      │    └── filters
      │         └── (a:1 + b:2) = sq:6
      └── filters
           └── (b:2 % 2) != (sq:6 % 2)

# Filter propagation through outer joins.

build
SELECT *
  FROM (SELECT * FROM pairs LEFT JOIN square ON b = sq AND a > 1 AND n < 6)
 WHERE b > 1 AND (n IS NULL OR n > 1) AND (n IS NULL OR a  < sq)
----
select
 ├── columns: a:1 b:2!null n:5 sq:6
 ├── project
 │    ├── columns: a:1 b:2 n:5 sq:6
 │    └── left-join (cross)
 │         ├── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5 sq:6 square.crdb_internal_mvcc_timestamp:7
 │         ├── scan pairs
 │         │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
 │         ├── scan square
 │         │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
 │         └── filters
 │              └── ((b:2 = sq:6) AND (a:1 > 1)) AND (n:5 < 6)
 └── filters
      └── ((b:2 > 1) AND ((n:5 IS NULL) OR (n:5 > 1))) AND ((n:5 IS NULL) OR (a:1 < sq:6))

build
SELECT *
  FROM (SELECT * FROM pairs RIGHT JOIN square ON b = sq AND a > 1 AND n < 6)
 WHERE (a IS NULL OR a > 2) AND n > 1 AND (a IS NULL OR a < sq)
----
select
 ├── columns: a:1 b:2 n:5!null sq:6
 ├── project
 │    ├── columns: a:1 b:2 n:5!null sq:6
 │    └── right-join (cross)
 │         ├── columns: a:1 b:2 rowid:3 pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
 │         ├── scan pairs
 │         │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
 │         ├── scan square
 │         │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
 │         └── filters
 │              └── ((b:2 = sq:6) AND (a:1 > 1)) AND (n:5 < 6)
 └── filters
      └── (((a:1 IS NULL) OR (a:1 > 2)) AND (n:5 > 1)) AND ((a:1 IS NULL) OR (a:1 < sq:6))

# The simpler plan for an inner join, to compare.
build
SELECT *
  FROM (SELECT * FROM pairs JOIN square ON b = sq AND a > 1 AND n < 6)
 WHERE (a IS NULL OR a > 2) AND n > 1 AND (a IS NULL OR a < sq)
----
select
 ├── columns: a:1!null b:2!null n:5!null sq:6!null
 ├── project
 │    ├── columns: a:1!null b:2!null n:5!null sq:6!null
 │    └── inner-join (cross)
 │         ├── columns: a:1!null b:2!null rowid:3!null pairs.crdb_internal_mvcc_timestamp:4 n:5!null sq:6!null square.crdb_internal_mvcc_timestamp:7
 │         ├── scan pairs
 │         │    └── columns: a:1 b:2 rowid:3!null pairs.crdb_internal_mvcc_timestamp:4
 │         ├── scan square
 │         │    └── columns: n:5!null sq:6 square.crdb_internal_mvcc_timestamp:7
 │         └── filters
 │              └── ((b:2 = sq:6) AND (a:1 > 1)) AND (n:5 < 6)
 └── filters
      └── (((a:1 IS NULL) OR (a:1 > 2)) AND (n:5 > 1)) AND ((a:1 IS NULL) OR (a:1 < sq:6))


exec-ddl
CREATE TABLE t1 (col1 INT, x INT, col2 INT, y INT)
----

exec-ddl
CREATE TABLE t2 (col3 INT, y INT, x INT, col4 INT)
----

build
SELECT * FROM t1 JOIN t2 USING(x)
----
project
 ├── columns: x:2!null col1:1 col2:3 y:4 col3:7 y:8 col4:10
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           └── t1.x:2 = t2.x:9

build
SELECT * FROM t1 NATURAL JOIN t2
----
project
 ├── columns: x:2!null y:4!null col1:1 col2:3 col3:7 col4:10
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4!null t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8!null t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── t1.x:2 = t2.x:9
           └── t1.y:4 = t2.y:8

build
SELECT x, t1.x, t2.x FROM t1 NATURAL JOIN t2
----
project
 ├── columns: x:2!null x:2!null x:9!null
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4!null t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8!null t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── t1.x:2 = t2.x:9
           └── t1.y:4 = t2.y:8

build
SELECT t1.*, t2.* FROM t1 NATURAL JOIN t2
----
project
 ├── columns: x:2!null y:4!null col1:1 col2:3 col3:7 col4:10
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4!null t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8!null t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── t1.x:2 = t2.x:9
           └── t1.y:4 = t2.y:8

build
SELECT * FROM t1 JOIN t2 ON t2.x=t1.x
----
project
 ├── columns: col1:1 x:2!null col2:3 y:4 col3:7 y:8 x:9!null col4:10
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           └── t2.x:9 = t1.x:2

build
SELECT * FROM t1 FULL OUTER JOIN t2 USING(x)
----
project
 ├── columns: x:13 col1:1 col2:3 y:4 col3:7 y:8 col4:10
 └── project
      ├── columns: x:13 col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      ├── full-join (hash)
      │    ├── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      │    ├── scan t1
      │    │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      │    ├── scan t2
      │    │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      │    └── filters
      │         └── t1.x:2 = t2.x:9
      └── projections
           └── COALESCE(t1.x:2, t2.x:9) [as=x:13]

build
SELECT * FROM t1 NATURAL FULL OUTER JOIN t2
----
project
 ├── columns: x:13 y:14 col1:1 col2:3 col3:7 col4:10
 └── project
      ├── columns: x:13 y:14 col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      ├── full-join (hash)
      │    ├── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      │    ├── scan t1
      │    │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      │    ├── scan t2
      │    │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      │    └── filters
      │         ├── t1.x:2 = t2.x:9
      │         └── t1.y:4 = t2.y:8
      └── projections
           ├── COALESCE(t1.x:2, t2.x:9) [as=x:13]
           └── COALESCE(t1.y:4, t2.y:8) [as=y:14]

# Regression: computed columns are not wrapped with Variable outside join.
build
SELECT * FROM (SELECT x, x+1 AS plus1 FROM t1) NATURAL FULL OUTER JOIN (SELECT x, 2 AS two FROM t2)
----
project
 ├── columns: x:15 plus1:7 two:14
 └── project
      ├── columns: x:15 t1.x:2 plus1:7 t2.x:10 two:14
      ├── full-join (hash)
      │    ├── columns: t1.x:2 plus1:7 t2.x:10 two:14
      │    ├── project
      │    │    ├── columns: plus1:7 t1.x:2
      │    │    ├── scan t1
      │    │    │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      │    │    └── projections
      │    │         └── t1.x:2 + 1 [as=plus1:7]
      │    ├── project
      │    │    ├── columns: two:14!null t2.x:10
      │    │    ├── scan t2
      │    │    │    └── columns: col3:8 t2.y:9 t2.x:10 col4:11 t2.rowid:12!null t2.crdb_internal_mvcc_timestamp:13
      │    │    └── projections
      │    │         └── 2 [as=two:14]
      │    └── filters
      │         └── t1.x:2 = t2.x:10
      └── projections
           └── COALESCE(t1.x:2, t2.x:10) [as=x:15]

build
SELECT * FROM t1 FULL OUTER JOIN t2 ON t1.x=t2.x
----
project
 ├── columns: col1:1 x:2 col2:3 y:4 col3:7 y:8 x:9 col4:10
 └── full-join (hash)
      ├── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           └── t1.x:2 = t2.x:9

build
SELECT t2.x, t1.x, x FROM t1 JOIN t2 USING(x)
----
project
 ├── columns: x:9!null x:2!null x:2!null
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9!null col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── scan t2
      │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           └── t1.x:2 = t2.x:9

build
SELECT t2.x, t1.x, x FROM t1 FULL OUTER JOIN t2 USING(x)
----
project
 ├── columns: x:9 x:2 x:13
 └── project
      ├── columns: x:13 col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      ├── full-join (hash)
      │    ├── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5 t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11 t2.crdb_internal_mvcc_timestamp:12
      │    ├── scan t1
      │    │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      │    ├── scan t2
      │    │    └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      │    └── filters
      │         └── t1.x:2 = t2.x:9
      └── projections
           └── COALESCE(t1.x:2, t2.x:9) [as=x:13]

# Test for #19536.
build
SELECT x FROM t1 NATURAL JOIN (SELECT * FROM t2)
----
project
 ├── columns: x:2!null
 └── inner-join (hash)
      ├── columns: col1:1 t1.x:2!null col2:3 t1.y:4!null t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6 col3:7 t2.y:8!null t2.x:9!null col4:10
      ├── scan t1
      │    └── columns: col1:1 t1.x:2 col2:3 t1.y:4 t1.rowid:5!null t1.crdb_internal_mvcc_timestamp:6
      ├── project
      │    ├── columns: col3:7 t2.y:8 t2.x:9 col4:10
      │    └── scan t2
      │         └── columns: col3:7 t2.y:8 t2.x:9 col4:10 t2.rowid:11!null t2.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── t1.x:2 = t2.x:9
           └── t1.y:4 = t2.y:8

# Tests for merge join ordering information.
exec-ddl
CREATE TABLE pkBA (a INT, b INT, c INT, d INT, PRIMARY KEY(b,a))
----

exec-ddl
CREATE TABLE pkBC (a INT, b INT, c INT, d INT, PRIMARY KEY(b,c))
----

exec-ddl
CREATE TABLE pkBAC (a INT, b INT, c INT, d INT, PRIMARY KEY(b,a,c))
----

exec-ddl
CREATE TABLE pkBAD (a INT, b INT, c INT, d INT, PRIMARY KEY(b,a,d))
----

build
SELECT * FROM pkBA AS l JOIN pkBC AS r ON l.a = r.a AND l.b = r.b AND l.c = r.c
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4 a:6!null b:7!null c:8!null d:9
 └── inner-join (cross)
      ├── columns: l.a:1!null l.b:2!null l.c:3!null l.d:4 l.crdb_internal_mvcc_timestamp:5 r.a:6!null r.b:7!null r.c:8!null r.d:9 r.crdb_internal_mvcc_timestamp:10
      ├── scan pkba [as=l]
      │    └── columns: l.a:1!null l.b:2!null l.c:3 l.d:4 l.crdb_internal_mvcc_timestamp:5
      ├── scan pkbc [as=r]
      │    └── columns: r.a:6 r.b:7!null r.c:8!null r.d:9 r.crdb_internal_mvcc_timestamp:10
      └── filters
           └── ((l.a:1 = r.a:6) AND (l.b:2 = r.b:7)) AND (l.c:3 = r.c:8)

build
SELECT * FROM pkBA NATURAL JOIN pkBAD
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4!null
 └── inner-join (hash)
      ├── columns: pkba.a:1!null pkba.b:2!null pkba.c:3!null pkba.d:4!null pkba.crdb_internal_mvcc_timestamp:5 pkbad.a:6!null pkbad.b:7!null pkbad.c:8!null pkbad.d:9!null pkbad.crdb_internal_mvcc_timestamp:10
      ├── scan pkba
      │    └── columns: pkba.a:1!null pkba.b:2!null pkba.c:3 pkba.d:4 pkba.crdb_internal_mvcc_timestamp:5
      ├── scan pkbad
      │    └── columns: pkbad.a:6!null pkbad.b:7!null pkbad.c:8 pkbad.d:9!null pkbad.crdb_internal_mvcc_timestamp:10
      └── filters
           ├── pkba.a:1 = pkbad.a:6
           ├── pkba.b:2 = pkbad.b:7
           ├── pkba.c:3 = pkbad.c:8
           └── pkba.d:4 = pkbad.d:9

build
SELECT * FROM pkBAC AS l JOIN pkBAC AS r USING(a, b, c)
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4 d:9
 └── inner-join (hash)
      ├── columns: l.a:1!null l.b:2!null l.c:3!null l.d:4 l.crdb_internal_mvcc_timestamp:5 r.a:6!null r.b:7!null r.c:8!null r.d:9 r.crdb_internal_mvcc_timestamp:10
      ├── scan pkbac [as=l]
      │    └── columns: l.a:1!null l.b:2!null l.c:3!null l.d:4 l.crdb_internal_mvcc_timestamp:5
      ├── scan pkbac [as=r]
      │    └── columns: r.a:6!null r.b:7!null r.c:8!null r.d:9 r.crdb_internal_mvcc_timestamp:10
      └── filters
           ├── l.a:1 = r.a:6
           ├── l.b:2 = r.b:7
           └── l.c:3 = r.c:8

build
SELECT * FROM pkBAC AS l JOIN pkBAD AS r ON l.c = r.d AND l.a = r.a AND l.b = r.b
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4 a:6!null b:7!null c:8 d:9!null
 └── inner-join (cross)
      ├── columns: l.a:1!null l.b:2!null l.c:3!null l.d:4 l.crdb_internal_mvcc_timestamp:5 r.a:6!null r.b:7!null r.c:8 r.d:9!null r.crdb_internal_mvcc_timestamp:10
      ├── scan pkbac [as=l]
      │    └── columns: l.a:1!null l.b:2!null l.c:3!null l.d:4 l.crdb_internal_mvcc_timestamp:5
      ├── scan pkbad [as=r]
      │    └── columns: r.a:6!null r.b:7!null r.c:8 r.d:9!null r.crdb_internal_mvcc_timestamp:10
      └── filters
           └── ((l.c:3 = r.d:9) AND (l.a:1 = r.a:6)) AND (l.b:2 = r.b:7)

# Tests with joins with merged columns of collated string type.
exec-ddl
CREATE TABLE str1 (a INT PRIMARY KEY, s STRING COLLATE en_u_ks_level1)
----

exec-ddl
CREATE TABLE str2 (a INT PRIMARY KEY, s STRING COLLATE en_u_ks_level1)
----

build
SELECT s, str1.s, str2.s FROM str1 INNER JOIN str2 USING(s)
----
project
 ├── columns: s:2!null s:2!null s:5!null
 └── inner-join (hash)
      ├── columns: str1.a:1!null str1.s:2!null str1.crdb_internal_mvcc_timestamp:3 str2.a:4!null str2.s:5!null str2.crdb_internal_mvcc_timestamp:6
      ├── scan str1
      │    └── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3
      ├── scan str2
      │    └── columns: str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      └── filters
           └── str1.s:2 = str2.s:5

build
SELECT s, str1.s, str2.s FROM str1 LEFT OUTER JOIN str2 USING(s)
----
project
 ├── columns: s:2 s:2 s:5
 └── left-join (hash)
      ├── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4 str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      ├── scan str1
      │    └── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3
      ├── scan str2
      │    └── columns: str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      └── filters
           └── str1.s:2 = str2.s:5

build
SELECT s, str1.s, str2.s FROM str1 RIGHT OUTER JOIN str2 USING(s)
----
project
 ├── columns: s:7 s:2 s:5
 └── project
      ├── columns: s:7 str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      ├── right-join (hash)
      │    ├── columns: str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    ├── scan str1
      │    │    └── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3
      │    ├── scan str2
      │    │    └── columns: str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    └── filters
      │         └── str1.s:2 = str2.s:5
      └── projections
           └── COALESCE(str1.s:2, str2.s:5) [as=s:7]

build
SELECT s, str1.s, str2.s FROM str1 FULL OUTER JOIN str2 USING(s)
----
project
 ├── columns: s:7 s:2 s:5
 └── project
      ├── columns: s:7 str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4 str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      ├── full-join (hash)
      │    ├── columns: str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4 str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    ├── scan str1
      │    │    └── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3
      │    ├── scan str2
      │    │    └── columns: str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    └── filters
      │         └── str1.s:2 = str2.s:5
      └── projections
           └── COALESCE(str1.s:2, str2.s:5) [as=s:7]

# Verify that we resolve the merged column a to str2.a but use IFNULL for
# column s which is a collated string.
build
SELECT * FROM str1 RIGHT OUTER JOIN str2 USING(a, s)
----
project
 ├── columns: a:4!null s:7
 └── project
      ├── columns: s:7 str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      ├── right-join (hash)
      │    ├── columns: str1.a:1 str1.s:2 str1.crdb_internal_mvcc_timestamp:3 str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    ├── scan str1
      │    │    └── columns: str1.a:1!null str1.s:2 str1.crdb_internal_mvcc_timestamp:3
      │    ├── scan str2
      │    │    └── columns: str2.a:4!null str2.s:5 str2.crdb_internal_mvcc_timestamp:6
      │    └── filters
      │         ├── str1.a:1 = str2.a:4
      │         └── str1.s:2 = str2.s:5
      └── projections
           └── COALESCE(str1.s:2, str2.s:5) [as=s:7]


exec-ddl
CREATE TABLE xyu (x INT, y INT, u INT, PRIMARY KEY(x,y,u))
----

exec-ddl
CREATE TABLE xyv (x INT, y INT, v INT, PRIMARY KEY(x,y,v))
----

build
SELECT * FROM xyu INNER JOIN xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:1!null y:2!null u:3!null v:7!null
 └── select
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── inner-join (hash)
      │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    ├── scan xyu
      │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── scan xyv
      │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── xyu.x:1 > 2

build
SELECT * FROM xyu LEFT OUTER JOIN xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:1!null y:2!null u:3!null v:7
 └── select
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8
      ├── left-join (hash)
      │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8
      │    ├── scan xyu
      │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── scan xyv
      │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── xyu.x:1 > 2

build
SELECT * FROM xyu RIGHT OUTER JOIN xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:5!null y:6!null u:3 v:7!null
 └── select
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── right-join (hash)
      │    ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    ├── scan xyu
      │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── scan xyv
      │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── xyv.x:5 > 2

build
SELECT * FROM xyu FULL OUTER JOIN xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:9!null y:10 u:3 v:7
 └── select
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8 x:9!null y:10
      ├── project
      │    ├── columns: x:9 y:10 xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8
      │    ├── full-join (hash)
      │    │    ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8
      │    │    ├── scan xyu
      │    │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    │    ├── scan xyv
      │    │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    │    └── filters
      │    │         ├── xyu.x:1 = xyv.x:5
      │    │         └── xyu.y:2 = xyv.y:6
      │    └── projections
      │         ├── COALESCE(xyu.x:1, xyv.x:5) [as=x:9]
      │         └── COALESCE(xyu.y:2, xyv.y:6) [as=y:10]
      └── filters
           └── x:9 > 2

# Verify that we transfer constraints between the two sides.
build
SELECT * FROM xyu INNER JOIN xyv ON xyu.x = xyv.x AND xyu.y = xyv.y WHERE xyu.x = 1 AND xyu.y < 10
----
project
 ├── columns: x:1!null y:2!null u:3!null x:5!null y:6!null v:7!null
 └── select
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── inner-join (cross)
      │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    ├── scan xyu
      │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── scan xyv
      │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         └── (xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)
      └── filters
           └── (xyu.x:1 = 1) AND (xyu.y:2 < 10)

build
SELECT * FROM xyu INNER JOIN xyv ON xyu.x = xyv.x AND xyu.y = xyv.y AND xyu.x = 1 AND xyu.y < 10
----
project
 ├── columns: x:1!null y:2!null u:3!null x:5!null y:6!null v:7!null
 └── inner-join (cross)
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── scan xyu
      │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      ├── scan xyv
      │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      └── filters
           └── (((xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)) AND (xyu.x:1 = 1)) AND (xyu.y:2 < 10)

build
SELECT * FROM xyu LEFT OUTER JOIN xyv ON xyu.x = xyv.x AND xyu.y = xyv.y AND xyu.x = 1 AND xyu.y < 10
----
project
 ├── columns: x:1!null y:2!null u:3!null x:5 y:6 v:7
 └── left-join (cross)
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5 xyv.y:6 v:7 xyv.crdb_internal_mvcc_timestamp:8
      ├── scan xyu
      │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      ├── scan xyv
      │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      └── filters
           └── (((xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)) AND (xyu.x:1 = 1)) AND (xyu.y:2 < 10)

build
SELECT * FROM xyu RIGHT OUTER JOIN xyv ON xyu.x = xyv.x AND xyu.y = xyv.y AND xyu.x = 1 AND xyu.y < 10
----
project
 ├── columns: x:1 y:2 u:3 x:5!null y:6!null v:7!null
 └── right-join (cross)
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── scan xyu
      │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      ├── scan xyv
      │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      └── filters
           └── (((xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)) AND (xyu.x:1 = 1)) AND (xyu.y:2 < 10)


# Test OUTER joins that are run in the distSQL merge joiner

build
SELECT * FROM (SELECT * FROM xyu ORDER BY x, y) AS xyu LEFT OUTER JOIN (SELECT * FROM xyv ORDER BY x, y) AS xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:1!null y:2!null u:3!null v:7
 └── select
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyv.x:5 xyv.y:6 v:7
      ├── left-join (hash)
      │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyv.x:5 xyv.y:6 v:7
      │    ├── project
      │    │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null
      │    │    └── scan xyu
      │    │         └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── project
      │    │    ├── columns: xyv.x:5!null xyv.y:6!null v:7!null
      │    │    └── scan xyv
      │    │         └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── xyu.x:1 > 2

build
SELECT * FROM (SELECT * FROM xyu ORDER BY x, y) AS xyu RIGHT OUTER JOIN (SELECT * FROM xyv ORDER BY x, y) AS xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:5!null y:6!null u:3 v:7!null
 └── select
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyv.x:5!null xyv.y:6!null v:7!null
      ├── right-join (hash)
      │    ├── columns: xyu.x:1 xyu.y:2 u:3 xyv.x:5!null xyv.y:6!null v:7!null
      │    ├── project
      │    │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null
      │    │    └── scan xyu
      │    │         └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── project
      │    │    ├── columns: xyv.x:5!null xyv.y:6!null v:7!null
      │    │    └── scan xyv
      │    │         └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── xyv.x:5 > 2

build
SELECT * FROM (SELECT * FROM xyu ORDER BY x, y) AS xyu FULL OUTER JOIN (SELECT * FROM xyv ORDER BY x, y) AS xyv USING(x, y) WHERE x > 2
----
project
 ├── columns: x:9!null y:10 u:3 v:7
 └── select
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyv.x:5 xyv.y:6 v:7 x:9!null y:10
      ├── project
      │    ├── columns: x:9 y:10 xyu.x:1 xyu.y:2 u:3 xyv.x:5 xyv.y:6 v:7
      │    ├── full-join (hash)
      │    │    ├── columns: xyu.x:1 xyu.y:2 u:3 xyv.x:5 xyv.y:6 v:7
      │    │    ├── project
      │    │    │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null
      │    │    │    └── scan xyu
      │    │    │         └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    │    ├── project
      │    │    │    ├── columns: xyv.x:5!null xyv.y:6!null v:7!null
      │    │    │    └── scan xyv
      │    │    │         └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    │    └── filters
      │    │         ├── xyu.x:1 = xyv.x:5
      │    │         └── xyu.y:2 = xyv.y:6
      │    └── projections
      │         ├── COALESCE(xyu.x:1, xyv.x:5) [as=x:9]
      │         └── COALESCE(xyu.y:2, xyv.y:6) [as=y:10]
      └── filters
           └── x:9 > 2

build
SELECT * FROM (SELECT * FROM xyu ORDER BY x, y) AS xyu LEFT OUTER JOIN (SELECT * FROM xyv ORDER BY x, y) AS xyv ON xyu.x = xyv.x AND xyu.y = xyv.y AND xyu.x = 1 AND xyu.y < 10
----
left-join (cross)
 ├── columns: x:1!null y:2!null u:3!null x:5 y:6 v:7
 ├── project
 │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null
 │    └── scan xyu
 │         └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
 ├── project
 │    ├── columns: xyv.x:5!null xyv.y:6!null v:7!null
 │    └── scan xyv
 │         └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
 └── filters
      └── (((xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)) AND (xyu.x:1 = 1)) AND (xyu.y:2 < 10)

build
SELECT * FROM xyu RIGHT OUTER JOIN (SELECT * FROM xyv ORDER BY x, y) AS xyv ON xyu.x = xyv.x AND xyu.y = xyv.y AND xyu.x = 1 AND xyu.y < 10
----
project
 ├── columns: x:1 y:2 u:3 x:5!null y:6!null v:7!null
 └── right-join (cross)
      ├── columns: xyu.x:1 xyu.y:2 u:3 xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null
      ├── scan xyu
      │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      ├── project
      │    ├── columns: xyv.x:5!null xyv.y:6!null v:7!null
      │    └── scan xyv
      │         └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      └── filters
           └── (((xyu.x:1 = xyv.x:5) AND (xyu.y:2 = xyv.y:6)) AND (xyu.x:1 = 1)) AND (xyu.y:2 < 10)

# Regression test for #20472: break up tuple inequalities.
build
SELECT * FROM xyu JOIN xyv USING(x, y) WHERE (x, y, u) > (1, 2, 3)
----
project
 ├── columns: x:1!null y:2!null u:3!null v:7!null
 └── select
      ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      ├── inner-join (hash)
      │    ├── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4 xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    ├── scan xyu
      │    │    └── columns: xyu.x:1!null xyu.y:2!null u:3!null xyu.crdb_internal_mvcc_timestamp:4
      │    ├── scan xyv
      │    │    └── columns: xyv.x:5!null xyv.y:6!null v:7!null xyv.crdb_internal_mvcc_timestamp:8
      │    └── filters
      │         ├── xyu.x:1 = xyv.x:5
      │         └── xyu.y:2 = xyv.y:6
      └── filters
           └── (xyu.x:1, xyu.y:2, u:3) > (1, 2, 3)


# Regression test for #20858.

exec-ddl
CREATE TABLE l (a INT PRIMARY KEY)
----

exec-ddl
CREATE TABLE r (a INT PRIMARY KEY)
----

build
SELECT * FROM l LEFT OUTER JOIN r ON l.a = r.a WHERE l.a = 3;
----
project
 ├── columns: a:1!null a:3
 └── select
      ├── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2 r.a:3 r.crdb_internal_mvcc_timestamp:4
      ├── left-join (hash)
      │    ├── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2 r.a:3 r.crdb_internal_mvcc_timestamp:4
      │    ├── scan l
      │    │    └── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2
      │    ├── scan r
      │    │    └── columns: r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    └── filters
      │         └── l.a:1 = r.a:3
      └── filters
           └── l.a:1 = 3

build
SELECT * FROM l RIGHT OUTER JOIN r ON l.a = r.a WHERE r.a = 3;
----
project
 ├── columns: a:1 a:3!null
 └── select
      ├── columns: l.a:1 l.crdb_internal_mvcc_timestamp:2 r.a:3!null r.crdb_internal_mvcc_timestamp:4
      ├── right-join (hash)
      │    ├── columns: l.a:1 l.crdb_internal_mvcc_timestamp:2 r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    ├── scan l
      │    │    └── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2
      │    ├── scan r
      │    │    └── columns: r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    └── filters
      │         └── l.a:1 = r.a:3
      └── filters
           └── r.a:3 = 3

build
SELECT * FROM l LEFT OUTER JOIN r USING(a) WHERE a = 1
----
project
 ├── columns: a:1!null
 └── select
      ├── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2 r.a:3 r.crdb_internal_mvcc_timestamp:4
      ├── left-join (hash)
      │    ├── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2 r.a:3 r.crdb_internal_mvcc_timestamp:4
      │    ├── scan l
      │    │    └── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2
      │    ├── scan r
      │    │    └── columns: r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    └── filters
      │         └── l.a:1 = r.a:3
      └── filters
           └── l.a:1 = 1

build
SELECT * FROM l RIGHT OUTER JOIN r USING(a) WHERE a = 3
----
project
 ├── columns: a:3!null
 └── select
      ├── columns: l.a:1 l.crdb_internal_mvcc_timestamp:2 r.a:3!null r.crdb_internal_mvcc_timestamp:4
      ├── right-join (hash)
      │    ├── columns: l.a:1 l.crdb_internal_mvcc_timestamp:2 r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    ├── scan l
      │    │    └── columns: l.a:1!null l.crdb_internal_mvcc_timestamp:2
      │    ├── scan r
      │    │    └── columns: r.a:3!null r.crdb_internal_mvcc_timestamp:4
      │    └── filters
      │         └── l.a:1 = r.a:3
      └── filters
           └── r.a:3 = 3

# Regression tests for #21243
exec-ddl
CREATE TABLE abcdef (
  a INT NOT NULL,
  b INT NOT NULL,
  c INT NOT NULL,
  d INT NOT NULL,
  e INT NULL,
  f INT NULL,
  PRIMARY KEY (a ASC, b ASC, c DESC, d ASC)
)
----

exec-ddl
CREATE TABLE abg (
  a INT NOT NULL,
  b INT NOT NULL,
  g INT NULL,
  PRIMARY KEY (a ASC, b ASC)
);
----

build
SELECT * FROM abcdef join (select * from abg) USING (a,b) WHERE ((a,b)>(1,2) OR ((a,b)=(1,2) AND c < 6) OR ((a,b,c)=(1,2,6) AND d > 8))
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4!null e:5 f:6 g:10
 └── select
      ├── columns: abcdef.a:1!null abcdef.b:2!null c:3!null d:4!null e:5 f:6 abcdef.crdb_internal_mvcc_timestamp:7 abg.a:8!null abg.b:9!null g:10
      ├── inner-join (hash)
      │    ├── columns: abcdef.a:1!null abcdef.b:2!null c:3!null d:4!null e:5 f:6 abcdef.crdb_internal_mvcc_timestamp:7 abg.a:8!null abg.b:9!null g:10
      │    ├── scan abcdef
      │    │    └── columns: abcdef.a:1!null abcdef.b:2!null c:3!null d:4!null e:5 f:6 abcdef.crdb_internal_mvcc_timestamp:7
      │    ├── project
      │    │    ├── columns: abg.a:8!null abg.b:9!null g:10
      │    │    └── scan abg
      │    │         └── columns: abg.a:8!null abg.b:9!null g:10 abg.crdb_internal_mvcc_timestamp:11
      │    └── filters
      │         ├── abcdef.a:1 = abg.a:8
      │         └── abcdef.b:2 = abg.b:9
      └── filters
           └── (((abcdef.a:1, abcdef.b:2) > (1, 2)) OR (((abcdef.a:1, abcdef.b:2) = (1, 2)) AND (c:3 < 6))) OR (((abcdef.a:1, abcdef.b:2, c:3) = (1, 2, 6)) AND (d:4 > 8))

# Regression tests for mixed-type equality columns (#22514).
exec-ddl
CREATE TABLE foo (
  a INT,
  b INT,
  c FLOAT,
  d FLOAT
)
----

exec-ddl
CREATE TABLE bar (
  a INT,
  b FLOAT,
  c FLOAT,
  d INT
)
----

# Only a and c can be equality columns.
build
SELECT * FROM foo NATURAL JOIN bar
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4!null
 └── inner-join (hash)
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3!null foo.d:4!null foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9!null bar.d:10!null bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── foo.a:1 = bar.a:7
           ├── foo.b:2 = bar.b:8
           ├── foo.c:3 = bar.c:9
           └── foo.d:4 = bar.d:10

# b can't be an equality column.
build
SELECT * FROM foo JOIN bar USING (b)
----
project
 ├── columns: b:2!null a:1 c:3 d:4 a:7 c:9 d:10
 └── inner-join (cross)
      ├── columns: foo.a:1 foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7 bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           └── foo.b:2 = bar.b:8

# Only a can be an equality column.
build
SELECT * FROM foo JOIN bar USING (a, b)
----
project
 ├── columns: a:1!null b:2!null c:3 d:4 c:9 d:10
 └── inner-join (hash)
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── foo.a:1 = bar.a:7
           └── foo.b:2 = bar.b:8

# Only a and c can be equality columns.
build
SELECT * FROM foo JOIN bar USING (a, b, c)
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4 d:10
 └── inner-join (hash)
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3!null foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9!null bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           ├── foo.a:1 = bar.a:7
           ├── foo.b:2 = bar.b:8
           └── foo.c:3 = bar.c:9

# b can't be an equality column.
build
SELECT * FROM foo JOIN bar ON foo.b = bar.b
----
project
 ├── columns: a:1 b:2!null c:3 d:4 a:7 b:8!null c:9 d:10
 └── inner-join (cross)
      ├── columns: foo.a:1 foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7 bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           └── foo.b:2 = bar.b:8

# Only a can be an equality column.
build
SELECT * FROM foo JOIN bar ON foo.a = bar.a AND foo.b = bar.b
----
project
 ├── columns: a:1!null b:2!null c:3 d:4 a:7!null b:8!null c:9 d:10
 └── inner-join (cross)
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── scan foo
      │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      ├── scan bar
      │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      └── filters
           └── (foo.a:1 = bar.a:7) AND (foo.b:2 = bar.b:8)

build
SELECT * FROM foo, bar WHERE foo.b = bar.b
----
project
 ├── columns: a:1 b:2!null c:3 d:4 a:7 b:8!null c:9 d:10
 └── select
      ├── columns: foo.a:1 foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7 bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── inner-join (cross)
      │    ├── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    ├── scan foo
      │    │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      │    ├── scan bar
      │    │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    └── filters (true)
      └── filters
           └── foo.b:2 = bar.b:8

# Only a can be an equality column.
build
SELECT * FROM foo, bar WHERE foo.a = bar.a AND foo.b = bar.b
----
project
 ├── columns: a:1!null b:2!null c:3 d:4 a:7!null b:8!null c:9 d:10
 └── select
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── inner-join (cross)
      │    ├── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    ├── scan foo
      │    │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      │    ├── scan bar
      │    │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    └── filters (true)
      └── filters
           └── (foo.a:1 = bar.a:7) AND (foo.b:2 = bar.b:8)

# Only a and c can be equality columns.
build
SELECT * FROM foo JOIN bar USING (a, b) WHERE foo.c = bar.c AND foo.d = bar.d
----
project
 ├── columns: a:1!null b:2!null c:3!null d:4!null c:9!null d:10!null
 └── select
      ├── columns: foo.a:1!null foo.b:2!null foo.c:3!null foo.d:4!null foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9!null bar.d:10!null bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      ├── inner-join (hash)
      │    ├── columns: foo.a:1!null foo.b:2!null foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6 bar.a:7!null bar.b:8!null bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    ├── scan foo
      │    │    └── columns: foo.a:1 foo.b:2 foo.c:3 foo.d:4 foo.rowid:5!null foo.crdb_internal_mvcc_timestamp:6
      │    ├── scan bar
      │    │    └── columns: bar.a:7 bar.b:8 bar.c:9 bar.d:10 bar.rowid:11!null bar.crdb_internal_mvcc_timestamp:12
      │    └── filters
      │         ├── foo.a:1 = bar.a:7
      │         └── foo.b:2 = bar.b:8
      └── filters
           └── (foo.c:3 = bar.c:9) AND (foo.d:4 = bar.d:10)

exec-ddl
CREATE TABLE t.kv (
  k INT PRIMARY KEY,
  v INT,
  w INT,
  s STRING
)
----

build
SELECT k FROM kv, (SELECT 1 AS k)
----
project
 ├── columns: k:6!null
 └── inner-join (cross)
      ├── columns: kv.k:1!null v:2 w:3 s:4 crdb_internal_mvcc_timestamp:5 k:6!null
      ├── scan kv
      │    └── columns: kv.k:1!null v:2 w:3 s:4 crdb_internal_mvcc_timestamp:5
      ├── project
      │    ├── columns: k:6!null
      │    ├── values
      │    │    └── ()
      │    └── projections
      │         └── 1 [as=k:6]
      └── filters (true)

build
select * from (select 1 as k), (select 2 as k) where 1 in (select k from kv)
----
select
 ├── columns: k:1!null k:2!null
 ├── inner-join (cross)
 │    ├── columns: k:1!null k:2!null
 │    ├── project
 │    │    ├── columns: k:1!null
 │    │    ├── values
 │    │    │    └── ()
 │    │    └── projections
 │    │         └── 1 [as=k:1]
 │    ├── project
 │    │    ├── columns: k:2!null
 │    │    ├── values
 │    │    │    └── ()
 │    │    └── projections
 │    │         └── 2 [as=k:2]
 │    └── filters (true)
 └── filters
      └── any: eq
           ├── project
           │    ├── columns: kv.k:3!null
           │    └── scan kv
           │         └── columns: kv.k:3!null v:4 w:5 s:6 crdb_internal_mvcc_timestamp:7
           └── 1

# Test natural outer join when the left side has unknown type
build
SELECT * FROM (VALUES (NULL, NULL)) NATURAL FULL OUTER JOIN (SELECT * FROM (VALUES (1, 1)))
----
project
 ├── columns: column1:5 column2:6
 └── project
      ├── columns: column1:5 column2:6 column1:1 column2:2 column1:3 column2:4
      ├── full-join (cross)
      │    ├── columns: column1:1 column2:2 column1:3 column2:4
      │    ├── values
      │    │    ├── columns: column1:1 column2:2
      │    │    └── (NULL, NULL)
      │    ├── values
      │    │    ├── columns: column1:3!null column2:4!null
      │    │    └── (1, 1)
      │    └── filters
      │         ├── column1:1 = column1:3
      │         └── column2:2 = column2:4
      └── projections
           ├── COALESCE(column1:1, column1:3) [as=column1:5]
           └── COALESCE(column2:2, column2:4) [as=column2:6]

# Regression test for #23609: make sure that the type of the merged column
# is int (not unknown).
build
SELECT column1, column1+1 AS r
FROM
  (SELECT * FROM
    (VALUES (NULL, NULL)) AS t
      NATURAL FULL OUTER JOIN
    (VALUES (1, 1)) AS u)
----
project
 ├── columns: column1:5 r:7
 ├── project
 │    ├── columns: column1:5 column2:6
 │    └── project
 │         ├── columns: column1:5 column2:6 column1:1 column2:2 column1:3 column2:4
 │         ├── full-join (cross)
 │         │    ├── columns: column1:1 column2:2 column1:3 column2:4
 │         │    ├── values
 │         │    │    ├── columns: column1:1 column2:2
 │         │    │    └── (NULL, NULL)
 │         │    ├── values
 │         │    │    ├── columns: column1:3!null column2:4!null
 │         │    │    └── (1, 1)
 │         │    └── filters
 │         │         ├── column1:1 = column1:3
 │         │         └── column2:2 = column2:4
 │         └── projections
 │              ├── COALESCE(column1:1, column1:3) [as=column1:5]
 │              └── COALESCE(column2:2, column2:4) [as=column2:6]
 └── projections
      └── column1:5 + 1 [as=r:7]

# ON clause must be type bool.
build
SELECT * FROM foo JOIN bar ON foo.c
----
error (42804): argument of ON must be type bool, not type float

# Regression test for #28817. Do not allow special functions in ON clause.
build
SELECT * FROM foo JOIN bar ON generate_series(0, 1) < 2
----
error (0A000): generate_series(): generator functions are not allowed in ON

build
SELECT * FROM foo JOIN bar ON max(foo.c) < 2
----
error (42803): aggregate functions are not allowed in JOIN conditions

# Verify join hints get populated.
build
SELECT * FROM onecolumn AS a(x) INNER MERGE JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1!null y:4!null
 └── inner-join (hash)
      ├── columns: x:1!null a.rowid:2!null a.crdb_internal_mvcc_timestamp:3 y:4!null b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      ├── flags: force merge join
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

build
SELECT * FROM onecolumn AS a NATURAL LEFT LOOKUP JOIN onecolumn as b USING(x)
----
error (42601): at or near "using": syntax error

build
SELECT * FROM onecolumn AS a(x) FULL OUTER HASH JOIN onecolumn AS b(y) ON a.x = b.y
----
project
 ├── columns: x:1 y:4
 └── full-join (hash)
      ├── columns: x:1 a.rowid:2 a.crdb_internal_mvcc_timestamp:3 y:4 b.rowid:5 b.crdb_internal_mvcc_timestamp:6
      ├── flags: force hash join (store right side)
      ├── scan onecolumn [as=a]
      │    └── columns: x:1 a.rowid:2!null a.crdb_internal_mvcc_timestamp:3
      ├── scan onecolumn [as=b]
      │    └── columns: y:4 b.rowid:5!null b.crdb_internal_mvcc_timestamp:6
      └── filters
           └── x:1 = y:4

# Regression test for #46403.
exec-ddl
CREATE TABLE t0(c0 INT)
----

exec-ddl
CREATE VIEW v0(c0, c1) AS SELECT DISTINCT c0, c0 FROM t0
----

build
SELECT * FROM v0 NATURAL JOIN t0
----
project
 ├── columns: c0:1!null c1:1!null
 └── inner-join (hash)
      ├── columns: c0:1!null c0:4!null rowid:5!null crdb_internal_mvcc_timestamp:6
      ├── distinct-on
      │    ├── columns: c0:1
      │    ├── grouping columns: c0:1
      │    └── project
      │         ├── columns: c0:1
      │         └── scan t0
      │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── scan t0
      │    └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           └── c0:1 = c0:4

build
SELECT * FROM t0 NATURAL JOIN v0
----
project
 ├── columns: c0:1!null c1:4!null
 └── inner-join (hash)
      ├── columns: c0:1!null rowid:2!null crdb_internal_mvcc_timestamp:3 c0:4!null
      ├── scan t0
      │    └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── distinct-on
      │    ├── columns: c0:4
      │    ├── grouping columns: c0:4
      │    └── project
      │         ├── columns: c0:4
      │         └── scan t0
      │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           └── c0:1 = c0:4

build
SELECT * FROM v0 NATURAL JOIN v0 AS v1
----
project
 ├── columns: c0:1!null c1:1!null
 └── inner-join (hash)
      ├── columns: c0:1!null c0:4!null
      ├── distinct-on
      │    ├── columns: c0:1
      │    ├── grouping columns: c0:1
      │    └── project
      │         ├── columns: c0:1
      │         └── scan t0
      │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── distinct-on
      │    ├── columns: c0:4
      │    ├── grouping columns: c0:4
      │    └── project
      │         ├── columns: c0:4
      │         └── scan t0
      │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           ├── c0:1 = c0:4
           └── c0:1 = c0:4

build
SELECT * FROM v0 NATURAL LEFT JOIN v0 AS v1
----
project
 ├── columns: c0:1 c1:1
 └── left-join (hash)
      ├── columns: c0:1 c0:4
      ├── distinct-on
      │    ├── columns: c0:1
      │    ├── grouping columns: c0:1
      │    └── project
      │         ├── columns: c0:1
      │         └── scan t0
      │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── distinct-on
      │    ├── columns: c0:4
      │    ├── grouping columns: c0:4
      │    └── project
      │         ├── columns: c0:4
      │         └── scan t0
      │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           ├── c0:1 = c0:4
           └── c0:1 = c0:4

build
SELECT * FROM v0 NATURAL RIGHT JOIN v0 AS v1
----
project
 ├── columns: c0:4 c1:4
 └── right-join (hash)
      ├── columns: c0:1 c0:4
      ├── distinct-on
      │    ├── columns: c0:1
      │    ├── grouping columns: c0:1
      │    └── project
      │         ├── columns: c0:1
      │         └── scan t0
      │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── distinct-on
      │    ├── columns: c0:4
      │    ├── grouping columns: c0:4
      │    └── project
      │         ├── columns: c0:4
      │         └── scan t0
      │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           ├── c0:1 = c0:4
           └── c0:1 = c0:4

build
SELECT * FROM v0 NATURAL FULL OUTER JOIN v0 AS v1
----
project
 ├── columns: c0:7 c1:8
 └── project
      ├── columns: c0:7 c1:8 t0.c0:1 t0.c0:4
      ├── full-join (hash)
      │    ├── columns: t0.c0:1 t0.c0:4
      │    ├── distinct-on
      │    │    ├── columns: t0.c0:1
      │    │    ├── grouping columns: t0.c0:1
      │    │    └── project
      │    │         ├── columns: t0.c0:1
      │    │         └── scan t0
      │    │              └── columns: t0.c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      │    ├── distinct-on
      │    │    ├── columns: t0.c0:4
      │    │    ├── grouping columns: t0.c0:4
      │    │    └── project
      │    │         ├── columns: t0.c0:4
      │    │         └── scan t0
      │    │              └── columns: t0.c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      │    └── filters
      │         ├── t0.c0:1 = t0.c0:4
      │         └── t0.c0:1 = t0.c0:4
      └── projections
           ├── COALESCE(t0.c0:1, t0.c0:4) [as=c0:7]
           └── COALESCE(t0.c0:1, t0.c0:4) [as=c1:8]

build
SELECT * FROM (SELECT DISTINCT c0, c0 FROM t0) AS v1(c0, c1) NATURAL JOIN t0
----
project
 ├── columns: c0:1!null c1:1!null
 └── inner-join (hash)
      ├── columns: c0:1!null c0:4!null rowid:5!null crdb_internal_mvcc_timestamp:6
      ├── distinct-on
      │    ├── columns: c0:1
      │    ├── grouping columns: c0:1
      │    └── project
      │         ├── columns: c0:1
      │         └── scan t0
      │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
      ├── scan t0
      │    └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
      └── filters
           └── c0:1 = c0:4

build
SELECT * FROM v0 JOIN v0 AS v1 USING (c0)
----
inner-join (hash)
 ├── columns: c0:1!null c1:1!null c1:4!null
 ├── distinct-on
 │    ├── columns: c0:1
 │    ├── grouping columns: c0:1
 │    └── project
 │         ├── columns: c0:1
 │         └── scan t0
 │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
 ├── distinct-on
 │    ├── columns: c0:4
 │    ├── grouping columns: c0:4
 │    └── project
 │         ├── columns: c0:4
 │         └── scan t0
 │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
 └── filters
      └── c0:1 = c0:4

build
SELECT * FROM v0 JOIN v0 AS v1 USING (c1)
----
inner-join (hash)
 ├── columns: c1:1!null c0:1!null c0:4!null
 ├── distinct-on
 │    ├── columns: c0:1
 │    ├── grouping columns: c0:1
 │    └── project
 │         ├── columns: c0:1
 │         └── scan t0
 │              └── columns: c0:1 rowid:2!null crdb_internal_mvcc_timestamp:3
 ├── distinct-on
 │    ├── columns: c0:4
 │    ├── grouping columns: c0:4
 │    └── project
 │         ├── columns: c0:4
 │         └── scan t0
 │              └── columns: c0:4 rowid:5!null crdb_internal_mvcc_timestamp:6
 └── filters
      └── c0:1 = c0:4
