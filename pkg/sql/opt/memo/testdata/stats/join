exec-ddl
CREATE TABLE xysd (x INT PRIMARY KEY, y INT, s STRING, d DECIMAL NOT NULL, UNIQUE (s DESC, d))
----

exec-ddl
CREATE TABLE uv (u INT, v INT NOT NULL)
----

exec-ddl
ALTER TABLE xysd INJECT STATISTICS '[
  {
    "columns": ["x"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 5000
  },
  {
    "columns": ["y"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 400
  }
]'
----

exec-ddl
ALTER TABLE uv INJECT STATISTICS '[
  {
    "columns": ["u"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 500
  },
  {
    "columns": ["v"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 100
  },
  {
    "columns": ["rowid"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  }
]'
----

norm
SELECT * FROM xysd JOIN uv ON true
----
inner-join (cross)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int!null)
 ├── stats: [rows=50000000]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int) v:7(int!null)
 │    └── stats: [rows=10000]
 └── filters (true)

norm colstat=1 colstat=2 colstat=3 colstat=4 colstat=6 colstat=7 colstat=(2,6,7)
SELECT * FROM xysd JOIN uv ON true
----
inner-join (cross)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int!null)
 ├── stats: [rows=50000000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0, distinct(3)=500, null(3)=500000, distinct(4)=500, null(4)=0, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0, distinct(2,6,7)=4000000, null(2,6,7)=0]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0, distinct(3)=500, null(3)=50, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int) v:7(int!null)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0, distinct(6,7)=10000, null(6,7)=0]
 └── filters (true)

norm
SELECT * FROM xysd JOIN uv ON false
----
values
 ├── columns: x:1(int!null) y:2(int!null) s:3(string!null) d:4(decimal!null) u:6(int!null) v:7(int!null)
 ├── cardinality: [0 - 0]
 ├── stats: [rows=0]
 ├── key: ()
 └── fd: ()-->(1-4,6,7)

build colstat=2
SELECT *, rowid FROM xysd INNER JOIN uv ON x=u
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int!null) v:7(int!null) rowid:8(int!null)
 ├── stats: [rows=10000, distinct(2)=400, null(2)=0]
 ├── key: (8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2,6), (8)-->(1-4,6,7), (1)==(6), (6)==(1)
 └── inner-join (hash)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int!null) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      ├── stats: [rows=10000, distinct(1)=500, null(1)=0, distinct(2)=400, null(2)=0, distinct(6)=500, null(6)=0]
      ├── key: (8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9), (1)==(6), (6)==(1)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0, distinct(4)=500, null(4)=0]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build
SELECT *, rowid FROM xysd LEFT JOIN uv ON x=u
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=10000]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── left-join (hash)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(one-or-more), right-rows(zero-or-one)
      ├── stats: [rows=10000, distinct(6)=500, null(6)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build
SELECT *, rowid FROM xysd RIGHT JOIN uv ON x=u
----
project
 ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) u:6(int) v:7(int!null) rowid:8(int!null)
 ├── stats: [rows=10000]
 ├── key: (8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(1-4,6,7)
 └── right-join (hash)
      ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=10000, distinct(1)=500, null(1)=0]
      ├── key: (8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(1-7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build
SELECT *, rowid FROM xysd FULL JOIN uv ON x=u
----
project
 ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=10000]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── full-join (hash)
      ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(one-or-more), right-rows(exactly-one)
      ├── stats: [rows=10000]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build
SELECT * FROM xysd, uv
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int!null)
 ├── stats: [rows=50000000]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 └── inner-join (cross)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=50000000]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters (true)

build
SELECT * FROM xysd, xysd AS xysd
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) x:6(int!null) y:7(int) s:8(string) d:9(decimal!null)
 ├── stats: [rows=25000000]
 ├── key: (1,6)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (6)-->(7-9), (8,9)~~>(6,7)
 └── inner-join (cross)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) crdb_internal_mvcc_timestamp:5(decimal) x:6(int!null) y:7(int) s:8(string) d:9(decimal!null) crdb_internal_mvcc_timestamp:10(decimal)
      ├── stats: [rows=25000000]
      ├── key: (1,6)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (6)-->(7-10), (8,9)~~>(6,7,10)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan xysd
      │    ├── columns: x:6(int!null) y:7(int) s:8(string) d:9(decimal!null) crdb_internal_mvcc_timestamp:10(decimal)
      │    ├── stats: [rows=5000]
      │    ├── key: (6)
      │    └── fd: (6)-->(7-10), (8,9)~~>(6,7,10)
      └── filters (true)

build
SELECT * FROM xysd, uv WHERE v = 5
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int!null)
 ├── stats: [rows=500000]
 ├── fd: ()-->(7), (1)-->(2-4), (3,4)~~>(1,2)
 └── select
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=500000, distinct(7)=1, null(7)=0]
      ├── key: (1,8)
      ├── fd: ()-->(7), (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,9)
      ├── inner-join (cross)
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=50000000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    ├── key: (1,8)
      │    ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    │    ├── stats: [rows=10000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    │    ├── key: (8)
      │    │    └── fd: (8)-->(6,7,9)
      │    └── filters (true)
      └── filters
           └── v:7 = 5 [type=bool, outer=(7), constraints=(/7: [/5 - /5]; tight), fd=()-->(7)]

# Force calculation of the distinct count for the column set spanning both
# tables in the join.
build
SELECT sum(v), x, v FROM xysd, uv GROUP BY x, v
----
group-by
 ├── columns: sum:10(decimal!null) x:1(int!null) v:7(int!null)
 ├── grouping columns: x:1(int!null) v:7(int!null)
 ├── stats: [rows=500000, distinct(1,7)=500000, null(1,7)=0]
 ├── key: (1,7)
 ├── fd: (1,7)-->(10)
 ├── project
 │    ├── columns: x:1(int!null) v:7(int!null)
 │    ├── stats: [rows=50000000, distinct(1,7)=500000, null(1,7)=0]
 │    └── inner-join (cross)
 │         ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
 │         ├── stats: [rows=50000000, distinct(1,7)=500000, null(1,7)=0]
 │         ├── key: (1,8)
 │         ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
 │         ├── scan xysd
 │         │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
 │         │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0]
 │         │    ├── key: (1)
 │         │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
 │         ├── scan uv
 │         │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
 │         │    ├── stats: [rows=10000, distinct(7)=100, null(7)=0]
 │         │    ├── key: (8)
 │         │    └── fd: (8)-->(6,7,9)
 │         └── filters (true)
 └── aggregations
      └── sum [as=sum:10, type=decimal, outer=(7)]
           └── v:7 [type=int]

# Join selectivity: 1/max(distinct(x), distinct(u)) = 1/5000.
norm
SELECT sum(v), x, v FROM xysd, uv WHERE x=u GROUP BY x, v
----
group-by
 ├── columns: sum:10(decimal!null) x:1(int!null) v:7(int!null)
 ├── grouping columns: x:1(int!null) v:7(int!null)
 ├── stats: [rows=10000, distinct(1,7)=10000, null(1,7)=0]
 ├── key: (1,7)
 ├── fd: (1,7)-->(10)
 ├── inner-join (hash)
 │    ├── columns: x:1(int!null) u:6(int!null) v:7(int!null)
 │    ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 │    ├── stats: [rows=10000, distinct(1)=500, null(1)=0, distinct(6)=500, null(6)=0, distinct(1,7)=10000, null(1,7)=0]
 │    ├── fd: (1)==(6), (6)==(1)
 │    ├── scan xysd
 │    │    ├── columns: x:1(int!null)
 │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0]
 │    │    └── key: (1)
 │    ├── scan uv
 │    │    ├── columns: u:6(int) v:7(int!null)
 │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
 │    └── filters
 │         └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
 └── aggregations
      └── sum [as=sum:10, type=decimal, outer=(7)]
           └── v:7 [type=int]

# Semi-join.
norm
SELECT * FROM xysd WHERE EXISTS (SELECT * FROM uv WHERE x=u)
----
semi-join (hash)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 ├── stats: [rows=500, distinct(1)=500, null(1)=0]
 ├── key: (1)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0]
 └── filters
      └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

# Anti-join.
norm
SELECT * FROM xysd WHERE NOT EXISTS (SELECT * FROM uv WHERE x=u)
----
anti-join (hash)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 ├── stats: [rows=4500]
 ├── key: (1)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0]
 └── filters
      └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

# Multiple equality conditions.
norm
SELECT * FROM xysd JOIN uv ON x=u AND y=v
----
inner-join (hash)
 ├── columns: x:1(int!null) y:2(int!null) s:3(string) d:4(decimal!null) u:6(int!null) v:7(int!null)
 ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 ├── stats: [rows=25, distinct(1)=25, null(1)=0, distinct(2)=25, null(2)=0, distinct(6)=25, null(6)=0, distinct(7)=25, null(7)=0]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (1)==(6), (6)==(1), (2)==(7), (7)==(2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int) v:7(int!null)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
 └── filters
      ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      └── y:2 = v:7 [type=bool, outer=(2,7), constraints=(/2: (/NULL - ]; /7: (/NULL - ]), fd=(2)==(7), (7)==(2)]

# Equality condition + extra filters.
norm
SELECT * FROM xysd JOIN uv ON x=u AND y+v=5 AND y > 0 AND y < 300
----
inner-join (hash)
 ├── columns: x:1(int!null) y:2(int!null) s:3(string) d:4(decimal!null) u:6(int!null) v:7(int!null)
 ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
 ├── immutable
 ├── stats: [rows=3333.33333, distinct(1)=500, null(1)=0, distinct(6)=500, null(6)=0]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (1)==(6), (6)==(1)
 ├── select
 │    ├── columns: x:1(int!null) y:2(int!null) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=3737.5, distinct(1)=3737.5, null(1)=0, distinct(2)=299, null(2)=0, distinct(4)=499.999473, null(4)=0]
 │    ├── key: (1)
 │    ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 │    ├── scan xysd
 │    │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0, distinct(4)=500, null(4)=0]
 │    │    ├── key: (1)
 │    │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 │    └── filters
 │         └── (y:2 > 0) AND (y:2 < 300) [type=bool, outer=(2), constraints=(/2: [/1 - /299]; tight)]
 ├── scan uv
 │    ├── columns: u:6(int) v:7(int!null)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
 └── filters
      ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]

# Force column statistics calculation for semi-join.
norm
SELECT count(*)
FROM (SELECT * FROM xysd WHERE EXISTS (SELECT * FROM uv WHERE x=u AND y+v=5)) AS a
GROUP BY y
----
project
 ├── columns: count:10(int!null)
 ├── immutable
 ├── stats: [rows=138.170075]
 └── group-by
      ├── columns: y:2(int) count_rows:10(int!null)
      ├── grouping columns: y:2(int)
      ├── immutable
      ├── stats: [rows=138.170075, distinct(2)=138.170075, null(2)=0]
      ├── key: (2)
      ├── fd: (2)-->(10)
      ├── semi-join (hash)
      │    ├── columns: x:1(int!null) y:2(int)
      │    ├── immutable
      │    ├── stats: [rows=166.666667, distinct(1)=166.666667, null(1)=0, distinct(2)=138.170075, null(2)=0]
      │    ├── key: (1)
      │    ├── fd: (1)-->(2)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null)
      │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
      │    └── filters
      │         ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      │         └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]
      └── aggregations
           └── count-rows [as=count_rows:10, type=int]

# Force column statistics calculation for anti-join.
norm
SELECT count(*)
FROM (SELECT * FROM xysd WHERE NOT EXISTS (SELECT * FROM uv WHERE x=u AND y+v=5)) AS a
GROUP BY y
----
project
 ├── columns: count:10(int!null)
 ├── immutable
 ├── stats: [rows=400]
 └── group-by
      ├── columns: y:2(int) count_rows:10(int!null)
      ├── grouping columns: y:2(int)
      ├── immutable
      ├── stats: [rows=400, distinct(2)=400, null(2)=0]
      ├── key: (2)
      ├── fd: (2)-->(10)
      ├── anti-join (hash)
      │    ├── columns: x:1(int!null) y:2(int)
      │    ├── immutable
      │    ├── stats: [rows=4833.33333, distinct(2)=400, null(2)=0]
      │    ├── key: (1)
      │    ├── fd: (1)-->(2)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null)
      │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
      │    └── filters
      │         ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      │         └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]
      └── aggregations
           └── count-rows [as=count_rows:10, type=int]

# Force column statistics calculation for left join.
norm
SELECT count(*)
FROM (SELECT * FROM xysd LEFT OUTER JOIN uv ON x=u AND y+v=5) AS a
GROUP BY y
----
project
 ├── columns: count:10(int!null)
 ├── immutable
 ├── stats: [rows=400]
 └── group-by
      ├── columns: y:2(int) count_rows:10(int!null)
      ├── grouping columns: y:2(int)
      ├── immutable
      ├── stats: [rows=400, distinct(2)=400, null(2)=0]
      ├── key: (2)
      ├── fd: (2)-->(10)
      ├── left-join (hash)
      │    ├── columns: x:1(int!null) y:2(int) u:6(int) v:7(int)
      │    ├── multiplicity: left-rows(one-or-more), right-rows(zero-or-one)
      │    ├── immutable
      │    ├── stats: [rows=5000, distinct(2)=400, null(2)=0, distinct(6)=500, null(6)=1666.66667]
      │    ├── fd: (1)-->(2)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null)
      │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0]
      │    └── filters
      │         ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      │         └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]
      └── aggregations
           └── count-rows [as=count_rows:10, type=int]

# Force column statistics calculation for right join.
norm
SELECT count(*)
FROM (SELECT * FROM xysd RIGHT OUTER JOIN uv ON x=u AND y+v=5) AS a
GROUP BY y
----
project
 ├── columns: count:10(int!null)
 ├── immutable
 ├── stats: [rows=399.903879]
 └── group-by
      ├── columns: y:2(int) count_rows:10(int!null)
      ├── grouping columns: y:2(int)
      ├── immutable
      ├── stats: [rows=399.903879, distinct(2)=399.903879, null(2)=1]
      ├── key: (2)
      ├── fd: (2)-->(10)
      ├── left-join (hash)
      │    ├── columns: x:1(int) y:2(int) u:6(int) v:7(int!null)
      │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
      │    ├── immutable
      │    ├── stats: [rows=10000, distinct(1)=500, null(1)=6666.66667, distinct(2)=399.903879, null(2)=6666.66667]
      │    ├── fd: (1)-->(2)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null)
      │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0]
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2)
      │    └── filters
      │         ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      │         └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]
      └── aggregations
           └── count-rows [as=count_rows:10, type=int]

# Force column statistics calculation for outer join.
norm
SELECT count(*)
FROM (SELECT * FROM xysd FULL OUTER JOIN uv ON x=u AND y+v=5) AS a
GROUP BY y
----
project
 ├── columns: count:10(int!null)
 ├── immutable
 ├── stats: [rows=400]
 └── group-by
      ├── columns: y:2(int) count_rows:10(int!null)
      ├── grouping columns: y:2(int)
      ├── immutable
      ├── stats: [rows=400, distinct(2)=400, null(2)=1]
      ├── key: (2)
      ├── fd: (2)-->(10)
      ├── full-join (hash)
      │    ├── columns: x:1(int) y:2(int) u:6(int) v:7(int)
      │    ├── multiplicity: left-rows(one-or-more), right-rows(exactly-one)
      │    ├── immutable
      │    ├── stats: [rows=11666.6667, distinct(2)=400, null(2)=6666.66667]
      │    ├── fd: (1)-->(2)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=0]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null)
      │    │    └── stats: [rows=10000, distinct(6)=500, null(6)=0]
      │    └── filters
      │         ├── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      │         └── (y:2 + v:7) = 5 [type=bool, outer=(2,7), immutable]
      └── aggregations
           └── count-rows [as=count_rows:10, type=int]

exec-ddl
CREATE TABLE uvw (u INT, v INT, w INT)
----

exec-ddl
CREATE TABLE xyz (x INT, y INT, z INT)
----

# Verify that two equivalent formulations of a join lead to similar statistics.
# In the first case, x=10 is pushed down; in the second case it is part of the
# ON condition. The latter formulation happens in practice when we convert to
# lookup join (we incorporate the filter back into the ON condition).

norm disable=(PushFilterIntoJoinLeftAndRight,PushFilterIntoJoinLeft,PushFilterIntoJoinRight,MapFilterIntoJoinLeft,MapFilterIntoJoinRight)
SELECT * FROM (SELECT * FROM uvw WHERE w=1) JOIN (SELECT * FROM xyz WHERE x=10) ON u=x
----
inner-join (hash)
 ├── columns: u:1(int!null) v:2(int) w:3(int!null) x:6(int!null) y:7(int) z:8(int)
 ├── stats: [rows=10.3537072, distinct(1)=1, null(1)=0, distinct(6)=1, null(6)=0]
 ├── fd: ()-->(1,3,6), (1)==(6), (6)==(1)
 ├── select
 │    ├── columns: u:1(int) v:2(int) w:3(int!null)
 │    ├── stats: [rows=10, distinct(1)=9.5617925, null(1)=0.1, distinct(3)=1, null(3)=0]
 │    ├── fd: ()-->(3)
 │    ├── scan uvw
 │    │    ├── columns: u:1(int) v:2(int) w:3(int)
 │    │    └── stats: [rows=1000, distinct(1)=100, null(1)=10, distinct(3)=100, null(3)=10]
 │    └── filters
 │         └── w:3 = 1 [type=bool, outer=(3), constraints=(/3: [/1 - /1]; tight), fd=()-->(3)]
 ├── select
 │    ├── columns: x:6(int!null) y:7(int) z:8(int)
 │    ├── stats: [rows=10, distinct(6)=1, null(6)=0]
 │    ├── fd: ()-->(6)
 │    ├── scan xyz
 │    │    ├── columns: x:6(int) y:7(int) z:8(int)
 │    │    └── stats: [rows=1000, distinct(6)=100, null(6)=10]
 │    └── filters
 │         └── x:6 = 10 [type=bool, outer=(6), constraints=(/6: [/10 - /10]; tight), fd=()-->(6)]
 └── filters
      └── u:1 = x:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

norm disable=(PushFilterIntoJoinLeftAndRight,PushFilterIntoJoinLeft,PushFilterIntoJoinRight,MapFilterIntoJoinLeft,MapFilterIntoJoinRight)
SELECT * FROM (SELECT * FROM uvw WHERE w=1) JOIN xyz ON u=x AND x=10
----
inner-join (hash)
 ├── columns: u:1(int!null) v:2(int) w:3(int!null) x:6(int!null) y:7(int) z:8(int)
 ├── stats: [rows=10.3537072, distinct(1)=1, null(1)=0, distinct(6)=1, null(6)=0]
 ├── fd: ()-->(1,3,6), (1)==(6), (6)==(1)
 ├── select
 │    ├── columns: u:1(int) v:2(int) w:3(int!null)
 │    ├── stats: [rows=10, distinct(1)=9.5617925, null(1)=0.1, distinct(3)=1, null(3)=0]
 │    ├── fd: ()-->(3)
 │    ├── scan uvw
 │    │    ├── columns: u:1(int) v:2(int) w:3(int)
 │    │    └── stats: [rows=1000, distinct(1)=100, null(1)=10, distinct(3)=100, null(3)=10]
 │    └── filters
 │         └── w:3 = 1 [type=bool, outer=(3), constraints=(/3: [/1 - /1]; tight), fd=()-->(3)]
 ├── scan xyz
 │    ├── columns: x:6(int) y:7(int) z:8(int)
 │    └── stats: [rows=1000, distinct(6)=100, null(6)=10]
 └── filters
      ├── u:1 = x:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      └── x:6 = 10 [type=bool, outer=(6), constraints=(/6: [/10 - /10]; tight), fd=()-->(6)]

# Bump up null counts.
exec-ddl
ALTER TABLE xysd INJECT STATISTICS '[
  {
    "columns": ["x"],
    "created_at": "2018-01-01 2:00:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 5000
  },
  {
    "columns": ["y"],
    "created_at": "2018-01-01 2:00:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 400,
    "null_count": 2500
  }
]'
----

exec-ddl
ALTER TABLE uv INJECT STATISTICS '[
  {
    "columns": ["u"],
    "created_at": "2018-01-01 2:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 500,
    "null_count": 5000
  },
  {
    "columns": ["v"],
    "created_at": "2018-01-01 2:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 100
  },
  {
    "columns": ["rowid"],
    "created_at": "2018-01-01 2:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  }
]'
----

build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd INNER JOIN uv ON x=u
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int!null) v:7(int!null) rowid:8(int!null)
 ├── stats: [rows=5000, distinct(2)=399.99851, null(2)=2500, distinct(3)=499.977311, null(3)=50, distinct(6)=499, null(6)=0, distinct(2,3)=3160.69477, null(2,3)=25, distinct(3,6)=5000, null(3,6)=0, distinct(1,2,8)=5000, null(1,2,8)=0]
 ├── key: (8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2,6), (8)-->(1-4,6,7), (1)==(6), (6)==(1)
 └── inner-join (hash)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int!null) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(zero-or-more), right-rows(zero-or-one)
      ├── stats: [rows=5000, distinct(1)=499, null(1)=0, distinct(2)=399.99851, null(2)=2500, distinct(3)=499.977311, null(3)=50, distinct(6)=499, null(6)=0, distinct(2,3)=3160.69477, null(2,3)=25, distinct(3,6)=5000, null(3,6)=0, distinct(1,2,8)=5000, null(1,2,8)=0]
      ├── key: (8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9), (1)==(6), (6)==(1)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(4)=500, null(4)=0, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd LEFT JOIN uv ON x=u
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=500, null(3)=100, distinct(6)=500, null(6)=0, distinct(2,3)=5000, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── left-join (hash)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(one-or-more), right-rows(zero-or-one)
      ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=500, null(3)=100, distinct(6)=500, null(6)=0, distinct(2,3)=5000, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(4)=500, null(4)=0, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd RIGHT JOIN uv ON x=u
----
project
 ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) u:6(int) v:7(int!null) rowid:8(int!null)
 ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=499.999999, null(3)=100, distinct(6)=500, null(6)=5000, distinct(2,3)=4323.45892, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
 ├── key: (8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(1-4,6,7)
 └── right-join (hash)
      ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=10000, distinct(1)=500, null(1)=0, distinct(2)=400, null(2)=5000, distinct(3)=499.999999, null(3)=100, distinct(6)=500, null(6)=5000, distinct(2,3)=4323.45892, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
      ├── key: (8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(1-7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd FULL JOIN uv ON x=u
----
project
 ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=500, null(3)=100, distinct(6)=500, null(6)=5000, distinct(2,3)=5000, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── full-join (hash)
      ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── multiplicity: left-rows(one-or-more), right-rows(exactly-one)
      ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=500, null(3)=100, distinct(6)=500, null(6)=5000, distinct(2,3)=5000, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

# Set one of the columns to non-nullable and see impact on multi-column null counts.
build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd FULL JOIN uv ON x=u WHERE s IS NOT NULL
----
project
 ├── columns: x:1(int) y:2(int) s:3(string!null) d:4(decimal) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=9900, distinct(2)=400, null(2)=4950, distinct(3)=500, null(3)=0, distinct(6)=500, null(6)=4950, distinct(2,3)=4999.5, null(2,3)=0, distinct(3,6)=9900, null(3,6)=0, distinct(1,2,8)=9900, null(1,2,8)=0]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── select
      ├── columns: x:1(int) y:2(int) s:3(string!null) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=9900, distinct(2)=400, null(2)=4950, distinct(3)=500, null(3)=0, distinct(6)=500, null(6)=4950, distinct(2,3)=4999.5, null(2,3)=0, distinct(3,6)=9900, null(3,6)=0, distinct(1,2,8)=9900, null(1,2,8)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── full-join (hash)
      │    ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── multiplicity: left-rows(one-or-more), right-rows(exactly-one)
      │    ├── stats: [rows=10000, distinct(2)=400, null(2)=5000, distinct(3)=500, null(3)=100, distinct(6)=500, null(6)=5000, distinct(2,3)=5000, null(2,3)=50, distinct(3,6)=10000, null(3,6)=50, distinct(1,2,8)=10000, null(1,2,8)=0]
      │    ├── key: (1,8)
      │    ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      │    ├── scan xysd
      │    │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    │    ├── key: (1)
      │    │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      │    ├── scan uv
      │    │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(8)=10000, null(8)=0]
      │    │    ├── key: (8)
      │    │    └── fd: (8)-->(6,7,9)
      │    └── filters
      │         └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]
      └── filters
           └── s:3 IS NOT NULL [type=bool, outer=(3), constraints=(/3: (/NULL - ]; tight)]

# Do a full join on a condition that results in 0 rows on one side. All null counts
# on the right side should be greater due to expected null-extension of columns.
build colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
SELECT *, rowid FROM xysd FULL JOIN uv ON u > 4 AND u < 2
----
project
 ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) u:6(int) v:7(int) rowid:8(int)
 ├── stats: [rows=50000000, distinct(2)=400, null(2)=25000000, distinct(3)=500, null(3)=500000, distinct(6)=500, null(6)=25000000, distinct(2,3)=5000, null(2,3)=250000, distinct(3,6)=250000, null(3,6)=250000, distinct(1,2,8)=50000000, null(1,2,8)=0]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 └── full-join (cross)
      ├── columns: x:1(int) y:2(int) s:3(string) d:4(decimal) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int) rowid:8(int) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=50000000, distinct(2)=400, null(2)=25000000, distinct(3)=500, null(3)=500000, distinct(6)=500, null(6)=25000000, distinct(2,3)=5000, null(2,3)=250000, distinct(3,6)=250000, null(3,6)=250000, distinct(1,2,8)=50000000, null(1,2,8)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters
           └── (u:6 > 4) AND (u:6 < 2) [type=bool, outer=(6), constraints=(contradiction; tight)]

build colstat=2 colstat=(1,2,8)
SELECT * FROM xysd, uv
----
project
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int!null)
 ├── stats: [rows=50000000, distinct(2)=400, null(2)=25000000, distinct(1,2,8)=50000000, null(1,2,8)=0]
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 └── inner-join (cross)
      ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal) u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      ├── stats: [rows=50000000, distinct(2)=400, null(2)=25000000, distinct(1,2,8)=50000000, null(1,2,8)=0]
      ├── key: (1,8)
      ├── fd: (1)-->(2-5), (3,4)~~>(1,2,5), (8)-->(6,7,9)
      ├── scan xysd
      │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) xysd.crdb_internal_mvcc_timestamp:5(decimal)
      │    ├── stats: [rows=5000, distinct(2)=400, null(2)=2500, distinct(1,2)=5000, null(1,2)=0]
      │    ├── key: (1)
      │    └── fd: (1)-->(2-5), (3,4)~~>(1,2,5)
      ├── scan uv
      │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null) uv.crdb_internal_mvcc_timestamp:9(decimal)
      │    ├── stats: [rows=10000, distinct(8)=10000, null(8)=0]
      │    ├── key: (8)
      │    └── fd: (8)-->(6,7,9)
      └── filters (true)

norm
SELECT * FROM xysd WHERE EXISTS(SELECT * FROM uv WHERE x=u)
----
semi-join (hash)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 ├── stats: [rows=500, distinct(1)=500, null(1)=0]
 ├── key: (1)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 ├── scan uv
 │    ├── columns: u:6(int)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=5000]
 └── filters
      └── x:1 = u:6 [type=bool, outer=(1,6), constraints=(/1: (/NULL - ]; /6: (/NULL - ]), fd=(1)==(6), (6)==(1)]

norm
SELECT * FROM uv WHERE EXISTS(SELECT * FROM xysd WHERE x=u)
----
semi-join (hash)
 ├── columns: u:1(int) v:2(int!null)
 ├── stats: [rows=10000, distinct(1)=500, null(1)=0]
 ├── scan uv
 │    ├── columns: u:1(int) v:2(int!null)
 │    └── stats: [rows=10000, distinct(1)=500, null(1)=5000, distinct(2)=100, null(2)=0]
 ├── scan xysd
 │    ├── columns: x:5(int!null)
 │    ├── stats: [rows=5000, distinct(5)=5000, null(5)=0]
 │    └── key: (5)
 └── filters
      └── x:5 = u:1 [type=bool, outer=(1,5), constraints=(/1: (/NULL - ]; /5: (/NULL - ]), fd=(1)==(5), (5)==(1)]

# Merge join (inner).
expr colstat=2 colstat=(1,2,7) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
(MergeJoin
    (Scan [ (Table "xysd") (Cols "x,y,s,d") ])
    (Sort (Scan [ (Table "uv") (Cols "u,v,rowid") ]))
    [ ]
    [
        (JoinType "inner-join")
        (LeftEq "+x")
        (RightEq "+u")
        (LeftOrdering "+x")
        (RightOrdering "+u")
    ]
)
----
inner-join (merge)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int!null) v:7(int!null) rowid:8(int!null)
 ├── left ordering: +1
 ├── right ordering: +6
 ├── stats: [rows=5000, distinct(1)=499, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(6)=499, null(6)=0, distinct(2,3)=5000, null(2,3)=25, distinct(3,6)=5000, null(3,6)=0, distinct(1,2,7)=5000, null(1,2,7)=0]
 ├── key: (8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7), (1)==(6), (6)==(1)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(4)=500, null(4)=0, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
 │    ├── key: (1)
 │    ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 │    └── ordering: +1
 ├── sort
 │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null)
 │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
 │    ├── key: (8)
 │    ├── fd: (8)-->(6,7)
 │    ├── ordering: +6
 │    └── scan uv
 │         ├── columns: u:6(int) v:7(int!null) rowid:8(int!null)
 │         ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
 │         ├── key: (8)
 │         └── fd: (8)-->(6,7)
 └── filters (true)

# Merge join (left) with extra ON condition.
expr colstat=2 colstat=(1,2,8) colstat=(2,3) colstat=3 colstat=(3,6) colstat=6
(MergeJoin
    (Scan [ (Table "xysd") (Cols "x,y,s,d") ])
    (Sort (Scan [ (Table "uv") (Cols "u,v,rowid") ]))
    [ (Gt (Var "y") (Var "v")) ]
    [
        (JoinType "left-join")
        (LeftEq "+x")
        (RightEq "+u")
        (LeftOrdering "+x")
        (RightOrdering "+u")
    ]
)
----
left-join (merge)
 ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null) u:6(int) v:7(int) rowid:8(int)
 ├── left ordering: +1
 ├── right ordering: +6
 ├── stats: [rows=5000, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(6)=500, null(6)=1666.66667, distinct(7)=100, null(7)=1666.66667, distinct(2,3)=5000, null(2,3)=25, distinct(3,6)=5000, null(3,6)=25, distinct(1,2,8)=5000, null(1,2,8)=0]
 ├── key: (1,8)
 ├── fd: (1)-->(2-4), (3,4)~~>(1,2), (8)-->(6,7)
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(2)=400, null(2)=2500, distinct(3)=500, null(3)=50, distinct(4)=500, null(4)=0, distinct(1,2)=5000, null(1,2)=0, distinct(2,3)=5000, null(2,3)=25]
 │    ├── key: (1)
 │    ├── fd: (1)-->(2-4), (3,4)~~>(1,2)
 │    └── ordering: +1
 ├── sort
 │    ├── columns: u:6(int) v:7(int!null) rowid:8(int!null)
 │    ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
 │    ├── key: (8)
 │    ├── fd: (8)-->(6,7)
 │    ├── ordering: +6
 │    └── scan uv
 │         ├── columns: u:6(int) v:7(int!null) rowid:8(int!null)
 │         ├── stats: [rows=10000, distinct(6)=500, null(6)=5000, distinct(7)=100, null(7)=0, distinct(8)=10000, null(8)=0]
 │         ├── key: (8)
 │         └── fd: (8)-->(6,7)
 └── filters
      └── y:2 > v:7 [type=bool, outer=(2,7), constraints=(/2: (/NULL - ]; /7: (/NULL - ])]

# Check that true filters are handled correctly for all join types.
norm
SELECT * FROM (SELECT 1) JOIN (SELECT 1 WHERE false) ON true
----
values
 ├── columns: "?column?":1(int!null) "?column?":2(int!null)
 ├── cardinality: [0 - 0]
 ├── stats: [rows=0]
 ├── key: ()
 └── fd: ()-->(1,2)

norm
SELECT * FROM (SELECT 1) LEFT JOIN (SELECT 1 WHERE false) ON true
----
left-join (cross)
 ├── columns: "?column?":1(int!null) "?column?":2(int)
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: "?column?":1(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(1)
 │    └── (1,) [type=tuple{int}]
 ├── values
 │    ├── columns: "?column?":2(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0]
 │    ├── key: ()
 │    └── fd: ()-->(2)
 └── filters (true)

norm
SELECT * FROM (SELECT 1) RIGHT JOIN (SELECT 1 WHERE false) ON true
----
values
 ├── columns: "?column?":1(int!null) "?column?":2(int!null)
 ├── cardinality: [0 - 0]
 ├── stats: [rows=0]
 ├── key: ()
 └── fd: ()-->(1,2)

norm
SELECT * FROM (SELECT 1) FULL JOIN (SELECT 1 WHERE false) ON true
----
left-join (cross)
 ├── columns: "?column?":1(int!null) "?column?":2(int)
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: "?column?":1(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(1)
 │    └── (1,) [type=tuple{int}]
 ├── values
 │    ├── columns: "?column?":2(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0]
 │    ├── key: ()
 │    └── fd: ()-->(2)
 └── filters (true)

norm
SELECT * FROM (SELECT 1 WHERE false) JOIN (SELECT 1) ON true
----
values
 ├── columns: "?column?":1(int!null) "?column?":2(int!null)
 ├── cardinality: [0 - 0]
 ├── stats: [rows=0]
 ├── key: ()
 └── fd: ()-->(1,2)

norm
SELECT * FROM (SELECT 1 WHERE false) LEFT JOIN (SELECT 1) ON true
----
values
 ├── columns: "?column?":1(int!null) "?column?":2(int!null)
 ├── cardinality: [0 - 0]
 ├── stats: [rows=0]
 ├── key: ()
 └── fd: ()-->(1,2)

norm
SELECT * FROM (SELECT 1 WHERE false) RIGHT JOIN (SELECT 1) ON true
----
left-join (cross)
 ├── columns: "?column?":1(int) "?column?":2(int!null)
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: "?column?":2(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(2)
 │    └── (1,) [type=tuple{int}]
 ├── values
 │    ├── columns: "?column?":1(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0]
 │    ├── key: ()
 │    └── fd: ()-->(1)
 └── filters (true)

norm
SELECT * FROM (SELECT 1 WHERE false) FULL JOIN (SELECT 1) ON true
----
left-join (cross)
 ├── columns: "?column?":1(int) "?column?":2(int!null)
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: "?column?":2(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(2)
 │    └── (1,) [type=tuple{int}]
 ├── values
 │    ├── columns: "?column?":1(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0]
 │    ├── key: ()
 │    └── fd: ()-->(1)
 └── filters (true)

norm
SELECT * FROM (SELECT 1 UNION SELECT 2) FULL JOIN (VALUES (1), (2)) ON true
----
inner-join (cross)
 ├── columns: "?column?":3(int!null) column1:4(int!null)
 ├── cardinality: [2 - 4]
 ├── multiplicity: left-rows(one-or-more), right-rows(one-or-more)
 ├── stats: [rows=4]
 ├── values
 │    ├── columns: column1:4(int!null)
 │    ├── cardinality: [2 - 2]
 │    ├── stats: [rows=2]
 │    ├── (1,) [type=tuple{int}]
 │    └── (2,) [type=tuple{int}]
 ├── union
 │    ├── columns: "?column?":3(int!null)
 │    ├── left columns: "?column?":1(int)
 │    ├── right columns: "?column?":2(int)
 │    ├── cardinality: [1 - 2]
 │    ├── stats: [rows=2, distinct(3)=2, null(3)=0]
 │    ├── key: (3)
 │    ├── values
 │    │    ├── columns: "?column?":1(int!null)
 │    │    ├── cardinality: [1 - 1]
 │    │    ├── stats: [rows=1, distinct(1)=1, null(1)=0]
 │    │    ├── key: ()
 │    │    ├── fd: ()-->(1)
 │    │    └── (1,) [type=tuple{int}]
 │    └── values
 │         ├── columns: "?column?":2(int!null)
 │         ├── cardinality: [1 - 1]
 │         ├── stats: [rows=1, distinct(2)=1, null(2)=0]
 │         ├── key: ()
 │         ├── fd: ()-->(2)
 │         └── (2,) [type=tuple{int}]
 └── filters (true)

exec-ddl
CREATE TABLE table0 (
    col0 INT4,
    col1 BOOL NULL,
    col2 BIT(40) NOT NULL
)
----

exec-ddl
CREATE TABLE table1 (
    col0 BIT(23) NULL,
    col1 INET NULL
)
----

# Regression test for #38091.
norm disable=EliminateJoinUnderProjectLeft
SELECT (
        SELECT 1
          FROM table1
               LEFT JOIN table1 AS t1
                INNER JOIN table0 ON false ON t0.col1
       )
  FROM table0 AS t0
----
project
 ├── columns: "?column?":20(int)
 ├── stats: [rows=1000000]
 ├── ensure-distinct-on
 │    ├── columns: t0.rowid:4(int!null) "?column?":19(int)
 │    ├── grouping columns: t0.rowid:4(int!null)
 │    ├── error: "more than one row returned by a subquery used as an expression"
 │    ├── stats: [rows=1000000]
 │    ├── key: (4)
 │    ├── fd: (4)-->(19)
 │    ├── left-join-apply
 │    │    ├── columns: t0.col1:2(bool) t0.rowid:4(int!null) "?column?":19(int)
 │    │    ├── stats: [rows=1000000]
 │    │    ├── fd: (4)-->(2)
 │    │    ├── scan table0 [as=t0]
 │    │    │    ├── columns: t0.col1:2(bool) t0.rowid:4(int!null)
 │    │    │    ├── stats: [rows=1000]
 │    │    │    ├── key: (4)
 │    │    │    └── fd: (4)-->(2)
 │    │    ├── project
 │    │    │    ├── columns: "?column?":19(int!null)
 │    │    │    ├── outer: (2)
 │    │    │    ├── stats: [rows=1000]
 │    │    │    ├── fd: ()-->(19)
 │    │    │    ├── left-join (cross)
 │    │    │    │    ├── outer: (2)
 │    │    │    │    ├── multiplicity: left-rows(exactly-one), right-rows(zero-or-more)
 │    │    │    │    ├── stats: [rows=1000, distinct(2)=1, null(2)=0]
 │    │    │    │    ├── scan table1
 │    │    │    │    │    └── stats: [rows=1000]
 │    │    │    │    ├── values
 │    │    │    │    │    ├── cardinality: [0 - 0]
 │    │    │    │    │    ├── stats: [rows=0]
 │    │    │    │    │    └── key: ()
 │    │    │    │    └── filters
 │    │    │    │         └── t0.col1:2 [type=bool, outer=(2), constraints=(/2: [/true - /true]; tight), fd=()-->(2)]
 │    │    │    └── projections
 │    │    │         └── 1 [as="?column?":19, type=int]
 │    │    └── filters (true)
 │    └── aggregations
 │         └── const-agg [as="?column?":19, type=int, outer=(19)]
 │              └── "?column?":19 [type=int]
 └── projections
      └── "?column?":19 [as="?column?":20, type=int, outer=(19)]

norm colstat=1 colstat=2
SELECT * FROM (SELECT 1) AS a(x) LEFT JOIN (SELECT 2) AS b(x) ON a.x = b.x
----
left-join (cross)
 ├── columns: x:1(int!null) x:2(int)
 ├── cardinality: [1 - 1]
 ├── multiplicity: left-rows(exactly-one), right-rows(exactly-one)
 ├── stats: [rows=1, distinct(1)=1, null(1)=0, distinct(2)=1, null(2)=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: "?column?":1(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1, distinct(1)=1, null(1)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(1)
 │    └── (1,) [type=tuple{int}]
 ├── values
 │    ├── columns: "?column?":2(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0, distinct(2)=0, null(2)=0]
 │    ├── key: ()
 │    └── fd: ()-->(2)
 └── filters (true)

exec-ddl
CREATE TABLE abc (a INT, b INT, c INT, PRIMARY KEY (a, b));
----

exec-ddl
CREATE TABLE def (d INT, e INT, f INT, PRIMARY KEY (d, e));
----

exec-ddl
ALTER TABLE abc INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 100,
    "distinct_count": 100
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 100,
    "distinct_count": 10
  }
]'
----

exec-ddl
ALTER TABLE def INJECT STATISTICS '[
  {
    "columns": ["d"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  },
  {
    "columns": ["e"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  }
]'
----

# TODO(rytaft): The cardinality estimates here are unrealistically low.
# Maybe revisit this? I doubt there's anything we can do there though.
expr format=show-all colstat=6 colstat=7 colstat=(6, 7) colstat=1 colstat=2 colstat=3 colstat=(1, 2, 3)
(MakeLookupJoin
  (Scan [ (Table "abc") (Cols "a,b,c") ])
  [ (JoinType "inner-join") (Table "def") (Index "def@primary") (KeyCols "a,b") (Cols "a,b,c,d,f,e") ]
  [ ]
)
----
inner-join (lookup t.public.def)
 ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int) t.public.def.d:5(int!null) t.public.def.e:6(int!null) t.public.def.f:7(int)
 ├── key columns: [1 2] = [5 6]
 ├── stats: [rows=0.01, distinct(1)=0.01, null(1)=0, distinct(2)=0.01, null(2)=0, distinct(3)=0.00999500175, null(3)=0.0001, distinct(5)=0.01, null(5)=0, distinct(6)=0.01, null(6)=0, distinct(7)=0.00999995009, null(7)=0.0001, distinct(6,7)=0.00999999509, null(6,7)=0, distinct(1-3)=0.0099995001, null(1-3)=0]
 ├── cost: 2120.6407
 ├── key: (5,6)
 ├── fd: (1,2)-->(3), (5,6)-->(7), (1)==(5), (5)==(1), (2)==(6), (6)==(2)
 ├── interesting orderings: (+1,+2)
 ├── scan t.public.abc
 │    ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 │    ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(1-3)=100, null(1-3)=0]
 │    ├── cost: 120.61
 │    ├── key: (1,2)
 │    ├── fd: (1,2)-->(3)
 │    ├── prune: (1-3)
 │    └── interesting orderings: (+1,+2)
 └── filters (true)

# TODO(rytaft): The cardinality estimates for the semi-join are the same as the table.
# The semi-join currently ignores the selectivities of the filters in the On condition.
# We should fix this.
expr format=show-all colstat=6 colstat=7 colstat=(6, 7) colstat=1 colstat=2 colstat=3 colstat=(1, 2, 3)
(MakeLookupJoin
  (Scan [ (Table "abc") (Cols "a,b,c") ])
  [ (JoinType "semi-join") (Table "def") (Index "def@primary") (KeyCols "a,b") (Cols "a,b,c,d,e") ]
  [ ]
)
----
semi-join (lookup t.public.def)
 ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 ├── key columns: [1 2] = [5 6]
 ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(6)=1, null(6)=0, distinct(7)=1, null(7)=0, distinct(6,7)=1, null(6,7)=0, distinct(1-3)=100, null(1-3)=0]
 ├── cost: 2120.6406
 ├── key: (1,2)
 ├── fd: (1,2)-->(3)
 ├── interesting orderings: (+1,+2)
 ├── scan t.public.abc
 │    ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 │    ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(1-3)=100, null(1-3)=0]
 │    ├── cost: 120.61
 │    ├── key: (1,2)
 │    ├── fd: (1,2)-->(3)
 │    ├── prune: (1-3)
 │    └── interesting orderings: (+1,+2)
 └── filters (true)

expr format=show-all colstat=6 colstat=7 colstat=(6, 7) colstat=1 colstat=2 colstat=3 colstat=(1, 2, 3)
(MakeLookupJoin
  (Scan [ (Table "abc") (Cols "a,b,c") ])
  [ (JoinType "anti-join") (Table "def") (Index "def@primary") (KeyCols "a,b") (Cols "a,b,c,d,e") ]
  [ ]
)
----
anti-join (lookup t.public.def)
 ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 ├── key columns: [1 2] = [5 6]
 ├── stats: [rows=1e-10, distinct(1)=1e-10, null(1)=0, distinct(2)=1e-10, null(2)=0, distinct(3)=1e-10, null(3)=1e-10, distinct(6)=1e-10, null(6)=0, distinct(7)=1e-10, null(7)=0, distinct(6,7)=1e-10, null(6,7)=0, distinct(1-3)=1e-10, null(1-3)=0]
 ├── cost: 2120.6406
 ├── key: (1,2)
 ├── fd: (1,2)-->(3)
 ├── interesting orderings: (+1,+2)
 ├── scan t.public.abc
 │    ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 │    ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(1-3)=100, null(1-3)=0]
 │    ├── cost: 120.61
 │    ├── key: (1,2)
 │    ├── fd: (1,2)-->(3)
 │    ├── prune: (1-3)
 │    └── interesting orderings: (+1,+2)
 └── filters (true)

expr format=show-all colstat=6 colstat=7 colstat=(6, 7) colstat=1 colstat=2 colstat=3 colstat=(1, 2, 3)
(MakeLookupJoin
  (Scan [ (Table "abc") (Cols "a,b,c") ])
  [ (JoinType "semi-join") (Table "def") (Index "def@primary") (KeyCols "a,b") (Cols "a,b,c,d,e") ]
  [ (False) ]
)
----
semi-join (lookup t.public.def)
 ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 ├── key columns: [1 2] = [5 6]
 ├── stats: [rows=0, distinct(1)=0, null(1)=0, distinct(2)=0, null(2)=0, distinct(3)=0, null(3)=0, distinct(6)=0, null(6)=0, distinct(7)=0, null(7)=0, distinct(6,7)=0, null(6,7)=0, distinct(1-3)=0, null(1-3)=0]
 ├── cost: 2120.6506
 ├── key: (1,2)
 ├── fd: (1,2)-->(3)
 ├── interesting orderings: (+1,+2)
 ├── scan t.public.abc
 │    ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 │    ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(1-3)=100, null(1-3)=0]
 │    ├── cost: 120.61
 │    ├── key: (1,2)
 │    ├── fd: (1,2)-->(3)
 │    ├── prune: (1-3)
 │    └── interesting orderings: (+1,+2)
 └── filters
      └── false [type=bool, constraints=(contradiction; tight)]

expr format=show-all colstat=6 colstat=7 colstat=(6, 7) colstat=1 colstat=2 colstat=3 colstat=(1, 2, 3)
(MakeLookupJoin
  (Scan [ (Table "abc") (Cols "a,b,c") ])
  [ (JoinType "anti-join") (Table "def") (Index "def@primary") (KeyCols "a,b") (Cols "a,b,c,d,e") ]
  [ (False) ]
)
----
anti-join (lookup t.public.def)
 ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 ├── key columns: [1 2] = [5 6]
 ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(6)=1, null(6)=0, distinct(7)=1, null(7)=0, distinct(6,7)=1, null(6,7)=0, distinct(1-3)=100, null(1-3)=0]
 ├── cost: 2120.6506
 ├── key: (1,2)
 ├── fd: (1,2)-->(3)
 ├── interesting orderings: (+1,+2)
 ├── scan t.public.abc
 │    ├── columns: t.public.abc.a:1(int!null) t.public.abc.b:2(int!null) t.public.abc.c:3(int)
 │    ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=10, null(2)=0, distinct(3)=10, null(3)=1, distinct(1-3)=100, null(1-3)=0]
 │    ├── cost: 120.61
 │    ├── key: (1,2)
 │    ├── fd: (1,2)-->(3)
 │    ├── prune: (1-3)
 │    └── interesting orderings: (+1,+2)
 └── filters
      └── false [type=bool, constraints=(contradiction; tight)]

# Regression test for #40460.
opt disable=SimplifyJoinFilters
SELECT
    *
FROM
    abc
    FULL JOIN (SELECT * FROM abc WHERE false) ON
            false
            IS NOT DISTINCT FROM not_like_escape(
                    '',
                    NULL::STRING,
                    (SELECT NULL)::STRING
                );
----
full-join (cross)
 ├── columns: a:1(int) b:2(int) c:3(int) a:5(int) b:6(int) c:7(int)
 ├── multiplicity: left-rows(exactly-one), right-rows(one-or-more)
 ├── stats: [rows=100]
 ├── key: (1,2)
 ├── fd: (1,2)-->(3,5-7)
 ├── scan abc
 │    ├── columns: a:1(int!null) b:2(int!null) c:3(int)
 │    ├── stats: [rows=100]
 │    ├── key: (1,2)
 │    └── fd: (1,2)-->(3)
 ├── values
 │    ├── columns: a:5(int!null) b:6(int!null) c:7(int!null)
 │    ├── cardinality: [0 - 0]
 │    ├── stats: [rows=0]
 │    ├── key: ()
 │    └── fd: ()-->(5-7)
 └── filters
      └── false [type=bool, constraints=(contradiction; tight)]

expr
(SemiJoin
    (Values
      [ (Tuple [ (Const 1 "int") (Const 2 "int") ] "tuple{int}" ) ]
      [ (Cols [ (NewColumn "a" "int") (NewColumn "b" "int") ]) ]
    )
    (Scan [ (Table "uv") (Cols "u,v,rowid") ])
    []
    []
)
----
semi-join (cross)
 ├── columns: a:1(int!null) b:2(int!null)
 ├── cardinality: [0 - 1]
 ├── stats: [rows=1]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: a:1(int!null) b:2(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(1,2)
 │    └── (1, 2) [type=tuple{int}]
 ├── scan uv
 │    ├── columns: u:3(int) v:4(int!null) rowid:5(int!null)
 │    ├── stats: [rows=10000]
 │    ├── key: (5)
 │    └── fd: (5)-->(3,4)
 └── filters (true)

expr
(AntiJoin
    (Values
      [ (Tuple [ (Const 1 "int") (Const 2 "int") ] "tuple{int}" ) ]
      [ (Cols [ (NewColumn "a" "int") (NewColumn "b" "int") ]) ]
    )
    (Scan [ (Table "uv") (Cols "u,v,rowid") ])
    []
    []
)
----
anti-join (cross)
 ├── columns: a:1(int!null) b:2(int!null)
 ├── cardinality: [0 - 1]
 ├── stats: [rows=1e-10]
 ├── key: ()
 ├── fd: ()-->(1,2)
 ├── values
 │    ├── columns: a:1(int!null) b:2(int!null)
 │    ├── cardinality: [1 - 1]
 │    ├── stats: [rows=1]
 │    ├── key: ()
 │    ├── fd: ()-->(1,2)
 │    └── (1, 2) [type=tuple{int}]
 ├── scan uv
 │    ├── columns: u:3(int) v:4(int!null) rowid:5(int!null)
 │    ├── stats: [rows=10000]
 │    ├── key: (5)
 │    └── fd: (5)-->(3,4)
 └── filters (true)

exec-ddl
ALTER TABLE xysd INJECT STATISTICS '[
  {
    "columns": ["x"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 5000
  },
  {
    "columns": ["y"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 400
  },
  {
    "columns": ["s"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 5000,
    "distinct_count": 10
  }
]'
----

exec-ddl
ALTER TABLE uv INJECT STATISTICS '[
  {
    "columns": ["u"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 500
  },
  {
    "columns": ["v"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 100
  },
  {
    "columns": ["u","v"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 550
  },
  {
    "columns": ["rowid"],
    "created_at": "2018-01-01 1:30:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  }
]'
----

# We use multi-column stats split across the join to estimate the selectivity
# here.
opt
SELECT * FROM xysd, uv WHERE (s = 'foo' AND u = 3 AND v = 4) OR (s = 'bar' AND u = 5 AND v = 6)
----
inner-join (cross)
 ├── columns: x:1(int!null) y:2(int) s:3(string!null) d:4(decimal!null) u:6(int!null) v:7(int!null)
 ├── stats: [rows=11979.6897, distinct(3)=2, null(3)=0, distinct(6)=2, null(6)=0, distinct(7)=2, null(7)=0, distinct(6,7)=2.19138756, null(6,7)=0]
 ├── fd: (1)-->(2-4), (3,4)-->(1,2)
 ├── scan uv
 │    ├── columns: u:6(int) v:7(int!null)
 │    └── stats: [rows=10000, distinct(6)=500, null(6)=0, distinct(7)=100, null(7)=0, distinct(6,7)=550, null(6,7)=0]
 ├── scan xysd
 │    ├── columns: x:1(int!null) y:2(int) s:3(string) d:4(decimal!null)
 │    ├── stats: [rows=5000, distinct(1)=5000, null(1)=0, distinct(3)=10, null(3)=0, distinct(4)=500, null(4)=0]
 │    ├── key: (1)
 │    └── fd: (1)-->(2-4), (3,4)~~>(1,2)
 └── filters
      └── (((s:3 = 'foo') AND (u:6 = 3)) AND (v:7 = 4)) OR (((s:3 = 'bar') AND (u:6 = 5)) AND (v:7 = 6)) [type=bool, outer=(3,6,7), constraints=(/3: [/'bar' - /'bar'] [/'foo' - /'foo']; /6: [/3 - /3] [/5 - /5]; /7: [/4 - /4] [/6 - /6])]
