import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q14
# Promotion Effect
# Monitors the market response to a promotion such as TV advertisements or a
# special campaign.
#
# Determines what percentage of the revenue in a given year and month was
# derived from promotional parts. The query considers only parts actually
# shipped in that month and gives the percentage. Revenue is defined as
# (l_extendedprice * (1-l_discount)).
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q14
SELECT
    100.00 * sum(CASE
        WHEN p_type LIKE 'PROMO%'
            THEN l_extendedprice * (1 - l_discount)
        ELSE 0
    END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue
FROM
    lineitem,
    part
WHERE
    l_partkey = p_partkey
    AND l_shipdate >= DATE '1995-09-01'
    AND l_shipdate < DATE '1995-09-01' + INTERVAL '1' MONTH;
----
----
project
 ├── save-table-name: q14_project_1
 ├── columns: promo_revenue:34(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(34)=1, null(34)=0]
 ├── key: ()
 ├── fd: ()-->(34)
 ├── scalar-group-by
 │    ├── save-table-name: q14_scalar_group_by_2
 │    ├── columns: sum:31(float) sum:33(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(31)=1, null(31)=0, distinct(33)=1, null(33)=0, distinct(31,33)=1, null(31,33)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(31,33)
 │    ├── project
 │    │    ├── save-table-name: q14_project_3
 │    │    ├── columns: column30:30(float!null) column32:32(float!null)
 │    │    ├── immutable
 │    │    ├── stats: [rows=74410.822, distinct(30)=74410.822, null(30)=0, distinct(32)=46961.8624, null(32)=0]
 │    │    ├── inner-join (hash)
 │    │    │    ├── save-table-name: q14_inner_join_4
 │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null) p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
 │    │    │    ├── stats: [rows=74410.822, distinct(2)=62218.5876, null(2)=0, distinct(6)=46328.879, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(19)=62218.5876, null(19)=0, distinct(23)=150, null(23)=0, distinct(6,7)=46961.8624, null(6,7)=0, distinct(6,7,23)=74410.822, null(6,7,23)=0]
 │    │    │    ├── fd: (19)-->(23), (2)==(19), (19)==(2)
 │    │    │    ├── scan part
 │    │    │    │    ├── save-table-name: q14_scan_5
 │    │    │    │    ├── columns: p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(23)=150, null(23)=0]
 │    │    │    │    │   histogram(19)=  0  4   995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4
 │    │    │    │    │                 <--- 51 ----- 1335 ----- 2367 ----- 3558 ----- 4278 ----- 5314 ----- 6325 ----- 7176 ----- 7962 ----- 8784 ----- 9892 ----- 10810 ----- 11716 ----- 13130 ----- 14005 ----- 15148 ----- 16150 ----- 17087 ----- 18257 ----- 19342 ----- 20527 ----- 21590 ----- 22542 ----- 23384 ----- 24421 ----- 25315 ----- 26134 ----- 27000 ----- 28133 ----- 29410 ----- 30496 ----- 31588 ----- 32466 ----- 33679 ----- 34601 ----- 35492 ----- 36519 ----- 37442 ----- 38366 ----- 39443 ----- 40397 ----- 41264 ----- 42229 ----- 43451 ----- 44398 ----- 45392 ----- 46638 ----- 47995 ----- 48801 ----- 49889 ----- 50947 ----- 52085 ----- 53305 ----- 54604 ----- 55814 ----- 56756 ----- 58001 ----- 58959 ----- 59885 ----- 60693 ----- 61995 ----- 62937 ----- 63659 ----- 64554 ----- 65585 ----- 66520 ----- 67565 ----- 68432 ----- 69390 ----- 70467 ----- 71369 ----- 72478 ----- 73538 ----- 74665 ----- 75622 ----- 76704 ----- 77646 ----- 78630 ----- 79292 ----- 80356 ----- 81132 ----- 82072 ----- 83154 ----- 84167 ----- 85308 ----- 86150 ----- 87083 ----- 87986 ----- 88892 ----- 89757 ----- 90788 ----- 91954 ----- 93074 ----- 93996 ----- 95002 ----- 96042 ----- 97023 ----- 97824 ----- 98940 ----- 99965 ----- 101025 ----- 101781 ----- 102883 ----- 103902 ----- 105012 ----- 106090 ----- 107104 ----- 108064 ----- 109159 ----- 110038 ----- 110978 ----- 111895 ----- 112941 ----- 114007 ----- 114921 ----- 116235 ----- 117042 ----- 117939 ----- 118788 ----- 119802 ----- 120824 ----- 121804 ----- 123111 ----- 124376 ----- 125340 ----- 126355 ----- 127574 ----- 128587 ----- 129598 ----- 130612 ----- 131514 ----- 132614 ----- 133829 ----- 134751 ----- 135902 ----- 136794 ----- 137598 ----- 138467 ----- 139297 ----- 140102 ----- 141045 ----- 142268 ----- 143377 ----- 144156 ----- 144880 ----- 145801 ----- 146819 ----- 148041 ----- 149167 ----- 150061 ----- 151337 ------ 152411 ------ 153293 ------ 154410 ------ 155310 ------ 156386 ------ 157590 ------ 158468 ------ 159305 ------ 160408 ------ 161368 ------ 162405 ------ 163380 ------ 164575 ------ 165545 ------ 166336 ------ 167397 ------ 168178 ------ 169037 ------ 170049 ------ 170961 ------ 171903 ------ 172778 ------ 173659 ------ 174790 ------ 175942 ------ 176848 ------ 177923 ------ 178929 ------ 180020 ------ 181259 ------ 182189 ------ 183185 ------ 184259 ------ 185293 ------ 186324 ------ 187343 ------ 188406 ------ 189513 ------ 190329 ------ 191092 ------ 192180 ------ 193293 ------ 194190 ------ 195344 ------ 196415 ------ 197219 ------ 198051 ------ 199021 ------ 199996
 │    │    │    │    │   histogram(23)=  0            1160            1.9758e+05           1260
 │    │    │    │    │                 <--- 'ECONOMY ANODIZED BRASS' ------------ 'STANDARD POLISHED TIN'
 │    │    │    │    ├── key: (19)
 │    │    │    │    └── fd: (19)-->(23)
 │    │    │    ├── index-join lineitem
 │    │    │    │    ├── save-table-name: q14_index_join_6
 │    │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null)
 │    │    │    │    ├── stats: [rows=74128.433, distinct(2)=62218.5876, null(2)=0, distinct(6)=71797.6283, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(6,7)=74128.433, null(6,7)=0]
 │    │    │    │    │   histogram(11)=  0       0        23508      2400      27010      3601      15406     2200.8
 │    │    │    │    │                 <--- '1995-08-31' ------- '1995-09-11' ------- '1995-09-22' ------- '1995-09-30'
 │    │    │    │    └── scan lineitem@l_sd
 │    │    │    │         ├── save-table-name: q14_scan_7
 │    │    │    │         ├── columns: l_orderkey:1(int!null) l_linenumber:4(int!null) l_shipdate:11(date!null)
 │    │    │    │         ├── constraint: /11/1/4: [/'1995-09-01' - /'1995-09-30']
 │    │    │    │         ├── stats: [rows=74128.433, distinct(1)=72797.8333, null(1)=0, distinct(4)=7, null(4)=0, distinct(11)=30, null(11)=0]
 │    │    │    │         │   histogram(1)=  0  7.41  363.23  7.41   363.23  7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41   363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    363.23   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   14.82   363.23   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    363.23   14.82   370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41    370.64   7.41
 │    │    │    │         │                <--- 2080 -------- 31014 -------- 69575 -------- 103104 -------- 128160 -------- 162950 -------- 198145 -------- 228293 -------- 261120 -------- 286596 -------- 313606 -------- 349666 -------- 388002 -------- 419650 -------- 449638 -------- 469765 -------- 501798 -------- 532839 -------- 569094 -------- 595175 -------- 631586 -------- 662690 -------- 691172 -------- 719398 -------- 752422 -------- 782370 -------- 811011 -------- 840933 -------- 875363 -------- 908545 -------- 937952 -------- 965280 -------- 992099 -------- 1023361 -------- 1061446 -------- 1093761 -------- 1130435 -------- 1156419 -------- 1186528 -------- 1213220 -------- 1247266 -------- 1279137 -------- 1308804 -------- 1338118 -------- 1367648 -------- 1403044 -------- 1434657 -------- 1461892 -------- 1496707 -------- 1524258 -------- 1556196 -------- 1584807 -------- 1624037 -------- 1647586 -------- 1680384 -------- 1710247 -------- 1742470 -------- 1772643 -------- 1806950 -------- 1838242 -------- 1869030 -------- 1892898 -------- 1924391 -------- 1956583 -------- 1992039 -------- 2023719 -------- 2054341 -------- 2082243 -------- 2116417 -------- 2143300 -------- 2173025 -------- 2201185 -------- 2226595 -------- 2249026 -------- 2275940 -------- 2304258 -------- 2333927 -------- 2363298 -------- 2388035 -------- 2420771 -------- 2444033 -------- 2467330 -------- 2499238 -------- 2517824 -------- 2544453 -------- 2571559 -------- 2596743 -------- 2628165 -------- 2656549 -------- 2694273 -------- 2723908 -------- 2751681 -------- 2779396 -------- 2807363 -------- 2846274 -------- 2878595 -------- 2907872 -------- 2935750 -------- 2967776 -------- 2995652 -------- 3033255 -------- 3055778 -------- 3091586 -------- 3121990 -------- 3148197 -------- 3172929 -------- 3200929 -------- 3223908 -------- 3255200 -------- 3285537 -------- 3308806 -------- 3329187 -------- 3351076 -------- 3385440 -------- 3417696 -------- 3451008 -------- 3480032 -------- 3506624 -------- 3534721 -------- 3562567 -------- 3591906 -------- 3627237 -------- 3652387 -------- 3688930 -------- 3711329 -------- 3737316 -------- 3767877 -------- 3803686 -------- 3840134 -------- 3875330 -------- 3903040 -------- 3930209 -------- 3964356 -------- 3986562 -------- 4031845 -------- 4058982 -------- 4087876 -------- 4116450 -------- 4146470 -------- 4171267 -------- 4199714 -------- 4225125 -------- 4257092 -------- 4288711 -------- 4321858 -------- 4352672 -------- 4386275 -------- 4412992 -------- 4446243 -------- 4474721 -------- 4503174 -------- 4529732 -------- 4559040 -------- 4592387 -------- 4621285 -------- 4655205 -------- 4688581 -------- 4719237 -------- 4756101 -------- 4786912 -------- 4816386 -------- 4843174 -------- 4871110 -------- 4895782 -------- 4927970 -------- 4959751 -------- 4983012 -------- 5021063 -------- 5058083 -------- 5087588 -------- 5117029 -------- 5157666 -------- 5186247 -------- 5218338 -------- 5251456 -------- 5282627 -------- 5314979 -------- 5338981 -------- 5365635 -------- 5395394 -------- 5431526 -------- 5462277 -------- 5490784 -------- 5520389 -------- 5545990 -------- 5577312 -------- 5609796 -------- 5638241 -------- 5671046 -------- 5698432 -------- 5725537 -------- 5753122 -------- 5777830 -------- 5810308 -------- 5841377 -------- 5871941 -------- 5896865 -------- 5933830 -------- 5965058 -------- 5999878
 │    │    │    │         │   histogram(4)=  0 18569 0 15767 0 12839 0 10897 0 8080 0 5374.3 0 2601.9
 │    │    │    │         │                <---- 0 ----- 1 ----- 2 ----- 3 ---- 4 ----- 5 ------ 6 --
 │    │    │    │         │   histogram(11)=  0       0        23508      2400      27010      3601      15406     2200.8
 │    │    │    │         │                 <--- '1995-08-31' ------- '1995-09-11' ------- '1995-09-22' ------- '1995-09-30'
 │    │    │    │         ├── key: (1,4)
 │    │    │    │         └── fd: (1,4)-->(11)
 │    │    │    └── filters
 │    │    │         └── l_partkey:2 = p_partkey:19 [type=bool, outer=(2,19), constraints=(/2: (/NULL - ]; /19: (/NULL - ]), fd=(2)==(19), (19)==(2)]
 │    │    └── projections
 │    │         ├── CASE WHEN p_type:23 LIKE 'PROMO%' THEN l_extendedprice:6 * (1.0 - l_discount:7) ELSE 0.0 END [as=column30:30, type=float, outer=(6,7,23), immutable]
 │    │         └── l_extendedprice:6 * (1.0 - l_discount:7) [as=column32:32, type=float, outer=(6,7), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:31, type=float, outer=(30)]
 │         │    └── column30:30 [type=float]
 │         └── sum [as=sum:33, type=float, outer=(32)]
 │              └── column32:32 [type=float]
 └── projections
      └── (sum:31 * 100.0) / sum:33 [as=promo_revenue:34, type=float, outer=(31,33), immutable]

----Stats for q14_project_1----
column_names     row_count  distinct_count  null_count
{promo_revenue}  1          1               0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{promo_revenue}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum_1}       1          1               0
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00
{sum_1}       1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_project_3----
column_names  row_count  distinct_count  null_count
{column30}    75983      12638           0
{column32}    75983      76207           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{column30}    74411.00       1.02           74411.00            5.89 <==            0.00            1.00
{column32}    74411.00       1.02           46962.00            1.62                0.00            1.00

----Stats for q14_inner_join_4----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
{p_partkey}        75983      63035           0
{p_type}           75983      150             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       74411.00       1.02           11.00               1.00                0.00            1.00
{l_extendedprice}  74411.00       1.02           46329.00            1.57                0.00            1.00
{l_partkey}        74411.00       1.02           62219.00            1.01                0.00            1.00
{l_shipdate}       74411.00       1.02           30.00               1.00                0.00            1.00
{p_partkey}        74411.00       1.02           62219.00            1.01                0.00            1.00
{p_type}           74411.00       1.02           150.00              1.00                0.00            1.00

----Stats for q14_scan_5----
column_names  row_count  distinct_count  null_count
{p_partkey}   200000     199241          0
{p_type}      200000     150             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_partkey}   200000.00      1.00           199241.00           1.00                0.00            1.00
{p_type}      200000.00      1.00           150.00              1.00                0.00            1.00

----Stats for q14_index_join_6----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       74128.00       1.03           11.00               1.00                0.00            1.00
{l_extendedprice}  74128.00       1.03           71798.00            1.01                0.00            1.00
{l_partkey}        74128.00       1.03           62219.00            1.01                0.00            1.00
{l_shipdate}       74128.00       1.03           30.00               1.00                0.00            1.00

----Stats for q14_scan_7----
column_names    row_count  distinct_count  null_count
{l_linenumber}  75983      7               0
{l_orderkey}    75983      49544           0
{l_shipdate}    75983      30              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  74128.00       1.03           7.00                1.00                0.00            1.00
{l_orderkey}    74128.00       1.03           72798.00            1.47                0.00            1.00
{l_shipdate}    74128.00       1.03           30.00               1.00                0.00            1.00
----
----
