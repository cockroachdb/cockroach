import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q14
# Promotion Effect
# Monitors the market response to a promotion such as TV advertisements or a
# special campaign.
#
# Determines what percentage of the revenue in a given year and month was
# derived from promotional parts. The query considers only parts actually
# shipped in that month and gives the percentage. Revenue is defined as
# (l_extendedprice * (1-l_discount)).
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q14
SELECT
    100.00 * sum(CASE
        WHEN p_type LIKE 'PROMO%'
            THEN l_extendedprice * (1 - l_discount)
        ELSE 0
    END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue
FROM
    lineitem,
    part
WHERE
    l_partkey = p_partkey
    AND l_shipdate >= DATE '1995-09-01'
    AND l_shipdate < DATE '1995-09-01' + INTERVAL '1' MONTH;
----
----
project
 ├── save-table-name: q14_project_1
 ├── columns: promo_revenue:34(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(34)=1, null(34)=0]
 ├── key: ()
 ├── fd: ()-->(34)
 ├── scalar-group-by
 │    ├── save-table-name: q14_scalar_group_by_2
 │    ├── columns: sum:31(float) sum:33(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(31)=1, null(31)=0, distinct(33)=1, null(33)=0, distinct(31,33)=1, null(31,33)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(31,33)
 │    ├── project
 │    │    ├── save-table-name: q14_project_3
 │    │    ├── columns: column30:30(float!null) column32:32(float!null)
 │    │    ├── immutable
 │    │    ├── stats: [rows=75588.5932, distinct(30)=75588.5932, null(30)=0, distinct(32)=47705.1727, null(32)=0]
 │    │    ├── inner-join (hash)
 │    │    │    ├── save-table-name: q14_inner_join_4
 │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null) p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
 │    │    │    ├── stats: [rows=75588.5932, distinct(2)=63033.2323, null(2)=0, distinct(6)=47051.9439, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(19)=63033.2323, null(19)=0, distinct(23)=150, null(23)=0, distinct(6,7)=47705.1727, null(6,7)=0, distinct(6,7,23)=75588.5932, null(6,7,23)=0]
 │    │    │    ├── fd: (19)-->(23), (2)==(19), (19)==(2)
 │    │    │    ├── scan part
 │    │    │    │    ├── save-table-name: q14_scan_5
 │    │    │    │    ├── columns: p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(23)=150, null(23)=0]
 │    │    │    │    │   histogram(19)=  0  1  999   1   999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1
 │    │    │    │    │                 <--- 1 ----- 987 ----- 1972 ----- 2846 ----- 3792 ----- 4654 ----- 5722 ----- 6939 ----- 7937 ----- 9255 ----- 10327 ----- 11291 ----- 12445 ----- 13372 ----- 14379 ----- 15457 ----- 16675 ----- 17486 ----- 18384 ----- 19373 ----- 20443 ----- 21601 ----- 23035 ----- 23908 ----- 25073 ----- 25915 ----- 26944 ----- 27899 ----- 29113 ----- 30364 ----- 31160 ----- 32292 ----- 33258 ----- 34323 ----- 35366 ----- 36418 ----- 37372 ----- 38215 ----- 39352 ----- 40245 ----- 41439 ----- 42339 ----- 43637 ----- 44511 ----- 45651 ----- 46591 ----- 47672 ----- 48564 ----- 49466 ----- 50522 ----- 51595 ----- 52762 ----- 53787 ----- 54869 ----- 56065 ----- 56958 ----- 57932 ----- 58966 ----- 59920 ----- 60770 ----- 61901 ----- 62841 ----- 63696 ----- 64590 ----- 65643 ----- 66567 ----- 67521 ----- 68377 ----- 69395 ----- 70732 ----- 71726 ----- 72528 ----- 73491 ----- 74301 ----- 75033 ----- 76089 ----- 77258 ----- 78099 ----- 79113 ----- 80081 ----- 80863 ----- 82053 ----- 83211 ----- 84007 ----- 85125 ----- 86229 ----- 87498 ----- 88267 ----- 88994 ----- 89981 ----- 91033 ----- 92136 ----- 93152 ----- 94179 ----- 95298 ----- 96566 ----- 97512 ----- 98476 ----- 99317 ----- 100285 ----- 101318 ----- 102259 ----- 103007 ----- 103930 ----- 104922 ----- 106125 ----- 106950 ----- 108047 ----- 109058 ----- 110013 ----- 111119 ----- 112044 ----- 112930 ----- 113827 ----- 114796 ----- 115770 ----- 116759 ----- 117893 ----- 118822 ----- 119884 ----- 121129 ----- 122133 ----- 123311 ----- 124317 ----- 125306 ----- 126352 ----- 127176 ----- 128056 ----- 128846 ----- 129709 ----- 130455 ----- 131466 ----- 132372 ----- 133261 ----- 134192 ----- 135103 ----- 136111 ----- 137285 ----- 138147 ----- 139212 ----- 140071 ----- 141098 ----- 142082 ----- 143112 ----- 144142 ----- 145334 ----- 146233 ----- 147427 ----- 148299 ----- 149264 ----- 150201 ------ 151175 ------ 152152 ------ 153305 ------ 154325 ------ 155665 ------ 156485 ------ 157522 ------ 158788 ------ 159780 ------ 160782 ------ 161605 ------ 162522 ------ 163451 ------ 164496 ------ 165673 ------ 166812 ------ 167754 ------ 168770 ------ 169914 ------ 170858 ------ 171813 ------ 172675 ------ 173553 ------ 174651 ------ 175603 ------ 176440 ------ 177417 ------ 178510 ------ 179651 ------ 180631 ------ 181579 ------ 182865 ------ 183917 ------ 184893 ------ 185879 ------ 186894 ------ 187920 ------ 188791 ------ 189570 ------ 190892 ------ 191769 ------ 192729 ------ 193530 ------ 194607 ------ 195817 ------ 196727 ------ 197756 ------ 198892 ------ 199913
 │    │    │    │    │   histogram(23)=  0            1280            1.975e+05           1220
 │    │    │    │    │                 <--- 'ECONOMY ANODIZED BRASS' ----------- 'STANDARD POLISHED TIN'
 │    │    │    │    ├── key: (19)
 │    │    │    │    └── fd: (19)-->(23)
 │    │    │    ├── index-join lineitem
 │    │    │    │    ├── save-table-name: q14_index_join_6
 │    │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null)
 │    │    │    │    ├── stats: [rows=75301.7345, distinct(2)=63033.2323, null(2)=0, distinct(6)=72897.2156, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(6,7)=75301.7345, null(6,7)=0]
 │    │    │    │    │   histogram(11)=  0       0        23081      3601      28210      3601      14406     2400.9
 │    │    │    │    │                 <--- '1995-08-31' ------- '1995-09-10' ------- '1995-09-23' ------- '1995-09-30'
 │    │    │    │    └── scan lineitem@l_sd
 │    │    │    │         ├── save-table-name: q14_scan_7
 │    │    │    │         ├── columns: l_orderkey:1(int!null) l_linenumber:4(int!null) l_shipdate:11(date!null)
 │    │    │    │         ├── constraint: /11/1/4: [/'1995-09-01' - /'1995-09-30']
 │    │    │    │         ├── stats: [rows=75301.7345, distinct(1)=73928.8531, null(1)=0, distinct(4)=7, null(4)=0, distinct(11)=30, null(11)=0]
 │    │    │    │         │   histogram(1)=  0 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636 376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.44 0.087818  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  376.49 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636  384.02 0.037636
 │    │    │    │         │                <---- 162 ---------- 31301 --------- 54535 --------- 88071 --------- 129153 -------- 162720 -------- 192002 -------- 217378 -------- 246113 -------- 271841 -------- 305764 -------- 338307 -------- 364355 -------- 391203 -------- 417345 -------- 444354 -------- 470532 -------- 508740 -------- 541509 -------- 567712 -------- 602535 -------- 633472 -------- 666272 -------- 704547 -------- 744737 -------- 772035 -------- 799329 -------- 830371 -------- 860963 -------- 886882 -------- 910501 -------- 935203 -------- 967490 -------- 992870 -------- 1030465 -------- 1055844 -------- 1084384 -------- 1116993 -------- 1143329 -------- 1169122 -------- 1206565 -------- 1231015 -------- 1256773 -------- 1290561 -------- 1315975 -------- 1338052 -------- 1377187 -------- 1406400 -------- 1439906 -------- 1478435 -------- 1509506 -------- 1540353 -------- 1568868 -------- 1602372 -------- 1631558 -------- 1665763 -------- 1698786 -------- 1726147 -------- 1755971 -------- 1781280 -------- 1807489 -------- 1846976 -------- 1876480 -------- 1903233 -------- 1933287 -------- 1958180 -------- 1987526 -------- 2019972 -------- 2054562 -------- 2083395 -------- 2116487 -------- 2143875 -------- 2169157 -------- 2191907 -------- 2227396 -------- 2260770 -------- 2291687 -------- 2318406 -------- 2345825 -------- 2376359 -------- 2411750 -------- 2442944 -------- 2476257 -------- 2508709 -------- 2536967 -------- 2567968 -------- 2600323 -------- 2636839 -------- 2676868 -------- 2710404 -------- 2738405 -------- 2769282 -------- 2795910 -------- 2829123 -------- 2855139 -------- 2884548 -------- 2919713 -------- 2949634 -------- 2977888 -------- 3008448 -------- 3037794 -------- 3063299 -------- 3090019 -------- 3120929 -------- 3149669 -------- 3184354 -------- 3214690 -------- 3242403 -------- 3269186 -------- 3297157 -------- 3327617 -------- 3361540 -------- 3390566 -------- 3421415 -------- 3448775 -------- 3479523 -------- 3513702 -------- 3557120 -------- 3594020 -------- 3618848 -------- 3657921 -------- 3686688 -------- 3719779 -------- 3745888 -------- 3767910 -------- 3800352 -------- 3830087 -------- 3862471 -------- 3894247 -------- 3923847 -------- 3946375 -------- 3976551 -------- 4008353 -------- 4035909 -------- 4072198 -------- 4100325 -------- 4127969 -------- 4159813 -------- 4186147 -------- 4210308 -------- 4238373 -------- 4272741 -------- 4298435 -------- 4324423 -------- 4351553 -------- 4380007 -------- 4408480 -------- 4432289 -------- 4462305 -------- 4490434 -------- 4520167 -------- 4552835 -------- 4585985 -------- 4624644 -------- 4648864 -------- 4677799 -------- 4709350 -------- 4738114 -------- 4769154 -------- 4799845 -------- 4826912 -------- 4852295 -------- 4884229 -------- 4915719 -------- 4941602 -------- 4968739 -------- 5001382 -------- 5030786 -------- 5056263 -------- 5087015 -------- 5115844 -------- 5138788 -------- 5171463 -------- 5205504 -------- 5231745 -------- 5266119 -------- 5291939 -------- 5324775 -------- 5351841 -------- 5387139 -------- 5416356 -------- 5444641 -------- 5469445 -------- 5501376 -------- 5528832 -------- 5558657 -------- 5592353 -------- 5627138 -------- 5658662 -------- 5693280 -------- 5726240 -------- 5758310 -------- 5788483 -------- 5819590 -------- 5848387 -------- 5882018 -------- 5906880 -------- 5939013 -------- 5973316 -------- 5999719
 │    │    │    │         │   histogram(4)=  0 18630 0 15768 0 13660 0 10926 0 8117.5 0 5655.2 0 2545.2
 │    │    │    │         │                <---- 0 ----- 1 ----- 2 ----- 3 ----- 4 ------ 5 ------ 6 --
 │    │    │    │         │   histogram(11)=  0       0        23081      3601      28210      3601      14406     2400.9
 │    │    │    │         │                 <--- '1995-08-31' ------- '1995-09-10' ------- '1995-09-23' ------- '1995-09-30'
 │    │    │    │         ├── key: (1,4)
 │    │    │    │         └── fd: (1,4)-->(11)
 │    │    │    └── filters
 │    │    │         └── l_partkey:2 = p_partkey:19 [type=bool, outer=(2,19), constraints=(/2: (/NULL - ]; /19: (/NULL - ]), fd=(2)==(19), (19)==(2)]
 │    │    └── projections
 │    │         ├── CASE WHEN p_type:23 LIKE 'PROMO%' THEN l_extendedprice:6 * (1.0 - l_discount:7) ELSE 0.0 END [as=column30:30, type=float, outer=(6,7,23), immutable]
 │    │         └── l_extendedprice:6 * (1.0 - l_discount:7) [as=column32:32, type=float, outer=(6,7), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:31, type=float, outer=(30)]
 │         │    └── column30:30 [type=float]
 │         └── sum [as=sum:33, type=float, outer=(32)]
 │              └── column32:32 [type=float]
 └── projections
      └── (sum:31 * 100.0) / sum:33 [as=promo_revenue:34, type=float, outer=(31,33), immutable]

----Stats for q14_project_1----
column_names     row_count  distinct_count  null_count
{promo_revenue}  1          1               0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{promo_revenue}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum_1}       1          1               0
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00
{sum_1}       1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_project_3----
column_names  row_count  distinct_count  null_count
{column30}    75983      12638           0
{column32}    75983      76207           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{column30}    75589.00       1.01           75589.00            5.98 <==            0.00            1.00
{column32}    75589.00       1.01           47705.00            1.60                0.00            1.00

----Stats for q14_inner_join_4----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
{p_partkey}        75983      63035           0
{p_type}           75983      150             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       75589.00       1.01           11.00               1.00                0.00            1.00
{l_extendedprice}  75589.00       1.01           47052.00            1.54                0.00            1.00
{l_partkey}        75589.00       1.01           63033.00            1.00                0.00            1.00
{l_shipdate}       75589.00       1.01           30.00               1.00                0.00            1.00
{p_partkey}        75589.00       1.01           63033.00            1.00                0.00            1.00
{p_type}           75589.00       1.01           150.00              1.00                0.00            1.00

----Stats for q14_scan_5----
column_names  row_count  distinct_count  null_count
{p_partkey}   200000     199241          0
{p_type}      200000     150             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_partkey}   200000.00      1.00           199241.00           1.00                0.00            1.00
{p_type}      200000.00      1.00           150.00              1.00                0.00            1.00

----Stats for q14_index_join_6----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       75302.00       1.01           11.00               1.00                0.00            1.00
{l_extendedprice}  75302.00       1.01           72897.00            1.00                0.00            1.00
{l_partkey}        75302.00       1.01           63033.00            1.00                0.00            1.00
{l_shipdate}       75302.00       1.01           30.00               1.00                0.00            1.00

----Stats for q14_scan_7----
column_names    row_count  distinct_count  null_count
{l_linenumber}  75983      7               0
{l_orderkey}    75983      49544           0
{l_shipdate}    75983      30              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  75302.00       1.01           7.00                1.00                0.00            1.00
{l_orderkey}    75302.00       1.01           73929.00            1.49                0.00            1.00
{l_shipdate}    75302.00       1.01           30.00               1.00                0.00            1.00
----
----
