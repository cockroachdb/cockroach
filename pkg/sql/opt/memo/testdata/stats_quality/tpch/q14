import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q14
# Promotion Effect
# Monitors the market response to a promotion such as TV advertisements or a
# special campaign.
#
# Determines what percentage of the revenue in a given year and month was
# derived from promotional parts. The query considers only parts actually
# shipped in that month and gives the percentage. Revenue is defined as
# (l_extendedprice * (1-l_discount)).
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q14
SELECT
    100.00 * sum(CASE
        WHEN p_type LIKE 'PROMO%'
            THEN l_extendedprice * (1 - l_discount)
        ELSE 0
    END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue
FROM
    lineitem,
    part
WHERE
    l_partkey = p_partkey
    AND l_shipdate >= DATE '1995-09-01'
    AND l_shipdate < DATE '1995-09-01' + INTERVAL '1' MONTH;
----
----
project
 ├── save-table-name: q14_project_1
 ├── columns: promo_revenue:34(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(34)=1, null(34)=0]
 ├── key: ()
 ├── fd: ()-->(34)
 ├── scalar-group-by
 │    ├── save-table-name: q14_scalar_group_by_2
 │    ├── columns: sum:31(float) sum:33(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(31)=1, null(31)=0, distinct(33)=1, null(33)=0, distinct(31,33)=1, null(31,33)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(31,33)
 │    ├── project
 │    │    ├── save-table-name: q14_project_3
 │    │    ├── columns: column30:30(float!null) column32:32(float!null)
 │    │    ├── immutable
 │    │    ├── stats: [rows=73883.8571, distinct(30)=73883.8571, null(30)=0, distinct(32)=46629.2864, null(32)=0]
 │    │    ├── inner-join (hash)
 │    │    │    ├── save-table-name: q14_inner_join_4
 │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null) p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    ├── multiplicity: left-rows(zero-or-more), right-rows(exactly-one)
 │    │    │    ├── stats: [rows=73883.8571, distinct(2)=61852.5712, null(2)=0, distinct(6)=46005.2575, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(19)=61852.5712, null(19)=0, distinct(23)=150, null(23)=0, distinct(6,7)=46629.2864, null(6,7)=0, distinct(6,7,23)=73883.8571, null(6,7,23)=0]
 │    │    │    ├── fd: (19)-->(23), (2)==(19), (19)==(2)
 │    │    │    ├── scan part
 │    │    │    │    ├── save-table-name: q14_scan_5
 │    │    │    │    ├── columns: p_partkey:19(int!null) p_type:23(varchar!null)
 │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(23)=150, null(23)=0]
 │    │    │    │    │   histogram(19)=  0  1  999   1   999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1
 │    │    │    │    │                 <--- 1 ----- 990 ----- 1908 ----- 2654 ----- 3480 ----- 4323 ----- 5415 ----- 6395 ----- 7425 ----- 8349 ----- 9254 ----- 10332 ----- 11390 ----- 12415 ----- 13416 ----- 14393 ----- 15313 ----- 16255 ----- 17665 ----- 18720 ----- 19911 ----- 20848 ----- 21989 ----- 23151 ----- 24356 ----- 25268 ----- 26245 ----- 27454 ----- 28599 ----- 29440 ----- 30292 ----- 31342 ----- 32192 ----- 33244 ----- 34481 ----- 35501 ----- 36339 ----- 37560 ----- 38608 ----- 39602 ----- 40697 ----- 41780 ----- 42779 ----- 43901 ----- 44961 ----- 46051 ----- 47161 ----- 48076 ----- 48933 ----- 49909 ----- 50998 ----- 51760 ----- 52535 ----- 53460 ----- 54368 ----- 55118 ----- 56199 ----- 57150 ----- 58264 ----- 59221 ----- 60205 ----- 61214 ----- 62123 ----- 63241 ----- 64288 ----- 65510 ----- 66487 ----- 67201 ----- 68166 ----- 69028 ----- 70017 ----- 70887 ----- 71713 ----- 72769 ----- 73666 ----- 74674 ----- 75744 ----- 76655 ----- 77515 ----- 78353 ----- 79352 ----- 80189 ----- 80922 ----- 82041 ----- 83040 ----- 84252 ----- 85274 ----- 86356 ----- 87233 ----- 88417 ----- 89682 ----- 90842 ----- 91964 ----- 92825 ----- 93915 ----- 95025 ----- 96201 ----- 97351 ----- 98607 ----- 99598 ----- 100794 ----- 101682 ----- 102536 ----- 103533 ----- 104562 ----- 105587 ----- 106505 ----- 107357 ----- 108473 ----- 109387 ----- 110109 ----- 111138 ----- 112141 ----- 113068 ----- 114173 ----- 115237 ----- 116149 ----- 117353 ----- 118542 ----- 119689 ----- 120744 ----- 121665 ----- 122560 ----- 123765 ----- 124914 ----- 125866 ----- 126940 ----- 127886 ----- 129064 ----- 130094 ----- 131156 ----- 132214 ----- 133114 ----- 134033 ----- 134953 ----- 135940 ----- 137212 ----- 138035 ----- 139066 ----- 140078 ----- 140756 ----- 141855 ----- 142810 ----- 143752 ----- 144763 ----- 145625 ----- 146578 ----- 147502 ----- 148203 ----- 149245 ----- 150294 ------ 151202 ------ 152175 ------ 153228 ------ 154049 ------ 155101 ------ 156242 ------ 157246 ------ 158276 ------ 159046 ------ 159984 ------ 160765 ------ 161607 ------ 162659 ------ 163871 ------ 164853 ------ 166025 ------ 167081 ------ 168121 ------ 168915 ------ 169848 ------ 170796 ------ 171727 ------ 172620 ------ 173588 ------ 174678 ------ 175985 ------ 177210 ------ 178275 ------ 179114 ------ 179954 ------ 181000 ------ 182196 ------ 183229 ------ 184242 ------ 185479 ------ 186555 ------ 187545 ------ 188446 ------ 189597 ------ 190758 ------ 191776 ------ 192781 ------ 193970 ------ 195096 ------ 195972 ------ 196897 ------ 197664 ------ 198728 ------ 199996
 │    │    │    │    │   histogram(23)=  0            1480            1.9718e+05           1340
 │    │    │    │    │                 <--- 'ECONOMY ANODIZED BRASS' ------------ 'STANDARD POLISHED TIN'
 │    │    │    │    ├── key: (19)
 │    │    │    │    └── fd: (19)-->(23)
 │    │    │    ├── index-join lineitem
 │    │    │    │    ├── save-table-name: q14_index_join_6
 │    │    │    │    ├── columns: l_partkey:2(int!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null)
 │    │    │    │    ├── stats: [rows=73603.4678, distinct(2)=61852.5712, null(2)=0, distinct(6)=71305.2797, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=30, null(11)=0, distinct(6,7)=73603.4678, null(6,7)=0]
 │    │    │    │    │   histogram(11)=  0       0        2734.3      5402      28811      1200      28811      4201      0     2441.7
 │    │    │    │    │                 <--- '1995-08-31' -------- '1995-09-02' ------- '1995-09-15' ------- '1995-09-29' --- '1995-09-30'
 │    │    │    │    └── scan lineitem@l_sd
 │    │    │    │         ├── save-table-name: q14_scan_7
 │    │    │    │         ├── columns: l_orderkey:1(int!null) l_linenumber:4(int!null) l_shipdate:11(date!null)
 │    │    │    │         ├── constraint: /11/1/4: [/'1995-09-01' - /'1995-09-30']
 │    │    │    │         ├── stats: [rows=73603.4678, distinct(1)=72291.5736, null(1)=0, distinct(4)=7, null(4)=0, distinct(11)=30, null(11)=0]
 │    │    │    │         │   histogram(1)=  0 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788 368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  367.95 0.085838  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  368 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.31 0.085838  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.36 0.036788  375.31 0.085838
 │    │    │    │         │                <----- 96 ------- 27462 ------ 55908 ------ 81189 ------ 111332 ----- 146310 ----- 176546 ----- 214183 ----- 244901 ----- 273698 ----- 297031 ----- 327972 ----- 364036 ----- 387430 ----- 419910 ----- 452645 ----- 483525 ----- 517120 ----- 544416 ----- 580583 ----- 610183 ----- 639270 ----- 675489 ----- 707588 ----- 733989 ----- 762849 ----- 789191 ----- 816259 ----- 840323 ----- 869380 ----- 901348 ----- 930243 ----- 954277 ----- 983841 ----- 1011971 ----- 1044325 ----- 1078305 ----- 1108161 ----- 1134371 ----- 1166722 ----- 1190086 ----- 1220487 ----- 1251076 ----- 1282883 ----- 1306945 ----- 1341152 ----- 1372839 ----- 1405123 ----- 1436802 ----- 1461223 ----- 1485568 ----- 1519622 ----- 1547942 ----- 1575398 ----- 1600675 ----- 1636354 ----- 1666116 ----- 1694565 ----- 1726311 ----- 1744324 ----- 1771008 ----- 1809671 ----- 1838310 ----- 1865984 ----- 1892293 ----- 1921220 ----- 1946343 ----- 1977892 ----- 2011041 ----- 2042051 ----- 2079205 ----- 2114406 ----- 2153093 ----- 2183456 ----- 2210885 ----- 2248451 ----- 2290051 ----- 2315974 ----- 2346562 ----- 2376961 ----- 2404199 ----- 2431109 ----- 2467681 ----- 2491684 ----- 2514117 ----- 2545093 ----- 2571202 ----- 2597444 ----- 2627872 ----- 2658853 ----- 2692096 ----- 2721061 ----- 2752866 ----- 2783620 ----- 2811588 ----- 2847140 ----- 2874885 ----- 2902368 ----- 2935717 ----- 2965856 ----- 2999718 ----- 3026497 ----- 3054692 ----- 3077540 ----- 3105633 ----- 3127238 ----- 3157925 ----- 3185728 ----- 3210144 ----- 3244998 ----- 3273921 ----- 3310662 ----- 3339776 ----- 3370343 ----- 3402913 ----- 3440772 ----- 3474279 ----- 3504768 ----- 3535555 ----- 3569154 ----- 3604261 ----- 3637094 ----- 3667714 -------- 3694596 ----- 3720451 ----- 3747078 ----- 3775621 ----- 3797316 ----- 3828068 ----- 3852358 ----- 3880161 ----- 3912773 ----- 3942627 ----- 3972226 ----- 4004099 ----- 4027655 ----- 4056066 ----- 4088323 ----- 4115264 ----- 4147139 ----- 4176096 ----- 4205191 ----- 4230976 ----- 4262658 ----- 4287621 ----- 4323334 ----- 4349126 ----- 4387877 ----- 4417188 ----- 4442406 ----- 4471904 -------- 4502437 -------- 4535779 -------- 4568487 -------- 4601252 -------- 4638375 -------- 4666407 -------- 4688003 -------- 4709570 -------- 4739781 -------- 4773827 -------- 4809248 -------- 4841249 -------- 4872931 -------- 4902339 -------- 4932486 -------- 4963587 -------- 4998565 -------- 5033764 -------- 5064996 -------- 5099011 -------- 5130176 -------- 5165413 -------- 5200421 -------- 5228065 -------- 5262852 -------- 5298087 -------- 5330695 -------- 5361220 -------- 5394146 -------- 5421249 -------- 5451938 -------- 5482695 -------- 5522210 -------- 5553862 -------- 5590054 -------- 5614337 -------- 5642499 -------- 5669729 -------- 5695173 -------- 5725025 -------- 5761990 -------- 5792037 -------- 5821728 -------- 5851847 -------- 5885088 -------- 5917123 -------- 5943943 -------- 5965765 -------- 5999750
 │    │    │    │         │   histogram(4)=  0 18386 0 15111 0 13595 0 10430 0 7868.2 0 5520.2 0 2693.9
 │    │    │    │         │                <---- 0 ----- 1 ----- 2 ----- 3 ----- 4 ------ 5 ------ 6 --
 │    │    │    │         │   histogram(11)=  0       0        2734.3      5402      28811      1200      28811      4201      0     2441.7
 │    │    │    │         │                 <--- '1995-08-31' -------- '1995-09-02' ------- '1995-09-15' ------- '1995-09-29' --- '1995-09-30'
 │    │    │    │         ├── key: (1,4)
 │    │    │    │         └── fd: (1,4)-->(11)
 │    │    │    └── filters
 │    │    │         └── l_partkey:2 = p_partkey:19 [type=bool, outer=(2,19), constraints=(/2: (/NULL - ]; /19: (/NULL - ]), fd=(2)==(19), (19)==(2)]
 │    │    └── projections
 │    │         ├── CASE WHEN p_type:23 LIKE 'PROMO%' THEN l_extendedprice:6 * (1.0 - l_discount:7) ELSE 0.0 END [as=column30:30, type=float, outer=(6,7,23), immutable]
 │    │         └── l_extendedprice:6 * (1.0 - l_discount:7) [as=column32:32, type=float, outer=(6,7), immutable]
 │    └── aggregations
 │         ├── sum [as=sum:31, type=float, outer=(30)]
 │         │    └── column30:30 [type=float]
 │         └── sum [as=sum:33, type=float, outer=(32)]
 │              └── column32:32 [type=float]
 └── projections
      └── (sum:31 * 100.0) / sum:33 [as=promo_revenue:34, type=float, outer=(31,33), immutable]

----Stats for q14_project_1----
column_names     row_count  distinct_count  null_count
{promo_revenue}  1          1               0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{promo_revenue}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum_1}       1          1               0
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00
{sum_1}       1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q14_project_3----
column_names  row_count  distinct_count  null_count
{column30}    75983      12638           0
{column32}    75983      76207           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{column30}    73884.00       1.03           73884.00            5.85 <==            0.00            1.00
{column32}    73884.00       1.03           46629.00            1.63                0.00            1.00

----Stats for q14_inner_join_4----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
{p_partkey}        75983      63035           0
{p_type}           75983      150             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       73884.00       1.03           11.00               1.00                0.00            1.00
{l_extendedprice}  73884.00       1.03           46005.00            1.58                0.00            1.00
{l_partkey}        73884.00       1.03           61853.00            1.02                0.00            1.00
{l_shipdate}       73884.00       1.03           30.00               1.00                0.00            1.00
{p_partkey}        73884.00       1.03           61853.00            1.02                0.00            1.00
{p_type}           73884.00       1.03           150.00              1.00                0.00            1.00

----Stats for q14_scan_5----
column_names  row_count  distinct_count  null_count
{p_partkey}   200000     199241          0
{p_type}      200000     150             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_partkey}   200000.00      1.00           199241.00           1.00                0.00            1.00
{p_type}      200000.00      1.00           150.00              1.00                0.00            1.00

----Stats for q14_index_join_6----
column_names       row_count  distinct_count  null_count
{l_discount}       75983      11              0
{l_extendedprice}  75983      72627           0
{l_partkey}        75983      63035           0
{l_shipdate}       75983      30              0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       73603.00       1.03           11.00               1.00                0.00            1.00
{l_extendedprice}  73603.00       1.03           71305.00            1.02                0.00            1.00
{l_partkey}        73603.00       1.03           61853.00            1.02                0.00            1.00
{l_shipdate}       73603.00       1.03           30.00               1.00                0.00            1.00

----Stats for q14_scan_7----
column_names    row_count  distinct_count  null_count
{l_linenumber}  75983      7               0
{l_orderkey}    75983      49544           0
{l_shipdate}    75983      30              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  73603.00       1.03           7.00                1.00                0.00            1.00
{l_orderkey}    73603.00       1.03           72292.00            1.46                0.00            1.00
{l_shipdate}    73603.00       1.03           30.00               1.00                0.00            1.00
----
----
