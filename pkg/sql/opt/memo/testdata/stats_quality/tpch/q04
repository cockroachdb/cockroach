import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q4
# Order Priority Checking
# Determines how well the order priority system is working and gives an
# assessment of customer satisfaction.
#
# Counts the number of orders ordered in a given quarter of a given year in
# which at least one lineitem was received by the customer later than its
# committed date. The query lists the count of such orders for each order
# priority sorted in ascending priority order.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q4
SELECT
    o_orderpriority,
    count(*) AS order_count
FROM
    orders
WHERE
    o_orderdate >= DATE '1993-07-01'
    AND o_orderdate < DATE '1993-07-01' + INTERVAL '3' MONTH
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem
        WHERE
            l_orderkey = o_orderkey
            AND l_commitDATE < l_receiptdate
    )
GROUP BY
    o_orderpriority
ORDER BY
    o_orderpriority;
----
----
sort
 ├── save-table-name: q4_sort_1
 ├── columns: o_orderpriority:6(char!null) order_count:30(int!null)
 ├── stats: [rows=4, distinct(6)=4, null(6)=0, avgsize(6)=4, distinct(30)=4, null(30)=0, avgsize(30)=4]
 ├── key: (6)
 ├── fd: (6)-->(30)
 ├── ordering: +6
 └── group-by (hash)
      ├── save-table-name: q4_group_by_2
      ├── columns: o_orderpriority:6(char!null) count_rows:30(int!null)
      ├── grouping columns: o_orderpriority:6(char!null)
      ├── stats: [rows=4, distinct(6)=4, null(6)=0, avgsize(6)=4, distinct(30)=4, null(30)=0, avgsize(30)=4]
      ├── key: (6)
      ├── fd: (6)-->(30)
      ├── semi-join (lookup lineitem)
      │    ├── save-table-name: q4_lookup_join_3
      │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    ├── key columns: [1] = [12]
      │    ├── stats: [rows=60122.05, distinct(1)=60122.1, null(1)=0, avgsize(1)=4, distinct(5)=92, null(5)=0, avgsize(5)=4, distinct(6)=4, null(6)=0, avgsize(6)=4]
      │    ├── key: (1)
      │    ├── fd: (1)-->(5,6)
      │    ├── index-join orders
      │    │    ├── save-table-name: q4_index_join_4
      │    │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    │    ├── stats: [rows=60122.05, distinct(1)=60122.1, null(1)=0, avgsize(1)=4, distinct(5)=92, null(5)=0, avgsize(5)=4, distinct(6)=4, null(6)=0, avgsize(6)=4]
      │    │    │   histogram(5)=  0       0        6883.4     286.81     6883.4     573.62     6309.8     717.02     6883.4     860.42     6596.6     860.42     6596.6     430.21     6309.8     717.02     6453.2     1147.2     1075.5     537.76
      │    │    │                <--- '1993-06-30' -------- '1993-07-11' -------- '1993-07-22' -------- '1993-08-02' -------- '1993-08-14' -------- '1993-08-25' -------- '1993-09-05' -------- '1993-09-16' -------- '1993-09-27' -------- '1993-09-30'
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    └── scan orders@o_od
      │    │         ├── save-table-name: q4_scan_5
      │    │         ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null)
      │    │         ├── constraint: /5/1: [/'1993-07-01' - /'1993-09-30']
      │    │         ├── stats: [rows=60122.05, distinct(1)=60122.1, null(1)=0, avgsize(1)=4, distinct(5)=92, null(5)=0, avgsize(5)=4]
      │    │         │   histogram(1)=  0           0            0 0.040081 299.08 0.040081 292.03 0.040081 302.41 0.040081 304.21 0.040081 289.5 0.040081 293.59 0.040081 300.89 0.040081 294.67 0.040081 311.75 0.040081 303.69 0.040081 309.9 0.040081 308.42 0.040081 304.09 0.040081 303.41 0.040081 310.95 0.040081 305.61 0.040081 300.89 0.040081 290.42 0.040081 313.47 0.040081 302.21 0.040081 298.84 0.040081 304.21 0.040081 310.26 0.040081 304.81 0.040081 309.06 0.040081 309.02 0.040081 308.98 0.040081 300.24 0.040081 301.73 0.040081 293.87 0.040081 293.07 0.040081 303.69 0.040081  302.45 0.040081  291.71 0.040081  296.32 0.040081  300.97 0.040081  305.53 0.040081  303.89 0.040081  311.67 0.040081  301.57 0.040081  303.37 0.040081  299.96 0.040081  307.14 0.040081  295.35 0.040081  299.44 0.040081  295.84 0.040081  306.54 0.040081  295.88 0.040081  306.06 0.040081  300.24 0.040081  298.48 0.040081  301.69 0.040081  298.28 0.040081  291.23 0.040081  319.08 0.040081  290.66 0.040081  301.21 0.040081  292.39 0.040081  300.73 0.040081  292.03 0.040081  293.43 0.040081  290.02 0.040081  298.68 0.040081  313.07 0.040081  295.76 0.040081  297.36 0.040081  307.1 0.040081  296.8 0.040081  297.92 0.040081  303.81 0.040081  314.11 0.040081  298.44 0.040081  294.83 0.040081  305.33 0.040081  285.01 0.040081  296.56 0.040081  305.53 0.040081  306.86 0.040081  297.96 0.040081  306.9 0.040081  296.8 0.040081  299.6 0.040081  303.53 0.040081  308.18 0.040081  303.01 0.040081  297.2 0.040081  301.57 0.040081  302.97 0.040081  293.83 0.040081  304.13 0.040081  296.16 0.040081  293.71 0.040081  307.5 0.040081  301.57 0.040081  308.14 0.040081  301.61 0.040081  305.21 0.040081  299.16 0.040081  304.41 0.040081  295.51 0.040081  307.46 0.040081  293.03 0.040081  291.43 0.040081  296.6 0.040081  308.18 0.040081  300.12 0.040081  302.89 0.040081  295.23 0.040081  301.49 0.040081  311.15 0.040081  296.08 0.040081  296.6 0.040081  303.13 0.040081  300.73 0.040081  288.66 0.040081  304.45 0.040081  301.65 0.040081  298.68 0.040081  291.83 0.040081  292.91 0.040081  296.08 0.040081  294.43 0.040081  295.96 0.040081  301.85 0.040081  308.9 0.040081  303.89 0.040081  301.13 0.040081  302.09 0.040081  289.02 0.040081  308.22 0.040081  306.98 0.040081  294.95 0.040081  306.5 0.040081  290.7 0.040081  293.71 0.040081  301.65 0.040081  303.21 0.040081  301.61 0.040081  298.16 0.040081  300.36 0.040081  297.4 0.040081  301.01 0.040081  304.45 0.040081  296.48 0.040081  295.76 0.040081  293.83 0.040081  296.12 0.040081  302.73 0.040081  293.83 0.040081  297.88 0.040081  311.59 0.040081  314.79 0.040081  303.13 0.040081  302.57 0.040081  314.55 0.040081  318 0.040081  311.39 0.040081  310.18 0.040081  299.84 0.040081  307.82 0.040081  307.18 0.040081  304.13 0.040081  301.73 0.040081  299.28 0.040081  298.4 0.040081  301.41 0.040081  313.87 0.040081  303.37 0.040081  307.5 0.040081  306.14 0.040081  299.12 0.040081  314.71 0.040081  299.96 0.040081  311.27 0.040081  298.68 0.040081  322.69 0.040081  306.42 0.040081  309.62 0.040081  299.48 0.040081  301.33 0.040081  313.87 0.040081  296.12 0.040081  310.63 0.040081  302.45 0.040081  309.38 0.040081  296 0.040081  299.2 0.040081  299.32 0.040081  313.03 0.040081  311.31 0.040081  301.09 0.040081  306.3 0.040081  309.1 0.040081  309.82 0.040081  305.9 0.040081  310.02 0.040081  317.92 0.040081  304.09 0.040081  319.24 0.040081  0           0
      │    │         │                <--- -9223372036854775808 ---- 1472 --------- 30469 --------- 54689 --------- 85922 --------- 118369 ------- 140867 -------- 166146 -------- 196357 -------- 222375 -------- 259877 -------- 291970 ------- 328227 -------- 363490 -------- 395873 -------- 427783 -------- 464741 -------- 498146 -------- 528358 -------- 551493 -------- 590144 -------- 621254 -------- 650083 -------- 682531 -------- 719041 -------- 751906 -------- 787617 -------- 823298 -------- 858944 -------- 888739 -------- 919527 -------- 944996 -------- 969922 -------- 1002020 -------- 1033280 -------- 1057284 -------- 1084416 -------- 1114693 -------- 1148034 -------- 1180262 -------- 1217697 -------- 1248386 -------- 1280261 -------- 1309862 -------- 1344263 -------- 1370759 -------- 1400003 -------- 1426822 -------- 1460837 -------- 1487680 -------- 1521376 -------- 1551174 -------- 1579779 -------- 1610532 -------- 1638983 -------- 1662660 -------- 1705024 -------- 1728321 -------- 1758757 -------- 1783239 -------- 1813344 -------- 1837573 -------- 1862757 -------- 1885607 -------- 1914340 -------- 1952706 -------- 1979458 -------- 2007302 ------- 2041697 ------- 2069157 -------- 2097383 -------- 2129571 -------- 2168643 -------- 2197223 -------- 2223363 -------- 2256577 -------- 2275975 -------- 2303264 -------- 2336608 -------- 2370823 -------- 2399074 ------- 2433315 ------- 2460771 ------- 2490114 -------- 2522119 -------- 2557218 -------- 2588866 ------- 2616610 -------- 2647296 -------- 2678913 -------- 2704354 -------- 2736743 -------- 2763779 -------- 2789157 ------- 2823812 -------- 2854502 -------- 2889572 -------- 2920263 -------- 2953378 -------- 2982439 -------- 3015013 -------- 3041603 -------- 3076227 -------- 3101125 -------- 3124930 ------- 3152260 -------- 3187366 -------- 3217059 -------- 3248611 -------- 3275008 -------- 3305634 -------- 3342721 -------- 3369702 ------- 3397031 -------- 3428771 -------- 3458885 -------- 3480806 -------- 3513408 -------- 3544129 -------- 3572866 -------- 3596965 -------- 3621794 -------- 3648771 -------- 3674624 -------- 3701510 -------- 3732387 ------- 3767974 -------- 3800224 -------- 3830599 -------- 3861635 -------- 3883808 -------- 3918949 -------- 3953249 -------- 3979456 ------- 4013443 ------- 4036775 -------- 4062148 -------- 4092867 -------- 4124641 -------- 4155333 -------- 4183718 -------- 4213574 ------- 4241445 -------- 4271751 -------- 4304354 -------- 4331590 -------- 4358338 -------- 4383782 -------- 4410791 -------- 4442244 -------- 4467687 -------- 4495876 -------- 4529761 -------- 4565792 -------- 4593991 -------- 4621829 -------- 4657703 ----- 4695878 -------- 4729632 -------- 4762593 -------- 4788581 -------- 4819943 -------- 4850885 -------- 4879777 -------- 4907042 -------- 4932640 ------- 4957638 -------- 4984675 -------- 5020100 -------- 5048481 ------- 5079622 -------- 5109862 -------- 5135363 -------- 5171364 -------- 5197414 -------- 5231104 -------- 5256289 -------- 5297604 -------- 5328038 -------- 5360608 -------- 5386337 -------- 5413315 -------- 5448743 -------- 5472197 -------- 5505440 -------- 5533184 -------- 5565603 ----- 5588963 ------- 5614503 -------- 5640135 -------- 5675008 -------- 5708709 -------- 5735522 ------- 5765862 ------- 5798085 -------- 5830787 ------- 5860867 -------- 5893703 -------- 5931844 -------- 5960706 -------- 5999719 --- 9223372036854775807
      │    │         │   histogram(5)=  0       0        6883.4     286.81     6883.4     573.62     6309.8     717.02     6883.4     860.42     6596.6     860.42     6596.6     430.21     6309.8     717.02     6453.2     1147.2     1075.5     537.76
      │    │         │                <--- '1993-06-30' -------- '1993-07-11' -------- '1993-07-22' -------- '1993-08-02' -------- '1993-08-14' -------- '1993-08-25' -------- '1993-09-05' -------- '1993-09-16' -------- '1993-09-27' -------- '1993-09-30'
      │    │         ├── key: (1)
      │    │         └── fd: (1)-->(5)
      │    └── filters
      │         └── l_commitdate:23 < l_receiptdate:24 [type=bool, outer=(23,24), constraints=(/23: (/NULL - ]; /24: (/NULL - ])]
      └── aggregations
           └── count-rows [as=count_rows:30, type=int]

----Stats for q4_sort_1----
column_names       row_count  distinct_count  null_count
{o_orderpriority}  5          5               0
{order_count}      5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00
{order_count}      4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_group_by_2----
column_names       row_count  distinct_count  null_count
{count_rows}       5          5               0
{o_orderpriority}  5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{count_rows}       4.00           1.25           4.00                1.25                0.00            1.00
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_lookup_join_3----
column_names       row_count  distinct_count  null_count
{o_orderdate}      52523      92              0
{o_orderkey}       52523      52442           0
{o_orderpriority}  52523      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      60122.00       1.14           92.00               1.00                0.00            1.00
{o_orderkey}       60122.00       1.14           60122.00            1.15                0.00            1.00
{o_orderpriority}  60122.00       1.14           4.00                1.25                0.00            1.00

----Stats for q4_index_join_4----
column_names       row_count  distinct_count  null_count
{o_orderdate}      57218      92              0
{o_orderkey}       57218      57218           0
{o_orderpriority}  57218      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      60122.00       1.05           92.00               1.00                0.00            1.00
{o_orderkey}       60122.00       1.05           60122.00            1.05                0.00            1.00
{o_orderpriority}  60122.00       1.05           4.00                1.25                0.00            1.00

----Stats for q4_scan_5----
column_names   row_count  distinct_count  null_count
{o_orderdate}  57218      92              0
{o_orderkey}   57218      57218           0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}  60122.00       1.05           92.00               1.00                0.00            1.00
{o_orderkey}   60122.00       1.05           60122.00            1.05                0.00            1.00
----
----
