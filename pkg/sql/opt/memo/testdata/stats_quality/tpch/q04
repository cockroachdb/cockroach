import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q4
# Order Priority Checking
# Determines how well the order priority system is working and gives an
# assessment of customer satisfaction.
#
# Counts the number of orders ordered in a given quarter of a given year in
# which at least one lineitem was received by the customer later than its
# committed date. The query lists the count of such orders for each order
# priority sorted in ascending priority order.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q4
SELECT
    o_orderpriority,
    count(*) AS order_count
FROM
    orders
WHERE
    o_orderdate >= DATE '1993-07-01'
    AND o_orderdate < DATE '1993-07-01' + INTERVAL '3' MONTH
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem
        WHERE
            l_orderkey = o_orderkey
            AND l_commitDATE < l_receiptdate
    )
GROUP BY
    o_orderpriority
ORDER BY
    o_orderpriority;
----
----
sort
 ├── save-table-name: q4_sort_1
 ├── columns: o_orderpriority:6(char!null) order_count:30(int!null)
 ├── stats: [rows=4, distinct(6)=4, null(6)=0, distinct(30)=4, null(30)=0]
 ├── key: (6)
 ├── fd: (6)-->(30)
 ├── ordering: +6
 └── group-by
      ├── save-table-name: q4_group_by_2
      ├── columns: o_orderpriority:6(char!null) count_rows:30(int!null)
      ├── grouping columns: o_orderpriority:6(char!null)
      ├── stats: [rows=4, distinct(6)=4, null(6)=0, distinct(30)=4, null(30)=0]
      ├── key: (6)
      ├── fd: (6)-->(30)
      ├── semi-join (lookup lineitem)
      │    ├── save-table-name: q4_lookup_join_3
      │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    ├── key columns: [1] = [12]
      │    ├── stats: [rows=56451.9231, distinct(1)=56451.9231, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=4, null(6)=0]
      │    ├── key: (1)
      │    ├── fd: (1)-->(5,6)
      │    ├── index-join orders
      │    │    ├── save-table-name: q4_index_join_4
      │    │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    │    ├── stats: [rows=56451.9231, distinct(1)=56451.9231, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=4, null(6)=0]
      │    │    │   histogram(5)=  0       0        4725      1200      7200      1200      7050      450       6900      1200      6750      600       6900      750       6900      750       3323.1     553.85
      │    │    │                <--- '1993-06-30' ------ '1993-07-08' ------ '1993-07-25' ------ '1993-08-06' ------ '1993-08-19' ------ '1993-09-01' ------ '1993-09-13' ------ '1993-09-23' -------- '1993-09-30'
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    └── scan orders@o_od
      │    │         ├── save-table-name: q4_scan_5
      │    │         ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null)
      │    │         ├── constraint: /5/1: [/'1993-07-01' - /'1993-09-30']
      │    │         ├── stats: [rows=56451.9231, distinct(1)=56451.9231, null(1)=0, distinct(5)=92, null(5)=0]
      │    │         │   histogram(1)=  0           0            0 0.037635 281.02 0.037635 285.57 0.037635 283.61 0.037635 289.94 0.037635 280.72 0.037635 285.35 0.037635 275.18 0.037635 287.75 0.037635 276.24 0.037635 281.24 0.037635 280.38 0.037635 273.98 0.037635 286.81 0.037635 280.57 0.037635 283.09 0.037635 279.89 0.037635 282.33 0.037635 286.51 0.037635 272.55 0.037635 281.54 0.037635 282.97 0.037635 284.97 0.037635 282.18 0.037635 282.97 0.037635 283.54 0.037635 285.01 0.037635 283.01 0.037635 275.97 0.037635 286.21 0.037635 286.7 0.037635 278.61 0.037635 272.17 0.037635 284.37 0.037635 276.2 0.037635  285.5 0.037635  285.16 0.037635  283.88 0.037635  274.85 0.037635  281.43 0.037635  289.71 0.037635  283.16 0.037635  277.82 0.037635  276.92 0.037635  288.43 0.037635  282.33 0.037635  276.61 0.037635  292.57 0.037635  281.02 0.037635  278.04 0.037635  286.7 0.037635  281.09 0.037635  276.76 0.037635  277.97 0.037635  285.5 0.037635  277.74 0.037635  282.6 0.037635  284.78 0.037635  289.6 0.037635  285.87 0.037635  282 0.037635  292.38 0.037635  281.09 0.037635  290.13 0.037635  285.42 0.037635  281.02 0.037635  285.99 0.037635  275.52 0.037635  277.29 0.037635  284.52 0.037635  282.79 0.037635  279.78 0.037635  293.74 0.037635  277.74 0.037635  279.7 0.037635  288.43 0.037635  291.52 0.037635  287.19 0.037635  281.36 0.037635  277.93 0.037635  285.76 0.037635  287.53 0.037635  285.76 0.037635  290.73 0.037635  287.79 0.037635  280.94 0.037635  282.79 0.037635  271.61 0.037635  276.24 0.037635  287.87 0.037635  283.16 0.037635  281.66 0.037635  276.95 0.037635  285.01 0.037635  276.61 0.037635  281.96 0.037635  282.18 0.037635  282.64 0.037635  275.9 0.037635  284.1 0.037635  282.71 0.037635  281.66 0.037635  287.27 0.037635  282.9 0.037635  281.02 0.037635  278.38 0.037635  285.46 0.037635  282.18 0.037635  297.16 0.037635  282.45 0.037635  279.25 0.037635  288.96 0.037635  293.29 0.037635  277.93 0.037635  277.93 0.037635  279.47 0.037635  286.36 0.037635  280.83 0.037635  276.43 0.037635  278.23 0.037635  283.65 0.037635  277.56 0.037635  274.85 0.037635  274.66 0.037635  283.43 0.037635  276.01 0.037635  279.89 0.037635  282.64 0.037635  284.07 0.037635  280 0.037635  275.49 0.037635  280.68 0.037635  290.8 0.037635  277.48 0.037635  282.9 0.037635  273.11 0.037635  278.5 0.037635  282.07 0.037635  281.17 0.037635  290.77 0.037635  280.53 0.037635  284.48 0.037635  277.33 0.037635  281.88 0.037635  284.63 0.037635  287.04 0.037635  279.74 0.037635  277.48 0.037635  282.79 0.037635  288.66 0.037635  282.37 0.037635  287.9 0.037635  282.11 0.037635  284.22 0.037635  279.96 0.037635  287.57 0.037635  282.33 0.037635  282.71 0.037635  282.22 0.037635  286.63 0.037635  281.13 0.037635  292.72 0.037635  289.9 0.037635  291.74 0.037635  284.03 0.037635  287.75 0.037635  286.85 0.037635  288.13 0.037635  282.07 0.037635  288.88 0.037635  295.06 0.037635  287.94 0.037635  291.93 0.037635  292.08 0.037635  292.83 0.037635  289.82 0.037635  281.96 0.037635  286.14 0.037635  282.41 0.037635  295.62 0.037635  295.09 0.037635  282.3 0.037635  291.86 0.037635  278.8 0.037635  282.75 0.037635  291.03 0.037635  278.53 0.037635  289 0.037635  280.42 0.037635  287.15 0.037635  285.04 0.037635  289.97 0.037635  288.77 0.037635  303.07 0.037635  295.32 0.037635  289.75 0.037635  287.94 0.037635  291.29 0.037635  295.06 0.037635  288.54 0.037635  0           0
      │    │         │                <--- -9223372036854775808 ---- 101 ---------- 29157 --------- 61863 --------- 92999 --------- 129156 -------- 157991 -------- 190502 -------- 214884 -------- 249314 -------- 274532 -------- 303776 -------- 332320 -------- 355714 -------- 389377 -------- 418086 -------- 448803 -------- 476966 -------- 507076 -------- 540513 -------- 562754 -------- 592226 -------- 622853 -------- 655073 -------- 685059 -------- 715683 -------- 746757 -------- 779008 -------- 809670 -------- 834690 -------- 867879 ------- 901479 -------- 928615 -------- 950533 -------- 982278 ------- 1007489 ------- 1040134 -------- 1072484 -------- 1103842 -------- 1127938 -------- 1157319 -------- 1193281 -------- 1224068 -------- 1250567 -------- 1276354 -------- 1311328 -------- 1341440 -------- 1366977 -------- 1405216 -------- 1434274 -------- 1460965 ------- 1494564 -------- 1523686 -------- 1549351 -------- 1575968 ------- 1608611 -------- 1635047 ------- 1665378 -------- 1697440 ------- 1733315 -------- 1766247 ----- 1796096 -------- 1834183 -------- 1863302 -------- 1899591 -------- 1932163 -------- 1961216 -------- 1994246 -------- 2018885 -------- 2044965 -------- 2076805 -------- 2107271 -------- 2135332 -------- 2174497 -------- 2200929 ------- 2228928 -------- 2263876 -------- 2301283 -------- 2335268 -------- 2364615 -------- 2391201 -------- 2424034 -------- 2458275 -------- 2491110 -------- 2527878 -------- 2562343 -------- 2591331 -------- 2621792 -------- 2643264 -------- 2668485 -------- 2703013 -------- 2733795 -------- 2763365 -------- 2789154 -------- 2821410 -------- 2846946 -------- 2876774 -------- 2906755 -------- 2937121 ------- 2962086 ------- 2993602 -------- 3024004 -------- 3053568 -------- 3087618 ------- 3118176 -------- 3147237 -------- 3174180 -------- 3206791 -------- 3236775 -------- 3278628 -------- 3308834 -------- 3336486 -------- 3371879 -------- 3410690 -------- 3437284 -------- 3463873 -------- 3491715 -------- 3525026 -------- 3553926 -------- 3579297 -------- 3606117 -------- 3637285 -------- 3663559 -------- 3687650 -------- 3711588 -------- 3742565 -------- 3767622 -------- 3795781 -------- 3826148 -------- 3857635 ----- 3885890 -------- 3910499 -------- 3939297 ------- 3976133 -------- 4002372 ------- 4032928 -------- 4055618 ------- 4082657 -------- 4112550 -------- 4141734 -------- 4178532 -------- 4207203 -------- 4239013 -------- 4265127 -------- 4294885 -------- 4326821 -------- 4360679 -------- 4388710 -------- 4414947 -------- 4445413 -------- 4480550 -------- 4510688 ------- 4541253 -------- 4567175 -------- 4594788 -------- 4618983 -------- 4649284 -------- 4675396 -------- 4701797 -------- 4727808 -------- 4757344 -------- 4782470 -------- 4816867 ------- 4849026 -------- 4882661 -------- 4910144 -------- 4940582 -------- 4970307 -------- 5001057 -------- 5026949 -------- 5058309 -------- 5094560 -------- 5125156 -------- 5158945 -------- 5192832 -------- 5227332 -------- 5259426 -------- 5285222 -------- 5314368 -------- 5340545 -------- 5377254 -------- 5413540 ------- 5439617 -------- 5473345 ------- 5496579 -------- 5523009 -------- 5556065 -------- 5579106 ----- 5610562 -------- 5635110 -------- 5665088 -------- 5693382 -------- 5725604 -------- 5756865 -------- 5799463 -------- 5835940 -------- 5867972 -------- 5898564 -------- 5931842 -------- 5968099 -------- 5999174 --- 9223372036854775807
      │    │         │   histogram(5)=  0       0        4725      1200      7200      1200      7050      450       6900      1200      6750      600       6900      750       6900      750       3323.1     553.85
      │    │         │                <--- '1993-06-30' ------ '1993-07-08' ------ '1993-07-25' ------ '1993-08-06' ------ '1993-08-19' ------ '1993-09-01' ------ '1993-09-13' ------ '1993-09-23' -------- '1993-09-30'
      │    │         ├── key: (1)
      │    │         └── fd: (1)-->(5)
      │    └── filters
      │         └── l_commitdate:23 < l_receiptdate:24 [type=bool, outer=(23,24), constraints=(/23: (/NULL - ]; /24: (/NULL - ])]
      └── aggregations
           └── count-rows [as=count_rows:30, type=int]

----Stats for q4_sort_1----
column_names       row_count  distinct_count  null_count
{o_orderpriority}  5          5               0
{order_count}      5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00
{order_count}      4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_group_by_2----
column_names       row_count  distinct_count  null_count
{count_rows}       5          5               0
{o_orderpriority}  5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{count_rows}       4.00           1.25           4.00                1.25                0.00            1.00
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_lookup_join_3----
column_names       row_count  distinct_count  null_count
{o_orderdate}      52523      92              0
{o_orderkey}       52523      52442           0
{o_orderpriority}  52523      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      56452.00       1.07           92.00               1.00                0.00            1.00
{o_orderkey}       56452.00       1.07           56452.00            1.08                0.00            1.00
{o_orderpriority}  56452.00       1.07           4.00                1.25                0.00            1.00

----Stats for q4_index_join_4----
column_names       row_count  distinct_count  null_count
{o_orderdate}      57218      92              0
{o_orderkey}       57218      57392           0
{o_orderpriority}  57218      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      56452.00       1.01           92.00               1.00                0.00            1.00
{o_orderkey}       56452.00       1.01           56452.00            1.02                0.00            1.00
{o_orderpriority}  56452.00       1.01           4.00                1.25                0.00            1.00

----Stats for q4_scan_5----
column_names   row_count  distinct_count  null_count
{o_orderdate}  57218      92              0
{o_orderkey}   57218      57392           0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}  56452.00       1.01           92.00               1.00                0.00            1.00
{o_orderkey}   56452.00       1.01           56452.00            1.02                0.00            1.00
----
----
