import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q4
# Order Priority Checking
# Determines how well the order priority system is working and gives an
# assessment of customer satisfaction.
#
# Counts the number of orders ordered in a given quarter of a given year in
# which at least one lineitem was received by the customer later than its
# committed date. The query lists the count of such orders for each order
# priority sorted in ascending priority order.
# --------------------------------------------------
save-tables database=tpch save-tables-prefix=q4
SELECT
    o_orderpriority,
    count(*) AS order_count
FROM
    orders
WHERE
    o_orderdate >= DATE '1993-07-01'
    AND o_orderdate < DATE '1993-07-01' + INTERVAL '3' MONTH
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem
        WHERE
            l_orderkey = o_orderkey
            AND l_commitDATE < l_receiptdate
    )
GROUP BY
    o_orderpriority
ORDER BY
    o_orderpriority;
----
sort
 ├── save-table-name: q4_sort_1
 ├── columns: o_orderpriority:6(char!null) order_count:28(int!null)
 ├── stats: [rows=5, distinct(6)=5, null(6)=0, distinct(28)=5, null(28)=0]
 ├── key: (6)
 ├── fd: (6)-->(28)
 ├── ordering: +6
 └── group-by
      ├── save-table-name: q4_group_by_2
      ├── columns: o_orderpriority:6(char!null) count_rows:28(int!null)
      ├── grouping columns: o_orderpriority:6(char!null)
      ├── stats: [rows=5, distinct(6)=5, null(6)=0, distinct(28)=5, null(28)=0]
      ├── key: (6)
      ├── fd: (6)-->(28)
      ├── semi-join (lookup lineitem)
      │    ├── save-table-name: q4_lookup_join_3
      │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    ├── key columns: [1] = [11]
      │    ├── stats: [rows=61200, distinct(1)=61200, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=5, null(6)=0]
      │    ├── key: (1)
      │    ├── fd: (1)-->(5,6)
      │    ├── index-join orders
      │    │    ├── save-table-name: q4_index_join_4
      │    │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    │    ├── stats: [rows=61200, distinct(1)=61200, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=5, null(6)=0]
      │    │    │   histogram(5)=  0      450       6750      600       6600      900       7050      1200      6600      1200      7050      750       6600      900       6750      600       6545.5     654.55
      │    │    │                <--- '1993-07-01' ------ '1993-07-12' ------ '1993-07-24' ------ '1993-08-05' ------ '1993-08-16' ------ '1993-08-29' ------ '1993-09-08' ------ '1993-09-19' -------- '1993-09-30'
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    └── scan orders@o_od
      │    │         ├── save-table-name: q4_scan_5
      │    │         ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null)
      │    │         ├── constraint: /5/1: [/'1993-07-01' - /'1993-09-30']
      │    │         ├── stats: [rows=61200, distinct(1)=61200, null(1)=0, distinct(5)=92, null(5)=0]
      │    │         │   histogram(1)=  0 6.12  299.88  6.12   299.88  6.12   299.88  6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12   299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    299.88   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12    306   6.12
      │    │         │                <--- 998 -------- 26593 -------- 56613 -------- 85827 -------- 115587 -------- 140512 -------- 167076 -------- 198882 -------- 228580 -------- 262243 -------- 292064 -------- 316161 -------- 344194 -------- 368550 -------- 402722 -------- 434529 -------- 468807 -------- 495107 -------- 526338 -------- 563239 -------- 597733 -------- 641894 -------- 665730 -------- 688742 -------- 721767 -------- 750050 -------- 787879 -------- 814565 -------- 837381 -------- 866657 -------- 902855 -------- 927172 -------- 952772 -------- 975840 -------- 1008646 -------- 1032066 -------- 1074656 -------- 1104896 -------- 1138369 -------- 1166689 -------- 1194912 -------- 1225222 -------- 1253284 -------- 1284803 -------- 1318499 -------- 1348609 -------- 1376609 -------- 1404933 -------- 1435745 -------- 1460325 -------- 1491648 -------- 1518852 -------- 1542567 -------- 1574277 -------- 1597958 -------- 1624964 -------- 1647555 -------- 1683651 -------- 1717189 -------- 1750563 -------- 1784775 -------- 1812449 -------- 1838850 -------- 1867751 -------- 1891783 -------- 1918790 -------- 1949827 -------- 1986021 -------- 2020134 -------- 2045829 -------- 2077894 -------- 2118912 -------- 2143264 -------- 2176486 -------- 2204838 -------- 2234146 -------- 2260484 -------- 2288512 -------- 2317121 -------- 2344321 -------- 2362567 -------- 2396133 -------- 2423623 -------- 2454884 -------- 2483879 -------- 2520162 -------- 2545574 -------- 2571874 -------- 2608417 -------- 2637477 -------- 2665607 -------- 2692231 -------- 2724261 -------- 2764451 -------- 2798656 -------- 2824775 -------- 2858690 -------- 2881990 -------- 2911814 -------- 2945056 -------- 2981315 -------- 3010306 -------- 3032320 -------- 3064389 -------- 3084166 -------- 3108832 -------- 3136032 -------- 3168484 -------- 3204039 -------- 3229922 -------- 3256549 -------- 3283169 -------- 3315236 -------- 3346756 -------- 3375879 -------- 3408007 -------- 3441827 -------- 3471204 -------- 3505414 -------- 3527938 -------- 3562561 -------- 3598630 -------- 3627270 -------- 3659266 -------- 3686468 -------- 3713505 -------- 3750817 -------- 3777696 -------- 3808129 -------- 3834533 -------- 3871968 -------- 3904931 -------- 3934215 -------- 3960643 -------- 3990336 -------- 4023203 -------- 4057826 -------- 4090691 -------- 4121216 -------- 4159681 -------- 4190726 -------- 4222624 -------- 4246567 -------- 4283653 -------- 4314339 -------- 4342592 -------- 4373829 -------- 4402372 -------- 4431332 -------- 4464452 -------- 4496327 ----- 4526789 ----- 4551109 ----- 4582401 ----- 4615974 ----- 4648482 ----- 4669601 ----- 4705891 ----- 4732869 ----- 4766145 ----- 4805862 ----- 4840677 ----- 4866787 ----- 4895332 ----- 4928100 ----- 4956323 ----- 4992161 ----- 5027008 ----- 5065797 ----- 5099011 ----- 5130592 ----- 5163463 ----- 5197314 ----- 5224994 ----- 5253892 ----- 5277638 ----- 5307105 ----- 5335750 ----- 5369828 ----- 5402528 ----- 5434183 ----- 5464227 ----- 5491072 ----- 5520679 ----- 5543047 ----- 5576708 ----- 5614951 ----- 5646055 ----- 5674721 ----- 5700295 ----- 5732066 ----- 5761255 ----- 5791233 ----- 5819651 ----- 5852291 ----- 5880258 ----- 5909062 ----- 5943111 ----- 5973926 ----- 5998752
      │    │         │   histogram(5)=  0      450       6750      600       6600      900       7050      1200      6600      1200      7050      750       6600      900       6750      600       6545.5     654.55
      │    │         │                <--- '1993-07-01' ------ '1993-07-12' ------ '1993-07-24' ------ '1993-08-05' ------ '1993-08-16' ------ '1993-08-29' ------ '1993-09-08' ------ '1993-09-19' -------- '1993-09-30'
      │    │         ├── key: (1)
      │    │         └── fd: (1)-->(5)
      │    └── filters
      │         └── l_commitdate:22 < l_receiptdate:23 [type=bool, outer=(22,23), constraints=(/22: (/NULL - ]; /23: (/NULL - ])]
      └── aggregations
           └── count-rows [as=count_rows:28, type=int]

stats table=q4_sort_1
----
column_names       row_count  distinct_count  null_count
{o_orderpriority}  5          5               0
{order_count}      5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderpriority}  5.00           1.00           5.00                1.00                0.00            1.00
{order_count}      5.00           1.00           5.00                1.00                0.00            1.00

stats table=q4_group_by_2
----
column_names       row_count  distinct_count  null_count
{count_rows}       5          5               0
{o_orderpriority}  5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{count_rows}       5.00           1.00           5.00                1.00                0.00            1.00
{o_orderpriority}  5.00           1.00           5.00                1.00                0.00            1.00

stats table=q4_lookup_join_3
----
column_names       row_count  distinct_count  null_count
{o_orderdate}      52523      92              0
{o_orderkey}       52523      52442           0
{o_orderpriority}  52523      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      61200.00       1.17           92.00               1.00                0.00            1.00
{o_orderkey}       61200.00       1.17           61200.00            1.17                0.00            1.00
{o_orderpriority}  61200.00       1.17           5.00                1.00                0.00            1.00

stats table=q4_index_join_4
----
column_names       row_count  distinct_count  null_count
{o_orderdate}      57218      92              0
{o_orderkey}       57218      57392           0
{o_orderpriority}  57218      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      61200.00       1.07           92.00               1.00                0.00            1.00
{o_orderkey}       61200.00       1.07           61200.00            1.07                0.00            1.00
{o_orderpriority}  61200.00       1.07           5.00                1.00                0.00            1.00

stats table=q4_scan_5
----
column_names   row_count  distinct_count  null_count
{o_orderdate}  57218      92              0
{o_orderkey}   57218      57392           0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}  61200.00       1.07           92.00               1.00                0.00            1.00
{o_orderkey}   61200.00       1.07           61200.00            1.07                0.00            1.00
