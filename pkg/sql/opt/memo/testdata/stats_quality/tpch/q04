import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q4
# Order Priority Checking
# Determines how well the order priority system is working and gives an
# assessment of customer satisfaction.
#
# Counts the number of orders ordered in a given quarter of a given year in
# which at least one lineitem was received by the customer later than its
# committed date. The query lists the count of such orders for each order
# priority sorted in ascending priority order.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q4
SELECT
    o_orderpriority,
    count(*) AS order_count
FROM
    orders
WHERE
    o_orderdate >= DATE '1993-07-01'
    AND o_orderdate < DATE '1993-07-01' + INTERVAL '3' MONTH
    AND EXISTS (
        SELECT
            *
        FROM
            lineitem
        WHERE
            l_orderkey = o_orderkey
            AND l_commitDATE < l_receiptdate
    )
GROUP BY
    o_orderpriority
ORDER BY
    o_orderpriority;
----
----
sort
 ├── save-table-name: q4_sort_1
 ├── columns: o_orderpriority:6(char!null) order_count:30(int!null)
 ├── stats: [rows=4, distinct(6)=4, null(6)=0, distinct(30)=4, null(30)=0]
 ├── key: (6)
 ├── fd: (6)-->(30)
 ├── ordering: +6
 └── group-by
      ├── save-table-name: q4_group_by_2
      ├── columns: o_orderpriority:6(char!null) count_rows:30(int!null)
      ├── grouping columns: o_orderpriority:6(char!null)
      ├── stats: [rows=4, distinct(6)=4, null(6)=0, distinct(30)=4, null(30)=0]
      ├── key: (6)
      ├── fd: (6)-->(30)
      ├── semi-join (lookup lineitem)
      │    ├── save-table-name: q4_lookup_join_3
      │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    ├── key columns: [1] = [12]
      │    ├── stats: [rows=62887.5, distinct(1)=62887.5, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=4, null(6)=0]
      │    ├── key: (1)
      │    ├── fd: (1)-->(5,6)
      │    ├── index-join orders
      │    │    ├── save-table-name: q4_index_join_4
      │    │    ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null) o_orderpriority:6(char!null)
      │    │    ├── stats: [rows=62887.5, distinct(1)=62887.5, null(1)=0, distinct(5)=92, null(5)=0, distinct(6)=4, null(6)=0]
      │    │    │   histogram(5)=  0       0        7200      300       7200      600       6600      750       7200      900       6900      900       6900      450       6600      750       6750      1200      1125     562.5
      │    │    │                <--- '1993-06-30' ------ '1993-07-11' ------ '1993-07-22' ------ '1993-08-02' ------ '1993-08-14' ------ '1993-08-25' ------ '1993-09-05' ------ '1993-09-16' ------ '1993-09-27' ------ '1993-09-30'
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    └── scan orders@o_od
      │    │         ├── save-table-name: q4_scan_5
      │    │         ├── columns: o_orderkey:1(int!null) o_orderdate:5(date!null)
      │    │         ├── constraint: /5/1: [/'1993-07-01' - /'1993-09-30']
      │    │         ├── stats: [rows=62887.5, distinct(1)=62887.5, null(1)=0, distinct(5)=92, null(5)=0]
      │    │         │   histogram(1)=  0           0            0 0.041924 312.84 0.041924 305.46 0.041924 316.32 0.041924 318.21 0.041924 302.82 0.041924 307.1 0.041924 314.73 0.041924 308.23 0.041924 326.09 0.041924 317.66 0.041924 324.16 0.041924 322.61 0.041924 318.08 0.041924 317.37 0.041924 325.25 0.041924 319.67 0.041924 314.73 0.041924 303.78 0.041924 327.89 0.041924 316.11 0.041924 312.59 0.041924 318.21 0.041924 324.54 0.041924 318.83 0.041924 323.28 0.041924 323.24 0.041924 323.19 0.041924 314.05 0.041924 315.61 0.041924 307.39 0.041924 306.55 0.041924 317.66 0.041924  316.36 0.041924  305.12 0.041924  309.95 0.041924  314.81 0.041924  319.59 0.041924  317.87 0.041924  326 0.041924  315.44 0.041924  317.32 0.041924  313.76 0.041924  321.27 0.041924  308.94 0.041924  313.22 0.041924  309.44 0.041924  320.64 0.041924  309.48 0.041924  320.13 0.041924  314.05 0.041924  312.21 0.041924  315.56 0.041924  312 0.041924  304.62 0.041924  333.76 0.041924  304.03 0.041924  315.06 0.041924  305.84 0.041924  314.56 0.041924  305.46 0.041924  306.93 0.041924  303.36 0.041924  312.42 0.041924  327.47 0.041924  309.36 0.041924  311.04 0.041924  321.22 0.041924  310.45 0.041924  311.62 0.041924  317.79 0.041924  328.56 0.041924  312.17 0.041924  308.39 0.041924  319.38 0.041924  298.12 0.041924  310.2 0.041924  319.59 0.041924  320.97 0.041924  311.66 0.041924  321.01 0.041924  310.45 0.041924  313.38 0.041924  317.49 0.041924  322.36 0.041924  316.95 0.041924  310.87 0.041924  315.44 0.041924  316.91 0.041924  307.35 0.041924  318.12 0.041924  309.78 0.041924  307.22 0.041924  321.64 0.041924  315.44 0.041924  322.31 0.041924  315.48 0.041924  319.25 0.041924  312.92 0.041924  318.41 0.041924  309.11 0.041924  321.6 0.041924  306.51 0.041924  304.83 0.041924  310.24 0.041924  322.36 0.041924  313.93 0.041924  316.82 0.041924  308.81 0.041924  315.35 0.041924  325.46 0.041924  309.69 0.041924  310.24 0.041924  317.07 0.041924  314.56 0.041924  301.94 0.041924  318.46 0.041924  315.52 0.041924  312.42 0.041924  305.25 0.041924  306.38 0.041924  309.69 0.041924  307.98 0.041924  309.57 0.041924  315.73 0.041924  323.11 0.041924  317.87 0.041924  314.98 0.041924  315.98 0.041924  302.32 0.041924  322.4 0.041924  321.1 0.041924  308.52 0.041924  320.59 0.041924  304.08 0.041924  307.22 0.041924  315.52 0.041924  317.16 0.041924  315.48 0.041924  311.87 0.041924  314.18 0.041924  311.08 0.041924  314.85 0.041924  318.46 0.041924  310.11 0.041924  309.36 0.041924  307.35 0.041924  309.74 0.041924  316.65 0.041924  307.35 0.041924  311.58 0.041924  325.92 0.041924  329.27 0.041924  317.07 0.041924  316.49 0.041924  329.02 0.041924  332.63 0.041924  325.71 0.041924  324.45 0.041924  313.64 0.041924  321.98 0.041924  321.31 0.041924  318.12 0.041924  315.61 0.041924  313.05 0.041924  312.13 0.041924  315.27 0.041924  328.31 0.041924  317.32 0.041924  321.64 0.041924  320.22 0.041924  312.88 0.041924  329.19 0.041924  313.76 0.041924  325.58 0.041924  312.42 0.041924  337.53 0.041924  320.51 0.041924  323.86 0.041924  313.26 0.041924  315.19 0.041924  328.31 0.041924  309.74 0.041924  324.91 0.041924  316.36 0.041924  323.61 0.041924  309.61 0.041924  312.96 0.041924  313.09 0.041924  327.43 0.041924  325.63 0.041924  314.93 0.041924  320.39 0.041924  323.32 0.041924  324.07 0.041924  319.97 0.041924  324.28 0.041924  332.54 0.041924  318.08 0.041924  333.93 0.041924  0           0
      │    │         │                <--- -9223372036854775808 ---- 1472 --------- 30469 --------- 54689 --------- 85922 --------- 118369 -------- 140867 ------- 166146 -------- 196357 -------- 222375 -------- 259877 -------- 291970 -------- 328227 -------- 363490 -------- 395873 -------- 427783 -------- 464741 -------- 498146 -------- 528358 -------- 551493 -------- 590144 -------- 621254 -------- 650083 -------- 682531 -------- 719041 -------- 751906 -------- 787617 -------- 823298 -------- 858944 -------- 888739 -------- 919527 -------- 944996 -------- 969922 -------- 1002020 -------- 1033280 -------- 1057284 -------- 1084416 -------- 1114693 -------- 1148034 -------- 1180262 ----- 1217697 -------- 1248386 -------- 1280261 -------- 1309862 -------- 1344263 -------- 1370759 -------- 1400003 -------- 1426822 -------- 1460837 -------- 1487680 -------- 1521376 -------- 1551174 -------- 1579779 -------- 1610532 ----- 1638983 -------- 1662660 -------- 1705024 -------- 1728321 -------- 1758757 -------- 1783239 -------- 1813344 -------- 1837573 -------- 1862757 -------- 1885607 -------- 1914340 -------- 1952706 -------- 1979458 -------- 2007302 -------- 2041697 -------- 2069157 -------- 2097383 -------- 2129571 -------- 2168643 -------- 2197223 -------- 2223363 -------- 2256577 -------- 2275975 ------- 2303264 -------- 2336608 -------- 2370823 -------- 2399074 -------- 2433315 -------- 2460771 -------- 2490114 -------- 2522119 -------- 2557218 -------- 2588866 -------- 2616610 -------- 2647296 -------- 2678913 -------- 2704354 -------- 2736743 -------- 2763779 -------- 2789157 -------- 2823812 -------- 2854502 -------- 2889572 -------- 2920263 -------- 2953378 -------- 2982439 -------- 3015013 -------- 3041603 ------- 3076227 -------- 3101125 -------- 3124930 -------- 3152260 -------- 3187366 -------- 3217059 -------- 3248611 -------- 3275008 -------- 3305634 -------- 3342721 -------- 3369702 -------- 3397031 -------- 3428771 -------- 3458885 -------- 3480806 -------- 3513408 -------- 3544129 -------- 3572866 -------- 3596965 -------- 3621794 -------- 3648771 -------- 3674624 -------- 3701510 -------- 3732387 -------- 3767974 -------- 3800224 -------- 3830599 -------- 3861635 -------- 3883808 ------- 3918949 ------- 3953249 -------- 3979456 -------- 4013443 -------- 4036775 -------- 4062148 -------- 4092867 -------- 4124641 -------- 4155333 -------- 4183718 -------- 4213574 -------- 4241445 -------- 4271751 -------- 4304354 -------- 4331590 -------- 4358338 -------- 4383782 -------- 4410791 -------- 4442244 -------- 4467687 -------- 4495876 -------- 4529761 -------- 4565792 -------- 4593991 -------- 4621829 -------- 4657703 -------- 4695878 -------- 4729632 -------- 4762593 -------- 4788581 -------- 4819943 -------- 4850885 -------- 4879777 -------- 4907042 -------- 4932640 -------- 4957638 -------- 4984675 -------- 5020100 -------- 5048481 -------- 5079622 -------- 5109862 -------- 5135363 -------- 5171364 -------- 5197414 -------- 5231104 -------- 5256289 -------- 5297604 -------- 5328038 -------- 5360608 -------- 5386337 -------- 5413315 -------- 5448743 -------- 5472197 -------- 5505440 -------- 5533184 -------- 5565603 -------- 5588963 -------- 5614503 -------- 5640135 -------- 5675008 -------- 5708709 -------- 5735522 -------- 5765862 -------- 5798085 -------- 5830787 -------- 5860867 -------- 5893703 -------- 5931844 -------- 5960706 -------- 5999719 --- 9223372036854775807
      │    │         │   histogram(5)=  0       0        7200      300       7200      600       6600      750       7200      900       6900      900       6900      450       6600      750       6750      1200      1125     562.5
      │    │         │                <--- '1993-06-30' ------ '1993-07-11' ------ '1993-07-22' ------ '1993-08-02' ------ '1993-08-14' ------ '1993-08-25' ------ '1993-09-05' ------ '1993-09-16' ------ '1993-09-27' ------ '1993-09-30'
      │    │         ├── key: (1)
      │    │         └── fd: (1)-->(5)
      │    └── filters
      │         └── l_commitdate:23 < l_receiptdate:24 [type=bool, outer=(23,24), constraints=(/23: (/NULL - ]; /24: (/NULL - ])]
      └── aggregations
           └── count-rows [as=count_rows:30, type=int]

----Stats for q4_sort_1----
column_names       row_count  distinct_count  null_count
{o_orderpriority}  5          5               0
{order_count}      5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00
{order_count}      4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_group_by_2----
column_names       row_count  distinct_count  null_count
{count_rows}       5          5               0
{o_orderpriority}  5          5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{count_rows}       4.00           1.25           4.00                1.25                0.00            1.00
{o_orderpriority}  4.00           1.25           4.00                1.25                0.00            1.00

----Stats for q4_lookup_join_3----
column_names       row_count  distinct_count  null_count
{o_orderdate}      52523      92              0
{o_orderkey}       52523      52442           0
{o_orderpriority}  52523      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      62887.00       1.20           92.00               1.00                0.00            1.00
{o_orderkey}       62887.00       1.20           62887.00            1.20                0.00            1.00
{o_orderpriority}  62887.00       1.20           4.00                1.25                0.00            1.00

----Stats for q4_index_join_4----
column_names       row_count  distinct_count  null_count
{o_orderdate}      57218      92              0
{o_orderkey}       57218      57392           0
{o_orderpriority}  57218      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}      62887.00       1.10           92.00               1.00                0.00            1.00
{o_orderkey}       62887.00       1.10           62887.00            1.10                0.00            1.00
{o_orderpriority}  62887.00       1.10           4.00                1.25                0.00            1.00

----Stats for q4_scan_5----
column_names   row_count  distinct_count  null_count
{o_orderdate}  57218      92              0
{o_orderkey}   57218      57392           0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_orderdate}  62887.00       1.10           92.00               1.00                0.00            1.00
{o_orderkey}   62887.00       1.10           62887.00            1.10                0.00            1.00
----
----
