import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q22
# Global Sales Opportunity
# Identifies geographies where there are customers who may be likely to make a
# purchase.
#
# This query counts how many customers within a specific range of country codes
# have not placed orders for 7 years but who have a greater than average
# “positive” account balance. It also reflects the magnitude of that balance.
# Country code is defined as the first two characters of c_phone.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q22
SELECT
    cntrycode,
    count(*) AS numcust,
    sum(c_acctbal) AS totacctbal
FROM (
    SELECT
        substring(c_phone FROM 1 FOR 2) AS cntrycode,
        c_acctbal
    FROM
        customer
    WHERE
        substring(c_phone FROM 1 FOR 2) in
            ('13', '31', '23', '29', '30', '18', '17')
        AND c_acctbal > (
            SELECT
                avg(c_acctbal)
            FROM
                customer
            WHERE
                c_acctbal > 0.00
                AND substring(c_phone FROM 1 FOR 2) in
                    ('13', '31', '23', '29', '30', '18', '17')
        )
        AND NOT EXISTS (
            SELECT
                *
            FROM
                orders
            WHERE
                o_custkey = c_custkey
        )
    ) AS custsale
GROUP BY
    cntrycode
ORDER BY
    cntrycode;
----
----
sort
 ├── save-table-name: q22_sort_1
 ├── columns: cntrycode:33(string) numcust:34(int!null) totacctbal:35(float!null)
 ├── immutable
 ├── stats: [rows=1e-10, distinct(33)=1e-10, null(33)=0, distinct(34)=1e-10, null(34)=0, distinct(35)=1e-10, null(35)=0]
 ├── key: (33)
 ├── fd: (33)-->(34,35)
 ├── ordering: +33
 └── group-by
      ├── save-table-name: q22_group_by_2
      ├── columns: cntrycode:33(string) count_rows:34(int!null) sum:35(float!null)
      ├── grouping columns: cntrycode:33(string)
      ├── immutable
      ├── stats: [rows=1e-10, distinct(33)=1e-10, null(33)=0, distinct(34)=1e-10, null(34)=0, distinct(35)=1e-10, null(35)=0]
      ├── key: (33)
      ├── fd: (33)-->(34,35)
      ├── project
      │    ├── save-table-name: q22_project_3
      │    ├── columns: cntrycode:33(string) c_acctbal:6(float!null)
      │    ├── immutable
      │    ├── stats: [rows=1e-10, distinct(6)=1e-10, null(6)=0, distinct(33)=1e-10, null(33)=0]
      │    ├── anti-join (lookup orders@o_ck)
      │    │    ├── save-table-name: q22_lookup_join_4
      │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    ├── key columns: [1] = [23]
      │    │    ├── immutable
      │    │    ├── stats: [rows=1e-10, distinct(1)=1e-10, null(1)=0, distinct(5)=1e-10, null(5)=0, distinct(6)=1e-10, null(6)=0]
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    ├── select
      │    │    │    ├── save-table-name: q22_select_5
      │    │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    │    ├── immutable
      │    │    │    ├── stats: [rows=16666.6667, distinct(1)=16658.9936, null(1)=0, distinct(5)=16666.6667, null(5)=0, distinct(6)=16666.6667, null(6)=0]
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(5,6)
      │    │    │    ├── scan customer
      │    │    │    │    ├── save-table-name: q22_scan_6
      │    │    │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    │    │    ├── stats: [rows=150000, distinct(1)=148813, null(1)=0, distinct(5)=150000, null(5)=0, distinct(6)=140426, null(6)=0]
      │    │    │    │    │   histogram(1)=  0  6   743   6    743   6    743   6    743   6    743   6    743   6    743   6    743   6    743   6    743   6    743   6    743   6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6    743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     743    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6     758    6
      │    │    │    │    │                <--- 15 ----- 1000 ----- 1729 ----- 2456 ----- 3206 ----- 3920 ----- 4786 ----- 5439 ----- 6291 ----- 7153 ----- 7946 ----- 8660 ----- 9407 ----- 10188 ----- 11057 ----- 11883 ----- 12613 ----- 13079 ----- 13746 ----- 14565 ----- 15339 ----- 16039 ----- 16761 ----- 17642 ----- 18228 ----- 18900 ----- 19615 ----- 20428 ----- 21262 ----- 22140 ----- 22748 ----- 23463 ----- 24009 ----- 24652 ----- 25302 ----- 26104 ----- 26765 ----- 27632 ----- 28315 ----- 29087 ----- 29832 ----- 30513 ----- 31325 ----- 32135 ----- 32780 ----- 33619 ----- 34517 ----- 35256 ----- 35884 ----- 36581 ----- 37332 ----- 37966 ----- 38867 ----- 39590 ----- 40299 ----- 40935 ----- 41822 ----- 42673 ----- 43542 ----- 44177 ----- 44748 ----- 45436 ----- 46119 ----- 46815 ----- 47432 ----- 48154 ----- 48925 ----- 49891 ----- 50759 ----- 51597 ----- 52433 ----- 53280 ----- 54047 ----- 54845 ----- 55557 ----- 56166 ----- 56919 ----- 57534 ----- 58172 ----- 58810 ----- 59539 ----- 60361 ----- 61113 ----- 61801 ----- 62654 ----- 63290 ----- 64097 ----- 64856 ----- 65647 ----- 66558 ----- 67105 ----- 67872 ----- 68765 ----- 69488 ----- 70125 ----- 70859 ----- 71803 ----- 72392 ----- 73075 ----- 73708 ----- 74531 ----- 75218 ----- 76001 ----- 76750 ----- 77579 ----- 78392 ----- 79144 ----- 80008 ----- 80802 ----- 81583 ----- 82244 ----- 83003 ----- 83797 ----- 84571 ----- 85408 ----- 86133 ----- 86910 ----- 87596 ----- 88237 ----- 89097 ----- 89779 ----- 90398 ----- 91294 ----- 91983 ----- 92821 ----- 93398 ----- 94052 ----- 94745 ----- 95391 ----- 96113 ----- 96654 ----- 97610 ----- 98380 ----- 99120 ----- 99849 ----- 100559 ----- 101056 ----- 101854 ----- 102563 ----- 103156 ----- 103983 ----- 104812 ----- 105543 ----- 106316 ----- 107084 ----- 107798 ----- 108503 ----- 109323 ----- 109960 ----- 110801 ----- 111693 ----- 112407 ----- 113054 ----- 113889 ----- 114649 ----- 115417 ----- 116107 ----- 117012 ----- 117996 ----- 118854 ----- 119571 ----- 120354 ----- 121179 ----- 122060 ----- 122991 ----- 123722 ----- 124487 ----- 125120 ----- 125792 ----- 126373 ----- 127168 ----- 128022 ----- 128657 ----- 129416 ----- 130387 ----- 131238 ----- 131869 ----- 132550 ----- 133313 ----- 134243 ----- 135005 ----- 135781 ----- 136463 ----- 137180 ----- 138038 ----- 138725 ----- 139607 ----- 140320 ----- 141036 ----- 141805 ----- 142350 ----- 143293 ----- 144060 ----- 144806 ----- 145783 ----- 146789 ----- 147534 ----- 148356 ----- 149188 ----- 149969
      │    │    │    │    │   histogram(5)=  0          1          1.5e+05          1
      │    │    │    │    │                <--- '10-100-794-8713' --------- '34-989-972-1815'
      │    │    │    │    │   histogram(6)=  0          15          1.4997e+05        15
      │    │    │    │    │                <--- -995.9600219726562 ------------ 9997.2001953125
      │    │    │    │    ├── key: (1)
      │    │    │    │    └── fd: (1)-->(5,6)
      │    │    │    └── filters
      │    │    │         ├── substring(c_phone:5, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [type=bool, outer=(5), immutable]
      │    │    │         └── gt [type=bool, outer=(6), immutable, subquery, constraints=(/6: (/NULL - ])]
      │    │    │              ├── c_acctbal:6 [type=float]
      │    │    │              └── subquery [type=float]
      │    │    │                   └── scalar-group-by
      │    │    │                        ├── save-table-name: q22_scalar_group_by_7
      │    │    │                        ├── columns: avg:21(float)
      │    │    │                        ├── cardinality: [1 - 1]
      │    │    │                        ├── immutable
      │    │    │                        ├── stats: [rows=1, distinct(21)=1, null(21)=0]
      │    │    │                        ├── key: ()
      │    │    │                        ├── fd: ()-->(21)
      │    │    │                        ├── select
      │    │    │                        │    ├── save-table-name: q22_select_8
      │    │    │                        │    ├── columns: c_phone:15(char!null) c_acctbal:16(float!null)
      │    │    │                        │    ├── immutable
      │    │    │                        │    ├── stats: [rows=45465.9983, distinct(15)=45465.9983, null(15)=0, distinct(16)=45465.9983, null(16)=0]
      │    │    │                        │    │   histogram(16)=  0   0   45461         5
      │    │    │                        │    │                 <--- 0.0 ------- 9997.2001953125
      │    │    │                        │    ├── scan customer
      │    │    │                        │    │    ├── save-table-name: q22_scan_9
      │    │    │                        │    │    ├── columns: c_phone:15(char!null) c_acctbal:16(float!null)
      │    │    │                        │    │    └── stats: [rows=150000, distinct(15)=150000, null(15)=0, distinct(16)=140426, null(16)=0]
      │    │    │                        │    │        histogram(15)=  0          1          1.5e+05          1
      │    │    │                        │    │                      <--- '10-100-794-8713' --------- '34-989-972-1815'
      │    │    │                        │    │        histogram(16)=  0          15          1.4997e+05        15
      │    │    │                        │    │                      <--- -995.9600219726562 ------------ 9997.2001953125
      │    │    │                        │    └── filters
      │    │    │                        │         ├── c_acctbal:16 > 0.0 [type=bool, outer=(16), constraints=(/16: [/5e-324 - ]; tight)]
      │    │    │                        │         └── substring(c_phone:15, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [type=bool, outer=(15), immutable]
      │    │    │                        └── aggregations
      │    │    │                             └── avg [as=avg:21, type=float, outer=(16)]
      │    │    │                                  └── c_acctbal:16 [type=float]
      │    │    └── filters (true)
      │    └── projections
      │         └── substring(c_phone:5, 1, 2) [as=cntrycode:33, type=string, outer=(5), immutable]
      └── aggregations
           ├── count-rows [as=count_rows:34, type=int]
           └── sum [as=sum:35, type=float, outer=(6)]
                └── c_acctbal:6 [type=float]

----Stats for q22_sort_1----
column_names  row_count  distinct_count  null_count
{cntrycode}   7          7               0
{numcust}     7          7               0
{totacctbal}  7          7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{numcust}     0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{totacctbal}  0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_group_by_2----
column_names  row_count  distinct_count  null_count
{cntrycode}   7          7               0
{count_rows}  7          7               0
{sum}         7          7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{count_rows}  0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{sum}         0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_project_3----
column_names  row_count  distinct_count  null_count
{c_acctbal}   6384       6304            0
{cntrycode}   6384       7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_lookup_join_4----
column_names  row_count  distinct_count  null_count
{c_acctbal}   6384       6304            0
{c_custkey}   6384       6359            0
{c_phone}     6384       6428            0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{c_custkey}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{c_phone}     0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_select_5----
column_names  row_count  distinct_count  null_count
{c_acctbal}   19000      18527           0
{c_custkey}   19000      19097           0
{c_phone}     19000      19095           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   16667.00       1.14           16667.00            1.11                0.00            1.00
{c_custkey}   16667.00       1.14           16659.00            1.15                0.00            1.00
{c_phone}     16667.00       1.14           16667.00            1.15                0.00            1.00

----Stats for q22_scan_6----
column_names  row_count  distinct_count  null_count
{c_acctbal}   150000     140628          0
{c_custkey}   150000     148813          0
{c_phone}     150000     150872          0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   150000.00      1.00           140426.00           1.00                0.00            1.00
{c_custkey}   150000.00      1.00           148813.00           1.00                0.00            1.00
{c_phone}     150000.00      1.00           150000.00           1.01                0.00            1.00

----Stats for q22_scalar_group_by_7----
column_names  row_count  distinct_count  null_count
{avg}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg}         1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q22_select_8----
column_names  row_count  distinct_count  null_count
{c_acctbal}   38120      37172           0
{c_phone}     38120      38046           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   45466.00       1.19           45466.00            1.22                0.00            1.00
{c_phone}     45466.00       1.19           45466.00            1.20                0.00            1.00

----Stats for q22_scan_9----
column_names  row_count  distinct_count  null_count
{c_acctbal}   150000     140628          0
{c_phone}     150000     150872          0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   150000.00      1.00           140426.00           1.00                0.00            1.00
{c_phone}     150000.00      1.00           150000.00           1.01                0.00            1.00
----
----
