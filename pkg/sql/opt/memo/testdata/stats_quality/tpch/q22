import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q22
# Global Sales Opportunity
# Identifies geographies where there are customers who may be likely to make a
# purchase.
#
# This query counts how many customers within a specific range of country codes
# have not placed orders for 7 years but who have a greater than average
# “positive” account balance. It also reflects the magnitude of that balance.
# Country code is defined as the first two characters of c_phone.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q22
SELECT
    cntrycode,
    count(*) AS numcust,
    sum(c_acctbal) AS totacctbal
FROM (
    SELECT
        substring(c_phone FROM 1 FOR 2) AS cntrycode,
        c_acctbal
    FROM
        customer
    WHERE
        substring(c_phone FROM 1 FOR 2) in
            ('13', '31', '23', '29', '30', '18', '17')
        AND c_acctbal > (
            SELECT
                avg(c_acctbal)
            FROM
                customer
            WHERE
                c_acctbal > 0.00
                AND substring(c_phone FROM 1 FOR 2) in
                    ('13', '31', '23', '29', '30', '18', '17')
        )
        AND NOT EXISTS (
            SELECT
                *
            FROM
                orders
            WHERE
                o_custkey = c_custkey
        )
    ) AS custsale
GROUP BY
    cntrycode
ORDER BY
    cntrycode;
----
----
sort
 ├── save-table-name: q22_sort_1
 ├── columns: cntrycode:33(string) numcust:34(int!null) totacctbal:35(float!null)
 ├── immutable
 ├── stats: [rows=1e-10, distinct(33)=1e-10, null(33)=0, distinct(34)=1e-10, null(34)=0, distinct(35)=1e-10, null(35)=0]
 ├── key: (33)
 ├── fd: (33)-->(34,35)
 ├── ordering: +33
 └── group-by
      ├── save-table-name: q22_group_by_2
      ├── columns: cntrycode:33(string) count_rows:34(int!null) sum:35(float!null)
      ├── grouping columns: cntrycode:33(string)
      ├── immutable
      ├── stats: [rows=1e-10, distinct(33)=1e-10, null(33)=0, distinct(34)=1e-10, null(34)=0, distinct(35)=1e-10, null(35)=0]
      ├── key: (33)
      ├── fd: (33)-->(34,35)
      ├── project
      │    ├── save-table-name: q22_project_3
      │    ├── columns: cntrycode:33(string) c_acctbal:6(float!null)
      │    ├── immutable
      │    ├── stats: [rows=1e-10, distinct(6)=1e-10, null(6)=0, distinct(33)=1e-10, null(33)=0]
      │    ├── anti-join (lookup orders@o_ck)
      │    │    ├── save-table-name: q22_lookup_join_4
      │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    ├── key columns: [1] = [23]
      │    │    ├── immutable
      │    │    ├── stats: [rows=1e-10, distinct(1)=1e-10, null(1)=0, distinct(5)=1e-10, null(5)=0, distinct(6)=1e-10, null(6)=0]
      │    │    ├── key: (1)
      │    │    ├── fd: (1)-->(5,6)
      │    │    ├── select
      │    │    │    ├── save-table-name: q22_select_5
      │    │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    │    ├── immutable
      │    │    │    ├── stats: [rows=16666.6667, distinct(1)=16658.9936, null(1)=0, distinct(5)=16666.6667, null(5)=0, distinct(6)=16666.6667, null(6)=0]
      │    │    │    ├── key: (1)
      │    │    │    ├── fd: (1)-->(5,6)
      │    │    │    ├── scan customer
      │    │    │    │    ├── save-table-name: q22_scan_6
      │    │    │    │    ├── columns: c_custkey:1(int!null) c_phone:5(char!null) c_acctbal:6(float!null)
      │    │    │    │    ├── stats: [rows=150000, distinct(1)=148813, null(1)=0, distinct(5)=150000, null(5)=0, distinct(6)=140426, null(6)=0]
      │    │    │    │    │   histogram(1)=  0  1   749   1   749   1    749   1    749   1    749   1    749   1    749   1    749   1    749   1    749   1    749   1    749   1    749   1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1    749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     749    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1     764    1
      │    │    │    │    │                <--- 21 ----- 889 ----- 1630 ----- 2510 ----- 3288 ----- 4048 ----- 4613 ----- 5309 ----- 6185 ----- 6839 ----- 7585 ----- 8433 ----- 9072 ----- 9951 ----- 10688 ----- 11318 ----- 12082 ----- 12756 ----- 13494 ----- 14223 ----- 14991 ----- 15850 ----- 16649 ----- 17293 ----- 17965 ----- 18629 ----- 19252 ----- 20030 ----- 20720 ----- 21419 ----- 22133 ----- 22839 ----- 23554 ----- 24273 ----- 25014 ----- 25797 ----- 26521 ----- 27255 ----- 27922 ----- 28610 ----- 29259 ----- 30040 ----- 30631 ----- 31284 ----- 32108 ----- 32900 ----- 33862 ----- 34575 ----- 35158 ----- 36006 ----- 36817 ----- 37506 ----- 38438 ----- 39238 ----- 39968 ----- 40620 ----- 41362 ----- 41985 ----- 42901 ----- 43767 ----- 44513 ----- 45300 ----- 46014 ----- 46785 ----- 47667 ----- 48418 ----- 49060 ----- 49946 ----- 50941 ----- 51695 ----- 52415 ----- 53135 ----- 54031 ----- 54677 ----- 55406 ----- 56349 ----- 57141 ----- 57866 ----- 58667 ----- 59497 ----- 60304 ----- 61048 ----- 61949 ----- 62597 ----- 63500 ----- 64280 ----- 65202 ----- 66108 ----- 66739 ----- 67441 ----- 68383 ----- 69152 ----- 69887 ----- 70590 ----- 71256 ----- 71760 ----- 72246 ----- 72886 ----- 73551 ----- 74412 ----- 75012 ----- 75804 ----- 76485 ----- 77394 ----- 77956 ----- 78641 ----- 79336 ----- 80066 ----- 80849 ----- 81688 ----- 82479 ----- 83170 ----- 83946 ----- 84719 ----- 85620 ----- 86382 ----- 86888 ----- 87542 ----- 88231 ----- 88994 ----- 89678 ----- 90411 ----- 91126 ----- 91842 ----- 92775 ----- 93418 ----- 94042 ----- 94911 ----- 95744 ----- 96582 ----- 97441 ----- 98273 ----- 99071 ----- 99916 ----- 100516 ----- 101399 ----- 102218 ----- 102998 ----- 103731 ----- 104602 ----- 105321 ----- 105975 ----- 106678 ----- 107601 ----- 108304 ----- 109019 ----- 109626 ----- 110410 ----- 110921 ----- 111682 ----- 112462 ----- 112993 ----- 113756 ----- 114505 ----- 115291 ----- 115958 ----- 116844 ----- 117612 ----- 118464 ----- 119146 ----- 120047 ----- 120664 ----- 121344 ----- 122348 ----- 123048 ----- 124034 ----- 124830 ----- 125463 ----- 126302 ----- 126936 ----- 127692 ----- 128413 ----- 129269 ----- 130158 ----- 130992 ----- 131611 ----- 132522 ----- 133328 ----- 134147 ----- 134977 ----- 135823 ----- 136525 ----- 137144 ----- 138055 ----- 138666 ----- 139457 ----- 140262 ----- 141024 ----- 141730 ----- 142362 ----- 143136 ----- 144012 ----- 144747 ----- 145540 ----- 146393 ----- 147010 ----- 147728 ----- 148522 ----- 149204 ----- 149995
      │    │    │    │    │   histogram(5)=  0          1          1.5e+05          1
      │    │    │    │    │                <--- '10-103-964-1832' --------- '34-996-464-1615'
      │    │    │    │    │   histogram(6)=  0          1           1.5e+05         1
      │    │    │    │    │                <--- -998.6799926757812 --------- 9996.7998046875
      │    │    │    │    ├── key: (1)
      │    │    │    │    └── fd: (1)-->(5,6)
      │    │    │    └── filters
      │    │    │         ├── substring(c_phone:5, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [type=bool, outer=(5), immutable]
      │    │    │         └── gt [type=bool, outer=(6), immutable, subquery, constraints=(/6: (/NULL - ])]
      │    │    │              ├── c_acctbal:6 [type=float]
      │    │    │              └── subquery [type=float]
      │    │    │                   └── scalar-group-by
      │    │    │                        ├── save-table-name: q22_scalar_group_by_7
      │    │    │                        ├── columns: avg:21(float)
      │    │    │                        ├── cardinality: [1 - 1]
      │    │    │                        ├── immutable
      │    │    │                        ├── stats: [rows=1, distinct(21)=1, null(21)=0]
      │    │    │                        ├── key: ()
      │    │    │                        ├── fd: ()-->(21)
      │    │    │                        ├── select
      │    │    │                        │    ├── save-table-name: q22_select_8
      │    │    │                        │    ├── columns: c_phone:15(char!null) c_acctbal:16(float!null)
      │    │    │                        │    ├── immutable
      │    │    │                        │    ├── stats: [rows=45458.4066, distinct(15)=45458.4066, null(15)=0, distinct(16)=45458.4066, null(16)=0]
      │    │    │                        │    │   histogram(16)=  0   0   45458      0.33334
      │    │    │                        │    │                 <--- 0.0 ------- 9996.7998046875
      │    │    │                        │    ├── scan customer
      │    │    │                        │    │    ├── save-table-name: q22_scan_9
      │    │    │                        │    │    ├── columns: c_phone:15(char!null) c_acctbal:16(float!null)
      │    │    │                        │    │    └── stats: [rows=150000, distinct(15)=150000, null(15)=0, distinct(16)=140426, null(16)=0]
      │    │    │                        │    │        histogram(15)=  0          1          1.5e+05          1
      │    │    │                        │    │                      <--- '10-103-964-1832' --------- '34-996-464-1615'
      │    │    │                        │    │        histogram(16)=  0          1           1.5e+05         1
      │    │    │                        │    │                      <--- -998.6799926757812 --------- 9996.7998046875
      │    │    │                        │    └── filters
      │    │    │                        │         ├── c_acctbal:16 > 0.0 [type=bool, outer=(16), constraints=(/16: [/5e-324 - ]; tight)]
      │    │    │                        │         └── substring(c_phone:15, 1, 2) IN ('13', '17', '18', '23', '29', '30', '31') [type=bool, outer=(15), immutable]
      │    │    │                        └── aggregations
      │    │    │                             └── avg [as=avg:21, type=float, outer=(16)]
      │    │    │                                  └── c_acctbal:16 [type=float]
      │    │    └── filters (true)
      │    └── projections
      │         └── substring(c_phone:5, 1, 2) [as=cntrycode:33, type=string, outer=(5), immutable]
      └── aggregations
           ├── count-rows [as=count_rows:34, type=int]
           └── sum [as=sum:35, type=float, outer=(6)]
                └── c_acctbal:6 [type=float]

----Stats for q22_sort_1----
column_names  row_count  distinct_count  null_count
{cntrycode}   7          7               0
{numcust}     7          7               0
{totacctbal}  7          7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{numcust}     0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{totacctbal}  0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_group_by_2----
column_names  row_count  distinct_count  null_count
{cntrycode}   7          7               0
{count_rows}  7          7               0
{sum}         7          7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{count_rows}  0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{sum}         0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_project_3----
column_names  row_count  distinct_count  null_count
{c_acctbal}   6384       6304            0
{cntrycode}   6384       7               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{cntrycode}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_lookup_join_4----
column_names  row_count  distinct_count  null_count
{c_acctbal}   6384       6304            0
{c_custkey}   6384       6359            0
{c_phone}     6384       6428            0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{c_custkey}   0.00           +Inf <==       0.00                +Inf <==            0.00            1.00
{c_phone}     0.00           +Inf <==       0.00                +Inf <==            0.00            1.00

----Stats for q22_select_5----
column_names  row_count  distinct_count  null_count
{c_acctbal}   19000      18527           0
{c_custkey}   19000      19097           0
{c_phone}     19000      19095           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   16667.00       1.14           16667.00            1.11                0.00            1.00
{c_custkey}   16667.00       1.14           16659.00            1.15                0.00            1.00
{c_phone}     16667.00       1.14           16667.00            1.15                0.00            1.00

----Stats for q22_scan_6----
column_names  row_count  distinct_count  null_count
{c_acctbal}   150000     140628          0
{c_custkey}   150000     148813          0
{c_phone}     150000     150872          0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   150000.00      1.00           140426.00           1.00                0.00            1.00
{c_custkey}   150000.00      1.00           148813.00           1.00                0.00            1.00
{c_phone}     150000.00      1.00           150000.00           1.01                0.00            1.00

----Stats for q22_scalar_group_by_7----
column_names  row_count  distinct_count  null_count
{avg}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg}         1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q22_select_8----
column_names  row_count  distinct_count  null_count
{c_acctbal}   38120      37172           0
{c_phone}     38120      38046           0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   45458.00       1.19           45458.00            1.22                0.00            1.00
{c_phone}     45458.00       1.19           45458.00            1.19                0.00            1.00

----Stats for q22_scan_9----
column_names  row_count  distinct_count  null_count
{c_acctbal}   150000     140628          0
{c_phone}     150000     150872          0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_acctbal}   150000.00      1.00           140426.00           1.00                0.00            1.00
{c_phone}     150000.00      1.00           150000.00           1.01                0.00            1.00
----
----
