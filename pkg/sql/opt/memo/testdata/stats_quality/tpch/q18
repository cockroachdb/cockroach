import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q18
# Large Volume Customer
# Ranks customers based on their having placed a large quantity order. Large
# quantity orders are defined as those orders whose total quantity is above a
# certain level.
#
# Finds a list of the top 100 customers who have ever placed large quantity
# orders. The query lists the customer name, customer key, the order key, date
# and total price and the quantity for the order.
# --------------------------------------------------
stats-quality database=tpch set=save_tables_prefix=q18
SELECT
    c_name,
    c_custkey,
    o_orderkey,
    o_orderdate,
    o_totalprice,
    sum(l_quantity)
FROM
    customer,
    orders,
    lineitem
WHERE
    o_orderkey IN (
        SELECT
            l_orderkey
        FROM
            lineitem
        GROUP BY
            l_orderkey HAVING
                sum(l_quantity) > 300
    )
    AND c_custkey = o_custkey
    AND o_orderkey = l_orderkey
GROUP BY
    c_name,
    c_custkey,
    o_orderkey,
    o_orderdate,
    o_totalprice
ORDER BY
    o_totalprice DESC,
    o_orderdate
LIMIT 100;
----
----
limit
 ├── save-table-name: q18_limit_1
 ├── columns: c_name:2(varchar!null) c_custkey:1(int!null) o_orderkey:11(int!null) o_orderdate:15(date!null) o_totalprice:14(float!null) sum:60(float!null)
 ├── internal-ordering: -14,+15
 ├── cardinality: [0 - 100]
 ├── stats: [rows=100, distinct(1)=100, null(1)=0, distinct(2)=100, null(2)=0, distinct(11)=100, null(11)=0, distinct(14)=100, null(14)=0, distinct(15)=100, null(15)=0, distinct(60)=100, null(60)=0]
 ├── key: (11)
 ├── fd: (1)-->(2), (11)-->(1,2,14,15,60)
 ├── ordering: -14,+15
 ├── group-by (partial streaming)
 │    ├── save-table-name: q18_group_by_2
 │    ├── columns: c_custkey:1(int!null) c_name:2(varchar!null) o_orderkey:11(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null) sum:60(float!null)
 │    ├── grouping columns: o_orderkey:11(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null)
 │    ├── internal-ordering: -14,+15
 │    ├── stats: [rows=149817.7, distinct(1)=149818, null(1)=0, distinct(2)=149818, null(2)=0, distinct(11)=149818, null(11)=0, distinct(14)=146905, null(14)=0, distinct(15)=2406, null(15)=0, distinct(60)=149818, null(60)=0, distinct(11,14,15)=149818, null(11,14,15)=0]
 │    ├── key: (11)
 │    ├── fd: (1)-->(2), (11)-->(1,2,14,15,60)
 │    ├── ordering: -14,+15
 │    ├── limit hint: 100.00
 │    ├── inner-join (lookup lineitem)
 │    │    ├── save-table-name: q18_lookup_join_3
 │    │    ├── columns: c_custkey:1(int!null) c_name:2(varchar!null) o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null) l_orderkey:22(int!null) l_quantity:26(float!null)
 │    │    ├── key columns: [11] = [22]
 │    │    ├── stats: [rows=604908.3, distinct(1)=79908.3, null(1)=0, distinct(2)=147341, null(2)=0, distinct(11)=149818, null(11)=0, distinct(12)=79908.3, null(12)=0, distinct(14)=146905, null(14)=0, distinct(15)=2406, null(15)=0, distinct(22)=149818, null(22)=0, distinct(26)=50, null(26)=0, distinct(11,14,15)=149818, null(11,14,15)=0]
 │    │    ├── fd: (1)-->(2), (11)-->(12,14,15), (11)==(22), (22)==(11), (1)==(12), (12)==(1)
 │    │    ├── ordering: -14,+15
 │    │    ├── limit hint: 403.76
 │    │    ├── inner-join (lookup customer)
 │    │    │    ├── save-table-name: q18_lookup_join_4
 │    │    │    ├── columns: c_custkey:1(int!null) c_name:2(varchar!null) o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null)
 │    │    │    ├── key columns: [12] = [1]
 │    │    │    ├── lookup columns are key
 │    │    │    ├── stats: [rows=153945.2, distinct(1)=79952.2, null(1)=0, distinct(2)=96250.7, null(2)=0, distinct(11)=96988.4, null(11)=0, distinct(12)=79952.2, null(12)=0, distinct(14)=96928.2, null(14)=0, distinct(15)=2406, null(15)=0]
 │    │    │    ├── key: (11)
 │    │    │    ├── fd: (1)-->(2), (11)-->(12,14,15), (1)==(12), (12)==(1)
 │    │    │    ├── ordering: -14,+15
 │    │    │    ├── limit hint: 200.00
 │    │    │    ├── sort
 │    │    │    │    ├── save-table-name: q18_sort_5
 │    │    │    │    ├── columns: o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null)
 │    │    │    │    ├── stats: [rows=152727, distinct(11)=152727, null(11)=0, distinct(12)=79952.2, null(12)=0, distinct(14)=152502, null(14)=0, distinct(15)=2406, null(15)=0, distinct(11,14,15)=152727, null(11,14,15)=0]
 │    │    │    │    ├── key: (11)
 │    │    │    │    ├── fd: (11)-->(12,14,15)
 │    │    │    │    ├── ordering: -14,+15
 │    │    │    │    ├── limit hint: 200.00
 │    │    │    │    └── project
 │    │    │    │         ├── save-table-name: q18_project_6
 │    │    │    │         ├── columns: o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null)
 │    │    │    │         ├── stats: [rows=152727, distinct(11)=152727, null(11)=0, distinct(12)=79952.2, null(12)=0, distinct(14)=152502, null(14)=0, distinct(15)=2406, null(15)=0, distinct(11,14,15)=152727, null(11,14,15)=0]
 │    │    │    │         ├── key: (11)
 │    │    │    │         ├── fd: (11)-->(12,14,15)
 │    │    │    │         └── project
 │    │    │    │              ├── save-table-name: q18_project_7
 │    │    │    │              ├── columns: o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null) l_orderkey:40(int!null)
 │    │    │    │              ├── stats: [rows=152727, distinct(11)=152727, null(11)=0, distinct(12)=78217.7, null(12)=0, distinct(14)=145006, null(14)=0, distinct(15)=2406, null(15)=0, distinct(40)=152727, null(40)=0]
 │    │    │    │              ├── key: (40)
 │    │    │    │              ├── fd: (11)-->(12,14,15), (11)==(40), (40)==(11)
 │    │    │    │              └── inner-join (lookup orders)
 │    │    │    │                   ├── save-table-name: q18_lookup_join_8
 │    │    │    │                   ├── columns: o_orderkey:11(int!null) o_custkey:12(int!null) o_totalprice:14(float!null) o_orderdate:15(date!null) l_orderkey:40(int!null) sum:58(float!null)
 │    │    │    │                   ├── key columns: [40] = [11]
 │    │    │    │                   ├── lookup columns are key
 │    │    │    │                   ├── stats: [rows=152727, distinct(11)=152727, null(11)=0, distinct(12)=78217.7, null(12)=0, distinct(14)=145006, null(14)=0, distinct(15)=2406, null(15)=0, distinct(40)=152727, null(40)=0, distinct(58)=96541.9, null(58)=0]
 │    │    │    │                   ├── key: (40)
 │    │    │    │                   ├── fd: (11)-->(12,14,15), (40)-->(58), (11)==(40), (40)==(11)
 │    │    │    │                   ├── select
 │    │    │    │                   │    ├── save-table-name: q18_select_9
 │    │    │    │                   │    ├── columns: l_orderkey:40(int!null) sum:58(float!null)
 │    │    │    │                   │    ├── stats: [rows=152727, distinct(40)=152727, null(40)=0, distinct(58)=152727, null(58)=0]
 │    │    │    │                   │    ├── key: (40)
 │    │    │    │                   │    ├── fd: (40)-->(58)
 │    │    │    │                   │    ├── group-by (streaming)
 │    │    │    │                   │    │    ├── save-table-name: q18_group_by_10
 │    │    │    │                   │    │    ├── columns: l_orderkey:40(int!null) sum:58(float!null)
 │    │    │    │                   │    │    ├── grouping columns: l_orderkey:40(int!null)
 │    │    │    │                   │    │    ├── internal-ordering: +40
 │    │    │    │                   │    │    ├── stats: [rows=1527270, distinct(40)=1.52727e+06, null(40)=0, distinct(58)=1.52727e+06, null(58)=0]
 │    │    │    │                   │    │    ├── key: (40)
 │    │    │    │                   │    │    ├── fd: (40)-->(58)
 │    │    │    │                   │    │    ├── scan lineitem
 │    │    │    │                   │    │    │    ├── save-table-name: q18_scan_11
 │    │    │    │                   │    │    │    ├── columns: l_orderkey:40(int!null) l_quantity:44(float!null)
 │    │    │    │                   │    │    │    ├── stats: [rows=6001215, distinct(40)=1.52727e+06, null(40)=0, distinct(44)=50, null(44)=0]
 │    │    │    │                   │    │    │    │   histogram(40)=  0  600  29406   600   29406   600   29406   600   29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    28806   1200   29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406   600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    28806   1200    29406    600    29406    600    29406    600    29406    600    28806   1200    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    29406    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600    30006    600
 │    │    │    │                   │    │    │    │                 <--- 197 ------- 23686 ------- 53253 ------- 90435 ------- 121730 ------- 153280 ------- 175456 ------- 208548 ------- 242209 ------- 273057 ------- 296640 ------- 330307 ------- 360999 ------- 386307 ------- 420225 ------- 450050 ------- 477795 ------- 504711 ------- 533153 ------- 556672 ------- 582243 ------- 613729 ------- 646117 ------- 675840 ------- 706048 ------- 733063 ------- 769282 ------- 793922 ------- 820357 ------- 849536 ------- 875719 ------- 905028 ------- 940643 ------- 968355 ------- 998721 ------- 1023621 ------- 1059424 ------- 1084932 ------- 1115553 ------- 1139363 ------- 1167361 ------- 1194400 ------- 1225984 ------- 1253861 ------- 1281633 ------- 1304999 ------- 1336355 ------- 1370759 ------- 1400832 ------- 1434085 ------- 1458852 ------- 1491427 ------- 1525120 ------- 1555205 ------- 1591300 ------- 1619426 ------- 1651458 ------- 1682950 ------- 1711399 ------- 1747591 ------- 1787205 ------- 1822240 ------- 1856163 ------- 1886915 ------- 1910949 ------- 1947202 ------- 1974311 ------- 2009286 ------- 2044034 ------- 2079104 ------- 2103488 ------- 2134657 ------- 2164293 ------- 2204514 ------- 2230823 ------- 2265253 ------- 2289826 ------- 2329539 ------- 2364455 ------- 2393507 ------- 2414628 ------- 2440228 ------- 2465255 ------- 2489568 ------- 2520900 ------- 2554919 ------- 2583333 ------- 2612966 ------- 2644833 ------- 2667362 ------- 2702784 ------- 2727394 ------- 2759748 ------- 2794531 ------- 2822214 ------- 2846624 ------- 2883748 ------- 2919586 ------- 2951908 ------- 2980068 ------- 3014726 ------- 3050725 ------- 3081028 ------- 3113351 ------- 3150243 ------- 3185669 ------- 3214311 ------- 3241281 ------- 3275748 ------- 3303232 ------- 3339559 ------- 3370627 ------- 3393664 ------- 3435265 ------- 3464581 ------- 3489026 ------- 3516096 ------- 3548480 ------- 3587015 ------- 3611239 ------- 3638724 ------- 3668641 ------- 3695751 ------- 3729636 ------- 3751523 ------- 3784608 ------- 3815715 ------- 3848608 ------- 3881184 ------- 3908738 ------- 3940002 ------- 3966176 ------- 4001984 ------- 4035687 ------- 4065283 ------- 4092834 ------- 4133062 ------- 4160613 ------- 4196421 ------- 4223713 ------- 4254788 ------- 4291040 ------- 4313664 ------- 4342823 ------- 4369952 ------- 4391684 ------- 4419040 ------- 4449921 ------- 4471781 ------- 4506210 ------- 4538176 ------- 4571297 ------- 4601121 ------- 4630887 ------- 4657476 ------- 4684803 ------- 4714566 ------- 4744070 ------- 4776385 ------- 4807777 ------- 4839491 ------- 4873953 ------- 4902245 ------- 4936263 ------- 4970721 ------- 5003140 ------- 5029729 ------- 5059010 ------- 5087521 ------- 5121093 ------- 5150405 ------- 5178375 ------- 5203683 ------- 5234531 ------- 5268195 ------- 5300004 ------- 5331558 ------- 5362178 ------- 5385762 ------- 5418498 ------- 5445762 ------- 5483109 ------- 5514561 ------- 5542052 ------- 5569572 ------- 5596102 ------- 5622401 ------- 5652194 ------- 5671362 ------- 5699591 ------- 5727136 ------- 5753284 ------- 5780742 ------- 5809189 ------- 5836545 ------- 5864454 ------- 5894917 ------- 5933825 ------- 5968933 ------- 5999590
 │    │    │    │                   │    │    │    │   histogram(44)=  0 1.1342e+05 5.766e+06 1.2182e+05
 │    │    │    │                   │    │    │    │                 <----- 1.0 ---------------- 50.0 --
 │    │    │    │                   │    │    │    └── ordering: +40
 │    │    │    │                   │    │    └── aggregations
 │    │    │    │                   │    │         └── sum [as=sum:58, type=float, outer=(44)]
 │    │    │    │                   │    │              └── l_quantity:44 [type=float]
 │    │    │    │                   │    └── filters
 │    │    │    │                   │         └── sum:58 > 300.0 [type=bool, outer=(58), constraints=(/58: [/300.00000000000006 - ]; tight)]
 │    │    │    │                   └── filters (true)
 │    │    │    └── filters (true)
 │    │    └── filters (true)
 │    └── aggregations
 │         ├── sum [as=sum:60, type=float, outer=(26)]
 │         │    └── l_quantity:26 [type=float]
 │         ├── const-agg [as=c_custkey:1, type=int, outer=(1)]
 │         │    └── c_custkey:1 [type=int]
 │         └── const-agg [as=c_name:2, type=varchar, outer=(2)]
 │              └── c_name:2 [type=varchar]
 └── 100 [type=int]

----Stats for q18_limit_1----
column_names    row_count  distinct_count  null_count
{c_custkey}     57         57              0
{c_name}        57         57              0
{o_orderdate}   57         57              0
{o_orderkey}    57         57              0
{o_totalprice}  57         57              0
{sum}           57         18              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_custkey}     100.00         1.75           100.00              1.75                0.00            1.00
{c_name}        100.00         1.75           100.00              1.75                0.00            1.00
{o_orderdate}   100.00         1.75           100.00              1.75                0.00            1.00
{o_orderkey}    100.00         1.75           100.00              1.75                0.00            1.00
{o_totalprice}  100.00         1.75           100.00              1.75                0.00            1.00
{sum}           100.00         1.75           100.00              5.56 <==            0.00            1.00

----Stats for q18_group_by_2----
column_names    row_count  distinct_count  null_count
{c_custkey}     57         57              0
{c_name}        57         57              0
{o_orderdate}   57         57              0
{o_orderkey}    57         57              0
{o_totalprice}  57         57              0
{sum}           57         18              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_custkey}     149818.00      2628.39 <==    149818.00           2628.39 <==         0.00            1.00
{c_name}        149818.00      2628.39 <==    149818.00           2628.39 <==         0.00            1.00
{o_orderdate}   149818.00      2628.39 <==    2406.00             42.21 <==           0.00            1.00
{o_orderkey}    149818.00      2628.39 <==    149818.00           2628.39 <==         0.00            1.00
{o_totalprice}  149818.00      2628.39 <==    146905.00           2577.28 <==         0.00            1.00
{sum}           149818.00      2628.39 <==    149818.00           8323.22 <==         0.00            1.00

----Stats for q18_lookup_join_3----
column_names    row_count  distinct_count  null_count
{c_custkey}     399        57              0
{c_name}        399        57              0
{l_orderkey}    399        57              0
{l_quantity}    399        27              0
{o_custkey}     399        57              0
{o_orderdate}   399        57              0
{o_orderkey}    399        57              0
{o_totalprice}  399        57              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_custkey}     604908.00      1516.06 <==    79908.00            1401.89 <==         0.00            1.00
{c_name}        604908.00      1516.06 <==    147341.00           2584.93 <==         0.00            1.00
{l_orderkey}    604908.00      1516.06 <==    149818.00           2628.39 <==         0.00            1.00
{l_quantity}    604908.00      1516.06 <==    50.00               1.85                0.00            1.00
{o_custkey}     604908.00      1516.06 <==    79908.00            1401.89 <==         0.00            1.00
{o_orderdate}   604908.00      1516.06 <==    2406.00             42.21 <==           0.00            1.00
{o_orderkey}    604908.00      1516.06 <==    149818.00           2628.39 <==         0.00            1.00
{o_totalprice}  604908.00      1516.06 <==    146905.00           2577.28 <==         0.00            1.00

----Stats for q18_lookup_join_4----
column_names    row_count  distinct_count  null_count
{c_custkey}     57         57              0
{c_name}        57         57              0
{o_custkey}     57         57              0
{o_orderdate}   57         57              0
{o_orderkey}    57         57              0
{o_totalprice}  57         57              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{c_custkey}     153945.00      2700.79 <==    79952.00            1402.67 <==         0.00            1.00
{c_name}        153945.00      2700.79 <==    96251.00            1688.61 <==         0.00            1.00
{o_custkey}     153945.00      2700.79 <==    79952.00            1402.67 <==         0.00            1.00
{o_orderdate}   153945.00      2700.79 <==    2406.00             42.21 <==           0.00            1.00
{o_orderkey}    153945.00      2700.79 <==    96988.00            1701.54 <==         0.00            1.00
{o_totalprice}  153945.00      2700.79 <==    96928.00            1700.49 <==         0.00            1.00

----Stats for q18_sort_5----
column_names    row_count  distinct_count  null_count
{o_custkey}     57         57              0
{o_orderdate}   57         57              0
{o_orderkey}    57         57              0
{o_totalprice}  57         57              0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{o_custkey}     152727.00      2679.42 <==    79952.00            1402.67 <==         0.00            1.00
{o_orderdate}   152727.00      2679.42 <==    2406.00             42.21 <==           0.00            1.00
{o_orderkey}    152727.00      2679.42 <==    152727.00           2679.42 <==         0.00            1.00
{o_totalprice}  152727.00      2679.42 <==    152502.00           2675.47 <==         0.00            1.00

----Stats for q18_project_6----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.

----Stats for q18_project_7----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.

----Stats for q18_lookup_join_8----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.

----Stats for q18_select_9----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.

----Stats for q18_group_by_10----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.

----Stats for q18_scan_11----
WARNING: No previous statistics output was found. To collect actual statistics,
run with the rewrite-actual-stats flag set to true.
----
----
