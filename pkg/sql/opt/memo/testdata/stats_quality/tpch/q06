import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q6
# Forecasting Revenue Change
# Quantifies the amount of revenue increase that would have resulted from
# eliminating certain companywide discounts in a given percentage range in a
# given year. Asking this type of "what if" query can be used to look for ways
# to increase revenues.
#
# Considers all the lineitems shipped in a given year with discounts between
# DISCOUNT-0.01 and DISCOUNT+0.01. The query lists the amount by which the total
# revenue would have increased if these discounts had been eliminated for
# lineitems with l_quantity less than quantity. Note that the potential revenue
# increase is equal to the sum of [l_extendedprice * l_discount] for all
# lineitems with discounts and quantities in the qualifying range.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q6
SELECT
    sum(l_extendedprice * l_discount) AS revenue
FROM
    lineitem
WHERE
    l_shipdate >= DATE '1994-01-01'
    AND l_shipdate < DATE '1994-01-01' + INTERVAL '1' YEAR
    AND l_discount BETWEEN 0.06 - 0.01 AND 0.06 + 0.01
    AND l_quantity < 24;
----
----
scalar-group-by
 ├── save-table-name: q6_scalar_group_by_1
 ├── columns: revenue:20(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(20)=1, null(20)=0]
 ├── key: ()
 ├── fd: ()-->(20)
 ├── project
 │    ├── save-table-name: q6_project_2
 │    ├── columns: column19:19(float!null)
 │    ├── immutable
 │    ├── stats: [rows=67337.6157, distinct(19)=67337.6157, null(19)=0]
 │    ├── select
 │    │    ├── save-table-name: q6_select_3
 │    │    ├── columns: l_quantity:5(float!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null)
 │    │    ├── stats: [rows=67337.6157, distinct(5)=23.5306122, null(5)=0, distinct(6)=65411.2677, null(6)=0, distinct(7)=1.79999997, null(7)=0, distinct(11)=365, null(11)=0, distinct(6,7)=67337.6157, null(6,7)=0, distinct(5,7,11)=15459.612, null(5,7,11)=0]
 │    │    │   histogram(5)=  0 3046  64292          0
 │    │    │                <--- 1.0 ------- 23.999999999999996
 │    │    │   histogram(7)=  0           0            67338   0
 │    │    │                <--- 0.049999999999999996 ------- 0.07
 │    │    │   histogram(11)=  0       0        1216.1     232.24     2229.6     46.432     1950.8     325.1      2229.6     92.864     2090.2     418.04     2090.2     185.73     2043.8     278.67     2229.6     185.73     2136.7     139.3      2183.1     139.3      2043.8     418.04     2090.2     185.73     2090.2     278.67     1997.3     278.67     2229.6     185.73     2043.8     232.24     2183.1     92.864     2229.6     371.53     2043.8     232.24     2043.8     232.24     2183.1     185.73     2090.2     278.67     2229.6     232.24     2090.2     418.04     2136.7     139.3      2043.8     278.67     2183.1     92.864     2043.8     232.24     2183.1     139.3      0     210.87
 │    │    │                 <--- '1993-12-31' -------- '1994-01-07' -------- '1994-01-24' -------- '1994-02-06' -------- '1994-02-18' -------- '1994-03-06' -------- '1994-03-17' -------- '1994-03-30' -------- '1994-04-08' -------- '1994-04-18' -------- '1994-04-30' -------- '1994-05-11' -------- '1994-05-24' -------- '1994-06-07' -------- '1994-06-17' -------- '1994-06-30' -------- '1994-07-11' -------- '1994-07-25' -------- '1994-08-06' -------- '1994-08-18' -------- '1994-08-30' -------- '1994-09-12' -------- '1994-09-24' -------- '1994-10-09' -------- '1994-10-20' -------- '1994-11-04' -------- '1994-11-20' -------- '1994-12-03' -------- '1994-12-17' -------- '1994-12-30' --- '1994-12-31'
 │    │    ├── index-join lineitem
 │    │    │    ├── save-table-name: q6_index_join_4
 │    │    │    ├── columns: l_quantity:5(float!null) l_extendedprice:6(float!null) l_discount:7(float!null) l_shipdate:11(date!null)
 │    │    │    ├── stats: [rows=870170.855, distinct(5)=50, null(5)=0, distinct(6)=602289.41, null(6)=0, distinct(7)=11, null(7)=0, distinct(11)=365, null(11)=0]
 │    │    │    └── scan lineitem@l_sd
 │    │    │         ├── save-table-name: q6_scan_5
 │    │    │         ├── columns: l_orderkey:1(int!null) l_linenumber:4(int!null) l_shipdate:11(date!null)
 │    │    │         ├── constraint: /11/1/4: [/'1994-01-01' - /'1994-12-31']
 │    │    │         ├── stats: [rows=870170.855, distinct(1)=702009.656, null(1)=0, distinct(4)=7, null(4)=0, distinct(11)=365, null(11)=0]
 │    │    │         │   histogram(1)=  0 0.43492 4350.6 0.43492 4350.6 0.43492 4350.6 0.43492 4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6 0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.1  1.0148   4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4350.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492  4437.6  0.43492
 │    │    │         │                <---- 162 --------- 31301 -------- 54535 -------- 88071 -------- 129153 -------- 162720 -------- 192002 -------- 217378 -------- 246113 -------- 271841 -------- 305764 -------- 338307 -------- 364355 -------- 391203 -------- 417345 -------- 444354 -------- 470532 -------- 508740 -------- 541509 -------- 567712 -------- 602535 -------- 633472 -------- 666272 -------- 704547 -------- 744737 -------- 772035 -------- 799329 -------- 830371 -------- 860963 -------- 886882 -------- 910501 -------- 935203 -------- 967490 -------- 992870 -------- 1030465 -------- 1055844 -------- 1084384 -------- 1116993 -------- 1143329 -------- 1169122 -------- 1206565 -------- 1231015 -------- 1256773 -------- 1290561 -------- 1315975 -------- 1338052 -------- 1377187 -------- 1406400 -------- 1439906 -------- 1478435 -------- 1509506 -------- 1540353 -------- 1568868 -------- 1602372 -------- 1631558 -------- 1665763 -------- 1698786 -------- 1726147 -------- 1755971 -------- 1781280 -------- 1807489 -------- 1846976 -------- 1876480 -------- 1903233 -------- 1933287 -------- 1958180 -------- 1987526 -------- 2019972 -------- 2054562 -------- 2083395 -------- 2116487 -------- 2143875 -------- 2169157 -------- 2191907 -------- 2227396 -------- 2260770 -------- 2291687 -------- 2318406 -------- 2345825 -------- 2376359 -------- 2411750 -------- 2442944 -------- 2476257 -------- 2508709 -------- 2536967 -------- 2567968 -------- 2600323 -------- 2636839 -------- 2676868 -------- 2710404 -------- 2738405 -------- 2769282 -------- 2795910 -------- 2829123 -------- 2855139 -------- 2884548 -------- 2919713 -------- 2949634 -------- 2977888 -------- 3008448 -------- 3037794 -------- 3063299 -------- 3090019 -------- 3120929 -------- 3149669 -------- 3184354 -------- 3214690 -------- 3242403 -------- 3269186 -------- 3297157 -------- 3327617 -------- 3361540 -------- 3390566 -------- 3421415 -------- 3448775 -------- 3479523 -------- 3513702 -------- 3557120 -------- 3594020 -------- 3618848 -------- 3657921 -------- 3686688 -------- 3719779 -------- 3745888 -------- 3767910 -------- 3800352 -------- 3830087 -------- 3862471 -------- 3894247 -------- 3923847 -------- 3946375 -------- 3976551 -------- 4008353 -------- 4035909 -------- 4072198 -------- 4100325 -------- 4127969 -------- 4159813 -------- 4186147 -------- 4210308 -------- 4238373 -------- 4272741 -------- 4298435 -------- 4324423 -------- 4351553 -------- 4380007 -------- 4408480 -------- 4432289 -------- 4462305 -------- 4490434 -------- 4520167 -------- 4552835 -------- 4585985 -------- 4624644 -------- 4648864 -------- 4677799 -------- 4709350 -------- 4738114 -------- 4769154 -------- 4799845 -------- 4826912 -------- 4852295 -------- 4884229 -------- 4915719 -------- 4941602 -------- 4968739 -------- 5001382 -------- 5030786 -------- 5056263 -------- 5087015 -------- 5115844 -------- 5138788 -------- 5171463 -------- 5205504 -------- 5231745 -------- 5266119 -------- 5291939 -------- 5324775 -------- 5351841 -------- 5387139 -------- 5416356 -------- 5444641 -------- 5469445 -------- 5501376 -------- 5528832 -------- 5558657 -------- 5592353 -------- 5627138 -------- 5658662 -------- 5693280 -------- 5726240 -------- 5758310 -------- 5788483 -------- 5819590 -------- 5848387 -------- 5882018 -------- 5906880 -------- 5939013 -------- 5973316 -------- 5999719
 │    │    │         │   histogram(4)=  0 2.1528e+05 0 1.8221e+05 0 1.5785e+05 0 1.2626e+05 0 93804 0 65350 0 29412
 │    │    │         │                <------ 0 ---------- 1 ---------- 2 ---------- 3 -------- 4 ----- 5 ----- 6 -
 │    │    │         │   histogram(11)=  0       0        15715      3001      28811      600       25209      4201      28811      1200      27010      5402      27010      2400      26410      3601      28811      2400      27610      1800      28210      1800      26410      5402      27010      2400      27010      3601      25809      3601      28811      2400      26410      3001      28210      1200      28811      4801      26410      3001      26410      3001      28210      2400      27010      3601      28811      3001      27010      5402      27610      1800      26410      3601      28210      1200      26410      3001      28210      1800      0     2724.9
 │    │    │         │                 <--- '1993-12-31' ------- '1994-01-07' ------- '1994-01-24' ------- '1994-02-06' ------- '1994-02-18' ------- '1994-03-06' ------- '1994-03-17' ------- '1994-03-30' ------- '1994-04-08' ------- '1994-04-18' ------- '1994-04-30' ------- '1994-05-11' ------- '1994-05-24' ------- '1994-06-07' ------- '1994-06-17' ------- '1994-06-30' ------- '1994-07-11' ------- '1994-07-25' ------- '1994-08-06' ------- '1994-08-18' ------- '1994-08-30' ------- '1994-09-12' ------- '1994-09-24' ------- '1994-10-09' ------- '1994-10-20' ------- '1994-11-04' ------- '1994-11-20' ------- '1994-12-03' ------- '1994-12-17' ------- '1994-12-30' --- '1994-12-31'
 │    │    │         ├── key: (1,4)
 │    │    │         └── fd: (1,4)-->(11)
 │    │    └── filters
 │    │         ├── (l_discount:7 >= 0.05) AND (l_discount:7 <= 0.07) [type=bool, outer=(7), constraints=(/7: [/0.05 - /0.07]; tight)]
 │    │         └── l_quantity:5 < 24.0 [type=bool, outer=(5), constraints=(/5: (/NULL - /23.999999999999996]; tight)]
 │    └── projections
 │         └── l_extendedprice:6 * l_discount:7 [as=column19:19, type=float, outer=(6,7), immutable]
 └── aggregations
      └── sum [as=sum:20, type=float, outer=(19)]
           └── column19:19 [type=float]

----Stats for q6_scalar_group_by_1----
column_names  row_count  distinct_count  null_count
{revenue}     1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{revenue}     1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q6_project_2----
column_names  row_count  distinct_count  null_count
{column19}    114160     108866          0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{column19}    67338.00       1.70           67338.00            1.62                0.00            1.00

----Stats for q6_select_3----
column_names       row_count  distinct_count  null_count
{l_discount}       114160     3               0
{l_extendedprice}  114160     98751           0
{l_quantity}       114160     23              0
{l_shipdate}       114160     365             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       67338.00       1.70           2.00                1.50                0.00            1.00
{l_extendedprice}  67338.00       1.70           65411.00            1.51                0.00            1.00
{l_quantity}       67338.00       1.70           24.00               1.04                0.00            1.00
{l_shipdate}       67338.00       1.70           365.00              1.00                0.00            1.00

----Stats for q6_index_join_4----
column_names       row_count  distinct_count  null_count
{l_discount}       909455     11              0
{l_extendedprice}  909455     565291          0
{l_quantity}       909455     50              0
{l_shipdate}       909455     365             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_discount}       870171.00      1.05           11.00               1.00                0.00            1.00
{l_extendedprice}  870171.00      1.05           602289.00           1.07                0.00            1.00
{l_quantity}       870171.00      1.05           50.00               1.00                0.00            1.00
{l_shipdate}       870171.00      1.05           365.00              1.00                0.00            1.00

----Stats for q6_scan_5----
column_names    row_count  distinct_count  null_count
{l_linenumber}  909455     7               0
{l_orderkey}    909455     266035          0
{l_shipdate}    909455     365             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  870171.00      1.05           7.00                1.00                0.00            1.00
{l_orderkey}    870171.00      1.05           702010.00           2.64 <==            0.00            1.00
{l_shipdate}    870171.00      1.05           365.00              1.00                0.00            1.00
----
----
