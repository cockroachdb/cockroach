import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q12
# Shipping Modes and Order Priority
# Determines whether selecting less expensive modes of shipping is negatively
# affecting the critical-priority orders by causing more parts to be received by
# customers after the committed date.
#
# Counts, by ship mode, for lineitems actually received by customers in a given
# year, the number of lineitems belonging to orders for which the l_receiptdate
# exceeds the l_commitdate for two different specified ship modes. Only
# lineitems that were actually shipped before the l_commitdate are considered.
# The late lineitems are partitioned into two groups, those with priority URGENT
# or HIGH, and those with a priority other than URGENT or HIGH.
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q12
SELECT
    l_shipmode,
    sum(CASE
        WHEN o_orderpriority = '1-URGENT'
            OR o_orderpriority = '2-HIGH'
            THEN 1
        ELSE 0
    END) AS high_line_count,
    sum(CASE
        WHEN o_orderpriority <> '1-URGENT'
            AND o_orderpriority <> '2-HIGH'
            THEN 1
        ELSE 0
    END) AS low_line_count
FROM
    orders,
    lineitem
WHERE
    o_orderkey = l_orderkey
    AND l_shipmode IN ('MAIL', 'SHIP')
    AND l_commitdate < l_receiptdate
    AND l_shipdate < l_commitdate
    AND l_receiptdate >= DATE '1994-01-01'
    AND l_receiptdate < DATE '1994-01-01' + INTERVAL '1' YEAR
GROUP BY
    l_shipmode
ORDER BY
    l_shipmode;
----
----
sort
 ├── save-table-name: q12_sort_1
 ├── columns: l_shipmode:26(char!null) high_line_count:31(decimal!null) low_line_count:33(decimal!null)
 ├── stats: [rows=2, distinct(26)=2, null(26)=0, avgsize(26)=4, distinct(31)=2, null(31)=0, avgsize(31)=4, distinct(33)=2, null(33)=0, avgsize(33)=4]
 ├── key: (26)
 ├── fd: (26)-->(31,33)
 ├── ordering: +26
 └── group-by (hash)
      ├── save-table-name: q12_group_by_2
      ├── columns: l_shipmode:26(char!null) sum:31(decimal!null) sum:33(decimal!null)
      ├── grouping columns: l_shipmode:26(char!null)
      ├── stats: [rows=2, distinct(26)=2, null(26)=0, avgsize(26)=4, distinct(31)=2, null(31)=0, avgsize(31)=4, distinct(33)=2, null(33)=0, avgsize(33)=4]
      ├── key: (26)
      ├── fd: (26)-->(31,33)
      ├── project
      │    ├── save-table-name: q12_project_3
      │    ├── columns: column30:30(int!null) column32:32(int!null) l_shipmode:26(char!null)
      │    ├── stats: [rows=29858.68, distinct(26)=2, null(26)=0, avgsize(26)=4, distinct(30)=4, null(30)=0, avgsize(30)=4, distinct(32)=4, null(32)=0, avgsize(32)=4]
      │    ├── inner-join (lookup orders)
      │    │    ├── save-table-name: q12_lookup_join_4
      │    │    ├── columns: o_orderkey:1(int!null) o_orderpriority:6(char!null) l_orderkey:12(int!null) l_shipdate:22(date!null) l_commitdate:23(date!null) l_receiptdate:24(date!null) l_shipmode:26(char!null)
      │    │    ├── key columns: [12] = [1]
      │    │    ├── lookup columns are key
      │    │    ├── stats: [rows=29858.68, distinct(1)=29641.8, null(1)=0, avgsize(1)=4, distinct(6)=4, null(6)=0, avgsize(6)=4, distinct(12)=29641.8, null(12)=0, avgsize(12)=4, distinct(22)=2525.98, null(22)=0, avgsize(22)=4, distinct(23)=2465.99, null(23)=0, avgsize(23)=4, distinct(24)=365, null(24)=0, avgsize(24)=4, distinct(26)=2, null(26)=0, avgsize(26)=4]
      │    │    ├── fd: (1)-->(6), (1)==(12), (12)==(1)
      │    │    ├── select
      │    │    │    ├── save-table-name: q12_select_5
      │    │    │    ├── columns: l_orderkey:12(int!null) l_shipdate:22(date!null) l_commitdate:23(date!null) l_receiptdate:24(date!null) l_shipmode:26(char!null)
      │    │    │    ├── stats: [rows=29858.68, distinct(12)=29641.8, null(12)=0, avgsize(12)=4, distinct(22)=2526, null(22)=0, avgsize(22)=4, distinct(23)=2466, null(23)=0, avgsize(23)=4, distinct(24)=365, null(24)=0, avgsize(24)=4, distinct(26)=2, null(26)=0, avgsize(26)=4, distinct(24,26)=730, null(24,26)=0, avgsize(24,26)=8]
      │    │    │    │   histogram(24)=  0       0        181.73     75.722     908.64      56.8      795.07     132.52     851.84     113.57     908.64     94.645     870.76     94.645     908.64     37.845     889.71     37.845     813.99     132.52     870.76     132.52     889.71     132.52     908.64     151.44     908.64     113.57     889.71      56.8      889.71     94.645     889.71      56.8      832.91     132.52     889.71     37.845     813.99     113.57     889.71     151.44     908.64      56.8      908.64     75.722     832.91     113.57     757.19     189.29     832.91     151.44     908.64     170.37     908.64     75.722     889.71     189.29     889.71      56.8      889.71     37.845     908.64     37.845     237.48     79.16
      │    │    │    │                 <--- '1993-12-31' -------- '1994-01-03' -------- '1994-01-16' -------- '1994-01-25' -------- '1994-02-04' -------- '1994-02-15' -------- '1994-03-03' -------- '1994-03-15' -------- '1994-03-27' -------- '1994-04-08' -------- '1994-04-18' -------- '1994-04-28' -------- '1994-05-12' -------- '1994-05-24' -------- '1994-06-05' -------- '1994-06-18' -------- '1994-06-30' -------- '1994-07-15' -------- '1994-07-27' -------- '1994-08-08' -------- '1994-08-20' -------- '1994-09-02' -------- '1994-09-15' -------- '1994-09-26' -------- '1994-10-06' -------- '1994-10-16' -------- '1994-10-29' -------- '1994-11-10' -------- '1994-11-23' -------- '1994-12-05' -------- '1994-12-17' -------- '1994-12-27' -------- '1994-12-31'
      │    │    │    │   histogram(26)=  0  14929   0  14929
      │    │    │    │                 <--- 'MAIL' --- 'SHIP'
      │    │    │    ├── index-join lineitem
      │    │    │    │    ├── save-table-name: q12_index_join_6
      │    │    │    │    ├── columns: l_orderkey:12(int!null) l_shipdate:22(date!null) l_commitdate:23(date!null) l_receiptdate:24(date!null) l_shipmode:26(char!null)
      │    │    │    │    ├── stats: [rows=946759.1, distinct(12)=749363, null(12)=0, avgsize(12)=4, distinct(22)=2526, null(22)=0, avgsize(22)=4, distinct(23)=2466, null(23)=0, avgsize(23)=4, distinct(24)=365, null(24)=0, avgsize(24)=4, distinct(26)=7, null(26)=0, avgsize(26)=4]
      │    │    │    │    └── scan lineitem@l_rd
      │    │    │    │         ├── save-table-name: q12_scan_7
      │    │    │    │         ├── columns: l_orderkey:12(int!null) l_linenumber:15(int!null) l_receiptdate:24(date!null)
      │    │    │    │         ├── constraint: /24/12/15: [/'1994-01-01' - /'1994-12-31']
      │    │    │    │         ├── stats: [rows=946759.1, distinct(12)=749363, null(12)=0, avgsize(12)=4, distinct(15)=7, null(15)=0, avgsize(15)=4, distinct(24)=365, null(24)=0, avgsize(24)=4]
      │    │    │    │         │   histogram(12)=  0 94.64 4639.1  94.64  4639.1  94.64  4639.1  94.64  4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1  94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4639.1   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64   4733.7   94.64
      │    │    │    │         │                 <--- 576 -------- 38535 -------- 66885 -------- 93380 -------- 127425 -------- 157218 -------- 184483 -------- 215330 -------- 252869 -------- 283878 -------- 313798 -------- 337056 -------- 372549 -------- 399591 -------- 426245 -------- 460578 -------- 498439 -------- 526049 -------- 554468 -------- 577921 -------- 609187 -------- 639524 -------- 665345 -------- 686180 -------- 721539 -------- 755680 -------- 782756 -------- 814496 -------- 845446 -------- 872130 -------- 910912 -------- 933697 -------- 965184 -------- 1000353 -------- 1038658 -------- 1073667 -------- 1097891 -------- 1131330 -------- 1157732 -------- 1179943 -------- 1206401 -------- 1230150 -------- 1261824 -------- 1293217 -------- 1326754 -------- 1357573 -------- 1390145 -------- 1429312 -------- 1460418 -------- 1491104 -------- 1523937 -------- 1559812 -------- 1591653 -------- 1615174 -------- 1646759 -------- 1670465 -------- 1696321 -------- 1724192 -------- 1748033 -------- 1777570 -------- 1807428 -------- 1836962 -------- 1872481 -------- 1902817 -------- 1928324 -------- 1960775 -------- 1985989 -------- 2019107 -------- 2044613 -------- 2071490 -------- 2101959 -------- 2135555 -------- 2164486 -------- 2186337 -------- 2213989 -------- 2246309 -------- 2276992 -------- 2306403 -------- 2329921 -------- 2354977 -------- 2380711 -------- 2410529 -------- 2437920 -------- 2462017 -------- 2483714 -------- 2513920 -------- 2542855 -------- 2574112 -------- 2596035 -------- 2625031 -------- 2658051 -------- 2695046 -------- 2725222 -------- 2754245 -------- 2777702 -------- 2804896 -------- 2844579 -------- 2873860 -------- 2903459 -------- 2933249 -------- 2965479 -------- 2996160 -------- 3022976 -------- 3053152 -------- 3083623 -------- 3111136 -------- 3144033 -------- 3180134 -------- 3209799 -------- 3239394 -------- 3270886 -------- 3297664 -------- 3329444 -------- 3357574 -------- 3380838 -------- 3412196 -------- 3438917 -------- 3462467 -------- 3498629 -------- 3530208 -------- 3562148 -------- 3589889 -------- 3621063 -------- 3655456 -------- 3686724 -------- 3709029 -------- 3738215 -------- 3767687 -------- 3804547 -------- 3831142 -------- 3875111 -------- 3905605 -------- 3933795 -------- 3966593 -------- 3995558 -------- 4020134 -------- 4052513 -------- 4078949 -------- 4114208 -------- 4149762 -------- 4176135 -------- 4207782 -------- 4241376 -------- 4270502 -------- 4304167 -------- 4333669 -------- 4362818 -------- 4393537 -------- 4423076 -------- 4452064 -------- 4491143 -------- 4522723 -------- 4550883 -------- 4581382 -------- 4616002 -------- 4649410 -------- 4680485 -------- 4715584 -------- 4740036 -------- 4771554 -------- 4799461 -------- 4826690 -------- 4855525 -------- 4887974 -------- 4917479 -------- 4950885 -------- 4984195 -------- 5010113 -------- 5033571 -------- 5065472 -------- 5100512 -------- 5129413 -------- 5160069 -------- 5186596 -------- 5221538 -------- 5252964 -------- 5284069 -------- 5314051 -------- 5353026 -------- 5388961 -------- 5424644 -------- 5452676 -------- 5483553 -------- 5516612 -------- 5551041 -------- 5579878 -------- 5612576 -------- 5643427 -------- 5673666 -------- 5709218 -------- 5737221 -------- 5766119 -------- 5795044 -------- 5826560 -------- 5855943 -------- 5889604 -------- 5917607 -------- 5942535 -------- 5969639 -------- 5999557
      │    │    │    │         │   histogram(15)=  0 2.3981e+05 0 2.0081e+05 0 1.6777e+05 0 1.4249e+05 0 94676 0 69019 0 32190
      │    │    │    │         │                 <------ 0 ---------- 1 ---------- 2 ---------- 3 -------- 4 ----- 5 ----- 6 -
      │    │    │    │         │   histogram(24)=  0       0        5762.2      2401      28811      1801      25210      4202      27010      3601      28811      3001      27610      3001      28811      1200      28211      1200      25810      4202      27610      4202      28211      4202      28811      4802      28811      3601      28211      1801      28211      3001      28211      1801      26410      4202      28211      1200      25810      3601      28211      4802      28811      1801      28811      2401      26410      3601      24009      6002      26410      4802      28811      5402      28811      2401      28211      6002      28211      1801      28211      1200      28811      1200      7530      2510
      │    │    │    │         │                 <--- '1993-12-31' -------- '1994-01-03' ------- '1994-01-16' ------- '1994-01-25' ------- '1994-02-04' ------- '1994-02-15' ------- '1994-03-03' ------- '1994-03-15' ------- '1994-03-27' ------- '1994-04-08' ------- '1994-04-18' ------- '1994-04-28' ------- '1994-05-12' ------- '1994-05-24' ------- '1994-06-05' ------- '1994-06-18' ------- '1994-06-30' ------- '1994-07-15' ------- '1994-07-27' ------- '1994-08-08' ------- '1994-08-20' ------- '1994-09-02' ------- '1994-09-15' ------- '1994-09-26' ------- '1994-10-06' ------- '1994-10-16' ------- '1994-10-29' ------- '1994-11-10' ------- '1994-11-23' ------- '1994-12-05' ------- '1994-12-17' ------- '1994-12-27' ------ '1994-12-31'
      │    │    │    │         ├── key: (12,15)
      │    │    │    │         └── fd: (12,15)-->(24)
      │    │    │    └── filters
      │    │    │         ├── l_shipmode:26 IN ('MAIL', 'SHIP') [type=bool, outer=(26), constraints=(/26: [/'MAIL' - /'MAIL'] [/'SHIP' - /'SHIP']; tight)]
      │    │    │         ├── l_commitdate:23 < l_receiptdate:24 [type=bool, outer=(23,24), constraints=(/23: (/NULL - ]; /24: (/NULL - ])]
      │    │    │         └── l_shipdate:22 < l_commitdate:23 [type=bool, outer=(22,23), constraints=(/22: (/NULL - ]; /23: (/NULL - ])]
      │    │    └── filters (true)
      │    └── projections
      │         ├── CASE WHEN (o_orderpriority:6 = '1-URGENT') OR (o_orderpriority:6 = '2-HIGH') THEN 1 ELSE 0 END [as=column30:30, type=int, outer=(6)]
      │         └── CASE WHEN (o_orderpriority:6 != '1-URGENT') AND (o_orderpriority:6 != '2-HIGH') THEN 1 ELSE 0 END [as=column32:32, type=int, outer=(6)]
      └── aggregations
           ├── sum [as=sum:31, type=decimal, outer=(30)]
           │    └── column30:30 [type=int]
           └── sum [as=sum:33, type=decimal, outer=(32)]
                └── column32:32 [type=int]

----Stats for q12_sort_1----
column_names       row_count  distinct_count  null_count
{high_line_count}  2          2               0
{l_shipmode}       2          2               0
{low_line_count}   2          2               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{high_line_count}  2.00           1.00           2.00                1.00                0.00            1.00
{l_shipmode}       2.00           1.00           2.00                1.00                0.00            1.00
{low_line_count}   2.00           1.00           2.00                1.00                0.00            1.00

----Stats for q12_group_by_2----
column_names  row_count  distinct_count  null_count
{l_shipmode}  2          2               0
{sum_1}       2          2               0
{sum}         2          2               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_shipmode}  2.00           1.00           2.00                1.00                0.00            1.00
{sum}         2.00           1.00           2.00                1.00                0.00            1.00
{sum_1}       2.00           1.00           2.00                1.00                0.00            1.00

----Stats for q12_project_3----
column_names  row_count  distinct_count  null_count
{column30}    30988      2               0
{column32}    30988      2               0
{l_shipmode}  30988      2               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{column30}    29859.00       1.04           4.00                2.00 <==            0.00            1.00
{column32}    29859.00       1.04           4.00                2.00 <==            0.00            1.00
{l_shipmode}  29859.00       1.04           2.00                1.00                0.00            1.00

----Stats for q12_lookup_join_4----
column_names       row_count  distinct_count  null_count
{l_commitdate}     30988      392             0
{l_orderkey}       30988      28828           0
{l_receiptdate}    30988      365             0
{l_shipdate}       30988      391             0
{l_shipmode}       30988      2               0
{o_orderkey}       30988      28828           0
{o_orderpriority}  30988      5               0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_commitdate}     29859.00       1.04           2466.00             6.29 <==            0.00            1.00
{l_orderkey}       29859.00       1.04           29642.00            1.03                0.00            1.00
{l_receiptdate}    29859.00       1.04           365.00              1.00                0.00            1.00
{l_shipdate}       29859.00       1.04           2526.00             6.46 <==            0.00            1.00
{l_shipmode}       29859.00       1.04           2.00                1.00                0.00            1.00
{o_orderkey}       29859.00       1.04           29642.00            1.03                0.00            1.00
{o_orderpriority}  29859.00       1.04           4.00                1.25                0.00            1.00

----Stats for q12_select_5----
column_names     row_count  distinct_count  null_count
{l_commitdate}   30988      392             0
{l_orderkey}     30988      28828           0
{l_receiptdate}  30988      365             0
{l_shipdate}     30988      391             0
{l_shipmode}     30988      2               0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_commitdate}   29859.00       1.04           2466.00             6.29 <==            0.00            1.00
{l_orderkey}     29859.00       1.04           29642.00            1.03                0.00            1.00
{l_receiptdate}  29859.00       1.04           365.00              1.00                0.00            1.00
{l_shipdate}     29859.00       1.04           2526.00             6.46 <==            0.00            1.00
{l_shipmode}     29859.00       1.04           2.00                1.00                0.00            1.00

----Stats for q12_index_join_6----
column_names     row_count  distinct_count  null_count
{l_commitdate}   909844     560             0
{l_orderkey}     909844     267788          0
{l_receiptdate}  909844     365             0
{l_shipdate}     909844     394             0
{l_shipmode}     909844     7               0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_commitdate}   946759.00      1.04           2466.00             4.40 <==            0.00            1.00
{l_orderkey}     946759.00      1.04           749363.00           2.80 <==            0.00            1.00
{l_receiptdate}  946759.00      1.04           365.00              1.00                0.00            1.00
{l_shipdate}     946759.00      1.04           2526.00             6.41 <==            0.00            1.00
{l_shipmode}     946759.00      1.04           7.00                1.00                0.00            1.00

----Stats for q12_scan_7----
column_names     row_count  distinct_count  null_count
{l_linenumber}   909844     7               0
{l_orderkey}     909844     267788          0
{l_receiptdate}  909844     365             0
~~~~
column_names     row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}   946759.00      1.04           7.00                1.00                0.00            1.00
{l_orderkey}     946759.00      1.04           749363.00           2.80 <==            0.00            1.00
{l_receiptdate}  946759.00      1.04           365.00              1.00                0.00            1.00
----
----
