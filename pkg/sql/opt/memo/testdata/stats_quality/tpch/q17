import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q17
# Small-Quantity-Order Revenue
# Determines how much average yearly revenue would be lost if orders were no
# longer filled for small quantities of certain parts. This may reduce overhead
# expenses by concentrating sales on larger shipments.
#
# Considers parts of a given brand and with a given container type and
# determines the average lineitem quantity of such parts ordered for all orders
# (past and pending) in the 7-year database. What would be the average yearly
# gross (undiscounted) loss in revenue if orders for these parts with a quantity
# of less than 20% of this average were no longer taken?
#
# TODO:
#   1. Allow Select to be pushed below Ordinality used to add key column
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q17
SELECT
    sum(l_extendedprice) / 7.0 AS avg_yearly
FROM
    lineitem,
    part
WHERE
    p_partkey = l_partkey
    AND p_brand = 'Brand#23'
    AND p_container = 'MED BOX'
    AND l_quantity < (
        SELECT
            0.2 * avg(l_quantity)
        FROM
            lineitem
        WHERE
            l_partkey = p_partkey
    );
----
----
project
 ├── save-table-name: q17_project_1
 ├── columns: avg_yearly:51(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(51)=1, null(51)=0]
 ├── key: ()
 ├── fd: ()-->(51)
 ├── scalar-group-by
 │    ├── save-table-name: q17_scalar_group_by_2
 │    ├── columns: sum:50(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(50)=1, null(50)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(50)
 │    ├── inner-join (lookup lineitem)
 │    │    ├── save-table-name: q17_lookup_join_3
 │    │    ├── columns: l_partkey:2(int!null) l_quantity:5(float!null) l_extendedprice:6(float!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    ├── key columns: [1 4] = [1 4]
 │    │    ├── lookup columns are key
 │    │    ├── immutable
 │    │    ├── stats: [rows=2865.45095, distinct(2)=285.348605, null(2)=0, distinct(5)=50, null(5)=0, distinct(6)=2861.23039, null(6)=0, distinct(19)=285.348605, null(19)=0, distinct(49)=285.348605, null(49)=0]
 │    │    ├── fd: (19)-->(49), (2)==(19), (19)==(2)
 │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    ├── save-table-name: q17_lookup_join_4
 │    │    │    ├── columns: l_orderkey:1(int!null) l_partkey:2(int!null) l_linenumber:4(int!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    │    ├── key columns: [19] = [2]
 │    │    │    ├── immutable
 │    │    │    ├── stats: [rows=8596.35284, distinct(1)=8572.22702, null(1)=0, distinct(2)=285.348605, null(2)=0, distinct(4)=7, null(4)=0, distinct(19)=285.348605, null(19)=0, distinct(49)=285.348605, null(49)=0]
 │    │    │    ├── key: (1,4)
 │    │    │    ├── fd: (19)-->(49), (1,4)-->(2), (2)==(19), (19)==(2)
 │    │    │    ├── project
 │    │    │    │    ├── save-table-name: q17_project_5
 │    │    │    │    ├── columns: "?column?":49(float!null) p_partkey:19(int!null)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── stats: [rows=285.348605, distinct(19)=285.348605, null(19)=0, distinct(49)=285.348605, null(49)=0]
 │    │    │    │    ├── key: (19)
 │    │    │    │    ├── fd: (19)-->(49)
 │    │    │    │    ├── group-by
 │    │    │    │    │    ├── save-table-name: q17_group_by_6
 │    │    │    │    │    ├── columns: p_partkey:19(int!null) avg:48(float!null)
 │    │    │    │    │    ├── grouping columns: p_partkey:19(int!null)
 │    │    │    │    │    ├── internal-ordering: +(19|31) opt(22,25)
 │    │    │    │    │    ├── stats: [rows=285.348605, distinct(19)=285.348605, null(19)=0, distinct(48)=285.348605, null(48)=0]
 │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    ├── fd: (19)-->(48)
 │    │    │    │    │    ├── inner-join (lookup lineitem)
 │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_7
 │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_partkey:31(int!null) l_quantity:34(float!null)
 │    │    │    │    │    │    ├── key columns: [30 33] = [30 33]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── stats: [rows=8596.37622, distinct(19)=285.348605, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(31)=285.348605, null(31)=0, distinct(34)=50, null(34)=0]
 │    │    │    │    │    │    ├── fd: ()-->(22,25), (19)==(31), (31)==(19)
 │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_8
 │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_orderkey:30(int!null) l_partkey:31(int!null) l_linenumber:33(int!null)
 │    │    │    │    │    │    │    ├── key columns: [19] = [31]
 │    │    │    │    │    │    │    ├── stats: [rows=8596.37622, distinct(19)=285.348605, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(30)=8572.25026, null(30)=0, distinct(31)=285.348605, null(31)=0, distinct(33)=7, null(33)=0]
 │    │    │    │    │    │    │    ├── key: (30,33)
 │    │    │    │    │    │    │    ├── fd: ()-->(22,25), (30,33)-->(31), (19)==(31), (31)==(19)
 │    │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── save-table-name: q17_select_9
 │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    ├── stats: [rows=285.349381, distinct(19)=285.348605, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(22,25)=1, null(22,25)=0]
 │    │    │    │    │    │    │    │    │   histogram(22)=  0    285.35
 │    │    │    │    │    │    │    │    │                 <--- 'Brand#23'
 │    │    │    │    │    │    │    │    │   histogram(25)=  0   285.35
 │    │    │    │    │    │    │    │    │                 <--- 'MED BOX'
 │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(22,25)
 │    │    │    │    │    │    │    │    ├── ordering: +19 opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    │    ├── scan part
 │    │    │    │    │    │    │    │    │    ├── save-table-name: q17_scan_10
 │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(22)=25, null(22)=0, distinct(25)=28, null(25)=0, distinct(22,25)=700, null(22,25)=0]
 │    │    │    │    │    │    │    │    │    │   histogram(19)=  0  1  999   1   999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1
 │    │    │    │    │    │    │    │    │    │                 <--- 1 ----- 987 ----- 1972 ----- 2846 ----- 3792 ----- 4654 ----- 5722 ----- 6939 ----- 7937 ----- 9255 ----- 10327 ----- 11291 ----- 12445 ----- 13372 ----- 14379 ----- 15457 ----- 16675 ----- 17486 ----- 18384 ----- 19373 ----- 20443 ----- 21601 ----- 23035 ----- 23908 ----- 25073 ----- 25915 ----- 26944 ----- 27899 ----- 29113 ----- 30364 ----- 31160 ----- 32292 ----- 33258 ----- 34323 ----- 35366 ----- 36418 ----- 37372 ----- 38215 ----- 39352 ----- 40245 ----- 41439 ----- 42339 ----- 43637 ----- 44511 ----- 45651 ----- 46591 ----- 47672 ----- 48564 ----- 49466 ----- 50522 ----- 51595 ----- 52762 ----- 53787 ----- 54869 ----- 56065 ----- 56958 ----- 57932 ----- 58966 ----- 59920 ----- 60770 ----- 61901 ----- 62841 ----- 63696 ----- 64590 ----- 65643 ----- 66567 ----- 67521 ----- 68377 ----- 69395 ----- 70732 ----- 71726 ----- 72528 ----- 73491 ----- 74301 ----- 75033 ----- 76089 ----- 77258 ----- 78099 ----- 79113 ----- 80081 ----- 80863 ----- 82053 ----- 83211 ----- 84007 ----- 85125 ----- 86229 ----- 87498 ----- 88267 ----- 88994 ----- 89981 ----- 91033 ----- 92136 ----- 93152 ----- 94179 ----- 95298 ----- 96566 ----- 97512 ----- 98476 ----- 99317 ----- 100285 ----- 101318 ----- 102259 ----- 103007 ----- 103930 ----- 104922 ----- 106125 ----- 106950 ----- 108047 ----- 109058 ----- 110013 ----- 111119 ----- 112044 ----- 112930 ----- 113827 ----- 114796 ----- 115770 ----- 116759 ----- 117893 ----- 118822 ----- 119884 ----- 121129 ----- 122133 ----- 123311 ----- 124317 ----- 125306 ----- 126352 ----- 127176 ----- 128056 ----- 128846 ----- 129709 ----- 130455 ----- 131466 ----- 132372 ----- 133261 ----- 134192 ----- 135103 ----- 136111 ----- 137285 ----- 138147 ----- 139212 ----- 140071 ----- 141098 ----- 142082 ----- 143112 ----- 144142 ----- 145334 ----- 146233 ----- 147427 ----- 148299 ----- 149264 ----- 150201 ------ 151175 ------ 152152 ------ 153305 ------ 154325 ------ 155665 ------ 156485 ------ 157522 ------ 158788 ------ 159780 ------ 160782 ------ 161605 ------ 162522 ------ 163451 ------ 164496 ------ 165673 ------ 166812 ------ 167754 ------ 168770 ------ 169914 ------ 170858 ------ 171813 ------ 172675 ------ 173553 ------ 174651 ------ 175603 ------ 176440 ------ 177417 ------ 178510 ------ 179651 ------ 180631 ------ 181579 ------ 182865 ------ 183917 ------ 184893 ------ 185879 ------ 186894 ------ 187920 ------ 188791 ------ 189570 ------ 190892 ------ 191769 ------ 192729 ------ 193530 ------ 194607 ------ 195817 ------ 196727 ------ 197756 ------ 198892 ------ 199913
 │    │    │    │    │    │    │    │    │    │   histogram(22)=  0     8220     1.837e+05     8080
 │    │    │    │    │    │    │    │    │    │                 <--- 'Brand#11' ----------- 'Brand#55'
 │    │    │    │    │    │    │    │    │    │   histogram(25)=  0     7160      1.8578e+05     7060
 │    │    │    │    │    │    │    │    │    │                 <--- 'JUMBO BAG' ------------ 'WRAP PKG'
 │    │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    │    ├── fd: (19)-->(22,25)
 │    │    │    │    │    │    │    │    │    └── ordering: +19
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         ├── p_brand:22 = 'Brand#23' [type=bool, outer=(22), constraints=(/22: [/'Brand#23' - /'Brand#23']; tight), fd=()-->(22)]
 │    │    │    │    │    │    │    │         └── p_container:25 = 'MED BOX' [type=bool, outer=(25), constraints=(/25: [/'MED BOX' - /'MED BOX']; tight), fd=()-->(25)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── avg [as=avg:48, type=float, outer=(34)]
 │    │    │    │    │              └── l_quantity:34 [type=float]
 │    │    │    │    └── projections
 │    │    │    │         └── avg:48 * 0.2 [as="?column?":49, type=float, outer=(48), immutable]
 │    │    │    └── filters (true)
 │    │    └── filters
 │    │         └── l_quantity:5 < "?column?":49 [type=bool, outer=(5,49), constraints=(/5: (/NULL - ]; /49: (/NULL - ])]
 │    └── aggregations
 │         └── sum [as=sum:50, type=float, outer=(6)]
 │              └── l_extendedprice:6 [type=float]
 └── projections
      └── sum:50 / 7.0 [as=avg_yearly:51, type=float, outer=(50)]

----Stats for q17_project_1----
column_names  row_count  distinct_count  null_count
{avg_yearly}  1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg_yearly}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_lookup_join_3----
column_names       row_count  distinct_count  null_count
{?column?}         587        185             0
{l_extendedprice}  587        430             0
{l_partkey}        587        195             0
{l_quantity}       587        6               0
{p_partkey}        587        195             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}         2865.00        4.88 <==       285.00              1.54                0.00            1.00
{l_extendedprice}  2865.00        4.88 <==       2861.00             6.65 <==            0.00            1.00
{l_partkey}        2865.00        4.88 <==       285.00              1.46                0.00            1.00
{l_quantity}       2865.00        4.88 <==       50.00               8.33 <==            0.00            1.00
{p_partkey}        2865.00        4.88 <==       285.00              1.46                0.00            1.00

----Stats for q17_lookup_join_4----
column_names    row_count  distinct_count  null_count
{?column?}      6088       194             0
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}      8596.00        1.41           285.00              1.47                0.00            1.00
{l_linenumber}  8596.00        1.41           7.00                1.00                0.00            1.00
{l_orderkey}    8596.00        1.41           8572.00             1.40                0.00            1.00
{l_partkey}     8596.00        1.41           285.00              1.40                0.00            1.00
{p_partkey}     8596.00        1.41           285.00              1.40                0.00            1.00

----Stats for q17_project_5----
column_names  row_count  distinct_count  null_count
{?column?}    204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}    285.00         1.40           285.00              1.47                0.00            1.00
{p_partkey}   285.00         1.40           285.00              1.40                0.00            1.00

----Stats for q17_group_by_6----
column_names  row_count  distinct_count  null_count
{avg}         204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg}         285.00         1.40           285.00              1.47                0.00            1.00
{p_partkey}   285.00         1.40           285.00              1.40                0.00            1.00

----Stats for q17_lookup_join_7----
column_names   row_count  distinct_count  null_count
{l_partkey}    6088       204             0
{l_quantity}   6088       50              0
{p_brand}      6088       1               0
{p_container}  6088       1               0
{p_partkey}    6088       204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_partkey}    8596.00        1.41           285.00              1.40                0.00            1.00
{l_quantity}   8596.00        1.41           50.00               1.00                0.00            1.00
{p_brand}      8596.00        1.41           1.00                1.00                0.00            1.00
{p_container}  8596.00        1.41           1.00                1.00                0.00            1.00
{p_partkey}    8596.00        1.41           285.00              1.40                0.00            1.00

----Stats for q17_lookup_join_8----
column_names    row_count  distinct_count  null_count
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_brand}       6088       1               0
{p_container}   6088       1               0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  8596.00        1.41           7.00                1.00                0.00            1.00
{l_orderkey}    8596.00        1.41           8572.00             1.40                0.00            1.00
{l_partkey}     8596.00        1.41           285.00              1.40                0.00            1.00
{p_brand}       8596.00        1.41           1.00                1.00                0.00            1.00
{p_container}   8596.00        1.41           1.00                1.00                0.00            1.00
{p_partkey}     8596.00        1.41           285.00              1.40                0.00            1.00

----Stats for q17_select_9----
column_names   row_count  distinct_count  null_count
{p_brand}      204        1               0
{p_container}  204        1               0
{p_partkey}    204        204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      285.00         1.40           1.00                1.00                0.00            1.00
{p_container}  285.00         1.40           1.00                1.00                0.00            1.00
{p_partkey}    285.00         1.40           285.00              1.40                0.00            1.00

----Stats for q17_scan_10----
column_names   row_count  distinct_count  null_count
{p_brand}      200000     25              0
{p_container}  200000     40              0
{p_partkey}    200000     199241          0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      200000.00      1.00           25.00               1.00                0.00            1.00
{p_container}  200000.00      1.00           28.00               1.43                0.00            1.00
{p_partkey}    200000.00      1.00           199241.00           1.00                0.00            1.00
----
----
