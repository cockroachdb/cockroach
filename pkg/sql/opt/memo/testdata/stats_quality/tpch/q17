import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q17
# Small-Quantity-Order Revenue
# Determines how much average yearly revenue would be lost if orders were no
# longer filled for small quantities of certain parts. This may reduce overhead
# expenses by concentrating sales on larger shipments.
#
# Considers parts of a given brand and with a given container type and
# determines the average lineitem quantity of such parts ordered for all orders
# (past and pending) in the 7-year database. What would be the average yearly
# gross (undiscounted) loss in revenue if orders for these parts with a quantity
# of less than 20% of this average were no longer taken?
#
# TODO:
#   1. Allow Select to be pushed below Ordinality used to add key column
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q17
SELECT
    sum(l_extendedprice) / 7.0 AS avg_yearly
FROM
    lineitem,
    part
WHERE
    p_partkey = l_partkey
    AND p_brand = 'Brand#23'
    AND p_container = 'MED BOX'
    AND l_quantity < (
        SELECT
            0.2 * avg(l_quantity)
        FROM
            lineitem
        WHERE
            l_partkey = p_partkey
    );
----
----
project
 ├── save-table-name: q17_project_1
 ├── columns: avg_yearly:51(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(51)=1, null(51)=0]
 ├── key: ()
 ├── fd: ()-->(51)
 ├── scalar-group-by
 │    ├── save-table-name: q17_scalar_group_by_2
 │    ├── columns: sum:50(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(50)=1, null(50)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(50)
 │    ├── inner-join (lookup lineitem)
 │    │    ├── save-table-name: q17_lookup_join_3
 │    │    ├── columns: l_partkey:2(int!null) l_quantity:5(float!null) l_extendedprice:6(float!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    ├── key columns: [1 4] = [1 4]
 │    │    ├── lookup columns are key
 │    │    ├── immutable
 │    │    ├── stats: [rows=2878.18939, distinct(2)=286.61713, null(2)=0, distinct(5)=50, null(5)=0, distinct(6)=2873.93123, null(6)=0, distinct(19)=286.61713, null(19)=0, distinct(49)=286.61713, null(49)=0]
 │    │    ├── fd: (19)-->(49), (2)==(19), (19)==(2)
 │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    ├── save-table-name: q17_lookup_join_4
 │    │    │    ├── columns: l_orderkey:1(int!null) l_partkey:2(int!null) l_linenumber:4(int!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    │    ├── key columns: [19] = [2]
 │    │    │    ├── immutable
 │    │    │    ├── stats: [rows=8634.56816, distinct(1)=8610.22746, null(1)=0, distinct(2)=286.61713, null(2)=0, distinct(4)=7, null(4)=0, distinct(19)=286.61713, null(19)=0, distinct(49)=286.61713, null(49)=0]
 │    │    │    ├── key: (1,4)
 │    │    │    ├── fd: (19)-->(49), (1,4)-->(2), (2)==(19), (19)==(2)
 │    │    │    ├── project
 │    │    │    │    ├── save-table-name: q17_project_5
 │    │    │    │    ├── columns: "?column?":49(float!null) p_partkey:19(int!null)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── stats: [rows=286.61713, distinct(19)=286.61713, null(19)=0, distinct(49)=286.61713, null(49)=0]
 │    │    │    │    ├── key: (19)
 │    │    │    │    ├── fd: (19)-->(49)
 │    │    │    │    ├── group-by
 │    │    │    │    │    ├── save-table-name: q17_group_by_6
 │    │    │    │    │    ├── columns: p_partkey:19(int!null) avg:48(float!null)
 │    │    │    │    │    ├── grouping columns: p_partkey:19(int!null)
 │    │    │    │    │    ├── internal-ordering: +(19|31) opt(22,25)
 │    │    │    │    │    ├── stats: [rows=286.61713, distinct(19)=286.61713, null(19)=0, distinct(48)=286.61713, null(48)=0]
 │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    ├── fd: (19)-->(48)
 │    │    │    │    │    ├── inner-join (lookup lineitem)
 │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_7
 │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_partkey:31(int!null) l_quantity:34(float!null)
 │    │    │    │    │    │    ├── key columns: [30 33] = [30 33]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── stats: [rows=8634.59174, distinct(19)=286.61713, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(31)=286.61713, null(31)=0, distinct(34)=50, null(34)=0]
 │    │    │    │    │    │    ├── fd: ()-->(22,25), (19)==(31), (31)==(19)
 │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_8
 │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_orderkey:30(int!null) l_partkey:31(int!null) l_linenumber:33(int!null)
 │    │    │    │    │    │    │    ├── key columns: [19] = [31]
 │    │    │    │    │    │    │    ├── stats: [rows=8634.59174, distinct(19)=286.61713, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(30)=8610.25091, null(30)=0, distinct(31)=286.61713, null(31)=0, distinct(33)=7, null(33)=0]
 │    │    │    │    │    │    │    ├── key: (30,33)
 │    │    │    │    │    │    │    ├── fd: ()-->(22,25), (30,33)-->(31), (19)==(31), (31)==(19)
 │    │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── save-table-name: q17_select_9
 │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    ├── stats: [rows=286.617913, distinct(19)=286.61713, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(22,25)=1, null(22,25)=0]
 │    │    │    │    │    │    │    │    │   histogram(22)=  0    286.62
 │    │    │    │    │    │    │    │    │                 <--- 'Brand#23'
 │    │    │    │    │    │    │    │    │   histogram(25)=  0   286.62
 │    │    │    │    │    │    │    │    │                 <--- 'MED BOX'
 │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(22,25)
 │    │    │    │    │    │    │    │    ├── ordering: +19 opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    │    ├── scan part
 │    │    │    │    │    │    │    │    │    ├── save-table-name: q17_scan_10
 │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(22)=25, null(22)=0, distinct(25)=28, null(25)=0, distinct(22,25)=700, null(22,25)=0]
 │    │    │    │    │    │    │    │    │    │   histogram(19)=  0  4   995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995   4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4    995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     995    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4     1015    4
 │    │    │    │    │    │    │    │    │    │                 <--- 51 ----- 1335 ----- 2367 ----- 3558 ----- 4278 ----- 5314 ----- 6325 ----- 7176 ----- 7962 ----- 8784 ----- 9892 ----- 10810 ----- 11716 ----- 13130 ----- 14005 ----- 15148 ----- 16150 ----- 17087 ----- 18257 ----- 19342 ----- 20527 ----- 21590 ----- 22542 ----- 23384 ----- 24421 ----- 25315 ----- 26134 ----- 27000 ----- 28133 ----- 29410 ----- 30496 ----- 31588 ----- 32466 ----- 33679 ----- 34601 ----- 35492 ----- 36519 ----- 37442 ----- 38366 ----- 39443 ----- 40397 ----- 41264 ----- 42229 ----- 43451 ----- 44398 ----- 45392 ----- 46638 ----- 47995 ----- 48801 ----- 49889 ----- 50947 ----- 52085 ----- 53305 ----- 54604 ----- 55814 ----- 56756 ----- 58001 ----- 58959 ----- 59885 ----- 60693 ----- 61995 ----- 62937 ----- 63659 ----- 64554 ----- 65585 ----- 66520 ----- 67565 ----- 68432 ----- 69390 ----- 70467 ----- 71369 ----- 72478 ----- 73538 ----- 74665 ----- 75622 ----- 76704 ----- 77646 ----- 78630 ----- 79292 ----- 80356 ----- 81132 ----- 82072 ----- 83154 ----- 84167 ----- 85308 ----- 86150 ----- 87083 ----- 87986 ----- 88892 ----- 89757 ----- 90788 ----- 91954 ----- 93074 ----- 93996 ----- 95002 ----- 96042 ----- 97023 ----- 97824 ----- 98940 ----- 99965 ----- 101025 ----- 101781 ----- 102883 ----- 103902 ----- 105012 ----- 106090 ----- 107104 ----- 108064 ----- 109159 ----- 110038 ----- 110978 ----- 111895 ----- 112941 ----- 114007 ----- 114921 ----- 116235 ----- 117042 ----- 117939 ----- 118788 ----- 119802 ----- 120824 ----- 121804 ----- 123111 ----- 124376 ----- 125340 ----- 126355 ----- 127574 ----- 128587 ----- 129598 ----- 130612 ----- 131514 ----- 132614 ----- 133829 ----- 134751 ----- 135902 ----- 136794 ----- 137598 ----- 138467 ----- 139297 ----- 140102 ----- 141045 ----- 142268 ----- 143377 ----- 144156 ----- 144880 ----- 145801 ----- 146819 ----- 148041 ----- 149167 ----- 150061 ----- 151337 ------ 152411 ------ 153293 ------ 154410 ------ 155310 ------ 156386 ------ 157590 ------ 158468 ------ 159305 ------ 160408 ------ 161368 ------ 162405 ------ 163380 ------ 164575 ------ 165545 ------ 166336 ------ 167397 ------ 168178 ------ 169037 ------ 170049 ------ 170961 ------ 171903 ------ 172778 ------ 173659 ------ 174790 ------ 175942 ------ 176848 ------ 177923 ------ 178929 ------ 180020 ------ 181259 ------ 182189 ------ 183185 ------ 184259 ------ 185293 ------ 186324 ------ 187343 ------ 188406 ------ 189513 ------ 190329 ------ 191092 ------ 192180 ------ 193293 ------ 194190 ------ 195344 ------ 196415 ------ 197219 ------ 198051 ------ 199021 ------ 199996
 │    │    │    │    │    │    │    │    │    │   histogram(22)=  0     7820     1.8414e+05     8040
 │    │    │    │    │    │    │    │    │    │                 <--- 'Brand#11' ------------ 'Brand#55'
 │    │    │    │    │    │    │    │    │    │   histogram(25)=  0     6800      1.8616e+05     7040
 │    │    │    │    │    │    │    │    │    │                 <--- 'JUMBO BAG' ------------ 'WRAP PKG'
 │    │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    │    ├── fd: (19)-->(22,25)
 │    │    │    │    │    │    │    │    │    └── ordering: +19
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         ├── p_brand:22 = 'Brand#23' [type=bool, outer=(22), constraints=(/22: [/'Brand#23' - /'Brand#23']; tight), fd=()-->(22)]
 │    │    │    │    │    │    │    │         └── p_container:25 = 'MED BOX' [type=bool, outer=(25), constraints=(/25: [/'MED BOX' - /'MED BOX']; tight), fd=()-->(25)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── avg [as=avg:48, type=float, outer=(34)]
 │    │    │    │    │              └── l_quantity:34 [type=float]
 │    │    │    │    └── projections
 │    │    │    │         └── avg:48 * 0.2 [as="?column?":49, type=float, outer=(48), immutable]
 │    │    │    └── filters (true)
 │    │    └── filters
 │    │         └── l_quantity:5 < "?column?":49 [type=bool, outer=(5,49), constraints=(/5: (/NULL - ]; /49: (/NULL - ])]
 │    └── aggregations
 │         └── sum [as=sum:50, type=float, outer=(6)]
 │              └── l_extendedprice:6 [type=float]
 └── projections
      └── sum:50 / 7.0 [as=avg_yearly:51, type=float, outer=(50)]

----Stats for q17_project_1----
column_names  row_count  distinct_count  null_count
{avg_yearly}  1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg_yearly}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_lookup_join_3----
column_names       row_count  distinct_count  null_count
{?column?}         587        185             0
{l_extendedprice}  587        430             0
{l_partkey}        587        195             0
{l_quantity}       587        6               0
{p_partkey}        587        195             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}         2878.00        4.90 <==       287.00              1.55                0.00            1.00
{l_extendedprice}  2878.00        4.90 <==       2874.00             6.68 <==            0.00            1.00
{l_partkey}        2878.00        4.90 <==       287.00              1.47                0.00            1.00
{l_quantity}       2878.00        4.90 <==       50.00               8.33 <==            0.00            1.00
{p_partkey}        2878.00        4.90 <==       287.00              1.47                0.00            1.00

----Stats for q17_lookup_join_4----
column_names    row_count  distinct_count  null_count
{?column?}      6088       194             0
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}      8635.00        1.42           287.00              1.48                0.00            1.00
{l_linenumber}  8635.00        1.42           7.00                1.00                0.00            1.00
{l_orderkey}    8635.00        1.42           8610.00             1.41                0.00            1.00
{l_partkey}     8635.00        1.42           287.00              1.41                0.00            1.00
{p_partkey}     8635.00        1.42           287.00              1.41                0.00            1.00

----Stats for q17_project_5----
column_names  row_count  distinct_count  null_count
{?column?}    204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}    287.00         1.41           287.00              1.48                0.00            1.00
{p_partkey}   287.00         1.41           287.00              1.41                0.00            1.00

----Stats for q17_group_by_6----
column_names  row_count  distinct_count  null_count
{avg}         204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg}         287.00         1.41           287.00              1.48                0.00            1.00
{p_partkey}   287.00         1.41           287.00              1.41                0.00            1.00

----Stats for q17_lookup_join_7----
column_names   row_count  distinct_count  null_count
{l_partkey}    6088       204             0
{l_quantity}   6088       50              0
{p_brand}      6088       1               0
{p_container}  6088       1               0
{p_partkey}    6088       204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_partkey}    8635.00        1.42           287.00              1.41                0.00            1.00
{l_quantity}   8635.00        1.42           50.00               1.00                0.00            1.00
{p_brand}      8635.00        1.42           1.00                1.00                0.00            1.00
{p_container}  8635.00        1.42           1.00                1.00                0.00            1.00
{p_partkey}    8635.00        1.42           287.00              1.41                0.00            1.00

----Stats for q17_lookup_join_8----
column_names    row_count  distinct_count  null_count
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_brand}       6088       1               0
{p_container}   6088       1               0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  8635.00        1.42           7.00                1.00                0.00            1.00
{l_orderkey}    8635.00        1.42           8610.00             1.41                0.00            1.00
{l_partkey}     8635.00        1.42           287.00              1.41                0.00            1.00
{p_brand}       8635.00        1.42           1.00                1.00                0.00            1.00
{p_container}   8635.00        1.42           1.00                1.00                0.00            1.00
{p_partkey}     8635.00        1.42           287.00              1.41                0.00            1.00

----Stats for q17_select_9----
column_names   row_count  distinct_count  null_count
{p_brand}      204        1               0
{p_container}  204        1               0
{p_partkey}    204        204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      287.00         1.41           1.00                1.00                0.00            1.00
{p_container}  287.00         1.41           1.00                1.00                0.00            1.00
{p_partkey}    287.00         1.41           287.00              1.41                0.00            1.00

----Stats for q17_scan_10----
column_names   row_count  distinct_count  null_count
{p_brand}      200000     25              0
{p_container}  200000     40              0
{p_partkey}    200000     199241          0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      200000.00      1.00           25.00               1.00                0.00            1.00
{p_container}  200000.00      1.00           28.00               1.43                0.00            1.00
{p_partkey}    200000.00      1.00           199241.00           1.00                0.00            1.00
----
----
