import file=tpch_schema
----

import file=tpch_stats
----

# --------------------------------------------------
# Q17
# Small-Quantity-Order Revenue
# Determines how much average yearly revenue would be lost if orders were no
# longer filled for small quantities of certain parts. This may reduce overhead
# expenses by concentrating sales on larger shipments.
#
# Considers parts of a given brand and with a given container type and
# determines the average lineitem quantity of such parts ordered for all orders
# (past and pending) in the 7-year database. What would be the average yearly
# gross (undiscounted) loss in revenue if orders for these parts with a quantity
# of less than 20% of this average were no longer taken?
#
# TODO:
#   1. Allow Select to be pushed below Ordinality used to add key column
# --------------------------------------------------
stats-quality database=tpch stats-quality-prefix=q17
SELECT
    sum(l_extendedprice) / 7.0 AS avg_yearly
FROM
    lineitem,
    part
WHERE
    p_partkey = l_partkey
    AND p_brand = 'Brand#23'
    AND p_container = 'MED BOX'
    AND l_quantity < (
        SELECT
            0.2 * avg(l_quantity)
        FROM
            lineitem
        WHERE
            l_partkey = p_partkey
    );
----
----
project
 ├── save-table-name: q17_project_1
 ├── columns: avg_yearly:51(float)
 ├── cardinality: [1 - 1]
 ├── immutable
 ├── stats: [rows=1, distinct(51)=1, null(51)=0]
 ├── key: ()
 ├── fd: ()-->(51)
 ├── scalar-group-by
 │    ├── save-table-name: q17_scalar_group_by_2
 │    ├── columns: sum:50(float)
 │    ├── cardinality: [1 - 1]
 │    ├── immutable
 │    ├── stats: [rows=1, distinct(50)=1, null(50)=0]
 │    ├── key: ()
 │    ├── fd: ()-->(50)
 │    ├── inner-join (lookup lineitem)
 │    │    ├── save-table-name: q17_lookup_join_3
 │    │    ├── columns: l_partkey:2(int!null) l_quantity:5(float!null) l_extendedprice:6(float!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    ├── key columns: [1 4] = [1 4]
 │    │    ├── lookup columns are key
 │    │    ├── immutable
 │    │    ├── stats: [rows=2871.62462, distinct(2)=285.963395, null(2)=0, distinct(5)=50, null(5)=0, distinct(6)=2867.38586, null(6)=0, distinct(19)=285.963395, null(19)=0, distinct(49)=285.963395, null(49)=0]
 │    │    ├── fd: (19)-->(49), (2)==(19), (19)==(2)
 │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    ├── save-table-name: q17_lookup_join_4
 │    │    │    ├── columns: l_orderkey:1(int!null) l_partkey:2(int!null) l_linenumber:4(int!null) p_partkey:19(int!null) "?column?":49(float!null)
 │    │    │    ├── key columns: [19] = [2]
 │    │    │    ├── immutable
 │    │    │    ├── stats: [rows=8614.87386, distinct(1)=8590.64401, null(1)=0, distinct(2)=285.963395, null(2)=0, distinct(4)=7, null(4)=0, distinct(19)=285.963395, null(19)=0, distinct(49)=285.963395, null(49)=0]
 │    │    │    ├── key: (1,4)
 │    │    │    ├── fd: (19)-->(49), (1,4)-->(2), (2)==(19), (19)==(2)
 │    │    │    ├── project
 │    │    │    │    ├── save-table-name: q17_project_5
 │    │    │    │    ├── columns: "?column?":49(float!null) p_partkey:19(int!null)
 │    │    │    │    ├── immutable
 │    │    │    │    ├── stats: [rows=285.963395, distinct(19)=285.963395, null(19)=0, distinct(49)=285.963395, null(49)=0]
 │    │    │    │    ├── key: (19)
 │    │    │    │    ├── fd: (19)-->(49)
 │    │    │    │    ├── group-by
 │    │    │    │    │    ├── save-table-name: q17_group_by_6
 │    │    │    │    │    ├── columns: p_partkey:19(int!null) avg:48(float!null)
 │    │    │    │    │    ├── grouping columns: p_partkey:19(int!null)
 │    │    │    │    │    ├── internal-ordering: +(19|31) opt(22,25)
 │    │    │    │    │    ├── stats: [rows=285.963395, distinct(19)=285.963395, null(19)=0, distinct(48)=285.963395, null(48)=0]
 │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    ├── fd: (19)-->(48)
 │    │    │    │    │    ├── inner-join (lookup lineitem)
 │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_7
 │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_partkey:31(int!null) l_quantity:34(float!null)
 │    │    │    │    │    │    ├── key columns: [30 33] = [30 33]
 │    │    │    │    │    │    ├── lookup columns are key
 │    │    │    │    │    │    ├── stats: [rows=8614.89733, distinct(19)=285.963395, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(31)=285.963395, null(31)=0, distinct(34)=50, null(34)=0]
 │    │    │    │    │    │    ├── fd: ()-->(22,25), (19)==(31), (31)==(19)
 │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    ├── inner-join (lookup lineitem@l_pk)
 │    │    │    │    │    │    │    ├── save-table-name: q17_lookup_join_8
 │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null) l_orderkey:30(int!null) l_partkey:31(int!null) l_linenumber:33(int!null)
 │    │    │    │    │    │    │    ├── key columns: [19] = [31]
 │    │    │    │    │    │    │    ├── stats: [rows=8614.89733, distinct(19)=285.963395, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(30)=8590.66735, null(30)=0, distinct(31)=285.963395, null(31)=0, distinct(33)=7, null(33)=0]
 │    │    │    │    │    │    │    ├── key: (30,33)
 │    │    │    │    │    │    │    ├── fd: ()-->(22,25), (30,33)-->(31), (19)==(31), (31)==(19)
 │    │    │    │    │    │    │    ├── ordering: +(19|31) opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    ├── select
 │    │    │    │    │    │    │    │    ├── save-table-name: q17_select_9
 │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    ├── stats: [rows=285.964174, distinct(19)=285.963395, null(19)=0, distinct(22)=1, null(22)=0, distinct(25)=1, null(25)=0, distinct(22,25)=1, null(22,25)=0]
 │    │    │    │    │    │    │    │    │   histogram(22)=  0    285.96
 │    │    │    │    │    │    │    │    │                 <--- 'Brand#23'
 │    │    │    │    │    │    │    │    │   histogram(25)=  0   285.96
 │    │    │    │    │    │    │    │    │                 <--- 'MED BOX'
 │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    ├── fd: ()-->(22,25)
 │    │    │    │    │    │    │    │    ├── ordering: +19 opt(22,25) [actual: +19]
 │    │    │    │    │    │    │    │    ├── scan part
 │    │    │    │    │    │    │    │    │    ├── save-table-name: q17_scan_10
 │    │    │    │    │    │    │    │    │    ├── columns: p_partkey:19(int!null) p_brand:22(char!null) p_container:25(char!null)
 │    │    │    │    │    │    │    │    │    ├── stats: [rows=200000, distinct(19)=199241, null(19)=0, distinct(22)=25, null(22)=0, distinct(25)=28, null(25)=0, distinct(22,25)=700, null(22,25)=0]
 │    │    │    │    │    │    │    │    │    │   histogram(19)=  0  1  999   1   999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999   1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1    999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     999    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1     1019    1
 │    │    │    │    │    │    │    │    │    │                 <--- 1 ----- 990 ----- 1908 ----- 2654 ----- 3480 ----- 4323 ----- 5415 ----- 6395 ----- 7425 ----- 8349 ----- 9254 ----- 10332 ----- 11390 ----- 12415 ----- 13416 ----- 14393 ----- 15313 ----- 16255 ----- 17665 ----- 18720 ----- 19911 ----- 20848 ----- 21989 ----- 23151 ----- 24356 ----- 25268 ----- 26245 ----- 27454 ----- 28599 ----- 29440 ----- 30292 ----- 31342 ----- 32192 ----- 33244 ----- 34481 ----- 35501 ----- 36339 ----- 37560 ----- 38608 ----- 39602 ----- 40697 ----- 41780 ----- 42779 ----- 43901 ----- 44961 ----- 46051 ----- 47161 ----- 48076 ----- 48933 ----- 49909 ----- 50998 ----- 51760 ----- 52535 ----- 53460 ----- 54368 ----- 55118 ----- 56199 ----- 57150 ----- 58264 ----- 59221 ----- 60205 ----- 61214 ----- 62123 ----- 63241 ----- 64288 ----- 65510 ----- 66487 ----- 67201 ----- 68166 ----- 69028 ----- 70017 ----- 70887 ----- 71713 ----- 72769 ----- 73666 ----- 74674 ----- 75744 ----- 76655 ----- 77515 ----- 78353 ----- 79352 ----- 80189 ----- 80922 ----- 82041 ----- 83040 ----- 84252 ----- 85274 ----- 86356 ----- 87233 ----- 88417 ----- 89682 ----- 90842 ----- 91964 ----- 92825 ----- 93915 ----- 95025 ----- 96201 ----- 97351 ----- 98607 ----- 99598 ----- 100794 ----- 101682 ----- 102536 ----- 103533 ----- 104562 ----- 105587 ----- 106505 ----- 107357 ----- 108473 ----- 109387 ----- 110109 ----- 111138 ----- 112141 ----- 113068 ----- 114173 ----- 115237 ----- 116149 ----- 117353 ----- 118542 ----- 119689 ----- 120744 ----- 121665 ----- 122560 ----- 123765 ----- 124914 ----- 125866 ----- 126940 ----- 127886 ----- 129064 ----- 130094 ----- 131156 ----- 132214 ----- 133114 ----- 134033 ----- 134953 ----- 135940 ----- 137212 ----- 138035 ----- 139066 ----- 140078 ----- 140756 ----- 141855 ----- 142810 ----- 143752 ----- 144763 ----- 145625 ----- 146578 ----- 147502 ----- 148203 ----- 149245 ----- 150294 ------ 151202 ------ 152175 ------ 153228 ------ 154049 ------ 155101 ------ 156242 ------ 157246 ------ 158276 ------ 159046 ------ 159984 ------ 160765 ------ 161607 ------ 162659 ------ 163871 ------ 164853 ------ 166025 ------ 167081 ------ 168121 ------ 168915 ------ 169848 ------ 170796 ------ 171727 ------ 172620 ------ 173588 ------ 174678 ------ 175985 ------ 177210 ------ 178275 ------ 179114 ------ 179954 ------ 181000 ------ 182196 ------ 183229 ------ 184242 ------ 185479 ------ 186555 ------ 187545 ------ 188446 ------ 189597 ------ 190758 ------ 191776 ------ 192781 ------ 193970 ------ 195096 ------ 195972 ------ 196897 ------ 197664 ------ 198728 ------ 199996
 │    │    │    │    │    │    │    │    │    │   histogram(22)=  0     7980     1.8372e+05     8300
 │    │    │    │    │    │    │    │    │    │                 <--- 'Brand#11' ------------ 'Brand#55'
 │    │    │    │    │    │    │    │    │    │   histogram(25)=  0     7040      1.8616e+05     6800
 │    │    │    │    │    │    │    │    │    │                 <--- 'JUMBO BAG' ------------ 'WRAP PKG'
 │    │    │    │    │    │    │    │    │    ├── key: (19)
 │    │    │    │    │    │    │    │    │    ├── fd: (19)-->(22,25)
 │    │    │    │    │    │    │    │    │    └── ordering: +19
 │    │    │    │    │    │    │    │    └── filters
 │    │    │    │    │    │    │    │         ├── p_brand:22 = 'Brand#23' [type=bool, outer=(22), constraints=(/22: [/'Brand#23' - /'Brand#23']; tight), fd=()-->(22)]
 │    │    │    │    │    │    │    │         └── p_container:25 = 'MED BOX' [type=bool, outer=(25), constraints=(/25: [/'MED BOX' - /'MED BOX']; tight), fd=()-->(25)]
 │    │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    │    └── filters (true)
 │    │    │    │    │    └── aggregations
 │    │    │    │    │         └── avg [as=avg:48, type=float, outer=(34)]
 │    │    │    │    │              └── l_quantity:34 [type=float]
 │    │    │    │    └── projections
 │    │    │    │         └── avg:48 * 0.2 [as="?column?":49, type=float, outer=(48), immutable]
 │    │    │    └── filters (true)
 │    │    └── filters
 │    │         └── l_quantity:5 < "?column?":49 [type=bool, outer=(5,49), constraints=(/5: (/NULL - ]; /49: (/NULL - ])]
 │    └── aggregations
 │         └── sum [as=sum:50, type=float, outer=(6)]
 │              └── l_extendedprice:6 [type=float]
 └── projections
      └── sum:50 / 7.0 [as=avg_yearly:51, type=float, outer=(50)]

----Stats for q17_project_1----
column_names  row_count  distinct_count  null_count
{avg_yearly}  1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg_yearly}  1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_scalar_group_by_2----
column_names  row_count  distinct_count  null_count
{sum}         1          1               0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{sum}         1.00           1.00           1.00                1.00                0.00            1.00

----Stats for q17_lookup_join_3----
column_names       row_count  distinct_count  null_count
{?column?}         587        185             0
{l_extendedprice}  587        430             0
{l_partkey}        587        195             0
{l_quantity}       587        6               0
{p_partkey}        587        195             0
~~~~
column_names       row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}         2872.00        4.89 <==       286.00              1.55                0.00            1.00
{l_extendedprice}  2872.00        4.89 <==       2867.00             6.67 <==            0.00            1.00
{l_partkey}        2872.00        4.89 <==       286.00              1.47                0.00            1.00
{l_quantity}       2872.00        4.89 <==       50.00               8.33 <==            0.00            1.00
{p_partkey}        2872.00        4.89 <==       286.00              1.47                0.00            1.00

----Stats for q17_lookup_join_4----
column_names    row_count  distinct_count  null_count
{?column?}      6088       194             0
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}      8615.00        1.42           286.00              1.47                0.00            1.00
{l_linenumber}  8615.00        1.42           7.00                1.00                0.00            1.00
{l_orderkey}    8615.00        1.42           8591.00             1.40                0.00            1.00
{l_partkey}     8615.00        1.42           286.00              1.40                0.00            1.00
{p_partkey}     8615.00        1.42           286.00              1.40                0.00            1.00

----Stats for q17_project_5----
column_names  row_count  distinct_count  null_count
{?column?}    204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{?column?}    286.00         1.40           286.00              1.47                0.00            1.00
{p_partkey}   286.00         1.40           286.00              1.40                0.00            1.00

----Stats for q17_group_by_6----
column_names  row_count  distinct_count  null_count
{avg}         204        194             0
{p_partkey}   204        204             0
~~~~
column_names  row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{avg}         286.00         1.40           286.00              1.47                0.00            1.00
{p_partkey}   286.00         1.40           286.00              1.40                0.00            1.00

----Stats for q17_lookup_join_7----
column_names   row_count  distinct_count  null_count
{l_partkey}    6088       204             0
{l_quantity}   6088       50              0
{p_brand}      6088       1               0
{p_container}  6088       1               0
{p_partkey}    6088       204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_partkey}    8615.00        1.42           286.00              1.40                0.00            1.00
{l_quantity}   8615.00        1.42           50.00               1.00                0.00            1.00
{p_brand}      8615.00        1.42           1.00                1.00                0.00            1.00
{p_container}  8615.00        1.42           1.00                1.00                0.00            1.00
{p_partkey}    8615.00        1.42           286.00              1.40                0.00            1.00

----Stats for q17_lookup_join_8----
column_names    row_count  distinct_count  null_count
{l_linenumber}  6088       7               0
{l_orderkey}    6088       6116            0
{l_partkey}     6088       204             0
{p_brand}       6088       1               0
{p_container}   6088       1               0
{p_partkey}     6088       204             0
~~~~
column_names    row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{l_linenumber}  8615.00        1.42           7.00                1.00                0.00            1.00
{l_orderkey}    8615.00        1.42           8591.00             1.40                0.00            1.00
{l_partkey}     8615.00        1.42           286.00              1.40                0.00            1.00
{p_brand}       8615.00        1.42           1.00                1.00                0.00            1.00
{p_container}   8615.00        1.42           1.00                1.00                0.00            1.00
{p_partkey}     8615.00        1.42           286.00              1.40                0.00            1.00

----Stats for q17_select_9----
column_names   row_count  distinct_count  null_count
{p_brand}      204        1               0
{p_container}  204        1               0
{p_partkey}    204        204             0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      286.00         1.40           1.00                1.00                0.00            1.00
{p_container}  286.00         1.40           1.00                1.00                0.00            1.00
{p_partkey}    286.00         1.40           286.00              1.40                0.00            1.00

----Stats for q17_scan_10----
column_names   row_count  distinct_count  null_count
{p_brand}      200000     25              0
{p_container}  200000     40              0
{p_partkey}    200000     199241          0
~~~~
column_names   row_count_est  row_count_err  distinct_count_est  distinct_count_err  null_count_est  null_count_err
{p_brand}      200000.00      1.00           25.00               1.00                0.00            1.00
{p_container}  200000.00      1.00           28.00               1.43                0.00            1.00
{p_partkey}    200000.00      1.00           199241.00           1.00                0.00            1.00
----
----
