# LogicTest: 5node

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, _bool BOOL, _bytes BYTES, _bit BIT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/62>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

# Verify that the window functions with the same PARTITION BY clause are
# evaluated as a single distributed windower stage followed by a couple of
# single-node stages.
query T
EXPLAIN (DISTSQL) SELECT
  avg(a) OVER (),
  min(b) OVER (PARTITION BY a),
  avg(c) OVER (ORDER BY b),
  max(c) OVER (PARTITION BY a)
FROM data
----
distribution: full
vectorized: true
·
• window
│
└── • window
    │
    └── • window
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0l99uo0YUh-_7FKNzZauD8Az_bK5IN26FlMSpbW23qqzVAOMELQYXcLNR5HevhiRrA8vIQ8RNFBj4ne_MdyTGL1D8m4AL8y_3N1f-HRpd-6v16s-bMVrNb-af1oj99zBiY7T4PF-i0RijXZyOgvfr-6vl2l_7izv029-IjXH1dPi-ulhez5diJRDvse-nlcZ76Pfl4hZFrGSAIc0ifsd2vAD3HyCAgQIGAzCYgMGCDYZ9noW8KLJcPPJSveBH38GdYIjT_aEUtzcYwizn4L5AGZcJBxfWLEj4krOI5_oEMES8ZHFSlRGlPfHn6_4bfwYMn7LksEsLFzGMAoxCwLDaM3FD0wliaYQIyspHnsPmiCE7lG9lT9WCZ_TIisd6HY_A5rjBUJTsgYNLznrxr8GdHHFHO6fcQ5rlEc95VEuuUpsN_xWnUfbEc92qU5zvvos8sce3_t3Io2Px39WXkWeMG32dmGmD2RqImTQUXX3-Y-QRQbg4lIIaexR7BvZs7JnYszqBjQYw6d5lKQ_5CY8xPptyj_56whNI2HOwZ3eCmU0wUgMjl08z6T3NOtF0Otg8dzf0sdmwB5xnu8ZML5dA-0ugmm4MJoF2NvQxCc6AEpwas3G5BKO_BEPTzcEkGJ0NfUzCdEAJ0xqzebkEs78EU9OtwSSYnQ19TMJsQAkzlY_Vkhf7LC14g_3nlSaNShoRTfLogb_uSJEd8pDf51lYPft6uaiCqq2NeFG-rr5d-On7UlHmnO1-nGguT7K6kyy1JKc7iShCzSRRilREslW0hUWaWZPzLCqJamFRaZRRi5qcRxktKkMaRWh3VivK7DtWRC1JMla2WpJsrBShZGOlSCUdqxaW1XusWlh2X4FULUki0FFLkglUhJIJVKSSCmxhOb0FtrCmfQUaakkSgVO1JJlARSiZQEUqqcAW1qy3wBYW6f1pNhWjJApnilEyh6pYMomqXFKLbbD-3-eZOGptk-zpaxyBCxPKCSWzrUZCc6uZprPVgmngaIG5DQ3btmlgiV-X24Q9FOK8t3rMnqrc9fNenNa2LCk4hlv2jV_zkue7OI2LMg7fVo7HX_4PAAD__-o6ZbM=

# Verify that all window functions with the PARTITION BY clause are distributed.
query T
EXPLAIN (DISTSQL) SELECT
  avg(a) OVER (),
  min(b) OVER (PARTITION BY a),
  max(c) OVER (PARTITION BY a ORDER BY b),
  avg(c) OVER (ORDER BY b),
  max(d) OVER (PARTITION BY b ORDER BY c),
  min(d) OVER (PARTITION BY a)
FROM data
----
distribution: full
vectorized: true
·
• window
│
└── • window
    │
    └── • window
        │
        └── • window
            │
            └── • window
                │
                └── • scan
                      missing stats
                      table: data@data_pkey
                      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMmN9v4kYQx9_7V6zmCdRFsOsfYD85vaQVUhJSgq5XVei04CVBRzC1TXNRxP9emfy0F08YIyd5OUHsfP2ZHc9Hc7mH5N8F-HDy7eL0qH_OGsf9y9Hln6dNdnlyevJlxNR_Vw3VZIOvJ0PWaHJ2M182Jk_fL46Go_6oPzhnv_3NVHZV_WxMd19lg-HxyTD7OGnybezzjbkrWUS4M2LyEjF9JNl9o2qy34eDMxaqVAGHZRTqc3WjE_D_AQEcJHCwgIMNHBwYc1jF0VQnSRRnt9xvf6Ef_gS_w2G-XK3T7MdjDtMo1uDfQzpPFxp8GKnJQg-1CnXc7gCHUKdqvtg-Jnt0kP3zffVD3wGHL9FifbNMfKY4m3A25SwEDpcrlf2s1RZMLUMmWJRe6xjGGw7ROn188ssDJ3fsWiXX-UcFAsabMYckVVcafPGqnP4x-J0NL6noJXe9jOJQxzrMJW9TizX_NV-G0a2O206e4nUDfBZkx3zWP28Esvn0yW4eVJcs1OXUVJfovF3Y0bdGYDVfvbiB_DWrc7BOs1t4IHlg8cDmgcODLg9cYuUyV7lVqFzU1VKB91Q-lW7nSrfKS3d50ONBt1D9S2V2sbK6mioLTT36-kcjELu5vSf0Lg96pehOAV2WNwUFEzvAyl-tZzDR2R6tV8rnFvlEjk_sbzZxiNnaotWWtbmtvKbDXhf3g93m1lSXEJ_ebXW1VOA9fQe35Zsq9x9AedAAylbbqm0AZWlNh3Wr-8ED2K2pLiE__QDW1VKB9_QdBjDfVGv_AbQOGkCr1bZrG0CrtKbDutX74AHs1VSXsD79ANbVUoH39B0GMN9Ue_8BtA8aQLvVdmobQLu0psO65X3wAHo11SXsTz-AdbVU4D19hwH0KP9HHepkFS0TXahw96M6hUe1RHYUOrzSD-eWROt4qi_iaLq99-HrYBu0nalQJ-nD1ccv_eXTpSSNtbp5_lPW_knd8iSHliQQKEGkEg6SReXyyrOkwSXQLIlEGVh4VK88yiJSCQTLImIJtzzLpp5WB8kyuCSaZSHvqYGFRyHvg0OkEgiWS8QSyCi6RC6JzGLX4LKKWZ3XWTYSZWDZaFR-qjuvo3oGlYNGSVmeZUS5VWUqaElYB4lMGBSRCpUplQuTqcHVrSxTAwuPwmRKpEJlSsRCZUo9LUymBlevskwNLDwKkymRCpUpEQuVKZELlanB5VWWqYElKi-BkhiFnFaXSoWZi8qFqotMhrnLJKu-CZpg1VdBKheqLyoY6i_yiWECM8mqr4MmWPV9kMqFOowKhkqMSoZazCSrvhOaYMZSuK_GLGIUcl49KhWmMSoXqjEyGaYxk8xYo_fWmAmGZ2Eao3KhGqOCoRojnximMZMMX6cxjZlgeBamMSoXqjEqGKoxKhmqMZPM2Kn31pgJ9sbGibwWxCjkvDwqFaYxKheqMTIZpjGTzFir99aYCYZnYRqjcqEao4KhGiOfGKYxg0zimzWmMQPsjSxMY1QuVGNUMFRjVDJUYyaZsVnvrTFvM-YwW0S33-ch-BBaciq8WbdlezPRsh0xa_VclX2y7Ik7nU16HReyX1BXCfj3cHkd3W5zR3crnYA_U4tEczhTP_SxTnV8M1_Ok3Q-fbyy2fzyfwAAAP__ujxlbw==
