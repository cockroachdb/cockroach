# LogicTest: 5node

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, _bool BOOL, _bytes BYTES, _bit BIT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Verify that all aggregate functions that we expect to have multi-stage
# execution do, in fact, get planned with 2 stages.
query T
EXPLAIN (DISTSQL) SELECT
  b, -- any_not_null
  avg(a),
  bool_and(_bool),
  bool_or(_bool),
  count(a),
  max(a),
  min(a),
  stddev(a),
  stddev_samp(a),
  stddev_pop(a),
  sum(a),
  sum_int(a),
  variance(a),
  var_samp(a),
  var_pop(a),
  xor_agg(_bytes),
  count(*), -- count_rows
  bit_and(_bit),
  bit_or(_bit),
  covar_pop(a, b),
  regr_sxx(a, b),
  regr_sxy(a, b),
  regr_syy(a, b),
  regr_avgx(a, b),
  regr_avgy(a, b),
  regr_intercept(a, b),
  regr_r2(a, b),
  regr_slope(a, b)
FROM data GROUP BY b
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: b
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsmUFvqkoUx_fvU0xmZV_G6AxgW1dwLTUkFrxA-9q8NARl4iVRxgfY2Nz0u78MKoL1MlpcdMGiZc5h_mdOz7_zW-hvmPw3h32oP49HmmGC1p3huM7P0RVw9JE-cMEEAf9t1vKvEJgwNvf8KGh5fLVLsDiPp2wVpdnWhb_ePMMoeyZpENC3wtJL_MWyGC_ZNlwtdk8v3FZ78-PQj6Z0F-zFPNgp1yz2_Nms5U3eU5rk7fzNGw3TbeNhug2ztrNoyvIqCEyuEIjpLPaS9fogfi_H7-XYf5utDxPlHWGU0nhKl2kpG5Ny2Tlb0k0G3NvWAwj81AdD23ocgx8vYAIRjFhATX9BE9j_F2KIIIEIShBBGSKowFcElzGb0iRhMd_yOxMYwRr2uwiG0XKV8vQrglMWU9j_DdMwnVPYh64_mVOb-gGNO12IYEBTP5xnx_Au1GUcLvz4HSI4YPPVIkr6gDeKQOY_f_DB82eYQgSdpc-3tDsY-FEAMGDpLxrD1w8E2Srdt5Gk_ozCPv5Ap7eqzWYxnfkpiztKuVOVT0MzXzzTcj3zcTRqqeSKd_P40FIxXw2sR9Pdrn9Y1sjTzLuWKuWhZW-jbKNnW_84LR4-aM9b1YNhblfOT_vOuL_fRY8PnpHXfrZsTxsOW6qclTbczUHKLuLnZIFra6ZjuIZlerY-tHXH4UttOLT1oebqLRUj_jeUB7efxeQd_PKTXwdjwPD1Yz9c8sfh7uusIhYHNKZBqVJWpWL8uPvp4MP543z-pDQlqeyAXHJAKW3t5QZc5wbc8NW9YWojz3Hv7vSnlnqLVII2dYsvvLE1Lr3cG9Xd733SbEMzB_qRMk-a_alGbi_GJX8xKRqMC1UGVl4Hy_s099xznp-PZl-OZV-OZbWn4bES2tPw2G7DdHV7oI_dI-9scuzQkTXWd3mbRgGN-0DFCKiko0oIqDICqoKA2kNAvUZAvUFAvd3-4C7fxxdcgEn-iwuxvFVhLsfZihfAvALmcpLJs7O4inAV4Sqi_BEn0mX_403WZssOVg52Hj9bLp2NT6cuvhh1O7jdIV_grqDZwsXvNdw9l7v4ktzFDXcb7n537pLT2Ucuxz7S7khfYJ-g2cLlu27Ydy77yCXZRxr2Nez77uyTTmefdDn2Se2O_AX2CZotXL6bhn3nsk-6JPukhn0N-747--TT2Sdfjn1yu6N8gX2CZguX77Zh37nsky_JPrlhX8O-784-wVcXNk2WLEroSZ8kdvmNoMGMbq5PwlbxlI5jNs2O2YRWpssSAU3SzVu8CYxo84o3WBTjQzEuiklJjM8T9-qIb-uIca2-sVKtJpXzlqrFUrVZvWq35Eq1Ui1W6lhdLRZYXS0WWF0tFlktUAus7tWx-rpSfFNt1k0ds6rFArOqxQKzqsUiswRqgVm3dczCAoqKMFqPo_VAWo-kNVFaj6W4FkyxgKaywLRPOD3LtGq1yLRqtci0arXQNIFcZNonqFaa9vrx1_8BAAD__yCBgnk=


statement ok
ALTER TABLE data DROP COLUMN _bool;
ALTER TABLE data DROP COLUMN _bytes;
ALTER TABLE data DROP COLUMN _bit;

query T
EXPLAIN (DISTSQL) SELECT sum(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslF2Lm0AUhu_7K4ZzlcCIjpps1qtdtikEsh-NKRSKF9PMwQaMY2dGaAn570W9WBM2o8beRc07z_twhnME_TuDCJbf39aPqxcy-byKt_HX9ZTEy_XyaUt0eZjwKfmyeX0mghsOFHIp8IUfUEP0AxhQ8IFCABRCoDCDhEKh5A61lqr6y7EOrMQfiDwK-7woTfU6obCTCiE6gtmbDCGCLf-Z4Qa5QOV6QEGg4fusxlToh0LtD1z9BQpPMisPuY5I1ScuePXTcRnhuSCMSPMLFSQnCrI07zhteIoQsRPtX-kxTRWm3Ejlzs4bxd-eJw9sehXjX8W8n17mUglUKM6OTk72Iswb1iQ4a8L6z4ANnoHLHNe_YQodpVry8zFT8Pu7-8PdfccNbnDvKNVyvxvjHvR3D4a7B44b3uDeUarlvhjjHvZ3D4e7h447u8G9o1TL_f5_bZ4PMBvUhcw1Xmygj0_2qs2EIsVmjWlZqh2-KbmrMc3ja52rXwjUpvnKmodV3nyqCrbDzBr2z8LsMuzbyR3owJoO7eFwTO-ZNTy3k-djyHfW8MJOXowh39tn5XVcE_slu2Qnp0__AgAA___4FuM7

query T
EXPLAIN (DISTSQL) SELECT sum((a-1)*1000 + (b-1)*100 + (c::INT-1)*10 + (d-1)) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlVGL2kAQx9_7KZZ5Su42JJvEOy9PimchoN5VLRSKD2t2sIJm7W4CLeJ3L0k4TORuY5u-6JMzs__9z_4yMEfQP3cQwfjb62QYz4j1HC-Wiy8TmyzGk_FoSXS-t4ofJw5hNrkjzPM8m9wTy1rXUnaVSqIoni3750KVF2XCJp_nL1MieMaBQioFzvgeNUTfgQEFHygEQCEECj1YUTgomaDWUhVHjqUgFr8g8ihs00OeFekVhUQqhOgI2TbbIUSw5OsdzpELVK4HFARmfLsrbQrrwUFt91z9Bgojucv3qY4Ip2RNSUKJAAqLAy9yjssITwVhRGY_UAGFOaYCVUQKHAPmsKh6rH1XIHkL7i1r4Ddrb__LWlAFjRO1A4OwrDyPR_F0OLFhdaIg8-z8Wp3xDULETvR6IsPNRuGGZ1K5vSaQxdepNWAf2_gf2pxvz1OpBCoUjatXJ3MjzPu7ToJGJ-z6EWD_PgIuc1z_ZoaghUmN_UOXIfCvR-93QO87bnAz6FuY1NA_dkEfXI8-6IA-cNzwZtC3MKmh73dBH16PPuyAPnTc3s2gb2FSQ__0v7bOOzZz1AeZarzYPu_f7BVbCcUGqxWmZa4SfFUyKW2q8KXUlQmBOquqrAritCoVDdbFzCj2G2J2KfbNzi3WgVEdmsVhl757RvGD2fmhi_OjUdw3O_e7OD-Zv5XXMibmIbv0Xp0-_QkAAP__LqCBIw==

query T
EXPLAIN (DISTSQL) SELECT sum(a), count(a), max(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF2L2kAUhu_7K4ZzFWEkThJ33VwpWwuCH1ujdKHIMnUOVjCZdGYCW8T_XpJAN8o6iYp3mYyvz8tzwtmD_rODEIavL-PBaEqcr6NoEX0ft0g0HA-fF0RnscNblKxllpjiKebvDm-Rb_PZhAhuOFBIpMApj1FD-BMYUPCAgg8UAqDQhRWFVMk1ai1V_pN9ERiJdwg7FLZJmpn89YrCWiqEcA9ma3YIISz4rx3OkQtUbgcoCDR8uyswObqfqm3M1V-g8Cx3WZzokOR9opTnj22XEZ4Iwog0v1HB6kBBZuYDpw3fIITsQJtXGmw2CjfcSOV2jxtFy4nTZ628zGw5XbzNZz8iJz9OBq_FxTm-d5b_gc0SqQQqFEfM1cHekHXOVYyWk7fRdOH0vf8N_fMN_aOGrPnQ2MVDc1nb9a4YW02pipSHu4zNay7Fu1yK13b9K6TUlKpIebyLFL-5FP9yKX7bDa6QUlOqIqV3FylBcynB5VKCttu9QkpNqYqUp7tvvU_4c9SpTDSebL_P_7mTb0UUGyxXqJaZWuOLkusCUx5nRa54IVCb8paVh1FSXuUFq2FmDXtHYXYa9uzkGrRvTQf2cHBL7641_GAnP9xCfrSGe3Zy7xbyk31WnZrPxP6RnbJXhy__AgAA__92gAx9

query T
EXPLAIN (DISTSQL) SELECT sum(a+b), count(a+b), max(a+b) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF2L4jwUx--fTxHOlTKRmrQ6Tq-UeVwQfJm1yg4sMkRzcAVt3CSFWcTvvrQuM1XGtPhy52n89__jd0p2YH6vIYTu60u_0xuSyv-9aBJ971dJ1O13nyfEJJuKIA9kXqVkoZLYfkwb8f7vN_k2Hg2IFFYAhVhJHIoNGgh_AgMKHCj4QCEACg2YUdhqtUBjlE7_sssCPfkOYZ3CKt4mNn08o7BQGiHcgV3ZNUIIEzFf4xiFRO3VgYJEK1brrCatbm_1aiP0H6DwrNbJJjYhEZTMgUK0FelU8xgRsSSMKPsLNVAYYyxRh6TNHtocZnsKKrGfBMaKJULI9rQ8ZWe51LgUVmmvcQwZTQeVNqumfKPpcPI2Hv2IKuk46LxmB-f6-dn-z9okVlqiRnnUOdu7CVn9HGI0Hbz1hpNKm38Q-ucJ_SNCVn6P7JI9eqzm8RtssoAz56l5l03y8p74RZ54zfNv4KmAM-fp8S6e_PKe_Is8-TUvuIGnAs6cp9ZdPAXlPQUXeQpqXuMGngo4c56e7n6DftE_RrNVscGTm_TrN9fTGxblEg_XsVGJXuCLVous5jCOslz2QKKxh1N2GHrx4SgFzIeZM8yPwuw0zN3NBdW-Mx24w8E13A1nuOlubl7T_OgMt9zNrWuan9y7qhd8Ju6P7LR7tv_vbwAAAP__c6knYg==

query T
EXPLAIN (DISTSQL) SELECT sum((a-1)*1000) + sum((b-1)*100) + sum((c::INT-1)*10) + sum(d-1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlUGL4kwQhu_fr2jqlIwdkk6i4-QUcfwgoM6surCweGjThSto2u0ksIv435ckiyYyJjLBxVt3Vd68VfUU9AHin1vwYPTtfTwIpkR7DeaL-ZexTuaj8Wi4IJoWpztN48QgTCdPhFmWpZMOyaOrUlQ_RUPPC6aL_jl3Soki9v_sbUIETzhQiKTAKd9hDN53YEDBBgoOUHCBQheWFPZKhhjHUmWfHHJBIH6BZ1HYRPs0ycJLCqFUCN4Bkk2yRfBgwVdbnCEXqEwLKAhM-Gab22TW_l5tdlz9BgpDuU13UewRTsmKkpASARTme57FDJMRHgnCiEx-oAIKM4wEKo9oPjOYV_SqP2Vz-XuhRPPtaqqUcYpjJX9K-24efx0Ng8lgDMsjBZkm5ybjhK8RPHaktw9isF4rXPNEKrNbncP860TzmZ41m53s08k5nVz9ahH21SLO3mkklUCFomK8PNaXyazP1Hkm47sdzXc6ms86vq1f78CpdMBu3yf2-X0ymWHaj75RDaMooerdb6Ps23nYLXjYhuk8Oo-GUZR4PN-Ph3M7D6cFD8cw3Ufn0TCKEo_-_Xi4t_NwW_BwDbP76DwaRlHi8fJvXsAPiphhvJdRjBcv4cd_trIXEsUai-c0lqkK8V3JMLcprm-5Lg8IjJMiy4pLEBWprMCymNWK7YqYXYrteucGa6dW7daL3TZ1d2vFvXrnXhvn51pxv96538b5pZ6V1bAm9Ut26b08_vcnAAD__3X0qjs=

query T
EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF2L2kAUhu_7K4ZzlcBInCS6bq4UayHgx9YoXSiyjJmDFTRjZyawRfzvJfFiVdaJjdgrk4lv3ofnhLMH_XsDEQxeX4a9eEycr3EyS74PXZIMhoP-jOh863CXku06c5bFL393UpeSVOaZcYRLvk0nIyK44UAhkwLHfIsaop_AgIIPFAKgEAKFFiwo7JRMUWupir_sy0As3iFqUlhnu9wUxwsKqVQI0R7M2mwQIpjx5QanyAUqrwkUBBq-3pQ1RXV3p9Zbrv4Ahb7c5NtMR4RTsqQkBQrJjhcHDY8RngnCiDS_UMHiQEHm5qNUG75CiNiB3g7WW60UrriRymudcyXzkdNlLlAYxWOn65dXvVenGxRX_cl8PHubTn4kjnuVxL9K8gGQZ1IJVCjO2hcHOytr_gtsMh-9xeOZ0w2vswZnrOz2cbKa4_RYw_NrDLQC7URS-8ED9W-X5NeV5De8oIakCrQTSU8PlhTcLimoKyloeGENSRVoJ5I6D5YU3i4prCspbHitGpIq0E4kPf_H_fkJyRT1TmYaL_bo529uFvsVxQqPy1jLXKX4omRa1hxvJ2WuPBCozfEpO97E2fFRAXgaZtawfxZml2Hf3lxRHVjToT0c3sPdsobb9ub2Pc1P1nDH3ty5p_nZPqtmxWdi_8guuxeHL38DAAD__1DlIiw=

# AVG is more tricky: we do two aggregations (for the sum and for the count)
# and calculate the average at the end.
query T
EXPLAIN (DISTSQL) SELECT avg(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF-L2kwUxu_fTzGcqwRH4kyi6-Yqy74WAv7ZGoVCkTJmDqmgGTuJpUX87iWxsFHWiTTmLpn4-PzyO-EcIfuxBR9GX97GL-GUWP-H0SL6PLZJNBqPXhdE_EwsyxKkQ9Y26ZDY98PpYlhcSpt8ms8mRIpcAIVUSZyKHWbgfwUGFDhQcIGCBxT6sKKw1yrGLFO6-MmxDITyF_g9Cpt0f8iL4xWFWGkE_wj5Jt8i-LAQ6y3OUUjUTg8oSMzFZlvWFNXBXm92Qv8GCq9qe9ilmU8EJWtKYkokUIj2ojjrOoyIVBJGVP4dNVCYYypR-yTwOpYVsE7A7U7g_n1BWJ0oqEP-zpXlIkHw2Ynez_6SJBoTkSvt9C_Ro-XECphdUM-W00V5fauS36x8bzqkSkvUKC9qViczFOvdooqWk29hwcXtqirmBPwmp3vBye4fK_v3sTqs6_AWBltDX3E4eNRg-f3CeANhvOu4LQiroa8Ie3qUMPd-YW4DYW7X8VoQVkNfETZ8lDDvfmFeA2Fe1-m3IKyGviLsuY1d-0HlHLO9SjO82rkf_3Ov2MUoEzwv7kwddIxvWsVlzfl2VubKA4lZfn7Kzjdhen5UAFbDzBjmF2F2Hebm5ppq15j2zGGvCXffGB6YmwdNmp-M4aG5edik-dk8q17NZ2L-yK67V6f__gQAAP__jxct0g==

# VARIANCE/STDDEV have three local (sqrdiff, sum, and count) and one final stage aggregations.
# We calculate and render the variance/stddev at the end.
query T
EXPLAIN (DISTSQL) SELECT sum(a), round(stddev(b), 1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L4jwUxu_fTxHOVYVITVsdp1cV_0DB0RnbeVlYZInm4ArauEm67CJ-96WVZVTGVCruXU7Sp8-T3wlnD_rHBkIYfnkd9-IJcQZxkiZv4wZJhuNhPyU63zq8QYmSeSYcbYTAn86iQQlrkNFs-kIENxwoZFLghG9RQ_gVGFDwgIIPFAKg0IY5hZ2SS9RaquKTfSmIxS8IWxTW2S43xfacwlIqhHAPZm02CCGkfLHBGXKBym0BBYGGrzelTWEd7dR6y9VvoNCXm3yb6ZBwShZAIdnxomq6jPBMEEak-Y4K5gcKMjcfjtrwFULIDvT2VL3VSuGKG6nc9nmo5P3FiVij8H-bDeLRyIm8sir2y1V_-j5Jy_W1KN7VKB8J8kwqgQrFmf38YA_LWtfSjuJJb_wtSQeD4f9O5NHIp1FQHMwwE6hCErG_ryDyKAvDMJ6k3et38M_uwG5vMqvTZJc1Xa9GmytynZDrPLrN3u2IvFqIvKbr10BUkesE0dOjEfm3I_JrIfKbblADUUWuE0TdRyMKbkcU1EIUNN12DUQVuU4QPf_LefpJlBnqncw0XszVz__cKuYtihUeh7OWuVriq5LL0uZYTktduSFQm-MpOxZxdjwqAp6KmVXsnYnZpdizO1dY-1Z1YBcH9-RuW8Udu3PnHucnq7hrd-7e4_xs71Wr4pnYH9ml9_zw358AAAD___c5JPI=

query T
EXPLAIN (DISTSQL) SELECT sum(a), round(variance(b), 1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lFGL4jAUhd_3V4T7VCFS01bHyVPFUSg4daY6y8IiSzQXV9DGTdplF_G_L60sozKmUnHecpOenpPvhrsD82sNHAbfXka9KCbOUzSZTl5HDTIZjAb9KTH5xhENSrTKU-n8Fnol0gU68wYlrEGGyfiZSJEJoJAqibHYoAH-HRhQ8ICCDxQCoNCGGYWtVgs0Runik10piOQf4C0Kq3SbZ8X2jMJCaQS-g2yVrRE4TMV8jQkKidptAQWJmVitS5vCOtzq1Ubov0Chr9b5JjWcCErmQGGyFUXVdBkRqSSMqOwnapjtKag8e3c0mVgicLan16fqLZcalyJT2m2fhpq8PTshaxT-r8lTNBw6oVdWxX656o_f4mm5vhTFuxjlPUGeKi1Rozyxn-3tYVnrUtphFPdGP772kqgX9wdO6NHQp2FQHCWYStSchOz_Swg9yjjnUTztXr6Ff3ILdn2bWZ02u6zpejUaXZHriF3n3o32rkfk1ULkNV2_BqKKXEeIHu6NyL8ekV8Lkd90gxqIKnIdIereG1FwPaKgFqKg6bZrIKrIdYTo8TMn6gdREjRblRo8m6wf_7lVTFyUSzyMZ6NyvcAXrRalzaEcl7pyQ6LJDqfsUETp4agIeCxmVrF3ImbnYs_uXGHtW9WBXRzckrttFXfszp1bnB-s4q7duXuL86O9V62KZ2J_ZOfes_2XfwEAAP__i2EmMA==

query T
EXPLAIN (DISTSQL) SELECT stddev(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lNGK4jAUhu_3KcK5qhipaeuM06sOo0LB0RnbWRYWWWJzcAVt3CQuu4jvvrQOjMqYypbepam__9fvhOxB_1pDCMNvL-PHeEKcQZykyeu4RZLhePiUEm2EwN-O43DSJosWaZMsDONJ2i-WokVGs-kzEdxwoJBLgRO-QQ3hd2BAwQMKPlAIgEIP5hS2SmaotVTFT_ZlIBZ_IOxSWOXbnSm25xQyqRDCPZiVWSOEkPLFGmfIBSq3CxQEGr5alzVFdbRVqw1Xf4HCk1zvNrkOCadkQUlGiQAKyZYXex2XEZ4Lwog0P1EBhRnmAlVIoqDtOBFrR16rHfnvHwjzAwW5Mx9c2vAlQsgO9Hb2x-VS4ZIbqdzeOXryOhvEo5ETsVbB-Pb8vnqavk3Scn0NwLsK8NG7y6USqFCclc4PdkR2oXcUTx7HP5J0MBh-dSJGI49G_nUw_wyM3T5V9v9TdVnH9RqYawX9ibS7Zubq3a7Pq6HP67h-A_oq6E_03Tejz79dn19Dn99xgwb0VdCf6Os3oy-4XV9QQ1_QcXsN6KugP9H30Pyl_AnADPVW5hovLufP_7lbXNoolni84bXcqQxflMzKmuPjtMyVGwK1Ob5lx4c4P74qAE_DzBr2zsLsMuzZmyuqfWs6sIeDOtw9a_jO3nxXp_neGu7bm_t1mh_ss-pWHBP7Ibvsnh--_AsAAP__liM7kA==

query T
EXPLAIN (DISTSQL) SELECT variance(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lNGK4jAUhu_3KcK5qhipaavj9KriKBScOlOdZWGRJTYHV9DGTeOyi_juS-vAqIxp2dK7NPX3__qdkCNkv7bgw_jby3QYRsR6CueL-eu0Rebj6Xi0IL-52vA0QcuyOGmTVYu0SeL7YbQY5EvRIpN49kwE1xwopFJgxHeYgf8dGFBwgIILFDyg0IMlhb2SCWaZVPlPjkUgFH_A71LYpPuDzreXFBKpEPwj6I3eIviw4KstxsgFKrsLFARqvtkWNXl1sFebHVd_gcJIbg-7NPMJp2RFSUKJAArzPc_3OjYjPBWEEal_ogIKMaYClU8Cr21ZAWsHTqsduO8fCMsTBXnQH1yZ5msEn51odfbheq1wzbVUdu8aff4aP4WTiRWwVs749vy-Gs3eokWxvgfg3AX46D2kUglUKK5KlyczIrvROwmj4fTH12EcDqPR2AoYDRwauPfR3Cs0Vn2u7P_narOO7TQw2RL6C239ZibrVNfn1NDndGy3AX0l9Bf6HprR51bX59bQ53ZsrwF9JfQX-gbN6POq6_Nq6PM6dq8BfSX0F_oem7-WPwGIMdvLNMOb6_nzf-7m1zaKNZ7v-EweVIIvSiZFzflxVuSKDYGZPr9l54cwPb_KAS_DzBh2rsLsNuyYm0uqXWPaM4e9Otw9Y7hvbu7XaX4whgfm5kGd5kfzrLolx8R8yG67l6cv_wIAAP__pi08zg==

# Regression aggregate functions have two local, and one final stage aggregations.
# Calculation and rendering are happening at the end.
query T
EXPLAIN (DISTSQL) SELECT covar_pop(a, c), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(a, c), regr_intercept(a, c), regr_r2(a, c), regr_slope(a, c) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lV9ro0AUxd_3U8h9SmCCGTX941Mka4OQTbIqpWUJMqsXN2Add5yUlJLvvqgLja7VYOm-5R7neA4_L5NXyH8nYIL9sF1ZzloZfXU83_u-GiuevbIXvhLyZyaCjGcjRpRwTBSBsQjy47Exv9Tnl_rMnuNjU6if2KcSRYiZrKlCq7824RlWinLnbr4pEZMMCKQ8wjV7whzMH0CBgAYEdCBgAIEZ7AhkgoeY51wUR15LgxMdwZwS2KfZQRbyjkDIBYL5CnIvEwQTfPYzQRdZhEKdAoEIJdsnZUwRPc_E_omJFyCw4MnhKc1NpWgHBLyMFdNEpQpLI4UqXP5CAbsTAX6Qb4m5ZDGCSU_k8lZWHAuMmeRCndVL-a619hzf2awD1166tucVP63l0rWXlm-P5pTMtfG7LbR3W7yFH1IuIhQY1ZJ3p-6etEHvzllbq2CxubfcYLvZjuZ0DOSvWjQPvIeHNvGxRXxsEa37ZYvful-2nHXWvu0u7K3_7yNXa8lbbbZ2Kb-HUa9hpJevGB2yYiqdqNqAJevpdfbxrj5xybTL6WiD6GgTVR9Ap6fXGZ3rT6SjX05HH0RHn6jGADo9vc7o3HwiHeNyOsYgOsZEnQ2g09PrjM7tf7q-W1q4mGc8zbFxjbe_eVpc7xjFWP0X5PwgQtwKHpYx1bgpfaUQYS6rp7QanLR6VBQ8N9NOs1Yz06ZZ607uidY73Ua32fhI71mn-ao7-eojyded5pvu5JuPJN92f6tpz5p0L1kze3f68icAAP__g2h04w==


# Test various combinations of aggregation functions and verify that the
# aggregation processors are set up correctly.
query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(c), avg(d), stddev(a), stddev_samp(a), stddev_pop(a), variance(b), var_samp(b), var_pop(b), sum(a+b+c::INT+d), covar_pop(a, c), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(a, c), regr_intercept(a, c), regr_r2(a, c), regr_slope(a, c) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVt1vsjoYvz9_RfNcYazBAjrHVYljhsQXfYF32XJiTAeNx0SBU9BsWfa_nxT8wjA0x2QXu4A8X78-H7-26Qdk_67ABPt5OrYcFykPjh_4v8ct5NtjexigbLNWWAsjtl0ory1c6OFOj6SeRxHfFiGlOM_YOj3V06RUt0wsWRzyYpktE2XgXpFR-_UVhaE2em2hNgpN03GDgRRltjDZxzKMZBmCL8Q8e3s709-r-ntVZ9vF27mhGrGMcy5CnuYVq9Cqy66SlJcW9OhNfqGI5QwwxEnEXbbmGZh_AwEMGmDQAYMBGHoww5CKJORZlggZ8lEAnOgNzC6GZZxucmmeYQgTwcH8gHyZrziYELDXFfc4i7hQu4Ah4jlbroo0MjVNxXLNxDtgGCarzTrOTMQwesUoxCgCDH7KpK2jEsTiCBGU5P9wARg8HkdcmIgabUWhpE21Vpvqu9FjRAlGVMOI6hhRA2afGJJNfqwzy9mCg0k-8fW9WIuF4AuWJ0LtVVvx__xSqNaS9UpJl9Jw8scNdnJhNQ5S78RfyP5v78F5fNytsfNoFc9xHSKlwLNc3wmciTv37JFn-74UrdHIs0dWYCtUwzLhV31rX_Z9bHcTJyLigkeVXmefzZMh3ZrRkEPx-yHNncbhHCL6Unt0XGs894OHB_tJoXeYEkwH5475dDKtcT5ZnmO5Q1uh91gORa-4StCJpyy3ewwaTg5hhBzNcuhz__m51vpSZ32ps1pPo7olrKdRXbTjBrY3tKdBjc_T6pKOJ1N7bz-cmOJoqOXJwIj2VNrHiN7tvgFG9H73ka78yXgizxKRECIxpCd_EkYkhkgQkQit--We0yt7jlx_b5D_f2-opKNq33BzXOjm5Hz0f9TNoV3PonYDi1pH1b-BxQvdnLB496NY1K9nUb-BRb2jGt_A4oVuTlgc_CgWjetZNG5g0eiovW9g8UI3Jyze_ygWL7xBPZ6lSZzxszdZ_cpd-Vbj0YKXD7ss2YiQT0USFmlKdVLgCkPEs7z0klJx4tIlCzwFk0awVgGTc7DWnPlCar0RbTSDjVvq7jWC-82Z-7dkvmsED5ozD27JfN_MVffCNmneZOe5Z59__RcAAP__8oSfLA==


query T
EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d), avg(a+b+c::INT+d), stddev(a+b), variance(c::INT+d), covar_pop(b, d), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(b, c), regr_intercept(a, b), regr_r2(b, c), regr_slope(a, c) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV11v6jgQfd9fYc2TUV2B8wFtnhzRFEWigZvksr1aIWQSi0WChHUCoqr631cOFAhLA1rU25e-BPvMGY9n5tgyr5D9MwMLnOd-13Y9hB_cIAx-dGsocLpOO0TZco55jaD5NMFj9cvXOKoRFKXLJMdxjSC-mmCMObpB4xq6QZFluV54p4bKmuVxLFZbM0ErLqc8iQTe0rasKF1xOVqkCzwmBSDFRI6y9RpzgqL9_KU8fynP-WqyPgZe1Io7YJrkQkZikSva-B2VWomUzdKF2KyDHv3eE4p5zoFAksbC43ORgfUXUCCgAQEdCBhAwIQhgYVMI5FlqVSU18LBjddgNQhMk8UyV_CQQJRKAdYr5NN8JsCCkI9nwhc8FrLeAAKxyPl0VoRRodlCTudcvgCBdjpbzpPMQmr7BEUExUAgWHCF3dYp4kmMKErzv4UEAr5IYiEtxIwbjBm9YVrthunbBhFUIERZ30GFEVSAujLA8I1Ausz3e89yPhFg0TdyeX72ZCLFhOeprJvl9IKfT5gZNSDw5HqYmcXIfsasqUbt3k8vHPm9PwOspgWZ7gzbcfDDf3AfHzHTdhztgKOVOPqOox9winHo217ghm7PG_lOx3eCQA3tTsd3OnboYGYS1rqIaJDN9i9Z8TKiQVRpPuqF9mEv9i1YJqmMhRRxqf7Dt-pu0caJdtFdu7Rdu97rOnJVPY1dlc0SXiT76Hp2dxSEDw_OALMWYXeE3e8NA9t3ba_tYEYbhFFKGNX21nZvYPujfq-PGdX3sKraKHh-xowa_0F_nUJ_nULtQefUEvago9jmEex6oeO3nb4SYvPI5msnHIJur--8r787mqXzRhAz66xJEGsRxNRxvFdHsqE-ikgVkyoqVVxqqo-i09aH8tBL8qCXX0X0_19FdXpb177oMjqT4YG8m9-X0SdfRtrlatOuUJt2W9e_SG1nMjxQW-tbbZ-sNv1ytelXqE2_rRtfpLYzGR6o7e5bbZ-sNuNytRlXqM24rZtfpLYzGR6o7f5bbb_xWX-iF77IFmmSiaPn_emVG-rZL-KJ2PxHyNKljERfplERZjPtFX4FEIss31jpZuImG5Pa4KEzrXTWSs702FmrjnwmtF7pbVQ7G9fs26x0blZHbl4TuVXpfFcd-e6ayPfVvWqckUm1yI5jD9_--DcAAP__ERJXMA==


# Verify that local and final aggregation is correctly shared and de-duplicated.
query T
EXPLAIN (DISTSQL) SELECT sum(a), stddev(a), avg(a) FILTER (WHERE a > 5), count(b), avg(b), variance(b) FILTER (WHERE b < 8), sum(b) FILTER (WHERE b < 8), stddev(b) FILTER (WHERE b > 2) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzslk1v4jAQhu_7K6w5BckocT74yMkIgjYShTbQdqVdVBlisUiQsE5S7ariv69MWpJQCBE9cOEEHs87r2fyWPIbRH9WYIPz437QcYdI6bnjyfhhUENjZ-B0JyhK1gqrYRTFvs9fd3_Z60JhNdR3BxPHQ8rzd8dzEEO_Ek0zOLJqGM3DJIiV2Xuu_H1lYsmCOVdmh8JZKpyjlnRJ1ucy0nOcSuJIr6G-N7pDPosZYAhCnw_Zmkdg_wQCGHTAYAAGEzBYMMWwEeGcR1EoZMrbTuD6f8HWMCyDTRLL8BTDPBQc7DeIl_GKgw0TNltxjzOfC1UDDD6P2XK1s5HWdCOWayb-AYZuuErWQWQjhtEMMIw3TK7qKkEs8BFBYfybC8Dg8cDnwkaUpL1Ytm27w0kLI6qnI2gdRrieRYiMwnSLIUzi7OBRzBYcbLLF1ZvrLBaCL1gcCtUq9jZ-vFOoWZNtPHg9t99_X3VHj8PJx06a8_GFKMnvf46-eKPnsbIXWrlyVsHIysR6ll2I7XXFzCMVjCMVjKMVjJMz1U_ONBtlEoTC54L7hTlOt-VTJ9qRsRM5jb477AxexpNez3lSqI4pwdTITT399-Jm4_tYNfZZzUK8lZV96nhuZ9h1FNrGlGiYErIXEe2zPZH-BqZk55vxK0nEiBoqNTGiFka0odImRlRy2pasaieHahSGSqrfQnLJLVRJXdWvdw_PtJcjonG7hxXvoV4dGf0iZPS6alwPmTPt5ZBp3pCpiIxRHRnjImSMumpeD5kz7eWQad2QqYiMWR0Z8yJkzLpqXQ-ZM-3lkGnfkLnggXhkph6PNmEQ8YOH4vHKmnxAcn_B09dmFCZizu9FON_ZpMvRTrcL-DyK012SLtwg3ZIHzItJqVgviMmhWC93PmNtlKrNcrH5lXNbpeJGuXPjK87NUnGr3Ln1Fed2-bfSzmBSDtmh93T77X8AAAD__yzmtsI=

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(DISTINCT a), variance(a) FILTER (WHERE a > 0) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k1GLm0AQgN_7K5Z5SmCDrppS9ikh9Voh513VXgutD1t3sIJx7e56tBz570WlpDnSI5L0zZ3Zz_lmlnkC86MGDuHn--06isnsbZRm6YftnKThNtxkxHS7mZhTIh7LIRfFm4z0gUehK9EUOBNzchNtszAhs0_vwyQkgnztXNdH4s7JTXJ3S6SwAig0SmIsdmiAfwEGFDyg4AOFACgsIafQalWgMUr3V54GIJI_gbsUqqbtbB_OKRRKI_AnsJWtEThk4luNCQqJ2nGBgkQrqnoo05detbraCf0LKGxU3e0aw0nvk7ai_1w4jIhGEkaU_Y4aKCTYSNScrNjYiMs5j-LsDSUrBvmegurswcZYUSJwtqf_MD6Ido3SEjXKI8l8f6KndVlqLIVV2lket5R-vJ2tvDlQWD-8O7zJGHpYJ9E63oT9jT_P8oK0dyTNzh8zmzxmhy0c7_qD9s539qY7ewvHv76zf76zP93ZXzjB9Z2D852D6c7Bwln-3yU84ZygaVVj8Nkynv6z2y8pyhLHjTaq0wXea1UMZcbj3cANAYnGjlk2HqJmSA2Cf8PsRfj1Eew-h71LKvuXwMEl8HISnO9f_Q4AAP__aKQY7A==

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(a), count(a), stddev(a), variance(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF9r4kAUxd_3Uwz3KcJInCT2T54iVSFgtU1sd2GRMpu5ZAXNuDOTskvxuy9JHpqUmqgFn5ybm-P5zcnlvoH-swEfJj8eZqNwTqxxGC_jx1mPxJPZ5G5JdL61eI8S_pqWv4nMM1OetBECX8vjK1drniVo8R6ZRot7IrjhQCGTAud8ixr8n8CAggMUXKDgAYUhrCjslExQa6mKV95KQSj-gj-gsM52uSkerygkUiH4b2DWZoPgw5L_2mCEXKCyB0BBoOHrTWlTWAc7td5y9Q8o3MlNvs20TwqeeMeLY99mhGeCMCLNb1Sw2lOQuXm304anCD7b0-ORRmmqMOVGKnvYJIqf7q2A9QqYxdN8WT-_RIvvsVWU8WM0DqfTsnmIxznI846RZ1IJVCgaDKt9OzEbHEKOn-5fwgLaaVRuUU3D-Wj2Ei_H48mzFXg0YLR6rWo8j6JwNL-bNFoRZgKVTwJGScDswKEkcCkJPEqC4cGbu42bs-OHg508HDbr284Z49EBVQv76iLj4RwfknN6SE7fds8IqQOqFtL1RUJyjw_JPT0kt297Z4TUAVUL6eYiIXnHh-SdHpLXt4dnhNQBVQvp9uLb-BOeCPVOZho_bOXP_3lQbGsUKVarXctcJfigZFLaVOWi1JUPBGpTdVlVhFnVKgDrYtYqdhpi9lHstDt3WLutaq9d7H2Fe9gqvmp3vvqK83Wr-Kbd-eYrzrft32rQMSbtQ_bRe7X_9j8AAP__fgQ8zw==

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(a), sum(a), avg(b) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lG-r2jAUxt_vU4TzSiFS01avt6-8OAeCf-6swmDIiObQCdq4JB0b4ncfadmuyjUt1b07J_Xx9-Q54RxB_9hBBMMvr-OX0ZQ0Po7iRfx53CTxcDwcLIjO9g3epIT_TBrrJv3XX56TT_PZhAhuOFBIpcAp36OG6CswoOADhQAohEChAysKByU3qLVU9ifHXDASvyBqU9imh8zY4xWFjVQI0RHM1uwQIljw9Q7nyAUqrw0UBBq-3eUYi-4f1HbP1W-gMJC7bJ_qiHBK1kAhPnDbtTxGeCoII9J8RwWrEwWZmTeiNjxBiNiJVnf1kiQKE26k8jqXpuLlpNFnTcu3lW-rwWw5XeT1Lbh_E_7GzFKpBCoUF8DVyW2Ptcv9xcvJt5F1GNhujqlAFZE-o6Tve_2AFuXf9uYlgotLsOpzZXXm6rGW59eYbImvs-i6j5-sXz0Uv1YofssLaoRS4usslKfHhxJUDyWoFUrQ8sIaoZT4Ogul9_hQwuqhhLVCCVtep0YoJb7OQnn-v4vxHfgc9UGmGq8W5Pv_3LaLE0WCxZbVMlMbfFVyk2OKdpbr8gOB2hRfWdGM0uKTNXguZk6xfyFm12LfTS5BB0516BaH9_juOMVdN7l7D_nJKe65yb17yM_uWbVLnon7kV2zV6cPfwIAAP__JjMVtA==

query T
EXPLAIN (DISTSQL) SELECT avg(c), sum(c), avg(d), sum(d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L2kAUxd_7KYb7tIGROEl03TxFrAuCf7ZGoVCkTDOXVNCMnUlKi_jdy0Rho6wTidineG9yPL85d7h70L82EMLw69u4P5qSp8-jeBF_GTskHo6HgwXhv9OnxKFEF9vyaWpxqoVDXuezCRE850AhkwKnfIsawm_AgIIHFHygEACFDqwo7JRMUGupzCf7UjASfyBsU1hnuyI37RWFRCqEcA_5Ot8ghLDgPzY4Ry5QuW2gIDDn601pY6yjnVpvufoLFAZyU2wzHZKEEgEU4h03VctlhGeCMCLzn6hgdaAgi_zdUec8RQjZgd5O1U9ThSnPpXI751DxcvIUMcfwzJbTxel32fUqXc-5CuJdBXn3LzKpBCoUZ-argx2Vta-xxsvJ99GJ60Trn_UDU80xE6hCEjF30I_N1_34dTzrL3oOJRGjJPLdKDCPq4fzzw7Hbp89azJ7l7Vcr8H0a7gqkXYfO33v9oC8RgF5LddvEFANVyWg58cG5N8ekN8oIL_lBg0CquGqBNR7bEDB7QEFjQIKWm6nQUA1XJWAXv7fgv0AZI56JzONF4v2439umwWMIsXjttayUAm-KZmUNsdyVurKhkCdH9-yYzHKjq8MYFXMrGLvTMwuxZ7ducbat6oDuzi4h7tjFXftzt17nJ-t4p7duXeP84t9Vu2aa2K_ZJfeq8OnfwEAAP__XwMnmw==

query T
EXPLAIN (DISTSQL) SELECT max(a), min(b) FROM data HAVING min(b) > 2
----
distribution: local
vectorized: true
·
• root
│
├── • filter
│   │ filter: min > 2
│   │
│   └── • values
│         size: 2 columns, 1 row
│
├── • subquery
│   │ id: @S1
│   │ original sql: <unknown>
│   │ exec mode: one row
│   │
│   └── • group (scalar)
│       │
│       └── • revscan
│             missing stats
│             table: data@data_pkey
│             spans: LIMITED SCAN
│             limit: 1
│
└── • subquery
    │ id: @S2
    │ original sql: <unknown>
    │ exec mode: one row
    │
    └── • group (scalar)
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkE1L80AQx-_PpxjmlMBCkzwX2ZNVW12oaW1LETSHNTvUYLpb9wUKpd9dksWXChU9zm_2P7-d2aN7bZHj6H42GYoSkiuxWC7uJiksRpPR5RI2cpfIlMGm0clTCuP59BaU9BJuhitRXr_zx5Bl_wkKZKiNolJuyCF_wBwrhltranLO2A7t-wdC7ZBnDBu9Db7DFcPaWEK-R9_4lpDjSraB3CBDhoq8bNp-YgEXkORQPwf94lKsDgxN8J9TnJdrQp4d2O9N46b1ZMkO8mNX5BzOi48FOeeiXJ6d9OZ_8c7JbY12dGQ9vVHFkNSa4hWdCbammTV1r4nltM_1QJHzsZvHQujY6j74NZz_GC6-havDv7cAAAD__0das9A=

query T
EXPLAIN (DISTSQL) SELECT DISTINCT (a) FROM data
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a
│ order key: a
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lV2L4jwUx--fTxHO1QxPSk1fnLFXLo4Lgquz6sXC4kXGhrGgTbeJsIP43Zda0PFlclpTvGva_nL-ze9wugX1ZwUR9H-9Dr8NRuThZTCdTX8OH8m0P-z3ZqRYD0a9GXngj-T7ZPyDxFxzoJDKWIz4WiiIfgMDCh5Q8IFCABRCmFPIcrkQSsm8eGW7BwbxX4haFJI02-ji9pzCQuYCoi3oRK8ERDDjbysxETwWudsCCrHQPFntyxSlu1merHn-ARR6crVZpyoiRZ5pxotLx2WEpzFhROqlyGG-oyA3-lhOaf4uIGI7Wj3SS6J0ki60G57m6RbfPc5jkYs4Il12Vu24wdsHWXK1vKDnu2Mi78tEx31kWet8n__Ljb6MzVq1ch8z-RUybdJrqa4GGklHZi4Lz968Xjs4qc2qNw2r3TQuc1zvhrZBQh3Ov323tmGNtg1rpG286uq8-uo8x_VvUIeEOpzB093UeY2q8xpR51dX59dX5ztucIM6JNThDJ7vps5vVJ3fiLqgurqgvrrAccMb1CGhDmfQuZu6oFF1QeP_2SvlJkJlMlWi0l-0VQQW8bsoP1DJTb4Qr7lc7MuUy_Ge29-IhdLlU1YuBmn5qAj4GWbnMPsMeycwqwe3beCODcyscrPQTHvG8_bNsG-W1TbbCox0aIZDG9VmGFFthhHVZhhTjdCI6raN6icj_GyW9WwjywwjsswwIssMY7IQGpHVsZHFkCmKjVG7OWo3SO0mqeUotZulzGqYMmSaBoi0i3FaS5qZxqSZaUyamUalITgm7WKoGqXNd__9CwAA___lEhkY

query T
EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • distinct
    │ distinct on: a
    │ order key: a
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lt1r4kAUxd_3rwj3qWUj8U7iV54sbReEfm11YWHxYWoGK2jizkTYUvzflxjQ-NF7Myb4VpOeuXfO-XHIJ5i_cwjh_vfLw83gybm6GwxHw58P187w_uH-duSY1WLzbPB0O3LktfPj9fnRiWQqwYU4idSTXCgD4R9AcEGACz64EIALLRi7sNTJRBmT6OxfPjeCQfQPwqYLs3i5SrPHYxcmiVYQfkI6S-cKQhjJt7l6VTJS2muCC5FK5Wy-GZON7i_1bCH1B7hwm8xXi9iETrbPcCmzPxseOjKOHHSS9F1pGK9dSFbpbpxJ5VRBiGu3_Ep3M5PO4knqtfb36Wf3ftaR0ioKnT4eTNsd8PbhvEvzfqQer3cbiS832p2T5LMOz_meH_Tl2ti02nu3k2_j0s10qtVUpon28MCo4a_Hqz5efzknKHH3VXzq9icvXthENO02ae1tguVRRWtUPWx44gxYmaW2qbcvBivWCivWAivjUhHWdhVYRXlEhD0iouH5ZyDCLLX1unMxREStiIhaEGFcKiLSqYKIXx4R3x4Rv-EFZyDCLLX1unsxRPxaEfFrQYRxqYhItwoiQXlEAntEgobXOgMRZqmt172LIRLUikhQCyKMS0VEenV9FZ2Y86rMMomNOvg6On1yMzNGRVOVG2mSlZ6oF51MNmPyn88b3eZBpEyav8X8xyDOX2ULFsV4KMaiWOyJ0U7cqSJGrKRuVVL3aLUgDfdpw31SHNCTA1IsmKxbpLpNi9tVQKHFDCi0mAOFUTOgMGoGlA5peJc2vFsFlB7dCU2mFI4qxaoVaDVXC7Sa7QVGzhUDI2cCx6Ni2fddML7TzcJkjnS1YMAMPyoXq9BpNRc6rWZDZ-Rc6IycC53uVWSKFY86xip0umOQKRk8ahmr0Gk1FzqtZkNn5FzojJwLnW5YwTSsoD_aDkMfr7_9DwAA___WjS9z

query T
EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A), SUM (DISTINCT B) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslNGr2jAUxt_3V4TzNCFSk1avt09evA4Er_dOHQyGD9EcXEGbLklhQ_zfR1vQVTQtcY857Zfv-_Ur5wjm1x5imHz_mL1M5-Tz63S5Wn6ddchyMpuMV8Tkh3I2nY9XRHRofbDpkC-L9zcihRVAIVUS5-KABuIfwIACBwohUIiAQh_WFDKttmiM0sUrx1Iwlb8h7lFI0iy3xXhNYas0QnwEm9g9QgwrsdnjAoVEHfSAgkQrkn1pU1iPMp0chP4DFMZqnx9SExNByQYoLDNRnLoBIyKVhBFlf6KG9YmCyu3F0VixQ4jZibZP9ZoYm6RbG_TrkUaMjvhdC37X4nJzniotUaOsXbw-3Qjxsttp3AmrdMCuPs3y29ulqhHrFJ-jNuKduynDWkrWvh7mU0_AugH3KKgh17mggX9BvD0690Ln3SD0QG_IdUZ_8kcP26OHXuhhN4g80BtyndGH_uhRe_TICz3qBn0P9IZcZ_Tn_7ORblgs0GQqNXi1mW7f3Cs2FsodVuvNqFxv8UOrbWlTHd9LXTmQaGz1lFWHaVo9KgL-K2ZOMa-J2bWYu50brEOnOnKLo0dy953igdt58Ijzk1M8dDsPH3F-dnfVa_hN3D_Ztff69OlvAAAA__9iiO4Y

query T
EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY a,b
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a, b
│ order key: a, b
│
└── • filter
    │ filter: ((a + b) + c::INT8) = 27
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8ll2L2kAUhu_7Kw7nysWROJPEj0Ah7a5Lha1uVWhL8SImw27ATWwSocvify9JwKxfczRmc5nRZ-bNvA-HvGH8d4kWDn49PnwZjqBxN5zOpj8ebmA6eBjcziB9Ho5uZ-AwWMD9ZPwdPCdx4Oe3wWQAjYYDTVjcQBNcyxqOZr0b-AyiC-PJ3WACX39nGDIMQk-OnBcZo_UHOTIUyFBHhgYyNHHOcBWFrozjMEr_8pYBQ-8fWm2GfrBaJ-nynKEbRhKtN0z8ZCnRwpmzWMqJdDwZaW1k6MnE8ZfZMWlOexX5L070igxvw-X6JYitLBIDFxlOV0660NI4OIEHHMLkWUY43zAM10lxaJw4TxItvmHnB7v3l4mMZKSZu6nydQsaDZtDE2yRXp6tv789K39AhuN1YoHNmS1OhhKXhLrz48QP3ETje3eVn8FwHHkykt7xQ4t9Fq_w7MTPx_aYb4ps-slsxVZhfuL-Vk1mi2a-2emXMEu8RJHO-JB0o7AVrjSxe7-nIpg7Efj5qvOSqmu8pYkSshPRtrJ36pSdCFV4wuuXnVcue6dC2cX5pomypomWppcwjYi2Na1bp2lEqKIkUb9ponLTuhWapp9vml7WNL2lGSVMI6JtTevVaRoRqihJr980vXLTehWaZpxvmlHWNKOlmSVMI6JtTevXaRoRqijJqN80o3LT-h_0qXjk0ImMV2EQy7O-ANtpbOk9yfxV43AdufIxCt3smPxxnHHZgifjJP-V5w_DIP8pDfge5kpYqGGxD_P3sL4D88vg3jUwF1fRnWto0VbTuvLCDTVsqNsiujaVdEcNd5RwVw13rxFFDROiqGFKFIImRFHTlCi9a0Tpq2dCmxgKxEihZsrBULmkboIm-iZoqnAKJxoncKpyfjBaLumcq0cLN4jW1MOFmwR-MF0uKl1NU6WrabJ0AqdKV-Nk6erJSpV-MGR2W-sRramnDO8T-MGcuah0NU2VrqbJ0gmcKl2NU6UL9YTdL32--fQ_AAD__7NCg8g=

query T
EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY b,a
----
distribution: full
vectorized: true
·
• sort
│ order: +b,+a
│
└── • distinct
    │ distinct on: a, b
    │ order key: a, b
    │
    └── • filter
        │ filter: ((a + b) + c::INT8) = 27
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8ll-L2kAUxd_7KYb75OJInEnin0Ah7a5Lha1uVWhL8SGaYVdwEzsZocvidy8xaNaszjV_yGOiZ-7Jye8e8gbR3zU4MPj1-PBlOCKNu-F0Nv3xcEOmg4fB7YzE18PR7Yx4lCzI_WT8nfie8sjPb4PJgDQaHmmSxQ1pkqXjDEez3g35THiXjCd3gwn5-pssKPGAQhD6YuS9iAicP8CAAgcKJlCwgIINcwobGS5FFIUy_svbXjD0_4HTprAKNlsV355TWIZSgPMGaqXWAhyYeYu1mAjPF9JoAwVfKG-13o-JfbobuXrx5CtQuA3X25cgcvZPQskSKEw3XnyjZTDiBT5hJFTPQsJ8RyHcqnRopLwnAQ7b0euN3a_WSkghDfvUVXLfIY2Gy0iTuDwOzzXfp-ckF0BhvFUOcRl1-UVTPI-pu1WkVsFSGSyTVTKDwlj6Qgr__ND0nMUrefai53NnzHepN_Oit_SoMJmYPapJXd5MDrv8EHaBh0jdWXmSm4ZSCWnwbG68SV3WvDjDLpzA8eAzZkZhK9wY_PTxL1nonFhg168TK7hOBmsZvMBCIdaOC9Wpc6EQUymLrP6FYpUvVKfChUKSOyxUNrdcC8Wvp5kXpZm3DLMAzYi1I83dOmlGTKUg8Ppp5pXT3K2QZiS5A83Z3HLRbF5Ps1mUZrNlWAVoRqwdae7VSTNiKgXBrJ9ms3KaexXSjCR3oDmbWy6aretptorSbLUMuwDNiLUjzf06aUZMpSBY9dNsVU5zv0KakeQONGdzK_zpfmbGRESbMIjEVV_k7Tga4T-JJM4o3MqleJThcj8muRzvdfsbvohU8itLLoZB8lNs8L2YacVcL-ZZMXsvNk_ELJ-4X0bMrFLqUrM5MtvUBm7pA7e0Yls_2da_6o5-dEer7urFXa24pxf3ylCmFyNvWi_GKEPUpWZjlPX1ndBGSkFfKQhnTN8pDCkV9mG_TuUmIv-wYHlwQdTIO0PUGDCYvNx0DBmmLxdmI7nr6wVjRl8vDOkXpi8YhjQMK1UxiBp7a-VKBpOXm44yo-8ZjvQML9UzHPl2wT5e9D3DkZ7hpXoGUWNfIOV6BpOXm44xw_U9w5Ge4fl6Zr779D8AAP__64mJ3g==

query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (hash)
    │ group by: c, d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl1tv6jgUhd_nV1j7CYRRsJ1wyVM6nc4IiYYOF2mqEaoMsSgSJEwSRqeq-O9HCbRc0nrDSZDgzRi-bO-9lpfIO0T_zcGGh3-eOndtl5T-aPcH_b87ZdJ_6DzcD8iEEo-SaLUoSVIhE9tuu4NmmVSI_H9aGpMK8crkz173kXgyluSvXnf4RH5_TjGg4AeecuVCRWD_CwwocKAggIIJFCwYUViGwURFURAmP3lPgbb3A-wahZm_XMXJ9ojCJAgV2O8Qz-K5AhsGcjxXPSU9FRo1oOCpWM7maZnkIM4ynC1k-AYU7oP5auFHNpGUjOnHwfpLmexVDUak7xFGgvhVhUChp3xPhTZxWMURm24pcXjFMSlxBCWOCaM1hWAV7w4XxXKqwGZrenoDd9NpqKYyDkLDOjy_I6iTjOfOfX5xu4MXd9jplBxRzmyZyVZ_-Fhy2OeKJ6v77tAdpOvDo-6qj9_Iq4xejwoz6nAYrXcd8W872j1q5Qehp0LlHTwsfYqmZ1b7qvZxhyzbNP9sVXyuPgbx0k7atsoHMibqfUhnONa36olz1HODarA02JFy2aIVjV3MYoe7ORKvHf3y69rWQW12-l1jv37XDFY1-KVuG9LCnvPqN3LbWJG3jV33bUPU2962enG3jZ_ueJ7D8bxqiEs5HmlhT_3GjTieF-l4ft2OR9TbOr5RnOPF6Y4XORwvqoZ5KccjLeyp37wRx4siHS-u2_GIelvHN4tzvHm6480cjjerhnUpxyMt7KnfuhHHm0U63rxuxyPqbR3fusw7xBcFeypaBn6kTnpDqCXDV95UbZSKglU4UU9hMEnLbD52Uy7d8FQUb75lmw9tf_NVcsB9mB3DbB_mBzA7D27kgRnLRVu56Jae5tqBC_3AhRY29ZVNLcwRrS0tXdfD9TxG0cOIUfQwZhSERoyC0IhRGtqBN_UDb-YxSkufCTUkFDKRclYq6GksFvQ0mgsIjgUDgiOCs0ywHM6dI3PXJwuiOdNHCzOR4plwOUt0PY2JrqdR0REcEx3BMdH1ucqQYGWZjDlLdH3GMCRkWCZlzhJdT2Oi62lUdATHREdwTHR9wnIkYbn-T9ux6KP1bz8DAAD__z1bJ4g=

query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d ORDER BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (streaming)
    │ group by: c, d
    │ ordered: +c,+d
    │
    └── • sort
        │ order: +c,+d
        │
        └── • render
            │
            └── • scan
                  missing stats
                  table: data@data_pkey
                  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl11rwkgUhu_3VwznSslInEliba7Sbd1FsLHrB2xZpEQzWEGNO4nLluJ_X5JoNQnO0Q0BvZuMfeZ8vOc90G8I_16CDZ0_33pPXZfUXrrD0fCPXp0MO73O84jMKPEpCbermkc0MrPtrjtq14lGvH_mtSnRiF8nvw36r8T3Io_8PuiP38iv7wlG-oOXzuDwBRTWgS9cbyVCsP8CBhQ4UDCAggkULJhQ2MhgJsIwkPGffCdA1_8X7CaFxXqzjeLrCYVZIAXY3xAtoqUAG0bedCkGwvOF1JtAwReRt1gmYeK0nI1crDz5BRSeg-V2tQ5t4lEypYfEhhsvvmvojHhrnzASRJ9CAoWBWPtC2sRhmmOktVPicM0xKXEMShwTJjsKwTY6JhdG3lyAzXb08gKGgYyE1K1s7o6hUcfUzobg14R4ms-lmHtRIHXWzMehTixBX_pCCt8mh4sn9_3D7Y8-3HGvV3OMeuHKjK-G49eaw35OPD4998fuKDlnkz_mM_0in174mcuEUYfDZHes0Thb4_GpIM07_5RGHa6lj6makW96ksJpM_YX2cpZsRn8pwXGz-nQoI9u3A6rnpmpeJQOc6Q71lmdzUp64AaNYKPz3CwUs9MUQ25lMmOXu5T9f5fqrKHzqnyKlLD3aauMT5EQp6PJ7tWnrAKf5pt-6z7ll7uBl3ADb-hGVW5ASti74aGMG5AQpwPA79UNvAI35Jt-624wLneDUcINRkM3q3IDUsLeDe0ybkBCnA6Aca9uMCpwQ77pt-4G83I3mCXcYDZ0qyo3ICXs3fBYxg1IiNMBMO_VDWYFbsg3_dbdgPznOhDhJliHIlPVuZebcXOEPxdpQ8NgK2fiTQazJEz62U-45MIXYZT-ytKP7jr9KU7wFGZKmKthnofZKWxkYHYd3C4DM16KbpWheVNNG8qGm2rYVKuFaG0p6ZYabinhBzX8UGZQ1DAyKGoYGxSERgZFTWOD0i4zKI_qndBElgKyUrCdUlgq18iN0IjeCI0JjuGI4giOSc4Kq-UazZl6tTATUU29XJiF4IXtcpXoahoTXU2joiM4JroaR0VXb1ZM9MKSyarWRlRTbxn2iOCFPXOV6GoaE11No6IjOCa6GsdE5-oNmxd9svvlvwAAAP__BAFTvQ==

# There should be no "by hash" routers if there is a single stream.
query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data WHERE a > 9 GROUP BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (hash)
    │ group by: c, d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: [/10 - ]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkl-r00wQxu_fTzHMVUrm0PzpC7pXW4_1WOhJa5qqBy2HbXYIhTQbdxNRSr-7JEE8VYx6Oc_M8-Q3mT2j-1SiwMX7zWq-TMB7udxm2zerCWwXq8VtBjmBJnDtyVPgQy7EMsmeTcAH9bnwDuCDnsCrdH0PWjUK3r1epAtQ8LENgpjhOdyl690GXjz0OUhYGc2JOrFD8QFDJPwf94S1NTk7Z2wnn_uhpf6CIiA8VnXbdPKeMDeWUZyxOTYlo8DE3Jh6GiGh5kYdy37sQmja5ofJNapgFPGFngSH48GZOpScstJsp8FVPHZrytoeT8p-RcJbU7anyglQBAf6vuW2Vp02DYMbJEy50mwFyNCX8fADCWTkyxmBjAnkDH9HHf4L9bwoLBeqMXYaXkPLmOQMCefJw2Oyzh6T3WrlyXjyizTrpO3u3pNh33x758locrVDh95x-yPY0RX2H66YsqtN5fivzhhc9oSsCx5eijOtzXljTd5_ZijXva8XNLtm6MZDsayGVgf41ByOmqNxczRqDn4y7y__fQsAAP__LrkQJQ==

query T
EXPLAIN (DISTSQL) SELECT sum(a), sum(b), sum(c) FROM data GROUP BY d HAVING sum(a+b) > 10
----
distribution: full
vectorized: true
·
• filter
│ filter: sum > 10
│
└── • group (hash)
    │ group by: d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlm9vqkgUxt_vp5icV5qOgRnAP7zCbW3XxGpX7WabXdOgTKyJgneA5DaN3_0GvCmKvXP0osRX_H04Z87zmyd8QPhtCTZ0_n3qtbt9Urnrjsajv3tVMur0OrdjEsarilul6XH68zirkvvh4JF4buSSh-Hg-Yn8-UI88lf7n27_YSshN2RaJf_Hum4IwnSg4Aee6LsrEYL9HzCgwIGCARRMoGDBhMJaBjMRhoFMXvlIBV3vO9g6hYW_jqPk9oTCLJAC7A-IFtFSgA1jd7oUQ-F6QmpJIU9E7mKZlkk6dNZysXLlO1C4DZbxyg9t4lIypWRGiQcURms3uVfTGHF9jzASRG9CAoWh8D0hbeKwG4dT4jBK0qNBiWPCZEMhiKOsrzBy5wJstqHH996ez6WYu1EgNWu_dSe5bvdfXvuD8Wv_uderOFY16fb5seLwzzPj88z8PGPVXHNZvek7eXPDt1wpBpNNtgD-ywVk34n9QHpCCm_vS-lXFEtk-kHh_BrZkWu08mvM-jdOMeB-sYyEFFJjuflvH9jEsTKKbdu-69x2H9s9oDCIIzvhwTGoggbzvMPsB7VgrXE99-bXta292uz4XcR-fxdprKbxC-wjpPsdyOrXuY_YOfcRK38fIQZk-6hewj7ix7PMC7DMa5pxAZaR7neMblwny_ycLPPyWUYMyFhulMCycTzLRgGWjZpmXoBlpPsdo5vXybJxTpaN8llGDMhYbpbAsnk8y2YBls2aZl2AZaT7HaNb18myeU6WzfJZRgzIWG6V_K_-RTNDEa4DPxRH_YnrybCFNxdbZ8IgljPxJINZWmZ7OUh16Q1PhNH2KdtedP3to6TBXTHLi9mumO-J2WniRhExY4XUViF1S63myoEb6oEbSrGprmwqxRzx2lKq62pxvQgoajECilqMgYKoEVAQNQJKQznwpnrgzSKgtNSZoCOhcBApJ6WCWo3FglqN5gIix4IBkSOGs4Ng2Z87R-auThbEc6aOFmYixQ_C5STT1WrMdLUaNR2RY6Yjcsx0da4yJFjZQcacZLo6YxgSMuwgZU4yXa3GTFerUdMROWY6IsdMVycsRxKWq3_a8qZPNn_8CAAA__-5Q_1S

query T
EXPLAIN (DISTSQL) SELECT avg(a+b), c FROM data GROUP BY c, d HAVING c = d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • filter
        │ filter: c = d
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMl11r4k4Uxu__n2I4V0pH4kziW6AQ_922K9jY9WXZskgZzWAFm7iTuGwpfvclsfiW7Rw1CrlLJvllnjPPcw76DuGvGdhw--Ox3Wy5pPCl1ev3vrWLpHfbvr3pE_F7UhDkioyKlIzJXbfzQDwRCXLf7Qweyf9PZEyJR742v7fcezIm18QDCn7gSVe8yhDsn8CAAgcKJlCwgEIFhhTmKhjLMAxU_Mp7ArS8P2CXKUz9-SKKl4cUxoGSYL9DNI1mEmzoi9FMdqXwpDLKQMGTkZjOkm1iVc5cTV-FegMKN8Fs8eqHNhGUjGiiEij05iJeKxmMCN8jjATRi1QwXFIIFtFm3zASEwk2W9LDtd1NZ5FUUhmVXWGrdZs4JrkmTnwCXel7yQq7cjgljknj9c9E8GNENCcTJSciCpTB9g7IiQ1ouk_Pbqf_7A7a7YJjFuMzGTwUHBZf3XQGbv_jevdFXtyTt9lx9EZeRPiytxeD4XJTgvlpCZvvLPxAeVJJb-dLyVd0RVZSG-9rZ-si-cfVcysu00yXaRW33eEG4ox13rLcoBTMDV7ee_Pfe1d29maHtw07vW0MVjL4CY2DqFs3TvWSjYOI2M4Uy2njsHM2TjU3jcMPDy_PEF5eMswTwouoW4e3dsnwIiK2feU5DS8_Z3hruQmveXh4zQzhNUuGdUJ4EXXr8NYvGV5ExLavZk7Da54zvPXchNc6PLxWhvBaJaNyQngRdevwNi4ZXkTEtq9WTsNrnTO8jdyEF_kn1JXhPPBDedCv6XJctvQmcnVGYbBQY_mognGyzeq2k3DJgifDaPWUrW5a_upRLHAbZlqY62G-D7Nt2NyB2XFwPQvMeCa6moXmZT1tag_c0sOW3i3E64qWrurhqhau6eFalqDoYSQoehgLCkIjQdHTWFDqWYLS0M-EMjIUkJGCzZTUUDnGboRG_EZozHAMRxxHcMxylhotx3jO9KOFWYhr-uHCKgiemi5Hma6nMdP1NGo6gmOm63HUdP1kxUxPDZld1-qIa_opwxoInpozR5mupzHT9TRqOoJjputxzHSun7D7pg-X__0NAAD__xrc8ZA=

query T
EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data GROUP BY d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMltFv2joUxt_vX2GdJ1CNgu2EtpEqpbeX3iFR6ALVVm2oMolFkSBmTiKtqvjfpwStBNrZdAaVN2Pyyznf-T4d5RnSHzPwof31tnvZ6aHaf53BcPC5W0eDdrd9NURpPq9xdILGdVw5o-tOd9gOUe3Lp3bYRhx9z5tNFqFY_9QFiuroOuzfoJhnHP0f9u9u0b_3KAYMiYxFj89FCv43IICBAgYGGFzA4MEIw0LJSKSpVMUjzyXQiX-C38QwTRZ5VlyPMERSCfCfIZtmMwE-DPl4JkLBY6GcJmCIRcans7JM0UWwUNM5V0-A4UrO8nmS-ohjNMYowmVjgwUv7hoOQTyJEUEyexQKMIQiiYXyUUBOAopRQFZDCNzifBEwjAIXRksMMs_W7aUZnwjwyRLvLuFyMlFiwjOpHG9TQVBM57J3_9DrDx96d91uLXDrRdN3N7WAVE6_vQjoG3dsq8115fETeuTp41ZRAqPlWgr9o5T1e_JEqlgoEW-8qXyLRixpviq8rXatkb6c2MupnEU_z3wUUBwwrDGE7VdFTzbkwiHe1pNv13Y3apPd80z-Ps8OaTj0cIk2iKiY3Dr2RJN9Jpp8VKLp7qmiFqmiDYcdLlUGEZVBnx57qug-U0U_KlVs91Qxi1SxhuMeLlUGEZVBnx17qtg-U8U-KlXu7qlyLVLlNhzvcKkyiKgM-vzYU-XuM1XuMXzTvdFjKNKFTFKx0xdbs1Ap4olYjSSVuYrErZJRWWb1s19y5UUs0mz1L1n96CSrv4oGqzDZhkkVphsweR_csoHPbWBi1Tfx9DTVzpvpYaY3q6V3y9XSnh72bKzWwwar9bDBaj1sstpAG6xu2Vh9qoXP9Gad2Zilhw1m6WGDWXrYZJaBNph1bmMWMWxR0xq126N2i9Ruk1quUrtdSqyWKTFsU9dg2qt1-i7T9LTJND1tMk1PG00z4CbTXi1VrWmj5T-_AgAA___TVOSq

# Same query but restricted to a single range; no local aggregation stage.
query T
EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data WHERE a = 1 GROUP BY d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: [/1 - /1]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUklGLm0AQx9_7KYZ5Srg54mqehINNr14reJoaQ3u04di4iwSMa3dXaAn57kWlXFJa23ub-c_8x984e0L7rcYQo8_rZBWnMHsXb4rNx2QOmyiJ7guw3XEm4Ab2c7qI4SFOiiiH2acPUR6BgK-d5wUlyOmuOyjn8JBnjyCFE_AiM3ifZ9s1vH0CiYSNlioVR2Ux_IIMCX3cEbZGl8pabXr5NDTF8juGHuGhaTvXyzvCUhuF4QndwdUKQ0z1rW4XPhJK5cShHtrOhLpzLybrRKUwDM50MZhNDy7Evla5ElKZhXc1Hvv1eGsOR2F-IOG9rrtjY0MQBHuCkoYtN63otQW7Hehy1UhlQuDshvsEnI3_lC_7-I4HBHyJfwNnrwFfVZVRlXDaLNg1N18i4Sp9ek6z4jndJsmML-c96vZxxtlF9Ou03P-DFiBh1rkQuE88oAls_wr7H4fMlW11Y9V_XdI77wiVrNT4WKzuTKnWRpfDZ8Y0G3yDIJV1YzUYk7gZSz3gpZlNmv1psz9p9n4z785vfgYAAP__cvQaVQ==

# Verify the XOR execution plan
query T
EXPLAIN (DISTSQL) SELECT xor_agg(to_hex(a)::bytes) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslNFu2jAUhu_3FNa5KpJRcBIo9VVZxyokVjrgotOEkIePUiSIme1ITIh3n5JsakCtkyi5Iwl_vj_fsc4JzO8dcBi_PE9Hkydy82WyWC6-TztkMZ6OH5bkqPRaRNGNVetXPN6IDueffyzHiw75Op99I1JYARRiJfFJ7NEA_wkMKPhAIQAKIVDow4rCQasNGqN0-pdTFpjII_AehW18SGx6e0VhozQCP4Hd2h0Ch6X4tcM5Cona6wEFiVZsdxkmRd8f9HYv9B-g8KB2yT42nKR9FgeR_ux6jIhYEkaUfUUNFOYYS9Sc_Puce_b_e2B1pqAS-1bFWBEhcHam1euOokhjJKzSXv-y7ctsvh49PqbED1H-h6g3QhIrLVGjvHj96uwuw3r12wQXbVj1ObHac_JY1_NbnlRJ4YKcQdNJ-dXd-PXd-F0vaNlNSeGCm9umboLqboL6boKuF7bspqRwwc2wqZuwupuwvpuw6_VbdlNSuODmrs3t9w5qjuagYoNXW_D9N_fS7YgywnyVGpXoDT5rtckw-eUsy2U3JBqbP2X5xSTOH6UFi2HmDPsXYXYd9t3kEnTgTIfucNikd98ZHrjJgybkW2d46CYPm5Dv3LPqlRwT9yG7Zq_On_4GAAD__1kTGwE=

# Verify the XOR execution plan
query T
EXPLAIN (DISTSQL) SELECT xor_agg(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslEFro0AUx-_7KYZ3amBER02aemroZksg23STHAqLlNnMww0Yx50ZoUvId1_UQ01oR417i5q_v__PN7wj6D8pRDB_eV7OFk_k5utis938WI7IZr6cP2zJm1SvPElu-Ih8W6--E8ENBwqZFPjED6gh-gkMKPhAIQAKIVAYQ0whV3KHWktV_uVYBRbiDSKPwj7LC1PejinspEKIjmD2JkWIYMt_pbhGLlC5HlAQaPg-rTAl-j5X-wNXf4HCg0yLQ6YjUvbZ5Lz86biM8EwQRqT5jQriEwVZmHecNjxBiNiJdq80SxKFCTdSuePzRi-r9evs8fHmno0-Rfmfot4JRSaVQIXi7PXxyV6Gef3bBGdtWPdZsN6zcJnj-ldMo6VU4wNMhk7D7-7v9_f3HTe4wr-lVMP_dqh_0N0_6O8fOG54hX9LqYb_dKh_2N0_7O8fOu74Cv-WUg3_u_-5jT5ArVHnMtN4sZU-frNXbisUCdarTctC7fBZyV2FqS9XVa66IVCb-imrLxZZ_ags2Awza9g_C7PLsG8nt6ADazq0h8MhvcfW8MROngwh31rDUzt5OoR8Z5-V13JM7Ifskh2fvvwLAAD__4NM6_k=

query T
EXPLAIN (DISTSQL) SELECT max(t.a), min(t.b), avg(t.c)  FROM (VALUES (1, 2, 3), (4, 5, 6), (7, 8, 0)) AS t(a, b, c) WHERE b > 3
----
distribution: local
vectorized: true
·
• group (scalar)
│ estimated row count: 1
│
└── • filter
    │ estimated row count: 1
    │ filter: column2 > 3
    │
    └── • values
          size: 3 columns, 3 rows
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkV-r00wQh-_fTzHM1S4Mbf68atmrRs3RQNtzbGo9oLnYJkMMptm6u5EDpd9d0oBaocVzN_ObPPNkkiO67y0qTB8fFkm2AvE2yzf5h4WEPF2kbzaw10_CT7Qk2Ded8JOdJNA_auEnpYS79f0SxDZZfExzECFBRBBLAvE_wQuCl0P5imBGEEgJSQ4ehCbYEZQSPr1P1yns4EsfBDFDjISdqXil9-xQfcYQC8KDNSU7Z-wQHc8PZNUTqoCw6Q69H-KCsDSWUR3RN75lVLjVbc9uGiBhxV437bhxBq9BxFB-7btvTmJxIjS9_73GeV0zquBE_666a1rPlu00vJSNuYJ59OtCpVS22syuesPneJO6tlxrb-w0ujQvk0cxDyUSLrOVmEdDlWzfiXl8_eToOeo1u4PpHF9or3_MgpCrmsc_6ExvS36wpjxrxvb-zJ2Dip0fp-HYZN04Gl7wTzi8CUe34egmHP8FF6f_fgYAAP__w4r5VQ==

query T
EXPLAIN (DISTSQL) SELECT * FROM (VALUES (1, '222'), (2, '444')) t1(a,b) JOIN (VALUES (1, 100.0), (3, 32.0)) t2(a,b) ON t1.a = t2.a
----
distribution: local
vectorized: true
·
• hash join
│ estimated row count: 2
│ equality: (column1) = (column1)
│
├── • values
│     size: 2 columns, 2 rows
│
└── • values
      size: 2 columns, 2 rows
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJykkFGL00AQgN_9FcO8NJGht7sNPgQOUrVij9icl_MQJA9rMrbBmK27GxBK_rskUe5arFJ8252Zb76ZOaD73mCMq4-36XK9geD1Or_P36ch5Kt09eoensObu-wdBA_L9MMqh0ASzJRSs5AgUASzKIpmYQjLHLyEQBN8DuEmGzo9IaQQczEQC4KFmotfgPoNZBvwcq7hGryaayRsTcUb_Y0dxp9QYkG4t6Zk54wdQoexYF39wFgQ1u2-80O4ICyNZYwP6GvfMMb4oJuO3ZVAwoq9rpupYwQvIVBQ7rr2qwux6AlN5x_bOK-3jLHo6WKVPFG9-F_Vo6Frja3YcnWkKAbyXyV_mPetdrsbU7dsr9TxzA1_8UEiw2tbb3fjCwmzzseQSEoUJQtKorObyEuOdsdub1rHpxuduVFByNWWp7M409mSb60pR830zUZuDFTs_JRV02fdjqlxwKewvABWp7D6K7w4gkVf9M9-BgAA___I6BDw

statement ok
CREATE TABLE nullables (a INT, b INT, c INT, PRIMARY KEY (a))

query T
EXPLAIN (DISTSQL) SELECT array_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • filter
    │ filter: ((b = 1) AND (c = 1.0)) AND (d = 1.0)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVGL2kAUhd_7K4b7lNCxcZK46w4Ukq5xG3B1G4V2KbKMmSEVYsZORugi_vcS47pVaiLmxTfvvZ6ck-8OmTXkv1OgEPx4GvjhEBm9cDwZfxuYaBwMgvsJYkqx1xeWJAYzUT8aPSLjbVKWnGmGvn8NogAZxgx9RsRE_rCHjLj4_alt7kq-K9Eo6gUR-vKMmAkYMsnFkC1EDvQnEMBgAwYHMLiAoQNTDEslY5HnUhV_WW8FIf8DtI1hni1XumhPMcRSCaBr0HOdCqAwYbNURIJxoaw2YOBCs3m6tSkie0s1XzD1ChjuZbpaZDlFDKMZRjFGHDCMl6zotSyCWMYRQVL_EgqmGwxypd99c80SAZRs8PnZ-vNUCyWU1TkMVvYpMgzPLnBRSsPhpLsj6DklQkppfzDyJ903tJ67H_SC-_DRHxRkRytNkUdOJrZPJn4PKhUXSvDDlB75CNPNf17LTxIlEqalssgRcj-K_OcX_-HB8Ih5MpJzEImcv2By-YIt0rLsC1Zck26_4purWbF9Pk-7AU-7ZTkX8KxJt-d5ezU8nfN5Og14Oi3LvYBnTbo9z-7V8HTP5-k24Om2rM4FPGvS7XneXQ3PmksoEvlSZrk4yHvqye3iey94Isr7IZcrFYsnJeOtTVmOtrptg4tcl1NSFmFWjoqA_4pJpdg-EJNjsV3tXGPtVKrdarHbJHenUnxT7XzTxPm2Utytdu42cb6r3lW75phUH7Jj7-nmw98AAAD__1XcVrc=

query T
EXPLAIN (DISTSQL) SELECT json_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • filter
    │ filter: ((b = 1) AND (c = 1.0)) AND (d = 1.0)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVGPmk4Uxd__n2JynyD_sTiAu-4kTaAru6VxZYsmbdOYzchMqA0ydhiTNsbv3iDWraaCkRffvPd6OIffnTBrKH5kQCH4_Dz0wxEyBuF4Mv44NNE4GAb3E_S9kPkLS1ODmeghjp6QsRuwquRMM_TpfRAHyDBm6C0iJvJHA2Qk5e83XXNX8l2JongQxOjdF8RMwJBLLkZsIQqgX4EABhswOIDBBQw9mGJYKpmIopCq_Mt6Kwj5T6BdDPN8udJle4ohkUoAXYOe60wAhQmbZSIWjAtldQEDF5rNs61NGdlbqvmCqV-A4V5mq0VeUMQwmmGUYMQBw3jJyl7HIojlHBEk9TehYLrBIFf61bfQLBVAyQafn-1hnmmhhLJ6h8GqPkWG4dklLkppOJr0dwQ9p0JIKX0YRv6k_wet5-4Hg-A-fPKHJdlopSnyyMnE9snEr0Gl4kIJfpjSI__DdPOP1_LTVImUaakscoT8wzgavfiPj4ZHzJOJnINE5Pz9ksv3a5GOZV-w4YZ0-w3fXM2G7fN52i142h3LuYBnQ7o9z9ur4emcz9NpwdPpWO4FPBvS7Xn2r4anez5PtwVPt2P1LuDZkG7P8-5qeDbcQbEoljIvxEHeU0_ulp97wVNRXQ-FXKlEPCuZbG2qMtrqtg0uCl1NSVWEeTUqA_4tJrVi-0BMjsV2vXODtVOrduvFbpvcvVrxTb3zTRvn21pxv96538b5rn5X3YZjUn_Ijr2nm_9-BwAA__8YDFYN

# Test that orderings on GROUP BY columns are propagated through aggregations.
statement ok
CREATE TABLE sorted_data (a INT PRIMARY KEY, b INT, c FLOAT, INDEX foo(b))

# Split into ten parts.
statement ok
ALTER TABLE sorted_data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE sorted_data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE sorted_data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: a
│
└── • scan
      missing stats
      table: sorted_data@foo
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFrq0AQxu_vr1jmpLAhangXT_ry0iIYTdVAQpGwcacSMK7dXSEQ_N-LemhSiG2P38z8Zr799grqvQIXVrtN6AcRMf4HaZa-hCZJV-FqmRFGyZldjKNJnpJ4TZSQGvmBM83IcxJvN-TfnjCgUAuOETujAvcVbKDwF3IKjRQFKiVkX74OQwG_gGtRONVNq_tyTqEQEsG9gj7pCsGFSMxEM3eAAkfNTtUw1lEQrf6ElGYlgrvo6M1ie3pxxo4VJsg4yrl1tx5uXua9CQEUlqJqz7Vy-wyOQCFtWK9m8MiK_RsrfllKLJkWcm7fO_F67Uf7QxRnh2gbhoZnm0Bh7e8MzzEfnnfuzn8TcYKqEbXCH2VsdTkF5CWO36hEKwvcSFEMZ0YZD9xQ4Kj02F2MIqjHVm_wFrYnYWcadiZh6wucd38-AgAA___wvPC6

query T
EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMll1v2jwYhs_fX2E9R6DXKDgftM0RrGUTEk26QKVWE6oMsSgSxJkdpFYV_31KckBoVzvFYeKshl72bV-3HvEG8vcafBg-3I0HowC1bkaT6eTnuI0mw_HweoooRhv60pq30fcovEWSi4zFTzHNKPoRhfd36NsjoiiMboZR8SdgSHjMArphEvxfQACDDRgcwOACBg9mGFLBF0xKLvJ_eSuAUfwCfhfDKkm3Wf7xDMOCCwb-G2SrbM3Ahymdr1nEaMyE1QUMMcvoal0cU8nVT8VqQ8UrYLjm6-0mkX5-izlgmKQ0X3UsgmgSI4J49swEzHYY-DbbHywzumTgkx2uH26wXAq2pBkXlneYrZ-_QShiJljso2I1CB6fgnD6FNyPx60-aQOG28FDq2-334XZ7z9_Rc9UPn_YerbbB7Y_Dbzfh5dB3u_zf7mR4lak29y19pGdxiMHvMNTixxK-Ox49-B4Ur9_xKB_FulY9hEN1MSruOqdRwNJww0kp2-gXb8CtkkF7I7lHFEBTbzKY12cRwXshitgn74CTv0KOCYVcDqWe0QFNPEqj3V5HhVwGq6Ac_oKuPUr4JpUwO1Y3hEV0MSrPNbVeVTAbbgC7r_9KfKXNBGTKU8kq_Uro5vfh8VLVt5f8q1YsDvBF8Ux5TIsuOKDmMms_JaUi1FSfpUHrMLkPUyqsH0Ak6_BPRP4ygQmRrmJp6Zt5Xs7athRy-qpbblK2lPDnolqNaxRrYY1qtWwTrWG1qjumai-UMKXalmXJrLUsEaWGtbIUsM6WRpaI-vKRBbRTFHdGDWbo2aD1GySGo5Ss1lKjIYp0UxTVyPtwzj9kjQ1rZOmpnXS1LRWmgbXSfswVJXSZrv__gQAAP__pFWB-g==

query T
EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlk9v4jwQxu_vp7DmBHqNgvOHtjnR7XZXSDR0gUpbrVBliEWRIGYdR9qq4ruvkhxIgfWkmEOOifPzPDPPo1HeIf29hhDufz4ObwcRaX0dTKaTH8M2mdwP7--mZEHJZpW05m1KOPk2Hj2QVCot4peYa06-j0dPj-TLM-GULIBCImMR8Y1IIfwFDCi4QMEDCj5QCGBGYavkQqSpVPkn7wUwiP9A2KWwSraZzl_PKCykEhC-g17ptYAQpny-FmPBY6GcLlCIheardVGmoqe_VasNV29A4U6us02ShrmyeSlusuX5i47DCE9iwojUr0LBbEdBZnpfO9V8KSBkO1pf3-1yqcSSa6mc4KO8fj6GkYqFEnFIiqfb6PklGk1foqfhsNVnbaDwMIhafbd9dOi1D_TtS87fyCtPX4-qzXb7Htx_9rC_R5baDu_5v7zI0CjrXrhTCqNMh6Tv0b5Li05OO-PV6CpLTvV1sqVIduTWYcHBl6dr-x9qs_qpZXapdVjHcc_ILaKwYmevsbllF84ta0Ru3frZcS2z43Yc74zsIAorI71qbHbcC2fHbUR2vPrZ8Syz43Uc_4zsIAorI71ubHa8C2fHa0R2_PrZ8S2z43ec4IzsIAorI71pbHb8C2fHb0R2kL_gsUi3MklFrT-pbt6yiJeiHFEqM7UQj0ouijLl46jgihexSHV5ysqHQVIe5QKrMDuEWRV2P8Dsc3DPBr6xgZmVbhaYadc4b88Me2azema3fCMdmOHAxmozjFhthhGrzTBmNUIjVvdsrL4ywtdms65tzDLDiFlmGDHLDGNmITRi1o2NWQzZotgatdujdovUbpNarlK7XcqslilDtqmPmHa0Tj9lmpnGTDPTmGlmGjUNwTHTjpaq0bTZ7r-_AQAA__-jlsiE

query T
EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllFv2jAUhd_3K6z7BJpRcBJomye6lk1INOmASqsmVJnEokgQZ7aRViH--5TkgQCtTTETPDrm8z33nqMrViD_zCGA7q_H_m0vRLX73nA0_Nmvo2G3370boRijxSytTeoYUfR9ED0gyYViyUtCFUU_BtHTI_r2jChGMYoG991BcQIMKU9YSBdMQvAbCGBwAYMHGHzA0IIxhkzwmEnJRf6TVQH0kr8QNDHM0myp8s9jDDEXDIIVqJmaMwhgRCdzNmA0YcJpAoaEKTqbF2Uq0jqZmC2oeAMMd3y-XKQyyEVOMIoBwzCj-YeGQxBNE0QQV69MwHiNgS_VprZUdMogIGt8uL7b6VSwKVVcOK1teZ18DJFImGBJgIrTbfj8Ekajl_Cp3691SB0wPPTCWset71169R19m5KTN_RK5etetfF604P7YQ-bd3ipbfedr-VDmkZJ8792uunCO3kXIW_wzCE7VkVLFaCOhzsuLub4vhp_Sw05PLfELrcOaTjuEck1KKwY2r7Y5JITJ5ecJbnu4VlxLbPiNhzviKwYFFZGeHWxWXFPnBX3LFnxDs-KZ5kVr-H4R2TFoLAywuuLzYp34qx4Z8mKf3hWfMus-A2ndURWDAorI7y52Kz4J86Kf_Z_T-8IHDCZ8VSyLW0fvdzMW2TJlJUjkXwpYvYoeFyUKY9RwRUfEiZVeUvKQy8tr3KBVZjswqQKu1sw-RzctoFvbGBipZu09LSrnbenhz29WW29W76Wbunhlo3VethgtR42WK2HTVYbaIPVbRurr7Twtd6saxuz9LDBLD1sMEsPm8wy0AazbmzMIoYtalqjdnvUbpHabVLLVWq3S4nVMiWGbeobTNtbp58yTU-bTNPTJtP0tNE0A24ybW-pak0br7_8CwAA__9k3bxt

query T
EXPLAIN (DISTSQL) SELECT b, max(c) FROM sorted_data@foo GROUP BY b
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: b
│ ordered: +b
│
└── • index join
    │ table: sorted_data@sorted_data_pkey
    │
    └── • scan
          missing stats
          table: sorted_data@foo
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUklFr2zAQx9_3KcT_KQGVxHb34idnXTYyXDtLUmgZISjWzRgcnyfJ0BHy3YftsTUFe-vjnfS7_--QzrA_SoRYPq7jxSoRk4-r7W77NZ6K7TJe3u3EUYqTep5kU_Fpk94Ly8aRPmjlVPSdWXzepA9r8eFJHCFRsaZEncgi_AYPEu-xl6gNZ2Qtm7Z97i6t9DPCuURR1Y1r23uJjA0hPMMVriSESPiG61kACU1OFWV37SLBjfsLWadyQnh7kS8Ge-ODd-pY0oaUJjObX43Hq-0gccdlc6psKJTsVtzWqq1uIJE2LhSRhyEp7y1SX7iofjt5w061KU7K_PwT7ssoGMz335K_yHNDuXJsZv51ftT6pEaTId3tK7FIng5JujskD3E8ibwpJO4Xj5PInw7KBFcy_3j6DdmaK0v_9fbzy16CdE7997LcmIzWhrMupi_TjusamqzrT2_7YlX1R63gS9gbhf1x2B-Fg3E4GIXnr-D95d2vAAAA__-gfDdx

query T
EXPLAIN (DISTSQL) SELECT * FROM (SELECT a, max(c) FROM sorted_data GROUP BY a) JOIN (SELECT b, min(c) FROM sorted_data@foo GROUP BY b) ON a = b
----
distribution: full
vectorized: true
·
• merge join
│ equality: (a) = (b)
│ left cols are key
│ right cols are key
│
├── • group (streaming)
│   │ group by: a
│   │ ordered: +a
│   │
│   └── • scan
│         missing stats
│         table: sorted_data@sorted_data_pkey
│         spans: FULL SCAN
│
└── • group (streaming)
    │ group by: b
    │ ordered: +b
    │
    └── • index join
        │ table: sorted_data@sorted_data_pkey
        │
        └── • scan
              missing stats
              table: sorted_data@foo
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMl1Fv4jgQx9_vU1jzBLdGwU6gFGklenu9EysKvbYr7eqEKkNcigQx5wRpV1W_-ymkJwIBT4zpbd42IT97Jvn9d-oXiP9ZQBeuv94OrvpDUvu9f_9w_9egTu6vB9efHsiv5I-70Q2pvV0KSpbie21az27HSicyfAxFIsifd6Mvt-S3b0TUyedRutYbM6FkOY8OMb0npbbcpE5GQyLIRzIBCpEK5VAsZQzdv4EBBQ4UfKAQAIUWjCmstJrKOFY6feRlA_TD79BtUphHq3WS3h5TmCotofsCyTxZSOjCg5gs5J0UodReEyiEMhHzxWabfGkrPV8K_QMofFKL9TKKu2nzU6BwvxLpVcNjREQhYUQlz1LD-JWCWifbjeNEzCR02SstX9zVbKblTCRKe63d2nrpOxjpUGoZdsnm6mr47XE4engcfhkMaj1WBwo3V19rPV7fK2a7_uQHeRbxc2Hp8eu2YH604O06Kitkf50P2UKGrljzZ7Xlu7VFt0-to0PPHez8RuqZ_KzmkdQe6-yuu5BPSa3HPtQ_6vnsOftn-jLWSfoiaI_Tnk97wVGxLko0ZFHqUDXUyuP-3pOH9-7s7M3KJ445JM5jDY-fkDmkvJyd7Wpkjp05c6wambNu6wyZu3zPzPHy3nMX73nD80_wHikvZ8hFNbznZ_aeV8N767bcvefN9_TeL--97-K93_CCE7xHyssZ0qmG9_6Zvfer4b11W2fwnr2n90F57wMX74OG1zrBe6S8nCGX1fA-OLP3QTW8t9CEtY578qTUniOT3Olza_FROwKbqtIA_VdUu4y82e5pgI4W0DpRT3ba3yP9ofOHbLv5eYb_wPj_dUg8UMidjFcqimWpI2AzbUWGM5m9nVit9VTeajXdbJNdjjbc5kYo4yT7lWUX_Sj7KS0wD7N9mOVhvgMzO_jCBWbMiW450Zdmmhtp3wXuuMAM-VwI3XahOdK2b5Q0MMOBEeaBWfGWkW6b4bZLPswwkg8zjOUDoZF8IDSSjwuXfJhhJB9mGMsHQiP5MNNYPjou-bg0T4AmMgIKA8RqBphpbAiYaXQKIDg2BhAc8ZyZxwjyxREaMR2hMdUxHHEdwTHZWWGW2NjOzLOEIeOAFaaJle5mGtPdTKO6IzimO4JjuhcGqZXuZhrT3UyjuiM4prsZR3UvjFMr3QuDZVf3DqJ7YbJY6W6mMd3NNKo7gmO6Izime2GqWulupjHdzTSqO4JjuptxTHduPpBy5ETKC7NlF-cIbnM645Z0x4ne-2zWeNsJ51jrdke08esv_wYAAP__wv1K7A==

# Verify that the stages preserve the ordering as expected.
query T
EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllFv2j4Uxd__n8K6T6AaBTuB0jyFf0snJEq6QKVVE6pcYlEkiJkdpFZVv_uUZBsBVpvidOKNmPyuz73n6CqvoH4swIfet9tBtz9Etav-aDz6OqijUW_QuxwjtV7WnuvoOgpvUO3XGcPo0fevB2F33EFnaIq6I_RcvBKzlNXRlyi8u0X_3yOGwuiqF-U_AUMiYj5kS67A_w4EMFDA4AIGDzC0YIJhJcWUKyVk9sprDvTjZ_CbGObJap1mxxMMUyE5-K-QztMFBx_G7HHBI85iLp0mYIh5yuaL_JpMUbCS8yWTL4DhUizWy0T5eRMYTQHDaMWyg4ZDEEtiRJFIn7hUgCHiScyljwL3LKC_O8YoIDB5wyDW6UaRStmMg0_e8OGqu7OZ5DOWCum0tkUH2WBCGXPJYx_lT93h_cMwHD8M7waDWkDrmfC7m1pA6jtiNvUfX9ATU087pTPxG8H0XcGbOqIQslvnrCik6Yo09-4ut0X22iJ_2qK7bW0ku5VLHoqGWDlkx4Rwneazf0-Ht6WDHJ5QcmRCHdJwaJ5RUmS0gogaZJfMbJ9GREnFESWfH1F6eDTosdGgDcetOBoG2aUhnp9GNGjF0aCfHw338Gi4x0bDbThexdEwyC4NsXMa0XArjob7-dHwDo-Gd2w0vEb-5WEbB4PU0uAuTiMOXsVx8P7td85f1ERcrUSi-JaQ9yo3s354PONF_0qs5ZTfSjHNrykew5zLD2Ku0uJfUjz0k-KvTGAZJrswKcN0CyYfg9s28IUNTKx0k5aeptp5u3rY1ZvV1rvlaemWHm7ZWK2HDVbrYYPVethktYE2WN22sfpcC3f0ZnVszNLDBrP0sMEsPWwyy0AbzLqwMYsYtqhpjdrtUbtFardJLVep3S4lVsuUGLapZzBtb51-yDQ9bTJNT5tM09NG0wy4ybS9pao1bfL2388AAAD__wG6nyA=

query T
EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) WHERE a > x GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • filter
    │ filter: a > x
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlttv2jAUxt_3V1jnCVSjYCfc8hTW0g2Jki5QbdWGKpdYFAkIc4JEVfV_n5KsXMLqwyWdeAMnP5_P_r5zlBcIf0_AhtaP206z3SWFq3av3_vWKZJeq9O67JNwMS0si-Tac29I4e-aoOTRtq87brNfJxdkSJo9skxf8UUkiuT715bXIoL8WpTLpiRL8sVz727J53siiOtdtbzkJ1CYBb7siqkMwf4JDChwoGACBQsoVGBAYa6CoQzDQMWvvCRA21-CXaYwns0XUbw8oDAMlAT7BaJxNJFgQ188TqQnhS-VUQYKvozEeJKUiSU6czWeCvUMFC6DyWI6C-3kVJQMgUJvLuKFksGImPmEkyB6kioECp6c-VLZxDEvHP52BZQ4DAavFIJFtFYURmIkwWavdH_V1-NJJJVURmVbcrpuE4e_XammIj-kYnM0UnIkokAZLHNPTuyFq3yppB-XBgrN7v1D1-0_dO86nYLDi_Fd3d0UHFbMqFkXeHwmTyJ8ymwdq18rNt9VvN4nSIVk97lIN9Idq7JTe_NYbOdYbHUsnj3WWrKVu-RuUArmBs-Y4C6i5O7f01HZ0sH2bwp2ZFMYrGTwpC1Y2hY5dAUie9UV1dy6Aqm4GR92Hl3Bcu6K6sd3Bd8_jfzYNPKSYeacRkT2Ko213NKIVNy0jZ9HGnnOaax9fBrN_dNoHptGs2RYOacRkb1KYz23NCIVN20zzyONZs5prH98Gq3902gdm0arlHxHnppAROoqgY3cEohU3LTKOo8EWjknsPF_v1n_ocaT4TyYhXJLyHs7l-PzSH8k0_OHwUIN5a0KhkmZ9K-bcMmCL8MofcrSP-1Z-igWuAkzLcz1MM_CbBM2t2B2GFw_BWb8JLp6Cs3LetrUXrilhy29W4jXFS1d1cNVLVzTw7VTgqKHkaDoYSwoCI0ERU9jQamfEpSGfiaUkaGAjBRspuwMlUPsRmjEb4TGDMdwxHEExyxnO6PlEM-ZfrQwC3FNP1xYBcF3pstBputpzHQ9jZqO4Jjpehw1XT9ZMdN3hsy2a3XENf2UYQ0E35kzB5mupzHT9TRqOoJjputxzHSun7BZ0wevn_4EAAD__6UBxH0=

# Ensure that an interesting input ordering that causes an ordered group by
# forces an ordered synchronizer. We create an index on b even though it's
# not used to help the optimizer realize that there's an ordering available
# on b for a constrained scan on the a,b primary index.

statement ok
CREATE TABLE data2 (a INT, b INT, PRIMARY KEY (a, b), INDEX(b));
ALTER TABLE data2 SPLIT AT SELECT 1,i FROM generate_series(1, 9) AS g(i);
ALTER TABLE data2 EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i);

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data2]
----
start_key  end_key  replicas  lease_holder
NULL       /1/1     {2}       2
/1/1       /1/2     {5}       5
/1/2       /1/3     {5}       5
/1/3       /1/4     {5}       5
/1/4       /1/5     {5}       5
/1/5       /1/6     {5}       5
/1/6       /1/7     {5}       5
/1/7       /1/8     {5}       5
/1/8       /1/9     {5}       5
/1/9       NULL     {5}       5


query T
EXPLAIN (opt,verbose) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b
----
group-by (streaming)
 ├── columns: b:2 count:5
 ├── grouping columns: b:2
 ├── internal-ordering: +2 opt(1)
 ├── stats: [rows=9.561792, distinct(2)=9.56179, null(2)=0, avgsize(2)=4]
 ├── cost: 25.1456179
 ├── key: (2)
 ├── fd: (2)-->(5)
 ├── distribution: test
 ├── prune: (5)
 ├── scan data2
 │    ├── columns: a:1 b:2
 │    ├── constraint: /1/2: [/1 - /1]
 │    ├── stats: [rows=10, distinct(1)=1, null(1)=0, avgsize(1)=4, distinct(2)=9.56179, null(2)=0, avgsize(2)=4]
 │    ├── cost: 24.82
 │    ├── key: (2)
 │    ├── fd: ()-->(1)
 │    ├── ordering: +2 opt(1) [actual: +2]
 │    ├── distribution: test
 │    ├── prune: (2)
 │    └── interesting orderings: (+2 opt(1))
 └── aggregations
      └── count-rows [as=count_rows:5]

query T
EXPLAIN (verbose) SELECT b, count(*), corr(a, b) FROM data2 WHERE a=1 GROUP BY b
----
distribution: full
vectorized: true
·
• group (streaming)
│ columns: (b, count, corr)
│ estimated row count: 10 (missing stats)
│ aggregate 0: count_rows()
│ aggregate 1: corr(a, b)
│ group by: b
│ ordered: +b
│
└── • scan
      columns: (a, b)
      ordering: +b
      estimated row count: 10 (missing stats)
      table: data2@data2_pkey
      spans: /1-/2

query T
EXPLAIN (DISTSQL) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b;
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: b
│ ordered: +b
│
└── • scan
      missing stats
      table: data2@data2_pkey
      spans: [/1 - /1]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVO-Lm0AQ_d6_YplPSbuH2c2PglAwvdpW8DRVw_UoEja6eAHj2t0Vehz534t6EJPmvMu1lPs4zr6Z9948vAf1MwcT7O8Ld-54aPDJCaPwmztEoe3alxFaY5SIqtCDt0P0OfCvUMo0o-j6qx3YiKEPiKAvgb9coI83aA0YCpFyj225AvMHEMBAAcMUYgylFAlXSsi6dd88dNJfYI4wbIqy0u1nvdE5BxOqQsiUS54ChpRrtsnrfryLMSRCcjD3Tz1xIUpjdvQQg6j0w9gYg9Is42BOdrizmnRWnxgcsXXOA85SLo3RwXhoXLBKudkyeQcYLkVebQtlIoYbG8KS1ZVBLgxi1Db4lTaRReExYuQcYvMskzxjWkiDHvKyml2tcyZqqrl3s_L8aOUtXXdgkWHN1l960Srwr8PB8IjRfsn6Dt0ydfvH_OYGD6zpo6z3c07dESzyDk4esyNt8hJp4fJq5XjRwKLHyvasxwes6fNDQF4YgjoG9OwQPEGs49T4FYWA_tsQTP9PCEb9XgdclaJQ_Fn_mFEtiacZby1QopIJX0iRNGva0m9wzYeUK91237eFU7StmmAXTHrBtB9Mj8GkCx4fgMl54Fk_eNxLe9QPnvSCp_2ap3-juR_8hObZWZrj3ZvfAQAA__8KfWZL

statement ok
CREATE TABLE uv (u INT PRIMARY KEY, v INT);
INSERT INTO uv SELECT x, x*10 FROM generate_series(2, 8) AS g(x);

# Regression test for #37211 (incorrect ordering between aggregator stages).
query T
EXPLAIN (DISTSQL) SELECT sum(v) FROM data INNER LOOKUP JOIN uv ON (a=u) GROUP BY u ORDER BY u
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: u
│ ordered: +u
│
└── • lookup join
    │ table: uv@uv_pkey
    │ equality: (a) = (u)
    │ equality cols are key
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlltv2koUhd_PrxjtJ9AZZGZsbpaORE5CK1JiUy5SowpFDh4RWvBQX6JGEf-9sl0VY8psHAjizcb5ZtbMWnsprxD8WIAJnS_93lXXIqWb7nA0_Nwrk2Gn17kekSBalp7L5MPAviOuEzqka1mdAenZ9qdxn9zaXYtEz8S2SMkh_5GoTD4O7HGf_H9PImIPbjqD5BEoeNIVlrMUAZhfgQEFDhR0oGAAhRpMKKx8ORVBIP34T14ToOv-BLNKYe6tojD-eUJhKn0B5iuE83AhwISR87gQA-G4wteqQMEVoTNfJNvEgtsrf750_BegcC0X0dILTOIAheHKiR8rGiOO5xJOZPgk_AAmawoyCjf7BaEzE2CyNT1c062ce78l1bYlRc8ZQT0pv0cr8k3OPSI9k7Tje7GjMH6ibU7b-l45vIicq9nMFzMnlL7GclfUjm2wfVf4wjVJ8nZl3T9Y9ujBGvd6pTYvx5c1viu19XJOzWaDxxfy5ARPuaUZTNYbxfpexZt1ZCokv86_6UKqY9V29s4ei-0ci_05Fs8fayPZOLlkS1bkSuM5E1LL-V4dtS0d7PB5YIXnQWMVjScTwdKJOHAgEFGZgaifYyAQOdnksMsYCHbigai__0Dww4PIiweRVzT9DUFERGWC2DhHEBE5Wcf4ZQSRnziIjfcPon54EPXiQdQrmvGGICKiMkFsniOIiJysY_plBFE_cRCb7x9E4_AgGsWDaFS02oHhQ4Rkwtc6R_gQOVmXjMsIn3Hi8LXO-__pX9QMRLCSXiC2hOxbuRqfR7gzkZ4_kJE_FX1fTpNt0lc74ZIfXBGE6VeWvnS99FMsMAszJczVMM_DLAvrWzArBjePgRk_iq4fQ_OqmtaVF26oYUPtFuJ1TUnX1XBdCTfUcOOYoKhhJChqGAsKQiNBUdNYUJrHBKWl7oQqUgpIpWCdslMqRexGaMRvhMYMx3DEcQTHLGc71VLEc6auFmYgrqnLhdUQfKddCpmupjHT1TRqOoJjpqtx1HR1s2Km75TMtmtNxDV1y7AWgu_0TCHT1TRmuppGTUdwzHQ1jpnO1Q2bN32y_udXAAAA___HxMQL
