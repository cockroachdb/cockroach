# LogicTest: 5node-dist-opt

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE2PmzAQhu_9FWhOrWRkbCCb5ZQe99ButWlPFQcXjyhSgpFtpFYR_70CDoEoMa68Rz5eP--jseYCrZL4VZzRQPETGBDgQCAFAhkQyKEk0GlVoTFKj7_MgRf5B4qEQNN2vR1flwQqpRGKC9jGnhAK-C5-nfANhURNEyAg0YrmNGE63ZyF_nuQwgogcOxEa4oopiwSrYxYpOxv1EDgtbdFdGBQDgRUb68sY0WNULCB-Pf5XNcaa2GVpvm6zvHHl48H9ukhhj_EXE_vW6UlapSro8vBXYQl_9ckXTVh_gNgPgOgLKY8aAQbjRbmu5ARcH9x7iXOY5oGiW80Wog_hYin_uKpl3ga0yxIfKPRQnwfIp75i2de4llM8yDxjUYL8ef32jZ3MG9oOtUavNk6909Oxm2EssZ5dRnV6wq_aVVNmPnxdcpNLyQaO39l88NLO38aCy7DzBnmqzC7DXM3eQOdOtOZO5yF9M6d4Z2bvAshPznDezd5H0J-ds8q2bgm7kt2yy6HD_8CAAD__8HMzUU=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum((a-1)*1000 + (b-1)*100 + (c::INT-1)*10 + (d-1)) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlUFr2zAUx-_7FOadnE3GlqykqU4q2w6BtRtpdxo5aNHDC6SWkRTYKPnuIzaldmhlDe-Sm5-e_u___HuC9wS10XinHtGB-AEUCDAgUAIBDgTmsCHQWLNF54w9XekEK_0bREFgVzcHfzreENgaiyCewO_8HkHAg_q5xzUqjTYvgIBGr3b71qaxu0dl_0itvAIC942qnUiynCaq1glNjP-FFgissdZoRZKmaSppRoUQq7uH5ew9LYriOfiQppINc8_fba7sgsGN3gXJ28ynzx9XtzdfZiSRlCSSkUSWJJEcNkcC5uBf_tN5VSEIeiTxLG6qymKlvLH5fIji_vttKunsTRv2ps1L9UNtrEaLelB6cww3Qot_66QcdELjh09jhp_TLGcXO_4RGj3qiynjZ_HQWRR0luXlxUIfodGDfjUFehkPvYyCXmY5v1joIzR60JdToPN46DwKOs_y-cVCH6HRg379v7bLKzZrdI2pHZ5tmdcrF6ftg7rCblU5c7Bb_GbNtrXpwq-trj3Q6HyXpV2wqrvUqcG-mAbFbCCm52IWdh6xLoNqHhbzKX3Pg-JF2HkxxfkqKF6GnZdTnK_DsypGnkn4kZ17b47v_gYAAP__QTtXTA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), count(a), max(a) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFr2zAUx-_7FOadNpCRJTlp6lPKTjmkGU0Dg2GGFj28QGoZSYaNku8-bI_VDrUscHazrfzz-_N74r1CqRU-yhe0kH0DBgQ4EBBAIAUCC8gJVEYf0Vptmp90gY36BVlC4FRWtWs-5wSO2iBkr-BO7oyQwbP8ccYnlAoNTYCAQidP5xZTmdOLNL_XSjoJBPaVLG0WxZRFslQRi7T7iQYI7GqXRWsG-YWArt0byzpZIGTsQsL7PBSFwUI6behiWGd_2H5cs09A4PPu8Pj893n78LV9GoPzUfgbsy61UWhQDYD5xV-PJWP99oft903TkP9rKMYbikFDFj4uFjIuymLKZw1solHPyPL2A-PhOniQDh5TMUvHRKOejrvb6xDhOkSQDhHTdJaOiUY9Havb60jDdaRBOtKYLmbpmGjU03H_f7fbO_AntJUuLV5tuff_OWm2H6oCu1VpdW2O-MXoY4vpXndtrv2g0LrulHUvm7I7agr2w8wb5oMwuw5zP3kCLbzp1B9O5_ReeMNLP3k5h3znDa_85NUc8r1_VsnENfFfsmt2fvnwJwAA__-Um-rw

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a+b), count(a+b), max(a+b) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFr2zAUx-_7FOadNiZjS3LS1CeXnXJIO5IGBsMMLXp4gVQykgIbJd992B6rE2JZEPdmW_nn9-f3xHsFpSU-ihe0kH8HCgQYEOBAIAMCMygJ1Ebv0Fptmp90gaX8DXlKYK_qo2s-lwR22iDkr-D27oCQw7P4ecA1CokmSYGARCf2hxZTm_2LMH8KKZwAAptaKJtHcUIjoWREI-1-oQECa1QSTR4V9HPBSFRQEhUMyhMBfXRvZOtEhZDTEwlv91BVBivhtElm5-U229XHgn4CAl-eto_P_55XD9_apyE4G4S_MY9KG4kG5RmwPPnr0XSo32a7-rFsGrL_DflwQ37WkIYPj4YML6FxwiYc30i_np_59ONj4XJYkBwWJ3xCOSP9enLuppfDw-XwIDk8TrIJ5Yz068lZTC8nC5eTBcnJ4mQ2oZyRfj059--7Fa_A12hrrSxebMfr_5w2WxNlhd2KtfpodvjV6F2L6V6f2lz7QaJ13SntXpaqO2oK9sPUG2ZnYXoZZn7yCJp705k_nN3Se-YNz_3k-S3kO2944ScvbiHf-2eVjlwT_yW7ZJenD38DAAD__1Lx-zA=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum((a-1)*1000) + sum((b-1)*100) + sum((c::INT-1)*10) + sum(d-1) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlc-K2zAQxu99CjOnpCtj60-yWZ20tD0EutuS3Z5KDmo0uIGsZWQFWpa8e7FdEjtsZNOQQm6Sxp-_mfkNzCvk1uCjfsES5HegQIABAQ4EBBCYwJJA4ewKy9K66pNGMDe_QKYE1nmx9dXzksDKOgT5Cn7tNwgSnvWPDS5QG3RJCgQMer3e1DaFW79o91sZ7TUQeCp0XsooTmikcxPRyPqf6IDAAnODTkYjRWMqpZw_Ps_G72mapn8vJBop1g21Irw5duL7sBL1-8dPH-YP959JpCiJFCOR4lUMljsCdusP5ZVeZwiS7sjwFtxnmcNMe-uSSbcDT98eRoqOq-KrE9uf-P4kxieTYCeTOHhvc-sMOjQd4-UunCZN_yXPAyklbkaK34wUvVFsfLoC3qmADp8kOmSSEhon7NpmqacJLUjTy80SG06CDSLB4oRfG4meJrRI3F6OBB9Ogg8iweNEXBuJnia0SMwuR0IMJyEGkRBxMrk2Ej1NaJG4-z-b7o0kFlgWNi_xaOO9_ee02oRoMmzWZmm3boVfnV3VNs31S62rHwyWvonS5jLPm1CVYFtMg2LWEdNjMQs791jzoFqExeKcvCdB8TTsPD3H-TYonoWdZ-c434VZpT1jEh6yY-_l7t2fAAAA__-1LXy2

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lM9r2zAUx-_7K8I7pSAj60fS1CeXnXJIOpoGBsMMLXp4gdQykgIbJf_7sH2oExpZS0hvtpVvvh8-T7w3qIzGpXpFB9kPYECAAwEBBCQQmEBBoLZmg84Z2_ykC8z1H8hSAtuq3vvmc0FgYyxC9gZ-63cIGbyoXzt8RqXR0hQIaPRqu2trart9VfZvrpVXQGBVq8plo4Sykar0iI2M_40WigMBs_fvDc6rEiFjBxJP8ViWFkvljaWTY4jVejHO2R0QWMyX45y3T4_fx7lonr4-rZcv41zencXgZzHe2_eVsRot6qPq4hAGZen_kK7Wi5_zAVZxxMriB8diBkdZQvkFoxvg6BmZ3nJ0PF4Hj9LBEyou0DHA0dNxf0sdIl6HiNIhEiov0DHA0dMxu6UOGa9DRumQCZ1coGOAo6fj4bP23AcYz-hqUzk82Xcf_3Pa7EHUJXZL05m93eA3azZtTff61ObaDxqd705Z9zKvuqMGsB9mwTA_CrPTMA83D1SLYFqGw_Ia7kkwPA03T69pvg-GZ-Hm2TXND-FZpQPXJHzJTruLw5d_AQAA__-ZF-tW

# AVG is more tricky: we do two aggregations (for the sum and for the count)
# and calculate the average at the end.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT avg(a+b+c::INT+d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lE2P2jAQhu_9FdGcQDhK7ASW9clVTxyWrfg4VVHl4lGKxMaRbaRWK_57leSwAS2OJSg3EvPmffSMNe9QaYVL-YYW-A-gQIABgQwI5EBgCgWB2ugdWqtN85cusFB_gKcE9lV9dM3rgsBOGwT-Dm7vDggcNvLXAVcoFZokBQIKndwf2pra7N-k-SuUdBIIrGtZWR7FCY1kpSIaafcbDRBYYaXQ8Ejkk9FI0Ilg44nIOF8sN_MxiQQlkWAkEhmJRA7FiYA-ug8i62SJwOmJhFN_LUuDpXTaJNNz6PX2ZSToGAh8e90uN-3va5XsauVH07HSRqFBdVZTnPxQNL1Gtd6-_Fw0XGzcV0cTwa5yZmecNHygNGSgCY0T9oCRDnD37M3uNVIWrooFqWJxkj1A1QB3T9XTvVRl4aqyIFVZnOQPUDXA3VM1v5eqPFxVHqQqj5PpA1QNcPdUPf-PnfpJ5QptrSuLF7v18y-nzc5FVWK3oK0-mh1-N3rX1nSPr22ufaHQuu6Udg-LqjtqAPth6g2zszC9DDN_80B15k3n_nB-C_fUG575m2e3ND95w3N_8_yW5mf_rNKBa-K_ZJfdxenLvwAAAP__gAoLsg==

# VARIANCE/STDDEV have three local (sqrdiff, sum, and count) and one final stage aggregations.
# We calculate and render the variance/stddev at the end.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), round(stddev(b), 1) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lEGL2zAQhe_9FWZOKcjYkp1sVicvTQOGNmmTbC_FFDUa3EDWMrIMLUv-e7F9WCckssBkb5LGz-_pGzGvUCiJK_GCFfCfQIEAAwIREIiBwBQyAqVWe6wqpZtPOkEq_wIPCRyKsjbNcUZgrzQCfwVzMEcEDjvx-4gbFBJ1EAIBiUYcjq1NqQ8vQv9LpDACCGxLUVTc8wPqiUJ61FPmD2ogsK4N9xJKEgbZiYCqzZtdZUSOwOmJuEd6ynONuTBKB9PzRNvnr5OEfmzCfN8s0uVykrB215y3q0_r59WuXd-Kwm5GeUtQF0pL1CjP7LOTPSwNb6VdpqunL7-2u8Xi849JwkgSkSRuChssJOqWnqdVXcimSjnn6Wo3v32H6OwO1L3D1KXDAfUDNrbHA6F62Gb37jFz58Oc-DA_iMbyGQjV4_Nwbz6RO5_IiU_kB_FYPgOhenzm9-YTu_OJnfjEfjAdy2cgVI_P43vO0CtRNliVqqjwYpZe_3PYzFiUOXYDuVK13uM3rfatTbddt7r2QGJluirtNmnRlZqAfTG1itmZmF6Kmd15wDqyqmO7OB6Te2oVz-zOszHOD1bx3O48H-P8aO9VOPBM7I_s0js7ffgfAAD__xebCC0=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), round(variance(b), 1) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lEGL2zAQhe_9FWZOKSjYkp1sVieHbQOG1mm92V6KKWo0uIGsZWQZWpb892L7sE7YyAKTvUkaP7-nb8S8QKkkpuIZa-A_gQIBBgRCIBABgQXkBCqt9ljXSref9IJE_gUeEDiUVWPa45zAXmkE_gLmYI4IHHbi9xEzFBK1HwABiUYcjp1NpQ_PQv-LpTACCDxWoqy5N_epJ0rpUU-ZP6iBwLYx3IspiRnkJwKqMa92tREFAqcn4h5pXRQaC2GU9hfniR6fvs5i-rEN8z37lGw2s5h1u_a8Wz1sn9Jdt74WhV2N8pqgKZWWqFGe2ecne1gaXEu7SdL1l18_1lmyTh8-z2JG4pDEUVvKsJSoO36eVk0p2yrlnCfpbnX9FuHZLah7j6lLj30699nULo-EGoBb3rrLzJ0Pc-LD5n44lc9IqAGfu1vzCd35hE58wrkfTeUzEmrAZ3VrPpE7n8iJTzT3F1P5jIQa8Ll_zyn6RpQM60qVNV5M07f_HLRTFmWB_UiuVaP3-E2rfWfTb7edrjuQWJu-SvtNUvalNuBQTK1idiaml2Jmdx6xDq3qyC6OpuReWMVLu_NyivOdVbyyO6-mON_bexWMPBP7I7v0zk8f_gcAAP__EtIIrA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT stddev(a+b+c::INT+d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lNGK2kAUhu_7FOFcuTghzkx03VzNUisEWrdVtzcllKlzSAU3EyYjtCy-e0lS2CjrZED0Lsn4-398ZzivUGiFC_mCFSQ_gAIBBgQ4EIiBwBgyAqXRG6wqbeqftIFU_YFkRGBblHtbf84IbLRBSF7Bbu0OIYG1_LXDJUqFJhoBAYVWbndNTWm2L9L8FUpaCQRWpSyqJAgjGshCBTTQ9jcaILDEQqFJAhEPBwNBh4LdDQVPknSxnt6RQFASCEYCwUkgYsgOBPTevhFVVuYICT0Qf-rHPDeYS6tNND6GXn1bztL5fCDoXc38_OX_08en58W6eT4HwM4CvPXuC20UGlRHpdnBjUhPxM7TxePnn6v1bPbp-0BQIhgR_DwYPwKj_vOkPvOMaBixG0y0h7uja3KdiTJ_ccxLHAsjfgNxPdwdcffXEcf9xXEvcTyM4huI6-HuiJteR1zsLy72EheH0fgG4nq4O-Ierr983wFYYlXqosKTJfz-P4_q5Ywqx3aTV3pvNvjV6E1T074-Nbnmg8LKtqe0fUmL9qgG7IapM8yOwvQ0zNzNPdXcmY7d4fgS7rEzPHE3Ty5pvneGp-7m6SXND-5ZjXquifuSnXZnhw__AgAA__9soBgk

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT variance(a+b+c::INT+d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lNGK2kAUhu_7FOFcKU6IMxNdN1cj2wqBNttm3d6UUKbOIRXcTJiM0LL47iVJYaOsk4DoXZLx9__4znBeodAKE_mCFUQ_gAIBBgQ4EAiBwAwyAqXRG6wqbeqftIFY_YFoSmBblHtbf84IbLRBiF7Bbu0OIYK1_LXDFKVCE0yBgEIrt7umpjTbF2n-CiWtBAJPpSyqyPMD6slCedTT9jcaIJBiodBEnggno5GgE8HGE8GjKE7WizHxBCWeYMQTnHgihOxAQO_tG1FlZY4Q0QMZTr3Mc4O5tNoEs2Pop2_px3i1Ggk6rpmfv_x_enh8TtbN8zkAdhbgrXdfaKPQoDoqzQ5uRHoidhUny88_vy_TeJk8fBoJSgQjgp9H40dodPhE6ZCJBtQP2A1m2sPdETa_zkzZcHFskDjmB_wG4nq4O-LuriOODxfHB4njfhDeQFwPd0fc4jriwuHiwkHiQj-Y3UBcD3dH3P311-87AClWpS4qPFnD7__ztF7PqHJsd3ml92aDX43eNDXt62OTaz4orGx7StuXuGiPasBumDrD7ChMT8PM3dxTzZ3p0B0OL-GeOcNzd_P8kuY7Z3jhbl5c0nzvntW055q4L9lpd3b48C8AAP__j6AYow==

# Test various combinations of aggregation functions and verify that the
# aggregation processors are set up correctly.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(c), avg(d), stddev(a), variance(b), sum(a+b+c::INT+d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUllGL2kAQx9_7KZZ5Um4k2U2iMU8r5wmB1mvVu5ciR2oGK3hZ2URoOfzuJYnVKOcmIAi-ze7kv_Of_Q1sPiBRMY2jd0oh-AkcEAQgOIDgAoIHc4SNVgtKU6XzT0pBGP-BwEZYJZttlm_PERZKEwQfkK2yNUEAs-jXmiYUxaQtGxBiyqLVuiiz0av3SP-VcZRFgDDdREkasI7FWZTEjDOV_SYNCBNKYtIBk-5DqyX5gxTtB-kEQTie-W1kkiOTApl0kEkX5jsEtc2OjtIsWhIEfIfNXQ-WS03LKFPa8k5NT1--taRo537zyMmjx-eX8WwfF7vuIfIq-SKe_pgMw9Fof8Y-I04yx3N4-2I74mI7xy62idIxaYpPWpjvzA1z-5OO-cHT_97fQmPPhy-6-WoUjgdf36az4fDptSV7KDlK_5h4HUzCwfjxqSX7KAVWb8BuVyegQG2VpJFJz5JdZLKHTPrIZP_ibTknt8WbjyxvMrIW71jiBkNb47vCsHsPQyuaYxCNMIiO5dwAQ43vCobePWBwmmNwGmFwOpZ7Aww1visY_HvA4DbH4DbC4HYs7wYYanxXMPTvAUPNj8GE0o1KUjp7UT8_2c5fWoqXVD7LqdrqBX3XalGUKZfPha7YiCnNyiwvF2FSpnKDVTE3isWJmJ-LhblyTWnHqHbNYvca355R3DVX7l5TuWcU--bK_jWV-2ZWds2YmIfsvPZ89-VfAAAA__-ZSpEL

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d), avg(a+b+c::INT+d), stddev(a+b), variance(c::INT+d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUVlFr4lwQff9-RZiniCPJvTfRmKcrtULga7qrtiwsUrJmcAWbyE2EXYr_fUlCYyI1Cfggvk1m5njmzBnwfkAUh-QH75SA-xMYIHBAEIBgAYINK4S9iteUJLHKWgqAF_4B10TYRvtDmqVXCOtYEbgfkG7THYELy-DXjuYUhKQMExBCSoPtLqfZq-17oP7KMEgDQFjsgyhxtYHBtCAKNabF6W9SgDCnKCTlatLq67pkfcl7fSlc1_OXTg-1PINZ9TOZ5VDLkyIrwOqIEB_S05RJGmwIXHbE7komm42iTZDGyrDrQhYvT7q0eoDw5Pm6tPNo8kOXwyx6eH7xl7ocZXHeySrZPF58n0-92UyXvOzhlR5e6xFlj6j0iN5FkfyiyJO2QxSrkBSFNWGrY_MamPnFHli5B17u4XPmNy-b1SoV2LV8vq2Z50_-f1ssp9PHV12OUDoox6fC62TuTfyHR10yEyVjKFlOU95IzXjUpG3IIWpyhJp0Lq5I1FbEul8063LRBhsY_EY33aKlYubwfm-adzeMdzKMDwxxI8NatFQMG92vYaK7YaKTYWJgWDcyrEVLxTDnfg2zuhtmdTLMGhj2jQxr0VIxbHy_hrW8ZeaU7OMoobO_-69_2cyeARRuqHgzJPFBrembitc5TfH5nOPyREhJWlRZ8eFFRSkbsApmjWBeA7NzMG9mbqEWjWirGWxdM7fdCB42Mw-vYR41gp1mZuca5nGzV2bLmTQf2Tn36vjfvwAAAP__hM679A==

# Verify that local and final aggregation is correctly shared and de-duplicated.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), stddev(a), avg(a) FILTER (WHERE a > 5), count(b), avg(b), variance(b) FILTER (WHERE b < 8), sum(b) FILTER (WHERE b < 8), stddev(b) FILTER (WHERE b > 2) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzslkGP2jwQhu_fr7DmtJ9klNhOIORktIAUacu2gd1Li1YpGVEkNkFOkFqt-O9VkpYkNHEiceDCCTyemdfz5rHkD4jiEBfBOybgfgUGFDhQEEDBAgo2rCkcVLzBJIlVllIUeOFPcE0Ku-hwTLPwmsImVgjuB6S7dI_gwir4vkcfgxCVYQKFENNgt89lDmr3HqhfMgzSACgsD0GUuGRgMBJEIWEkTn-gAgo-RiEql0j27WiaAm3Xdb3FyqFE8jyycS4jyMsIy6KwPlGIj2l50CQNtgguO9H-w0y2W4XbII2VYddnWb58epDW_9kYX_ypN5__WT0-vyxWf3eKHDL3nlYzn0hW3W-K2ucqu9bZLrN5mVGLnTvUMxs6iIYOorGDaDWRt5pYeneMYhWiwrBm3Pqkt5mZDT6zzI25t5g8vS1X0-ns9UFyKhmVomJz8e_NqxpZrIbnrFHZ6HXie5PF4-xBOlSOqWTmOWv8rxxjVLJMM1csAc1Qo0QKQ1qUSJsSOTTynxElMoNx3OqhqHnI-t8q1udWGWxg8Nvdq45xKh98eL9XbfeK92eC92KCDwxxOyY6xqkwMboz0caE6M-E6MWEGBjW7ZjoGKfChHNnoo0Jqz8TVi8mrIFh346JjnEqTIzvTPR5kzWY6GNyiKMEL95mzZ3N7M2G4RaLB14SH9UGP6t4k8sUy-e8Lg-EmKTFLisWXlRsZQesFjNtMa8Vs8tirlfukBbaaktfbF1zbltbPNQrD69RHmmLHb2yc43yWP-tzA5M9JBdaq9P__0OAAD__wXcSdY=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), avg(DISTINCT a), variance(a) FILTER (WHERE a > 0) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k8-L1DAUx-_-FeV7WjElTdoRyanDukpBR-nUvWgPcfKoA7NNSTKgLPO_S9vDWtldIjMe349P3icP3j16a2ij78hDfYUAgwRDDoYCDCu0DIOzO_LeurFlBirzEypj2PfDMYzplmFnHUHdI-zDgaDQ6O8HqkkbcjwDg6Gg94dpzOD2d9r9Ko0OGgzbQfdeJSkXie5NIhIbfpADQ029IaeSUnw7ZllOmVKq2jRvWFIKtCcGewwPAj7ojqDEiT0h-eBmnSFHZmlVyldoT4_8ZN11jjodrOOrJbL98vGqlC_BsL59f_W22jbV5rpJ5tTtuq7Wm-ubsSN5V31oburnvOXCW8QvV8Qsl4uUy8uvV8ZryihNmfL88pp5vGYepZmnvLi8ZhGvWURpFilf_d-bekSzJj_Y3tPC8KmXs_HgyHQ0H6i3R7ejz87upjFz-GnipoQhH-aqmIOqn0qT4J-weBZ-vYCzv2F5zuT8HLg4B179E9yeXvwOAAD__z-C5xU=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), avg(a), count(a), stddev(a), variance(a) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lNGLm0AQxt_7V8g8XWFFdzW5nE-GywWEXtJqci9Fjm12sIGcK-sKLUf-96IWTsNlFSQPgcxOvnzf_maZd8ilwA1_wxKCn0CBAAMCHhDwgcAMUgKFkgcsS6nqn7SCSPyBwCVwzItK18cpgYNUCME76KM-IQSw479OGCMXqBwXCAjU_HhqbAp1fOPqbyi45kAgKXheBpbtUIvnwqKW1L9RAYFtpQMrpJCeCchKf3iVmmcIAT2T8XmWWaYw41oqZ9aPk-yf70L6FQg8bveb3f_vyY94Fa3XTXUtALsa4MO3yqUSqFD0TNOzOSJ1r2VM9s-vUZ2S1dU62iy_vSa71erp5S70SEhJt_GyjKPl5vGp14oxF6hqssQKqRMyYjUfj1ihf_WuXu-udPzw6ZjhO9R22KTxDyTqsJ3fZvxsPBI2CgmzHW8SkoFEHST3t0HijUfijULi2Y4_CclAog6SxW2Q-OOR-KOQ-LYzm4RkIFEHycPt9-YnAWIsC5mXeLE_P_9nt96rKDJsl3ApK3XA70oeGpu23Da65kBgqdsubYsob1t1wK6YGsWsJ6aXYmZ2HrD2jGrfLPan5J4ZxXOz83yK871RvDA7L6Y4P5hn5Q48E_Mju_ROz1_-BQAA__-gWwJr

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(a), sum(a), avg(b) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEGL2z4Qxe__T2Hm9C_IyJKcbNYnl55y2E1JNqdiihoNbiBrGUmGliXfvcimrBM2ssDpbcbKy3v6jZg3aLTCZ_mKFopvwIAABwICCORAYAEVgdboA1qrjf_JIFirX1BkBI5N2zn_uSJw0AaheAN3dCeEAl7kjxNuUSo0NAMCCp08nnqb1hxfpfldKukkENi1srFFklKWyEYlLNHuJxogsOlckZSMlByqMwHduXc762SNULAziY_0ua4N1tJpQxeXiXb7p_9L9smH8RX31ZfN_vmlr2-Z85vm755do41Cg-rCsDqH47FsOt9u__R97RMK322xUWh6XEnJaSnIUP5tb15CXFyCxQ-VxQyVspTyuWOdCDXitrz_WHk8ER5FhKdUzCUyEWpE5OH-REQ8ERFFRKQ0n0tkItSIyOr-RPJ4InkUkTyli7lEJkKNiDz-22X4gfkWbasbi1dL8eN_zvyyRFXjsFmt7swBvxp96G2GdtPr-g8KrRtO2dCsm-HIBxyLWVDML8TsWszDzhPWIqjOw-J8Tu5FULwMOy_nOD8Exauw82qO82N4VtnEMwk_smvv6vzfnwAAAP__B8X2Pw==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT avg(c), sum(c), avg(d), sum(d) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L4jAUxd_3U5T7tEIk5o-O06fKwIKwMy5Wn5ayZM2lKzhNSVPYZfC7L22FaWVMC8V50tzk9Jz8brhvkBmNL-oVCwh_AgMCHAgIICCBwBwSArk1BywKY6sjjWCt_0I4I3DM8tJV5YTAwViE8A3c0Z0QQtip3yfcotJo6QwIaHTqeKptcnt8VfZfpJVTQCDOVVaEwZSyQGU6YIFxf9ACgU3pwiASJJKQnAmY0r3bFU6lCCE7k-GRVmlqMVXOWDrvJor3z18jNgECT5v9y-7yv67yVpVPbgbhN4O8-5eZsRot6o55cvZHZbNbWeP986_1JdclrejUZbXaYqbRhkHE6NMqrk6v4m_fN6vdckKCiJEgEjSS1c_Ny4nO5djwxrMhjadsSvnY1veEavFc3Lf1fDgdPogOn1Ixlk5PqBadh_vSEcPpiEF0xJTKsXR6QrXoLO9LRw6nIwfRkVM6H0unJ1SLzuPnDdUPgmyxyE1W4NVw_fjLs2rook6xmdCFKe0Bf1hzqG2a5abW1QWNhWt2WbNYZ81WFbAtZl4x74jZtZj7nXushVct_WI5JvfcK174nRdjnB-84qXfeTnG-dHfq1nPM_E_smvv5PzlfwAAAP__uBQKgA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT max(a), min(b) FROM data HAVING min(b) > 2]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslEFr2zAUx-_7FOKdWpCRJTlpqpN7GeTQdHQ9DDYftOjhGVLLSDJslHz3kfhQJySywDlayj-_P78n3ge01uBGv6MH9RM4UBBAQQKFAigsoKLQObtF7607_GQIrM1fUDmFpu36cDiuKGytQ1AfEJqwQ1Dwpn_v8BW1QcdyoGAw6GZ3xHSuedfuX2l00EDhe6dbr0jGONGtIZzY8AcdUHjpgyIlp6WAak_B9uET54OuERTf0_RKT3XtsNbBOrY4bfT89OOu5PdA4Xm9uSvF_VWguAr85PStdQYdmhNItY9X4vlUJwpfm11Ap0gpyK8-zyUSoZRab95WVwvLk8I8fWg8ZWiMZ0zMHdtEqZGj5W3GJtItiCQLImNyroWJUiMLD7exINMtyCQLMmPFXAsTpUYWVrexUKRbKJIsFBlbzLUwUWpk4fH2i-wC8BV9Z1uPZwvt8j_nh0WHpsZhK3rbuy1-c3Z7xAyfL8fc8cCgD8MtHz7W7XB1KDgO82hYnIT5eVjEyRNoGU0X8XAxp_ciGl7Gycs55IdoeBUnr-aQH-OzyieeSfyRnbOr_Zf_AQAA__8xO-Q5

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT (a) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslD2vmzAUhvf-CnTWGhkbyAdThi5ZmirtVjG4-ChFSjCyjdQq4r9fARK5RDfGujBi5_XzPjmW71Apid_FDQ1kv4EBAQ4EYiCQAIEUcgK1VgUao3T3kyFwlP8giwiUVd3YbjknUCiNkN3BlvaKkMEv8eeKZxQSNY2AgEQrymuPqXV5E_r_QQorgMDPWlQmC0LKAlHJgAXK_kUNBE6NzYIDg7wloBr7YBkrLggZa4l_n2-lsWVVWJpOyxw66ZOWqFE6afwl7QFRwznPhK-Qt65KLPpkp3jSiflPhPlMhLKQ8kUzmWk0_gGbVWbC_f25lz8PabzIf6bR6L9dxT_294-9_OOQJov8ZxqN_rtV_BN__8TLPwlpush_ptHov1_9TfqAdkZTq8rghPXq5Kh7sFBecHjgjGp0gT-0KnrM8Hnqc_2CRGOHXTZ8HKthqyv4PsycYT4Js-cwd5Nn0LEznbjDyZLeqTO8cZM3S8hbZ3jnJu-WkPfuWUUz18R9yZ7ZefvlLQAA__-HYNkY

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslMGOmzAURff9CvRWrWrk2JBMhlWqziaLTqpJuqpYuPiJImUwso3UasS_V4DEFJQYS7DEzvW5J8_yG5RK4rN4RQPJT2BAgAOBCAjEQGALKYFKqwyNUbr9SR84yj-QbAgUZVXbdjklkCmNkLyBLewVIYGL-HXFFxQSNd0AAYlWFNcOU-niVei_BymsAALnSpQmCULKAlHKgAXK_kYNBE61TYIDg7QhoGr7zjJW5AgJa4h_n6fC2KLMLN2Oyxxa6ZOWqFE6afwu7R2i-nOmhM-QNjcqfclzjbmwSlM2-YvOP759fDqeL8fnr5fgwD7dbRWNWjH_mTCfmVAWUr5oKjONhqnsVpkK9_fnXv48pNEi_5lGg__DKv6Rv3_k5R-FNF7kP9No8N-v4h_7-8de_nFIt4v8ZxoN_o-rv0o3aC9oKlUaHLHunbxpnyyUOfZPnFG1zvC7VlmH6T9PXa5bkGhsv8v6j2PZb7UF_w8zZ5iPwmwa5m7yDDpypmN3OF7Se-sM79zk3RLygzO8d5P3S8iP7lltZq6J-5JN2Wnz4V8AAAD__2uj2aE=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A), SUM (DISTINCT B) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFr2zAYhu_7FeY7rVRGkeykqU8e6yWHNaPJTsMHzfrwDKllJAU2Sv77cATubBJZ4PRoya-el-cTeoNGSXwWr2gg-wkMCHAgkACBFAgsoSDQalWiMUp3v7jARv6BbEGgbtqj7ZYLAqXSCNkb2NoeEDLYi18HfEEhUdMFEJBoRX04Y1pdvwr9N5fCCiCwa0VjsiimLBKNjFik7G_UQGB7tFmUM5JzKE4E1NG-44wVFULGTiS80lNtbN2Uli6HfRyCwFZL1CinmPwq8x2l3FFjzj3J-T0UpwvlvlSVxkpYpSkb-dr9-Pb5abPbb56_7qOc3XXOBkv87mrZZFCWhc-MhcyMspjyuVObKNVPbXXDqfFwETxIBI9pMlfERKlexMMNRSThIpIgEUlM07kiJkr1ItY3FJGGi0iDRKQxXc4VMVGqF_H4QQ_aBeYLmlY1BgfEaycvupcOZYXudTTqqEv8rlV5xrjP7Tl3XpBorNtl7mPTuK2u4P9h5g3zQZiNw9xPnkAn3nTqD6dzei-94ZWfvJpDfvCG137yeg750T-rxcQ18V-yMbs4ffoXAAD__2Z96FY=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY a,b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lE9r2zAYxu_7FOI9tUTGluT8qWDgwxjk0oyut-GDZr10htQykgIbJd99OIJ0CYssSOpLQHYe_x79XqE36IzGR_WKDuQPYECBAwUBFEqgMIeaQm9Ng84ZO_wlBNb6N8iCQtv1Oz88rik0xiLIN_Ct3yJIeFY_t_iESqPNC6Cg0at2e8D0tn1V9k-llVdA4XuvOidJljOiOk0YMf4XWqDwtd16tJLc3VWMzEjF74dfIeX68Xl1Tz4TvpRhARQ2Oy9JxWjFod5TMDv_3s159YIg2Z6m9__SOt92jc_np-UDgsLGarSox5j8IvMdZcKnzjkzWvEZ1PtYOVZc1U6ctGPpE2UpE81ZlvNJZzqyg6O2xQ1nytOt8SRrPMvFpNZGdnC0tryhNZFuTSRZE1leTmptZAdHa6sbWivTrZVJ1sosn09qbWQHR2sPH3Tr_of5hK43ncMT4qUvF8N1jPoFwxXuzM42-M2a5oAJy80hd3ig0fnwloXFuguvhoL_hlk0zE_C7DzM4-QRtIimy3i4vKb3PBpexMmLa8jLaHgVJ6-uIT_EZ1WMHJP4ITtn1_tPfwMAAP__0NQX6g==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY b,a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lUFr2zAUx-_7FOKdWizjSLKbRjDwYQxyaUbb2_BBsx6dIbWMpMBGyXcfjiBdwiKrJMslICl__d775aG8QW80PqhXdCC_AwMKHCgIoFAChQoaCoM1LTpn7PiVEFjqXyBnFLp-2Phxu6HQGosg38B3fo0g4Vn9WOMjKo22mAEFjV516x1msN2rsr9rrbwCCk-D6p0kecGI6jVhxPifaIHC127t0Upyc1MzkpGa346fQsrlw_P9LflM-FyGBVBYbbwkNaM1h2ZLwWz8e23OqxcEybY0vf4vnfNd3_qiOiw-ICisrEaLeorJTzLfUSZcdczJaM0zaLax4tjsrOrER4w8GevRFowdIXlGa5adZJQHDJY-NSxlagqWF_yqczPRwf6nubvg3PB0azzJGs8LcVVrEx3src0vaE2kWxNJ1kRelFe1NtHB3tr9Ba2V6dbKJGtlXlRXtTbRwd7a4j-97P9gPqIbTO_wgHjq5tn45KN-wfA34czGtvjNmnaHCcvVLrfb0Oh8OGVhsezD0Vjg32EWDfODMDsO82hYxMkiXjaPp8touoqHq3OavouG53Hy_BzyfTS8iJMX55DZxIxNDdnHpqzZfvoTAAD__3tHTBk=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl19r4kAUxd_3U4T71NKReGcm_slTyj4J3XRp7cOySEnNYIU2I5MIW0q_-5LEVmPq3IgR9Knj6C_3zj1nDuk7JDpWYfSqUvD_AgIDDgwEMJDAwIMJg4XRU5Wm2uQ_KYFR_A_8LoN5slhm-faEwVQbBf47ZPPsRYEP4-jpRd2pKFbG7QKDWGXR_KUoszDz18i8BXGURcDgfhElqe90XHSiJHbQ0dmzMsDgTiWxMr4T4FUgfH8UjgfMCfhVIJkTCOYUfzHfgskHA73M1u2kWTRT4OMHa97y9Wxm1CzKtHG9aseBYEE-kOvwz2N4O34MH25uLgJxWduS-db9w6-LAL9WPF_9vH0Ix8W62uq6-tOb8xylz1uFkRWnW5-I7zzR-lHLRJtYGRVXHlY8xXJm7H5Xe_uEWD80_zqq-Fp9DuJxlB_bu6zImUv2KaEbeDvVE_uoF-qOXri4pVy96FUgdxaU7Q63bIl3t375fW2vUhub3y5scrtc7Lj82PeLaHrDa70zuV_Y5v3C075fhHqr-9Vr737x5h7njTzOO644tseJpjf07p-Jx3mbHuen7XFCvZXH--15XDT3uGjkcdFx5bE9TjS9offgTDwu2vS4OG2PE-qtPD5oz-OyucdlI4_Ljusd2-NE0xt6D8_E47JNj8vT9jih3srjw-P8L_BNwTuVLnSSqkZv-t18-CqeqVKpVC_NVP02elqUKT_eFlyxEas0K7_F8sMoKb_KG9yEcRvGTZhXYNwP7h8CIx5EewfRQzvNrQMX9oELKyztlaUV5oTWnpXu2eHeIUaxw4RR7DBlFIImjELQhFH61oEP7AMfHGKUoT0TukQo1CJlr1Sw01Qs2GkyFwicCgYCJwTHWrBU586JuduThdAc7dGCkiheC5e9RLfTlOh2mhSdwCnRCZwS3Z6rSAQr1jJmL9HtGYNEyGAtZfYS3U5TottpUnQCp0QncEp0e8JyImG5_aVtW_TJx4__AQAA__-JBffg

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d ORDER BY c, d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl19r8koQxu_Ppwhz1eJKnN2NtblKOVdCjx5ae3E4SEnNYoXWlU0Kbyn97i_502ri605kG9CrxrVPnsnM_B7iB6x1oibxq0oh_B8QGHBgIICBBAYBzBlsjF6oNNUm_5dSME5-QThgsFpv3rL8eM5goY2C8AOyVfaiIIRZ_PSi7lScKOMPgEGisnj1UthszOo1Nu9REmcxMLjfxOs09Po-evE68dDT2bMywOBOrRNlQi_CXiTCcDyZjZgX8V4kmRcJ5hV_MT-C-ScD_ZZty0mzeKkgxE_WvuR7bTJl_KBebSR6LJK9gxb8GIub5dKoZZxp4-Og6cOivOlTkyijktD7OriZ_Pc4mc4eJw-3txeRuNw7kvnR_cM_FxF-X_H86u_pw2RWXNeL39bz9O49x-lzoxJkRUu3zygOPuP2Vrqsu3mrHot4r7yZrRnNphcl7DajOqg_Oe43g3-3QHxffTXocZy3I7is7Va-P1_75EfBwTnLY-Y80X298XljxPumvUgeNAw6aXpVWb3fh0oY1krA9sRjG-J97Pu8a-aJoivmhy7MExa7a47nyjx2wHyz6afOPDHniiz8OeZ5e-B4K-B43xddA0cUXQF35QIcYbG7Y_xcgeMdANds-qkDR8y5Ao7_HHCiPXCiFXCi78uugSOKroAbuQBHWOzumDhX4EQHwDWbfurAEXOugBM_B5xsD5xsBZzs-0HXwBFFV8BduwBHWOzumDxX4GQHwDWbfurAEXOugJPd_Iz8g-GdSjd6napWvw4H-TRUslTlBFP9ZhbqX6MXhU35cVroioNEpVn5LZYfxuvyq7zAXTFaxdwu5k0x7opFTYzHia9dxCid1E7enPAW1oZLe8OlVRzYnQP7qId266FVfWUXX1nFI7t45LJldjExabuY2jJC7eRNbdm1PRMGRCjYI4XYM7RnChKhgnt81eWCkO8Bdsy6EGpiZoSaWhhK7uZOrQzawwUDou_2eKF2xh4vSOQL2gMGiYRBp4gh1NTU3EKGkru5kztjzxlO5Ax3yhlOvLtQLy_2nOFEznCnnCHU1BuIW85Qcjd3ame4PWc4kTP8uJyZf_71OwAA__-zYTEB

# There should be no "by hash" routers if there is a single stream.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data WHERE a > 9 GROUP BY c, d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUks9Kw0AQh-8-RZhTS6ckm0SQPW1PUqip9I8gEsqaHUKgzYbdLSgl7y7JHmwUox7nN_NNvjB7gVoryuSJLPAXYIBwCzlCY3RB1mrTxX5oqd6ARwhV3ZxdF-cIhTYE_AKuckcCDpme6yaMAUGRk9WxH2sR9Nl9QtbJkoAnLV4tZuOLd_L1SBuSikwYDdZDY6qTNO9CSScBYdvI2vIgZNEcEDZUKzI8EGwmEs6X2e4OAxHPRIqBSDAQKfzkx_7jtyhLQ6V02oRsqCcSFCkgLLLnQ7beHbL9ajURyfRblHbRdv8wEaxvPt1PRDwd_EOn3nnPRrTjgfYv99qQbXRt6U8Hi9ocgVRJ_k1YfTYFPRpd9J_x5brn-kCRdb6b-GJZ-1YneA2zUTgeh-NROPoC5-3NRwAAAP__DNTtHA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a), sum(b), sum(c) FROM data GROUP BY d HAVING sum(a+b) > 10]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUll9r4kwUh-_fTxHOVcs7kpyZiW1zlbJ_oNDapdteLLtSpmawgs3IZIQtxe--JEKNujsnZRT0ykR9cs6c58chb1CaQg_Ui64g-wkIDDgwEMBAAoMUhgxm1ox0VRlb_2UJXBW_IUsYTMrZ3NVfDxmMjNWQvYGbuKmGDO7V01TfaVVoGyfAoNBOTaZNmZmdvCj7mhfKKWDwfabKKot6MUaqLCKMjHvWFhjc6bLQNoty_D_nLMqRRc2nYFEuYbhgYOZu1UHl1FhDhgvWvcvL8djqsXLGxul6k3l9fzn48Ti4vX8cPFxfn-Tpad3tw81Jzt-vxPuVfL_C043mVvWeXqNnVT1vlEIYLlYH4P88wOo589LYQltdrD2peYrniJhsFd48I3Y8YzOLr5OpawSl0a95kggdYZJl2ecvn65uLq-Bwe3cZbWzXDCPMbHbAw9Mz8xiTDf--ffacq02ds80dsl0jL2Y7yHVRJ8t5f3DTDXuMtV4BKnm3ZPFOyWL92Kxh2QRfbbGfnaYyeK7TBY_gmSJ7skSnZIlerHcQ7KIPltjPz_MZIldJkscQbJk92TJTsmSvTjdQ7KIPltjvzjMZMldJkseQbKIt_I7Xc1MWelOb3BJPRBdjPVyepWZ25H-Zs2oKbO8vW245otCV275Ky5vrsrlT3WDbRg3YWzDfA3Gj8H9EPgiBMagvjH109w7b-GHhV9W329LeunUD6chqv0wodoPE6r9MKWaoAnV_RDVZ1743C_rPESWHyZk-WFClh-mZBE0IesiRBYSW5Rao2F7NGyRhm3SwFUatksxaJkisU0lIW1rnX5Imp-mpPlpSpqfJqUROCVta6l6pQ0X__0JAAD__-bTv9w=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT avg(a+b), c FROM data GROUP BY c, d HAVING c = d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlmFro04Qxt__P4XMq5b_ipldTVvhwHJwUOjZo9e8OI4QtnFJAqkrq4ErJd_9UMvFJHc7lk3Ad7r6c56Z52HwDXKdqVS-qBLin4DAgAMDAQxCYBDBlEFh9FyVpTb1Ky1wl_2CeMRglRebqj6eMphroyB-g2pVrRXE8CSf1-pRyUyZYAQMMlXJ1bopU5jVizSvSSYrCQy-FzIvY88P0JN55qGnq6UywODLal0pE3uJ8D55SS3oUeVZc4L_J5x5iWD1-XTLQG-qnZaykgsFMW5Zf723i4VRC1lpE0T7cpN6HLfpj1n68DRLJ_f3F4m4rHVPvl4kWF99fpikT-_X-y_yywN1u4LPr95SlsuDWgjT7a4D_s8Odt_Z5Npkyqhs70vNVyw94uio8KF2_NMkf7-a3dVtiuM2w8uuOTwgjBGnbSvVvi4CjA7e_HvtcK829g8x9glxgH7AzxpjQnHH4vFAY4ynjDEOJsa8f5R4ryhxPxBnjRKhuDPmq4FGiZ8ySnwwURL9oyR6RUn4QXjWKBGKO2O-HmiUxCmjJAYTpbB_lMJeUQr9IDprlAjFnTHfDDRK4SmjFA4mSsQP9KMqC52Xqtdf2KhuW2UL1c6o1BszV9-Mnjdl2tuHhmsOMlVW7VNsb-7y9lEtsAvjIYxdmO_B-DF47ALfuMDopBsjO82t8xZ2WNjNGtvdCq10ZIcjF6vtMGG1HSastsOU1QRNWD12sfrKCl_bzbp2McsOE2bZYcIsO0yZRdCEWTcuZiGxRak16rZH3Rap2yZ1XKVuuxSdlikS2zQkTDtapx8yzU5TptlpyjQ7TZpG4JRpR0vVatp0-9_vAAAA__8tx7ql

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data GROUP BY d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlt9q2zAUh-_3FOZcdUzGPpKctoaBerFBoUtH1l6MLRQ1FmmgtYxsw0rJuw_b0DhpKrkoJLmT_3zWOfp-HPwCuc7UWD6pEtI_gECAAgEGBDgQSGBKoDB6pspSm-aVDrjM_kEaE1jkRV01t6cEZtooSF-gWlSPClK4kfePaqJkpkwUA4FMVXLx2G5TmMWTNM8ik5UEAr8KmZdpEEYYyDwLMNDVgzJAYKLyTJk0EPhFUBII_FvHMZsJ3qy_CkaCbkmC9jGD6ZKArqtVUWUl5wpSXJLhhV_M50bNZaVNlKzXLZozuRj_vhtf39yNb6-uTgT_3DRw--NEYG8VfL-8uvk2CQTdcm-zzNXO98_BgywfNjZFmC5XrdB3W1l9p861yZRR2dqX2q9YmsX4zcab3a56pK8r9rpqz-K6rtJGh2BE8HeFsN12MdahLiJMNt7cvjdf2xuHpxiHpDjCMKL7ybGj9J7a0bHnGHeZYzxUjunwLNFBWaJhxPaTJUfpveM9PfYs0V1miR4qS2x4ltigLLEw4vvJkqP03vGeHXuW2C6zxA6VJT48S3xQlngYJfvJkqP03vGeH3uW-C6zxI_hX21LjRNVFjov1aA_sbjpUmVz1R1JqWszUz-NnrXbdJfXLdfeyFRZdU-xu7jMu0dNgX0YN2Hsw3QNxo_BIx_43AdGr7oxsdPUet7MDjO7rJHdFrfSiR1OfFTbYYdqO-xQbYddqh20Q_XIR_WpFT6zyzrzkWWHHbLssEOWHXbJctAOWec-stAxRV1j1G-O-g1Sv0nqOUr9Zil6DVN0TFPukPZmnH5Imp12SbPTLml22inNgbukvRmqVmnT5af_AQAA___tdK1s

# Same query but restricted to a single range; no local aggregation stage.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data WHERE a = 1 GROUP BY d]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUksFq4zAQhu_7FGJOWXaCLdknwYJy2IVA6hQ3OZTWBNUajCGxjCRDS_C7F9uHJqV125vmn_nGH4zP0FhDmT6RB_kAHBAEFAitsyV5b90QT0Nr8wwyRqibtgtDXCCU1hHIM4Q6HAkkZHZp20gAgqGg6-M41iPYLrxBPuiKQCY9Xizm84t3-ulIOWlDLoqv1kPr6pN2L8rooAHhrtWNlyziy9Ejp8aQk0zxP0ogU_yxi-OkVOnw_qsSZCqFzxT5TxRXVeWo0sG6iF8bqhQQVtn9IdvuDtl-s1mo9Pegur9ZKH7xYv_Xm92_nCnxQZYAwrYLkimBKsEZbXGl_cXJcvKtbTx962ZxXyCQqWj6LbztXEm3zpbjZ6ZyO3JjYMiHqZtMxbqZWoPgJcxnYTEPi1k4fgcX_a_XAAAA___19-2A

# Verify the XOR execution plan
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT xor_agg(to_hex(a)::bytes) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lE1r3DAQhu_9FWZOLcjIkr2bjU6bQgm5NGWTQ0sxQV0NzsJGMpIWUoL_e7F9iL0ksorjoz9ePS_PiHkBbRR-l0_oQPwGBgQ4EMiBQAEEVlASqK3Zo3PGtr_0gRv1DCIjcND1ybevSwJ7YxHEC_iDPyIIuJd_jrhDqdDSDAgo9PJw7DC1PTxJ-3erpJdA4K6W2okkpSyRWiUsMf4RLRDYoVZoReLNwyM-f96yL0J8_XX_7Y4kWwZlQ8Cc_GsD52WFIFhD4lteVZXFSnpj6Wpc8uft7uHq-rqlvovi76JeCSdtrEKLanR82YTLsOz_2-SjNix-PCxmPJSllC8woImeAyfruQPi8Up4lBKe0nwBJRM9B0ou5irJ45XkUUrylBYLKJnoOVCymaukiFdSRCkpUrpaQMlEz4GSy4_cbG-gduhqox2ebbi3T87azYeqwn5NOnOye_xhzb7D9I-3Xa57odD5_ivrH250_6ktOAyzYJiPwuw8zMPkCXQeTBfhcDGn9yoYXofJ6znki2B4EyZv5pAvw7PKJq5J-JKds8vm078AAAD__3zS9gk=

# Verify the XOR execution plan
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT xor_agg(a) FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslM-LnDAUx-_9K-SdWojERJ2d9TR7WvbSKdMeCkVKah5WmDWSRGhZ_N-LehgdZmJK9uiPbz7fDy-8N2iVxM_iFQ0UP4ABAQ4EUiCQAYEcSgKdVhUao_T4yxx4kX-gSAg0bdfb8XVJoFIaoXgD29gzQgHfxK8znlBI1DQBAhKtaM4TptPNq9B_D1JYAQS-dqI1RRRTFolWRixS9jdqIHDsbREdGJQDAdXbC8tYUSMUbCD-fZ7qWmMtrNI0X9f5fjz9fHp-_nhgn-6i-F3UhdC3SkvUKFfHl4O7DEv-v026asP8B8F8BkFZTHnQKDYaLex3oaPg_vLcS57HNA2S32i0kH8IlU_95VMv-TSmWZD8RqOF_D5UPvOXz7zks5jmQfIbjRbyj--5gW6gTmg61Rq82kS3T07GDYWyxnmdGdXrCr9oVU2Y-fE45aYXEo2dv7L54aWdP40Fl2HmDPNVmF2HuZu8gU6d6cwdzkJ6587wzk3ehZAfnOG9m7wPIT-6Z5VsXBP3Jbtml8OHfwEAAP__W2jUcQ==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT max(t.a), min(t.b), avg(t.c)  FROM (VALUES (1, 2, 3), (4, 5, 6), (7, 8, 0)) AS t(a, b, c) WHERE b > 3]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkM1KxDAUhfc-RTmrGQhM0m4kq3ajdDFVRETQLkJ7KYXYW_IjwtB3lzYLHWFEd7nn5jtfyAkT99SYN_LQL1BoBWbHHXnPbo3Shbr_gJYC4zTHsMatQMeOoE8IY7AEDcudsdm7sZF8Jg8SAj0FM9qt-Wa0gZzOyjx7jVIWlBVa67p5vEa7CHAMX80-mIGg1SL-bq-GwdFgAruDOjcfq-ddqfYQONbNrszXU_V0uyuL_UV1_h_1A_mZJ09n2kvNcmkFqB8ofa7n6Dq6d9xtmjTebdwW9ORD2qo01FNarQ_8Dqtf4fwH3C5XnwEAAP__aQiixw==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM (VALUES (1, '222'), (2, '444')) t1(a,b) JOIN (VALUES (1, 100.0), (3, 32.0)) t2(a,b) ON t1.a = t2.a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyckUFL_DAQxe__T1Hm9BcCbVJPAaFH14MrXqWH0IzdQsyUTCLC0u8uTQ7rLq7ueuvMvN-8zssePFl8NG_IoF9AQi9gDjQgM4W1VQQb-wG6ETD5OcW13QsYKCDoPcQpOgQNjgbjqnfjEnLV1A0IsBjN5LJ-EUApHmiOZkTQchF_dJC1vMhBnXU4LE6egsWA9nTj75JvfvPe8O6BJo-hVkdqcPga_3fy5i5M4y5_gYBtirrqpOiU6FrR3cK5S9prsnpGnskzXpRRs56BdsQSC1MKAz4FGrJNKbeZyw2LHMtUlWLj8yg_5ldYXgGrU1j9CLdHcLP0y7_PAAAA__870evq

statement ok
CREATE TABLE nullables (a INT, b INT, c INT, PRIMARY KEY (a))

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT array_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlEGL00AUx-9-iuF_anFiMkkqy4CQ4LpLYW2l9iISZOw8YqCbCTNTUJZ-d2mC1ojVkV5ynPfyy3u__-E9oTWaVuqRHORHCHCk4MjAkYNjgYqjs2ZHzhl7-mQAlvorZMLRtN3Bn8oVx85YgnyCb_yeILFVn_e0IaXJxgk4NHnV7PsxnW0elf1WaOUVON53qnWSRbFgqtVMMOO_kAXHXbP3ZCWbzYqUvWJCSrlcbW_mrFzdslmRnWovEinl3cO63N7MfzTyn43bN6-Xb8uHOTjWBy9ZIVAdOczBnxd3XtUEKY78gtzZyVhNlvTYphDPUR3_kEBZ15Zq5Y2NF2Ok3GzKD5_K-_tZIeYXN0pHG4nwuEVI3LGI4nQ6gafhemmQXhrF2XT0snC9LEgvi-J8Onp5uF4epJdH8WI6ev84dRtynWkdjcwu_Tk5nQrSNQ2nxZmD3dE7a3b9mOG57rm-oMn5oSuGx7LtW_2Cv8Lir_DLEZz8DqfXTM6ugfNr4MV_wdXx2fcAAAD__6aqGXg=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT json_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlEGL00AUx-9-iuF_anFiMkkqy4CQ4LpLZW1ltzcJMnYeMdDNhJkpKEu_uzRBa8TqLL3kOO_ll_d-_8N7Qms0rdQjOchPEOBIwZGBIwfHAhVHZ82WnDP2-MkALPU3yISjabu9P5Yrjq2xBPkE3_gdQWKjvuzonpQmGyfg0ORVs-vHdLZ5VPZ7oZVX4HjoVOski2LBVKuZYMZ_JQuOm2bnyUo2mxUpe8OElHK52lzNWbm6ZrMiO9ZeJVLKm7t1ubma_2zkvxrX794uP5R3c3Cs916yQqA6cJi9Py3uvKoJUhz4GbmTk7GaLOmxTSFeojr8JYGyri3VyhsbL8bI-4f16nN5ezsrxPzsQuloIRGetghJOxZRnE4n7zRcLw3SS6M4m45eFq6XBellUZxPRy8P18uD9PIoXkxH7z-X7p5cZ1pHI7Nzf06Ol4J0TcNlcWZvt_TRmm0_Zniue64vaHJ-6IrhsWz7Vr_g77D4J_x6BCd_wuklk7NL4PwSePEsuDq8-BEAAP__vcYZMw==

# Test that orderings on GROUP BY columns are propagated through aggregations.
statement ok
CREATE TABLE sorted_data (a INT PRIMARY KEY, b INT, c FLOAT, INDEX foo(b))

# Split into ten parts.
statement ok
ALTER TABLE sorted_data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE sorted_data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE sorted_data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFq8zAQhO__U4Q5JbAhlsN_0ck5BlKnpCm0FBNUa2sCqddIMhSC373YOjQpxG2PO9pvZlidUYvl3Lyzh36BAuE_CkLjpGTvxfVyXFrbD-iEcKybNvRyQSjFMfQZ4RhODI1c5tIsUhAsB3M8DWsdQdrwBflgKoZednRhrMaN9-b1xDs2lt0iubLHm0jmxQW2B2uCAeGhMbXXkzkI2zboSaYoS3Grh_pLj1VVOa5MELdQ1zWyfl7lz4d8uz_kj5vNNFMzEO5WT9Msnd2MT6_if7jvjn0jtedfHTjpCgLbiuMfemldyfdOyiEmjtuBGwTLPsTXZRzWdXzqC17CahROx-F0FE6-wUX37zMAAP__NDHaoA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a ORDER BY a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllGL4jwUhu-_X1HO1QxfSj1p62iv6uXArC6zs7DLIpKxQQWnKWmEHQb_-1J7YdWdnJbUxUtbn-RNnsNLPyBXmZyKN1lC8gsQGHBgEAKDCBjEMGdQaLWUZal09ZcaeMx-QzJgsMmLnakezxkslZaQfIDZmK2EBF7E61Y-S5FJHQyAQSaN2GwP2xR68yb0e1oqbWS2yIQRwOBbIfIy8fwAPZFnHnrKrKUGBrOdSbwUWcphvmegdua4a2nESkKCe9Y-2WS10nIljNJBfBosrS5gpjOpZVZtCQwm05-L6exlMf3-9HSX4j0w-DL5cZfy-7Mwx_Vf3721KNcXS8_3x8D808DHdVQd5Hyd_-uFLKfCQX_HOkYOe488Vb4qAjyV8Nn20cn22H74sMPwBegH3HX8iGwNUcPbGD_sefzw-uPH2_vnXfxzPwhd_RPZGjf1cBv-ec_--fX9h-39h138h34QufonsjVuanQb_sOe_YfX9x-19x918R_5Qezqn8jWuKnxbfiPevYf_dvPj7-keZZlofJStvqyGFTnkdlK1ucv1U4v5Vetlodt6p-zA3d4kMnS1G-x_vGY16-qgE0Yz2FswvwExm7w0AUeu8DolBtjO82t9x3a4dAua2i3FVnp2A7HLqrtMKHaDhOq7TClmqAJ1UMX1Q9WeGSXNXKRZYcJWXaYkGWHKVkETcgau8hCokWpGnXrUbcidWtSxyp161J0KlMk2jQipF3UaSdpdpqSZqcpaXaalEbglLSLUrVKm-__-xMAAP__HM5iZA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlk1v4jAQhu_7K6I5Fa2jYDuhkFN6ROqGVbd7WK0QcokFSDSOHCNtVfHfVyQHwkc9CeaQYz6ezIzfR6N8Qq4ymYp3WUL8FygQYECAA4EQCEQwJ1BotZRlqfThlRqYZv8gHhLY5MXOHG7PCSyVlhB_gtmYrYQYXsXbVr5IkUkdDIFAJo3YbKsyhd68C_2RlEobmS0yYQQQ-FWIvIw9P6CeyDOPesqspYb5noDamWOh0oiVhJjuSftmnlYrLVfCKB1Ep70kh5lnOpNaZrFXXT2lfxbp7HWR_n5-fkjoAAj8mKYPCRtcPOSDs_6OJd8-vLUo1xfV5vvjDOzLGY7fUXVv59_5Xn_IMigd3nlSArOdib2Ek4SRapLryfAWU-3ya3NdHSlVvioCGp29eb12eFKbtleUdlA0oH7AbpAUaaeR3ai3ktI7S0p7ISlrLwrrIgrzA36DKEg7jfN77K0o7M6isF6IwtuLwruIwv0gvEEUpJ3G-Y17Kwq_syi8F6KE7UUJu4gS-kF0gyhIO43zm_RWlPDOooS9EAX5c32RZaHyUrb6-xkeRpbZStZHVKqdXsqfWi2rMvXlrOKqG5ksTf2U1hfTvH50aLAJ03OYNmF2AtNu8MgFnrjA1KlvGtlpZj1vboe5PayRPa3QSkd2OHKJ2g4jUdthJGo7jEWN0EjUI5eoH63w2B7W2CUsO4yEZYeRsOwwFhZCI2FNXMKiyBbF1qjbHnVbpG6b1HGVuu1S6rRMKbJNQyS0i3XaKTQ7jYVmp7HQ7DQaGoJjoV0sVWto8_23_wEAAP__X2mXqg==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c ORDER BY a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlsFu4jAQhu_7FNGcitZRsJ1QyCk9InXDqts9rFYIucQCJBpHjpG2qnj3FcmBAMWTYA45hvB5Zvz9GuUTcpXJVLzLEuK_QIEAAwIcCIRAIII5gUKrpSxLpQ9_qYFp9g_iIYFNXuzM4ec5gaXSEuJPMBuzlRDDq3jbyhcpMqmDIRDIpBGbbVWm0Jt3oT-SUmkjs0UmjAACvwqRl7HnB9QTeeZRT5m11DDfE1A7cyxUGrGSENM9ad_M02ql5UoYpYPotJfkMPNMZ1LLLPaqp6f0zyKdvS7S38_PDwkdAIEf0_QhYYOLl3xw1t-x5NuHtxbl-qLafH-cgV2d4XiOqns7P-d7fZBlUDq886QEZjsTewknCSPVJF-b4TdPxa9MlSpfFQE9VXetfHhSnrZPKe2Q0oD6Abshp0g7DX2j3uaU3jmntBc5Ze2DwroEhfkBvyEoSDuN-3vsbVDYnYPCehEU3j4ovEtQuB-ENwQFaadxf-PeBoXfOSi8F0EJ2wcl7BKU0A-iG4KCtNO4v0lvgxLeOShhL4KCfLy-yLJQeSlbff0MDyPLbCXrKyrVTi_lT62WVZn6cVZx1Q-ZLE39ltYP07x-dWiwCdNzmDZhdgLTbvDIBZ64wNSpbxrZaWa9b26HuV3WyG4rtNKRHY5cVNthRLUdRlTbYUw1QiOqRy6qH63w2C5r7CLLDiOy7DAiyw5jshAakTVxkUWRLYqtUbc96rZI3Tap4yp126XUaZlSZJuGiLSLddpJmp3GpNlpTJqdRqUhOCbtYqlapc333_4HAAD__6Vgl6k=

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT b, max(c) FROM sorted_data@foo GROUP BY b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkk9r8kAQxu_vp5DnpLBi_vhecopHi02KtdBSgmyz0xDQTNjdQIvku5dkCzWCaT3uzPzm-YXJCRUrSuSRDKJX-BD4j0yg1pyTMay7shtaqw9EnkBZ1Y3typlAzpoQnWBLeyBESHjO9SKEgCIry0M_1gpwY38gY2VBiJatOFvsjy_eybcDbUkq0gtvsB7vzLFhbUntlbQSAo-1rEw0mUMgbWw0iX1ck_Bvkbjjsvp28IcOtS6PUn9eeLjwQMTh1fzglvxVUWgqpGW9CIb5ceeTakWaVP-9AqvkZZ-ku33ytNlMY38GgfvV8zQOZldlwoHML6fekqm5MvSnW3ttJkCqIPc7GW50Tg-a8z7GPdOe6wuKjHXdpXusK9fqBM9hfxQOxuFgFA7H4XAU9i7grP33FQAA__9E9hy_

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM (SELECT a, max(c) FROM sorted_data GROUP BY a) JOIN (SELECT b, min(c) FROM sorted_data@foo GROUP BY b) ON a = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMl11v4kYUhu_7K9C5SrSDzIzNp1TJuUy1C9V2K7WqUOTgCSARDxobqVHEf6_AqvgwnNeTIa3vAviZOYd53hzmnTKT6nHyqnMa_UWSBCkSFJKgiAR1aSpobc1M57mxu0dK4DH9m0YdQctsvSl2b08FzYzVNHqnYlmsNI3oR_K80t91kmobdEhQqotkudpvs7bL18S-xbmxhU6f0qRISNBv6yTLR612IFtJlrZkyxQLbUnQZFOMWrEUcUjTrSCzKQ675kUy1zSSW1G_sof53Op5UhgbdE8Li3dfwMSm2up0tyUJehj_-TSe_Hga__71610s70nQt4c_7mJ1f1bMYf3nt9YiyReVpafbQ8HqasGHdUxZyPk6X8qFmK5k5_9qK_RrSxye2mSXnrvY-Tdt5_oXs8y0DeTgdN2VfinuYvnl_me7nC_KP4-VUiIORRxdFatfoyGHUsembdaBCs-evLz34GRvWT9u0iFugWwHyjdwoLYjNXvNCJy8ceBkMwLn3NYNAjf8zMCp-tIrF-lVOwh9pQe1HenRb4b06sbSq2ZI79yWv_Sq85nSh_WlD12kD9tB5Cs9qO1Ij0EzpA9vLH3YDOmd27qB9PIzpY_qSx-5SB-1g66v9KC2Iz2GzZA-urH0UTOkd3BEnt3sXoy5ct08CHHVhsilil1a_i2iV8fUcnfF6dj9oI7yY788HsfeB9fz8_EG_63Uf3URvFDId52vTZbrWte8zq4Vnc51-e3kZmNn-ldrZvttypeTPbd_I9V5UX4qyxePWfnRrsBjWJ7D8hhWJ7B0g_s-sJRedNeLHvK0YunQBx74wBIcF6B7PrQCbYespBEPRyysIl7xLkv3eLjnkw8eBvngYZQPQIN8ABrko--TDx4G-eBhlA9Ag3zwNMrHwCcfQ34CdMAIqAwQpxnA02gI8DScAgBHYwDgwHPJjxFw4oAGpgMaqY5w4DrAkeyyMktcbJf8LJFgHMjKNHHSnaeR7jwNdQc40h3gSPfKIHXSnaeR7jwNdQc40p3Hoe6Vceqke2WwnOo-ALpXJouT7jyNdOdpqDvAke4AR7pXpqqT7jyNdOdpqDvAke48jnRX_IVUgRupqsyWU1wB3OV2phzpgRd9dmzOeM8LV6h1tyvadPvTPwEAAP__qGgS1A==

# Verify that the stages preserve the ordering as expected.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) GROUP BY a ORDER BY a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllFr4kAUhd_3V4T71NIJ8c5Ea_OUviwUurp07cOySJmaQQWbCZMIW4r_fUkCa9Q6N91JXR9j_GbOvedwyBukOlEj-aJyiH4BAgMODAQwCIFBH6YMMqNnKs-1Kf9SA3fJb4h6DJZpti7Kn6cMZtooiN6gWBYrBRFM5PNKPSiZKBP0gEGiCrlcVddkZvkizWucyEICgx-ZTPPI8wP0ZJp43NPFQpkcGDyoNFEm8mJxFfMo-no_vp0MmRcj82LOvFjAdMNAr4utjLyQcwURblh7qbfzuVFzWWgT9HeVxuU2xiZRRiWRVz3djn4-jcaTp9Hj_f1FzC_LAR6_XcR4uSdme_7zq7eQ-WLvaITpZiuYHxW8PUfXQvbPuaoPskyFvYO7m2PhwVj4d6xqwPG6KKdnleb3Fy7-WT8_on-kfZ0FuOvIsevDneuxfTSxTTQD9ANehRPrcHaYTUJrw8XBeWQTO84mnjibvH04eKtwcD8QnxQOQmtjjdfnEQ7ecTj4icMh2odDtAqH8IPwk8JBaG2scXge4RAdh0OcOBxh-3CErcIR-tUHR1eBIPQ1VndzHoEIOw5E-B8_c96R9qDyTKe5avUF0yuHU8lc1cvI9drM1HejZ9U19eO44qofEpUX9VusH-7S-lUpsAnjPoxNmO_A-DF44ALfuMDopBv7dppb9y3ssLCbNbC7FVrpvh3uu1hthwmr7TBhtR2mrCZowuqBi9XXVnhoN2voYpYdJsyyw4RZdpgyi6AJs25czEKiRakadetRtyJ1a1LHKnXrUnQqUyTaNCRMO6jTD5lmpynT7DRlmp0mTSNwyrSDUrWaNt18-RMAAP__oBl70Q==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) WHERE a > x GROUP BY a ORDER BY a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlk1r40gQhu_7K0SdEtJGqm75SyflEghk7SWbHJYdExSrcQyO2rRkmBDy3wepYSxb4yp5rGR89Mejqu73qULvkJlUT5JXnUP0PyAIkCBAgYAQBPRhJmBtzVznubHlXxxwm36HKBCwzNabovx6JmBurIboHYplsdIQwUPyvNL3Okm19QMQkOoiWa6qMmu7fE3sW5wmRQIC_l0nWR55PR-9JEs96ZniRdscBNzrLNU28mJ1FcsourmbXj-MhBej8GIpvFjB7EOA2RTbNvIiWWiI8EO0b3Viembt93ebvFmuiqq29L5tgkBpL8aD5eQx5a4XC6sXSWGsj3s3E5e3P7WptjotS4OA68l_T5Ppw9Pk8e7uIpaX5YU9_n0R4-VeN9sCz2_eS5K_7D267H7bsTrY8fY5xjWy_5wr9yDqWP1G7fqxsHEs_Hms6oDTTVGeXhA3Hv52__JA_84CuZvIofL9nfLYfhSwzSj42PNlNQzohqHDWWB6dbcw6GwWmHJ1afA8ZgE7noXBF8-CbC-jbCWj7Pnqk2RkenUyDjuTkSlXT02eh4yyYxmHXyyjai-jaiWj6vnhJ8nI9OpkHHUmI1Ounpo6DxlVxzKOvljGsL2MYSsZw1711tiVgEx_TsBxZwIy5epJhechYNixgOM_-Jr6i9budb42Wa5bvYEG5eF0utDuMnKzsXP9jzXzqoz7OK246otU54X7Fd2H28z9VDZYh5GEJQ3LfRjrsNqB8Th4dAqM8iR6cAotA5pW5IWHNBzSaTFZ90l6QMMDEh7S8PAUUWiYEYWGOVEYmhGFpjlRRqeIMqZ3QsAsBWalcDulsVSOiZuhmbwZmgucw5nEGZyLHBur5ZjMkV4tGDKp0csF-wze2C5HhU7TXOg0zYbO4FzoNM6GTm9WLvTGktlNbcSkRm8ZHDN4Y88cFTpNc6HTNBs6g3Oh0zgXuqQ37H7os4-_fgQAAP__8yKVTQ==

# Ensure that an interesting input ordering that causes an ordered group by
# forces an ordered synchronizer. We create an index on b even though it's
# not used to help the optimizer realize that there's an ordering available
# on b for a constrained scan on the a,b primary index.

statement ok
CREATE TABLE data2 (a INT, b INT, PRIMARY KEY (a, b), INDEX(b));
ALTER TABLE data2 SPLIT AT SELECT 1,i FROM generate_series(1, 9) AS g(i);
ALTER TABLE data2 EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i);

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE data2]
----
start_key  end_key  replicas  lease_holder
NULL       /1/1     {2}       2
/1/1       /1/2     {5}       5
/1/2       /1/3     {5}       5
/1/3       /1/4     {5}       5
/1/4       /1/5     {5}       5
/1/5       /1/6     {5}       5
/1/6       /1/7     {5}       5
/1/7       /1/8     {5}       5
/1/8       /1/9     {5}       5
/1/9       NULL     {5}       5


query T
EXPLAIN (opt,verbose) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b
----
group-by
 ├── columns: b:2 count:3
 ├── grouping columns: b:2
 ├── internal-ordering: +2 opt(1)
 ├── stats: [rows=9.5617925, distinct(2)=9.5617925, null(2)=0]
 ├── cost: 11.1156179
 ├── key: (2)
 ├── fd: (2)-->(3)
 ├── prune: (3)
 ├── scan data2
 │    ├── columns: a:1 b:2
 │    ├── constraint: /1/2: [/1 - /1]
 │    ├── stats: [rows=10, distinct(1)=1, null(1)=0, distinct(2)=9.5617925, null(2)=0]
 │    ├── cost: 10.81
 │    ├── key: (2)
 │    ├── fd: ()-->(1)
 │    ├── ordering: +2 opt(1) [actual: +2]
 │    ├── prune: (2)
 │    └── interesting orderings: (+1,+2) (+2,+1)
 └── aggregations
      └── count-rows

query TTTTT
EXPLAIN (verbose) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b
----
group           ·            ·              (b, count)  ·
 │              aggregate 0  b              ·           ·
 │              aggregate 1  count_rows()   ·           ·
 │              group by     b              ·           ·
 │              ordered      +b             ·           ·
 └── render     ·            ·              (b)         +b
      │         render 0     b              ·           ·
      └── scan  ·            ·              (a, b)      +a,+b
·               table        data2@primary  ·           ·
·               spans        /1-/2          ·           ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlFtr3DAQhd_7K5Z52lAFW9pLQU8OfVpI7bIXSilmUazBMWwsI8nQUPa_F1sBX7pRdrel5FGe-WbOmQP-BaWSGIsnNMB_AAUCDAgsICVQaZWhMUo3Jde4kj-BhwSKsqqt-2wLe0DgUJdKS9QogYBEK4pDU0-PKYFMaQTetcbqVlXBctRIQNX2ZWxKwFiRI_D5kfRW097qE4O34uGAaxQSdRAOxkOliyehnyMprGgcbipRGj4J6G1Ag8Z2Uls-iRiJKLymhV6i5S7PNebCKh2woZSoXeeOxSft6y7-vo-T7T7e3d9PI3oDBD4nu3i7XyffNtObkaJuycPz5FGYxz_mt2d_Uc1eVd3NORUdRPQjnMyvZ21-jbXN7st-FW-nERs761TPBqrZ-bnTM3NvkmfX5P6Glt5xZu8od_Zvc1_8n9xD_63XaCpVGjzrTxI2llDm6E5gVK0z_KpV1q5xz6Tl2g8SjXXVT-6xKl2pEdiHqRdmfpiNYdqHZwOYXgYv_fDMKzv0w3MvvPB7XvyNZz_8huflRZ7T44ffAQAA__-nWEjn

statement ok
CREATE TABLE uv (u INT PRIMARY KEY, v INT);
INSERT INTO uv SELECT x, x*10 FROM generate_series(2, 8) AS g(x);

# Regression test for #37211 (incorrect ordering between aggregator stages).
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(v) FROM data INNER LOOKUP JOIN uv ON (a=u) GROUP BY u ORDER BY u]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMll9vmzAUxd_3KdB9ajVHxDb5xxN97NQlU9c-TFNUucFKs7UYGTKtqvrdJ2BqCDT3wohYHgn52cc-5x7xApEJ9Vw96QT878CBgQAGEhh4wGAESwaxNSudJMZmfymAy_A3-EMGmyjeptnPSwYrYzX4L5Bu0kcNPtyo-0d9rVWorTsEBqFO1eYx3ya2mydln4NQpQoYfI1VlPjOwOWOikJHOCZ90DYBBott6jsBh-UrA7NNd5slqVpr8Pkray7ok9lEf_WM3tez_QUMroz5uY2dH2YTOSbKt38TwgLBAnlQjmgj52K9tnqtUmNdXrmfIPNgYUNtdeg7-dPF_NvdfHFzN7-9ujoLxHl2bbefzwJ5XlGz2-D-2XlQyUNl6ewyd4rlQcW7dUwhpLrOx2Ih7Fij2t7lY_HasfjbsfIDFpcuGBIA75_1iwP652ZgYlfsO3Jo-9He9rz5QPAmA-HygSvykeDFSLSeCEJRaSLGfUwEIaccHX4aE8GPPBHjnidCNI-kaBRJMXBlp0gSikqRnPQRSUJO2TtxGpEUR47kpOdIyuaRlI0iKQeu1ymShKJSJKd9RJKQU_ZOnkYk5ZEjOe05kl7zSHqNIukN8k_MdjEkVJRiOOsjhoScsl_eacTQO3IMZ__x8_Udadc6iU2U6EZfpsPscDpc6-IyErO1K_3FmlW-TfG4yLn8h1AnafGWFw-XUfEqE1iGOQoLHBZVmJdhuQfzdvC0C8xFJ3rchRZDnJbohXs47OFuEV6PUHqMw2MUnuDwpEtQcJgICg5TQSFoIig4TQVl2iUoM7wThkQpEJVCdUqtVNrYTdCE3wRNGU7hhOMETlnOa9XSxnOOVwv3CNfwcuEjAq-1SyvTcZoyHadJ0wmcMh3HSdPxZqVMr5XMvmtTwjW8ZfiMwGs908p0nKZMx2nSdAKnTMdxynSBN2zV9OXrhz8BAAD__2dkrLM=
