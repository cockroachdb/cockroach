# LogicTest: 5node

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, _bool BOOL, _bytes BYTES, _bit BIT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Verify that all aggregate functions that we expect to have multi-stage
# execution do, in fact, get planned with 2 stages.
query T
EXPLAIN (DISTSQL) SELECT
  b, -- any_not_null
  avg(a),
  bool_and(_bool),
  bool_or(_bool),
  count(a),
  max(a),
  min(a),
  stddev(a),
  stddev_samp(a),
  stddev_pop(a),
  sum(a),
  sum_int(a),
  variance(a),
  var_samp(a),
  var_pop(a),
  xor_agg(_bytes),
  count(*), -- count_rows
  bit_and(_bit),
  bit_or(_bit),
  covar_pop(a, b),
  regr_sxx(a, b),
  regr_sxy(a, b),
  regr_syy(a, b),
  regr_avgx(a, b),
  regr_avgy(a, b),
  regr_intercept(a, b),
  regr_r2(a, b),
  regr_slope(a, b),
  regr_count(a, b),
  covar_samp(a, b),
  corr(a, b),
  sqrdiff(a)
FROM data GROUP BY b
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: b
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsmVFvokoUx9_vp5jME70ZozOgtT7BWmpIFFygvW1uGoIy65prwQVsbDb97jcDiGBdRotv5aEy5zD_M8fz7_we2t8w-rWCA6g-TseKpgPhVrNs6_v4CljqWB3aYIaA-7oQ3CsEZkGwclzfExy22iWCMI_nwcaPk60v7jZ9Lv3kGcWeR18LSydyX9bFeB1k4eZl93SWWbVXN1y6_pzugr2YBTvlNggdd7EQnNlbTKO8nb9Zo8s4a3wZZ2HSdhLNg7wKArMrBEK6CJ1ouz2I38rxWzl2Xxfbw0R5x9KPaTin67iUDUm57CpY01ImG2qaSXtNv_4uE4a7dfQr9JY_fgjuFbgzjQnw3NgFI9O4n4JvT2AGEfQDj-ruC43g4F-IIYIEIihCBCWIYBc-I7gOgzmNoiBkW34nAs3bwkEHwaW_3sQs_YzgPAgpHPyG8TJeUTiAtjtbUZO6Hg3bHYigR2N3uUqOYV3I7MNZ_0ffIILDYLV58aMBYG0jkPz2sAezjT2XMUTQWrtsS6uNget7AIMg_klD-PyOYLCJ941EsbugcIDf0enNKotFSBduHITtbrlXmc1D0Z8c3bAd_X48FmRyxbq5nwgyZquhca_b2fqbYYwdRb8VZDEPDTOLko2OafxjCSycKI-ZaqLp2cr6bt5qd3e76H7iaHntR8N0lNFIkKWktGanB3V3ETsnCWxT0S3N1gzdMdWRqVoWWyqjkamOFFsVZIzYdygPbj-L2Rv46UY_D8aA4fP7frjkj8Pd19n4QejRkHqlSkmVivHjzoeDD-eP8_mT0pTEsgNSyYFuaWsvN-A6N6DPVnearowdy769VR8E-QbJBKV1iy-cqTEtvdwb1dnvfVBMTdGH6pEyD4r5oUZuL8YlfzEpGowLVYZGXgdL-zTz3LEeH49mn45ln45llYfRsRLKw-jYbk23VXOoTu0j70xy7NCxMVXL-fT7WMpkepg3zXImvyaF-ZnU92g4ADJGQCZtWURAlhCQuwjIPQTkawTkPgLyTfaDO2wfWzABJvkHE2IpU2Emx8mKFcCsAmZyksiTs5iKMBVhKrI7kCQfTEX6f6SUeNmLpAetYN3G3YOdx8-WSmfj03GOL4jzNm61ySeAzmm3QJReA_RzgY4vCXTcAL0B-hcFOjkdquSSUCWttvgJqHLaLdzq6waq50KVXBKqpIFqA9UvClXxdKiKl4Sq2GpLn4Aqp93Cre43UD0XquIloSo2UG2g-kWhKp0OVemSUJVa7e4noMppt3CrbxqongtV6ZJQlRqoNlD9olDl_NfJpNE68CN60l9rO-yiUW9B01sZBZtwTqdhME-OSUMj0SUJj0Zx-hangeanr1iDRTE-FOOimJTE-Dxxr474po4Y1-obd6vVpHLeYrVYrDarV-2WVKnuVou7dayuFnOsrhZzrK4W86zmqDlW9-pYfV0p7leb1a9jVrWYY1a1mGNWtZhnFkfNMeumjlmYQ1EeRutxtB5I65G0JkrrsRTXginm0FTimPYBp2eZVq3mmVat5plWreaaxpHzTPsA1UrTnt__-j8AAP__B0P_tA==


statement ok
ALTER TABLE data DROP COLUMN _bool;
ALTER TABLE data DROP COLUMN _bytes;
ALTER TABLE data DROP COLUMN _bit;

query T
EXPLAIN (DISTSQL) SELECT sum(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslF2Lm0AUhu_7K4ZzlcCIjpps1qtdtikEsh-NKRSKlGnmYEONY2dGaAn570W9WBM2o9W9CfHjned9OHKOoH9nEMHy68v6fvVEJh9X8Tb-vJ6SeLlePmyJLg8TPiWfNs-PRHDDgUIuBT7xA2qIvgEDCj5QCIBCCBRmkFAolNyh1lJVrxzrwEr8gcijsM-L0lS3Ewo7qRCiI5i9yRAi2PIfGW6QC1SuBxQEGr7PakyFvqt-vhe_8C9QeJBZech1RKpGccGrv47LCM8FYUSan6ggOVGQpXkFasNThIidaP9S92mqMOVGKnd23in-8ji5Y9OrGP8q5vX0MpdKoEJxdnRyshdh3v81Cc6asP5TYAOm4DLH9QfMoaNWS38-Zg5-f3t_iL3vuMEA-45aLfubMfZBf_tgiH3guOEA-45aLfvFGPuwv304xD503NkA-45aLfvb99pAb2A2qAuZa7zYRG-f7FUbCkWKzTrTslQ7fFFyV2Oay-c6V98QqE3zlDUXq7x5VBVsh5k17J-F2WXYt5M70IE1HdrD4ZjeM2t4bifPx5BvrOGFnbwYQ761z8rr-EzsH9klOzl9-BcAAP__g7LmoQ==

query T
EXPLAIN (DISTSQL) SELECT sum((a-1)*1000 + (b-1)*100 + (c::INT-1)*10 + (d-1)) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUldGL2k4Qx99_f8UyT8ndhmSTeOflSfH8QUC9q1ooFClrdrBSzdrdBFrE_70k4TCRu40lfdEHcWb2u9_ZjwNzBP1zBxGMv7xOhvGMWM_xYrn4NLHJYjwZj5ZE53ur-HDiEGaTO8I8z7PJPbGsdS1lV6kkiuLZsn8uVHlRJmzy__xlSgTPOFBIpcAZ36OG6CswoOADhQAohEChBysKByUT1Fqq4sixFMTiF0QehW16yLMivaKQSIUQHSHbZjuECJZ8vcM5coHK9YCCwIxvd6VNYT0ovr4dfuBvoDCSu3yf6ohwStaUJJQIoLA48CLnuIzwVBBGZPYdFVCYYypQRaQAMmAOi6rn2ncFlLfg3rIGfrP29rusBVXQOFE7MAjLyvN4FE-HExtWJwoyz87v1RnfIETsRK9nMtxsFG54JpXbayJZfJ5aA_axjf-hzfn2PJVKoELRuHp1MjfCvL_rJGh0wq4fAtZlCFzmuP7NjEELlRr9hy5j4F8P3-8E33fc4Gbgt1CpwX_sAj-4Hn7QCX7guOHNwG-hUoPf7wI_vB5-2Al-6Li9m4HfQqUG_-lfbZ93bOaoDzLVeLGF3r_ZK7YTig1Wq0zLXCX4qmRS2lThS6krEwJ1VlVZFcRpVSoarIuZUew3xOxS7JudW6wDozo0i8MuffeM4gez80MX50ejuG927ndxfjL_V17LmJiH7NJ7dfrvTwAAAP__immEiQ==

query T
EXPLAIN (DISTSQL) SELECT sum(a), count(a), max(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF-L4jwUxu_fTxHOVYVITVsdp1fKvC4I_pm1yg4sIllzcGW1cZMUZhG_-5IKO1XGtFS8kabx6e_hd0KOoH_vIIbB2-uoP5wQ7_9hMk--jhokGYwGL3Ois73HG5SsZZaa_GnP3z3eIF9m0zER3HCgkEqBE75HDfF3YEAhAAohUIiAQhuWFA5KrlFrqexfjnlgKN4hblHYpofM2NdLCmupEOIjmK3ZIcQw5z92OEMuUPktoCDQ8O0ux1h0z_6sDr_wD1B4kbtsn-qY2EbJgdvHps8ITwVhRJqfqGB5oiAz8wHUhm8QYnai1Uv1NxuFG26k8tuXnZLF2Ouxhi0zXUzmq9n0W-LZ5bj_lm_c4gc3-R_YLJVKoEJxwVye3A1Z61bFZDFeDSdzrxf8axjebhheNGTVx8ZqjM1nTT-oMbiSWgUtnYcMLqiuJaijJWj6YQ0tJbUKWp4eoiWsriWsoyVs-lENLSW1Clq6D9ESVdcS1dESNf12DS0ltQpanh9--33Cn6E-yFTj1S34-Zdb9nZEscHzVaplptb4quQ6x5yX0zyXvxCozXmXnRfD9LxlCxbDzBkOLsLsOhy4ySXo0JmO3OHont5tZ7jjJnfuIT85w103uXsP-dk9q1bJMXEfsmv28vTf3wAAAP__7NsP4w==

query T
EXPLAIN (DISTSQL) SELECT sum(a+b), count(a+b), max(a+b) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF2L4jAUhu_3V4RzpUykJq2O0ytl1gXBj1mr7MAiEs3BldXGTVKYRfzvS-syozKmxY8b8TS-vg_PKdmC-bOCENqvL91Wp09KXzvRKPreLZOo3W0_j4hJ1iVBHsisTMlcJbF9n9bi7f938m046BEprAAKsZLYF2s0EP4EBhQ4UPCBQgAUajChsNFqjsYonf5kmwU68g3CKoVlvEls-nhCYa40QrgFu7QrhBBGYrbCIQqJ2qsCBYlWLFdZTVrdTD-mm9_4Fyg8q1Wyjk1IBCUzoBBtRDpVPEZELAkjyv5CDRSGGEvUIWmyhyaHyY6CSuwHg7FigRCyHS3O2VosNC6EVdqrHWNG416pycop32DcH02Hgx9RKR17rdfs4Fw_P9v_UZvESkvUKI86Jzs3IaueQ4zGvWmnPyo1-Tuhf57QPyJkxTfJLtukxyoev8Euc0gPTNXvskte3BS_0BSveP4NTOWQHph6vIspv7gp_0JTfsULbmAqh_TAVOMupoLipoILTQUVr3YDUzmkB6ae7n6TftI_RLNRscGTG_Xzf66mNy3KBe6vZaMSPccXreZZzX4cZLnsgURj96dsP3Ti_VEKeBhmzjA_CrPTMHc351T7znTgDgfXcNec4bq7uX5N86Mz3HA3N65pfnLvqprzmrhfstPuye7LvwAAAP__JdYqyA==

query T
EXPLAIN (DISTSQL) SELECT sum((a-1)*1000) + sum((b-1)*100) + sum((c::INT-1)*10) + sum(d-1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVGL2kAQx9_7KZZ5Ss4NySbxzstTxLMQUO-qFgpFypodrFSzdpNAi_jdS5KiiZyJNFh8kd0Z__nPzG9g9xD_3IAHwy9vo34wIdpLMJvPPo10MhuOhoM50bQ43WoaJwZhOnkgzLIsnXRIHl2WovoxGnpeMJn3TrljShSxj9PXMRE84UAhkgInfIsxeF-BAQUbKDhAwQUKXVhQ2CkZYhxLlf1lnwsC8Qs8i8I62qVJFl5QCKVC8PaQrJMNggdzvtzgFLlAZVpAQWDC15vcJrP2s59vux_4GygM5CbdRrFHOCVLSkJKBFCY7XgWM0xGeCQIIzL5jgooTDESqDyi-cxgXtGt_pBN5u-FEs23q6lSximOlfwx7bt5_GU4CMb9ESwOFGSanNqME75C8NiBXj-K_mqlcMUTqcxudRKzz2PNZ3rWbHayjyfneHL1i0XYF4s4eaeRVAIViorx4lBfJrP-pc4TGd_taL7T0XzW8W39cgdOpQN2_UaxNhtlMsO0732nGoZRgvV4u52yrydityJiG6Zz70QahlEi8nQ7Is71RJxWRBzDdO-dSMMwSkR6tyPiXk_EbUXENczuvRNpGEaJyPP_eQnfKWKK8U5GMZ69iO9_2cpeShQrLJ7VWKYqxDclw9ymuL7mujwgME6KLCsuQVSksgLLYlYrtitidi62650brJ1atVsvdtvU3a0VP9Y7P7ZxfqoV9-qde22cn-tZWQ1rUr9k596Lw4c_AQAA__-6wa2h

query T
EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L2kwUxu_fTzGcqwRG4iRx182V4msh4J-tUbpQRMbMwUo1Y2cmsEX87iXxYlXWiY3YG00mPj4_fiecPehfG4ig__Y66MYj4vwfJ9Pk68AlSX_Q702JzrcOdynZrjNnWXzzdyd1KUllnhlHuOTLZDwkghsOFDIpcMS3qCH6Dgwo-EAhAAohUGjBnMJOyRS1lqr4yb4MxOIdoiaFdbbLTXE8p5BKhRDtwazNBiGCKV9ucIJcoPKaQEGg4etNWVNUd4qPxe4n_gYKPbnJt5mOCKdkSUkKFJIdLw4aHiM8E4QRaX6ggvmBgszNR602fIUQsQO9Ha27WilccSOV1zonS2ZDp8NcoDCMR07HL6-6b04nKK5649loupiMvyWOe5XEv0ryAZBnUglUKM7a5wc7K2v-DWwyGy7i0dTphNdZgzNWdvtAWe2Beqzh-TVGWgF3ounpwSP1b9fk19fkN7yghqYKuBNNzw_WFNyuKaivKWh4YQ1NFXAnmtoP1hTerimsrylseK0amirgTjS9_MM9-gnJBPVOZhov9unn_9ws9iyKFR6Xspa5SvFVybSsOd6Oy1x5IFCb41N2vImz46MC8DTMrGH_LMwuw769uaI6sKZDezi8h7tlDT_Zm5_uaX62htv25vY9zS_2WTUrXhP7S3bZPT_89ycAAP__3gslkg==

# AVG is more tricky: we do two aggregations (for the sum and for the count)
# and calculate the average at the end.
query T
EXPLAIN (DISTSQL) SELECT avg(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF2L2kAUhu_7K4ZzleBInEl03Vxl2VoI-LE1CoUiy5g5pFI3YyextIj_vSQWNso6EWJuJJn4-j4-J5wDZL-24MPo28v4KZwS63MYLaKvY5tEo_HoeUHE78SyLEE6ZG2TDol9P5wuhsWltMmX-WxCpMgFUEiVxKl4wwz878CAAgcKLlDwgEIfVhR2WsWYZUoXXzmUgVD-Ab9HYZPu9nlxvKIQK43gHyDf5FsEHxZivcU5Cona6QEFibnYbMuaojooPl53P_EvUHhW2_1bmvlEULKmJKZEAoVoJ4qzrsOISCVhROU_UAOFOaYStU8Cr2NZAesE3O4E7v-_CKsjBbXP38myXCQIPjvS2-mfkkRjInKlnf45fLScWAGzC-rZcroor69V8quV7037VGmJGuVZzepohmK9a1TRcvIaFlzcrqpiTsCvcrpnnOz2wbImg3VY1-EtjLaGv2JxcK_R8tuV8UbKeNdxW1BWw19R9nAvZe7tytxGytyu47WgrIa_omx4L2Xe7cq8Rsq8rtNvQVkNf0XZYxs794PKOWY7lWZ4sXs__uVesZNRJnha4Jna6xhftIrLmtPtrMyVBxKz_PSUnW7C9PSoAKyGmTHMz8LsMszNzTXVrjHtmcNeE-6-MTwwNw-aND8Yw0Nz87BJ86N5Vr2a18T8kl12r46f_gUAAP__r74xOA==

# VARIANCE/STDDEV have three local (sqrdiff, sum, and count) and one final stage aggregations.
# We calculate and render the variance/stddev at the end.
query T
EXPLAIN (DISTSQL) SELECT sum(a), round(stddev(b), 1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L4jwUxu_fTxHOVYVITVtnnF5V_AMFR2ds52VhkSGagyurjZukyy7id19aWUZlTKXi3khO4tPnye-EswP9Yw0hDL68jLrxmDj9OEmT11GDJIPRoJcSnW8c3qBEyTwTjjZC4E9n3qCENchwOnkmghsOFDIpcMw3qCH8CgwoeEDBBwoBUGjDjMJWyQVqLVXxl10piMUvCFsUVtk2N8X2jMJCKoRwB2Zl1gghpHy-xilygcptAQWBhq_WpU1hHRU_79vv-Bso9OQ632Q6JJySOVBItryomi4jPBOEEWm-oYLZnoLMzYenNnyJELI9vT5Xd7lUuORGKrd9Git5e3Yi1ij8X6f9eDh0Iq-siv1y1Zu8jdNyfSmKdzHKR4I8k0qgQnFiP9vbw7LWpbTDeNwdvSdpvz_434k8Gvk0CoqDKWYCVUgi9vcdRB5lYRjG47Rz-Q7-yR3Y9W1m9drssqbr1Wh0RbIjdg_3brR3PSSvJiSv6fo1IFUkO4L0eG9I_vWQ_JqQ_KYb1IBUkewIUufekILrIQU1IQVNt10DUkWyI0hP_3KufhJlinorM41n8_XzL7eKuYtiiYchrWWuFvii5KK0OZSTUlduCNTmcMoORZwdjoqAx2JmFXsnYnYu9uzOFda-VR3YxcEtudtW8YPd-eEW50eruGN37tzi_GTvVavimdgf2bn3bP_fnwAAAP__obooWA==

query T
EXPLAIN (DISTSQL) SELECT sum(a), round(variance(b), 1) FROM data
----
distribution: full
vectorized: true
·
• render
│
└── • group (scalar)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lFGL4j4Uxd__nyLcpwqRmrY6Tp4qjkLBqTPV-bOwyBDNxZXVxk3aZRfxuy-tLKMyplJxXyQ38fSc_G64OzA_1sBh8OVl1Iti4jxFk-nkddQgk8Fo0J8Sk28c0aBEqzyVzk-hVyJdoDNvUMIaZJiMn4kUmQAKqZIYiw0a4F-BAQUPKPhAIQAKbZhR2Gq1QGOULv6yKwWR_AW8RWGVbvOs2J5RWCiNwHeQrbI1AoepmK8xQSFRuy2gIDETq3VpU1iHxc_79jv-Bgp9tc43qeFEUDIHCpOtKKqmy4hIJWFEZd9Qw2xPQeXZh6fJxBKBsz29PldvudS4FJnSbvs01uTt2QlZo_B_TZ6i4dAJvbIq9stVf_wWT8v1pSjexSgfCfJUaYka5Yn9bG8Py1qX0g6juDd6_7-XRL24P3BCj4Y-DYPiKMFUouYkZH_fQuhRxjmP4mn38i38k1uw6xvN6jXaZU3Xq9HqimRH9Dr3brV3PSSvJiSv6fo1IFUkO4L0cG9I_vWQ_JqQ_KYb1IBUkewIUvfekILrIQU1IQVNt10DUkWyI0iP_3KyfhIlQbNVqcGzCfv5l1vF5EW5xMOYNirXC3zRalHaHMpxqSs3JJrscMoORZQejoqAx2JmFXsnYnYu9uzOFda-VR3YxcEtudtWccfu3LnF-cEq7tqdu7c4P9p71ap4JvZHdu492__3JwAA__9CrCmW

query T
EXPLAIN (DISTSQL) SELECT stddev(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF-L4jwUxu_fTxHOVcVITVtnnF518A8UHJ2xnZeFRYbYHFxZp3GTuOwifveldWBUxlQovZE09fH5-Tshe9C_NhDC6Nvz5DGeEmcYJ2nyMmmRZDQZDVKijRD423EcTtpk2SJtkoVhPE37xVK0yHg-eyKCGw4Ucilwyt9RQ_gdGFDwgIIPFAKg0IMFha2SGWotVfGVfRmIxR8IuxTW-XZniu0FhUwqhHAPZm02CCGkfLnBOXKByu0CBYGGrzdlTVEdFR9v25_4FygM5Gb3nuuQcEqWlGSUCKCQbHmx13EZ4bkgjEjzAxVQmGMuUIUkCtqOE7F25LXakf_xF2FxoCB35pNMG75CCNmB3k7_uFopXHEjlds7h09e5sN4PHYi1ioYX58-VoPZ6zQt19cAvKsAn727XCqBCsVZ6eJgR2QXgsfx9HHylqTD4eh_J2I08mjkXwfzz8DY7XNldebqso7rNTDZCv4TbXfNTNa7XaBXS6DXcf0GBFbwnwi8b0agf7tAv5ZAv-MGDQis4D8R2G9GYHC7wKCWwKDj9hoQWMF_IvCh-cv5C4A56q3MNV5c0l__cre4vFGs8HjTa7lTGT4rmZU1x8dZmSs3BGpzfMuOD3F-fFUAnoaZNeydhdll2LM3V1T71nRgDwd1uHvW8J29-a5O87013Lc39-s0P9hn1a04JvZDdtm9OPz3LwAA__9q1z72

query T
EXPLAIN (DISTSQL) SELECT variance(a+b+c::INT+d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lGFr4jAYx9_fpwjPq4qRmrY611cVp1BwdavuODhkxObBk3ONl8bjDvG7j9bBVGZaKH0jaerf_8_fE3KA7M8WfBj_eJoOw4hYD-F8MX-etsh8PB2PFuQvVxueJmhZFidtsmqRNkl8P4wWg3wpWmQSzx6J4JoDhVQKjPgbZuD_BAYUHKDgAgUPKPRgSWGnZIJZJlX-lUMRCMU_8LsUNulur_PtJYVEKgT_AHqjtwg-LPhqizFygcruAgWBmm-2RU1eHeQfr7vf-B8ojOR2_5ZmPuGUrChJKBFAYb7j-V7HZoSngjAi9S9UQCHGVKDySeC1LStg7cBptQP34y_C8khB7vUnWab5GsFnR1qdfrheK1xzLZXdu4SfP8cP4WRiBayVM748fqxGs5doUaxvATg3AT5796lUAhWKi9Ll0YzIrgRPwmg4ff0-jMNhNBpbAaOBQwP3Npp7gcaqT5bVmazNOrbTwGxL-M_E9ZuZrVNdoFNLoNOx3QYElvCfCbxrRqBbXaBbS6Dbsb0GBJbwnwkcNCPQqy7QqyXQ69i9BgSW8J8JvG_-ev4CIMZsJ9MMr67pr3-5m1_fKNZ4uuszuVcJPimZFDWnx1mRKzYEZvr0lp0ewvT0Kgc8DzNj2LkIs-uwY24uqXaNac8c9upw94zhvrm5X6f5zhgemJsHdZrvzbPqlhwT8yG77l4ev70HAAD__4erQDQ=

# Regression aggregate functions have two local, and one final stage aggregations.
# Calculation and rendering are happening at the end.
query T
EXPLAIN (DISTSQL) SELECT covar_pop(a, c), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(a, c), regr_intercept(a, c), regr_r2(a, c), regr_slope(a, c), regr_count(a, c), covar_samp(a, c), corr(a, c), sqrdiff(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVV9vok4Uff99CnKfMBmD_LF_eJJYNCQW7ED7a7MxZBamrFnL0AEbm8bvvgG6VVwKBl98IXPPzOGcOfcm8wHp6wp0MB_nM8OyBfHGcj33btYTXHNmjj0hYG-E-wlLRIKEoIcETiPup5vNQf1erd-rNXmLNodA9cQyzigPaJJVUK5Uf7tiCa0gAVvHX5TSa0pekh3C-d91-srD5fOzSHrCBDu3QkgyAghiFlKbvNAU9B8gAwIFEKiAQAMEQ1ggSDgLaJoynh_5KAhWuAF9gGAZJ-sshxcIAsYp6B-QLbMVBR088nNFMSUh5dIAEIQ0I8tVIZNLj_KPn_ym74BgzFbrlzjVhdwrIHATkld9SRZIHAqywLJflMNii4Cts51mmpGIgi5v0fG-jCjiNCIZ49KwasvDhu1anuXYPjan2HTdfGlMp9icGp4pjmQ0Unq5Xefe9nzs_O-Keene4RtrMhFHclHd336uimPF-jvjyrfGd37XMeMh5TSsmF1sm68mH0Q-sWxj5o-dBwP7c2f-6bBE88v67uNjHfhUAz7VgMbDtIZvPExrzlq2Z-KxOff-3cJKjd7MmZu7cHO6WPZh_1KucVu91djBuAJ8tUlFIw2Nht-3Ra20RT5-zuVucy7JfUnpMOktzvbG4eK8Jl05PlKlY6RKX1I7RNribC_Sy_OKVD0-UrVjpGpf0jpE2uJsL9Kr84pUOz5SrWOkWl8adoi0xdlepNfnFWnL24xpmrA4pQdPXf2fB_kTSMOIlu9lytY8oHPOgkKmLJ2CVwAhTbNyVy4LKy63coP7ZLmRrFTI8iFZaVZukVYb2VozWTvF97CRfNGsfHGK8mUj-apZ-eoU5evmXg1axqR5yA61F9v__gQAAP__Qgnbvw==


# Test various combinations of aggregation functions and verify that the
# aggregation processors are set up correctly.
query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(c), avg(d), stddev(a), stddev_samp(a), stddev_pop(a), variance(b), var_samp(b), var_pop(b), sum(a+b+c::INT+d), covar_pop(a, c), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(a, c), regr_intercept(a, c), regr_r2(a, c), regr_slope(a, c), regr_count(a, c), covar_samp(a, c), corr(a, c), sqrdiff(a)  FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVs1uqzgU3s9TWF4RxRGxIWnKyiilEVIacoHb6dUoQi74ZqJJgWtI1Krqu48M-YGIkkiRuugCdP6-c3zOZ1t-h9mfNTSg9TSfmvYMKHe253s_ph3gWVNr7INs86KwDgJsu1SeO6jQw50eST2PIr4tQkoxyNhLWtXTpFS3TKxYHPIizZaJMnCvyKh9fkVhoAueO6ALQsOwZ_5IirJamOxjGQJyGYIvRZC9vp7ob3X9ra6z7fL11FCPWMU5FyFP85pVkHradZLymiVMNvEBUq61nMbeIsRezv6IaPX7t8I64N51HkDEcgYRjJOIz9gLz6DxD8QQQQIR1CCCOkRwABcIpiIJeZYlQoa8FwA7eoVGH8FVnG5yaV4gGCaCQ-Md5qt8zaEBffa85i5nERdqHyIY8Zyt1kUZWZrKX5D-x98gguNkvXmJMwMwBJ4RCBGIIIJeyqStp2LA4ghgkOT_cgERdHkccWEAqncVheIuJZ0u1XbEIUAxApQgQDUEqA4XHwgmm_y40ixnSw4N_IEu78ZcLgVfsjwR6qDejPfzQaGkI9crJU1KY-fnzN_JhVU_SIOKv5C9H-6dfX-_y7HzkJrnmAdLyXfNmWf7tjMLXGviWp4nRXMyca2J6VsKJagsWCQLXOdvT-l8Ogby6RiO3W_iRERc8KjW-uKjfVC43zApfOhlP7PAbp3VIWIotXt7Zk4Dz7-7sx4VeoMoRnR06gjmzrzB-Wi6tjkbWwq9RXJGWs1Vgiqecrn9Y9DYOYRhfDRLDgLv6anR-qvJ-qvJaj5OmlKYj5OmaHvmW-7YmvsNPpc0FZ06c2tvP8wUk9P2PPPhpL-x47p1y2FjVkZ8OJPF4VPLs4cAHah0iAC92X0jBOjt7sN9-ZPxWJ5WLCFYYvBA_iQMSwyWICwRRCJIUUEiiESQz0-4Vtva-PL7Cl9zX6m4p5IvuLHO9FM5iMPvfGORy2klV9FKeqr2BbSe6adC6813plW7nFbtKlq1nqp_Aa1n-qnQOvrOtOqX06pfRaveUwdfQOuZfiq03n5nWs-8nl2epUmc8ZPnY3PmvnxW8mjJyzdolmxEyOciCYsypeoUuMIQ8SwvvbhU7Lh0yQVWwbgVTGpgfAom7ZXPlNZa0Xo7WL9m3YNW8LC98vCayjet4FF75dE1lW_bueqf2Sbtm-y09uLjr_8DAAD__04d4bI=


query T
EXPLAIN (DISTSQL) SELECT sum(a), min(b), max(c), count(d), avg(a+b+c::INT+d), stddev(a+b), variance(c::INT+d), covar_pop(b, d), regr_sxx(a, c), regr_sxy(a, c), regr_syy(a, c), regr_avgx(a, c), regr_avgy(b, c), regr_intercept(a, b), regr_r2(b, c), regr_slope(a, c), sqrdiff(a), regr_count(a, b), covar_samp(b, c), corr(a, c) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8uO4jgU3c9XWF4ZYQTOA6isHFEpFIkKdJJmqjVCyCRuBg0kaScgSq3695ETXmGogMSCWdQG7HPPffkeW8pvmP5aQgNab6OBaTsAPdue730b1IBnDayeD9L1CrEaBqtFhGbyn21RUMMgiNdRhsIaBmwzRwgxUAezGqiDwDBsx-_KpbSmWRjyzc6MwYaJBYsCjna0HSuIN0xMkzhBM5wDgs_FNN1uEcMgOO7fy_v38p5t5ttz4F1GPACLKOMi4EkmabM9KpQSKV3GCd_HSX-JcPHzZ34GubVofOde1J2yVbKPEMRCFL7gxR2-gpBlDGIYxSF32Iqn0PgLEoihAjFUIYYaxFCHEwwTEQc8TWMhKb9zBzvcQqOF4SJK1pmEJxgGseDQ-A2zRbbk0IA-my25y1nIRbMFMQx5xhbLPI1MTeXPNPmHv0MMe_FyvYpSA8jqMQgwCCGGXsIk1mgSwKIQEBBnf3MBMXR5FHJhAKrVEaKkTpVanaq78WKQI1ha96DEMMhBVRrg5APDeJ0dq08zNufQIB_49g7N-VzwOcti0dTLDXrfXxHVahDDV9tBVM9X5huibbnqDb87_tQd_ukhuc3J5GDYrb1v7rP98oKocuAoJxylxFEPHPWEk69913Q827eHztS1-q7leXJp9vuu1Td9C1Ed085NRA0X5d8S8TaihoujOfShnVSv1T6dkvLplI7DWUexCLngYWkyk4_qOZLWhUGSwyCVwyD3Jz61d7Xuzl8v4fkxvNiOOZh6_vOzNUa0g2kX06ejYWy6tun0LERJC1NCMCXK0dobjk13OhqOECXqEZbnOfXe3hAl2n_QH5fQH5dQc9y_FMIc9yVbP4Ntx7fcnjWSEm2f2VzlgoM3GI6scvzDqEkHU9lr97xXz3wdlWP1hq67j3K4-qX7jAHVm7SNAe1gQOV1f5JXviV_JJFIJpFUIrlElz-STiSfdHcxiPRSWp_qTi3pjtz-_pF73r8maTSVB72AV3o8uTntrxfwYS-gcrsSlbuUqDSa6oOUeKXHEyV2vpT4MCWqtytRvUuJaqOpPUiJV3o8UWL3S4kPU6J2uxK1u5SoNZr6g5R4pccTJT59KfF_8X1yYUouT5M4SvnZd8rlyC35_cLDOS8-dtJ4LQI-EnGQpym2w9wvB0KeZoWVFBs7KkyywFNnUumslJzJubNSnflKarXSW6t21u6pW690bldnbt-TuVPp3K3O3L0n81P1rFpXZFItsvPck48__g0AAP___M2gmQ==


# Verify that local and final aggregation is correctly shared and de-duplicated.
query T
EXPLAIN (DISTSQL) SELECT sum(a), stddev(a), avg(a) FILTER (WHERE a > 5), count(b), avg(b), variance(b) FILTER (WHERE b < 8), sum(b) FILTER (WHERE b < 8), stddev(b) FILTER (WHERE b > 2) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzslk1v6jgUhvfzK6yzCpJR4jjhIysjCJpIFNpA25FmEDLEYtCFhJuP6l5V_Pcrk5YkFEJEF2zYtPj4vOf1OXks-R2in2uwwP7ncdBxhkjpOePJ-GlQQ2N7YHcnKEo2Cq9hFMWeJ972P_nbUuE11HcGE9tFyuvftmsjjv5LNI0KZNYwWgSJHyvzj1z5_42HK-4vhDI_Fs5T4QK1pEuyuZSRnuNckkB6DfXd0QPyeMwBgx94Ysg3IgLrXyCAQQcMFDAYgMGEKYZtGCxEFAWhTHnfCxzvF1gahpW_TWIZnmJYBKEA6x3iVbwWYMGEz9fCFdwToaoBBk_EfLXe20hrJv_Mtj_Eb8DQDdbJxo8sxDGaA4bxlstVXSWI-x4iKIj_FyFgcIXvidBCjKTdmJZlOcNJCyOmp0NoHUeEnkWIjMJ0hyFI4uzoUcyXAiyyw9Xb6yyXoVjyOAhVs9jd-PlBYUZNtvHk9px-_2PVHT0PJ587ac7nN2Ikv_81OnNHr2PlIDRz5cyCkZmJ9Sy7EDvoipknKtATFejJCvTsTPWzM81GmfhB6IlQeIU5TnflUyfaibETOY2-M-wMZuNJr2e_KEzHjGBGc1NPf82cbHyfq8Yhq1mIt7KyLx3X6Qy7tsLamBENM0IOIqJ9tSfSn2JG9r4Zv5JEjBhVmYERMzFiDZU1MWKS07ZkVTs7VFoYKql-D8l191AldVW_3U280GCOicb9Jla8iXp1aPQrodHrKr0dNBcazEHTvENTERpaHRp6JTS0rhq3g-ZCgzloWndoKkJjVIfGuBIao66at4PmQoM5aNp3aK54KJ6YqSuibeBH4ujBeLqyJh-SwluK9NUZBUm4EI9hsNjbpMvRXrcPeCKK012SLhw_3ZIHzItJqVgviMmxWC93vmBNS9VGudj4zrnNUnGj3LnxHedmqbhV7tz6jnO7_FtpFzAph-zYe7r7608AAAD__81Buig=

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(DISTINCT a), variance(a) FILTER (WHERE a > 0) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k1GL004QwN__n2KZpxa2JJukf2SfGmpOA73cmcRT0CBrdojFNBt3N4dS-t0lCVJ71KO29aV0Z_aX-c0sswXzrQYO0fv7VRgnZPIyzvLszWpKsmgVLXNius1ETCkRj9WQi5NlTvrAo9Br0ZQ4EVNyE6_yKCWTd6-jNCKCfOxc10fiTslNendLpLACKDRKYiI2aIB_AAYUPKDgA4UAKMyhoNBqVaIxSvdXtgMQy-_AXQrrpu1sHy4olEoj8C3Yta0ROOTic40pConacYGCRCvW9VCmL73ofz61X_EHUFiquts0hpPeKGtF_3fmMCIaSRhR9gtqoJBiI1FzsmBjKy7nPE7yF5QsGBQ7Cqqzex9jRYXA2Y7-wXmv2jVKS9QoDzSL3ZGuwqrSWAmrtDM_bCp7eztZeFOgED682r_KGHoI0zhMllF_49fDPCPtHUiz0wfNzhi0w2aOd_1Re6dbe-dYezPHv761f7q1f461P3OC61sHp1sH51gHM2f-b5fxiHWKplWNwSdLefzLbr-sKCscN9uoTpd4r1U5lBmPdwM3BCQaO2bZeIibITUI_g6zZ-H_D2D3KexdUtm_BA4uged_BRe7_34GAAD__xpgHFI=

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(a), count(a), stddev(a), variance(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF9r4kwUxu_fTzGcK4WROEnsn1xFqkLAapvYvguLyKxzyMrajDszKbsUv_syyUWTUhNJwRudk5PH5zePh_MG-vceAph-e5iPowXpTaJklTzO-ySZzqd3K6Lzlx7vU8Jf0-J7K_PMFCdthMDX4vjK1Y5nW-zxPpnFy3siuOFAIZMCF_wFNQTfgQEFFyh4QMEHCiNYUzgouUWtpbKvvBWCSPyBYEhhlx1yYx-vKWylQgjewOzMHiGAFf-xxxi5QOUMgYJAw3f7wsZah_Zjc_iFf4HCndznL5kOiCVKDtweBw4jPBOEEWl-ooL1kYLMzbuhNjxFCNiRng81TlOFKTdSOaM6U_J03wtZ38Isnxar6nkTL_9PerZMHuNJNJsVzVM87kmed4w8k0qgQlFjWB-bidnwFHLydL-JLLRbqzxbzaLFeL5JVpPJ9LkX-jRktHytbDyP42i8uJvWWjFmAlVAQkZJyJzQpST0KAl9SsLRyZt7tZuz88eDdRgPhw0ct8OAtGBV4r66yIC458fkdonJHTheh5hasCoxXV8kJu_8mLwuMXkDx-8QUwtWJaabi8Tknx-T3yUmf-CMOsTUglWJ6fbiW_kTnhj1QWYaP2znz395aLc2ihTLFa9lrrb4oOS2sCnLZaErHgjUpuyysoiysmUBq2LWKHZrYvZR7DY7t1h7jWq_Wex_hXvUKL5qdr76ivN1o_im2fnmK863zf_VsGVMmofso_f6-N-_AAAA__8XykA1

query T
EXPLAIN (DISTSQL) SELECT sum(a), avg(b), sum(a), sum(a), avg(b) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF-L2kAUxd_7KYb7pDASJ4m7bp5crAXBP1ujUCiyjM4llWrGzkxKi_jdyyS0q7JOQrQvcu_Ek9_JucM9gP6xhQgGX15Gz8MJaXwcxvP486hJ4sFo0J8Tne0avEkJ_5k0Vk36rz8_J59m0zER3HCgkEqBE75DDdFXYEDBBwoBUAiBQgeWFPZKrlFrqexfDrlgKH5B1KawSfeZscdLCmupEKIDmI3ZIkQw56stzpALVF4bKAg0fLPNMRbdsz-v--_4Gyj05TbbpToinJIVUIj33HYtjxGeCsKINN9QwfJIQWbmjakNTxAidqTVfT0nicKEG6m8zrmteDFu9FjT8m3l26o_XUzmeX0N7l-FvzGzVCqBCsUZcHl022Ptcn_xYvw6tA4D280wFagi0mOU9HyvF9Ci_Nte_Yjg7CNY9cmyepP1WMvza8y2xNlJeA_3n61fPRa_Zix-ywtqxFLi7CSWx_vHElSPJagZS9DywhqxlDg7iaV7_1jC6rGENWMJW16nRiwlzk5iefq_C_Id-Az1XqYaLxbl-29u2wWKIsFi22qZqTW-KLnOMUU7zXX5gUBtiqesaIZp8cgaPBUzp9g_E7NLse8ml6ADpzp0i8NbfHec4gc3-eEW8qNT3HWTu7eQn9yzapdcE_clu2Qvjx_-BAAA__8PERka

query T
EXPLAIN (DISTSQL) SELECT avg(c), sum(c), avg(d), sum(d) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF-L2kAUxd_7KYb7tIGROEncdfMUsS4I_tkahUKRZZq5pFLN2JmktIjfvUwUNso6kYh9Md6bnJxfzh3uDvSvNYQw-Po66g0n5OHzMJ7HX0YOiQejQX9O-O_0IXEo0cWmvJpaHGvhkJfZdEwEzzlQyKTACd-ghvAbMKDgAQUfKARAoQNLClslE9RaKvPIrhQMxR8I2xRW2bbITXtJIZEKIdxBvsrXCCHM-fc1zpALVG4bKAjM-Wpd2hjryPy8bX_iX6DQl-tik-mQJJQIoBBvualaLiM8E4QRmf9ABcs9BVnk75465ylCyPb0eq5emipMeS6V2znFihfjh4g5hme6mMyP_8uuV-l6zkUQ7yLIu3-RSSVQoTgxX-7tqKx9iTVejN-GR64jrX_SD0w1w0ygCknE3H4vNk_34pfRtDfvOpREjJLId6PAXC5-nH_ycez66bNm03dZy_UazL-GrBLq433n710fkdcwIq_l-g0iqiGrRPR034j86yPyG0bkt9ygQUQ1ZJWIuveNKLg-oqBhREHL7TSIqIasEtHz_1u0H4DMUG9lpvFs4X785rZZxChSPGxtLQuV4KuSSWlzKKelrmwI1PnhLjsUw-xwywBWxcwq9k7E7Fzs2Z1rrH2rOrCLg1u4O1bxo9358RbnJ6u4a3fu3uL8bJ9Vu-aY2A_Zufdy_-lfAAAA__8mTisB

query T
EXPLAIN (DISTSQL) SELECT max(a), min(b) FROM data HAVING min(b) > 2
----
distribution: local
vectorized: true
·
• root
│
├── • filter
│   │ filter: min > 2
│   │
│   └── • values
│         size: 2 columns, 1 row
│
├── • subquery
│   │ id: @S1
│   │ original sql: <unknown>
│   │ exec mode: one row
│   │
│   └── • group (scalar)
│       │
│       └── • revscan
│             missing stats
│             table: data@data_pkey
│             spans: LIMITED SCAN
│             limit: 1
│
└── • subquery
    │ id: @S2
    │ original sql: <unknown>
    │ exec mode: one row
    │
    └── • group (scalar)
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkE1L80AQx-_PpxjmlMBCkzwX2ZNVW12oaW1LETSHNTvUYLpb9wUKpd9dksWXChU9zm_2P7-d2aN7bZHj6H42GYoSkiuxWC7uJiksRpPR5RI2cpfIlMGm0clTCuP59BaU9BJuhitRXr_zx5Bl_wkKZKiNolJuyCF_wBwrhltranLO2A7t-wdC7ZBnDBu9Db7DFcPaWEK-R9_4lpDjSraB3CBDhoq8bNp-YgEXkORQPwf94lKsDgxN8J9TnJdrQp4d2O9N46b1ZMkO8mNX5BzOi48FOeeiXJ6d9OZ_8c7JbY12dGQ9vVHFkNSa4hWdCbammTV1r4nltM_1QJHzsZvHQujY6j74NZz_GC6-havDv7cAAAD__0das9A=

query T
EXPLAIN (DISTSQL) SELECT DISTINCT (a) FROM data
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a
│ order key: a
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lV2L4jAUhu_3V4RzNcOm1PTD0V65OC4Irs6qFwuLLBkbRlmn6TYRdhD_-1ALOn5MTm2KN2LaPjlv8xxON6D-rSCC3q-nwbf-kNw99ifTyc_BPZn0Br3ulOTr_rA7JXf8nnwfj36QmGsOFBIZiyF_FQqi38CAggcUfKAQAIUQZhTSTM6FUjLLH9nsgH78H6IGhWWSrnV-eUZhLjMB0Qb0Uq8ERDDlzysxFjwWmdsACrHQfLnalclLd_KfP-lf8QYUunK1fk1URPJEk5Tnfx2XEZ7EhBGpFyKD2ZaCXOtDQaX5i4CIbWn5UI9LpZfJXLvhcaJO_uajLBaZiCPSYSfVDhs8v5EFV4szerY9JPI-TXTYRxa1Tvf5Wmz0aWzWuCr3IZNfItM6uZTqYqChdGTqsvDkycu1g6ParHzbsApt4zLH9So0DhJrb6B5s8ZhtTYOq6VxvPLyvCryPMf1K8hDYu1P4eFm8rxa5Xm1yPPLy_OryPMdN6ggD4m1P4XWzeT5tcrza5EXlJcXVJEXOG5YQR4Sa38K7ZvJC2qVF9T-vb1QbixUKhMlSn1NG3lgEb-I4gWVXGdz8ZTJ-a5MsRztuN2FWChd3GXFop8Ut_KAH2F2CrOPsHcEs-vgpg3ctoGZVW4WmmnPeN6-GfbNsppmW4GRDs1waKPaDCOqzTCi2gxjqhEaUd20Uf1ghFtmWS0bWWYYkWWGEVlmGJOF0Iisto0shkxRbIzazVG7QWo3SS1Hqd0sZVbDlCHTNECknY3Tq6SZaUyamcakmWlUGoJj0s6GqlHabPvlPQAA__832xx-

query T
EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • distinct
    │ distinct on: a
    │ order key: a
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lltr20AQhd_7K8Q8JVRGnpV805NDkoIht8YuFIopG2txTB2tq11DQ_B_L7LAli-ZsS74JcSyz87sOR8HfYD5O4cQbn8-3V0NHpyLm8FwNPx-d-kMb-9ur0eOWb6tnw0erkeOvHS-PT_eO5G0ElyIdaQe5JsyEP4CBBcEuOCDCwG40IKxC4tET5QxOkl_8rEWDKJ_EDZdmMWLpU0fj12Y6ERB-AF2ZucKQhjJl7l6VjJSidcEFyJl5Wy-HpOO7qd_fi_-qHdw4VrPl2-xCZ10o-FCpv82PHRkHDnoaPuqEhivXNBLux1orJwqCHHlnr7UzczYWTyxXmt3o35688ckUomKQqePe9O2B7y8O6_SvB6ox6vtRuLTjbbn6GzW_jlfs4M-XRubhfbe7uQXcelqOk3UVFqdeLhn1PDH_UUfLz-dE5xw92V87PZHL57bRDSLbdLa2QRPhxVLwOphwxMlcGXW2uTePhuuWCuuWAuujEt5XNtVcBWnQyLKQCIanl8CEmatjduds0EiaoVE1AIJ41Iekk4VSPzTIfHLQOI3vKAEJMxaG7e7Z4PErxUSvxZIGJfykHSrQBKcDklQBpKg4bVKQMKstXG7dzZIglohCWqBhHEpD0mvrrejI3OelVno2Ki9t6TjJzdTY1Q0VZmRRi-TiXpK9GQ9Jvv4uNatH0TK2OxbzD4M4uyrdMG8GPfFmBeLHTEWE3eqiBErqVuV1D1aLUjDfdpwnxQH9OSAFAsm6xapbtPidhVQaDEDCi3mQGHUDCiMmgGlQxrepQ3vVgGlR3dCkymFg0op1Aq0mqsFWs32AiPnioGRM4HjQbHs-i4Y3-lmYTJHulowYIYflEuh0Gk1FzqtZkNn5FzojJwLne5VZIoVDzqmUOh0xyBTMnjQMoVCp9Vc6LSaDZ2Rc6Ezci50umEF07CCfmnbD328-vI_AAD__2dbMtk=

query T
EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A), SUM (DISTINCT B) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslNGr2jAUxt_3V4TzNCFSk9Z7vX3y4nUgeL136mAwZERzcLLadEkKG-L_PtqCrqJpiXsp5KRfvu-XE84BzK8EYhh_fZ8-T2bk48tksVx8nnbIYjwdj5bE5PuyNpmNlkR0aL2w7pBP87dXIoUVQCFVEmdijwbib8CAAgcKIVCIgEIfVhQyrTZojNLFL4dSMJG_Ie5R2KVZbovyisJGaYT4AHZnE4QYlmKd4ByFRB30gIJEK3ZJaVNYD4vP9-wn_gEKI5Xk-9TERFCyBgqLTBSrbsCISCVhRNkfqGF1pKBye_Y0VmwRYnak7XO97IzdpRsb9OuhhowO-U0LftPifHKeKi1Ro6wdvDpeCfG83WrcCqt0wC4uZ_Hl9dysIesU11Er8c7NlGEtJWvfIObXoIB1A-7RooZkpxY9-LeIt4fnnvC8G4Qe8A3JTvCP_vBhe_jQEz7sBpEHfEOyE_zAHz5qDx95wkfdoO8B35DsBP_0fybTFYs5mkylBi8m1PWTe8XkQrnFaswZlesNvmu1KW2q5VupKwsSja12WbWYpNVWEfBfMXOKeU3MLsXc7dxgHTrVkVsc3ZO77xQ_uJ0f7nF-dIoHbufBPc5P7l71Gp6J-5Fdeq-OH_4GAAD__2su8X4=

query T
EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY a,b
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a, b
│ order key: a, b
│
└── • filter
    │ filter: ((a + b) + c::INT8) = 27
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lu9r2kAYx9_vr3h4Xlk8iXeJvwKDbK1lQqedCtsYMmJytDKbuOSEleL_PpKAqVrv0ZjmTSFnP3ff3PfDQ14w_rtEG_s_7u8-DYZQuxlMppNvd1cw6d_1r6eQPA-G11NwGczhdjz6Cr6rXPj-pT_uQ63mQh3mV1AHz7YHw2n3Cj6C6MBofNMfw-efKYYMg9CXQ_dJxmj_Qo4MBTI0kaGFDFs4Y7iKQk_GcRgl__KSAgP_H9pNhotgtVbJ8oyhF0YS7RdUC7WUaOPUnS_lWLq-jIwmMvSlchfL9Jgkp5P8-b36I5-R4XW4XD8FsZ2GYuAhw8nKTRYaBgc38IFDqB5lhLMNw3Ct8mNj5T5ItPmGnR7tdrFUMpKR0drNla3bUKs5HOrgiOT6HPP1_dnZAzIcrZUNDmeOOBpKnBPqZhGrReApg-_dVnYGw1Hky0j6bx-a7zN_hkc3fnxrj9kmz2YezZZvFWYn7m9VZ46oZ5sdf4lWgZfI01nvkm4YNsKVIXbv91iE1k4EfrrsvLDsBm8YooDuRLit7u0qdSdC5abw6nXnpeveLlF3cbprorhromGYBVwjwm1d61TpGhEqr0lU75oo3bVOia6Zp7tmFnfNbBhWAdeIcFvXulW6RoTKazKrd80s3bVuia5Zp7tmFXfNahitAq4R4bau9ap0jQiV12RV75pVumu9d_pkfOPQsYxXYRDLk74Em0ls6T_I7FXjcB158j4KvfSY7HGUcumCL2OV_cqzh0GQ_ZQEfA1zLSz0sNiH-WvY3IH5eXD3EpiLi-j2JbRo6mlTe-GWHrb0bRFdt7R0Ww-3tXBHD3cuEUUPE6LoYUoUgiZE0dOUKN1LROnpZ0KTGArESKFmysFQOadugib6JmiqcAonGidwqnJ-MFrO6ZzrRwu3iNb0w4W3CPxgupxVup6mStfTZOkETpWux8nS9ZOVKv1gyOy21iVa008Z3iPwgzlzVul6mipdT5OlEzhVuh6nShf6Cbtf-mzz4X8AAAD__49Ihy4=

query T
EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c::INT) = 27 ORDER BY b,a
----
distribution: full
vectorized: true
·
• sort
│ order: +b,+a
│
└── • distinct
    │ distinct on: a, b
    │ order key: a, b
    │
    └── • filter
        │ filter: ((a + b) + c::INT8) = 27
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8ll9r4loUxd_vp9jsJ4tH4jlJ_BO4kHtbywgd7agwMwwyRHNoZWziJBGmFL_7EIOmpnq2-UNeColdZ6-s_PYibxj-XqOFg2-PD_8NR9C4G05n0y8PNzAdPAxuZxBfD0e3M3AYLOB-Mv4MrhM58PXTYDKARsOBJixuoAlLyxqOZr0b-BdEF8aTu8EE_v8OCwYOMvR8V46cFxmi9QM5MhTIUEeGBjI0cc5wE_hLGYZ-EP_L214wdP-g1Wa48jbbKL49Z7j0A4nWG0araC3RwpmzWMuJdFwZaG1k6MrIWa33Y2Kfdvzn5-aXfEWGt_56--KF1v5ZGCyR4XTjxDdaGgfHc4GDHz3LAOc7hv42SseGkfMk0eI7dr21-9U6koEMNPPUV3LfgkbD5tAEW8Tx2fr7_KzkAhmOt5EFNme2uGhK5DF1twqjlbeMNJ5JK5nBcBy4MpDu-aHpOYtXeHbC53NnzHepN_2it_QoP5mYParJbNFMDrv8EGaBh0jdGXmSm_pBJANNZHMTTWbz5sUZZuEEjgefMTPyW_5GE6ePf8lC58QCv36heOGF0nhLEwVWijB3XKlOnStFmEpp5PWvFK98pToVrhSR3GGlsrnlWilxPc-iOM-ipekFeCbMHXnu1skzYSpFQdTPs6ic526FPBPJHXjO5paLZ_16nvXiPOstzSjAM2HuyHOvTp4JUykKev0865Xz3KuQZyK5A8_Z3HLxbFzPs1GcZ6OlmQV4Jswdee7XyTNhKkXBqJ9no3Ke-xXyTCR34DmbW-FP-DMzJjLc-F4or_oyb8fRSPdJJnGG_jZYysfAX-7HJJfjvW5_w5VhlPzKk4uhl_wUG3wv5kqxUItFVszfi_UTMc8n7pcRc6OUutRsQczWlYEb6sANpdhUTzbVr7qjHt1RqrtqcVcp7qnFvTKUqcXEm1aLKcoIdanZFGV9dSe0iVJQVwrBGVd3CidKhX_Yr1O5Tsg_LFgeXAg18c4INQUMJS83nUKGq8uFm0Tu6nqhmFHXCyf6hasLhhMNw0tVDKGm3lq5kqHk5aaTzKh7RhA9I0r1jCC-XaiPF3XPCKJnRKmeIdTUF0i5nqHk5aZTzAh1zwiiZ0S-npnv_vkbAAD__2EMjUQ=

query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (hash)
    │ group by: c, d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl9tv4jgUxt_3r7DOEwijYDvhkqd0u90VEg1dLtJUI4QCsWg1NGaSMJqq4n8fJdBySesDSpDgpTKGX47P-T5_at4g-jkHG-6-PXRu2i4p_dPuD_r_d8qkf9e5ux2QKSU-JdHypeSRCpnadtsdNMukQrxfs9KEVIhfJv_2uvfE92KP_NfrDh_I348pBhQC5UvXe5ER2N-BAQUOFARQMIGCBSMKi1BNZRSpMPnJWwq0_d9g1yg8B4tlnGyPKExVKMF-g_g5nkuwYeBN5rInPV-GRg0o-DL2nudpmeQgTvJnvPghX4HCrZovX4LIJh4lE_p-tP7CS_aqBiNe4BNGVPwkQ6DQk4EvQ5s4rOKIdb-UOLzimJQ4ghLHhNGKglrG2-NFsTeTYLMVPb6Fm9kslDMvVqFh7XfgCOokA7pxH8dudzB2h51OyRHlzJaZbPWH9yWHfax4srrtDt1But4_6rb65JU8edHTQWFGHQ6j1bYj_mVH20ctAxX6MpT-3sPSp2h6ZrXPah92yLJN849WxcfqfRDjdtK2Vd6TMVHvXTrDsb5UT5yinquqamGwA-WyRSsau5jFDnd9JF47-OXnta292uz428by3DaDVQ1-rvuGNLHjvfqV3DdW5H1jl33fEPU2961e3H3jx3ue5_I8rxriXJ5HmtjRv3ElnudFep5ftucR9TaebxTneXG850Uuz4uqYZ7L80gTO_o3r8TzokjPi8v2PKLexvPN4jxvHu95M5fnzaphncvzSBM7-reuxPNmkZ43L9vziHobz7fO8y7xScGejBYqiORRbwq1ZPjSn8m1UpFahlP5EKppWmb9sZty6YYvo3j9LVt_aAfrr5ID7sLsEGa7MN-D2WlwIw_MWC7aykW39DTXDlzoBy60sKmvbGphjmhtaem6Hq7nMYoeRoyihzGjIDRiFIRGjNLQDrypH3gzj1Fa-kyoIaGQiZSTUkFPY7Ggp9FcQHAsGBAcEZxlgmV_7hyZuz5ZEM2ZPlqYiRTPhMtJoutpTHQ9jYqO4JjoCI6Jrs9VhgQry2TMSaLrM4YhIcMyKXOS6HoaE11Po6IjOCY6gmOi6xOWIwnL9f-0HYo-Wv31JwAA__8DOyru

query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data GROUP BY c, d ORDER BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (streaming)
    │ group by: c, d
    │ ordered: +c,+d
    │
    └── • sort
        │ order: +c,+d
        │
        └── • render
            │
            └── • scan
                  missing stats
                  table: data@data_pkey
                  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl99r6kgUx9_3rxjOk5KROJPE2jyl27qLYGPXH7BlEYlmsGWt403i5Zbi_35JotUkOEcJAX0pyaSfOT--53vALwh_LMGGzr8vvYeuS2pP3eFo-E-vToadXudxROaU-JSEm4-aRzQyt-2uO2rXiUa8n4vajGjEr5O_Bv1n4nuRR_4e9Mcv5M_XBCP9wVNnsH8DCivpC9f7ECHY_wEDChwoGEDBBAoWTCisAzkXYSiD-F--EqDr_wK7SeF9td5E8fGEwlwGAuwviN6jpQAbRt5sKQbC80WgN4GCLyLvfZmEidNy4j_T9f_iEyg8yuXmYxXaxKNkRvepDddefNbQGfFWPmFERm8iAAoDsfJFYBOHaY6RVk-JwzXHpMQxKHFMmGwpyE10SC-MvIUAm23p-SUMZRCJQLey2TuGRh1TOxmCXxLiYbEIxMKLZKCzZj4OdWIR-oEvAuHbZH_w4L5O3f5o6o57vZpj1AtHZnw0HD_XHPb9xOOnx_7YHSXP2eQP-cw-yZsXvuUyYdThMNkeajRO1ni4SqZ556_SqMO19DJVM_JNT1I4bsbuIFs5KzaDf7fA-H7aN2jajdth1TMzFY_Sfo50xzqps1lJD1zZkGud52ahmJ2mGHIrkxk736esjE911tB5VU5Fitg5tVXGqUiI4-Fkt-pUVoFT802_dqfy8_3AS_mBN3SjKj8gRez8cFfGD0iI4xHgt-oHXoEf8k2_dj8Y5_vBKOUHo6GbVfkBKWLnh3YZPyAhjkfAuFU_GBX4Id_0a_eDeb4fzFJ-MBu6VZUfkCJ2frgv4wckxPEImLfqB7MCP-Sbfu1-QH7BDkS4lqtQZKo6dXMzbo7wFyJtaCg3wVy8BHKehElf-wmXHPgijNKvLH3prtJPcYLHMFPCXA3zPMyOYSMDs8vgdhmY8VJ0qwzNm2raUDbcVMOmWi1Ea0tJt9RwSwnfqeG7MoOihpFBUcPYoCA0MihqGhuUdplBuVfvhCayFJCVgu2UwlK5RG6ERvRGaExwDEcUR3BMclZYLZdoztSrhZmIaurlwiwEL2yXi0RX05joahoVHcEx0dU4Krp6s2KiF5ZMVrU2opp6y7B7BC_smYtEV9OY6GoaFR3BMdHVOCY6V2_YvOiT7R-_AwAA___bEFcj

# There should be no "by hash" routers if there is a single stream.
query T
EXPLAIN (DISTSQL) SELECT c, d, sum(a+c::INT) + avg(b+d) FROM data WHERE a > 9 GROUP BY c, d
----
distribution: full
vectorized: true
·
• render
│
└── • group (hash)
    │ group by: c, d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: [/10 - ]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkl-Pk1AQxd_9FJN5omE25U9N9D7duta1SZdWoOpGm-aWOyGNlItcMJqm390AMW41or6QzJk5h98wnNF-LlDg4v1mNV9G4LxcJmnyZjWBZLFa3KaQEWgC254cBS5kQiyj9NkEXFBfcucALugJvIrX96BVo-Dd60W8AAUfW88LGZ7DXbzebuDFQ5-DhKXRHKkTWxQf0EfCp7gjrGqTsbWm7uRzP7TUX1F4hMeyaptO3hFmpmYUZ2yOTcEoMDI3ppoGSKi5UceiH7sQmrb5abKNyhlFeKFHwf54cKoOBcesNNdT7yoeuzVl99hXn_gbEt6aoj2VVoAiONCPPZNKddrU926QMOZScy1A-q4Mh09IIANXzghkSCBn-Cdu_3-453lec64aU0_9a2wZkpwh4Tx62EfrdB9tVytHhpPfpFknJdt7R_p98-2dI4PJ1Q4desftjmAHV9h_uWPMtjKl5X86pHfZEbLOefhXrGnrjDe1yfrXDOW69_WCZtsM3XAoluXQ6gAfm_1RczBuDkbN3i_m3eXJ9wAAAP__csEQ0w==

query T
EXPLAIN (DISTSQL) SELECT sum(a), sum(b), sum(c) FROM data GROUP BY d HAVING sum(a+b) > 10
----
distribution: full
vectorized: true
·
• filter
│ filter: sum > 10
│
└── • group (hash)
    │ group by: d
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlttv6kYQxt_7V6zmCXQW2bO2ufjJNIeTIhFIgVSNWhQZvCKoxKa-SI0i_vfKporBpDsgg8ULvvF5Zuf77Sd_QPT3Gmzo_f446PaHrPa9P5lOfh3U2aQ36N1NWZS81dw6z47z_46LOvsxHj0wz41ddj8ePT2yn5-Zx37p_tYf3u8k7Bub19mfia4bkqEOHPzAk0P3TUZg_wEIHARwMICDCRwsmHHYhMFCRlEQpn_5yAR97x-wdQ4rf5PE6e0Zh0UQSrA_IF7Fawk2TN35Wo6l68lQSwt5MnZX66xM2qGT_rxs_pLvwOEuWCdvfmQzl7M5ZwvOPOAw2bjpvYaGzPU9hiyIX2UIHMbS92RoMwe_OYIzBznLjgZnjgmzLYcgifPOothdSrBxy0_vvrtchnLpxkGoWYfNO-l1d_j8MhxNX4ZPg0HNseppt08PNUd8nhmfZ-bnGdYLzeX15u_s1Y1eC6UQZtt8AeJ_F5C_J_GD0JOh9A7elL1FsUTUjwoX14gnrtEqrjHv3zjHgB-rdSxDGWpYmP_ugc0cK-fYtu3vvbv-Q3cAHEZJbKc8OAZX0GBedpjDoBFsNKEX_vl1beugNp6-j7DMPtKwoYkr7CSi_z3Mmre5k_CSOwmr30mEAflOalawk8TpNItSNIuGZlyBZqL_Patbt0mzuCTNonqaCQNymlsV0GycTrNRimajoZlXoJnof8_q9m3SbFySZqN6mgkDcprbFdBsnk6zWYpms6FZV6CZ6H_P6s5t0mxekmazepoJA3KaOxV_s3_RzFhGm8CP5Elf5Ho6bOkt5c6ZKEjChXwMg0VWZnc5ynTZDU9G8e4p7i76_u5R2uC-GIti3BeLAzGeJ26VESOWUlul1B21WigHbqgHbijFprqyqRQLwmtLqW6qxc0yoKjFBChqMQUKoSZAIdQEKC3lwNvqgbfLgNJRZ4JOhMJRpJyVCmo1FQtqNZkLhJwKBkJOGI5HwXI4d0HMXZ0shOeojhY0ieJH4XKW6Wo1ZbpaTZpOyCnTCTllujpXkQhWPMqYs0xXZwwSIYNHKXOW6Wo1ZbpaTZpOyCnTCTllujphBZGwQv3RVjR9tv3p3wAAAP__bKEAxw==

query T
EXPLAIN (DISTSQL) SELECT avg(a+b), c FROM data GROUP BY c, d HAVING c = d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • filter
        │ filter: c = d
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMl9tr4kAUxt_3rxjOk9KROJN4CxTidtuuYGPXy7JlERnNYGVtxk3isqX4vy-Jxet2jhqFvJRkkl_mO_N951DfIPw9BRtufzw26w2X5L40Ot3Ot2aedG6btzddIv6Mc4JckWGekhG5a7ceiCciQe7brd4j-fxERpR45Gv9e8O9JyNyTTyg4CtPuuJFhmD_BAYUOFAwgYIFFErQpzAL1EiGoQriV94SoOH9BbtIYeLP5lG83KcwUoEE-w2iSTSVYENXDKeyLYUnA6MIFDwZick02SZW5cR_BrNf8hUo3Kjp_MUPbSIoGdJEJ1DozES8VjAYEb5HGFHRswygv6Cg5tF65zASYwk2W9DD1d1NppEMZGCUtqUt123imOSaOPEZtKXvJSvsyuGUOCaN1z8SwY8RUR-PAzkWkQoMtnNETmxB3X0auK3uwO01mznHzMdn0nvIOSy-umn13O779faLPL8jb73j8JU8i_B5Zy8G_cW6BPPDEtbfmfsq8GQgva0vJV_RFVna23hXO1sVyd-vBo24THO_TCu_6Q43EGes85blqoKaGby48-b_9y5t7c0ObxyWpnEMVjD4Ca2D6Fu1TvmSrYOI2EwVy2jrsHO2TjkzrcMPjy9PFV9eMMwT4ovoW8W3csn4IiI2neUZjS8_Z3wrmYmveXh8zVTxNQuGdUJ8EX2r-FYvGV9ExKazZkbja54zvtXMxNc6PL5WqvhaBaN0QnwRfav41i4ZX0TEprNWRuNrnTO-tczEF_lF1JbhTPmhPOi_6mJctvTGcnlGoZoHI_kYqFGyzfK2lXDJgifDaPmULW8a_vJRLHATZlqY62G-C7NN2NyC2XFwNQ3MeCq6nIbmRT1tag_c0sOW3i3E65KWLuvhshau6OFKmqDoYSQoehgLCkIjQdHTWFCqaYJS08-EIjIUkJGCzZS9oXKM3QiN-I3QmOEYjjiO4JjlbG-0HOM5048WZiGu6YcLKyH43nQ5ynQ9jZmup1HTERwzXY-jpusnK2b63pDZdq2KuKafMqyG4Htz5ijT9TRmup5GTUdwzHQ9jpnO9RN21_T-4tO_AAAA___evPT2

query T
EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data GROUP BY d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlm9r4koUxt_fT3E4r5SOxJmJtg0U0ttr7wpWu9GyW3aljMlgy9qMmz-wpfjdl0S2RtudsYxS38g45pdznvM8HHzG9OcMPex8ve6dd_tQ-687HA0_9-ow7PQ6FyNI88eagCOY1EnlDJfd3qgTQO3Lp07QAQHf82aThxDpnzqDsA6XweAKIpEJ-D8Y3FzDv7cQIcFYRbIvHmWK3jekSJAhQY4EXSTYwjHBeaJCmaYqKR55LoFu9Au9JsGHeJ5nxfWYYKgSid4zZg_ZTKKHIzGZyUCKSCZOEwlGMhMPs7JM0YVffNzNf8gnJHihZvljnHogCEwIhKRsbTgXxV3DoSDiCCio7F4mSDCQcSQTD3x65DMCPl2OwXeL85nPCfgujhcEVZ6tGkwzMZXo0QXZXsT5dJrIqchU4rTWNfjFfM77t3f9weiuf9Pr1Xy3XjR9c1XzaeX0xw2fvXHHN9pcVZ48wb1I7zeKUhwvVlLYX6Ws3pPHKolkIqO1N5Vv0YilzVeFN9WuNLKXE385lbMY5JkHPiM-JxpD-G5V9FVDzR3a2njy7druWm26faKpTaId2nDY_jJtkFGxuX3omaa7zDT9qEyz7XPFrHLFGg7fX64MMiqjPj70XLFd5op9VK749rniVrniDcfdX64MMiqjPjn0XPFd5op_VK7c7XPlWuXKbTit_eXKIKMy6tNDz5W7y1y5h_Df7o0eA5nOVZzKrf65NQuVMprK5UhSlSehvE5UWJZZfh2UXHkRyTRb_kqXX7rx8qeiwSpMN2FahdkaTN8Ht23gUxuYWvVNW3qaaefN9TDXm9XWu-Vq6ZYebtlYrYcNVuthg9V62GS1gTZY3bax-lgLn-jNOrExSw8bzNLDBrP0sMksA20w69TGLGrYoqY1ardH7Rap3Sa1XKV2u5RaLVNq2KauwbRX6_Rdpulpk2l62mSanjaaZsBNpr1aqlrTxot_fgcAAP___aDoEA==

# Same query but restricted to a single range; no local aggregation stage.
query T
EXPLAIN (DISTSQL) SELECT sum(a+b), sum(a+b) FILTER (WHERE a < d), sum(a+b) FILTER (WHERE a = c) FROM data WHERE a = 1 GROUP BY d
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: d
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: [/1 - /1]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUklGLm0AQx9_7KYZ5Srg54mqehIO9Xr024JnUGNqjDWHjDhJqXOuu0BLy3YtKuaS0tn2Rmf_Mf_yN4wnt1xJDjD6u4vtFApM3i3W2fh9PYR3F0UMGtj1OFNzAfkoXMTwu4ixKYfLhXZRGoOBz63lBDnq86w7yKTymyyfQyil4kQW8TZebFbx-Bo2EldGcqCNbDD-hQEIft4R1Y3K21jSdfOqbFvobhh7hoapb18lbwtw0jOEJ3cGVjCEm5tbUMx8JNTt1KPu2M6Fp3YvJOlUwhsGZLgaL8cGZ2pecstLczLyr8ditJ7vHrv7C35HwwZTtsbIhKII9QU79nutaddpM3PZ8KVeamxCkuJE-gRTDV5XzLr6TAYGc45_Qxf-g3xdFw4VyppmJa3I5R8L75HmXLLNdsonjiZxPO9TN00SKi-jncaX_Gy1AwmXrQpA-yYBGsP0r7L-cMmVbm8ryP93SO28JWRc8_C7WtE3Oq8bk_WuGdNn7ekGzdUM1GJJFNZQ6wEuzGDX742Z_1Oz9Yt6eX_0IAAD__8yYGwM=

# Verify the XOR execution plan
query T
EXPLAIN (DISTSQL) SELECT xor_agg(to_hex(a)::bytes) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslF1v2jAUhu_3K6xzVSSj4CRQ6quyjlVIrHTARacJIQ8fpWg0zmxHYkL89ynJpgbUOhnJDSIfb543z4nOAcyvHXAYPz1OR5MHcvVpslguvk47ZDGeju-WZK_0WkTRlVXrZ9xfiQ7nH78tx4sO-TyffSFSWAEUYiXxQbygAf4dGFDwgUIAFEKg0IcVhUSrDRqjdHbLIQ9M5B54j8I2TlKbnV5R2CiNwA9gt3aHwGEpfuxwjkKi9npAQaIV212OydC32c86-Ym_gcKd2qUvseEka7RIRPa36zEiYkkYUfYZNVCYYyxRc_L3hW7ZvzeC1ZGCSu1rGWNFhMDZkdYvPIoijZGwSnv9075Ps_l6dH-fEd9F-e-iXglprLREjfLk8aujuwzr_X-b4KQNqz8pdsGkPNb1_JZnVVG5pGfQdFZ-fTv-JXb8rhe0bKeicsnOdVM7QX07wSV2gq4XtmynonLJzrCpnbC-nfASO2HX67dsp6Jyyc5Nm1vwDdQcTaJig2fb8O0n97ItiTLCYqUaleoNPmq1yTHF4SzP5SckGltcZcXBJC4uZQXLYeYM-ydhdh723eQKdOBMh-5w2KR33xkeuMmDJuRrZ3joJg-bkG_cs-pVfCbuj-ycvTp--BMAAP__N8ceZw==

# Verify the XOR execution plan
query T
EXPLAIN (DISTSQL) SELECT xor_agg(a) FROM data
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: data@data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyslF1r2zAUhu_3K8S5SkDGlu2kqa8auqwEsqZLclEYJmjRwQtzLU-SoSPkvw_bF3VCK3v2bkL88fp5eY44J9C_U4hg8fy0mi8fyejzcrvbfluNyXaxWtzvyKtUe54kIz4mXzbrr0Rww4FCJgU-8hfUEH0HBhR8oBAAhRAoTCCmkCt5QK2lKl85VYGleIXIo3DM8sKUt2MKB6kQohOYo0kRItjxHylukAtUrgcUBBp-TCtMib4rf_b5L_wDFO5lWrxkOiJlo23Oy7-OywjPBGFEmp-oID5TkIV5A2rDE4SInWn3UvMkUZhwI5U7uez0vN7s5w8Pozs2_hDlf4h6IxSZVAIViovPx2d7Geb9e5vgog3rPg3WYxouc1y_xzxaajUUTIfOw-9uwO9jwHfcoIeBlloNAzdDDQTdDQR9DASOG_Yw0FKrYWA21EDY3UDYx0DouJMeBlpqNQzc_s-t9A5qgzqXmcar7fT-l71ya6FIsF5xWhbqgE9KHipMfbmuctUNgdrUT1l9sczqR2XBZphZw_5FmF2HfTu5BR1Y06E9HA7pPbGGp3bydAj5xhqe2cmzIeRb-6y8lmNiP2TX7Pj86W8AAAD__2uU718=

query T
EXPLAIN (DISTSQL) SELECT max(t.a), min(t.b), avg(t.c)  FROM (VALUES (1, 2, 3), (4, 5, 6), (7, 8, 0)) AS t(a, b, c) WHERE b > 3
----
distribution: local
vectorized: true
·
• group (scalar)
│ estimated row count: 1
│
└── • filter
    │ estimated row count: 1
    │ filter: column2 > 3
    │
    └── • values
          size: 3 columns, 3 rows
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkV-r00wQh-_fTzHM1S4Mbf68atmrRs3RQNtzbGo9oLnYJkMMptm6u5EDpd9d0oBaocVzN_ObPPNkkiO67y0qTB8fFkm2AvE2yzf5h4WEPF2kbzaw10_CT7Qk2Ded8JOdJNA_auEnpYS79f0SxDZZfExzECFBRBBLAvE_wQuCl0P5imBGEEgJSQ4ehCbYEZQSPr1P1yns4EsfBDFDjISdqXil9-xQfcYQC8KDNSU7Z-wQHc8PZNUTqoCw6Q69H-KCsDSWUR3RN75lVLjVbc9uGiBhxV437bhxBq9BxFB-7btvTmJxIjS9_73GeV0zquBE_666a1rPlu00vJSNuYJ59OtCpVS22syuesPneJO6tlxrb-w0ujQvk0cxDyUSLrOVmEdDlWzfiXl8_eToOeo1u4PpHF9or3_MgpCrmsc_6ExvS36wpjxrxvb-zJ2Dip0fp-HYZN04Gl7wTzi8CUe34egmHP8FF6f_fgYAAP__w4r5VQ==

query T
EXPLAIN (DISTSQL) SELECT * FROM (VALUES (1, '222'), (2, '444')) t1(a,b) JOIN (VALUES (1, 100.0), (3, 32.0)) t2(a,b) ON t1.a = t2.a
----
distribution: local
vectorized: true
·
• hash join
│ estimated row count: 2
│ equality: (column1) = (column1)
│
├── • values
│     size: 2 columns, 2 rows
│
└── • values
      size: 2 columns, 2 rows
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJykkFGL00AQgN_9FcO8NJGht7sNPgQOUrVij9icl_MQJA9rMrbBmK27GxBK_rskUe5arFJ8252Zb76ZOaD73mCMq4-36XK9geD1Or_P36ch5Kt09eoensObu-wdBA_L9MMqh0ASzJRSs5AgUASzKIpmYQjLHLyEQBN8DuEmGzo9IaQQczEQC4KFmotfgPoNZBvwcq7hGryaayRsTcUb_Y0dxp9QYkG4t6Zk54wdQoexYF39wFgQ1u2-80O4ICyNZYwP6GvfMMb4oJuO3ZVAwoq9rpupYwQvIVBQ7rr2qwux6AlN5x_bOK-3jLHo6WKVPFG9-F_Vo6Frja3YcnWkKAbyXyV_mPetdrsbU7dsr9TxzA1_8UEiw2tbb3fjCwmzzseQSEoUJQtKorObyEuOdsdub1rHpxuduVFByNWWp7M409mSb60pR830zUZuDFTs_JRV02fdjqlxwKewvABWp7D6K7w4gkVf9M9-BgAA___I6BDw

statement ok
CREATE TABLE nullables (a INT, b INT, c INT, PRIMARY KEY (a))

query T
EXPLAIN (DISTSQL) SELECT array_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • filter
    │ filter: ((b = 1) AND (c = 1.0)) AND (d = 1.0)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVGL2k4Uxd__n2K4Twn_sXGSuOsOFJKucRtwdRuFdikiY2ZIpdmMnYzQRfzuJcZ1q9REzIsv4r3X4zn53SGzhvxXChSCb08DPxwioxeOJ-MvAxONg0FwP0FMKfY6Y0liMBP1o9EjMt4mZcmZZujr5yAKkGHM0UdETOQPe8iIi-8f2uau5LsSjaJeEKFPz4iZgCGTXAzZi8iBfgcCGGzA4AAGFzB0YIphqWQs8lyq4ifrrSDkv4G2MSyy5UoX7SmGWCoBdA16oVMBFCZsnopIMC6U1QYMXGi2SLc2RWSv-Jgtf4pXwHAv09VLllPEMJpjFGPEAcN4yYpeyyKIZRwRJPUPoWC6wSBX-t051ywRQMkGn5-uv0i1UEJZncNoZZ8iw_DsAhilNBxOujuGnlNCpJT2ByN_0n2D67n7QS-4Dx_9QcF2tNIUeeRkYvtk4vegUnGhBD9M6ZH_Ybr5x2P5SaJEwrRUFjmC7keR_zzzHx4Mj5gnIzkHkcj5KyZNVmyRlmVfsOSafPsl31zNku3zidqNiNoty7mAaE2-PdHbqyHqnE_UaUTUaVnuBURr8u2Jdq-GqHs-UbcRUbdldS4gWpNvT_TuaojWXEaRyJcyy8VB3lP_3C7e-4InorwncrlSsXhSMt7alOVoq9s2uMh1OSVlEWblqAj4t5hUiu0DMTkW29XONdZOpdqtFrtNcncqxTfVzjdNnG8rxd1q524T57vqXbVrjkn1ITv2nm7--xMAAP__go1aHQ==

query T
EXPLAIN (DISTSQL) SELECT json_agg(a) FROM (SELECT a FROM data WHERE b = 1 AND c = 1.0 AND d = 1.0 ORDER BY a)
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • filter
    │ filter: ((b = 1) AND (c = 1.0)) AND (d = 1.0)
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVGPmkAUhd_7Kyb3CdKxOIC77iRNoCu7pXFliyZt05jNyEyoLcvYYUzaGP97g1i3mgpGXnwx3ns9nsN3J8wKip8ZUAg-Pw79cISMQTiejD8OTTQOhsHtBH0vZP7E0tRgJrqLowdkbAesKjnTDH16H8QBMowZeouIifzRABlJ-f1N19yWfFuiKB4EMXr3BTETMOSSixF7FgXQr0AAgw0YHMDgAoYeTDEslExEUUhV_mS1EYT8F9Auhnm-WOqyPcWQSCWArkDPdSaAwoTNMhELxoWyuoCBC83m2camjOyVH0-LH-I3YLiV2fI5LyhiGM0wSjDigGG8YGWvYxHEco4IkvqbUDBdY5BL_eJcaJYKoGSNT093N8-0UEJZvf1oVZ8iw_DsEhilNBxN-luGnlNBpJTeDSN_0v8L13N3g0FwGz74w5JttNQUeeRoYvto4pegUnGhBN9P6ZHXMF3_57H8NFUiZVoqixxA_zCORk_-_b3hEfNoImcvETl9w6TNhi3SsewzdtyQb7fjq4vZsX06UbsVUbtjOWcQbci3I3p9MUSd04k6rYg6Hcs9g2hDvh3R_sUQdU8n6rYi6nas3hlEG_LtiN5cDNGGuygWxULmhdjLe-yfu-VrX_BUVNdEIZcqEY9KJhubqow2uk2Di0JXU1IVYV6NyoD_ikmt2N4Tk0OxXe_cYO3Uqt16sdsmd69WfFXvfNXG-bpW3K937rdxvqnfVbfhmNQfskPv6frVnwAAAP__PfVZcw==

# Test that orderings on GROUP BY columns are propagated through aggregations.
statement ok
CREATE TABLE sorted_data (a INT PRIMARY KEY, b INT, c FLOAT, INDEX foo(b))

# Split into ten parts.
statement ok
ALTER TABLE sorted_data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE sorted_data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE sorted_data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a
----
distribution: full
vectorized: true
·
• group (hash)
│ group by: a
│
└── • scan
      missing stats
      table: sorted_data@foo
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFrq0AQxu_vr1jmpLAhangXT_ry0iIYTdVAQpGwcacSMK7dXSEQ_N-LemhSiG2P38z8Zr799grqvQIXVrtN6AcRMf4HaZa-hCZJV-FqmRFGyZldjKNJnpJ4TZSQGvmBM83IcxJvN-TfnjCgUAuOETujAvcVbKDwF3IKjRQFKiVkX74OQwG_gGtRONVNq_tyTqEQEsG9gj7pCsGFSMxEM3eAAkfNTtUw1lEQrf6ElGYlgrvo6M1ie3pxxo4VJsg4yrl1tx5uXua9CQEUlqJqz7Vy-wyOQCFtWK9m8MiK_RsrfllKLJkWcm7fO_F67Uf7QxRnh2gbhoZnm0Bh7e8MzzEfnnfuzn8TcYKqEbXCH2VsdTkF5CWO36hEKwvcSFEMZ0YZD9xQ4Kj02F2MIqjHVm_wFrYnYWcadiZh6wucd38-AgAA___wvPC6

query T
EXPLAIN (DISTSQL) SELECT a, max(b) FROM sorted_data GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlk9v2jAYxu_7FNZ7As0oOH9omxOsZRMSTbpApVYTQoZYtBqNMztIrSq--5TkQGhXO8Vh4kaAn_3Yv0ev8gryzxp8GN7djAejALWuRpPp5Oe4jSbD8fByiihGT_S5tWij71F4jSQXGYvnMc0o-hGFtzfo2z2iKIyuhlHxETAkPGYBfWIS_F9AAIMNGBzA4AIGD2YYUsGXTEou8r-8FsAofga_i-ExSTdZ_vUMw5ILBv4rZI_ZmoEPU7pYs4jRmAmrCxhiltHHdbFNJVe_8nme_mYvgOGSrzdPifTz4ywAwySl-VPHIogmMSKIZw9MwGyLgW-yXQKZ0RUDn2xx_ZSD1UqwFc24sLz9kP38MkIRM8FiHxVPg-B-HoTTeXA7Hrf6pA0Yrgd3rb7dfhNmt_7iBT1Q-fBu6dl2F9j-MPBuHV4GebvO13IhxalIt7lj7SI7jUcOeIenFtmX8NH27t72pH4RSRNFtEjHsg-ooiZnRVrvNKpIGq4iOX4V7fpdsBvpgt2xnAO6oMlZubWz0-iC3XAX7ON3wanfBaeRLjgdyz2gC5qclVs7P40uOA13wTl-F9z6XXAb6YLbsbwDuqDJWbm1i9PogttwF9z_-7ryjzQRkylPJKv1JtLNz8PiFSvPL_lGLNmN4Mtim_IxLLjii5jJrPyVlA-jpPwpD1iFyVuYVGF7Dyafg3sm8IUJTIxyE09N28r7dtSwo5bVU9tylbSnhj0T1WpYo1oNa1SrYZ1qDa1R3TNRfaaEz9Wyzk1kqWGNLDWskaWGdbI0tEbWhYksopmiujFqNkfNBqnZJDUcpWazlBgNU6KZpq5G2rtx-ilpalonTU3rpKlprTQNrpP2bqgqpc22X_4GAAD__0g_lBA=

query T
EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlk9v2kAQxe_9FKs5gbrIrP-QxCfSNK2QiEmBSI0qhBa8IqjES-211Cjiu1e2D5g_3XFYH3zDXn47b-Y9jfwOyZ8N-HD_83F4OwhI6-tgMp38GLbJ5H54fzclS0pe11Fr0aaEk2_j0QNJZKxEOA-54uT7ePT0SL48E07JEihEMhQBfxUJ-L-AAQUbKDhAwQUKHswobGO5FEki4-wv7zkwCP-C36Wwjrapyl7PKCxlLMB_B7VWGwE-TPliI8aChyK2ukAhFIqvN3mZkp5-6fd8-1u8AYU7uUlfo8TPJC4KlZMtz150LEZ4FBJGpHoRMcx2FGSq9iISxVcCfLaj1YXerlaxWHElY8s71NnP5jGKQxGL0Cf5023wPA9G03nwNBy2-qwNFB4GQatvt08OnfaRvn3JxRt54cnLSbXZbt-D_d8e9vfIQtvxPZ-LizSNsm7NnVIYpconfYf2bZp3ct4Zp0JXaXSur7MtBbIjtxbzjv55vrZ7UJtVjy-rKb4W61j2BQFGpJZ87TU2wKzmALNGBNiuHiK7rhDZHcu5IESI1NJsrxobIrvmENmNCJFTPUROXSFyOpZ7QYgQqaXZXjc2RE7NIXIaESK3eojcukLkdizvghAhUkuzvWlsiNyaQ-Q2IkTIl_JYJFsZJaLS11Y3a1mEK1GMKJFpvBSPsVzmZYrHUc7lL0KRqOKUFQ-DqDjKBJZhdgyzMmwfwOxjcM8EvjGBmZFu5ulpWztvRw87erN6erdcLe3pYc_Eaj2MWK2HEav1MGY1QiNW90ysvtLC13qzrk3M0sOIWXoYMUsPY2YhNGLWjYlZDNmi2Bo126Nmi9RskxquUrNdyoyWKUO2qYuYdrJOP2SansZM09OYaXoaNQ3BMdNOlqrWtNnu078AAAD__yAt2po=

query T
EXPLAIN (DISTSQL) SELECT c, min(b), a FROM sorted_data GROUP BY a, c ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • scan
      missing stats
      table: sorted_data@sorted_data_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllFv2j4Uxd__n8K6T6C_UXASaJsnupZNSDTpgEqrJoRMYlE0GjPbSKsQ331K8kCA1qY4E7xhm5997j1HV1mD_L2AALo_Hvu3vRDV7nvD0fB7v46G3X73boRijF7naW1ax4iir4PoAUkuFEsmCVUUfRtET4_oyzOiGMUoGtx3B_kKMKQ8YSF9ZRKCn0AAgwsYPMDgA4YWjDEsBY-ZlFxkf1nnQC_5A0ETwzxdrlS2PcYQc8EgWIOaqwWDAEZ0umADRhMmnCZgSJii80X-TElap_R7svzF3gDDHV-sXlMZZGqnGMWAYbik2UbDIYimCSKIqxcmYLzBwFdqK0IqOmMQkA0-XujtbCbYjCounNauzk7Wj0gkTLAkQPnqNnyehNFoEj71-7UOqQOGh15Y67j1g0Ovvqdv--T0Db1Q-XLw2nizrcH9sIbtPbzQtn_P_8VFmkJJ859Wuq3Cq7yKkDf40iF7VkUrFaCOhzsuzvv4vhp_Rw05PsCkogA7pOG4J0TYILXkbPtiI0wqjjA5S4Td40PjVhUat-F4J4TGILXUy6uLDY1bcWjcs4TGOz40XlWh8RqOf0JoDFJLvby-2NB4FYfGO0to_OND41cVGr_htE4IjUFqqZc3Fxsav-LQ-Gf_wnpH4IDJJU8l29H20c3NrESWzFjREslXImaPgsf5M8Uyyrl8I2FSFaekWPTS4igTWIbJPkzKsLsDk8_BbRv4xgYmVrpJS0-72n57etjTm9XWu-Vr6ZYebtlYrYcNVuthg9V62GS1gTZY3bax-koLX-vNurYxSw8bzNLDBrP0sMksA20w68bGLGKYoqYxajdH7Qap3SS1HKV2s5RYDVNimKa-wbSDcfop0_S0yTQ9bTJNTxtNM-Am0w6Gqta08ea_vwEAAP__cHDOgw==

query T
EXPLAIN (DISTSQL) SELECT b, max(c) FROM sorted_data@foo GROUP BY b
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: b
│ ordered: +b
│
└── • index join
    │ table: sorted_data@sorted_data_pkey
    │
    └── • scan
          missing stats
          table: sorted_data@foo
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkt-L2kAQx9_7VyzfJ4U9NPH6sk-xV1ssucSqB3cUkTU7DdKYSXc3cEX830uSQvXAtL7t_PjMfgbmCPezgMLseRFP54kYfJyv1quv8VCsZvHsYS12Uhz06yAbik_L9FE4tp7M1mivo-_M4vMyfVqIDy9iB4mSDSX6QA7qGwJIvMdGorKckXNsm_SxbZqbV6ixxL6sat-kNxIZW4I6wu99QVBI-I6r0QQShrzeF23bSYJr_xdyXucEdX-SZ4OD_sFrvStoSdqQHY0vxuPNdpB44KI-lE4JLdsVV5VuojtIpLVXIgpwTSq4ReoL78s_TsF1p7P3tvpBv84Fd1JkV13CW1ymeW4p157tKLx0iRq31BqyZNrdJabJyzZJ19vkKY4HUTCExOP0eRCFw6sykwuZf5zBklzFpaP_uoPxaSNBJqfu1BzXNqOF5az9pgvTlmsThpzvqvddMC-7UiN4Dge9cNgPh73wpB-e9MLjN_Dm9O53AAAA__8rGDy4

query T
EXPLAIN (DISTSQL) SELECT * FROM (SELECT a, max(c) FROM sorted_data GROUP BY a) JOIN (SELECT b, min(c) FROM sorted_data@foo GROUP BY b) ON a = b
----
distribution: full
vectorized: true
·
• merge join
│ equality: (a) = (b)
│ left cols are key
│ right cols are key
│
├── • group (streaming)
│   │ group by: a
│   │ ordered: +a
│   │
│   └── • scan
│         missing stats
│         table: sorted_data@sorted_data_pkey
│         spans: FULL SCAN
│
└── • group (streaming)
    │ group by: b
    │ ordered: +b
    │
    └── • index join
        │ table: sorted_data@sorted_data_pkey
        │
        └── • scan
              missing stats
              table: sorted_data@foo
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMl1Fv4kYQx9_7KVbzBL1FZteGEEsnOb2mFSdiUuCkO1UIGbwBVPBS20h3ivjulXEqDIYdFjut3zD4t55Z__6Z7CtEf6_Ahsevz72Hrktqv3aHo-EfvToZPvYeP43Iz-S3Qf-J1N4uPUrW3vfarJ5-HckwFv7E92KP_D7of3kmv3wjXp187idrvTFTStbL4BzjvEh54KZ10neJRz6SKVAIpC9cby0isP8EBhQ4UDCBggUUWjCmsAnlTESRDJNbXvdA1_8OdpPCMths4-TrMYWZDAXYrxAv45UAG0bedCUGwvNFaDSBgi9ib7naPyZbWubzZPOX-AEUPsnVdh1EdrILM6Aw3HjJVcNgxAt8woiMFyKE8Y6C3MaHCqLYmwuw2Y5eX-XDfB6KuRfL0GgdF-kkm9EPfREK3yb7qwf328Ttjybul16v5rA6UHh6-FpzeP2kmMP60x9k4UWL3NLj3aFgfrHgwzoyLeR0nQ_pQoquWPP_asss1hY93LUNzt13tvMnEc7FZ7kMRGiwzvG6K_ES1xz2of4xXM4X6cdkM7ZxshHU4dQxqWNdFOvuioY0SnVlQ24Mbp7cef7ZnaNns-ujx8qInsEaBr8hfEidGU3b1QgfKzl8rBrh026rhPDdv2f4-PUB4KUEgDcM84YAIHVmVLmrRgB4yQHg1QiAdlvFA8Cb7xkA8_oAmKUEwGwY1g0BQOrMqNKpRgDMkgNgViMA2m2VEAD2ngGwrg-AVUoArIbRuiEASJ0ZVe6rEQCr5ABY1QiAhi-sdVmYFylPHJlmTqgHnS_aYelUlSTp36Lat1k8TSy-VEzrRlXZbf-tdN3CL7VdzNUS_qrx_-pQeaaQgYg2MojEVUfGZtKK8Oci3Z1IbsOZeA7lbP-Y9LK_5_Zf-CKK019ZetEN0p-SArMwO4VZFuZHMNOD74rAjBWiW4XoezXNlbRZBO4UgRnyuhC6XYTmSNumUlJLDVtKmFtqxVtKuq2G20XyoYaRfKhhLB8IjeQDoZF83BXJhxpG8qGGsXwgNJIPNY3lo1MkH_fqCdBERkBugGjNADWNDQE1jU4BBMfGAIIjnjP1GEHeOEIjpiM0pjqGI64jOCY7y80SHduZepYwZByw3DTR0l1NY7qraVR3BMd0R3BM99wg1dJdTWO6q2lUdwTHdFfjqO65caqle26wHOveQXTPTRYt3dU0pruaRnVHcEx3BMd0z01VLd3VNKa7mkZ1R3BMdzWO6c7VB1KOnEh5brYc4xzBdU5nXJPuFKJPXps23i6Ec6x1vSPaePfTPwEAAP__FdJiSQ==

# Verify that the stages preserve the ordering as expected.
query T
EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • render
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMllFv2jAUhd_3K6z7BKpRsBMozVNYSyckSrpApVUTqlxi0Wo0ZnaQWlX971OSbQRYbYrDxAsiTr6bc-85usorqJ9z8KH37XrQ7Q9R7aI_Go--Dupo1Bv0zsdILZ9qz3V0GYVXqPb7jGF07_uXg7A77qATNEXdEXouHolZyuroSxTeXKPPt4ihMLroRflfwJCImA_ZE1fgfwcCGChgcAGDBxhaMMGwkGLKlRIye-Q1B_rxM_hNDI_JYplmxxMMUyE5-K-QPqZzDj6M2f2cR5zFXDpNwBDzlD3O89dkioLs527xg78AhnMxXz4lys_bwGgKGEYLlh00HIJYEiOKRPrApQIMEU9iLn0UuCcB_dMzRgGByRsGsUxXmlTKZhx88oZ3192dzSSfsVRIp7UuO8hGE8qYSx77KL_qDm_vhuH4bngzGNQCWs-E31zVAlLfELOqf_-CHph62CidiV8Jpu8KXtURhZDNOidFIU1XpLn17nJbZKst8rctutnWSrJbueShaIiFQzZMCJdpPvv3dHhrOsjuGSV7Z9QhDYfmKSVFSisIqUF4yc72cYSUVBxScviQ0t3DQfcPB204bsXhMAgvjfH0OMJBKw4HPXw43N3D4e4fDrfheBWHwyC8NMbOcYTDrTgc7uHD4e0eDm__cHiN_AvENhAGsaXRnR1HILyKA-H93--df6iJuFqIRPE1Ie9Vbmb98HjGi_6VWMopv5Zimr-muAxzLj-IuUqLu6S46CfFrUxgGSabMCnDdA0mH4PbNvCZDUysdJOWnqbaebt62NWb1da75Wnplh5u2Vithw1W62GD1XrYZLWBNljdtrH6VAt39GZ1bMzSwwaz9LDBLD1sMstAG8w6szGLGLaoaY3a7VG7RWq3SS1Xqd0uJVbLlBi2qWcwbWudfsg0PW0yTU-bTNPTRtMMuMm0raWqNW3y9ulXAAAA__-L2qKG

query T
EXPLAIN (DISTSQL) SELECT sum(x) FROM (SELECT a, b::float + c AS x FROM data) WHERE a > x GROUP BY a ORDER BY a
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: a
│ ordered: +a
│
└── • filter
    │ filter: a > x
    │
    └── • render
        │
        └── • scan
              missing stats
              table: data@data_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlttv4jgUxt_3r7DOE6hGwU645SlsS3eRKOkGqp1qBlUpsSgaihknSFRV__dRkimXZOrDJR3xUhUnP5_P_r5zlFcIf8zAhs6X21672yelq-5gOPivVyaDTq9zOSTh8rm0KpNrz70hpV9rPiWPtn3dc9vDJrkgY9IekFX6SuBHfpn8_2_H6xCffFtWq6YgK_KP597dkr_viU9c76rjJf8ChbkMRN9_FiHYX4EBBQ4UTKBgAYUajCgslByLMJQqfuU1AbrBCuwqhel8sYzi5RGFsVQC7FeIptFMgA1D_3EmPOEHQhlVoBCIyJ_OkjKxRCf-87D4Ll6AwqWcLZ_noZ2ci5IxUBgs_HihYjDizwPCiYyehAqBgifmgVA2ccwLh79fAiUOg9EbBbmMNprCyJ8IsNkb3V_39XQWCSWUUdsVna7bxOHvl6qpyA-p2J5MlJj4kVQGy9yUE7vhqkAoEcSlgUK7f__Qd4cP_bter-TwcnxXdzclh5UzajYFHl_Ikx8-ZbaO1W8Umx8q3uwjUyHZfS7SjXTHquVqbx-L5Y7F1sfi2WNtJFuFS-7LilwYPGOCu4ySu_9IR21HB9u_LdjRbWGwisGTxmBpYxTQF4jwdV_UC-sLpOJ2gNh59AUruC_qn98XfP888uPzyCuGWXAeEeHrPDYKyyNScds4fh555AXnsfH5eTT3z6N5fB7NimEVnEdE-DqPzcLyiFTcNs48jzyaBeex-fl5tPbPo3V8Hq1K8j15agYRsesMtgrLIFJx2yzrPDJoFZzB1p_9dv2NGk-ECzkPxY6Qj3auxucRwUSk5w_lUo3FrZLjpEz60024ZCEQYZQ-ZemP7jx9FAvchpkW5nqYZ2G2DZs7MDsMbp4CM34SXT-F5lU9bWov3NLDlt4txOualq7r4boWbujhxilB0cNIUPQwFhSERoKip7GgNE8JSks_E6rIUEBGCjZTckPlELsRGvEboTHDMRxxHMExy1lutBziOdOPFmYhrumHC6sheG66HGS6nsZM19Oo6QiOma7HUdP1kxUzPTdkdl1rIq7ppwxrIXhuzhxkup7GTNfTqOkIjpmuxzHTuX7CZk0fvf31MwAA__8Susfj

# Ensure that an interesting input ordering that causes an ordered group by
# forces an ordered synchronizer. We create an index on b even though it's
# not used to help the optimizer realize that there's an ordering available
# on b for a constrained scan on the a,b primary index.

statement ok
CREATE TABLE data2 (a INT, b INT, PRIMARY KEY (a, b), INDEX(b));
ALTER TABLE data2 SPLIT AT SELECT 1,i FROM generate_series(1, 9) AS g(i);
ALTER TABLE data2 EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i);

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data2]
----
start_key  end_key  replicas  lease_holder
NULL       /1/1     {2}       2
/1/1       /1/2     {5}       5
/1/2       /1/3     {5}       5
/1/3       /1/4     {5}       5
/1/4       /1/5     {5}       5
/1/5       /1/6     {5}       5
/1/6       /1/7     {5}       5
/1/7       /1/8     {5}       5
/1/8       /1/9     {5}       5
/1/9       NULL     {5}       5


query T
EXPLAIN (opt,verbose) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b
----
group-by (streaming)
 ├── columns: b:2 count:5
 ├── grouping columns: b:2
 ├── internal-ordering: +2 opt(1)
 ├── stats: [rows=9.561792, distinct(2)=9.56179, null(2)=0, avgsize(2)=4]
 ├── cost: 25.1456179
 ├── key: (2)
 ├── fd: (2)-->(5)
 ├── distribution: test
 ├── prune: (5)
 ├── scan data2
 │    ├── columns: a:1 b:2
 │    ├── constraint: /1/2: [/1 - /1]
 │    ├── stats: [rows=10, distinct(1)=1, null(1)=0, avgsize(1)=4, distinct(2)=9.56179, null(2)=0, avgsize(2)=4]
 │    ├── cost: 24.82
 │    ├── key: (2)
 │    ├── fd: ()-->(1)
 │    ├── ordering: +2 opt(1) [actual: +2]
 │    ├── distribution: test
 │    ├── prune: (2)
 │    └── interesting orderings: (+2 opt(1))
 └── aggregations
      └── count-rows [as=count_rows:5]

query T
EXPLAIN (verbose) SELECT b, count(*), corr(a, b) FROM data2 WHERE a=1 GROUP BY b
----
distribution: full
vectorized: true
·
• group (streaming)
│ columns: (b, count, corr)
│ estimated row count: 10 (missing stats)
│ aggregate 0: count_rows()
│ aggregate 1: corr(a, b)
│ group by: b
│ ordered: +b
│
└── • scan
      columns: (a, b)
      ordering: +b
      estimated row count: 10 (missing stats)
      table: data2@data2_pkey
      spans: /1-/2

query T
EXPLAIN (DISTSQL) SELECT b, count(*) FROM data2 WHERE a=1 GROUP BY b;
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: b
│ ordered: +b
│
└── • scan
      missing stats
      table: data2@data2_pkey
      spans: [/1 - /1]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVGFr2zAQ_b5fIe5Tsqk4UpoMDANnXbYFUjuzHboyQlDiww1zLU-SYaXkvw_LhThZ6jbdGPtiOJ3e3XtPD9-D_pGBC-Ovs-lo4pPOh0kUR1-mXRKNp-OLmKwoWcsyN53XXfIxDC5JIozg5OrzOBwTQd4RRj6FwXxG3l-TFVDIZYK-uEUN7jdgQIEDhQEsKBRKrlFrqarWvb04SX6C26OwyYvS1MdmYzIEF8pcqgQVJkAhQSM2WdVfbBcU1lIhuLurvjyThTM8uEhBluZh7IKCNiJFcM-3tLGaNVYfGRyLVYYhigSV09sbD9YFz36XxXe8AwoXMitvc-0SQa0TUSGqymFnDnMqJ4LSuMTj8Bg3dgq3UZoqTIWRyuH71Dy7qzbPJbYa-ddLP4iX_nw67XisW7EN5n68DIOrqNM9YLRbsrojN0Lf_DbfPsMDa_4o692cY08JHnsDR9-zIe38JdKi-eVy4scdjx8q27Hu77Hmz88Be3kOqiTwk3PwBLeGWf3_KAf87-Zg8G9y0Gv3OkRdyFzjs_40vUoSJinWFmhZqjXOlFzbNXUZWJw9SFCbuvu2LiZ53aoINsGsFczbwfwQzJrg_h6YnQYetoP7rbR77eDzVvCgXfPgTzS3g5_QPDxJ82L76lcAAAD__3_LaAs=

statement ok
CREATE TABLE uv (u INT PRIMARY KEY, v INT);
INSERT INTO uv SELECT x, x*10 FROM generate_series(2, 8) AS g(x);

# Regression test for #37211 (incorrect ordering between aggregator stages).
query T
EXPLAIN (DISTSQL) SELECT sum(v) FROM data INNER LOOKUP JOIN uv ON (a=u) GROUP BY u ORDER BY u
----
distribution: full
vectorized: true
·
• group (streaming)
│ group by: u
│ ordered: +u
│
└── • lookup join
    │ table: uv@uv_pkey
    │ equality: (a) = (u)
    │ equality cols are key
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlltv2koUhd_PrxjtJ9AZZGZsbpaORE5CK1JiUy5SowpFDh4RGuKhvqBGEf-9st0WY8psbkG8RBjnm1kza-0l3iD4PgMTWl-6nau2RQo37f6g_7lTJP1Wp3U9IEH0UlgUyYeefUdcJ3RI27JaPdKx7U_DLrm12xaJFsS2SMEh_5GoSD727GGX_H9PImL3blq95CNQ8KQrLOdFBGB-BQYUOFDQgYIBFCowojD35VgEgfTjf3lLgLb7A8wyhak3j8L46xGFsfQFmG8QTsOZABMGzuNM9ITjCl8rAwVXhM50lmwTC27Gfx7mz-IVKFzLWfTiBSZxgEJ_7sQfSxojjucSTmT4JPwARksKMgpXOwahMxFgsiXdXdWtnHq_RFXWRUWLZrT4Lagj5XM0J9_k1CPSM0mTZVVGlCy2yuH7yLmaTHwxcULpayx3Sc3YCNt3hS9ckyRPV9b9g2UPHqxhp1No8mJ8WcO7QlMv5tSsNnh8JU9O8JRbmsFouVKsb1W8WkemQvLr_JsupDpWZWPv7LHYxrHYn2Px_LFWko2TS7ZkSc41njPBjsLk7rfpqKzpYLtPBDtgIjRW0ngyEyydiR1HApGVGYnqOUYCkZPNDruMkWAnHonq-48E3z2K_JAo8pKmHxBFRFYmirVzRBGRk_WMX0YU-YmjWHv_KOq7R1E_JIp6STMOiCIiKxPF-jmiiMjJeqZfRhT1E0ex_v5RNHaPonFIFI2SVtkxfoiUTPwa54gfIifrk3EZ8TNOHL_GeX-n_kVNTwRz6QViTci2lcvxeYQ7Een5Axn5Y9H15TjZJn20Ey75whVBmL5l6UPbS1_FArMwU8JcDfM8zLKwvgaz_eD6MTDjR9HVY2heVtO68sINNWyo3UK8rijpqhquKuGaGq4dExQ1jARFDWNBQWgkKGoaC0r9mKA01J1QRkoBqRSsUzZKZR-7ERrxG6ExwzEccRzBMcvZRrXs4zlTVwszENfU5cIqCL7RLnuZrqYx09U0ajqCY6arcdR0dbNipm-UzLprdcQ1dcuwBoJv9MxepqtpzHQ1jZqO4JjpahwznasbNm_6aPnPzwAAAP__WCfNZg==
