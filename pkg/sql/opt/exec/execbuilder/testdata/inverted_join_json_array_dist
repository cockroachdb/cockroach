# LogicTest: 5node

statement ok
CREATE TABLE json_tab (
  a INT PRIMARY KEY,
  b JSONB
)

statement ok
CREATE INVERTED INDEX foo_inv ON json_tab(b)

statement ok
CREATE TABLE array_tab (
  a INT PRIMARY KEY,
  b INT[]
)

statement ok
CREATE INVERTED INDEX foo_inv ON array_tab(b)

statement ok
INSERT INTO json_tab VALUES
  (1, '{"a": "b"}'),
  (2, '[1,2,3,4, "foo"]'),
  (3, '{"a": {"b": "c"}}'),
  (4, '{"a": {"b": [1]}}'),
  (5, '{"a": {"b": [1, [2]]}}'),
  (6, '{"a": {"b": [[2]]}}'),
  (7, '{"a": "b", "c": "d"}'),
  (8, '{"a": {"b":true}}'),
  (9, '{"a": {"b":false}}'),
  (10, '"a"'),
  (11, 'null'),
  (12, 'true'),
  (13, 'false'),
  (14, '1'),
  (15, '1.23'),
  (16, '[{"a": {"b": [1, [2]]}}, "d"]'),
  (17, '{}'),
  (18, '[]'),
  (19, '["a", "a"]'),
  (20, '[{"a": "a"}, {"a": "a"}]'),
  (21, '[[[["a"]]], [[["a"]]]]'),
  (22, '[1,2,3,1]'),
  (23, '{"a": 123.123}'),
  (24, '{"a": 123.123000}'),
  (25, '{"a": [{}]}'),
  (26, '[[], {}]'),
  (27, '[true, false, null, 1.23, "a"]'),
  (28, '{"a": {}}'),
  (29, NULL),
  (30, '{"a": []}'),
  (31, '{"a": {"b": "c", "d": "e"}, "f": "g"}'),
  (32, '{"a": [1]}'),
  (33, '[1, "bar"]')

statement ok
ALTER TABLE json_tab SPLIT AT VALUES (10), (20)

statement ok
ALTER TABLE json_tab EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 10), (ARRAY[3], 20)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW RANGES FROM INDEX json_tab@primary WITH DETAILS] ORDER BY lease_holder, start_key
----
start_key           end_key       replicas  lease_holder
<before:/Table/62>  …/10          {1}       1
…/10                …/20          {2}       2
…/20                …/<IndexMax>  {3}       3

# This query performs an inverted join.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab@foo_inv AS j1, json_tab AS j2 WHERE j1.b @> j2.b ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: b @> b
    │
    └── • inverted join
        │ table: json_tab@foo_inv
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMll9zokgUxd_3U3Tdp91NE-kG_MMT2ejWumU0q1btTM2kLJRrBoM00435Uym_-xRojGJgYHzxze6G3z3n1rmNr6C-B2BD59Nt76rbJ7-3u6Px6L_eH2TU6XWux-RP8vdwcEMWSoST2J06cyEmfvhIrkZkwehuP11z8v8_nWGHLNjllDhfV7puIFnwyykZDNudIfnrc3Lk0mTPBQqh8LDvLlGB_QUYUOBAwYA7CpEUM1RKyOToNX2w6z2DrVPww2gVJ9t3FGZCItivEPtxgGDD2J0GOETXQ1nTgYKHsesHKX5n4O3HJHrAF6BwLYLVMlQ2cSmZAoVR5CYrrcZ0uFtTEKv4vaCK3XsEm-0p7LbB1te0vMhu-IgyRu9f4Ycoa0aOzm2jge5e6DxHkjjmrrMO_0D-YBXbxGHU4dQxcg3wjAGjioFE-LbJ9ZJN7gnxsIrIQvghEaFNnMT1oE8cq4wbkzoWTT3lGjIyhupVDI2EjFHWWodmHHZBHeMit6SZKdnKLfleSUgPJXp5hT7Q1heaiGqMH7ySJ8nKSGL8QBMrPz3stOmpMV2r8fIDxKrozAyQeQ4DZFYxsDdAjXMdoEYVQ9sBYvppE8QO71FePq78xLhyXSudVV5FZCar1jlk1apiYC-rzXPNarOKobesshOzyqp8YYaoIhEqLHWL65lSGks-DOjd4-ZjosRKzvBWiln67GY5SEHphocq3pyyzaIbvh2pWKK73P1l2SexQhLPJxlZEi8kGfmkepZkFJLMAxLbJ7WyJLO4TwWijhplFaLq-SSWJdULSY18kpklNQpJzXxSI0tq_mrL2VGjWsU91_NV8aNw_iTnBUG3jljFSWcFUW8esYqzXtSudKjngXia-B7YgIbuWdyzNGNa9zQTmaW15vOG1mpwA2ctrz5vJtfoPHDvVXKzjL6Jp5Q7fomSe2HuBgop3LgP2MYY5dIPfRX7s-3Jev3bjwAAAP__kg94jw==

# This query performs a cross join followed by a filter.
# Note that the distribution shows as either full or partial depending on the
# test config, so we hide it.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM json_tab@json_tab_pkey AS j1, json_tab AS j2 WHERE j1.b @> j2.b ORDER BY j1.a, j2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: json_tab@json_tab_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lFFP2zAQgN_3K6yTJrbh0NhJW8hTGO1Et9KyttI2sQo5yRVS0rizHTGE-t-npAzajLISxFvsu3z3nXPOLehfCXgwbHfbRyMSpxNJPg36J-Ss_f20e9jpkXetznA0_Np9T-5yPiwTplqm50YE_t-H8_kV3pDDIZkyeh8t1px8O24P2mTK9gLi_8xs20Ey5XsB6Q9a7QH5-CMPCZrvifFdcqHS649It_OlTXaiWBsVB5mJZeq93QEKqYywJ2aowTsDBhQ4UHBgTGGuZIhaS5WHbovETvQbPJtCnM4zk2-PKYRSIXi3YGKTIHgwEkGCAxQRqpoNFCI0Ik4K_OPNAoUjmWSzVHtEUBIAheFc5CurxmwYLyjIzDwU1EZcIHhsxbDTAs9e0GqSzitK8pKks1HywS1LpYpQYbTmNc7f_F_KI50eC335WcYpqlpjvdF-j_j8fpB8Fyj0M-MRn1GfU9-hvruxL6fUV-M5hz-UyqCqNdd1fLZLfWd3Y0m3VLK5VpJt_73Zy753jdlWjW8_l6yqp_u6nuXRdNc8-fae_IWe3La2PkxeVbL-ipLlk6w_5zIMUM9lqrF82R-tZJcqWSy_8hhd4PIXomWmQjxVMixyl8t-ASo2ItRmGeXLRSctQiyvoFDM7n-kqyT2DBJfJTllEn-S5KyR7FVSo0xyniTtbyb9051b9ZxYmVSvek5umdSo6sTLpGZVp3o-WZNEXp_HEXhwEARNZrMDa9-dBJbrug0rcMK6hXXOI2cfmwGGkL8gLnQ-3sNLeV1gRzfzfDgnItFI4URcYQsNqlmcxtrE4V1ksXjzJwAA__-pNQC9

# This query performs an inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT j1.*, j2.* FROM json_tab AS j2 INNER INVERTED JOIN json_tab AS j1
ON j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> '{"a": {}}')
    │
    └── • inverted join
        │ table: json_tab@foo_inv
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: [ - /19]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUll-PokgUxd_3U1Tuy-hMoRR_HZ7oGdmEjoOzYja72e6YAq692EixgPMnxu--AbVbSGN0-qnfuqouv3vOLQ7tFor_ErDA-evr5Mb1SG_s-nP_j0mf-M7E-TwnKzZ4T8lKGbwnv8-mX8iqEOmi5AG58clKIa7nOTPien86s7kzJrdT12uWMDL1SK-3YoOA2HcbWVaxogV9cuONSXP_3fYO-B1YZLvbvesfK5QBJ3VBSBS5T6azsTMjn_6ulPFaGQcKqYjQ42sswPoHGFBQ4J5ClosQi0Lk1fa2LnKjH2DJFOI025TV9j2FUOQI1hbKuEwQLJjzIMEZ8gjzoQwUIix5nNToozf7-Mcie8SfQOGzSDbrtLAIpyQACn7Gq5U0ZDLc7yiITfncsCj5A4LFThS6Y7DkHb1cpJt-w7zE6FbEKeZDpUPnUohFnH4D-vSA8yPLSc_WnsZuK4dRn-w1rsKyrFt_6n3qv-BzuiktYjNqK9RWO50qLafKNU4rh4fb0C68jYkQj5uMrEScEpFaxFYrqR7p2foLtvXX2daorXc6V1vOtWuc-yIvMR8aTde2-oHa7ENnS63V0uhs-dxJ5BHmGHU1ekGbJySRDUfNJ_ZjUeuZVMPp1Ki3NI4aGtnl-WSvy-eQydJQuTyi7BqdrYiqbyqi6jVOTyKqv_mI6tc4P0TUfF1EzWu-CjMsMpEW2GjZ1UludZJYFWaMHnD_ASjEJg_xay7Cuna_nNageiPCotyfsv3CTY9HRZkjXz_94zolsbMkpZuktEnKWZLaTdLaJPUsSWuQ2CnJaJO0s6SPV8xJP0syukmsTTLOksxuktommWdJo26S3iaNfnXiZvWOLhPxfRFHYIGOJpofcSmpzFAkTTUDiYcskEIj4sZoJKsBq34YLBP-UFRB8f8V32vs_GdWveZLnhRI4Qt_xDGWmK_jNC7KODyc7Ha__R8AAP__UvZ5AA==

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM json_tab@json_tab_pkey AS j1, json_tab AS j2
WHERE j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: json_tab@json_tab_pkey
    │     spans: [ - /19]
    │
    └── • filter
        │ filter: b @> '{"a": {}}'
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lV-P2jgQwN_vU1gjnXb36iyxk_DHT9kWqtLbQo8g3Z26aOWQYRuajTk7Ua9CfPdTwpaSCDig4g3bw29-M3jMEsw_CQgIeve9N2MSpzNF3o6GH8in3l8f7-_6A3Ld7Qfj4I_7G_IS89s6YG5U-pjJ0P_-4XHxBb-Ru4DMGd2clmtO_nzXG_XI9fWc3YbEf8ht20Ey57fhDbkbdEl1_2r5APIBBFmuVlc33yP4rSRlwJRw-4YMR93eiLz-m8zZraQFS05e0pRFDIZjct__vUeuothkOg7zLFap-PUKKKQqwoF8RgPiEzCgwIGCAxMKC62maIzSxdGyDOxH_4KwKcTpIs-K7QmFqdIIYglZnCUIAsYyTHCEMkLdsIFChJmMkxK_u01A4Y1K8ufUCCIpCYFCsJDFymowGyYrCirPfiQ0mXxCEGzLsN8FYa_oeZL8gpK8JslPkXwbJxlq1A2varjeF8Tnu6-JEOJ9MBy83mvl1Ky8vVY_ZPJU6Qg1RhWXSfHN_wvZUdo7aT6_V3GKutGuFjccEN_d1OUXP84wzwTxGfU59R3qu3vrcmt1tU_pdqB0hrrRqer4zivqs1cbiyI_LV32Wng1i07Fgh1_MdnPXcwGs60GP36A2LmezmU96zPknOK5maHmhWeoWbHix3fP_cnucds6unXuKZKb1rUu3LrWKWM6QrNQqcH6M7Qzk13LZLHiMcLoCdePm1G5nuJHraZl7Ho5LEHlRoQmW58660U_LY9YkUGjfN7cx20SO0jiFZK9TbLrJH6CE98meXWSc5Dk7ndq10nuQRKzTyjPO7flbp3UPEhq7XdidVLr3JY366T2QVJnvxOvkzrnOrWK6z5L1NfHOAIBXqsdeh27Y4URNi231XasTuShhe2p9JrRTPJZ8fc3S-STKWYu-Ky-ltjxt0UxMTOZGKTwQX7BLmaon-M0Nlk8fTlZrX75LwAA___66J2C

# This query performs a left inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 LEFT INVERTED JOIN json_tab AS j1
ON j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join (left outer)
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> '{"a": {}}')
    │
    └── • inverted join (left outer)
        │ table: json_tab@foo_inv
        │ on: a < 20
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzkll1zokgXx--fT9F1bkafaSLdIGJfkRmdKlMOzKq7tVubVKqBNosxNEvjvJTld98CYyIYGJlc5i79kt85_s85_2YL6t81MBj_-WV6OXFRZzSZL-a_TbtoPp6OPy7Q_9GnmfcZrZSMbzPuo8s5WlE0HX9aoIn7x3i2GI_QlTdxyzcI8lzU6azIhY-c642uGwKt6IXfRZfuCJX3322vgV8DQ9vd7l33cINecFRcCBDVu8ibjcYz9OEvtCIXHOcsDhhiGQqXPwgF7G8ggIECBgNuMCSpDIRSMs2PtsXFSfgdmI4hipNNlm_fYAhkKoBtIYuytQAGC-6vxUzwUKQ9HTCEIuPRusAffp9z-OM2uRc_AMNHud48xIohjpEPGOYJz1daj-hws8MgN9lzQJXxOwGMHGU4GQHTd_j8JCfxV5FmIrySUSzSnlHOc_EjEWxfIO_3xXhWVAfwc_5LKW-j-CvgJ9D4e5KijmM-lcShj2U42iuViTF2NffcD13A4LnIIc-1YoxN3IUNGJZRqjK0klGMohglPEpFqOXLF0TzNhlDDsEOxY6BnX6tcrSinNFGuVyxx-paLVWrVn0q5f0m2f86GTPkGHspOo71gozWz2VUIpBx-Aty9bFj1cplVOSy2sg1l2km0t6wLJVjvMcOeV8b0qyEHNaGfI4k01CkIqwL9EJurtRk0iO09C91KfUrKRFayomcbwrkdabQI7rWo-f7AmmTZ8UXzDftC2Yb5Y58YfA2fWHQRq5HXyD664yBlF89ev4U0ldOIdW1s0eQtkmyMoL9Nz2C_TbKHY2g_TZH0G4j12EEyStHkLT5HpgJlchYibPeXL0SSiP5My7CO7F_-pXcpIH4ksqguLtfegWo2AiFyvanZL-YxIcjlaWCPzx9Nx-TSCOJ1pOMKok2kox6klUlGY0ks0Qix6RhlWQ269SQ1IlQ_UaUVU8iVZLVSBrUk8wqadBIsutJgyrJ_lXJyYlQw2bN9fqs6Elz_qTPGxq9f8Jq7nTS0Or2Cau515vkKoZ6uZbfbqMQGBjCt30eDjXfMm3NtMyhZi_NvkaCwBpavkXsYe5YyzW_U7mzzP-R3wpubvIK2JKvlcDwmd-LkchE-hDFkcqi4PFkt_vffwEAAP__ALs90Q==

# This query performs a semi inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 WHERE EXISTS (
  SELECT * FROM json_tab@foo_inv AS j1
  WHERE j1.b @> j2.b AND j2.a < 20
)
ORDER BY j2.a
----
distribution: full
vectorized: true
·
• lookup join (semi)
│ table: json_tab@json_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join
    │ table: json_tab@foo_inv
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: [ - /19]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlF9v4jgUxd_3U1j3CXadEjsJpXlKt6TaVBS6gLRdzSCUP5dOaIgzdugfVXz3UQKlEDVMmXnqW2xf_3zOdY5fQH1PwAb39qZ37vVJo-uNxqN_e00ycnvuxZj8SS6Hg2syVyKd5n5Azkdkzsl__7hDl7i3RTFpvF_qzISYxulDuYVttjTm7CQgztelrhtI5vwkaJLzfpc05vzEJ-V0SLjebJLBsOsOyd__F0U-UEhFhH1_gQrsL8CAAocJhUyKEJUSsph-KYu86AlsnUKcZsu8mJ5QCIVEsF8gj_MEwYaxHyQ4RD9C2dKBQoS5Hycleiv_9WOa3eMzULgQyXKRKpv4lARAYZT5xUhrMR0mKwpimb8dqHL_DsFmOwq9Ltj6in5cpJc-oMwxuhJxirLFa3Ru2gx0u8F9yiRxzG2bnWLrLJYqJ3MRpyROSebHEiOtGL5jbbDMbeIw6nDqGNSxav3xij9-jL_C1-YOzH1v4-cMbdJzL8dk5F575Grg9YHWX01PiPtltjYnUps4RmGiTxxrvwcKQ5FGP2tCUGvXqNg1a-2-uRQyQonRvkGH_QWT1Ts96QtNZK32fvXbddQqMyvK2nvK2MfTwH4vDS2may3-8UCwY3RWAmF8gkAYx_jbCYT1OQNhHZP_IapMpAr3rNadpFdO0lgRH4zucB03JZYyxBspwrJ2PRyUoHIiQpWvV9l64KWvSyqX6C-2z_MuiR0k8XoSr5L4QZKxR2K7JLNKMg6STo9wZx4kWfUkViVZB0ntepJRJbV_tU9W8T_MEvE4jSOwQe-YuhlwpvHZaVszZ9zQOrplamdh52zWQSMwo7B4BBL_ThU_5eibeCyxRdQU2DM_UUjh2r_HLuYoF3EaqzwONyur1R8_AgAA__84IvbZ

# This query performs an anti inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 WHERE NOT EXISTS (
  SELECT * FROM json_tab@foo_inv AS j1
  WHERE j1.b @> j2.b AND j2.a < 20
)
ORDER BY j2.a
----
distribution: full
vectorized: true
·
• lookup join (anti)
│ table: json_tab@json_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join (left outer)
    │ table: json_tab@foo_inv
    │ on: a < 20
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzcll1zm0YUhu_7K3bOld0uFgtIQnuFG5EpGQVSiU7TaT2eBQ4uMmYpi_IxHv33DsixBTWqlFzFd9qvZ8_7nnNY3YP6JwcO7vt3i0vPJ2dzbxWufl2ck5W7cF-F5Efyehm8JWsli-taRORyRdYG-f0Xd-kSPwiJ-745QM6e3-6kUl5nxYf2GHs4drZmFxFx_trouolkbVxE5-TSn5OztXEhSDsdE0M_PyfBcu4uyc9_NJsEUChkgr64QwX8T2BAwQAKJlxRKCsZo1Kyapbu241e8gm4TiEryk3dTF9RiGWFwO-hzuocgUMoohyXKBKsRjpQSLAWWd7iHyV8-XFd3uJnoPBK5pu7QnEiKImAwqoUzUgbMR2uthTkpn66UNXiBoGzvQi9OXB9S48P0is-YFVj8kZmBVYjsxtn-LlEThbu65AEv4XukrwJPB8o9FMA9BHkfior4liPKXAaGwOfOOzJfc6554c2UEizStVkLbOCZAUpRVZhojXDZ7wINjUnDqOOQR2TOuNBQ4yeIeYphjRGPCRtMmjGpR96__Gin8uFlLebcidOFpw45oMT4645CmNZJP9nQjQo1-zJnQzKfVIpqwQrTLoCHfYTXG2f8cSXmixHs-7up3QMRmb1Ipt1ImPHtw_7tvYZMV0bGcd3EDslzl4HWS-xg6xTDNnroOn32UHTjlzj-Do1vrFODV07ukiNU4LsFen4JRbp-BRD9orU_j6L1D7lVVuiKmWhsCN16Ca9d5PGmkcBkxvcPSJKbqoY31UybvfuhkELaicSVPVule0GXvFlSdUVirvHfyn7JHaQZAyTzD7JOEgyOyS2T5r0SeZhdfoJ8qyDqPEwifVJ44OkyTDJ6pMmX2vUtE-aHiTZwzEZfZJ9kDQbJo37pNnXqrObck9z-fE6S4CDGSHaGFuaPYsmmpVasWbjxNKSaRTHaZwKpjff0zQXN6rpudXf8mOLbb4kCngqcoUU3opbnGON1V1WZKrO4oeV7faHfwMAAP__laE0mQ==

statement ok
INSERT INTO array_tab VALUES
  (1, '{}'),
  (2, '{1}'),
  (3, '{1, 2}'),
  (4, '{1, 3}'),
  (5, '{1, 2, 3, 4}')

statement ok
ALTER TABLE array_tab SPLIT AT VALUES (3), (3)

statement ok
ALTER TABLE array_tab EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 3), (ARRAY[3], 5)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW RANGES FROM INDEX array_tab@primary WITH DETAILS] ORDER BY lease_holder, start_key
----
start_key              end_key       replicas  lease_holder
<before:/Table/106/2>  …/3           {1}       1
…/3                    …/<IndexMax>  {3}       3

# This query performs an inverted join.
query T
EXPLAIN (DISTSQL)
SELECT * FROM array_tab@foo_inv AS a1, array_tab AS a2 WHERE a1.b @> a2.b ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: b @> b
    │
    └── • inverted join
        │ table: array_tab@foo_inv
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMldtv2kgUxt_3rxidp93NODC-gNdPzgaqUhFIAamt2ggNnkPqxnjcmSEXRfzvlQ3lYsUINy95Y87x_M73Hc0nnkH_TCCA7ufr_kVvQP7u9MaT8cf-P2Tc7XcvJ-Rf8m40vCJcKf40NXwWzqWcxuk9uRgTzuiuURRs8ul9d9QlnJ3PSPht2Ww6SLh9PiPDUac7Iv9_yVuc5jUOFFIpcMAXqCH4CgwoOHBDIVMyQq2lysvPxUc98QhBk0KcZkuTl28oRFIhBM9gYpMgBDDhswRHyAWqRhMoCDQ8Tgr0Tv721zS7wyegcCmT5SLVAeGUzIDCOOP5yWo4cLOiIJdmN1EbfosQsD2JvQ4EzRU9XWUvvUdlUHyQcYqqYVcJ3ewZ6PZG9zFTJHS3ew3tF-QPlyYgIaOhTcNqB3bJgV3HQa58s2b35DX3pbxbZuSHjFMi04CETi52QELvFD8uDT1auKq05JQsuXUsjaUyqBqtQzshO6Ohc1Y50i2NbFWO3E2SSqBCUTXoBW0Dacms4R_cqFLklRT5B4rY6flhr81Pw7FOzg-ro7KUH-dN5Mep42AvP97bzY9Xx9ImP-3X5addJ7Ij1JlMNZ6Ui2ZpksXypKG4xXU6tVyqCK-VjIpv18dhASoKArVZd9n60Et_t7RRyBfbv4F9EjtKsqtJdplkHyU51SS3THKOktwDEtsntcok9yjpvxp78o6SWtUkVia1jpLa1SSnTGofJfnVJK9M8v904-38jc4T-TCNBQQQ-ZHH5zNm-Rwjy7UFtzgTM6vti_nc9p22cPIwzBN-q_OgjL_LhwI7ecryZz7niUYKV_wOO2hQLeI01iaONp3V6q9fAQAA__83lD2r

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a1, array_tab AS a2 WHERE a1.b @> a2.b ORDER BY a1.a, a2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: array_tab@array_tab_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lGFP2zwQx98_n8I66RHbcGgcpx3kVRjNRLfSsqbSNrEKOc0VItI4sx0xhPrdJ6cI2owy6MS7-O7yu__5_skt6J85BBBH_ehoTLJiJsnH0fCEnEXfTvuHvQF50-3F4_hL_y25q3m3LBBKiZtzI5Lw_um8vMIbchgTwehDvg545OtxNIqIYHsJCX9UrsuRCG8vIcNRNxqRD99tSlAbE5O74lrNYDgm_d7niOykmTYqSyqTySL4fwcoFDLFgZijhuAMGFDgMKFQKjlFraWy4du6qJf-gsClkBVlZWx4QmEqFUJwCyYzOUIAY5HkOEKRomq5QCFFI7K8Rm-aFSgcybyaFzoggpIEKMSlsCenxWGyoCAr89BRG3GBELAVib0uBO6CbqfSe02VXkOlt1Hlg7iqkCpFhemasIl9828lj4x6LPTlJ5kVqFr--qTDAQm9exuFNjusTEBCRkOPhpyG_sa5eGMu_yW3H0tlULXa63JCtktDvruxpd9o2V5ryZ6_cPavC29x59m2ZNuq5K-psmlL_pL1jVCXstDYtOejndxGJ4dZk2J6gUvTa1mpKZ4qOa1rl8dhDaoDKWqzzHrLQ6-oU8x2UCjm99_-Kom9gOStkrwmyXuSxNdI7irJb5L4k6TOZtIf0_nb3hNrktrb3hO3W5zl8vo8SyEAdyZ4e_o-dRK3g46_3xGOmB1wBw9S7Ahk_j6zv9lZLi60tVJ8Ka9r7PimtEaYiVwjhRNxhV00qOZZkWmTTe8yi8V_vwMAAP__UrplUQ==

# This query performs an inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a2
INNER INVERTED JOIN array_tab@foo_inv AS a1
ON a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> ARRAY[1])
    │
    └── • inverted join
        │ table: array_tab@foo_inv
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: [ - /4]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlV9vskgUxu_3U0zOTXU7KAMDuFzhVjahsdhFs9mma8woY5e3yPAO2D8xfvc3oLVKitH2qnfOnJnfeZ4zPHEF2c8YbHD_ve13PR81et5wNPy730RDt-9ejdDv6K9gcIOYlOx1krOps_s1SR_5K-oOEdOQ5_tugDz_HzcYuT10PfD8vStzISZR8lSeJWjgo0aDkdYUOf8tVVXniGmtaRN1_R463L9YkfVF862itRgqCzNkNNEg6LkB-vMOMdJiuEAwwJCIkPtswTOw74EABh3GGFIpZjzLhCy2V-UhL3wBW8UQJekyL7bHGGZCcrBXkEd5zMGGEZvGPOAs5LKtAoaQ5yyKS3TdOADDlYiXiySzEcNoChiGKStWSluH8RqDWObvHbOcPXCwyZ5Erwe2usanq_SSJy5zHl6LKOGyrdUJ3T4C4N0N9yWVqOHQ3bwdbTvrvb1uEHTv7olt254_6oybHzgcLHMbOQQ7GnbqTWoVk9o5Jgtz25egJ79EX4jHZYp-iChBIrGRoxdifdRwjA8sG5-1TLFj1LrWK67pOa6HQuZcts1Dx45-iR1yWduSVlqatS3fOwkZcsnDukYfaPOFItJ25-BGnSKjoqhzoIicnkLy1RS2daVd_1jVHJJzdFZyqH-XHOrnmNzLofGtc2ic43qbQ-trObTOiX7As1QkGT8pX2qlk0KKxPLwgW9SnomlnPFbKWbl2c1yUILKjZBn-aZKNgsveStlueRssftT2ieRoyStnqRVSdpRkl5PolWSfpRED0hkn2RWSfQo6Y8z5mQcJZn1JFIlmUdJVj1Jr5Kso6ROPcmokjqfnbhVfKPzWDxPohBssAhlBqVzRZtRVaEqZUqHUEsJrblpaobZ0a0iDPOYPWRFUIb_i-cSO3pNi898zuKMY7hhj7zHcy4XURJleTTbVtbr334FAAD__8YcdM4=

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a1, array_tab AS a2
WHERE a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: array_tab@array_tab_pkey
    │     spans: [ - /4]
    │
    └── • filter
        │ filter: b @> ARRAY[1]
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF9v4kYQwN_7KVYjVYRmAa9t_nSfTANRaAmkBqmNUhQt9pBYMV66u1YuQnz3k02OgBW4wF3e2JnlN79ZZliC_j8GDqNuv3sxJlEyk-TSH16Tu-6_N_12b0DOOr3RePR3v0xe7_y2viCUEi_3Rky9zaf7xRO-kPaICEbf8nnAJv9cdf0uOTsTrDol3n-pZTlIhF2dlkl70CG78dKSrUrlbxm7KkieCEi9TIZ-p-uTP26JYFVBM4SYvNJz_cFwTPq9v7qkFEbaqGiamkgm_NcSUEhkiAMxRw38DhhQcGBCYaFkgFpLlYWX-aVe-AW4RSFKFqnJwhMKgVQIfAkmMjECh7GYxuijCFHVLKAQohFRnKP3PQ5QuJBxOk80J4KSKVAYLUR2qtQcmKwoyNS8VdRGPCBwtqXY6wC3VvQ0S_szLe2CpX2M5WUUG1Soau6u4jrOiWdvZqPt--3bO8Y57w3GrcleH6fg4-71edNIE6lCVBjuWEyyb37vyjtNXQn9-KeMElS1xm5bwwHx3E1HXva7DFPDiceoZ1PPoZ67ty-30FfjmHceSWVQ1Zq7Op5zTj12vrHI6tPcZa9FvWDR3LFgH59J9qMzWXMqtfqHd4ed6un8BM8P745zjOVmd-qftjv1Y2bMR72QicbiDr1bySpUqrBskzB8wPVmapmqAG-UDPK76-MwB-WBELVZZ531oZfkKZZVUCjmm7-ibRI7SLJ3SNY2ySqS7COc7G2SWyQ5B0nufqdGkeQeJLWO6K5-6os7RVLjIKm534kVSc1TX7yeTdYsls_3UQgcZo3fLdeaYkVYjbDihgIrImBYabUsDIIZCtfKFmoWiwedjffoUT7n2PHLIhvOmYg1UrgWT9hBg2oeJZE2UfCaWa1--RoAAP__JmoClQ==

# This query performs a left inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT a1.*, a2.* FROM array_tab@array_tab_pkey AS a2
LEFT INVERTED JOIN array_tab@foo_inv AS a1
ON a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join (left outer)
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> ARRAY[1])
    │
    └── • inverted join (left outer)
        │ table: array_tab@foo_inv
        │ on: a < 5
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzkld-SmkgUh-_3KbrOTTRpRhsQta9wI6kiZTCL7tamslNTLRxn2XFothuTTFm-ewo0RslADcnl3Nl_-M7xO_JzB_r_DXDw_n4_m_gB6Uz9xXLxx6xLFt7Me70kgl29pESYVy_Jm3D-jgilxMNNLlbu6dNNdocPZLIgwiQz782S-MFfXrj0puTt3A_OnlhLeZOkn8qrjMwD0ukIdrUi7j_bft_CosqqSybBlFzuv9ix_YvutxPzSpDyICKDLpmHUy8kv38oGhVlowIopDLGQNyjBv4RGFCw4JpCpmSEWktVbO_KS378BXifQpJm27zYvqYQSYXAd5An-QaBw1KsNhiiiFH1-kAhxlwkmxJdZwMovJab7X2qORGUrIDCIhPFyuhZcL2nILf594o6F7cInJ216E-B9_f06V366SdUOcZvZZKi6pmXjS4fMuSH6cz_XHphORqg8MNwgJ5I3pdMkY5rn-bgmscZnO1NwnDy4SPjnPvBcnTdBQrzgLjsNKLjCVBYJ0rn5D-ZpCRJSSYShbFRLB-xNd_mnLiMuiZ1LeoOap2ZFWdmG2eFq-Ng7ba-fhj4TMq7bXb4fjLlxLUOLjqu84hBp8mgxkim8U-oGlDXqVVlVVTZbVQtpMpR9ZxLTa71irrsVW1Ju1LSqS35vZJUMSqM6wo90lsgDZn1RpdPHLRY1LVpKae2x0Glx9FFj-zp2cB-NRt6lvHkbGBtuqxkg_VMs8Fq4-wsGwbPLxsGbVQds2H4a9kwbBNHIepMphovStZV6lcqGaxIEYxv8ZA8Wm5VhO-VjMq7h-W8BJUbMer8cMoOCz_9dqRzheL-9Gd9TmKNJLOeZFZJZiPJqifZVZLVSLIvSOyc5FRJdiNp3MLToJHk1JNYleQ0kob1JKtKGjaSRvWkQZU0-lnjw-I3ut7IzzdJDByiiI0jMTSNsenYhh3HY2MUrRzDEaMoipzV2MTiZVhvxK0uXpTFv_JziS3SSgNfi41GCu_EHU4xR3WfpInOk-h4st__9jUAAP__PNPKoA==

# This query performs a semi inverted join.
query T
EXPLAIN (DISTSQL)
SELECT a2.* FROM array_tab@array_tab_pkey AS a2 WHERE EXISTS (
  SELECT * FROM array_tab@foo_inv AS a1
  WHERE a1.b @> a2.b
)
ORDER BY a2.a
----
distribution: full
vectorized: true
·
• lookup join (semi)
│ table: array_tab@array_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join
    │ table: array_tab@foo_inv
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlF1z2joQhu_Pr9DsVXKOHCx_kMRXzgnOHGcI5AAzTadlGBmvUzfGciWTj8nw3zsCSrAb09Be5c4raZ_dd-VXz6C-ZeBBcHPdPQt75KATDkfD_7uHZBh0g_MR4dbR3-Ri0L8iXEr-NCl55G--JsUdPpGzIeEW-fBfMAhIcKPzycE6-6fURIhJmt8vc9g6h7OjiPif56Zpo64XHZL-oBMMyL8fdciBQi5i7PEZKvA-AQMKNowpFFJMUSkh9fLz8lAYP4JnUkjzYl7q5TGFqZAI3jOUaZkheDDiUYYD5DHKlgkUYix5mi3RTRqBwrnI5rNceYRTEgGFYcF1ZLRsGC8oiHn5UlGV_BbBY1sthh3wzAV9e5dhfo-yxPhSpDnKltXU6HqiQDcZwWMhie9sRurr3CSVqiRfRZqTNCcFTyXGhg5fkdaflx7xGfUt6tvUdxsFWjWB1j4CtbD1LThVcaOnAj3SDS5GZBhcheSyH_aA7rqcrhB382IlT-Qe8W0to0d8tzoFhVORx78aQ9Qo2K4JdhoFv-gUMkaJcVWiz_6B8eKVqfSEIYpWu3r65UIaO3NqnbUrnbG3O4L9qSNatvFmR7B9uqw5wn4PjrD3EbjlCPe9OsLd5wkYoCpErrAitqmSWatkMO0fjG9x5Tcl5nKK11JMl2dXYX8JWi7EqMrVLlsFYf5jS5US-WzzRG-T2E6S1Uyy6iRrJ8mukNg2yamT7J2k4z3UOTtJbjOJ1UnuTlK7mWTXSe3fnZOr_4ckEw-TNAYPplZsJu6pa0Rmcmo4kcOME-fENqLjU8Z44nDX0W9dkvFbpX_K4RfxsMRqsynwEp4ppHDF77CDJcpZmqeqTKfrncXir-8BAAD__8FT_CY=

# This query performs an anti inverted join.
query T
EXPLAIN (DISTSQL)
SELECT a2.* FROM array_tab@array_tab_pkey AS a2 WHERE NOT EXISTS (
  SELECT * FROM array_tab@foo_inv AS a1
  WHERE a1.b @> a2.b
)
ORDER BY a2.a
----
distribution: full
vectorized: true
·
• lookup join (anti)
│ table: array_tab@array_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join (left outer)
    │ table: array_tab@foo_inv
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUll1v4jgUhu_3V1jnqt11SpwPquYq3ZJqU1HoQlbb1Q5CJjnpZBrijB36oYr_PjIwFELDlJmr3uHYfnye47wRL6C-5uBBcHvTPQ975KgTDqPh391jMgy6wUVEuHXyO7kc9K8Jl5I_jys-8de_xuU9PpPzIeEW-fevYBCQXj8iwa1mkKMVYWd7KsQ4Kx4W-9hqH2cnE-J_mpmmjfrMyTHpDzrBgPz5nx5yoFCIBHt8igq8_4EBBRtGFEopYlRKSP34ZbEoTJ7AMylkRTmr9OMRhVhIBO8FqqzKETyI-CTHAfIEZcsECglWPMsX6CZPoHAh8tm0UB7hlEyAwrDkemS0bBjNKYhZ9Xqiqvgdgsc2Sgw74Jlz-v4qw-IBZYXJlcgKlC1ru9DouUSPdIPLiPT_iYIBueqHPaCw02mga1LwVEriO-tW-5qZZlJV5IvICpIVpOSZxMTQwzeU-7PKIz6jvkV9m_puo7hVE7cOEdfCq9txGqXPe1G467xzaV0h7mflUk8UHvFtrdEjvrvdBYWxKJIftWHSKGzXhJ1G4VdPIROUmGwr-uwPGM3f6EpPGKJstbdXv15IY2VOrbL2VmXs_Ulhv5qUlm28OynskCprSbE_clLsQ8Q3kuJ-1KS4h3waBqhKUSjckm06yaydZDCdK0zucJlDJWYyxhsp4sXa5bC_AC0eJKiq5SxbDsLi-5SqJPLp-pO-SWJ7SVYzyaqTrL0ke4vENklOnWTvJZ0eYOfsJbnNJFYnuXtJ7WaSXSe1f7ZPrn4f0lw8jrMEPEjbaLatNDVY6sSGg5Zr8OQ0Ntz22dlZ4kws19T_FtKc3yn9Ug4_i8cFVodNgZfyXCGFa36PHaxQTrMiU1UWr2bm89--BQAA___ExArY
