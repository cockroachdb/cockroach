# LogicTest: 5node

statement ok
CREATE TABLE json_tab (
  a INT PRIMARY KEY,
  b JSONB
)

statement ok
CREATE INVERTED INDEX foo_inv ON json_tab(b)

statement ok
CREATE TABLE array_tab (
  a INT PRIMARY KEY,
  b INT[]
)

statement ok
CREATE INVERTED INDEX foo_inv ON array_tab(b)

statement ok
INSERT INTO json_tab VALUES
  (1, '{"a": "b"}'),
  (2, '[1,2,3,4, "foo"]'),
  (3, '{"a": {"b": "c"}}'),
  (4, '{"a": {"b": [1]}}'),
  (5, '{"a": {"b": [1, [2]]}}'),
  (6, '{"a": {"b": [[2]]}}'),
  (7, '{"a": "b", "c": "d"}'),
  (8, '{"a": {"b":true}}'),
  (9, '{"a": {"b":false}}'),
  (10, '"a"'),
  (11, 'null'),
  (12, 'true'),
  (13, 'false'),
  (14, '1'),
  (15, '1.23'),
  (16, '[{"a": {"b": [1, [2]]}}, "d"]'),
  (17, '{}'),
  (18, '[]'),
  (19, '["a", "a"]'),
  (20, '[{"a": "a"}, {"a": "a"}]'),
  (21, '[[[["a"]]], [[["a"]]]]'),
  (22, '[1,2,3,1]'),
  (23, '{"a": 123.123}'),
  (24, '{"a": 123.123000}'),
  (25, '{"a": [{}]}'),
  (26, '[[], {}]'),
  (27, '[true, false, null, 1.23, "a"]'),
  (28, '{"a": {}}'),
  (29, NULL),
  (30, '{"a": []}'),
  (31, '{"a": {"b": "c", "d": "e"}, "f": "g"}'),
  (32, '{"a": [1]}'),
  (33, '[1, "bar"]')

statement ok
ALTER TABLE json_tab SPLIT AT VALUES (10), (20)

statement ok
ALTER TABLE json_tab EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 10), (ARRAY[3], 20)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE json_tab] ORDER BY lease_holder
----
start_key  end_key  replicas  lease_holder
NULL       /10      {1}       1
/10        /20      {2}       2
/20        NULL     {3}       3

# This query performs an inverted join.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab@foo_inv AS j1, json_tab AS j2 WHERE j1.b @> j2.b ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: b @> b
    │
    └── • inverted join
        │ table: json_tab@foo_inv
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzElN9u2jAUh-_3FNa52lbTxE7on1y5azONiUGXVNqmDaFAzqpQiDMnqToh3n1KoBQQcVIxtXexnZ_P56NPZw7pnyk44H6_7l50euTtVce_8b923xHf7bqXN-Q9-ej1v5BJKuNhFozEbymHUXxPLnwyYXS9X645-fbJ9VwyYccjIn7lpmkhmfDjEel7V65HPvwojgJa7AVAIZYh9oIZpuD8BAYUOFCwYEAhUXKMaSpVcTQvf-yED-CYFKI4ybNie0BhLBWCM4csyqYIDtwEoyl6GISoDBMohJgF0bS8fv2Ax49hcod_gcKlnOazOHVIQMkIKPhJUKxaBjNhsKAg8-ypYJoFtwgOW9DmUJ34HlWG4WcZxagMq4Jr1Vig64D7kCgi7HUnRdGefp45RDAqOBVWJSB_DmABtmraSQVcoqJZoIp2daW8yxMykVFMZOwQUbyn3yOivY_TpqJNS9pKVOs5qL5UGSrjfBtTsCMqrKPKEnZliaebpQpRYVh18R6WnmzJxGB8K1KF0N5CYM01ZodpbDCzZfCmJtdw7Zhsv7zJNYAbJp--tsk1qCuTmXmIyry5R_xAj7jZaihRDdSORO2Xl6gGcEOis9eWqAb1USL2v-bhnhoepomMU2w05sxiUGJ4i8vhmspcjfFayXFZZrnsl7lyI8Q0W56y5aITL48KwM0w04a5Psy1YUsftrRheyvMdsO2_s01pdva9Ik-fKINn-rDp9rwmT58dkjHzvUdM2s0qZGszjK9ZqzGM6YXbfflg8WbfwEAAP__tKazXA==

# This query performs a cross join followed by a filter.
# Note that the distribution shows as either full or partial depending on the
# test config, so we hide it.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM json_tab@json_tab_pkey AS j1, json_tab AS j2 WHERE j1.b @> j2.b ORDER BY j1.a, j2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: json_tab@json_tab_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k1Fv0zAQx9_5FNZJaMDcJXa6DeUpYwtaoTQjqQRoRJPTHCOls4vtSKCq3x0lHRup2tIu6lvOd__8f2ffzcD8nIAPSdgPz4ekkN8UeRtHH8h1-Pmqf9YbkBcXvWSYfOy_JPc1rxYFY6PkjRVZ8PfjZvoDf5OzhIwZfcjWMSefLsM4JGN2lJHga-m6HpIxP8pIFF-EMXnzpUoJWp2J9L64RhlEQ9LvvQ_JQV4Yq4ustIWS_vMDoCBVjgNxhwb8a2BAgQMFD1IKU61GaIzSVWpWF_byX-C7FAo5LW11nFIYKY3gz8AWdoLgw1BkE4xR5KgdFyjkaEUxqX-_ulmgcK4m5Z00PhGUZEAhmYoq6jjMhXROQZX20dBYcYvgszl9GpS3Ryi-FuqRpZRK56gxb3CklfJ_JSs6uxTm-ztVSNTOSbOxaEAC_jAoQRcoRKX1ScBowGng0aC7tg9vl8tNlLaondOmfcAOaeAdrrXoNizY9u_H2r2fw9yOw7edqx24uvvlao4W356Lt-TibmfLy9oB6niPUOuXcAVUjGaqpMHlZVz5Z7faQMxvcbHRRpV6hFdajWqbRRjVuvogR2MXWb4IerJO1bf2r5jtIObLYr5R7DXE7rLY2yh-vVncbdPzcZueT9o4n-7knM6f_QkAAP__Dt-OaA==

# This query performs an inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT j1.*, j2.* FROM json_tab AS j2 INNER INVERTED JOIN json_tab AS j1
ON j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> '{"a": {}}')
    │
    └── • inverted join
        │ table: json_tab@foo_inv
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: [ - /19]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUk09vm0wQxu_vpxjNJXayMSzYSd49kcRUInIhBatq1VjR2mwjHIelC0SpLH_3Csg_orCJ1R7aGzvMb-Z5RnrWmP9YIUP3y_nk2POhN_aiafRp0ofInbinU1jSwS6BpTXYhQ9h8BGWuUwvCz6H4wiWFni-74bg-Z_dcOqO4Szw_HYLhcCHXm9JB3NwLkrTtEU1bd6HY38M7frO-gL5BTJYbzY7_YcOa8ChbliAZfYhCMduCCdfK2W8VsaRYCpj4fMbkSP7hhQJWjgjmCm5EHkuVVVe101efIfMJJikWVlU5RnBhVQC2RqLpFgJZDjl85UIBY-FMkwkGIuCJ6t69IM35-HjMrsWP5HgqVyVN2nOgBOYI8Eo49Vr36AmzjYEZVk8LcwLfiWQ0Q15vygvvRWqEPGZTFKhDKtD13cpL5P0Fskj4N5lCnrO8PHMjnV_2me11ukZY2dR4J_0kWBQFgwcShyLOHanE2sbJ5WD--sOO1xkKrnhqrrrRMrrMoOlTFKQKQPHrkT50HNGrxgabWdoSJxRpyd7G0-RVIVQxkHbj2PvEYfuda4Ydq54mixVLJSIuwa_osWX-zIzjtpEY9uuPVfmOzWNWpro-5NCfy8pBjX3Deu9YXlD14uw2H9xWN5w8iwso38mLG94ug_L4Z8KyysrQpFnMs1Fa0XXZLNKkYivRJO8XJZqIc6VXNRrmmdQc3UhFnnR_KXNw0ubX5XA5zDVwpYetrSwrYdtLTxswfQlPNTC_-s3j7TwgR4-0MKHevhQCx_p4aOtDjbb_PcrAAD__90U5bU=

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM json_tab@json_tab_pkey AS j1, json_tab AS j2
WHERE j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: json_tab@json_tab_pkey
    │     spans: [ - /19]
    │
    └── • filter
        │ filter: b @> '{"a": {}}'
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF1v2j4Uxu__n-LoSH9RVpfEDn3zVfqSqnSMdARpm1pUGeJ1YTRmtiNtQnz3KaGlSwUpDHV3sX2e_J7z6OhM0fwYI8coaAdnPUjSrwouuuEHuAk-X7dPWh3YOW9Fvehjuw6PNe_mBSOj0jsrBv7Tx93ku_wFJxGMKFm8FmcGny6DbgA7OyPaGIB_m7muJ2HEGoM6nHTOoXxfm96iuEUO09msVn-qYA0BRcEQmFuHsHsedOH0C4xoQ5D8X6L_iCma6IQ9aLfeB1CLE2N1MshsolL-fw0JpiqWHfEgDfIbpEiQIUEP-wQnWg2lMUrnT9OisBX_RO4STNJJZvPrPsGh0hL5FG1ixxI59sRgLLtSxFI7LhKMpRXJuPj98piQ4JkaZw-p4SAIDJBgNBH5ac-hLvZnBFVmn4HGinuJnM7I35lib2iKbWLqIhlbqaV29suO5vccfLZ8DDjnV1HYOV3pwlvp4hmepUrHUsu4xO7nytdKlrRyKcy3K5WkUjtH5WbCDvjNRR9-Hn6YWQ4-JT4jvkf85so-mpukGSltpXaOy3jf2yU-3V1Qcx4p2Cup-yUqXX-w6HaD5VB3z2HrDvwGvry39cU28bWY-YM3nXm2fjrNLdNh7t6a0bxiahHN4T9bB0tcdKWZqNTIl2th6Z_dfBfI-F7Od4tRmR7Ka62GBWZ-DAtdcRFLY-ev3vzQSounYrL_FNNKMSuJ3ZditgGZvRR7leJmNblZKaZutXp_m8QOKsWH1eTDbRI7qhQfV5OPNyL3Z__9DgAA__-zyhha

# This query performs a left inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 LEFT INVERTED JOIN json_tab AS j1
ON j1.b @> j2.b AND j1.b @> '{"a": {}}' AND j2.a < 20
ORDER BY j1.a, j2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join (left outer)
    │ table: json_tab@json_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> '{"a": {}}')
    │
    └── • inverted join (left outer)
        │ table: json_tab@foo_inv
        │ on: a < 20
        │
        └── • scan
              missing stats
              table: json_tab@json_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzkVVFP4koUfr-_4uS8CNcBOi0gzlNValLDbb3Q3exmJabQ0RSx050WoyH8902pCCUyxbBP-taZznfOd75zvpw5Jr-nyND6cd07sx2odO2BN_i_V4WB1bMuPPgXLvvufzBJRHSb-iM4G8BEh5516YHtfLf6ntWFK9d2ii8ouA5UKhNaH4F5M9M0g8NEr4-qcOZ0oXh_NL9B_wYZzBeLo-rqhV73YflgDLpWBbfftfpw_hMmtO6TLJaPBCMRcMd_5AmyX0iRoI4EDRwSjKUY8yQRMvs1Xz60g2dkGsEwimdpdj0kOBaSI5tjGqZTjgw9fzTlfe4HXDY0JBjw1A-ny_Cr-szVx238wF-Q4IWYzh6jhIFPYIQEB7GfnWoNquFwQVDM0nXCJPXvOTK6IPuTsqMnLlMeXIkw4rJhFHl5LzFneUPcb57VX3YDyZrvnRC3YfSE5C2Q9RxLqJjNtxaY-qvsG3eFtjDGrgauc15Fgq4DJl33hjFmO14HCd6FMklhIsIIwghiP5Q8qGXHDDRLGZiUmDoxDWK2diqjf0SZTJHXbrU_qEosw0dfZv3rCfEwi3PeImJgGnmRFbP9jkDtcoESPhZRsIcQLWK2dwphfESIgZApl43TogimcUxMerwzRXNninVkIQMuebAr8DtcHFETcYPqBcguCq0CBbq_O-lh7mxQrdbQ9zVoCa8tgza_kEFLlNkw6MnnNmiJEK8GpdohDtX3t4d-oD10rbanN0pIbXmj9YW8UaLMhjc6n9sbJUKsvEH_1vZ6J0efJ7GIEr7XUtKytcaDe56vwkTM5JhfSzFepsmP7hK3vAh4kuZ_aX6wo_xXRnATTJVgXQ3WlWBDDTaU4GYBTLfBTXXNJalbSnRbDW4rwSdq8IkS3FGDO4codqpWTCsZk5IhK5sy9ZjRkjmj6kHbrny4-OdPAAAA____S3j6

# This query performs a semi inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 WHERE EXISTS (
  SELECT * FROM json_tab@foo_inv AS j1
  WHERE j1.b @> j2.b AND j2.a < 20
)
ORDER BY j2.a
----
distribution: full
vectorized: true
·
• lookup join (semi)
│ table: json_tab@json_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join
    │ table: json_tab@foo_inv
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: [ - /19]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUk0FP204Qxe__TzGaU_LvhnjtJJV8MgWjGoWEJpFK1UZoEw_IIey6uzYCoXz3am1KMIpNUC_tzTM7v933Rs-PaH6u0cfw4nx4GI2gdRxNZ9MvwzZMw2F4NIP_4WQyPoOVUfIyEws4nMLKha-fw0kI4YUdhtbu0eBKqctE3hUIf0JaK36wgOBH7jgewco9WLThcHQMrZV7IKBoL8F12m0YT47DCXz6ZocEMpQqppG4JYP-d-TI0MU5w1SrJRmjtG0_FkNRfI--wzCRaZ7Z9pzhUmlC_xGzJFsT-jgTizVNSMSkuw4yjCkTybq4-ln-74_L9IYekOGRWue30vggGCyQ4TQVtup0uYPzDUOVZ9sHTSauCX2-YfuLiuQd6YziU5VI0l23RtfTWpE9A-F9qiHoPa81sOhVok0GK5VISCSkItEUd2yJDMd55kPAWeCywGNBv1a_-x79VvfTTntV7bOHlHwYhiczmIZnEZyOoxGyraVUJ7dC2yUPlbrJ01K2kj4EnpU7gmBQdWdoqWS8n71erT2v1t7WldIxaYqrhgL-AeebHTsYqY5Ku4Pq9FZPrZJeRQnfP738z9Lb5U6n6-4b4Dd0vQqw99cF-A39LwLc_9cDvMPehEyqpKGKtbqbHZtuiq-p_BuMyvWSzrVaFs-U5bjgikZMJitPeVlEsjyyAl_CvBF2m2G3EfYqMH8Ne43wx-aXe41wvxnuN8KDZnjwLs_zzX-_AgAA__88gICx

# This query performs an anti inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab AS j2 WHERE NOT EXISTS (
  SELECT * FROM json_tab@foo_inv AS j1
  WHERE j1.b @> j2.b AND j2.a < 20
)
ORDER BY j2.a
----
distribution: full
vectorized: true
·
• lookup join (anti)
│ table: json_tab@json_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join (left outer)
    │ table: json_tab@foo_inv
    │ on: a < 20
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlUFv2kAQhe_9FaM5QbsErw2E-GSaOKojaqfGVVO1KDJ4EpkQr7u2o0QR_72ySUNMw0KUEzd2d76d98ZPyyNmf-Zoon1xPhw4LjROnFEw-jZswsge2scBfIRT3_sKs0wkl3k4gcEIZjr8-GL7NrheAPZFCUDj9XLrSojLOLmrMP6ENWb8YALW70LTDIKZfjBpwsA9gcZMPwih2p6CrjWb4Pkntg-ff5ZFITJMRERueEsZmr-QI0MdGRo4ZphKMaUsE7I8eqwKnegeTY1hnKRFXm6PGU6FJDQfMY_zOaGJQTiZk09hRLKtIcOI8jCeV9c_W_j34zK9oQdkeCzmxW2SmRAymCDDURqWq1abazheMBRFvmqY5eE1ockXbHdRTnJHMqfoTMQJybZR1xU8pGTC0D4NwPse2D6ceY6LDNdHjuz5Ivs-lWB1nkdulWPzXLD4atqmaTpu0EeGV7HMcpiJOIE4gTSMJUWtcllCRW6CxZmlM8tgVnejYf0thkujTx-ht9HswA2c_7ymMr4NZflVhkLcFOlStkhMsIwnj7267YymIol2s9fZaM_YaG_lSsiIJEV1Qxb_hOPFKzNwRUuk7aN69UrPRiWdmhK-e9z5--Le5lqrre-a-C261hLf2f_EbzH8IvGH-5h4ffec6e_Mma61dgzZFlFrIevuf8i2GH4Rsv4-hmzLv4ZPWSqSjGrWNt2slW8uRde0fKMzUcgpnUsxrdosl17FVRsRZfnylC8XTrI8KgW-hLkS1tWwroSNGszXYUMtW1O37ijprhruKuGeGu69x_ShEu6rO_eV8JEaPnqT7PHiw98AAAD__xh2mio=

statement ok
INSERT INTO array_tab VALUES
  (1, '{}'),
  (2, '{1}'),
  (3, '{1, 2}'),
  (4, '{1, 3}'),
  (5, '{1, 2, 3, 4}')

statement ok
ALTER TABLE array_tab SPLIT AT VALUES (3), (3)

statement ok
ALTER TABLE array_tab EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 3), (ARRAY[3], 5)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE array_tab] ORDER BY lease_holder
----
start_key  end_key  replicas  lease_holder
NULL       /3       {1}       1
/3         NULL     {3}       3

# This query performs an inverted join.
query T
EXPLAIN (DISTSQL)
SELECT * FROM array_tab@foo_inv AS a1, array_tab AS a2 WHERE a1.b @> a2.b ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: b @> b
    │
    └── • inverted join
        │ table: array_tab@foo_inv
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzEk99v2jAQx9_3V1j3tK1ug5PwY3ly12YaE4MuQdqmDSFDblVWiDPHqVoh_vfJAUGpiAFtUt_wHZ-7j07fLKD4M4MAwm83vctun7y-7sbD-EvvDYnDXng1JG_Jh2jwmQilxONYiwn_JeU4ze7JZUwEo9tGVXDJ149hFBLBLiaE_ywbDQ-JcC8mZBBdhxF5_920BDU1ARQymWBfzLGA4AcwoODBiEKu5BSLQipTXlR_6iYPEDQopFlealMeUZhKhRAsQKd6hhDAUExmGKFIUDkNoJCgFumsGr3V3_wa53f4CBSu5KycZ0VABCUToBDnwrzOHQ9GSwqy1NuNhRa3CAFb0uOtutk9Ko3JJ5lmqBy3Tmx9V6AbInzIFeH-5o7csINSB4Qzyl3K6w3dUwyN2fpsfp1drtK5UOZePSnvypz8lmlGZBYQ7hmrPuHNfaI-5U1a6da6eqe4xlJpVE5r15OzM8q9s9oVfu2K7WSpElSY1A3e49KX5zJ3OjtEnUFzx4AdH2T2r0F2vPMjg3zA6lmQvRcI8gHDJ0FuvniQD7iug9z-X0HesyLCIpdZgUcFtGESjsktrr6KQpZqijdKTqs1q-eg4qpCgoVeddnq0c1WLSP4FGZW2LXDrhX27LBnhf0dmD2HfSv8zr65aYVbdrhlhdt2uG2FO3a4c9LBRstXfwMAAP__0MCoeA==

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a1, array_tab AS a2 WHERE a1.b @> a2.b ORDER BY a1.a, a2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: array_tab@array_tab_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0Ul9v0z4Uff99iqsr_TRg3prEHQ958tiCVijNSCoBGtHkNJcRkcXBdiSmqt8dJZlWUjVlZdqb75_jc459lmh-FuhjHEyDsznk5TcFb6PwA1wFny-np5MZvDifxPP44_Ql3O-86hak1vLu2spUPJyuqx90B6cxSJet523Dg08XQRSAdI9TEF9rx-EE0jtOIYzOgwjefGlGkjU9mdwvt2pm4Rymk_cBHGS5sTpPa5ur0v__ABmWKqOZvCWD_hW6yJBjwrDSakHGKN20l-3SJPuFvsMwL6vaNu2E4UJpQn-JNrcFoY9zmRYUkcxIjxxkmJGVedFePeQVGZ6por4tjQ-SQYoM40o21dGIY7JiqGq7ZjRW3hD67or9myrvOVV5g6rWYupS6Yw0ZT0hSYP828oWaxfSfH-n8pL0aNx3Fs5AeA8xEc00rK0PwmXCY4IzMR70wfd53VhpS3p00qcX7iET_HCQYtyjcB__ge5TP3DEjx4Zqz1U8edUNRyrLaoiMpUqDW3Ga-vNTpMpym6oy6hRtV7QpVaLlqYrwxbXNjIytpt6XTEp21H7bH-C3T3A3ibY2wnmPbCzCeY7wa93g8dP8Xyyl-dk9d_vAAAA__-sGwU5

# This query performs an inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a2
INNER INVERTED JOIN array_tab@foo_inv AS a1
ON a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> ARRAY[1])
    │
    └── • inverted join
        │ table: array_tab@foo_inv
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: [ - /4]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUk0Fv2k4Qxe__TzGaS-CfDWZtnFCfTIMrOaImNahqlKJowdPIDfG6aztKhPjulQ1NIMIbUHtob-ysfzvvPfEWmP2Yo4Pel8tBzw-g0fdH49GnQRNG3sA7H8P_8CEcfgShlHi6ycXUff51k97RE_RGIEzwg8ALwQ8-e-HY68PF0A82kG9S3sTJQ_Uth2EAjYbgrSm4X4t22yIQZmvahF7Qh-350YIvj5q_bsyWgOpiBnYThmHfC-H9FQjeEqx8QiDDREYUiHvK0LlGjgwtnDBMlZxRlklVjhfVR370iE6bYZykRV6OJwxnUhE6C8zjfE7o4FhM5xSSiEgZbWQYUS7iefV0XRzI8FzOi_skc0AwmCLDUSrK04lh4WTJUBb5y8YsF7eEDl-y_VX5yQOpnKILGSekDLNO2Dp0ZM-E95gqaLid53xdc53txqwXhr2ra-44jh-Mu5MmMhwWuQMuZ67J3HoT5iEmSvHrZDt1BlIV3wtVRjqQ8q5I4buME5CJA65Vqgqg4do7vNj7eukw1661Yx1iZyRVTso43bbiWsfM5ce1Kzq1K15elioiRVHdwzu0BPJEpkZ3i6hTYG8p4PvXgf9uHQzrxKgPnx-i61UhrL-zEG-Y2CiE_S8U4g0760Kc_alC7FgRUpbKJKO9_ujtsikU3dKqXZks1IwulZxVa1bHYcVVg4iyfHXLVwc_WV2VAjdhroVNPWxqYUsPW1q4swXz13BHC7_Tb7a18KkePtXCZ3r4TAt39XD3oMAmy_9-BgAA__8pGeGk

# This query performs a cross join followed by a filter.
query T
SELECT info FROM [EXPLAIN (DISTSQL)
SELECT * FROM array_tab@array_tab_pkey AS a1, array_tab AS a2
WHERE a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
] WHERE info NOT LIKE 'distribution:%'
----
vectorized: true
·
• sort
│ order: +a,+a
│
└── • cross join
    │ pred: b @> b
    │
    ├── • scan
    │     missing stats
    │     table: array_tab@array_tab_pkey
    │     spans: [ - /4]
    │
    └── • filter
        │ filter: b @> ARRAY[1]
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8k2Fv2j4Qxt__P8XppL8oq0twAm3lV2FtqrIx6ALSVnVRZciti0ZjZjvSKsR3n5J0dKlKCuu2d_jOj3_PXR6WaL7NUeA4GAQnE0jSzwrOwtE7uAo-Xgx6_SHsnfbHk_H7QRPu77wqL0it5d21lVN__et68ZXuoDcGydlDvyi48OE8CAPY25O8NQX_U9ZuewTSbU2b0BueQrXeWPJVo_mz47YkFI0ZdJswCk-DEF5fguQtyfInZHT_emF_OJrAoP82gEacGKuTaWYTlYr_G8gwVTEN5S0ZFFfIkaGHEcOFVjMyRum8vCwu9ePvKNoMk3SR2bwcMZwpTSiWaBM7JxQ4kdM5hSRj0k4bGcZkZTIvnt60HGR4oubZbWoESAZTZDheyPx04HgYrRiqzD4QjZU3hIKv2O-5cv-mK3cXV2fJ3JIm7XSqlsq6AN9df_teGPYur7gQoj-cHEcb-d5G_gM2S5WOSVNcoUa58rkrTwxxLs2XNypJSTuH1TFGQ_A76wn8fO-jzArwOfNd5nvM72yco7PLHsdKW9LOURXve_vM5_tras5jBXsjtVuh8u0zxV-aKcc7cLpbZn0HX94f8LVl1p9xtc569x9k_Ql-SGahUkOPM__ky-086BTfUPnHMSrTM7rQalZgyuOo0BWFmIwtu1556KdFq_hsv4p5rditiNuPxe4OZPex2KsVd-rJnVrxcb24-5KFHdaKj-rJRzstLFr99yMAAP__tfyPYg==

# This query performs a left inverted join with an additional filter.
query T
EXPLAIN (DISTSQL)
SELECT a1.*, a2.* FROM array_tab@array_tab_pkey AS a2
LEFT INVERTED JOIN array_tab@foo_inv AS a1
ON a1.b @> a2.b AND a1.b @> '{1}' AND a2.a < 5
ORDER BY a1.a, a2.a
----
distribution: full
vectorized: true
·
• sort
│ order: +a,+a
│
└── • lookup join (left outer)
    │ table: array_tab@array_tab_pkey
    │ equality: (a) = (a)
    │ equality cols are key
    │ pred: (b @> b) AND (b @> ARRAY[1])
    │
    └── • inverted join (left outer)
        │ table: array_tab@foo_inv
        │ on: a < 5
        │
        └── • scan
              missing stats
              table: array_tab@array_tab_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzkk19v2koQxd_vpxjNSyBZ_qwNhOun5QZHcsQ1qXGrRimKFryJ3BCvuzZRIsR3r2xTgtN4A2qf2jfvjn8zZ8_orDD5tkAL7c-Xo4HjQm3oTPzJh1EdJvbIPvOB0-YxAW40j-HcG_8PXCn-fJPyGdt-3cT34hkGE-AGjOxzHxz3k-359hAuxo67Q9xKeRNGj_mvFMYu1GqcNmfAvizbbVNkU2Z1GLhDKN8frej6qP6jYjQ55IU5dOsw9oa2B_9dZUJ5LpQjwUgGwuUPIkHrGikSNHFKMFZyLpJEqux6lf_kBE9otQmGUbxMs-spwblUAq0VpmG6EGihz2cL4QkeCNVqI8FApDxc5K2r3ECCZ3KxfIgSCziBGRKcxDw7NVomTtcE5TJ9mZik_E6gRddkf1VO9ChUKoILGUZCtYyyMP85FlaxjfFH3_byVSDBn5aBZNvJfooV1Fhn6zszNp7v3A08b3B1TS3Lcly_P60jwbELjG5XsqkgwdtQJSl8lWEEYQQxD5UIGtkxY5apBYwSZhBmEtat9MQ4xJPMi82iOof6EavwgatscyMp75dxIVxGFjCzeGSN9d6wpqezJhFzGQV7eNAlrFfpgXmIBxOpUqFavfL7mXlCGD2pHNGpHPHSWapAKBFUNX5DiysbMm71y0TxbJOwDskfX6mpW9JE9w8p_dWQtszGniF9R9WrkJp_RUjf8WQnpN0_NqTveLAJ6envCukbIzyRxDJKRGlEVed2ll4R3Iki8Ylcqrm4VHKejymO45zLLwKRpEWVFgcnKkqZwF2YamFDDxta2NTDphbulGD6Gu5o4X_1k7tauKeHe1r4VA-fauG-Hu4fZNh0_c_3AAAA__-W3zX9

# This query performs a semi inverted join.
query T
EXPLAIN (DISTSQL)
SELECT a2.* FROM array_tab@array_tab_pkey AS a2 WHERE EXISTS (
  SELECT * FROM array_tab@foo_inv AS a1
  WHERE a1.b @> a2.b
)
ORDER BY a2.a
----
distribution: full
vectorized: true
·
• lookup join (semi)
│ table: array_tab@array_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join
    │ table: array_tab@foo_inv
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUk0Fv2kAQhe_9FaM5Je0SsA1U8slp4qiOCKQ2UlO1KFrwJHIDu-6uHQUh_nu1NgKcxg5RL-3NM7vfznuj5xXqX3N00b-5HpwGQzg6D6Jx9GVwDJE_8M_GwO2T93ARjq6AK8WXtxmfetuv2_SBlnAaAbfh62c_9MG_MTwcbeg_0DspbxPxWDDWhuHWyRS8H3mn45CZNz2GUXjuh_Dpmyk5MhQypiFfkEb3O1rI0MEJw1TJGWktlWmviktB_IRuh2Ei0jwz7QnDmVSE7gqzJJsTujjm0zmFxGNS7Q4yjCnjybx4us4jMjyT83whtAucwRQZRik3Vavt4GTNUObZbqLO-D2ha63Z4aoC8Ugqo_hSJoJU264Tttkgsi3hP6UKvO52hZ5h7xKlM_gpEwGJgJQniuKWKZHhKM9c8Czm2cxzmNerNWC_xYARvtlqtyp-vEzJhYF_MYbIvwrgchQMke15SlWy4MpseSDlQ56WuqVwwXOM3iF4_ao9TTMp4sP8dWv9ObX-drakiklRXHXkWR9wsn5hCUPZkmm7X72901OrpFtRYh0eYOtvA9x2WgcG-BVVzwLs_HsBfsXAXoB7_32AX_AXkk6l0FTxVvdyx6Sb4nsq_wYtczWjayVnxZiyHBVc0YhJZ-WpVRaBKI-MwH3YaoTtZthuhJ0KbD2HnUb4Y_PkbiPca4Z7jXC_Ge6_yfNk_e53AAAA__8uMIUP

# This query performs an anti inverted join.
query T
EXPLAIN (DISTSQL)
SELECT a2.* FROM array_tab@array_tab_pkey AS a2 WHERE NOT EXISTS (
  SELECT * FROM array_tab@foo_inv AS a1
  WHERE a1.b @> a2.b
)
ORDER BY a2.a
----
distribution: full
vectorized: true
·
• lookup join (anti)
│ table: array_tab@array_tab_pkey
│ equality: (a) = (a)
│ equality cols are key
│ pred: b @> b
│
└── • inverted join (left outer)
    │ table: array_tab@foo_inv
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUk0FP204Qxe__TzGaE_y7IbGdpJJPpmBUo9SmjqtStRHaxANyCbvuro1AKN-9WhslmGAT1BM3z-6-mfcbPT-g_rNEF_3zs8lhEMLecTBNpl8n-zD1J_5RAtw--B9O4ugLcKX4_UXB59766yK_pns4nAK34ftnP_YhjBLwz00P2HvssCW_lPIiE7eVznrUcetgDt6vcjBwyMyc70MUH_sxfPphSo4MhUwp5Dek0f2JFjJ0cMYwV3JBWktljh-qR0F6h-6AYSbysjDHM4YLqQjdByyyYknoYsLnS4qJp6T6A2SYUsGzZdW6jRMZHslleSO0C5zBHBlOc26qXt_B2YqhLIvNRF3wK0LXWrHdXQXillRB6anMBKm-3TSW3OfkwsQ_SSD6lvgxnEZBiAy3Nots3cm_yxV4w_VqPdPzMlO6gN8yE5AJyHmmKO2ZEhlGZeGCZzHPZp7DvFErmP0WMAP0uO1hK9RhmATbTLnKbrgy259IeV3mtW8pXPAc4zcEb9zE07SQIt2Nb9jK57TybbCkSklR2iTyrA84W72whFD2ZN4fN19v_LQ6GTacWLsH2_rXYPed3o7BfsXVs2A77yfYr4A9Cfbo3Qf7Bb6YdC6FpgZbW-eBST2lV1T_JVqWakFnSi6qMXUZVbrqICVd1LdWXQSivjIGn4qtTrHdLbY7xU5DbD0XO53ij92Th53iUbd41Cked4vHb2Kerf77GwAA__8u3ZNI
