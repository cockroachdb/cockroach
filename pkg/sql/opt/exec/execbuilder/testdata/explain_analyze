# LogicTest: local

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v), INDEX (v))

query T
EXPLAIN ANALYZE (PLAN) SELECT k FROM kv WHERE k >= 2
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
regions: <hidden>
·
• scan
  sql nodes: <hidden>
  kv nodes: <hidden>
  regions: <hidden>
  KV time: 0µs
  KV rows decoded: 0
  actual row count: 0
  missing stats
  table: kv@kv_pkey
  spans: [/2 - ]

statement ok
INSERT INTO kv VALUES (1,10), (2,20), (3,30), (4,40);

query T
EXPLAIN ANALYZE (PLAN) SELECT * FROM kv WHERE k >= 2
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
rows decoded from KV: 3 (24 B, 6 KVs, 3 gRPC calls)
regions: <hidden>
·
• scan
  sql nodes: <hidden>
  kv nodes: <hidden>
  regions: <hidden>
  KV time: 0µs
  KV rows decoded: 3
  actual row count: 3
  missing stats
  table: kv@kv_pkey
  spans: [/2 - ]

statement ok
GRANT SELECT ON crdb_internal.tables TO root;

query T
EXPLAIN (VERBOSE) SELECT * FROM system.privileges WHERE path = 'vtable/crdb_internal/tables'
----
distribution: local
vectorized: true
·
• scan
  columns: (username, path, privileges, grant_options, user_id)
  estimated row count: 10 (missing stats)
  table: privileges@privileges_path_user_id_key
  spans: /"vtable/crdb_internal/tables"-/"vtable/crdb_internal/tables"/PrefixEnd

# Regression test for not showing the execution statistics that correspond to
# scans of the virtual tables. Scrub row counts to avoid test brittleness when
# virtual tables are added or removed.
query T scrub-row-counts
EXPLAIN ANALYZE SHOW TABLES
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
regions: <hidden>
·
• sort
│ sql nodes: <hidden>
│ regions: <hidden>
│ execution time: 0µs
│ order: +nspname,+relname
│
└── • render
    │
    └── • hash join (left outer)
        │ sql nodes: <hidden>
        │ regions: <hidden>
        │ execution time: 0µs
        │ equality: (column80) = (table_id)
        │
        ├── • render
        │   │
        │   └── • hash join (left outer)
        │       │ sql nodes: <hidden>
        │       │ regions: <hidden>
        │       │ execution time: 0µs
        │       │ equality: (column62) = (table_id)
        │       │ right cols are key
        │       │
        │       ├── • render
        │       │   │
        │       │   └── • hash join (right outer)
        │       │       │ sql nodes: <hidden>
        │       │       │ regions: <hidden>
        │       │       │ execution time: 0µs
        │       │       │ equality: (oid) = (relowner)
        │       │       │
        │       │       ├── • virtual table
        │       │       │     sql nodes: <hidden>
        │       │       │     regions: <hidden>
        │       │       │     execution time: 0µs
        │       │       │     table: pg_roles@primary
        │       │       │
        │       │       └── • hash join
        │       │           │ sql nodes: <hidden>
        │       │           │ regions: <hidden>
        │       │           │ execution time: 0µs
        │       │           │ equality: (oid) = (relnamespace)
        │       │           │
        │       │           ├── • filter
        │       │           │   │ sql nodes: <hidden>
        │       │           │   │ regions: <hidden>
        │       │           │   │ execution time: 0µs
        │       │           │   │ filter: nspname NOT IN ('crdb_internal', 'information_schema', __more1_10__, 'pg_extension')
        │       │           │   │
        │       │           │   └── • virtual table
        │       │           │         sql nodes: <hidden>
        │       │           │         regions: <hidden>
        │       │           │         execution time: 0µs
        │       │           │         table: pg_namespace@primary
        │       │           │
        │       │           └── • filter
        │       │               │ sql nodes: <hidden>
        │       │               │ regions: <hidden>
        │       │               │ execution time: 0µs
        │       │               │ filter: relkind IN ('S', 'm', __more1_10__, 'v')
        │       │               │
        │       │               └── • virtual table
        │       │                     sql nodes: <hidden>
        │       │                     regions: <hidden>
        │       │                     execution time: 0µs
        │       │                     table: pg_class@primary
        │       │
        │       └── • distinct
        │           │ sql nodes: <hidden>
        │           │ regions: <hidden>
        │           │ execution time: 0µs
        │           │ distinct on: table_id
        │           │
        │           └── • virtual table
        │                 sql nodes: <hidden>
        │                 regions: <hidden>
        │                 execution time: 0µs
        │                 table: table_row_statistics@primary
        │
        └── • virtual table
              sql nodes: <hidden>
              regions: <hidden>
              execution time: 0µs
              table: tables@tables_database_name_idx (partial index)
              spans: [/'test' - /'test']

# Regression test for not showing execution stats for mutation nodes with a
# RETURNING clause (#139378).
query T
EXPLAIN ANALYZE DELETE FROM kv WHERE true RETURNING *;
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
rows decoded from KV: 4 (32 B, 8 KVs, 4 gRPC calls)
regions: <hidden>
·
• delete
│ sql nodes: <hidden>
│ regions: <hidden>
│ execution time: 0µs
│ actual row count: 4
│ from: kv
│ auto commit
│
└── • scan
      sql nodes: <hidden>
      kv nodes: <hidden>
      regions: <hidden>
      KV time: 0µs
      KV rows decoded: 4
      actual row count: 4
      missing stats
      table: kv@kv_pkey
      spans: FULL SCAN
      locking strength: for update

query T
EXPLAIN ANALYZE INSERT INTO kv VALUES (1, 10) RETURNING k + v;
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
regions: <hidden>
·
• render
│
└── • insert
    │ sql nodes: <hidden>
    │ regions: <hidden>
    │ execution time: 0µs
    │ actual row count: 1
    │ estimated row count: 1
    │ into: kv(k, v)
    │
    └── • values
          sql nodes: <hidden>
          regions: <hidden>
          execution time: 0µs
          actual row count: 1
          size: 2 columns, 1 row

# Verify that the number of applied statement hints is displayed.
statement ok
SELECT crdb_internal.inject_hint(
  'SELECT k FROM kv WHERE k >= _',
  'SELECT k FROM kv@kv_v_idx WHERE k >= _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

query T
EXPLAIN ANALYZE SELECT k FROM kv WHERE k >= 100
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
plan type: custom
statement hints count: 1
regions: <hidden>
·
• scan
  sql nodes: <hidden>
  kv nodes: <hidden>
  regions: <hidden>
  KV time: 0µs
  KV rows decoded: 0
  actual row count: 0
  missing stats
  table: kv@kv_pkey
  spans: [/100 - ]
