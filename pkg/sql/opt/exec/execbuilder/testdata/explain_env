# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2jwUx6_rpzjKTeET-Ujgpgqq9KU01ZeNhgqyrlVVWU5iwMPYmePQwDSpD8ET9kkmh7ZjkxjrRXMRyT7_3_E55x_HtuGaqoJJ4UFfpnMlSTo7PwNa0TQpGc-oAk0LDcutCiHbBkWlyqjCXyQTBeZswTTMSAF6RiGjE1JyDUvCS-rBidFTQRJO8ZpN12RaU_vkUhi9zDVbsDVVuCwonrFCy6kii-It1KLkmqWS40ITfYDkMiWc6RV-SZHhnCjNNJOCZpiJjFa4SMmBsnMlczIlmmIm8lLjekhMTPdSk8kWoxOqMJdyXubPM51IhSfz_WVvSSY0VUvCC73iFG-nnB1gMmLsfIOeFYRz-YAnJedY10aaURyqjRM1pVvIyLGSD3sR13EcNA5ic5guvnI4NVl6AOb8X6Wk1NKkX9JUS8XW9A-WoP4o8OMAYv9sEEBeJpyl_1bQQEcEwig-gWgYQ_RpMGiho-R5Z7vqD6NxPPLDKIYK53O6gqtReOmPbuFjcAsNAv6432yhozA6D26gwglmWQWN5GX_wr8MB7dg5YotiFpZ0CAtSJqo2UPIH8TB6PeawuhD0I9hHPtxOI7D_hiO7xAAwLf6bR4rlbxciMLy4O51sw4Q63V939rRK0o0zTDRlgdWx3FPbMe1HRcc13Mcz3GsHbGZPBOpxqkshQFcx9kJ13cQm-ukVzk1-XZhYVx-AXcxJR9-Jux03U63jn1v_XVvybv0Vpfyfu2h--MeQsHN1cAPI2gMr-IWBNF1E8bBwNj8D1yMhpdQwef_g1EACZxCt4ds27ZR_Zep_nv-pBA8bTZPm8enzSOkUhRaESa0B-1O2_Xgrt0FG9rde_QjAAD__5Civ6w=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ld1u2zYUx6_DpzjwTe3BWuT4JnBQYKrLbNocOZC1rkEQEJREOVxoUuOHYmUYUOwZfLmny5MMlJPUXeOlvagvDIjn9z86H3_aQQDvmDZcyQlMVXGjFS2u374BtmZF7rgomQbLjIVmSyEUBKCZ0iXT5HfFpSGCr7iFa2rAXjMoWUWdsNBQ4dgEjj3PJM0FI3d8eUeXnWofrqTnVW35it8xTZxh5Jobq5aarszXqFZOWF4oQYyl9gWlUAUV3LbkMUVJaqott1xJVhIuS7YmpqAvlF1rVdMltYxwWTtLuiFxudyrqqqtjFVME6HUjasfZlopTaqb_WVvlVxaphsqjG0FI9sply9oSurX-RU8N1QIdUsqJwSx3SL9KF6qTVC9ZFuRx4lWt3slozAM0QJn_mXW_CHgtc9yAuDf_ylKnVU-fcMKqzS_Y_-zEjRNcZRhyKI3Mwy1ywUvvl9DHx1QiJPsGJJ5Bsmvs9kQHeQPJ9un6TxZZGkUJxmsSX3DWjhP47MovYBf8AX0KUSL6WCIDuLkLX4Pa5ITXq6hnz-en0Zn8ewCerXmK6rbHvTpEPIBGpwgFM0ynP63pjj5GU8zWGRRFi-yeLqAV5cIAODP7tt_eoUSbiVNbwKXT4ddgPaenq-GO7xm1LKSUNubQO8oHB0H4SgIRxCOJmE4CcPeDuwnz2VhSaGc9IJRGO6EuztI_HWybc18vl2x9Ft-FO7KtLr9mPBoPDoad7G_hl_cW_5NeutK-XbtoatXJ8-7r_Xuc5-5r9nnvvYZ97lHl33CNaTy5Ok8xfGPyZZsBpDiU5ziZIoXT2br04_W9brOus1-67ohNHut2z5r3a5__P58FsUJ9Ofn2RBw8m4ACzzz7Hdwms7PYD2EFn77CacYcngN4xMUBEGAuJRMB92_RL_QypgBgvvNP_ebD_ebD9D9DLefnax_eLiFPvK338L9ZvMAFEoaqymXdgKHR4ejCVwejiGAw_EV2sEqLizTBvpWOzZA_wYAAP__4dAqBw==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lN-O4jYUxq_HT3GUm4WKVGH2ZgTaiyybldIyYUTS1Y5GI8tJTsDF2KntQKCqtA_BZZ9unqRymNnSSpTOxXCBYn_f7_j8ke378AW14UqOYKKKlVasWH76CNhikTdclKjBorGwOboI8X3QqHSJmv6quDRU8DW3sGQG7BKhxIo1wsKGiQZHcOP8KFkukO75Ys8WHXXOrqTzq9ryNd-jpo1BuuTGqoVma_Maat0IywslqLHMXiCFKpjgdkdfQpS0Ztpyy5XEknJZYktNwS6kXWtVswWzSLmsG0u7JnG5OEtV1RHDCjUVSq2a-rmnldK0Wp1P-0hyaVFvmDB2J5Aeu1xeYErmxvkKPzdMCLWlVSMEtd0gXSsu5SaYXuARcnaq1fYsMgyCgKRR5g6z5jcBH1yUMYA7_59W1ljlwm-wsErzPf7HSMhkHoVZBFn4cRpB3eSCFz-20CNXDOIku4FklkHyy3Q6IFf5885xNZklaTYP4ySDltYr3MHdPL4N5_fwc3QPPQZhOukPyFWcfIq-QktzyssWevnL_ufwNp7eg1drvmZ650GPDSDvk_6YkHCaRfN_5xQnP0WTDNIszOI0iycpvHsgAAC_d__u5xVKNGtpvBE8fN_sBOZ9Xz8OTvwamcWSMuuNwLsOhjd-MPSDIQTDURCMgsA7MbvOc1lYWqhGOmAYBCdydwepu052V6OLdwpLN-UX8BTTavt3wOv3w-v3nfbH4H_Xlr9JbV0qb1ceeXw3JiT6ejcN4wR6s7tsAFHypQ9pNHVj_gE-z2e30EKYgpI4OH7ZrRoT3_d9wqVE7XfvZK_Qypg-gafDn0-Hb0-Hb9A9RC08MPNBSXw8I9mt6qTDs1RxYVEb6FndYJ_8FQAA___0m9gg

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxK4QWMVl4l-v6PP3zmeB9dcG6HKMQQqW2rFssXFOfA1zx6ckDnXYLmxUPcUQikmoLnSOdf0txKloVKshIUz-DKaAHge5LxgTlqomXR8DKfI84CX7EFyuhHzDZt3HiyYAbvgb3FVtryqrFiJDdfUGU4Xwlg112xlPmKtnLQiU5Iay-wOU6qMSWEb-joipxXTVlihSp5TUeZ8TU3GdsSutKrYnFlORVk5S7uaRDl_1yqKXuMF11QqtXTVS6uF0rRYvh-7N0Vpua6ZNLaRnPYt5zucnLUb_QAvDJNSPdLCSUltt8i2il3ZJNNz3kstTrV6fFc5OT4-7k4rF8aaPxLO2in_vCfmrGrH1zyzSosN_89KUJBgn2Ag_nmEoXIPUmSfGxigPQdhTE4hnhGIf0bRIdqrX_70X8EsTknihzGBhlZL3sBVEl76yS38wLcwcOCnwfAtV9OiJaezBIdf456sh5DgKU5wHOD0NcJ6wFo5jC_wTeeJfA2D-nXo1L8Mo1vYr7RYMd3sw8AdQj1EwwlCfkRw8vZBYfwdBwRS4pMwJWGQwsHd_cEEIXxzFflhDIPZFTkEHF8PIcVRy36CaTK7hAZ-fcMJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSP_gYAAP__ze5psg==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxK4QWMVl4l-v6PP3zmeB9dcG6HKMQQqW2rFssXFOfA1zx6ckDnXYLmxUPcUQikmoLnSOdf0txKloVKshIUz-DKaAHge5LxgTlqomXR8DKfI84CX7EFyuhHzDZt3HiyYAbvgb3FVtryqrFiJDdfUGU4Xwlg112xlPmKtnLQiU5Iay-wOU6qMSWEb-joipxXTVlihSp5TUeZ8TU3GdsSutKrYnFlORVk5S7uaRDl_1yqKXuMF11QqtXTVS6uF0rRYvh-7N0Vpua6ZNLaRnPYt5zucnLUb_QAvDJNSPdLCSUltt8i2il3ZJNNz3kstTrV6fFc5OT4-7k4rF8aaPxLO2in_vCfmrGrH1zyzSosN_89KUJBgn2Ag_nmEoXIPUmSfGxigPQdhTE4hnhGIf0bRIdqrX_70X8EsTknihzGBhlZL3sBVEl76yS38wLcwcOCnwfAtV9OiJaezBIdf456sh5DgKU5wHOD0NcJ6wFo5jC_wTeeJfA2D-nXo1L8Mo1vYr7RYMd3sw8AdQj1EwwlCfkRw8vZBYfwdBwRS4pMwJWGQwsHd_cEEIXxzFflhDIPZFTkEHF8PIcVRy36CaTK7hAZ-fcMJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSP_gYAAP__ze5psg==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20wUhtfMVRyxIfmEP0CRKpSIhTGT1q1xkD2lIIRGgz1Oppl43PkxcVZcRK6QK6lswwYV0i5tPc-rM-85ngfXXBuhyjEEKltqxbLFxTnwNc8enJA512C5sVD3FEIpJqC50jnX9KcSpaFSrISFM_g0mgB4HuS8YE5aqJl0fAynncJL9iA53Yj5hs07Ec5AFcUfFVUizwNVWbESG66pM5wuhLFqrtnKwIIZsAv-N9bKSSsyJamxzO4wpcqYFLahrxE5rZi2wgpV8pyKMudrajJWfhxTaVWxObOcirJylnZViXL-rlUUvcYLrqlUaumql2YLpWmxfH_s3hSl5bpm0thGctoXne9wctZu9R94YZiU6pEWTkpqu122VeyaTTI9573U4lSrx3eVk-Pj4-5WcmGs-SU_OBDmrGrja55ZpcWGf7ASFCTYJxiIfx5hqNyDFNn_DQzQnoMwJqcQzwjE36PoEO3VL3_6r2AWpyTxw5hAQ6slb-AqCS_95Ba-4VsYOPDTYPiWq2nRktNZgsPPcU_WQ0jwFCc4DnD6OsJ6wFo5jC_wTeeJfA2D-jV06l-G0S3sV1qsmG72YeAOoR6i4QQhPyI4efugMP6KAwIp8UmYkjBI4eDu_mCCEL65ivwwhsHsihwCjq-HkOKoZf-DaTK7hAZ-fMEJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSPfgcAAP__9H9qFA==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0s9O20oUBvA18xRHbEiu8AUUqUKJWBgzad0aB9lTCkJoNNjjZJqJx50_Js6Kh8gT8iSVbdggCOrS1vc7Oj6fPQ-uuTZClWMIVLbUimWLi3Pga549OCFzrsFyY6HuUwilmIDmSudc099KlIZKsRIWzuDLaALgeZDzgjlpoWbS8TGcdoSX7EFyuhHzDZt3EM5AFcW7RJWdUZUVK7HhmjrD6UIYq-aarcxu6Xlv4MpJKzIlqbHMGlgwA3bB35dSZUwK29DXETmtmLbCClXynIoy52tqMlbuHlNpVbE5s5yKsnKWducS5fxDVRQ94wXXVCq1dNXLdQulabH8eO1eitJyXTNpbCM57Y-df2Jy1jb7D3lhmJTqkRZOSmq7PttTfLabZHrOe9TGqVaPH5KT4-PjrvtcGGv-yB1VM2dVO77mmVVabPiOSlCQYJ9gIP55hKFyD1Jk_zcwQHsOwpicQjwjEP-MokO0V7-86Z-CWZySxA9jAg2tlryBqyS89JNb-IFvYeDAT4Ph21xNizY5nSU4_Br3yXoICZ7iBMcBTl9XWA9Yi8P4At90TuRrGNSvQ6f-ZRjdwn6lxYrpZh8G7hDqIRpOEPIjgpO3HxTG33FAICU-CVMSBikc3N0fTBDCN1eRH8YwmF2RQ8Dx9RBSHLXZ_2CazC6hgV_fcILBwRmMJsjzPA91_3mD4Hm7fd4-PW-fIFOlsZqJ0o7h6GQMd0cj8OBodI_-BgAA__9YPWp2

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20AUhdfMU1yxIalwAUWqUCIWxkxat8ZB9pSCEBoN9jiZZuJx58fEWfEQeUKepLJDNgiIWNr6vqPrc-x5cM21EaocQqCyuVYsm12cA1_y7MEJmXMNlhsL9YZCKMUENFc655r-VaI0VIqFsHAG3wYjAM-DnBfMSQs1k44P4bRTeMkeJKcrMV2xaSfCGaiieFNRZeeoyoqFWHFNneF0JoxVU80W5rPmwkkrMiWpsczusD0PpMqYFLah25ScVkxbYYUqeU5FmfMlNRkrYcYM2Bl_O6bSqmJTZjkVZeUs7SoT5fRdqyg2Gi-4plKpuateGi6UpsXc7DBFabmumTS2kZxuCs93ODlr1_0ELwyTUj3SwklJbbdpW8Wu2yTTU76RWpxq9fiucnJ8fNytmAtjzT_5wWDMWdXG1zyzSosV_2ASFCTYJxiIfx5hqNyDFNnXBnpoz0EYk1OIJwTi31F0iPbqlzebp2ASpyTxw5hAQ6s5b-AqCS_95BZ-4VvoOfDToP-aq2nRkuNJgsPv8Yas-5DgMU5wHOB0e8Kyx1o5jC_wTeeJfAm9ehs69i_D6Bb2Ky0WTDf70HOHUPdRf4SQHxGcvP6gMP6JAwIp8UmYkjBI4eDu_mCEEL65ivwwht7kihwCjq_7kOKoZb_AOJlcQgN_fuAEg4MzGIyQ53ke6v7zBsHzev28fnpeP0GmSmM1E6UdwtHJEO6OBuDB0eAe_Q8AAP___k5q2A==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAUhd_zK-7jNs0TlLWwoj6wzJOQIO0gRX2zTHIT7jB2sK9py6-fQraXaQz1zZLPd3R0zhUCVugDOXsLqSu23uli8-0r4AsW60imRA-MgeHQqZJkKXPw6HyJXv10ZIMytCOGO7gZjAGEgBIrHQ3DQZuItzBKhAC0em1QHak-6vrEwUYH4A3-LXe21buGaUdH9CoGVBsK7Gqvd-Et1C4apsIZFVjzBdK4QhviV_XHolSN9kxMzmKpyJb4okKhL8RuvGt0rRkV2SayOtVEtj5LVVWHYYVeGee2sfndauW8qrbnY3ckWUZ_0Cbwq0HVtVxeYErdLvoGPQVtjHtWVTRG8WnItopL2Yz2NXZQK1fePZ9F-r1e73RaJQUOewN3rcs_70lHdq39AQt2no74n0mSdCEnuYSl_PEos1RCE9eGik8B9zCfZqvJ7FFCH-aTp-755epqMBhe9QY3o-vPw-H1qDeEaZYu5FxmOfRhmU8WOfTHSSKfHmaTaQbv7h_yjyCz1XtYyplMc_gA3xf3cwi4HydCCJEE3Ee0BYqABgtuf5JfAQAA__83zjAS

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0Vd9u27YXvg6f4sA3tX-wGjkGfghsBJjqMps2Rw4kLW0QBAQlUQ4XWtRISrEyDCj2DL7c0-VJBkpx4rbxsl7UFwZ4-H0fzp_viI4DF0xpLosJzGR6qyRNb96_A7ZmaVJxkTEFhmkDdYdCKMIxKCZVxhT5TfJCE8FX3MAJ_H88BXAcyFhOK2GgpqJiEzhGjgOsoIlg5J4v7-my5cEN1WBu2JdwWVi8LA1f8XumSKUZueHayKWiK_0trFUlDE-lINpQ8wpTyJQKbhqylchISZXhhsuCZYQXGVsTndJX0i6VLOmSGkZ4UVaGtG3ixXIvK887GsuZIkLK26p87GouFclv96fdMXlhmKqp0KYRjHRdzl7hZNRO9BvwXFMh5B3JKyGIaQdpW_FaboKqJetIFk6UvNtLGbmu21or49ro3wWcWJUX_UQrI618zVIjFb9n_zISNAuxF2OIvXdzDGWVCJ6-XUMfHVDwg_gYgkUMwa_z-RAdJI-R7jRbBFEcen4Qw5qUt6yB89A_88JL-AVfQp-CF80GQ3TgB-_xR1iThPBsDf1kGz_1zvz5JfRKxVdUNT3o0yEkAzSYIuTNYxx-mZMf_IxnMUSxF_tR7M8ieHOFAAD-aP_tr5dKUa0K3ZvA1VOwvaC9p_P1cAevGDUsI9T0JtA7ckfHjjty3BG4o4nrTly3twO2nedFakgqq8ISRq67c93uILHrZJqSWb1dcmGnvCXu0pS8exY8Go-Oxu3dn8P_XFvyXWprU_l-5aHrN9OX3ddY91Vfua_e577mBfdVW5d9hqtJbpGnixD7PwYdsh5AiE9xiIMZjp7M1qfP1rW81rr1futWQ6j3Wrd50bq79V_4-MMWXXeLMIRWE7wIIjy37OconIaLs_bVebtNePjZsYEPP-EQQwInMJ4ihD-ezz0_gP7iPB4CDi4GW9H_dVr1FDmO4yBeFEw57evTT5XUeoDgYfP3w-bTw-YTtJ_35qvI-ofH7bY3f9npPmw2j4BUFtooygszgcOjw9EErg7H4MDh-BrtwHIuDFMa-kZVbID-CQAA___4x0Oh

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkkFr20wQhs_ZXzHkEvsj-nAplBCTg6IqoFaWjbQNNaUsE2kkb73WqrsjJ_avL7JbKKWuyf15ZoZ33iCAR3Je2_YWIluuncVy9f4e6IXKp16bihwweYbtkRKiiCU4sq4ip75Z3Xpl9EYz3MG7t1OAIICKauwNwxZNT7dwI4IAqMUnQ2qvmz02Bw9W6IFX9Cdu24G3HeuN3pNTvSe10p5t43DjX2NtesO6tEZ5Rj5jGlui0bxTv0ZUqkPHmrVtqVK6rehF-RLPnN0522GDTEq3Xc_qEJNum5NWXR81qskpY-26736mWlun6vXps4-mbpncFo3nnSF1TLk641Q4fPQVvPZojH1WdW-M4sMjhyjO3WbQNXSUBlw5-3xSeTOZTA7VqrRn_93A3TDlr33Cnu0wfkslW6f39I-XiCiPQxmDDO_TGPz_DCNxgZBk8gayuYTsU5pei4tonhUyD5NMAqtuTTtY5MkszJfwMV7CCCEsovG1uHgIZ0m6hMvO6Q263SWMcCzGUyHCVMb5b1uS7EMcSShkKJNCJlEBV1--Xk2FiD8v0jDJYDRfyGuIs8cxFHE6sP_BQz6fDfZUBEEQiEPbWPwIAAD__3aYOPU=
