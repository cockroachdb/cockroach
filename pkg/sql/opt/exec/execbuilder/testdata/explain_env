# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4kIvtgdLlmwUKGQEmKoynTZXDiS1axEEBEVRK1FZTETKkzcMyEf4V_YD-5R8yUA5sT1MSZBl9YMBXp577j1Hh5YFH1ktuag8CAT9WgtCv7x9A6xlNGt4mbMaFJMK1juUYSQohZwokhHJ4BQG-nYwB7AsyFlBmlLBmpQN82AH5VLJ6xJOQRRFL4w0SnRQXuWsxTWjYrViVU4UF5XErCJZyfJHCO63ChYfkhTFkKA0DaN3IK9Lm9Z5hnmlWF2R0laaCtfiVywVUVwqTqVNJBYFVnzVybHcv_6U_Xos15EPDrrDSvsgeCCKop9pL7mPSa8mbQ1ZEcUppqIsGdVm2AcvBgUpJetnV3XD_gv7ilfal51DUg951T_gleM8wV-ImlEilfz_VpYbqdgKd59QYi1gV3_GACOIkZ8iSP03C9TF2r5qspJTu4WhcUIgjNLXEC1TiD4sFmPjJLur7E7BMkrS2A-jFFp89ZVt4DwO3_vxZ_gJfYYhAT8JRmPjJIzeok_Q4gzzvIVh1tWN0dww_IXW1jc-jH5EQQpJ6qdhkoZBAoMLAwDg9-5f_0yy_gVL_hszPXDGhzIVZbOqpOnBxb64w5v78-UxvmZEsRwTZXpgTh33teW4luOC43qO4zmOeQTWaeYVVZiKptINrnM8-wuXSugMYbW50ouZx8081w1Hhaopyz3TMY9-kvsJ05k7nXV3f4xf6kH2TTzoNnyeDdOX2GBcDuaPpHej09v8K73rh9K76Ulvc5_ef-DWuNDIs2WMwnfRDrkeQYzOUIyiACVwn-AhOURf93XRXz8d_U1v9Du96NP5wg8jGC7P0zGg6OMIErTQ2O_gLF6-hxZ-_gHFCDI4hdncsCzLMiQlFbTf370-A26329vtze32BqiopKoJr5QHk-nE9eBiMgMLJrNL4-8AAAD__z__A1I=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2zYUhq_Dpzjwje3BciQbBQoFAeaqTKfNlQNJ7VoEAUFR1MpVJlOR8qQNA4o9gy_3GnuBPUqeZKCc2B6qtuiy-sKADj_-55zfv-w48JJXWijpQ6DY20pR9ubpE-ANZ1ktypxXYLg2sNlRCCU4hZwamlHN4RyG9nR4BuA4kPOC1qWBDS1r7sMOFdrodyWcgyqKXozWRnWokDlvSMWZWq-5zKkRSmrCJc1Knn9C4H6qYPkiSXEMCU7TMHoG-l05ZVWeESENryQtp8ZKkUr9QrShRmgjmJ5STVRBjFh36zje33_p_n0cz9UfbXTH6ulh4aEqin6l_cp9SnY0PbXImhrBCFNlyZk1Y3rwYljQUvN-dVPV_L-or4W0vuwc0rbJo_4Gj1z3M_qFqjij2uj_b2TdasPXpPsJNbEL7Opf0AAFMV6kGNLFkyXuYj29qbNSsGkDI3RCIYzSxxCtUoheLJcTdJLdVXZPwSpK0ngRRik05OYtb-EyDp8v4tfwA34NIwqLJBhP0EkYPcWvoCEZEXkDo6yro_EZQoul3a2vfRh9j4MUknSRhkkaBgkMrxAAwG_dt_0M6OYnosWvfOCDOzmUmSrrtdQDH672xR0_2D9fH_MVp4bnhJqBD4OZ6z12XM9xPXA933V91x0cwTbNQjJDmKqlveC5x73fCG2UzRAx7Y0dbHB8WeT2wlFB1mW5VzrWsa_kvsNs7s3m3dnvk4d6kH0VD7oJv8yG2UNsQNfDs0-kt7XprT9I7-Zj6W170lvfp_df3IYUlrxYxTh8Fu3IzRhifIFjHAU4gfsEj-gh-vZeF_3N56Pf9ka_2xe_ulwuwghGq8t0Ajh6OYYELy37DVzEq-fQTKCFH7_DMYYMzmF-hhzHcZCQklfOz0pIGLFKaT1GcLv983b7_nb7HjSjEtoPKs23dy-sPfnDun673d4BTEltKiqk8eF0dur5cHU6BwdO59foCCtEaXilYWT_bMbonwAAAP__FhonWw==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFunEYUfTZfccXL7lYLgo0iRbvyAyHjiHbDWkCiRJY1GoahmYadcZhhzbaqlI_Yx_5Gf6Cf4i-pBuzdrYptuW54QMy955577-GA48AHVisuxRxCSb_UktDPb14DaxnNG14VrAbNlIZNj7KsFGVQEE1yohicwshkRwsAx4GClaSpNGxI1bA59FCutPpawSnIshyEkUbLDspFwVpcMyrXayYKorkUCjNB8ooVDxDcTRUu36cZSiBFWRbFb0F9rVxaFznmQrNakMrVhgrX8horTTRXmlPlEoVliTVfd-s4_l9_quF9HN9T9za6xSr3sPBIluUw037lISYzmnINZE00p5jKqmLUiOEetBiVpFJsmF3XDfsv7GsujC69Qso0eTnc4KXnPcJfyppRorT6_0ZWW6XZGnevUGGzQB9_QgMrTFCQIciC10vU2dq9avKKU7eFsXVCIIqzVxCvMojfL5dT6yS_jfSncBWnWRJEcQYtvvrCtnCeRO-C5BP8hD7BmECQhpOpdRLFb9BHaHGOedHCOO_i1mRhWcHS7DbUPop_RGEGaRZkUZpFYQqjCwsA4Lfubi6bbH7Giv_K7Dl400OYyqpZC2XP4WIf7PH2_nx5jK8Z0azARNtzsGee_8rxfMfzwfPnnjf3PPsIbNzMBdWYykaYAt877v2ZKy2Nh7DeXpnB7ONiXpiCo4BoqmrPdMxjPsl9h9kLf_aiy_0-fa4G-XfRoJvwaTLMniODdTlaPODerXFv8y_3bu5z73bAvc2de_-B2-DSIM9WCYrexj1yM4EEnaEExSFK4c7BY3KwvqnrrL953PrbQet3-6KP58sgimG8Os-mgOIPE0jR0mB_gLNk9Q5aCFKQgk37J30tF5bjOI7FhWC184vkAsa0lkpNLLjZ_XGz-3az-waKEgEtXBB1KgW7vCelr2WX2t2mSl5pVisYm1_JxPo7AAD__9g5G8Y=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4kIvdgZLkWJ0CBTkQVWZTpsrB5LatQgCgqKolatEpiLlWRsG9CP8K_uBfUq-ZKDU2h6mtui6-cEAL889596jQ8eBF6xVXIoAIknftJLQ108eA9syWnS8LlkLmikNmxFlWRnKoSSaFEQxuIKZuZ1dAjgOlKwiXa1hQ-qOBTBCudLqbQ1XIKtqEkY6LQcoFyXb4pZR2TRMlERzKRRmghQ1Kz9BIMXQ3jLZlqzFP0suFK55wzVcwbfLyZ6LcZFo9TzLUQoZyvM4eQrqbe3StiwwF5q1gtSuNuq4lb9gpYnmSnOqXKKwrLDmzeCA4__5h5q2wPE99VGh91jlHjyayaqaZtq7NMVkRlOugTREc4qprGtGjX_uwb5ZRWrFptl127F_w95wYXwZHVJG5NG0wCPP-wx_JVtGidLqvxtZ9UqzBg-fUGGzwFj_AgErSlGYI8jDxys0vAT3vitqTt0tzK0TAnGSX0CyziF5vlotrJPifWU8Resky9MwTnLY4vs3rIebNH4Wpq_gB_QK5gTCLDpdWCdx8gS9hC0uMC-3MC-GunV6aVnhyuw2JR8n36MohywP8zjL4yiD2a0FAPDb8G9-Ntn8hBX_ldkBeItDmcq6a4SyA7jdF0e8vT_fHeNbRjQrMdF2APa55184nu94Pnh-4HmB59lHYJNmLqjGVHbCNPjesfZrrrQ0GcK6vzeD2cfNvDQNRwXR1fWe6ZjHPMm9wvnSP18Od78vvtaD4n_xYJjwy2w4_xobrLvZ5SfS25v0dv9I7-Zj6e0n0tt9SO_fcBtcGeT1OkXx02REbk4hRdcoRUmEMviQ4Dk5RN_0DdHffD76_WT0h33Ry5tVGCcwX9_kC0DJi1PI0Mpgv4HrdP0MevjxO5Qi6OAKlpeW4ziOpSgR0FvwsNs97N497N4BlULplnChAzjzA7g9W4IDZ8s7668AAAD__1gpEIE=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9FunEYUfTZfccXLrqsFg1eJLCw_EDJOaTesBSRNZFmjYRiaaWDGYYbt0qpSPsK_0h_op_hLqoFkvVWxo9QND0hz59xz5p454zjwmrWKSxFAJOn7VhL67vkzYFtGi47XJWtBM6VhM6IsK0M5lESTgigGZzAzu7NTAMeBklWkqzVsSN2xAEYoV1p9qOEMZFVNwkin5QDlomRb3DIqm4aJkmguhcJMkKJm5QMEUgztLZNtyVr8i-RC4Zo3XMMZPF1O9pyMg0SrV1mOUshQnsfJC1Afape2ZYG50KwVpHa1Ucet_BUrTTRXmlPlEoVlhTVvBgcc_68_1bQFju-pe4U-YZV759FMVtU0086lB5mmPZg9XU6TntzLaIZVrhFtiOYUU1nXjJobce8uZFaRWrFpat127L-wN1wYp0fPlRF5Mi3wxPO-wF_JllGitPr_jqx6pVmDh1AobAYY618hYEUpCnMEefhshYa35V53Rc2pu4W5dUAgTvITSNY5JK9Wq4V1UHyqjKtonWR5GsZJDlt8_Z71cJHGL8P0LfyI3sKcQJhFhwvrIE6eozewxQXm5RbmxVC3Dk8tK1yZ2abk4-QHFOWQ5WEeZ3kcZTC7tAAAfh_-5rPJ5mes-G_MDsBb3JWprLtGKDuAy11xxNu79dU-vmVEsxITbQdgH3v-ieP5jueD5weeF3ievQc274MLqjGVnTANvrev_Y4rLU2GsO6vzcHs_WZemoa9gujqese0z2Me-U7heOkfL4e9PxaP9aD4Jh4MJ_w6G44fY4N1NTt9IL29SW_3r_Ru7ktvP5He7nN6_4Hb4Mogz9cpil8kI3JzCCk6RylKIpTB5wTPyV30Td8Q_c2Xo99PRn-YF725WIVxAvP1Rb4AlLw-hAytDPY7OE_XL6GHn75HKYIOzmB5ajmO41iKEgG9Bbc3N7c3H29vPgKVQumWcKEDOPIDuDxaggNHyyvr7wAAAP__DYgq6w==

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91unEYUvjZPcbQ3u64WDF4lsrB8Qcg4pd2wFpA0kWWNhmFwpoEZhxm2i6tKeQi_Sl-gj-InqQaS3a2KHaVp9mIlDt_PnI9vbBtes0ZxKXwIJX3fSELfPX8GbMNo3vKqYA1opjSsB5RlpSiDgmiSE8XgDKbm7fQUwLahYCVpKw1rUrXMhwHKlVYfKjgDWZajMNJq2UOZIHnF8C2_viXX-FfJhWGJUZIsy57DRcE2uGFU1jUTBdFcCoUHpeIRUyl6esNkU7CmN1O44jXXcAZPF6Ock2H5cPkqzVACKcqyKH4B6kPl0KbIMReaNYJUju73aORvWGmiudKcKocoLEused2nZnt__anGY7M9Vz1o9AmrnF2uU1mW40rbZB9VGs9g-nQxLnryoKJZVjnGtCaaU0xlVTFqvoiz-yDTklSKjUvrpmX_Rb3mwiQ9ZK6MyZNxgyeu-wX9UjaMEqXV_3dk1SnNatyXQmGzwDD_CgMrTFCQIciCZ0vU30fnps0rTp0NzKwDAlGcnUC8yiB-tVzOrYP802R4CldxmiVBFGewwTfvWQcXSfQySN7Cz-gtzAgEaXg4tw6i-Dl6AxucY15sYJb3c-vw1LKCpdltzD6Kf0JhBmkWZFGaRWEK00sLAOD3_t_8JmR9jRW_ZRMf3PluTGXV1kJNfLjcDgf8ZPt8tY9vGNGswERPfJgcu96J7Xq264Hr-a7ru-5kD2zuBxdUYypbYQieu-_9jistTYew7m7MwSb7ZF4Ywt5AtFW1VdrXMZd863C88I4X_bs_5t-aQf5dMuhP-HUxHH9LDNbV9PSR9namve2_2rt-qL3dSHvbz-39B26NS4M8XyUoehEPyPUhJOgcJSgOUQqfGzwju-obXl_99Zer341Wv98XvblYBlEMs9VFNgcUvz6EFC0N9gc4T1YvoYNffkQJghbOYHFq2bZtW4oSAZ0F93d393cf7-8-ApVC6YZwoX048ny4PFqADUeLK-vvAAAA__8OPzxo

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkWK0CBTkwVWZTpsrB5LatQgCgqKolKtEpiTlWRkG9CPyK_uBfUq-ZKDUOh6mJOiy-sGArs45l_fcQ7kuvGVKcykCCCX9qCShH16-ALZhNG94VTAFhmkD6x7lOCnKoCCG5EQzOIGxfTs-BnBdKFhJmsrAmlQNC6CHcm30pwpOQJblIIw0RnZQJkheMXzNL6_JJf5VcmFZYpAky7LjcFGwDVaMyrpmoiCGS6Fxr1Q80FSKji6vDK_5NVO40Qx_4NrIS0Vq_ThTMakKprpjalzxmhs4gefzQc5Rb1u4fJNmKIEUZVkUvwL9qZpRVeSYC8OUINXMdA4o-RvWhhiuDad6RjSWJTa87vx2_b_-1MOGu76n7230BatndxsZy7IcVtru5EGlYQ_Gz-fDokf3Ktph9cw2rYnhFFNZVYzaXc7uVjkuSaXZsLRRDfsv6jUX1unec7v18bPhBs887xH9UipGiTb6_zuybrVhNe5CobEdoK9_QwMnTNAiQ5AtXixRd5NnV01ecTrbwMTZIxDF2RHEqwziN8vl1NnLv1T6p3AVp1myiOIMNvjqI2vhLIleL5L38DN6DxMCizTcnzp7UfwSvYMNzjEvNjDJu7qzf-w4i6Wdbah9FP-EwgzSbJFFaRaFKYzPHQCA37t_-xuR9SXW_JqNAvCmd2Uqq6YWehTA-bbY40fb54tdvGLEsAITMwpgdOj5R67nu54Pnh94XuB5ox2wvR9cUIOpbIQl-N5u7-4jYTOETXtlDzbaJfPCEnYKoqmqrdKujr3k2w6Hc_9w3r37Y_pUD_Lv4kF3wm-z4fApNjgX4-MH0tva9Db_Su_6vvS2A-ltvqb3H7g1Li3ydJWg6FXcI9f7kKBTlKA4RCl8TfCE3EXf8rrorx-PfjsY_W5e9O5suYhimKzOsimg-O0-pGhpsT_AabJ6DS388iNKEDRwAvNjx3Vd19GUCGgduL25ub35fHvzGagU2ijChQngwA_g_GAOLhzML5y_AwAA__85VVCz

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkWK0CBTkwXWZTpsrB5LatQgCgqKolCtFpiLl2RkG9CPyK_uBfUq-ZCDVOh6mpMuy-cGArs45l_fcI_o-vGWN5kpGMFf0Y6MI_fDyBbA1o0XLRckaMEwbWHUoz8tQDiUxpCCawQkM7dvhMYDvQ8kq0goDKyJaFkEH5droTwJOQFVVL4y0Rjkok6QQDF_zy2tyiX9WXFqW7CWpqnIcLku2xg2jqq6ZLInhSmrcKZUPNFXS0dWV4TW_Zg1uNcMfuDbqsiG1fiyzboXhVAmsDTH_gN0w1ZSscUNqLHjNDZzA82kv56gzfb54k-UohQzleZy8Av1JTGhTFphLwxpJxMQ4_xr1izsG14ZTPSEaqwobXrtt-eEfv-v-dflhoO9t9AWrJ3f7HKqq6lfabvRBpX4Phs-n_aJH9yo6zye2aU0Mp5gqIRi1SZjcBWFYEaFZv7RpWvZv1GsurdOd53brw2f9DZ4FwTf0K9UwSrTR_92R9UYbVmMXCo3tAF39EQ28eYpmOYJ89mKB3D0wuWoLwelkDSNvj0Cc5EeQLHNI3iwWY2-v-FLpnubLJMvTWZzksMZXH9kGztL49Sx9Dz-i9zAiMMvm-2NvL05eonewxgXm5RpGhat7-8eeN1vY2frax8kPaJ5Dls_yOMvjeQbDcw8A4Ff3b38DsrrEml-zQQTB-K5MlWhrqQcRnG-LHX6wfb7YxTeMGFZiYgYRDA6D8MgPQj8IIQijIIiCYLADtt8Hl9RgqlppCWGw29tdMTZD2Gyu7MEGu2ReWsJOQbZCbJV2dexHvu1wOA0Pp-7db-OnelD8Lx64Ez7OhsOn2OBdDI8fSO_Gprf9W3pX96V305Pe9mt6_4Jb4coiT5cpil8lHXK1Dyk6RSlK5iiDrwkekbvoW56L_urb0d_0Rt_Ni96dLWZxAqPlWT4GlLzdhwwtLPY7OE2Xr2EDP32PUgQtnMD02PN93_c0JRI2Htze3NzefL69-QxUSW0awqWJ4CCM4PxgCj4cTC-8PwMAAP__iZZmtA==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysksuO0zAUhvd5irMrIBz1Qi9M1UUJBlVqM0OTVrOzXOdEGByb-jjD8GC8AE-G3CBmkxkEYhfFv78_5zthDI7oSTt7BZlTn72T6uPbN4D3qE6tNhV6CEgB7rpUkhS8hEoGeZKEsIJBPB0sARiDCmvZmgB30rR4BV1UU6CzgRW4uu6NyTa4S1TbCu-FR-WaBm0lg3aWBFp5Mlg9AXD2ct2j8xV68clpS8LoRgdYwWzSe2fRDZJtD0XJ91Dwstzk74HOJlW-OgltA3orTRpiu_Duq6Agg6agFaWShKtF0M3FABv9-E79CthoSI8W_cpS-uBo4Oq6n_Tb0pOkfgeD2aQfuniUGIelNJY2MmgllDMGVdxI-rCQQS0NYT86-Bb_hd5oG013zimWTPsLpsPhH_i186gkBfp_n0zfKGAjLj8FiThA9_4vCpJsz9clh4J_OPA84_ClPRmtUsIz7Db5cb09cBjBbn3bPb4ejyeT-Xg4mS2mr-bz6WI4h02e7fmO5yWMoCjX-xJGyyThtzfb9SaHZ9c35Uvg-fE5FHzLsxJewLv99Q4Iz8uEMcYSwnOLViEjjOLjSfIzAAD__-I1Tr0=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfJkWy0CGQEmOqynTZXDiQ1bREEBCVRK1eZTEVKszcMKPYNftxv7Af2KfmSgVLiuKuSouvmBwO6Ovcc3cNzadtwzirFpfBgIbN3laTZ26dPgG1Ylta8zFkFmikNTYdCKMYJ5FTTlCoGpzA0b4dzANuGnBW0LjU0tKyZBx2UK63el3AKsih6YbTWsoVykbMNqVgm12smcqq5FIowQdOS5Q8QSNG2V0xWOavIT5ILRUq-5hpO4fGst-ekG2SxfBknOIIYJ0kQPgf1vpxkVZ4SLjSrBC0n2qiTSv5MlKaaK80zNaGKyIJovm4dsN2__lT9Ftiuo-4VusGqyZ1HQ1kU_Ux7lx5k6vdg-HjWT3pyL6MZVk2M6JpqnpFMliXLzIlM7g5kWNBSsX5qXdXs37CvuTBOd54rI_KoX-CR43yGv5AVy6jS6r_7ZLVVmq1JGwpFzABd_QsE0CLCfoIh8Z8scbtbk6s6LXk22cAIHVEIwuQEwlUC4cvl0kJH6U2le1qswjiJ_CBMYEOu3rEtnEXBCz96Az_gNzCi4MeLsYWOgvApfg0bkhKeb2CUtnU0niPkL81sffJB-D1eJBAnfhLESbCIYXiBAAB-bf_Nb0CbH4niv7CBB451V85kWa-FGnhwsS92-MH--fIQXzGqWU6oHngwmDruie24tuOC43qO4znO4ABs9oOLTJNM1sI0uM6h9luutDQZInp7ZT5scNjMc9NwUBB1We6ZDnnMku8VpjN3Omvf_WZ9rQfp_-JB-4VfZsP0a2xAl8P5A-ndmvTWn6S3uS-925701rfp_QjXkMIgn60iHDwPO2Qzhgg_wxEOFziG2wSP6F30TV8b_ebz0d_2Rv9w3vMAv7qVado9NZtpoaPazIjG4McQ46XhoBakFtQWNPAsWr34eMesf-i--g5HGFI4hdkcIfz6bOkHIYxWZ4kFODwf35J-03E1c2Tbto24EKyyzS0Po6ySSo0RXO_-uN59uN59AJVRAdtPKptvb64D8-Z3c6bXu90NIJNC6YpyoT04nh67Hlwcz8CG49klOoAVvNSsUjAyV9kY_R0AAP__AMJsXQ==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk-Fu0zAQxz_PT3Hf0qIl6jRtqlb1QxYCCmRplXgTE0KWm1yEWWIz33VsD8YL8GQoLWISyoZA-2r_7_e_-58dhnCFnoyzZ5C4-sY7XX9-fQ54j_Vma7oGPTASw91eJUSVSmg0640mhCUEw22wAAhDaLDV247hTndbPIO91BDTbQdLcG07KtNbdjupsQ3eK4-163u0jWbjLCm0etNh8wzA2V25R-cb9OqLM5ZUZ3rDsITT49Ga-X6QJL-sZFpClUqZFW-Bbruo9s1GGcvore4iHtyVd98UsWZDbGqKNCnXKjb9LoHw6Md3Go8gPJrRk0a_tBQ9ZhS4th0n_U7pWdJ4BsHp8Th0_iRxGJaiwbTXbGpVu67DethI9LiQoNUd4Tia_Rb_h94bOyS9z5wGk5Nxg5PZ7C_81nmsNTG9XMv0QIy92j0KUsMA-_N_MBBJmcYyBRmf5-nub0UUMUzEgYaskHMoVhKKyzw_FAfJqqhkGWeFBFZfb_AB1mV2EZfX8D69homGuEqmYroQIs6Hhv9gZsW7NJFQyVhmlcySCoKPn4KFEOmHdR5nBUxWa3kIaXE1hSrNB-0reFOuLoAiXogwDENBtbbA4mcAAAD__0DBVUE=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xewcA6FgI0gQJPAiTYUigOEGtWJ0R4yoUcqGImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wFXAfzEAOaL-_fAT2SqTrraoogxAK7IZVl66KEGgUrZIIFTNLXySWAUlBTg50T2KHr6AKG6HCmJaJnNGKD19sOnZUnHRrNFHfWJFCF5uE-hs7Xo7BI953DODAtC28dLCA0zWgaOwl91PqaHnUkE9qWfI2pnzV5rBzVbwCC78cjhVhT1F-D9aydba3AAs5ORmfOBznXy7t1WXyCdVGWN6sPwFuXm1hX2nqh6NHlktp1DN80C4plsYZz5ORDbNtbVfMf33lcq5rP-NWiX1nOXxxNQtOMk35bepM07mBydjIOPX-VmC7LeSptUazRJjhH_UbkLw8yadAxjaMldvQv9Nb6ZHpwzqnkdLzgdDb7A78JkQyy8P_7ZX5ioVb3S8E6XWA4_4uCrPh8u7y6WcHRx9vyGIrVZgqbq-VdsYaj-fQyU0qprB_gDA77_WH_fNg_w9H8eJr9DAAA___03lZf

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexkA6FgI0gQJPAiTYUigOEGtWJ0R4ypUcuWImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wl3ATzNQY0n9--AXogs-2sqymCEAvsh1SWrcsKahTcIhMsIE9f8ysApaCmBjsnsEfX0SUM0eFMS0TPaMQGr3cdOiuPOjSaKe6tSSATrViDbhQV6VPnMA5Ey8I7BwsITTOaxk5CH7W-pgcdyYS2JV9jamdNHreO6lcAwffjkUKsKeovwXrWzrZWYAHnp6MzF4Oam-X9uio_wLqsqtvVO-CdK0yst9p6oejRFZLadQzfNAuKZbGGC-RkQ2zbO1XzH995XKqaz_jFol9ZLp4d5aFpxkm_Lb1KGneQn5-OQy9eJKbLcpFKWxRrtAnOUb8PxfOD5A06pnG0xI7-hd5an0wPzjmVnI0XnM1mf-A3IZJBFv5_v8yPLNTqfilYpwsM539RkJUf75bXtyuYvL-rTqBcbaawuV7el2uYzKdXmVJKZf0AZ3A8HI6Hp-PhCSbzk2n2MwAA__-yYVWK

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9GO0zgUfZ58xVVf2lk1VToj0KijeSjFg7Jb0lESEAghy3Ec8NaxO7aTbbraz9of2C9bOYG2iLSIZelDpdyce47PybHvw2umDVdyBgtF11oR-vH5M2BbRrOKi5xpsMxYqDuU5yUohZxYkhHD4A6G7u3wFsD3IWcFqYSFmoiKzaCDdjNsNZGGUMuVxI8VEdw2WBXYMF1z6oio5pZTInqpNPtQCaI7Rm6seRRwB6ooetGksqqFcpmzLdaMqrJkMidO3WAmSSZYfoZAyXZdM6VzpvHvikuDBS-5hTt4et27c9NFs1i-SlIUQ4LSNIxegHkUE6rzDHNpmZZETKxTx1r9gY0llhvLqZkQ49KwvGwz9af__G36Q_WngTkp9AlrJoeMhqoo-pn2KZ1l6s9g-PS6n_TmJKMzayZOtCSWU0yVEKztw-TwQYYFEYb1U1tdsf_CXnLpku4yN07kSb_AkyD4Bn-hNKPEWPP_Hdk0xrISt6Uw2Bno5t8h4C1iNE8RpPNnS9Te1smmygSnky2MvAsCYZTeQLRKIXq1XI69i-zTpHtarKIkjedhlMIWb9asgYc4fDmP38Jv6C2MCMyTxeXYuwij5-gNbHGGeb6FUdbOvctbz5svnbc--TD6FS1SSNJ5GiZpuEhg-M4DAPiz_Xe_Aak_YMN3bDCDYHwYUyWqUprBDN7thx1-sH9-f4zXjFiWY2IHMxhcBdMbP5j6wRSC6SwIZkEwOAK7-8EltZiqSrqFaXCs_ZEbq1yHsG027mCD42Weu4WjgayE2DMd87hLvle4up5eXbfv_hr_aAbZT8mgPeH3xXD1IzF474e3Z9rbuPZWX7W3PtXepqe91ef2foGrceGQ96sYhS-iDllfQozuUYyiBUrgc4NH5FB9t9dWv_529Zve6p_3u3N-N-uvDGtWnLK867G8Wfd4LtZfutWs6PPbjKrzvnanfaE3D8t5GMFo9ZCOAUWvLyFBS4f9Be7j1UvY3Xq-7_ueoUTCzvs3AAD__wO_dPA=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgbLkBO0CBzkwVWZQpsrB5JatCgKgqKoljNFOiSlWRn2WfuBfdlAqXVcVHbRdfWDAV2dew7P0aHvw2umDVdyAaGiG60I_fj8GbAdo3nNRcE0WGYsND3K81KUQUEsyYlhcANj93Z8DeD7ULCS1MJCQ0TNFtBD-xm2mkhDqOVK4vuaCG5brEpsmG44dURUc8spEYNUmn2oBdE9IzfW3Au4AVWWg2hSW9VBuSzYDmtGVVUxWRCnbjCTJBesOEGgZLeumdIF0_h3xaXBglfcwg08vRzcueqjCVev0gwlkKIsi-IXYO7FjOoix1xapiURM-vUsVZ_YGOJ5cZyambEuDQsr7pM_fk_f5vhUP15YI4KfcKa2WNGY1WWw0z7lE4yDWcwfno5THp1lNGZNTMnWhHLKaZKCNb1Yfb4QcYlEYYNU1tds__CXnHpku4zN07kybDAkyD4Bn-pNKPEWPP_Hdm0xrIKd6Uw2Bno598h4IUJWmYIsuWzFepu62xb54LT2Q4m3hmBKM6uIF5nEL9arabeWf5p0j-F6zjNkmUUZ7DD2w1r4S6JXi6Tt_AbegsTAss0PJ96Z1H8HL2BHc4xL3Ywybu5d37tecuV8zYkH8W_ojCDNFtmUZpFYQrjdx4AwJ_dv_uNSPMBG_7ARgsIpo9jqkRdSTNawLv9sMeP9s_vD_GaEcsKTOxoAaOLYH7lB3M_mEMwXwTBIghGB2B3P7ikFlNVS7cwDw61P3JjlesQtu3WHWx0uMwLt3AwkLUQe6ZDHnfJ9woXl_OLy-7dX9MfzSD_KRl0J_y-GC5-JAbv_fj6RHtb1976q_Y2x9rbDrS3_tzeL3ANLh3ydp2g6EXcI5tzSNAtSlAcohQ-N3hCHqvv9rrqN9-ufjtY_dN-H5zf7eYrw5qVxyw_DFjebgY8l5sv3WpWDvltJ_VpXw_HfaE3d6tlFMNkfZdNAcWvzyFFK4f9BW6T9Utorz3f933PUCKh9f4NAAD__wOudO4=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgbLkBO0CBzkwXWZQpsrB5JatCgKgqKoljNFOiSlSRn2WfuBfdlAqXVcVHbRdfWDAV2dew7P0aHvw2umDVdyAStFt1oR-vH5M2ANo1nFRc40WGYs1D3K8xKUQk4syYhhcANj93Z8DeD7kLOCVMJCTUTFFtBD-xm2mkhDqOVK4vuKCG5brApsmK45dURUc8spEYNUmn2oBNE9IzfW3Au4AVUUg2hSWdVBucxZgzWjqiyZzIlTN5hJkgmWnyBQslvXTOmcafy74tJgwUtu4QaeXg7uXPXRrNavkhTFkKA0DaMXYO7FjOo8w1xapiURM-vUsVZ_YGOJ5cZyambEuDQsL7tM_fk_f5vhUP15YI4KfcKa2WNGY1UUw0z7lE4yDWcwfno5THp1lNGZNTMnWhLLKaZKCNb1Yfb4QcYFEYYNU1tdsf_CXnLpku4zN07kybDAkyD4Bn-hNKPEWPP_Hdm0xrISd6Uw2Bno598h4K1itEwRpMtna9Td1tmuygSnswYm3hmBMEqvINqkEL1ar6feWfZp0j-tNlGSxsswSqHBuy1r4S4OXy7jt_AbegsTAstkdT71zsLoOXoDDc4wzxuYZN3cO7_2vOXaeRuSD6Nf0SqFJF2mYZKGqwTG7zwAgD-7f_cbkfoDNvyBjRYQTB_HVImqlGa0gHf7YY8f7Z_fH-I1I5blmNjRAkYXwfzKD-Z-MIdgvgiCRRCMDsDufnBJLaaqkm5hHhxqf-TGKtchbNudO9jocJnnbuFgICsh9kyHPO6S7xUuLucXl927v6Y_mkH2UzLoTvh9MVz8SAze-_H1ifa2rr3VV-2tj7W3HWhv9bm9X-BqXDjk7SZG4YuoR9bnEKNbFKNohRL43OAJeay-2-uqX3-7-u1g9U_7fXB-d9uvDGtWHLP8MGB5tx3wXGy_dKtZMeS3nVSnfT0c94Xe3K2XYQSTzV06BRS9PocErR32F7iNNy-hufZ83_c9Q4mExvs3AAD__wOddOw=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkBO0CBzkwXWZQpsrB5JatCgKgqKoljNNOiTlWR72WfuBfdlAKXM8lHbQZc1DAF2dew7P8RHDEN4zbbiSE5gputSK0K-vXwHbMlrUXJRMg2XGwqZDBUGGciiJJQUxDG6g7972rwHCEEpWkVpY2BBRswl00G6GrSbSEGq5kvi-JoLbBqsKG6Y3nDoiqrnllAgvlWZfakF0x8iNNfcCbkBVlRdNaqtaKJcl22LNqFqtmCyJUzeYSVIIVp4gULJd10zpkmn8q-LSYMFX3MINvLz07lx10czm77IcpZChPI-TN2DuxYjqssBcWqYlESPr1LFWv2FjieXGcmpGxLg0LF-1mYbjv_40_lDDcWSOCj1gzegxo76qKj_TPqWTTP4M-i8v_aRXRxmdWTNyoitiOcVUCcHaPowef5B-RYRhfmqra_Zf2FdcuqS7zI0TeeEXeBFFT_BXSjNKjDX_35FNYyxb4bYUBjsD3fw7BIJZiqY5gnz6ao7ar3W0rgvB6WgLg-CMQJzkV5AsckjezefD4Kx4mHRPs0WS5ek0TnLY4vWSNXCXxm-n6Uf4BX2EAYFpNjsfBmdx8hp9gC0uMC-3MCjaeXB-HQTTufPmk4-Tn9Eshyyf5nGWx7MM-p8CAIDf2__ur0c2X7DhO9abQDR8HFMl6pU0vQl82g87fG___PkQrxmxrMTE9ibQu4jGV2E0DqMxRONJFE2iqHcAdt8Hl9RiqmrpFsbRofZXbqxyHcK2WbuD9Q6XeekWDgayFmLPdMjjPvK9wsXl-OKyfffH8LkZFD8kg_aE3xfDxXNiCD73r0-0d-fau15-U1_NqmMF3nkKvF7-0-ADYLWE20WK4jdJB9KsOocU3aIUJTOUwcMRmkF9uuI7b8VP-2qcr_obW5tjphqPqdrjqcEbXDnkv5xtfL62A_JEIN613WC9fLwKnF57FWyevgqa4zmhD3fzaZzAYHGXDwEl788hQ3OH_Qlu08VbaK6DMAzDwFAioQn-DgAA__-rKISy

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2zYUhq_DpzjQjZ3BEmSl6VIHuVAcddCmyoHFBC2KgqAoquVKkQlJpcmGPdZeYE82UGoTY1CzdUh9YcDn_Of_qY9HDkO45MYKrVaw1uyj0ZR9ODsFfstZ3QvZcAOOWwc3owqhKsPQUEdrajmcwMx3Z8cAYQgNb2kvHdxQ2fMVjNKxRpyhylLmhFbkuqdSuDuiW2K5uRHMGzEjnGBUTloZ_r6X1IyOwjp7LeEEdNtOqmnv9CAVquG3xHCmu46rhvp0S7iiteTNIwZaDeOGa9NwQ37VQlkiRSccnMDzg8mZoxHNuriocLaFKsM4L38Cey0jZpqaCOW4UVRGzqcToz8R66gT1glmI2o9DSe6gWm4_OtPOw01XMb2q0GftTZ6YDTTbTvtdE_pUadpBrPnB9OmR1919A9rIx_aUScYYVpKPuxD9HAhs5ZKy6etnen5_3HvhPKkR-bWhxxOBxzG8b_4t9pwRq2zT3dke2cd78iwFJb4Bxjr3xCA1tssxRng9LTIhrc1uuprKVhUwxzt1XC62RRQbjCUF0WxQHtGfxIN5CU-GqqXeZX7yS8KOMtephcFhl6J637AJpr5_gLtrTdlhbdpXmKoydVHfgfn2_xVun0Dv2RvYD76ptXaa_PyLHsNNamJaG5hXg91tH-MUFp4FFOnzcufszWGCqc4r3C-rmD2FgEA_D58-09Ab94TK37jwQqWi4cy07LvlA1W8Pa-ODTq4P73u1294dTxhlAXrCBI4iQJl0kYJ7A8Wh08WyUvosMfn704SIKdGf9WCcUcYbpXfi7ZaX4Q1mm_d8TdXfnTBbujovnHeRXtBhEZ7pyQXbHqpbzPiHca_k_jS325jOOh88fiEUTxf0E03Nt3xBR_G6bkKTF9ZoTezY4Ryl6fF2lewnxzjheQlZf7UGWFX7kf4OV28wrqYxSGYYgsowpq9HcAAAD__8tkFIY=
