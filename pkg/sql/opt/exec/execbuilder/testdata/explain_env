# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O20wQxa_ZpzjyDcmn-IuT3CBHSDXBqG6Dg2yXghBare2FbNl40_WaOqkq8RB5Qp6ksvnTCKm0vcAXlmbm_I5nvLO2jVOuS6EKFxOV3WjFsvnhAXjNs7QSMucahpcGtw8qQmwbmiudc02_KFGUVIqFMJizEmbOkfMrVkmDWyYr7mKv0fOCpZLTtbhes-uW-p1cFY1eLY1YiDXXtCo5nYvSqGvNFuW_UItKGpEpSUvDzB9IqTImhVnRJ4ucLpk2wghV8JyKIuc1LTP2WtuxnyAXpSm_SuxDXV2NAdt-KWSVUc0Xb3lmlBZr_oojmUS-l_hIvIOpj2WVSpH9X6NDdhiCMNlDOEsQfppOe2Qnfcw8RJNZGCeRF4QJarq84SucRMGxF53jo3-ODoMXT7o9shOEh_4ZappSkdfopE_5I-84mJ7DWmqxYHplocN6SLukOybEmyZ-9LKnIPzgTxLEiZcEcRJMYuxeEAD43r6bx8qUrBZFabm4eE62BWY9x5e9Lb3mzPCcMmO5sIbOYM92BrYzgDNwHcd1HGtL3Px5UWSGZqoqGmDgOFvldoVosw1mteSN3zZcVFI-g9uYVt9-GQ5Hg-Gorf3o_fVs6ZvM1rbyduORy90xIf7ZydQLQnRmJ0kPfnjaRexPm2P-D0fR7Bg1Pr_3Ix8p9jEaE9u2bdJekvrd40oR3G8295u7-80dMlWURjNRGBf9YX_g4qI_go3-6JL8DAAA___Rs0vw

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O20wQxa_ZpzjyDcmn-IuT3CBHSDXBqG6Dg2yXghBare2FbNl40_WaOqkq8RB5Qp6ksvnTCKm0vcAXlmbm_I5nvLO2jVOuS6EKFxOV3WjFsvnhAXjNs7QSMucahpcGtw8qQmwbmiudc02_KFGUVIqFMJizEmbOkfMrVkmDWyYr7mKv0fOCpZLTtbhes-uW-p1cFY1eLY1YiDXXtCo5nYvSqGvNFuW_UItKGpEpSUvDzB9IqTImhVnRJ4ucLpk2wghV8JyKIuc1LTP2WtuxnyAXpSm_SuxDXV2NAdt-KWSVUc0Xb3lmlBZr_oojmUS-l_hIvIOpj2WVSpH9X6NDdhiCMNlDOEsQfppOe2Qnfcw8RJNZGCeRF4QJarq84SucRMGxF53jo3-ODoMXT7o9shOEh_4ZappSkdfopE_5I-84mJ7DWmqxYHplocN6SLukOybEmyZ-9LKnIPzgTxLEiZcEcRJMYuxeEAD43r6bx8qUrBZFabm4eE62BWY9x5e9Lb3mzPCcMmO5sIbOYM92BrYzgDNwHcd1HGtL3Px5UWSGZqoqGmDgOFvldoVosw1mteSN3zZcVFI-g9uYVt9-GQ5Hg-Gorf3o_fVs6ZvM1rbyduORy90xIf7ZydQLQnRmJ0kPfnjaRexPm2P-D0fR7Bg1Pr_3Ix8p9jEaE9u2bdJekvrd40oR3G8295u7-80dMlWURjNRGBf9YX_g4qI_go3-6JL8DAAA___Rs0vw

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lFFvqzYUx5_rT3HEyyUTLCR5qYiuNG6us7GlpAJ2d6uqsgw4jVeCM9swyDSp2mfI4z5dPskEadOobbrtoTwg-Zz__3CO-dm2DV-YVFwULkxEeicFTZefPwGrWZqUPM-YBM2UhmqvQsi2QTIhMybJr4IXiuR8xTUsqQK9ZJCxBS1zDRXNS-bCeatnBU1yRjb8dkNvO9cpuShavVhrvuIbJkmpGFlypcWtpCv1f1yrMtc8FTlRmup_ceYipTnXDXkskZE1lZprLgqWEV5krCYqpW-1HeEYMq60-i2HjyAWizGAbT8X0lKL9osVS7WQfMPeqIgmIfZiDLH3aYZhXSY5T7-twURnFPwgPodgHkPw82xmobPkIbJfTeZBFIeeH8RQk_Uda-Ay9C-88Ap-wldgUvCiSc9CZ37wGX-FmiSEZzWYyWN86l34sysw1pKvqGwMMKkFSQ_1xgh5sxiHz3vygx_xJIYo9mI_iv1JBB-uEQDAH927fYxU5OWqUIYL14dgl6DGYX1jHeklo5plhGrDBWPoDM5tZ2A7A3AGruO4jmMcidud50WqSSrKojUMHOco3SFEWhp0s2ZtvWNzUeb5wXhsk-L3p4LD0WA46nJ_Wv95tuRdZutaeb_x0M2H8ev0NS195Qv6qlP0Na_QVz5SdqRb3JGKSLYgNUznIfa_D_baqgchnuIQBxMcHXAz6RO8Dan28Fan4S0tqE7C27wKb7cD-OvlzPMDMOeXsQU4-NKDCM9a7TcwDecXUFvQwC8_4BBDAh9hNEa2bduIFwWTdnfNmakUSvUQ7LZ_77b3u-09dPdI8yJSf_dwDtvMX-1_2G23D4JUFEpLygvtQn_YH7hw3R-BDf3RDTqSLXiumVRgalmyHvonAAD___HNtvk=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0U89O20wQP7NPMfIF55P9yYELSsTBBCO5NQ6KXQRCaLW2J2TLZjfdXYOTqhIPkWOfjiepbCCNkKDtAR8sz_z-eGZ3xvfhHLXhSg5gpMpbrVg5Oz4CbLAsai4q1GDRWLh7YhHi-6BR6Qo1_aq4NFTwObcwYwbsDKHCKauFhTsmahzAQctHyQqBdMVvVuymU71FV7Llq4Xlc75CTWuDdMaNVTeazc2_qOa1sLxUghrL7B-UQpVMcLukLxYVXTBtueVKYkW5rLChpmTvlZ1FOVTcWPNNwCGo6XQI4Puviay2qv3jHZZWab7CdxzJaBKFeQR5eJREsKgLwcv_G3DJDoM4zQ8gHeeQfkkSj-wUz5mnaDROs3wSxmkODV3c4hLOJvFpOLmEz9EluAzCbNTzyE6cHkcX0NCC8qoBt3jJn4SncXIJzkLzOdNLB1zmQdEjvSEhYZJHk9c1xemnaJRDlod5nOXxKIPdKwIA8L17t49TKlHPpXEGcLVJdgBzNvG1t8XXyCxWlFlnAM5e0D_wg74f9CHoD4JgEATOFrk9eS5LS0tVy1bQD4ItuBsh2k6DXS6w9dsWy1qIjXBbptX9b8O9_f7efof98P66t-JDeutK-bj2yPXukJDo4iwJ4xTc8VnuQZSe9yCLkvaa_4OTyfgUGggzUBK9py97r4bE932fcClR-92au6VWxvQIPK5_Pq4fHtcP0O1RA1fMHCqJ129A9l510PoZmnJhURtwra6xR34FAAD__5mqZGQ=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkdFu2jAYha_rpzjqTcPUrJqQpgrUizQ1W7YQUOJ1RVVlmcSAR4iZ7USEqz4ET8iTTJRxsWrqtEtb33f8-_y-j3tprNJVD6HOl0aLfHF3C7mR-bRWZSENnLQOzZEiJKMMRmpTSMN_aFVZXqqVcrjBx24f8H0Ucibq0qERZS17uCa-D1mJaSn5Vs23Yv7iYSEs3EK-xnV14PXaqZXaSsNrK_lCWafnRqzs_1irunQq1yW3Trh_mKXORalcy08RBV8L45RTupIFV1UhN9zm4q2xD80Uyjr7s8QN9Gz21zpE7fThxUbmThu1lW8kkjClAaNgwW1Msa6npcrft_DIWY0oYddIRgzJtzi-JGfN75vjKRwlGUuDKGFo-XopW4zTaBikE3ylE3g1gizs_MnNlrzhRs74BoNRSqNPyZFtOkjpgKY0CWl2GmLjiYMeJXf0AS1vuCo28JpT7CAYRvEE52ujVsK05_DqSzQd0ukTEsSMpq-_FCVfaMiQsYBFGYvCDBePTxd9QujDOA6iBN5ozC5Bk_sOMhof2HcYpKMhWnz_TFOKGjfo9onv-z55WVRLsN_t9rvn_e4Zua6sM0JVroerDz08XnXh46r7RH4FAAD___Qz9qQ=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkdFu2jAYha_rpzjqTcPUrJqQpgrUizQ1W7YQUOJ1RVVlmcSAR4iZ7USEqz4ET8iTTJRxsWrqtEtb33f8-_y-j3tprNJVD6HOl0aLfHF3C7mR-bRWZSENnLQOzZEiJKMMRmpTSMN_aFVZXqqVcrjBx24f8H0Ucibq0qERZS17uCa-D1mJaSn5Vs23Yv7iYSEs3EK-xnV14PXaqZXaSsNrK_lCWafnRqzs_1irunQq1yW3Trh_mKXORalcy08RBV8L45RTupIFV1UhN9zm4q2xD80Uyjr7s8QN9Gz21zpE7fThxUbmThu1lW8kkjClAaNgwW1Msa6npcrft_DIWY0oYddIRgzJtzi-JGfN75vjKRwlGUuDKGFo-XopW4zTaBikE3ylE3g1gizs_MnNlrzhRs74BoNRSqNPyZFtOkjpgKY0CWl2GmLjiYMeJXf0AS1vuCo28JpT7CAYRvEE52ujVsK05_DqSzQd0ukTEsSMpq-_FCVfaMiQsYBFGYvCDBePTxd9QujDOA6iBN5ozC5Bk_sOMhof2HcYpKMhWnz_TFOKGjfo9onv-z55WVRLsN_t9rvn_e4Zua6sM0JVroerDz08XnXh46r7RH4FAAD___Qz9qQ=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMkdFu2jwYho_rq3jVk4ZfzV9NSFMF6kGami1bGlDidUVVZZnEgEeIme1EhKNeBFfIlUzAONg0sR3aep_n-159vo8naazSVQ-hzhdGi3z-cA-5lvmkVmUhDZy0Ds0xRUhGGYzUppCGf9OqsrxUS-Vwh_fdPuD7KORU1KVDI8pa9nB7QGQlJqXkGzXbiNkBxB30dPpHRFfE96FXTi3VRhpeW8nnyjo9M2JpMRcWbi7_hVrWpVO5Lrl1wv2FLHUuSuVaflIUfCWMU07pShZcVYVcc5uL6oxmX7VQ1tnv5Zl-onZ6P7GRudNGbeQZIwlTGjAKFtzHFKt6Uqr8_xYeuagRJewWyZAh-RLH1-Si-flzfIXDJGNpECUMLV8tZItRGj0G6Rif6RhejSALO7_mpgvecCOnfI3BMKXRh-SYbTpI6YCmNAlpdlpi7Yk9HiUP9Bktb7gq1vCak3YQPEbxGJcro5bCtJfw6ms0HdLpExLEjKa_V4qSTzRkyFjAooxFYYarl9erPiH0eRQHUQJvOGLXoMlTBxmN99n_MEiHj2jx9SNNKWrcodsnvu_75HColmC33e62b7vtG3JdWWeEqlwPN-96eLnpwsdN95X8CAAA__-gpvcG

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8kdFu2jwYho_rq3jVk4ZfzV9NSFMF6kGami1bGlDidUVVZZnEgEeIme1EhKNeBFfIlUzAOFhVcWjrfZ7v_fT5Pp6ksUpXPYQ6Xxgt8vnDPeRa5pNalYU0cNI6NMcUIRllMFKbQhr-S6vK8lItlcMdPnf7gO-jkFNRlw6NKGvZw-0BkZWYlJJv1GwjZgcQd9DT6YeIrg6MXjm1VBtpeG0lnyvr9MyIpT1P-v47cFmXTuW65NYJZzEXFm4uPyZLnYtSuZafFAVfCeOUU7qSBVdVIdfc5qI6o9lXL5R19nd5pqmond5PbGTutFEbecZIwpQGjIIF9zHFqp6UKv-_hUcuakQJu0UyZEh-xPE1uWj-_hxf4TDJWBpECUPLVwvZYpRGj0E6xnc6hlcjyMLOv7npgjfcyClfYzBMafQlOWabDlI6oClNQpqdSqw9scej5IE-o-UNV8UaXnPSDoLHKB7jcmXUUpj2El59jaZDOn1CgpjR9P1KUfKNhgwZC1iUsSjMcPXyetUnhD6P4iBK4A1H7Bo0eeogo_E--x8G6fARLX5-pSlFjTt0-8T3fZ8cDtUS7Lbb3fZtt31DrivrjFCV6-HmUw8vN134uOm-kj8BAAD__4o392g=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkcFu2jAAhs_1U_zqpWFqVk1IUwXqIU3Nli0NKPG6oqqyTGLAI8TMdiLCqQ_BE_IkEzAOm7ZOO9r6vv__Lfs-HqSxSlc9hDpfGC3y-d0t5Frmk1qVhTRw0jo0R4qQjDIYqU0hDf-mVWV5qZbK4Qbvu33A91HIqahLh0aUtezh-qDISkxKyTdqthGzg4gb6On0j4quDo5eObVUG2l4bSWfK-v0zIil_V9zWZdO5brk1gn3D9v3UepclMq1_JRS8JUwTjmlK1lwVRVyzW0uKsyFhZvLv4wolHX2e_lKn6id3jc2MnfaqI18JZGEKQ0YBQtuY4pVPSlV_raFR85qRAm7RjJkSL7E8SU5a37eHE_hMMlYGkQJQ8tXC9lilEb3QTrGZzqGVyPIws6v3HTBG27klK8xGKY0-pAc2aaDlA5oSpOQZqcRa0_s9Si5o49oecNVsYbXnGIHwX0Uj3G-MmopTHsOr75E0yGdPiFBzGj6-5Oi5BMNGTIWsChjUZjh4un5ok8IfRzFQZTAG47YJWjy0EFG4z37BoN0eI8WXz_SlKLGDbp94vu-Tw4f1RLsttvd9mW3fUGuK-uMUJXr4epdD09XXfi46j6THwEAAP__tir3yg==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUkEFvGjEQhe_-Fe_YVnUVoAk0KIft1pWQYJPCBuVmGe8A05o12LMo5ddXNOqlqqhyG2m-783oaY0lpcyxvUUZ_Y8Und9--Qx6Jr_qODSUIJQFxxdKqYWpkSimhpL9HrnNNvCOBXe4GYwBrdHQ2nVBcHSho1uMlNag1q0C2RNvTm7z28PWZciW_sZje-bjXnjHJ0q2y2S3nCVuktvl11i7Lgj7GGwWJ_8xQ_QusPy0fyIau3dJWDi21FhuG3q22btLb5-baThLPgTcIa7X_6zDdRLPF4_kJSY-0YVEVc5NURsszLdHU5UG-24V2H_IdMBsUi2L6aNBD7Pi6WX81O8PBsP-1eBmdP1xOLweXQ0xqcq5mZmqRg-LupjX6I2VMk8P02JS4c39Q_0eplq-xcJMTVnjHb7O72fIdBgrrbVWmQ4dtZ50pkBezhv1KwAA__8rjrxH

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFuo0YUhq8zT3HEzeIKNjiWqggrUlnvpKV1cAQ0u1EUjQYYx9Ngxp0ZKLiqtOoz-LJP5yepwLFDd51texEukOac_z-cOXwztg03TCouChcmIn2UgqaL9--A1SxNSp5nTIJmSkO1UyEU4RgkEzJjkvwieKFIzpdcwwV8OxoD2DZkbE7LXENF85K5cI5sG1hBk5yRNX9Y04fOBwuqQC_Y53JRtHqx0nzJ10ySUjGy4EqLB0mX6v-4lmWueSpyojTV_-LMRUpzrhuyL5GRFZWaay4KlhFeZKwmKqVfa7udTMaVVr_mcAFiPj86Dlpq0X6xYqkWkq_ZVyqiSYi9GEPsvZtiWJVJztO3NZjohIIfxOcQzGIIfp5OLXSSPEV2q8ksiOLQ84MYarJ6ZA1ch_6VF97CT_gWTApeNBlY6MQP3uOPUJOE8KwGM9nHL70rf3oLxkryJZWNASa1IBmgwRghbxrj8POe_OBHPIkhir3Yj2J_EsGbOwQA8Hv3bh8jFXm5LJThwt0h2CWocVjfWz29ZFSzjFBtuGCcOcNz2xnazhCcoes4ruMYPXE7eV6kmqSiLFrD0HF66Q4h0tKgmxVr6_XNRZnnB2PfJsVvzwXPRsOzUZf7w_rPe0teZW9dK6-3PXT_Znycvqalr_yCvuol-poj9JV7ynq6-SOpiGRzUsPlLMT-98FOWw0gxJc4xMEERwfcTPoMb0OqHbzVy_CWFlQvwtschbc_gRsff9irq91RsKCrCV4EEZ627ucoXIazq-7afLtv2PrHsoEPP-AQQwIXMBojhD9eTz0_AHN2HVuAg5vBvug3u1rVGNm2bSNeFEza3fVpplIoNUCw3fy13Xzabj5Bdz81X0Tq757Od5v5s_2_283mSZCKQmlJeaFdOD07HbpwdzoCG05H96gnm_NcM6nA1LJkA_R3AAAA__8KctCT

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkFFr2zAURp-jX_HRlyYj2stglIY-uJ4K3hwn2FpZGEOo9k2iVbEy6To0-fUjHYMxRkffz7nf5UiJe4rJhf4aeWgfY7Dt9sMt6Inah8H5jiKYEuPwixKiURqRQuwomu_B9cl4t3OMG7x_NwOkREdrO3jGwfqBrnElpAT19sGTObnNyW6ePWxtAm_pbzz0Zz7s2e3ciaIZEpmtSxw20e7Sa6zd4Nm1wZvElv9j-tBa7_hofp_ozN5GduxCT51xfUdPJrX2pbfPZTqXOP3wuEFYr_-Zww4czosHajlEd6IXLoq8VplW0NltqZDeMsZiZFFU-grVQqP6XJZTMcoXVaPrrKg02Owf6YhlXcyzeoVPaoWxRdbkk6kY3WXzolzhYh_dzsbjBcZ2IiYzIbJSq_qPlaL6qHKNRme6aHSRN7j8-u1yJoT6siyzosJ4sdRTqOp-gkaVZ_YN7urF_GzPhJRSiudYLH4GAAD__2xjxSo=
