# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO2zAUhq_xU_zKDe3W0KTdBQqatFCCli2kKM0YCCHLSdzWI4krx2GBaRIP0SfkSaYExoo02G7IhSWf83__OSfHpokTriohSwcTmV4qydLlwT54w9OkFnnGFTSvNK7uVYSYJhSXKuOKfpOirGguCqGxZBX0kiPjc1bnGlcsr7mDd62elyzJOb0Rixu26Kjn5LJs9XKlRSFuuKJzqbhYlPSSX1cvM7xZcSUKXmqW078a0JRVKcv480bz-dPqdcXpUlRaLhQr_lH_KVXUuRapzGmlmX6JJJPIc2MPsbsfeGjQI1sMfhjvIpzGCL8EwYBsJQ-R-9tkGs7iyPXDGMZKiYKpawPHkX_kRmf47J2hx-DOJv0B2fLDA-8UDU2oyBr0kt_xQ_fID8428B4bIOmT_h4hbhB70UM_7eZ3VnWSi3SngR9-8iYxZrEb-7PYn8ywfU4A4Ed3tp-RyrwuyspwcP4Y7BLMeLxfDDb0ijPNM8q04cAYWfauadmmZcOyHctyLOttdxobSCYqLcpU01TWZYvZlrWR7hZG23-vr1e8dd2EyzrPH8FNTMnvfwxHY3s07nI_B_89YfKKE3YNvd6Q5GJ7jxDv9Dhw_RC96XE8gBee9DHzgnblb3AYTY_Q4OtHL_KQ4D3Ge8Q0TZNUKSvRfHh4YwR36_Xd-vZufYtUlpVWTJTawXA0tB2cD8cwMRxfkF8BAAD__5NyRsI=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO2zAUhq_xU_zKDe3W0KTdBQqatFCCli2kKM0YCCHLSdzWI4krx2GBaRIP0SfkSaYExoo02G7IhSWf83__OSfHpokTriohSwcTmV4qydLlwT54w9OkFnnGFTSvNK7uVYSYJhSXKuOKfpOirGguCqGxZBX0kiPjc1bnGlcsr7mDd62elyzJOb0Rixu26Kjn5LJs9XKlRSFuuKJzqbhYlPSSX1cvM7xZcSUKXmqW078a0JRVKcv480bz-dPqdcXpUlRaLhQr_lH_KVXUuRapzGmlmX6JJJPIc2MPsbsfeGjQI1sMfhjvIpzGCL8EwYBsJQ-R-9tkGs7iyPXDGMZKiYKpawPHkX_kRmf47J2hx-DOJv0B2fLDA-8UDU2oyBr0kt_xQ_fID8428B4bIOmT_h4hbhB70UM_7eZ3VnWSi3SngR9-8iYxZrEb-7PYn8ywfU4A4Ed3tp-RyrwuyspwcP4Y7BLMeLxfDDb0ijPNM8q04cAYWfauadmmZcOyHctyLOttdxobSCYqLcpU01TWZYvZlrWR7hZG23-vr1e8dd2EyzrPH8FNTMnvfwxHY3s07nI_B_89YfKKE3YNvd6Q5GJ7jxDv9Dhw_RC96XE8gBee9DHzgnblb3AYTY_Q4OtHL_KQ4D3Ge8Q0TZNUKSvRfHh4YwR36_Xd-vZufYtUlpVWTJTawXA0tB2cD8cwMRxfkF8BAAD__5NyRsI=

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lM9um0oUxteZpzhiE3wvxNi-i4joSiXOuKV1cIRpmiiKRgMe29NgsGYGCqkqRX0GL_t0fpIK7CSk-dN2ERYjzTnfd2YO5wemCadMSJ4mNvTT6EqkNJofHQIrWBRmPJ4wAYpJBflGhZBpgmCpmDBBPqc8kSTmC65gTiWoOYMJm9IsVpDTOGM2_FfpWULDmJFrPrums9r1nDxNKn26VHzBr5kg01QwPkvIFSvlyx5WLJngC5YoGpMnC5CIyohO2POFptOHp2eSkTmXKp0JuvjN-Q9diyxWPEpjIhVVLzlR38dOgCFwDocYCtDRDgXXC_bBGwXgfRwODbQTbiObXX_kjQPfcb0AtKXgCypKDU5899jxz-EDPgedgjPutwy043pH-AwKEhI-KUAPb-MD59gdnjfsOjUgbKHWAULOMMD-9j7V5PeWWRjzaK8A13uP-wGMAydwx4HbH8PuBQIA-Fqv1aNFaZwtEqnZcHEXrBNUu9tfGg29YFSxCaFKs0HrWp190-qYVgesjm1ZtmX9W69awzLhUvEkUiRKs6SydSyrka4HRqp3r8olq6o2zUkWx3fGpk2kX-4Ldnudbq_OfTP-uMPwFTusL_R6TaLL3YNfUCwrFLNHKOZ_iWJ2i1xDOr0iORFsSgoYjHzsvvU22rwFPh5gH3t9PIZCp_cIlyTfIJw_j3BmQP4ywuWTCNe947OToeN6oI9OAgOwd9qCMR5W2n9g4I-OoTCghE_vsI8hhP-hd4BM0zQRTxImzPqXpkcilbKFYL36sV7drFc3ICOaQPkoUrzZfpJV5ns1gfVqtRVEaSKVoDxRNrS77Y4NF-0emNDuXaKGbMpjxYQEXYmMtdDPAAAA__8kbq8W

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k9FO2z4Uxq_xUxzlhvT_T1AKu0DlKpQgZQspajIEQshyktPWw7Er24HANImH6OWejieZElhXtMF2Qy6s-Dvf77NPjuL7cIbacCVHMFbltVasXBwdArZYFg0XFWqwaCzcPLkI8X3QqHSFmn5RXBoqeM0tLJgBu0CocMYaYeGGiQZH8KHzo2SFQHrP5_ds3lOv2ZXs_Gppec3vUdOZ0sjnkl7jnXmbwXaJmtcoLRP0jwG0ZKZkFb4eNJu9PL0xSBfcWDXXrP7L-S-puhGWl0pQY5l9iyTjaRTmEeThYRJBCy7ZYhCn-T6kkxzSz0nika3iWXnajSdplk_DOM3BWWpeM33nwOk0PgmnF_ApugCXQZiNBx7ZitOj6BxaWlBeteAWP_Xj8CROLjZwl3lQDMjggJAwyaPp8326ye8sm0LwcqeFOP0YjXPI8jCPszweZ7B9SQAAvvZr9zilEk0tjTOCy7XYF5iz3l95G36NzGJFmXVG4OwGw30_GPrBEILhKAhGQfB_vzobSMWN5bK0tFSN7LBhEGyU-4HR7tvbuyV2qZuwbIRYg5uYVre_Anf3hrt7fe2b988dFu_YYX-h92uSXG0fEBKdnyZhnII7Oc09iNKzAWRR0o38PzieTk6ghTADJdF7erO36oD4vu8TLiVqv_-x3VIrYwYEHlffH1cPj6sHMCWTHfabZm9Vp62etRkXFrUB1-oGB-RHAAAA__93vVp0

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 100

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyEks1u2kAUhdeZpzjKJqaKQyK6qEBZOM7QujUG2dM0KIpGgxnDFP-gmbGFWeUheEKepKKkUqnadHmvvu8cXem6Lh6kNqoq-_CrdKUrkS7v7yA3Mp3VKp9LDSuNRXOkCEkog5aVnkvNv1eqNDxXhbK4xc319QBwXcxlJurcohF5Lft4T1wXshSzXPKtWmzF4qeIpTCwS_knXpUHvlpbVait1DyrtFSLkq9ka9525GYttSpkaUXO_xrAU2FSMZf_Dsqy0_baSL5UxlYLLYr_9J9aRZ1blVY5N1bYt0zix9RjFMy7CylaOOSsRhCxD4jGDNHXMLwkZ83r5jj54yhhsRdEDOdrrQqh23NM4mDkxVN8oVM4NbzE75yi2Yo3XMuMbzAcxzT4GB3ZpoOYDmlMI58m2Dji4AXRPX1Eyxuu5hs4za-8oTcKwulvtU59iaZDOgNCvJDR-PWOw9dcretZrtKrFkH0mfoMCfNYkLDAT3Dx9HwxIIQ-TkIviOCMJ-wSNHroIKHhgX2HYTweocW3TzSmqHGL3oC4rusSk4oSLcF-t9vvXva7F6RVaawWqrR9dG_6eOr24KLbeyY_AgAA__9BFuym

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 100


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyEks1u2kAUhdeZpzjKJqaKQyK6qEBZOM7QujUG2dM0KIpGgxnDFP-gmbGFWeUheEKepKKkUqnadHmvvu8cXem6Lh6kNqoq-_CrdKUrkS7v7yA3Mp3VKp9LDSuNRXOkCEkog5aVnkvNv1eqNDxXhbK4xc319QBwXcxlJurcohF5Lft4T1wXshSzXPKtWmzF4qeIpTCwS_knXpUHvlpbVait1DyrtFSLkq9ka9525GYttSpkaUXO_xrAU2FSMZf_Dsqy0_baSL5UxlYLLYr_9J9aRZ1blVY5N1bYt0zix9RjFMy7CylaOOSsRhCxD4jGDNHXMLwkZ83r5jj54yhhsRdEDOdrrQqh23NM4mDkxVN8oVM4NbzE75yi2Yo3XMuMbzAcxzT4GB3ZpoOYDmlMI58m2Dji4AXRPX1Eyxuu5hs4za-8oTcKwulvtU59iaZDOgNCvJDR-PWOw9dcretZrtKrFkH0mfoMCfNYkLDAT3Dx9HwxIIQ-TkIviOCMJ-wSNHroIKHhgX2HYTweocW3TzSmqHGL3oC4rusSk4oSLcF-t9vvXva7F6RVaawWqrR9dG_6eOr24KLbeyY_AgAA__9BFuym

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyEks1u2kAUhdeZpzjKJqaK86N0UYFYOM7QujUG2dM0KIpGgxnDFNuDxmMLs8pD8IQ8SUVIpSLRdnmvvu8cXem6Lh6lqZQuu_B1ujRapIuHe8i1TKe1ymfSwMrKojlQhCSUwUhtZtLwn1qVFc9VoSz6uL256QGui5nMRJ1bNCKvZRcf3xxZimku-UbNN2L-ZqIPnWUnFV0S14VeWVWojTQ800aqecmXsq2wEBXsQp525HoljSpkaUXOTwbwVFSpmMm_B2XZcXtdSb5QldVzI4r_9B9bRZ1bleqcV1bYf5nEj6nHKJh3H1K0cMhZjSBinxCNGKLvYXhJzpr3zWHyR1HCYi-IGM5XRhXCtOcYx8HQiyf4RidwaniJ3zlGsyVvuJEZX2MwimnwOTqwTQcxHdCYRj5NsHbE3guiB_qEljdczdZwmt95A28YhJM_ap36Ek2HdHqEeCGj8fsd-8-5WtXTXKVXLYLoK_UZEuaxIGGBn-Di-eWiRwh9GodeEMEZjdklaPTYQULDPfsBg3g0RIsfX2hMUaOPux5xXdclVSpKtAS77Xa3fd1tX5HqsrJGqNJ2cX3bxfP1HVxc372QXwEAAP__4WjtCA==

statement ok
SET optimizer_foreign_keys = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx80t9O2zAUBvBr_BSfuCGdCH_ELqZWXITgbtlCihKPgRCy3NRpvSZxZTtR0yseok_YJ5naMm0TjEtb3-87OtLxfdxJY5Wu-wh1Pjda5LPrK8ilzMeNKifSwEnr0O5ThGSUwUhtJtLwn1rVlpeqUg6XOD87GwC-j4ksRFM6tKJsZB8fd0bWYlxKvlLTlZjuJC6hi-JNouud0QunKrWShhfaSDWt-Vx29n3n-5DLhTSqkrUTJX-zg-fC5mIiLWbCws3kq6Ki2Db9wY2VfKas01Mjqv-z-rWqmtKpXJfcOuHekyRMacAoWHAVU3TwyEGDKGGfkIwYku9xfEwO2pef_SscJRlLgyhhOFwYVQnTHeI2jW6C9AHf6AO8BkEW9v6NFnPeciMLvsRwlNLoc7LPtj2kdEhTmoQ0w9ITWxcl1_QeHW-5mizhtb_7hsFNFD_8NdZrjtH2SG9ASBAzmr7ssb2ek0UzLlV-0iFKvtKQIWMBizIWhRmOHp-OBoTQ-9s4iBJ4o1t2DJrc9ZDReJv9gGE6ukGHH19oStHgEhcD4vu-T2wuanQEm_V6s37erJ-R69o6I1Tt-jg97-Px9AI-Ti-eyK8AAAD__7vP7Wo=

statement ok
SET experimental_optimizer_foreign_key_cascades = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyE0t9q2zAYBfDr6ikOvakz6v6huxgJvXBdZfPmOsXWupZShOLIiRbbCpJs4lz1IfKEeZKRpIOOhe1S4vyOPsHn-3iQxipd9xHqfG60yGe3N5BLmY8bVU6kgZPWod2nCMkog5HaTKThP7WqLS9VpRyucXlxMQB8HxNZiKZ0aEXZyD4-7oysxbiUfKWmKzHdSVxDF8VBouud0QunKrWShhfaSDWt-Vx29v9OLhfSqErWTpT8YAnPhc3FRO7K6sNdRUF8_90MjZV8pqzTUyMqi5mwcDN5YIS_VNWUTuW65NYJ9y9JwpQGjIIFNzFFB48cNYgS9gnJiCH5Hsen5Kh9u9mfwlGSsTSIEobjhVGVMN0x7tPoLkif8I0-wWsQZGHvz2gx5y03suBLDEcpjT4n-2zbQ0qHNKVJSDMsPbF1UXJLH9HxlqvJEl77u28Y3EXx07tnveYUbY_0BoQEMaPp2z-2C3S2aMalys86RMlXGjJkLGBRxqIww8nzy8mAEPp4HwdRAm90z05Bk4ceMhpvsx8wTEd36PDjC00pGlzjakB83_eJzUWNjmCzXm_Wr5v1K3JdW2eEql0f55d9PJ9fwcf51Qv5FQAA___e1u1u

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyE0t9q2zAYBfDr6ikOvakz6v6huxgJvXBdZfPmOsXWupZShOLIiRbbCpJs4lz1IfKEeZKRpIOtBHopcX5Hn-DzfTxIY5Wu-wh1Pjda5LPbG8ilzMeNKifSwEnr0O5ThGSUwUhtJtLw31rVlpeqUg7XuLy4GAC-j4ksRFM6tKJsZB-fd0bWYlxKvlLTlZjuJK6hi-Ig0fXO6IVTlVpJwwttpJrWfC47-7GTy4U0qpK1EyU_WMJzYXMxkbuy-nBXUbwborGSz5R1empE9cEYvv8OVk3pVK5Lbp1wFjNh4WbygCRhSgNGwYKbmKKDR44aRAn7gmTEkPyM41Ny1L7d7E_hKMlYGkQJw_HCqEqY7hj3aXQXpE_4QZ_gNQiysPd_tJjzlhtZ8CWGo5RGX5N9tu0hpUOa0iSkGZae2LoouaWP6HjL1WQJr_3bNwzuovjpn2e95hRtj_QGhAQxo-nbP7ZLdLZoxqXKzzpEyXcaMmQsYFHGojDDyfPLyYAQ-ngfB1ECb3TPTkGThx4yGm-znzBMR3fo8OsbTSkaXONqQHzf94nNRY2OYLNeb9avm_Urcl1bZ4SqXR_nl308n1_Bx_nVC_kTAAD__0mA7dA=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0t9u2jwYBvDj-ioe9aThU9M_4juYQBykqdmyhYASryuqKssEh3okMXKciHDUi-AKuZIJ6KR1QuoObT2_x6-l13XxIE2ldNmDr9Ol0SJ9ub-DXMt0Vqt8Lg2srCyaY4qQhDIYqc1cGv5Tq7LiuSqUxQC3Nzd9wHUxl5moc4tG5LXs4f-DkaWY5ZJv1GIjFgeJAXSWnSS6PBi9sqpQG2l4po1Ui5IvZVt97OR6JY0qZGlFzk-W8FRUqZjLQ1l5uivL_hqiriR_UZXVCyOKfxjjvSzq3KpU57yywn6giR9Tj1Ew7y6kaOGQsxpBxD4hGjNE38Pwkpw1bzfHkz-OEhZ7QcRwvjKqEKY9xyQORl48xTc6hVPDS_zO-2i25A03MuNrDMcxDT5Hx2zTQUyHNKaRTxOsHbF3QXRPH9Hyhqv5Gk7zu2_ojYJw-sezTn2JpkM6fUK8kNH47R_7Rbpa1bNcpVctgugr9RkS5rEgYYGf4OLp-aJPCH2chF4QwRlP2CVo9NBBQsN99j8M4_EILX58oTFFjQG6feK6rkuqVJRoCXbb7W77utu-ItVlZY1Qpe3h-raHp-suXFx3n8mvAAAA___2fe4y

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_foreign_keys

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJx8jk9P3DAQR-_-FL9jW9XS_oEuZcUhTV1ppU2gSVhxs4wzSVwcG2wH0f30VcqpBe1tpHlv5nGOA4VovLtE7vVD8EoP37-BXkjfT8a2FJAoJjy_UozVokEgH1oK8pc3LkprRpNwheVisQU4R0udmmzCs7ITXeKMcQ5y6t6SPJr-qPq_IgYVkQb6H_du5v1jMqM5UpCdD2R6Jx_odzzhzF308kjBjOSSsvLdC1KrqFVLEVfw7t1c33X_BkyR5GBi8n1Q46mEN9Y42WS0tzImlU6ZLK9E1gjU4uetKHOBSE8oduUh298KLFFkd6_j19Vqvd6sFusvF-dnm835xWKDXZlXohBlgyXqJqsaLLeMibubfbYr8eH6pvkMUR4-ohZ7kTf4hB_VdTG_2DLOOWeRniZymngkSzrNG_YnAAD__wl6slU=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4kIvlTepkeI9FDICTHWZTZsjB5KWNggCgpLpmItMGiSlyRkGFPsGP-7r_CWDZCdR0sxYH-oHArz3nMNzzUO5LlwypbkUAYxlcackLRYf3gNrWJFXvJwxBYZpA_UOhVCKM1BMqhlT5HfJhSYlX3IDp-B73gjAdWHG5rQqDdS0rFgAPyDXBSZoXjJyz2_v6W1HhAXVYBbsJVyKFi9Xhi_5PVNkLhXjt4LcsbU-wGl9sWbFFF8yYWhJXlUgBdUFnTENpyDFq3blfP7cQKUZWXBt5K2iy0MWvmAtq9LwQpZEG2oOMdE4wWGGIQvfTzA0YKMjClGcvYN4mkH822TioKN8X9ntxtM4zZIwijOwVoovqVpbcJFE52FyBb_iK7AphOl44KCjKP6AP0FDcsJnDdj5Q_0sPI8mVz26TR3IB2gwQiicZDjZ-2kD8HZV5SUv3jYQxb_gcQZpFmZRmkXjFN5cIwCAP7u1_VmFLKul0FYA14_FrkGtx_2N08MrRg2bEWqsAKwTz3_ner7r-eD5gecFnvd9t1o9yoxrw0VhSCEr0dJ8z-u1uwsj7X9v1ivWqvbJoirLR2KfpuQfT4InQ_9k2PX-cv73hPk3nLAz9O2GRDdvRi-iuG6jWH0Rxforo1g9RK4Hnd-Rmig2Jw2cTRMc_RTvsPUAEnyGExyPcQqNTZ8ivCb1LsL1f0e4cqA-HOH1qxHuz34Z4Y9Q756DA50ihCmkeNLSnqpwlkzPnz8P58VRH3_GCYYcTmE4Qgh_upiEUQz29CJzAMeXgwfR73Za9Qi5rusiLgRTbveZtAsltR4g2G7-2W4-bzefQRdUPD_nYLf5cf_2W9Tf7VVvN5s9uJBCG0W5MAEcnxz7AVwfD8GF4-EN6sHmvDRMabCNqtgA_RsAAP__9ZjPZQ==
