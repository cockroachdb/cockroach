# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U2Fu2zYY_R2e4oP_2B4sRbJRoJARYKrDdNpcOZCUrkUQEBRFrURlMRUpTd4woIfwVXaBHSUnGShljrsp67q2_mFAnx7fe3x6n2XBS14pIUsPVpK9rSRlb86fAW85S2tRZLwCzZWGpkchFOMEMqppShWHMxibt-MlgGVBxnNaFxoaWtTcgx4qlFbvCjgDmeeDMFpr2UFFmfGWVJzJ7ZaXGdVClorwkqYFz_6F4C9Xq_VVnOAIYpwkQfgcck51XXG74UzLinT09gPdWFc1H3ae00LxQU71rrBZlaVElJpXJS1sbfhIJX8mSlMtlBZM2VQRmRMttl1ElvvH72pYyXId9ajQPVbZDyGOZZ4PMx1iHGIy1pRtIFuqBSNMFgVnJuDjQLprD7ObrP4P-1aUJpc-IWVEngwLPHGcj_DnsuKMKq2-nGW1U5pvSfcJFTEX6OdfQKDhrC9cxjWvtqLsmkFy0da36lNaiK5i3K3gEq0i7CcYEv_ZGsNtnRaC2S1M0AmFIEyeQrhJILxar2foJL2f9E-rTRgnkR-ECbTk9i3fwWUUvPCj1_ADfg0TCn68ms7QSRCe41fQkpSIrIVJ2s3RdLlEyF-bG_bSxo190A_C7_EqgTjxkyBOglUM42sEAPBr929-I9r8RJT4hY88cGYPYyaLeluqkQfXh2GPHx2eb47xFaeaZ4TqkQejueM-tRzXclxwXM9xPMcZHYHN0oiSacJkXZoDrnOs_UYoLU1Vid7dGmOj48MiMweOBmVdFAemYx6z-QeF-cKdL7p3v80-N4P0q2TQOfy0GOafEwO6GS8_1uGd6XD9jw43j3V4N9Dh-sMO70jTd7j5Dx3eDXbYGH_8hH9-Dh9YakhuTF1sIhw8D3tTzRQifIEjHK5w_Le1mdDpEiH86nLtByFMNpfJDHD4cgoxXhsv38BFtHkBLfz4HY4wpHAGiyWyLMtCitES2m_v9xTB3X5_t39_t38PTJZKV1SU2oPT-anrwfXpAiw4XdygPwMAAP__w21OJQ==


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VGFu2zYY_R2e4oP_2B4sR45RoLARYKrDdNpcOZCUrkUQEBRFrVxlMhUpTdowoNgZ_HPX2AV2lJxkoJQ57qqs69r6hwF9fHzv8elRjgPPeaGFkgtYKfa6UJS9OnsCvOYsKUWe8gIM1waqDoVQhGNIqaEJ1RxOYWhXh0sAx4GUZ7TMDVQ0L_kCOqjQRr_J4RRUlvXCaGlUCxUy5TUpOFPbLZcpNUJJTbikSc7TfyH429VqfRnFOIQIx7EfPIWMU1MWfFpxZlRBWvrpPd3QFCXvd57RXPNeTv0mn7IiTYiQhheS5lNj-UihfiLaUCO0EUxPqSYqI0Zs24ic2Z9_6H4lZ-bqB4XusHp6H-JQZVk_0z7GPiZrTU8tZEuNYISpPOfMBnwYSHvsfnab1f9h3wppc-kS0lbkUb_AI9f9AH-mCs6oNvrzWdaNNnxL2leoiT1AN_8MAhVnXeFSbnixFbJtBslEXd7oj2khuoxwewWXaBViL8YQe0_WGG7KJBdsWsMIHVHwg_gxBJsYgsv1eoKOkrtJ97TaBFEcen4QQ01uXvMGLkL_mRe-hO_wSxhR8KLVeIKO_OAMv4CaJESkNYySdo7GyyVC3tqesJO2bqZ7fT_4Fq9iiGIv9qPYX0UwvEIAAL-0__Y3oNUPRIuf-WAB7uR-zFRebqUeLOBqP-zwg_3z9SG-4NTwlFAzWMDgxJ09dtyZ487AnS1cd-G6gwOwvTRCMkOYKqXdMHMPtV8JbZStKjHNjTU2ONwsUrvhYCDLPN8zHfLYm79XOJnPTubt2q-TT80g-SIZtA4_LoaTT4kBXQ-XH-pwYztcvtfh6qEONz0dLt_tcEOqrsPVf-hw09tha_zhHd7ZGbxjqSKZNXW-CbH_NOhMVWMI8TkOcbDC0T-uzYiOlwjhFxdrzw9gtLmIJ4CD52OI8Np6-QrOw80zqCfQwPff4BBDAqcwXyLHcRwkpOSF86MSEkasUFqPEdzufr_dvb3dvQXNqITmvUn99d3Vtiu_2ddzu9vdAZiS2hRUSLOA45Pj2QKujufgwPH8Gh3AMpEbXmgY2c_WGP0VAAD__yg7ci4=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkFMUKGzkQXWYQpsrB5JStAgCgqKolatMpiSlyBsG9CPyuN_YD-xT8iUDpcxxN2Vd19YPhnV5eM7h8aE8D15xbYSSC1gp9k4ryt6ePgfecpbXoiq4BsuNhaZHIZTiDApqaU4NhxMYu9XxEsDzoOAlrSsLDa1qvoAeKow17ys4AVWWgzBaW9VBhSx4SzRnarvlsqBWKGkIlzSvePEvBH-5Wq0v0gwnkOIsi-IXUHJqa839hjOrNOno_Qe6sdU1H3Ze0srwQU7zvvKZLnIipOVa0sq3jo9odUOMpVYYK5jxqSGqJFZsu4i8-R-_m2Elbx6YR4XuscZ_CHGsynKYaR_jEJOzZnwH2VIrGGGqqjhzAR8G0h17mN1l9X_Yt0K6XPqEjBN5OizwNAg-wV8qzRk11nw9y2ZnLN-S7i80xB2gn38FgYazvnAFt1xvheyaQUrR1tfmc1qILlLcXcElWiU4zDBk4fM1hus6rwTzW5igIwpRnD2DeJNBfLFez9BRfj_pn1abOM2SMIozaMn1O76D8yR6GSZv4Af8BiYUwnQ1naGjKD7Fr6ElORFFC5O8m6PpcolQuHYn7KWdG3-vH8Xf41UGaRZmUZpFqxTGlwgA4Jfu231GtPmRGPEzHy0gmD2MmarqrTSjBVzuhz1-tH--OsRrTi0vCLWjBYyOg_kzL5h7wRyC-SIIFkEwOgC7SyMks4SpWroN8-BQ-60wVrmqEru7dsZGh5tF4TYcDGRdVXumQx538_cKx0_mx0-6tV9nX5pB_k0y6Bx-XgzHXxIDuhovP9Xhnetw_Y8ON491eDfQ4frjDu9I03e4-Q8d3g122Bl_fEd4egofWWpI6UydbRIcvYh7U80UEnyGExyvcPq3azOh0yVC-PX5OoximGzOsxng-NUUUrx2Xr6Ds2TzEloIU1CSz_pf9kYtked5HhJScu39pISECdPKmCmCu9vf7m4_3N1-AMOohBYuqTlRkl89smRvVLd0e79UispybWDiXkpT9GcAAAD___m-Zpk=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvtgfLkWN0CGTkQXWYTpsrB5LStQgCgqKolatEpiKlWRsG9CPyK_uBfUq-ZKBUOO6mrOva-sGArs495_Do0HHgBa-0UNKDtWJvKkXZ6_OnwHecpbUoMl6B4dpA06MQinECGTU0pZrDGYzt2_EKwHEg4zmtCwMNLWruQQ8V2ui3BZyByvNBGK2N6qBCZnxHKs5UWXKZUSOU1IRLmhY8-xcCJbv1iqsq4xX5WQmpSSFKYeAMvl0O7pz2B1lvruIERxDjJAnCZ5BzauqKzxvOjKpI52j-4GBsqpoPHzanheaDnPptMWdVlhIhDa8kLebG8pFK_UK0oUZoI5ieU01UTowou1SdxZ9_6GElZ-HqR4XeY_X8IfexyvNhpn3yQ0zWmp5bSEmNYISpouDMfpPDQLpjD7PbrP4PeymkzaVPSFuRJ8MCT1z3I_y5qjij2ugvZ1m32vCSdJ9QE3uAfv4FBBrO-sJl3PCqFLJrBsnFrr7Vn9JCdBXj7tau0DrCfoIh8Z9uMNzWaSHYfAcTdEQhCJNTCLcJhFebzQwdpe8n_dN6G8ZJ5AdhAjty-4a3cBkFz_3oFfyAX8GEgh-vpzN0FITn-CXsSEpEtoNJ2s3RdLVCyN_YE_bS1s18rx-E3-N1AnHiJ0GcBOsYxtcIAOC37t_-RrT5iWjxKx954M4exkwVdSn1yIPr_bDHj_bPN4f4ilPDM0LNyIPRibs4ddyF4y7AXXiu67nu6ABsL42QzBCmamkXFu6h9muhjbJVJaa9tcZGh8siswsHA1kXxZ7pkMfe_L3CyXJxsuze_T773AzSr5JB5_DTYjj5nBjQzXj1sQ63tsP1PzrcPNbhdqDD9YcdbknTd7j5Dx1uBztsjT--4Z-fwweWGpJbUxfbCAfPwt5UM4UIX-AIh2sc_-3aTOh0hRB-ebnxgxAm28tkBjh8MYUYb6yXb-Ai2j6HFn78DkcYajiD5Qo5juMgzaiEFsH93d393bv7u3fAlNSmokIaD44XHlwfL8GB4-UN-isAAP__t21bVA==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VOFu2zYX_R0-xYX_2P5gOXKMFoGM_FAdpp82Vw4kpWsRBARFUStXiUxFSrM2DOhD5FX2AnuUPMlAqXDcTWnXtfMPA7q695xzjw7pOPCSV1oo6cFasbeVouzN-TPgO87SWhQZr8BwbaDpuxCKcQIZNTSlmsMZjO3b8QrAcSDjOa0LAw0tau5B3yq00e8KOAOV54NttDaqaxUy4ztScabKksuMGqGkJlzStODZJwCU7MYrrqqMV-QnJaQmhSiFgTN4uhycOe0XWW-u4gRHEOMkCcLnkHNq6orPG86MqkinaP6gYGyqmg8vm9NC80FM_a6YsypLiZCGV5IWc2PxSKV-JtpQI7QRTM-pJionRpSdq87ij9_1MJOzcPWjRB969fzB97HK82GkvfOfRBr2dfx0OQx6-iiiXVbPLWlJjWCEqaLgzH7lQ4s7I4ehrfv_Br0U0jrde64tyZNhgieu-xn8XFWcUW30t5OsW214SbpQaGIX6OvfgKDhrI9wxg2vSiG7rJFc7Opb_SW5Rlcx7u6BFVpH2E8wJP6zDYbbOi0Em-9ggo4oBGFyCuE2gfBqs5mho_RDpX9ab8M4ifwgTGBHbt_yFi6j4IUfvYbv8WuYUPDj9XSGjoLwHL-CHUmJyHYwSbs6mq5WCPkbu2FPbdXM9_xB-B1eJxAnfhLESbCOYXyNAAB-7f7tb0SbH4kWv_CRB-7socxUUZdSjzy43hf7_tH--eawv-LU8IxQM_JgdOIuTh134bgLcBee63quOzpotsdQSGYIU7W0Awv3kPuN0EbZqBLT3lpho8NhkdmBg4Ksi2KPdIhj75I9w8lycbLs3v02-1oP0v_Eg07hl9lw8jU2oJvx6nMZbm2G679luHksw-1AhuuPM9ySps9w8w8y3A5m2Ap_fMI_P4ePJDUkt6IuthEOnoe9qGYKEb7AEQ7XOP7LsZnQ6Qoh_Opy4wchTLaXyQxw-HIKMd5YLf-Di2j7Alr44f84wlDDGSxXyHEcB2lGJbQI7u_u7u_e39-9B6akNhUV0nhwvPDg-ngJDhwvb9CfAQAA__8raHW-

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfLkWO0CGzkQXWYTpsrB5LStQgCgqKolKtEpiKlWRkG9CPyK_uBfUq-ZKBUOO6mtOva-sGAru495_DcIzoOvOSlFkouYKXY21JR9ub0GfAtZ0kl8pSXYLg2UHddCEU4hpQamlDN4QSG9u1wCeA4kPKMVrmBmuYVX0DXKrTR73I4AZVlvW20Mqpt5ZImOSe34vqWXpNflZB2SvYOqSxrZ4RM-ZaUnKmi4DKlRiipSYeUfoJUyXa85KpMedmSaZKLQhg4gafz3pnj7vCr9UUU4xAiHMd-8BwyTk1V8mnNmVElaRVNHxQMTVnxfoMymmvei6nf5VNWpgkR0vBS0nxqWm9K9RvRhhqhjWB6SjVRGTGiaDfhzP76U_czOTNXP0r0oVdPH3Y1VFnWj7Tb1ieR-n0dPp33gx4_imgPq6eWtKBGMMJUnnNmt7xvcWtkP7R1__-gF0JapzvPtSV50k_wxHU_g5-pkjOqjf52knWjDS9IGwpN7AG6-jcgqDnrIpxyw8tCyDZrJBPb6kZ_Sa7RRYTbu2OJViH2Ygyx92yN4aZKcsGmWxihAwp-EB9DsIkhuFivJ-gg-VDpnlabIIpDzw9i2JKbt7yB89B_4YWv4Wf8GkYUvGg1nqADPzjFr2BLEiLSLYySto7GyyVC3tqesKO2aqY7fj_4Ca9iiGIv9qPYX0UwvEQAAL-3__Y3oPU10eKWDxbgTh7KTOVVIfVgAZe7Ytc_2D1f7feXnBqeEmoGCxgcubNjx5057gzc2cJ1F6472Gu2n6GQzBCmKmkHZu4-9xuhjbJRJaa5scIG-8MitQN7BVnl-Q5pH8feJTuGo_nsaN6--2PytR4k38WDVuGX2XD0NTagq-HycxlubIarf2W4fizDTU-Gq48z3JC6y3D9HzLc9GbYCn98wjs9hY8k1SSzos42IfafB52oegwhPsMhDlY4-sdnM6LjJUL41fna8wMYbc7jCeDg5RgivLZafoCzcPMCGvjlRxxiqOAE5kvkOI6DNKMSGgT3d3f3d-_v794DU1KbkgppFnA4W8Dl4RwcOJxfob8DAAD__8BUhzs=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3tgfLkWO0CGzkwnWYTpsrB5LStQgCgqaolKtEuiSl2RkG9CHyKnuBPUqeZKBUOO6mNOua-sKAjs73w0-f5HnwmmsjlJzAXLH3WlH27vQF8A1nq1LkKddgubFQNVsIxTiBlFq6oobDCXTd3e4UwPMg5RktcwsVzUs-gWZVGGs-5HACKsta12hpVb3KJV3lnNyI6xt6TX5VQjqUbAWpLKsxQqZ8QzRnqii4TKkVShrSMKVfEFWyhqu1FYW44ZqUhpN3wlh1rWlhHkdqrnTKdW3TkFwUwsIJPB-3Yo6b2OaLizjBEcQ4SYLwJWSc2lLzYcWZVZrUZxnee-9aXfL2aDOaG97KaT7kQ6bTFRHSci1pPrR1qlr9RoylVhgrmBlSQ1RGrCjqZ-iN_vrTtCt5I988KPRp1wzvn3JXZVk70-45f5GpPdfu83E76fGDjO6wZuhEC2oFI0zlOWeuH_sR10G2U7v0_w97IaRLusncNan7rF3gme8_wp8pzRk11jydZbM1lhekLoUh7gDN_AkEKs6aCqfccl0IWXeNZGJTrs3X9BpdxLj-6kzRPMKzBEMye7HAsC5XuWDDDfTQAYUgTI4hXCYQXiwWA3Sw-jRprubLME6iWRAmsCHr93wL51Hwaha9hZ_xW-hRmMXz_gAdBOEpfgMbsiIi3UBvVc9RfzpFaLZwJ2yknZvhTj8If8LzBOJklgRxEsxj6F4iAIDf63_369DqmhhxwzsT8Af3Y6byspCmM4HL3bDZ7-yur_b3NaeWp4TazgQ6R_7o2PNHnj8CfzTx_Ynvd_aW3WsoJLOEqVI6wMjf166_b66qxG7XzlhnHyxSB9gbyDLPd0z7PO5bslM4Go-OxvW9PwbfmsHqu2RQO_y6GI6-JQZ01Z0-1uGt63D5rw5XD3V429Lh8vMOb0nVdLj6Dx3etnbYGX8YMTs9hc8sVSRzps6WEQ5eho2pqg8RPsMRDuc4_sdr06P9KUL4zfliFoTQW54nA8Dh6z7EeOG8_ABn0fIVbOGXH3GEoYQTGE-R53keMoxK2CK4u729u_14d_sRmJLGaiqkncDhaAKXh2Pw4HB8hf4OAAD___9Em4Y=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkWO0CGzkwXWYTpsrB5LStQgCgqaolKtEuiSl2RkG9CPyK_uBfUq-ZCBVOO6mtM2a-cGAru45597DI_o-vGZKcykmMJf0vZKEvjt9AWzD6KriRcYUGKYN1E2X5yUohYwYsiKawQl07dvuFMD3IWM5qQoDNSkqNoGmlWujPxRwAjLPW9tIZaRrZYKsCoZv-PUNuca_Si4sSrSCZJ47DBcZ22DFqCxLJjJiuBQaN0zZF0SlcHC5NrzkN0zhSjP8jmsjrxUp9WORZVUYTmWBtSHmG9CKSZUx5ZbUuOAlN3ACz8etmOPG9PniIklRDAlK0zB6CTkjplJsWDNqpMLOieH95l2jKtZ-MDkpNGvl1B-KIVXZCnNhmBKkGBp3Jkr-5lbj2nCqh0RjmWPDS5cAf_TXn7pdyR8F-kGhT716eJ-RrszzdqZdSr7I1O5r9_m4nfT4QUZ3jkMrWhLDKaayKBi16dq32BnZTm3d_y_sJRfW6cZzm6Tus3aBZ0HwFf5cKkaJNvrpRtZbbViJXSg0tgs09ScQqBltIpwxw1TJhcsazvmmWuvH5Nq7SJC7s6bePEazFEE6e7FAsK5WBafDDfS8AwJhlB5DtEwhulgsBt7B6lOleZovoySNZ2GUwgav37MtnMfhq1n8Fn5Gb6FHYJbM-wPvIIxO0RvY4BXm2QZ6K1f3-tOp580WdsNG2k4z3OmH0U9onkKSztIwScN5At1LDwDgd_dvfx1SX2PNb1hnAsHgvkxlUZVCdyZwuSs2_Z3d89V-v2LEsAwT05lA5ygYHfvByA9GEIwmQTAJgs5es_0MuaAGU1kJCxgF-9rudrRRxWa7toN19sE8s4C9gqiKYse0z2Pvkp3C0Xh0NHbv_hh8rwer_8UDN-HjbDj6Hhu8q-70axne2gxX_8pw_VCGty0Zrj7P8BbXTYbrb8jwtjXDdvCHEbPTU_hspBrndqizZYzCl1EzVN2HGJ2hGEVzlPzjs-mR_tTz0JvzxSyMoLc8TweAotd9SNDCzvIDnMXLV7CFX35EMYIKTmA89Xzf9z1NiYCtB3e3t3e3H-9uPwKVQhtFuDATOBxN4PJwDD4cjq-8vwMAAP__6ZWxhw==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyslN-O0zwQxe_zFHPX70Mkarf0D1v1ogSDKrXZpUmrvbNcZyIMjr31OKU8GC_AkyEniOUiuwi0d1F8_DszZ0aOYzigI2XNNaRWfnZWyI9v3wBeUB4bpUt04JE8nDtVFOWsgFJ4cRSEsIRBOB0sAOIYSqxEoz2chW7wGjqpIk8nDUuwVdUrE423rVSZEi_cobR1jaYUXllDHI04aiyfAFjTXndoXYmOf7LKENeqVh6WMB333pl3jaSbfV6wHeSsKNbZe6hQ-MZhckbpreNtRclDBQPvGuxvthKasJdJJ51IVx65Mh6dETrxgced_cLJC6_IK0mJIG4r7lXdphqPvn-jfqd4NKRHjX5qKXnIfWCrqp_0K_knSf25Dqbjfuj8UWJolpJgWguvJJdWa5Rhyr9H3AbZjw7p_wu9ViYk3WVOwWTSbzAZDv_Ar6xDKcjT85VMX8ljzdulIB4a6P4_g8EZZbfCJXp0tTLtrvFKXZp7-pu9jvY5a9-BRZTu2KpgkLMPe5alDO6bo1YyITzBdp0dVps9gxFsV3fd5-urq_F4djUcT-eTV7PZZD6cwTpLd2zLsgJGkBerXQGjxSKK2N3tZrXO4L-b2-IlsOzwP-Rsw9ICXsC73c0WCE-LKI7jOCI8NWgkxoRhyOEk-hEAAP__43SOzg==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfY6-4sIvtgfJkWO0CGwEmOownTZXCSQlbREEBEVRK1eZTElKszcMKPYNftxv7Af2KfmSgVLqOK3SrmvrBwO6uvecc48Pac-DC6Y0l2IKc0lfK0noq-MnwFaMZhUvc6bAMG2gbrscJ0Ep5MSQjGgGR9C3b_szAM-DnBWkKg3UpKzYFNpWro1-U8IRyKLobCOVkU0rFzlbYcWoXC6ZyInhUmjMBMlKln8EQIpmXDGpcqbwL5ILjUu-5AaO4PGkc-awXWS-OE9SFEOC0jSMnkLBiKkUG9WMGqlwo2h0p6BvVMW6ly1IqVknpn5TjqjKM8yFYUqQcmQsHlbyV6wNMVwbTvWIaCwLbPiycdUb__O37mbyxr5-kOi2V4_ufO_LouhG2jr_UaRuX_uPJ92ghw8i2mX1yJIuieEUU1mWjNpfedfixshuaOv-_0FfcmGdbj3XluRRN8Ej3_8EfiEVo0Qb_fUk67U2bImbUGhsF2jrX4GgZrSNcM4MU0sumqzhgq-qa_05uXbOE9TcAzNnHqMgRZAGTxYIrqus5HS0goGzRyCM0kOITlOIzhcL19nLbivt0_w0StI4CKMUVvj6NVvDWRw-C-KX8BN6CQMCQTIfus5eGB2jF7DCGeb5CgZZU3eGs5njBAu7YUtt1Yy2_GH0I5qnkKRBGiZpOE-gf-kAAPzefNtPj9Q_Y81_Y70p-O5dmcqyWgrdm8Llttj297bPV7v9ihHDckxMbwq9A3986Pljzx-DP576_tT3ezvN9hhyQQ2mshJ2YOzvcr_i2kgbVWzW11ZYb3eY53ZgpyCqstwi7eLYu2TLcDAZH0yad3-4X-pB9k08aBR-ng0HX2KDc9WffSrDa5vh6oMM1w9leN2R4ep-hte4bjNc_4cMrzszbIU_PBEcH8M9STUurKiT0xiFT6NWVD2EGJ2gGEVzlLx3bAZk2GXMRYiev_Olbs62Pc2us1dZR5whBAkkaGHVEhcyFyoXajiJT5_dx3ff0_v8BxQjyOAIJtYK9OJsEYQRDE7PUhdQdDF8h_pdC1bPHM_zPIcLwZRn_4BgQJXUeujAzeavm83bm81b0JQIWH9QWX1_e4fYN3_aHNxsNrcNVAptFOHCTGH_YH88hcv9CXiwP7lydtoKXhqmNAzs_Th0_g0AAP__siO6fQ==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyslNFO3DwQha_xU8xd4BeJQAiEWHER8qdV2pBFG4OKqsryOhPVJbHB42yXB-sL9MkqJ1XpRaBqxW1y5jtnTkaJY7hBR9qaM8isunNWqs__XwBuUa0H3TXowCN52EwqxuqcQyO9XEtCOIcovI0WAHEMDbZy6DxsZDfgGUxSTZ4eOjgH27azMjl4O0q1aXArHCrb92ga6bU1JNDIdYfNCwBrxnGH1jXoxBerDYlO99rDOZwczc6cTotk5XXN8xXUOedF9RZalH5wmGxQeevEmCh5ShB5N-D8sq3sCGeZ9NAlyjVroY1HZ2SX-MATzn4V5KXX5LWiRJKwrfC6H1uND79_o3mn-PCAnjX6qaXkqffItu086VfzL5Lme41Ojuahp88Sw7KUBNNeeq2Esl2HKnzl3ysei5xHh_b_hd5rE5qeOqdgcjxvcHxw8Ad-ax0qSZ5eLzI9ksdejEdBIiwwPX8Fgw2q6YQb9Oh6bcZbE63eDvf0N3fNrut8_A8sWLbKU54DTy_KHCjxsMt2JBQVP4VqyaG6Lst9tpMtq5qv0qLi4MX9HT7C1aq4TFe38D6_hV0JaZ3tsb3FgrG0DLEnXrBIArSo3uUZh5qnvKh5kdUQffwULRjLP1yVaVHB7vKK70Ne3exBnZdB-x-8WS0vQ6QFi-M4ZqSkAc9-BAAA__81TpNk

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexsA5FgI0gQJPAiTYUigOEGtWN0R4ypUcqGImvOyHV2OYSv0gv0KD5JQaloumBSNMiWGr4_fPp5DisKbLw7hyuv74NH_eX9O6Ad6XVrbEUBhFhg209l2aJcQoWCa2SCKQzi18EFQJ5DRTW2VmCLtqVz6Ef7MyUBHaMW453atGiNPChfK6awNTqC1qjv74JvXZWEBbprLYaeaVh4Y2EKvq6T09iK70aNq2inAmnfNOQqjPmsyOHaUvUCwLvueiAfKgrqqzeOlTWNEZjC6XHyzlkv52p2u1iWn2BRLpfX8w9QE0obqNiSFh9Ut1HxtMFAQktpgTVapiSTN7bQoVor44SCQ1tI5KngvysWFMNiNBfI0bGYpvtT-eTnD04n5ZMxPxv0e5aLJ-8DX9dp0h_zL5LSXgenx2no2bPE-FguYmiDYrTS3lrqWva34k5kGh3tv4beGBdN9845hpykA07G43_wax9IIwu_3cr8wEKN6krBKj6gP3-DgC3pvsIVCYXGuK5rqja79hv_T6-z8vPN7PJ6DsOPN8sjKOerEawuZ7flAoaT0UWW53medTc4g8N-f9g_HvaPMJwcjbJfAQAA__93FZMj

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zoQhvc6xexsA5FgI0gQJPAiL08oAhhuUDtGd8SYGrVsKbLmjFRnl0P4Kr1Aj-KTFJSKpgsmRYtsqeH3Dz_9eQ4bCmy8u4Qbrz8Hj_rj__8B7UlvW2MrCiDEAt0wlWWrcg0VCm6RCeYwil9HVwB5DhXV2FqBDm1LlzCMDmdKAjpGLcY7tWvRGnlQvlZMoTM6gnQwYjTaJCrQh9ZiGIiGhXcW5uDrOjmNrfh-1LiK9iqQ9k1DrsKYzoocbi1VLwC8668H8qGioD5541hZ0xiBOZyfJu9cDGpuFverdfkOVuV6fbt8AzWhtIGKjrT4oPqNiqcNRhJaSuur0TIlmbyzhQ7VVhknFBzaQiJPBf9VsaAYFqO5QI6GxTT9f8pn379xOimfTfnZoJ-zXDx5H_m6TpN-mX-RlPY6Oj9NQy-eJcbHchFDGxSjlfbWUt-x3xX3ItPoaP9f6I1x0fTgnGPIWTrgbDr9A7_2gTSy8OutzA8s1Ki-FKziA4bzVwjoSA8VrkgoNMb1XVO12bdf-G96nZXv7xbXt0sYv71bn0C53Exgc724L1cwnk2usjzP86y_wRkcD4fj4fF4eITx7GSS_QgAAP__nfCSTg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMlOiSlWR72WfuBfdlAqXCcVm7TtfODAV3de865R4d0XXjNlOaynMNS0o2ShH68fgFsx2hacZExBYZpA3XX5TgxSiAjhqREM7iCoX07XAC4LmQsJ5UwUBNRsTl0rV0NG0VKTajhssT3FRHcNFjmWDNVc2qBqOKGUyJ6oRT7UAmiOkSujb4XcAUyz3u7SWVk28rLjO2wYlQWBSszYtk1ZiVJBcu-AiDLdlwxqTKm8O-SlxoLXnADV_D8onfmsrNmubqLExRBjJIkCF9CzoipFJvWjBqpcKto-qBgaFTF-u3LidCsF1PfiylVWYp5aZgqiZgai4eV_ANrQwzXhlM9Jdo6bHjRfid39s_fup_JnXn6JNGnXj198H0o87wf6eD8V5H6fR0-v-gHvTyJaJfVU0taEMMpplII1mbs2OLWyH5o6_5_QS94aZ3uPNeW5Fk_wTPP-wZ-LhWjRBv98yTrRhtW4DYUGtsFuvpPIKgZ7SKcMcNUwcs2azjnu2qrvyfXzl2M2ptl4Swj5CcIEv_FCsG2SgWn0x2MnDMCQZhcQrhOILxbrSbOWfqp0j0t12GcRH4QJrDD2w1r4DYKXvnRW_gNvYURAT9ejifOWRBeozewwynm2Q5GaVt3xouF4_gru2FHbdVMD_xB-CtaJhAnfhLESbCMYfjOAQD4s_23vwGpP2DN92wwB2_yUKZSVEWpB3N4dyh2_YPD8_vjfsWIYRkmZjCHwbk3u3S9mevNwJvNPW_ueYOjZnsMeUkNprIq7cDMO-b-yLWRNqrYNFsrbHA8zDM7cFQoKyEOSMc49i45MJxfzM4v2nd_TX7Ug_R_8aBV-H02nP-IDc774eJbGW5shqsvMlyfynDTk-HqcYYbXHcZrp-Q4aY3w08QvrfCt5svlCuWn9K-79G-3TxB5P6kyNNr-dfX8Mi3GueW_WYdoeBl2LHXY4jQDYpQuETxZ2d7RMan8fef4-ebx8iK5SexGxhV44XjoDe3Kz8IYbS-TSaAwtdjiNHK7vkL3ETrV7BfOK7ruo6mpIS9828AAAD__0NwzHQ=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMlOiSlWR72WfuBfdlAqXCcVm7TtfODAV3de865R4d0XXjNlOaynMNS0o2ShH68fgFsx2hacZExBYZpA3XX5TgxSiAjhqREM7iCoX07XAC4LmQsJ5UwUBNRsTl0rV0NG0VKTajhssT3FRHcNFjmWDNVc2qBqOKGUyJ6oRT7UAmiOkSujb4XcAUyz3u7SWVk28rLjO2wYlQWBSszYtk1ZiVJBcu-AiDLdlwxqTKm8O-SlxoLXnADV_D8onfmsrNmubqLExRBjJIkCF9CzoipFJvWjBqpcKto-qBgaFTF-u3LidCsF1PfiylVWYp5aZgqiZgai4eV_ANrQwzXhlM9Jdo6bHjRfid39s_fup_JnXn6JNGnXj198H0o87wf6eD8V5H6fR0-v-gHvTyJaJfVU0taEMMpplII1mbs2OLWyH5o6_5_QS94aZ3uPNeW5Fk_wTPP-wZ-LhWjRBv98yTrRhtW4DYUGtsFuvpPIKgZ7SKcMcNUwcs2azjnu2qrvyfXzl2M2ptl4Swj5CcIEv_FCsG2SgWn0x2MnDMCQZhcQrhOILxbrSbOWfqp0j0t12GcRH4QJrDD2w1r4DYKXvnRW_gNvYURAT9ejifOWRBeozewwynm2Q5GaVt3xouF4_gru2FHbdVMD_xB-CtaJhAnfhLESbCMYfjOAQD4s_23vwGpP2DN92wwB2_yUKZSVEWpB3N4dyh2_YPD8_vjfsWIYRkmZjCHwbk3u3S9mevNwJvNPW_ueYOjZnsMeUkNprIq7cDMO-b-yLWRNqrYNFsrbHA8zDM7cFQoKyEOSMc49i45MJxfzM4v2nd_TX7Ug_R_8aBV-H02nP-IDc774eJbGW5shqsvMlyfynDTk-HqcYYbXHcZrp-Q4aY3w08QvrfCt5svlCuWn9K-79G-3TxB5P6kyNNr-dfX8Mi3GueW_WYdoeBl2LHXY4jQDYpQuETxZ2d7RMan8fef4-ebx8iK5SexGxhV44XjoDe3Kz8IYbS-TSaAwtdjiNHK7vkL3ETrV9AsHNd1XUdTUkLj_BsAAP__Q1_Mcg==

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkwXWYQpsrB5JStCgKgqKoljMlOiSlSR72WfuBfdlAqXCcVm7TtfODAV3de865R4d0XXjNlOaymMNK0q2ShH68fgGsZjQpuUiZAsO0garrcpwIxZASQxKiGVzB0L4dLgBcF1KWkVIYqIgo2Ry61q6GjSKFJtRwWeD7kghuGiwzrJmqOLVAVHHDKRG9UIp9KAVRHSLXRt8LuAKZZb3dpDSybeVFymqsGJV5zoqUWHaNWUESwdKvAMiiHVdMqpQp_LvkhcaC59zAFTy_6J257KxZre-iGIUQoTj2g5eQMWJKxaYVo0Yq3CqaPigYGlWyfvsyIjTrxdT3YkpVmmBeGKYKIqbG4mEl_8DaEMO14VRPibYOG56338md_fO37mdyZ54-SfSpV08ffB_KLOtHOjj_VaR-X4fPL_pBL08i2mX11JLmxHCKqRSCtRk7trg1sh_auv9f0HNeWKc7z7UledZP8MzzvoGfScUo0Ub_PMm60YbluA2FxnaBrv4TCCpGuwinzDCV86LNGs54Xe709-TauYtQe7MsnFWIljGCePlijWBXJoLTaQ0j54yAH8SXEGxiCO7W64lzlnyqdE-rTRDF4dIPYqjxbssauA39V8vwLfyG3sKIwDJajSfOmR9cozdQ4wTztIZR0tad8WLhOMu13bCjtmqmB34_-BWtYojiZexHsb-KYPjOAQD4s_23vwGpPmDN92wwB2_yUKZSlHmhB3N4dyh2_YPD8_vjfsWIYSkmZjCHwbk3u3S9mevNwJvNPW_ueYOjZnsMeUENprIs7MDMO-b-yLWRNqrYNDsrbHA8zFM7cFQoSiEOSMc49i45MJxfzM4v2nd_TX7Ug-R_8aBV-H02nP-IDc774eJbGW5shssvMlydynDTk-HycYYbXHUZrp6Q4aY3w08QvrfCd9svlCuWndK-79G-2z5B5P6kyNNrLa-v4ZFvFc4s-80mRP7LoGOvxhCiGxSiYIWiz872iIxP4-8_x8-2j5EVy05iNzAqxwvHQW9u10s_gNHmNp4ACl6PIUJru-cvcBNuXkG9cFzXdR1NSQG1828AAAD__0NOzHA=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfa6-4sIvtgfLkBO0CGzkwXWYQpsrB5JStCgKgqKoljMlOiSlWR72WfuBfdlAqXDcVGqTtfODAV3de865R4d0XXjDlOaymMNK0q2ShH66eglsz2hScpEyBYZpA1Xb5TgRiiElhiREM7iEoX07XAC4LqQsI6UwUBFRsjm0rW0NG0UKTajhssB3JRHc1FhmWDNVcWqBqOKGUyI6oRT7WAqiWkSujb4TcAkyyzq7SWlk08qLlO2xYlTmOStSYtk1ZgVJBEu_ASCLZlwxqVKm8O-SFxoLnnMDl_DivHPmorVmtb6NYhRChOLYD15BxogpFZtWjBqpcKNoeq9gaFTJuu3LiNCsE1PfiSlVaYJ5YZgqiJgai4eV_ANrQwzXhlM9Jdo6bHjefCd39s_fupvJnXm6l-hzr57e-z6UWdaNdHT-m0jdvg5fnHeDXvQi2mX11JLmxHCKqRSCNRk7tbgxshvauv9f0HNeWKdbz7Uled5N8NzzvoOfScUo0Ub_PMm61obluAmFxnaBtv4TCCpG2winzDCV86LJGs74vtzpp-TauY1Qc7MsnFWIljGCePlyjWBXJoLT6R5GzjMCfhBfQLCJIbhdryfOs-RzpX1abYIoDpd-EMMe77ashpvQf70M38Fv6B2MCCyj1XjiPPODK_QW9jjBPN3DKGnqznixcJzl2m7YUls10yO_H_yKVjFE8TL2o9hfRTB87wAA_Nn829-AVB-x5gc2mIM3uS9TKcq80IM5vD8W2_7B8fnDab9ixLAUEzOYw-DMm1243sz1ZuDN5p4397zBSbM9hrygBlNZFnZg5p1yf-LaSBtVbOqdFTY4HeapHTgpFKUQR6RTHHuXHBnOzmdn5827vyY_6kHyv3jQKHyaDWc_YoPzYbj4XoYPNsO77VchVizri_GhI8a77SPyeujM6yNE1lZk-ZXGqk9h3aGw_PKg1bhqD1r1COF1r_D-VZdXV3AiKdvC9SZE_quglaNYNoYQXaMQBSsUPaAbleN-7Pohtt0lswt_wVD14u9hRJ6C_1B7P_LBJmG8cBz09ma99AMYbW7iCaDgzRgitLYW_gLX4eY11AvHdV3X0ZQUUDv_BgAA___Y2eeH

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lOFu2zYQxz-HT3HwFyeDJchK06U28kFx1EGbKgeWErQoCoKiqJYrRSYk5SYb9lh7gT3ZQKp1jEHN1iH1BwO--9__jj-eGQRwzbThSi5gpehHrQj9cHEO7I7RuueiYRosMxa2gwqhMq2gIZbUxDA4g6nLTpcAQQANa0kvLGyJ6NkCBukQw1YTaQi1XEl82xPB7T1WLTZMbzl1RlRzyykRo1aave8F0YMjN9bcCjgD1bajatJb5aVcNuwOa0ZV1zHZENfdYCZJLVjziIGSvlwzpRum8a-KS4MF77iFM3h-PFpzOqBZ5VdllW6gTKsqK36ClhHbaxZuGbVKYz9R-DDB1OqejeNriTBs1NPcipDqpsZcWqYlEaF1flirT9hYYrmxnJqQGEfY8s7fUzD_608z3imYR-arjT5rTfjAfaradtxpR_5Rp3Gu0-fH46anX3V0hzWha9oRyymmSgjmd2wfsQc5bu3o_x_3jktHemBuXJOT8QYnUfQv_q3SjBJjzdONbO6NZR32S2GwO8AQf4IGW0aHFW6YZbrj0u8abvldf2O-Za_RVZn6l2WJVps0qVKokvM8hZu-FpyGNRyigxrO1-scinUFxVWez9CBVp94A1lRnfrodVZmruiLAi7Sl8lVXkEv-W3vL4c3h0czdLBaF2W1SbKighrffGT3cLnJXiWbN_BL-gYOB9-kXDltVlykr6HGNebNHRzWPo6OlkuEktwBGSZ1w4e7cbPi53RVQVklVVZW2aqE6VsEAPC7_3afCdm-x4b_xiYLmM8ewlSJvpNmsoC3u6BP1JPd73f7es2IZQ0mdrKASRzFcTCPgyiG-eni-NkifhGe_PjsxXE82atxf14uqcVU9dLVxXvJD9xY5dYb2_sbN91kv5Q3_5hXks6LsF8tjPfFshdi1yPaS7i36Ut8Po8in_lj9gii6L8g8hf3HTFF34YpfkpMnxmhd9MlQunryzzJCjhcX1YzSIvrIyjT3K3cD_Bys34F9RIFQRAgQ4mEGv0dAAD__-BzUqk=
