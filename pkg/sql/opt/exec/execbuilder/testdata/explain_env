# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20AQhs_sU_zyhaSNiZ1ckFGlmmBUt8ZBjktBCFlreyHbrnej9Zoaqko8RJ6QJ6lsaJoLantgDyPNzP-NZvSvbeOM6Zor6WGmim9a0WJ5dAjWsiJvuCiZhmG1we2TihDbhmZKl0xnXxWXdSZ4xQ2WtIZZMpTsmjbC4JaKhnnY7_RM0lyw7J7f3NObnnpJrmSnVyvDK37PdNbULFvy2qgbTav6f6iqEYYXSmS1oeYvJGtXTPOKSUNFtqLacCoyLkvWspfJ62tCZkngpwFS_zAK0GJAdijCON1HPE8Rf46iEdnJnytP2WweL9LED-MU1krziuo7C6dJeOInF_gUXGBA4S9mwxHZCeOj4Bxtlme8bDHIf9eP_ZMwutjCB3SEfEiGB4T4URokz_t0tu2tmlzwYq9FGH8MZikWqZ-GizScLbB7SQDgRx-7ZxVKNJWsLQ-Xm2LfoNYmvxpt6TWjhpUZNZYHa-K4-7bj2o4Lx_Ucx3Oct320tpCS14bLwmSFamSHuY6z1e69zjrbzN2KdVO3YdkIsQG3Ma2-_xk4mbqTad_7OfrnC_NXvLBf6PWOJFe7B4QE56eRH8YYzE_TEYL4bIhFEHWWv8FxMj9Biy8fgiRAjneYHhDbtm1SF1Siff_8xwge1-vH9cPj-gGFkrXRlEvjYTwZux4ux1PYGE-vyK8AAAD__11rLZc=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20AQhs_sU_zyhaSNiZ1ckFGlmmBUt8ZBjktBCFlreyHbrnej9Zoaqko8RJ6QJ6lsaJoLantgDyPNzP-NZvSvbeOM6Zor6WGmim9a0WJ5dAjWsiJvuCiZhmG1we2TihDbhmZKl0xnXxWXdSZ4xQ2WtIZZMpTsmjbC4JaKhnnY7_RM0lyw7J7f3NObnnpJrmSnVyvDK37PdNbULFvy2qgbTav6f6iqEYYXSmS1oeYvJGtXTPOKSUNFtqLacCoyLkvWspfJ62tCZkngpwFS_zAK0GJAdijCON1HPE8Rf46iEdnJnytP2WweL9LED-MU1krziuo7C6dJeOInF_gUXGBA4S9mwxHZCeOj4Bxtlme8bDHIf9eP_ZMwutjCB3SEfEiGB4T4URokz_t0tu2tmlzwYq9FGH8MZikWqZ-GizScLbB7SQDgRx-7ZxVKNJWsLQ-Xm2LfoNYmvxpt6TWjhpUZNZYHa-K4-7bj2o4Lx_Ucx3Oct320tpCS14bLwmSFamSHuY6z1e69zjrbzN2KdVO3YdkIsQG3Ma2-_xk4mbqTad_7OfrnC_NXvLBf6PWOJFe7B4QE56eRH8YYzE_TEYL4bIhFEHWWv8FxMj9Biy8fgiRAjneYHhDbtm1SF1Siff_8xwge1-vH9cPj-gGFkrXRlEvjYTwZux4ux1PYGE-vyK8AAAD__11rLZc=

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFO2zAUhq_xUxzlhnRLaNreoKBJC8XdspUUpRkDIWQ5qUs9UqeynSxlmoT2DL3c0_VJpqQFojG2cUEuLPmc_7d89H-xbcMpk4pnwoV-llzLjCazo0NgJUvinKcTJkEzpaHYqBCybZAskxMmyZeMC0VSPucaZlSBnjGYsCnNUw0FTXPmwn6lZ4LGKSM3_OqGXtWup-SZqPTZQvM5v2GS5IqRGVc6u5J0rp7jmuep5kmWEqWp_oeTlQsm-ZwJTVOyoFJzmhIuJqxkTzunU4T6IfYiDJF3OMRQgol2KPhBtA_BKILg03BooZ14W9ns-qNgHIWeH0RgLCSfU7k04CT0j73wHD7iczApeON-y0I7fnCEz6AkMeGTEsz4rj7wjv3hecNuUgviFmodIOQNIxxu71PFtrfI45QneyX4wQfcj2AceZE_jvz-GHYvEADAt3qtPiPJ0nwulOHCxX2xblDjfn9pNfSSUc0mhGrDBaPrdPZtp2M7HXA6ruO4jvO6Xo2GZcKV5iLRJMlyUdk6jtNo11mTKja9XLDq1KZZ5Gl6b2zaZPb14cBur9Pt1b3v1n9PGL_ghPWFXm5IdLl78BuKywrF_BGKxTNRzO-Qa0in16Qgkk1JCYNRiP13wUZbtCDEAxzioI_HUJr0AeElKTYIF08jnFtQ_B3h5R8RrmfHZydDzw_AHJ1EFuDgtAVjPKy0r2AQjo6htGAJn9_jEEMMb6B3gGzbthEXgkm7fo_MRGZKtRCsVz_Xq9v16hZUQgUsH1XKt9tfsur8qBJYr1ZbQZIJpSXlQrvQ7rY7Lly0e2BDu3eJGrIpTzWTCkwtc9ZCvwIAAP__4_mV6w==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k8FO3D4Qxs_4KUa5kP3_E5SFC1pOYQlS2pBFGxeBELKcZJZ169gr24FAVYmH2GOfjiepEuh2pQq1PZCDFX_z_UYz-uQwhAs0Vmg1gamuvhjNq-XJMWCHVdkKWaMBh9bB3YuLkDAEg9rUaNhnLZRlUjTCwZJbcEuEGhe8lQ7uuGxxAoe9HxUvJbJHcfvIbwfqLbtWvV-vnGjEIxrWWmRLYZ2-Nbyx_0I1rXSi0pJZx90fSOxWaESDynHJVtw4wSUTqsYO3yYXC0Km8ySmCdD4OEugA5_scEhzegj5jEL-KcsCslO-Ki-36Swv6DxOcwreyoiGmwcPzufpWTy_go_JFfgc4mI6CshOmp8kl9Cxkom6A7_8qZ_GZ2l2tYX7PIByREZHhMQZTeav8_Sx7a3aUopqr4M0_5BMKRQ0pmlB02kBu9cEAODrcPafV2nZNsp6E7jeiEOBe5v7TbDlN8gd1ow7bwLefjQ-DKNxGI0hGk-iaBJF_w-nt4XUwjqhKscq3aoeG0fRVnnImvWxuYcV9l23YdVKuQG3MaPvfzXcPxjvHwy1b8Ffb1i-44bDQO-3JLnZPSIkuTzP4jQHf3ZOA0jyixEUSdZH_h-czmdn0EFcgFYYvPy5e31EwjAMiVAKTTi8Sr8y2toRgef19-f10_P6CWzFVY_9prl73WvrV20hpENjwXemxRH5EQAA__-3bkFJ

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zwYx_Hj6ip-9KTOS9TwEhgloQeuq2zeHCXYWtdQilAcJdHqP0GWjZ2jXkSuMFcysnSwDcbYocTnK_HwUIoHbStTFiMEZfpiS5Vu7--gW50ua5OttIXTlUNzVoQkTMDq0q60lV9LU1QyM7lxuMW74RigFCu9VnXm0Kis1iPcEEqhC7XMtNybzV5tvnfYqgpuq3_nZXHy5c6Z3Oy1lXWl5dZUrtxYlVf_UuV15kxaZrJyyv2l1O1OW5PrwqlM7pR1RmXSFCvd6j-X6zUhQcx8wSD8u4ihg0cuaoRc3IDPBPjnKOqTi-bt5nwKZjwRsR9ygcudNbmy3SXmcTj14wU-sQW8Gn4S9H6l6xfZSKvXssVkFrPwPT_bpoeYTVjMeMAStJ46dSG_Z4_oZCPNqoXX_Hhv4k_DaPHTt17dR9MjvTEhfiRY_DbHaePXu3qZmfS6Q8g_skAgEb4IExEGCa6enq_GhLDHeeSHHN5sLvpg_KGHhEUn-x8m8WyKDl8-sJihxi2GY0IppaRKVYGO4Hg4HA-vx8Mr0rKonFWmcCMM_h_haTAExWD4TL4FAAD__93P01M=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zwYx_Hj6ip-9KTOS9TwEhgloQeuq2zeHCXYWtdQilAcJdHqP0GWjZ2jXkSuMFcysnSwDcbYocTnK_HwUIoHbStTFiMEZfpiS5Vu7--gW50ua5OttIXTlUNzVoQkTMDq0q60lV9LU1QyM7lxuMW74RigFCu9VnXm0Kis1iPcEEqhC7XMtNybzV5tvnfYqgpuq3_nZXHy5c6Z3Oy1lXWl5dZUrtxYlVf_UuV15kxaZrJyyv2l1O1OW5PrwqlM7pR1RmXSFCvd6j-X6zUhQcx8wSD8u4ihg0cuaoRc3IDPBPjnKOqTi-bt5nwKZjwRsR9ygcudNbmy3SXmcTj14wU-sQW8Gn4S9H6l6xfZSKvXssVkFrPwPT_bpoeYTVjMeMAStJ46dSG_Z4_oZCPNqoXX_Hhv4k_DaPHTt17dR9MjvTEhfiRY_DbHaePXu3qZmfS6Q8g_skAgEb4IExEGCa6enq_GhLDHeeSHHN5sLvpg_KGHhEUn-x8m8WyKDl8-sJihxi2GY0IppaRKVYGO4Hg4HA-vx8Mr0rKonFWmcCMM_h_haTAExWD4TL4FAAD__93P01M=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0cFq2zAcx_Fz9RQ_eqkz4oYRGCUhB9dVNm-OE2ytayhFKI6caLWtIMvGzqkPkSfMk4w0HWywsR0lvh-JP3_Xxb00ldLlCL5On40W6fbuFrKV6apW-VoaWFlZNOeKkIQyGKnNWhr-Xauy4rkqlMUEH4ZjwHWxlpmoc4tG5LUc4eaVyFKscsn3arMXm1eICXSW_ZHokrgu9M6qQu2l4XUl-VZVVm-MKCpsRQW7lf-jijq3KtU5r6yw_5Cy3UmjCllakfOdMFaJnKtyLVv5d5llhPgx9RgF825Dig4OuagRROwG0Zwh-hqGfXLRvN2cT_48SljsBRHD5c6oQpjuEos4mHnxEl_oEk4NL_F7v6fZM2-4kRlvMZ3HNPgYndumh5hOaUwjnyZoHXFyQXRHH9Dxhqt1C6f5-d7UmwXh8pdvnbqPpkd6Y0K8kNH4bY7T1q939SpX6XWHIPpMfYaEeSxIWOAnuHp8uhoTQh8WoRdEcOYL1geN7ntIaHhq32Eaz2fo8O0TjSlqTDAcE9d1XVKlokRHcDwcjoeX4-EFqS4ra4Qq7QiD9yM8DoZwMRg-kR8BAAD__2P607U=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx80d9q2zwYx_Hj6ip-9KTOS93wEhglIQeuq2zeHCfYWtdQilAcOdHqP0GSjZ2jXkSuMFcyknSwjW6HEt-PxMPjuniQ2qiqHMKv0hddiXRzfwfZynRZq3wlNaw0Fs25IiShDFpWeiU1_16p0vBcFcpijA-DEeC6WMlM1LlFI_JaDnF7IrIUy1zynVrvxPoEMUaVZe-SqjyZamtVoXZS89pIvlHGVmstCvNv6bp_wKLOrUqrnBsrrMFGGNiNfF_Kdiu1KmRpRc63Qlslcq7KlWzl32WWEeLH1GMUzLsLKTo45KJGELFbRDOG6GsYXpOL5u3mfPJnUcJiL4gYLrdaFUJ3l5jHwdSLF_hCF3BqeInf-z3NXnjDtcx4i8kspsHH6Nw2PcR0QmMa-TRB64ijC6J7-oiON1ytWjjNz_cm3jQIF79869TXaHqkNyLECxmN3-Y4bv5mWy9zld50CKLP1GdImMeChAV-gqun56sRIfRxHnpBBGc2Z9eg0UMPCQ2P7X-YxLMpOnz7RGOKGmMMRsR1XZeYVJToCA77_WH_eti_Iq1KY7VQpR2i__8QT_0BXPQHz-RHAAAA__8nQ9QX

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zAUx_Hr6il-9KbOqBtGYJSEXLiusnlznGBrXUMpQnHkRKv_BEk2dq76EHnCPMlI0sHGBmOXEt-PxOG4Lh6kNqoqh_Cr9EVXIt3c30G2Ml3WKl9JDSuNRXOuCEkog5aVXknNv1eqNDxXhbIY48NgBLguVjITdW7RiLyWQ9yeiCzFMpd8p9Y7sT5BjFFl2V9JVZ5MtbWqUDupeW0k3yhjq7UWhflfWdS5VWmVc2OF_Yd2Xch2K7UqZGlFzrdCWyVyrsqVbKXBRhjYjfxDZhkhfkw9RsG8u5Cig0MuagQRu0U0Y4i-huE1uWjebs4nfxYlLPaCiOFyq1UhdHeJeRxMvXiBL3QBp4aX-L3f0-yFN1zLjLeYzGIafIzObdNDTCc0ppFPE7SOOLoguqeP6HjD1aqF0_x8b-JNg3Dxy7dOfY2mR3ojQryQ0fhtjuP2b7b1MlfpTYcg-kx9hoR5LEhY4Ce4enq-GhFCH-ehF0RwZnN2DRo99JDQ8Ni-wySeTdHh2ycaU9QYYzAiruu6xKSiREdw2O8P-9fD_hVpVRqrhSrtEP33Qzz1B3DRHzyTHwEAAP__LO7UeQ==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUzUHr2jAYx_F7XsXvuI0F1E7rlB26LgPBVtdW8RZi-2izpY0mqYivfjhvgzH-twee74cf59iT89r2C6S2_uWsqttvX0F3qo-DNg05BPIBt1fFWCkqOLKuISd_Wt17aXSnA75gFi0BztHQSQ0m4KbMQAvMGeegXh0NyYc-P9T5j0OrPEJLf-e2f_b2EnSnH-Tk4Em22gd7dqrzb1HdYIKurZE-qPAfSfcLOd1RH5SRF-WCVkbqvqE7_VueToylhUgqgVL82Ik8FfB0RbbK98l6JzBGlhxe5-fJJIriySiazaef4ng6H8VY5WkhMpFXGKOskqLCeMmYOGzXySrHu822-giR79-jFGuRVviA78Ume04sGeecM0_XgfqauCdDdXh-2O8AAAD__7f4mP4=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9O4zgUxq_xUxzlhnQ3oWkrrVAqpA3F3c1uSVGS4Y8QspzUpR7SpLKdTMpoJDTP0Mt5uj7JKGmBwAzMcEEuLPmc73fso_M5pgmnTEiepTYMsvhGZDSeHR0CK1kc5TyZMAGKSQXFRoVQgEMQLBMTJsjHjKeSJHzOFRzAX70-gGnChE1pnigoaJIzG_aRaQJLaZQwcsuvb-l1zcGMSlAz9lyepZU-Wyg-57dMkFwyMuNSZdeCzuVbqHmeKB5nCZGKql-QrFwwwecsVTQhCyoUpwnh6YSV7GVyOkVo4GMnxBA6hyMMJehoh4LrhfvgjUPwPoxGBtqJtpHNbjD2gtB3XC8EbSH4nIqlBie-e-z4F_A_vgCdghMMWgbacb0jfA4liQiflKBH9_Ghc-yOLhq4Tg2IWqjVR8gZhdjf3qea3N4ijxIe75Xgev_hQQhB6IRuELqDAHYvEQDA53qtPi3OknyeSs2Gy4dgnaDaw_7KaOgFo4pNCFWaDVrX6uybVse0OmB1bMuyLevPetUayIRLxdNYkTjL0wrrWFYjXc-aVGNTywWrqjbhNE-SB7CJiezTY8Fur9Pt1bkvxm93GL1jh_WF3q9JdLXbf2bFZWXF_AcrFm-0Yn5vuYZ0ekMKItiUlDAc-9j9x9toixb4eIh97A1wAKVOHy28JMXGwsXLFs4NKF638PKnFm72furiMyg2z8GAuiI4AQR4VGGPURj64-Onz8N4dtTZv9jHEMEB9PoI4fOTkeN6oI9PQgOwd9q6L_rHplbRR6ZpmoinKRNm_YPTY5FJ2UKwXn1br-7WqzuQMU2fnvNqtvx7-_Yr1ddq1OvVaiuOs1QqQXmqbGh32x0bLts9MKHdu0IN2ZQnigkJuhI5a6HvAQAA__9J27YO
