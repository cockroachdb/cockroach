# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k19O60YUxp-ZVRz5JUkVO3aiK105ilRfM1C3wUG2oSCERuPxpIxwbPCMU6dVJRaRrXQDXQorqcaBkKoB-ueSh0g--c53vnPys2nCOa-kKAsX_JLdViVlN4dfgDecpbXIM16B4lLBcqNCyDQhxglkVNGUSg4T6GhBZ4zaspBK3ucwgXI-HwOYJmR8TutcwZLmNXeB1qpspaLIeEMqzsrFghcZVaIsJOEFTXOevWGgQ-h-f3oWJzjSaZIgPAZ5n1usylIiCsWrguaW0lakKn8mUlElpBJMWlSSck6UWLTRTeeP32Vn7xzTseWrg5600voXC-_z0cGkpSULqgQjrMxzzvQprJdLzGku-V5vVdX8v3gvRKFvsrmOhAl82mv_ybbfcZ-XFWdUKvm14sqVVHxB2r9OEh1-U__H9siPsJdgSLwvU9yya93VaS6Y1UAXHVAIwuQzhLMEwrPptI8O0qfK5smfhXESeUGYQEPubvkKTqPgxIsu4Qd8CV0KXuz3-uggCA_xBTQkJSJroJu2ddQbI-RN9Wb7xgfh99hPIE68JIiTwI-hc4UAAH5tv_XHoMufiBS_cMMFu_9SZmVeLwppuHC1LW70xvb5eldfcap4RqgyXDCGtvPZtB3TdsB2XNt2bdvYEWuGRcEUYWVd6AbH3p19I6QqNT1Ere50MGO3uajzfNu426bfu63hcOQMR-1vv_X_78rph6zcJvy4rdF1Z_wGmyvNZv03Npevsbnaw2b9zOZfdEsy18qjWYSD43CjXPYgwkc4wqGPY3jms0tfwNZ9LdjL98Fe7QW73RdfnE69IITu7DTpAw7PexDjqdZ-A0fR7AQa-PE7HGFIYQKjMTJN00SS0QKab5_eLQSP6_Xj-uFx_QCsLKSqqCiUC4PhwHHhajACEwaja_RnAAAA___CnvZc


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B5MR4pRoJARYK7KdNpcOZDUrkUQEBRFrVxlMhUpT9owoNgz-OdeYy-wR8mTDJRTx0Pddh-tfxjg4bnnnnt9aIzhuaiN1CqAUPPXtWb81eNHIFrB80ZWhajBCmNhs2MhhDGkJIOCWZYzI-Acho4wnKMelsaaNxWcgy7LOQDGUIiSNZWFDasaEQBrrO6pUhWipbXger0WqmBWamWoUCyvRPERAWfC1YfLZ2lGEucmi-InYN5UU14XOZXKilqxamqdFK31T9RYZqWxkpspM1SX1Mp1bx37f_5hhkf7YN8zH2x0xzXTfzHwMR1nzEwdZc2s5JTrqhLcrWJ6v4mSVUYc1bZ1I_6L9loqt5Pddgycw4Oj8g887xPqpa4FZ8aaz2XXdMaKNe1_OkOd-R3-j-VRmJBFRiBbPFqSPrvTmyavJJ-2MEInDKI4ewjxKoP42XI5QSf5HbI7has4zZJFFGfQ0pvXooPLJHq6SF7Cd-QljBgs0nA8QSdR_Ji8gJbmVBYtjPIeR-M5Qoulm-xY-yj-loQZpNkii9IsClMYXiEAgF_6b_cZsM0P1MifxSAAb3IPc101a2UGAVztwR1_sD9fH_JrwawoKLODAAZnnv8Qez72fPD8wPMCzxsckF2GpeKWct0oV-B7h71fSWO1Sw-13Y0zNjgsVk1V7QsPy9y72wuezfyzWX_36-T_jpx_kZF7h19uanQ9nH8km53LZvNeNjcfymZ3JJvNu2z-jbehpWNerBISPYl3zM0YEnJBEhKHJIV3-Ryx-2C7uj7Ym08Huzsa7H5e8uJyuYhiGK0uswmQ-PkYUrJ03K_gIlk9hXYCHXz_DUkI5HAOsznCGGMklRI1_lFLBSNea2PGCG63v99u395u34LhTEH3HtJ-ffcc3c1vbuu32-0dgWtlbM2ksgGcnp36AVydzgDD6ewaHdBKWVlRGxi5v5Ix-isAAP__XLEadA==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1uo0YUvs48xRE3tiuDIKuVVrZ8wbKTFa0XR8CudhVFo2EYutPgmYQZHNyqUh7Cl32NvkAfJU9SDU4cV3WS_my4QMw53_nOdw4fuC584o0WSk4gUuyiUZR9ffcWeMdZ0Yq65A0Yrg2stiiEXBcynENJDS2o5jCDgQUMpqgPC230VQ0zUFU1BXBdKHlF29rAitYtnwBtjeqhQpa8Iw1narnksqRGKKkJl7SoefkEgRVh66P5xyzHqVWTx8l70Fe1x5qyIEIa3khae8ZSkUZdE22oEdoIpj2qiaqIEcteuhv88bseHOzjBr5-tNEdVnv_YuBDPFaY9ixkSY1ghKm65syuwnvYREVrzQ9ym6bl_4V7KaTdyXY7Gmbw-iD9a99_hr1SDWdUG_2t5Oq1NnxJ-leniRW_jf9jehSlOMwx5OHbOe696122RS2Y18EQHVGIk_wNJIscko_z-RgdFXeR7SlaJFmehnGSQ0cuL_gaTtP4Q5h-gR_wFxhSCLNoNEZHcfIOf4aOFESUHQyLPo5GU4TCuZ3sUPs4-R5HOWR5mMdZHkcZDM4QAMAv_d1eDl39SLT4mTsT8McPYabqdim1M4GzXXCLd3bn8318w6nhJaHGmYBz7AdvXD9w_QD8YOL7E9939sDWw0IyQ5hqpS0I_P3eX4U2yrqHmPWlFebsF8u2rneF-2X2u9sRHr8Kjl_1uV_H_3fk4kVG7hW-3NTofDB9wptr6832b95cPebN9QFvtvfe_AtuRSqLPFmkOH6fbJGrEaT4BKc4iXAG9_4c0gdj27re2Kvnjb0-aOx-Xvz5dB7GCQwXp_kYcPJpBBmeW-x3cJIuPkAHYQZK8vH2yVyrKXJd10VCSt64PykhYcgapfUIwe3mt9vNze3mBjSjEjo4o3qmJD9_JGWuVZ_a3KUqURveaBjaH8UI_RkAAP__1ZwO3w==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99u2zYUxq_DpzjQjZ3BUqQYHQIZvlBVptPmyoGkdi2CgKAoeuUqkalIedaGAX2IvMpeYI-SJxkot46Hqe3-1RcGdPx93_njn1wXXvBWCyVDiBV70yrKXj95DHzHWdmJuuItGK4NbPcqhFwXclxARQ0tqeawhIkVTBZoKAtt9NsalqA2mwWA60LFN7SrDWxp3fEQaGfUIBWy4jvScqaahsuKGqGkJlzSsubVJwKUHOwtV23FW_KjElKTWjTCwBK-no96LtDgiVfP8wJndoEiSZ-Cflt7rK1KIqThraS1Z2x30qqfiDbUCG0E0x7VRG2IEc2wrRv8_puejLZxA19_tNF7rfb-wY3Gcuxg2rOShhrBCFN1zZm9nvdwvA2tNR_NNm3H_012I6S9yf46GpbwaDT-ke9_Jn2jWs6oNvr_Glf32vCGDH-dJnb4ff1vx6M4w1GBoYger_CAu3fblbVg3g6m6IRCkhYXkK4LSJ-vVjN0Ur6v7J_idZoXWZSkBezI7Rvew1WWPIuyV_AdfgVTClEen87QSZI-wS9hR0oiqh1My6GOThcIRSu72Vj7JP0WxwXkRVQkeZHEOUyuEQDAL8O3_Th0-wPR4mfuhODPHspM1V0jtRPC9aG41zuH55tjfcup4RWhxgnBOfeDC9cPXD8APwh9P_R950hsGRaSGcJUJ60h8I97vxbaKEsPMf2tHcw5Nsuurg_GY5t97w6B5_PgfD789uvsv65cfpGVhwm_3NboZrL4BJu9ZbP7C5vbj7HZj7DZfWDzT7ot2Vjl5TrDydN0r9yeQoYvcYbTGOfwgc8pfQDb-gawt58Hux8Fe9gXv7xaRUkK0_VVMQOcvjiFHK-s9iu4zNbPoIfvv8EZhg6WMF8g13VdpBmV0CO4v7u7v3t3f_cOmJLatFRIE8JZEML12RxcOJvfoD8CAAD__10NA5o=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4kIvdgZLkWJ0CGT4QVWZTpsrB5LatQgCgqLolatEpiLlWRsG9CPyK_uBfUq-ZKDcOh7mpOvW-MEAr845957LQ9eFV7zVQskQYsXetYqyt8-eAt9wVnairngLhmsD6y0KIdeFHBdQUUNLqjnMYWQBoxkaykIb_b6GOajVagbgulDxFe1qA2tadzwE2hk1QIWs-Ia0nKmm4bKiRiipCZe0rHn1gICSA73lqq14S35WQmpSi0YYmMO304OcMzRw4sXLvMCZNVAk6XPQ72uPtVVJhDS8lbT2jO1OWvUL0YYaoY1g2qOaqBUxohncusGff-jRwTZu4Ot7G33Eau8LdvSgzhdu4D49a1R7tmVDjWCEqbrmzN6Gd3cZK1prflDYtB3_L9qNkHbH221rmMOTg_JPfP8z6ivVcka10V9rXN1rwxsyREETO_y2_q_lUZzhqMBQRE8XeHg-3nVX1oJ5GxijIwpJWpxBuiwgfblYTNBR-bGyPcXLNC-yKEkL2JDrd7yHiyx5EWVv4Af8BsYUojw-nqCjJH2GX8OGlERUGxiXQx0dzxCKFtbZofZJ-j2OC8iLqEjyIolzGF0iAIDfhn_7c-j6J6LFr9wJwZ_clZmqu0ZqJ4TLXXGLd3bnq318y6nhFaHGCcE59YMz1w9cPwA_CH0_9H1nD2zfhJDMEKY6aQmBv9_7rdBG2fQQ01_bwZx9suzqekfcp9l3vBM8nQan0-Hb75P_a7l8FMvDhI_nGl2NZg9ks7fZ7P6RzfV92ewPZLP7lM2_4dZkZZHnywwnz9Mtcn0MGT7HGU5jnMOnfI7pXbAtbwj2-vPB7g8Ge_CLX18soiSF8fKimABOXx1DjhcW-w2cZ8sX0MOP3-EMQwdzmM6Q67ou0oxK6BHc3tzc3ny4vfkATEltWiqkCeEkCOHyZAounEyv0F8BAAD__-wmHbY=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkWJ0CGT4wXWZTpsrB5LatQgCgqKolKtEpiLlWRkG9CPyK_uBfUq-ZCDdJh6mpOvW-sEAr845957LQ8-DV7zRQskQloq9axRlb589Bb7lLG9FVfAGDNcGNjsUQp4HKc6goIbmVHOYw9AChjPkykIb_b6COaiynAF4HhS8pG1lYEOrlodAW6MclEuaV5xci8trekl-UUJaluwlqbJ0HCELviUNZ6quuSyoEUpqslMqHmmqpKM3XDUFb1wzTSpRCwNz-H7ayzlBjrNcvUwznFjTWRQ_B_2-mrCmyImQhjeSVhPjfDTqV6INNUIbwfSEaqJKYkTtNuQFf_6hh71tvMDXDzb6iNWTL9jrozpfuIGH9KxRPbEta2oEI0xVFWf2Nib3l1HSSvNeYdO0_L9o10LaHe-2rWEOT3rln_j-Z9RL1XBGtdFfa1zdacNr4qKgiR1-V__X8miZ4EWGIVs8XWH35CZXbV4JNtnCCB1QiOLsBOJ1BvHL1WqMDvKPld1puY7TLFlEcQZbcvWOd3CWRC8WyRv4Cb-BEYVFujwco4MofoZfw5bkRBRbGOWujg5nCC1W1llf-yj-ES8zSLNFFqVZtExheI4AAH5z__Y3oJtLosU1H4Tgj-_LTFVtLfUghPO74g4_uDtf7OMbTg0vCDWDEAbHfnDi-YHnB-AHoe-Hvj_YA9s3ISQzhKlWWkLg7_d-K7RRNj3EdFd2sME-WbZVdUfcp9l3fCd4PA2Op-7b7-P_azn_JpbdhN_ONboYzh7JZmez2f4jm5uHstn1ZLP9lM2_4TaktMjTdYKj5_EOuTmEBJ_iBMdLnMKnfI7ofbAtzwV78_lgd73Bdn7x67PVIophtD7LxoDjV4eQ4pXFfgenyfoFdPDzDzjB0MIcpjPkeZ6HNKMSOgS3Nze3Nx9ubz4AU1KbhgppQjgKQjg_moIHR9ML9FcAAAD__537LzM=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvQ6f4oNv7AyWI8XoEMjIhesynTZXDiS1axEEBEVRKVeJTEnKszMM6EPkVfYCe5Q8yUC6TTzMSdat0YUAfjrnfH-HCgJ4w7URSsYwU-yDVpS9f_Ec-IqzshNNxTVYbiwsNyiEggByXEBFLS2p4XAMfQfoT5APC2PNxwaOQdX1BCAIoOI17RoLS9p0PAbaWeWhXNKy4eRKXFzRC_KLEtKx5E6SqmvPEbLiK6I5U23LZUWtUNKQjVL1QFIlPV1dWtGKK65JZzh5L4xVF5q25nGm5kpXXPsyDWlEKywcw_fjnZwj5Dmz-eu8wJkbV5GkL8F8bEZMVyUR0nItaTOyfgJa_UqMpVYYK5gZUUNUTaxo_WyD6M8_TH9nmiAKzb2JPmPN6Cs28qDOV07gPj3XqBm5lC21ghGmmoYzt8fR3Rpr2hi-U9jqjv8X7VZIN-PNtN2-n-2UfxaGj6jXSnNGjTXfqlyzNpa3xFvBEFf8Jv6v5dEsw9MCQzF9Psf-so4uu7IRbLSCAdqjkKTFEaSLAtLX8_kQ7ZWfI5vTbJHmRTZN0gJW5PIDX8NplryaZu_gJ_wOBhSm-Wx_iPaS9AV-CytSElGtYFD6ONqfIDSdu852pU_SH_GsgLyYFkleJLMc-mcIAOA3_3ZPjy4viBFXvBdDOLwLM9V0rTS9GM5ugxt87_Z8vo3XnFpeEWp7MfQOw-goCKMgjCCM4jCMw7C3BXZ3QkhmCVOddIQo3M7tfwzOPcSuL11hvW2y7JrmlrhNc_f4VvBwHB2O_bffh_-35fJJWvYVPl3X6Lw_ecCba-fN7h_eXN7nzfUOb3ZfvPk33JLUDnmyyHDyMt0gl_uQ4ROc4XSGc_jizwG9M7bjeWMvHzf2eqexfb_47el8mqQwWJwWQ8Dpm33I8dxhv4OTbPEK1vDzDzjD0MExjCcoCIIAGUYlrBHcXF_fXH-6uf4ETEljNRXSxnAQxXB2MIYADsbn6K8AAAD__9a0Q34=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3dgbLkWJ0CGTkwnWZTpsrB5LatQgCgqKolCtFpiLl2RkG9CHyKnuBPUqeZCDdJh7mpM226EIAj77vOz_8joIA3vDWCK1imGn2odWUvX_xHPiKs7ITsuItWG4sLDcohIIAclxARS0tqeFwDH0H6E-QDwtjzUcJx6DregIQBFDxmnbSwpLKjsdAO6s9lCtaSk6uxMUVvSC_aKEcS-0k6br2HKEqviItZ7ppuKqoFVoZslGqHkiqlafrSysaccVb0hlO3gtj9UVLG_NYZtNJK5iWxFhqv4Hdct1WvPVNGiJFIywcw_fjnZwj5Dmz-eu8wJkbdpGkL8F8lCPWViURyvJWUTmyfn6t_tWXIYwVzIyoIbomVjT-ZoLozz9Mf2eaIArNvYk-Y83oEff5oM4jJ3Cfnp_3yKVsqBWMMC0lZ84FozsT1FQavlPYth3_N9qNUG7Gm2m7-362U_5ZGH5FvdYtZ9RY83-Va9bG8oZ4Kxjiit_Ev1kezTI8LTAU0-dz7Fd9dNmVUrDRCgZoj0KSFkeQLgpIX8_nQ7RXfo5sTrNFmhfZNEkLWJHLD3wNp1nyapq9g5_wOxhQmOaz_SHaS9IX-C2sSElEtYJB6eNof4LQdO4625U-SX_EswLyYlokeZHMcuifIQCA3_zbPT26vCBGXPFeDOHwLsy07BplejGc3QY3-N7t-Xwb33JqeUWo7cXQOwyjoyCMgjCCMIrDMA7D3hbY7YRQzBKmO-UIUbid2_9WnHuIXV-6wnrbZNVJeUvcprk9vhU8HEeHY__t9-F_bbl8kpZ9hU_XNTrvTx7w5tp5s_uHN5f3eXO9w5vdF2_-DbcktUOeLDKcvEw3yOU-ZPgEZzid4Ry--HNA74zteN7Yy68be73T2L5f_PZ0Pk1SGCxOiyHg9M0-5HjusN_BSbZ4BWv4-QecYejgGMYTFARBgAyjCtYIbq6vb64_3Vx_AqaVsS0VysZwEMVwdjCGAA7G5-ivAAAA___O9Fl_

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysks-O0zAQxu9-irktIBz1D92WrXoowaBKbXZp02pvlutMhMGxicdZlgfjBXgy5BSJS3dhEbdo8s3vm_nGnMMBAxnvriD3-nPwSn98-wbwHvWxM7bCABEpwt1JxRjnsBMlVCqqoyKEBVwkwcWc9WVDkVoLC_B1PQfgHCqsVWcj3Cnb4RWoLvpealyF9zKg9k2DrlLReEcSnTparB4BeNe3B_ShwiA_eeNIWtOYCAu4HJ_tmbG-J1_vd6XYpgXKVfEeqLWZDtVRGhcxOGWzmNxl8F8lRRUNRaMpUyR9LaNp-m358Md3ujhrw4cDetDol5ayJ2T0KOeJCTzES4tSliwbFY2W2luLOl0j-32MWlnCs-AYOvwXdmNcyviUNsECJmfxk8HgD_TaB9SKIv2vcekbRWxk_xRIpuFP9b_Gs3wrlqWAnfiwF0Uu4Et3tEZnhC1sVsVhud4LGMJmeXv6fD0ajcfT0WB8OZu8mk4ns8EUVkW-FRtRlDCEXbncljCcMyZub9bLVQHPrm_KlyCKw3PYibXIS3gB77bXGyBs54xzzhlh26HTyAlT5OkP-xkAAP__dz9HLQ==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4kR47RIZBhYKrLdNpcOZDUtEUQEBRFr1xlMiUpzd4woNgz-OdeYy-wR8mTDJTz4a5Oum6LfxjQ1bnn8FyeK9-HM66NUDKEqWLvtKLs7bOnwFecFbWoSq7BcmOh2aIQ8n3IcA4ltbSghsMEug7QHaO2LIw17yuYgFosxgC-DyVf0Lqy0NCq5iHQ2qoWKmTJV0RzppZLLktqhZKGcEmLipcPECjZtmuudMk1-VEJaUgllsLCBL4e7e05Rm3PdPYyy3HqDORx8hzM-2rAdFkQIS3XklYD69SJVj8RY6kVxgpmBtQQtSBWLFu3_vDPP0x3r4w_DMy9QtdYM_iCGT3I84UTuI_PGTUDJ7mkVjDCVFVx5m5jcHcZC1oZvpfY6pr_G-6lkG7G22kbmMCTvfRPguAz7AulOaPGmv_ruGZtLF-SNgqGuMNv6_-YHk1THOUY8ujpDLfrM7isi0qwwQp66IBCnOTHkMxzSF7OZh46KK4r26fpPMnyNIqTHFbk8h1fw2kav4jSN_A9fgM9ClE27XvoIE6e4dewIgUR5Qp6RVtH_TFC0cw52ycfJ9_haQ5ZHuVxlsfTDLrnCADgl_bf_Tq0-YEY8TPvhBB4d2WmqnopTSeE89viFt-5fb7YxWtOLS8JtZ0QOkfB8NgPhn4whGAYBkEYBJ0dsNsJIZklTNXSNQyDXe23wljl0kPs-tIdrLPbLOuqum3cbXN7fEt4NBoejdp3v3r_1XLxKJbbEz6ea3TRHT-QzbXLZv1JNpv7srnek836Jpsf4RqycMiTeYrj58kW2fQhxSc4xckUZ3CTzx69C7bra4PdfD7Y673B3vV7FuNXNzJNu4Vu7zx0UDuPqA9RBhmeOQ7qQeFB7UEDJ-n8xccb5P1N99W3OMVQwARGY4Tw69NZFCfQm5_mHuDkrH9D-tWWqxkj3_d9JKTk2ndfbugxrYzpI7ja_H61-XC1-QCGUQnrTyqrb66X3b35zd3p1WZzDWBKGqupkDaEw6PDYQjnhyPw4XB0gXZgC1FZrg303Ieqj_4KAAD__yvtXyg=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk1Fu00AQhp-7p5i3JKhrpUJFVaM8uMYgg-tE9raiQmi1scdiqb1LdyalPRgX4GTIDhISSgtFfR398_0z_-xKCZcYyHp3Comvr4M39efXZ4B3WG-2tmswACMx3O5UQkgJVaqgMWw2hhCWMBkEk4UYy5aYbjpYgm_bBYCU0GBrth3Drem2eApmy36UWtfgnQ5Y-75H1xi23pFGZzYdNo8AvBvbA_rQYNBfvHWkO9tbhiW8erm350SMPUl-Uam0HBZQWfEW6KaL6tBstHWMwZku4sFdB_9NExu2xLamyJD2rWbbj9vKox_fabLXRh7N6UGjX1qKnpDRo5wnJvAQb1iUosGyN2xrXfuuw3q4RvT7GK3pCPeCOWzxf9i9dUPGu7QJlnC8F388n_-F3vqAtSGm5xqX7omx1-NTID0Mv6v_M14kZRqrFFR8lqfj94koYpiKAwNZoU6gWCkoLvL8UBwkq6JSZZwVClh_vcZ7WJfZeVxewfv0CqYG4iqZidlCiDgfxv2DmRXv0kRBpWKVVSpLKph8_DRZCJF-WOdxVsB0tVaHkBaXM6jSfNC-gDfl6hwo4oWQUkpBtXHA4mcAAAD___pdTbE=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysksFuEzEQhu9-irk1kepVIlSEGuVQygpVikJF0oibNeudLaZeW_HMhvbWh8ir8AI8Sp4EeQPisi0UcR39__ePf4_WsKHELoZzuIz2LkW0n9-9BbonW3XO15RAiAV2R5VSWsOqXEONghUywRxOsuBkpvoxNdh5MZIwMFpxMZhth97Jg4mNYUo7Z7OpQnt3m2IX6hmA1r-MsEPf0Tkkuu08piPTsfDWwxxi0wyqsZPYS12o6d4ksrFtKdSY89lQwMpT_Qwght6eKKaakvkSXWDjXesE5vD61aDnjeo9l4ub1br8mEtZXy3fA299YVNdGReEUkBfSE43KX41LCiOxVkukHMf4tq-QT39_o1PBmP0dMJPBv3UcvGCjp7lvLCBp3j5oVzkyBbFWWOj99RfQ_H7Mxr0TINgSR39C7t1IXd8bJthDmeD-LPJ5A_0JiayyML_a11-YKHW9KfAJi9_nP81XpWfrhcXV0sYfbhen0K53Ixhc7G4KVcwmo5nSmutVW9gBYf9_rB_POwfYTQ9HasfAQAA___0aU7P

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFuE0EQRfdzitrZltIjWygIxfIiBAtFskyEHYtdq9xTAwU93XJXjUl2OYSvwgU4ik-CegxiMwkEsS39_3717zIGNpSEY7iAq-i-pIju05vXQHfkti37ihIoicL-pCoKY2A1X0OFilsUghkMsmAwLbox1dh6tZowCDrlGOyuRc96b2NthdKeXTa5xMoO_RTAmF822KNv6QISfWw9phORRWXnYQaxrnvV2GrspBwqurOJXGwaChXmdLEUcOupegIQQ2dPFFNFyX6OHMR6blhhBi9f9HpeFZ3nanG7Ws_f50rW18u3IDtfulRtLQelFNCXmtNtil-tKCqLspMSJbeh3HT9mcn3bzLojTGTsTwa9FMr5TM6epLzzAYe4-WHSpkjG1R21kXvqbuF8vdn1OiFesGaWvoXdsMhd3xqW2AG57348_H4D_Q6JnIoKv9rXbkXpcZ2pyA2L3-a_zW-mH-4WVxeL2H47mZ9BvPlZgSby8XtfAXDyWhaGGNM0RmkgOPhcDw8HA8PMJycjYofAQAA___HYE36

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBN0CGzkwXWZQpsrB5JatCgKgqKoljNNOiSlWR72WfuBfdlAuUlcVHbXrdGDAF6dc-49V4dBAG-4sUKrCcw1WxlN2acXz4FvOcsrIQtuwHHroN6jEAoCSHEGBXU0p5bDNfQ9oD9FbZmXtJKOOEOVpcwJrchdRaVwDdElsdzUgnkSM8IJRuUUIAjuaVBTWfEJGP6xktTsFYV19k7CNeiy7ETTyukWKlTBt8Rwptdrrgrqu1vCFc0lL04IaNXSDdem4Ib8poWyRIq1cHANP192cq5Qy5kvXqcZTvxKsih-CfZOjpgpciKU40ZROXK-OzH6d2IddcI6weyIWr8NJ9bt_oLx33_ZfmebYBzao40-Y-3oO3Z0Uuc7N3BMzxu1I99yTZ1ghGkpeZuF0ePPKKm0vFPYmYr_F-21UH7H-21buIZnnfLPwvAb6qU2nFHr7I8a1zbW8TVpo2CJH35f_9fyaJ7gWYYhmz1f4PZCjjZVLgUbbWGAzihEcXYF8TKD-PViMURn-efK_jRfxmmWzKI4gy3ZrHgDt0n0apa8g1_xOxhQmKXz8yE6i-IX-C1sSU5EsYVB3tbR-RSh2cI762ofxb_geQZpNsuiNIvmKfTfIwCAP9q3f3q0_kis2PHeBMLhY5lpWa2V7U3g_UNxj-89nD8c4g2njheEut4Eehfh-CoIx0E4hnA8CcNJGPYOwP5OCMUcYbpSnjAOD3t_EtZpnx7imo0frHdIVpWUD8RDmr_HD4IXl-OLy_bbn8P_azl_EsvthE_nGn3oT09ks_HZrL7KZn0sm01HNqv7bH6Bq0npkTfLBEcv4z2yPocE3-AEx3Ocwn0-B_Qx2J7XBrv-drCbzmCf9rvzfjerrwwbXh6zvOuwvFl1eC5XX7o1vOzy2wyq0752x33ht7eLWRTDYHmbDQHHb84hxQuP_QlukuUr2E1REAQBsowq2KF_AgAA__8Fj2e7

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBN0CGzkwXWZQpsrB5JatCgKgqKoljNNOiSlWRn2WfuBfdlAuXFcVHbXrdGDAF6dc-49V4dBAG-4sUKrCcw1WxlN2acXz4FvOcsrIQtuwHHroN6hEAoCSHEGBXU0p5bDNfQ9oD9FbZmXtJKOOEOVpcwJrchdRaVwDdElsdzUgnkSM8IJRuUUIAgeaFBTWfEJGP6xktTsFIV19k7CNeiy7ETTyukWKlTBt8Rwptdrrgrqu1vCFc0lL04IaNXSDdem4Ib8poWyRIq1cHANP192cq5Qy5kvXqcZTvxKsih-CfZOjpgpciKU40ZROXK-OzH6d2IddcI6weyIWr8NJ9bt_oLx33_ZfmebYBzao40-Y-3oO3Z0Uuc7N3BMzxu1I99yTZ1ghGkpeZuF0ePPKKm0vFPYmYr_F-21UH7Hu21buIZnnfLPwvAb6qU2nFHr7I8a1zbW8TVpo2CJH35X_9fyaJ7gWYYhmz1f4PZCjjZVLgUbbWGAzihEcXYF8TKD-PViMURn-efK7jRfxmmWzKI4gy3ZrHgDt0n0apa8g1_xOxhQmKXz8yE6i-IX-C1sSU5EsYVB3tbR-RSh2cI762ofxb_geQZpNsuiNIvmKfTfIwCAP9q3f3q0_kisuOe9CYTDxzLTslor25vA-31xh-_tzx8O8YZTxwtCXW8CvYtwfBWE4yAcQziehOEkDHsHYH8nhGKOMF0pTxiHh70_Ceu0Tw9xzcYP1jskq0rKPfGQ5u_xXvDicnxx2X77c_h_LedPYrmd8Olcow_96YlsNj6b1VfZrI9ls-nIZvWQzS9wNSk98maZ4OhlvEPW55DgG5zgeI5TeMjngD4G2_PaYNffDnbTGezTfu-9383qK8OGl8cs33dY3qw6PJerL90aXnb5bQbVaV_3x33ht7eLWRTDYHmbDQHHb84hxQuP_QlukuUraKYoCIIAWUYVNOifAAAA__8Ffme5

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBN0CGzkwXWZQpsrB5JatCgKgqKoljNNOiTlSRn2WfuBfdlAuXFcVHbXrdGDAF6dc-49V4dBAG-4sUKrCcw1WxlN2acXz4HXnOWVkAU34Lh1sN2hEAoCSHEGBXU0p5bDNfQ9oD9FbZmXtJKOOEOVpcwJrchdRaVwDdElsdxsBfMkZoQTjMopQBA80GBLZcUnYPjHSlKzUxTW2TsJ16DLshNNK6dbqFAFr4nhTK_XXBXUd7eEK5pLXpwQ0KqlG65NwQ35TQtliRRr4eAafr7s5FyhljNfvE4znPiVZFH8EuydHDFT5EQox42icuR8d2L078Q66oR1gtkRtX4bTqzb_QXjv_-y_c42wTi0Rxt9xtrRd-zopM53buCYnjdqR77lmjrBCNNS8jYLo8efUVJpeaewMxX_L9profyOd9u2cA3POuWfheE31EttOKPW2R81rm2s42vSRsESP_yu_q_l0TzBswxDNnu-wO2FHG2qXAo2qmGAzihEcXYF8TKD-PViMURn-efK7jRfxmmWzKI4g5psVryB2yR6NUvewa_4HQwozNL5-RCdRfEL_BZqkhNR1DDI2zo6nyI0W3hnXe2j-Bc8zyDNZlmUZtE8hf57BADwR_v2T49uPxIr7nlvAuHwscy0rNbK9ibwfl_c4Xv784dDvOHU8YJQ15tA7yIcXwXhOAjHEI4nYTgJw94B2N8JoZgjTFfKE8bhYe9Pwjrt00Ncs_GD9Q7JqpJyTzyk-Xu8F7y4HF9ctt_-HP5fy_mTWG4nfDrX6EN_eiKbjc9m9VU2t8ey2XRks3rI5he4LSk98maZ4OhlvENuzyHBNzjB8Ryn8JDPAX0Mtue1wd5-O9hNZ7BP-733fjerrwwbXh6zfN9hebPq8FyuvnRreNnltxlUp33dH_eF394uZlEMg-VtNgQcvzmHFC889ie4SZavoJ6iIAgCZBlVUKN_AgAA__8FbWe3

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBN0CGzkwXWZQpsrB5JatCgKgqKoljNNOiSlWR72WfuBfdlAOU08VHbWbfGDAV6fc-491-cGAbzjxgqtJjDXbGU0ZV9evQS-5SyvhCy4Acetg3qPQigIIMUZFNTRnFoO19D3gP4UtWVe0ko64gxVljIntCJ3FZXCNUSXxHJTC-ZJzAgnGJVTgCD4SoOayopPwPDPlaRmryiss3cSrkGXZSeaVk63UKEKviWGM71ec1VQ390SrmgueXFCQKuWbrg2BTfkFy2UJVKshYNr-PGyk3OFWs588TbNcOJXkkXxa7B3csRMkROhHDeKypHz3YnRvxLrqBPWCWZH1PptOLFu9xeM__zD9jvbBOPQHm10j7Wj79jRSZ3v3MAxPW_UjnzLNXWCEaal5G0WRo9_Rkml5Z3CzlT832ivhfI73m_bwjW86JR_EYZPqJfacEats__XuLaxjq9JGwVL_PD7-j-WR_MEzzIM2ezlArcHOdpUuRRstIUBOqMQxdkVxMsM4reLxRCd5feV_Wu-jNMsmUVxBluyWfEGbpPozSz5AD_jDzCgMEvn50N0FsWv8HvYkpyIYguDvK2j8ylCs4V31tU-in_C8wzSbJZFaRbNU-h_RAAAv7Xf_tOj9WdixY73JhAOH8tMy2qtbG8CHx-Ke3zv4f3pEG84dbwg1PUm0LsIx1dBOA7CMYTjSRhOwrB3APY3IRRzhOlKecI4POz9RVinfXqIazZ-sN4hWVVSPhAPaf6OHwQvLscXl-1vvw__q-X8WSy3Ez6fa_SpPz2RzZ3P5mb1TTgNL4_Fc9cRz83qaz4PgOUKbpYJjl7He5Dh5Tkk-AYnOJ7jFO5HaAbV6QDvOgN82lfjfVXf2KqPmWo6TFUdnhpSk9Ij_-as7vK1HdAnFtJJ2w02q8dD9_3aQ6-fPvTm-J7w-9vFLIphsLzNhoDjd-eQ4oXH_gA3yfINNFMUBEGALKMKGvRXAAAA___JM3d9

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8VNFu2zYUfQ6_4kIvdgZLkJVmS234QXHUQZsqB5YStCgKgqLolitFxiTlxhv2WfuBfdlAukk9wMmSYasfDOjcc869OrxUGMI104YrOYG5op-0IvTjxTmwW0abnouWabDMWNjsWAiFIVRZDS2xpCGGwQwGjjCYIg-zFemFxVYTaQi1XEm87ongdovVChumN5w6EdXcckrEFCAM72SwIaJnE9DsQy-I3jlyY81awAzUanWQTXqrPJXLlt1izajqOiZb4robzCRpBGsfMVDSyzVTumUa_6K4NFjwjluYwfcnBzVnyGvmxVVVZ0sXSZ2XP4JZi4jqtsFcWqYlEZF13bFWn7GxxHJjOTURMS4NyzufXzj-8w8zONgmHMfmwUZfuCZ6RkaP-jwzgYf83IuayLXsiOUUUyUE87sQfT2MFRGGHTS2umf_xrvj0mW8S9vADE4P2p_G8T-4r5RmlBhr_qtxzdZY1mG_Cga74Xf4k-3RfJmldQZ1el5k_kJGN30jOI0aGKKjBs4XiwLKRQ3lVVGM0JFWn3kLeVmfefQ6r3KnvGPARfYqvSpq6CVf9z4w3g6PR-hoviirepnmZQ0NvvnEtnC5zF-ny7fwc_YWhjvftJo7bl5eZG-gwQ3m7S0MG4-j4ylCaeGCODRtXv6UzWuo6rTOqzqfVzB4hwAAfvP_7heQzQds-K8smMB49BWmSvSdNMEE3t2DvtAE98_v9_maEctaTGwwgSCJkyQcJ2GcwPhscvJikryMTn948fIkCfY07iZxSS2mqpdOl-wVP3Jjlds4bLc3brpgXypJ5zHsDxjjv9V6Ie4t472C-y7c4eNxHPvK76NHEomfkog_pv8xlfjbpfIlEvR-MEUoe3NZpHkJw8VlPYKsvD6GKivcQn0Hr5aL19BMURiGITKUSGjQXwEAAP__jLcHUQ==
