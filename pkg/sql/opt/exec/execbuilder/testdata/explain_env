# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U2Fu2zYY_R2e4oP_2BksRbJRoJARYKrCdNpcOZCUrkUQEBRFrURlMRUpTd4woIfIVXaBHSUnGShljrspC7qu_mFAnx7fe3x6n2XBa14rISsPAsne15Kyd2cvgHecZY0oc16D5kpDO6AQSnAKOdU0o4rDKUzN2-kKwLIg5wVtSg0tLRvuwQAVSqsPJZyCLIpRGG207KGiynlHas7kdsurnGohK0V4RbOS5_9C8JerYH2ZpDiGBKdpGL2EglPd1NxuOdOyJj29_UA31XXDx50XtFR8lFN9KG1W5xkRleZ1RUtbGz5Sy5-J0lQLpQVTNlVEFkSLbR-R5f7xuxpXslxHPSp0j1X2Q4hTWRTjTPsYx5iMNWUbyJZqwQiTZcmZCfgwkP7a4-wmq__CvhWVyWVISBmRZ-MCzxznCf5C1pxRpdX_Z1ntlOZb0n9CRcwFhvlnCKDLBPcbskJBjP0UQ-q_WGO4abJSMLuDGTqiEEbpc4g2KUSX6_UcHWX3k-Ep2ERJGvthlEJHbt7zHVzE4Ss_fgs_4Lcwo-AnwfEcHYXRGX4DHcmIyDuYZf0cHa8Q8tfmgoOyMWPv5cPoexykkKR-GiZpGCQwvUIAAL_2_-Y3oe1PRIlf-MQDZ_4wZrJstpWaeHC1Hw74yf75-hBfc6p5TqieeDBZOO5zy3EtxwXH9RzHc5zJAdhUWlRMEyabyhxwnUPtd0JpaYpE9O7GGJscHha5OXAwqJqy3DMd8pi93Csslu5i2b_7bf6lGWRfJYPe4efFsPiSGND1dPVUhXemws0_Ktw-VuHdSIWbTyu8I-1Q4fbpCu9GK2x8P37CPzuDTxy1pDCezjcxDl9Gg6f2GGJ8jmMcBTj529bMqLGE31ys_TCC2eYinQOOXh9DgtfGyzdwHm9eQQc_fodjDBmcwnKFLMuykGK0gu7b-y1FcHd7e3f78e72IzBZKV1TUWkPThYnrgdXJ0uw4GR5jf4MAAD__y0ZLKU=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VGFu2zYY_R2d4oP_2B4sRYpRoJARYKrDdNpcOZCUrkUQEBRFrVxlMhUpzdowoNgZ_HPX2AV2lJxkoJQ57qos6Lr6hwF9fHzv8elRtg0vWaW4FD4sJX1bSULfnD0DtmU0q3mZswo0UxqaHmVZCUohJ5pkRDE4hbFZHS8AbBtyVpC61NCQsmY-9FCutHpXwinIohiEkVrLDspFzra4YlRuNkzkRHMpFGaCZCXL_4Xgb1fL1WWSohgSlKZh9BwKRnRdMadhVMsKd_TOPd1YVzUbdl6QUrFBTvWudGiVZ5gLzSpBSkcbPlzJn7DSRHOlOVUOUVgWWPNNF5Ht_fmHGlayPVc9KHSHVc59iGNZFMNM-xiHmIw15RjIhmhOMZVlyagJ-DCQ7tjD7Car_8K-4cLk0iekjMiTYYEnrvsIfyErRonS6v-zrFql2QZ3r1Bhc4B-_gkC1mWCuhuysJYxClIEafBsheCmzkpOnS1MrCMCYZQ-hWidQnS5Ws2so-xu0j8t11GSxkEYpbDFN29ZCxdx-CKIX8N36DVMCATJcjqzjsLoDL2CLc4wz7cwybq5NV1YVrAyB-yVjRlnLx9G36JlCkkapGGShssExlcWAMAv3b_5jUjzA1b8ZzbywZ3dj6ks641QIx-u9sMeP9o_Xx_iK0Y0yzHRIx9GJ6731HY92_XA9XzX9V13dAA2leaCakxlLcwGzz3UfsOVlqZIWLc3xtjocDPPzYaDgajLcs90yGPu5V7hZO6dzLu1X2efm0H2RTLoHH5aDCefE4N1PV48VuHWVLj-qMLNQxVuBypcf1jhFjd9hZvHK9wOVtj4fnhHcHYGHzhqcGE8na9jFD6Pek_NFGJ0jmIULVHyj1szIcYSenWxCsIIJuuLdAYoejmFBK2Ml6_gPF6_gO0MWvj-GxQjyOAU5gvLtm3b4kKwyv5RcgETWkmlphbc7n6_3b2_3b0HRYmA9qPJ9uu7i21WfjNv53a3uwNQKZSuCBfah-OTY8-Hq-M52HA8v7YOYAUvNasUTMyXaWr9FQAA__-TM1Cu

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkFIUKGzkQVWYQpsrB5JStAgCgqKolatMpiKlyBsG9CPyuN_YD-xT8iUDpcxxN2VB19UPhnV5eM7h8aEcB97wWgsllxAq9qFWlL0_fQm84yxvRFXwGgzXBtoBhVCKMyiooTnVHE5galenKwDHgYKXtKkMtLRq-BIGqNBGf6zgBFRZjsJoY1QPFbLgHak5U9stlwU1QklNuKR5xYt_IfjLVbi-SDOcQIqzLIpfQcmpaWrutpwZVZOe3n2gm5q64ePOS1ppPsqpP1Yuq4ucCGl4LWnlGstHanVDtKFGaCOYdqkmqiRGbPuIHP-P3_W4kuN7-lGhe6x2H0KcqrIcZ9rHOMZkrWnXQrbUCEaYqirObMCHgfTHHme3Wf0X9q2QNpchIW1Fno8LPPe8J_hLVXNGtdH_n2W904ZvSf8XamIPMMy_QABdpLi_ISsUJjjIMGTByzWG6yavBHM7mKEjClGcvYB4k0F8sV4v0FF-Pxmewk2cZkkQxRl05PoD38F5Er0OknfwA34HMwpBGs4X6CiKT_Fb6EhORNHBLO_naL5CKFjbAw7K1oy7l4_i73GYQZoFWZRmUZjC9BIBAPzSf9vPhLY_Ei1-5pMleIuHMVNVs5V6soTL_XDAT_bPV4f4mlPDC0LNZAmTY89_4Xi-4_ng-UvPW3re5ABsKy0kM4SpRtoNvneo_V5oo2yRiNldW2OTw82isBsOBrKpqj3TIY-9l3uF42f-8bN-7dfF12aQf5MMeodfFsPx18SArqarpyq8sxVu_lHh9rEK70Yq3Hxe4R1phwq3T1d4N1ph6_vxHcHpKXzmqCWl9XS2SXD0Kh48tXNI8BlOcBzi9G-3ZkatJfz2fB1EMcw259kCcPxmDileWy_fwVmyeQ0dBCkoyRfDL3OjVshxHAcJKXnt_KSEhBmrldZzBHe3v93dfrq7_QSaUQkdXFJ9oiS_emTJ3Kh-6fZ-qRSV4bWGmX3vzNGfAQAA___YAUUZ

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgZLkWJ0CGTkQXWYTpsrB5LStQgCgqKolatEpiKlWRsG9CP8K_uBfUq-ZKBUOO6mLOi6-sGArs495_Do0LbhFasVl8KHlaTvakno24vnwLaMZg0vc1aDZkpDO6AsK0Ep5ESTjCgG5zA1b6dLANuGnBWkKTW0pGyYDwOUK63el3AOsihGYaTRsodykbMtrhmVVcVETjSXQmEmSFay_F8IpOjXaybrnNX4Z8mFwiWvuIZz-HYxunM2HGS1vk5SFEOC0jSMXkDBiG5q5rSMalnj3pHz4GCq64aNH7YgpWKjnOp96dA6zzAXmtWClI42fLiWv2ClieZKc6ocorAssOZVn6rt_fmHGleyPVc9KvQRq5yH3KeyKMaZ9smPMRlryjGQimhOMZVlyaj5JoeB9MceZzdZ_Rf2iguTy5CQMiLPxgWeue4T_IWsGSVKq__PsuqUZhXuP6HC5gDD_DMErOsE9Zdqaa1iFKQI0uD5GsFdk5WcOluYWUcEwig9g2iTQnS9Xs-to-zjZHhabaIkjYMwSmGL796xDq7i8GUQv4Ef0BuYEQiS1fHcOgqjC_QatjjDPN_CLOvn1vHSsoK1OeCgbMw4e_kw-h6tUkjSIA2TNFwlML2xAAB-6__Nb0Lan7Div7KJD-78YUxl2VRCTXy42Q8H_GT_fHuIrxnRLMdET3yYnLreme16tuuB6_mu67vu5ABsKs0F1ZjKRpgFzz3UfsuVlqZIWHd3xtjkcJnnZuFgIJqy3DMd8ph7uVc4XXini_7d7_MvzSD7Khn0Dj8vhtMvicG6nS6fqnBnKtz8o8LtYxXuRircfFrhDrdDhdunK9yNVtj4fnwjuLiATxy1uDCeLjcxCl9Eg6f2GGJ0iWIUrVDyt1szI8YSen21DsIIZpurdA4oenUMCVobL9_AZbx5CR38-B2KETRwDoulZdu2bSlKBHQW3O9297sP97sPQKVQuiZcaB9OPB9uThZgw8ni1vorAAD__wUGOdQ=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9FunEYUfTZfcbUvu64WDF4lslj5gazHKe2GtQCniSxrNAxDMw3MOMxAl1aV8hH-lf5AP8VfUg1E602LY6Vu9mElLveec-7hXNuG16xWXAofVpK-ryWh785eANsymjW8zFkNmikN7dBlWQlKISeaZEQxOIWpeTtdAtg25KwgTamhJWXDfBhaudLqQwmnIItitI00WvatXORsi2tGZVUxkRPNpVCYCZKVLP8CgBT9eM1knbMa_yK5ULjkFddwCs8XozMnwyKr9WWSohgSlKZh9BIKRnRTM6dlVMsa94qcewVTXTdsfNmClIqNYqoPpUPrPMNcaFYLUjra4OFa_oqVJporzalyiMKywJpXvau299efapzJ9lz1INGnXuXc-z6VRTGOtHP-i0jjvk6fL8ZBTx5ENMsqx5BWRHOKqSxLRs1X3re4N3Ic2rj_X9ArLozTg-fKkDwbJ3jmuo_gF7JmlCit_j_JqlOaVbgPhcJmgaH-FQTWZYL6M11aqxgFKYI0eLFGcNNkJafOFmbWAYEwSk8g2qQQXa7Xc-sg-1QZnlabKEnjIIxS2OKb96yDizh8FcRv4Uf0FmYEgmR1OLcOwugMvYEtzjDPtzDL-rp1uLSsYG0WHJiNGGdHH0Y_oFUKSRqkYZKGqwSmVxYAwO_9v_lNSPszVvw3NvHBnd-XqSybSqiJD1e74tA_2T1f7_fXjGiWY6InPkyOXe_Edj3b9cD1fNf1XXey12yOhAuqMZWNMAOeu8_9jistTZCw7m6MsMn-MM_NwF5BNGW5Q9rHMZe-YzheeMeL_t0f86d6kH0TD3qFX2fD8VNssK6ny8ci3JkIN_-KcPtQhLuRCDefR7jD7RDh9vEId6MRNrofngjOzuAzRS0ujKbzTYzCl9GgqT2EGJ2jGEUrlPzjambESEJvLtZBGMFsc5HOAUWvDyFBa6PlOziPN6-gg5--RzGCBk5hsbRs27YtRYmAzoK729u72493tx-BSqF0TbjQPhx5PlwdLcCGo8W19XcAAAD__0FeVD4=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgZLkWK0CGTkQXWYTpsrB5LStQgCgqKolKtMpiKlWRkG9CPyK_uBfUq-ZKBUOO4mN-i6-sGALu895_DwXNuG16xSXAofFpK-rySh785eANswmtW8zFkFmikNTd9lWQlKISeaZEQxOIWxOR3PAWwbclaQutTQkLJmPvStXGn1oYRTkEUx2EZqLbtWJkhWMnzHb-7IDf5VcmGmxOCQLIpuhoucbXDFqFyvmciJ5lIo3CPlXyCVohuvmKxyVnVkCpd8zTWcwvPZ4MxJf_nF8jJJUQwJStMwegkFI7qumNMwqmWFO0XOo4Kxrmo2bFBBSsUGMdWH0qFVnmEuNKsEKR3deVPJ37DSRHOlOVUOUVgWWPN19xK299efapjJ9ly1l-hTr3Ie32osi2IYaftaX0Qa9nX8fDYMerIX0VxWOYZ0TTSnmMqyZNS88q7FnZHD0Mb9_4K-5sI43XuuDMmzYYJnrvsEfiErRonS6v-TrFql2Rp3oVDYXKCvfwWBdZmgbrXn1iJGQYogDV4sEdzWWcmps4GJdUAgjNITiFYpRJfL5dQ6yD5V-q_FKkrSOAijFDb49j1r4SIOXwXxW_gZvYUJgSBZHE6tgzA6Q29ggzPM8w1Msq5uHc4tK1iaC_bMRoyzpQ-jn9AihSQN0jBJw0UC4ysLAOD37t_8RqS5wYrfsZEP7vSxTGVZr4Ua-XC1Lfb9o-339W5_xYhmOSZ65MPo2PVObNezXQ9cz3dd33VHO81mSbigGlNZCzPgubvc77jS0gQJ6_bWCBvtDvPcDOwURF2WW6RdHLPpW4bjmXc8687-mH6rB9l38aBT-HU2HH-LDdb1eP5UhFsT4fpfEW72RbgdiHD9eYRb3PQRbp6OcDsYYaN7_0RwdgafKWpwYTSdr2IUvox6Tc0hxOgcxShaoOQfWzMhRhJ6c7EMwggmq4t0Cih6fQgJWhotP8B5vHoFLfzyI4oR1HAKs7ll27ZtKUoEtBY83N8_3H98uP8IVAqlK8KF9uHI8-HqaAY2HM2urb8DAAD__xKZZbs=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1unEYUvjZPcbQ3a1cLBq8SWax8QdbjlHbDWoDTRJY1GmBwpoEZZ2agi6tKeQi_Sl-gj-InqQai9abFsdI0e7ESh_P9zMcHtg2vqVRMcB-WIn8vBcnfnb4AuqF51rCqoBI0VRraYcuyEpRCQTTJiKJwAlNzd7oAsG0oaEmaSkNLqob6MKwypdWHCk5AlOXoGmm06FcpJ1lF8S27viXX-FfBuEHxUZAoyx7DeEE3WNJc1DXlBdFMcIUHpuILooL3cHGjWc1uqcSNovgdU1pcS1Krp5GSCllQ2dtUuGI103ACz-ejmOMhtuXqIklRDAlK0zB6CSUlupHUaWmuhcT9WZwH71MtGzoebUkqRUc51YfKyWWRYcY1lZxUju5TleI3rDTRTGmWK4coLEqsWd0_Q9v76081rmR7rnpU6NOuch6e8lSU5TjT9jl_kWk81-nz-Tjp8aOM5rDKMaI10SzHuagqmpt-7EbcBzlObdL_L-w14ybpIXPTpOmzcYFnrvsEfykkzYnS6v-zrDqlaY37UihsDjDMv0LAukhQ_1FYWMsYBSmCNHixQnDTZBXLnQ3sW3sEwig9hmidQnSxWs2svezTZLharqMkjYMwSmGDb97TDs7j8FUQv4Wf0VvYJxAky4OZtRdGp-gNbHCGWbGB_ayfWwcLywpW5oCDsjHjbOXD6Ce0TCFJgzRM0nCZwPTSAgD4vf83vwlpr7Fit3Tigzt7GOeiamquJj5cbofD_mR7fbW7LynRtMBET3yYHLnese16tuuB6_mu67vuZGfZvCSM5xrnouEG4Lm72v3XxxQJ6-7GGJvsgllhADsD3lTVlmmXx7zpW4WjuXc07-_9MfvWDLLvkkHv8OtiOPqWGKyr6eKpCnemws2_Ktw-VuFupMLN5xXucDtUuH26wt1ohY3vxxHB6Sl85qjFpfF0to5R-DIaPLUHEKMzFKNoiZJ_vDX7xFhCb85XQRjB_vo8nQGKXh9AglbGyw9wFq9fQQe__IhiBA2cwHxh2bZtWyonHDoL7u_u7u8-3t99hFxwpSVhXPtw6PlweTgHGw7nV9bfAQAA__94EHoG

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkWO0CGzkQXWYTpsrB5LStQgCgqKolKtEpiSlWRkG9CPyK_uBfUq-ZKBUOO6mNMuy-cGAru4599zDQ7kuvGVKcynmsJT0o5KEfjh5BWzDaFrxImMKDNMG6q7LcWKUQEYMSYlmcAxD-3a4AHBdyFhOqsJATYqKzaFr5droTwUcg8zz3jZSGdm2MkHSguEbfnVDrvDPkguLEr0gmecthouMbbBiVJYlExkxXAqNO6bsG0OlaOHy2vCS3zCFK83wB66NvFKk1E9FllVhOJUF1oaYf4BWTKqMqXZJjQtecgPH8HLWiznqTF-uzuMERRCjJAnC15AzYirFJjWjRircOjG533xoVMX6DyYnhWa9nPpTMaEqSzEXhilBiolpz0TJX9rVuDac6gnRWObY8LJNgDv943fdP8mdevrBQV969eQ-I0OZ5_1M25R8k6nf1-HLWT_p0YOM7TlO7NCSGE4xlUXBqE3XrsWtkf3U1v1_w15yYZ3uPLdJGr7oH_DC8x7hz6VilGij_zvJutGGlbgNhcZ2ga7-hAHOeYzaT8rCWUbITxAk_qsVgusqLTidbGDk7BEIwuQIwnUC4flqNXb20i-V7mm5DuMk8oMwgQ2-_sgaOIuCN370Hn5E72FEwI-X-2NnLwhP0DvY4BTzbAOjtK07-wvH8Vd2wW6yFTPZjg_CH9AygTjxkyBOgmUMwwsHAODX9t_-BqS-wprfsMEcvPF9mcqiKoUezOFiW-z6B9vny91-xYhhGSZmMIfBoTc9cr2p603Bm849b-55g51me0m4oAZTWQkLmHq7s9tvlw0SNs21FTbYBfPMAnYKoiqKLdMuj73p2wmHs-nhrH332_i5HqT_iwetwqfZcPgcG5zL4eKxCDc2wtXfIlw_FOGmJ8LV1xFucN1FuH48wk1vhK3uhxH-yQl8pajGudV0uo5Q8DrsNNX7EKFTFKFwieK_3JoRsZLQu7OVH4QwWp8lY0Dh232I0cpq-Q5Oo_UbaOCn71GEoIJjmC0c13VdR1MioHHg7vb27vbz3e1noFJoowgXZg4H0zlcHMzAhYPZpfNnAAAA___fd5AH

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk8uO0zAUhvd5irMrIBL1Qi9M1UUJBlVqM0OTVrOzXOdEGByb-jhleDBegCdDThDDIjMINLso_v39Pp-TOIYjOlLWXEFq5Wdnhfz49g3gHcpTo3SJDjySh0uXiqKcFVAKL06CEFYwCKuDJUAcQ4mVaLSHi9ANXkEXVeTprGEFtqp6Y6Lxto0qU-IddyhtXaMphVfWEEcjThrLRwDWtNsdWlei45-sMsS1qpWHFcwmvXsW3SDp9pAXbA85K4pN9h4qFL5xmFxQeut4e6Lk_gQD7xrsH7YSmrCXSWedSFeeuDIenRE68YHHnf3KyQuvyCtJiSBuK-5V3VqNRz--U39TPBrSg0W_spTcex_Yquon_Tb_KKnf62A26YcuHiSGYSkJpbXwSnJptUYZbvlPxa3IfnSw_z_0WplgunNOoWTaXzAdDv_Cr6xDKcjT0x2ZvpHHmrcfBfEwQPf-HwqiQ87a33QZpXu2Lhjk7MOBZSmDL81JK5kQnmG3yY7r7YHBCHbr2-7x9Xg8mczHw8lsMX01n08XwzlssnTPdiwrYAR5sd4XMFpGEbu92a43GTy7vileAsuOzyFnW5YW8ALe7a93QHheRnEcxxHhuUEjMSYMVxBWop8BAAD__zp3bYk=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfQ6_4sIvtgfJkWO0CGwEmOownTZXCSQlbREEBCVRK1eZTElKszcMKPYNftxv7Af2KfmSgVLqOK3SoOvqBwO6vPecw-NzZdeFC6Y0l2IKc5m9VZJmb46fAVuxLK14mTMFhmkDdduFUIwTyKmhKdUMjqBvT_szANeFnBW0Kg3UtKzYFNpWro1-V8IRyKLobKOVkU0rFzlbEcUyuVwykVPDpdCECZqWLP8MgBTNuGJS5UyRXyQXmpR8yQ0cwdNJ58xhe5H54jxOcAQxTpIgfA4Fo6ZSbFSzzEhFGkWjOwV9oyrWfdmClpp1Yup35ShTeUq4MEwJWo6MxSNK_kq0oYZrwzM9oprIghi-bFx1x__8rbuZ3LGnHyS67dWjO9_7sii6kbbOfxap29f-00k36OGDiPayemRJl9TwjGSyLFlmf-Vdixsju6Gt-_8FfcmFdbr1XFuSJ90ETzzvEfxCKpZRbfT_J1mvtWFL0oRCE3uBtv4FBOg8xs2aztA8wn6CIfGfLTBcV2nJs9EKBmiPQhAmhxCeJhCeLxYO2ktvK-3T_DSMk8gPwgRW5PotW8NZFLzwo9fwE34NAwp-PB86aC8Ij_ErWJGU8HwFg7Spo-EMIX9hL9gyWzGjLX0Q_ojnCcSJnwRxEsxj6F8iAIDfm2_76dH6Z6L5b6w3Bc-5K2eyrJZC96ZwuS22_b3t89Vuv2LUsJxQ05tC78AbH7re2PXG4I2nnjf1vN5Os10SLjJDMlkJOzD2drnfcG2kDRIx62srrLc7zHM7sFMQVVlukXZx7KZvGQ4m44NJc_aH87UepN_Eg0bhl9lw8DU2oKv-7LEIr22Eq08iXD8U4XVHhKv7EV6Tuo1w_XiE150RtrofnvCPj-GeopoUVtPJaYSD52GrqR5ChE9whMM5jj_amgEddvlyEeCXH2ypm822u-ygvcoagobgxxDjhVVLHUgdqByo4SQ6fXEf3_lI78sfcIQhhSOYzBDCr84WfhDC4PQscQCHF8MPoN-1WPUMua7rIi4EU679c4BBpqTWQwQ3m79uNu9vNu9BZ1TA-pPK6vvbF4g9-dOm4GazuW3IpNBGUS7MFPYP9sdTuNyfgAv7kyu001bw0jClYWDfgEP0bwAAAP__OnCYwg==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk9FOnUoUhq-dp1h36IkQjdEYd7xAzrShRbaB0dQ0zWT2sEinAlNnDbv6YH2BPlkz0NReoE2b3sI_37_WBxPHcIOOjB3OILP6zlmlP_5_AfiAejOarkEHHsnDdk4xVnMBjfJqowjhHKLwNloBxDE02Kqx87BV3YhnMEcNebrv4Bxs2y7G1OjtFDVDgw_SobZ9j0OjvLEDSRzUpsPmBYAdpuMOrWvQyU_WDCQ70xsP53BytHjmdF4kK65rwSuouRB5-RpaVH50mGxRe-vkNFHyNEHk3YjLy7aqI1xk0n2XaNdspBk8ukF1iQ886ewXSV55Q95oShRJ20pv-slqfPjtKy03xYcH9GzRjywlT94j27bLpJ_mXyQte41Ojpahp88Sw7KUhNJeeaOltl2HOnzlXxVPIpfRwf7f0HszBNOzcwolx8sFxwcHv-G31qFW5OnfjUyP5LGX009BMiwwP_-DAnZd8-marlhW8VRwEOlFwYESD7tsR0FeilMo1wLK66LYZzvZuqxFlealAC8_3-EjXFX5ZVrdwlt-C7sK0jrbY3srxtIiTD3jQkMSmHn5hmcCapGKvBZ5VkP0_kO0Yoy_uyrSvITd9ZXYB17e7EHNi5D9D15V68sw0YrFcRwz0moAz74HAAD__24qch8=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexsA5FgI0gQJPAiTYUigOEGtWN0R4yoUcqGImHOyE12OYSv0gv0KD5JQaloumBStMiW-vP-8Il5DhsKbLw7hyuv74NH_eX9O6AH0lVnbE0BhFhgN6SybFWuoUbBCplgDqP4dXQBkOdQU4OdFdih7egchuhwpiSgY9RivFPbDq2RR-UbxRR2RkdQhfr-LvjO1UlYoLvOYhiYhoW3FubgmyaZxk58HzWupgcVSPu2JVdj7GdFDitL9SsA7_rxQD7UFNRXbxwra1ojMIfT4-TM2SDnanG7WpefYFWu19fLD9AQSheo2JEWH1S_UfG8wUhCR2mBDVqmJJO3ttChrpRxQsGhLSTyVPDfFAuKYTGaC-ToWEzb_6l89uM7p5vy2ZRfLPqV5eLZ-8g3TZr02_yrpLTX0elxGnr2IjFelotY2qIYrbS3lvpX9qfiXmQaHe3_D701LpoenHMsOUkXnEynf-E3PpBGFn67lfmRhVrVPwpW8QLD-T8UZOXnm8Xl9RLGH2_WR1AuNxPYXC5uyxWMZ5OLLM_zPOsHOIPDfn_YPx32TzCeHU2ynwEAAP__7WlyGQ==

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zoQhvc6xexsA6FgI0gQJPAiL08oAhhuUDtGd8SYGrVsKRLmjNxkl0P4Kr1Aj-KTFJSKpgsmRYtuqX--f_iJSsGGItvgL-EmmM8xoPn4_39AD2S2nXU1RRBigf2QKopVtYYaBbfIBHMYpa-jKwCloKYGOyewR9fRJQzR4UxLRM9oxAavdx06K486NJop7q1JIBOtWIMui4r0oXMYB6Jl4Z2DOYSmyaaxk9BHra_pQUcyoW3J15jaWZPHraP6FUDw_XikEGuK-lOwnrWzrRWYw_lpduZiUHOzuF-tq3ewqtbr2-UbaAili1TuyUiIut-ofN5gJLGjvL4GHVOWyTtXmlhvtfVC0aMrJfF0DF80C4plsYZL5GRYbNv_JzX79pXzTWo25ReLfmS5fPY-Ck2TJ_00_yop73V0fpqHXrxITJflMpW2KNZoE5yj_o39qrgXmUcn-39Db61PpgfnnErO8gVn0-lv-E2IZJCF_93K_MhCre4fBet0geH8DwqK6v3d4vp2CeO3d-sTqJabCWyuF_fVCsazyVWhlFJFP8AFHA-H4-HpeHiC8exkUnwPAAD__2UIcUQ=

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtgdLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMtOiSlWR72WfuBfdlAqXCcVm7WZfODAV3de865R-e6LrxlSnNZzmAh6VpJQj9fvwK2YzSruMiZAsO0gbrrcpwEpZATQzKiGVzB0L4dzgFcF3JWkEoYqImo2Ay61q6GjSKlJtRwWeL7ighuGiwLrJmqObVAVHHDKRG9UIp9qgRRHSLXRt8LuAJZFL3dpDKybeVlznZYMSo3G1bmxLJrzEqSCZZ_B0CW7bhiUuVM4V8lLzUWfMMNXMHLi96Zy86axfIuSVEMCUrTMHoNBSOmUsyrGTVS4VaR96BgaFTF-u0riNCsF1PfC4-qPMO8NEyVRHjG4mElf8PaEMO14VR7RFuHDd-038md_vWn7mdyp74-SfSlV3sPvg9lUfQjHZz_LlK_r8OXF_2glycR7bLas6QbYjjFVArB2owdW9wa2Q9t3f836BteWqc7z7UledFP8ML3n8AvpGKUaKP_O8m60YZtcBsKje0CXf0HCJy7BLWHP3cWMQpSBGnwaolgW2WCU28HI-eMQBillxCtUojulsuJc5Z9qXRPi1WUpHEQRins8HbNGriNwzdB_B5-Qe9hRCBIFuOJcxZG1-gd7HCGeb6DUdbWnfHccYKlXbBjtmK8A30Y_YwWKSRpkIZJGi4SGH5wAAB-b__tb0DqT1jzPRvMwJ88lKkU1abUgxl8OBS7_sHh-eNxv2LEsBwTM5jB4NyfXrr-1PWn4E9nvj_z_cFRsz0SXlKDqaxKOzD1j7k_c22kDRI2zdYKGxwP89wOHBXKSogD0jGOvfQDw_nF9PyifffH5LkeZP-LB63CH7Ph_Dk2OB-H86ci3NgIV99EuD4V4aYnwtXjCDe47iJcPx3hpjfC_0D33urerr8RrlhxSvq-R_p2_bTG_UmNp7cKrq_hkWs1Liz5zSpG4euoI6_HEKMbFKNogZKvLntExqfx91_jF-vHyIoVJ7EbGFV2XfTudhmEEYxWt-kEUPR2DAla2j1_gpt49Qb2c8d1XdfRlJSwd_4OAAD__-IIqrk=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtgdLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMtOiSlWR72WfuBfdlAqXCcVm7WZfODAV3de865R-e6LrxlSnNZzmAh6VpJQj9fvwK2YzSruMiZAsO0gbrrcpwEpZATQzKiGVzB0L4dzgFcF3JWkEoYqImo2Ay61q6GjSKlJtRwWeL7ighuGiwLrJmqObVAVHHDKRG9UIp9qgRRHSLXRt8LuAJZFL3dpDKybeVlznZYMSo3G1bmxLJrzEqSCZZ_B0CW7bhiUuVM4V8lLzUWfMMNXMHLi96Zy86axfIuSVEMCUrTMHoNBSOmUsyrGTVS4VaR96BgaFTF-u0riNCsF1PfC4-qPMO8NEyVRHjG4mElf8PaEMO14VR7RFuHDd-038md_vWn7mdyp74-SfSlV3sPvg9lUfQjHZz_LlK_r8OXF_2glycR7bLas6QbYjjFVArB2owdW9wa2Q9t3f836BteWqc7z7UledFP8ML3n8AvpGKUaKP_O8m60YZtcBsKje0CXf0HCJy7BLWHP3cWMQpSBGnwaolgW2WCU28HI-eMQBillxCtUojulsuJc5Z9qXRPi1WUpHEQRins8HbNGriNwzdB_B5-Qe9hRCBIFuOJcxZG1-gd7HCGeb6DUdbWnfHccYKlXbBjtmK8A30Y_YwWKSRpkIZJGi4SGH5wAAB-b__tb0DqT1jzPRvMwJ88lKkU1abUgxl8OBS7_sHh-eNxv2LEsBwTM5jB4NyfXrr-1PWn4E9nvj_z_cFRsz0SXlKDqaxKOzD1j7k_c22kDRI2zdYKGxwP89wOHBXKSogD0jGOvfQDw_nF9PyifffH5LkeZP-LB63CH7Ph_Dk2OB-H86ci3NgIV99EuD4V4aYnwtXjCDe47iJcPx3hpjfC_0D33urerr8RrlhxSvq-R_p2_bTG_UmNp7cKrq_hkWs1Liz5zSpG4euoI6_HEKMbFKNogZKvLntExqfx91_jF-vHyIoVJ7EbGFV2XfTudhmEEYxWt-kEUPR2DAla2j1_gpt49QaaueO6rutoSkponL8DAAD__-H3qrc=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtgdLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMtOiSlWR72WfuBfdlAqXCcVm7WZfODAV3de865R-e6LrxlSnNZzmAh6VpJQj9fvwK2YzSruMiZAsO0gbrrcpwEpZATQzKiGVzB0L4dzgFcF3JWkEoYqImo2Ay61q6GjSKlJtRwWeL7ighuGiwLrJmqObVAVHHDKRG9UIp9qgRRHSLXRt8LuAJZFL3dpDKybeVlznZYMSo3G1bmxLJrzEqSCZZ_B0CW7bhiUuVM4V8lLzUWfMMNXMHLi96Zy86axfIuSVEMCUrTMHoNBSOmUsyrGTVS4VaR96BgaFTF-u0riNCsF1PfC4-qPMO8NEyVRHjG4mElf8PaEMO14VR7RFuHDd-038md_vWn7mdyp74-SfSlV3sPvg9lUfQjHZz_LlK_r8OXF_2glycR7bLas6QbYjjFVArB2owdW9wa2Q9t3f836BteWqc7z7UledFP8ML3n8AvpGKUaKP_O8m60YZtcBsKje0CXf0HCJy7BLWHP3cWMQpSBGnwaolgW2WCU28HI-eMQBillxCtUojulsuJc5Z9qXRPi1WUpHEQRins8HbNGriNwzdB_B5-Qe9hRCBIFuOJcxZG1-gd7HCGeb6DUdbWnfHccYKlXbBjtmK8A30Y_YwWKSRpkIZJGi4SGH5wAAB-b__tb0DqT1jzPRvMwJ88lKkU1abUgxl8OBS7_sHh-eNxv2LEsBwTM5jB4NyfXrr-1PWn4E9nvj_z_cFRsz0SXlKDqaxKOzD1j7k_c22kDRI2zdYKGxwP89wOHBXKSogD0jGOvfQDw_nF9PyifffH5LkeZP-LB63CH7Ph_Dk2OB-H86ci3NgIV99EuD4V4aYnwtXjCDe47iJcPx3hpjfC_0D33urerr8RrlhxSvq-R_p2_bTG_UmNp7cKrq_hkWs1Liz5zSpG4euoI6_HEKMbFKNogZKvLntExqfx91_jF-vHyIoVJ7EbGFV2XfTudhmEEYxWt-kEUPR2DAla2j1_gpt49QZ2c8d1XdfRlJSwc_4OAAD__-HmqrU=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMtOiSlWR72WfuBfdlAqXDcVGqWdfODAV3de865R-e6LrxlSnNZzGEp6UZJQj9fvwK2ZzQtuciYAsO0gartcpwYJZARQ1KiGVzB0L4dLgBcFzKWk1IYqIgo2Rza1raGjSKFJtRwWeD7kghuaixzrJmqOLVAVHHDKRGdUIp9KgVRLSLXRt8LuAKZ553dpDSyaeVFxvZYMSq3W1ZkxLJrzAqSCpZ9B0AWzbhiUmVM4V8lLzQWfMsNXMHLi86Zy9aa5eouTlAEMUqSIHwNOSOmVGxaMWqkwo2i6YOCoVEl67YvJ0KzTkx9L6ZUZSnmhWGqIGJqLB5W8jesDTFcG071lGjrsOHb5ju5s7_-1N1M7szTvURfevX0wfehzPNupKPz30Xq9nX48qIb9LIX0S6rp5Z0SwynmEohWJOxU4sbI7uhrfv_Bn3LC-t067m2JC-6CV543hP4uVSMEm30fydZ19qwLW5CobFdoK0_g8C5i1Fz-AtnGSE_QZD4r1YIdmUqOJ3uYeScEQjC5BLCdQLh3Wo1cc7SL5X2abkO4yTygzCBPd5tWA23UfDGj97DL-g9jAj48XI8cc6C8Bq9gz1OMc_2MEqbujNeOI6_sgu2zFbM9EgfhD-jZQJx4idBnATLGIYfHACA35t_-xuQ6hPW_MAGc_AmD2UqRbkt9GAOH47Ftn9wfP542q8YMSzDxAzmMDj3ZpeuN3O9GXizuefNPW9w0myPhBfUYCrLwg7MvFPuz1wbaYOETb2zwganwzyzAyeFohTiiHSKYy_9yHB-MTu_aN79MflRD9L_xYNG4fNsOP8RG5yPw8VTET7YCO8232RYsbwvxYeOFO82T8f10BnXf6CxthrLbyRWfQLrDoHl12dW46o9s-pp3XWv7v5N_etrOFGUb-BmHaHgddiqUSwfQ4RuUITCJYof0Y3KcT92_RjbrpLbfb9iqHrx9zAiz8F_rL0f-WBzYJ1E725XfhDCaH2bTACFb8cQo5W18Ce4idZvoF44ruu6jqakgNr5OwAA__95yMXM

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu27YXxq_DpzjwjZ0_LEFWmv5TG7lQHHXQpsqBpQQtioKgKKrlSpEJSbnJhj3WXmBPNpBqHWNQs3XofGHA53znO59-pBwEcMO04UouYa3oR60I_XB5Aeye0brnomEaLDMWdoMKoTKtoCGW1MQwOIep605XAEEADWtJLyzsiOjZEgbpUMNWE2kItVxJfNcTwe0DVi02TO84dUZUc8spEaNWmr3vBdGDIzfW3Ak4B9W2o2rSW-WlXDbsHmtGVdcx2RC33WAmSS1Y84SBkn5cM6UbpvHPikuDBe-4hXN4fjI6czagWefXZZVuoUyrKit-gJYR22sW7hi1SmOfKHxMMLW6Z-P4WiIMG_U0dyKkuqkxl5ZpSURonR_W6hM2llhuLKcmJMYRtrzz5xQs_vjdjG8KFpH56qLPWhM-cp-qth132pN_0mmc6_T5ybjp2Vcd3cOa0C3tiOUUUyUE83fsELEHOW7t6P8b945LR3pgbtyS0_EFp1H0N_6t0owSY833i2wejGUd9pfCYPcAQ_0bFqDrMvUv_gqtt2lSpVAlF3kKt30tOA1rmKGjGi42mxyKTQXFdZ7P0ZFWn3gDWVGd-epNVmZu6IsCLtOXyXVeQS_5Xe_Z8WZ2PEdH601RVtskKyqo8e1H9gBX2-xVsn0DP6VvYDb4JuXaabPiMn0NNa4xb-5hVvs6Ol4hlOSOxxDUZQ_3abPix3RdQVklVVZW2bqE6VsEAPCr_3afCdm9x4b_wiZLWMwfy1SJvpNmsoS3-6Jv1JP973eHes2IZQ0mdrKESRzFcbCIgyiGxdny5NkyfhGe_v_Zi5N4cjDjXi0uqcVU9dLNxQfND9xY5S4ftg-3Lt3kcJQ3f8krSedF2B88xodi2Qux3xEdNNw_x5f6YhFFvvPb_AlE0T9B5M_tP8QUfRum-Hti-swIvZuuEEpfX-VJVsBsc1XNIS1ujqFMc3fl_gcvt5tXUK9QEAQBMpRIqNGfAQAA__-uHTFk
