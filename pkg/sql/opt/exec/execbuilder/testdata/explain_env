# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2jAUhq_rpzjKTWEiI4GbKqjSUppq2WioIOtaVZXlJAa8GjtzHBqYJvUheMI-yeTQdmwSY71oLiLZ5_-Ozzl_HNuGS6oKJoUHfZneKUnS2ekJ0IqmScl4RhVoWmhYbFQI2TYoKlVGFf4mmSgwZ3OmYUYK0DMKGZ2QkmtYEF5SD46MngqScIpXbLoi05raJZfC6GWu2ZytqMJlQfGMFVpOFZkXr6HmJdcslRwXmug9JJcp4Uwv8XOKDOdEaaaZFDTDTGS0wkVK9pSdK5mTKdEUM5GXGtdDYmK6k5pMNhidUIW5lHdl_jTTiVR4cre77A3JhKZqQXihl5zizZSzPUxGjJ2v0LOCcC7v8aTkHOvaSDOKfbVxoqZ0Axk5VvJ-J-I6joPGQWwO08V3DscmSw_AnP-nlJRamvQLmmqp2Ir-wxLUHwV-HEDsnwwCyMuEs_R9BQ10QCCM4iOIhjFEXwaDFjpInnY2q_4wGscjP4xisHLF5kQtLbgYhef-6Bo-B9fQIOCP-80WOgij0-AKKpxgllXQSJ73z_zzcHC9hTdIC5ImavYQ8gdxMPq7rDD6FPRjGMd-HI7jsD-GwxsEAPCjfpvHSiUv56KwPLh52awDxHpZ37a29IoSTTNMtOWB1XHcI9txbccFx_Ucx3Mca0tshs9EqnEqS2EA13G2wvU1xOZG6WVOTb5tWBijn8FtTMn73wk7XbfTrWM_W__dW_ImvdWlvF176Pawh1BwdTHwwwgaw4u4BUF02YRxMDA2v4Oz0fAcKvj6MRgFkMAxdHvItm0b1T-a6sPTJ4Xgcb1-XD88rh8glaLQijChPWh32q4HN-0u2NDu3qJfAQAA___FbsBk

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lc9u4zYQxs_hUwx8WbuwGjm-BA4WqNbLtGodOZDV7QZBQFAS5bChSZV_FCtFgUWfwcc-XZ6koJxk3e66aQ7xwYBmvt9oOPPRDgL4wLThSk5gqoobrWhx_f4dsDUrcsdFyTRYZiw0WxVCQQCaKV0yTX5VXBoi-IpbuKYG7DWDklXUCQsNFY5N4NjrmaS5YOSOL-_osqP2yZX0elVbvuJ3TBNnGLnmxqqlpivzEmrlhOWFEsRYap8hhSqo4LYljyVKUlNtueVKspJwWbI1MQV9pu1aq5ouqWWEy9pZ0g2Jy-Veqqq2GKuYJkKpG1c_zLRSmlQ3-9veklxaphsqjG0FI9spl88wJfXrfIGeGyqEuiWVE4LYbpF-FM_1Jqhesi3k5USr273IKAxDtMCZf5k1vwl466ucAPj3_1NKnVW-fMMKqzS_Y_-xEjRNcZRhyKJ3Mwy1ywUvvl1DHx1QiJPsGJJ5BsnPs9kQHeQPke3TdJ4ssjSKkwx6teYrqtsenKfxWZRewE_4AvoUosV0MEQHcfIef4Q1yQkv19DPH-On0Vk8u9jB-3QI-QANThCKZhlO_91WnPyIpxkssiiLF1k8XcCbSwQA8Hv37T-9Qgm3kqY3gcunYJegvafnq-GOXjNqWUmo7U2gdxSOjoNwFIQjCEeTMJyEYW9H7IfPZWFJoZz0wCgMd9LdNST-Rtm2Zr7eLiz9oh_BXUyr288Fj8ajo3GX-2P4v8-Wv8rZulZe73jo6s3J1w3YegO6LwzYvNCA7tFoO9LqhjREs4qs4XSe4vj7ZKttBpDiU5ziZIoXT47r08_-bUmz9W-z379uCM1e_7Zf9W83BPzxfBbFCfTn59kQcPJhAAs889pv4DSdn8F6CC388gNOMeTwFsYnKAiCAHEpmQ66f4t-oZUxAwT3m7_uN5_uN5-g-zluv4isv3u4ij7zp1_F_WbzICiUNFZTLu0EDo8ORxO4PBxDAIfjK7Qjq7iwTBvoW-3YAP0dAAD__6wRLDM=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lEtu6zYUhsfhKg40uXZhFXLuJLBxB7qOAqh15MBSgwRBQFDSkc2GJlWS8qsokEV42NVlJQXlJHULuG4G8cAQ-f_f4XmA9H24RW24kgMYqeJJK1bML78DrrHIGy5K1GDRWFjuXYT4PmhUukRNf1VcGir4gluYMwN2jlBixRphYclEgwO4cH6ULBdIt3y2ZbOWOmZX0vlVbfmCb1HTxiCdc2PVTLOF-Qi1aITlhRLUWGZPkEIVTHC7oW8hSlozbbnlSmJJuSxxTU3BTqRda1WzGbNIuawbS9smcTk7SlXVHsMKNRVKPTX1a08rpWn1dDztPcmlRb1kwtiNQLrvcnmCKZkb5wf83DAh1IpWjRDUtoN0rTiVm2B6hnvI2alWq6NIPwgCkkaZO8ya3wR8c1GGAO78f1pZY5ULv8TCKs23-B8jIaNpFGYRZOH3cQR1kwte_LiGDjljECfZBSSTDJJfxuMeOctfd_ar0SRJs2kYJxl4teYLpjce3Ezj63B6Dz9H99BhEKajbo-cxclldAdrmlNerqGTv-1fhdfx-P4A77Ae5F3SHRISjrNo-u-04uSnaJRBmoVZnGbxKIUvDwQA4Pf23_28QolmIY03gIf3zVZg3vv6sXfg18gslpRZbwDeedC_8IO-H_Qh6A-CYBAE3oHZNZ_LwtJCNdIB_SA4kNtrSN2NspsaXbxDWLpBv4GHmFarvwOef-2ff221P3r_u7b8U2prU_m88sjjlyEh0d3NOIwT6Exush5EyW0X0mjsxvwDXE0n17CGMAUlsbf_sis1JL7v-4RLidpvn8pOoZUxXQIvuz9fds8vu2do36I1PDDzTUl8PCLZlWql3atUcWFRG-hY3WCX_BUAAP__TWbY2A==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxqQNrSu4jLR73fy5TvH8-CaayNUOYRAZXOtWDa7OAe-5NmDEzLnGiw3FuqOQijFBDRXOuea_lSiNFSKhbBwBp8GIwDPg5wXzEkLNZOOD-EUeR7wkj1ITldiumLTjQczZsDO-FtclS2vKisWYsU1dYbTmTBWTTVbmPdYCyetyJSkxjK7w5QqY1LYhr6OyGnFtBVWqJLnVJQ5X1KTsR2xK60qNmWWU1FWztJNTaKcbrWKotN4wTWVSs1d9dJqoTQt5ttjd6YoLdc1k8Y2ktOu5XyHk7N2o-_ghWFSqkdaOCmp3SyyrWJXNsn0lHdSi1OtHrcqJ8fHx5vTyoWx5peEs3bKP--JOava8TXPrNJixf-zEhQk2CcYiH8eYajcgxTZxwZ6aM9BGJNTiCcE4u9RdIj26pc33VMwiVOS-GFMYL_SYsF0sw9XSXjpJ7fwDd9Cz4GfBv2_0WJOa6p5QZcwniQ4_Bx3bN2HBI9xguMAp685lj3W6mF8gW-goTUV-RJ69evYsX8ZRrd_fL3nDqHuo_4IIT8iOHn7V2H8FQcEUuKTMCVhkMLB3f3BCCF8cxX5YQy9yRU5BBxf9yHFUct-gHEyuYQGfnzBCQYHZzAYIc_zPLQ59gbB83r9vH56Xj9BpkpjNROlHcLRyRDujgbgwdHgHv0OAAD__-ZkayY=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxqQNrSu4jLR73fy5TvH8-CaayNUOYRAZXOtWDa7OAe-5NmDEzLnGiw3FuqOQijFBDRXOuea_lSiNFSKhbBwBp8GIwDPg5wXzEkLNZOOD-EUeR7wkj1ITldiumLTjQczZsDO-FtclS2vKisWYsU1dYbTmTBWTTVbmPdYCyetyJSkxjK7w5QqY1LYhr6OyGnFtBVWqJLnVJQ5X1KTsR2xK60qNmWWU1FWztJNTaKcbrWKotN4wTWVSs1d9dJqoTQt5ttjd6YoLdc1k8Y2ktOu5XyHk7N2o-_ghWFSqkdaOCmp3SyyrWJXNsn0lHdSi1OtHrcqJ8fHx5vTyoWx5peEs3bKP--JOava8TXPrNJixf-zEhQk2CcYiH8eYajcgxTZxwZ6aM9BGJNTiCcE4u9RdIj26pc33VMwiVOS-GFMYL_SYsF0sw9XSXjpJ7fwDd9Cz4GfBv2_0WJOa6p5QZcwniQ4_Bx3bN2HBI9xguMAp685lj3W6mF8gW-goTUV-RJ69evYsX8ZRrd_fL3nDqHuo_4IIT8iOHn7V2H8FQcEUuKTMCVhkMLB3f3BCCF8cxX5YQy9yRU5BBxf9yHFUct-gHEyuYQGfnzBCQYHZzAYIc_zPLQ59gbB83r9vH56Xj9BpkpjNROlHcLRyRDujgbgwdHgHv0OAAD__-ZkayY=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKkoyBELJMctJ6dePMf0LTKx6iT8iTTG1A2qYB26Wt7_f5-Duf58ElaiNUNYRA5XOteD47OwVcYn7nhCxQg0VjoelUhKQ0A41KF6jZdyUqw6RYCAsn8GEwAvA8KLDkTlpouHQ4hOMtghW_k8hWYrri0y0IJ6DK8q-IqojngaqtWIgVauYMspkwVk01XxiYcQN2hv9CLZy0IleSGcvtG6RUOZfCtuzZomA111ZYoSosmKgKXDKT8-p1m1qrmk-5RSaq2lm2jUpU0xepsuwwLFEzqdTc1U_Jlkqzcv7y2B0pKou64dLYViLrgi7eYAq-2ep_6IXhUqp7Vjopmd3uchPFW7NJrqfYQRs50-r-ReTo8PBw25VCGGt-yFcKwp1VG_sGc6u0WOErKyFBQv2MQuafRhRqdydF_r6FHtlxEMbZMcSTDOKvUbRPdpqnm-4UTOI0S_wwzmC31mLBdbsLF0l47ifX8IVeQ8-Bnwb936XlnDVMY8mWMJ4kNPwYd9qmDwkd04TGAU2f51j2-AYP4zN6BS1rmCiW0Guebcf-eRhd__J6z-1D0yf9ESF-lNHkz1-F8WcaZJBmfhamWRiksHdzuzcihF5dRH4YQ29yke0DjS_7kNJoo30H42RyDi18-0QTCg5OYDAinud5ZFv2lsDjev24fnhcP0CuKmM1F5UdwsHREG4OBuDBweCW_AwAAP__Du5riA==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2z4cxa_xU3zFDe1P5Aeo0oRacRGCu2ULKUo8BkLIMonTenXjzH9C0yseok_Ik0xNQNoQLdplovM5Pj7HngfXXBuhyiEEKptrxbLZxTnwJc8enJA512C5sVB3KoRSTEBzpXOu6U8lSkOlWAgLZ_BpMALwPMh5wZy0UDPp-BBOW4SX7EFyuhLTFZu2IJyBKop3EVW2jKqsWIgV19QZTmfCWDXVbGF2k573Blw4aUWmJDWWWQMzZsDO-PukVBmTwjb01SKnFdNWWKFKnlNR5nxJTcbK3TaVVhWbMsupKCtnaVuXKKdbqaLoMF5wTaVSc1e9tFsoTYv59tgdKUrLdc2ksY3ktCs7_4DJ2WbZf9ALw6RUj7RwUlLb7rmp4qNskukp76CNnGr1uBU5OT4-brfPhbHml9wxNXNWbexrnlmlxYrvmAQFCfYJBuKfRxgq9yBF9n8DPbTnIIzJKcQTAvH3KDpEe_XLn-4rmMQpSfwwJrBfabFgutmHqyS89JNb-IZvoefAT4P-39JiTmuqeUGXMJ4kOPwcd9q6Dwke4wTHAU5fcyx7bIOH8QW-gYbWVORL6NWvtmP_Moxu_zi95w6h7qP-CCE_Ijh5e6sw_ooDAinxSZiSMEjh4O7-YIQQvrmK_DCG3uSKHAKOr_uQ4mij_Q_GyeQSGvjxBScYHJzBYIQ8z_NQ-9gbBM_r9fP66Xn9BJkqjdVMlHYIRydDuDsagAdHg3v0OwAA__90h2vq

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zwYxo_xVbzihPYT-QBVmlArDkJwt2whRYnHQAhZJnFar26c-U9oesRF9Aq5kqkJlbYJqDi09fwev36e1_PgmmsjVDmEQGVzrVg2uzgHvuTZgxMy5xosNxbqToVQiglornTONf2pRGmoFAth4Qw-DUYAngc5L5iTFmomHR_CaYvwkj1ITldiumLTFoQzUEXxKqLKllGVFQux4po6w-lMGKummi3MR8mFk1ZkSlJjmd1Bex5IlTEpbEO3LjmtmLbCClXynIoy50tqMlbCjBmwM_66TaVVxabMcirKylnaRibK6ZtUUXQYL7imUqm5q14SLpSmxdzsIEVpua6ZNLaRnHaB5zuYnG3a_YBeGCaleqSFk5LattNNFLtmk0xPeQdt5FSrxzeRk-Pj47bFXBhrfsl3CmPOqo19zTOrtFjxdypBQYJ9goH45xGGyj1Ikf3fQA_tOQhjcgrxhED8PYoO0V79ctOdgkmcksQPYwL7lRYLppt9uErCSz-5hW_4FnoO_DTo_y0t5rSmmhd0CeNJgsPPcaet-5DgMU5wHOB0O8eyxzZ4GF_gG2hoTUW-hF69tR37l2F0-8frPXcIdR_1Rwj5EcHJv78K4684IJASn4QpCYMUDu7uD0YI4ZuryA9j6E2uyCHg-LoPKY422v9gnEwuoYEfX3CCwcEZDEbI8zwPtcveIHher5_XT8_rJ8hUaaxmorRDODoZwt3RADw4Gtyj3wEAAP__HJFsTA==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAUhd_zK-7jNs0TlLWwoj6wzJOQIO0gRX2zTHIT7jB2sK9py6-fQraXaQz1zZLPd3R0zhUCVugDOXsLqSu23uli8-0r4AsW60imRA-MgeHQqZJkKXPw6HyJXv10ZIMytCOGO7gZjAGEgBIrHQ3DQZuItzBKhAC0em1QHak-6vrEwUYH4A3-LXe21buGaUdH9CoGVBsK7Gqvd-Et1C4apsIZFVjzBdK4QhviV_XHolSN9kxMzmKpyJb4okKhL8RuvGt0rRkV2SayOtVEtj5LVVWHYYVeGee2sfndauW8qrbnY3ckWUZ_0Cbwq0HVtVxeYErdLvoGPQVtjHtWVTRG8WnItopL2Yz2NXZQK1fePZ9F-r1e73RaJQUOewN3rcs_70lHdq39AQt2no74n0mSdCEnuYSl_PEos1RCE9eGik8B9zCfZqvJ7FFCH-aTp-755epqMBhe9QY3o-vPw-H1qDeEaZYu5FxmOfRhmU8WOfTHSSKfHmaTaQbv7h_yjyCz1XtYyplMc_gA3xf3cwi4HydCCJEE3Ee0BYqABgtuf5JfAQAA__83zjAS

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VcFu4zYQPS-_YuDL2oW0kWOgCGwEqNbLtGodOZDU7AZBQFAS5bChRZWkFCtFgUW_wcd-Xb6kkBQn6m7cNIf1wQBn3nsYzrwRbRvOmdJc5lOYy-RGSZpcf3gPbMOSuOQiZQoM0waqDoVQiCNQTKqUKfKb5Lkmgq-5gWP4fjIDsG1IWUZLYaCiomRTOEK2DSynsWDkjq_u6KrlwTXVYK7Zl3CZN3hZGL7md0yRUjNyzbWRK0XX-jWsdSkMT6Qg2lDzAlPIhApuarKTSElBleGGy5ylhOcp2xCd0BfKLpQs6IoaRnhelIa0beL5ai8ryzoay5giQsqbsnjoaiYVyW72l90xeW6YqqjQphaMdF1OX-CktJnoK_BcUyHkLclKIYhpB9m04qXaBFUr1pEaOFHydi9l7DhOa62Ua6N_F3DcqDzrJ1oa2chXLDFS8Tv2HyNB8wC7EYbIfb_AUJSx4Mm7DQzRGwqeHx2Bv4zA_3WxsNCb-CHSneZLP4wC1_MjGBSKr6mqB3AWeKducAG_4AsYUnDD-chCbzz_A_4EGxITnm5gGO_iJ-6pt7jo0YfUgniERjOE3EWEgy_L8vyf8TyCMHIjL4y8eQhvLxEAwB_tf_MbJFKU61wPpnD5GGwTdPB4vrJ6eMWoYSmhZjCFwaEzPrKdse2MwRlPHWfqOIMeuGk-zxNDElnmDWHsOL10u4ak2ShTF6zR65PzZtA7Yp-m5O2T4OFkfDhpc39a__tu8Te5W1vKt7seuno7e96AdWPA8isDVq80YLkzWg-a3ZCKKJaRDZwsA-z96HfYagQBPsEB9uc4fHTckD75tyZV599qv39LC6q9_q2f9W-_Cece_rhDV902WNBqghtCiBcN-ykKJ8HytH193u0Ktv51rOHjTzjAEMMxTGYI4U9nC9fzYbg8iyzA_vloJ_pdp1XNkG3bNuJ5zpTdvkLDREmtRwjut3_fbz_fbz9D-5mvv4psfnhY8SbzVzPi--32AZDIXBtFeW6mcHB4MJ7C5cEEbDiYXKEeLOPCMKVhaFTJRuifAAAA__9-t0XN

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUksFq20AQhs_ZpxhyiV2iklIoISYHRVVArSwbaRtqSlkm0kjeeq1Vd0dO7KcvslsIpa7J_ftmhn_-IIAHcl7b9gYiW66cxXL58Q7omcrHXpuKHDB5hs2BEqKIJTiyriKnfljdemX0WjPcwof3E4AggIpq7A3DBk1PN3AtggCoxUdDaqebHTZ7D5bogZf0N27bgbcd67XekVO9J7XUnm3jcO1fY617w7q0RnlGPmEaW6LRvFV_RlSqQ8eatW2pUrqt6Fn5Ek-c3TnbYYNMSrddz2ofk26bo1ZdHzSqySlj7arvfqdaW6fq1fGzD6ZumdwGjeetIXVIuTrhVDh89BW89miMfVJ1b4zi_SOHKE7dZtA1dJAGXDn7dFR5d3V1ta9WpT37nwZuhyn_7BP2bIfxGyrZOr2j_7xERHkcyhhkeJfG4N8yjMQZQpLJa8hmErIvaXopzqJZVsg8TDIJ553Ta3Tbc5jnyTTMF_A5XsAIISyi8aU4uw-nSbp4gY1wLMYTIcJUxvmLRUn2KY4kFDKUSSGTqICLb98vJkLEX-dpmGQwms3lJcTZwxiKOB3YN3Cfz6aDPRFBEARiXzgWvwIAAP__Hfw5sQ==
