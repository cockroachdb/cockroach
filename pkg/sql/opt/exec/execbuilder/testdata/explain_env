# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1uo0YYvc48xSff2K4MAVsrrbAilXUmu7ReHAHZH0XRaBiGZhR-ssxAcatK-xB-lb5AHyVPUg2kjtOSrtrs-sISH2fOOd_xGRsGvOOVFGXhwKpkN1VJ2fXpK-AtZ3EtsoRXoLhU0PQohEIcQUIVjankcAJj_Xa8BDAMSHhK60xBQ7OaO9BDhVTyUwYnUKbpIIzWquygokh4SyrOyjznRUKVKAtJeEHjjCf_QvCXq9X6IoxwACGOIs9_DfJTZrIqiYkoFK8KmplKU5Gq_JlIRZWQSjBpUknKlCiRd-sY9h-_y-F9DNuSTwrdY6X5sPC4TNNhpv3KQ0zamjQ1JKdKMMLKLONMh2E-ZDFOaSb5MLuqav5_2HNR6Fz6hKQWeTEs8MKyvsCflhVnVCr59SzLrVQ8J91PKIleoJ9_BYGGs657ZsIVr3JRdM0gqWjr20cCmmWYv5NG6CLE3XVZolWA3QhD5L5aY7it40wws4UJOqLg-dFL8DcR-Bfr9QwdxfeT_mm18cMocD0_gpbc3vAtnAfeWzf4CD_ijzCh4Iar6Qwdef4p_gAtiYlIWpjE3RxN4b0XvYGJZNc8pyQr2U1nXTufLpcIuWu9fW9LOzX33jz_B7yKIIzcyAsjbxXC-BIBAPzafevPiDY_ESl-4SMHrNnDmJVZnRdy5MDlftjjR_vnq0N8xaniCaFq5MBobtkvDcs2LBss27Esx7JGB2B9oUTBFGFlXegDtnWofS2kKnWNidreamOjw8Mi0QcOBkWdZXumQx79r7BXmC_s-aJ799vsuRnE3ySDzuF_i2H-nBjQ1Xj5pX5vdb_rf_S7earf24F-14_7vSVN3-_mmf3eDvZbL_X0Cff0FB7ZbUiqDZ9tAuy99nvDzRQCfIYD7K9w-LcrNaHTJUL4w_na9XyYbM6jGWD_3RRCvNZevoOzYPMWWnj_BgcYYjiBxRIZhmEgyWgB7ff39xvB3W53t_t8t_sMrCykqqgolAPH82PbgcvjBRhwvLhCfwYAAP__89BFAw==


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR45RoLARYK7DtNpcOZCUfiAICIqiFi4ymYqUJm0YUOwZ_HOvsRfYo-RJBkqZ46zKii2tfxjQ5bnnnnt0KMeBNzzXQskZLBW7zhVlVycvgFecxYXIEp6D4dpA2aIQCnEECTU0pprDMfTtaX8O4DiQ8JQWmYGSZgWfQQsV2ugPGRyDStNOGC2MaqBCJrwiOWdqs-EyoUYoqQmXNM548i8Ef6tars7DCAcQ4ijy_JegP2RjlicxEdLwXNJsbCwVydVPRBtqhDaC6THVRKXEiE2zjjP58w_dvY8zcfWjg-6weny_cF-laTfTbuUuJitNjy1kQ41ghKks48yaMb73op_STPNudpMX_P-wb4S0vrQOaTvkWfeAZ677Gf5U5ZxRbfSXk6xrbfiGNK9QE7tAW_8CA0rOmuyNE254vhGySQZJRVXcPBhgWbr5m9EInYe4uS5ztAzwIsIQLV6sMNwUcSbYuIIBOqDg-dFz8NcR-Oer1QgdxHeV9mm59sMoWHh-BBW5ueY1nAXe60XwHr7H72FAYREuhyN04Pkn-B1UJCYiqWAQN3U0hLde9AoGml3xDSWZYteNdKt8OJ8jtFjZ7VtZVul4p83zv8PLCMJoEXlh5C1D6F8gAIBfmn_769HyB6LFz7w3A3d0X2YqKzZS92ZwsSu2-N7u-XIfn3NqeEKo6c2gd-ROnjvuxHEn4E5mrjtz3d4e2F4oIZkhTBXSNkzc_dlXQhtlY0xMfWOF9fabRWIb9gqyyLId0z6P_SrsJhxNJ0fT5uzX0VM9iL-KB43C_2bD0VNsQJf9-efyXdt8F5_ku3ws33VHvouH-a5J2ea7fGK-685826Ue71icnMADuSVJreDTdYC9l34ruBxCgE9xgP0lDv9xpQZ0OEcIvztbLTwfBuuzaATYfzOEEK-slm_gNFi_hmoENbx9hQMMMRzDdI4cx3GQkJLnzo9KSBiwXGk9RHC7_f12-_F2-xE0oxLqTyrVt3efBHvym311t9vtHYApqU1OhTQzODw6nMzg4nAKDhxOL9EeLBWZ4bmGQWMq-isAAP__WUlpDA==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkFMUKGzkQXWYTpsrB5LStQgCgqKohYtEpiKlyBsG9CPyuN_YD-xT8iUDpcxxNmXFltYPhnXv4bnnHh_KceAdr7RQcgErxa4qRdnl8WvgLWdpLYqMV2C4NtD0KIRinEBGDU2p5nAEY9sdLwEcBzKe07ow0NCi5gvooUIb_bGAI1B5PgijtVEdVMiMt6TiTJUllxk1QklNuKRpwbN_IfhL1Wp9Fic4ghgnSRC-Af2xcFmVpURIwytJC9dYKlKpG6INNUIbwbRLNVE5MaLs1nHmf_yuh_dx5p5-ctA9VrsPC49Vng8z7VYeYrLStGshJTWCEaaKgjNrhvvgxTinhebD7Kaq-f9hL4W0vvQOaTvk5fCAl573Gf5cVZxRbfSXk6y32vCSdH-hJnaBvv4FBjScddlzM254VQrZJYPkoq2vHw2wLMP83WiEzmLcXZclWkXYTzAk_us1hus6LQRzW5igAwpBmLyCcJNAeLZez9BBel_pn1abME4iPwgTaMn1Fd_CaRS89aMP8D3-ABMKfryaztBBEB7j99CSlIishUna1dEUfgiSb2Gi2SUvKSkUu-qkW-XT5RIhf22372VZpe5OWxB-h1cJxImfBHESrGIYnyMAgF-6b_sZ0eZHosXPfLQAb_ZQZqqoS6lHCzjfFXv8aPd8sY-vODU8I9SMFjA69OavHG_ueHPw5gvPW3jeaA9sL5SQzBCmamkPzL392ZdCG2VjTMz22gob7R8WmT2wV5B1UeyY9nnsW2E34fDF_PBF1_t19lwP0q_iQafwv9lw-Bwb0MV4-bl8b22-63_ku3kq39uBfNeP870lTZ_v5pn53g7m2y719An_-BgeyW1IbgWfbCIcvAl7wc0UInyCIxyucPy3KzWh0yVC-P3p2g9CmGxOkxng8N0UYry2Wr6Bk2jzFlrwY1CSz_pf5kYtkeM4DhJS8sr5SQkJE1YpracI7m5_u7v9dHf7CTSjElo4p_pISX7xRMvcqK51e9_KRWF4pWHSWYb-DAAA__9hbl13

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvQ6f4oNvbA-WI8foENjIheowrTZXDiSlPwgCgqKohYtEpiKlWRsG9CHyKnuBPUqeZKBUOM6mrNjS-sKAPp3vnMPjQzsOvOWlFkouYKXYTakouz59CXzLWVKJPOUlGK4N1B0KoQjHkFJDE6o5nMDQvh0uARwHUp7RKjdQ07ziC-igQhv9MYcTUFnWC6OVUS1UyJRvScmZKgouU2qEkppwSZOcp_9CoGS7XnJVprwkPyshNclFIQycwPfz3p3j7iCr9UUU4xAiHMd-8Ar0x3zKyjQhQhpeSppPjVUnpfqFaEON0EYwPaWaqIwYUbQJOLM__9D9ETgzVz8p9Bmrpw8ZDVWW9TPtUupjstb01EIKagQjTOU5Zza_6UN8w4zmmvezm7Li_4e9ENLm0iWkrciLfoEXrvsF_kyVnFFt9NezrBtteEHan1ATe4Bu_hUEas7auk5TbnhZCNk2g2RiW90-ErAs_fytNEIXEW5v2BKtQuzFGGLv5RrDbZXkgk23MEIHFPwgPoZgE0NwsV5P0EHyedI9rTZBFIeeH8SwJbc3vIHz0H_jhR_gR_wBRhS8aDWeoAM_OMXvYUsSItItjJJ2jsbwzo9fw0iza15Qkit201q3zsfLJULe2p6-s2WdTnfe_OAHvIohir3Yj2J_FcHwEgEA_NZ-28-A1j8RLX7lgwW4k4cxU3lVSD1YwOVu2OEHu-erfXzJqeEpoWawgMGROzt23JnjzsCdLVx34bqDPbC9UEIyQ5iqpF2Yufva10IbZWtMTHNrjQ32l0VqF_YGssrzHdM-j_1X2CkczWdH8_bd75PnZpB8kwxah_8thqPnxICuhssv9bux_a7-0e_6qX43Pf2uHve7IXXX7_qZ_W56-20P9fSGd3oKj-zWJLOGzzYh9l8FneF6DCE-wyEOVjj625Ua0fESIfz-fO35AYw25_EEcPB2DBFeWy_fwVm4eQMNvHuNQwwVnMB8iRzHcZBmVEKD4P7u7v7u0_3dJ2BKalNSIc0CDmcLuDycgwOH8yv0VwAAAP__cnVSMg==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO9u27YX_Rw-xYW_2P7BcuQYLQIb-aA6TKvfXDmQlP5BEBAURS1cJDIVKc3aMKAPkVfZC-xR8iQDpcJxNqXFls4fDOjq3nPOPTyU48A7Xmqh5AJWit2UirLr01fAt5wllchTXoLh2kDddSEU4RhSamhCNYcTGNq3wyWA40DKM1rlBmqaV3wBXavQRn_K4QRUlvW20cqotlXIlG9JyZkqCi5TaoSSmnBJk5ynXwFQsh0vuSpTXpKflJCa5KIQBk7g5bx35rhbZLW-iGIcQoTj2A9eg_6UT1mZJkRIw0tJ86mx7KRUPxNtqBHaCKanVBOVESOK1gFn9sfvut8CZ-bqJ4m-9Orpg0dDlWX9SDuXvorU78Hw5bwf9PhJRLusnlrSghrBCFN5zpk9kenDgQwzmmveD23Kiv8b9EJI63TnubYkL_oJXrjuN_AzVXJGtdHfT7JutOEFaUOhiV2gq38Hgpqz9gJMU254WQjZZo1kYlvdPiKwKP34LTVCFxFu7-wSrULsxRhi79Uaw22V5IJNtzBCBxT8ID6GYBNDcLFeT9BB8qXSPa02QRSHnh_EsCW3N7yB89B_64Uf4Qf8EUYUvGg1nqADPzjFH2BLEiLSLYySto7G8N6P38BIs2teUJIrdtNKt8rHyyVC3tpu38mySqc7bX7wf7yKIYq92I9ifxXB8BIBAPza_tvfgNY_Ei1-4YMFuJOHMlN5VUg9WMDlrtj1D3bPV_v9JaeGp4SawQIGR-7s2HFnjjsDd7Zw3YXrDvaa7RUVkhnCVCXtwMzd574W2igbY2KaWytssD8sUjuwV5BVnu-Q9nHsd2bHcDSfHc3bd79NnutB8p940Cr8ZzYcPccGdDVcfivfjc139bd810_lu-nJd_U43w2pu3zXz8x305tvu9TTE97pKTySW5PMCj7bhNh_HXSC6zGE-AyHOFjh6C9XakTHS4Twh_O15wcw2pzHE8DBuzFEeG21_A_Ows1baOD9GxxiqOAE5kvkOI6DNKMSGgT3d3f3d5_v7z4DU1KbkgppFnA4W8Dl4RwcOJxfoT8DAAD__8vQbJw=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIrCRH67DtNpcOZCUfiAICIqiEi4SmYqUZmUY0IfIq-wF9ih5koFS4Tib0mJL6x8GdHXvOeceHspx4B0vtFByBkvFrgtF2dXxK-AbzuJSZAkvwHBtoGq7EApxBAk1NKaawxH07dv-HMBxIOEpLTMDFc1KPoO2VWijP2VwBCpNO9toaVTTyiWNM05uxeUtvSS_KiHtlOwcUmnazAiZ8A0pOFN5zmVCjVBSkxYp-Qqpks14wVWR8KIh0yQTuTBwBC-nnTOH7fLL1VkY4QBCHEWe_xr0p2zMiiQmQhpeSJqNTbNHoX4j2lAjtBFMj6kmKiVG5I1rzuSvP3W3bc7E1U8SfenV4wdf-ypNu5G2zn4VqduD_stpN-jhk4h2WT22pDk1ghGmsowzeyLjhwPppzTTvBvaFCX_P-i5kNbp1nNtSV50E7xw3W_gp6rgjGqjv59kXWvDc9KEQhO7QFv_DgQVZ80FGCfc8CIXsskaScWmvHlEYFG68RtqhM5C3NzzOVoGeBFhiBavVhhuyjgTbLyBAdqj4PnRIfjrCPyz1WqE9uIvlfZpufbDKFh4fgQbcnPNazgNvLeL4CP8gj_CgMIiXA5HaM_zj_EH2JCYiGQDg7ipoyG896I3MNDsiueUZIpdN9Kt8uF8jtBiZbdvZVml4602z_8ZLyMIo0XkhZG3DKF_jgAAfm_-7a9Hq0uixS3vzcAdPZSZyspc6t4MzrfFtr-3fb7Y7S84NTwh1PRm0DtwJ4eOO3HcCbiTmevOXLe302yvqJDMEKZKaQcm7i73ldBG2RgTU99YYb3dYZHYgZ2CLLNsi7SLY78zW4aD6eRg2rz7Y_RcD-If4kGj8L_ZcPAcG9BFf_6tfNc23-W_8l09le-6I9_l43zXpGrzXT0z33Vnvu1ST08sjo_hkdyKpFbwyTrA3mu_FVwNIcAnOMD-Eof_uFIDOpwjhD-crhaeD4P1aTQC7L8bQohXVstPcBKs30IN79_gAEMJRzCdI8dxHKQZlVAjuL-7u7_7fH_3GZiS2hRUSDOD_ckMzven4MD-9AL9HQAA__93AX4Z

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIrCRH67DtNpcOZCUfiAICJqiEi4S6YqUZmUY0IfIq-wF9ih5koFS4Tib0mBL6h8GdHXPuYfnHtFx4APPtVByAnPFrnNF2dXxG-AbzlaFSGOeg-HaQNl0IRTiCGJq6IpqDkfQtW-7UwDHgZgntEgNlDQt-ASaVqGN_pLCEagkaW2jhVF1K5d0lXJyIy5v6CX5VQlpUbIVpJKkxggZ8w3JOVNZxmVMjVBSk4Yp_s5QJWu4WhuRiRuek0JzciW0UZc5zfTTyJyrPOZ5LVOTVGTCwBG8HrdiDhvb5ouzMMIBhDiKPP8t6C_pkOXxighpeC5pOjS1A7n6jWhDjdBGMD2kmqiEGJHVfjujv_7U7YY7I1c_Ouhbrx7eb6SrkqSdabuT7zK1e9B9PW4nPXyU0R5WD-3QjBrBCFNpypnd5fB-ld2Eppq3U5u84P-HPRPSOt14brfefdU-4JXrPsGfqJwzqo1-Ocm60oZnpA6FJvYATf0FBpSc1Z_OMOaG55mQddZIIjbF-sEAy9LOX49G6CzE9Q0xRfMAzyIM0ezNAsO6WKWCDTfQQ3sUPD86BH8ZgX-2WAzQ3upbpXmaL_0wCmaeH8GGrK95BaeB934WfIZf8GfoUZiF8_4A7Xn-Mf4EG7IiIt5Ab1XXUR8-etE76Gl2xTNKUsWua-lWeX86RWi2sKdvZFmlw602z_8ZzyMIo1nkhZE3D6F7jgAAfq__7a9Dy0uixQ3vTMAd3JeZSotM6s4EzrfFpr-zfb7Y7c85NTwm1HQm0DlwR4eOO3LcEbijietOXLez02w_USGZIUwV0gJG7u7s-p6yMSamWlthnV2wiC1gpyCLNN0y7fLYe2Y74WA8OhjX7_4YPNeD1Q_xoFb432w4eI4N6KI7fSrflc138a98l4_lu2rJd_Ew3xUpm3yXz8x31Zpve6jHEbPjY3ggtySJFXyyDLD31m8El30I8AkOsD_H4T8-qR7tTxHCn04XM8-H3vI0GgD2P_QhxAur5Sc4CZbvoYKP73CAoYAjGE-R4zgO0oxKqBDc3d7e3X69u_0KTEltciqkmcD-aALn-2NwYH98gf4OAAD__32fkmQ=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIrCRH67DtNpcOZCUfiAICJqiEi4S6YqUZ2cY0IfIq-wF9ih5koFU4Tib0q5L6h8GdHXPuYfnHtHz4B0vtVByBFPFrktF2dXxK-BrzhaVyFNeguHawKruQijGCaTU0AXVHI6gbd-2xwCeBynPaJUbWNG84iOoW4U2-lMOR6CyrLGNVka5Vi7pIufkRlze0EvyqxLSomQjSGWZwwiZ8jUpOVNFwWVKjVBSk5op_cpQJR1cLY0oxA0vSaU5uRLaqMuSFvp7kUWVG8FUTrSh5j-gS67KlJfukJrkohAGjuDlsBFzWJs-nZ3FCY4gxkkShK9Bf8r7rEwXREjDS0nzvnH-leo3J0NoI5juU01URowo3La8wV9_6uZ1eQNfPzroS6_u3--zrbKsmWm70a8yNXvQfjlsJj18lNF53rdDC2oEI0zlOWc2Cf37ILQzmmveTG3Kiv8f9kJI63Ttud16-0XzgBe-_w3-TJWcUW3080nWG214QVwoNLEHqOvPMGDFmfvw-ik3vCyEdFkjmVhXywcDLEszvxuN0FmM3f0yRtMITxIMyeTVDMOyWuSC9dfQQXsUgjA5hHCeQHg2m_XQ3uJLpX6azsM4iSZBmMCaLK_5Bk6j4O0k-gi_4I_QoTCJp90e2gvCY_wB1mRBRLqGzsLVURfeB8kb6Gh2xQtKcsWunXSrvDseIzSZ2dPXsqzS_lZbEP6MpwnEySQJ4iSYxtA-RwAAv7t_-2vR1SXR4oa3RuD37stM5VUhdWsE59ti3d_aPl_s9pecGp4SalojaB34g0PPH3j-APzByPdHvt_aabafqJDMEKYqaQEDf3e2u-VsjInZLK2w1i5YpBawU5BVnm-ZdnnsPbOdcDAcHAzduz96T_Vg8UM8cAq_z4aDp9iALtrjb-V7Y_Nd_Svfq8fyvWnId_Uw3xuyqvO9emK-N435tod6HDE5PoYHclcks4JP5hEOXoe14FUXInyCIxxOcfyPT6pDu2OE8IfT2SQIoTM_TXqAw3ddiPHMavkJTqL5W9jA-zc4wlDBEQzHyPM8D2lGJWwQ3N3e3t1-vrv9DExJbUoqpBnB_mAE5_tD8GB_eIH-DgAA____p6hl

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk8-O0zAQxu95irkVEInaLf3DVj2UYFClNrs0abU3y3UmwuDYW49TyoPxAjwZcoJYIWUXCe0tij__Ps83M3EMB3SkrLmG1Mqvzgr5-f07wAvKY6N0iQ48kodzp4qinBVQCi-OghCWMAingwVAHEOJlWi0h7PQDV5DJ1Xk6aRhCbaqemWi8baVKlPihTuUtq7RlMIra4ijEUeN5RMAa9rrDq0r0fEvVhniWtXKwxKm4947866QdLPPC7aDnBXFOvsIdNKJdOWRK-PRGaETH9y5s984eeEVeSUpEcRtxb2q2wTi0c8f1B9BPBrSo0a_tZQ8ZDSwVdVP-pPSk6T-DAbTcT90_igxFEtJMK2FV5JLqzXK0JHkoSGDSmjCfrR3Df4PvVYmJN1lTsFk0m8wGQ7_wa-sQynI0_M9mb6Tx5q3Q0E8FND9fwaDM8p2AZISPbpamXbWeKUuzf1fBoHSz2-to2ifs3ZnF1G6Y6uCQc4-7VmWMrhvjlrJhPAE23V2WG32DEawXd11n2-vrsbj2dVwPJ1P3sxmk_lwBuss3bEtywoYQV6sdgWMFosoYne3m9U6gxc3t8VrYNnhJeRsw9ICXsGH3c0WCE-LKI7jOCI8NWgkxoShyeEk-hUAAP__SqpzFA==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfQ6_4sIvtgfLkWO0CGwEmOqwrTZXCSQlaREEBEVRCxeJTEVKszcMKPYNedxv7Af2KfmSgVLqOK3SYkuXhwC6vPecw8ND2nHglJdaKDmDhWJXpaLs8vAF8BVnSSXylJdguDZQt10IRTiGlBqaUM3hAPp2tT8HcBxIeUar3EBN84rPoG0V2uj3ORyAyrLONloZ1bQKmfIVKTlTRcFlSo1QUhMuaZLz9AsASjbjJVdlykvysxJSk1wUwsABPJ92zuy3G1ksT6IYhxDhOPaDV6Df52NWpgkR0vBS0nxsLDsp1S9EG2qENoLpMdVEZcSIonHAmfz9l-62wJm4-lGiu149vveor7KsG2nj0heRuj3oP592g-4_img3q8eWtKBGMMJUnnNmT2R8fyD9jOaad0ObsuL_Bb0Q0jrdeq4tybNugmeu-xX8TJWcUW30t5Os19rwgjSh0MRuoK1_A4Kas-YCjFNueFkI2WSNZGJVXT8gsCjd-A01QicRbu7sHC1C7MUYYu_FEsN1leSCjVcwQDsU_CDeh-AohuBkuRyhneSu0n4tjoIoDj0_iGFFrq_4Go5D_40XvoMf8TsYUPCixXCEdvzgEL-FFUmISFcwSJo6GsKZH7-GgWaXvKAkV-yqkW6VD-dzhLyl3X0ryyodb7T5wQ94EUMUe7Efxf4igv45AgD4rflv_3q0_olo8SvvzcAd3ZeZyqtC6t4MzjfFtr-3-b7Y7i85NTwl1PRm0NtzJ_uOO3HcCbiTmevOXLe31WyvqJDMEKYqaQcm7jb3pdBG2RgTs762wnrbwyK1A1sFWeX5Bmkbx74zG4a96WRv2qz9PnqqB8n_4kGj8N_ZsPcUG9BFf_61fK9tvqvP8l0_lu91R76rh_lek7rNd_3EfK8782039fiEd3gID-TWJLOCXx6F2H8VtILrIYT4JQ5xsMDRJ1dqQIddpp36-OyjZ3XzJthXYIR2KusWGoIXQYSXVi0dQTKCagQ1vAyP3jzEH32i9-w1DjEkcABTawV-e7z0_AAGR8fxCHBwOvyI-l0LVs-R4zgOElLy0rE_XDBgpdJ6iOD25s_bmw-3Nx9AMyph_Vll9f3d22NX_rAZub25uWtgSmpTUiHNDHb3diczON-dggO70wu01ZaJ3PBSw6A5PfRPAAAA__84w7Fb

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk9FO3DoQhq_xU8xddo9IBEIgxIqLkJO2aUMWbQwtqirL60yES2KDx0uXB-sL9MkqJ1VRpUClitvdP98389uOY7hCR9qaE8isunVWqpv_zwC3qNYb3TXowCN5eBhTjNU5h0Z6uZaEcApR-DdaAMQxNNjKTefhQXYbPIExqsnTfQenYNt2MiY33g5RbRrcCofK9j2aRnptDQk0ct1h8wLAmuFzh9Y16MRXqw2JTvfawykcHUx-czwukpWXNc9XUOecF9VboPsuUa5ZC208OiO7xAe7cPabIC-9Jq8VJZKEbYXX_dBAvP_jO01XEO_v0bOiX1lKnjqKbNtOk3639CJpuoPo6GAaevwsMSxLSZD20msllO06VOFEkqcDiVrZEU6jvdvgv9B7bULTY-cUJIfTgsO9vb_wW-tQSfL0eiPTI3nsxXApSIQFxt9fQfCAangASYMeXa_NcNdEq7ebuz8EgTLNH9SMXdb58GYXLFvlKc-Bp2dlDpR4mLEdCUXFj6Facqguy3KX7WTLquartKg4eHF3i49wsSrO09U1fMivYSYhrbM5m8PHgr-DGakb7KXorLod5gnjzBcLxtIyrDS6gj4JwqJ6n2ccap7youZFVkP0-Uu0YCz_dFGmRQWz5QXfhby6mkOdlyH7H7xZLc_DuAsWx3HMSEkDnv0MAAD__2vSgPY=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk1Fq20AQht91inlzDJGwCQkhwQ9pKkrAuKF2TN-W0WqUbrParXdGrvOWQ_gqvUCP4pOUlUpDYZNCyevqn-_XfhrlOawpsPHuAq69fgge9Zf374B2pKvO2JoCCLHAdkhl2bJcQY2CFTLBDEbx6egSIM-hpgY7K7BF29EFDNHhTElAx6jFeKc2HVojj8o3iilsjY6gCvXDffCdq5OwQPedxTAwDQtvLMzAN00yjZ34PmpcTTsVSPu2JVdj7GdFDitL9SsA7_rxQD7UFNRXbxwra1ojMIOzk-TM-SDnen63XJWfYFmuVjeLD8AbW-hQV8o4oeDQFhLbVfDfFQuKYTGaC-ToQ0zbW82nP39wWms-nfCLRb-zXDw7GvmmSZP-WHqVlHYwOjtJQ89fJMbLchFLWxSjlfbWUr8RxfMHGTVomdJoCR39D701LpoenHMsOU0XnE4m_-A3PpBGFn67V-ZHFmpVvxSs4gWG8zco2JLuf4CiJqHQGtfvmmrMrvv2V0GkpPl9dZaVn2_nVzcLOPp4uzqGcrEew_pqflcu4Wg6vszyPM-zfoIzOOz3h_3TYf8ER9PjcfYrAAD___xrd2k=

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk1Fq20AQht91inmzDZGwCQkhwQ9pKkrAuKFWTN-W9WrUTrvarXdGrvOWQ_gqvUCP4pOUlUpDYZNCyevqn-_XfhrlOawxMHl3CTfefA1em89v3wDu0Ww6sjUGEGSB3ZDKslVZQa1FbzQjzGEUn46uAPIcamx0ZwV22nZ4CUN0OFMStGNthLxT205bkgflG8UYdmQiyAQSMtomUQE_dVaHgUgsvLUwB980ybTuxPdRcjXuVUDj2xZdrWM7K3R6Y7F-AeBdPx7QhxqD-uLJsbLUksAczk-TMxeDmpvF_aoqP8CqrKrb5TvgrS1MqDeKnGBw2hYS21Xw3xWLFmIhw4XmaEOo7Z3ms58_OC01n0352aLfWS6eHI1806RJfyy9SEo7GJ2fpqEXzxLjZbmIpa0WMsp4a7Hfh-Lpg4wabRnTaAkd_g-9JRdND845lpylC86m03_wGx_QaBZ-vVfmBxZsVb8UrOIFhvNXKNih6X-AokbB0JLrd001tO--_VUQKWl-X51l5ce7xfXtEsbv76oTKJfrCayvF_flCsazyVWW53me9ROcwfFwOB4ej4dHGM9OJtmvAAAA__9pOXaU

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvi6f4sA3tgfLkBO0CGzkwnWYTpsrB5bStSgKgqKohjMlOiSlWR72WHuBPdlAqXCcVm63pctFAB0dfn_-RM-DN1wboYopLBTbaEXZ3dVL4DvOklLIlGuw3Fio2i2EIhxDSi1NqOFwCX33tj8D8DxIeUZLaaGisuRTaFfbGbGaFoYyK1RB7ksqha2JyojhuhLMATEtrGBUdkJp_rGUVLeIwlhzL-ESVJZ1btPSqmZVFCnfEc2ZynNepNSxG8ILmkiefgVAFc1xzZVOuSa_KlEYIkUuLFzCi_POMxdtNIvlbRTjNUQ4joPwFZh7OWY6TYgoLNcFlWPr2IlWvxFjqRXGCmbG1Lg0rMibTL3JX3-a7lC9iW9OEn3aNeOHjPoqy7qRDil9Fak7g_6L827Qi5OIzqwZO9KcWsEIU1Lypg_jhx-kn1FpeDe01SX_L-i5KFzSbebGkTzvJnju-9_Az5TmjBprvp9kUxvLc9KUwhBnoJ1_B4KKs-YDGKfccp2LoukaycSu3D4icCjd-A01QrcRbm6BGVqs8TzGEM9fLjFsy0QKNt7BAD2jEITxBYSrGMLb5XKEniWfJu3TYhVG8XoehDHsyHbDa7hZB6_n63fwM34HAwrzaDEcoWdBeIXfwo4kRKQ7GCTNHA3hlyD-EQaG3fGcEqnYppHulA9nM4TmS-e-leWUjg_agvAnvIghiudxEMXBIoL-ewQA8Hvz3_31aPWRGLHnvSn4o4cxU7LMC9ObwvvDsN3vHZ4_HO9rTi1PCbW9KfTO_MmF5088fwL-ZOr7U9_vHS27T1QUzBKmysIdmPjH3HfCWOVqTGy9dcJ6x4dF6g4cDYpSygPSMY67Zw4MZ-eTs_Pm3R-jp2aQ_C8ZNAr_XQxnT4kBfejPvtXv2vW7_KLf1al-1x39Lh_3uyZV2-_qif2uO_v9D0ztnant5gtXmmenfO07fG03TzSwP2ngtOX51RU8yrsimVN2vVrj4FXYKquGsMbXeI3DBY4-uxMGdHgaf_85frZ5jKx5dhK7hkE5nCGE394s50EIg9VNPAIcvhlChJfO5w9wvV69hv0MeZ7nIcNoAXv0dwAAAP__ciDMng==

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvi6f4sA3tgfLkBO0CGzkwnWYTpsrB5bStSgKgqKohjMlOiSlWR72WHuBPdlAqXCcVm63pctFAB0dfn_-RM-DN1wboYopLBTbaEXZ3dVL4DvOklLIlGuw3Fio2i2EIhxDSi1NqOFwCX33tj8D8DxIeUZLaaGisuRTaFfbGbGaFoYyK1RB7ksqha2JyojhuhLMATEtrGBUdkJp_rGUVLeIwlhzL-ESVJZ1btPSqmZVFCnfEc2ZynNepNSxG8ILmkiefgVAFc1xzZVOuSa_KlEYIkUuLFzCi_POMxdtNIvlbRTjNUQ4joPwFZh7OWY6TYgoLNcFlWPr2IlWvxFjqRXGCmbG1Lg0rMibTL3JX3-a7lC9iW9OEn3aNeOHjPoqy7qRDil9Fak7g_6L827Qi5OIzqwZO9KcWsEIU1Lypg_jhx-kn1FpeDe01SX_L-i5KFzSbebGkTzvJnju-9_Az5TmjBprvp9kUxvLc9KUwhBnoJ1_B4KKs-YDGKfccp2LoukaycSu3D4icCjd-A01QrcRbm6BGVqs8TzGEM9fLjFsy0QKNt7BAD2jEITxBYSrGMLb5XKEniWfJu3TYhVG8XoehDHsyHbDa7hZB6_n63fwM34HAwrzaDEcoWdBeIXfwo4kRKQ7GCTNHA3hlyD-EQaG3fGcEqnYppHulA9nM4TmS-e-leWUjg_agvAnvIghiudxEMXBIoL-ewQA8Hvz3_31aPWRGLHnvSn4o4cxU7LMC9ObwvvDsN3vHZ4_HO9rTi1PCbW9KfTO_MmF5088fwL-ZOr7U9_vHS27T1QUzBKmysIdmPjH3HfCWOVqTGy9dcJ6x4dF6g4cDYpSygPSMY67Zw4MZ-eTs_Pm3R-jp2aQ_C8ZNAr_XQxnT4kBfejPvtXv2vW7_KLf1al-1x39Lh_3uyZV2-_qif2uO_v9D0ztnant5gtXmmenfO07fG03TzSwP2ngtOX51RU8yrsimVN2vVrj4FXYKquGsMbXeI3DBY4-uxMGdHgaf_85frZ5jKx5dhK7hkE5nCGE394s50EIg9VNPAIcvhlChJfO5w9wvV69hnqGPM_zkGG0gBr9HQAA__9yD8yc

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvi6f4sA3tgfLkBO0CGzkwnWYTpsrB5bStSgKgqaohjMlOiSlSR72WHuBPdlAqXCcVm63pctFAB0dfn_-RM-DN1wbofIpLBTbakXZ3dVL4BVnm0LIhGuw3Fgo2y2EIhxDQi3dUMPhEvrubX8G4HmQ8JQW0kJJZcGn0K62M2I1zQ1lVqic3BdUClsTlRLDdSmYA2JaWMGo7ITS_GMhqW4RhbHmXsIlqDTt3KaFVc2qyBNeEc2ZyjKeJ9SxG8JzupE8-QqAypvjmiudcE1-VSI3RIpMWLiEF-edZy7aaBbL2yjGa4hwHAfhKzD3csx0siEit1znVI6tYyda_UaMpVYYK5gZU-PSsCJrMvUmf_1pukP1Jr45SfRp14wfMuqrNO1GOqT0VaTuDPovzrtBL04iOrNm7EgzagUjTEnJmz6MH36Qfkql4d3QVhf8v6BnIndJt5kbR_K8m-C5738DP1WaM2qs-X6STW0sz0hTCkOcgXb-HQhKzpoPYJxwy3Um8qZrJBVVsXtE4FC68RtqhG4j3NwCM7RY43mMIZ6_XGLYFRsp2LiCAXpGIQjjCwhXMYS3y-UIPdt8mrRPi1UYxet5EMZQkd2W13CzDl7P1-_gZ_wOBhTm0WI4Qs-C8Aq_hYpsiEgqGGyaORrCL0H8IwwMu-MZJVKxbSPdKR_OZgjNl859K8spHR-0BeFPeBFDFM_jIIqDRQT99wgA4Pfmv_vr0fIjMWLPe1PwRw9jpmSR5aY3hfeHYbvfOzx_ON7XnFqeEGp7U-id-ZMLz594_gT8ydT3p77fO1p2n6jImSVMFbk7MPGPue-EscrVmNh654T1jg-LxB04GuSFlAekYxx3zxwYzs4nZ-fNuz9GT81g879k0Cj8dzGcPSUG9KE_-1a_a9fv4ot-l6f6XXf0u3jc75qUbb_LJ_a77uz3PzC1d6Z22y9caZ6e8rXv8LXbPtHA_qSB05bnV1fwKO-SpE7Z9WqNg1dhq6wcwhpf4zUOFzj67E4Y0OFp_P3n-On2MbLm6UnsGgbFcIYQfnuznAchDFY38Qhw-GYIEV46nz_A9Xr1GqoZ8jzPQ4bRHCr0dwAAAP__cf7Mmg==

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfLkBO0CGzkwXWYTpsrB5bStSgKgqaohjMlOiTlWR72WfuBfdlAqXCcVGrXJfWDAV3de865R4f0PHjLtREqH8NMsbVWlN1evgK-42xVCJlwDZYbC9u6C6EIx5BQS1fUcLiArnvbnQB4HiQ8pYW0sKWy4GOoW-sasZrmhjIrVE7uCiqFLYlKieF6K5gDYlpYwahshNL8UyGprhGFseZOwgWoNG3spoVVVavIE74jmjOVZTxPqGM3hOd0JXnyFQCVV-OaK51wTX5XIjdEikxYuICXZ40z57U1s_lNFOMlRDiOg_A1mDs5ZDpZEZFbrnMqh9axE63-IMZSK4wVzAypcW5YkVWeeqN__jbNpnoj37QSfe41w3uPuipNm5EOLn0VqdmD7suzZtDzVkS3rBk60oxawQhTUvIqD8P7D9JNqTS8Gdrqgv8f9Ezkzunac-NIXjQTvPD9b-CnSnNGjTXPJ9mUxvKMVKEwxC1Q15-BYMtZdQCGCbdcZyKvskZSsSs2DwgcSjN-RY3QTYSrW2CCZks8jTHE01dzDJtiJQUb7qCHTigEYXwO4SKG8GY-H6CT1edK_TRbhFG8nAZhDDuyWfMSrpfBm-nyPfyK30OPwjSa9QfoJAgv8TvYkRURyQ56q6qO-vBbEP8MPcNueUaJVGxdSXfK-5MJQtO5276W5ZQOD9qC8Bc8iyGKp3EQxcEsgu4HBADwZ_Xvfh26_USM2PPOGPzBfZkpWWS56Yzhw6FY93cOzx-P-zWnlieE2s4YOqf-6NzzR54_An809v2x73eOmt0RFTmzhKkidwMj_5j7VhirXIyJLTdOWOd4WCRu4KiQF1IekI5x3D1zYDg9G52eVe_-GjzVg9UP8aBS-H02nD7FBvSxO_lWvvcu35v1FwHXPG2L-L4h4pv1E7O8b8zyf1igdAsUX-jftqkvG9QXDw9oSbb1Ad0-camydal2G6aXl3AkN13D1WKJg9dhLVXztA9LfIWXOJzh6BFdr-i3Y5ePsd2eqTPjAcO2FX8HPfo9-I-1tyPvXYL6E4Twu-v5NAiht7iOB4DDt32I8NxZ-BNcLRdvoJwgz_M8ZBjNoUT_BgAA__9Cmuex

# Check that we remove histograms from statistics correctly.

statement disable-cf-mutator ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0VO9u27YX_Rw-xYW_2PnBEmSn6S-1kQ-Ko27aVDmwlKxFURAURTVcKDIhKTfZsMfaC-zJBlKt4w1q9geZPxjQveeew3N4pSCAK6YNV3IBK0VvtCL0-vwM2D2jVcdFzTRYZixsexRCRVJCTSypiGFwCmPXHS8BggBq1pBOWNgS0bEF9NC-hq0m0hBquZL4riOC2wesGmyY3nLqiKjmllMiBqk0-9gJontGbqy5E3AKqmkG0aSzykO5rNk91oyqtmWyJk7dYCZJJVj9BIGSflwzpWum8Y-KS4MFb7mFU3h5NDhz0kezyi6LMtlAkZRlmn8D5k6EVNcV5tIyLYkIrVPHWn3CxhLLjeXUhMS4NCxvfabB7LdfzXCowSwyXxX6jDXhY0Zj1TTDTLuUnmQazmD88miY9OSrjM6sCZ1oSyynmCohmN-H8PFCxg0Rhg1TW92xf8PecumS7jM3TuR4WOA4iv6Cv1GaUWKseb4jmwdjWYv9UhjsDPT1ZxDYMupfgLBmlumWS79ruOH33e0fBBzLML-XRuiySPxXYIlWmyQuEyjjsyyB264SnIYVTNBBBWfrdQb5uoT8Msum6ECrT7yGNC9PfPUqLVI39AUB58nr-DIroZP8rvOXw-vJ4RQdrNZ5UW7iNC-hwrc37AEuNumbePMOvk_ewaTnjYuVw6b5efIWKlxhXt_DpPJ1dAg_pOW3MDH0mrUEC0VvvFNn9HC5RCjOXFi9C2cs3FlJ8--SVQlFGZdpUaarAsbvEQDAz_7f_UZk-xEb_hMbLWA2fSxTJbpWmtEC3u-KvlGNds8f9vGaEctqTOxoAaN5NJ8Hs3kQzWF2sjh6sZi_Co___-LV0Xy0N-NebC6pxVR10s3N95rX3FjlVh_bh1t3utH-KK__dF5JWg_Cfu0w3gfLToidRrTXcN-tL_XZLIp855fpExFFfycif6n_YUzRP4tp_pwxfc4IfRgvEUreXmRxmsNkfVFOIcmvDqFIMrdy_4PXm_UbqJYoCIIAGUokVOj3AAAA__-HIkA7
