# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvQ6f4oNvbA-WItkoUMgIMNVhWm2uHEhKfxAEBEVRCxH9uCKlyRsG9CHyKnuBPUqeZKCUOc6mtBjS-sKAPh2ec3h8PhsGvOOVFGXhwKpkN1VJ2fXpK-AtZ3EtsoRXoLhU0PQohEIcQUIVjankcAJj_Xa8BDAMSHhK60xBQ7OaO9BDhVTyUwYnUKbpIIzWquygokh4SyrOyjznRUKVKAtJeEHjjCdfIPjH1Wp9EUY4gBBHkee_BprkQmrTJs-oVIIRtq3NneBZYj6wjlOaST58A1XVfJBafspMViUxEYXiVUEzU2k-UpW_EqmoElpOmlSSMiVK5F1Shv3Xn3JYyLAt-aTQPVaaD1mOyzQdZtqnOcSkrUlTQ3La5VFmGWeqi-j5gXyBPReFzqVPSGqRF8MCLyzrK_xpWXFGpZLfzrLcScVz0v2EkugL9PNvINBw1tXaTLjiVS6KrhkkFW29fSSgWYb5O2mELkLcbeISrQLsRhgi99Uaw7aOM8HMFiboiILnRy_B30TgX6zXM3QU30_6p9XGD6PA9fwIWrK94Ts4D7y3bvARfsYfYULBDVfTGTry_FP8AVoSE5G0MIm7OZrCey96AxPJrnlOSVaym866dj5dLhFy1_r2vS3t1Nx78_yf8CqCMHIjL4y8VQjjSwQA8Hv3rT8j2vxCpPiNjxywZg9jVmZ1XsiRA5f7YY8f7Z-vDvEVp4onhKqRA6O5Zb80LNuwbLBsx7IcyxodgPVCiYIpwsq60Ads61D7WkhV6hoTtdtqY6PDwyLRBw4GRZ1le6ZDHv2vsFeYL-z5onv3x-y5GcTfJYPO4f-LYf6cGNDVePm1fu90v-v_9Lt5qt-7gX7Xj_u9I03f7-aZ_d4N9ltf6ukT7ukpPLLbkFQbPtsE2Hvt94abKQT4DAfYX-HwXys1odMlQvjD-dr1fJhszqMZYP_dFEK81l5-gLNg8xZaeP8GBxhiOIHFEhmGYSDJaAHtj_f7jeDu9vbu9vPd7WdgZSFVRUWhHDieH9sOXB4vwIDjxRX6OwAA__-PHWNf


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvQ6f4oNvbA-WItsoUNgIMNdhWm2uHEhKfxAEBEVRCxeJdEXKszYMKPYMvtxr7AX2KHmSgXLmOKvSYkjrCwP6eHjO4dGhHAfe8FILJScwV-ymVJRdn74AvuEsqUSe8hIM1wbWOxRCEY4hpYYmVHM4ga5d7U4BHAdSntEqN7CmecUnsIMKbfSHHE5AZVkrjFZGNVAhU74hJWeqKLhMqRFKasIlTXKefobgX1fzxUUU4xAiHMd-8BJoWghtTbs8p9oIRtiqcmvB89S9Z-1mNNe8_QSmrHgrtf6Qu6xMEyKk4aWkuWssHynVL0QbaoSV0y7VRGXEiKJJyhn-_ZduF3KGnn5U6A6r3fssuyrL2pn2abYxWWvatZCCNnmoPOfMNBE9PZDPsBdC2lx2CWkr8qxd4JnnfYE_UyVnVBv99SzrWhtekOYVamIPsJt_BYE1Z02t3ZQbXhZCNs0gmdhUqwcClqWdv5FG6CLCzU2conmIZzGGePZigWFVJblg7gZ66IiCH8TPIVjGEFwsFgN0lNxNdk_zZRDF4cwPYtiQ1Q2v4Tz0X8_C9_Ajfg89CrNo3h-gIz84xe9gQxIi0g30kmaO-vDWj19BT7NrXlCSK3bTWLfO-9MpQrOFPf3OlnXq7r35wQ94HkMUz2I_iv15BN1LBADwW_Nvfx26_olo8SvvTMAb3I-ZyqtC6s4ELvfDHb6zf746xJecGp4SajoT6Iy84XPHGzreELzhxPMmntc5ANsLJSQzhKlK2g1D71D7WmijbI2JqVfWWOdws0jthoOBrPJ8z3TIY78Ke4XReDgaN2u_D56aQfJNMmgc_r8YRk-JAV11p1_qd237XX3S7_Vj_a5b-l097HdN1rt-r5_Y77q13_ZQj--YnZ7CA7trklnDZ8sQ-y-DneF1H0J8hkMczHH0nyvVo_0pQvjd-WLmB9BbnscDwMGbPkR4Yb18B2fh8jVsBlDD21c4xJDACYynyHEcBwkpeen8rISEHiuV1n0Et9s_b7cfb7cfQTMqof5ksvn-7pNgV_6wr-52u70DMCW1KamQZgLHo-PhBC6Px-DA8fgKHcAykRteaug1oaJ_AgAA___rTYdo

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkFMUKGzkQXWYTpurBJbStQgCgqaohQtFuiKlyBsG9CPyuN_YD-xT8iUDpcxxNqXFkNYPhnV5eM7h8aE8D97x0gitZrDQ7LrUlF0dvwbecLauhMx4CZYbC3WHQijBKWTU0jU1HI5g6FaHcwDPg4zntJIWaiorPoMOKow1HyUcgc7zXhitrG6hQmW8ISVnuii4yqgVWhnCFV1Lnn2G4B9Xi-V5kuIVJDhNo_gN0KwQxpn2uaTGCkbYpvK3gsvMf2Ad5lQa3n8CW1a8l9p8lD4rszURyvJSUelbx0dKfUOMpVY4OeNTQ3ROrCjapLzpX3-afiFvGpgnhe6xxn_IcqjzvJ9pl2Yfk7NmfAcpaJuHlpIz20b0_EA-w14I5XLpEjJO5GW_wMsg-AJ_rkvOqLHm61k2W2N5Qdq_0BB3gG7-FQRqztpa-xm3vCyEaptBctFUm0cCjqWfv5VG6DzB7U2co8UKhymGNHy9xLCp1lIwv4EROqAQxekriE9TiM-Xywk6WN9PuqfFaZykqzCKU2jI5ppv4WwVvQ1XH-BH_AFGFMJkMZ6ggyg-xu-hIWsisgZG63aOxvBTlH4PI8OueEGJ1Oy6te6cj-dzhMKlO31nyzn1d96i-Ae8SCFJwzRK0miRwPACAQD81n67z4DWPxMjfuWDGQSThzHTsiqUGczgYjfs8IPd8-U-vuTU8oxQO5jB4DCYvvKCqRdMIZjOgmAWBIM9sLtQQjFLmK6U2zAN9rWvhLHa1ZjY7cYZG-xvFpnbsDdQlZQ7pn0e91bYKRy-mB6-aNd-nzw3g_U3yaB1-P9iOHxODOhyOP9Sv7eu39V_-l0_1e9tT7-rx_3ekrrrd_3Mfm97--0O9fSO8PgYHtmtSe4Mn5yucPQm7gzXY1jhE7zC8QIn_7pSIzqeI4Tfny3DKIbR6Vk6ARy_G0OCl87Ld3CyOn0LDYQJaMUn3S97o-fI8zwPCaV46f2ihYIRK7UxYwR3t3_c3X66u_0EhlEFDVxQc6QVv3xiyd7odun2fikX0vLSwKiNDP0dAAD__-r-e9M=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4iRY7RIbCRH67DtNpcOZCUfiAICJqiFi4U6YqUZ20Y0IfIq-wF9ih5koFS4Tib0mJI6x8GdHXvOeceHsrz4C0vjdBqAnPNbktN2c3ZS-BbzlaVkBkvwXJjYdN2IZTgFDJq6YoaDqfQd2_7UwDPg4zntJIWNlRWfAJtqzDWfJRwCjrPO9toZXXTKlTGt6TkTBcFVxm1QitDuKIrybMvAGjVjJdclxkvya9aKEOkKISFU_hx3Dlz0i4yX1wmKY4hwWkaRq-AZoUwbk-fS2qsYIStK78WXGb-g5B-TqXh3UvbsuKd0Oaj9FmZrYhQlpeKSt86PFLq34ix1ApHZ3xqiM6JFUVjrjf6-y_TTeSNAvMk0ede4z_Y39d53o20O4AuJCfN-K6loI0fWkrObGPR8w35AnohlPOldcg4khfdBC-C4Cv4uS45o8aabyfZ1MbygjRHaIhboK1_A4INZ81N8DNueVkI1SSD5GJbrR8ROJRu_IYaocsEN5d3iuYxnqUY0tnLBYZ1tZKC-VsYoAMKYZSeQLRMIbpcLA7RwepzpX2aL6MkjWdhlMKWrG95DRdx-GYWf4Cf8QcYUJgl8-EhOgijM_wetmRFRLaFwaqpoyG8C9PXMDDshheUSM1uG-lO-XA6RWi2cNu3spxSf6ctjH7C8xSSdJaGSRrOE-hfIQCAP5p_9-vRzS_EiN95bwLB4UOZaVkVyvQmcLUrtv293fP1fn_JqeUZobY3gd5xMDrxgpEXjCAYTYJgEgS9vWZ3oYRiljBdKTcwCva5b4Sx2sWY2HrthPX2h0XmBvYKqpJyh7SP474KO4bj8eh43Lz78_C5Hqy-iweNwv9nw_FzbEDX_enX8l27fFf_yffmqXzXHfmuHue7Jps235tn5rvuzLdb6umJ2dkZPJK7IbkTfL6McfgqagVvhhDjcxzjaI6Tf12pAR1OEcLvLxazMILB8iI9BBy9HUKCF07LD3AeL99ADe9e4xhDBacwniLP8zxkGFVQI7i_u7u_-3R_9wmYVsaWVCg7gaPRBK6OxuDB0fga_RMAAP__xG5wjg==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sRY7RIrCRH67DtNpcOZCUfiAICFqiFi4U6YqUZm0Y0IfIq-wF9ih5koFS4TibkmJI5h8GdHXvOeceHdJx4AMrNFdyCguV3BSKJtenb4BtWbIuuUhZAYZpA1XbhVCEY0ipoWuqGZxA377tzwAcB1KW0VIYqKgo2RTaVq6N_iLgBFSWdbbR0qimlcuUbUnBEpXnTKbUcCU1YZKuBUufAFCyGS-YKlJWkF8Ul5oInnMDJ_B60jlz3C6yWF5EMQ4hwnHsB2-BpjnXdk-XCaoNT0iyKd2aM5G690L6GRWadS9tipJ1Qusvwk2KdE24NKyQVLjG4pFC_Uq0oYZbOu1STVRGDM8bc53xX3_qbiJn7OlHib71avfe_r7Ksm6k3Qd4Eqnb3v7rSTfo8aOIdlntWtKcNg4rIVhiGtOfb_ET6DmX1unWc21JXnUTvPK87-BnqmAJ1Ua_nGRda8Ny0oRCE7tAW38BgoolzdlyU2ZYkXPZZI1kfFtuHhBYlG78hhqhiwg318EMLUI8jzHE8zdLDJtyLXjibmGADij4QXwMwSqG4GK5HKGD9bdK-7RYBVEczv0ghi3Z3LAazkP__Tz8DD_hzzCgMI8WwxE68INT_Am2ZE14uoXBuqmjIXz043cw0Mk1yykRKrlppFvlw9kMofnSbt_KskrdnTY_-BEvYojieexHsb-IoH-JAAB-b_7tr0ern4nmv7HeFLzRfTlRosyl7k3hclds-3u756v9_oJRw1JCTW8KvSNvfOx4Y8cbgzeeet7U83p7zfaIcpkYkqhS2oGxt899zbVRNsbE1BsrrLc_zFM7sFeQpRA7pH0ce8_sGI4m46NJ8-6P0XM9WP8vHjQK_5sNR8-xAV31Z9_Ld23zXf4r39Vj-a478l0-zHdNqjbf1TPzXXfm2y71-MT89BQeyK1IZgWfrULsvw1awdUQQnyGQxwscPSPIzWgwxlC-NP5cu4HMFidxyPAwYchRHhptfwAZ-HqPdTw8R0OMZRwApMZchzHQTqhEmoEd7e3d7df726_QqKkNgXl0kzhcDyFy8MJOHA4uUJ_BwAA___X14r4

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4iRY7RIrCRH67DtNpcOZCUfiAICFqiEi4S6YqUZmUY0IfIq-wF9ih5koFU4TibkmJI5x8GdHXvOeceHspx4AMrFZdiAnOZ3JSSJtcnb4BtWLKqeJ6yEjRTGuq2C6EIx5BSTVdUMTiGvnnbnwI4DqQso1WuoaZ5xSbQtnKl1ZccjkFmWWcbrbS0rUzQVc7ILb-6pVfkV8mFmRKdQzLL7AwXKduQkiWyKJhIqeZSKNIipc-QSmHHSybLlJWWTJGcF1zDMbwed84ctcvPF-dRjEOIcBz7wVugacGV8cZlOVWaJyRZV27DWZ66D0L6Gc0V6zZKlxXrhFZfcjcp0xXhQrNS0NzV1qJS_kaUppobOuVSRWRGNC_sgTijv_5U3UTOyFNPEn3rVe7DkfVllnUjbQ_tWaRue_uvx92gR08immWVa0gLah2Wec4SbU1_ucXPoBdcGKdbz5UhedVN8MrzvoOfyZIlVGn14ySrRmlWEBsKRcwCbf0HENQssXfLTZlmZcGFzRrJ-KZaPyIwKN34lhqh8wjbT8gUzUM8izHEszcLDOtqlfPE3cAA7VHwg_gIgmUMwflisY_2Vt8q7dN8GURxOPODGDZkfcMaOAv997PwM_yCP8OAwiyaD_fRnh-c4E-wISvC0w0MVraOhvDRj9_BQCXXrKAkl8mNlW6UD6dThGYLs30ryyh1t9r84Gc8jyGKZ7Efxf48gv4FAgD43f6bX4_WV0TxW9abgLf_UE5kXhVC9SZwsS22_b3t8-Vuf8moZimhujeB3qE3OnK8keONwBtNPG_ieb2dZnNFuUg0SWQlzMDI2-W-5kpLE2Oim7UR1tsd5qkZ2CmIKs-3SLs45juzZTgcjw7H9t0f-y_1YPW_eGAV_jcbDl9iA7rsT7-X78bku_pXvuun8t105Lt6nO-G1G2-6xfmu-nMt1nq6YnZyQk8kluTzAg-XYbYfxu0gushhPgUhziY4-gfV2pAh1OE8KezxcwPYLA8i_cBBx-GEOGF0fITnIbL99DAx3c4xFDBMYynyHEcB6mECmgQ3N_d3d99vb_7CokUSpeUCz2Bg9EELg7G4MDB-BL9HQAA__-60Zx1

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VG1u4zYQ_R2eYuA_tgtLkWPsIrCRH16H2VXrlQNJ2Q8EAUFLVMJGIr0i5VopCuwhcpVeoEfJSQpSC8dplQRFUv8woNHMe2-eHuk48ImViksxhplMrktJk6vjd8A2LFlWPE9ZCZopDeumC6EIx5BSTZdUMTiCrnnbnQA4DqQso1WuYU3zio2haeVKq285HIHMstY2WmlpW5mgy5yRG355Qy_Jr5ILMyVah2SW2RkuUrYhJUtkUTCRUs2lUKRBSp8glcKOy5XmBb9hJakUI1dcaXlZ0kI9P1kyWaastDIVyXnBNRzB21HrzGFj22x-FsU4hAjHsR-8B5oWXBlXXZZTpXlCklXl1pzlqXu_QjejuWLtFuuyYq3Q6lvuJmW6JFxoVgqau9qaW8rfiNJUc0OnXKqIzIjmhf2UzvCvP1U7kTP01KNEP3qVe_-xuzLL2pG2n_tJpHZ7u29H7aCHjyKaZZVrSAtqHZZ5zhJtTX-5xU-gF1wYpxvPTaC6b9oJ3njeM_iZLFlClVavJ1nVSrOC2FAoYhZo6q9AsGaJPZVuyjQrCy5s1kjGN9XqAYFBace31AidRdhePhM0C_E0xhBP380xrKplzhN3Az20R8EP4kMIFjEEZ_P5AO0tf1Sap9kiiOJw6gcxbMjqmtVwGvofp-FX-AV_hR6FaTTrD9CeHxzjL7AhS8LTDfSWto768NmPP0BPJVesoCSXybWVbpT3JxOEpnOzfSPLKHW32vzgZzyLIYqnsR_F_iyC7jkCAPjd_ptfh64vieI3rDMGb3BfTmReFUJ1xnC-LTb9ne3zxW5_yahmKaG6M4bOgTc8dLyh4w3BG449b-x5nZ1mc0S5SDRJZCXMwNDb5bZXoIkx0fXKCOvsDvPUDOwURJXnW6RdHHPPbBkORsODkX33x-ClHiz_Fw-swv9mw8FLbEAX3clz-a5Nvqt_5Xv9WL7rlnxXD_Ndk3WT7_UL81235tss9fjE9PgYHshdk8wIPlmE2H8fNILXfQjxCQ5xMMPRP45Uj_YnCOEvp_OpH0BvcRoPAAef-hDhudHyE5yEi49Qw-cPOMRQwRGMJshxHAephAqoEdzd3t7dfr-7_Q6JFEqXlAs9hv3hGM73R-DA_ugC_R0AAP__-IGwwA==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvY6e4oNvbA-WIsdoEdjIheswrTZXDiSlPwgCgpaohAtFuiLlWRkG9CHyKnuBPUqeZCBVOM6mpCuS-cKAqO_88PCIrgsfaKmYFGOYyfS6lCS9On4DdEPTZcV4RkvQVGlYN1OOE6MEMqLJkigKR9A1b7sTANeFjOak4hrWhFd0DM0oU1p94XAEMs9bx0ilpR2lgiw5xTfs8oZc4l8lEwYlWkEyzy2GiYxucElTWRRUZEQzKRRumLInRKWwcLnSrGA3tMSVoviKKS0vS1KoH0UWFdcslRwrTfR_QJdUlhkt7SYV5qxgGo7g9agVc9iEPpufxQmKIEZJEoRvgWQFU-ZMPMqJ0izF6aryakZ55t0H0M0JV7T9gHRZ0VZq9YV7aZktMROaloJwT9ujKeVvdofMyCmPKCxzrFlhi-AO__pTtQu5Q189KvRtVnn3VenKPG9n2pblSab2eLuvR-2kh48y2uP0jGhBbMKSc5pqG_rzI36CvWDCJN1kbgrVfdUu8Mr3v8Ofy5KmRGn1cpZVrTQtsC2FwmYDzfoLCKxpar9pL6OalgUTtms4Z5tq9UDAsLTzW2nHOYuRvbomzixC0wRBMn0zR7Cqlpyl3gZ6zh6BIEwOIVwkEJ7N5wNnb_ltpXmaLcI4iaZBmMAGr65pDadR8H4afYZf0GfoEZjGs_7A2QvCY_QJNniJWbaB3tKuO334GCTvoKfSK1oQzGV6ba0b5_3JxHGmc7P7xpZx6m29BeHPaJZAnEyTIE6CWQzdcwcA4Hf7b34dsr7Eit3Qzhj8wf1yKnlVCNUZw_l2sZnvbJ8vdudLSjTNMNGdMXQO_OGh6w9dfwj-cOz7Y9_v7AybT5SJVONUVsIAhv6utr1ATY2xrlfGWGcXzDID2FkQFedbpl0ec89sFQ5Gw4ORfffH4LkZLP-XDKzDH4vh4DkxOBfdyff6XZt-V__q9_qxftct_a4e9rvG66bf62f2u27tt9nU44jp8TE8sLvGuTF8sohQ8DZsDK_7EKETFKFwhuJ_fFI90p84Dvp0Op8GIfQWp8kAUPihDzGaGy8_wUm0eA81fHyHIgQVHMFo4riu6zoqJQJqB-5ub-9uv97dfoVUCqVLwoQew_5wDOf7I3Bhf3Th_B0AAP__TWvGwQ==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyslMGO0zwUhfd5irvr_yMStVM6LVPNogSDKrWZoUmr2VmucyMMjt36OqXzYLwAT4acIEZImbJgdlF8_B2f45vEMezQkbLmBlIrvzor5Of37wDPKPeN0iU68EgeTp0qinJWQCm82AtCuIVBWB3MAeIYSqxEoz2chG7wBjqpIk9HDbdgq6pXJhpvW6kyJZ65Q2nrGk0pvLKGOBqx11heAFjTbndoXYmOf7HKENeqVh5u4Xrcu2fWBUlX27xgG8hZUSyzjyDKWlHImaAW5JXk8tAkjwp1mTwdZFAJTdgf2rsGe9F01Il05Z4r49EZoRMfeNzZb5y88CrYUSKI24p7VbflxqMf36nfKB4N6VmjX1pKnuof2KrqJ_2-gIuk_noH1-N-6OxZYghLSTCtRduw1Rqlb0v_94ov0GtlQtNd5xRMJv0Gk-HwL_zKOpSCPL3ckemRPNa8HQriIUD3_gUMTijbbysp0aOrlWlnjVfq3Bz-MAiUfn5rHUXbnLW_g3mUbtiiYJCzT1uWpQwOzV4rmRAeYb3MdovVlsEI1ouH7vHt1dV4PL0ajq9nkzfT6WQ2nMIySzdszbICRpAXi00Bo_k8itjD_WqxzOC_u_viNbBs9z_kbMXSAl7Bh83dGgiP8yiO4zgiPDZoJMaE4ZLDSvQzAAD__zYRkXA=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfQ6_4sIvtgdLkWO0CGwEmOowrTZXCSQlaREEBCVRCxeJTEVKszcMKPYNftxv7Af2KfmSgVLqOK2SYkibhwC6uvecc48OacuCM1YqLsUU5jK5LiVNrg5fAVuyJK54nrISNFMa6rYLoRBHkFJNY6oYHEDfvO3PACwLUpbRKtdQ07xiU2hbudLqQw4HILOss41WWjatXKRsSUqWyKJgIqWaS6EIEzTOWfoEgBTNeMlkmbKS_Cq5UCTnBddwAC8nnTP77SLzxWkY4QBCHEWe_xpoWnBl9rRZTpXmCUluKnvFWZ7a90L6Gc0V615alxXrhFYfcjsp05hwoVkpaG5rg0dK-RtRmmpu6JRNFZEZ0bxozLXG__6juomssaMeJbrrVfa9_X2ZZd1Imw_wJFK3vf2Xk27Q_UcRzbLKNqQFbRyWec4S3Zj-fIufQC-4ME63nitD8qKb4IXjfAU_kyVLqNLq20lWK6VZQZpQKGIWaOvfgKBmSXO27JRpVhZcNFkjGV9WNw8IDEo3fkON0GmIm-tghuYBdiMMkftqgeGminOe2EsYoB0Knh_tg38cgX-6WIzQTnxXaZ_mx34YBa7nR7AkN9dsBSeB99YN3sPP-D0MKLjhfDhCO55_iN_BksSEp0sYxE0dDeHci97AQCVXrKAkl8l1I90oH85mCLkLs30ryyi1N9o8_yc8jyCM3MgLI28eQv8CAQD80fw3fz1a_0IU_531puCM7suJzKtCqN4ULjbFtr-3eb7c7i8Z1SwlVPem0NtzxvuWM7acMTjjqeNMHae31WyOKBeJJomshBkYO9vcV1xpaWJM9OrGCOttD_PUDGwVRJXnG6RtHHPPbBj2JuO9SfPuz9FzPYi_iweNwv9nw95zbECX_dnX8r0y-a6-yHf9WL5XHfmuHuZ7Reo23_Uz873qzLdZ6vEJ9_AQHsitSWYEHx0H2Hvtt4LrIQT4CAfYn-PwsyM1oMMu0848fP7Js7q5E8wtMEI7lXELDcENIcQLo5aOIB5BNYIajoLjtw_xR5_pPX-DAwwxHMDEWIHfnSxcz4fB8Uk0AuyfDT-h_tCC1TNkWZaFuBCstMwPFwySUio1RHC7_vt2_fF2_RFUQgWsvqgsf7y7e8ybv0xGbtfru4ZECqVLyoWewu7e7ngKF7sTsGB3com22jKea1YqGDRfD_0XAAD__9-nz7c=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyslMFO3DoUhtf4Kc4uM1ckAiEQYsQi5KZt2pBBE0OLqsryOCfCxYnBx6HwYH2BPlnlTFVUKUwXZTtz_H3n_-MkjuEKHWnbn0Bm1a2zUt38fwb4iGo9aNOgA4_k4WEzxVidc2ikl2tJCKcQhX-jBUAcQ4OtHIyHB2kGPIHNqCZP9wZOwbbt5JgcvB1Hdd_go3CobNdh30ivbU8Ce7k22GwB2H487tC6Bp34anVPwuhOeziFo4PJM8ebIFl5WfN8BXXOeVG9Bdl0mkLOBI0kr5VQd0PypNE0yfMiUSsN4XRo7wacRNO9SZRr1kL3Hl0vTeIDTzj7TZCXXgcdJZKEbYXX3VhuvP_jO02L4v09elH0a5aS5_oj27bTpN8PYCtput7o6GAaevwiMYSlJEg7OTZsjUHlx9L_veIt9E73oelN5xQkh9OCw729v_Bb61BJ8vR6K9MTeezEeClIhACb319B8IBqfLeSBj26TvfjXROtfhzu_hAEyjR_VDN2Wefj52DBslWe8hx4elbmQImHGduRUFT8GKolh-qyLHfZTrasar5Ki4qDF3e3-AQXq-I8XV3Dh_waZhLSOpuzOXws-DuYkbrBTgpj1e24T1hnvlgwlpYh0sYV9EkQFtX7PONQ85QXNS-yGqLPX6IFY_mnizItKpgtL_gu5NXVHOq8DLP_wZvV8jysu2BxHMeMlOzBs58BAAD__4JDn1I=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk0FqGzEUhvdzirezDZnBJiSEBC_SdCgB44baMd2JN9KbVI1GivU0rr3LIXyVXqBH8UmKZkpDQXE33mp-fb_06U2ew4o8a2ev4c7JZ-9Qfvv4AWhLsmq1UeQhEAfY9KksW5RLUBiwQiaYwiB-HdwA5DkoqrE1ATZoWrqGPtqvieDRMsqgnRXrFo0OO-FqweQ3WkZQhfL5ybvWqiTM01Nr0PdMzYHXBqbg6jqZxja4Lqqtoq3wJF3TkFUY-1mQxcqQOgJwttvuyXlFXnx32rIwutEBpnB5ntxz1cu5mz0uluUXWJTL5f38E6BqNEd3BRnkoKWQL22x02RU8XaQQY2GKS0y-JaSaF6bQnpVCW0DeYumCJEnvPshOGDQsY4L5Kg66KZ7sHzy6yeni_LJmN8t-pPl4k3_wNV1mvT3AY6S0noHl-dp6NW7xHhZLmJpg51hZwx1w3YKxUfojbbRdO-cY8lFuuBiPP4Pv3aeJHLg0x2ZdxyoEd1QsIgX6NdPULAh2f1bhaJAvtG2mzVR62378k9BpKT5XXWWlV8fZrf3cxh-flieQTlfjWB1O3ssFzCcjG6yPM_zrNvBGRz2-8P-9bB_heHkbJT9DgAA__-QR5XF

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk0Fu2zAQRfc6xewcA5FgI0gQJPAiTYUigOEGtWN0R4ypUcuWImPOyLV3OYSv0gv0KD5JQaloUIBxN95Sn--Tj6M8hyUFNt7dwL3X34NH_fX9O6At6VVrbEUBhFhg06eybF4uoELBFTLBBAbx6-AWIM-hohpbK7BB29IN9NF-TUlAx6jFeKfWLVojO-VrxRQ2RkeQDkaMRptEBfrSWgw90bDw2sIEfF0n09iK76LGVbRVgbRvGnIVxnZW5HBlqToC8K7bHsiHioL65o1jZU1jBCZwdZHcc92ruZ8-zRflJ5iXi8XD7ANg1RiO5gqyyGK00s9tsTNkq-L1IIMaLVNao4SWkmhe20KHaqWMEwoObSGRp4L_oVhQTKzjAjmKFtN0z5WPf_3kdFE-HvGbRX-yXLzqH_i6TpP-PsBRUlrv4OoiDb1-kxgvy0UsbbAz7K2lbtROofgIvTEumu6dcyy5TBdcjkb_4dc-kEYWPt2RecdCjeqGglW8QL9-goIN6e7fKioSCo1x3ayp2mzb538KIiXN76qzrPz8OL17mMHZx8fFOZSz5RCWd9Oncg5n4-Ftlud5nnU7OIPDfn_Yvxz2L3A2Ph9mvwMAAP__sU-U8A==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tgdLkBO0CGzkwnWYTpsrB5bStSgKgqKohjMlOiSlWR72WHuBPdlAqXCcVk42JPWFAR0dfn_6JNeF90xpLosJzCVdK0no7eUbYFtGk5KLlCkwTBuo2i3HiVAMKTEkIZrBBfTt3f4UwHUhZRkphYGKiJJNoF1tZ9goUmhCDZcFviuJ4KbGMsOaqYpTC0QVN5wS0Qml2JdSENUicm30nYALkFnWuU1KI5tVXqRsixWjMs9ZkRLLrjErSCJY-giALJrjikmVMoV_l7zQWPCcG7iA12edZ87baOaLmyhGK4hQHAfhWyBpzrVNzmOCaMMpppvSqzkTqXcvpJ8RoVl3jEaVrBNa3wmPqjTBvDBMFUR4xuJhJf_A2hDDLZ32iLZBG543j8sd__O37iZyx74-SvR1V3v38fdllnUj7R_Ao0jd8fZfn3WDnh9FtGa1Z0lz0iQshWBN1V4i4kfQc17YpNvMtSV51U3wyvefwM-kYpRoo19Osq61YTluSqGxNdDOX4CgYrR5t7yUGaZyXjRdwxnflpsHBBalG7-hdpybCDUfmKkzX6FZjCCevVkg2JSJ4NTbwsA5IRCE8TmEyxjCm8Vi5JwkXyft1XwZRvFqFoQxbPFmzWq4XgXvZquP8Cv6CAMCs2g-HDknQXiJPsAWJ5inWxgkzdwZwm9B_DMMNL1lOcFC0nUj3SofTqeOM1tY960sq9TbawvCX9A8hiiexUEUB_MI-p8cAIA_m3_765HqC9Z8x3oT8Ef3YypFmRe6N4FP-2G739tffz7cV4wYlmJiehPonfrjc9cfu_4Y_PHE9ye-3ztYtq8oL6jBVJaFPTD2D7lvuTbS1hibemOF9Q4P89QeOBgUpRB7pEMc-53ZM5yejU_Pmnt_jZ6bQfJDMmgU_r8YTp8Tg_O5P32q37Xtd_ldv6tj_a47-l0-7HeNq7bf1TP7XXf2-z-Y2llTm_V3rhTLjvnadfjarJ9pYHfUwHHLs8tLeJB3hTOr7Gq5QsHbsFVWDWGFrtAKhXMUffNNGJDhcfzdt_jZ-iGyYtlR7BoG5XDqOOjD9WIWhDBYXscjQOH7IURoYX3-BFer5TvYTR3XdV1HU1LAzvk3AAD__y9t6vo=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tgdLkBO0CGzkwnWYTpsrB5bStSgKgqKohjMlOiSlWR72WHuBPdlAqXCcVk42JPWFAR0dfn_6JNeF90xpLosJzCVdK0no7eUbYFtGk5KLlCkwTBuo2i3HiVAMKTEkIZrBBfTt3f4UwHUhZRkphYGKiJJNoF1tZ9goUmhCDZcFviuJ4KbGMsOaqYpTC0QVN5wS0Qml2JdSENUicm30nYALkFnWuU1KI5tVXqRsixWjMs9ZkRLLrjErSCJY-giALJrjikmVMoV_l7zQWPCcG7iA12edZ87baOaLmyhGK4hQHAfhWyBpzrVNzmOCaMMpppvSqzkTqXcvpJ8RoVl3jEaVrBNa3wmPqjTBvDBMFUR4xuJhJf_A2hDDLZ32iLZBG543j8sd__O37iZyx74-SvR1V3v38fdllnUj7R_Ao0jd8fZfn3WDnh9FtGa1Z0lz0iQshWBN1V4i4kfQc17YpNvMtSV51U3wyvefwM-kYpRoo19Osq61YTluSqGxNdDOX4CgYrR5t7yUGaZyXjRdwxnflpsHBBalG7-hdpybCDUfmKkzX6FZjCCevVkg2JSJ4NTbwsA5IRCE8TmEyxjCm8Vi5JwkXyft1XwZRvFqFoQxbPFmzWq4XgXvZquP8Cv6CAMCs2g-HDknQXiJPsAWJ5inWxgkzdwZwm9B_DMMNL1lOcFC0nUj3SofTqeOM1tY960sq9TbawvCX9A8hiiexUEUB_MI-p8cAIA_m3_765HqC9Z8x3oT8Ef3YypFmRe6N4FP-2G739tffz7cV4wYlmJiehPonfrjc9cfu_4Y_PHE9ye-3ztYtq8oL6jBVJaFPTD2D7lvuTbS1hibemOF9Q4P89QeOBgUpRB7pEMc-53ZM5yejU_Pmnt_jZ6bQfJDMmgU_r8YTp8Tg_O5P32q37Xtd_ldv6tj_a47-l0-7HeNq7bf1TP7XXf2-z-Y2llTm_V3rhTLjvnadfjarJ9pYHfUwHHLs8tLeJB3hTOr7Gq5QsHbsFVWDWGFrtAKhXMUffNNGJDhcfzdt_jZ-iGyYtlR7BoG5XDqOOjD9WIWhDBYXscjQOH7IURoYX3-BFer5Tuop47ruq6jKSmgdv4NAAD__y9c6vg=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tgdLkBO0CGzkwnWYTpsrB5bStSgKgqaohjMlOiSlSR72WHuBPdlAqXCcVk42JPWFAR0dfn_6JNeF90xpLvMJzCXdKEno7eUbYBWj64KLhCkwTBso2y3HiVAMCTFkTTSDC-jbu_0pgOtCwlJSCAMlEQWbQLvazrBRJNeEGi5zfFcQwU2NZYo1UyWnFogqbjglohNKsS-FIKpF5NroOwEXINO0c5sURjarPE9YhRWjMstYnhDLrjHLyVqw5BEAmTfHFZMqYQr_LnmuseAZN3ABr886z5y30cwXN1GMVhChOA7Ct0CSjGubnMcE0YZTTLeFV3MmEu9eSD8lQrPuGI0qWCe0vhMeVcka89wwlRPhGYuHlfwDa0MMt3TaI9oGbXjWPC53_M_fupvIHfv6KNHXXe3dx9-XadqNtH8AjyJ1x9t_fdYNen4U0ZrVniXNSJOwFII1VXuJiB9Bz3huk24z15bkVTfBK99_Aj-VilGijX45ybrWhmW4KYXG1kA7fwGCktHm3fISZpjKeN50Dae8KrYPCCxKN35D7Tg3EWo-MFNnvkKzGEE8e7NAsC3WglOvgoFzQiAI43MIlzGEN4vFyDlZf520V_NlGMWrWRDGUOHthtVwvQrezVYf4Vf0EQYEZtF8OHJOgvASfYAKrzFPKhism7kzhN-C-GcYaHrLMoKFpJtGulU-nE4dZ7aw7ltZVqm31xaEv6B5DFE8i4MoDuYR9D85AAB_Nv_21yPlF6z5jvUm4I_ux1SKIst1bwKf9sN2v7e__ny4rxgxLMHE9CbQO_XH564_dv0x-OOJ7098v3ewbF9RnlODqSxye2DsH3Lfcm2krTE29dYK6x0e5ok9cDDICyH2SIc49juzZzg9G5-eNff-Gj03g_UPyaBR-P9iOH1ODM7n_vSpfte238V3_S6P9bvu6HfxsN81Ltt-l8_sd93Z7_9gamdNbTffuVIsPeZr1-Fru3mmgd1RA8ctzy4v4UHeJU6tsqvlCgVvw1ZZOYQVukIrFM5R9M03YUCGx_F33-Knm4fIiqVHsWsYFMOp46AP14tZEMJgeR2PAIXvhxChhfX5E1ytlu-gmjqu67qOpiSHyvk3AAD__y9L6vY=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkBO0CGzkwXWYTpsrB5bStSgKgqaohjMlOiTlWR72WfuBfdlAqXCcVE5XJPODAV3de865R4f0PHjPtRGqGMFUsZVWlN1evgG-5WxZCplyDZYbC5umC6EYJ5BSS5fUcLiArnvbHQN4HqQ8o6W0sKGy5CNoWpsasZoWhjIrVEHuSiqFrYjKiOF6I5gDYlpYwahshdL8SympbhCFseZOwgWoLGvtpqVVdasoUr4lmjOV57xIqWM3hBd0KXn6BIAq6nHNlU65Jr8rURgiRS4sXMDrs9aZ88aa6ewmTvACYpwkYfQWaJoL45zzuaTGCkbYuvQrwWXq3wvpZlQa3m6j1SVvhTZ30mc6XRJRWK4LKn3r8IhWfxBjqRWOzvjUOKOtyOvP5Q3_-du0E3nDwBwl-tpr_Hv7uyrL2pH2H-BJpHZ7u6_P2kHPjyK6ZY3vSHNaO6yk5HXUXsLiJ9BzUTinG8-NI3nVTvAqCL6DnynNGTXWvJxkUxnLc1KHwhC3QFN_AYINZ_XZ8lNuuc5FUWeNZGJbrh8QOJR2_JoaoZsY1xfMGE0XeJJgSCZvZhjW5VIK5m-hh04ohFFyDtE8gehmNhugk-XXSvM0nUdxspiEUQJbsl7xCq4X4bvJ4iP8ij9Cj8IknvYH6CSMLvEH2JIlEekWesu6jvrwW5j8DD3DbnlOiVRsVUt3yvvjMUKTmdu-keWU-nttYfQLniYQJ5MkjJNwGkP3EwIA-LP-d78O3XwhRux4ZwTB4L7MlCzzwnRG8GlfbPo7--fPh_2aU8tTQm1nBJ3TYHjuBUMvGEIwHAXBKAg6B83uiIqCWcJUWbiBYXDIfSuMVS7GxFZrJ6xzOCxSN3BQKEop90iHOO6e2TOcng1Pz-p3fw2e68Hyf_GgVvhjNpw-xwb0uTv-Xr53Lt_r1TcB1zw7FvFdS8TXq2dmedea5f-wQOUWKL_RvzmmvmpRXz48oBXZNAd088ylqqNLHbdhcnkJB3KzFVzNFzh8GzVSNc_6sMBXeIGjKY4f0fXK_nHs6jG22zNzZjxg2BzF30KP_gj-Y-3HkXcuQf0xQvjD9WwSRtCbXycDwNH7PsR45iz8Ca4W83dQjZHneR4yjBZQoX8DAAD__8sxBhw=

# Check that we remove histograms from statistics correctly.

statement disable-cf-mutator ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0VOFu2zYQ_h0-xcF_7AyWIDtNl9rID8dRN22qHFhK1qIoCIqiGi4U6ZCUG2_YY-0F9mQDqdbxBjXbgMw_DOjuu--7--6kIIAbpg1XcgZLRe-0IvT28gLYA6Nly0XFNFhmLGw7FEJ5XEBFLCmJYXAOQ5cdzgGCACpWk1ZY2BLRshl00C6GrSbSEGq5kvi-JYLbHVY1NkxvOXVEVHPLKRG9VJp9bAXRHSM31twLOAdV171o0lrloVxW7AFrRlXTMFkRp24wk6QUrHqCQElfrpnSFdP4Z8WlwYI33MI5vDzprTnrrFmm13kRryGPiyLJvgNSNdw450ImiLGcYrppwx1nogofGxnWRBjWb6PVLeulNvcipLoqMZeWaUlEaB0f1uoTNpZY7uRMSIwz2vLGryuY_PG76RcKJpH5qtBnrAkf7R-quu5n2i_gSaZ-e4cvT_pJz77K6IY1oRNtiHdYCcH8qT2HxU-wN1w6pzvPjRM57Rc4jaJ_4K-VZpQYa56vZbMzljXYH4XBboAu_gwCW0b9uxVWzDLdcOlvDdf8od38RcCx9PN7aYSu89h_YOZouY4XRQzF4iKNYdOWgtOwhBE6KuFitUohWxWQXafpGB1p9YlXkGTFmY_eJHniir4g4DJ-vbhOC2glv2_9cng1Oh6jo-Uqy4v1IskKKPHmju3gap28WazfwY_xOxh1vIt86bBJdhm_hRKXmFcPMCp9HB3DT0nxPYwMvWUNwULROz-pG_R4PkdokTqzuincYOF-lCT7IV4WkBeLIsmLZJnD8D0CAPjV_7vfgGw_YsN_YYMZTMaPYapE20gzmMH7fdAnysH--cMhXjNiWYWJHcxgMI2m02AyDaIpTM5mJy9m01fh6bcvXp1MBwc17sXmklpMVStd3fQgecuNVe70sd1tXHeDw1Je_a1fSRoPwv7sMD4Ey1aIvUZ0kHDfrS_xySSKfOa38RMWRf_GIr_U_9Gm6L_ZNH1Omz57hD4M5wjFb6_SRZLBaHVVjCHObo4hj1N3ct_A6_XqDZRzFARBgAwlEkr0ZwAAAP__gAVelw==
