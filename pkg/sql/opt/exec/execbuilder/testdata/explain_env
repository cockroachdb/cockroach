# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99um0oQxq-zT_GJm9hH5hjbNxFWpEMcokNLcAQ0TRRFqwU28bZr1l2WlLiqlIfwE-ZJKsifWpGathfhAmlmvt_HDDtr2zjluhKqdDFT-WetWL44PABveJ7VQhZcw_DK4OZBRYhtQ3OlC67pJyXKikqxFAYLVsEsOAp-xWppcMNkzV3stXpeskxyuhbXa3bdUb-Sq7LVq5URS7HmmtYVpwtRGXWt2bL6G2pZSyNyJWllmPkNKVXOpDC39MmioCumjTBClbygoix4Q6ucvdZ24qcoRGWqLxL7UFdXU8C2XwpZbVT7xRueG6XFmr_iSGax76U-Uu8g9LGqMynyfxv0yA5DEKV7iOYpog9hOCA72WPmIZrNoySNvSBKYa20WDJ9a-EkDo69-Bzv_XP0GLxk1h-QnSA69M_Q0IyKokEve8ofecdBeL6F99gAWZ_0p4R4YerHL9sKonf-LEWSemmQpMEswe4FAYBv3bt9rFzJellWlouL52RXYNZzfDnY0mvODC8oM5YLa-yM9mxnZDsjOCPXcVzHsbbE7c8XZW5oruqyBUaOs1Xutoi2C2FuV7z124bLWspncBvT6utPw_FkNJ50te-DP54te5PZulbebjxyuTslxD87Cb0gQm9-kg7gR6d9JH7YHvM_OIrnx2jw8X8_9pFhH5MpsW3bJt09af57XCmC-83mfnN3v7lDrsrKaCZK42I4Ho5cXAwnsDGcXJIfAQAA__-rPEyo

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99um0oQxq-zT_GJm9hH5hjbNxFWpEMcokNLcAQ0TRRFqwU28bZr1l2WlLiqlIfwE-ZJKsifWpGathfhAmlmvt_HDDtr2zjluhKqdDFT-WetWL44PABveJ7VQhZcw_DK4OZBRYhtQ3OlC67pJyXKikqxFAYLVsEsOAp-xWppcMNkzV3stXpeskxyuhbXa3bdUb-Sq7LVq5URS7HmmtYVpwtRGXWt2bL6G2pZSyNyJWllmPkNKVXOpDC39MmioCumjTBClbygoix4Q6ucvdZ24qcoRGWqLxL7UFdXU8C2XwpZbVT7xRueG6XFmr_iSGax76U-Uu8g9LGqMynyfxv0yA5DEKV7iOYpog9hOCA72WPmIZrNoySNvSBKYa20WDJ9a-EkDo69-Bzv_XP0GLxk1h-QnSA69M_Q0IyKokEve8ofecdBeL6F99gAWZ_0p4R4YerHL9sKonf-LEWSemmQpMEswe4FAYBv3bt9rFzJellWlouL52RXYNZzfDnY0mvODC8oM5YLa-yM9mxnZDsjOCPXcVzHsbbE7c8XZW5oruqyBUaOs1Xutoi2C2FuV7z124bLWspncBvT6utPw_FkNJ50te-DP54te5PZulbebjxyuTslxD87Cb0gQm9-kg7gR6d9JH7YHvM_OIrnx2jw8X8_9pFhH5MpsW3bJt09af57XCmC-83mfnN3v7lDrsrKaCZK42I4Ho5cXAwnsDGcXJIfAQAA__-rPEyo

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN-OozYUxq_HT3HEzZIKGpLcjIhWKpt1WtoMGQHd7mg0sgw4E3cJTm1DIVWlVZ8hl326PEkFmcminT_duRgukHzO9x3OMT_btuEDk4qLwoWZSD9JQdP1-3fAapYmJc8zJkEzpaE6qhCybZBMyIxJ8rvghSI533ANa6pArxlkbEXLXENF85K5cN7qWUGTnJEdv93R2871lFwUrV5sNd_wHZOkVIysudLiVtKNeolrU-aapyInSlP9P85cpDTnuiH3JTKypVJzzUXBMsKLjNVEpfS5tiMcQ8aVVn_k8BbEajUFsO2vhbTUov1ixVItJN-xZyqiWYi9GEPsvVtg2JZJztPvazDRGQU_iM8hWMYQ_LpYWOgsuYscV7NlEMWh5wcxGFvJN1Q2BlyG_oUXXsEv-ApMCl40G1jozA_e449Qk4TwrAYzuY_PvQt_cdWzm9SCZIAGU4S8RYzDr9vyg5_xLIYo9mI_iv1ZBG-uEQDAX927fYxU5OWmUIYL16dgl6DGaX1j9fSSUc0yQrXhgjF2Rue2M7KdETgj13FcxzF64nbzeZFqkoqyaA0jx-mlO4pIC4Rutqyt1zcXZZ6fjH2bFH9-KTiejMaTLve39c2zJa8yW9fK642Hbt5MHwewaQEsHwBYvRDA8h60nnT1iVREshWpYb4Msf9jcNRWAwjxHIc4mOHoRJxJv_DbkOrIb_U0v6UF1ZP8No_y220C_ni58PwAzOVlbAEOPgwgwotW-x3Mw-UF1BY08NtPOMSQwFuYTJFt2zbiRcGk3V12ZiqFUgMEh_2_h_3nw_4zdLdJ8yBS_3B3FNvMP-2vOOz3d4JUFEpLygvtwnA8HLlwPZyADcPJDerJVjzXTCowtSzZAP0XAAD__5BfuGg=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O2zAUxq_xUxzlhnZKphRuUCsuQglStpCixkMghCwnOaXeXLuzHQidJvEQvdzT8SRTwp9VSLDtglxE8fm-35dzEjsI4BSNFVoNYazLb0bzcn54ANhgWdRCVmjAoXVw_eAiJAjAoDYVGvZVC2WZFAvhYM4tuDlChTNeSwfXXNY4hL3Wj4oXEtlKXK34VUe9Zteq9eulEwuxQsNqi2wurNNXhi_s_1CLWjpRasms4-4vpNQll8LdsqeIii25ccIJrbBiQlXYMFvyt9rOYwqVsM5-l7APejYbAQTBSyOvnW7feI2l00as8I1EMp7GEY2BRgdpDMu6kKL82ECPbHFIMroH2YRC9iVNfbJVPFYeVuNJltNplGQUvKURC25uPTiZJsfR9Bw-x-fQ4xDl475PtpLsMD6DhhVMVA30iqf6UXScpOcbeI_7UPRJf0RIlNJ4-rKtJPsUjynkNKJJTpNxDtsXBADgR3dvL6_Usl4o6w3h4rnYCdx7Xl_6G36D3GHFuPOG4O2Eg70gHAThAMLBMAyHYehtmNuPL1TpWKlr1QKDMNyQu13E2g3hbpfY5m3CqpbyGdzEjL75E7izO9jZ7bSf_j_PVrzLbF0r7zceudweERKfnaRRkkFvckJ9iLPTPuRx2v7mD3A0nRxDA1EOWqH_8ORu9IgEQRAQoRSaoDvpvdJoa_sE7te_7td39-s76I5SAxfc7muFl69I7kZ30vpRmgnp0FjoOVNjn_wOAAD__5cjZRw=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkdFu2jwYho_rq3jVk4ZfzV9NSFMF4iBNzZYtBJR4XVFVWSYx4DXEzHYiwlEvgivkSibKkLZq6rRDW8_zfp9f-z7upLFKVz2EOn8yWuTL2xvIjcxntSoLaeCkdWiOFCEZZTBSm0Ia_k2ryvJSrZTDAO-7fcD3Uci5qEuHRpS17OGa-D5kJWal5Fu12IrFi4elsHBL-RrX1YHXa6dWaisNr63kS2WdXhixsv9irerSqVyX3Drh_mKWOhelci0_RRR8LYxTTulKFlxVhdxwm4u31j40Uyjr7PcSA-j5_I91iNrpw8RG5k4btZVvJJIwpQGjYMFNTLGuZ6XK_2_hkbMaUcKukYwZki9xfEnOmp83x1M4TjKWBlHCcL42aiVMe45JGo2CdIrPdAqvRpCFnd_R-RNvuJFzvsFwnNLoQ3Jkmw5SOqQpTUKanfbYeOKgR8ktvUfLG66KDbzmFDsMRlE8_WW6V1-i6ZBOn5AgZjR9_aoo-URDhowFLMpYFGa4eHi86BNC7ydxECXwxhN2CZrcdZDR-MD-h2E6HqHF1480pagxQLdPfN_3yctftQT73W6_e97vnpHryjojVOV6uHrXw8NVFz6uuo_kRwAAAP__s2n3Ww==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkdFu2jwYho_rq3jVk4ZfzV9NSFMF4iBNzZYtBJR4XVFVWSYx4DXEzHYiwlEvgivkSibKkLZq6rRDW8_zfp9f-z7upLFKVz2EOn8yWuTL2xvIjcxntSoLaeCkdWiOFCEZZTBSm0Ia_k2ryvJSrZTDAO-7fcD3Uci5qEuHRpS17OGa-D5kJWal5Fu12IrFi4elsHBL-RrX1YHXa6dWaisNr63kS2WdXhixsv9irerSqVyX3Drh_mKWOhelci0_RRR8LYxTTulKFlxVhdxwm4u31j40Uyjr7PcSA-j5_I91iNrpw8RG5k4btZVvJJIwpQGjYMFNTLGuZ6XK_2_hkbMaUcKukYwZki9xfEnOmp83x1M4TjKWBlHCcL42aiVMe45JGo2CdIrPdAqvRpCFnd_R-RNvuJFzvsFwnNLoQ3Jkmw5SOqQpTUKanfbYeOKgR8ktvUfLG66KDbzmFDsMRlE8_WW6V1-i6ZBOn5AgZjR9_aoo-URDhowFLMpYFGa4eHi86BNC7ydxECXwxhN2CZrcdZDR-MD-h2E6HqHF1480pagxQLdPfN_3yctftQT73W6_e97vnpHryjojVOV6uHrXw8NVFz6uuo_kRwAAAP__s2n3Ww==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMkdFu2jAARZ_rr7jqS8PUrJqQpgrUhzQ1W7Y0oMTriqrKMokBryFmthMRnvoRfCFfMgFD2qaJ7dHWPef6yr6PB2ms0lUPoc5fjBb5_O4WciXzSa3KQho4aR2aQ4qQjDIYqU0hDf-mVWV5qRbK4Qbvu33A91HIqahLh0aUtezheo_ISkxKyddqthazPYgb6On0r4iuiO9DL51aqLU0vLaSz5V1embEwmIuLNxc_g-1qEuncl1y64T7B1nqXJTKtfyoKPhSGKec0pUsuKoKueI2F9UJzW5qoayz38sT-0Tt9K6xkbnTRq3lCSMJUxowChbcxhTLelKq_G0Lj5zViBJ2jWTIkHyJ40ty1vy8OZzCYZKxNIgShvOlUQth2nOM0ug-SMf4TMfwagRZ2Pk9On3hDTdyylcYDFMafUgO2aaDlA5oSpOQZsd3rDyxw6Pkjj6i5Q1XxQpec9QOgvsoHv_S7tWXaDqk0yckiBlN_1wVJZ9oyJCxgEUZi8IMF0_PF31C6OMoDqIE3nDELkGThw4yGu-ybzBIh_do8fUjTSlq3KDbJ77v-2T_Vy3BdrPZbl63m1fkurLOCFW5Hq7e9fB01YWPq-4z-REAAP__YQL3vQ==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8kdFu2jAARZ_rr7jqS8PUrJqQpgrUhzQ1W7Y0oMTriqrKMokBryFmthMRnvoRfCFfMgFD2qqKR1v3nHst-z4epLFKVz2EOn8xWuTzu1vIlcwntSoLaeCkdWgOKUIyymCkNoU0_JdWleWlWiiHG3zu9gHfRyGnoi4dGlHWsofrPSIrMSklX6vZWsz2IG6gp9N3EV3tGb10aqHW0vDaSj5X1umZEQt7mvT9N-CiLp3KdcmtE85iLizcXL5PljoXpXItPyoKvhTGKad0JQuuqkKuuM1FdUKzm14o6-zv8sRSUTu9a2xk7rRRa3nCSMKUBoyCBbcxxbKelCr_2MIjZzWihF0jGTIkP-L4kpw1f28Op3CYZCwNooThfGnUQpj2HKM0ug_SMb7TMbwaQRZ2_o9OX3jDjZzyFQbDlEZfkkO26SClA5rSJKTZccfKEzs8Su7oI1recFWs4DVH7SC4j-LxP-1efYmmQzp9QoKY0fTtq6LkGw0ZMhawKGNRmOHi6fmiTwh9HMVBlMAbjtglaPLQQUbjXfYDBunwHi1-fqUpRY0bdPvE932f7P-qJdhuNtvN63bzilxX1hmhKtfD1acenq668HHVfSZ_AgAA__9Lufgf

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkdFu2jwAha_rpzjqTcOv5q8mpKkC9SJNzZYtBJR4XVFVWSYx4DXEzHYiwlUfgifkSSZgSNu0ddqlre8751j2fdxLY5Wuegh1_my0yBd3t5BrmU9rVRbSwEnr0BwpQjLKYKQ2hTT8i1aV5aVaKocbvO32Ad9HIWeiLh0aUdayh-uDIisxLSXfqPlGzA8ibqBns98qujo4euXUUm2k4bWVfKGs03MjlvZfzWVdOpXrklsn3F9s30epc1Eq1_JTSsFXwjjllK5kwVVVyDW3uaiwEBZuIf8wolDW2a_lK32idnrf2MjcaaM28pVEEqY0YBQsuI0pVvW0VPn_LTxyViNK2DWSEUPyKY4vyVnz_eZ4CkdJxtIgShjOV0YthWnPMU6jYZBO8JFO4NUIsrDzMzp75g03csbXGIxSGr1LjmzTQUoHNKVJSLPTjrUn9nqU3NEHtLzhqljDa06xg2AYxZMf2r36Ek2HdPqEBDGj6a-vipIPNGTIWMCijEVhhovHp4s-IfRhHAdRAm80ZpegyX0HGY337H8YpKMhWnx-T1OKGjfo9onv-z45_FVLsNtud9uX3fYFua6sM0JVroerNz08XnXh46r7RL4FAAD__3jS-IE=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUkEFvGjEQhe_-Fe_YVnUVoAk0KIft1pWQYJPCBuVmGe8A05o12LMo5ddXNOqlqqhyG2m-783oaY0lpcyxvUUZ_Y8Und9--Qx6Jr_qODSUIJQFxxdKqYWpkSimhpL9HrnNNvCOBXe4GYwBrdHQ2nVBcHSho1uMlNag1q0C2RNvTm7z28PWZciW_sZje-bjXnjHJ0q2y2S3nCVuktvl11i7Lgj7GGwWJ_8xQ_QusPy0fyIau3dJWDi21FhuG3q22btLb5-baThLPgTcIa7X_6zDdRLPF4_kJSY-0YVEVc5NURsszLdHU5UG-24V2H_IdMBsUi2L6aNBD7Pi6WX81O8PBsP-1eBmdP1xOLweXQ0xqcq5mZmqRg-LupjX6I2VMk8P02JS4c39Q_0eplq-xcJMTVnjHb7O72fIdBgrrbVWmQ4dtZ50pkBezhv1KwAA__8rjrxH

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFuo0YUhq8zT3HEzeIK1tiWqggrUlnvuKV1cAQ0u1EUjQYYx9PFjDszUOOq0qrP4Ms-nZ-kAscO3c1uNxfhAmnO-f_DmcM3Y9twzaTionBhItIPUtB0-fYNsA1Lk5LnGZOgmdJQHVQIRTgGyYTMmCS_CV4okvMV13AB34_GALYNGVvQMtdQ0bxkLpwj2wZW0CRnZMvvt_S-9cGSKtBL9qlcFI1erDVf8S2TpFSMLLnS4l7SlXqOa1XmmqciJ0pT_T_OXKQ057omxxIZWVOpueaiYBnhRcY2RKX0a203k8m40ur3HC5ALBZPjoOWWjRfrFiqheRb9pWKaBJiL8YQe29mGNZlkvP09QZMdEbBD-JzCOYxBL_OZhY6Sx4ih9VkHkRx6PlBDMZa8hWVtQFXoX_phTfwC74Bk4IXTXoWOvODt_g9bEhCeLYBMznGp96lP7vp2E1qQdJDvTFC3izG4adt-cHPeBJDFHuxH8X-JIJXtwgA4M_23TxGKvJyVSjDhdtTsE1Q47S-szp6yahmGaHacMEYOoNz2xnYzgCcges4ruMYHXEzfF6kmqSiLBrDwHE66ZYi0gCh6zVr6nXNRZnnJ2PXJsUfjwWHo8Fw1Ob-sr55b8mL7K1t5eW2h-5ejZ8GsG4ALD8DsHomgOURtI508YFURLIF2cB0HmL_x-CgrXoQ4ikOcTDB0Yk4kz7yW5PqwG_1ZX5LC6ov8ls_yW93CNc-fndUV4fTYEFbE7wIIjxr3I9RmIbzy_byfH1s2PrPsoZ3P-EQQwIXMBojhN9fzTw_AHN-FVuAg-veseh3h1rVGNm2bSNeFEza7SVqplIo1UOw3_2z333c7z5Ce0vVn0U2Pzwc8Sbzd_OL97vdgyAVhdKS8kK70B_2By7c9kdgQ390hzqyBc81kwpMLUvWQ_8GAAD__ySM0gI=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkFFr2zAURp-jX_HRlyYj2stglIY-qJ4K3hwn2FpZGEOotpJok61Mug5tfv1wx6CMkdH3c-53OZzj3sbkQn-NLDQ_YjDN_sMt7KNtHgbnWxtBNhGOvynGaqkQbYitjfp7cH3S3nWOcIP37xYA52jt1gyecDR-sNe4YpzD9ubBW31yu5PZPXvYmwTa27_x0I98OJDr3MlGPSSr9y5R2EXTpddY3eDJNcHrRIb-Y_rQGO_oSf850eqDieTIhd622vWtfdSpMefeHsu0LlH66XGDsN3-M4cZKIyLR9tQiO5kz1xkWSWFklDitpBIbwlTNjHIS3WFcqVQfi6KOZtkq7JWlchLhYtDdJ2JTxdYV_lSVBt8khtMDUSdzeZscieWebF5gU3NjM0WjIlCyerFUF5-lJlCrYTKa5VnNS6_frtcMCa_rAuRl5iu1moOWd7PUMtiZN_grlotR3vBOOecPfci9isAAP__uHXF5g==
