# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4kIvtgdLlmwUKGQEmKoynTZXDiSlaxEEBEVRK1FZTEXKkzcM6Ef4V_YD-5R8yUA5sz3MWZBl1YMAXp17zr1Hh7YN73ijhKx9CCX71EjKPr5-BbzjLG9FVfAGNFca1jsUQrYNKc6goJrmVHE4h4EBDOaoLwul1ecKzkGW5RzAtqHgJW0rDWtatdwH2mrZQ0Vd8I40nMnVitcF1ULWivCa5hUv_oXADGH6w8VVmuHETJNF8RtQnyuHNUVORK15U9PK0YaKNPJnojTVQmnBlEMVkSXRYtWPbnt__K4GJ3Vsz1UPCt1jlXNYeCDL8jTTfuVTTGY05RjIimrBCJNVxZkxwzl4MShppfhpdt20_L-wr0RtfNk5pIzIi9MCL1z3Ef5SNpxRpdX_N7LaKM1XpP-FipgFdvUnCKCrFPfhnaMwwUGGIQteLTDctnklmNPBEJ1RiOLsJcTLDOKrxWKMzvL7yu4ULuM0S4IozqAjt5_4Bi6T6G2QfIAf8AcYUgjScDRGZ1H8Gr-HjuREFB0M876ORnOEgoVZcKdshnH28lH8PQ4zSLMgi9IsClMYXCMAgF_7t3ksuv6JKPELt3xwx4cyk1W7qpXlw_W-uMNb-_PNMb7hVPOCUG35YE1d76Xterbrgev5ruu7rnUENpEWNdOEybY2DZ57rP1RKC1NkIje3JrBrONmUZiGo0LdVtWe6ZjH3Mu9wnTmTWf9t9_Gz_Ug_yoe9BM-zYbpc2xAN4P5YxHemAi3_4jw-qEIb05EuP0rwn_DrUlpkBfLBEdv4h1yPYIEX-AExyFO97doSA_5N319_teP539zMv_90vj95SKIYhguL7Mx4PjdCFK8MNhv4CJZvoUOfvwOJxhyOIfZHNm2bSPFaA3dt_dXEMHddnu3_XK3_QJM1ko3VNTah8l04vlwPZmBDZPZDfozAAD__0G8_88=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfTkWwUKGQEmOsynTZXDiSlaxEEBEVRK1eZTEXKkzYMKPYNftxv7Af2KfmSgXLmeKi7oMvqBwO8PPece48PjTG8EpWRWgWw0PxdpRl_-_wZiEbwrJZlLiqwwljY7FAIYQwJSSFnlmXMCDiDvgP0Z6grS2PN-xLOQBfFDABjyEXB6tLChpW1CIDVVndQqXLR0EpwvV4LlTMrtTJUKJaVIv8XAjeE618sL5OUxG6aNIxegHlfjnmVZ1QqKyrFyrF1VLTSP1FjmZXGSm7GzFBdUCvX3ejY__MP0z-qg33PfFLoDmvG9wv3dVEcZ9qvfIzJjWbGDrJmVnLKdVkK7swY33vRL1hpxHF2W9Xiv7CvpXK-7BwyTuTJcYEnnvcAf6ErwZmx5v8b2bTGijXtfkJD3QK7-mcIoMuEdOGdoUVM5imBdP5sSeCmzkrJxw0M0AmDMEqfQrRKIbpcLkfoJLur7E6LVZSk8TyMUmjozTvRwkUcvpzHb-A78gYGDObJYjhCJ2H0nLyGhmZU5g0Msq6OhjOE5ku34E7ZDTPey4fRt2SRQpLO0zBJw0UC_SsEAPBL9-0-Pbb5gRr5s-gF4I3uy1yX9VqZXgBX--IO39ufrw_xlWBW5JTZXgC9iec_xZ6PPR88P_C8wPN6B2AXaam4pVzXyjX43qH2W2msdkGitr1xg_UOm2XuGg4Kqi7LPdMhj3uXe4XJ1J9Mu7tfR4_1IPsiHnQTfp4Nk8fYgK77s4ci3LoI1x9FePOpCLdHIlz_HeF_4Da0cMjzVUzCF9EOuRlCTM5JTKIFSfavaMDu8-_6uvxvHs5_ezT_3dLk9cVyHkYwWF2kIyDRqyEkZOmwX8F5vHoJzQha-P4bEhPI4AymM4QxxkgqJSr8o5YKBrzSxgwR3G5_v91-uN1-AMOZgvajSvP13at1N78562-32zsA18rYikllAzidnPoBXJ1OAcPp9BodwApZWlEZGLi_nSH6KwAA___1qSPn

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4kIvtgdLkFwUKGzkQVWZQpsrB5JStAgCgqKolatMpiLlyBsG9CP8uN_YD-xT8iUDpcz2MGdB19UPhnV57jn3Hh_KdeEtb7RQcg6RYh8bRdmHVy-Bd5wVrahL3oDh2sBmQCHkupDhHEpqaEE1h3MYWcBogfqy0EZ_quEcVFUtAFwXSl7RtjawoXXL50Bbo3qokCXvSMOZWq-5LKkRSmrCJS1qXv4LgR3C9kfLqyzHqZ0mj5PXoD_VHmvKgghpeCNp7RlLRRp1R7ShRmgjmPaoJqoiRqz70d3gj9_16KSOG_j6UaEHrPYOC49UVZ1m2q98ismOpj0LWVMjGGGqrjmzZngHL0YVrTU_zW6alv8X9rWQ1pfBIW1Fnp8WeO77T_BXquGMaqP_v5H1Vhu-Jv1fqIldYKh_gQC6ynAf3gWKUhzmGPLw5RLDbVvUgnkdjNEZhTjJX0CyyiG5Wi6n6Kx4qAxP0SrJ8jSMkxw6cvuRb-Eyjd-E6Xv4Ab-HMYUwiyZTdBYnr_A76EhBRNnBuOjraLJAKFzaBQdlO4y3l4-T73GUQ5aHeZzlcZTB6BoBAPzSf9uPQzc_Ei1-5s4c_OmhzFTdrqV25nC9Lw54Z_98c4xvODW8JNQ4c3BmfvDC9QPXD8AP5r4_933nCGwjLSQzhKlW2obAP9b-ILRRNkjEbG_tYM5xsyhtw1FBtnW9ZzrmsfdyrzB7Fsye9We_Tr_Wg-KbeNBP-GU2zL7GBnQzWjwV4a2NcPuPCG8ei_D2RITbvyL8N9yGVBZ5sUpx_DoZkJsJpPgCpziJcLa_RWN6yL_t6_O_eTr_25P575fG7y6XYZzAeHWZTwEnbyeQ4aXFfgcX6eoNdBBmoCSfDr_MnVog13VdJKTkjfuTEhLGrFFaTxDc7367332-330GzaiEDq6pPleS3zxyZO5Uf7R7OKpEbXijYWxfKhP0ZwAAAP__LU4YUg==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgZLkWJ0CGTkQVWZTpsrB5LStQgCgqKolatEpiLlWRsG9CPyK_uBfUq-ZKDcOR6mLuiy6UEAr849596jQ8eB17zVQskAIsXet4qydy-eA99yVnSiLnkLhmsDmx0KIceBDOdQUkMLqjmcw9QCpks0lIU2-kMN56CqagngOFDyina1gQ2tOx4A7YwaoEKWfEtazlTTcFlSI5TUhEta1Lz8BwIlh_aWq7bkLflRCalJLRph4By-Xoz2nKGhJ1pdZTlO7QJ5nLwE_aF2WVsWREjDW0lr11h10qqfiDbUCG0E0y7VRFXEiGbY1vF__01PR2Uc39OfFfqE1e6DR1NVVeNMe5fGmOxo2rWQhhrBCFN1zZn1z32wb1rRWvNxdtN2_N-wN0JaX3YOaSvybFzgmec9wl-pljOqjf7vRta9Nrwhwy_UxC6wq3-BALrK8JD3JYpSHOYY8vD5CsNtV9SCuVuYoSMKcZKfQbLOIblareboqPhU2Z2idZLlaRgnOWzJ7Xvew2UavwrTt_AdfgszCmEWHc_RUZy8wG9gSwoiyi3MiqGOjpcIhSu74E7ZDuPu5ePkWxzlkOVhHmd5HGUwvUYAAL8Mb_tM6OYHosXPfBKAN38oM1V3jdSTAK73xR1-sj_fHOJbTg0vCTWTACannn_meL7j-eD5gecFnjc5ANtIC8kMYaqTtsH3DrXfCW2UDRIx_a0dbHLYLErbcFCQXV3vmQ557L3cK5wu_NPF8O3X-VM9KP4XD4YJv8yG06fYgG6my8ci3NsId3-L8OZzEe5HItz9GeG_4DakssiLdYrjl8kOuTmGFF_gFCcRzva3aEYf8m_7hvxvHs9_P5r_YWn85nIVxgnM1pf5HHDy-hgyvLLYr-AiXb-CHr7_BqcYOjiHxRI5juMgzaiEHsH93d393cf7u4_AlNSmpUKaAE78AK5PFuDAyeIG_REAAP___dsNDQ==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkWK0CGTkQVWZTpsrB5LStQgCgqKolatEpiLlWRsG9CPyK_uBfUq-ZKDc2R6mNOiy-cGArs49596jcx0H3vBGCyV9CBX70CjK3r98AXzDWd6KquANGK4NrLcohBwHUpxBQQ3NqeZwDmMLGC9QXxba6I8VnIMqywWA40DBS9pWBta0arkPtDWqhwpZ8A1pOFN1zWVBjVBSEy5pXvHiCwRK9u0NV03BG_KTElKTStTCwDk8nw_2nKG-J1xepRlO7AJZFL8C_bGasabIiZCGN5JWM2PVSaN-JtpQI7QRTM-oJqokRtT9to73x-96PCjjeK5-UOgzVs_2Ho1VWQ4z7Vz6ItOwB-Pn82HSswcZ7bJ6ZkVragQjTFUVZ_aLzPYfZFzSSvNhatO0_N-w10Jap7eeayvybFjgmes-wl-qhjOqjf7vRtadNrwmfSg0sQts618hgK5S3F_QAoUJDjIMWfBiieG2zSvBZhuYoCMKUZydQbzKIL5aLqfoKP9c2T6FqzjNkiCKM9iQ2w-8g8skeh0k7-B7_A4mFII0PJ6ioyh-id_ChuREFBuY5H0dHS8QCpZ2wa2yHWa2k4_i73CYQZoFWZRmUZjC-BoBAPza_9vfiK5_JFr8wkc-uNN9mamqraUe-XC9K27xo93zzSG-4dTwglAz8mF06npnjus5rgeu57uu77qjA7A9EiGZIUy10jZ47qH2e6GNskEipru1g40Om0VhGw4Ksq2qHdMhj730ncLp3Dud9-9-mz7Vg_x_8aCf8OtsOH2KDehmvHgswp2NcPuPCK8finA3EOH2rwj_DbcmpUVerBIcvYq3yPUxJPgCJzgOcbq7ognd59_29flfP57_bjD__dL47eUyiGKYrC6zKeD4zTGkeGmx38BFsnoNHfzwLU4wtHAO8wVyHMdBmlEJHYL7u7v7u0_3d5-AKalNQ4U0Ppx4PlyfzMGBk_kN-jMAAP__5Rcndw==

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvg6f4sA3dgbLkWK0CGTkwnWZTpsrB5LStQgCgqKolKtMpiLlWRkG9CHyKnuBPUqeZCDVOR6mNOi6-cKAjr4fnk8fPQ_e8FoLJUNYKPahVpS9f_kC-JazvBFVwWswXBvYdCiEPA9SnEFBDc2p5nAKQwsYzpAbC230xwpOQZXlDMDzoOAlbSoDG1o1PATaGOWgXNK84uRWXN_Sa_KzEtKyZC9JlaXjCFnwLak5U-s1lwU1QklNOqXiC6ZKOnrNVV3w2plpUom1MHAKz6e9nBPkOIvlRZrhxC6dRfEr0B-rCauLnAhpeC1pNTFuj1r9QrShRmgjmJ5QTVRJjFi7hLzgj9_1sNfGC3z9qNFnrJ485DpUZdmvtEv2i0r9GQyfT_tFTx5VtMvqiTVdUyMYYaqqOLNfZPLwQYYlrTTvlzZ1w_-N-lpIm3SXubYmz_oNnvn-E_qlqjmj2uj_7si61YaviSuFJnaBbv4VBugixe7WzdAiwfMMQzZ_scRw0-SVYJMtjNABhSjOTiBeZRBfLJdjdJB_nnRPi1WcZsk8ijPYkpsPvIXzJHo9T97Bj_gdjCjM08XhGB1E8Uv8FrYkJ6LYwih3c3Q4Q2i-tAt2zvYwk519FP-AFxmk2TyL0ixapDC8RAAAv7p_-xvQzTXR4pYPQvDHD2OmqmYt9SCEy92www92z1f7-JpTwwtCzSCEwbEfnHh-4PkB-EHo-6HvD_bA9pIIyQxhqpGWEPj73u-FNsoWiZj2xh5ssE8WhSXsDWRTVTulfR1703cOx9PgeOre_Tb-1gzy_yUDd8Kvi-H4W2JAV8PZUxVubYWbf1R481iF254KN39V-G-4DSkt8myV4OhV3CE3h5DgM5zgeIHT3S0a0Yf-W57r_-bp_re9_XdL47fny3kUw2h1no0Bx28OIcVLi_0OzpLVa2jhp-9xgqGBU5jOkOd5HtKMSmgR3N_d3d99ur_7BExJbWoqpAnhKAjh8mgKHhxNr9CfAQAA__9qgDj0

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VF9u2zYcfg5P8YNf5AyWI8VoEcjIg-synTZXDiSlaxEEBCVRKVeJTEnKszMM6CFylV1gR8lJBtKd42FKg66bHwzw5-8P-fGjfR_eMKW5FBHMZflBSVq-f_kC2JqVRcebiikwTBtYbVEI-T5kOIeKGlpQzeAUPAvwpsiNuTb6YwOnIOt6CuD7ULGado2BFW06FgHtjHRQJmjRMHLLr2_pNflZcmFZopck69pxuKjYmihWyrZloqKGS6HJVqn6gqkUji5vDG_5LVOk04y859rIa0Vb_TRTMakqptw2NWl4yw2cwvNJL-cEOc58cZHlOLVx5XHyCvTHZlyqqiBcGKYEbcbGJaDkL0Qbarg2vNRjqomsieGty9YP__hde702fhjoR40-Y_X44UY8Wdf9Srs7-aJSfwbe80m_6MmjivawemxNW2p4SUrZNKy0dzl-uEqvpo1m_dJGdezfqLdc2KS3mdtb9571GzwLgif0a6lYSbXR_92W9UYb1hJXCk3sAbbzrzBAFxl273WK5ime5Rjy2YsFhpuuaHg5XsMQHVCIk_wEkmUOycViMUIHxefJdjVfJlmezuIkhzW5-cA2cJ7Gr2fpO_gRv4MhhVk2Pxyhgzh5id_CmhSEV2sYFm6ODqcIzRb2gFtnu5nxzj5OfsDzHLJ8lsdZHs8z8C4RAMCv7tt-BnR1TTS_ZYMIgtHDuJRN1wo9iOByN9ziB7v11T5eMWpYRagZRDA4DsITPwj9IIQgjIIgCoLBHtg-Ei5KQ0rZCUsIg31v909hi0TM5sZubLBP5pUl7A1E1zQ7pX0d-9J3DseT8Hjifvtt9K0ZFP9LBm6HXxfD8bfEgK686VMV3tgKd_-o8OqxCm96Ktz9VeG_4VaktsizZYrjV8kWuTqEFJ_hFCdznO1e0ZA-9N_yXP9XT_d_09t_d2j89nwxixMYLs_zEeDkzSFkeGGx38FZunwNG_jpe5xi6OAUJlPk-76PdEkFbBDc393d3326v_sEpRTaKMqFieAojODyaAI-HE2u0J8BAAD__xPsTT8=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VF9u2zYcfg5P8YNflAyWI8VoEcjIg-synTZXDiSlaxEEBCVRKVeKTEXKszMM6CFylV1gR8lJBtKd42FKs6yrHwzw5-8P-fGjfR_esFZzJSOYqfJDq2j5_uULYCtWFh0XFWvBMG1guUEh5PuQ4RwqamhBNYMT8CzAmyA35trojwJOQNX1BMD3oWI17YSBJRUdi4B2Rjkok7QQjNzwqxt6RX5WXFqW7CWpunYcLiu2Ii0rVdMwWVHDldRko1R9wVRJR1fXhjf8hrWk04y859qoq5Y2-qnMphOGl0oQbaj5F-yWqbZirTukJoI33MAJPB_3co6R48zm51mOUxt2HievQH8Uo7KtCsKlYa2kYmRcfq36xW2Da8NLPaKaqJoY3rib8cM_ftder40fBvpBo89YPbq_T0_Vdb_S9ka_qNSfgfd83C96_KCiy3xkTRtqeElKJQQrbRNG90Xwaio065c2bcf-i3rDpU16k7m9de9Zv8GzIHhEv1YtK6k2-v_bsl5rwxriSqGJPcBm_gQDdJ5h99onaJbiaY4hn76YY7juCsHL0Qr20R6FOMmPIVnkkJzP50O0V3yebFazRZLl6TROcliR6w9sDWdp_HqavoMf8TvYpzDNZgdDtBcnL_FbWJGC8GoF-4Wbo4MJQtO5PeDG2W5mtLWPkx_wLIcsn-ZxlsezDLwLBADwq_u2nwFdXhHNb9gggmB4Py6V6BqpBxFcbIcb_GC7vtzFt4waVhFqBhEMjoLw2A9CPwghCKMgiIJgsAO2j4TL0pBSddISwmDX2_3P2CIRs762GxvsknllCTsD2QmxVdrVsS9963A0Do_G7rffhl-bQfFNMnA7fFoMR18TA7r0Jo9VeG0r3P2jwsuHKrzuqXD3V4X_hluS2iJPFymOXyUb5PIAUnyKU5zMcLZ9Rfv0vv-W5_q_fLz_697-u0Pjt2fzaZzA_uIsHwJO3hxAhucW-x2cpovXsIafvscphg5OYDxBvu_7SJdUwhrB3e3t3e2nu9tPUCqpTUu5NBEchhFcHI7Bh8PxJfozAAD__9ygY0A=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk9Fu0zAUhu_zFOcugHDUrnQtq3pRgkGV2mw0abU7y3VOhMGxqY8zxoPxAjwZcorYTTYE4i5y_vP9-f8TMwYH9KSdvYLcqc_eSfXx7RvAe1THTpsaPQSkAHdnVZIwBiWvoJZBHiUhLCGNgnSR9MeaAp0MLME1zQKAMaixkZ0JcCdNh1cgu-B6qbY13guPyrUt2loG7SwJtPJosH4C4Gw_7tH5Gr345LQlYXSrAyzhcjI4M0_6mXyzLyu-iwGqdfEe6GQy5euj0Dagt9JkIboL774KCjJoClpRJkm4RgTd9mnZ-Md3Sgdt2HhEjxr90lL20FHqmmaY9LulJ0nDHaSXk2Ho_FFiDEtZNG1l0EooZwyquJHsYSFpIw3hMDr4Dv-F3mobmz53TtFkOmwwHY3-wG-cRyUp0P_7ZPpGAVvR_xQkYoDz-V8YJPuS9zdokeQ7vqo4lPzDnhc5hy_d0WiVEZ5guy4Oq82ewxi2q9vz4-uLi8lkdjGaXM6nr2az6Xw0g3WR7_iWFxWMoaxWuwrGiyThtzeb1bqAZ9c31UvgxeE5lHzD8wpewLvd9RYIT4uEMcYSwlOHViEjjCuIb5KfAQAA___9p0wT

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfJkWy0CGQEmOoynTZXDiQlbREEBCVRK1eZTEVKszcMKPYNftxv7Af2KfmSgXJiu6vSoOvmBwO6PPecey_PpW3DJasUl8KDmczeVZJmb58_A7ZiWVrzMmcVaKY0NFsUQrYNMU4gp5qmVDE4hb4B9KeoDXOl1fsSTkEWxRTAtiFnBa1LDQ0ta-YBrbVsoVzkbEUqlsnlkomcai6FIkzQtGT5ZwikaNMrJqucVeQnyYUiJV9yDafwdNKZc4LanNn8Ik5wZBpIgvAFqPflKKvylHChWSVoOdJGnVTyZ6I01VxpnqkRVUQWRPNl263t_vWn6nfK2K6jHhS6w6rRfkZ9WRTdTLspfZapewb9p5Nu0pMHGU2zamREl1TzjGSyLFlmbmS0v5B-QUvFuql1VbN_w77kwkx6O3NlRJ50CzxxnEf4C1mxjCqt_ruS1VpptiStKRQxDWzjXyCALmLcbtAUzSLsJxgS_9kcw02dljwbrWCAjigEYXIC4SKB8GI-t9BRehfZfs0WYZxEfhAmsCI379gazqPgpR-9gR_wGxhQ8OPZ0EJHQfgcv4YVSQnPVzBI2zgaThHy56bBrbIpZrSTD8Lv8SyBOPGTIE6CWQz9KwQA8Gv7b3492vxIFP-F9TxwrH04k2W9FKrnwdUuuMX3dt_Xh_iKUc1yQnXPg97YcU9sx7UdFxzXcxzPcXoHYLMkXGSaZLIWJsF1DrXfcqWlMRLR6xtTWO8wmecm4SAg6rLcMR3ymE3fKYwn7njSnv1mfe0M0v9lBm2FXzaG8deMAV33p49ZeG0sXH9i4eYhC687LFzfW_gjXEMKgzxbRDh4EW6RzRAifIYjHM5wvNuiAd373-S1_m8e9_-60__dTV8G-NW9YNOurVlUCx3Vpls0BD-GGM8NG7UgtaC2oIGzaPHy45Wz_lHBq-9whCGFU5hMEcKvz-d-EMJgcZ5YgMPL4T3pN1uuZops27YRF4JVtnn5YZBVUqkhgtvNH7ebD7ebD6AyKmD9SWT17d3rYE5-N1d8u9ncATIplK4oF9qD4_Gx68HV8QRsOJ5cowNYwUvNKgUD87wN0d8BAAD__zpBa_s=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk9Fu0zAUhq_npzh3adEcdZo2VYt6kYWAAllaJe7EhJDlJifCLImZjzu2B-MFeDLkFLGbbAjErfWf7z__fxLO4RotaTNcQGLqW2tU_fn1JeAD1ru97hq04JAc3B9UjHEOVSqgUU7tFCGsIPCCIGLjsyZHdx2swLRtBMA5NNiqfefgXnV7vAC1d2aU6qHBB2mxNn2PQ6OcNgNJHNSuw-YFgBnGcYvGNmjlF6MHkp3utYMVnJ9OzizZOJPk20qkpQ8gsuIt0F0X1rbZST04tIPqQufdpTXfJDnlNDldU6hImlY63Y9p-cmP7xRM2vCTBT1r9EtL4VNHgWnbadLvll4kTXcQnJ9OQ5fPEn1YCr1pr5yuZW26Dmt_kfDpIEGrOsJptLN7_Bd6rwff9KFz8iZn0wZni8Uf-K2xWCty9P9Wpkdy2MvxoyDpAxze_8KAbat0_IMilpRpLFIQ8WWeAoUOZuxIQVaIJRRrAcU2z4_ZUbIuKlHGWSHAya-3-AibMruKyxt4n97ATEFcJXM2jxiLc7_1AecdQs_MindpIqASscgqkSUVBB8_BRFj6YdNHmcFzNYbcQxpcT2HKs299hW8KddXfqOIcc45o1oN4NjPAAAA__8OLFCp

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zwQhfc6xexkA6FgI0gQxPAif36hCGC4Qe0Y3REjapSyoUiYM3KTXQ7hq_QCPYpPUlBum42SokW3xHvfEz9RKdhQZBv8JVwH8xADmk___wf0SKbqrKspghAL7I6pLFMKVuUaahSskAnmkKdAPsv6Y2qwc6Ilomc0YoPX2w6dlScdGs0Ud9akUoXm4T6GztczAKV-FmGHrqNLiHTfOYxHpmXhrYM5hKYZTGMnoY9aX9OjjmRC25KvMe2zJo-Vo_oNQPB9PVKINUX9OVjP2tnWCszh_HSwc5H1nevF3WpdfkhS1jfLd8BbV5hYV9p6oejRFZLWdQxfNAuKZbGGC-TkQ2zbG1TTb185H5xR0wm_OvQjy8WLozw0zTDpl6U3ScMO8vPTYejFq8R0WS7SaItijTbBOepfRPHyQ_IGHdMwWmJHf0NvrU-mj845jZwND5xNJr_hNyGSQRb-d5_MTyzU6v5RsE4XOJ7_wUBWfrxdXN0sYfT-dn0C5XIzhs3V4q5cwWg6nmVKKZX1Bc7gsN8f9s-H_TOMpifj7HsAAAD__yAgUKM=

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFqGzEUhvc6xduNDdFgExJCjBdpakrAuKF2THfiWfOmVauRsN4bN9nlEL5KL9Cj-CRF47bZTFJashX___2jb6Q1rCmxi-ESrqP9miLaz2_fAN2T3bTOV5RAiAV2x5RSWsNytoIKBTfIBFMocqCYqO6Yamy9GEkYGK24GMy2Re_kwcTaMKWds7lkkxNn0U8AtP5dgx36li4h0afWYzoSHQtvPUwh1nVvGluJXdSFiu5NIhubhkKFeZ0NBdx4ql4AxNDVE8VUUTJfogtsvGucwBTOT3s7F6rrXM_vlqvZh6xkdbN4B7z1pU3VxrgglAL6UvK6SfGbYUFxLM5yiZxtiGs6f3r84zsXvTN6POJnh35luXxyVMS67if9sfQiqd9BcX7aD714lpgvy2UebVCcNTZ6T917KJ9-SFGjZ-pHS2rpf-iNC9n00TnnkbP-gbPR6C_8OiayyMKv98n8wEKN6R4Fm3yB4_k_DKjZx9v51c0CBu9vVycwW6yHsL6a382WMBgPJ0prrVVXYAWH_f6wfzzsH2EwPhmqnwEAAP__6QxPzg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBO0CGzkwXWZQpsrB5JStCgKgqKoljNNOiTlWR72WfuBfdlAqXVcVE7WdfODAV6few7P8WEQwBturNBqAnPNVkZT9unlC-A7zvJKyIIbcNw62LYohIIAUpxBQR3NqeVwDX0P6E9RM-YlraQjzlBlKXNCK3JfUSlcTXRJLDdbwfwSM8IJRuUUIAi-rMGWyopPwPCPlaSmZRTW2XsJ16DLshNNK6cbqFAF3xHDmV6vuSqoV7eEK5pLXjxCoFWzbrg2BTfkVy2UJVKshYNreH7ZuXOFmp354i7NcOIjyaL4Fdh7OWKmyIlQjhtF5ch5dWL0b8Q66oR1gtkRtT4NJ9ZNfsH4rz9tv1MmGIf2pNBnrB09ZNTXZdnNdEjpUabuDPrPL7tJr04yerN25EXX1AlGmJaSN30YPfwh_ZJKy7upnan4v2FfC-WTbjO3XuRZt8CzMHyCv9SGM2qd_e-ubGvr-Jo0pbDEG2jn3yGA7lLcvMkpmid4lmHIZi8WGDZVLgUb7WCAzihEcXYF8TKD-G6xGKKz_POkPc2XcZolsyjOYEc2K17DbRK9niXv4Bf8DgYUZun8fIjOovglfgs7khNR7GCQN3N0PkVotvAGW2V_mdFBPop_xvMM0myWRWkWzVPov0cAAL833_7To9uPxIo9700gHD6MmZbVWtneBN4fhi2-dzh_OMYbTh0vCHW9CfQuwvFVEI6DcAzheBKGkzDsHYH9IxGKOcJ0pfzCODzW_iSs075IxNUbf7He8bIo_MLRQFVSHpiOefxLPyhcXI4vLpvf_hj-aAb5_5JBc8Pvi-HiR2JAH_rTpypc-wpX31R4e6rCdUeFqy8V_gq3JaVH3iwTHL2KW-T2HBJ8gxMcz3F6eEUD-tB_v9f0f_t0_-vO_v8D03tverP6xrXh5Snf-w7fm1WH8XL1tWXDyy7T9aB63Nz-tDn89nYxi2IYLG-zIeD4zTmkeOGxP8FNsnwN-ykKgiBAllEFe_R3AAAA___57nKg

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBO0CGzkwXWZQpsrB5JStCgKgqKoljNNOiTlWRn2WfuBfdlAqbVdVE7WdfODAV6few7P8WEQwBturNBqAnPNVkZT9unlC-A7zvJKyIIbcNw62LYohIIAUpxBQR3NqeVwDX0P6E9RM-YlraQjzlBlKXNCK3JfUSlcTXRJLDdbwfwSM8IJRuUUIAi-rMGWyopPwPCPlaSmZRTW2XsJ16DLshNNK6cbqFAF3xHDmV6vuSqoV7eEK5pLXjxCoFWzbrg2BTfkVy2UJVKshYNreH7ZuXOFmp354i7NcOIjyaL4Fdh7OWKmyIlQjhtF5ch5dWL0b8Q66oR1gtkRtT4NJ9ZNfsH4rz9tv1MmGIf2pNBnrB0dMurrsuxm2qf0KFN3Bv3nl92kVycZvVk78qJr6gQjTEvJmz6MDn9Iv6TS8m5qZyr-b9jXQvmk28ytF3nWLfAsDJ_gL7XhjFpn_7sr29o6viZNKSzxBtr5dwiguxQ3b3KK5gmeZRiy2YsFhk2VS8FGOxigMwpRnF1BvMwgvlsshugs_zxpT_NlnGbJLIoz2JHNitdwm0SvZ8k7-AW_gwGFWTo_H6KzKH6J38KO5EQUOxjkzRydTxGaLbzBVtlfZrSXj-Kf8TyDNJtlUZpF8xT67xEAwO_Nt__06PYjseKB9yYQDg9jpmW1VrY3gff7YYvv7c8fjvGGU8cLQl1vAr2LcHwVhOMgHEM4noThJAx7R2D_SIRijjBdKb8wDo-1PwnrtC8ScfXGX6x3vCwKv3A0UJWUe6ZjHv_S9woXl-OLy-a3P4Y_mkH-v2TQ3PD7Yrj4kRjQh_70qQrXvsLVNxXenqpw3VHh6kuFv8JtSemRN8sER6_iFrk9hwTf4ATHc5zuX9GAHvrv95r-b5_uf93Z_39g-sGb3qy-cW14ecr3Q4fvzarDeLn62rLhZZfpelA9bu7htDn89nYxi2IYLG-zIeD4zTmkeOGxP8FNsnwN9RQFQRAgy6iCGv0dAAD___ndcp4=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkBO0CGzkwXWZQpsrB5JStCgKgqKoljNNOiTlWRn2WfuBfdlAqbVdVE7WdfODAV6few7P8WEQwBturNBqAnPNVkZT9unlC-A7zvJKyIIbcNw62LYohIIAUpxBQR3NqeVwDX0P6E9RM-YlraQjzlBlKXNCK3JfUSlcTXRJLDdbwfwSM8IJRuUUIAi-rMGWyopPwPCPlaSmZRTW2XsJ16DLshNNK6cbqFAF3xHDmV6vuSqoV7eEK5pLXjxCoFWzbrg2BTfkVy2UJVKshYNreH7ZuXOFmp354i7NcOIjyaL4Fdh7OWKmyIlQjhtF5ch5dWL0b8Q66oR1gtkRtT4NJ9ZNfsH4rz9tv1MmGIf2pNBnrB0dMurrsuxm2qf0KFN3Bv3nl92kVycZvVk78qJr6gQjTEvJmz6MDn9Iv6TS8m5qZyr-b9jXQvmk28ytF3nWLfAsDJ_gL7XhjFpn_7sr29o6viZNKSzxBtr5dwiguxQ3b3KK5gmeZRiy2YsFhk2VS8FGOxigMwpRnF1BvMwgvlsshugs_zxpT_NlnGbJLIoz2JHNitdwm0SvZ8k7-AW_gwGFWTo_H6KzKH6J38KO5EQUOxjkzRydTxGaLbzBVtlfZrSXj-Kf8TyDNJtlUZpF8xT67xEAwO_Nt__06PYjseKB9yYQDg9jpmW1VrY3gff7YYvv7c8fjvGGU8cLQl1vAr2LcHwVhOMgHEM4noThJAx7R2D_SIRijjBdKb8wDo-1PwnrtC8ScfXGX6x3vCwKv3A0UJWUe6ZjHv_S9woXl-OLy-a3P4Y_mkH-v2TQ3PD7Yrj4kRjQh_70qQrXvsLVNxXenqpw3VHh6kuFv8JtSemRN8sER6_iFrk9hwTf4ATHc5zuX9GAHvrv95r-b5_uf93Z_39g-sGb3qy-cW14ecr3Q4fvzarDeLn62rLhZZfpelA9bu7htDn89nYxi2IYLG-zIeD4zTmkeOGxP8FNsnwNuykKgiBAllEFO_R3AAAA___5zHKc

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvdgbLkBO0CGzkwXWZQpsrB5JStCgKgqKoljNNOiTlWR72WfuBfdlAuXE8VI7XZfWDAV2few7P8RGDAN5xY4VWI5hqtjCasi-vXwHfcJZXQhbcgOPWwXqHQigIIMUZFNTRnFoO19D1gO4YNWNe0ko64gxVljIntCL3FZXC1USXxHKzFswvMSOcYFSOAYLgYQ3WVFZ8BIZ_riQ1O0Zhnb2XcA26LFvRtHK6gQpV8A0xnOnlkquCenVLuKK55MUTBFo164ZrU3BDftVCWSLFUji4hpeXrTtXqNmZzu7SDCc-kiyK34C9lwNmipwI5bhRVA6cVydG_0aso05YJ5gdUOvTcGLZ5BcM__rTdltlgmFojwp9xdrBY0ZdXZbtTPuUnmRqz6D78rKd9OooozdrB150SZ1ghGkpedOHweMf0i2ptLyd2pmK_xf2pVA-6V3m1ou8aBd4EYYn-EttOKPW2f_vyLa2ji9JUwpLvIHd_DsE0F2Km3dyjKYJnmQYssmrGYZVlUvBBhvooTMKUZxdQTzPIL6bzfroLP862T1N53GaJZMozmBDVgtew20SvZ0kH-AX_AF6FCbp9LyPzqL4NX4PG5ITUWyglzdzdD5GaDLzBnfK_jCDvXwU_4ynGaTZJIvSLJqm0P2IAAB-b779p0PXn4kVW94ZQdh_HDMtq6WynRF83A93-M7--dMh3nDqeEGo64ygcxEOr4JwGIRDCIejMByFYecA7F8SoZgjTFfKLwzDQ-0vwjrti0RcvfIH6xwui8IvHAxUJeWe6ZDHv-l7hYvL4cVl89sf_edmkP-QDJoTfl8MF8-JAX3qjk9VeOsrvFp802HDy2Mt3ra0eLV4qPEBsFzAzTzB0Zt4BzK8PIcE3-AEx1OcPhyh7lVP93zb2vN_Ya725qpvvK2POatbnFUtxmqyJqVH_sPeus3cpkdPpNK6tu2tFo-XgtdrLoX16UuhPh4Wfn87m0Qx9Oa3WR9w_O4cUjzz2J_gJpm_hXqMgiAIkGVUQY3-DgAA__8ZhoJi

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3cgZLkJWmS23kQnHUQZsqB5YStCgKgqKolitFJiSVJhv2WHuBPdlAunGMQc3WofWFAZ_z_Rx-PHQYwhXThiu5gJWiH7Ui9MP5GbA7RpuBi5ZpsMxYuN2iEApDqLIaWmJJQwyDUwgcIFgiX2YdGYTFVhNpCLVcSXwzEMHtPVYdNkzfcupIVHPLKRFLgDB8oMEtEQNbgGbvB0H0VpEba24EnILqulE0GazyUC5bdoc1o6rvmWyJczeYSdII1j4hoKSna6Z0yzT-VXFpsOA9t3AKz49GOSfIc1bFZVVnGxdJnZc_gbkREdVtg7m0TEsiIuvcsVafsLHEcmM5NRExLg3Le59fOP_rTxOM2oTz2HzR6DPWRI8ZBarrxpV2KT2pNJ5B8PxoXPTki4rusCZypj2xnGKqhGB-H6LHCwk6Igwbl7Z6YP9HvefSJb3N3DiT43GD4zj-F_1OaUaJsebbjWzujWU99kthsDvAtv4VBuiyyvybXKLVJkvrDOr0rMjgemgEp1EDU3TQwNl6XUC5rqG8LIoZOtDqE28hL-sTX73Kq9yRHhBwnr1ML4saBslvBp8db6eHM3SwWpdVvUnzsoYGX39k93CxyV-lmzfwS_YGplvdtFo5bF6eZ6-hwQ3m7R1MG19Hh0uE0sLlsR3UzR7tps3Ln7NVDVWd1nlV56sKgrcIAOB3_-0-E3L7Hhv-G5ssYD57LFMlhl6ayQLe7oq-0Ux2v9_t4zUjlrWY2MkCJkmcJOE8CeME5ieLo2eL5EV0_OOzF0fJZI_jnhaX1GKqBul4yV7zAzdWueXD9v7aTTfZp_L2H_NK0nsQ9heP8T5YDkLsPOK9hvvneKjP53HsO3_Mnogo_i8R-Xv7jjHFXxdT8i1j-pwRehcsEcpeXxRpXsJ0fVHPICuvDqHKCrdyP8DLzfoVNEsUhmGIDCUSGvR3AAAA__825w_u
