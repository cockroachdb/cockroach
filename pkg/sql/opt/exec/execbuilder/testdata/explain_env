# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VG1u20YQ_Z09xUB_JBWiTEoIEFAwUEZeJ2wVyiDpfMAwFsvlsl6Y5DrcJUu1KJBD-Cq9QI_ikxRLurLS0g1Sp_ohgMM3b948vZFlwVteKSFLF9aSXVeSsquTl8BbzpJa5CmvQHOloelRCEU4hpRqmlDF4RjG5u14BWBZkPKM1rmGhuY1d6GHCqXVxxyOQWbZIIzWWnZQUaa8JRVnsih4mVItZKkIL2mS8_RfCP5Std6cRzEOIcJx7AevIONU1xWfN5xpWZGOfv5AN9ZVzYeVZzRXfJBTfcznrEoTIkrNq5Lmc234SCV_JkpTLZQWTM2pIjIjWhSdRZbzx-9qeJLl2OrRQfdYNX8wcSyzbJhpb-MQk5Gm5gZSUC0YYTLPOTMGHxrSrT3Mbrz6L-yFKI0vvUPKDHk-POC5bX-BP5MVZ1Rp9e0kq53SvCDdT6iIWaCvf4MBDWd94FKueVWIsksGyURb36ivSSE6j3B3giu0DrEXY4i9lxsMN3WSCzZvYYKeUfCD-AUE2xiC881mhp4l95X-ab0Nojj0_CCGltxc8x2chf4bL_wAP-IPMKHgRevpDD3zgxP8HlqSEJG2MEm6OprCOz9-DRPFrnhBSS7ZdSfdKJ-uVgh5G7N9L8sone-1-cEPeB1DFHuxH8X-OoLxBQIA-LX7Np8RbX4iSvzCRy7Ys4cyk3ldlGrkwsW-2ONH--fLQ3zFqeYpoXrkwmhhOy8s27FsB2zHtW3XtkcHYHNQomSaMFmXpsGxD2dfCaWliTHRuxsjbHTYLFLTcFAo6zzfMx3ymH-F_YTF0lksu3e_zZ7qQfK_eNAp_DobFk-xAV2OV1_K987ku_5HvpvH8r0byHf9eb53pOnz3Twx37vBfJulHu_wTk7gM7kNyYzg022I_VdBL7iZQohPcYiDNY7-dlITOl0hhN-fbTw_gMn2LJ4BDt5OIcIbo-U7OA23b6CFd69xiCGBY1iukGVZFlKMltB-f3_fCO5ub-9uP93dfgImS6UrKkrtwtHiyHHh4mgJFhwtL9GfAQAA__9cOmC9


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_V0-xYX_2B4sR7ZRoLARYK7DtNpcOZCUfiAICIqiFi4ymYqUJm0YUOwZ_HOvsRfYo-RJBkqZ467Kii6dfxjQ5bnnnnt0KMeB1zzXQsk5rBS7zhVlVyfPgVecxYXIEp6D4dpA2aIQCnEECTU0pprDMfTtaX8B4DiQ8JQWmYGSZgWfQwsV2uj3GRyDStNOGC2MaqBCJrwiOWdqu-UyoUYoqQmXNM548i8Ef6tarc_DCAcQ4ijy_BeQcmqKnI9LzozKSUM_vqfrm7zg3cpTmmneyanfZ2OWJzER0vBc0mxsLB_J1U9EG2qENoLpMdVEpcSIbWORM_nzD909yZm4-sFBd1g9vjexr9K0m2lvYxeTlabHFrKlRjDCVJZxZg0-NKRZu5vdevVf2LdCWl9ah7Qd8rR7wFPX_Qx_qnLOqDb660nWtTZ8S5pXqIldoK1_hQElZ23gEm54vhWySQZJRVXc6C9JIToPcXMFF2gV4GWEIVo-X2O4KeJMsHEFA_SEgudHz8DfROCfr9cj9CS-q7RPq40fRsHS8yOoyM01r-Es8F4tg3fwPX4HAwrLcDUcoSeef4LfQkViIpIKBnFTR0N440UvYaDZFd9Skil23Ui3yoeLBULLtd2-lWWVjvfaPP87vIogjJaRF0beKoT-BQIA-KX5t78eLX8gWvzMe3NwR_dlprJiK3VvDhf7Yovv7Z8vD_E5p4YnhJreHHpTd_LMcSeOOwF3Mnfduev2DsD2QgnJDGGqkLZh4h7OvhLaKBtjYuobK6x32CwS23BQkEWW7ZkOeexXYT9hOptMZ83Zr6PHehD_Lx40Cr_MhuljbECX_cXn8l3bfBef5Lt8KN91R76Lj_Ndk7LNd_nIfNed-bZLPdyxPDmBj-SWJLWCTzcB9l74reByCAE-xQH2Vzj8x5Ua0OECIfz2bL30fBhszqIRYP_1EEK8tlq-gdNg8wqqEdTw5iUOMMRwDLMFchzHQUJKnjs_KiFhwHKl9RDB7e73292H290H0IxKqD-pVN_efRLsyW_21d3udncApqQ2ORXSzOFoejSZw8XRDBw4ml2iA1gqMsNzDYPGVPRXAAAA___bM4TG

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgdLkFMUKGzkQXWYTpsrB5LStQgCgqKohYtEpiKlyBsG9CPyuN_YD-xT8iUDpcxxN2VFl8wPhnXv4bnnHh_KceAdr7RQcgErxa4qRdnl8WvgLWdpLYqMV2C4NtD0KIRinEBGDU2p5nAEY9sdLwEcBzKe07ow0NCi5gvooUIb_bGAI1B5PgijtVEdVMiMt6TiTJUllxk1QklNuKRpwbN_IfhL1Wp9Fic4ghgnSRC-gZxTU1fcbTgzqiIdvftANzZVzYeV57TQfJBTfyxcVmUpEdLwStLCNZaPVOqGaEON0EYw7VJNVE6MKDuLnPkfv-vhSc7c048Ousdq98HEscrzYaadjUNMVpp2LaSkRjDCVFFwZg3eN6Rbe5jdevVf2EshrS-9Q9oOeTk84KXnfYE_VxVnVBv9fJL1Vhteku4v1MQu0NefYUDDWR-4jBtelUJ2ySC5aOtr_TUpRGcx7q7gEq0i7CcYEv_1GsN1nRaCuS1M0AGFIExeQbhJIDxbr2foIL2v9E-rTRgnkR-ECbTk-opv4TQK3vrRB_gef4AJBT9eTWfoIAiP8XtoSUpE1sIk7epoCj8Eybcw0eySl5QUil110q3y6XKJkL-22_eyrFJ3py0Iv8OrBOLET4I4CVYxjM8RAMAv3bf9jGjzI9HiZz5agDd7KDNV1KXUowWc74o9frR7vtjHV5wanhFqRgsYHXrzV443d7w5ePOF5y08b7QHthdKSGYIU7W0B-be_uxLoY2yMSZme22FjfYPi8we2CvIuih2TPs89q2wm3D4Yn74ouv9OnuqB-n_4kGn8OtsOHyKDehivPxSvrc23_U_8t08lu_tQL7rz_O9JU2f7-aJ-d4O5tsu9fgJ__gYPpPbkNwKPtlEOHgT9oKbKUT4BEc4XOH4b1dqQqdLhPD707UfhDDZnCYzwOG7KcR4bbV8AyfR5i204MegJJ_1v8yNWiLHcRwkpOSV85MSEiasUlpPEdzd_nZ3--nu9hNoRiW0cE71kZL84pGWuVFd6_a-lYvC8ErDpLMM_RkAAP__NHd5MQ==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIbCRH6rDtNpcOZCUfiAICIqiFi4SmYqUZm0Y0IfIq-wF9ih5koFS4bibsqJL5h8GdHXuueceHspx4C0vtVByASvFbkpF2fXpS-BbzpJK5CkvwXBtoO5QCEU4hpQamlDN4QSG9u1wCeA4kPKMVrmBmuYVX0AHFdrojzmcgMqyXhitjGqhQqZ8S0rOVFFwmVIjlNSES5rkPP0XAiXb9pKrMuUl-VkJqUkuCmHgBL6f9_Ycd4us1hdRjEOIcBz7wSvIODVVyac1Z0aVpFU0fVAwNGXF-5fNaK55L6f-mE9ZmSZESMNLSfOpsXykVL8QbagR2gimp1QTlREjitZVZ_bnH7p_kjNz9aODPmP19MH3ocqyfqad831MVpqeWkhBjWCEqTznzJ7JviHt2v3s1qv_wl4IaX3pHNJ2yIv-AS9c9yv8mSo5o9ro55OsG214Qdoj1MQu0NWfYUDNWRe4lBteFkK2ySCZ2Fa3-ltSiC4i3N7aJVqF2IsxxN7LNYbbKskFm25hhA4o-EF8DMEmhuBivZ6gg-RzpXtabYIoDj0_iGFLbm94A-eh_8YLP8CP-AOMKHjRajxBB35wit_DliREpFsYJW0djeGdH7-GkWbXvKAkV-ymlW6Vj5dLhLy13b6TZZVOd9r84Ae8iiGKvdiPYn8VwfASAQD81v7b34DWPxEtfuWDBbiThzJTeVVIPVjA5a7Y4Qe756t9fMmp4SmhZrCAwZE7O3bcmePOwJ0tXHfhuoM9sL1QQjJDmKqkbZi5-7OvhTbKxpiY5tYKG-w3i9Q27BVklec7pn0e-1XYTTiaz47m7bvfJ0_1IPlfPGgVfpsNR0-xAV0Nl1_Ld2PzXf0j3_Vj-W568l19me-G1F2-6yfmu-nNt13q8Q7v9BS-kFuTzAo-24TYfxV0gusxhPgMhzhY4ehvV2pEx0uE8PvztecHMNqcxxPAwdsxRHhttXwHZ-HmDTTw7jUOMVRwAvMlchzHQZpRCQ2C-7u7-7tP93efgCmpTUmFNAs4nC3g8nAODhzOr9BfAQAA__83t23s

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIrCRH6rDtNpcOZCUfiAICIqiFi4SmYqUZm0Y0IfIq-wF9ih5koFS4bib0qJL5x8GdHXvOeceHdJx4A0vtVByASvFbkpF2fXpC-BbzpJK5CkvwXBtoO66EIpwDCk1NKGawwkM7dvhEsBxIOUZrXIDNc0rvoCuVWijP-RwAirLettoZVTbKmTKt6TkTBUFlyk1QklNuKRJztMvACjZjpdclSkvyS9KSE1yUQgDJ_B83jtz3C2yWl9EMQ4hwnHsBy8h49RUJZ_WnBlVklbR9EHB0JQV7182o7nmvZj6Qz5lZZoQIQ0vJc2nxuKRUv1KtKFGaCOYnlJNVEaMKFpXndlff-p-Jmfm6keJPvXq6YPvQ5Vl_Ug757-I1O_r8Pm8H_T4UUS7rJ5a0oIawQhTec6Z_cr7FrdG9kNb9_8LeiGkdbrzXFuSZ_0Ez1z3K_iZKjmj2ujvJ1k32vCCtKHQxC7Q1b8DQc1ZF-GUG14WQrZZI5nYVrf6W3KNLiLc3gNLtAqxF2OIvRdrDLdVkgs23cIIHVDwg_gYgk0MwcV6PUEHyadK97TaBFEcen4Qw5bc3vAGzkP_tRe-h5_wexhR8KLVeIIO_OAUv4MtSYhItzBK2joaw1s_fgUjza55QUmu2E0r3SofL5cIeWu7fSfLKp3utPnBj3gVQxR7sR_F_iqC4SUCAPi9_be_Aa1_Jlr8xgcLcCcPZabyqpB6sIDLXbHrH-yer_b7S04NTwk1gwUMjtzZsePOHHcG7mzhugvXHew12yMqJDOEqUragZm7z30ttFE2xsQ0t1bYYH9YpHZgryCrPN8h7ePYe2bHcDSfHc3bd39MnupB8r940Cr8NhuOnmIDuhouv5bvxua7-le-68fy3fTku_o83w2pu3zXT8x305tvu9TjE97pKXwmtyaZFXy2CbH_MugE12MI8RkOcbDC0T-O1IiOlwjhd-drzw9gtDmPJ4CDN2OI8Npq-QHOws1raODtKxxiqOAE5kvkOI6DNKMSGgT3d3f3dx_v7z4CU1KbkgppFnA4W8Dl4RwcOJxfob8DAAD__3MtiFY=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4sR47RIrCRH67DtNpcOZCUfiAICIqiEi4SmYqUZmUY0IfIq-wF9ih5koFS4bib0qJL5h8GdHXvOeceHtFx4B0vtFByBkvFrgtF2dXxK-AbzuJSZAkvwHBtoGq7EApxBAk1NKaawxH07dv-HMBxIOEpLTMDFc1KPoO2VWijP2VwBCpNO9toaVTTyiWNM05uxeUtvSS_KiHtlOwcUmnazAiZ8A0pOFN5zmVCjVBSkxYp-Qapks14wVWR8KIh0yQTuTBwBC-nnTOH7fLL1VkY4QBCHEWe_xpSTk1Z8HHFmVEFaRSNHxT0TVHyboNSmmneiak_ZWNWJDER0vBC0mxsGm8K9RvRhhqhjWB6TDVRKTEib07Cmfz1p-5mciaufpToS68eP5xVX6VpN9L2tL6J1O1r_-W0G_TwUUS7rB5b0pwawQhTWcaZPeVdixsju6Gt-_8FPRfSOt16ri3Ji26CF677HfxUFZxRbfTzSda1NjwnTSg0sQu09WcgqDhrI5xww4tcyCZrJBWb8kb_SK7RWYibu2OOlgFeRBiixasVhpsyzgQbb2CA9ih4fnQI_joC_2y1GqG9-EulfVqu_TAKFp4fwYbcXPMaTgPv7SL4CL_gjzCgsAiXwxHa8_xj_AE2JCYi2cAgbupoCO-96A0MNLviOSWZYteNdKt8OJ8jtFjZ7VtZVul4q83zf8bLCMJoEXlh5C1D6J8jAIDfm3_769Hqkmhxy3szcEcPZaayMpe6N4PzbbHt722fL3b7C04NTwg1vRn0DtzJoeNOHHcC7mTmujPX7e00209USGYIU6W0AxN3l_tKaKNsjImpb6yw3u6wSOzATkGWWbZF2sWx98yW4WA6OZg27_4YPdWD-H_xoFH4YzYcPMUGdNGffy_ftc13-a98V4_lu-7Id_l1vmtStfmunpjvujPfdqnHJxbHx_CV3IqkVvDJOsDea78VXA0hwCc4wP4Sh__4pAZ0OEcIfzhdLTwfBuvTaATYfzeEEK-slp_gJFi_hRrev8EBhhKOYDpHjuM4SDMqoUZwf3d3f_f5_u4zMCW1KaiQZgb7kxmc70_Bgf3pBfo7AAD__9utmdM=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B4iR47RIrCRH67DtNpcOZCUfiAICJqiEi4S6ZKUZmcY0IfIq-wF9ih5koFS4bib0qBL5x8GdHXPueceHtHz4B3XRig5hpliN1pRdn3yCvias2Up8pRrsNxYqJouhGKcQEotXVLD4Ri67m13AuB5kPKMlrmFiuYlH0PTKow1n3I4BpVlrW20tKpu5ZIuc05uxdUtvSK_KiEdSraCVJbVGCFTviaaM1UUXKbUCiUNaZjSbwxVsoarlRWFuOWalIaTa2GsutK0ME8jNVc65bqWaUguCmHhGF6OWjFHjW2z-Xmc4AhinCRB-BoyTm2p-aDizCpN6l0GD9q7Vpe83dqM5oa3cppP-YDpdEmEtFxLmg9s7apWvxFjqRXGCmYG1BCVESuK-gy94V9_mvZJ3tA3jw760msGD6fcVVnWzrQ9528ytfvafTlqJz16lNEtawZuaEGtYISpPOfM5WPX4trIdmrn_n9hL4R0TjeeuyR1X7QPeOH7T_BnSnNGjTU_TrLZGMsLUofCELdAU_8BAyrOmgin3HJdCFlnjWRiXa7M9-Qance4vnUmaBbhaYIhmb6aY1iVy1ywwRp6aI9CECZHEC4SCM_n8320t_xSaZ5mizBOomkQJrAmqxu-gbMoeDuNPsIv-CP0KEzjWX8f7QXhCf4Aa7IkIl1Db1nXUR_eB8kb6Bl2zQtKcsVuaulOeX8yQWg6d9s3spzSwVZbEP6MZwnEyTQJ4iSYxdC9QAAAv9f_7teh1RUx4pZ3xuDvP5SZystCms4YLrbFpr-zfb7c7decWp4Sajtj6Bz6wyPPH3r-EPzh2PfHvt_ZaXafqJDMEqZK6QBDf3d2ffe5GBO7WTlhnV2wSB1gpyDLPN8y7fK4e2Y74XA0PBzV7_7Yf64Hy__Fg1rh99lw-Bwb0GV38lS-Ny7f5b_yXT2W701Lvsuv870hVZPv6pn53rTm2y31OGJ6cgJfya1I5gSfLiIcvA4bwVUfInyKIxzOcPyPT6pH-xOE8Iez-TQIobc4S_YBh-_6EOO50_ITnEaLt7CB929whKGEYxhNkOd5HjKMStgguL-7u7_7fH_3GZiSxmoqpB3DwXAMFwcj8OBgdIn-DgAA__-LUK4e

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO9u27YX_Rw9xYW_2P4hcuQYLQIb-eA6TKvfXDmQlP5BEBA0RSVcJNIlKc3OMKAPkVfZC-xR8iQDqcJxN6Vdls4fDOjqnnPPPTyi78M7pjSXYgwzSW-UJPT65BWwNaPLihcZU2CYNlA3XZ6XoBQyYsiSaAbH0LVvuxMA34eM5aQqDNSkqNgYmlaujf5UwDHIPG9tI5WRrpUJsiwYvuVXt-QK_yy5sCjRCpJ57jBcZGyNFaOyLJnIiOFSaNwwZd8YKoWDy5XhJb9lClea4WuujbxSpNRPRZZVYTiVBdaGmH-AVkyqjCm3pMYFL7mBY3g5asUcNabP5udJimJIUJqG0WvIGTGVYoOaUSMVdk4MHjbvGlWx9oPJSaFZK6f-VAyoypaYC8OUIMXAuDNR8he3GteGUz0gGsscG166BPjDP37X7ZP8YaAfHfSlVw8eMtKVed7OtE3JN5nafe2-HLWTHj3K6M5xYIeWxHCKqSwKRm26di12RrZTW_f_DXvJhXW68dwmqfuifcCLIPgOfy4Vo0Qb_eMk6402rMQuFBrbBZr6DxhQM9pEOGOGqZILlzWc83W10k_JtXeeIHdnTbxZjKYpgnT6ao5gVS0LTgdr6Hl7BMIoPYJokUJ0Pp_ve3vLL5XmabaIkjSehlEKa7y6YRs4i8O30_gj_IQ-Qo_ANJn19729MDpBH2CNl5hna-gtXd3rw_swfQM9Ta9ZSXAh6Y2TbpX3JxPPm87t9o0sq3Sw1RZG_0ezFJJ0moZJGs4S6F54AAC_un_765D6Cmt-yzpjCPYfylQWVSl0ZwwX22LT39k-X-72K0YMyzAxnTF0DoPhkR8M_WAIwXAcBOMg6Ow020-UC2owlZWwgGGwO9vdnDbG2GxWVlhnF8wzC9gpiKootky7PPae2U44HA0PR-7db_vP9WD5n3jgFD7NhsPn2OBddiffy_fG5rv6W77rx_K9acl39XW-N7hu8l0_M9-b1nzbpR5HTE9O4Cu5Nc6t4NNFjMLXUSO47kOMTlGMohlK_vJJ9Uh_4nnow9l8GkbQW5yl-4Cid31I0Nxq-R-cxou3sIH3b1CMoIJjGE083_d9T1MiYOPB_d3d_d3n-7vPQKXQRhEuzBgOhmO4OBiBDwejS-_PAAAA__9GJMQf

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyslN-O0zwQxe_zFHPX70Mkarf0D1v1ogSDKrXZpUmrvbNcZyIMjr31OKU8GC_AkyEniOUiuwi0d1F8_DszZ0aOYzigI2XNNaRWfnZWyI9v3wBeUB4bpUt04JE8nDtVFOWsgFJ4cRSEsIRBOB0sAOIYSqxEoz2chW7wGjqpIk8nDUuwVdUrE423rVSZEi_cobR1jaYUXllDHI04aiyfAFjTXndoXYmOf7LKENeqVh6WMB333pl3jaSbfV6wHeSsKNbZe6hQ-MZhckbpreNtRclDBQPvGuxvthKasJdJJ51IVx65Mh6dETrxgced_cLJC6_IK0mJIG4r7lXdphqPvn-jfqd4NKRHjX5qKXnIfWCrqp_0K_knSf25Dqbjfuj8UWJolpJgWguvJJdWa5Rhyr9H3AbZjw7p_wu9ViYk3WVOwWTSbzAZDv_Ar6xDKcjT85VMX8ljzdulIB4a6P4_g8EZZbfCJXp0tTLtrvFKXZp7-pu9jvY5a9-BRZTu2KpgkLMPe5alDO6bo1YyITzBdp0dVps9gxFsV3fd5-urq_F4djUcT-eTV7PZZD6cwTpLd2zLsgJGkBerXQGjxSKK2N3tZrXO4L-b2-IlsOzwP-Rsw9ICXsC73c0WCE-LKI7jOCI8NWgkxoRhyOEk-hEAAP__43SOzg==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfY6-4sIvtgfLkWO0CGwEmOswrTZXCSQlaREEBEVRCxeJTElKszcMKPYNftxv7Af2KfmSgVLqOK3SokubhwC6PPfcc4-OaNeFM6Y0l2ICc0mvlST06vAFsCWjScnzlCkwTBuoGpTjRCiGlBiSEM3gALr2tDsFcF1IWUbK3EBF8pJNoIFybfS7HA5AZlkrjJRG1lAuUrbEilFZFEykxHApNGaCJDlLP0MgRd2umFQpU_hXyYXGOS-4gQN4Pm7t2W8WmS9OoxiFEKE49oOXkDFiSsWGFaNGKlwrGt4r6BpVsvZlM5Jr1sqp3-VDqtIEc2GYEiQfGsuHlfwNa0MM14ZTPSQaywwbXtSuuqN__9Htk9yRpx8ddIfVw3vfuzLL2pk2zn-Wqd3X7vNxO-n-o4x2WT20QwtiOMVU5jmj9i1vW1wb2U5t3f8_7AUX1unGc22HPGsf8MzzvsCfScUo0UZ_O8l6pQ0rcB0Kje0CTf0bDKgYbSKcMsNUwUWdNZzxZXmjvybXzmmE6ntg6sxDNIsRxLMXCwQ3ZZJzOlxCz9kh4AfxPgTHMQSni8XA2UnuKs3T_DiI4nDmBzEs8c01W8FJ6L-ehW_hZ_QWegRm0bw_cHb84BC9gSVOME-X0EvqutOHcz9-BT1Nr1hBcC7pdS3dKu9Pp44zW9jtG1lW6XCjzQ9-QvMYongW-1HszyPoXjgAAH_U_-1fh1S_YM1_Z50JeIP7MpV5WQjdmcDFptjgO5vny228YsSwFBPTmUBnzxvtu97I9UbgjSaeN_G8zhbYfqJcUIOpLIVtGHnbs6-4NtLGGJvVjRXW2W7mqW3YKogyzzdM2zz2ntlM2BuP9sb12Z-Dp3qQfBcPaoVfZ8PeU2xwLrvTL-V7ZfNdfpLv6rF8r1ryXT7M9wpXTb6rJ-Z71Zpvu9TjHbPDQ3ggt8KZFXx0HCL_ZdAIrvoQoiMUomCOoo8-qR7pt5l25qPzD55V9Z1gb4GBs1Nat5w-zCKI0MKqJQNIBlAOoIKj8Pj1Q_7BR3rPX6EQQQIHMLZWoDcni5kfQO_4JB4ACs76H1h_aMiqqeO6rutwIZhy7Q8X9KiSWvcduF3_fbt-f7t-D5oSAatPKssf7-4ee_KXzcjten0HoFJoowgXZgK7e7ujCVzsjsGF3fGlswXLeG6Y0tCr357zXwAAAP__bvHNFQ==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyslNFOnEAUhq-dpzh37DZCNEZj3HiBlLa0yJpltDVNM5kdDnEqMDpn2K4P1hfokzUDTe0F2rTxFv7z_f_5OSEM4QotadOdQGLUrTVS3bw-A9yiWve6qdCCQ3KwGVWMlSmHSjq5loRwCoF_GywAwhAqrGXfONjIpscTGKWaHN03cAqmridlsndmkOquwq2wqEzbYldJp01HAju5brB6BmC6YdyisRVa8dXojkSjW-3gFI4OJmeOx0WS_LLk6QrKlPOseAs1StdbjDaonLFiSBQ9Jgic7XF62Vo2hJNMum8iZau10J1D28kmcp4nrPkmyEmnyWlFkSRhauF0O7Qa7v_4TtNO4f4ePWn0S0vRY--Bqetp0u_mnyVN9xocHUxDj58k-mUp8qatdFoJZZoGlf_Kf1Y8FDmN9u3_D73VnW967Jy8yeG0weHe3l_4tbGoJDl6ucj0QA5bMRwFCb_A-PwFDDaoxhOu0KFtdTfcmqj1tr-jf7lrdlmmw39gwZJVGvMUeHyWp0CRgxnbkZAV_BiKJYfiMs932U6yLEq-irOCgxN3t_gAF6vsPF5dw4f0GmYS4jKZszl8zPg7mJG6wVaKxqjbIY-PM18sGItzv9Lo5e0jb5gV79OEQ8ljnpU8S0oIPn8JFoylny7yOCtgtrzgu5AWV3Mo09xrX8Gb1fLcx12wMAxDRkp24NjPAAAA__-mvpyw

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexsA5FgI0gQJPAiTYUigOEGtWN0R4ypUcqGImvOyHV2OYSv0gv0KD5JQaloumBSNMiWGr4_fPp5DisKbLw7hyuv74NH_eX9O6Ad6XVrbEUBhFhg209l2aJcQoWCa2SCKQzi18EFQJ5DRTW2VmCLtqVz6Ef7MyUBHaMW453atGiNPChfK6awNTqC1qjv74JvXZWEBbprLYaeaVh4Y2EKvq6T09iK70aNq2inAmnfNOQqjPmsyOHaUvUCwLvueiAfKgrqqzeOlTWNEZjC6XHyzlkv52p2u1iWn2BRLpfX8w9QE0obqNiSFh9Ut1HxtMFAQktpgTVapiSTN7bQoVor44SCQ1tI5KngvysWFMNiNBfI0bGYpvtT-eTnD04n5ZMxPxv0e5aLJ-8DX9dp0h_zL5LSXgenx2no2bPE-FguYmiDYrTS3lrqWva34k5kGh3tv4beGBdN9845hpykA07G43_wax9IIwu_3cr8wEKN6krBKj6gP3-DgC3pvsIVCYXGuK5rqja79hv_T6-z8vPN7PJ6DsOPN8sjKOerEawuZ7flAoaT0UWW53medTc4g8N-f9g_HvaPMJwcjbJfAQAA__93FZMj

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zoQhvc6xexsA5FgI0gQJPAiL08oAhhuUDtGd8SYGrVsKbLmjFRnl0P4Kr1Aj-KTFJSKpgsmRYtsqeH3Dz_9eQ4bCmy8u4Qbrz8Hj_rj__8B7UlvW2MrCiDEAt0wlWWrcg0VCm6RCeYwil9HVwB5DhXV2FqBDm1LlzCMDmdKAjpGLcY7tWvRGnlQvlZMoTM6gnQwYjTaJCrQh9ZiGIiGhXcW5uDrOjmNrfh-1LiK9iqQ9k1DrsKYzoocbi1VLwC8668H8qGioD5541hZ0xiBOZyfJu9cDGpuFverdfkOVuV6fbt8AzWhtIGKjrT4oPqNiqcNRhJaSuur0TIlmbyzhQ7VVhknFBzaQiJPBf9VsaAYFqO5QI6GxTT9f8pn379xOimfTfnZoJ-zXDx5H_m6TpN-mX-RlPY6Oj9NQy-eJcbHchFDGxSjlfbWUt-x3xX3ItPoaP9f6I1x0fTgnGPIWTrgbDr9A7_2gTSy8OutzA8s1Ki-FKziA4bzVwjoSA8VrkgoNMb1XVO12bdf-G96nZXv7xbXt0sYv71bn0C53Exgc724L1cwnk2usjzP86y_wRkcD4fj4fF4eITx7GSS_QgAAP__nfCSTg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tofIkBO0CGzkwnWYTpsrB5bStSgKgqaOGs6U6JCUZnvYY-0F9mQDpcJxWrldl9YXBnR0-P35M30fXqM2QhUjmCq-0orxu6sXgBvky1LIFDVYNBaqZsvzYpJAyixbMoNwCV33tjsG8H1IMWOltFAxWeIImtVmRq1mhWHcClXQ-5JJYbdUZdSgrgR3QFwLKziTrVAaP5SS6QZRGGvuJVyCyrLWbVZaVa-KIsUN1chVnmORMsduKBZsKTH9AoAq6uMalU5R09-VKAyVIhcWLuH5eeuZiyaa6ew2TsgCYpIkYfQSMmS21DiokFulaa1o8KCga3WJ7fFlTBpsxTT3csB1uqSisKgLJgfW4VGt_qDGMiuMFdwMmHEJW5HXv5M__Odv087kDwNzlOjjrhk85N5VWdaOtE_-i0jtuXafn7eDXhxFdGbNwJHmzApOuZIS644dRlwH2Q7t0v8_6LkoXNJN5saRPGsneBYEX8HPlEbOjDXfT7LZGos5rUthqDPQzL8DQYW8qXCKFnUuirprNBObcm2-pdfebUzqm2XsTRdkkhBIJi9mBNblUgo-2EDPO2EQRskFRPMEotvZ7NQ7WX6cNE_TeRQni0kYJbCh6xVu4WYRvpos3sKv5C30GEziaf_UOwmjK_IGNnRJRbqB3rKee334LUx-hp7hd5gzKhVf1dKd8v547HmTmXPfyHJKB3ttYfQLmSYQJ5MkjJNwGkP3nQcA8Gf97T4dVn2gRuywM4Lg9GHMlSzzwnRG8G4_bPY7--f3h_samcWUMtsZQecsGF74wdAPhhAMR0EwCoLOwbL7i4qCW8pVWbgDw-CQ-04Yq1yNqd2unbDO4WGRugMHg6KUco90iOPumT3D2fnw7Lx-99fpUzNY_pAMaoXfFsPZU2Lw3nfHX-v31vW7_Kzf1bF-b1v6XT7u95ZWTb-rJ_Z729rv_2Bq50ytV5-50pgd87Vr8bVePdHA7qiB45YnV1fwKO-KZk7Z9XxBwpdRo6zqw4JckwWJpiT-5E7osf5x_N2n-NnqMbLG7Cj2Fnplf-x55M3NbBJG0JvfJKdAotd9iMnM-fwJrhfzV7Abe77v-57hrICd928AAAD__4qO6Fg=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tofIkBO0CGzkwnWUTpsrB5bStSgKgqKOGs6U6JCUZnnYY-0F9mQDpcJxWrldl9YXBnR0-P35M10XXqPSXBYTmEu2VpKyu6sXgFtkSclFigoMagNVu-U4kR9DSg1NqEa4hL59258CuC6kmNFSGKioKHEC7Wo7I0bRQlNmuCzIfUkFNzWRGdGoKs4sEFPccEZFJ5TCD6WgqkXk2uh7AZcgs6xzm5ZGNqu8SHFLFDKZ51ik1LJrggVNBKZfAJBFc1yhVCkq8rvkhSaC59zAJTw_7zxz0UYzX9xGsb-CyI_jIHwJGVJTKhxVyIxUpFE0elDQN6rE7vgyKjR2Yup7MWIqTQgvDKqCipGxeETJP4g21HBtONMjqm3ChufN7-SO__lbdzO5Y08fJfq4q0cPufdllnUj7ZP_IlJ3rv3n592gF0cRrVk9sqQ5NZwRJoXApmOHETdBdkPb9P8Pes4Lm3SbubYkz7oJnnneV_AzqZBRbfT3k6xrbTAnTSk0sQba-XcgqJC1FU7RoMp50XSNZHxbbvS39Nq5jfzmZpk685U_i32IZy8WPmzKRHA22sLAOaEQhPEFhMsYwtvF4tQ5ST5O2qf5Mozi1SwIY9iSzRpruFkFr2art_Cr_xYGFGbRfHjqnAThlf8GtiQhPN3CIGnmzhB-C-KfYaDZHeaUCMnWjXSrfDidOs5sYd23sqzS0V5bEP7iz2OI4lkcRHEwj6D_zgEA-LP5tp8erT4QzXfYm4B3-jBmUpR5oXsTeLcftvu9_fP7w32F1GBKqOlNoHfmjS9cb-x6Y_DGE8-beF7vYNn-RXnBDGGyLOyBsXfIfce1kbbGxNQbK6x3eJin9sDBoCiF2CMd4th7Zs9wdj4-O2_e_XX61AySH5JBo_DbYjh7SgzO-_70a_2ubb_Lz_pdHet33dHv8nG_a1K1_a6e2O-6s9__wdTOmtqsP3OlMDvma9fha7N-ooHdUQPHLc-uruBR3hXJrLLr5coPXoatsmoIK__aX_nh3I8-uRMGdHgcf_cpfrZ-jKwwO4pdw6AcTh3Hf3OzmAUhDJY38Sn44eshRP7C-vwJrlfLV1BPHdd1XUczWkDt_BsAAP__in3oVg==

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tofIkBO0CGzkwnWYTpsrB5bStSgKgqaOGs6U6JCUZnvYY-0F9mQDpcJxWrldl9YXBnR0-P35M30fXqM2QhUjmCq-0orxu6sXgBvky1LIFDVYNBaqZsvzYpJAyixbMoNwCV33tjsG8H1IMWOltFAxWeIImtVmRq1mhWHcClXQ-5JJYbdUZdSgrgR3QFwLKziTrVAaP5SS6QZRGGvuJVyCyrLWbVZaVa-KIsUN1chVnmORMsduKBZsKTH9AoAq6uMalU5R09-VKAyVIhcWLuH5eeuZiyaa6ew2TsgCYpIkYfQSMmS21DiokFulaa1o8KCga3WJ7fFlTBpsxTT3csB1uqSisKgLJgfW4VGt_qDGMiuMFdwMmHEJW5HXv5M__Odv087kDwNzlOjjrhk85N5VWdaOtE_-i0jtuXafn7eDXhxFdGbNwJHmzApOuZIS644dRlwH2Q7t0v8_6LkoXNJN5saRPGsneBYEX8HPlEbOjDXfT7LZGos5rUthqDPQzL8DQYW8qXCKFnUuirprNBObcm2-pdfebUzqm2XsTRdkkhBIJi9mBNblUgo-2EDPO2EQRskFRPMEotvZ7NQ7WX6cNE_TeRQni0kYJbCh6xVu4WYRvpos3sKv5C30GEziaf_UOwmjK_IGNnRJRbqB3rKee334LUx-hp7hd5gzKhVf1dKd8v547HmTmXPfyHJKB3ttYfQLmSYQJ5MkjJNwGkP3nQcA8Gf97T4dVn2gRuywM4Lg9GHMlSzzwnRG8G4_bPY7--f3h_samcWUMtsZQecsGF74wdAPhhAMR0EwCoLOwbL7i4qCW8pVWbgDw-CQ-04Yq1yNqd2unbDO4WGRugMHg6KUco90iOPumT3D2fnw7Lx-99fpUzNY_pAMaoXfFsPZU2Lw3nfHX-v31vW7_Kzf1bF-b1v6XT7u95ZWTb-rJ_Z729rv_2Bq50ytV5-50pgd87Vr8bVePdHA7qiB45YnV1fwKO-KZk7Z9XxBwpdRo6zqw4JckwWJpiT-5E7osf5x_N2n-NnqMbLG7Cj2Fnplf-x55M3NbBJG0JvfJKdAotd9iMnM-fwJrhfzV7AZe77v-57hrICN928AAAD__4ps6FQ=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkwXWUTpsrB5bStSgKgqauGs6U6JCUZnnYZ-0H9mUDpcJxU7ldltQPBnR17znnHh3SdeEtKs1lPoaZZGslKbu9fAW4RbYquEhQgUFtoGy6HCfyY0iooSuqES6ga992JwCuCwmmtBAGSioKHEPT2tSIUTTXlBkuc3JXUMFNRWRKNKqSMwvEFDecUdEKpfBTIahqELk2-k7ABcg0be2mhZF1K88T3BKFTGYZ5gm17JpgTlcCk28AyLweVyhVgor8LnmuieAZN3ABL89aZ84ba2bzmyj2lxD5cRyEryFFagqFwxKZkYrUiob3CrpGFdhuX0qFxlZMfSeGTCUrwnODKqdiaCweUfIPog01XBvO9JBq67DhWf2d3NE_f-t2Jnfk6aNEn3v18N73rkzTdqS9899Eave1-_KsHfT8KKJdVg8taUYNZ4RJIbDO2KHFtZHt0Nb9_4Oe8dw63XiuLcmLdoIXnvcd_FQqZFQb_XySdaUNZqQOhSZ2gab-DAQlsibCCRpUGc_rrJGUb4uNfkyunZvIr2-WiTNb-tPYh3j6au7DplgJzoZb6DknFIIwPodwEUN4M58PnJPV50rzNFuEUbycBmEMW7JZYwXXy-DNdPkefvXfQ4_CNJr1B85JEF7672BLVoQnW-it6rrTh9-C-GfoaXaLGSVCsnUt3SrvTyaOM53b7RtZVulwry0If_FnMUTxNA6iOJhF0P3gAAD8Wf_bX4eWn4jmO-yMwRvcl5kURZbrzhg-7ItNf2f__PGwXyE1mBBqOmPonHqjc9cbud4IvNHY88ae1zlotkeU58wQJovcDoy8Q-5bro20MSam2lhhncNhntiBg0JeCLFHOsSx98ye4fRsdHpWv_tr8FQPVj_Eg1rh42w4fYoNzsfu5Hv53tl8b9ZfBVxheiziu5aIb9ZPzPKuNcv_YYHKLlB8pb88pr5qUV98eUArUjYHtHziUtXRpY7bML28hAO56RquFks_eB02UhWmfVj6V_7SD2d-9ICuV_SPY1cPse2eqTXjC4byKP4WevQx-A-1H0fe2QT1J47jv7ueT4MQeovreAB--LYPkT-3Fv4EV8vFG6gmjuu6rqMZzaFy_g0AAP__NrwDeg==

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lOFu2zYQxz9HT3HwFzuDJchK06U28kFx1E2bKgeWkrUoCoKiqIYLRSYk5cYb9lh7gT3ZQKp1jEHNliH1BwO--9__7n46y_fhiirNpJjDUpIbJTG5Pj8Dek9J1TFeUwWGagObXuV5RVJCjQ2usKZwCmObHS8AfB9q2uCOG9hg3tE59NI-hozCQmNimBTorsOcmS2SDdJUbRixRkQxwwjmg1aKfuw4Vr0j00bfcTgF2TSDatwZ6aRM1PQeKUpk21JRY9tdIypwxWn9iIEUrlxRqWqq0K-SCY04a5mBU3h5NFhz0qNZZpdFmayhSMoyzX-AhmLTKRpsKDFSITdR8DDB2KiODuNrMNd00FPf8YCoukJMGKoE5oGxfkjJT0gbbJg2jOgAa0vYsNY9J3_21596uJM_C_VXG33W6uCB-1g2zbDTjvyjTsNcxy-Phk1Pvupol9WBbdpiwwgiknPqbmwfsQM5bG3p_x_3lglLumeubZPj4QbHYfgv_o1UlGBt9PONrLfa0Ba5o9DILtDHn6HBhpL-hGtqqGqZcLeGGnbf3eqn3LV3WSTuzbLwluskLhMo47Msgduu4owEFUy8gwrOVqsM8lUJ-WWWTb0DJT-xGtK8PHHRq7RIbdEXBZwnr-PLrIROsLvOPRxWTw6n3sFylRflOk7zEip0e0O3cLFO38Trd_Bz8g4mvW9cLK02zc-Tt1ChCrH6HiaVi3uH8Eta_ggTTa5pixGX5MZtahc9XCw8L84srH4Lu1iwWyXNf0qWJRRlXKZFmS4LGL_3AAB-d9_2M8Kbj0iz3-hoDrPpQ5hI3rVCj-bwfhd0iWq0-_1hX68oNrRG2IzmMIrCKPJnkR9GMDuZH72YR6-C4-9fvDqKRns19o_NBDGIyE7Yumgvec20kfb0kdne2ulG-6Ws_se8ArdOhNzZIbQvFh3nux7hXsK-t77EZ7MwdJk_po8gCv8LIvdQvyGm8GmYoufE9JmR92G88Lzk7UUWpzlMVhflFJL86hCKJLMn9x28Xq_eQLXwfN_3PU2wgMr7OwAA___dn1v1
