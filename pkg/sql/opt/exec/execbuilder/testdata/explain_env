# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O2zAUxq_xU3zKDe3U0LS9QamQFkrQspUUJRkDIWQ5iaHe3LhzHBY6TeIh-oQ8yZQAXTWJ_bkgF5F8zvc7-Y78xbZxxnUpVOFiorIvWrFsfnQIXvMsrYTMuYbhpcHto4oQ24bmSudc089KFCWVYiEM5qyEmXPk_JpV0uCWyYq72G_0vGCp5HQlblbspqVekqui0aulEQux4ppWJadzURp1o9mi_B9qUUkjMiVpaZj5CylVxqQwd_R5RE6XTBthhCp4TkWR85qWGXvZ9vU1if0EuShN-VXioKmMAdv-Xckqo5pP3vLMKC1W_A_OyCTyvcRH4h1OfSyrVIpsr0aH7DAEYbKPcJYg_Did9shO-lR5PE1mYZxEXhAmsJZaLJi-s3AaBSdedIEP_gU6DF486fbIThAe-eeoaUpFXqOTPtePvZNgerGFd1gPaZd0x4R408SPnmw14djbeAvC9_4kQZx4SRAnwSTG7iUBgO_tu3msTMlqUZSWi8tNsW0wa3O-6m3pNWeG55QZy4U1dAb7tjOwnQGcges4ruNYW-LmBkSRGZqpqmiAgeNstdss0SYW5m7Jm3nbcFFJuQG3Ma2-_Ro4HA2Go7b3o_fPu6Wvsltr5fXWI1e7Y0L889OpF4TozE6THvzwrIvYnzbX_AbH0ewENT698yMfKQ4wGhPbtm3S_i3126dcETys1w_r-4f1PTJVlEYzURgX_WF_4OKyP4KN_uiK_AwAAP__fcJO9A==

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O2zAUxq_xU3zKDe3U0LS9QamQFkrQspUUJRkDIWQ5iaHe3LhzHBY6TeIh-oQ8yZQAXTWJ_bkgF5F8zvc7-Y78xbZxxnUpVOFiorIvWrFsfnQIXvMsrYTMuYbhpcHto4oQ24bmSudc089KFCWVYiEM5qyEmXPk_JpV0uCWyYq72G_0vGCp5HQlblbspqVekqui0aulEQux4ppWJadzURp1o9mi_B9qUUkjMiVpaZj5CylVxqQwd_R5RE6XTBthhCp4TkWR85qWGXvZ9vU1if0EuShN-VXioKmMAdv-Xckqo5pP3vLMKC1W_A_OyCTyvcRH4h1OfSyrVIpsr0aH7DAEYbKPcJYg_Did9shO-lR5PE1mYZxEXhAmsJZaLJi-s3AaBSdedIEP_gU6DF486fbIThAe-eeoaUpFXqOTPtePvZNgerGFd1gPaZd0x4R408SPnmw14djbeAvC9_4kQZx4SRAnwSTG7iUBgO_tu3msTMlqUZSWi8tNsW0wa3O-6m3pNWeG55QZy4U1dAb7tjOwnQGcges4ruNYW-LmBkSRGZqpqmiAgeNstdss0SYW5m7Jm3nbcFFJuQG3Ma2-_Ro4HA2Go7b3o_fPu6Wvsltr5fXWI1e7Y0L889OpF4TozE6THvzwrIvYnzbX_AbH0ewENT698yMfKQ4wGhPbtm3S_i3126dcETys1w_r-4f1PTJVlEYzURgX_WF_4OKyP4KN_uiK_AwAAP__fcJO9A==

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNGOozYUhq_HT3HEzZIKNiS5GRGtVDbrtLQZMgK63dFoZBlwJu4SnNqGQqpKqz5DLvt0eZIKksmi7s5052K4QPI5_384B3-2bcN7JhUXhQszkX6Ugqbrd2-B1SxNSp5nTIJmSkN1VCFk2yCZkBmT5DfBC0VyvuEa1lSBXjPI2IqWuYaK5iVz4bLVs4ImOSM7fr-j953rMbkoWr3Yar7hOyZJqRhZc6XFvaQb9RzXpsw1T0VOlKb6f5y5SGnOdUMeSmRkS6XmmouCZYQXGauJSunjba9WKMIxZFxp9XsOb9rIFMC2_6ukpRbtJyuWaiH5jj3RGZqF2IsxxN7bBYZtmeQ8fV2DiS4o-EF8CcEyhuCXxcJCF8kpclzNlkEUh54fxGBsJd9Q2RhwHfpXXngDP-MbMCl40WxgoQs_eIc_QE0SwrMazOQhPveu_MVNz25SC5IBGkwR8hYxDk9ttXC8PvfmBz_hWQxR7MV-FPuzCF7dIgCAP7t3-xipyMtNoQwXbs_BLkGN8_rO6uklo5plhGrDBWPsjC5tZ2Q7I3BGruO4jmP0xO0O8CLVJBVl0RpGjtNLdyyRFgvdbFlbr28uyjw_G_s2Kf74XHA8GY0nXe4v65tnS15ktq6VlxsP3b2afp3CpqWw_ILC6pkUlg-09aSrj6Qikq1IDfNliP0fgqO2GkCI5zjEwQxH59Ng0s8QN6Q6Qlw9DnFpQfU0xM1XIe7-BP5wvfD8AMzldWwBDt4PIMKLVvsdzMPlFdQWNPDrjzjEkMAbmEyRbds24kXBpN3de2YqhVIDBIf9P4f9p8P-E3QXS_NFpP7-dCjbzN_tfhz2-5MgFYXSkvJCuzAcD0cu3A4nYMNwcod6shXPNZMKTC1LNkD_BgAA__9WJLyi

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0U81O4z4QP-OnGOVC-1eCUrigVhxCCVL-G1LUeBEIIctJptS7rt21HQhdrcRD9LhPx5OsEqBbrcR-HMghin8fk9_IM0EAF2is0GoIY11-NpqX85NjwAbLohayQgMOrYO7ZxUhQQAGtanQsE9aKMukWAgHc27BzREqnPFaOrjjssYhHLZ6VLyQyFbidsVvO9dbcq1avV46sRArNKy2yObCOn1r-ML-i2tRSydKLZl13P3BKXXJpXAP7LVExZbcOOGEVlgxoSpsmC3527FnM5LHFCphnf0i4ahFRgBB8KuS1063v7zD0mkjVvibZGQ8jSMaA42O0xiWdSFFuddAj-xwSDJ6CNmEQvYxTX2yU7wgz6fxJMvpNEoyCt7SiAU3Dx6cT5OzaHoFH-Ir6HGI8nHfJztJdhJfQsMKJqoGesUrfhqdJenVlr3HfSj6pD8iJEppPH2J1Q7H3iZbkv0fjynkNKJJTpNxDrvXBADga_duH6_Usl4o6w3hegN2BPc25xt_S2-QO6wYd94QvP1wcBiEgyAcQDgYhuEwDL0tcXsDQpWOlbpWrWEQhlt0N0usHQv3sMS23rZZ1VJujNs2o-9_Ftw_GOwfdNw3_697K96lty7K-7VHbnZHhMSX52mUZNCbnFMf4uyiD3mcttf8H5xOJ2fQQJSDVug_f7l7PSJBEAREKIUm6Pa9VxptbZ_A0_r70_rxaf0I3UI1cM3tkVZ48wbl7nVHrV-omZAOjYWeMzX2yY8AAAD__9yBZ2g=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkk9u2zwQxdfhKR6yifwhSvDBQBHYyEJR6FatIgcSmyYIAoKWaJuNLLokJVhe5RA-oU9SyI6LtugfdMnB7828eRzfx500VulqgFDnz0aLfH59BbmS-aRWZSENnLQOzZ4iJKMMRmpTSMM_a1VZXqqFcrjEm_4Q8H0Ucirq0qERZS0HuCC-D1mJSSn5Ws3WYrbTYS4s3Fz-jOuq4_XSqYVaS8NrK_lcWadnRizsv6gWdelUrktunXB_UZY6F6VyLT-0KPhSGKec0pUsuKoKueI2F7-3PZ3uoimUdfZLicuu8ss8RO10N7KRudNGreUfnJEwpQGjYMFVTLGsJ6XKz1p45KhGlLALJGOG5GMcn5Kj5rWyf4XjJGNpECUMx0ujFsK0x7hNo5sgfcAH-gCvRpCFvR_R6TNvuJFTvsJonNLobbJnmx5SOqIpTUKaHXysPNHJo-Sa3qPlDVfFCl5zaDsKbqL44bvpXn2Kpkd6Q0KCmNH0davuvM6-rRYl72nIkLGARRmLwgwnj08nQ0Lo_W0cRAm88S07BU3uesho3LH_YZSOb9Di0zuaUtS4RH9IfN_3ye7HWoLtZrPdvGw3L8h1ZZ0RqnIDnP8_wON5Hz7O-0_kawAAAP__6U_5pw==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkk9u2zwQxdfhKR6yifwhSvDBQBHYyEJR6FatIgcSmyYIAoKWaJuNLLokJVhe5RA-oU9SyI6LtugfdMnB7828eRzfx500VulqgFDnz0aLfH59BbmS-aRWZSENnLQOzZ4iJKMMRmpTSMM_a1VZXqqFcrjEm_4Q8H0Ucirq0qERZS0HuCC-D1mJSSn5Ws3WYrbTYS4s3Fz-jOuq4_XSqYVaS8NrK_lcWadnRizsv6gWdelUrktunXB_UZY6F6VyLT-0KPhSGKec0pUsuKoKueI2F7-3PZ3uoimUdfZLicuu8ss8RO10N7KRudNGreUfnJEwpQGjYMFVTLGsJ6XKz1p45KhGlLALJGOG5GMcn5Kj5rWyf4XjJGNpECUMx0ujFsK0x7hNo5sgfcAH-gCvRpCFvR_R6TNvuJFTvsJonNLobbJnmx5SOqIpTUKaHXysPNHJo-Sa3qPlDVfFCl5zaDsKbqL44bvpXn2Kpkd6Q0KCmNH0davuvM6-rRYl72nIkLGARRmLwgwnj08nQ0Lo_W0cRAm88S07BU3uesho3LH_YZSOb9Di0zuaUtS4RH9IfN_3ye7HWoLtZrPdvGw3L8h1ZZ0RqnIDnP8_wON5Hz7O-0_kawAAAP__6U_5pw==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMktFO2zwYho_xVbzihPQXAf2qNKFWHITgbtlCihKPgRCy3MRpPdK4s52o6REX0SvslUxt6bRJG9uhrfd5v--R7fu4k8YqXQ8Q6vzZaJHPrq8glzKfNKoqpIGT1qHdpwjJKIOR2hTS8K9a1ZZXaq4cLvGuPwR8H4UsRVM5tKJq5AAXO0TWYlJJvlLTlZjuQFxCl-VvEV0T34deODVXK2l4YyWfKev01Ii5xUxYuJn8F2reVE7luuLWCfcXstK5qJTr-KGi4AthnHJK17Lgqi7kkttc1H-sKcuda6Gss9-qNwRF4_R2ZCtzp41ayTc2I2FKA0bBgquYYtFMKpWfdfDIUYMoYRdIxgzJ5zg-JUft683-FI6TjKVBlDAcL4yaC9Md4zaNboL0AZ_oA7wGQRb2fo2Wz7zlRpZ8idE4pdH7ZJ9te0jpiKY0CWl22GPpiS0eJdf0Hh1vuSqW8NpD7Si4ieKHn6Z7zSnaHukNCQliRtNXq-0XO_uhFiUfaciQsYBFGYvCDCePTydDQuj9bRxECbzxLTsFTe56yGi8zf6HUTq-QYcvH2hK0eAS_SHxfd8nuxfrCDbr9Wb9slm_INe1dUao2g1w_v8Aj-d9-DjvP5HvAQAA__-ZNPoJ

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8ktFO2zwYho_xVbzihPQXAf2qNKFWHITgbtlCihKPgRCyTOK0Hmnc2U7U9IiL6BX2Sqa2dNom1kNb7_N-zyfb93EnjVW6HiDU-YvRIp9eX0EuZP7cqKqQBk5ah3aXIiSjDEZqU0jDv2tVW16pmXK4xIf-EPB9FLIUTeXQiqqRA1xsEVmL50rypZosxWQL4hK6LN9FdL1l9NypmVpKwxsr-VRZpydGzOxh0vf_AmdN5VSuK26dcBZTYeGm8n2y0rmolOv4vqLgc2GcckrXsuCqLuSC21zU_6wpy617oayzP6oDqqJxejOylbnTRi3lATMSpjRgFCy4iinmzXOl8rMOHjlqECXsAsmYIfkax6fkqH272Z3CcZKxNIgShuO5UTNhumPcptFNkD7gC32A1yDIwt6f0fKFt9zIki8wGqc0-pjssm0PKR3RlCYhzfYeC09s8Ci5pvfoeMtVsYDX7mtHwU0UP_w23WtO0fZIb0hIEDOavm21-WZnv1aLks80ZMhYwKKMRWGGk8enkyEh9P42DqIE3viWnYImdz1kNN5k_8MoHd-gw7dPNKVocIn-kPi-75Pti3UE69VqvXpdr16R69o6I1TtBjj_f4DH8z58nPefyM8AAAD__4Y3-ms=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9q2zwYxo-rq3joSZ2PuuUjMEpCD1xX2by5TrG1rqUUodhyotWxMkk2cY56EbnCXMlI0oyN_WOHEs_v97wvku_jThqrdD1AqPNno0U-u76CXMp80qiqkAZOWod2nyIkowxGalNIwz9rVVteqblyuMSb_hDwfRSyFE3l0IqqkQNc7BBZi0kl-UpNV2K6A3EJXZa_RHS9Y_TCqblaScMbK_lMWaenRsztv5LzpnIq1xW3Tri_0L6PSueiUq7jB0vBF8I45ZSuZcFVXcglt7moMRMWbiZ_0pTlbopCWWe_VH8oFI3T28pW5k4btZK_VdaEhCkNGAULrmKKRTOpVH7WwSNHDaKEXSAZMyQf4_iUHLWvN_tTOE4ylgZRwnC8MGouTHeM2zS6CdIHfKAP8BoEWdj7MVo-85YbWfIlRuOURm-TfbbtIaUjmtIkpNlhjqUntniUXNN7dLzlqljCaw_aUXATxQ_ftXvNKdoe6Q0JCWJG09ettl_t7NtqUfKehgwZC1iUsSjMcPL4dDIkhN7fxkGUwBvfslPQ5K6HjMbb7H8YpeMbdPj0jqYUDS7RHxLf932ye7GOYLNeb9Yvm_ULcl1bZ4Sq3QDn_w_weN6Hj_P-E_kaAAD__7Wc-s0=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUkE9vGjEQxe_-FO_YVnUVoAk0KIft1pWQYJPCBuVmGe8A05o12LMo5dNXBPVS9Y96szy_38zT0xpLSplje4sy-m8pOr_99BH0TH7VcWgoQSgLjhdKqYWpkSimhpL9GrnNNvCOBXe4GYwBrdHQ2nVBcHSho1uMlNag1q0C2RNvTm7z4mHrMmRLv-KxPfNxL7zjEyXbZbJbzhI3ye3y_1i7Lgj7GGwWJ_8wQ_QusHy3P1c0du-SsHBsqbHcNvRss3d_jr1ev1TTcJZ8CLg7__y2D9dJPJ88kpeY-ER_SabKuSlqg4X58miq0mDfrQL7d5kOmE2qZTF9NOhhVjxdnh_6_cFg2L8a3Iyu3w-H16OrISZVOTczU9XoYVEX8xq9sVLm6WFaTCq8un-o38JUy9dYmKkpa7zB5_n9DJkOY6W11irToaPWk84UyMt5on4EAAD___odvKU=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9u2zYUxq_DpzjQTeVBqmUbGAIZAaa69KbNkQNJSxsEAUFJdMxVFj2S0mwPA4o9gy_3dH6SQfKfaG2SNRfxhQGd832Hh-Tv0LbhmknFReHCSKSfpKDp_P07YCuWJiXPMyZBM6Wh2qsQinAMkgmZMUl-E7xQJOcLruECvh8MAWwbMjajZa6honnJXDhHtg2soEnOyIbfb-h944M5VaDn7Eu5KGq9WGq-4BsmSakYmXOlxb2kC_US16LMNU9FTpSm-n-cuUhpzvWaHEtkZEml5pqLgmWEFxlbEZXSp9uezZqjybjS6vccLurIo-dBSy3qJSuWaiH5hj3TGRqF2IsxxN67CYZlmeQ8fbsCE51R8IP4HIJpDMGvk4mFzpJDZP81mgZRHHp-EIOxlHxB5dqAq9C_9MIb-AXfgEnBi0YdC535wXv8EVYkITxbgZkc42Pv0p_ctOwmtSDpoM4QIW8S4_DQVs3H21NvfvAzHsUQxV7sR7E_iuDNLQIA-LP5r39GKvJyUSjDhdtTsElQ4_R9Z7X0klHNMkK14YLRd3rnttOznR44PddxXMcxWuL6BniRapKKsqgNPcdppRuWSI2FXi9ZXa9tLso8PxnbNin-eCjYH_T6gyb3l_XNe0teZW9NK6-3PXT3Zvg4heuawvIrCqsXUlgeaWtJZ59IRSSbkRWMpyH2fwz22qoDIR7jEAcjHJ2mwaQPEK9JtYe4ehri0oLqeYjXj0LcPolrH384NlDt58KCpjB4EUR4UrsfojAOp5f_nRPrixU__IRDDAlcwGCIEP54NfH8AMzpVWwBDq47x6Lf7WtVQ2Tbto14UTBpN--pmUqhVAfBbvvPbvt5t_0MzYO1_iqy-uEw7HXm7_qed9vtQZCKQmlJeaFd6Pa7PRduuwOwoTu4Qy3ZjOeaSQWmliXroH8DAAD__1mA1jw=
