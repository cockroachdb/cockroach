# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO20oQhq_Zp_jlG5KjmNjJDXKEdExYdHxqHGRvKQgha-0sZFvHm-6uaUhViYfIE_IklQNNo0pF7QW-sDQz_zc7o39cFxdCG6nqAGNVftKKl7OTY4ilKItGVlOhYYWxuH9WEeK60ELpqdD5RyVrk1dyLi1m3MDOBKbiljeVxT2vGhHgsNWLmheVyFfybsXvNtTv5Kpu9Wph5VyuhM4bI_KZNFbdaT43f0PNm8rKUlW5sdy-RmaUYSqNNZ8rHEHd3o4A1_1VyBur2kfuRWmVlivxSkcyTmnIKFh4HFMsmqKS5cESHbLHESXsEMmEIXkfxz2yV7xknqPxJMlYGkYJg7PQcs71g4PzNDoL0yu8o1focITZuNsje1FyQi-xzItcTpfoFD_yp-FZFF_t4B3eQ9El3REhYcxo-jJWa-rBdrYo-Z-OGTIWsihj0TjD_jUBgK-bf_s5paqaeW2cANfb5KbAnW1809vRa8GtmObcOgGcgecfup7vej48P_C8wPOcHXHrgKxLm5eqqVvA97yd8uYG8tZO-7AQbb9duG6qagvuYlp9-dlwMPQHw03tW--PdyveZLfNKG-3HrnZHxFCL8_jMErQmZyzHmhy0UVG49bmf3CaTs6wxIf_aEpR4AjDEXFd1yWm5DWW_77cFcHTev20fnxaP6JUtbGay9oG6A_6foDr_hAu-sMb8j0AAP__km8zyg==

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO20oQhq_Zp_jlG5KjmNjJDXKEdExYdHxqHGRvKQgha-0sZFvHm-6uaUhViYfIE_IklQNNo0pF7QW-sDQz_zc7o39cFxdCG6nqAGNVftKKl7OTY4ilKItGVlOhYYWxuH9WEeK60ELpqdD5RyVrk1dyLi1m3MDOBKbiljeVxT2vGhHgsNWLmheVyFfybsXvNtTv5Kpu9Wph5VyuhM4bI_KZNFbdaT43f0PNm8rKUlW5sdy-RmaUYSqNNZ8rHEHd3o4A1_1VyBur2kfuRWmVlivxSkcyTmnIKFh4HFMsmqKS5cESHbLHESXsEMmEIXkfxz2yV7xknqPxJMlYGkYJg7PQcs71g4PzNDoL0yu8o1focITZuNsje1FyQi-xzItcTpfoFD_yp-FZFF_t4B3eQ9El3REhYcxo-jJWa-rBdrYo-Z-OGTIWsihj0TjD_jUBgK-bf_s5paqaeW2cANfb5KbAnW1809vRa8GtmObcOgGcgecfup7vej48P_C8wPOcHXHrgKxLm5eqqVvA97yd8uYG8tZO-7AQbb9duG6qagvuYlp9-dlwMPQHw03tW--PdyveZLfNKG-3HrnZHxFCL8_jMErQmZyzHmhy0UVG49bmf3CaTs6wxIf_aEpR4AjDEXFd1yWm5DWW_77cFcHTev20fnxaP6JUtbGay9oG6A_6foDr_hAu-sMb8j0AAP__km8zyg==

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lM9u2kAQxs_Zpxj5ElPZwcAlMopUhyytW2Ii200TRZG1NkvYxnjp7toFqkpRn4Fjn44nqWwIsZo_ag7hgLQzv2884_nWpgnnVEjGMxt6PLkVnCSTk2Ogc5rEOUtHVICiUkGxoRAyTRCUixEV0TfOMhmlbMoUTIgENaEwomOSpwoKkubUhsOSpxmJUxot2c2S3FSq53CelTyfKTZlSyqiXNJowqTiN4JM5WtU0zxVLOFpJBVRLykDHMKISSW_p3AEfDzuApjmvyDJFS8fUtBEccGW9IWKqOdjJ8QQOscDDLM8TllyMAcd7RFwvfAQvGEI3pfBwEB78TayOfWGXhD6juuFoM0EmxKx0ODMd08d_xI-40vQCThBr2GgPdc7wRcwj-KIjeagx_fxvnPqDi5rcp0YEDdQo4uQMwixv22rXOrBrjfX-4R7IQShE7pB6PYC2L9CAAA_q__ypyU8zaeZ1Gy42gWrBNF252ujxgtKFB1FRGk2aG2rdWhaLdNqgdWyLcu2LK0GlxtgWaKihOdZKWhZVi1deSAq16kWM1rWq4uzPE13wrpM8B8PBdudVrtT5X4Z_z1b_CazVa283Xjoer_7tAsXpQvzRy4sXunC_N5tNXR8GxWRoONoDv2hj90P3oYtGuDjPvax18PB7jbo5MHEi6jYmLh43sS5AcXLJl48aeLqTeCLs4HjeqAPz0IDsHfegAAPSvYd9P3hKcwNWMDXj9jHEMMRdLrINE0TsSyjwqy-V3oiuJQNBOvVn_Xqbr26A5mQDBaPIvP320tZZn6X-1ivVlsg4ZlUgrBM2dBsN1s2XDU7YEKzc41q2JiligoJuhI5baC_AQAA__9FOqF4

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k9FO2zAUhq_xU_zKDe2UoBRuUCsuQglStpCixkMghCIndak31-5sB0qnSTxEL_d0PMmUwLpqEmi7IBdRfP7_OzlHfxIEuODGCq36GOrqq9Gsmp0cgy95VdZCTriB49bh7tlFSBDAcG0m3BRftFC2kGIuHGbMws04JnzKaulwx2TN-zhs_FyxUvJiJW5X7LalXrNr1fj1wom5WHFT1JYXM2GdvjVsbv-HmtfSiUrLwjrm3iLzmGIirLPfJI6gp9MBEAR_G1ntdPOSO145bcSKv9GRDMdxRGPQ6DiNsahLKaq9JTpkhyHJ6CGyEUX2OU19slO-VJ5Pw1GW03GUZBTewog5Mw8ezsfJWTS-wqf4Ch2GKB92fbKTZCfxJZZFWYjJEp3yd_00OkvSqy28w3yUXdIdEBKlNB6_jNWEureZLck-xkOKnEY0yWkyzLF7TQDge3tvLq_Ssp4r6_VxvSm2AvM25xt_y284c3xSMOf14e2HvcMg7AVhD2GvH4b9MPS2zE0CQlWuqHStGqAXhlty-w0UTZzuYcGbftuwqqXcgNuY0fd_Gu4f9PYPWu2H_8-7le-yWzvK-61HbnYHhMSX52mUZOiMzqmPOLvoIo_TJuYPOB2PzrBElEMr7j8_uXs9IEEQBEQoxU3Q_qedymhruwRP659P68en9SNsxRSWuGb2SCt-84rk7nUrrV-kqZCOG4uOMzXvkl8BAAD__6KvTD4=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9u2jAYR6_rp_ipNw0TKZqQpgrERZqaLVsIKPG6oqqKTDDgNcTMfyLgqg_BE_IkU0Y7bdNUqZe2zvk-H8m-j1uhjVRVD6EqHrXixermGmIripmT5VxoWGEs6hNFSEYZtFB6LnT-XcnK5KVcS4sBPnT7gO9jLhbclRY1L53o4Yr4PkTFZ6XI93K558tfHlbcwK7Ev7iqGl5trFzLvdC5MyJfSWPVUvO1eYu1dqWVhSpzY7l9zWyS5tJY86PEAGqx-G8Hd1Y1S2pRWKXlXrwykYQpDRgFC65jio2blbK43MEjZw5Rwq6QjBmSr3HcJmf1883pFI6TjKVBlDCcb7Rcc707xySNRkE6xRc6hecQZGHrb3TxmNe5Fot8i-E4pdHH5MTWLaR0SFOahDR7ecfW440eJTf0Dru8zuV8C69-GTsMRlE8_WO759qoW6TVJySIGU2fq5pvcfk7LUo-05AhYwGLMhaFGS7uHy76hNC7SRxECbzxhLVBk9sWMho37DsM0_EIO3z7RFMKhwG6feL7vk9MwSvsCI6Hw_HwdDw8oVCVsZrLyvbQed_DfacLH53uA_kZAAD__4Hu3n0=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9u2jAYR6_rp_ipNw0TKZqQpgrERZqaLVsIKPG6oqqKTDDgNcTMfyLgqg_BE_IkU0Y7bdNUqZe2zvk-H8m-j1uhjVRVD6EqHrXixermGmIripmT5VxoWGEs6hNFSEYZtFB6LnT-XcnK5KVcS4sBPnT7gO9jLhbclRY1L53o4Yr4PkTFZ6XI93K558tfHlbcwK7Ev7iqGl5trFzLvdC5MyJfSWPVUvO1eYu1dqWVhSpzY7l9zWyS5tJY86PEAGqx-G8Hd1Y1S2pRWKXlXrwykYQpDRgFC65jio2blbK43MEjZw5Rwq6QjBmSr3HcJmf1883pFI6TjKVBlDCcb7Rcc707xySNRkE6xRc6hecQZGHrb3TxmNe5Fot8i-E4pdHH5MTWLaR0SFOahDR7ecfW440eJTf0Dru8zuV8C69-GTsMRlE8_WO759qoW6TVJySIGU2fq5pvcfk7LUo-05AhYwGLMhaFGS7uHy76hNC7SRxECbzxhLVBk9sWMho37DsM0_EIO3z7RFMKhwG6feL7vk9MwSvsCI6Hw_HwdDw8oVCVsZrLyvbQed_DfacLH53uA_kZAAD__4Hu3n0=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMkt9qGk0Yxo8zV_GQk6wf2YQPoQTFg81mbLddV9mdppEQhnEddZp1x86fRT3KRXiFXkkxJqWFIj2c4fd73-eBNwxxL41Vuu4g1uWz0aJc3N1CrmU58aqaSgMnrUNzpAgpKIOR2kyl4d-1qi2v1FI59PCh3QXCEFM5E75yaETlZQc3r4qsxaSSfKvmWzF_FdGDns3-quiahCH0yqml2krDvZV8oazTcyOWFgth4RbyX6ylr5wqdcWtE-6Uecg4VdbZH9WJYMI7fVjSyNJpo7byxEQS5zRiFCy6TSlWflKp8mqDgJx5JBm7QTZkyL6m6SU5a95-jq94mBUsj5KM4Xxl1FKYzTlGeTKI8jG-0DECj6iIW3-is2fecCNnfI3-MKfJx-zINi3ktE9zmsW0eM-xDsRBT7I7-oANb7iarhE072P70SBJx79tD_wlmhZpdQmJUkbzt1aH07j6VS3JPtOYoWARSwqWxAUuHp8uuoTQh1EaJRmC4Yhdgmb3LRQ0PbD_oZ8PB9jg2yeaU3j00O6SMAxDYktRY0Ow3-32u5f97gWlrq0zQtWug-v_O3i8biPEdfuJ_AwAAP__FkPe3w==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8kt9u2jAYR6_rp_ipNw0TKZqQpgrERZqaLVsIKPG6oqqKTDDgNcTMfyLgqg_BE_IkE9BO27Rxaeuc7_iT7Pu4F9pIVXUQquJZK14s7m4h1qKYOFlOhYYVxqI-UYRklEELpadC59-VrExeyqW06OFDuwv4PqZixl1pUfPSiQ5ujoqo-KQU-VbOt3x-FNGDms3-qajq6KiVlUu5FTp3RuQLaayaa740503f_0tcutLKQpW5sdwaLLiBXYj_NKfSWPOjPJPgzqpDpBaFVVpuxZmJJExpwChYcBtTrNyklMX1Bh65cIgSdoNkyJB8jeMmuahfb06ncJhkLA2ihOFypeWS680lRmk0CNIxvtAxPIcgCxt_orPnvM61mOVr9IcpjT4mJ7ZuIKV9mtIkpNnbO9YeP-hRckcfsMnrXE7X8Oq3sf1gEMXj3-qea6JukEaXkCBmNH3d6vA9rn-tFiWfaciQsYBFGYvCDFePT1ddQujDKA6iBN5wxJqgyX0DGY0P7Dv00-EAG3z7RFMKhx7aXeL7vk9MwStsCPa73X73st-9oFCVsZrLynbQet_BY6sNH632E_kZAAD__-en30E=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9qGkEUxq8zT_GRm6wlm1CEEpRcbDZju-26yu40jYQwjOuo06w7dv4s6lUewif0SYqalBZCaS9n-P2-cz44YYg7aazSdQexLp-MFuX89gZyJcuxV9VEGjhpHZojRUhBGYzUZiIN_65VbXmlFsrhGh_aXSAMMZFT4SuHRlRednB1UGQtxpXkGzXbiNlBxDX0dPqmouuDo5dOLdRGGu6t5HNlnZ4ZsbD_ay585VSpK26dcP9gT5R19kf1F1B4p0kYopGl00ZtJObCws3lG4kkzmnEKFh0k1Is_bhS5cUaATnxSDJ2hWzAkH1N03Ny0rz8HF_xICtYHiUZw-nSqIUw61MM86Qf5SN8oSMEHlERt_5Ep0-84UZO-Qq9QU6Tj9mRbVrIaY_mNItp8brHKhB7Pclu6T3WvOFqskLQvMb2on6Sjn6bHvhzNC3S6hISpYzmL632J3Lxq1qSfaYxQ8EilhQsiQucPTyedQmh98M0SjIEgyE7B83uWihoumffoZcP-ljj2yeaU3hco90lYRiGxJaixppgt93uts-77TNKXVtnhKpdB5fvO3i4bCPEZfuR_AwAAP__-3zfow==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUj09r20AQR-_7KX7HtnRLbDWRG5ODqm7BYCmppJjcxHo1trZdaaP9Y4o-fVFzKyWQ28C8N8PjHAdyXtvxFrlVv5yVqv_2FfSb1DFq05FDIB9weaEYq0UDR9Z15NqfVo--NXrQAXe4SbYA5-joJKMJuEgT6RYbxjlolEdD7azPszz_9dBLj9DTv7gdF94-Bz3omVwbPbW99sGenRz8W6whmqCVNa0PMrxmLkmd9sFPBnewp9N_O2QMdnlyIRWs0zO9cpHllcgagVr8eBRlLvAcj0arT54mFLvykO0fBVYosqeX8ct6nSTp-iq52Vx_TtPrzVWKXZlXohBlgxXqJqsarLaMiaeHfbYr8e7-ofkIUR7eoxZ7kTf4gO_VfQFP05ZxzjnzNEUaFXFPhlRYNuxPAAAA___3pKF7

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNtuo0gQfU5_RYmX4BXE2JZWEVakJU57l10HR8DmoihCDW7HvcG0t7thbI9GiuYb_Dhf5y8ZgS9hkkw0eQgPSF11zukq6hSmCZdUSMYzG3o8eRCcJJOzU6BzmsQ5S0dUgKJSQbFBIRTgEATlYkRF9B9nmYxSNmUKTuD3ThfANGFExyRPFRQkzakNx8g0gWYkTmm0ZPdLcl_xYEIkqAl9DudZieczxaZsSUWUSxpNmFT8XpCpfA9rmqeKJTyNpCLqLWbZ0ohJJf9P4QT4ePxqHyRXvLykoInigi3pG4qo52MnxBA6pwMMszxOWXI0Bx0dEHC98Bi8YQjev4OBgQ7ibWRz6g29IPQd1wtBmwk2JWKhwYXvnjv-DfyDb0An4AS9hoEOXO8MX8M8iiM2moMe7-J959wd3NToOjEgbqBGFyFnEGJ_W1Y516N9ba73N-6FEIRO6Aah2wvg8BYBAHyu3uWjJTzNp5nUbLjdB6sE0fbnO6OGF5QoOoqI0mzQ2lbr2LRaptUCq2Vblm1ZWg1cToBliYoSnmcloWVZtXTlgagcp1rMaKlXJ2d5mu6JdZrgn54E251Wu1Plvhi_3Fv8Ib1VpXxce-jusPu6CxelC_MXLize6cJ857YadPwQFZGg42gO_aGP3T-9DbZogI_72MdeDwf7bdDJk4kXUbExcfFzE-cGFG-bePGqietf4tLFV7sCis1eGFAJgxNAgAcl-ykKfX94_uOeGM9uvPoL-xhiOIFOFyF8fTFwXA_04UVoAPYuGzvR3zZaRReZpmkilmVUmNV_UE8El7KBYL36tl49rlePIBOSweJFZP7HdtnLzNdyzuvVagtIeCaVICxTNjTbzZYNt80OmNDs3KEabMxSRYUEXYmcNtD3AAAA__8RH7sS
