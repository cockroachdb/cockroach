# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu6jYYx6_rp_iUmwMTGQncVEFHWg4n1bLRUEHWtaoqy0kMeBg7cxwITJP6EDxhn2RyQls2iaJqKhdI_vL_ff77-zuxbbilqmBSeDCU6VJJki6-fwNa0TQpGc-oAk0LDetGhZBtg6JSZVThPyQTBeZsxTQsSAF6QSGjM1JyDWvCS-rBpdFTQRJO8Y7Nd2ReU6fkUhi9zDVbsR1VuCwoXrBCy7kiq-Ij1KrkmqWS40ITfYbkMiWc6S1-aZHhnCjNNJOCZpiJjFa4SMkZ27mSOZkTTTETealxPSQm5iep2azB6IwqzKVclvlhpjOp8Gx52nZDMqGpWhNe6C2nuJlydobJiInzA3pWEM7lBs9KzrGugzSjOOeNEzWnDWTkWMnNScR1HMcwqSx00xxvmF7ggwzXMbIdfW_LaRAbr7r4k8NXUxkAGPv_VpJSS7PTmqZaqvdaCoSGk8CPA4j9b6MA8jLhLP2xgha6IBBG8SVE4xii30ajDrpIDpVmNRxH03jih1EMFc6XdAs3k_Dan9zDr8E9tAj402G7gy7C6HtwBxVOMMsqaCUv9Sv_Ohzdg5UrtiJqa0GLdCBpo_YAIX8UB5P_egqjX4JhDNPYj8NpHA6n8OUBAQD8Vf-bn0XW83qIlgdO562cSl6uRGF58PBabPTW6_rxWK8o0TTDRFseWD3HvbQd13ZccFzPcTzHsY7EJhAmUpNgKQzgOsd71292na7e5saYdQwLc3dewGNMyc1bw17f7fXrZ393_u-Rk085cu3w806NHr8MEArubkZ-GEFrfBN3IIhu2zANRuZS_ABXk_E1VPD7z8EkgAS-Qn-AbNu2Uf1Jq346XEAEz_v98_7pef8EqRSFVoQJ7UG313U9eOj2wYZu_xH9EwAA___co-HC

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ldFu2zYUhq-rpzjQTe3BWuT4JlBQYKrLbNocOZC1rkEQEJRE2VxoUiMpxcowoNgz-HJPlycZKDmJu8YNiqG-MKCj7yd_nvPT9jx4T5VmUgQwlfmNkiRfvXsLdEPzrGa8oAoM1QaannIczwNFpSqowr9LJjTmbM0MrIgGs6JQ0JLU3EBDeE0DOLE8FSTjFN-x5R1ZdqpDuBSWl5Vha3ZHFa41xSumjVwqstZfo1rX3LBccqwNMS8oucwJZ6bFD0sUuCLKMMOkoAVmoqAbrHPygu1KyYosiaGYiao2uGsSE8uDqrLsZbSkCnMpb-pq19NSKlzeHLbdK5kwVDWEa9NyivsuFy9oCmLH-RU804RzeYvLmnNsukHaVrzkjRO1pL3I4ljJ24OSse_7VpNLbfrF8S0zK7zDcDdGdke_tOUCpdar0X9weGMrpwDW_qckqY20OzU0N1J9aUnhONMEhSmCNHw7Q1DVGWf59xsYOK8IRHF6AvE8hfjX2WzkvMp2lf5pOo8XaRJGcQobXN3QFi6S6DxMLuEXdAkDAuFiOhw5r6L4HfoAG5xhVmxgkD3Uz8LzaHYJbqXYmqjWhQEZQTZ0hqeOE85SlPzXUxT_jKYpLNIwjRZpNF3A6ysHAODP7tt-XNIsuya6Afijp3Iueb0W2g3g6rHY8-7j8_U-rygxtMDEuAG4x_74xPPHnj8Gfxz4fuD77h5sB8JEbidYCysY-_t7dze7m65pK2vM3RcLm50H4b5MydunBY8n4-NJ9-6v0f89cvZNjtw5_Handq5fnz6f1dZmtf4sq82hrLbPZLV-yOQnXINLS57NExT9GPdkM4QEnaEExVO0eIzmgDwF3eq6oDeHg16PoDkY9PbZoHfnRx8uZmEUw2B-kY4Axe-HsEAzy34HZ8n8HDYjaOG3n1CCIIM3MDl1PM_zHCYEVV73lzTIldR66MD99p_77cf77UfofvPbzyqbH3Z31r75207hfrvdAbkU2ijChAng6PhoHMDV0QQ8OJpcO3tYybihSsPAqJoOnX8DAAD__3W7TB0=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lFFv2zYQx5_DT3HQS-3BGuT0JXDQB9VVAW2OElha0SAICEo62VxoUiMpW_YwoB_Cj_t0-SQDJaf1BrhGMcQPhnn3_x3_vKPp-_AJteFKTmCqiietWLH88B6wxSJvuChRg0VjYd2rCPF90Kh0iZr-rrg0VPAVt7BkBuwSocSKNcLCmokGJ3Dl9ChZLpDu-GLHFh11Sq6k06va8hXfoaaNQbrkxqqFZivzI9SqEZYXSlBjmT1DClUwwe2WvpQoac205ZYriSXlssSWmoKdsV1rVbMFs0i5rBtLuyZxuThJVVWPYYWaCqWemvrQ00ppWj2dtt2TXFrUayaM3QqkfZfLM0zJ3Dh_QM8NE0JtaNUIQW03SNeKc94E0wvsISenWm1OIuMgCBxTKGP74nTD7ZIeZLQbI9_h97ZMo8x5teYPAe9c5BrA2f-3kjVWuZ3WWFilv1dSEjKdR2EWQRa-n0VQN7ngxc8tDMgFgzjJriC5zSD5bTYbkYv8EOlX09skzeZhnGTQ0voJt3A3j2_C-T38Gt3DgEGYTocjchEnH6LP0NKc8rKFQf4S_xjexLN78GrNV0xvPRiwEeRDMrwmJJxl0fy_nuLkl2iaQZqFWZxm8TSFNw8EAODP7tt9PLZedE30JhCMvoULJZqVNN4EHr4Ge733df14rNfILJaUWW8C3mUwvvKDsR-MIRhPgmASBN6R2A2Ey8JNsJEOGAfHe3f_7G66dls7Y94xLN3deQGPMa023wpevh1fvu1yf43-75HzVzly5_D1Tk0e31wTEn2-m4VxAoPbu2wEUfJpCGk0c5fiJ_g4v72BFsIUlMRR_8tu1DXxfd8nXErUfvcoDwqtjBkSeN7__bz_8rz_At2r18IDM--UxMcTKbtRXWp_SFVcWNQGBlY3OCT_BAAA___pUfo2

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk89O4zoUh9f4KY7Y0F6RC6jSCLViEYI7k5mQosTDgBCyTOK0nrpxxn9C0xUP0SfkSUZJYIMGKpaxvu_45HeOPQ-uuTZClWMIVLbUimWLi3Pga549OCFzrsFyY6HuKYRSTEBzpXOu6W8lSkOlWAkLZ_BlNAHwPMh5wZy0UDPp-BhOkecBL9mD5HQj5hs27zxYMAN2wd_iqmx5VVmxEhuuqTOcLoSxaq7ZynzGWjlpRaYkNZbZHaZUGZPCNvS1RE4rpq2wQpU8p6LM-ZqajO1ou9KqYnNmORVl5SztYhLl_F2rKHqNF1xTqdTSVS-pFkrTYvl-270pSst1zaSxjeS0Tznf4eSsnegneGGYlOqRFk5KartBtlHs6k0yPee91OJUq8d3lZPj4-PWyZSxfXH6KOyCvmC0G6PY8I-ubDczF8aaPxLO2pN_riNzVrU31TyzSn9UskQoSLBPMBD_PMJQuQcpsv8bGKA9B2FMTiGeEYh_RtEh2qtfTvqvYBanJPHDmEBDqyVv4CoJL_3kFn7gWxg48NNg-JaradGS01mCw69xT9ZDSPAUJzgOcPrawnrAWjmML_BN54l8DYP6tejUvwyjW9ivtFgx3ezDwB1CPUTDCUJ-RHDy9ofC-DsOCKTEJ2FKwiCFg7v7gwlC-OYq8sMYBrMrcgg4vh5CiqOW_Q-myewSGvj1DScYHJzBaII8z_NQ90waBM_b7fP26Xn7BJkqjdVMlHYMRydjuDsagQdHo3v0NwAA__-DroEQ

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk89O4zoUh9f4KY7Y0F6RC6jSCLViEYI7k5mQosTDgBCyTOK0nrpxxn9C0xUP0SfkSUZJYIMGKpaxvu_45HeOPQ-uuTZClWMIVLbUimWLi3Pga549OCFzrsFyY6HuKYRSTEBzpXOu6W8lSkOlWAkLZ_BlNAHwPMh5wZy0UDPp-BhOkecBL9mD5HQj5hs27zxYMAN2wd_iqmx5VVmxEhuuqTOcLoSxaq7ZynzGWjlpRaYkNZbZHaZUGZPCNvS1RE4rpq2wQpU8p6LM-ZqajO1ou9KqYnNmORVl5SztYhLl_F2rKHqNF1xTqdTSVS-pFkrTYvl-270pSst1zaSxjeS0Tznf4eSsnegneGGYlOqRFk5KartBtlHs6k0yPee91OJUq8d3lZPj4-PWyZSxfXH6KOyCvmC0G6PY8I-ubDczF8aaPxLO2pN_riNzVrU31TyzSn9UskQoSLBPMBD_PMJQuQcpsv8bGKA9B2FMTiGeEYh_RtEh2qtfTvqvYBanJPHDmEBDqyVv4CoJL_3kFn7gWxg48NNg-JaradGS01mCw69xT9ZDSPAUJzgOcPrawnrAWjmML_BN54l8DYP6tejUvwyjW9ivtFgx3ezDwB1CPUTDCUJ-RHDy9ofC-DsOCKTEJ2FKwiCFg7v7gwlC-OYq8sMYBrMrcgg4vh5CiqOW_Q-myewSGvj1DScYHJzBaII8z_NQ90waBM_b7fP26Xn7BJkqjdVMlHYMRydjuDsagQdHo3v0NwAA__-DroEQ

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk99O2zwYxo_xVbzihPYT-QBVmlArDkJwt2whRUnGQAhZJnFar66d-U9oesRF9Aq5kikJnKBRtsNEv9_jN8_reB5cM224kmMIVL7UiuaLi3Nga5Y_OC4KpsEyY6HuKYRSnIFmShdMk5-KS0MEX3ELZ_BpNAHwPChYSZ2wUFPh2BhOO4VJ-iAY2fD5hs47Ec5AleUfFSWR54GqLF_xDdPEGUYW3Fg113RlYEEN2AX7G2vlhOW5EsRYaj8whcqp4LYhrxEFqai23HIlWUG4LNiamJzK3TGVVhWdU8sIl5WzpKuKy_m7Vln2GiuZJkKppatemi2VJuXy_bF7k0vLdE2FsY1gpC-6-MApaLvVf-C5oUKoR1I6IYjtdtlW8dFsguo566UWJ1o9vqucHB8ft06ujO3DySO3C_KCkW6NfMN2HdletYIba36JHfeLOqvak2qWW6V3RUqEggT7GYbMP48wVO5B8Pz_BgZoz0EYZ6cQzzKIv0fRIdqrX970T8EsTrPED-MMGlItWQNXSXjpJ7fwDd_CwIGfBsO3XE3KlpzOEhx-jnuyHkKCpzjBcYDT1xHWA9rKYXyBbzqPF2sY1K-hU_8yjG5hv9J8RXWzDwN3CPUQDScI-VGGk7cfFMZfcZBBmvlZmGZhkMLB3f3BBCF8cxX5YQyD2VV2CDi-HkKKo5b9D6bJ7BIa-PEFJxgcnMFogjzP81D3mzQInrfb5-3T8_YJciWN1ZRLO4ajkzHcHY3Ag6PRPfodAAD__8JdgXI=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk81O4zwUhtf4Ko7Y0H4iH6BKI9SKRQjuTGZCipIMA0LIMonTeuraGf-EpisuolfIlYySwAZB0SwTPc_rk_c4ngfXTBuu5BgClS-1ovni4hzYmuUPjouCabDMWKh7CqEUZ6CZ0gXT5Lfi0hDBV9zCGXwZTQA8DwpWUics1FQ4NobTTmGSPghGNny-ofNOhDNQZfmuomTnqMryFd8wTZxhZMGNVXNNV2a36XlvxJUTludKEGOpNbCgBuyCvW8KlVPBbUNeIwpSUW255UqygnBZsDUxOZW7YyqtKjqnlhEuK2dJVxeX8w-tsuw1VjJNhFJLV720WypNyuXHY_cml5bpmgpjG8FIX3bxiVPQdrP_wHNDhVCPpHRCENvts63is9kE1XPWSy1OtHr8UDk5Pj5unVwZ24eTR24X5AUj3Rr5hu06sr06BTfW_BE7bgp1VrUn1Sy3Su-KlAgFCfYzDJl_HmGo3IPg-f8NDNCegzDOTiGeZRD_jKJDtFe_vOmfglmcZokfxhk0pFqyBq6S8NJPbuEHvoWBAz8Nhm-5mpQtOZ0lOPwa92Q9hARPcYLjAKevI6wHtJXD-ALfdB4v1jCoX0On_mUY3cJ-pfmK6mYfBu4Q6iEaThDyowwnbz8ojL_jIIM087MwzcIghYO7-4MJQvjmKvLDGAazq-wQcHw9hBRHLfsfTJPZJTTw6xtOMDg4g9EEeZ7noe43aRA8b7fP26fn7RPkShqrKZd2DEcnY7g7GoEHR6N79DcAAP__PjmB1A==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk89O4zoUxtf4KY7Y0F6RC6jSFWrFIgT3TmZCipIMA0LIMonTeuraGf8JTVc8RJ-QJxklgQ0CKpaJfr_PJ-eLPQ-umTZcyTEEKl9qRfPFxTmwNcsfHBcF02CZsVD3FEIpzkAzpQumyW_FpSGCr7iFM_hvNAHwPChYSZ2wUFPh2BhOO4VJ-iAY2fD5hs47Ec5AleW7ipKdoyrLV3zDNHGGkQU3Vs01XZmvmisnLM-VIMZSu8P2PBAqp4LbhrymFKSi2nLLlWQF4bJga2JyKmFBDdgFez-m0qqic2oZ4bJylnQr43L-oVWWvcZKpolQaumqlw2XSpNyaXaYXFqmayqMbQQj_cKLHU5B23a_wHNDhVCPpHRCENt12q5i12yC6jnrpRYnWj1-qJwcHx-3Tq6M7cPJI7cL8oKRrkm-YZ8d2f4EBTfW_BGf9E2dVe1JNcut0p9FSoSCBPsZhsw_jzBU7kHw_N8GBmjPQRhnpxDPMoh_RtEh2qtf3vRPwSxOs8QP4wwaUi1ZA1dJeOknt_AD38LAgZ8Gw7dcTcqWnM4SHP4f92Q9hARPcYLjAKevI6wHtJXD-ALfdB4v1jCoX0On_mUY3cJ-pfmK6mYfBu4Q6iEaThDyowwnbz8ojL_jIIM087MwzcIghYO7-4MJQvjmKvLDGAazq-wQcHw9hBRHLfsPTJPZJTTw6xtOMDg4g9EEeZ7noe6aNAiet9vn7dPz9glyJY3VlEs7hqOTMdwdjcCDo9E9-hsAAP___GiCNg==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAQx9_zKe5xm5YJylpYUR8Y8yQkSDtIUd8s41zCDWMH-wwtn34K6V6mUdS3KP797k7_uzSFJfpAzt7C2OmNd0qvf3wHfEa9imQK9MAYGPYtlSQLkYNH5wv08rcjG6ShLTHcwU1vCJCmUGCpomHYKxPxFgZJmgJatTIoj1QdVXXyYK0C8Br_xZ1teFczbemIXsaAck2BXeXVNrzH2kbDpJ2RgRVfMI3TyhC_yL8lClkrz8TkLBaSbIHPMmh1Yezau1pVilGSrSPLU0xkq7NWWbYaluilcW4T69dUS-dluTk_dmuSZfR7ZQK_GJRtysUFp1DNRt_BU1DGuIMsozGST4tsorg0m1G-wlZqcOnd4azS7XQ6jaNd4La4PBCv5SsmT2ukI77VsrnMggKHnYG75s9_z1FFdk2nPWp2_q2SNknGczHKBSzEr0eRjQXUcWVIfwm4g9kkW46mjwK6MBs9tZ_frq56vf5Vp3czuP7a718POn2YZOO5mIkshy4s8tE8h-4wScTTw3Q0yeDD_UP-GUS2_AgLMRXjHD7Bz_n9DALuhkmapmkScBfRakwDGtTcvCR_AgAA__-To0dw

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0Vd1u2zYUvg6f4kA3tQepkWNgKGwEmOoymzZHDmQtbRAEBC3RNhda1EhKsTIMKPYMvtzT5UkGSnbitnGDYqgvDPDw-87vd0TPg0umNJf5AEYyvVWSpst3b4GtWToruciYAsO0gapFITTFCSgmVcYU-UPyXBPBV9zAKfzYHwJ4HmRsTkthoKKiZAN4gzwPWE5ngpF7vrini4YHS6rBLNnncJlbvCwMX_F7pkipGVlybeRC0ZX-FtaqFIanUhBtqHmBKWRKBTc12bnISEGV4YbLnGWE5xlbE53SF9IulCzoghpGeF6UhjRt4vniIGs-b2lszhQRUt6Wxbarc6nI_PZw2i2T54apigptasFI2-XsBU5G7US_Ac81FULekXkpBDHNIG0rXspNULVgLcnCiZJ3Byk93_ctJ5XatM7JHTdLsoWRZoz8nn0tpFVmxrXRfwo4tZZn5UhLI22kiqVGqq-5zBEaxThIMCTB2zGGopwJnr5eQwcdUQij5A1EkwSi38djFx3Ntpb2NJpE0yQOwiiBNSluWQ0XcXgexFfwG76CDoVgOuq66CiM3uEPsCYzwrM1dGY7-1lwHo6vwCkUX1FVO9ChLsy6qDtEKBgnOP48pzD6FY8SmCZBEk6TcDSFV9cIAOCv5t_-HFotmiY6A_DdJ3MqRbnKtTOA60dji3cezzf7eMWoYRmhxhmAc-L33nh-z_N74PcGvj_wfWcPbAfC89ROsMwtoefvx242u5muqQubmLNPzq12dsR9mpJ3Tw5P-r2TfnP3t_t_S559l5KbDL9f1ejm1fB5rdZWq-UXWq0OabV-RqvlTpOf4Coyt8izSYzDn6MWWXUhxmc4xtEITx-l2aFPQre8RujVYaGXLlQHhV4_K_T9-i9D_H6HrppVtcvpoqPSFo66EExhisfWh10pF2w8OIsn581D93qXtvvJsYb3v-AYwwxOoT9ECH-4GAdhBJ3JReICji67O6c_tL6qIfI8z0M8z5nymgevkyqpdRfBw-bfh83Hh81HaF6U-gvL-qftF8He_GNn_LDZbAGpzLVRlOdmAMcnx70BXB_3wYPj_g3ag825MExp6BhVsi76LwAA__9onmWt

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkkFr20wQhs_eXzHkEvvD-nAplBCTg6IqoFaWjbQNNaUsG2kkb73WqrsjO_avL5JSKKWOyXV4npnhnfE8eETrlKlvITD51hqZbz7eAz5j_tQqXaAFQkewHyjGspCDRWMLtOKHUbUTWu0UwR18eD8H8DwosJStJthL3eIt3DDPA6zlk0ZxUtVJVr0HG-mANvg3buqONw2pnTqhFa1DsVGOTGXlzr3F2rWaVG60cCTpgqlNLrWio_jdohCNtKRImRoLoeoCn4XL5YW1G2saWUlCoeqmJdHHpOrqrFWWg4YlWqGN2bbNS6qlsaLcnl97MFVNaPdSOzpqFEPKxQWnkN1F38ArJ7U2B1G2WgvqD9lFcWk3LW2Fg9ThwprDWeXdbDbrnNw4GpqLg6KNeMFEf0Z1wtdGdp9ZKEfup4a7rvLPd5QtmW7SHnMy9rWWNWNBGvo8BO7fxyG4_wnGbCQhSvgNJEsOyZc4nrJRsEwynvpRwoFEs8UjrNJo4adr-ByuYSzBz4LJlI0e_EUUr-GqsWon7fEKxnLCJnPG_JiH6R9TouRTGHDIuM-jjEdBBtffvl_PGQu_rmI_SmC8XPEphMnjBLIw7tj_4CFdLjp7zjzP81j_rMR-BQAA__-oFVBT
