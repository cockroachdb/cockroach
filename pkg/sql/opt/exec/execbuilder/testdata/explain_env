# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ks9O20wUxdfMUxx5Q_IpJnayQUafVBOM6tY4yHEpCKHR2B7ItPZMNB5TQ1WJh8gT8iSVTZpmg9ou8MLS3Ht-V-f-sW1ccF0LJT3MVP5VK5YvT47BW55njSgLrmF4bXD_oiLEtqG50gXX9IsSsqalqITBktUwS46C37KmNLhnZcM9HHZ6LllWcvoo7h7ZXU-9Jley06uVEZV45Jo2NadLURt1p1lV_wtVNaURuSppbZj5A8nbFdei4tKwkm7M9jzNVdlUkgp5z7XhBRWy4C1_vdztLSGzJPDTAKl_HAVYNVkp8oMWA7LHEMbpIeJ5ivhTFI3IXraJvLxm83iRJn4Yp7BWWlRMP1g4T8IzP7nCx-AKAwZ_MRuOyF4YnwSXaGlGRdFikP2Kn_pnYXS1gw_YCNmQDI8I8aM0SDa2upUebL2F8YdglmKR-mm4SMPZAvvXBAC-9__us14mUVserrfBPsGs7ftmtKPXnHUTY8byYE0c99B2XNtx4bie43iOY-2IC1EbIXNDc9XIDnAdZyfdX0C3C2oeVryrtwvLpiy34C6m1bffBSdTdzLtcz9Gf91b9ia99Vberj1ys39ESHB5HvlhjMH8PB0hiC-GWARRt-b_cJrMz9Di8_sgCZDhf0yPiG3bNqlzJtG-29wVwfN6_bx-el4_IVeyNpoJaTyMJ2PXw_V4Chvj6Q35GQAA___ZpDar

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ks9O20wUxdfMUxx5Q_IpJnayQUafVBOM6tY4yHEpCKHR2B7ItPZMNB5TQ1WJh8gT8iSVTZpmg9ou8MLS3Ht-V-f-sW1ccF0LJT3MVP5VK5YvT47BW55njSgLrmF4bXD_oiLEtqG50gXX9IsSsqalqITBktUwS46C37KmNLhnZcM9HHZ6LllWcvoo7h7ZXU-9Jley06uVEZV45Jo2NadLURt1p1lV_wtVNaURuSppbZj5A8nbFdei4tKwkm7M9jzNVdlUkgp5z7XhBRWy4C1_vdztLSGzJPDTAKl_HAVYNVkp8oMWA7LHEMbpIeJ5ivhTFI3IXraJvLxm83iRJn4Yp7BWWlRMP1g4T8IzP7nCx-AKAwZ_MRuOyF4YnwSXaGlGRdFikP2Kn_pnYXS1gw_YCNmQDI8I8aM0SDa2upUebL2F8YdglmKR-mm4SMPZAvvXBAC-9__us14mUVserrfBPsGs7ftmtKPXnHUTY8byYE0c99B2XNtx4bie43iOY-2IC1EbIXNDc9XIDnAdZyfdX0C3C2oeVryrtwvLpiy34C6m1bffBSdTdzLtcz9Gf91b9ia99Vberj1ys39ESHB5HvlhjMH8PB0hiC-GWARRt-b_cJrMz9Di8_sgCZDhf0yPiG3bNqlzJtG-29wVwfN6_bx-el4_IVeyNpoJaTyMJ2PXw_V4Chvj6Q35GQAA___ZpDar

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9O2z4Ux6_xUxzlhvSnhKbtDQr6SQvF3bKVFKUZAyFkOalLPVKnsp0sZZqE9gy93NP1SaakpUQCtnFBLyr5nO_XOn8-jm3DOZOKZ8KFfpbcyowms5NjYCVL4pynEyZBM6Wh2KgQsm2QLJMTJsnXjAtFUj7nGmZUgZ4xmLApzVMNBU1z5sJhpWeCxikjd_zmjt7Urpfkmaj02ULzOb9jkuSKkRlXOruRdK5e45rnqeZJlhKlqf6Lk5ULJvmcCU1Tsi229pMkS_O5IFwUTGo2IVxMWMlevm46RagfYi_CEHnHQwyLPE55clCCifYo-EF0CMEoguDzcGihvXgb2Zz6o2AchZ4fRGAsJJ9TuTTgLPRPvfASPuFLMCl4437LQnt-cIIvoCQx4ZMSzPghPvBO_eFlw25SC-IWah0h5A0jHG7LqlZ6sKvNDz7ifgTjyIv8ceT3x7B_hQAAvtf_1c_YTEIZLlztgnWCGrvztdXQS0ariVFtuGB0nc6h7XRspwNOx3Uc13GMhnjCleYi0STJclEZOo7TSNcEVLsgerlg1X1Ns8jTdGds2mT27fHCbq_T7dW5H9Y_9xa_SW91KW_XHrreP3qewmVFYf6EwuKVFOYPtDWk01tSEMmmpITBKMT--2CjLVoQ4gEOcdDH491rMOkjxEtSbCAuXoY4t6D4M8TLZyGuJ4EvzoaeH4A5OosswMF5C8Z4WGn_g0E4OoXSgiV8-YBDDDH8D70jZNu2jbgQTNr118pMZKZUC8F69Wu9ul-v7kElVMDySaR8t32UVeZntY_1arUVJJlQWlIutAvtbrvjwlW7Bza0e9eoIZvyVDOpwNQyZy30OwAA__98SaRZ

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k99OnEAUxq-dpzjhRrYBw-qNWa9wxYQWWbNQozFmMsBZd9phZjMzKNo08SH2sk_nkzSw2y1JY9peyAVhvvP9Ts4fxvfhCrXhSk5gqsqvWrFyeXYK2GJZNFxUqMGisfCwcRHi-6BR6Qo1_aK4NFTwmltYMgN2iVDhgjXCwgMTDU7guPOjZIVA-szvn9l9T71lV7Lzq5XlNX9GTRuDdMmNVfea1eZ_qLoRlpdKUGOZ_QuJ7Qo1r1FaJui22J6npRJNLSmXD6gtVpTLClt8O91iQch0HoV5BHl4mkSwagrBy4MWXLLHIE7zY0hnOaSfk8Qje8VW2ZymszTL52Gc5uCsNK-ZfnLgch5fhPMb-BTdgMsgzKYjj-zF6Vl0DS0tKK9acItf-nl4ESc3A9xlHhQjMjohJEzyaL4tq1vpwa62OP0YTXPI8jCPszyeZrB_SwAAvvXv7nE2kzDOBG53Yh9gzu585w38Glk3MWadCTiHwfjYD8Z-MIZgPAmCSRA4A3PFjeWytLRUjeyAcRAMwv0f0O2C2qcVdvmGsGyE2IFDTKvH3wkPj8aHR33su_fPvRXv0ltfyvu1R-72TwiJri-TME7BnV3mHkTp1QiyKOnW_AHO57MLaCHMQEn0Nl_2UZ0Q3_d9wqVE7fe31C21MmZE4HX943X98rp-AVMy2WF_aPZRddp6qy24sKgNuFY3OCI_AwAA__96lUpd

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9q2zAcha-rpzj0ps6oW0ZglIReuK6yeXOdYGtdQylCsX9JtPpPkGXj5KoPkSfMk4w06dgGY-xS4vuOzgG5Lu7J1LoqB_Cr9NlUKl3e3oA6SmeNzjMysFRbtAeKsYQLGKpMRkZ-r3RZy1wX2uIaH_pDwHWR0Vw1uUWr8oYGuGKuCyrVLCe50YuNWrx6WKoadkl_4lW556uV1YXekJFNTXKpa1stjCrq_7GKJrc6rXJZW2X_YVK3IqMLKq3K5bHsqy_TKm-KUuqyJWMpk7rMqKO_x83njPkx9wSH8G5CjlUzy3V6sYbDThoEkbhCNBaIvobhOTtpjzeHkz-OEhF7QSRwujK6UGZ9ikkc3HnxFF_4FE4DL_F7v6PzZ9lKQ3PZYTSOefAxOrBtDzEf8ZhHPk_eenSO2utBdMsfsJat1FkHp32LHXl3QTj95XWnOUfbY70hY14oeHxctf8UFz-nBdFn7gskwhNBIgI_wdnj09mQMf4wCb0ggjOeiHPw6L6HhId79h1G8fgOa3z7xGOOBtfoD5nrui6rU1VizbDbbnfbl932BWlV1tYoXdoBLt8P8HjZh4vL_hP7EQAA__9nAeFe

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9q2zAcha-rpzj0ps6oW0ZglIReuK6yeXOdYGtdQylCsX9JtPpPkGXj5KoPkSfMk4w06dgGY-xS4vuOzgG5Lu7J1LoqB_Cr9NlUKl3e3oA6SmeNzjMysFRbtAeKsYQLGKpMRkZ-r3RZy1wX2uIaH_pDwHWR0Vw1uUWr8oYGuGKuCyrVLCe50YuNWrx6WKoadkl_4lW556uV1YXekJFNTXKpa1stjCrq_7GKJrc6rXJZW2X_YVK3IqMLKq3K5bHsqy_TKm-KUuqyJWMpk7rMqKO_x83njPkx9wSH8G5CjlUzy3V6sYbDThoEkbhCNBaIvobhOTtpjzeHkz-OEhF7QSRwujK6UGZ9ikkc3HnxFF_4FE4DL_F7v6PzZ9lKQ3PZYTSOefAxOrBtDzEf8ZhHPk_eenSO2utBdMsfsJat1FkHp32LHXl3QTj95XWnOUfbY70hY14oeHxctf8UFz-nBdFn7gskwhNBIgI_wdnj09mQMf4wCb0ggjOeiHPw6L6HhId79h1G8fgOa3z7xGOOBtfoD5nrui6rU1VizbDbbnfbl932BWlV1tYoXdoBLt8P8HjZh4vL_hP7EQAA__9nAeFe

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMkt1q2zAAha-rpzj0ps6oW0ZglIReuK6yeXOcYGtdQylCseVEq20FWTZOrvoQecI8ychPxwYb26XE9x2dA3JdPEhTK10N4Ov0xWiRLu_vIDuZzhtVZNLAytqiPVKEJJTBSG0yafh3raqaF6pUFrf40B8CrotM5qIpLFpRNHKAm4MiKzEvJN-oxUYsDiJuofP8j4quiOtCr6wq1UYa3tSSL1Vt9cKIssZS1LBL-T9W2RRWpbrgtRX2H6bsVtKoUlZWFPzU9-DzVBdNWXFVtdJYmXFVZbKTf4_Lc0L8mHqMgnl3IcWqmRcqvVrDIWcNgojdIJowRF_D8JKctaeb48mfRAmLvSBiOF8ZVQqzPsc0DsZePMMXOoPTwEv83u9o_sJbbmTOO4wmMQ0-Rke27SGmIxrTyKfJW4_OEXs9iO7pI9a85Srr4LRvsSNvHISzX153mku0PdIbEuKFjManVfuPcfVzWhB9pj5DwjwWJCzwE1w8PV8MCaGP09ALIjiTKbsEjR56SGi4Z99hFE_GWOPbJxpTNLhFf0hc13VJnYoKa4Lddrvbvu62r0h1VVsjVGUHuH4_wNN1Hy6u-8_kRwAAAP__-oPhwA==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx80t9q2zwYBvDj6ioeelLno275CIyS0APXVTZvjhNsrWsoRSi2nGi1rSDLxslRLyJXmCsZ-dOxjW6HEs_v1fuAXBcP0tRKVwP4On0xWqTL-zvITqbzRhWZNLCytmiPKUISymCkNpk0_LtWVc0LVSqLW3zoDwHXRSZz0RQWrSgaOcDNgchKzAvJN2qxEYsDxC10nr9LdHUwemVVqTbS8KaWfKlqqxdGlPW_pev-AcumsCrVBa-tsDWWooZdyvel7FbSqFJWVhT8tPPB81QXTVlxVbXSWJlxVWWyk38fl-eE-DH1GAXz7kKKVTMvVHq1hkPOGgQRu0E0YYi-huElOWtPN8eTP4kSFntBxHC-MqoUZn2OaRyMvXiGL3QGp4GX-L3fo_kLb7mROe8wmsQ0-Bgds20PMR3RmEY-Td726Byx50F0Tx-x5i1XWQenfRs78sZBOPvldae5RNsjvSEhXshofGq1_xxXP6sF0WfqMyTMY0HCAj_BxdPzxZAQ-jgNvSCCM5myS9DooYeEhvvsfxjFkzHW-PaJxhQNbtEfEtd1XVKnosKaYLfd7ravu-0rUl3V1ghV2QGu_x_g6boPF9f9Z_IjAAD__8sy4iI=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt1q2zAAha-rpzj0ps6oW0ZglIReuK6yeXOcYGtdQylCseVEq20FWTZOrvoQecI8ychPx8YGY5cS33d0Dsh18SBNrXQ1gK_TF6NFury_g-xkOm9UkUkDK2uL9kgRklAGI7XJpOHftapqXqhSWdziQ38IuC4ymYumsGhF0cgBbg6KrMS8kHyjFhuxOIi4hc7zvyq6Ojh6ZVWpNtLwppZ8qWqrF0aU9f-aZVNYleqC11bYf9iuC9mtpFGlrKwo-Kn3IYKnumjKiquqlcbKjKsqk52ssRQ17FL-EZfnhPgx9RgF8-5CilUzL1R6tYZDzhoEEbtBNGGIvobhJTlrTzfHkz-JEhZ7QcRwvjKqFGZ9jmkcjL14hi90BqeBl_i939H8hbfcyJx3GE1iGnyMjmzbQ0xHNKaRT5O3Hp0j9noQ3dNHrHnLVdbBad9iR944CGe_vO40l2h7pDckxAsZjU-r9h_k6ue0IPpMfYaEeSxIWOAnuHh6vhgSQh-noRdEcCZTdgkaPfSQ0HDPvsMonoyxxrdPNKZocIv-kLiu65I6FRXWBLvtdrd93W1fkeqqtkaoyg5w_X6Ap-s-XFz3n8mPAAAA___eQ-KE

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUzs2O2jAQwPG7n2KObVVXQAqhoB7S1JWQSKBJQNws4wzErWODPxDi6Sugp5VWq72NNP_faCiFLTqvrJlBbuVfZ4Xsfv4AvKLcR6VbdBDQB7g8K0Jq1oBD61p0_I9VxnOtehXgO0ySOQCl0OJBRB3gInTEGUwJpYBG7DXymzrexPHhoBMeQocvc2vuvT0F1asbOh498k75YI9O9P49qo86KGk190GENyReT-hUjyYIzf8_-_BcWh17w5W5oAvYcmVavOLr5w4HQvKKZQ2Dmv3esDJncIp7reQXj2coFuU2W24YDKHIds_x22iUJOlokEym469pOp4OUliUecUKVjYwhLrJqgaGc0LYbr3MFiV8WK2bz8DK7Ueo2ZLlDXyCX9WqAI_nOaGUUuLxHNFIpB41ynDfkH8BAAD__30mpFw=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VN9uuzYUvq6f4oibkgkakkhTRVRpNHU2tpRUwPpHVWUZ4jReiYmMYaTTpGrPkMs9XZ5kgvwp7dr-fr0oF0g-5_s-H_t8x6YJl0xmPBU2DNL4QaY0np2dAitZHOU8mTAJimUKig0KoQCHIFkqJ0ySP1IuMpLwOVdwAj_2-gCmCRM2pXmioKBJzmw4RqYJTNAoYeSR3z_S-5oHM5qBmrHX8FRU-HSh-Jw_MknyjJEZz1R6L-k8-wxrnieKx2lCMkXVN5isXDDJ50wompBtsTWfxGmSzwXhomBSsQnhYsJK9r7cdIrQwMdOiCF0TkcYFnmU8PioBB0dUHC98Bi8cQje76ORgQ6ibWSzGoy9IPQd1wtBW0g-p3KpwYXvnjv-DfyGb0Cn4ASDloEOXO8MX0NJIsInJejRLj50zt3RTYOuUwOiFmr1EXJGIfa3ZVVdPdrX5nq_4kEIQeiEbhC6gwAObxEAwF_1v_q0zU1kmg23-2CdoNp-fWc08JLR6sao0mzQulbn2LQ6ptUBq2Nblm1ZWgM84ZniIlYkTnNRETqW1UjXDqh6QdRywSq9JlnkSbInNmky_fNZsNvrdHt17m_ju88WfcnZ6lK-7njo7rD_tguXlQvz_7mw-KQL853bGtDpAymIZFNSwnDsY_dnb4MtWuDjIfaxN8DBfhp0-mziJSk2Ji7eN3FuQPGxiZdvmrh5E5cuvtoVUGzmwoBaGJwAAjyq2M9RGPrj85dzYrza8eoX7GOI4AR6fYTw9cXIcT3QxxehAdi7bO1Ef9hoFX1kmqaJuBBMmvUrqMcyzbIWgvXq3_Xqab16giym4uU-H2bLn7aPQIX6p-r_erXaguNUZEpSLpQN7W67Y8NtuwcmtHt3qAGb8kQxmYGuZM5a6L8AAAD__3rZxyk=
