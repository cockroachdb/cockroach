# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4kIvtgdLlmwUKGQEmKoynTZXDiS1axEEBEVRK1FZTEXKkzcMyEf4V_YD-5R8yUA5sR1MSZBl84MBXp577j1Hh5YFH1ktuag8CAT9WgtCv7x9A6xlNGt4mbMaFJMK1juUYSQohZwokhHJ4BQG-nYwB7AsyFlBmlLBmpQN82AH5VLJbyWcgiiKXhhplOigvMpZi2tGxWrFqpwoLiqJWUWykuWPENxtFSw-JCmKIUFpGkbvQH4rbVrnGeaVYnVFSltpKlyLX7FURHGpOJU2kVgUWPFVJ8dy__pT9uuxXEc-OOgWK-2D4IEoin6mveQ-Jr2atDVkRRSnmIqyZFSbYR-8GBSklKyfXdUN-zfsK15pX3YOST3kVf-AV47zBH8hakaJVPK_W1lupGIr3H1CibWAXf0ZA4wgRn6KIPXfLFAXa_uqyUpO7RaGxgmBMEpfQ7RMIfqwWIyNk-y2sjsFyyhJYz-MUmjx1Ve2gfM4fO_Hn-En9BmGBPwkGI2NkzB6iz5BizPM8xaGWVc3RnPD8BdaW9_4MPoRBSkkqZ-GSRoGCQwuDACA37t__TPJ-hcs-W_M9MAZH8pUlM2qkqYHF_viDm_uz5fH-JoRxXJMlOmBOXXc15bjWo4Ljus5juc45hFYp5lXVGEqmko3uM7x7C9cKqEzhNXmSi9mHjfzXDccFaqmLPdMxzz6Se4nTGfudNbd_TF-qQfZ_-JBt-HzbJi-xAbjcjB_JL0bnd7mH-ldP5TeTU96m7v03sOtcaGRZ8sYhe-iHXI9ghidoRhFAUrux3hIDvnXzV3-10_nf9Ob_040-nS-8MMIhsvzdAwo-jiCBC009js4i5fvoYWff0AxggxOYTY3LMuyDElJBe33t0_QgJvt9mZ7fbO9BioqqWrCK-XBZDpxPbiYzMCCyezS-DsAAP__tUwFQA==


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2zYUhq_Dpzjwje3BciQbBQoFAaaqTKfNlQNJ7VoEAUFR1MpVJlOR8qQNA4o9gy_3GnuBPUqeZKCcOi6qtui6-cKADj_-55zfv-w48JzXWijpQ6jY61pR9urxI-AtZ3kjqoLXYLg2sN1TCKU4g4IamlPN4RzG9nR8BuA4UPCSNpWBLa0a7sMeFdroNxWcgyrLQYw2RvWokAVvSc2Z2my4LKgRSmrCJc0rXnxC4N1U4epZmuEEUpxlUfwE9JtqzuoiJ0IaXktazY2VIrX6hWhDjdBGMD2nmqiSGLHp13G8v__Sw_s4nqs_2uiO1fP7hceqLIeVDisPKdnR9NwiG2oEI0xVFWfWjPm9F-OSVpoPq5u64f9GfSOk9WXvkLZNHgw3eOC6n9EvVc0Z1Ub_dyPrThu-If1PqIldYF__ggYoTHCQYciCRyvcx3p-0-SVYPMWJuiEQhRnDyFeZxA_W61m6CS_q-yfwnWcZkkQxRm05OY17-AyiZ4GyUv4Ab-ECYUgDaczdBLFj_ELaElORNHCJO_raHqGULCyuw21j-LvcZhBmgVZlGZRmML4CgEA_NZ_28-Ibn8iWvzKRz64s_syU1WzkXrkw9WhuOdHh-frY77m1PCCUDPyYbRwvYeO6zmuB67nu67vuqMj2KZZSGYIU420Fzz3uPcroY2yGSKmu7GDjY4vi8JeOCrIpqoOSsc69pU8dFgsvcWyP_t99rUe5P-LB_2EX2bD4mtsQNfjs0-kt7PpbT5I7_Zj6e0G0tu8S-973JaUlrxYJzh6Eu_J7RQSfIETHIc4fT_GE3qff3u5z__28_nvBvPfL41fXK6CKIbJ-jKbAY6fTyHFK8t-AxfJ-im0M-jgx-9wgiGHc1ieIcdxHCSk5LXzsxISJqxWWk8R3O7-vN29vd29Bc2ohO6DSvvt3VtrT_6w1t_udncAU1KbmgppfDhdnHo-XJ0uwYHT5TU6wkpRGV5rmNh_nCn6JwAA__8tjilJ

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFunEYUfTZfccXL7lYLgo0iRbvyAyHjiHbDWkCiRJY1GoahmYadcZhhzbaqlI_Yx_5Gf6Cf4i-pBpzdtYptuW55QMy955577-GA48AHVisuxRxCSb_UktDPb14DaxnNG14VrAbNlIZNj7KsFGVQEE1yohicwshkRwsAx4GClaSpNGxI1bA59FCutPpawSnIshyEkUbLDspFwVpcMyrXayYKorkUCjNB8ooVDxB8nypcvk8zlECKsiyK34L6Wrm0LnLMhWa1IJWrDRWu5TVWmmiuNKfKJQrLEmu-7tZx_L_-VMP7OL6n7m10i1XuYeGRLMthpv3KQ0xmNOUayJpoTjGVVcWoEcM9aDEqSaXYMLuuG_Zv2NdcGF16hZRp8nK4wUvPe4S_lDWjRGn1342stkqzNe5eocJmgT7-hAZWmKAgQ5AFr5eos7V71eQVp24LY-uEQBRnryBeZRC_Xy6n1kl-G-lP4SpOsySI4gxafPWFbeE8id4FySf4CX2CMYEgDSdT6ySK36CP0OIc86KFcd7FrcnCsoKl2W2ofRT_iMIM0izIojSLwhRGFxYAwG_d3Vw22fyMFf-V2XPwpocwlVWzFsqew8U-2OPt_fnyGF8zolmBibbnYM88_5Xj-Y7ng-fPPW_uefYR2LiZC6oxlY0wBb533PszV1oaD2G9vTKD2cfFvDAFRwHRVNWe6ZjHfJL7DrMX_uxFl_t9-lwN8v9Fg27Cp8kwe44M1uVo8YB7t8a9zT_cu7nPvdsB9zbf3XsHt8GlQZ6tEhS9jXvkZgIJOkMJikOU3rXxmBz8b4o7_28e9_920P_d0ujj-TKIYhivzrMpoPjDBFK0NNgf4CxZvYMWghSkYNP-SV_LheU4jmNxIVjt_CK5gDGtpVITC252f9zsvt3svoGiREALF0SdSsEu70npa9mldrepklea1QrG5n8ysf4OAAD__64RHbQ=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4kIvdgZLkWJ0CBTkQVWZTpsrB5LatQgCgqKolatEpiLlWRsG9CP8K_uBfUq-ZKDU2S6mtui6-cEAL889596jQ8eBF6xVXIoAIknftJLQ108eA9syWnS8LlkLmikNmxFlWRnKoSSaFEQxuIKZuZ1dAjgOlKwiXa1hQ-qOBTBCudLqbQ1XIKtqEkY6LQcoFyXb4pZR2TRMlERzKRRmghQ1Kz9BIMXQ3jLZlqzFP0suFK55wzVcwbfLyZ6LcZFo9TzLUQoZyvM4eQrqbe3StiwwF5q1gtSuNuq4lb9gpYnmSnOqXKKwrLDmzeCA4__5h5q2wPE99VGh91jlHjyayaqaZtq7NMVkRlOugTREc4qprGtGjX_uwb5ZRWrFptl127F_w95wYXwZHVJG5NG0wCPP-wx_JVtGidLqvxtZ9UqzBg-fUGGzwFj_AgErSlGYI8jDxys0vAT3vitqTt0tzK0TAnGSX0CyziF5vlotrJPifWU8Resky9MwTnLY4vs3rIebNH4Wpq_gB_QK5gTCLDpdWCdx8gS9hC0uMC-3MC-GunV6aVnhyuw2JR8n36MohywP8zjL4yiD2a0FAPDb8G9-Ntn8hBX_ldkBeItDmcq6a4SyA7jdF0e8vT_fHeNbRjQrMdF2APa55184nu94Pnh-4HmB59lHYJNmLqjGVHbCNPjesfZrrrQ0GcK6vzeD2cfNvDQNRwXR1fWe6ZjHPMm9wvnSP18Od78vvtaD4n_xYJjwy2w4_xobrLvZ5SfS25v0dv9I7-Zj6e0n0tv9nd4PcBtcGeT1OkXx02REbk4hRdcoRUmEsg9jPCeH_JvmIf-bz-e_n8z_sDR6ebMK4wTm65t8ASh5cQoZWhnsN3Cdrp9BDz9-h1IEHVzB8tJyHMexFCUCegsedruH3buH3TugUijdEi50AGd-ALdnS3DgbHln_RUAAP__DTESbw==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9FunEYUfTZfccXLrqsFg1eJLCw_EDJOaTesBSRNZFmjYRiaaWDGYYbt0qpSPsK_0h_op_hLqoF0vVGxo9QND0hz59xz5p454zjwmrWKSxFAJOn7VhL67vkzYFtGi47XJWtBM6VhM6IsK0M5lESTgigGZzAzu7NTAMeBklWkqzVsSN2xAEYoV1p9qOEMZFVNwkin5QDlomRb3DIqm4aJkmguhcJMkKJm5QMEUgztLZNtyVr8i-RC4Zo3XMMZPF1O9pyMg0SrV1mOUshQnsfJC1Afape2ZYG50KwVpHa1Ucet_BUrTTRXmlPlEoVlhTVvBgcc_68_1bQFju-pe4U-YZV759FMVtU0086lB5mmPZg9XU6TntzLaIZVrhFtiOYUU1nXjJobce8uZFaRWrFpat127L-wN1wYp0fPlRF5Mi3wxPO-wF_JllGitPr_jqx6pVmDh1AobAYY618hYEUpCnMEefhshYa35V53Rc2pu4W5dUAgTvITSNY5JK9Wq4V1UHyqjKtonWR5GsZJDlt8_Z71cJHGL8P0LfyI3sKcQJhFhwvrIE6eozewxQXm5RbmxVC3Dk8tK1yZ2abk4-QHFOWQ5WEeZ3kcZTC7tAAAfh_-5rPJ5mes-G_MDsBb3JWprLtGKDuAy11xxNu79dU-vmVEsxITbQdgH3v-ieP5jueD5weeF3ievQc274MLqjGVnTANvrev_Y4rLU2GsO6vzcHs_WZemoa9gujqese0z2Me-U7heOkfL4e9PxaP9aD4Jh4MJ_w6G44fY4N1NTt9IL29SW_3r_Ru7ktvP5He7p_0fobb4Mogz9cpil8kI3JzCCk6RylKIpR9HuM5ucu_aR7yv_ly_vvJ_A9DozcXqzBOYL6-yBeAkteHkKGVwX4H5-n6JfTw0_coRdDBGSxPLcdxHEtRIqC34Pbm5vbm4-3NR6BSKN0SLnQAR34Al0dLcOBoeWX9HQAA__9GoizZ

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91unEYUvjZPcbQ3u64WDF4lsrB8Qcg4pd2wFpA0kWWNhmFwpoEZhxm2i6tKeQi_Sl-gj-InqQbS3Y2KHaVp9mIlDt_PnI9vbBtes0ZxKXwIJX3fSELfPX8GbMNo3vKqYA1opjSsB5RlpSiDgmiSE8XgDKbm7fQUwLahYCVpKw1rUrXMhwHKlVYfKjgDWZajMNJq2UOZIHnF8C2_viXX-FfJhWGJUZIsy57DRcE2uGFU1jUTBdFcCoUHpeIRUyl6esNkU7CmN1O44jXXcAZPF6Ock2H5cPkqzVACKcqyKH4B6kPl0KbIMReaNYJUju73aORvWGmiudKcKocoLEused2nZnt__anGY7M9Vz1o9AmrnF2uU1mW40rbZB9VGs9g-nQxLnryoKJZVjnGtCaaU0xlVTFqvoiz-yDTklSKjUvrpmX_Rb3mwiQ9ZK6MyZNxgyeu-wX9UjaMEqXV_3dk1SnNatyXQmGzwDD_CgMrTFCQIciCZ0vU30fnps0rTp0NzKwDAlGcnUC8yiB-tVzOrYP802R4CldxmiVBFGewwTfvWQcXSfQySN7Cz-gtzAgEaXg4tw6i-Dl6AxucY15sYJb3c-vw1LKCpdltzD6Kf0JhBmkWZFGaRWEK00sLAOD3_t_8JmR9jRW_ZRMf3PluTGXV1kJNfLjcDgf8ZPt8tY9vGNGswERPfJgcu96J7Xq264Hr-a7ru-5kD2zuBxdUYypbYQieu-_9jistTYew7m7MwSb7ZF4Ywt5AtFW1VdrXMZd863C88I4X_bs_5t-aQf5dMuhP-HUxHH9LDNbV9PSR9namve2_2rt-qL3dSHvbf9r7GW6NS4M8XyUoehEPyPUhJOgcJSgOUfp5jWdk139D7vu__nL_u9H-90ujNxfLIIphtrrI5oDi14eQoqXB_gDnyeoldPDLjyhB0MIZLE4t27ZtS1EioLPg_u7u_u7j_d1HoFIo3RAutA9Hng-XRwuw4WhxZf0dAAD__57KPlY=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkWK0CBTkwVWZTpsrB5LatQgCgqKolKtEpiTlWRkG9CPyK_uBfUq-ZKDUOS6mJOiy-sGArs45l_fcQ7kuvGVKcykCCCX9qCShH16-ALZhNG94VTAFhmkD6x7lOCnKoCCG5EQzOIGxfTs-BnBdKFhJmsrAmlQNC6CHcm30pwpOQJblIIw0RnZQJkheMXzNL6_JJf5VcmFZYpAky7LjcFGwDVaMyrpmoiCGS6Fxr1Q80FSKji6vDK_5NVO40Qx_4NrIS0Vq_ThTMakKprpjalzxmhs4gefzQc5Rb1u4fJNmKIEUZVkUvwL9qZpRVeSYC8OUINXMdA4o-RvWhhiuDad6RjSWJTa87vx2_b_-1MOGu76n7230BatndxsZy7IcVtru5EGlYQ_Gz-fDokf3Ktph9cw2rYnhFFNZVYzaXc7uVjkuSaXZsLRRDfsv6jUX1unec7v18bPhBs887xH9UipGiTb6_zuybrVhNe5CobEdoK9_QwMnTNAiQ5AtXixRd5NnV01ecTrbwMTZIxDF2RHEqwziN8vl1NnLv1T6p3AVp1myiOIMNvjqI2vhLIleL5L38DN6DxMCizTcnzp7UfwSvYMNzjEvNjDJu7qzf-w4i6Wdbah9FP-EwgzSbJFFaRaFKYzPHQCA37t_-xuR9SXW_JqNAvCmd2Uqq6YWehTA-bbY40fb54tdvGLEsAITMwpgdOj5R67nu54Pnh94XuB5ox2wvR9cUIOpbIQl-N5u7-4jYTOETXtlDzbaJfPCEnYKoqmqrdKujr3k2w6Hc_9w3r37Y_pUD_Lv4kF3wm-z4fApNjgX4-MH0tva9Db_Su_6vvS2A-lt_knvV7g1Li3ydJWg6FXcI9f7kKBTlKA4ROnXMZ6Qu_xbcpf_9eP5bwfz3w2N3p0tF1EMk9VZNgUUv92HFC0t9gc4TVavoYVffkQJggZOYH7suK7rOpoSAa0Dtzc3tzefb28-A5VCG0W4MAEc-AGcH8zBhYP5hfN3AAAA__8vZlKh

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkWK0CBTkwXWZTpsrB5LatQgCgqKolCtFpiLl2RkG9CPyK_uBfUq-ZCDVOS6mpMuy-cGArs45l_fcI_o-vGWN5kpGMFf0Y6MI_fDyBbA1o0XLRckaMEwbWHUoz8tQDiUxpCCawQkM7dvhMYDvQ8kq0goDKyJaFkEH5droTwJOQFVVL4y0Rjkok6QQDF_zy2tyiX9WXFqW7CWpqnIcLku2xg2jqq6ZLInhSmrcKZUPNFXS0dWV4TW_Zg1uNcMfuDbqsiG1fiyzboXhVAmsDTH_gN0w1ZSscUNqLHjNDZzA82kv56gzfb54k-UohQzleZy8Av1JTGhTFphLwxpJxMQ4_xr1izsG14ZTPSEaqwobXrtt-eEfv-v-dflhoO9t9AWrJ3f7HKqq6lfabvRBpX4Phs-n_aJH9yo6zye2aU0Mp5gqIRi1SZjcBWFYEaFZv7RpWvZv1GsurdOd53brw2f9DZ4FwTf0K9UwSrTR_92R9UYbVmMXCo3tAF39EQ28eYpmOYJ89mKB3D0wuWoLwelkDSNvj0Cc5EeQLHNI3iwWY2-v-FLpnubLJMvTWZzksMZXH9kGztL49Sx9Dz-i9zAiMMvm-2NvL05eonewxgXm5RpGhat7-8eeN1vY2frax8kPaJ5Dls_yOMvjeQbDcw8A4Ff3b38DsrrEml-zQQTB-K5MlWhrqQcRnG-LHX6wfb7YxTeMGFZiYgYRDA6D8MgPQj8IIQijIIiCYLADtt8Hl9RgqlppCWGw29tdMTZD2Gyu7MEGu2ReWsJOQbZCbJV2dexHvu1wOA0Pp-7db-OnelD8Lx64Ez7OhsOn2OBdDI8fSO_Gprf9W3pX96V305Pe9q_0foVb4coiT5cpil8lHXK1Dyk6RSlK5ij7OsYjcpd_S3b5X307_5ve_Luh0buzxSxOYLQ8y8eAkrf7kKGFxX4Hp-nyNWzgp-9RiqCFE5gee77v-56mRMLGg9ubm9ubz7c3n4EqqU1DuDQRHIQRnB9MwYeD6YX3ZwAAAP__7axoog==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysksuO0zAUhvd5irMrIBz1Qi9M1UUJBlVqM0OTVrOzXOdEGByb-jjD8GC8AE-G3CBmkxkEYhfFv78_5zthDI7oSTt7BZlTn72T6uPbN4D3qE6tNhV6CEgB7rpUkhS8hEoGeZKEsIJBPB0sARiDCmvZmgB30rR4BV1UU6CzgRW4uu6NyTa4S1TbCu-FR-WaBm0lg3aWBFp5Mlg9AXD2ct2j8xV68clpS8LoRgdYwWzSe2fRDZJtD0XJ91Dwstzk74HOJlW-OgltA3orTRpiu_Duq6Agg6agFaWShKtF0M3FABv9-E79CthoSI8W_cpS-uBo4Oq6n_Tb0pOkfgeD2aQfuniUGIelNJY2MmgllDMGVdxI-rCQQS0NYT86-Bb_hd5oG013zimWTPsLpsPhH_i186gkBfp_n0zfKGAjLj8FiThA9_4vCpJsz9clh4J_OPA84_ClPRmtUsIz7Db5cb09cBjBbn3bPb4ejyeT-Xg4mS2mr-bz6WI4h02e7fmO5yWMoCjX-xJGyyThtzfb9SaHZ9c35Uvg-fE5FHzLsxJewLv99Q4Iz8uEMcYSwnOLViEjjOLjSfIzAAD__-I1Tr0=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfJkW20CGQEmOoynTZXDiQ1bREEBCVRK1eZTEVKszcMKPYNftxv7Af2KfmSgZLrOKuSosvmBwO6PPcc3sND2jZcsFJxKVyYy_R9KWn67vkzYGuWJhUvMlaCZkpD3aIQinAMGdU0oYrBKfTNan8GYNuQsZxWhYaaFhVzoYVypdWHAk5B5nknjFZaNlAuMrYmJUvlasVERjWXQhEmaFKw7AECKZr2kskyYyX5SXKhSMFXXMMpPJ129py0g8wXr6IYhxDhOPaDF6A-FKO0zBLChWaloMVIG3VSyp-J0lRzpXmqRlQRmRPNV40D9vivP1W3BfbYUfcK7bBqdOtRX-Z5N9PepQeZuj3oP512k57cy2iGVSMjuqKapySVRcFScyKj2wPp57RQrJtalxX7N-wrLozTrefKiDzpFnjiOF_gz2XJUqq0-u-2rDZKsxVpQqGIGaCtf4UAmofYizHE3rMFbu7W6LpKCp6O1jBARxT8ID6BYBlD8GqxsNBRsqu0X_NlEMWh5wcxrMn1e7aB89B_6YVv4Qf8FgYUvGg-tNCRHzzHb2BNEsKzNQySpo6GM4S8hZmtS94PvsfzGKLYi_0o9ucR9C8RAMCvzb_59Wj9I1H8F9ZzwbFuy6ksqpVQPRcu98UW39t_Xx3iS0Y1ywjVPRd6E2d8Yjtj2xmDM3Ydx3Wc3gHY3A8uUk1SWQnTMHYOtd9xpaXJENGba7Ox3mEzz0zDQUFURbFnOuQxl3yvMJmOJ9Nm7TfrsR4k_4sHzQ6_zobJY2xAV_3ZA-ndmPRWn6W3vi-9m470Vp_SewdXk9wgz5Yh9l8ELbIeQojPcIiDOY7uxnhAb_Nvmpv811_O_6Yz_4dDX_j4NezQdXNZzfW00FFlBkVD8CKI8MJwUAsSCyoLajgLly_v7tD6h-7r73CIIYFTmM4Qwm_OF54fwGB5HluAg4vhJ9JvWq56hmzbthEXgpW2eephkJZSqSGCm-0fN9uPN9uPoFIqYPNZZf3t7k0wK7-bg73ZbneAVAqlS8qFduF4cjx24fJ4CjYcT6_QASznhWalgoF5z4bo7wAAAP__pLNuSw==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk-Fu0zAQxz_PT3Hf0qIl6jRtqlb1QxYCCmRplXgTE0KWm1yEWWIz33VsD8YL8GQoLWISyoZA-2r_7_e_-58dhnCFnoyzZ5C4-sY7XX9-fQ54j_Vma7oGPTASw91eJUSVSmg0640mhCUEw22wAAhDaLDV247hTndbPIO91BDTbQdLcG07KtNbdjupsQ3eK4-163u0jWbjLCm0etNh8wzA2V25R-cb9OqLM5ZUZ3rDsITT49Ga-X6QJL-sZFpClUqZFW-Bbruo9s1GGcvore4iHtyVd98UsWZDbGqKNCnXKjb9LoHw6Md3Go8gPJrRk0a_tBQ9ZhS4th0n_U7pWdJ4BsHp8Th0_iRxGJaiwbTXbGpVu67DethI9LiQoNUd4Tia_Rb_h94bOyS9z5wGk5Nxg5PZ7C_81nmsNTG9XMv0QIy92j0KUsMA-_N_MBBJmcYyBRmf5-nub0UUMUzEgYaskHMoVhKKyzw_FAfJqqhkGWeFBFZfb_AB1mV2EZfX8D69homGuEqmYroQIs6Hhv9gZsW7NJFQyVhmlcySCoKPn4KFEOmHdR5nBUxWa3kIaXE1hSrNB-0reFOuLoAiXogwDENBtbbA4mcAAAD__0DBVUE=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xewcA6FgI0gQJPAiTYUigOEGtWJ0R4yoUcqGImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wFXAfzEAOaL-_fAT2SqTrraoogxAK7IZVl66KEGgUrZIIFTNLXySWAUlBTg50T2KHr6AKG6HCmJaJnNGKD19sOnZUnHRrNFHfWJFCF5uE-hs7Xo7BI953DODAtC28dLCA0zWgaOwl91PqaHnUkE9qWfI2pnzV5rBzVbwCC78cjhVhT1F-D9aydba3AAs5ORmfOBznXy7t1WXyCdVGWN6sPwFuXm1hX2nqh6NHlktp1DN80C4plsYZz5ORDbNtbVfMf33lcq5rP-NWiX1nOXxxNQtOMk35bepM07mBydjIOPX-VmC7LeSptUazRJjhH_UbkLw8yadAxjaMldvQv9Nb6ZHpwzqnkdLzgdDb7A78JkQyy8P_7ZX5ioVb3S8E6XWA4_4uCrPh8u7y6WcHRx9vyGIrVZgqbq-VdsYaj-fQyU0qprB_gDA77_WH_fNg_w9H8eJr9DAAA___03lZf

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexkA6FgI0gQJPAiTYUigOEGtWJ0R4ypUcuWImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wl3ATzNQY0n9--AXogs-2sqymCEAvsh1SWrcsKahTcIhMsIE9f8ysApaCmBjsnsEfX0SUM0eFMS0TPaMQGr3cdOiuPOjSaKe6tSSATrViDbhQV6VPnMA5Ey8I7BwsITTOaxk5CH7W-pgcdyYS2JV9jamdNHreO6lcAwffjkUKsKeovwXrWzrZWYAHnp6MzF4Oam-X9uio_wLqsqtvVO-CdK0yst9p6oejRFZLadQzfNAuKZbGGC-RkQ2zbO1XzH995XKqaz_jFol9ZLp4d5aFpxkm_Lb1KGneQn5-OQy9eJKbLcpFKWxRrtAnOUb8PxfOD5A06pnG0xI7-hd5an0wPzjmVnI0XnM1mf-A3IZJBFv5_v8yPLNTqfilYpwsM539RkJUf75bXtyuYvL-rTqBcbaawuV7el2uYzKdXmVJKZf0AZ3A8HI6Hp-PhCSbzk2n2MwAA__-yYVWK

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgbLkBO0CBzkwXWZQpsrB5JatCgKgqKoljNFOiSlWR72WfuBfdlAqbMdVHbRdfODAV2dew7P0aHvw1umDVdyBgtF11oR-vnlC2BbRrOKi5xpsMxYqDuU5yUohZxYkhHD4A6G7u3wFsD3IWcFqYSFmoiKzaCDdjNsNZGGUMuVxI8VEdw2WBXYMF1z6oio5pZTInqpNPtUCaI7Rm6seRRwB6ooetGksqqFcpmzLdaMqrJkMidO3WAmSSZYfoZAyXZdM6VzpvGvikuDBS-5hTt4ft27c9NFs1i-SVIUQ4LSNIxegXkUE6rzDHNpmZZETKxTx1r9ho0llhvLqZkQ49KwvGwz9ad__Wn6Q_WngTkp9AVrJoeMhqoo-pn2KZ1l6s9g-Py6n_TmJKMzayZOtCSWU0yVEKztw-TwQYYFEYb1U1tdsX_DXnLpku4yN07kWb_AsyD4Bn-hNKPEWPPfHdk0xrISt6Uw2Bno5t8h4C1iNE8RpPMXS9Te1smmygSnky2MvAsCYZTeQLRKIXqzXI69i-zLpHtarKIkjedhlMIWb9asgYc4fD2P38Mv6D2MCMyTxeXYuwijl-gdbHGGeb6FUdbOvctbz5svnbc--TD6GS1SSNJ5GiZpuEhg-MEDAPi9_Xe_Aak_YcN3bDCDYHwYUyWqUprBDD7shx1-sH_-eIzXjFiWY2IHMxhcBdMbP5j6wRSC6SwIZkEwOAK7-8EltZiqSrqFaXCs_Zkbq1yHsG027mCD42Weu4WjgayE2DMd87hLvle4up5eXbfv_hj_aAbZ_5JBe8Lvi-HqR2LwPg5vz7S3ce2tvmpvfaq9TU97q3_a-wRX48Ih71cxCl9FHbK-hBjdoxhFC5Q8rfGIHPrvltv-19_uf9Pb__Omd870Zv2Va82KU753Pb436x7jxfqpZc2Kk6abUXXe3O60OfTuYTkPIxitHtIxoOjtJSRo6bA_wX28eg27W8_3fd8zlEjYeX8HAAD__7BreMw=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgbLkBO0CBzkwVWZQpsrB5JatCgKgqKoljNFOiSlWRn2WfuBfdlAqXMcVHbRdfODAV2dew7P0aHvw1umDVdyAaGiG60I_fzyBbAdo3nNRcE0WGYsND3K81KUQUEsyYlhcANj93Z8DeD7ULCS1MJCQ0TNFtBD-xm2mkhDqOVK4vuaCG5brEpsmG44dURUc8spEYNUmn2qBdE9IzfW3Au4AVWWg2hSW9VBuSzYDmtGVVUxWRCnbjCTJBesOEGgZLeumdIF0_hXxaXBglfcwg08vxzcueqjCVdv0gwlkKIsi-JXYO7FjOoix1xapiURM-vUsVa_YWOJ5cZyambEuDQsr7pM_flff5rhUP15YI4KfcGa2WNGY1WWw0z7lE4yDWcwfn45THp1lNGZNTMnWhHLKaZKCNb1Yfb4QcYlEYYNU1tds3_DXnHpku4zN07k2bDAsyD4Bn-pNKPEWPPfHdm0xrIKd6Uw2Bno598h4IUJWmYIsuWLFepu62xb54LT2Q4m3hmBKM6uIF5nEL9ZrabeWf5l0j-F6zjNkmUUZ7DD2w1r4S6JXi-T9_ALeg8TAss0PJ96Z1H8Er2DHc4xL3Ywybu5d37tecuV8zYkH8U_ozCDNFtmUZpFYQrjDx4AwO_dv_uNSPMJG_7ARgsIpo9jqkRdSTNawIf9sMeP9s8fD_GaEcsKTOxoAaOLYH7lB3M_mEMwXwTBIghGB2B3P7ikFlNVS7cwDw61P3NjlesQtu3WHWx0uMwLt3AwkLUQe6ZDHnfJ9woXl_OLy-7dH9MfzSD_XzLoTvh9MVz8SAzex_H1ifa2rr31V-1tjrW3HWhv_U97n-AaXDrk7TpB0au4RzbnkKBblKA4ROnTGk_IY__dctf_5tv9bwf7f9r0gzO93XzlWrPymO-HAd_bzYDxcvPUsmblUdPtpD5t7uG4OfTubrWMYpis77IpoPjtOaRo5bA_wW2yfg3ttef7vu8ZSiS03t8BAAD__7BaeMo=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgbLkBO0CBzkwXWZQpsrB5JatCgKgqKoljNFOiSlSRn2WfuBfdlAqXMcVHbRdfODAV2dew7P0aHvw1umDVdyAStFt1oR-vnlC2ANo1nFRc40WGYs1D3K8xKUQk4syYhhcANj93Z8DeD7kLOCVMJCTUTFFtBD-xm2mkhDqOVK4vuKCG5brApsmK45dURUc8spEYNUmn2qBNE9IzfW3Au4AVUUg2hSWdVBucxZgzWjqiyZzIlTN5hJkgmWnyBQslvXTOmcafyr4tJgwUtu4QaeXw7uXPXRrNZvkhTFkKA0DaNXYO7FjOo8w1xapiURM-vUsVa_YWOJ5cZyambEuDQsL7tM_flff5rhUP15YI4KfcGa2WNGY1UUw0z7lE4yDWcwfn45THp1lNGZNTMnWhLLKaZKCNb1Yfb4QcYFEYYNU1tdsX_DXnLpku4zN07k2bDAsyD4Bn-hNKPEWPPfHdm0xrISd6Uw2Bno598h4K1itEwRpMsXa9Td1tmuygSnswYm3hmBMEqvINqkEL1Zr6feWfZl0j-tNlGSxsswSqHBuy1r4S4OXy_j9_ALeg8TAstkdT71zsLoJXoHDc4wzxuYZN3cO7_2vOXaeRuSD6Of0SqFJF2mYZKGqwTGHzwAgN-7f_cbkfoTNvyBjRYQTB_HVImqlGa0gA_7YY8f7Z8_HuI1I5blmNjRAkYXwfzKD-Z-MIdgvgiCRRCMDsDufnBJLaaqkm5hHhxqf-bGKtchbNudO9jocJnnbuFgICsh9kyHPO6S7xUuLucXl927P6Y_mkH2v2TQnfD7Yrj4kRi8j-PrE-1tXXurr9pbH2tvO9De6p_2PsHVuHDI202MwldRj6zPIUa3KEbRCiVPazwhj_13y13_62_3vx3s_2nTD870bvuVa82KY74fBnzvtgPGi-1Ty5oVR023k-q0uYfj5tC7u_UyjGCyuUungKK355CgtcP-BLfx5jU0157v-75nKJHQeH8HAAD__7BJeMg=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvdgbLkBO0CBzkwXWZQpsrB5JatCgKgqKoljNFOiSlWR72WfuBfdlAqbNdVHbQdctDAF2dew7P8RF9H94ybbiSM1goutaK0M8vXwDbMppVXORMg2XGQt2hPC9BKeTEkowYBncwdG-HtwC-DzkrSCUs1ERUbAYdtJthq4k0hFquJH6siOC2warAhumaU0dENbecEtFLpdmnShDdMXJjzaOAO1BF0YsmlVUtlMucbbFmVJUlkzlx6gYzSTLB8jMESrbrmimdM41_VVwaLHjJLdzB8-venZsumsXyTZKiGBKUpmH0CsyjmFCdZ5hLy7QkYmKdOtbqN2wssdxYTs2EGJeG5WWbqT_960_TH6o_DcxJoS9YMzlkNFRF0c-0T-ksU38Gw-fX_aQ3JxmdWTNxoiWxnGKqhGBtHyaHH2RYEGFYP7XVFfs37CWXLukuc-NEnvULPAuCJ_gLpRklxpr_7simMZaVuC2Fwc5AN_8OAW8Ro3mKIJ2_WKL2a51sqkxwOtnCyLsgEEbpDUSrFKI3y-XYu8i-TLqnxSpK0ngeRils8WbNGniIw9fz-D38gt7DiMA8WVyOvYsweonewRZnmOdbGGXt3Lu89bz50nnrkw-jn9EihSSdp2GShosEhh88AIDf2__ub0DqT9jwHRvMIBgfxlSJqpRmMIMP-2GHH-yfPx7jNSOW5ZjYwQwGV8H0xg-mfjCFYDoLglkQDI7A7vvgklpMVSXdwjQ41v7MjVWuQ9g2G3ewwfEyz93C0UBWQuyZjnncR75XuLqeXl237_4Y_2gG2f-SQXvC74vh6kdi8D4Ob8-0d-fau1l_U1_NilMF3vUUeLP-p8FHwGIN96sYha-iDqRZcQkxukcxihYo-eoczag63_Ndb8_Pm2ucueobb_UpZ02Ps6rHWINrXDjkV_bqk-a2I_JENKd3d6PN-nAzOOX2Zqifvhma04mhdw_LeRjBaPWQjgFFby8hQUuH_Qnu49VraG493_d9z1AiofH-DgAA__8854p8

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2zYUhq_DpzjQjZ3BEmSl6VIHuVAcddCmyoHFBC2KgqAoquVKkQlJpcmGPdZeYE82UGoTY1CzdUh9YcDn_Of_qY9HDkO45MYKrVaw1uyj0ZR9ODsFfstZ3QvZcAOOWwc3owqhKsPQUEdrajmcwMx3Z8cAYQgNb2kvHdxQ2fMVjNKxRpyhylLmhFbkuqdSuDuiW2K5uRHMGzEjnGBUTloZ_r6X1IyOwjp7LeEEdNtOqmnv9CAVquG3xHCmu46rhvp0S7iiteTNIwZaDeOGa9NwQ37VQlkiRSccnMDzg8mZoxHNuriocLaFKsM4L38Cey0jZpqaCOW4UVRGzqcToz8R66gT1glmI2o9DSe6gWm4_OtPOw01XMb2q0GftTZ6YDTTbTvtdE_pUadpBrPnB9OmR1919A9rIx_aUScYYVpKPuxD9HAhs5ZKy6etnen5_3HvhPKkR-bWhxxOBxzG8b_4t9pwRq2zT3dke2cd78iwFJb4Bxjr3xCA1tssxRng9LTIhrc1uuprKVhUwxzt1XC62RRQbjCUF0WxQHtGfxIN5CU-GqqXeZX7yS8KOMtephcFhl6J637AJpr5_gLtrTdlhbdpXmKoydVHfgfn2_xVun0Dv2RvYD76ptXaa_PyLHsNNamJaG5hXg91tH-MUFp4FFOnzcufszWGCqc4r3C-rmD2FgEA_D58-09Ab94TK37jwQqWi4cy07LvlA1W8Pa-ODTq4P73u1294dTxhlAXrCBI4iQJl0kYJ7A8Wh08WyUvosMfn704SIKdGf9WCcUcYbpXfi7ZaX4Q1mm_d8TdXfnTBbujovnHeRXtBhEZ7pyQXbHqpbzPiHca_k_jS325jOOh88fiEUTxf0E03Nt3xBR_G6bkKTF9ZoTezY4Ryl6fF2lewnxzjheQlZf7UGWFX7kf4OV28wrqYxSGYYgsowpq9HcAAAD__8tkFIY=
