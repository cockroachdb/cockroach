# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVO1u2zYU_R0-xYX_2B4sRbJRoJARYKrDtNpcOZCUfiAICIqiFiL6SEVKkzcM6EP4VfYCe5Q8yUApc5xNWbGlQP3DgC4Pzz33kIeGAe94JUVZOLAq2U1VUnZ9-gp4y1lciyzhFSguFTQ9CqEQR5BQRWMqOZzAWK-OlwCGAQlPaZ0paGhWcwd6qJBKfsrgBMo0HYTRWpUdVBQJb0nFWZnnvEioEmUhCS9onPHkXwj-UrVaX4QRDiDEUeT5r0F-ykxWJTERheJVQTNTaSpSlT8TqagSUgkmTSpJmRIl8m4cw_7jdzk8j2Fb8slG91hpPgw8LtN0mGk_8hCTliZNDcmpEoywMss402aYD16MU5pJPsyuqpr_H_ZcFNqX3iGpm7wYbvDCsr7An5YVZ1Qq-fUky61UPCfdEUqiB-jrX6FBw1l398yEK17louhuBklFW98-aqBZhvm71ghdhLiLyxKtAuxGGCL31RrDbR1ngpktTNARBc-PXoK_icC_WK9n6Ci-r_Rfq40fRoHr-RG05PaGb-E88N66wUf4EX-ECQU3XE1n6MjzT_EHaElMRNLCJO7qaArvvegNTCS75jklWcluOula-XS5RMhd6-l7WVqpudfm-T_gVQRh5EZeGHmrEMaXCADg1-5f_0a0-YlI8QsfOWDNHsqszOq8kCMHLvfFHj_af18d4itOFU8IVSMHRnPLfmlYtmHZYNmOZTmWNToAJzyjW5LwjCvdt3P6cFkfVsEUYWVdaD7bOpR2LaQq9S0nanur948OuUWiNxwUijrL9kyHPPrR2HeYL-z5olv7bfZci-JvYVE3wH9zaf4cl9DVePmldGx1Oup_pKN5Kh3bgXTUj9OxJU2fjuaZ6dgOpkMP9fQO9_QUHsltSKoFn20C7L32e8HNFAJ8hgPsr3D4t0BO6HSJEP5wvnY9Hyab82gG2H83hRCvtZbv4CzYvIUW3r_BAYYYTmCxRIZhGEgyWkD7_f3rgOBut7vbfb7bfQZWFlJVVBTKgeP5se3A5fECDDheXKE_AwAA__9BslaD


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVN1u2zYYvQ6f4oNvbA-WI8coUNgIMNdhWm2uHEhKfxAEBEVRCxeaTEXKszYMKPYMvtxr7AX2KHmSgVLmOKuyYkuB-sKAPh6e73yHPPQ8eMMLI7SawFyz60JTdnXyAviGs7QUMuMFWG4srBsUQjFOIKOWptRwOIauW-1OATwPMp7TUlpYU1nyCTRQYaz5IOEYdJ63wmhpdQ0VKuMbUnCmVyuuMmqFVoZwRVPJs38h-FvVfHEeJziCGCdJEL4E80EOWZGlRCjLC0Xl0DoqUuifiLHUCmMFM0NqiM6JFat6HG_05x-mfR5v5JtHG91hzfB-4K7O83am3chtTE6aGTrIilrBCNNScubMGN570c2pNLyd3RYl_z_sK6GcL41DxjV51t7gme9_hj_XBWfUWPPlJJvKWL4i9REa4gZo6l-gwZqz-u4NM255sRKqvhkkF5vy5kEDx9LOX7dG6DzGdVymaB7hWYIhmb1YYLgpUynYcAM9dEAhCJPnEC4TCM8XiwE6SO8qzdd8GcZJNAvCBDbk5ppXcBYFr2fRe_gev4cehVk87w_QQRCe4HewISkR2QZ6aV1HfXgbJK-gZ9gVX1EiNbuupTvl_ekUodnCTd_IckqHO21B-B2eJxAnsySIk2AeQ_cCAQD8Uv-7X4eufyBG_Mw7E_AH92WmZblSpjOBi12xwXd235f7-IJTyzNCbWcCnSN_9NzzR54_An808f2J73f2wBmXtCIZl9y6vrXT-8vusBSzhOlSOb6Rvy_tShir3S0ntrpx-zv73CJzG_YKqpRyx7TP4x6NXYej8ehoXK_9OniqRenXsKge4L-5dPQUl9Bld_q5dFQuHeUn6Vg_lo6qJR3lw3RUZN2kY_3EdFSt6XBDPb5jdnICD-SuSe4Eny4jHLwMG8HrPkT4FEc4nOP4H4Hs0f4UIfzubDELQugtz5IB4PBNH2K8cFq-gdNo-Ro2A6jg7SscYUjhGMZT5Hmeh4RSvPB-1EJBjxXamD6C2-3vt9uPt9uPYBhVUH1S2Xx796C4ld_c0d1ut3cAppWxBRXKTuDw6HA0gYvDMXhwOL5Ee7BcSMsLA73aVPRXAAAA__9ldnqM

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJzEVNFu2zYUfQ6_4sIvtgfLkFMUKGzkQXWYTpsrB5bStQgCgqKohQtFpiKlyBsG9CPyuN_YD-xT8iUDpcxxNmXFlgL1g2Hde3juuUc89jx4x0sjtJrDUrOrUlN2efwaeMNZWgmZ8RIsNxbqDoVQjBPIqKUpNRyOYOi6wwWA50HGc1pJCzWVFZ9DBxXGmo8SjkDneS-MVla3UKEy3pCSM10UXGXUCq0M4Yqmkmf_QvCXquXqLE7wBmKcJGH0BsxHOWVllhKhLC8VlVPrqEipb4ix1ApjBTNTaojOiRVFu443--N307-PN_PNk4PusWb6sPBQ53k_027lPiYnzUwdpKBWMMK0lJw5M6YPXgxzKg3vZ7dlxf8PeyGU86VzyLghL_sHvPT9z_DnuuSMGmu-nGSzNZYXpH2FhrgFuvoXGFBz1t69acYtLwuh2ptBctFU148GOJZ-_nY0QmcxbuOyQMsNDhIMSfB6heG6SqVg0wZG6IBCGCWvIFonEJ2tVhN0kN5XuqflOoqTTRBGCTTk-opv4XQTvg02H-B7_AFGFIJ4OZ6ggzA6xu-hISkRWQOjtK2jMfwQJt_CyLBLXlAiNbtqpTvl48UCoWDltu9kOaXTnbYw-g4vE4iTIAnjJFzGMDxHAAC_tN_uM6D1j8SIn_lgDv7kocy0rAplBnM43xU7_GD3fLGPLzm1PCPUDuYwOPRnrzx_5vkz8Gdz35_7_mAPnHFJtyTjkls3t3V6v-1elmKWMF0pxzfz96VdCmO1u-XEbq_d-cE-t8jcgb2CqqTcMe3zuD-N3YTDF7PDF23v18lzLUq_hkXtAv_NpcPnuIQuhovPpWPr0lH9Ix31U-nY9qSjepyOLam7dNTPTMe2Nx1uqadPBMfH8EhuTXIn-GS9weGbqBNcj2GDT_AGR0sc_y2QIzpeIITfn66CMILR-jSZAI7ejSHGK6flGzjZrN9CA0EMWvFJ98ve6AXyPM9DQileej9poWDESm3MGMHd7W93t5_ubj-BYVRBA-fUHGnFL55o2Rvdtm7vW7mQlpcGRq1l6M8AAAD__xp9bvc=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVO1u2zYU_R0-xYX_2B4sR47RIbCRH67DtNpcOZCUfiAICJqiFi4UmYqUZm0Y0IfIq-wF9ih5koFS4TibsmJLgfqHAV3ee865RzzyPHjLCyO0msFSs5tCU3Z9-hL4lrNNKWTKC7DcWKjaLoRinEBKLd1Qw-EE-u60PwfwPEh5RktpoaKy5DNoW4Wx5qOEE9BZ1tlGS6ubVqFSviUFZzrPuUqpFVoZwhXdSJ7-C4BWzXjBdZHygvyshTJEilxYOIHvp50zx-0iy9VFnOAIYpwkQfgKzEc5ZkW6IUJZXigqx9axk0L_QoylVhgrmBlTQ3RGrMgbB7zJn3-Ybgu8iW-eJPrca8YPHvV1lnUj7VzqQnLSzNi15NQKRpiWkjPn3_jBvn5GpeHd6LYo-f9Bz4VyvrQOGUfyopvghe9_AT_TBWfUWPP1JJvaWJ6T5hUa4hZo61-BoOKsua7jlFte5EI1N4NkYlvePiJwKN34DTVCFzFuEjZHywgvEgzJ4uUKw225kYKNtzBABxSCMDmGcJ1AeLFajdDB5nOlfVquwziJFkGYwJbc3vAazqPgzSL6AD_iDzCgsIiXwxE6CMJT_B62ZENEuoXBpqmjIbwLktcwMOya55RIzW4a6U75cD5HaLFy27eynNLxTlsQ_oCXCcTJIgniJFjG0L9EAAC_Nf_u16PVT8SIX3lvBv7oocy0LHNlejO43BXb_t7u-Wq_v-DU8pRQ25tB78ifHHv-xPMn4E9mvj_z_d5ec8olrUnKJbeOt3F6_9i9LMUsYbpUDm_i70u7FsZqd8uJrW_dfG8fW6RuYK-gSil3SPs47qOxYziaTo6mzdnvo-datPkWFjUL_DeXjp7jErrqz7-Ujtqlo_xHOqqn0lF3pKN8nI6aVG06qmemo-5Mh1vq6YnF6Sk8kluRzAk-W0c4eBW2gqshRPgMRzhc4vhvgRzQ4Rwh_P58tQhCGKzPkxHg8O0QYrxyWr6Ds2j9Bmp49xpHGEo4gekceZ7nIcOoghrB_d3d_d2n-7tPwLQytqBC2RkcTmZweTgFDw6nV-ivAAAA__8WVGOy

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVO9u27YX_Rw-xYW_2P7BcuQYLQIb-eA6TKvfXDmQlP5BEBA0RS1cKDIVKc3aMKAPkVfZC-xR8iQDpcJxNqXFlgLLhwC6vPeccw957HnwjhdGaDWDpWY3habs-vQV8C1nm1LIlBdgubFQtV0IxTiBlFq6oYbDCfTdaX8O4HmQ8oyW0kJFZcln0LYKY80nCSegs6yzjZZWN61CpXxLCs50nnOVUiu0MoQrupE8_QqAVs14wXWR8oL8pIUyRIpcWDiBl9POmeN2keXqIk5wBDFOkiB8DeaTHLMi3RChLC8UlWPr2EmhfybGUiuMFcyMqSE6I1bkjQPe5I_fTbcF3sQ3TxJ96TXjB4_6Osu6kXYufRWp24P-y2k36PGTiG5ZM3akObWCEaal5MzdyPjhQvoZlYZ3Q9ui5P8GPRfKOd16bhzJi26CF77_DfxMF5xRY833k2xqY3lOmkdhiFugrX8HgoqzJgDjlFte5EI1b41kYlvePiJwKN34DTVCFzFuMjtHywgvEgzJ4tUKw225kYKNtzBABxSCMDmGcJ1AeLFajdDB5kul_VquwziJFkGYwJbc3vAazqPg7SL6CD_gjzCgsIiXwxE6CMJT_AG2ZENEuoXBpqmjIbwPkjcwMOya55RIzW4a6U75cD5HaLFy27eynNLxTlsQ_h8vE4iTRRLESbCMoX-JAAB-bf67vx6tfiRG_MJ7M_BHD2WmZZkr05vB5a7Y9vd231f7_QWnlqeE2t4Mekf-5NjzJ54_AX8y8_2Z7_f2mlMuaU1SLrl1vI3T-8fushSzhOlSObyJvy_tWhir3Ssntr518719bJG6gb2CKqXcIe3juJ-hHcPRdHI0bc5-Gz3Xos1_YVGzwD9z6eg5LqGr_vxb6ahdOsq_paN6Kh11RzrKx-moSdWmo3pmOurOdLilnp5YnJ7CI7kVyZzgs3WEg9dhK7gaQoTPcITDJY7_EsgBHc4Rwh_OV4sghMH6PBkBDt8NIcYrp-V_cBat30IN79_gCEMJJzCdI8_zPGQYVVAjuL-7u7_7fH_3GZhWxhZUKDuDw8kMLg-n4MHh9Ar9GQAA___VtX4c

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVO1u2zYU_R0-xYX_2B4sR47RIrCRH67DtNpcOZCUfiAICJqiEi4UmYqUZ2UY0IfIq-wF9ih5koFS4Tib0mJLgeZHAF3ee865hzz2PHjHCyO0msBcs-tCU3Z1_Ar4hrNVKWTKC7DcWFg3XQjFOIGUWrqihsMRdN1pdwrgeZDyjJbSwprKkk-gaRXGmk8SjkBnWWsbLa2uW7miK8nJrbi8pZfkVy2Um1KtQzrL6hmhUr4hBWc6z7lKqRVaGdIgpV8h1aoeL7guUl7UZIZIkQsLR_By3Dpz2Cw_X5zFCY4gxkkShK_BfJJDVqQrIpTlhaJyaOs9Cv0bMZZaYaxgZkgN0RmxIq9d80Z__WnabfNGvnmS6EuvGT742tVZ1o60dfarSO0edF-O20EPn0R0y5qhI82pFYwwLSVn7kaGDxfSzag0vB3aFiX_P-i5UM7pxnPjSF60E7zw_W_gZ7rgjBprvp9kUxnLc1I_CkPcAk39OxCsOasDMEy55UUuVP3WSCY25c0jAofSjl9TI3QW4zrnUzSP8CzBkMxeLTDclCsp2HADPbRHIQiTQwiXCYRni8UA7a2-VJqv-TKMk2gWhAlsyM01r-A0Ct7Ooo_wC_4IPQqzeN4foL0gPMYfYENWRKQb6K3qOurD-yB5Az3DrnhOidTsupbulPenU4RmC7d9I8spHW61BeHPeJ5AnMySIE6CeQzdcwQA8Hv93_116PqSGHHLOxPwBw9lpmWZK9OZwPm22PR3tt8Xu_0Fp5anhNrOBDoH_ujQ80eePwJ_NPH9ie93dppTLmlFUi65dby107vH7rIUs4TpUjm8kb8r7UoYq90rJ7a6cfOdXWyRuoGdgiql3CLt4rifoS3DwXh0MK7P_hg816LVj7CoXuC_uXTwHJfQRXf6rXRULh3lv9KxfiodVUs6ysfpqMi6Scf6memoWtPhlnp6YnZ8DI_krknmBJ8sIxy8DhvB6z5E-ARHOJzj-B-B7NH-FCH84XQxC0LoLU-TAeDwXR9ivHBafoKTaPkWKnj_BkcYSjiC8RR5nuchw6iCCsH93d393ef7u8_AtDK2oELZCeyPJnC-PwYP9scX6O8AAAD__71oj5k=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVF1u4zYQfg5PMfCL7cJy5Bi7CGzkweswu2q9ciAp-4MgIGiKSthIpFekVCtFgT1ErtIL9Cg5SUFp4TitskGbAOsHAxrOfPPNN_zoOPCB51ooOYG5Yte5ouzq-A3wDWerQqQxz8FwbaBsshAKcQQxNXRFNYcj6NrT7hTAcSDmCS1SAyVNCz6BJlVoo7-kcAQqSVrTaGFUncolXaWc3IjLG3pJflVC2irZWqSSpK4RMuYbknOmsozLmBqhpCYNUvydpkrW5WptRCZueE4KzcmV0EZd5jTTT1fmXOUxz2uamqQiEwaO4PW4teawkW2-OAsjHECIo8jz34L-kg5ZHq-IkIbnkqZDUyuQq9-INtQIbQTTQ6qJSogRWa23M_rrT90uuDNy9aONvuXq4f1GuipJ2pG2O_kuUrsG3dfjdtDDRxHtsHpom2bUCEaYSlPO7C6H96vsJjTVvB3a5AX_P-iZkFbpRnO79e6r9gavXPcJ_ETlnFFt9MtR1pU2PCP1pdDEDtDEX6BByVltnWHMDc8zIeu7RhKxKdYPGliUdvy6NUJnIa5fiCmaB3gWYYhmbxYY1sUqFWy4gR7ao-D50SH4ywj8s8VigPZW3yLN13zph1Ew8_wINmR9zSs4Dbz3s-Az_II_Q4_CLJz3B2jP84_xJ9iQFRHxBnqrOo768NGL3kFPsyueUZIqdl1Tt8z70ylCs4WdvqFlmQ633Dz_ZzyPIIxmkRdG3jyE7jkCAPi9_re_Di0viRY3vDMBd3AfZiotMqk7EzjfBpv8zvb7Yjc_59TwmFDTmUDnwB0dOu7IcUfgjiauO3Hdzk5yzFNakZin3Ni-tdK7x3ZZkhnCVCEt3sjdpVY_Y_aWE1OtbX1nF1vEtmAnIIs03SLt4thnaNvhYDw6GNdnfwyeK9HqR0hUD_DfVDp4jkroojt9yh2VdUfxL3eUj7mjanFH8dAdFSkbd5TPdEfV6g471OMVs-NjeEC3JIklfLIMsPfWbwiXfQjwCQ6wP8fhPwzZo_0pQvjT6WLm-dBbnkYDwP6HPoR4Ybn8BCfB8j1U8PEdDjAUcATjKXIcx0GaUQkVgrvb27vbr3e3X4EpqU1OhTQT2B9N4Hx_DA7sjy_Q3wEAAP__rnuj5A==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJzEVN1u2zgTvY6eYuAb2x8iR47RIrCRC9dhWn3ryoGk9AdBQNAUlXBDka5Iea0sFuhD5FX2BfZR8iQLUoXj7CrtdlNgfWFAw5kzh2fm0PfhHSs1V3IMM0VvSkXo9ckrYBtGlxUXGSvBMG1g3WR5XoJSyIghS6IZHEPXnnYnAL4PGctJJQysiajYGJpUro3-JOAYVJ63ppHKKJfKJFkKhm_51S25wj8rLm2VbC1See5quMzYBpeMqqJgMiOGK6lxg5R9pamSrlytDC_4LStxpRm-5tqoq5IU-nsri0oYTpXA2hDzD6pLpsqMle6SGgtecAPH8HLUWnPUiD6bnycpiiFBaRpGr0F_EgNaZkvMpWGlJGJgnH6l-sXR4NpwqgdEY5Vjwws3LX_4x--6fVz-MNBPNvqSqwcP8-yqPG9H2k70q0jtGnRfjtpBj55EdJoPbNOCGE4xVUIwajdh8LAI3ZwIzdqhTVmxf4NecGmVbjS3U---aG_wIgi-gZ-rklGijf5xlHWtDSuwWwqN7QWa-A9osGbUGW-QMcPKgku3azjnm2r1qIFFacd3rT3vPEHufZl4sxhNUwTp9NUcwapaCk4HG-h5ewTCKD2CaJFCdD6f73t7yy-R5mu2iJI0noZRChu8umE1nMXh22n8EX5CH6FHYJrM-vveXhidoA-wwUvMsw30li7u9eF9mL6BnqbXrCBYKHrjqFvm_cnE86Zze_uGlmU62HILo_-jWQpJOk3DJA1nCXQvPACAX92__XXI-gprfss6Ywj2H8JUiaqQujOGi22wye9svy9380tGDMswMZ0xdA6D4ZEfDP1gCMFwHATjIOjsJGdMkBpnTDBj-zqld4_tsCQ1mKpKWrxhsEvNPYJ2y7GpV7a-s4vNM1uwE5CVEFukXRz7DG07HI6GhyN39tv-cyVa_hcSuQt8n0qHz1HJu-xOvuWO2rqj-ps71k-5o25xR_XYHTVeN-5YP9Mddas77KWerpienMAjumucW8KnixiFr6OG8LoPMTpFMYpmKPmLIXukP_E89OFsPg0j6C3O0n1A0bs-JGhuufwPTuPFW6jh_RsUI6jgGEYTz_d939OUSKg9uL-7u7_7fH_3GaiS2pSESzOGg-EYLg5G4MPB6NL7MwAA__-FG7nl

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk8-O0zAQxu95irkVEInaLf3DVj2UYFClNrs0abU3y3UmwuDYW49TyoPxAjwZcoJYIWUXCe0tij__Ps83M3EMB3SkrLmG1Mqvzgr5-f07wAvKY6N0iQ48kodzp4qinBVQCi-OghCWMAingwVAHEOJlWi0h7PQDV5DJ1Xk6aRhCbaqemWi8baVKlPihTuUtq7RlMIra4ijEUeN5RMAa9rrDq0r0fEvVhniWtXKwxKm4947866QdLPPC7aDnBXFOvsIdNKJdOWRK-PRGaETH9y5s984eeEVeSUpEcRtxb2q2wTi0c8f1B9BPBrSo0a_tZQ8ZDSwVdVP-pPSk6T-DAbTcT90_igxFEtJMK2FV5JLqzXK0JHkoSGDSmjCfrR3Df4PvVYmJN1lTsFk0m8wGQ7_wa-sQynI0_M9mb6Tx5q3Q0E8FND9fwaDM8p2AZISPbpamXbWeKUuzf1fBoHSz2-to2ifs3ZnF1G6Y6uCQc4-7VmWMrhvjlrJhPAE23V2WG32DEawXd11n2-vrsbj2dVwPJ1P3sxmk_lwBuss3bEtywoYQV6sdgWMFosoYne3m9U6gxc3t8VrYNnhJeRsw9ICXsGH3c0WCE-LKI7jOCI8NWgkxoShyeEk-hUAAP__SqpzFA==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJzEVdFu2zYUfQ6_4sIvtgfLkWO0CGwEmOqwrTZXCSQlaREEBEVRCxeJTEVKszcMKPYNedxv7Af2KfmSgVLqOK3SYkuB5SGALi_POfeQh3YcOOWlFkrOYKHYVakouzx8AXzFWVKJPOUlGK4N1G0XQhGOIaWGJlRzOIC-Xe3PARwHUp7RKjdQ07ziM2hbhTb6fQ4HoLKss41WRjWtQqZ8RUrOVFFwmVIjlNSES5rkPP0CgJLN9pKrMuUl-VkJqUkuCmHgAJ5PO_fst4MslidRjEOIcBz7wSvQ7_MxK9OECGl4KWk-NpadlOoXog01QhvB9JhqojJiRNE44Ez-_kt3W-BMXP0o0V2vHt971FdZ1o20cemLSN0e9J9Pu0H3H0W0w-qxJS2oEYwwleec2RMZ3x9IP6O55t3Qpqz4f0EvhLROt55rS_Ksm-CZ634FP1MlZ1Qb_e0k67U2vCDNpdDEDtDWvwFBzVkTgHHKDS8LIZu7RjKxqq4fEFiUbvyGGqGTCDeZnaNFiL0YQ-y9WGK4rpJcsPEKBmiHgh_E-xAcxRCcLJcjtJPcVdqvxVEQxaHnBzGsyPUVX8Nx6L_xwnfwI34HAwpetBiO0I4fHOK3sCIJEekKBklTR0M48-PXMNDskheU5IpdNdKt8uF8jpC3tNO3sqzS8UabH_yAFzFEsRf7UewvIuifIwCA35r_9q9H65-IFr_y3gzc0X2ZqbwqpO7N4HxTbPt7m--L7f6SU8NTQk1vBr09d7LvuBPHnYA7mbnuzHV7W80pz-mapDznxvI2Tm8v28OSzBCmKmnxJu62tEuhjbK3nJj1td3f28YWqd2wVZBVnm-QtnHsM7Rh2JtO9qbN2u-jp1qU_B8WNQP8O5f2nuISuujPv5aOtU1H9Vk66sfSse5IR_UwHWtSt-mon5iOdWc67FCP7_AOD-GB3JpkVvDLoxD7r4JWcD2EEL_EIQ4WOPokkAM67DLt1MdnHz2rmxfFviEjtFNZt9AQvAgivLRq6QiSEVQjqOFlePTmIf7oE71nr3GIIYEDmFor8NvjpecHMDg6jkeAg9PhR9TvWrB6jhzHcZCQkpeO_dmDASuV1kMEtzd_3t58uL35AJpRCevPKqvv714uu_KHvSO3Nzd3DUxJbUoqpJnB7t7uZAbnu1NwYHd6gbbaMpEbXmoYNKeH_gkAAP__3evC2w==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk9FO3DoQhq_xU8xddo9IBEIgxIqLkJO2aUMWbQwtqirL60yES2KDx0uXB-sL9MkqJ1VRpUClitvdP98389uOY7hCR9qaE8isunVWqpv_zwC3qNYb3TXowCN5eBhTjNU5h0Z6uZaEcApR-DdaAMQxNNjKTefhQXYbPIExqsnTfQenYNt2MiY33g5RbRrcCofK9j2aRnptDQk0ct1h8wLAmuFzh9Y16MRXqw2JTvfawykcHUx-czwukpWXNc9XUOecF9VboPsuUa5ZC208OiO7xAe7cPabIC-9Jq8VJZKEbYXX_dBAvP_jO01XEO_v0bOiX1lKnjqKbNtOk3639CJpuoPo6GAaevwsMSxLSZD20msllO06VOFEkqcDiVrZEU6jvdvgv9B7bULTY-cUJIfTgsO9vb_wW-tQSfL0eiPTI3nsxXApSIQFxt9fQfCAangASYMeXa_NcNdEq7ebuz8EgTLNH9SMXdb58GYXLFvlKc-Bp2dlDpR4mLEdCUXFj6Facqguy3KX7WTLquartKg4eHF3i49wsSrO09U1fMivYSYhrbM5m8PHgr-DGakb7KXorLod5gnjzBcLxtIyrDS6gj4JwqJ6n2ccap7youZFVkP0-Uu0YCz_dFGmRQWz5QXfhby6mkOdlyH7H7xZLc_DuAsWx3HMSEkDnv0MAAD__2vSgPY=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk1Fq20AQht91inlzDJGwCQkhwQ9pKkrAuKF2TN-W0WqUbrParXdGrvOWQ_gqvUCP4pOUlUpDYZNCyevqn-_XfhrlOawpsPHuAq69fgge9Zf374B2pKvO2JoCCLHAdkhl2bJcQY2CFTLBDEbx6egSIM-hpgY7K7BF29EFDNHhTElAx6jFeKc2HVojj8o3iilsjY6gCvXDffCdq5OwQPedxTAwDQtvLMzAN00yjZ34PmpcTTsVSPu2JVdj7GdFDitL9SsA7_rxQD7UFNRXbxwra1ojMIOzk-TM-SDnen63XJWfYFmuVjeLD8AbW-hQV8o4oeDQFhLbVfDfFQuKYTGaC-ToQ0zbW82nP39wWms-nfCLRb-zXDw7GvmmSZP-WHqVlHYwOjtJQ89fJMbLchFLWxSjlfbWUr8RxfMHGTVomdJoCR39D701LpoenHMsOU0XnE4m_-A3PpBGFn67V-ZHFmpVvxSs4gWG8zco2JLuf4CiJqHQGtfvmmrMrvv2V0GkpPl9dZaVn2_nVzcLOPp4uzqGcrEew_pqflcu4Wg6vszyPM-zfoIzOOz3h_3TYf8ER9PjcfYrAAD___xrd2k=

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJysk1Fq20AQht91inmzDZGwCQkhwQ9pKkrAuKFWTN-W9WrUTrvarXdGrvOWQ_gqvUCP4pOUlUpDYZNCyevqn-_XfhrlOawxMHl3CTfefA1em89v3wDu0Ww6sjUGEGSB3ZDKslVZQa1FbzQjzGEUn46uAPIcamx0ZwV22nZ4CUN0OFMStGNthLxT205bkgflG8UYdmQiyAQSMtomUQE_dVaHgUgsvLUwB980ybTuxPdRcjXuVUDj2xZdrWM7K3R6Y7F-AeBdPx7QhxqD-uLJsbLUksAczk-TMxeDmpvF_aoqP8CqrKrb5TvgrS1MqDeKnGBw2hYS21Xw3xWLFmIhw4XmaEOo7Z3ms58_OC01n0352aLfWS6eHI1806RJfyy9SEo7GJ2fpqEXzxLjZbmIpa0WMsp4a7Hfh-Lpg4wabRnTaAkd_g-9JRdND845lpylC86m03_wGx_QaBZ-vVfmBxZsVb8UrOIFhvNXKNih6X-AokbB0JLrd001tO--_VUQKWl-X51l5ce7xfXtEsbv76oTKJfrCayvF_flCsazyVWW53me9ROcwfFwOB4ej4dHGM9OJtmvAAAA__9pOXaU

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJzElOFu2zYQxz9XT3HwF9uDZcgJWgQ28sF1lE6bKweW0rUoCoKiTg1nSnRISrM87LH2AnuygVLhOK3cbkuB-YMBHY-_u_-fPLouvEGluSymsJBsoyRld1cvAXfIkpKLFBUY1AaqNstxIj-GlBqaUI1wCX272p8BuC6kmNFSGKioKHEKbWobI0bRQlNmuCzIfUkFNzWRGdGoKs4siCluOKOiE6XwYymoaolcG30v4BJklnVm09LIJpUXKe6IQibzHIuU2uqaYEETgelXALJotiuUKkVFfpW80ETwnBu4hBfnnXsuWmsWy9so9tcQ-XEchK9A34sxU2lCeGFQFVSMja1OlPyNaEMN14YzPabaumF43njqTv76U3eb6k48fbLQp1w9fvCoL7Osm3Rw6aukbg_6L867oRcniVasHtuiOTWcESaFwOY-jB8OpJ9RobEbbVSJ_4We88I63XqubZHn3QWee943-JlUyKg2-vu1rGttMCfNpdDECmjj36FAhawZgHGKBlXOi-aukYzvyu2jApbSzW9KO85t5DevwMxZrP157EM8f7n0YVsmgrPxDgbOMwpBGF9AuIohvF0uR86z5FOk_Vqswihez4Mwhh3ZbrCGm3Xwer5-Bz_772BAYR4thiPnWRBe-W9hRxLC0x0MkibuDOGXIP4RBprdYU6JkGzTtG47H85mjjNfWvVtW7bT8aG3IPzJX8QQxfM4iOJgEUH_vQMA8Hvzb389Wn0kmu-xNwVv9BBmUpR5oXtTeH8Itvm9w_eH43yF1GBKqOlNoXfmTS5cb-J6E_AmU8-bel7vKDlFQWuSokBj6zZOHy_bwyqYIUyWheVNvOPW7rg20t5yYuqt3d87ZvPUbjgKFKUQB9Ixxz5Dhwpn55Oz82btj9FTLUr-D4saAf_OpbOnuOR86M--NR21nY7yi-moTk1H3TEd5ePpqEnVTkf1xOmoO6fjH4jaW1HbzReqFGandO07dG03TxSwPyngtOT51RU88rsime3serX2g1dh21k1hLV_7a_9cOFHn70oAzo8zd9_zs82j8kKs5PsGgblcOY4_tub5TwIYbC6iUfgh2-GEPlLq_MHuF6vXsN-5riu6zqa0QL2zt8BAAD__-jw3h4=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJzElOFu2zYQxz9XT3HwF9uDZcgJWgQ28sF1lE6bKweW0rUoCoKiTg1nSnRISrM87LH2AnuygVLhOK3cbkuB-YMBHY-_u_-fPLouvEGluSymsJBsoyRld1cvAXfIkpKLFBUY1AaqNstxIj-GlBqaUI1wCX272p8BuC6kmNFSGKioKHEKbWobI0bRQlNmuCzIfUkFNzWRGdGoKs4siCluOKOiE6XwYymoaolcG30v4BJklnVm09LIJpUXKe6IQibzHIuU2uqaYEETgelXALJotiuUKkVFfpW80ETwnBu4hBfnnXsuWmsWy9so9tcQ-XEchK9A34sxU2lCeGFQFVSMja1OlPyNaEMN14YzPabaumF43njqTv76U3eb6k48fbLQp1w9fvCoL7Osm3Rw6aukbg_6L867oRcniVasHtuiOTWcESaFwOY-jB8OpJ9RobEbbVSJ_4We88I63XqubZHn3QWee943-JlUyKg2-vu1rGttMCfNpdDECmjj36FAhawZgHGKBlXOi-aukYzvyu2jApbSzW9KO85t5DevwMxZrP157EM8f7n0YVsmgrPxDgbOMwpBGF9AuIohvF0uR86z5FOk_Vqswihez4Mwhh3ZbrCGm3Xwer5-Bz_772BAYR4thiPnWRBe-W9hRxLC0x0MkibuDOGXIP4RBprdYU6JkGzTtG47H85mjjNfWvVtW7bT8aG3IPzJX8QQxfM4iOJgEUH_vQMA8Hvzb389Wn0kmu-xNwVv9BBmUpR5oXtTeH8Itvm9w_eH43yF1GBKqOlNoXfmTS5cb-J6E_AmU8-bel7vKDlFQWuSokBj6zZOHy_bwyqYIUyWheVNvOPW7rg20t5yYuqt3d87ZvPUbjgKFKUQB9Ixxz5Dhwpn55Oz82btj9FTLUr-D4saAf_OpbOnuOR86M--NR21nY7yi-moTk1H3TEd5ePpqEnVTkf1xOmoO6fjH4jaW1HbzReqFGandO07dG03TxSwPyngtOT51RU88rsime3serX2g1dh21k1hLV_7a_9cOFHn70oAzo8zd9_zs82j8kKs5PsGgblcOY4_tub5TwIYbC6iUfgh2-GEPlLq_MHuF6vXkM9c1zXdR3NaAG183cAAAD__-jf3hw=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJzElOFu2zYQxz9XT3HwF9uDZcgJWgQ28sF1lE6bKweW0rUoCoKmTg1nSnRISpM87LH2AnuygVLhOK3cbkuB-YMBHY-_u_-fPLouvEGlucynsJBsqyRld1cvAStkm4KLBBUY1AbKNstxIj-GhBq6oRrhEvp2tT8DcF1IMKWFMFBSUeAU2tQ2RoyiuabMcJmT-4IKbmoiU6JRlZxZEFPccEZFJ0rhx0JQ1RK5NvpewCXINO3MpoWRTSrPE6yIQiazDPOE2uqaYE43ApOvAGTebFcoVYKK_Cp5rongGTdwCS_OO_dctNYslrdR7K8h8uM4CF-BvhdjppIN4blBlVMxNrY6UfI3og01XBvO9Jhq64bhWeOpO_nrT91tqjvx9MlCn3L1-MGjvkzTbtLBpa-Suj3ovzjvhl6cJFqxemyLZtRwRpgUApv7MH44kH5KhcZutFEF_hd6xnPrdOu5tkWedxd47nnf4KdSIaPa6O_Xsq61wYw0l0ITK6CNf4cCJbJmAMYJGlQZz5u7RlJeFbtHBSylm9-UdpzbyG9egZmzWPvz2Id4_nLpw67YCM7GFQycZxSCML6AcBVDeLtcjpxnm0-R9muxCqN4PQ_CGCqy22INN-vg9Xz9Dn7238GAwjxaDEfOsyC88t9CRTaEJxUMNk3cGcIvQfwjDDS7w4wSIdm2ad12PpzNHGe-tOrbtmyn40NvQfiTv4ghiudxEMXBIoL-ewcA4Pfm3_56tPxINN9jbwre6CHMpCiyXPem8P4QbPN7h-8Px_kKqcGEUNObQu_Mm1y43sT1JuBNpp439bzeUXKCgtYkQYHG1m2cPl62h5UzQ5gscsubeMet3XFtpL3lxNQ7u793zOaJ3XAUyAshDqRjjn2GDhXOzidn583aH6OnWrT5PyxqBPw7l86e4pLzoT_71nTUdjqKL6ajPDUddcd0FI-noyZlOx3lE6ej7pyOfyBqb0Xttl-oUpie0rXv0LXbPlHA_qSA05LnV1fwyO-SpLaz69XaD16FbWflENb-tb_2w4UfffaiDOjwNH__OT_dPiYrTE-yaxgUw5nj-G9vlvMghMHqJh6BH74ZQuQvrc4f4Hq9eg3VzHFd13U0ozlUzt8BAAD__-jO3ho=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJzElNFu2zYUhq-jpzjwje3BMuQELQIbuXAdpdPmyoGldC2KgqCpo4YzJTok5Vke9lh7gT3ZQKlwnFRq1yVAcxHAR4ff_59fPHJdeItKc5mPYSbZWknKbi9fAe6QrQouElRgUBvY1l2OE_kxJNTQFdUIF9C1T7sTANeFBFNaCANbKgocQ91a14hRNNeUGS5zcldQwU1JZEo0qi1nFsQUN5xR0YhS-KkQVNVEro2-E3ABMk0bu2lhZNXK8wR3RCGTWYZ5Qq26JpjTlcDkKwCZV8cVSpWgIr9LnmsieMYNXMDLs8Yz53U0s_lNFPtLiPw4DsLXoO_EkKlkRXhuUOVUDI1VJ0r-QbShhmvDmR5SbdMwPKsydUf__K2bQ3VHnm4V-tyrh_cZdWWaNpMOKX2V1JxB9-VZM_S8lWiH1UMrmlHDGWFSCKzuw_D-hXRTKjQ2o40q8P_QM57bpOvMtRV50SzwwvO-wU-lQka10c9nWZfaYEaqS6GJHaCuP4PAFlm1AMMEDaqM59VdIynfFZsHApbSzK-kHecm8quvwMSZLf1p7EM8fTX3YVOsBGfDHfScEwpBGJ9DuIghvJnPB87J6nOl_jVbhFG8nAZhDDuyWWMJ18vgzXT5Hn7130OPwjSa9QfOSRBe-u9gR1aEJzvoraq604ffgvhn6Gl2ixklQrJ1Zd06708mjjOd2-lrW9bp8OAtCH_xZzFE8TQOojiYRdD94AAA_Fn9t38duv1ENN9jZwze4L7MpCiyXHfG8OFQrPs7h98fj_sVUoMJoaYzhs6pNzp3vZHrjcAbjT1v7Hmdo-YEBS1JggKN1a2SPn5sX1bODGGyyC1v5B1bu-XaSHvLiSk39nznmM0Te-CokBdCHEjHHPsZOiicno1Oz6pnfw2eGtHqR0RUDfB9KZ0-JSXnY3fyre3Y2-3YrL9YD4Vp24LsGxZks37iJuwbN-E_DFDaAYov_G_b3JcN7ouH612Sbb3e2ycOVbYO1R7D9PISjuyma7haLP3gdVhbVZj2Yelf-Us_nPnRI7le0W9nl4_Zds7UhvFAYdvK30GPfg__sfd28t7eoP7Ecfx31_NpEEJvcR0PwA_f9iHy5zbCn-BquXgD5cRxXdd1NKM5lM6_AQAA___yRPkx

# Check that we remove histograms from statistics correctly.

statement disable-cf-mutator ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJzEVO1u2zYU_R0-xYX_2BksQXaaLrWRH46jbtpUObCUrEVREBRFNVwoMiEpN96wx9oL7MkGUq3jDUr2gQD1DwO-99xzfM69UhDAFdOGKzmDpaI3WhF6fX4G7J7RsuWiYhosMxY2HQqhPC6gIpaUxDA4haHrDucAQQAVq0krLGyIaNkMOmhXw1YTaQi1XEl81xLB7RarGhumN5w6Iqq55ZSIXirNPraC6I6RG2vuBJyCquteNGmt8lAuK3aPNaOqaZisiFM3mElSClY9QaCkH9dM6Ypp_LPi0mDBG27hFF4e9c6cdNEs08u8iNeQx0WRZN-BuRMh1VWJubRMSyJC69SxVp-wscRyYzk1ITEuDcsbn2kw-eN30x9qMInMo0KfsSZ8yGio6rqfaZfSk0z9GQxfHvWTnjzK6Mya0Ik2xHKKqRKC-XsIHxYyrIkwrJ_a6pb9H_aGS5d0l7lxIsf9AsdR9A_8tdKMEmPN8_1lszWWNdgfhcHOQFd_BoENo_4BCCtmmW649LeGa37f3v5FwLH083tphC7z2L8F5mi5jhdFDMXiLI3hti0Fp2EJI3RQwtlqlUK2KiC7TNMxOtDqE68gyYoTX71K8sQNfUHAefx6cZkW0Ep-1_rl8Gp0OEYHy1WWF-tFkhVQ4tsbtoWLdfJmsX4HP8bvYNTxLvKlwybZefwWSlxiXt3DqPR1dAg_JcX3MDL0mjUEC0VvvFNn9HA-R2iRurA6F85YuLOSZD_EywLyYlEkeZEscxi-RwAAv_pv9xmQzUds-C9sMIPJ-KFMlWgbaQYzeL8r-kY52P3-sI_XjFhWYWIHMxhMo-k0mEyDaAqTk9nRi9n0VXj87YtXR9PB3kzFBNniiglmnbzfz37brVhSi6lqpaOd7jWvubHKPRnYbm_d9GCfmVd_syNJ40HYXyXG-2DZCrHTiPYa7rX2pT6ZRJHv_DZ-IsHo3yTod_71Uoz-W4rT50zxc4Tow3COUPz2Il0kGYxWF8UY4uzqEPI4dQf7Dbxer95AOUdBEATIUCKhRH8GAAD__wDmUbs=
