# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4kIvtQdTkWIUKBQEmOoymzZXDiStaxEEBEXRLVGZTEXKkzcM6Ef4V_YD-5R8yUDZsb3Z24oN0YMA3nvOufcQhxjDG9EYqVUEE80_NprxD69egugEL1tZV6IBK4yF5QaFEMaQkwIqZlnJjICrvn8JgDFUYs7a2sKS1a2IADmgVJXoaCO4XiyEqpiVWhkqFCtrUcEV6Pn8JHk7K9UKP3Z43RorGjDCWqnem8gBAMyn2udNVVKprGgUq33rxGmjf6LGMiuNldz4zFA9p1Yu3M44_P03AzD4y1AcBma4V912jV9JY82nerPuMY21Vh_Q3FDju-KCWckp13UtuDPu733PWW3EsZRtWvFlUgupnL2NUQNX8PxY7XkQHInNdSM4M9b8x2XMylixoP0dG-pW29S_UA1NMhIXBIr45ZT02fHv27KW3O9ggM4YJGnxAtJZAekP0-kInZXbyuY0maV5kcVJWkBH7z-KFdxkyes4ewffk3cwYBDnk-EInSXpK_IWOlpSWXUwKPs6Gl4iFE8Lkp0cn6TfkUkBeREXSV4kkxye3SIAgF_6v_s8tnxPjfxZeBEEo32Z67pdKONFcLsrbvDe7nx3iG8Es6KizHoReBdB-AIHIQ5CCMIoCKIg8A7ALn1ScUu5bpUjhMHh7A_SWO2SQe3q3i3mHZJVW9c74iHNPY-d4MU4vBj3vV9H_9dy-SSW-w2fzjW6e3b5D9lcuWy2R9lc_l02Vyey2T5m80-4JZ075PUsI8k36Qa5HEJGrklG0gnJ4TGfA7YPtuP1wV7-e7BXJ4Pd-yVvb6ZxksJgdlOMgKRvhpCTqcN-BdfZ7DV08OO3JCNQwhWMLxHGGCPDmYLu6-3bQvCwXj-sPz-sPwPXytiGSWUjOL84DyO4PR8DhvPxHfojAAD___Hp2mQ=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sAvtQfTkWIUKBQEmOsymzZXDmStaxEEBEXRLVeZTEXKszcMKPYNftxv7Af2KfmSgbKTeHO2FSviBwO895xz7yEORQheydoqo2OMjXhfGy7evXgOuZKiaFRVyhpOWoflFhUEhGBGc5Tc8YJbibO2fwoQglLOeVM5LHnVyBiBBypdyhWrpTCLhdQld8poy6TmRSVLnMHM5w-Sd7NSo8ltR1SNdbKGlc4p_dbGHgDYD9VA1GXBlHay1rwaOC_OavMjs447ZZ0SdsAtM3Pm1MLvTKI_frdA929DSRTa3r3qrmsHpbLOfqi26x7SeOPMHs0PtQNfXHCnBBOmqqTwxgf3vue8svJQytWN_DSphdLe3taoxRmeHqo9DcMDsbmppeDW2f-5jF1bJxesvWPL_Grb-ieqBeOMjnKKfPR8QtvsDK6bolJisEI3OOJI0vwZ0mmO9LvJpB8cFbvK9jSeprM8GyVpjhW7fi_XuMiSl6PsDb6lb9DlGM3GvX5wlKQv6GusWMFUuUK3aOtB7zQIRpOcZg-OT9Jv6DjHLB_lySxPxjM8uQwA4Of23_86fPmWWfWT7MQI-_dlYapmoW0nxuVdcYvv3J2v9vG15E6WjLtOjM5JGD0jYUTCCGEUh2Echp09sE-f0sIxYRrtCVG4P_udss74ZDC3vvaLdfbJuqmqO-I-zT-PO8GTYXQybHu_9D_XcvEoltsNH891cPXk9F-yufbZbA6yufynbK4fyGZzm82_4JZs7pHn04wmX6Vb5LKHjJ7TjKZjOsNtPrv8Ptie1wZ7-d_BXj8Y7NYvfX0xGSUputOLvA-avuphRice-wXOs-lLrPpY4_uvaUZR4AzD04AQQgKltazJD0ZpdEVtrO0FuNn8drP5eLP5CCu4xvqgsvpy9xx951d_6zebzQ4gjLau5kq7GMcnx1GMy-MhCI6HV8EebK4qJ2uL7vZb8mcAAAD__14V_m0=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3tQfTkFMUKBTkQnWZQZsrB5JWtAgCgqKolitNpjqUI28Y0IfI5V5jL7BHyZMMlPLjze5WrKguBPGc7_vO-YRPIgReywaVNREsrPjQWC7ev3wBspOibJWuZANOooPNgAoCQiCnBVTc8ZKjhNO-fwJACFSy5q12sOG6lREEHqhMJTvWSGHXa2kq7pQ1yKThpZYVnIKt64Pku1mpNeS-I3SLTjaA0jll3mHkAQD4Uc9EU5VMGScbw_XMeXHW2GuGjjuFTgmccWS2Zk6t_c5k_ucfCDD-x1AyD3HyqHrXxVml0OFHPay7T-Otszs0PxRnvrjmTgkmrNZSeOOzR9811yj3pVzTyi-TWivj7Q1GEU7h2b7aszDcE6ttIwVHh_9zGdyik2vWv2NkfrWh_oVqwSKjcUGhiF8saZ-d2VVbaiVmHYyDIw5JWjyHdFVA-tNyOQ2OyrvKcFqs0rzI4iQtoGNXH-QWzrPkVZy9hR_pWxhziPPFZBocJelL-gY6VjJVdTAu-3owOQmCeFnQ7OD4JP2BLgrIi7hI8iJZ5PDkIgAA-LW_-2vEN-8Yql_kKIJw-lgWVrdrg6MILh6KA370cL7cxTeSO1kx7kYRjI7D-XMSzkk4h3AehWEUhqMdsE-fMsIxYVvjCfNwd_Z7hc76ZDC3vfKLjXbJptX6gbhL85_Hg-Dx0_nx07732_RrLZffxHK_4bdzHVw-OfmXbG59Ntu9bG4-l83tgWy299n8G27Dao88W2U0-T4dkJsJZPSMZjRd0Bzu8znmj8H2vD7Ym_8O9vZgsHu_9M35Mk5SGK_OiynQ9PUEcrr02O_gLFu9gg7iHKyR0-HJXduTgBBCAmWMbMjPVhkYi8YiTgK4vfn99ubT7c0nQMENdHDB8dQaefmZlru2fevmrlUr7WSDMB7-FH8FAAD__44s8tg=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k9Fu2zYUhq-jp_jhm9qD5UgxOgQKfOG6zKbNlQNZ61oEAUFRdMuVJlOR8uwNA_oQeZW9wB4lTzJQbmJv9rZiRX1hgIf_f875iU9hiJeittLoBBPD39WG8bfPn0GsBS8bqSpRwwnrsNqqgiAMMScFKuZYyazAqL2_AMIQlViwRjmsmGpEgsALpa7EmtaCm-VS6Io5abSlQrNSiQojmMXiqNno1l4LU1eipj8ZqS1VcikdRvh6eNRz3q6XGR0-XHDVWCdqWOGc1G9s4gWAfa8GvK5KKrUTtWZq4Pw-tDY_U-uYk9ZJbgfMUrOgTi59zDD-43cLdP82M4wj29t1_XhrB5W0zr5X24SHNtY4s2fzQ-3AF5fMSU65UUpw_1aD3VMtmLLisJWrG_FprZZS-3jboBYjPD3s9jSKDpotTC04s87-z2XsxjqxpO0bW-pX29Y_sVswycm4ICjGz6akxW1w25RK8sEa3eCEIc2Kc2SzAtkP02k_OCk_VranySybF_k4zQqs6e07scFVnr4Y56_xPXmNLsN4Pun1g5M0e05eYU1LKqs1umVbD3oXQTCeFiQ_Oj7NviOTAvNiXKTzIp3M8eQ6AIBf23__67DVG2rlL6KTIOrvytyoZqltJ8H1Y3Gr7zyeb_b1tWBOVJS5ToLOWRSfh1EcRjGiOImiJIo6e2JPn9TcUW4a7Q1xtD_7rbTOeDKo29z6xTr7Zt0o9Wjct_nP47Hh2TA-G7Z3v_U_N3L5RSK3G3651MHNk4t_YXPj2WwO2Fz9E5ubI2w2D2z-RbeiC6-8nOUk_SbbKlc95OSS5CSbkDke-OyyHdje14K9-m-wN0fBbvOSV1fTcZqhO7sq-iDZyx7mZOq1X-Eyn73ABj9-S3KCBiMML4IwDMPAcqaxCXB_d3d_9-H-7gO40dbVTGqX4DROcH06RIjT4U3wZwAAAP__bZnnkw==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1u2zYU_R09xYH_1B4sR4rRIVDgH67LbNpcOZC1rkUQEBRFt1xpMhUpz94woA-RV9kL7FHyJAPlfHiztxUr4h8GeO855557fRyGeC1qK41OMDH8Q20Yf__yBcRa8LKRqhI1nLAOqy0qCMIQc1KgYo6VzAqM2v4ZEIaoxII1ymHFVCMSBB4odSXWtBbcLJdCV8xJoy0VmpVKVBjBLBYHyXezMqPD-w5XjXWihhXOSf3OJh4A2I9qwOuqpFI7UWumBs6L09r8TK1jTlonuR0wS82COrn0nsP4j98t0P3b0DCObO9R9a5rB5W0zn5UW7v7NNY4c4hWC1NXoqY_GaktVXIpHUb4erivcLpD957twGsumZOccqOU4P5ug8ezLZiyYl_H1Y34PKml1P462ztZjPB8X-15FO2JLUwtOLPO_k8zdmOdWNL2J7LUW9vWP1MtmORkXBAU4xdT0kZvcN2USvLBGt3giCHNilNkswLZD9NpPzgq7yrb12SWzYt8nGYF1vT6g9jgIk9fjfO3-J68RZdhPJ_0-sFRmr0kb7CmJZXVGt2yrQe9syAYTwuSHxyfZt-RSYF5MS7SeZFO5nh2GQDAr-23_3TY6h218hfRSRD1H8vcqGapbSfB5UNxi-88vK928bVgTlSUuU6CzkkUn4ZRHEYxojiJoiSKOjtgH16puaPcNNoT4mh39ntpnfHJoG5z7Y11dsm6UeqBuEvz_64HwZNhfDJse7_1v3Tl8klWbh0-3dbB1bOzf8nmxmez2cvm6p-yuTmQzeY-m3_BrejCI89nOUm_ybbIVQ85OSc5ySZkjvt8dtljsD2vDfbqv4O9ORjsdl_y5mI6TjN0ZxdFHyR73cOcTD32K5zns1fY4MdvSU7QYIThWRCGYRhYzjQ2AW5vbm5vPt3efAI32rqaSe0SHMcJLo-HCHE8vAr-DAAA__8sdevh

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sAvtQfLkWJ0CBT4wXWZTZsrB7LWtQgCgqKolKtMpiLl2RkG9CPyK_uBfUq-ZKDUJN7sbcWG6kEA7z3n8NyrI9_Ha1EbqVWEmebva834u5cvIDaC542sClHDCmOx7lCe5_tYkgwFsyxnRmDS9s8A30chStZUFmtWNSKC54BCsbwS9FZe37Jr-pOWChNodZCgy7LlSFWIDa0F16uVUAWzUitDO6XC0cvyML_zl2jlP3R41RgrahhhrVTXJnIAwHyoRrwuciqVFbVi1ci2Nmv9MzWWWWms5GbEDNUltXLl5vTD338zQP8vl_phYAZPqp-6ZlRIY82HqrO7T2ON1YdotdB1Iep2U4ZWciUtJvh6vK9wukN3ns3Iaa6YlZxyXVWCu72NntZWssqIfR1bN-LzpFZSue10ezKY4Pm-2vMg2BMrdS04M9b8RzNma6xY0fYTGeqsdfXPVPNmKZlmBNn0xZy0cR3dNHkl-WiDvnfEECfZKZJFhuSH-XzoHeWfKt1ptkiWWTqNkwwbevNebHGRxq-m6Vt8T96izzBdzgZD7yhOXpI32NCcymKDft7WvcGZ503nGUkPXh8n35FZhmU2zeJlFs-WeHbpAcAv7ds9Pba-pkbeil6EYPhU5rpqVsr0Ilw-Fjt87_F8tYuvBbOioMz2IvROgvDUD0I_CBGEURBEQdDbAbvwSsUt5bpRjhAGu3e_k8ZqlwxqtzfOWG-XrJqqeiTu0tzf9Sh4Mg5Pxm3v1-H_HTn_IiO3Dr_c1N7Vs7N_yObWZbPZy-b677K5PZDN5iGbf8KtaemQ54uUxN8kHXI9QErOSUqSGVniIZ999hRsx2uDvf73YG8PBrudl7y5mE_jBP3FRTYESV4PsCRzh_0K5-niFbb48VuSEjSYYHzm-b7ve4Yzha2H-7u7-7uP93cfwbUytmZS2QjHYYTL4zF8HI-vvD8CAAD__7qn_V4=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvo6e4sA3tQfLkWJ0CBTkwnWZTZsrB7LWtQgCgqIol6tEpjyUZ2cY0IfIq-wF9ih5koFSE3uz1xUrogsBPOf7vvPDj74Pr4VBqVUEU83fG834u5cvQKwFzxtZFcKAFWhh1aE8z_dhQTIomGU5QwHnbf4MwPehECVrKgsrVjUiAs8BhWJ5JeitXN6yJf1FSwXnoNVBgi7LliNVIdbUCK7rWqiCWakV0k6pcPSyPMxXLV3fWFnLW2Fog4K-k2j10rAaP890kyVa-Q8ZXjVohQEU1kq1xMgBAPBDNeKmyKlUVhjFqpFtBzT6V4qWWYlWchwxpLqkVtZuQ3745x8I0P9HUT8McLBV_ZTFUSHR4oeqa3efxhqrD9GM0KYQpt0x0krW0sI5fDveVzjdobueceQ0a2Ylp1xXleBu46PtwktWodjXsaYRXyZVS-W20-3JXcTzfbXnQbAnVmojOEOL_7MZ3KAVNW2vCKlrrYt_oZo3TckkI5BNXsxIa_TRTZNXko_W0PeOGMRJdgrJPIPkp9ls6B3lnyLdaTpPFlk6iZMM1vTmvdjAZRq_mqRv4UfyFvoMJovpYOgdxclL8gbWNKeyWEM_b-Pe4MzzJrOMpAfLx8kPZJrBIptk8SKLpwt4duUBAPzW_t3XY6slRXkrehEEw22Y66qpFfYiuHoMdvje4_l6F28Es6KgzPYi6J0E4akfhH4QQhBGQRAFQW8H7MwrFbeU60Y5Qhjs1m5fo3MGtZsb11hvl6yaqnok7tLc63oUPBmHJ-M29_vwa0fOn2TktsOnm9q7fnb2GW9unDebPW-u_s2bmwPebB68-TfcipYOeTFPSfxd0iFXA0jJBUlJMiULePBnn22N7XitsVf_bezNQWO385I3l7NJnEB_fpkNgSSvB7AgM4f9Bi7S-SvYwM_fk5RAA-cwPvN83_c95EzBxoP7u7v7u4_3dx-Ba4XWMKlsBMdhBFfHY_DheHzt_RUAAP__GWsRuA==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvo6e4sA3tQfLkWJ0CBTkwnWZTZsrB7LWtQgCgqIolytFpiTl2RkG9CHyKnuBPUqeZCDVxN7srd2G-MKAzvm-7_x9DEN4zbThSiYwVfS9VoS-e_kC2JrRsuWiYhosMxZWHSoIwhAWqICKWFISw-Dc588AwhAqVpNWWFgR0bIEAgdkkpSC4Vu-vCVL_JPiEs5ByYMEVdeew2XF1lgzqpqGyYpYrqTBnVLl6HV9mC89Xd1Y3vBbpnFrGH7HjVVLTRrzb5lNKyynSmBjif0M2-0lUzJ8yFDRGss0GGYtl0uTOACA-SBGVFcl5tIyLYkYWb8erX72VbixnJoRMVjV2PLG7TeMf__NAPT_UjSMIzPYqn7KmlHFjTUfRNfuPo20Vh2iaaZ0xbS_kMGCN9zCOXw93lc43aH7zYycZkMsp5gqIRh19xptz1UTYdi-jtUt-zKphku3nW5P7hDP99WeR9GeWK00o8RY8x-bMRtjWYP9iQx2rXXxL1QLpjmaFAiKyYsZ8s9kdNOWgtPRGvrBEYE0K04hmxeQ_TCbDYOj8lOk-5rOs0WRT9KsgDW-ec82cJmnryb5W_gevYU-gcliOhgGR2n2Er2BNS4xr9bQL308GJwFwWRWoPxg-TT7Dk0LWBSTIl0U6XQBz64CAIBf_L_79chqiQ2_Zb0EouE2TJVoG2l6CVw9Bjt87_H7ehevGbGswsT2EuidRPFpGMVhFEMUJ1GURFFvB-zMyyW1mKpWOkIc7db2b9k5A9vNjWust0uWrRCPxF2ae12Pgifj-GTsc78O_-_I5ZOM7Dt8uqmD62dn_-DNjfNmu-fN1d95c3PAm-2DN_-EW-HaIS_mOUq_yTrkagA5ukA5yqZoAQ_-7JOtsR3PG3v1eWNvDhrbz4veXM4maQb9-WUxBJS9HsACzRz2K7jI569gAz9-i3IELZzD-CwIwzAMDCUSNgHc393d3328v_sIVEljNeHSJnAcJ3B1PIYQjsfXwR8BAAD__yl2J7k=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyckVFv0zAUhd_zK-7jhnDUrnQtrfpQipEqtdlos2pvluvcgMGxqe_NGD-MP8AvQ16GhsgeJt6inHO-e3QsBBwwkg1-Bqtgvsagzef37wDv0Rxb6yqMwEgMd50ry4SAvSyh0qyPmhAWD_ocQAiosNatY7jTrsUZZMlofYX3KqIJTYO-0myDJ4VeHx1WsIBQ18-GH28VwYs_inEtMUYgZLb-E82SAYBOLjexOirrGaPXLucEVzF8V8SaLbE1lGtSoVZsm9RZDH_9JICzf46K4YDOn6iPKuWVJaaT6-r2Y7rl8FwsYogVRvUlWE_K2cYyLOBy1CdM_4qnzpQnZqPZGmWCc2jSbvnTbLV2hH0OxxZfhmqsT-t0OxEsYNynjQeDHqwOEY0mpv8sQz-IsVEPT0QqVev-v5CWrXZyWUrYy483slhJ-NYenTU54Qm26-Kw3NxIGMJ2edt9vr24GI0mF4PR5XT8ZjIZTwcTWBerndzKooQh7MvlroThPMvk7fVmuS7g7Oq6fA2yOJzDXm7kqoRX8GF3tQXC0zwTQoiM8NSiNygI05xJyX4HAAD__5n3FWc=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3tQfJkWN0CGQYmOsymzZXDiQtbREEBEXRLVeZTElKszcMKPYMvtxr7AX2KHmSgZKduLW3FSviCwM65_u-86PvyPfhimsjlAxhqtg7rSh7-_wZ8BVneSXKgmuw3FioWxRCvg8pzqCglubUcBg3-RGA70PBF7QqLdS0rHgIyAGFLPiKaM7UcsllQa1Q0hAuaV7yAsagFouj5G2tWEl_l2FlZSzXYLi1Qr4xoQMAmPdln-kiJ0JariUt-9aJE61-JsZSK4wVzPSpIWpBrFi6nv3BX38agO4nRf1BYHoPqtus6RfCWPO-bNs9pNHKqmM0zZUuuCY_KSENKcVSWBjD18NDhfM9uuvZ9J3mklrBCFNlyZnbW_9hbQtaGn6oY3XFP09qKaTbTrsnA2N4eqj2NAgOxBZKc0aNNf-zGbM2li9J84oMca218c9UQ9METzIM2eTZDDfW699WeSlYfwVddEIhirNziOcZxD_OZh46ybeR9mk6j9MsmURxBity-46v4TKJXkyS1_ADfg1dCpN02vPQSRQ_x69gRXIiihV08yaOeiOEJrMMJ0fLR_H3eJpBmk2yKM2iaQpPrhEAwK_Nv_t1aP2GGPEL74QQeA9hpspqKU0nhOv7YIvv3D_f7OM1p5YXhNpOCJ2zYHDuBwM_GEAwCIMgDILOHtiZV0hmCVOVdIRBsF_7rTBWOWcQu751jXX2ybIqy3viPs1d173g2XBwNmxyv3lfOnL-KCM3HT7e1OjmyehfvLl23qwOvFn_kzfXR7xZ7bz5Ea4mC4e8mCc4-jZukXUPEnyBExxPcQo7f3bpg7EdrzF2_d_GXh819v68VxF-uStTN1fo7s5DJ5WbEfVgkkKKZ06DepB7UHlQw0Uyf_HxBXmf1H35HU4w5DCG4Qgh_OpyNoli6M4vMw9wfNXbiX7VatUj5Pu-j4SUXPvumwtdppUxPQR3mz_uNh_uNh_AMCphfRBZfbM9dpf53b3Tu81mC2BKGqupkDaE07PTQQjXp0Pw4XR4g_ZgC1Farg102y_V3wEAAP__3JotYg==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJycklFP2zAUhZ_xr7hvtBOOQBMToupD6DIpW0lR4qGhabJc52bzcOzhe8Pgh-0P7JdNaZmYKA9orznnfPfoxFLCJSZyMZzCItrrFI399vYM8A7tenC-xQSMxHC7dQkhJTSFgtawWRtCmG_0GYCU0GJnBs9wa_yApyBGowst3umENvY9htawi4E0BrP22MIcYtc9G364VcUg_yrWD8SYgJDZha90OhoA6MZnNrVr7QJjCsZnPMJ1ij81sWFH7CxlhnTsNLt-7CyPfv8igMmTo_LokKaP1AeVstYR043f1t2NmYHjc7GEMbWY9PfoAmnvescwhzevdwkn_8THzpSNzN6ws9pG79GOu2WPs3XGE-5yOA34MlTvwrjOdieCORzv0o4PD3dgXUxoDTH9Zxm6J8Zeb34R6bHa9vsLaWJRF7kqQOVny2Lz9DLKGCZiz0BZqROoVgqqj8vlgdhbrKpG1XlZKWD94xrv4aIuz_P6Cj4UVzAxkDeLqZjOhMiXqqifMsvqfbFQ0KhclY0qFw3sf_6yPxOi-HSxzMsKJqsLdQBFdTmFpliO3lfwrl6dA2U8E1JKKciaACz-BAAA__95XBvr

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyc0cFuEzEQBuD7PsUcE6leJUJFKFUOBXJAqkKlloibNWvPBlOvrXjGob31IfIqvACPkidB3i0qYnOIuHpmPv8eKwUbSuxiWMCHaB5SRPPt43ugRzJNdt5SAiEW2A9dVaUU3K3uwaJgg0yw7OtXAEqBpRazF9ijz7SAqm8czrQkDIxGXAx6l9E7edKx1Uxp70xhGjQP2xRzsCexRNvsMfWmC5YedSITu46CxYKypoCNJwtLiG170njJv45B_akYn1koAZOIC1telAYA3vnaJNtoF4RSQF9LwXWKPzQLimNxhmvk8gZxXXmAmv_6yQCTfy5V8xlPX9WXKtfWsfDOD3HHY5glnhpLFJOlpL9HF1h71zmBJbx9Mxbe_TVeMnNdzA7FGW2i99R_Rv26thY909iRlOk8qnOhbGfYE8MSLsfa5Ww2wtqYyCAL_2cYfmKhTvdfxLpEG87P1KrV19ub609rmHy-vb-A1Xozhc31zZfVHUzm06tKKaWqfoIrOB4Ox8Pz8fAMk_nFtPodAAD__yBYHQk=

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyc0cFuE0EMBuD7PoWPidRZJUJFKFUOBXJAqkKllojbyJnxFsPsjDL2hvbWh8ir8AI8Sp4EzW5REZtD1evY_vZf2xjYUBZOcQEfkvuRE7pvH98D3ZPbdhw8ZVAShf3QVVXGwM3qFjwqblEIln39AsAY8NRgFxT2GDpaQNU3Dm9WM0ZBp5yi3XUYWB9saqxQ3rMrjMus7DCcpDLddQFzL3L0dG8zudS2FD0WUixF3AbysITUNCeNp_TrFM3figudKGUQUuV4J4vSACC7ULvst5ajUo4Yai24zemnFUVlUXZSo5Q_UG5LfDP__UsAJv991MxnMn1Wn6pSexaVXRjijsew03RqLFPKnrL9njiKDdyywhLevhkL7_4ZL5mlLmaLys66FAL1p6if19ZgEBo7mjt6GdVyLNsZ9iSwhPOxdj6bjbAmZXIoKq8MIw-i1Nr-RGJLtOH9hVq1-np9dflpDZPP17dnsFpvprC5vPqyuoHJfHpRGWNM1U9IBcfD4Xh4PB4eYTI_m1Z_AgAA__9-7Rw0

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYYvY6e4oNvag-WISfoEDjIhesygzZXDmStaFEUBEVRKWeadPhRnuVhj7UX2JMNlPLjzkpWrIgvDOj7zjk8hzoKQ3gvLEqjJzAzfGUN41_evgGxEzyvpCqEBSfQwbZFBUEYwpJkUDDHcoYCLpv9BUAYQiFKVikHW6YqMYGgAbYz6izTyLiTRtPbiinpampKisJuJfcy3EonOVOdUlbcVIrZRlHqQuyoFdys10IXzEsiFZrlShRwCaYsOzXu3CdGh_cbrip0wgIK56S-wYkHAOCtGnFb5FRqJ6xmauS8OLXmd4qOOYlOchwx9AmcXHv74fjvvxCg_69Dw3GEg0fVuy2OCokOb1Vr95jGKme6aFYYWwhLfzNSI1VyLR1cwo9nxwrnB3TvGUdec82c5JQbpUTzKkaP11YyheJYx9lKfJvUWmp_O-09IVzC62O111F0JFYaKzhDh__TDNboxJo2rwipt9bOv1EtmKVkmhHIpm_mpCnzaFPlSvLRDvrBCYM4yc4hWWSQ_DqfD4OT_G7SPs0WyTJLp3GSwY5uVqKG6zR-N00_wi_kI_QZTJezwTA4iZO35APsaE5lsYN-3syDwUUQTOcZSTuPj5OfySyDZTbN4mUWz5bw6lMAAPBH8-9_Pba9oSj3ojeBaPg45kZVa429CXx6GLb43sPz50O8FcyJgjLXm0DvNBqfh9E4jMYQjSdRNImi3gHYl1dq7ig3lfaEcXR49heJzvhmUFdvvLHeIVlXSj0QD2n-63oQPD0bn541uz-H3xs5f5HIjcOXSx18fnXxTDdr383qqJvbp7pZd3Szuu_mV7gtLT3yapGS-KekRW4HkJIrkpJkRpZw388-eyy25zXF3v53sevOYj-fd-_zblZHga0on4q874i8WXVkLldfp7Wi7Mpb96vnc-2fzkU-XM-ncQL9xXU2BJK8H8CSzD32B7hKF-9gfxGEYRgGyJmGffBPAAAA__9KjzX1

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtQfLkBN0CBzkwXWZQZsrB7JWtCgKgqKolDNNOryUZ2XYZ-0H9mUDpSR2ZyUrVsQPBnTvOYfnUEdhCO-FRWn0BGaGr6xh_MvbNyB2gueVVIWw4AQ62LaoIAhDWJIMCuZYzlDAZbO_AAhDKETJKuVgy1QlJhA0wHZGnWUaGXfSaHpbMSVdTU1JUdit5F6GW-kkZ6pTyoqbSjHbKEpdiB21gpv1WuiCeUmkQrNciQIuwZRlp8a9-8To8GHDVYVOWEDhnNQ3OPEAALxVI26LnErthNVMjZwXp9b8TtExJ9FJjiOGPoGTa28_HP_9FwL0_3VoOI5wsFe93-KokOjwVrV2j2mscqaLZoWxhbD0NyM1UiXX0sEl_Hh2rHB-QPeeceQ118xJTrlRSjSvYrS_tpIpFMc6zlbi26TWUvvbae8J4RJeH6u9jqIjsdJYwRk6_J9msEYn1rR5RUi9tXb-jWrBLCXTjEA2fTMnTZlHmypXko920A9OGMRJdg7JIoPk1_l8GJzk95P2abZIllk6jZMMdnSzEjVcp_G7afoRfiEfoc9gupwNhsFJnLwlH2BHcyqLHfTzZh4MLoJgOs9I2nl8nPxMZhkss2kWL7N4toRXnwIAgD-af__rse0NRXknehOIhvsxN6paa-xN4NPjsMX3Hp8_H-KtYE4UlLneBHqn0fg8jMZhNIZoPImiSRT1DsC-vFJzR7mptCeMo8Ozv0h0xjeDunrjjfUOybpS6pF4SPNf16Pg6dn49KzZ_Tn83sj5i0RuHL5c6uDzq4tnuln7blZH3dw-1c26o5vVQze_wm1p6ZFXi5TEPyUtcjuAlFyRlCQzsoSHfvbZvtie1xR7-9_FrjuL_XzeO593szoKbEX5VOS7jsibVUfmcvV1WivKrrx1v3o-193TuciH6_k0TqC_uM6GQJL3A1iSucf-AFfp4h3UF0EYhmGAnGmog38CAAD__0p-NfM=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtQfLkBN0CBzkwXWZQZsrB7JWtCgKgqKolDNNOryUZ2XYZ-0H9mUDpSR2ZyUrVsQPBnTvOYfnUEdhCO-FRWn0BGaGr6xh_MvbNyB2gueVVIWw4AQ62LaoIAhDWJIMCuZYzlDAZbO_AAhDKETJKuVgy1QlJhA0wHZGnWUaGXfSaHpbMSVdTU1JUdit5F6GW-kkZ6pTyoqbSjHbKEpdiB21gpv1WuiCeUmkQrNciQIuwZRlp8a9-8To8GHDVYVOWEDhnNQ3OPEAALxVI26LnErthNVMjZwXp9b8TtExJ9FJjiOGPoGTa28_HP_9FwL0_3VoOI5wsFe93-KokOjwVrV2j2mscqaLZoWxhbD0NyM1UiXX0sEl_Hh2rHB-QPeeceQ118xJTrlRSjSvYrS_tpIpFMc6zlbi26TWUvvbae8J4RJeH6u9jqIjsdJYwRk6_J9msEYn1rR5RUi9tXb-jWrBLCXTjEA2fTMnTZlHmypXko920A9OGMRJdg7JIoPk1_l8GJzk95P2abZIllk6jZMMdnSzEjVcp_G7afoRfiEfoc9gupwNhsFJnLwlH2BHcyqLHfTzZh4MLoJgOs9I2nl8nPxMZhkss2kWL7N4toRXnwIAgD-af__rse0NRXknehOIhvsxN6paa-xN4NPjsMX3Hp8_H-KtYE4UlLneBHqn0fg8jMZhNIZoPImiSRT1DsC-vFJzR7mptCeMo8Ozv0h0xjeDunrjjfUOybpS6pF4SPNf16Pg6dn49KzZ_Tn83sj5i0RuHL5c6uDzq4tnuln7blZH3dw-1c26o5vVQze_wm1p6ZFXi5TEPyUtcjuAlFyRlCQzsoSHfvbZvtie1xR7-9_FrjuL_XzeO593szoKbEX5VOS7jsibVUfmcvV1WivKrrx1v3o-193TuciH6_k0TqC_uM6GQJL3A1iSucf-AFfp4h3sLoIwDMMAOdOwC_4JAAD__0ptNfE=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvtQfLkBN0CBzkwXWZQZsrB7JWtCgKgqKolDNNOryUZ3nYZ-0H9mUDpTT2ZiUtVtQPBnR57uE5l-eGIbwVFqXRE5gZvrKG8U-vX4HYCZ5XUhXCghPoYNuigiAMYUkyKJhjOUMB1835FUAYQiFKVikHW6YqMYGgAbY16izTyLiTRtP7iinpampKisJuJfc03EonOVOdVFbcVYrZhlHqQuyoFdys10IXzFMiFZrlShRwDaYsOzke1CdGh59PuKrQCQsonJP6DiceAID3asRtkVOpnbCaqZHz5NSa3yk65iQ6yXHE0Dtwcu3lh-O__0KA_n8uDccRDg6sD6c4KiQ6vFet3NM2VjnT1WaFsYWw9DcjNVIl19LBNfx4ccpwedTuNePIc66Zk5xyo5RonmJ0GFvJFIpTHmcr8XVUa6n9dNo5IVzDy1O2l1F0QlYaKzhDh_9TDNboxJo2T4TUS2vrX8kWzFIyzQhk01dz0oR5tKlyJfloB_3gjEGcZJeQLDJIfp3Ph8FZ_lBpv2aLZJml0zjJYEc3K1HDbRq_mabv4RfyHvoMpsvZYBicxclr8g52NKey2EE_b-rB4CoIpvOMpJ3Xx8nPZJbBMptm8TKLZ0t48SEAAPij-fe_HtveUZR70ZtANDyUuVHVWmNvAh8eiy2-9_j98RhvBXOioMz1JtA7j8aXYTQOozFE40kUTaKodwT24ZWaO8pNpX3DODq--5NEZ3wyqKs3XljvuFlXSj02Hrf57XokPL8Yn180Z38Ov9Vy_l0sNwq_n-vg44urZ7K599ncrE7CaUX5VDz3HfHcrD7n8whYruBmkZL4p6QFWVEOICU3JCXJjCzhQULdr54P8L4zwM_7qr2v6sTW9ilTdYepqsNTTbe09Mh_Odt2-dr12RcG0tm2729Wh0X39zWLvv3yotdPz4m8u51P4wT6i9tsCCR5O4AlmXvsD3CTLt5AfRWEYRgGyJmGOvgnAAD__ypNRbc=

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8k99u2zYUxq_DpzjQTZ3BEmSl2VIFuVAcFdCmyoGlBi2KgqAoOuVKkQkPlcYb9lh7gT3ZQDl_vNkYggGbLwz4-875-dNHKgzhSliURqcwN_yrNYx_uTgHcS94O0jVCQtOoIO7zRQhYQh13kDHHGsZCjgb_VOAMIROrNigHNwxNYgUyDi40aizTCPjThpNbwempFtTs6Io7J3kHsOtdJIztRdlxfWgmB2JUnfinlrBTd8L3TGPRCo0a5Xo4AzMarWX8ZC-Mjp8dLga0AkLKJyT-hpTPwCAtyritmup1E5YzVTkPJxa842iY06ikxwjhv4JnOx9_HD2x-8IMPnbn4azGA-fqQ8uRp1Eh7dqE3d3jQ3O7FuzwthOWPqzkRqpkr10cAbfH-0STrbWfWaMPLNnTnLKjVJiPIroubYVUyh2Oc4O4mWoXmrfzqYnhDM43qUdx_EObGWs4Awd_sswuEYnejoeEVIfbaO_kEbmyzxrcmiy8zIfL3N0M7RK8qiFCTlo4XyxKKFaNFC9L8spObDmm-ygqJqTUb0q6sJvPk7ARf42e182MGh5O4xlyG5yOCUH80VVN8usqBpo6c1XsYbLZfEuW36En_KPMNlws3ruZ4vqIv8ALW2p7O5h0o46OTwlJCubfLk3bVH9mM8bqJusKeqmmNfw6hMBAPh1_PafgN1dU5S_iCCF2fRZ5kYNvcYghU9P4mi0wdPvz9vzVjAnOspckEKQxEkSzpIwTmB2kh69TpM30fEPr98cJcHWjr_yUnNHuRm030u2zC8SnfG3ibr1jU8XbK9q1o8aHY-X0r94g1JPyHjL8G_roz6bxfHo_Db9h0bilzQyHtN_2Er8_7XyUAn5_OqUkPzDZZkVFUwWl80U8urqEOq89BfqO3i7XLyD9pSEYRgS5ExDS_4MAAD__7Ch1Xw=
