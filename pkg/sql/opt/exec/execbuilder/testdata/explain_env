# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99O2z4Ux6_xUxzlhvan5te0vUGpkBZK0LKFFCUeAyFkOYlpvbl2ZjssdJrEQ_QJeZIp4c8qJMZ2QS4i-Zzv5-R7To5dF06ZNlxJH2aq-KoVLZaHB8AaVuQ1FyXTYJmxcH2vQsh1QTOlS6bJF8WlIYKvuIUlNWCXDEp2RWth4ZqKmvmw1-qZpLlgZM0Xa7roqJfkSrZ6VVm-4mumSW0YWXJj1ULTlfkXalULywsliLHUvkIKVVDB7Q15LFGSimrLLVeSlYTLkjXEFPQV25VWFV1QywiXVW1JNyQuFy9SV1coCzGU3FjzTcB-G5kCuO5zJa2tar9wzQqrNF-zPxhBszQMcAg4OIhDqOpc8OL_Bnpoh0KU4D1I5hiST3E8QDv5Q-T-NJsnGU6DKMHgVJqvqL5x4CSNjoP0HD6G59CjEGSz_gDtRMlheAYNyQkvG-jlj_Gj4DiKz7fwHh1A3kf9KUJBjMP0ua0o-RDOMGQ4wFGGo1kGuxcIAOBH924fp1CiXknj-HDxFOwS1Hk6Xw629JpRy0pCreODM_ZGe643cr0ReCPf83zPc7bE7fC5LCwpVC1bYOR5W-lu-Ui7R_amYm29bVjWQjyB25hW338XHE9G40mX-zn4697yN-mts_J27aHL3SlC4dlJHEQJ9OYneABhctqHLIzb3_wfHKXzY2jg8_swDSGHfZhMkeu6LuquV_PuYaUQ3G02d5vbu80tFEoaqymX1ofheDjy4WI4AReGk0v0KwAA__8WfGDL

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lFFv2zYQx5_DT3HQS-VBWuT4JVBQYKrLbNocOZC0rkEQEJREO1xlUiMpTcowoNhn8OM-nT_JIDlxhbZe24f4wQDv_v_T3eknui68YUpzKXyYy_ydkjS_f_0KWMvyrOZlwRQYpg00exVCrguKSVUwRX6XXGhS8g03cE81mHsGBVvRujTQ0LJmPpz3eiZoVjLywNcPdD24jsml6PWyMnzDH5gitWbknmsj14pu9Le4NnVpeC5Log01X3CWMqclNx15KlGQiirDDZeCFYSLgrVE5_QLbVdKVnRNDSNcVLUhw5K4WB91rVYowSkUXBv9Rwkv-8gFgOt-rKS1kf0TGpYbqfgD-59G0DzGQYohDV4tMFR1VvL8-xZsdEIhjNJziJYpRL8uFg46yR4j-9N8GSVpHIRRClal-IaqzoLrOLwK4hv4Bd-ATSFI5hMHnYTRa_wWWpIRXrRgZ0_xy-AqXNyM7DZ1IJugyQVCwSLF8cdthdHPeJ5CkgZpmKThPIEXtwgA4K_hv_9ZuSzrjdCWD7eH4JCg1uF854z0ilHDCkKN5YN15k3PXW_qelPwpr7n-Z5njcT98rnIDcllLXrD1PNG6QE-0nNkuor19cZmUZflwTi2Kfnnh4Jns-nZbMj97Xz1bNmzzDa08nzjobsXF58HsOsBrD8BsPlGAOsn0EbS1TvSEMVWpIXLZYzDH6O9tplAjC9xjKM5Tg7E2fQDvx1p9vw2x_mtHWiO8tt9lt9hCfjt9SIII7CX16kDOHozgQQveu13cBkvr6B1oIPffsIxhgxewuwCua7rIi4EU-5wR9q5klpPEOy2_-6273fb9zBcQt0nkfaHx0-xz_zTv4rddvsoyKXQRlEujA-nZ6dTH25PZ-DC6ewOjWQrXhqmNNhG1WyC_gsAAP__IF_Miw==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lM9O4zoUxtf4KY6yIb1KrlLYoFYsQglS7g0pajIIhJDlJKetZ1w7YzsQOhqJh-hyno4nGSX8mQqJYWZBFlF8vu93co5zYt-Hc9SGKzmCiSq_aMXK5fERYItl0XBRoQaLxsLNo4sQ3weNSleo6WfFpaGCr7iFJTNglwgVzlkjLNww0eAIDjo_SlYIpGu-WLNFT71lV7Lzq9ryFV-jpo1BuuTGqoVmK_M31KoRlpdKUGOZfYcUqmSC2zv6nKKiNdOWW64kVpTLCltqSvZO2bVWNVswi5TLurG03yQuF29S8znJohwqbqz5KuCwi4wBfP-1kzVWdW-4wdIqzdf4m0LIZBaFeQR5eJREUDeF4OW_Lbhkh0Gc5geQTnNIPyWJR3aKp8jjajJNs3wWxmkOTq35iuk7B85m8Wk4u4T_o0twGYTZZOCRnTg9ji6gpQXlVQtu8Rw_CU_j5HILd5kHxYAMxoSESR7NXpcVp_9FkxyyPMzjLI8nGexeEQCAb_29u5xSiWYljTOCq5dgLzDnZX3tbfk1MosVZdYZgbMXDA_8YOgHQwiGoyAYBYGzZe42n8vS0lI1sgOGQbAl98NHuzmydzV2-bZh2QjxAm5jWt3-Sri3P9zb77Xv3h_3VnxIb30pH9ceud4dExJdnCVhnII7Pcs9iNLzAWRR0n3mf-BkNj2FFsIMlETv8cneqjHxfd8nXErUfn9AuKVWxgwIPGx-PGzuHzb30P-BLVwxc6gkXr8h2VvVS5snac6FRW3AtbrBAfkZAAD___FmeT8=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkc1O20AUhdfMUxyxwalwURWpQolYGDNp3RoH2VMKQmg02JNkiuNx58eKs-Ih8oQ8SZVQpBa1RV366vvuPT4ThriUxirdjBDr8t5oUS7OTiFXsrzzqq6kgZPWoXuiCCkog5HaVNLwb1o1ltdqqRxO8H44BsIQlZwJXzt0ovZyhGMShpCNuKslX6v5Wsx3HhbCwi3kS1w3W163Ti3VWhrureQLZZ2eG7G0_2Mtfe1UqWtunXCvmLUuRa1cz59XVLwVximndCMrrppKrrgtxSuxW6NbMRdOctW03vFdTaqZ_9WazXaFVso6-73GyXbyxxaFd3p7oZOl00at5T-CkDinEaNg0WlK0fq7WpVvewRkzyPJ2DGyKUP2JU0PyV73c_L0FU-zguVRkjHst0Ythen3cZEn51F-jc_0GoFHVMSD39HZPe-4kTO-wmSa0-RD9sR2A-R0QnOaxbR4zrEKxFZPsjN6hZ53XFUrBN3z2kl0nqTXv1wP_CG6ARmMCYlSRvOXf5Vkn2jMULCIJQVL4gIHN7cHY0Lo1UUaJRmC6QU7BM0uByhoumXfYJJPz9Hj60eaU3icYDgmYRiGZPfEPcHjZvO4eXjcPKDUjXVGqMaNcPRuhJujIUIcDW_JjwAAAP__V3YLjQ==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkc1O20AUhdfMUxyxwalwURWpQolYGDNp3RoH2VMKQmg02JNkiuNx58eKs-Ih8oQ8SZVQpBa1RV366vvuPT4ThriUxirdjBDr8t5oUS7OTiFXsrzzqq6kgZPWoXuiCCkog5HaVNLwb1o1ltdqqRxO8H44BsIQlZwJXzt0ovZyhGMShpCNuKslX6v5Wsx3HhbCwi3kS1w3W163Ti3VWhrureQLZZ2eG7G0_2Mtfe1UqWtunXCvmLUuRa1cz59XVLwVximndCMrrppKrrgtxSuxW6NbMRdOctW03vFdTaqZ_9WazXaFVso6-73GyXbyxxaFd3p7oZOl00at5T-CkDinEaNg0WlK0fq7WpVvewRkzyPJ2DGyKUP2JU0PyV73c_L0FU-zguVRkjHst0Ythen3cZEn51F-jc_0GoFHVMSD39HZPe-4kTO-wmSa0-RD9sR2A-R0QnOaxbR4zrEKxFZPsjN6hZ53XFUrBN3z2kl0nqTXv1wP_CG6ARmMCYlSRvOXf5Vkn2jMULCIJQVL4gIHN7cHY0Lo1UUaJRmC6QU7BM0uByhoumXfYJJPz9Hj60eaU3icYDgmYRiGZPfEPcHjZvO4eXjcPKDUjXVGqMaNcPRuhJujIUIcDW_JjwAAAP__V3YLjQ==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMkd9O2zwYxo_xVTzihPQT-dBUaUKtOAjB3bKFFCUeAyFkmcRpPdI485-o6REX0SvkSibKkLZpYzu09fs97-vHYYhLaazS7QSxLu-NFuXy7BRyLcs7r5pKGjhpHfpnipCCMhipTSUN_6JVa3mjVsrhBG_HUyAMUcla-MahF42XExzvFNmKu0byjVpsxGIn4gS6rn-r6JaEIXTn1EptpOHeSr5U1umFESuLpbBwS_kv1so3TpW64dYJ9xez0aVolBv4S0TFO2Gcckq3suKqreSa21K0r8d0RndiIZzkqu2847uqVLv4o1XXu4YqZZ392rxSi_BOP03oZem0URv5yiIkzmnEKFh0mlJ0_q5R5f8DArLnkWTsGNmcIfuUpodkr_9-83yK51nB8ijJGPY7o1bCDPu4yJPzKL_GR3qNwCMq4tHPaH3Pe25kzdeYzXOavMue2X6EnM5oTrOYFi97rAPxpCfZGb3CwHuuqjWC_iV2Fp0n6fUP0wN_iH5ERlNCopTR_NdXJdkHGjMULGJJwZK4wMHN7cGUEHp1kUZJhmB-wQ5Bs8sRCpo-sf9hls_PMeDze5pTeJxgPCVhGIZk98UDweN2-7h9eNw-oNStdUao1k1w9GaCm6MxQhyNb8m3AAAA__8aHQvv

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8kd9O2zwYxo_xVTzihPYT-dBUaUKtOAjB3bKFFCUeAyFkmcRpPdI485-o7REX0SvkSibCKm2I9dDW7_e872MHAa6lsUo3Y0S6eDRaFIuLc8iVLB68qktp4KR16F4pQnLKYKQ2pTT8h1aN5bVaKoczfBxNgCBAKSvha4dO1F6OcdorshEPteQbNd-IeS_iDLqq3lV00zu6dWqpNtJwbyVfKOv03Iil3W8GwRtx6WunCl1z64SzWAgLt5Dvm7UuRK3cmu8iSt4K45RTupElV00pV9wWotkf0xrdirlwkqum9Y73z6Wa-T-tquobl8o6-7PeU1B4p18mdLJw2qiN3LMIiTIaMgoWnicUrX-oVfH_GgNy4BGn7BTpjCH9liTH5KD7ffN6imZpzrIwThkOW6OWwqwPcZXFl2F2i6_0FgOPMI-Gf6PVI--4kRVfYTrLaPwpfWW7ITI6pRlNI5rv9lgNxIsepxf0BmvecVWuMOh2sdPwMk5u_5g-8MfohmQ4ISRMGM3etorTLzRiyFnI4pzFUY6ju_ujCSH05ioJ4xSD2RU7Bk2vh8hp8sL-h2k2u8Qa3z_TjMLjDKMJCYIgIP0Xrwmet9vn7dPz9gmFbqwzQjVujJMPY9ydjBDgZHRPfgUAAP__GeIMUQ==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkd9O2zAYxa_xUxxxQzuRoanShFpxEYK7ZQspSjwGQsgyidN6pHHmP1HbKx6iT8iTTIRV2ibGtEtb53e-n_0FAS6lsUo3Y0S6uDdaFIuzU8iVLO68qktp4KR16J5ThOSUwUhtSmn4N60ay2u1VA4neD-aAEGAUlbC1w6dqL0c47hHZCPuask3ar4R8x7ECXRVvYjopmd069RSbaTh3kq-UNbpuRFL-7_k0tdOFbrm1gn3DzoIUOtC1Mqt-a6l5K0wTjmlG1ly1ZRyxW0hGiyEhVvIl2tao1sxF05y1bTe8f7LVDP_K1VVvXuprLPf61c0hXf6aUInC6eN2shXREiU0ZBRsPA0oWj9Xa2Kt2sMyJ5HnLJjpDOG9EuSHJK97ufN8ymapTnLwjhl2G-NWgqz3sdFFp-H2TU-02sMPMI8Gv4ere55x42s-ArTWUbjD-lzthsio1Oa0TSi-c5jNRBPeJye0SusecdVucKg29VOw_M4uf5l-sAfohuS4YSQMGE0-_NVcfqJRgw5C1mcszjKcXBzezAhhF5dJGGcYjC7YIeg6eUQOU2esm8wzWbnWOPrR5pReJxgNCFBEASkX_Ga4HG7fdw-PG4fUOjGOiNU48Y4ejfGzdEIAY5Gt-RHAAAA__9cCQyz

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUkMFuGjEQhu9-ijm2VV0FaAINymG7dSUk2KSwQblZxjss0xp7scco5emrJeqlaotyszz_N_PrkxLWGBMFfwtlsD9iMHb35TPgM9pNJtdgBMbEcHxJCbFSNUQMscGovwfySTvaE8Md3IymAFJCg1uTHcPRuIy3MBFSAnqzcahP1J5Me-ZgZxLwDv-MB9_nQ8e0pxNGnRPqHSUObTT79Bpqnx2TDU4nNnyBdMEaR_xT_17R6M5EJqbgsdHkG3zWyZoLtbsYOtMaRk2-y6zPmsi3_6S227PQhhKng4O7_uevFk3m0F84ouUQ6YT_KSLKpSpqBSv17VFVpYIubxzZDwkPsJhV62L-qGAAi-Lp5flpOByNxsOr0c3k-uN4fD25GsOsKpdqoaoaBrCqi2UNg6kQ6ulhXswqeHP_UL8HVa3fwkrNVVnDO_i6vF9AwsNUSCmlSHjI6C3KhA4t9xPxKwAA__-actBq

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFupDYUhq_jpzjiZpkKNkxGqiJGkcrOOi3thImAZjeKIsuAZ-IuY1Pb0CFVpVWfYS77dHmSCiaT0N2ku3sRLpB8zv8fjg-f7bpwwZTmUvgwk_kHJWl-8_YNsA3Ls5qXBVNgmDbQ7FQIJTgFxaQqmCK_SS40KfmaGziB7ydTANeFgi1pXRpoaFkzH46R6wITNCsZueWrW7rqfXBDNZgb9qlcik4vK8PX_JYpUmtGbrg2cqXoWn-La12XhueyJNpQ8wVnKXNactOSfYmCVFQZbrgUrCBcFGxDdE6_0HalZEVX1DDCRVUb0o-Ji9WzruWyH2jBtdG_l3DSRZ6cIq2N7L7QsNxIxW_Z_zSCZjEOUgxp8GaOoaqzkuevN2CjAwphlB5DtEgh-nU-d9BBdh_ZrWaLKEnjIIxSsCrF11S1FpzH4VkQX8Iv-BJsCkEyGznoIIze4vewIRnhxQbsbB8_Dc7C-eXAblMHshEaTREK5imOP20rjH7GsxSSNEjDJA1nCby6QgAAf_bv7rFyWdZroS0frh6CfYJaD-trZ6BXjBpWEGosH6wjb3zsemPXG4M39j3P9zxrIO6Gz0VuSC5r0RnGnjdI9_CRjiPTVqyrNzSLuiwfjEObkn88FjyajI8mfe4v56v3lr3I3vpWXm576PrV9GkA2w7A-jMAm28EsN6DNpAuP5CGKLYkGzhdxDj8MdppmxHE-BTHOJrh5IE4mz7y25Jmx2_zPL-1A82z_LZP8jscwkWI3-3Vze40ONDXhCCBBM8792MUTuPFWX_nvt437Pxn2cK7n3CMIYMTmEwRwu_P50EYgb04Tx3A0cVoX_S7Xa1milzXdREXgim3v3vtXEmtRwjutv_cbT_ebT9Cf7m1n0U2P9wf8S7zd_eL77bbe0EuhTaKcmF8ODw6HPtwdTgBFw4n12ggW_LSMKXBNqpmI_RvAAAA__-I3uYl

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkFFr2zAURp-jX3HpS5MR7WUwSkMfXE8Fb44TbK0sjCFU-8a5m2x50nVo8-uHMwZlbCt7Fefofhwp4R5DJN9fQ-rrb8Hb-vDuFvAR64eRXIMBGCPD8SclRKU0BPShwWC-euqjcdQRww28fbMCkBIa3NvRMRytG_EaroSUgL19cGhO1J5se_bgYCPwAX_HfT_xfmDq6ITBjBHNgSL7Ntgu_o_VjY6p9s5EtvyC6XxtHfGT-fVFYwYbmJh8j42hvsFHE2v7wuwh-MG2ltFQP4xszpmob_9q7ffnoA1Fjt8d3Ewvf6xoR_bThSPW7AOd8B9DRFqqRCvQyW2uIL5mmIuZhazQV1BsNBQf83wpZummqHSZZIWGiyFQZ8PTBWzLbJ2UO_igdjC3kFTpYilmd8k6y3fPsLldiMVKiCTXqnx2KCveq1RDpROdVTpLK7j8_OVyJYT6tM2TrID5ZquXoIr7BVQqn9hXcFdu1pO9ElJKKc6ZWfwIAAD__7G82gk=
