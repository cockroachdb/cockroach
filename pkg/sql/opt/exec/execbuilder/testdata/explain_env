# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9u4jgUxq_rpzjKTWFFlgRuqqBKm9JUm10aKsh0WlWV5SQGPJg4Yzs0MBqpD8ET9klGDv3DjMSgatRcRPLJ9zv-zjl2bBuuqVRM5B70RTqXgqSz8zOgFU2TkvGMStBUaVhuVQjZNkgqZEYl_iJYrjBnC6ZhRhToGYWMTkjJNSwJL6kHJ0ZPc5JwitdsuibTmtonF7nRi0KzBVtTiUtF8YwpLaaSLNR7qEXJNUsFx0oTfYDkIiWc6RV-SZHhgkjNNBM5zTDLM1phlZIDtgspCjIlmmKWF6XGdZNYPt1LTSZbjE6oxFyIeVk893QiJJ7M99vekizXVC4JV3rFKd52OTvAZMSM8x16pgjn4gFPSs6xrgdpWnHIGydySreQkWMpHvYiruM4aBzEZjOtvnI4NVl6AGb_n6Wk1MKkX9JUC8nW9DcjQf1R4McBxP7ZIICiTDhL_66ggY4IhFF8AtEwhujTYNBCR8lzZLvqD6NxPPLDKIYKF3O6gqtReOmPbuH_4BYaBPxxv9lCR2F0HtxAhRPMsgoayUv8wr8MB7dgFZItiFxZ0CAtSJqo2UPIH8TB6FdPYfRf0I9hHPtxOI7D_hiO7xAAwLf6bR6LLKdYsTW1PHBab-FU8HKRK8uDu9fgVm-9ru939ZISTTNMtOWB1XHcE9txbccFx_Ucx3Mca0dsBsLyVONUlLkBXGd37_pqYnPL9KowxqxdODfDfwF3MSke3hJ2um6nW3_73vrTkpMPKbl2-HFVo_vjHkLBzdXADyNoDK_iFgTRdRPGwcAcir_gYjS8hAo-_xuMAkjgFLo9ZNu2jep_UvXP8wFE8LTZPG0enzaPkIpcaUlYrj1od9quB3ftLtjQ7t6jHwEAAP__DjbKZA==

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ld1u2zYUx6_DpzjQTe3BWuT4JnBQYKrLbNocOZC1rkEQEJREOVxoUiMpxfIwoNgz-HJPlycZKOfDXeMFRRFfGNDR7394Pv60fR8-MG24kmOYqPxGK5pfv38HbMXyrOaiYBosMxaaLYWQ74NmShdMk98Vl4YIvuQWrqkBe82gYCWthYWGipqN4djxTNJMMLLmizVddKp9uJKOV5XlS75mmtSGkWturFpoujRfo1rWwvJcCWIstS8ohcqp4LYlDykKUlFtueVKsoJwWbAVMTl9oexKq4ouqGWEy6q2pBsSl4u9qrLcyljJNBFK3dTV_UxLpUl5s7_srZJLy3RDhbGtYGQ75eIFTUHdOr-C54YKoW5JWQtBbLdIN4qXahNUL9hW5HCi1e1eyTAIAjTHqTvMmj8EvHVZTgDc-Z-jtLbKpW9YbpXma_Y_K0GTBIcphjR8N8VQ1Zng-fcr6KEDClGcHkM8SyH-dTodoIPsPrJ9mszieZqEUZzCilQ3rIXzJDoLkwv4BV9Aj0I4n_QH6CCK3-OPsCIZ4cUKetlD_DQ8i6YX4FWaL6luPejRAWR91D9BKJymOPlvTVH8M56kME_DNJqn0WQOby4RAMCf3bf7eLRZEMPXzBtDMHgK50rUS2m8MVw-Bre89_h8tctrRi0rCLXeGLyjYHjsB0M_GEIwHAfBOAi8HdgthMvcklzV0gmGwe7Z3dUk7pbZtnKFebti6Zb_INyVaXX7lPBoNDwade_-Gnxry9mrtNxV-Hpdo6s3J897tXVerb_warPPq-0zXq0fPPkZ15DSkaezBEc_xluy6UOCT3GC4wmeP1qzR5-M7nSd0Zv9Rq8H0Ow1evus0bv-8cfzaRjF0JudpwPA8Yc-zPHUsd_BaTI7g9UAWvjtJ5xgyOAtjE6Q7_s-4lIy7Xf_Kb1cK2P6CO42_9xtPt1tPkH3o91-EVn9cH9n3Zu_3RbuNpt7IFfSWE25tGM4PDocjuHycAQ-HI6u0A5WcmGZNtCzumZ99G8AAAD__5yWNL8=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lN1u2zYUx6_DpzjQTe3BGuT0JnDQC9VVAW2OElha0SAICEo6sjnTpEZStuxhQB_Cl3u6PMlAKWm9AZ5RFNGFIJ7z_x2eD5G-D59QG67kBKaqWGnFiuWH94AtFnnDRYkaLBoLm15FiO-DRqVL1PR3xaWhgq-5hSUzYJcIJVasERY2TDQ4gSunR8lygXTPF3u26KhTciWdXtWWr_keNW0M0iU3Vi00W5vvodaNsLxQghrL7BlSqIIJbnf0JURJa6Ytt1xJLCmXJbbUFOxM2rVWNVswi5TLurG0axKXi5NUVfUYVqipUGrV1M89rZSm1ep02j3JpUW9YcLYnUDad7k8w5TMjfM79NwwIdSWVo0Q1HaDdK04l5tgeoE95ORUq-1JZBwEAUmjzG1mzR8C3rko1wBu_39LWWOVC7_BwirN9_g_IyHTeRRmEWTh-1kEdZMLXvzcwoBcMIiT7AqS2wyS32azEbnIny39anqbpNk8jJMMWlqvcAd38_gmnN_Dr9E9DBiE6XQ4Ihdx8iH6DC3NKS9bGOQv9o_hTTy7B6_WfM30zoMBG0E-JMNrQsJZFs3_m1Oc_BJNM0izMIvTLJ6m8OaBAAD82b3d47HNghq-R28CweibuVCiWUvjTeDhq7HXe1_Xj8d6jcxiSZn1JuBdBuMrPxj7wRiC8SQIJkHgHYndQLgsLC1UIx0wDo737o4mdafM7mqXmHcMSzf8F_AY02r7LeDl2_Hl28731-hHS85fpeQuw9ermjy-uSYk-nw3C-MEBrd32Qii5NMQ0mjmfoqf4OP89gZaCFNQEkf9l92qa-L7vk-4lKj97lYdFFoZMyTwdPj76fDl6fAFumurhQdm3imJjydcdqs61-HZVXFhURsYWN3gkPwTAAD__4o94tg=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxK4QWMVl4l-v6PP3zmeB9dcG6HKMQQqW2rFssXFOfA1zx6ckDnXYLmxUPcUQikmoLnSOdf0txKloVKshIUz-DKaAHge5LxgTlqomXR8DKfI84CX7EFyuhHzDZt3HiyYAbvgb3FVtryqrFiJDdfUGU4Xwlg112xlPmKtnLQiU5Iay-wOU6qMSWEb-joipxXTVlihSp5TUeZ8TU3GdsSutKrYnFlORVk5S7uaRDl_1yqKXuMF11QqtXTVS6uF0rRYvh-7N0Vpua6ZNLaRnPYt5zucnLUb_QAvDJNSPdLCSUltt8i2il3ZJNNz3kstTrV6fFc5OT4-7k4rF8aaPxLO2in_vCfmrGrH1zyzSosN_89KUJBgn2Ag_nmEoXIPUmSfGxigPQdhTE4hnhGIf0bRIdqrX_70X8EsTknihzGBhlZL3sBVEl76yS38wLcwcOCnwfAtV9OiJaezBIdf456sh5DgKU5wHOD0NcJ6wFo5jC_wTeeJfA2D-nXo1L8Mo1vYr7RYMd3sw8AdQj1EwwlCfkRw8vZBYfwdBwRS4pMwJWGQwsHd_cEEIXxzFflhDIPZFTkEHF8PIcVRy36CaTK7hAZ-fcMJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSP_gYAAP__ze5psg==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zAUxq_xUxxxQzuRAao0oVZchOBu2UKKEo-BELJM4rRe3Tjzn9D0iofoE_IkUxK4QWMVl4l-v6PP3zmeB9dcG6HKMQQqW2rFssXFOfA1zx6ckDnXYLmxUPcUQikmoLnSOdf0txKloVKshIUz-DKaAHge5LxgTlqomXR8DKfI84CX7EFyuhHzDZt3HiyYAbvgb3FVtryqrFiJDdfUGU4Xwlg112xlPmKtnLQiU5Iay-wOU6qMSWEb-joipxXTVlihSp5TUeZ8TU3GdsSutKrYnFlORVk5S7uaRDl_1yqKXuMF11QqtXTVS6uF0rRYvh-7N0Vpua6ZNLaRnPYt5zucnLUb_QAvDJNSPdLCSUltt8i2il3ZJNNz3kstTrV6fFc5OT4-7k4rF8aaPxLO2in_vCfmrGrH1zyzSosN_89KUJBgn2Ag_nmEoXIPUmSfGxigPQdhTE4hnhGIf0bRIdqrX_70X8EsTknihzGBhlZL3sBVEl76yS38wLcwcOCnwfAtV9OiJaezBIdf456sh5DgKU5wHOD0NcJ6wFo5jC_wTeeJfA2D-nXo1L8Mo1vYr7RYMd3sw8AdQj1EwwlCfkRw8vZBYfwdBwRS4pMwJWGQwsHd_cEEIXxzFflhDIPZFTkEHF8PIcVRy36CaTK7hAZ-fcMJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSP_gYAAP__ze5psg==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20wUhtfMVRyxIfmEP0CRKpSIhTGT1q1xkD2lIIRGgz1Oppl43PkxcVZcRK6QK6lswwYV0i5tPc-rM-85ngfXXBuhyjEEKltqxbLFxTnwNc8enJA512C5sVD3FEIpJqC50jnX9KcSpaFSrISFM_g0mgB4HuS8YE5aqJl0fAynncJL9iA53Yj5hs07Ec5AFcUfFVUizwNVWbESG66pM5wuhLFqrtnKwIIZsAv-N9bKSSsyJamxzO4wpcqYFLahrxE5rZi2wgpV8pyKMudrajJWfhxTaVWxObOcirJylnZViXL-rlUUvcYLrqlUaumql2YLpWmxfH_s3hSl5bpm0thGctoXne9wctZu9R94YZiU6pEWTkpqu122VeyaTTI9573U4lSrx3eVk-Pj4-5WcmGs-SU_OBDmrGrja55ZpcWGf7ASFCTYJxiIfx5hqNyDFNn_DQzQnoMwJqcQzwjE36PoEO3VL3_6r2AWpyTxw5hAQ6slb-AqCS_95Ba-4VsYOPDTYPiWq2nRktNZgsPPcU_WQ0jwFCc4DnD6OsJ6wFo5jC_wTeeJfA2D-jV06l-G0S3sV1qsmG72YeAOoR6i4QQhPyI4efugMP6KAwIp8UmYkjBI4eDu_mCCEL65ivwwhsHsihwCjq-HkOKoZf-DaTK7hAZ-fMEJBgdnMJogz_M81N15g-B5u33ePj1vnyBTpbGaidKO4ehkDHdHI_DgaHSPfgcAAP__9H9qFA==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0s9O20oUBvA18xRHbEiu8AUUqUKJWBgzad0aB9lTCkJoNNjjZJqJx50_Js6Kh8gT8iSVbdggCOrS1vc7Oj6fPQ-uuTZClWMIVLbUimWLi3Pga549OCFzrsFyY6HuUwilmIDmSudc099KlIZKsRIWzuDLaALgeZDzgjlpoWbS8TGcdoSX7EFyuhHzDZt3EM5AFcW7RJWdUZUVK7HhmjrD6UIYq-aarcxu6Xlv4MpJKzIlqbHMGlgwA3bB35dSZUwK29DXETmtmLbCClXynIoy52tqMlbuHlNpVbE5s5yKsnKWducS5fxDVRQ94wXXVCq1dNXLdQulabH8eO1eitJyXTNpbCM57Y-df2Jy1jb7D3lhmJTqkRZOSmq7PttTfLabZHrOe9TGqVaPH5KT4-PjrvtcGGv-yB1VM2dVO77mmVVabPiOSlCQYJ9gIP55hKFyD1Jk_zcwQHsOwpicQjwjEP-MokO0V7-86Z-CWZySxA9jAg2tlryBqyS89JNb-IFvYeDAT4Ph21xNizY5nSU4_Br3yXoICZ7iBMcBTl9XWA9Yi8P4At90TuRrGNSvQ6f-ZRjdwn6lxYrpZh8G7hDqIRpOEPIjgpO3HxTG33FAICU-CVMSBikc3N0fTBDCN1eRH8YwmF2RQ8Dx9RBSHLXZ_2CazC6hgV_fcILBwRmMJsjzPA91_3mD4Hm7fd4-PW-fIFOlsZqJ0o7h6GQMd0cj8OBodI_-BgAA__9YPWp2

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20AUhdfMU1yxIalwAUWqUCIWxkxat8ZB9pSCEBoN9jiZZuJx58fEWfEQeUKepLJDNgiIWNr6vqPrc-x5cM21EaocQqCyuVYsm12cA1_y7MEJmXMNlhsL9YZCKMUENFc655r-VaI0VIqFsHAG3wYjAM-DnBfMSQs1k44P4bRTeMkeJKcrMV2xaSfCGaiieFNRZeeoyoqFWHFNneF0JoxVU80W5rPmwkkrMiWpsczusD0PpMqYFLah25ScVkxbYYUqeU5FmfMlNRkrYcYM2Bl_O6bSqmJTZjkVZeUs7SoT5fRdqyg2Gi-4plKpuateGi6UpsXc7DBFabmumTS2kZxuCs93ODlr1_0ELwyTUj3SwklJbbdpW8Wu2yTTU76RWpxq9fiucnJ8fNytmAtjzT_5wWDMWdXG1zyzSosV_2ASFCTYJxiIfx5hqNyDFNnXBnpoz0EYk1OIJwTi31F0iPbqlzebp2ASpyTxw5hAQ6s5b-AqCS_95BZ-4VvoOfDToP-aq2nRkuNJgsPv8Yas-5DgMU5wHOB0e8Kyx1o5jC_wTeeJfAm9ehs69i_D6Bb2Ky0WTDf70HOHUPdRf4SQHxGcvP6gMP6JAwIp8UmYkjBI4eDu_mCEEL65ivwwht7kihwCjq_7kOKoZb_AOJlcQgN_fuAEg4MzGIyQ53ke6v7zBsHzev28fnpeP0GmSmM1E6UdwtHJEO6OBuDB0eAe_Q8AAP___k5q2A==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAUhd_zK-7jNs0TlLWwoj6wzJOQIO0gRX2zTHIT7jB2sK9py6-fQraXaQz1zZLPd3R0zhUCVugDOXsLqSu23uli8-0r4AsW60imRA-MgeHQqZJkKXPw6HyJXv10ZIMytCOGO7gZjAGEgBIrHQ3DQZuItzBKhAC0em1QHak-6vrEwUYH4A3-LXe21buGaUdH9CoGVBsK7Gqvd-Et1C4apsIZFVjzBdK4QhviV_XHolSN9kxMzmKpyJb4okKhL8RuvGt0rRkV2SayOtVEtj5LVVWHYYVeGee2sfndauW8qrbnY3ckWUZ_0Cbwq0HVtVxeYErdLvoGPQVtjHtWVTRG8WnItopL2Yz2NXZQK1fePZ9F-r1e73RaJQUOewN3rcs_70lHdq39AQt2no74n0mSdCEnuYSl_PEos1RCE9eGik8B9zCfZqvJ7FFCH-aTp-755epqMBhe9QY3o-vPw-H1qDeEaZYu5FxmOfRhmU8WOfTHSSKfHmaTaQbv7h_yjyCz1XtYyplMc_gA3xf3cwi4HydCCJEE3Ee0BYqABgtuf5JfAQAA__83zjAS

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfQ6_4kIvtQepkWNgCGwEmOoymzZHDmQtbRAEBC3RDhda1EhKsTwMKPYNftzX5UsGSnHitvGCoogfDPDqnKtz7z1X9Dy4YEpzmQ9gJNNbJWl68_4dsBVLZyUXGVNgmDZQtSiEpjgBxaTKmCJ_SJ5rIviSGziBH_tDAM-DjM1pKQxUVJRsAMfI84DldCYYWfPFmi4aHtxQDeaGfQmXucXLwvAlXzNFSs3IDddGLhRd6m9hLUtheCoF0YaaF5hCplRwU5NtiowUVBluuMxZRniesRXRKX1BdqFkQRfUMMLzojSkaRPPF3tZ83lLY3OmiJDytiweujqXisxv98tumTw3TFVUaFMLRtouZy9wMmon-g14rqkQ8o7MSyGIaQZpW_GSNkHVgrUkCydK3u2l9Hzfb6yVcW30nwJObJZn_URLI236iqVGKr5m_zMSNIpxkGBIgndjDEU5Ezx9u4IOOqAQRskxRJMEot_HYxcdzB4i7Wk0iaZJHIRRAitS3LIazuPwLIgv4Td8CR0KwXTUddFBGL3HH2FFZoRnK-jMtvHT4CwcX4JTKL6kqnagQ12YdVF3iFAwTnD8paYw-hWPEpgmQRJOk3A0hTdXCADgr-bf_hxaLYjma-YMwHefwqkU5TLXzgCuHoMt3nk8X-_iFaOGZYQaZwDOkd879vye5_fA7w18f-D7zg7YDoTnqSGpLHNL6Pm7725Wk9gtM3VhhTm75NwOf0vcpSl595TwqN876jfP_na_t-TZq5TcKHy9qtH1m-HzXq2tV8uvvFrt82r9jFfLrSc_w1VkbpGnkxiHP0ctsupCjE9xjKMRnj5as0OfjG55jdGr_UYvXaj2Gr1-1ui79V-E-MMWXTWrapfTRQelLRx1IZjCFI9tDrtSLtj3wWk8OWtuqrdb2e5nxxo-_IJjDDM4gf4QIfzxfByEEXQm54kLOLrobpP-0OaqhsjzPA_xPGfKa26sTqqk1l0E95t_7zef7jefoLkS6q8iq58evgj2yT92xvebzQMglbk2ivLcDODw6LA3gKvDPnhw2L9GO7A5F4YpDR2jStZF_wUAAP__Fg1OTw==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkkFr20wQhs_ZXzHkEvsj-nAplBCTg6IqoFaWjbQNNaUsE2kkb73WqrsjJ_avL7JbKKWuyf15ZoZ33iCAR3Je2_YWIluuncVy9f4e6IXKp16bihwweYbtkRKiiCU4sq4ip75Z3Xpl9EYz3MG7t1OAIICKauwNwxZNT7dwI4IAqMUnQ2qvmz02Bw9W6IFX9Cdu24G3HeuN3pNTvSe10p5t43DjX2NtesO6tEZ5Rj5jGlui0bxTv0ZUqkPHmrVtqVK6rehF-RLPnN0522GDTEq3Xc_qEJNum5NWXR81qskpY-26736mWlun6vXps4-mbpncFo3nnSF1TLk641Q4fPQVvPZojH1WdW-M4sMjhyjO3WbQNXSUBlw5-3xSeTOZTA7VqrRn_93A3TDlr33Cnu0wfkslW6f39I-XiCiPQxmDDO_TGPz_DCNxgZBk8gayuYTsU5pei4tonhUyD5NMAqtuTTtY5MkszJfwMV7CCCEsovG1uHgIZ0m6hMvO6Q263SWMcCzGUyHCVMb5b1uS7EMcSShkKJNCJlEBV1--Xk2FiD8v0jDJYDRfyGuIs8cxFHE6sP_BQz6fDfZUBEEQiEPbWPwIAAD__3aYOPU=
