# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k9FO2zAUhq_xU_zKDe3U0LS9QamQFkrQspUUJRkDIWQ5iaHe3LhzHBY6TeIh-oQ8yZQAXTVpbLsgF5F8zv-d_Ef-Y9s447oUqnAxUdkXrVg2PzoEr3mWVkLmXMPw0uD2UUWIbUNzpXOu6WclipJKsRAGc1bCzDlyfs0qaXDLZMVd7Dd6XrBUcroSNyt201J_kqui0aulEQux4ppWJadzURp1o9mi_B9qUUkjMiVpaZj5CylVxqQwd_R5RE6XTBthhCp4TkWR85qWGXvJduwnyEVpyq8SB1DX12PAtn8Xssqo5ou3PDNKixV_YSKZRL6X-Ei8w6mPZZVKke3V6JAdhiBM9hHOEoQfp9Me2UmfKo-nySyMk8gLwgTWUosF03cWTqPgxIsu8MG_QIfBiyfdHtkJwiP_HDVNqchrdNLn-rF3EkwvtvAO6yHtku6YEG-a-NGTrSYbextvQfjenySIEy8J4iSYxNi9JADwvX03j5UpWS2K0nJxuSm2DWZtzle9Lb3mzPCcMmO5sIbOYN92BrYzgDNwHcd1HGtL3NyAKDJDM1UVDTBwnK12GyXapMLcLXkzbxsuKik34Dam1bdfA4ejwXDU9n70_nm39FV2a6283nrkandMiH9-OvWCEJ3ZadKDH551EfvT5prf4DianaDGp3d-5CPFAUZjYtu2TdqfpX77lCuCh_X6YX3_sL5HporSaCYK46I_7A9cXPZHsNEfXZGfAQAA___R906W

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k9FO2zAUhq_xU_zKDe3U0LS9QamQFkrQspUUJRkDIWQ5iaHe3LhzHBY6TeIh-oQ8yZQAXTVpbLsgF5F8zv-d_Ef-Y9s447oUqnAxUdkXrVg2PzoEr3mWVkLmXMPw0uD2UUWIbUNzpXOu6WclipJKsRAGc1bCzDlyfs0qaXDLZMVd7Dd6XrBUcroSNyt201J_kqui0aulEQux4ppWJadzURp1o9mi_B9qUUkjMiVpaZj5CylVxqQwd_R5RE6XTBthhCp4TkWR85qWGXvJduwnyEVpyq8SB1DX12PAtn8Xssqo5ou3PDNKixV_YSKZRL6X-Ei8w6mPZZVKke3V6JAdhiBM9hHOEoQfp9Me2UmfKo-nySyMk8gLwgTWUosF03cWTqPgxIsu8MG_QIfBiyfdHtkJwiP_HDVNqchrdNLn-rF3EkwvtvAO6yHtku6YEG-a-NGTrSYbextvQfjenySIEy8J4iSYxNi9JADwvX03j5UpWS2K0nJxuSm2DWZtzle9Lb3mzPCcMmO5sIbOYN92BrYzgDNwHcd1HGtL3NyAKDJDM1UVDTBwnK12GyXapMLcLXkzbxsuKik34Dam1bdfA4ejwXDU9n70_nm39FV2a6283nrkandMiH9-OvWCEJ3ZadKDH551EfvT5prf4DianaDGp3d-5CPFAUZjYtu2TdqfpX77lCuCh_X6YX3_sL5HporSaCYK46I_7A9cXPZHsNEfXZGfAQAA___R906W

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNGOozYUhq_HT3HEzZIKNiS5GRGtVDbrtLQZMgK63dFoZBlwJu4SnNqGQqpKqz5DLvt0eZIKksmi7s5052K4QPI5_384B3-2bcN7JhUXhQszkX6Ugqbrd2-B1SxNSp5nTIJmSkN1VCFk2yCZkBmT5DfBC0VyvuEa1lSBXjPI2IqWuYaK5iVz4bLVs4ImOSM7fr-j953rMbkoWr3Yar7hOyZJqRhZc6XFvaQb9RzXpsw1T0VOlKb6f5y5SGnOdUMeSmRkS6XmmouCZYQXGauJSulTbUc4howrrX7P4Q2I1WoKYNv_FdJSi_aLFUu1kHzHnqiIZiH2Ygyx93aBYVsmOU9f12CiCwp-EF9CsIwh-GWxsNBFcoocV7NlEMWh5wcxGFvJN1Q2BlyH_pUX3sDP-AZMCl40G1jowg_e4Q9Qk4TwrAYzeYjPvSt_cdOzm9SCZIAGU4S8RYzDU1stG6_PvfnBT3gWQxR7sR_F_iyCV7cIAODP7t0-RiryclMow4Xbc7BLUOO8vrN6esmoZhmh2nDBGDujS9sZ2c4InJHrOK7jGD1xuwO8SDVJRVm0hpHj9NIdSqSlQjdb1tbrm4syz8_Gvk2KPz4XHE9G40mX-8v65tmSF5mta-XlxkN3r6Zfp7BpKSy_oLB6JoXlA2096eojqYhkK1LDfBli_4fgqK0GEOI5DnEww9H5NJj0M8QNqY4QV49DXFpQPQ1x81WIuz-BP1wvPD8Ac3kdW4CD9wOI8KLVfgfzcHkFtQUN_PojDjEk8AYmU2Tbto14UTBpd9eemUqh1ADBYf_PYf_psP8E3b3SfBGpvz8dyjbzd7sfh_3-JEhFobSkvNAuDMfDkQu3wwnYMJzcoZ5sxXPNpAJTy5IN0L8BAAD__ynVvEQ=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k8FO20AQhs_sU4x8wals5MAFJeJggpHcGgfFLgIhtFrbE7LtZjfdXYNJVYmHyLFPx5NUNiGNKkHbAz5Y3vn_bzyjnfF9uEBtuJIDGKnyq1asnJ0cAzZYFjUXFWqwaCzcPbsI8X3QqHSFmn5RXBoq-JxbmDEDdoZQ4ZTVwsIdEzUO4LD1o2SFQLrkt0t221Gv2ZVs_Wph-ZwvUdPaIJ1xY9WtZnPzP9S8FpaXSlBjmf0LKVTJBLcP9CVFRRdMW265klhRLitsqCnZW2VnUQ4VN9Z8E3AEajodAvj-n0ZWW9X-8Q5LqzRf4hsZyWgShXkEeXicRLCoC8HLvQZcssMgTvNDSMc5pJ-TxCM7xTryfBqN0yyfhHGag7PQfM70gwPnk_gsnFzBp-gKXAZhNup5ZCdOT6JLaGhBedWAW7zET8OzOLnawl3mQdEjvSEhYZJHk3VZ7WzsbWqL04_RKIcsD_M4y-NRBrvXBADge_duH6dUop5L4wzgehPsBOZszjfell8js1hRZp0BOPtB_9AP-n7Qh6A_CIJBEDhb5vYGuCwtLVUtW6AfBFtyN0q0nQr7sMA23zYsayE24Dam1f3vhPsH_f2DTvvh_XNvxbv01pXyfu2Rm90hIdHleRLGKbjj89yDKL3oQRYl7TV_gNPJ-AwaCDNQEr3nL3uvhsT3fZ9wKVH73bq7pVbG9Ag8rX4-rR6fVo_Q7VMD18wcKYk3r0j2XnXSai1NubCoDbhW19gjvwIAAP__HmlnCg==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zwcho_xVbzihPQTAX2qNKFWHITgbtlCihKPUSFkuYnbeqRxZztR0yMuolfYK5lC6bRNE9MObT3P-_tj-z7upLFKVwOEOn8yWuSL6yvItcyntSoLaeCkdWj2FCEZZTBSm0Ia_lWryvJSLZXDJd71h4Dvo5AzUZcOjShrOcAF8X3ISkxLyTdqvhHzFw8LYeEW8ndcVx2vV04t1UYaXlvJF8o6PTdiaf_FWtalU7kuuXXC_cUsdS5K5Vp-iCj4ShinnNKVLLiqCrnmNhdvtd1tplDW2W8lLqFnsz-uQ9ROdxUbmTtt1Ea-kUjClAaMggVXMcWqnpYqP2vhkaMaUcIukIwZks9xfEqOmteb_SkcJxlLgyhhOF4ZtRSmPcZtGt0E6QSf6ARejSALe7-isyfecCNnfI3ROKXR-2TPNj2kdERTmoQ0O_Sx9kSnR8k1vUfLG66KNbzmEDsKbqJ48lN1rz5F0yO9ISFBzGj6OlX3u85-jBYlH2nIkLGARRmLwgwnD48nQ0Lo_W0cRAm88S07BU3uesho3LH_YZSOb9DiyweaUtS4RH9IfN_3ycuDtQS77Xa3fd5tn5HryjojVOUGOP9_gIfzPnyc9x_J9wAAAP__zTf5SQ==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9O2zwcho_xVbzihPQTAX2qNKFWHITgbtlCihKPUSFkuYnbeqRxZztR0yMuolfYK5lC6bRNE9MObT3P-_tj-z7upLFKVwOEOn8yWuSL6yvItcyntSoLaeCkdWj2FCEZZTBSm0Ia_lWryvJSLZXDJd71h4Dvo5AzUZcOjShrOcAF8X3ISkxLyTdqvhHzFw8LYeEW8ndcVx2vV04t1UYaXlvJF8o6PTdiaf_FWtalU7kuuXXC_cUsdS5K5Vp-iCj4ShinnNKVLLiqCrnmNhdvtd1tplDW2W8lLqFnsz-uQ9ROdxUbmTtt1Ea-kUjClAaMggVXMcWqnpYqP2vhkaMaUcIukIwZks9xfEqOmteb_SkcJxlLgyhhOF4ZtRSmPcZtGt0E6QSf6ARejSALe7-isyfecCNnfI3ROKXR-2TPNj2kdERTmoQ0O_Sx9kSnR8k1vUfLG66KNbzmEDsKbqJ48lN1rz5F0yO9ISFBzGj6OlX3u85-jBYlH2nIkLGARRmLwgwnD48nQ0Lo_W0cRAm88S07BU3uesho3LH_YZSOb9DiyweaUtS4RH9IfN_3ycuDtQS77Xa3fd5tn5HryjojVOUGOP9_gIfzPnyc9x_J9wAAAP__zTf5SQ==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMktFu2jAYha_rpzjqTcPUtJqQpgrUizQ1W7Y0VInXFVWVZRIDXkPMbCciXPUheEKeZALKtEkT26Wt853fn_z7Ph6ksUpXPYQ6fzFa5LPbG8ilzMe1Kgtp4KR1aPYpQjLKYKQ2hTT8u1aV5aWaK4drfOj2Ad9HISeiLh0aUdayh6sdIisxLiVfqelKTHcgrqEnk78iuiK-D71waq5W0vDaSj5T1umpEXOLmbBwM_k_1Lwuncp1ya0T7h9kqXNRKtfyQ0XBF8I45ZSuZMFVVcglt7mojtRsVQtlnf1RHvETtdPbiY3MnTZqJY80kjClAaNgwU1MsajHpcovWnjkpEaUsCskQ4bkaxyfk5Pm7WZ_CodJxtIgShhOF0bNhWlPcZ9Gd0E6whc6glcjyMLOn9HJC2-4kRO-xGCY0uhjss82HaR0QFOahDQ7vGPpiS0eJbf0ES1vuCqW8JpD7SC4i-LRb9O9-hxNh3T6hAQxo-mb1XbDLn6pRclnGjJkLGBRxqIww9nT81mfEPp4HwdRAm94z85Bk4cOMhpvs-8wSId3aPHtE00palyj2ye-7_tk92EtwWa93qxfN-tX5LqyzghVuR4u3_fwdNmFj8vuM_kZAAD__3y6-as=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx8ktFu2jAYha_rpzjqTcPUtJqQpgrUizQ1W7Y0VInXFVWVZRIDXkPMbCciXPUheEKeZALKtE0Vl7bO9_3nl-37eJDGKl31EOr8xWiRz25vIJcyH9eqLKSBk9ah2acIySiDkdoU0vCfWlWWl2quHK7xqdsHfB-FnIi6dGhEWcsernaIrMS4lHylpisx3YG4hp5M3kV0tWP0wqm5WknDayv5TFmnp0bM7XHS9_8D53XpVK5Lbp1wFjNh4WbyfbLUuSiVa_lBUfCFME45pStZcFUVcsltLqojmm31Qllnf5VHmora6e3ERuZOG7WSR4wkTGnAKFhwE1Ms6nGp8osWHjmpESXsCsmQIfkex-fkpHm72Z_CYZKxNIgShtOFUXNh2lPcp9FdkI7wjY7g1QiysPNvdPLCG27khC8xGKY0-pzss00HKR3QlCYhzQ49lp7Y4lFySx_R8oarYgmvOWgHwV0Uj_6a7tXnaDqk0yckiBlN37ba_rKLP6tFyVcaMmQsYFHGojDD2dPzWZ8Q-ngfB1ECb3jPzkGThw4yGm-zHzBIh3do8eMLTSlqXKPbJ77v-2T3YC3BZr3erF8361fkurLOCFW5Hi4_9vB02YWPy-4z-R0AAP__aVv6DQ==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUktFu2jwYho_rq3jVk4ZfTatfSFMF6kGami1bGlDidUVVZZnEgNcQM9uJCEe9CK6QK5mAMm3S1mmHtp7nfb9Ptu_jXhqrdNVDqPNno0U-v72BXMl8UquykAZOWofmQBGSUQYjtSmk4V-1qiwv1UI5XONdtw_4Pgo5FXXp0Iiylj1c7RVZiUkp-VrN1mK2F3ENPZ3-VtHV3tFLpxZqLQ2vreRzZZ2eGbGw_2ou6tKpXJfcOuH-Yvs-Sp2LUrmWH1MKvhTGKad0JQuuqkKuuM1FhbmwcHP5hyEKZZ39Vr7RJ2qnd42NzJ02ai3fSCRhSgNGwYKbmGJZT0qVX7TwyEmNKGFXSIYMyec4PicnzevN4RQOk4ylQZQwnC6NWgjTnmKURndBOsYnOoZXI8jCzq_o9Jk33MgpX2EwTGn0PjmwTQcpHdCUJiHNjnOsPLHTo-SWPqDlDVfFCl5zjB0Ed1E8_qndq8_RdEinT0gQM5q-brX7aRc_VouSjzRkyFjAooxFYYazx6ezPiH0YRQHUQJvOGLnoMl9BxmNd-x_GKTDO7T48oGmFDWu0e0T3_d9sn-wlmC72Ww3L9vNC3JdWWeEqlwPl__38HjZhY_L7hP5HgAA__-YXvpv

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUkEFvGjEQhe_-Fe_YVnUVoAk0KIft1pWQYJPCBuVmGe8A05o12LMo5ddXNOqlqqhyG2m-783oaY0lpcyxvUUZ_Y8Und9--Qx6Jr_qODSUIJQFxxdKqYWpkSimhpL9HrnNNvCOBXe4GYwBrdHQ2nVBcHSho1uMlNag1q0C2RNvTm7z28PWZciW_sZje-bjXnjHJ0q2y2S3nCVuktvl11i7Lgj7GGwWJ_8xQ_QusPy0fyIau3dJWDi21FhuG3q22btLb5-baThLPgTcIa7X_6zDdRLPF4_kJSY-0YVEVc5NURsszLdHU5UG-24V2H_IdMBsUi2L6aNBD7Pi6WX81O8PBsP-1eBmdP1xOLweXQ0xqcq5mZmqRg-LupjX6I2VMk8P02JS4c39Q_0eplq-xcJMTVnjHb7O72fIdBgrrbVWmQ4dtZ50pkBezhv1KwAA__8rjrxH

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VM1u4zYQPodPMdBl5UJayzZQBDICVOulW7WOHEhqdoMgICiJjtmVRZekVNtFgUWfwcc-nZ-kkPwTNUnT5hAdBHDm-z4Oh9_QtuGaScVF4cJIpF-koOn84wdgK5YmJc8zJkEzpaHaoxCKcAySCZkxSX4RvFAk5wuu4QK-HQwBbBsyNqNlrqGieclcOEe2DaygSc7Iht9v6H3DgzlVoOfsMVwUNV4sNV_wDZOkVIzMudLiXtKFeg1rUeaapyInSlP9H8xcpDTnek2OEhlZUqm55qJgGeFFxlZEpfSlsuvOZFxp9WsOFyBms2fbQUst6h0rlmoh-Ya9oIhGIfZiDLH3YYJhWSY5T9-vwERnFPwgPodgGkPw82RiobPkENmvRtMgikPPD2IwlpIvqFwbcBX6l154Az_hGzApeNGoY6EzP_iIP8OKJIRnKzCTY3zsXfqTmxbdpBYkHdQZIuRNYhweyqrt8f5Umx_8iEcxRLEX-1HsjyJ4d4sAAH5v_vVnpCIvF4UyXLg9BZsENU7rO6uFl4xqlhGqDReMvtM7t52e7fTA6bmO4zqO0QLXN8CLVJNUlEVN6DlOK91YidSu0Oslq_Xa5KLM8xOxTZPitwfB_qDXHzS5P6z_fbbkTc7WlPJ2x0N374bPu3Bdu7B84sLqlS4sj25rQWdfSEUkm5EVjKch9r8P9tiqAyEe4xAHIxydpsGkDyZek2pv4urfTVxaUL1s4vWzJm534trHn44FVPu5sKARBi-CCE9q9kMUxuH08p9zYj3a8dMPOMSQwAUMhgjhz1cTzw_AnF7FFuDgunMU_WavVQ2Rbds24kXBpN08p2YqhVIdBLvtX7vt1932KzTv1fpJZPXdYdjrzJ_1Pe-22wMgFYXSkvJCu9Dtd3su3HYHYEN3cIdasBnPNZMKTC1L1kF_BwAA__8NUdXe

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkVFr2zAUhZ-jX3HoS5MR9WUwSkMfVE8Fb44TbK0sjCFUW0m0yVYmXYc2v36422CMkbH379xz-C7neLAxudDfIAvN1xhMs397B_tkm8fB-dZGkE2E4w-KsVoqRBtia6P-ElyftHedI9zizesFwDlauzWDJxyNH-wNrhnnsL159Faf3O5kdi857E0C7e2feOhHPhzIde5kox6S1XuXKOyi6dL_pLrBk2uC14kM_SPpQ2O8o2f960SrDyaSIxd622rXt_ZJp8acmz2aaV2i9M3jFmG7_asOM1AYG4-2oRDdyZ65yLJKCiWhxF0hka4IUzYxyEt1jXKlUH4oijmbZKuyVpXIS4WLQ3Sdic8XWFf5UlQbvJcbTA1Enc3mbHIvlnmx-Q2bmhmbLRgThZLVz6Lx4VdjW16-k5lCrYTKa5VnNS4_fb5cMCY_rguRl5iu1moOWT7MUMtiZF_hvlotx60Lxjnn7EUase8BAAD__8_fx9Q=
