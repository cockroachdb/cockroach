# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k-9O8zYUxj_jqzjKl7ZTkyatXulVqkoLwbBsJUVJYCCELMdxh0WaQOx06aZJXERvZTewS-FKJqdQOq3AtI1-qOTj5zznT342TbjglRRl4YJfsruqpOz26BB4w1laizzjFSguFSw3KoRME2KcQEYVTankMGnvxwCmCRmf0zpXsKR5zV1AWiiKjDek4qxcLHiRUSXKQhJe0DTnGUygnM_3JutaOt-fnscJjnTRJAhPQD7kFquylIhC8aqguaW0FanKn4lUVAmpBJMWlaScEyUWusOO6fzxu-zsrWM6tnyz0LNWWpmQSj7k7_RLa1W-6aMbk5aWLKgSjLAyzznTq7BeNzGnueR7vVVV83_jvRCF3slmOxIm8GWv_Rfb_sB9XlacUank_9WuXEnFF6T9dJLo5jfxf2yP_Ah7CYbEO5ziFkHrvk5zwawGuuiAQhAmXyGcJRCeT6d9dJA-RzYnfxbGSeQFYQINub_jKziLglMvuoIf8BV0KXix3-ujgyA8wpfQkJSIrIFu2sZRb4yQN9WT7SsfhN9jP4E48ZIgTgI_hs41AgD4tf3XP4MufyJS_MINF-z-a5iVeb0opOHC9Ta40Rvb882uvuJU8YxQZbhgDG3nq2k7pu2A7bi27dq2sSPWDIuCKcLKutAJjr1b-1ZIVWp6iFrd68aM3eSizvNt4m6afndbw-HIGY7au9_6_3Xk9FNGbjv8vKnRTWf8DpsrzWb9NzaXb7G52sNm_cLmX3RLMtfK41mEg5Nwo1z2IMLHOMKhj2N44bNLX8HWeS3Yy4_BXu0Fu50XX55NvSCE7uws6QMOL3oQ46nWfgPH0ewUGvjxOxxhSGECozEyTdNEktECmm-f3xaCp_X6af34tH4EVhZSVVQUyoXBcOC4cD0YgQmD0Q36MwAA__9AuO5I


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9u2zYUxq_DpzjwTezBdKQYBQoFAaaqTKfNlQNJ7VoEAUFR1MpVJlOR8qQNA4o9gy_3GnuBPUqeZKCcOh7qtMO2-sIAD7_znT_-0RjDS9EYqVUAkeZvG834m6dPQHSCF62sS9GAFcbCeqtCCGPISA4ls6xgRsD5cH8GgDGUomJtbWHN6lYEgJxQqlJ0tBFcr1ZClcxKrQwVihW1KOEcdFUdTHa1XH60eJHlJHVF8zh5BuZdPeNNWVCprGgUq2fWWdFG_0SNZVYaK7mZMUN1Ra1cuQ6Psf_nH-b4YB3se-bBQndaMyulseZd_Yl-WWv1gz6uMTNzkhWzklOu61pwt4rZ_SYqVhtx0Ns2rfg33iup3E622zFwDo8O2j_yvM-4V7oRnBlr_q92TW-sWNHhpzPUNb-N_2N7FKUkzAnk4ZMFGRCc3bRFLfmsgzE6YhAn-WNIljkkLxaLKToq7iLbU7RMsjwN4ySHjt68FT1cpvHzMH0N35HXMGYQZtFkio7i5Cl5BR0tqCw7GBdDHE3OEAoXbrJD5ePkWxLlkOVhHmd5HGVwfIUAAH4Zvt1nxNY_UCN_FqMAvOl9mOu6XSkzCuBqF9zqR7vz9b6-EcyKkjI7CmB06vmPsedjzwfPDzwv8LzRntgxLBW3lOtWuQTf26_9RhqrHT3U9jeusdF-smrrepe4n-be3c7wdO6fzoe7X6f_deTii4w8dPjlpkbXx2efYLN3bLYfsbl-iM3-AJvtBzb_plvTyikvlimJnyVb5XoCKbkgKUkiksEHPsfsHmyXN4C9_jzY_UGwh3nJq8tFGCcwXl7mUyDJywlkZOG0X8FFunwO3RR6-P4bkhIo4BzmZwhjjJFUSjT4Ry0VjHmjjZkguN38frt5f7t5D4YzBf1Hke7ru-fobn5zW7_dbO4EXCtjGyaVDeDk9MQP4OpkDhhO5tdoT1bJ2orGwNj9lUzQXwEAAP__NA4SYA==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFuo0YUfc58xRUvtiuDIKuVVrb8wLKTFa0XR8CudhVFo2EYutPFMwkzOLhVpXyEH_sb_YF-Sr6kGpw4rmonVdvwgJh7zz333MsB14VPvNFCyQlEin1rFGVf370F3nFWtKIueQOGawOrLQoh14UM51BSQwuqOcz6_BTAdaHkFW1rAytat3wCyAKFLHlHGs7UcsllSY1QUhMuaVHzEmagqupgse1l66P5xyzHqW2ax8l70Ne1x5qyIEIa3khae8ZSkUbdEG2oEdoIpj2qiaqIEUurcOAGf_yuBwf7uIGvjza6x2qvFNro6_oJvbQ16iiPFaY9C1lSIxhhqq45s6vwHjdR0Vrzg9ymafm_4V4KaXey3Y6GGbw-SP_a959hr1TDGdVG_19y9VobviT9q9PEit_G_zE9ilIc5hjy8O0c9xb0rtqiFszrYIhOKMRJ_gaSRQ7Jx_l8jE6K-8j2FC2SLE_DOMmhI1ff-BrO0_hDmH6BH_AXGFIIs2g0Ridx8g5_ho4URJQdDIs-jkZThMK5nexQ-zj5Hkc5ZHmYx1keRxkMLhAAwC_93V4OXf1ItPiZOxPwx49hpup2KbUzgYtdcIt3dufLfXzDqeElocaZgHPqB29cP3D9APxg4vsT33f2wNbDQjJDmGqlLQj8_d5fhTbKuoeY9ZUV5uwXy7aud4X7Zfa72xGevgpOX_W5X8f_deTiRUbuFb7c1OhyMH3Cm2vrzfZv3lwd8-b6gDfbB2_-BbcilUWeLVIcv0-2yNUIUnyGU5xEOIMHfw7po7FtXW_s1fPGXh80dj8v_nw-D-MEhovzfAw4-TSCDM8t9js4SxcfoIMwAyX5ePtkbtQUua7rIiElb9yflJAwZI3SeoTgbvPb3eb2bnMLmlEJHVxQPVOSXx5JmRvVpzb3qUrUhjcahvZHMUJ_BgAA__-_sAbL

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99u2zYUxq_DpzjQTZzBUqQYHQIFvlBVptPmyoGkdi2CgKAoeuUqkalIedaGAX0Iv8peYI-SJxkot46HKe2wNboQwMPvO__0k-vCK95qoWQIsWLvWkXZ22dPgW84KztRV7wFw7WB9U6FkOtCjguoqKEl1Rzmw_0FgOtCxVe0qw2sad3xEJAVClnxDWk5U03DZUWNUFITLmlZ8wrmoFarUbOSg73lqq14S35WQmpSi0YYmMO3s1HPORo88eJlXuDM9lkk6XPQ72uPtVVJhDS8lbT2jK1OWvUL0YYaoY1g2qOaqBUxorFDHbvBn3_o49EybuDrBwt91GqvEtro9_VnRqSdUQ_msY1pz0oaagQjTNU1Z3Z73v3yVrTWfDS3aTv-X3I3Qtqd7LajYQ5PRtM_8f0vZF-pljOqjf5a7epeG96Q4dNpYpvfxf91ehRnOCowFNHTBR6o9W67shbM28AEHVFI0uIc0mUB6cvFYoqOyo-R3SlepnmRRUlawIbcvuM9XGXJiyh7Az_gNzChEOXxyRQdJekz_Bo2pCSi2sCkHOLo5AKhaGEnGyufpN_juIC8iIokL5I4h-NrBADw2_C2j0PXPxEtfuVOCP70PsxU3TVSOyFc74M7vbM_3xzqW04Nrwg1TgjOmR-cu37g-gH4Qej7oe87B2LLsJDMEKY6aQ2Bf1j7rdBGWXqI6W9tY86hWXZ1vTce2ux_t094NgvOZsPd79P_O3L5KCMPHT7e1Ojm-OIzbPaWze4fbK4fYrMfYbP7xObfdGuyssrLZYaT5-lOuT6BDF_iDKcxzuETnxN6D7b1DWCvvwx2Pwr2MC9-fbWIkhQmy6tiCjh9dQI5XljtN3CZLV9ADz9-hzMMHcxhdoFc13WRZlRCj-Buu73bfrjbfgCmpDYtFdKEcBqEcH06AxdOZzforwAAAP__j9X7dw==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0k99u2zYUxq_DpzjQTZzBUqQYHQIFvlBVptPmyoGkdi2CgKAoeuUqkalIedaGAX0Iv8peYI-SJxkot46HKc2wtboQwMPvfOcPfnRdeMVbLZQMIVbsXasoe_vsKfANZ2Un6oq3YLg2sN6pEHJdyHEBFTW0pJrDfLi_AHBdqPiKdrWBNa07HgKyQiErviEtZ6ppuKyoEUpqwiUta17BHNRqNZpsa9n8ePEyL3BmixZJ-hz0-9pjbVUSIQ1vJa09Y61Iq34h2lAjtBFMe1QTtSJGNLbDYzf48w99PFrHDXz9YKGPWu1VQhv9vv5Mv7Qz6nGflqu24i35WQmpSS0aYWAO385GLc8f9LODas-WbKgRjDBV15zZ1Xr3m13RWvNRY9N2_L94N0LaHe-2rWEOT0btn_j-I-4r1XJGtdFfql3da8MbMqCgiW1-F__X9ijOcFRgKKKnCzwg7d12ZS2Yt4EJOqKQpMU5pMsC0peLxRQdlR8ju1O8TPMii5K0gA25fcd7uMqSF1H2Bn7Ab2BCIcrjkyk6StJn-DVsSElEtYFJOcTRyQVC0cJONlY-Sb_HcQF5ERVJXiRxDsfXCADgt-FvP4eufyJa_MqdEPzpfZipumukdkK43gd3emd_vjnUt5waXhFqnBCcMz84d_3A9QPwg9D3Q993DsT2TQjJDGGqkzYh8A9rvxXaKEsPMf2tbcw5TJZdXe8TD9PsO94bns2Cs9lw9_v0_45cfpWRhw6_3tTo5vjiM2z2ls3uH2yuH2KzH2Gz-8Tm33RrsrLKy2WGk-fpTrk-gQxf4gynMc7hE58Teg-2zRvAXj8Odj8K9jAvfn21iJIUJsurYgo4fXUCOV5Y7TdwmS1fQA8_foczDB3MYXaBXNd1kWZUQo_gbru92364234ApqQ2LRXShHAahHB9OgMXTmc36K8AAAD__9OuBQo=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvcQZLkWJ0CBT4QVWZTpsrB5LatQgCgqKolKtEpiLlWRkG9CPyK_uBfUq-ZKDcJh6mNMPW6EEAL885956LQ8eBN7zVQskAIsU-tIqy9y-eA99wVnSiLnkLhmsD6y0KIceBDOdQUkMLqjkshvsTAMeBkle0qw2sad3xAJAFckmLmpNrcXlNL8kvSkhYgJKjBFVVA0fIkm9Iy5lqGi5LaoSSmmyVSkuvqnG-RAM_Wr7OcpzaQfM4eQn6Y-2ytiyIkIa3ktauGYZq1a9EG2qENoJpl2qiKmJEY13tO_6ff-j90T6O7-kHG33GarcU2uiP9VfmpZ1Rj-u0XLUlb4fdaVKLRhhYwPfzUcnjB_WsUe3alg01ghGm6pozu1r3frMVrTUfFTZtx_-LdiOk3fF22xoW8GxU_pnnPaJeqZYzqo3-VuPqXhvekCEKmtjht_V_LY-iFIc5hjx8vsTDM3CvuqIWzN3AFO1RiJP8GJJVDsnr5XKG9orPle0pWiVZnoZxksOGXH3gPZyl8aswfQc_4XcwpRBm0cEM7cXJC_wWNqQgotzAtBjq6OAEoXBpnY21j5MfcZRDlod5nOVxlMH-OQIA-G34229C15dEi2s-CcCb3ZeZqrtG6kkA53fFLX5yd77YxbecGl4SaiYBTI48_9jxfMfzwfMDzws8b7IDtm9CSGYIU520BN_b7f1eaKNseojpr-xgk12y7Or6jrhLs-_4TvBo7h_Nh7vfZ__XcvEklocJn841utg_-Uo2e5vN7h_ZXD-UzX4km92XbP4NtyaVRZ6uUhy_TLbI9QGk-BSnOIlwBl_yOaX3wba8Idjrx4PdjwZ78Ivfni3DOIHp6iyfAU7eHECGlxb7HZymq1fQw88_4BRDBwuYnyDHcRykGZXQI7i9ubm9-XR78wmYktq0VEgTwKEfwPnhHBw4nF-gvwIAAP__ZUEWhw==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvcQbLkWJ0CBTkwVWZTpsrB5LatQgCgqKolKtEpiTlWRkG9CPyK_uBfUq-ZKDcOh6mJMPW-sGALs859x7yXM-DN1wboWQIkWIftKLs_YvnwNecFa2oS67BcmNhtUEh5HmQ4RxKamlBDYfT_vwEwPOg5BVtawsrWrc8BOSAXNKi5uRGXN3QK_KLEhJOQclBgqqqniNkyddEc6aahsuSWqGkIRul0tGrapgve7q6tqIRN1yT1nDyXhirrjRtzOPMnhotXmc5Tp3FPE5egvlYT5kuCyKk5VrSemp7O1r9SoylVhgrmJlSQ1RFrGjcfex7wZ9_mP3BPl7gmwcbfcaaaSmMNR_rR-alrVVP62iudMl1f-uG1KIRFk7h-9mg5PGDes6ombqWDbWCEabqmjP3KNP7N6lobfigsNUt_y_ajZDujje37R7v2aD8M99_Qr1SmjNqrPla45rOWN6QPgqGuOE39X8tj6IUz3MM-fz5AvcLNL1ui1qw6RrGaI9CnOTHkCxzSF4vFhO0V3yubL6iZZLl6TxOcliT6w-8g_M0fjVP38FP-B2MKcyz6GCC9uLkBX4La1IQUa5hXPR1dHCC0HzhnA21j5MfcZRDls_zOMvjKIP9CwQA8Fv_734juroiRtzwUQj-5L7MVN020oxCuNgWN_jR9vtyF685tbwk1I5CGB35wbHnB54fgB-Evh_6_mgH7HZCSGYJU610hMDf7d1vuUsPsd21G2y0S5ZtXW-JuzS3x1vBo1lwNOvPfp_8X8vFN7HcT_jtXKPL_ZNHstm5bLb_yObqoWx2A9lsv2Tzb7gVqRzybJni-GWyQa4OIMVnOMVJhDP4ks8xvQ-24_XBXj0d7G4w2L1f_PZ8MY8TGC_P8wng5M0BZHjhsN_BWbp8BR38_ANOMbRwCrMT5HmehwyjEjoEd7e3d7ef7m4_AVPSWE2FtCEcBiFcHM7Ag8PZJforAAD__74nKtI=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYYvY6e4oNv4gyWI8XoECjIhesynTZXDiS1axEEBEVRKVeKTEnKszMM6EPkVfYCe5Q8yUC6TTxMqfcXXxjgx3PO93eoMIQ3TBuuZAIzRT9oRej7F8-BrRitOi5qpsEyY2G5QQVBGEKBSqiJJRUxDE79_QlAGELNGtIJC0siOpZA4IBMkkowfMOvbsgV_klxCaegZC9BNY3ncFmzFdaMqrZlsiaWK2nwRql29Kbp50tPV9eWt_yGadwZht9zY9WVJq35p8y2E5ZTJbCxxO5ge_ps_rooUe4GVKbZSzAfxZjqusJcWqYlEWPrh6HVz16TG8upGRODVYMtb90098P499_Mfm-eMI7Mo4k-Y8245saaj-Ir9ZLOqt06mildM-13ZrDgLbdwCt9OeiWPH9Xzwxu7lC2xnGKqhGDUrXT8sNGGCMN6ha3u2L_Rbrl0M95M2y3vWa_8syjaod4ozSgx1vxf5Zq1sazF3goGu-I38b8tH8xyNC0RlNPnc-Sf3_i6qwSn4xUMgz0CaVYeQ7YoIXs9n4-CvepzZHOaLbKizKdpVsIKX39gazjP01fT_B38gN7BkMC0mB2Mgr00e4HewgpXmNcrGFY-HhycBMF07jrrS59m36NZCUU5LdOiTGcF7F8EAAC_-H_3G5DlFTb8hg0SiEYPYapE10ozSODiPrjBD-7Pl9t4zYhlNSZ2kMDgKIqPwygOoxiiOImiJIoGW2D3JrikFlPVSUeIo-3c_hvh3IPt-toVNtgmy06Ie-I2zb3je8GjSXw08Xe_jv5ry9WTtOwrfLqug8v9k694c-282f3Fm8vHvLnu8Wb3xZt_wi1x45BnixylL7MNcnkAOTpDOcpmqIAv_hySB2M7njf2crex173G9v2it-fzaZrBcHFejgBlbw6gQHOH_QbO8sUrWMOP36EcQQenMDkJwjAMA0OJhHUAd7e3d7ef7m4_AVXSWE24tAkcxglcHE4ghMPJZfBHAAAA__9fAkDT

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysks2O0zAUhfd5irsbQDjqD52WqboowaBKbWZI0mp2luPcCINjE19nGB6MF-DJkKdIbDIMQuws33O_c3xkxuCEnrSzV5A59dk7qT6-fQN4j6oetGnQQ0AKcHdWJQljUPIKGhlkLQlh8zBfAzAGDbZyMAHupBnwCpIo1LbBe-FRua5D28ignSWBVtYGG9iAa9vR5egV97P9sax4EU2rXf4eqDep8k0ttA3orTRpiCjh3VdBQQZNQStKJQnXiqC7mPCCTX98p4tRHzad0KNGv7SUNpoC9eYPeeUQ3NMcj8436MUnpy0JozsdYAOX81Hk6lFefCil0bKTQSuhnDGoYrXp72ZbaQhHwcEP-C_sTtvY8bltgg0sRvGLyeQJeus8KkmB_ldc-kYBO_HwFUjE8Of7v8YnWcG3FYeSfzjyPOPwZaiNVilhD4ddftrujxymcNjeno-vZ7P5fDmbzC9Xi1fL5WI1WcIuzwp-4HkFUyirbVHBdJ0k_PZmv93l8Oz6pnoJPD89h5LveVbBC3hXXB-AsF8njDGWEPYDWoWMMFYeJ8nPAAAA__-YsS6B

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3sQfJkWJ0CGQYmOoynTZXDiQ1bREEBEXRK1eZTElKszcMKPYMvtxr7AX2KHmSgXJ-3NVphm31hQEefuf7zjn6Dn0fzrk2QskIpoq904qyt8-eAl9xVjairrgGy42FdotCyPchxwVU1NKSGg6T7n4M4PtQ8QVtagstrRseAXJAISu-IpoztVxyWVErlDSES1rWvIIJqMVib7LTcvnT2cu8wJkTLZL0OZj39ZDpqiRCWq4lrYfWURGtfiLGUiuMFcwMqSFqQaxYugoP_fDPP8zhXh0_DMyDQjdYM6yEseZ9_Zl6aWPV4zyaK11xTX5UQhpSi6WwMIGvR3spTx7kc42aoZNcUisYYaquOXOjHd5PdkFrw_cSW93wf8O9FNLNeDttAxN4spf-SRA8wr5QmjNqrPm_yjVrY_mSdFYwxBW_jf9jejTNcFxgKOKnM9xZenjVlLVgwxX00QGFJC1OIJ0XkL6czTx0UN5EtqfpPM2LLE7SAlbk6h1fw1mWvIizN_A9fgN9CnE-HXjoIEmf4dewIiUR1Qr6ZRdHgzFC8cx1tk8-Sb_D0wLyIi6SvEimORxeIACAX7p_9-vR9gdixM-8F0Hg3YeZqpulNL0ILu6CW3zv7ny5i9ecWl4RansR9I6D8MQPQj8IIQijIIiCoLcDdjshJLOEqUa6hDDY1X4rjFXOPcSur1xhvd1k2dT1XeJumtvjO8LjUXg86u5-9f5ry-UXabmr8Mt1jS4Px5_x5tp5s_nEm-1D3lzv8WZz682PcC1ZOOTpPMPJ83SLbAeQ4VOc4XSKc7j1Z5_eG9vldcZuHzf2eq-xd_s9T_CrW5m220K3dx46aFyPaABxDjmeOQ7qQelB40ELp9n8xccb5P1N99W3OMNQwgRGY4Tw67NZnKTQn58VHuD0fHBL-tWWqx0j3_d9JKTk2ncvN_SZVsYMEFxvfr_efLjefADDqIT1J5HVNzfL7m5-c9_0erO5ATAljdVUSBvB0fFRGMHF0Qh8OBpdoh3YQtSWawN991AN0F8BAAD___QIRnw=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysktFq20wQha-zTzF3tn-ywuEnJcT4QlHVolaRjbQJDaUsa2lEt1lpm51xmjxYX6BPVtYuFIrTlNLb3TPfOXMYKeEaA1k_nkPm29vgTfvx5QXgA7abrXUdBmAkhvu9SggpockVdIbNxhDCcve_AJASOuzN1jHcG7fFcxBRaMcOH3TA1g8Djp1h60fSOJqNww6W4Pv-4HD0ivNZedWovI6mqqheA925pA3dRtuRMYzGJRxROvgvmtiwJbYtJYa07zXbISacyJNvX2ly0EeezOlJox9aSjpLTHfuN3nNlv3znIA-dBj0J29H0s4OlmEJL_4_iDx7khcXpSRaDoZtq1vvHLax2uRns71xhAfBHLb4N-zBjrHjfdsESzg9iD-dz5-h9z5ga4jpX8WlR2Ic9O4USMfw-_c_xouszlOVg0ovynx30gklDFNxZKCo1BlUKwXVVVkei6NsVTWqTotKAevPt_gI67q4TOsbeJvfwNRA2mQzMVsIkZYx7i_MonqTZwoalaqiUUXWwOT9h8lCiPzdukyLCqartTqGvLqeQZOXUfsfvKpXl0AJL4SUUgpqzQgsvgcAAP__UDU1BQ==

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJys0sFqGzEQBuD7PsXcYkO02JSUkuBDmi4lYNxQO6Y3MSvNpmq0EtbMusktD-FX6Qv0UfwkRbuFXjZNKblqR9_8MyulYEuJXQzncBXNfYpovn54D_RApu6ct5RAiAX2Q1VRKAXragMWBWtkgkX__QJAKbDUYOcF9ug7OoeiLxzOtCQMjEZcDHrXoXfyqGOjmdLemczUaO7vUuyCHcUS3XUeU2-6YOlBJzKxbSlYzChrClh7srCA2DSjRs6f718tb9eb6nMeZHO9-gi886VJttYuCKWAvpRM6RS_axYUx-IMl8g5sbg2xz1R858_-GS0j5rP-NlGv2u5tI6Fd_4vebGT-LKTKCZLSX-LLrD2rnUCC3j7ZpR896yXB-Uyt2xRnNEmek_9_yr_bLZBzzQKS-rof-zWhbzjYdsMCzgb5c9msxf0JiYyyMKvFZcfWajV_VNgncMP5__MF9WXm-Xl9Qomn242p1CttlPYXi5vqzVM5tOLQimliv4CF3A8HI6Hp-PhCSbz02nxKwAA__-hzzYj

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJys0sFu00AQBuC7n2JuTaSulQgVoVY5lGKhSlGoSBpxW03WYxhY7yo749De-hB5FV6AR8mToHWQuLgEoV7Xs9_8M15jYE1JOIZLuInuW4rovrx7C_RAbtOxrymBkijsjlVFYQwsqxXUqLhBIZj1368AjIGaGuy8wg59R5dQ9IXHM6sJg6BTjsFuO_SsjzY2Vijt2GXGJVZ26AepRJ87j6kXOdT0YBO52LYUasykWAq48VTDDGLTDBo5fb5_M79frqqPeYzV7eI9yNaXLtUby0EpBfSlZsqm-N2KorIoOylRcl7lNoc9M9OfP-RssI-ZTuTZRr9rpaxZVLb-L3mx03jaSRRTTcl-jRzEem5ZYQavXw2Sb5718qBS5pYtKjvrovfU_63yz2Yb9EKDsKaO_sduOeQdH7ctMIOLQf5iMjmhNzGRQ1F5qbjyKEqt7Z-C2Bz-eP7PfFF9uptf3y5g9OFudQ7VYj2G9fX8vlrCaDq-KowxpugvSAGH_f6wfzrsn2A0PR8XvwIAAP__tyw1Tg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0k9Fu2zYUhq-jpzjQTZzBEqQEHQIHuVBVptDmyoGkFi2KgqAoquVMiQ5JaZaHPdZeYE82UG4TF5WTYWt9YUBH__nP-aifngdvmNJctguIJV0rSeinF8-BbRktOy4qpsAwbaDfqxzH8yBHBVTEkJJoBtfj-ysAz4OK1aQTBnoiOrYAZxTua9go0mpCDZctvuuI4GbAssaaqZ5Ta0MVN5wSMWml2MdOEDU68rZiW6wYlU3D2opYS41ZS0rBKrgGWdeTHnZ72x8vX-cFyixGkaQvQd8Jn6qqxLw1TLVE-MZaYSV_x9oQw7XhVPtE230Nb-yyp17491_6dHKOFwb66KDPWu1XXBt9Jx7Zl3RGPu2jmFQVU_g3yVuNBW-4gWv4-WLS8vKonwXVvh3ZEMMpplIINn4t_-FkayI0mzQ2qmP_xbvhrT3j_WlruIZnk_bPguAJ91oqRok2-nutqwdtWIPHKGhsl9_X_7W9E2coKhAU0fMlGi-Jv-lKwam_hZlzQiBJi0tIVwWkr5fLuXNSfq7sn-JVmhdZlKQFbPFmzQa4zZJXUfYOfkXvYEYgyuOzuXOSpC_QW9jiEvNqC7NyrDtnV44TLS3Z1Pgk_QXFBeRFVCR5kcQ5nL53AAD-GP_tzyX9R6z5jrkLCOYPZSpF17TaXcD7--Je794_fzjUK0YMqzAx7gLc8yC89ILQC0IIwkUQLILAPRDbO8FbajCVXWsbwuBw9ieujbTpwWbY2MXcw-a2E-K-8bDN3uN7w_OL8PxifPfn_P8ilz8Eedzwx1E7H06vHsnmYLPZfZPN_lg2h4lsdl-y-ZWux7VV3qwylLxM98r-DDJ0gzKUxiiHL_mckYdg274x2P3TwR4mg_04787ybtbfACtWH0PeTSBv1hPM9fprWsXqKd5h1j3OtTvOhd7eLqMkhdnqtpgDSt-cQY6WVvsT3GSrV7C7cjzP8xxNSQs7558AAAD__6s7Tw8=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0k9Fu2zYUhq-jpzjQTZzBEqQEHQIHuVBVptDmyoGkFi2KgqAoquVMiQ5JaVaGPdZeYE82UG4TF5WdYWt9YUBH__nP-aifngdvmNJctguIJV0rSeinF8-BbRktOy4qpsAwbaDfqRzH8yBHBVTEkJJoBtfj-ysAz4OK1aQTBnoiOrYAZxTuatgo0mpCDZctvuuI4GbAssaaqZ5Ta0MVN5wSMWml2MdOEDU68rZiW6wYlU3D2opYS41ZS0rBKrgGWdeTHnZ72x8vX-cFyixGkaQvQd8Jn6qqxLw1TLVE-MZaYSV_x9oQw7XhVPtE230Nb-yyp17491_6dHKOFwb64KDPWu1XXBt9J47sSzojn_ZRTKqKKfyb5K3GgjfcwDX8fDFpeXnQz4Jq345siOEUUykEG7-W_3iyNRGaTRob1bH_4t3w1p7x7rQ1XMOzSftnQfCEey0Vo0Qb_b3W1YM2rMFjFDS2y-_q_9reiTMUFQiK6PkSjZfE33Sl4NTfwsw5IZCkxSWkqwLS18vl3DkpP1d2T_EqzYssStICtnizZgPcZsmrKHsHv6J3MCMQ5fHZ3DlJ0hfoLWxxiXm1hVk51p2zK8eJlpZsanyS_oLiAvIiKpK8SOIcTt87AAB_jP_255L-I9b8nrkLCOaPZSpF17TaXcD7h-JO7z48f9jXK0YMqzAx7gLc8yC89ILQC0IIwkUQLILA3RPbO8FbajCVXWsbwmB_9ieujbTpwWbY2MXc_ea2E-Khcb_N3uMHw_OL8PxifPfn_P8ilz8Eedzwx1E7H06vjmRzsNnsvslmfyibw0Q2uy_Z_ErX49oqb1YZSl6mO2V_Bhm6QRlKY5TDl3zOyGOwbd8Y7P7pYA-TwT7Oe295N-tvgBWrDyHfTyBv1hPM9fprWsXqKd5h1h3nuj_Mhd7eLqMkhdnqtpgDSt-cQY6WVvsT3GSrVzBcOZ7neY6mpIXB-ScAAP__qypPDQ==

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0k9Fu2zYUhq-jpzjwTZzBEqQEHQIHuVBVptDmyoGkFi2KgqAoquVMiQ5JaVKGPdZeYE82UG4TF5WdYWt9YUBH__nP-aifrgtvmNJcNkuIJN0oSeinF8-B9YwWLRclU2CYNtDtVI7jupChHEpiSEE0g-vx_RWA60LJKtIKAx0RLVuCMwp3NWwUaTShhssG37VEcDNgWWHNVMeptaGKG06JmLRS7GMriBodeVOyHitGZV2zpiTWUmPWkEKwEq5BVtWkh93e9ker11mOUouRx8lL0HfCo6osMG8MUw0RnrFWWMnfsTbEcG041R7Rdl_Da7vsqRv8_Zc-nZzjBr4-OOizVnsl10bfiSP7ktbIp30Uk6pkCv8meaOx4DU3cA0_X0xaXh70s6DasyNrYjjFVArBxq_lPZ5sRYRmk8ZGtey_eNe8sWe8O20N1_Bs0v6Z7z_hXknFKNFGf6919aANq_EYBY3t8rv6v7Z3ohSFOYI8fL5C4yXxtm0hOPV6mDsnBOIkv4RknUPyerVaOCfF58ruKVonWZ6GcZJDj7cbNsBtGr8K03fwK3oHcwJhFp0tnJM4eYHeQo8LzMse5sVYd86uHCdcWbKp8XHyC4pyyPIwj7M8jjI4fe8AAPwx_tvfjHQfseb3bLYEf_FYplK0daNnS3j_UNzpZw_PH_b1ihHDSkzMbAmzcz-4dP3A9QPwg6XvL31_tie2d4I31GAq28Y2BP7-7E9cG2nTg82wtYvN9pubVoiHxv02e48fDM8vgvOL8d2fi_-LXPwQ5HHDH0ftfDi9OpLNwWaz_Sab3aFsDhPZbL9k8ytdhyurvFmnKH6Z7JTdGaToBqUoiVAGX_I5J4_Btn1jsLungz1MBvs4773l3W6-AVasOoR8P4G83UwwV5uvaRWrpniHeXuc6_4wF3p7uwrjBObr23wBKHlzBhlaWe1PcJOuX0F_5biu6zqakgZ6558AAAD__6sZTws=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U9FunEYUfTZfccWL19WCwFYqay0_EDKOaDesBSRKFEWjYRiS6Q7Memagy1b9rP5Av6wa1rW3CmtXbbIPK3E599xzLud6HrxjSnPZLiCWdK0koV9evQS2ZbTsuKiYAsO0gX6PchzPgxwVUBFDSqIZXI_vrwA8DypWk04Y6Ino2AKcEbivYaNIqwk1XLb4riOCmwHLGmumek4tDVXccErEJJVinztB1MjI24ptsWJUNg1rK2IpNWYtKQWr4BpkXU9yWPW2P16-zQuUWRtFkr4GfSd8qqoS89Yw1RLhG0uFlfwVa0MM14ZT7RNt9RreWLGnXvjnH_p0co4XBvrooHus9iuujb4TT-glnZHP8ygmVcUU_kXyVmPBG27gGn68mKS8PMpnjWrfjmyI4RRTKQQbv5b_uNmaCM0miY3q2H_hbnhrd7zftoZreDFJ_yIInmGvpWKUaKO_lVw9aMMaPEZBYyt-X__X9E6coahAUEQvl2g8En_TlYJTfwsz54RAkhaXkK4KSN8ul3PnpLyv7J_iVZoXWZSkBWzxZs0GuM2SN1H2AX5GH2BGIMrjs7lzkqSv0HvY4hLzaguzcqw7Z1eOEy2ts6nxSfoTigvIi6hI8iKJczj96AAA_Db-259L-s9Y8x1zFxDMH8tUiq5ptbuAjw_FPd59eP50iFeMGFZhYtwFuOdBeOkFoReEEISLIFgEgXsAtjfBW2owlV1rG8LgcPYXro206cFm2Fhh7mFz2wnx0HjYZu_4gfD8Ijy_GN_9Pv-_lsvvYnlU-P1cO59Or57I5s5mc7P-KpyK1cfiuZuI52b9dz4PgPUablYZSl6ne5Bi9Rlk6AZlKI1RDvcShln3dIB3kwF-2tdgfXVf2eqPmRomTHUTngbc49oi_-Gsn_K1nZFnFjLZtptt1o-HbueNh94_f-jD8T2h97fLKElhtrot5oDSd2eQo6XF_gA32eoNDFeO53meoylpYXD-CgAA__8JA17R

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8lF1u4zYUhZ_DVVzoxU5hCbIyaTM2_KA4mkKtRg4sJZggCAiKohM2FBmTlBO36LK6ga6soJwfF3B-ULT1gwGfe-_Hw0PSvg_nTBuu5Aimit5qRejNyTGwB0arlouaabDMWFhtuhDyfSiSEmpiSUUMg0lXHwP4PtRsQVphYUVEy0aAusaNhq0m0hBquZJ42RLB7RqrBTZMrzh1GKq55ZSInSjNrltBdEfksmYPWDOqmobJmjikwUySSrAaJqAWi50M597NT7Ozokzmbhtlmv8IZikCqusKc2mZlkQE1qGwVvfYWGK5sZyagBjn1_LGme35wz__ML2d6_jD0Ly60GOvCWpurFmKN_yS1qr3OZopXTONf1FcGix4wy1M4PuDncijV3luoyZwSzbEcoqpEoJ1pxW8JLsgwrCdYKtb9k_YDZcu403aBiZwuBN_GIbv0BdKM0qMNf-WXbM2ljW4uwoGO_Mb_cN4NJ0ncZlAGR9nSfdIgru2EpwGFfTRXgXHs1kG-ayE_CzLBmhPq3teQ5qXR516nhapm3zqgJPkS3yWldBKvmy7wHjd3x-gveksL8p5nOYlVPjulq3hdJ5-jecX8HNyAf0NNy6mrjfNT5JvUOEK8_oB-lWno_0xQnHmgtjlNs1_SqYlFGVcpkWZTgvoXSIAgN-6b_fxyOoaG_4r80YwHLzIVIm2kcYbweWz2BUq7_n31Xa_ZsSyGhPrjcCLwijyh5EfRjA8Gh18GkWfg8MfPn0-iLytGfeSuKQWU9VKNxdtFW-4scrdOGzXd86dtz0qSdNpuDtgjP9Wa4V4RoZbBfe_8KQPh2HYVX4fvJFI-JFEumP6D1MJ_79UHiNBV70xQsm30yxOc-jPTssBJPn5PhRJ5i7Ud_BlPvsK1Rj5vu8jQ4mECv0VAAD__9bd7pY=
