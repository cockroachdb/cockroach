# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu8jYUx6_rpzjKzUcnMhK4qYIqLaWZlo2GCrKuVVVZTmLAw9iZ40BgmtSH4An7JJMT2rJJFFWfygWST_6_c_4-5yS2DXdUFUwKDwYyXShJ0vn1FdCKpknJeEYVaFpoWDUqhGwbFJUqowr_KZkoMGdLpmFOCtBzChmdkpJrWBFeUg8ujJ4KknCKt2y2JbOaOiaXwuhlrtmSbanCZUHxnBVazhRZFp-hliXXLJUcF5roEySXKeFMb_BrigznRGmmmRQ0w0xktMJFSk7YzpXMyYxoipnIS43rJjExO0pNpw1Gp1RhLuWizPc9nUqFp4vjthuSCU3VivBCbzjFTZezE0xGzDg_oWcF4Vyu8bTkHOt6kKYVp7xxoma0gYwcK7k-iriO4xgmlYVukuM103O8l-F6jGxLPyo5CWLjVRd_cbg0kT6Asf9fJSm1NJVWNNVSfZRSIDQYB34cQOxfDQPIy4Sz9McKWuiMQBjFFxCNYoh-Hw7b6CzZR5rTYBRN4rEfRjFUOF_QDdyOwxt__AC_BQ_QIuBPBudtdBZG18E9VDjBLKugldRxdN5HyB_Gwfj_lcPo12AQwyT243ASh4MJfHtEAAB_1__mZ5HVrG6V5YHTfg-nkpdLUVgePL4FG731dn461CtKNM0w0ZYHVtdxL2zHtR0XHNdzHM9xrAOxaTsTqZlTKQzgOoe16_e3nqHe5MaYdQgLsyGv4CGm5Po9Ybfndnv1s3_a33vl5EuuXDv8ulujp299hIL726EfRtAa3cZtCKK7c5gEQ7MUP8DP49ENVPDHL8E4gAQuoddHtm3bqP5wVT_t1wzBy273snt-2T1DKkWhFWFCe9DpdlwPHjs9sKHTe0L_BgAA__-x9NrZ

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ld9u2zYUxq_DpzjwTe3BWuT4JlBQYK7LbNpcOZC1rkUQELRE2VxoUiMpRcowoNgz-HJPlycZKDmJu8YJiqG-MKCj38fz76PtefCeacOVDGCq0mutaLp--wZYzdJlyUXGNFhmLFQdhZDngWZKZ0yT3xWXhgi-4RbW1IBdM8hYTkthoaKiZAGcOp5JuhSM3PLVLV21qkO4ko5XheUbfss0KQ0ja26sWmm6MV-j2pTC8lQJYiy1LyiFSqngtiH3R2SkoNpyy5VkGeEyYzUxKX2h7EKrgq6oZYTLorSkHRKXq4OqPO9kLGeaCKWuy2I301xpkl8fLrtTcmmZrqgwthGMdFPOXtBk1K3zK3huqBDqhuSlEMS2i3SjeKk2QfWKdSKHE61uDkpGvu87TaqM7Q4nN9yuyQ4j7Rr5LXsu5QInrlZr_hDw2kXOAFz5n5O0tMplqlhqlX7uSInQNMaTBEMyeTPDUJRLwdPva-ijIwphlJxCNE8g-nU2G6Kj5S7SPU3n0SKJJ2GUQE2Ka9bARRy-m8Qf4Rf8EfoUJovpYIiOwugt_gA1WRKe1dBftnE0OENoMktw_N_MYfQzniawSCZJuEjC6QJeXSIAgD_bb_fp0WrVjqoXgD98DKdKlBtpegFcPgQ7vvfwfLXPa0Ytywi1vQB6J_7o1PNHnj8CfxT4fuD7vT3YjZ3L1O2plE4w8vdzt_e33aFtCldYb18snUPuhfsyrW4eDzwZj07G7bu_hv-35eU3abmt8Nt1ja5enT3tyMY5svzCkdUhRzZPOLK8d-RnXEVyR57PYxz-GHVkNYAYn-MYR1O8eLBmnz7a2elaO1fP2rl50s5tl_jDxWwSRtCfXyRDwNH7ASzwzLHfwXk8fwf1EBr47SccY1jCaxifIc_zPMSlZNpr_176qVbGDBDcbf-52366236C9ve7-SJS_7C7f-7N327Wd9vtDkiVNFZTLm0AxyfHowAuj8fgwfH4Cu1hOReWaQN9q0s2QP8GAAD__wMoPiM=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lMGO2zYQhs_LpxjoEruwCnlzWdjIQXFUQK0jLyw1SLBYELQ0slnTpEpStuyiQB7Cxz7dPklByUncAo6xCFYHQZz5v5nhDEXfhw-oDVdyBBOVr7Vi-erdW8AG80XNRYEaLBoL205FiO-DRqUL1PQPxaWhgm-4hRUzYFcIBZasFha2TNQ4gjunR8kWAumBLw9s2VKX5Eo6vaos3_ADalobpCturFpqtjHPoTa1sDxXghrL7BVSqJwJbvf0S4iCVkxbbrmSWFAuC2yoydmVsiutKrZkFimXVW1p2yQulxepsuwwLFFTodS6rk49LZWm5fpy2R3JpUW9ZcLYvUDadbm4whTMjfMZem6YEGpHy1oIattBulZcq00wvcQOcnKq1e4iMgyCwDG5MrYLTnfcruhJRtsx8gN-L2UaZa5Wa_4U8MZZxgCu_P8qWW2Vy7TF3Cr9vZCSkMk8CrMIsvDtNIKqXgie_9xAj9wwiJPsDpJZBsnv0-mA3CxOlm41mSVpNg_jJIOGVmvcw_08fh_OP8Fv0SfoMQjTSX9AbuLkXfQRGrqgvGigt2jtpD8mJJxm0fz_mePk12iSQZqFWZxm8SSFVw8EAOCv9u0ej22Xbau8EQSDb-ZciXojjTeCh6_GTu99XT-e6zUyiwVl1huBdxsM7_xg6AdDCIajIBgFgXcmdm3nMndzqqUDhsF57vb_bWdo95UrzDuHpTshX8BzTKvdt4C3r4e3r1vf34Mf3fLiRbbcVvhyuyaPr8aERB_vp2GcQG92nw0gSj70IY2m7lD8BL_MZ--hgTAFJXHQfdmdGhPf933CpUTtt1dvL9fKmD6Bp-M_T8fPT8fP0N5tDTww80ZJfLzgsjvVuo4nV8mFRW2gZ3WNffJvAAAA__9lEfNN

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk8FO4zoUhtf4Kc6O9opcQJVGqBWLEMxMZkqKkgwDQsgyidN66sYZ-zg0XfEQfUKeZJQENmigYhnr-45__cfxPLgWxkpdjiHQ2dJoni3Oz0CsRfbgpMqFARQWoe4pQhKaghHa5MKw31qWlim5kgin8GU0AfA8yEXBnUKouXJiDCfE80CU_EEJtpHzDZ93Hiy4BVyIt7guW15XKFdyIwxzVrCFtKjnhq_sZ6yVUygzrZhFjjtMpTOuJDbsdUTOKm5QotSlyJksc7FmNuM7YldGV3zOUTBZVg5ZV5Ms5-9aRdFrohCGKa2XrnpptdCGFcv3Y_emLFGYmiuLjRKsbznf4eS83egneGm5UvqRFU4pht0i2yp2ZVPczEUvtTgz-vFd5fjo6Kh1Mm2xH84eJS7YC8a6NcqN-OjK9mXm0qL9o-C0Pfnnc-QOdXtTLTLU5qORJSFBTP2UQuqfTSlU7kHJ7P8GBmTPQRilJxDNUoh-TqcHZK9-Oem_glmUpLEfRik0rFqKBq7i8NKPb-EHvYWBAz8Jhm-5mhUteTGLafg16sl6CDG9oDGNApq8RlgPeCuH0Tm96TyZr2FQd0PJcEKIP01p_DZ2GH2nQQpJ6qdhkoZBAvt39_sTQujN1dQPIxjMrtIDoNH1EBI6bdn_4CKeXUIDv77RmIKDUxhNiOd5Hul-hobA83b7vH163j5BpkuLhssSx3B4PIa7wxF4cDi6J38DAAD__-ufef8=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk8FO4zoUhtf4Kc6O9opcQJVGqBWLEMxMZkqKkgwDQsgyidN66sYZ-zg0XfEQfUKeZJQENmigYhnr-45__cfxPLgWxkpdjiHQ2dJoni3Oz0CsRfbgpMqFARQWoe4pQhKaghHa5MKw31qWlim5kgin8GU0AfA8yEXBnUKouXJiDCfE80CU_EEJtpHzDZ93Hiy4BVyIt7guW15XKFdyIwxzVrCFtKjnhq_sZ6yVUygzrZhFjjtMpTOuJDbsdUTOKm5QotSlyJksc7FmNuM7YldGV3zOUTBZVg5ZV5Ms5-9aRdFrohCGKa2XrnpptdCGFcv3Y_emLFGYmiuLjRKsbznf4eS83egneGm5UvqRFU4pht0i2yp2ZVPczEUvtTgz-vFd5fjo6Kh1Mm2xH84eJS7YC8a6NcqN-OjK9mXm0qL9o-C0Pfnnc-QOdXtTLTLU5qORJSFBTP2UQuqfTSlU7kHJ7P8GBmTPQRilJxDNUoh-TqcHZK9-Oem_glmUpLEfRik0rFqKBq7i8NKPb-EHvYWBAz8Jhm-5mhUteTGLafg16sl6CDG9oDGNApq8RlgPeCuH0Tm96TyZr2FQd0PJcEKIP01p_DZ2GH2nQQpJ6qdhkoZBAvt39_sTQujN1dQPIxjMrtIDoNH1EBI6bdn_4CKeXUIDv77RmIKDUxhNiOd5Hul-hobA83b7vH163j5BpkuLhssSx3B4PIa7wxF4cDi6J38DAAD__-ufef8=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk99O2zwYxo_xVbxntJ_IB6jShFpxEILZspUUJR4DIWSZxGm9unbmP6HpERfRK-RKpiRwgkbZDhP9fo9fPa8dBHDNjRVajSHS-dJoli_Oz4Cvef7ghSy4Acetg7qnEMowAcO1KbihP7VQlkqxEg5O4dNoAhAEUPCSeemgZtLzMZx0ClfsQXK6EfMNm3cinIIuyz8qWqEgAF05sRIbbqi3nC6EdXpu2MrCgllwC_431spLJ3ItqXXMfWBKnTMpXENfIwpaMeOEE1rxggpV8DW1OVO7YyqjKzZnjlOhKu9oV5VQ83etsuw1XnJDpdZLX700W2pDy-X7Y_emUI6bmknrGslpX3TxgVOwdqv_wAvLpNSPtPRSUtftsq3io9kkM3PeSy1OjX58Vzk-OjpqnVxb14fTR-EW9AWj3RrFhu86sr1qhbDO_pI77hfzTrcn1Tx32uyKVAhFKQ4JBhKeTTFU_kGK_P8GBmjPQ5yQE0hmBJLv0-kB2qtf_vRf0SzJSBrGCYGGVkvewFUaX4bpLXzDtzDwEGbR8C1X07IlL2Ypjj8nPVkPIcUXOMVJhLPXEdYD1spxco5vOk8UaxjUXSgaThAKpwSnb8eOk684IpCRkMQZiaMM9u_u9ycI4ZuraRgnMJhdkQPAyfUQMjxt2f_gIp1dQgM_vuAUg4dTGE1QEAQB6h5Dg-B5u33ePj1vnyDXyjrDhHJjODwew93hCAI4HN2j3wEAAP__IGl6YQ==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk81O4zwUhtf4Ks6O9hP5AFUaoVYsQjAzmSkpSjwMCCHLJE7rqWtn_BOarriIXiFXMkoCGwRFs0z0PK-P3mMHAVxzY4VWY4h0vjSa5YvzM-Brnj94IQtuwHHroO4phDJMwHBtCm7oby2UpVKshINT-DKaAAQBFLxkXjqomfR8DCedwhV7kJxuxHzD5p0Ip6DL8l1Fq87RlRMrseGGesvpQlin54at7G4zCN6IKy-dyLWk1jFnYcEsuAV_35Q6Z1K4hr5GFLRixgkntOIFFarga2pzpnbHVEZXbM4cp0JV3tGuLqHmH1pl2Wu85IZKrZe-emm31IaWy4_H7k2hHDc1k9Y1ktO-7OITp2DtZv-BF5ZJqR9p6aWkrttnW8Vns0lm5ryXWpwa_fihcnx0dNQ6ubauD6ePwi3oC0a7NYoN33Vke3UKYZ39I3fcFOadbk-qee602RWpEIpSHBIMJDybYqj8gxT5_w0M0J6HOCEnkMwIJD-n0wO0V7_86b-iWZKRNIwTAg2tlryBqzS-DNNb-IFvYeAhzKLhW66mZUtezFIcf016sh5Cii9wipMIZ68jrAeslePkHN90nijWMKi7UDScIBROCU7fjh0n33FEICMhiTMSRxns393vTxDCN1fTME5gMLsiB4CT6yFkeNqy_8FFOruEBn59wykGD6cwmqAgCALUPYYGwfN2-7x9et4-Qa6VdYYJ5cZweDyGu8MRBHA4ukd_AwAA__-SQnrD

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUk89O4zoUxtf4Kc6O9opcQJWuUCsWIZg7mSkpSjwMCCHLJE7rqWtn_Cc0XfEQfUKeZJQENgioWCb6_b5zdL4kCOCaGyu0GkOk86XRLF-cnwFf8_zBC1lwA45bB3VPIZRhAoZrU3BDf2uhLJViJRycwn-jCUAQQMFL5qWDmknPx3DSKVyxB8npRsw3bN6JcAq6LN9VtOocXTmxEhtuqLecLoR1em7Yyn7VXHnpRK4ltY65HXYQgNQ5k8I19DWloBUzTjihFS-oUAVfU5szBQtmwS34-zGV0RWbM8epUJV3tDuZUPMPrbLsNV5yQ6XWS1-9XLjUhpZLu8MUynFTM2ldIzntD17scArWtvsFXlgmpX6kpZeSuq7T9hS7dpPMzHkvtTg1-vFD5fjo6Kh1cm1dH04fhVvQF4x2TYoN_2xk-xEUwjr7R37SN_NOt5NqnjttPotUCEUpDgkGEp5NMVT-QYr83wYGaM9DnJATSGYEkp_T6QHaq1_e9E_RLMlIGsYJgYZWS97AVRpfhukt_MC3MPAQZtHwLVfTsiUvZimO_096sh5Cii9wipMIZ68rrAeslePkHN90nijWMKi7UDScIBROCU7frh0n33FEICMhiTMSRxns393vTxDCN1fTME5gMLsiB4CT6yFkeNqy_8BFOruEBn59wykGD6cwmqAgCALU_QwNguft9nn79Lx9glwr6wwTyo3h8HgMd4cjCOBwdI_-BgAA__9GjHsl

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAQx9_zKe5xm5YJylpYUR8Y8yQkSDtIUd8s41zCDWMH-wwtn34K6V6mUdS3KP797k7_uzSFJfpAzt7C2OmNd0qvf3wHfEa9imQK9MAYGPYtlSQLkYNH5wv08rcjG6ShLTHcwU1vCJCmUGCpomHYKxPxFgZJmgJatTIoj1QdVXXyYK0C8Br_xZ1teFczbemIXsaAck2BXeXVNrzH2kbDpJ2RgRVfMI3TyhC_yL8lClkrz8TkLBaSbIHPMmh1Yezau1pVilGSrSPLU0xkq7NWWbYaluilcW4T69dUS-dluTk_dmuSZfR7ZQK_GJRtysUFp1DNRt_BU1DGuIMsozGST4tsorg0m1G-wlZqcOnd4azS7XQ6jaNd4La4PBCv5SsmT2ukI77VsrnMggKHnYG75s9_z1FFdk2nPWp2_q2SNknGczHKBSzEr0eRjQXUcWVIfwm4g9kkW46mjwK6MBs9tZ_frq56vf5Vp3czuP7a718POn2YZOO5mIkshy4s8tE8h-4wScTTw3Q0yeDD_UP-GUS2_AgLMRXjHD7Bz_n9DALuhkmapmkScBfRakwDGtTcvCR_AgAA__-To0dw

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0Vd1u2zYUvg6f4sA3tQepkWNgCBwEmOsymzZXDmQtbREEBC1RNhea1EhKsTIMKPYMvtzT5UkGSnbitvlBMVQXAnj4fef3O6DvwwXThis5hLFKr7Wi6fLtG2Brls5LLjKmwTJjoWpRCM1wApopnTFN_lBcGiL4ils4hR8HJwC-DxnLaSksVFSUbAjHyPeBSToXjNzyxS1dNDxYUgN2yb6EK-nwqrB8xW-ZJqVhZMmNVQtNV-ZbWKtSWJ4qQYyl9gWmUCkV3NZk5yIjBdWWW64kywiXGVsTk9IX0i60KuiCWka4LEpLmjZxuXiSlectjeVME6HUdVlsu5orTfLrp9NumVxapisqjK0FI22Xsxc4GXUT_QY8N1QIdUPyUghim0G6VryUm6B6wVqSgxOtbp6k9IMgcJxUGds6JzfcLskWRpox8lv2XEinzIwba_4UcOosj8qRlla5SBVLrdLPuZQIjWM8SjAkozcTDEU5Fzx9vYYuOqAQRskxRNMEot8nEw8dzLeW9jSeRrMkHoVRAmtSXLMazuPw3Sj-CL_hj9ClMJqNex46CKO3-AOsyZzwbA3deWNHvROERpMEx19GDqNf8TiBWTJKwlkSjmfw6hIBAPzV_N3XodWiaVVnCIH3YE6VKFfSdIZweW9s8Z3789U-XjNqWUao7QyhcxT0j_2g7wd9CPrDIBgGQWcP7NrOZermVEpH6Af7sZv9bWZo68Il1tknS6eQHXGfptXNg8OjQf9o0Nz97f3fkuffpeQmw-9XNbp6dfK4ImunyPIrRVZPKbJ-RJHlTpGf4SqSO-TZNMbhz1GLrHoQ4zMc42iMZ_fS7NIHOTteI-fqWTnXj8p5v8qLEL_foatm7dyieeigdOWhHoxmMMMT54N6MPeg9KCCs3j6rnm0Xu-S8z471vD-FxxjmMMpDE4Qwh_OJ6Mwgu70PPEARxe9ndMfWl_VCfJ930dcSqb95vHqploZ00Nwt_n3bvPpbvMJmteh_sqy_mm73e7mHzfJu81mC0iVNFZTLu0QDo8O-0O4PByAD4eDK7QHy7mwTBvoWl2yHvovAAD__-qlV7M=

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUklFr2zAQx5-rT3FvbUY9MgajNPTB9Tzw5jrB1srKGIdqnx0tiuVJ56TJpx-OOxhjaeir-P3-Ov53QQD35Ly27TVEtlw5q8rlx1ugJyofe20qcsDkGTYjJUQRS3BkXUUOf1rdejR6rRlu4MP7GUAQQEW16g3DRpmeruFKBAFQqx4N4V43e9UcPFgqD7ykf3HbDrztWK_1nhz2nnCpPdvGqbV_jbXuDevSGvSs-IRpbKmM5h3-iaiwU441a9tShbqt6Al9qU6M3TnbqUYxoW67nvFQk26bo1ZdjxrV5NBYu-q751Zr67BeHR97NHXL5DbKeN4ZwrHl6oRTqWGjr-C1V8bYLda9MciHRQ5VnJrNKNfQKA04Ors9qrybTqeDU1rPYzhuNS_xGcPDGvWeXvpyuMxKe_a_DNwML_89R9WzHX7aUMnWvRTZChHlcShjkOFtGoN_y3AhzhQkmbyCbC4h-5qml-IsmmeFzMMkk8DYrWgHizy5C_MH-BI_wIWCsIgmYjITIkxlnP8Vl2Sf40hCIUOZFDKJCjj__uN8JkT8bZGGSQYX84W8hDi7n0ARpwP7Bj7l87vBnokgCAJxuEoWvwMAAP__iItKGA==
