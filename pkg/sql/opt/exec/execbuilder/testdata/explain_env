# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20oUhtfMU_zyhuQqJnayQUZXuiYYXd9rHOS4FITQaGwPZNrxTDQeU0NViYfIE_IklQNNs0FtF3hh6Zzzf0fn1z-uiwtuGqFVgJkuPxvNyuXJMXjHy6IVsuIGljcW9y8qQlwXhmtTcUM_aaEaKkUtLJasgV1yVPyWtdLinsmWBzjs9VyxQnL6KO4e2d2GekuuVa_XKytq8cgNbRtOl6Kx-s6wuvkTqm6lFaWWtLHM_oLk3YobUXNlmaQrZqxgkgpV8Y6_Td7eEjLLojCPkIfHSYRVW0hRHnQYkD2GOM0Pkc5zpB-SZET2itfOSzWbp4s8C-M0h7MyombmwcF5Fp-F2RX-j64wYAgXs-GI7MXpSXSJjhZUVB0GxY_-aXgWJ1c7-ICNUAzJ8IiQMMmj7PWsPr2D7W1x-l80y7HIwzxe5PFsgf1rAgBfN__-c0ot21o1ToDrbXMzYM62vhnt6A1nlleUWSeAM_H8Q9fzXc-H5weeF3iesyOuRGOFKi0tdat6wPe8nfEmbNrnZh9WvN-3C6tWyi24ixn95efCydSfTDezb6Pf9la8i7fNKe9nj9zsHxESXZ4nYZxiMD_PR4jSiyEWUdLH_BdOs_kZOnz8N8oiFPgb0yPiuq5LmpIpdP-8viuC5_X6ef30vH5CqVVjDRPKBhhPxn6A6_EULsbTG_I9AAD__0fxLfo=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20oUhtfMU_zyhuQqJnayQUZXuiYYXd9rHOS4FITQaGwPZNrxTDQeU0NViYfIE_IklQNNs0FtF3hh6Zzzf0fn1z-uiwtuGqFVgJkuPxvNyuXJMXjHy6IVsuIGljcW9y8qQlwXhmtTcUM_aaEaKkUtLJasgV1yVPyWtdLinsmWBzjs9VyxQnL6KO4e2d2GekuuVa_XKytq8cgNbRtOl6Kx-s6wuvkTqm6lFaWWtLHM_oLk3YobUXNlmaQrZqxgkgpV8Y6_Td7eEjLLojCPkIfHSYRVW0hRHnQYkD2GOM0Pkc5zpB-SZET2itfOSzWbp4s8C-M0h7MyombmwcF5Fp-F2RX-j64wYAgXs-GI7MXpSXSJjhZUVB0GxY_-aXgWJ1c7-ICNUAzJ8IiQMMmj7PWsPr2D7W1x-l80y7HIwzxe5PFsgf1rAgBfN__-c0ot21o1ToDrbXMzYM62vhnt6A1nlleUWSeAM_H8Q9fzXc-H5weeF3iesyOuRGOFKi0tdat6wPe8nfEmbNrnZh9WvN-3C6tWyi24ixn95efCydSfTDezb6Pf9la8i7fNKe9nj9zsHxESXZ4nYZxiMD_PR4jSiyEWUdLH_BdOs_kZOnz8N8oiFPgb0yPiuq5LmpIpdP-8viuC5_X6ef30vH5CqVVjDRPKBhhPxn6A6_EULsbTG_I9AAD__0fxLfo=

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lMFO20wQx8_sU4x8wflkEye5IKNPqgmb1m1wkONSEEKrtbMhW5x1tLt2HapKqM-QY58uT1LZCcES0JYDPljamd9_NeP5j20bzplUPBMu9LPkVmY0mZ0cAytZEuc8nTAJmikNxYZCyLZBskxOmCRfMy4USfmca5hRBXrGYMKmNE81FDTNmQuHFc8EjVNG7vjNHb2pVS_hmaj4bKH5nN8xSXLFyIwrnd1IOlevUc3zVPMkS4nSVP9FycoFk3zOhKYpWVCpOU0JFxNWspeV0ylC_RB7EYbIOx5iWORxypODEky0R8EPokMIRhEEn4dDC-3F28jm1B8F4yj0_CACYyH5nMqlAWehf-qFl_AJX4JJwRv3Wxba84MTfAEliQmflGDGD_GBd-oPLxtyk1oQt1DrCCFvGOFwW1Y1vYNdbX7wEfcjGEde5I8jvz-G_SsEAPC9flePkWRpPhfKcOFqF6wT1Nidr60GLxnVbEKoNlwwuk7n0HY6ttMBp-M6jus4RgOecKW5SDRJslxUgo7jNNL1sEk1N71csOq-pljkaboTNmUy-_Z4YbfX6fbq3A_rn3uL36S3upS3aw9d7x8978Jl5cL8iQuLV7owf3BbA53ekoJINiUlDEYh9t8HG7ZoQYgHOMRBH49322DSRxMvSbExcfGyiXMLij-bePmsiesvgS_Ohp4fgDk6iyzAwXkLxnhYsf_BIBydQmnBEr58wCGGGP6H3hGybdtGXAgm7frHZCYyU6qFYL36tV7dr1f3oBIqYPkkUr7bLmWV-VnNY71abYEkE0pLyoV2od1td1y4avfAhnbvGjWwKU81kwpMLXPWQr8DAAD__wfkm6g=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k8FO20AQhs_sU4x8wals5MAFhZMJRnJrHBRvEQih1dqekG3Xu9HuGgxVJR4ixz4dT1LZ0DRShdoe8MHy_PN_oxn9chjCBRortJrAVFdfjebV8uQYsMOqbIWs0YBD6-DuxUVIGIJBbWo07IsWyjIpGuFgyS24JUKNC95KB3dctjiBw96PipcS2aO4feS3A_WWXaver1dONOIRDWstsqWwTt8a3tj_oZpWOlFpyazj7i8kdis0okHluGQrbpzgkglVY4dvk4sFIdN5EtMEaHycJbBqSymqvQ58ssMhzekh5DMK-ecsC8hO-aq8VNNZXtB5nOYUvJURDTcPHpzP07N4fgWfkivwOcTFdBSQnTQ_SS6hYyUTdQd--Us_jc_S7GoL93kA5YiMjgiJM5rMX9fq09vb7JbmH5MphYLGNC1oOi1g95oAAHwb3v3jVVq2jbLeBK434tDg3qa-Cbb8BrnDmnHnTcDbj8aHYTQOozFE40kUTaLI2zLXwjqhKscq3aoeGEfRVnsIm_W5uYcV9vO2YdVKuQG3MaPvfw_cPxjvHwy978E_31a-y23DKu93HrnZPSIkuTzP4jQHf3ZOA0jyixEUSdbH_AFO57Mz6CAuQCsMXr7cvT4iYRiGRCiFJhx-SL8y2toRgef1j-f10_P6CWzFVY_9obl73WvrV20hpENjwXemxRH5GQAA__-v4EGs

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkd9q2zAUxq-rp_joTZ0RNYzAKAm9cF1l8-Yowda6hlKE4iiJVv8JsmycXPUh8oR5kpGlHdtgjF6ew-93zvk4lOJO28qUxQBBmT7ZUqXr2xvoVqfz2mQLbeF05dCcKEISJmB1aRfayu-lKSqZmdw4XONDfwhQioVeqjpzaFRW6wGuCKXQhZpnWu7MaqdWPz2sVQW31n_jZXHky40zudlpK-tKy7WpXLmyKq_eYuV15kxaZrJyyv3H1O1GW5PrwqlMbpR1RmXSFAvd6n-byyUhQcx8wSD8m4hhU88zk15u4ZGzGiEXV-ATAf41irrkrHnpnKpgwhMR-yEXON9Ykyu7Pcc0Dsd-PMMXNoNXw0-Czp_o8kk20uqlbDGaxCz8yE9s00HMRixmPGDJ6x2tp456yG_ZPbaykWbRwmtex478cRjNftvu1V00HdIZEuJHgsUvqY7_v_wVLeSfWSCQCF-EiQiDBBcPjxdDQtj9NPJDDm8yFV0wftdBwqIj-w6jeDLGFt8-sZihxjX6Q0IppaRKVYEtwWG_P-yfD_tnpGVROatM4QbovR_godcHRa__SH4EAAD__xzn2K0=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkd9q2zAUxq-rp_joTZ0RNYzAKAm9cF1l8-Yowda6hlKE4iiJVv8JsmycXPUh8oR5kpGlHdtgjF6ew-93zvk4lOJO28qUxQBBmT7ZUqXr2xvoVqfz2mQLbeF05dCcKEISJmB1aRfayu-lKSqZmdw4XONDfwhQioVeqjpzaFRW6wGuCKXQhZpnWu7MaqdWPz2sVQW31n_jZXHky40zudlpK-tKy7WpXLmyKq_eYuV15kxaZrJyyv3H1O1GW5PrwqlMbpR1RmXSFAvd6n-byyUhQcx8wSD8m4hhU88zk15u4ZGzGiEXV-ATAf41irrkrHnpnKpgwhMR-yEXON9Ykyu7Pcc0Dsd-PMMXNoNXw0-Czp_o8kk20uqlbDGaxCz8yE9s00HMRixmPGDJ6x2tp456yG_ZPbaykWbRwmtex478cRjNftvu1V00HdIZEuJHgsUvqY7_v_wVLeSfWSCQCF-EiQiDBBcPjxdDQtj9NPJDDm8yFV0wftdBwqIj-w6jeDLGFt8-sZihxjX6Q0IppaRKVYEtwWG_P-yfD_tnpGVROatM4QbovR_godcHRa__SH4EAAD__xzn2K0=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyMktFq2zAUhq-rp_jpTZ1Rt4zAKAm9cF1l8-Yowda6hlKE4siJVtsKsmycXPUh8oR5kpGmHRtsbJfn8H3nnB-O7-NO2VqbaoDQZE_WyGx1ewPVqWze6GKhLJyqHdojRUhKOawydqGs-G50VYtCl9rhGh_6Q8D3sVC5bAqHVhaNGuDqRVGVnBdKbPVyK5cvIq5h8vyPiqmI78OsnS71VlnR1EqsdO3M0sqyxkrWcCv1P1bZFE5nphC1k-4fpurWyupSVU4WYi2t07IQulqoTv3dzHNCwoQGnIIHNzHFupkXOrvYwCMnDSLGr8AmHOxrHJ-Tk_a1c6zCCUt5EkSM43RtdSnt5hTTJBoHyQxf6AxegyANe7-j-ZNohVW56DCaJDT6yI5s20NCRzShLKTp2x2dJw96xG7pPTaiFXrRwWvfxo6CcRTPftnuNedoe6Q3JCSIOU1eUx1-4OJntIh9piFHygMepTwKU5w9PJ4NCaH30ziIGLzJlJ-DsrseUhof2HcYJZMxNvj2iSYUDa7RHxLf931SZ7LChmC_2-13z_vdMzJT1c5KXbkBLt8P8HDZh4_L_iP5EQAA__-oX9kP

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx80t1u2jwcx_Hj-ip-6knDI1L0CGmqQBykqdmyhYASryuqKssEB7zmBdlOFDjqRXCFXMkEtNM2dTu09f3Y_kt2XdxLbVRVDuBX6bOuRLq-u4VsZbqoVb6UGlYai-ZcEZJQBi0rvZSaf69UaXiuCmUxwof-EHBdLGUm6tyiEXktB7g5EVmKRS75Tq12YnWCGKHKsndJVZ5MtbGqUDupeW0kXytjq5UWhfm3dN0_YFHnVqVVzo0V1mAtDOxavi9lu5FaFbK0Iucboa0SOVflUrby7zLLCPFj6jEK5t2GFJt6kav0eguHXNQIInaDaMoQfQ3DLrloXnfOK38aJSz2gojhcqNVIfT2ErM4mHjxHF_oHE4NL_E7v6fZM2-4lhlvMZ7GNPgYndumg5iOaUwjnyZv72gdceRBdEcfsOUNV8sWTvN27NibBOH8l9uduoumQzpDQryQ0fh1quM_uP45WhB9pj5DwjwWJCzwE1w9Pl0NCaEPs9ALIjjTGeuCRvcdJDQ8tv9hHE8n2OLbJxpT1BihPySu67rEpKLEluCw3x_2L4f9C9KqNFYLVdoBev8P8Njrw0Wv_0R-BAAA__9xBNlx

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0t1q2zAYxvHj6ioeelJnxA0jMEpCDlxX2bw5TrC1rqEUoThyotUfQZKNk6NeRK4wVzKStGNjg7FDif9P0gtyXdxLbVRVDuBX6bOuRLq-u4VsZbqoVb6UGlYai-ZcEZJQBi0rvZSaf69UaXiuCmUxwof-EHBdLGUm6tyiEXktB7g5EVmKRS75Tq12YnWCGKHKsr-SqjyZamNVoXZS89pIvlbGVistCvO_sqhzq9Iq58YK-w_tupDtRmpVyNKKnG-EtkrkXJVL2UqDtTCwa_mHzDJC_Jh6jIJ5tyHFpl7kKr3ewiEXNYKI3SCaMkRfw7BLLprXnfPKn0YJi70gYrjcaFUIvb3ELA4mXjzHFzqHU8NL_M7vafbMG65lxluMpzENPkbntukgpmMa08inyds7WkcceRDd0QdsecPVsoXTvB079iZBOP_ldqfuoumQzpAQL2Q0fp3q-Beuf44WRJ-pz5AwjwUJC_wEV49PV0NC6MMs9IIIznTGuqDRfQcJDY_tO4zj6QRbfPtEY4oaI_SHxHVdl5hUlNgSHPb7w_7lsH9BWpXGaqFKO0Dv_QCPvT5c9PpP5EcAAAD__3wL2dM=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUy0Hv0jAcxvF7X8VzVGPNH-afIcTDnDUhYQO3Qbg1ZfvBqt062o4QXr1BbibGeHuS5_vhHHtyXtt-gdTWP51Vdfv1C-hG9XHUpiGHQD7g-qwYK0UFR9Y15OQPq3svje50wGfMoiXAORo6qdEEXJUZaYE54xzUq6Mhedfnuzr_dmiVR2jpz9z2j94OQXf6Tk6OnmSrfbBnpzr_P6obTdC1NdIHFf4h6TaQ0x31QRk5KBe0MlL3Dd3o7_J0YiwtRFIJlOL7TuSpwDAeja4_eLogW-X7ZL0TmCBLDs_5aTqNonj6Es3mrx_j-HX-EmOVp4XIRF5hgrJKigqTJWPisF0nqxxvNtvqPUS-f4tSrEVa4R2-FZsMni5LxjnnzNNlpL4m7slQHR4P-xUAAP__XVibqw==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNtum0AQfc5-xYiX4ApibEtVhBWpxFm3tA6OgOaiKFoteB1vg8FaFopTVYr6DX7s1_lLKvAlJE3S5iF-sLQz55ydYc6srsMpEylPYhN6SXgjEhpOjg6BFSwMMh6NmADJUgn5CoWQh30QLBEjJsi3hMcpifiUSziA950ugK7DiI1pFknIaZQxE_aRrgOLaRAxcsuvb-l1xYMJTUFO2GN4Epf4ZCb5lN8yQbKUkQlPZXIt6DR9DWuaRZKHSURSSeU_mKyYMcGnLJY0IjMqJKcR4fGIFex55niMUM_Flo_Btw4HGGZZEPFwrwAV7VCwHX8fnKEPztfBQEM7wTqyOvWGjue7lu34oMwEn1IxV-DEtY8t9wK-4AtQKVher6GhHds5wudQkIDwUQFqsIn3rWN7cFGjq1SDoIEaXYSsgY_ddVnlAPe2tdnOZ9zzwfMt3_Z8u-fB7iUCAPhR_Zc_JUyibBqnigmX22CVoMr2fKXV8IJRyUaESsUEpW209nWjpRstMFqmYZiGodTAI55KHoeShEkWl4SWYdTS1bBJOTc5n7FSr06OsyjaEus0kXy_F2x3Wu1Olfup_XdvwZv0VpXydu2hq93u0y6cly7M_nJh_koXZhu31aDjG5ITwcakgP7QxfZHZ4XNG-DiPnax08PedhtUem_iOclXJs6fN3GmQf6yiedPmrj-JU5tfLYpIF_thQaVMFgeeHhQsu-j0HeHxw_3RHt049kn7GII4AA6XYTw-cnAsh1Qhye-Btg5bWxE36208i7SdV1HPI6Z0KsHTw1FkqYNBMvF7-Xibrm4gzSk8cN7XswWH9aPQIn6Vc5_uViswWESp1JQHksTmu1my4TLZgd0aHauUA025pFkIgVViow10J8AAAD__0H4vng=
