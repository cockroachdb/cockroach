# LogicTest: 5node

subtest scrub

# TODO(radu): rework or remove these tests (the inner ORDER BY is ignored by
# the optimizer).
#
# # Verify the index check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
#     FROM
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
#     FULL OUTER JOIN
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
#       ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
#     WHERE (leftside.k IS NULL) OR
#           (rightside.k IS NULL)
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLBlIJDs9CAq6dCFLGpdscio-uNY0a3AkM5Khy5J3L45hNw5x2vQ4I33zzc8bOG9pXRwogP4BEnKEhn1JIXjuUv2Hpf0Neo5QuaaNXTpHKD0T6DeIVawJNGyLnzVtqLDEszkgWIpFVZ_KNlwdCn41kUIEhKyNWhiFRqJJID8i-DZ-FA6x2BNoecR_lz97jsQzOfQaOUWjpmiS6ahG3aM5n1ENXYFK7-zdUyb_MWUyPiXCoYjli6jJaaFGremo9UPWOs-WmOzAlnfk375caf0b8Z6efOWIZ-mw_-1rQ1o87lYrke22XzfiKVuuAaGmX3FyNtzDF672L8MUIDxWdSTWYmKUWD6L9W61ehDZRkzM4j1-P4fE7iIJmhTNAs3n0Q0t7rnLhkLjXaDLTV2tPO_WQ3ZP_bqDb7mk7-zLk6YPsxN3SlgKsX-VfbB0_VPX4Dksb8LpAJaXsLoJJ7fNyR1mdQmnN-HFhTk_fvoTAAD__3P7gDg=
#
# # Verify the foreign key check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE parent (
#   id INT PRIMARY KEY,
#   id2 INT,
#   UNIQUE INDEX (id, id2)
# )
#
# statement ok
# CREATE TABLE child (
#   child_id INT PRIMARY KEY,
#   id INT,
#   id2 INT,
#   FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
# )
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT p.child_id, p.id, p.id2
#     FROM
#       (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
#     FULL OUTER JOIN
#       (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
#       ON p.id = c.id AND p.id2 = c.id2
#     WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
#           c.id IS NULL AND c.id2 IS NULL
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nID1bi9BAYZbAWL0-G8T0PEmXNtqEskidBS_O7DCGstvRvdY345__wO5-QRtJFYdL_QAf8BCTQUJmt6dM7YFW0FmbwHHlNQepr9ihsKvbEI_BG88iMCh7r7OWKFnUR7FQMFib5TY3i2v1WjbLvZm1Zpifft-a5VsrV4bqfOovYiVECzUDCzf3I43w0IPFno__WR7PvYZKtaSdbe4YPYyEUxuyh-8s3aWIkW5c7VrMl_lbzS_Ve0A94YpdFesX339cOEnFyf8pyUp_pLRW7KrAAKI559JNiRivR4-GjVcOsjkRypYMcDULhWo0fLSRRFgpHsOynKmhSnPD-QsiKRSHfsQD4Vn0kk3gf6nHz4Q4BCOXtOREIFoyK9OL70LXur0E1GO3w5xldfjtfZoRxw24Uzs-3xmzV90GzHMuQCkOj8dsu2Q6bDVfhYz8PJG8LsZZj9NZzuwvHSLO9-BwAA__9_viDb

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/66>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

query T
EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
distribution: full
vectorized: false
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lV1ro0oYx-_Ppxiem7YwoqPmzauGNuUITdKTEc4uSyjT-DSVGic7M9Ltlnz3xWSzrW6VRIgXoqP-nt_858U30N9TCGD05e52GE7I-XXII_7f7QW5mo2G0YjwaBiFPAqvONGMTCdEkJvZdExiYQT5P4z-JdO7KJxOOBlyMr0h_CuPRmMSheMRObNYrs-AQiZjnIgVagi-AQMKLlDwgIIPFDowp7BWcoFaS1W88rb9IIx_QOBQSLJ1bormOYWFVAjBG5jEpAgBROIhxRmKGJXtAIUYjUjSbZlC8LI43a-f8RUoXMk0X2U6IAIo8LUoLi2bEZHFhBFpnlDBfENB5ua9oDZiiRCwD4bhNQTOhh4uycVqnaKyO2XBXTNPfmJAmOM4hT83wgTkktWKuBWRTq3Ie_08kypGhXGp_nxTqzpcLhUuhZHKZs7h0uTcdRzykC-e0eiL2i54lS6wcpjs8BFnLUbcZpbtthpzdozmfsy7JxjzbknEPTwvt01ermV7rfJyj9Hc59U7QV69koh3eF5em7w8y_Zb5eUdo7nPq3-CvPolEf_wvPw2efmW3WmVl3-M5j6vwQnyGhzzM5ihXstMY2Uv_rySU6lksWLTxniJux1ey1wt8E7Jxfbd3e10C9o2xKjN7inb3YTZ_pE2CsXqz7_sI4k1ktwSiX0kdaokt9npGCmvEeXXk1iV5LftXrdK6jSSuvVObpXUbevUq5J6jaR-vZNXJfXbOvWrpEHzNHDqpfy_5mbzNG-wGhRL5zGVL_dJDAE4vw_rk9P-gOIDsdTF-uVP8mWLjV7Xxep7FKlGCmPxjNdoUK2SLNEmWUBgVI6bzT-_AgAA___I8qX8

statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsllFvm0gQx9_vU4zmpa2EA7tgx-GpOTfVWZXjyKCeTqeo2sDURcYst7sozUX-WPcF7pOdgPpiU3BNVEt9qB-Qd3eY-f-Z3672EfVfKfo4WVxdhlcQhJfhNAinkwA0g_k1CHi7mM8gFkbA79PwN5jfhNP5dQCXAczfQvBHEF7NIJzOruDFgBX6BVqYyZiuxZo0-n8iQws5WuiihR5aOMRbC3MlI9JaqjLksXphGn9G37EwyfLClNO3FkZSEfqPaBKTEvoYiruUFiRiUraDFsZkRJJWZUqBr8vHh3xFD2jhRKbFOtM-CLQwyEX5d2AzEFkMDKT5RAotfPceyuLah4zVQ0XLRJbBhrSpp0yyJh-cf__R9TiSmaHMJDL7aknJew0xRTKm2AfmOPX03YMhDYpE7MPYceDXenq5uJlAJNJU78TmIlHbWF5Nzt5PJqAN5RDJIjPwkj4bO8nMKx8c-ymAaNUVUMmShckLU1e63VhYj798am3EktBnO72ZvkHf2VjHtycQ6zwlZQ_3W1NPB8nfVNWuLAVGGB9es04hvCFk2CnkqX6RSRWToniv_u2mU-rlcqloKYxUNnOOFw0vuePAXRGtyOhXnRbchgW2_zHZ8ayzZ7Bus4HNu2nn35923kY7OxvBu6SFd97Gu3cK3nkP3lmfFm15H52A99GeEH48K_w5rPCB7Xaz4v5kpY0V3qdFW1bOT8DK-Z4Q93hW3Oew4g5sr5sV7ycrbay4fVq0ZWV8AlbGe0K841nxnsOKN7CH3awMvz8rbhsr_MxtZ8VtY2V0ClbcHqx4fVq0ZeXiBKxc9Ln8LUjnMtPUuHu1V3IalQasvKRRvKT6RqdloSK6UTKqYuvhvEpUTcSkTb3K6sE02y5po0is_7-77mZiBzPxvUxsN9OwmYkf1tRHlHswldediTUzeX3tiaormJG5l2pV7yRNWXW0lVfO7UK9l-qVp3N3u7omrcXyKaAkfVfnqKlzeFDnqNsxb2Ya_ZiOz5s6zw_qHHc7dpuZxj-m43FT58XhDeJ0W_a-2rWHD4Bent1Oz_zM-4bnYcPzRXlkfUzl_YckRh-dL79By2P7w_IFsdTluRl8kveV6PAhL0-9jyLVZOFMrOgNGVLrJEu0SSL0jSpos_nlvwAAAP__FkObzw==

query T retry
EXPLAIN (DISTSQL, TYPES) SELECT * FROM data
----
distribution: full
vectorized: true
·
• scan
  columns: (a int, b int, c float, d decimal)
  estimated row count: 1,000 (100% of the table; stats collected <hidden> ago)
  table: data@data_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklEFvmz4UwO__T2G903-TERjIDpw2NZmElKZZ4LBpiioXv6aogJlt1FUR330ydGtBSYWID5bs5_zeLw8_H0H_KiCC1fft-ku8If8v4yRNvq0pSX9sV8kHkqzWq6uUfCRfdzfXRHDDgUIlBW54iRqin8CAgg8UAqAQAoUF7CnUSmaotVT2yLH7QSx-Q-RRyKu6MXZ7TyGTCiE6gslNgRBByu8K3CEXqFwPKAg0PC-6NDb1Zzvd1o_4DBSuZNGUlY4Ip-SOkowSARSSmts9x2WEV4IwIs0DKti3FGRjXjNrww8IEXujGi8h8lp6xvZVsqmkEqhQDAXzygB9me8LyU0XzvKSF7BvT_zZjXRk7S4GlHOe_shzMfBk06vKLqmqyxzXn1VXNvD1p_v6F_n6jhvM8vUHvsF03-Ai38Bxw1m-wcA3nO4bXuQbOu5ilm94ts9O-O5Q17LSOKlTvFEmh9neQ3HAvou1bFSGWyWz7my_vOlA3YZAbfoo6xdx1YWYzaCQl_-eibck9i7p04DkvUvy5zqxMSmYS_LHpHAuKRiTFnNJof2K94V8us0FROC9DOfE9Hd07zA_aHuVkgf51GHT59peBKMapHDNH3GJBlWZV7k2edYH2va_PwEAAP__DBRFDg==

# Check that we properly render virtual computed columns when collecting stats.
statement ok
ALTER TABLE data ADD COLUMN e INT AS (b + 1) VIRTUAL

statement ok
CREATE INDEX ON data (e)

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV-9um0gQ_35PsZovbXXrwC7YcfiUnJvqrCp_ZFBPp1NUbWDqomCW212U5iI_1r3APdkJqGsg4Bq5lRqp_oDYmWF2fjO__Vn7CPrvBDyYLc7PgnPiB2fB3A_mM59oRt4sri5IJIwgf8yD38nVdTC_uvTJmU-u3hD_Tz84vyDB_OKcvBixXL8ACqmM8FKsUIP3FzCgwIGCAxRcoDCGGwqZkiFqLVUR8lh-MI8-gWdTiNMsN4X5hkIoFYL3CCY2CYIHgbhNcIEiQmXZQCFCI-Kk3KYo8LR4vM_u8AEozGSSr1LtEUHJLSUhJRFQ8DNR2EYWIyKNCCPSfEQFFBaYRqg8csooOeWUnDqUnLrF-6_M87z5ZTAFCm_fkaJW7ZGUVUuFy1gWKQ1qU5lMvEKP2P_9q6t1KFODqYll-sSl5L0mEYYywsgjzLYr8-2DQU0UisgjU9smv1Xm5eJ6RkKRJLoWm4lYbWJ5abx4N5sRbTAjocxTQ17iJ2PFqXnlEdvaBiDe9QWUZcncZLmpdrpZU6jWnyejjVgieKw2yvlr8Ow13X-avlhlCSpr3JxkZfbjf7Dcu4TkG2GK2Wxfec1K6yun6aB1g_vER-u2cS9O3sI57sW5hZenUkWoMGrAu1n3duJsuVS4FEYqi9n794S85LZNbvPwDo1-VetQn6PVr11hze59JbLZy1ZwX2edVmdZk0Jsf0FghwiCxUYWP1QS-LeXBN4lCexoQt7GHaLAu0TB_R6iwAeIAhsy0Y0oTJ6fKEwaOPn-zOUHMZePLOdQ5jo_mdvFXD5kohvmHj8_5h43cDr7M9c5iLnOyHIPZa77k7ldzHWGTHTD3OnzY-60gdPdn7nuQcx1R9b4UOaOvz1znS7m8iOnm7lOF3Mn34O5zgDmukMmumHuyfNj7smQq9ICdSZTja2rRPdOdmunESvuHBgtsbqgaJmrEK-VDMvYanlVJioNEWpTeVm1mKcblzYKxerLTa-eie3MxBuZWD3TuJ2J765pSFHOzlRufybWzuQOhSfKqUCK5l6qu-qgakxLHS-UYOOojmrl2f7JbLwr1FostwG2Czf1OiftOsc765z0I-btTJMfE_Fxu87jnXVO-xE77UzTHxPxtF3nye4DYvdDdp-c2t0CMAiz04uZH7lfwTxuYT4pJOtDIu_fxxF4YH_-jToemx8UH4ilLnTT_yjvy6KDh6xQvQ8i0UjhQtzhazSoVnEaaxOH4BmV43r9y_8BAAD__-Uvbv4=

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON c, e, a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl9Fu2zYXx--_pzg4N_2G0ZUoyY7DK2duihmF48ASOgyDUTDSqStEFjWSRpoFfqy9wJ5skBS3tiobthEPvaguBPCQOvwfnd9foJ7Q_JmhwOH0-iq6hjC6ikZhNBqGYDhMbiBmQAwkvJ1OxpBIK-G3UfQrTG6j0eQmhKsQJm8h_D2MrscQjcbX8KrDl-YVMsxVQjdyQQbFH8iRoYcMfWQYIMMuzhgWWsVkjNLlkqfqgVHyGYXLMM2LpS3DM4ax0oTiCW1qM0KBkbzLaEoyIe24yDAhK9Os2qYUOChvH4p7ekSGQ5UtF7kRIFlZyh0yDAtZBjoOB5knwEHZT6SR4ZTyhLSAAWcw8BgM_J-5EGJ0E_WR4bv3UAo0AnJeDzXNU1WmsmRsHbLpggS4__xt6nGscku5TVX-zZRWDwYSilVCiQDuunX47tGSAU0yEdB3XfilDs-nt0OIZZaZjbWFTPV6rVcFx--HQzCWCojVMrfwf_psnTS3Pwlwna8LiO53LahkqaUtlrbeabZiWI-f22GsnBMKvtG_0RsU7ood3sJQLoqMtNPdbl8dDtO_yjdVtspKW_Vj4LGBv1OK15DS3Snlq4JlrnRCmpItBbPVTrFX87mmubRKO9x9Edl-QzbffoX8cBfwk13g8I7jneoD7-V94LX5gL_uwbu0xQlemxOCczjBO8IJ_Jg2rp3QO4sTeltSvMOJ8k4nyus4_qlE-T-IaiPKO6aNa6IuzkLUxZYU_3Ci_NOJ8jtOcCpRwQ-i2ojyj2njmqj-WYjqb0kJDicqOJ2ooON0TyWq-_JE-W1Eea_9dqL8NqJ65yDKP4Ko4Jg2rom6PAtRl8ccRadkCpUbapwD23dyGzt1eHlgpGRO9enSqKWO6VaruFpbDydVoiqQkLH1LK8Ho3w9Zawmufhykt7MxPdm8rYy8c1M3WYmb7-mY0T5e1MFuzPxZqbg2PJk1RXMyT4ofV97yVBe_rCU_53P4dpLdbxf_UetZxZkjJx_mXRxtqmv19TX3auvt7tSr5mp931VetHUd7FXX393pX4zU__7qrTf1He53wju7lKDb9y53-j_ea2X5SfpY6YePqQJCnSfr07LbX1h-YCcm_K7GH5SD5XY6LEov2ofZWaI4Vje0xuypBdpnhqbxiisXtJq9b9_AwAA__8Gm7_Y

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON e FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsVtFu2zYUfd9XEPelLSZHIiU7Dp-auSlmFI4DS-gwDEHBSLeqYFnUSAppFviz9gP7skFStdiq5FlBDfShehDMy6t7z_E9h-Aj6D9T4DBbXV0GV8QPLoO5H8xnPtGULK8Jkrer5YJEwgjy2zz4lSxvgvny2ieXPlm-Jf7vfnC1IMF8cUVejGihX4AFmYzwWmxQA_8DKFjAwAIXLPDAgjHcWpArGaLWUpUpj9UH8-gzcMeCJMsLU4ZvLQilQuCPYBKTInAIxF2KKxQRKtsBCyI0IkmrNiXA1-XrQ77GB7BgJtNik2lO7sACPxflz5FNicgiQok0n1CBBSvMIlScvKY_U875_DqYggXv3pMSkuYko_VSYZzIsoRBbeqQSTbIifPP37pehzIzmJlEZl9tKXmvSYShjDDihDpOHb57MKiJQhFxMnUc8ksdjlc3MxKKNNU7ublIVJPLquDi_WxGtMGchLLIDHmJn42dZOYVJ479lIC47kuoYMnC5IWpO91uLajXXwagjYgRON2Z2PwNcGdrHT80X2zyFJU93h9YHfaTv7DqXVHyjTDlLHqBsBaQcS-Qp_5FJlWECqO9_rfbXqiXcawwFkYqmzrHgyYvmeOQuyJco9Gveim4LQp0_8-kxzuAPsMBNh3ZbKgH2Lf3AOvyAD2bkHdJhwtYlwu8U7iADXABHTK4xgWTE7hgsgeEHa8g9hwFsZHtDlWQ-0NBXQpiQwbXKOj8BAo63wPiHq8g9zkKcke2N1RB3g8FdSnIHTK4RkHTEyhougfEO15B3nMU5I3s8VAFjb-9gtwuBbEzt1tBbpeCJqdQkDtAQd6QwTUKujiBgi6GXCpXqHOZaWzd6bo7Oa1OI1pe_jCKsb4palmoEG-UDKvcermsClWBCLWpd2m9mGfNljYKxea_O_FuJXqwEturRHcrjduV2GFMQ0C5B0t5_ZVou5I3lJ6opgIZmnup1rWTNGbVgVdeZZuN2kv1ztNp3OxuUGsRPyWUSt_FOWnjHB_EOelnzNqVJt8n4_M2zvODOKf9jN12pen3yXjaxnlx2CBOP2XvK9cePgAGcXZ7ObMz7384j1ucL8oj62Mq7z8kEXBwvjyjjlfzQPmBiHV5bvqf5H0FOnjIy1Pvo0g1WrAQa3yDBtUmyRJtkhC4UQVutz_9GwAA__-G9LjA

statement ok
ALTER TABLE data ADD COLUMN f FLOAT AS (atan2d(c, d::float)) VIRTUAL

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON f, e, d FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl1Fv2zYQx9_3KQ730hajK1GSHYdPztwEM7rEgSV0GIagYKSLK0QWNZJGmgX-WPsC-2SDpLi1VdmwA3voQ_UggEfq-D_d7y9QT2j-ylDgcHJ-Fp1DGJ1FozAaDUMwHMZXcMeAGCRwMRlfQiKthN9H0a8wvo5G46sQzkIYX0D4RxidX0I0ujyHVx0-N6-QYa4SupIzMij-RI4MPWToI8MAGXbxhmGhVUzGKF0ueaoeGCWfUbgM07yY2zJ8wzBWmlA8oU1tRigwkrcZTUgmpB0XGSZkZZpV25QCB-XtY3FPj8hwqLL5LDcCEga3DGJkGBayDHQcDjJPgIOyn0gjwwnlCWkBA85g4P3MhRCjq6jPQFqZe8nrgc8GXIiL38ZnUf8NMnz_AUrNRkDO66GmaarK7JaMrUM2nZEA999_TD2OVW4pt6nKv5nS6sFAQrFKKBHAXbcO3z5aMqBJJgL6rgu_1OHp5HoIscwys7K2kKlervWq4OWH4RCMpQJiNc8tvKbP1klz-0aA63xdQHS_aUElS81tMbf1TjcLhvX4uUPGyimh4CstHb1D4S7Y7l0N5azISDvd9Y7W4TD9u3xTZfestFWLBh4b-BuleA0p3Y1SviqY50onpClZU3Cz2Cj2bDrVNJVWaYe7B5HtN2Tz9VfIdzcGf7ExHN5xvANawzu8Nbw2a_C3PXiftpjDazNHcAxzeHuYg-_T2aU5ekcxR29Nirc7ZN7LIfM6jn9AyPwfkLVB5u3T2SVkJ0eB7GRNir87ZP7LIfM7TnBAyIIfkLVB5u_T2SVk_aNA1l-TEuwOWfByyIKO0z0gZN3DQ-a3Qea99dsh89sg6x0DMn8PyIJ9OruE7PQokJ3uc6ydkClUbqhxpmzfyW3s1OHl4ZOSKdUnVaPmOqZrreJqbT0cV4mqQELG1rO8Hozy5ZSxmuTsy6l8NRPfmslby8RXM3WbmbztmvYR5W9NFWzOxJuZgn3Lk1VXMCf7oPR97SVDefnzU_7WPodrL9XxfvVPtpyZkTFy-mXSxZtVfb2mvu5Wfb3NlXrNTL3vq9KTpr6Trfr6myv1m5n631el_aa-0-1GcDeXGnzjzu1G_99rPS0_SXeZeviYJijQfb46LbflheUDcmrK72L4ST1UYqPHovyq3cnMEMNLeU_vyJKepXlqbBqjsHpOi8VP_wUAAP__PiDaXw==

statement ok
CREATE TYPE gh AS (g INT, h INT)

# Try a virtual computed column whose expression cannot be distributed.
statement ok
ALTER TABLE data ADD COLUMN g gh[] AS (array_cat(ARRAY[(1, 2)], ARRAY[(a, b)])) VIRTUAL

# Error if we specify the problematic virtual computed column directly.
statement error cannot be executed with distsql
CREATE STATISTICS s1 ON g FROM data

# We should skip the problematic virtual computed column when using defaults.
query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV-Fu2zYQ_r-nIO5PE4yOREp2HP5y5iaY0SUOLKHDMAQFI11dIbbokTTSLPBj7QX2ZIOkerYUybWQGmiA-ocg3p2O9919_Aw-gflrBgKGk4vz8IIE4Xk4CsLRMCCGkcvJ-IrE0kry-yj8lYxvwtH4OiDnARlfkuCPILy4IuHo6oK86bCleQMUUhXjtZyjAfEnMKDAgYIHFHyg0IVbCgutIjRG6SzkKf9gFH8G4VJI0sXSZuZbCpHSCOIJbGJnCAJCeTfDCcoYteMChRitTGb5NlmBg-zxYXGPj0BhqGbLeWoEkZTcURJREgOFYCEzW8dhRKYxYUTZT6iBwgTTGLUgA0bJgFMy8CgZ-Nn7z0wIMboO-5RIK1MeHw08OvCFuPxtfB72j4HCu_ckg2AESVmx1DhNVLaTRWMLk03mKIj77z-mWEcqtZjaRKXPXFo9GBJjpGKMBWGuW5jvHi0aolHGgvRdl_xSmKeTmyGJ5GxmtmIXMtHrWJ4br94Ph8RYXJBILVNLjvCzdZLUHgviOpsAxPumgLwstbSLpS12ul1RKNZfBmasnCIItjXh0VsQ7oruP-RAzhcz1E63PODCHCR_Y753Dimw0mYj27zyLSvdXnllB902-M98dNvW3bz2GiHzCuRuI-QN0mWqdIwa4xLS21VjU86nU41TaZV2mLt_e8gRd11yt4zu0ZrjrWY1OSqt2xVWbuRXIsttbQrukSO-MTc13Ks0nJVJxvZXEvYSJXFYx-EH0hL-7bWE12kJO-mRd0mNmvA6NfEPoSa8hZqwNoNeq0nvVatJrwSZ789t_iJu847jHYjb3g9u13Gbtxn0mtunr5rbpyXI3v7c9l7Eba_j-Afitv-D23Xc9toMes3t_qvmdr8E2d-f2_6LuO13nO6BuN399tz26rjNT7x6bnt13O4dgtteC277bQa95vbZq-b2WZtL3QTNQqUGKzed-p3cyk4dll2JMJ5icX8yaqkjvNEqymOL5ThPlBtiNLbwsmIxStcuYzXK-f930u1MbGcmXsrEtjN1q5n47praFOXtTOU3Z2LVTH5beDKfCqRoH5S-L86swTQX_Yy5a0dxagvP5h9p7Z2jMXK6CXB9uN2us1ets7uzzl4zYl7N1Ps-EZ9W6zzdWWe_GbFXzdT_PhH3q3We7T4gbjNk_9mp3S0ArTB7jZj5if8VzN0K5rNMsj7O1MOHJAYB7pdfp-ax_kH2gZyaTDeDT-ohLzp8XGSq91HODFK4kvf4Fi3qeZImxiYRCKuXuFr99F8AAAD__6Vroho=

# Check that we also collect stats on the hidden expression index virt column.
statement ok
CREATE INDEX ON data ((a * b))

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWN1u4zYTvf-egpibTb7SkUjJP-GVU2-CGtvEgSVsURTBgpFmvUJs0SVpZNMgj9UX6JMVkta1pUheC1kDi2B9IZAzo-EczuER6Ecwf85BwGh6fhaekyA8C8dBOB4FxDByMZ1cklhaSX4bh7-QyXU4nlwF5CwgkwsS_B6E55ckHF-ekzcdtjJvgEKqYrySCzQg_gAGFDhQ8ICCDxS6cENhqVWExiidhTzmL4zjzyBcCkm6XNnMfEMhUhpBPIJN7BxBQChv5zhFGaN2XKAQo5XJPF8mK3CYPT4s7_ABKIzUfLVIjSCSkltKIkpioBAsZWbrOIzINCaMKPsJNVCYYhqjFmTIKBlySoYeJUM_G__EhBDjq3BAyZD9P_NJK1MeHw09OvSFuPh1chYOjoHCu_ckQ2IESVkx1ThLVLagRWMLk00WKIj7z9-mmEcqtZjaRKXPXFrdGxJjpGKMBWGuW5hvHywaolHGggxcl_xcmGfT6xGJ5HxutmKXMtHrWJ4bL9-PRsRYXJJIrVJLjvCzdZLUHgviOpsAxLumgLwstbLLlS1WunmiUMy_9M1YOUMQbKvR47cg3Ce6f68DuVjOUTvdcp8Lc5D8hfnaOaTASpt1bjPkW1a6PfPKDrpt8J_56Latuxn2NsN-I3peQd9tRL8BvUqVjlFjXAJ989S4P2ezmcaZtEo7zN1_p8gRd11yu4ru0JrjrX1rclR2cVdYeU-_Elne4abgXpOjT474xtzUCa_SCVYmIttfdNhLRMdhHYcfVnb4t5cdXic77KRH3iU1wsPrhMc_hPDwFsLD2vR7LTy91yI8vRJ6vj_b-YvYzjuOd1i2ez_YXsd23qbfa7b3Xwvb-yX03v5s917Edq_j-Idlu_-D7XVs99r0e832wWth-6CE3t-f7f6L2O53nO5h2d799mz36tjOT7x6tnt1bO8dgu1eC7b7bfq9Zvvpa2H7aZsL5BTNUqUGK1ep-pXcykodlt25MJ5hcUEzaqUjvNYqymOL6SRPlBtiNLbwsmIyTtcuYzXKxX_33-1MbGcmXsrEtjN1q5n47praFOXtTOU3Z2LVTH5beDLvCqRo75W-K46vwTT7IuS327WjOMCFZ_O5WnsXaIycbQLc_C-nTZ29ap3dnXX2mhHzaqbe94m4X62zv7POQTNir5pp8H0iHlTrPN19QNxmyP6zU7tbAFph9hox8xP_K5i7FcynmWR9nKv7D0kMAtwvv07NY_2D7AU5M5luBp_UfV50-LDMVO-jnBukcCnv8C1a1IskTYxNIhBWr_Dp6X__BgAA__9uA739

# Check that we also collect stats on other hidden columns.
statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWN1u4zYTvf-egpibTb7SkUjJP-GVU2-CGtvEgSVsURTBgpFmvUJs0SVpZNMgj9UX6JMVkta1pUheC1kDi2B9IZAzo-EczuER6Ecwf85BwGh6fhaekyA8C8dBOB4FxDByMZ1cklhaSX4bh7-QyXU4nlwF5CwgkwsS_B6E55ckHF-ekzcdtjJvgEKqYrySCzQg_gAGFDhQ8ICCDxS6cENhqVWExiidhTzmL4zjzyBcCkm6XNnMfEMhUhpBPIJN7BxBQChv5zhFGaN2XKAQo5XJPF8mK3CYPT4s7_ABKIzUfLVIjSCSkltKIkpioBAsZWbrOIzINCaMKPsJNVCYYhqjFmTIKBlySoYeJUM_G__EhBDjq3BAyZD9P_NJK1MeHw09OvSFuPh1chYOjoHCu_ckQ2IESVkx1ThLVLagRWMLk00WKIj7z9-mmEcqtZjaRKXPXFrdGxJjpGKMBWGuW5hvHywaolHGggxcl_xcmGfT6xGJ5HxutmKXMtHrWJ4bL9-PRsRYXJJIrVJLjvCzdZLUHgviOpsAxLumgLwstbLLlS1WunmiUMy_9M1YOUMQbKvR47cg3Ce6f68DuVjOUTvdcp8Lc5D8hfnaOaTASpt1bjPkW1a6PfPKDrpt8J_56Latuxn2NsN-I3peQd9tRL8BvUqVjlFjXAJ989S4P2ezmcaZtEo7zN1_p8gRd11yu4ru0JrjrX1rclR2cVdYeU-_Elne4abgXpOjT474xtzUCa_SCVYmIttfdNhLRMdhHYcfVnb4t5cdXic77KRH3iU1wsPrhMc_hPDwFsLD2vR7LTy91yI8vRJ6vj_b-YvYzjuOd1i2ez_YXsd23qbfa7b3Xwvb-yX03v5s917Edq_j-Idlu_-D7XVs99r0e832wWth-6CE3t-f7f6L2O53nO5h2d799mz36tjOT7x6tnt1bO8dgu1eC7b7bfq9Zvvpa2H7aZsL5BTNUqUGK1ep-pXcykodlt25MJ5hcUEzaqUjvNYqymOL6SRPlBtiNLbwsmIyTtcuYzXKxX_33-1MbGcmXsrEtjN1q5n47praFOXtTOU3Z2LVTH5beDLvCqRo75W-K46vwTT7IuS327WjOMCFZ_O5WnsXaIycbQLc_C-nTZ29ap3dnXX2mhHzaqbe94m4X62zv7POQTNir5pp8H0iHlTrPN19QNxmyP6zU7tbAFph9hox8xP_K5i7FcynmWR9nKv7D0kMAtwvv07NY_2D7AU5M5luBp_UfV50-LDMVO-jnBukcCnv8C1a1IskTYxNIhBWr_Dp6X__BgAA__9uA739

# Check that we can disable stats collection on virtual computed columns.
statement ok
SET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled = false

statement error cannot create statistics on virtual column
CREATE STATISTICS s1 ON e FROM data

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV-Fum0gQ_n9PsZo_baV1YBfsOPxKzk11VuU6Mqin08mqNjB1kTHL7S5Kc5Ef617gnuwE1GebADVKKzVS_QN5Z4bZ-Wa-b4EH0H8l4MFkcX0VXBM_uAqmfjCd-EQz8mYxn5FIGEF-nwa_kflNMJ2_88mVT-ZviP-HH1zPSDCdXZMXA5brF0AhlRG-ExvU4P0JDChwoOAABRcoDGFJIVMyRK2lKkIeyhum0WfwbApxmuWmMC8phFIheA9gYpMgeBCI2wQXKCJUlg0UIjQiTsptigIvi8uHbI33QGEik3yTao8ISm4pCSmJgIKficI2sBgRaUQYkeYTKqDw9j0pqtAeSVm1VLiKZRFsUJvKZOINesT-9x9drUOZGkxNLNNHLiXvNIkwlBFGHmG2XZlv7w1qolBEHhnbNvm1Mq8WNxMSiiTRB7GZiNUulpfG2fvJhGiDGQllnhryEj8bK07NK4_Y1j4Acd0WUJYlc5PlptppuaVQrb_0XBuxQvDYwZCmr8Gzt_T0OflikyWorOHxjCqzH_-N5d4lJN8I45FLtv_LD6z0cOUcO-ihwX3ko5duKzheAzdsBbfHlKdSRagwOsK03LbCv1qtFK6Ekcpi9umNIC-5bZPbPFyj0a8O2tLmqDWpK-y4ZV-J7GqgU2sgO6YHO13G7CkyttjA4u1C5t9eyLxJyOxsRN7GDVLmTVJ2v4eUeQ8psz6z2kl59EykPDoCx08nIn8SEfnActqJ6PwkYhMReZ9Z7Yh4_kyIeH4EzjmdiM6TiOgMLLediO5PIjYR0ekzqx0Rx8-EiOMjcO7pRHSfRER3YA3biTj89kR0mojIz5xmIjpNRBx9DyI6PYjo9pnVjogXz4SIF30-IRaoM5lqrL1tN-9k13YasOK1HKMVVu_wWuYqxBslwzK2Ws7LRKUhQm0qL6sW03Tn0kah2Pz_BXSYiXVm4keZ2GGmYT0T766pT1FOZyq3PROrZ3L7whPlVCBFcyfVulKnxrQ8i4un9s5R6bPy7B8UO-8GtRarfYDtwPKwzlG9zmFnnaN2xLyeafRjIj6v13neWee4HbFTzzT-MRGP63VedAvEbofsPlJt9wHQC7PTipmfuV_BPKxhviiOrI-JvPsQR-CB_eU3aLjsflDcIFa6ODf9T_KuLDq4z4pT76NINFKYiTW-RoNqE6exNnEInlE5bre__BcAAP__RO4t8Q==

statement ok
RESET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled

subtest regression_98373

statement ok
CREATE TABLE IF NOT EXISTS t98373 AS
        SELECT
                g::INT2 AS _int2,
                g::INT4 AS _int4,
                g::INT8 AS _int8,
                g::FLOAT8 AS _float8,
                '2001-01-01'::DATE + g AS _date,
                '2001-01-01'::TIMESTAMP + g * '1 day'::INTERVAL AS _timestamp
        FROM
                generate_series(1, 5) AS g;

statement OK
SET vectorize = off

statement OK
SET distsql = always

# These query plans should be disallowed from executing in a distributed
# fashion, even with distsql = always. Check different flavors of EXPLAIN.

query T
EXPLAIN SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN

query T
EXPLAIN(DISTSQL) SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF9r2zAUxd_3KcR5akFh9sq2TE8tSTYMaZLZfhgUEzTr1hOVJU-S6Urwdx-20_1jg90HiftH5_6OTghfDQQ2nw7bm2zHLtZZURYft5es2Gw3q5J5ajrv6oujtvGVENmuXF4KkW8-HPL9it0UrHZm-eY1e5_vb1l8t7x6e3V9l1TgsE7RTrYUIO6QouIYhSgE58fSaRrI1DeIhEPbro9jueKonSeIE6KOhiBQys-GcpKK_MsEHIqi1GaSPS-cr2P3QE_gWDnTtzYINjGDo-jkmC7AkZNV5MUPW9fp2ROqgcP18SdGiLIhiPQX7mwNkQz8_9FzCp2zgX6j_tem5I9Ni3SoOEg1NP9XcL2v6eBdPc3O6X4SmgqKQpy76Zxk9rkVoifZzvgVx71xj0etIJCcY_GX4zkwPpBNGI0VX9zjJFs-dSPWvTSBOG7lA60pkm-11SHqGiL6nobhxfcAAAD__wgUvrk=

statement OK
RESET vectorize

statement OK
RESET distsql
