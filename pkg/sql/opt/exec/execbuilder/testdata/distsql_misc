# LogicTest: 5node

subtest scrub

# TODO(radu): rework or remove these tests (the inner ORDER BY is ignored by
# the optimizer).
#
# # Verify the index check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
#     FROM
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
#     FULL OUTER JOIN
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
#       ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
#     WHERE (leftside.k IS NULL) OR
#           (rightside.k IS NULL)
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLBlIJDs9CAq6dCFLGpdscio-uNY0a3AkM5Khy5J3L45hNw5x2vQ4I33zzc8bOG9pXRwogP4BEnKEhn1JIXjuUv2Hpf0Neo5QuaaNXTpHKD0T6DeIVawJNGyLnzVtqLDEszkgWIpFVZ_KNlwdCn41kUIEhKyNWhiFRqJJID8i-DZ-FA6x2BNoecR_lz97jsQzOfQaOUWjpmiS6ahG3aM5n1ENXYFK7-zdUyb_MWUyPiXCoYjli6jJaaFGremo9UPWOs-WmOzAlnfk375caf0b8Z6efOWIZ-mw_-1rQ1o87lYrke22XzfiKVuuAaGmX3FyNtzDF672L8MUIDxWdSTWYmKUWD6L9W61ehDZRkzM4j1-P4fE7iIJmhTNAs3n0Q0t7rnLhkLjXaDLTV2tPO_WQ3ZP_bqDb7mk7-zLk6YPsxN3SlgKsX-VfbB0_VPX4Dksb8LpAJaXsLoJJ7fNyR1mdQmnN-HFhTk_fvoTAAD__3P7gDg=
#
# # Verify the foreign key check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE parent (
#   id INT PRIMARY KEY,
#   id2 INT,
#   UNIQUE INDEX (id, id2)
# )
#
# statement ok
# CREATE TABLE child (
#   child_id INT PRIMARY KEY,
#   id INT,
#   id2 INT,
#   FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
# )
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT p.child_id, p.id, p.id2
#     FROM
#       (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
#     FULL OUTER JOIN
#       (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
#       ON p.id = c.id AND p.id2 = c.id2
#     WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
#           c.id IS NULL AND c.id2 IS NULL
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nID1bi9BAYZbAWL0-G8T0PEmXNtqEskidBS_O7DCGstvRvdY345__wO5-QRtJFYdL_QAf8BCTQUJmt6dM7YFW0FmbwHHlNQepr9ihsKvbEI_BG88iMCh7r7OWKFnUR7FQMFib5TY3i2v1WjbLvZm1Zpifft-a5VsrV4bqfOovYiVECzUDCzf3I43w0IPFno__WR7PvYZKtaSdbe4YPYyEUxuyh-8s3aWIkW5c7VrMl_lbzS_Ve0A94YpdFesX339cOEnFyf8pyUp_pLRW7KrAAKI559JNiRivR4-GjVcOsjkRypYMcDULhWo0fLSRRFgpHsOynKmhSnPD-QsiKRSHfsQD4Vn0kk3gf6nHz4Q4BCOXtOREIFoyK9OL70LXur0E1GO3w5xldfjtfZoRxw24Uzs-3xmzV90GzHMuQCkOj8dsu2Q6bDVfhYz8PJG8LsZZj9NZzuwvHSLO9-BwAA__9_viDb

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/66>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

query T
EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
distribution: full
vectorized: false
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lV1ro0oYx-_Ppxiem7YwoqPmzauGNuUITdKTEc4uSyjT-DSVGic7M9Ltlnz3xWSzrW6VRIgXoqP-nt_858U30N9TCGD05e52GE7I-XXII_7f7QW5mo2G0YjwaBiFPAqvONGMTCdEkJvZdExiYQT5P4z-JdO7KJxOOBlyMr0h_CuPRmMSheMRObNYrs-AQiZjnIgVagi-AQMKLlDwgIIPFDowp7BWcoFaS1W88rb9IIx_QOBQSLJ1bormOYWFVAjBG5jEpAgBROIhxRmKGJXtAIUYjUjSbZlC8LI43a-f8RUoXMk0X2U6IAIo8LUoLi2bEZHFhBFpnlDBfENB5ua9oDZiiRCwD4bhNQTOhh4uycVqnaKyO2XBXTNPfmJAmOM4hT83wgTkktWKuBWRTq3Ie_08kypGhXGp_nxTqzpcLhUuhZHKZs7h0uTcdRzykC-e0eiL2i54lS6wcpjs8BFnLUbcZpbtthpzdozmfsy7JxjzbknEPTwvt01ermV7rfJyj9Hc59U7QV69koh3eF5em7w8y_Zb5eUdo7nPq3-CvPolEf_wvPw2efmW3WmVl3-M5j6vwQnyGhzzM5ihXstMY2Uv_rySU6lksWLTxniJux1ey1wt8E7Jxfbd3e10C9o2xKjN7inb3YTZ_pE2CsXqz7_sI4k1ktwSiX0kdaokt9npGCmvEeXXk1iV5LftXrdK6jSSuvVObpXUbevUq5J6jaR-vZNXJfXbOvWrpEHzNHDqpfy_5mbzNG-wGhRL5zGVL_dJDAE4vw_rk9P-gOIDsdTF-uVP8mWLjV7Xxep7FKlGCmPxjNdoUK2SLNEmWUBgVI6bzT-_AgAA___I8qX8

statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsllFvm0gQx9_vU4zmpa2EAwvYcfapOTfVWZXjyKCeTqeo2sDURcYst7sozUX-WPcF7pOdgHKxqXFNKkt9qB-Qd3eY-f-Z3672EfVfKXKcLK4uwysIwstwGoTTSQCawfwaBLxdzGcQCyPg92n4G8xvwun8OoDLAOZvIfgjCK9mEE5nV_BiwAr9Ai3MZEzXYk0a-Z_I0EIXLfTQQh8tHOKthbmSEWktVRnyWL0wjT8jdyxMsrww5fSthZFUhPwRTWJSQo6huEtpQSImZTtoYUxGJGlVphT4unx8yFf0gBZOZFqsM81BoIVBLsq_A5uByGJgIM0nUmjhu_dQFtccMlYPTbImDs6__-h6HMnMUGYSmX21pOS9hpgiGVPMgTlOPX33YEiDIhFzGDsO_FpPLxc3E4hEmuqt2Fwkqol1q8nZ-8kEtKEcIllkBl7SZ2MnmXnFwbGfAohWXQGVLFmYvDB1pduNhfX4y3fVRiwJOdtqxPQNcmdjHd-LQKzzlJQ93O1DPR0kf1NVu7IUGGE4vGadQtyWkGGnkKf6RSZVTIrinfq3m06pl8uloqUwUtnMOV40vHQdB-6KaEVGv-q04LUssN2PyY4Hmz0DbJsNbLcbbfc70Xb3oc3ORvAu2QO3uw9u_xRwuz3gZn360cA9OgHcox0h7vFguM8Bwx3YXjcY3k8wuNunHw0Y5ycA43xHiHc8GN5zwPAGtt8Nhv8TDO716UcDxvgEYIx3hPjHg-E_Bwx_YA-7wRh-JxjePjDcM28_GN4-MEanAMPrAYbfpx8NGBcnAOOiz4VtQTqXmabWfWl_JadVacDKixXFS6pvYVoWKqIbJaMqth7Oq0TVREza1KusHkyzZkkbRWL9_31zOxM7mMndycS2Mw3bmdzDmvqI8g6m8rszsXYmv689UXUFMzL3Uq3qnaQpq86x8prYLNR7qV55OmSb1TVpLZZPASXp2zpHbZ3DgzpH3Y7ddqbRj-n4vK3z_KDOcbdjr51p_GM6Hrd1XhzeIE63Zf-rXXv4AOjl2ev07J753_A8bHm-KI-sj6m8_5DEyNH58hvseTQ_LF8QS12em8EneV-JDh_y8tT7KFJNFs7Eit6QIbVOskSbJEJuVEGbzS__BQAA__9hInyF

query T retry
EXPLAIN (DISTSQL, TYPES) SELECT * FROM data
----
distribution: full
vectorized: true
·
• scan
  columns: (a int, b int, c float, d decimal)
  estimated row count: 1,000 (100% of the table; stats collected <hidden> ago)
  table: data@data_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklEFvmz4UwO__T2G903-TERjIDpw2NZmElKZZ4LBpiioXv6aogJlt1FUR330ydGtBSYWID5bs5_zeLw8_H0H_KiCC1fft-ku8If8v4yRNvq0pSX9sV8kHkqzWq6uUfCRfdzfXRHDDgUIlBW54iRqin8CAgg8UAqAQAoUF7CnUSmaotVT2yLH7QSx-Q-RRyKu6MXZ7TyGTCiE6gslNgRBByu8K3CEXqFwPKAg0PC-6NDb1Zzvd1o_4DBSuZNGUlY4Ip-SOkowSARSSmts9x2WEV4IwIs0DKti3FGRjXjNrww8IEXujGi8h8lp6xvZVsqmkEqhQDAXzygB9me8LyU0XzvKSF7BvT_zZjXRk7S4GlHOe_shzMfBk06vKLqmqyxzXn1VXNvD1p_v6F_n6jhvM8vUHvsF03-Ai38Bxw1m-wcA3nO4bXuQbOu5ilm94ts9O-O5Q17LSOKlTvFEmh9neQ3HAvou1bFSGWyWz7my_vOlA3YZAbfoo6xdx1YWYzaCQl_-eibck9i7p04DkvUvy5zqxMSmYS_LHpHAuKRiTFnNJof2K94V8us0FROC9DOfE9Hd07zA_aHuVkgf51GHT59peBKMapHDNH3GJBlWZV7k2edYH2va_PwEAAP__DBRFDg==

# Check that we properly render virtual computed columns when collecting stats.
statement ok
ALTER TABLE data ADD COLUMN e INT AS (b + 1) VIRTUAL

statement ok
CREATE INDEX ON data (e)

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV9tu2zgTvv-fgpibtvjpSKRkx-FVsm6KNYocYAldLBZBwUhTV4gtakkKaTbIY-0L7JMtJNVrSbFcC0KBBqgvBM1Bw_lmvpmEj2D-XIGA2eL8LDwnQXgWzoNwPguIYeTd4uqCxNJK8ts8_JVcXYfzq8uAnAXk6h0Jfg_C8wsSzi_OyasRy80roJCqGC_lGg2IP4ABBQ4UPKDgA4Ux3FDItIrQGKULl8fyg3n8BYRLIUmz3BbqGwqR0gjiEWxiVwgCQnm7wgXKGLXjAoUYrUxW5TFFgqfF42N2hw9AYaZW-To1gkhKbimJKImBQpDJQjdyGJFpTBhR9jNqoLDANEYtyCmj5JRTcupRcuoX7_9nQoj5ZTgFCu8_kCJXI0jKKtEmaxTE_edvU8mRSi2mNlHpM5NW94bEGKkYY0GY61bq2weLhmiUsSBT1yW_VOrl4npGIrlamZpvJhO98eWl8uLDbEaMxYxEKk8teY1frJOk9o0grrN1QLzrcijTUrnNcluddPNEoZK_tsFYuUQQrNa3-VsQ7hM9vHWBXGcr1M642bZKHSR_YXl2CSmw0haN2L7ympbWJa9poHWF_8xG67pxJ07ewjnuxLmFl6dKx6gxbsC7eeqsxNlyqXEprdIOcw-vCXnNXZfc5tEdWvOmVqEuQ6te-9ya1fuGZ7OWLeeuynqtyrImhdjh08-GTL_DRg4fOv984PzzXfPPjibkfbJjA_BdG8D_HhuA99gArE_7Nhtg8vI2wKSBkx9OUz6IpnzkeENp6v2kqeB92reh6fHLo-lxA6d3OE29QTT1Ro4_lKb-T5oKr0_7NjSdvjyaThs4_cNp6g-iqT9yxkNpOh5IU28XTfmRt5um3i6aTr4HTb0eNPX7tG9D05OXR9OTPtebBZpMpQZb__7vPsltnTRixT0B4yVWlwqjch3htVZR6VuJV2WgUhGjsZWVVcI83ZiM1SjX_93O6pHY3ki8EYnVI43bkfj-nPok5e0N5XdHYu1Ifl94suwKpGjvlb6rBtVgWi7tYuw3hmpUK8v2L8rGukZj5HLr4PpwU89z0s5zvDfPSTdi3o40-TERH7fzPN6b57QbsdeONP0xEU_beZ7sHxC3G7L_bGr3L4BemL1OzPzI_wbmcQvzSbGyPq3U_cckBgHu199ox2Pzg-IDuTTF3gw-q_sy6fAhK7beJ7kySOFC3uFbtKjXSZoYm0QgrM7x6el__wYAAP__LKBPtA==

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON c, e, a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl9Fu2zYUhu_3FAfnphtGV6IkOw6vnLkpZhSOA0voMAxGwUinrhBZ1EgaaRb4sfYCe7JBUtzaqm1Y7jz0oroQwEPq5394PgrkE5o_MxQ4nF5fRdcQRlfRKIxGwxAMh8kNxAyIgYTX08kYEmkl_DaKfoXJbTSa3IRwFcLkNYS_h9H1GKLR-BpedPjSvECGuUroRi7IoPgDOTL0kKGPDANk2MUZw0KrmIxRuhzyVH0wSj6icBmmebG0ZXjGMFaaUDyhTW1GKDCSdxlNSSakHRcZJmRlmlXTlAYH5etdcU-PyHCosuUiNwIkK1O5Q4ZhIctAx-Eg8wQ4KPuBNDKcUp6QFjDgDAYeg4H_MxdCjG6iPjJ88xZKg0ZAzuumTRckwP3nb1O3Y5Vbym2q8i-6tHowkFCsEkoEcNetw3ePlgxokomAvuvCL3V4Pr0dQiyzzGyMLWSq12O9Kjh-OxyCsVRArJa5hR_po3XS3P4kwHU-DyC63zegsqWWtljaeqbZimHdfl57Y-WcUPCNYo1eoXBX7Ph6hXJRZKSd7nat6nCY_lWuVFkXK221-AOPDfy9VryGle5eK58dLHOlE9KUbDmYrfaavZrPNc2lVdrh7n9i22_Y5ttLyI9Hnp-MvMM7jncq9N5XQu_tgp6_7MGbdAf23i7sg3Ng77XAnrep2Rr73lmw721Z8Y7HxzsdH6_j-Kfi43_HR3htarbG5-Is-FxsWfGPx8c_HR-_4wSn4hN8x0f4bWq2xqd_Fnz6W1aC4_EJTscn6DjdU_HpfiU-_i58vJf-bnz8Xfj0zoGP3wKfoE3N1vhcngWfyzbHxymZQuWGGme33TO5jZk6vDzkUTKn-kRo1FLHdKtVXI2tm5NKqAokZGzdy-vGKF93GatJLj6dfjeV-EElb0uJbyp1m0reYU9tTPkHpYL9SrypFLRNT1ZVwZzsg9L39V4ylJeXjPJi-Byu91Id71d3n3XPgoyR80-dLs42_fWa_roH_fX2Z-o1lXrfVqYXTX8XB_3192fqN5X631am_aa_y8Mbwd2favDF7jy80f_3XC_LX9L7TD28SxMU6D4_nR2v9YPlB3Juyv9i-EE9VGajx6L8q72XmSGGY3lPr8iSXqR5amwao7B6SavVD_8GAAD__5KDoI4=

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON e FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsltFu2zYUhu_3FMS5aYvJkUjJjsOrZm6KGYXjwBI6DENQMNKpK1gmNZJCmgV-rL3AnmyQVC22anlWCgO9qC8Ekzw65_91PhJ8BPNnBhwmi6vL6IqE0WU0DaPpJCSGkvk1QfJ2MZ-RRFhBfptGv5L5TTSdX4fkMiTztyT8PYyuZiSazq7IiwEtzAtwQKoEr8UaDfA_gIIDDBzwwYEAHBjCrQO5VjEao3QZ8li9ME0-A_ccSGVe2HL61oFYaQT-CDa1GQKHSNxluECRoHY9cCBBK9KsKlMKfF0-PuQrfAAHJior1tJwcgcOhLko_w5cSoRMCCXKfkINDixQJqg5eU1_ppzz6XU0BgfevSelJMOJpPXQpmvkxPvnb1OPYyUtSpsq-dWSVveGJBirBBNOqOfV03cPFg3RKBJOxp5Hfqmnl4ubCYlFlpmt2Fykuoll1eTs_WRCjMWcxKqQlrzEz9ZNpX3Fiec-BSCuugIqWaqweWHrSrcbB-rxl69trFgicLrVnukb4N7GOb5DoVjnGWp3uNudejpM_8KqdmUptMKWH75TCGsJGXYKeapfSKUT1Jjs1L_ddEq9XC41LoVV2qXe8aLJS-Z55K6IV2jNq04LfssC3f2Y9Hjc6TNwd-nAZX2BZ98IPNsHPD0bkXfpHuTZPuSDUyDPeiBP-3SpQX50AuRHO0LY8biw5-DCBq7fFxf_By6c9elSg8v5CXA53xHiH4-L_xxc_IEb9MUl-IEL9_t0qcFlfAJcxjtCguNxCZ6DSzBwh31xGX4jLv4-XNiZvx8Xfx8uo1Pg4vfAJejTpQaXixPgctHnIrhAkytpsHUP21_Ja1Ua0PLChskS69udUYWO8UaruIqth_MqUTWRoLH1Kq0HU9ksGatRrP-7x25nogczsZ1MdDvTsJ2JHdbUR5R_MFXQnYm2MwV97YmqKyDR3iu9qneSQVmdbuX1s1mo91K98nT0NqtrNEYsnwJK0rd1jto6hwd1jrods3am0ffp-Lyt8_ygznG3Y7-dafx9Oh63dV4c3iBet-Xgq117-ADo5dnv9MzOgv_xPGx5viiPrI-Zuv-QJsDB-_Ib7Hk0PyhfEEtTnpvhJ3VfiY4e8vLU-ygygw7MxArfoEW9TmVqbBoDt7rAzeanfwMAAP___iaZdg==

statement ok
ALTER TABLE data ADD COLUMN f FLOAT AS (atan2d(c, d::float)) VIRTUAL

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON f, e, d FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl1Fv2zYQx9_3KQ730hajK1GSHYdPztwUMzrHgSV0GAajYKSLK0QWNZJGmgX-WPsC-2SDpLi1VduwU3voQ_UggEfq-D_d7y9Qj2j-ylBgf3x5EV1CGF1EgzAa9EMwHEZXcMuAGCTwdjwaQiKthN8H0a8wuo4Go6sQLkIYvYXwjzC6HEI0GF7CixafmxfIMFcJXckZGRR_IkeGHjL0kWGADNs4YVhoFZMxSpdLHqsHBsknFC7DNC_mtgxPGMZKE4pHtKnNCAVG8iajMcmEtOMiw4SsTLNqm1Jgr7x9KO7oARn2VTaf5UZAwuCGQYwMw0KWgZbDQeYJcFD2I2lkOKY8IS2gxxn0vJ-5EGJwFXUZSCtzL3nZ81mPC_H2t9FF1H2FDN-9h1KzEZDzemjTGQlw__3H1ONY5ZZym6r8qymt7g0kFKuEEgHcdevwzYMlA5pkIqDruvBLHZ6Or_sQyywzK2sLmerlWq8KDt_3-2AsFRCreW7hJX2yTprbVwJc58sCorttCypZam6Lua13miwY1uOndhgrp4SCr_Rv8AaFu2D7tzCUsyIj7bTX21eHw_Tv8k2VrbLSVv3oeaznb5XiNaS0t0r5omCeK52QpmRNwWSxVezFdKppKq3SDnePIttvyObrr5Dv7wL-bBc4vOV4R_SB940-8Db5gL_uwLt0gxO8TU4ITuEE7wAn8EPauHRC5yRO6KxJ8fYnyns-UV7L8Y9IlP-DKOEd0sYlUWcnIepsTYq_P1H-84nyW05wRKKCH0QJ_5A2LonqnoSo7pqUYH-igucTFbSc9hGJan8jUf4morzX_mai_E1EdU5BlH8AUcEhbVwSdX4Sos4POYqOyRQqN9Q4B27eyW3s1OLlgZGSKdWnS6PmOqZrreJqbT0cVYmqQELG1rO8Hgzy5ZSxmuTs80l6NRPfmclby8RXM7Wbmbzdmg4R5e9MFWzPxJuZgkPLk1VXMCd7r_Rd7SVDefnDUv53PoVrL9XxbvUftZyZkTFy-nnSxcmqvk5TX3unvs72Sr1mps73VelZU9_ZTn3d7ZX6zUzd76vSblPf-W4juNtLDb5y526j_--1npefpNtM3X9IExToPl2tDbflheUDcmrK72L4Ud1XYqOHovyq3crMEMOhvKM3ZEnP0jw1No1RWD2nxeKn_wIAAP__O4O7FQ==

statement ok
CREATE TYPE gh AS (g INT, h INT)

# Try a virtual computed column whose expression cannot be distributed.
statement ok
ALTER TABLE data ADD COLUMN g gh[] AS (array_cat(ARRAY[(1, 2)], ARRAY[(a, b)])) VIRTUAL

# Error if we specify the problematic virtual computed column directly.
statement error cannot be executed with distsql
CREATE STATISTICS s1 ON g FROM data

# We should skip the problematic virtual computed column when using defaults.
query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV-Fu4kYQ_t-nGM2fy6lL7F0bQvYXKZeo6JoQYeuqqopOG3uOswI23V2USyMeqy_QJ6tsHwUczGEhpIt0_LC8M-PZ-Wa-_dA-o_lrghL7o8uL8BKC8CIcBOGgH4DhcDUaXkOsrILfB-GvMLwNB8ObAC4CGF5B8EcQXl5DOLi-hDctPjdvkGGaxXSjpmRQ_okcGQpk6CFDHxm28Y7hTGcRGZPpPOS5-GAQf0HpMkzS2dzm5juGUaYJ5TPaxE4IJYbqfkIjUjFpx0WGMVmVTIpt8gJ7-ePj7IGekGE_m8ynqZGgGNwziBjEyDCYqdzWcjioNAYOmf1MGhmOKI1JS-hxBj3BoOcx6Pn5-89cSjm4CbsMlFWpiE96Huv5Ul79NrwIu2-R4fsPkEMwElJeLm0yJQnuv_-Ych1lqaXUJln6wqWzRwMxRVlMsQTuuqX5_smSAU0qltB1XfilNI9Ht32I1GRi1mJnKtHLWFEYrz_0-2AszSDK5qmFE_pinSS1byW4ziqA6KEuoCgrm9vZ3JY73S0Yluuv0zFWjQklXxvn4B1Kd8H2n2igprMJaae9Oc3SHCR_U7F3ASmwyubzWb2KNStbX3mbDrZu8F_42LqtvXrt1EIWFcjtWsgrpPM00zFpijeQ3i1qm3IxHmsaK5tph7v7twdOhOvC_Tx6IGverjWrzlFp3a6wzUZ-I3KzrXXBHTgRK3Ndw71Kw_kmyfj-ssEPkQ2HtxxxJOEQBwqH2CYc_LQD75Mt0iG2SYd_DOkQDaSDN5nqUjo6r1o6OhuQxf5EFgcRWbQc70hE9n4QWYomU10S-exVE_lsA7K3P5G9g4jstRz_SET2fxBZek2muiRy91UTubsB2d-fyP5BRPZbTvtIRG4fSGRvG5HFqbedyN42IneOQWSvAZH9JlNdEvn8VRP5vMlFbERmlqWGKreT7Tu5lZ1aPL_GUDym8s5jsrmO6FZnURFbLodFosIQk7Gll5eLQbp0GatJTf-_R65n4jsziY1MfD1Tu5pJ7K6pSVHezlR-fSZezeQ3haeKqWBK9jHTD-WZNZQWCp8zd-koT23pWf39LL1TMkaNVwGuj3frdXaqdbZ31tmpRyyqmTrfJ-Kzap1nO-vs1iP2qpm63yfibrXO890HxK2H7L84tbsFoBFmrxazOPW_gbldwXyeS9anSfb4MYlRovv119ryWP4w_0CNTa6bwefssSg6fJrlqvdJTQwxvFYP9I4s6WmSJsYmEUqr57RY_PRfAAAA___maoLQ

# Check that we also collect stats on the hidden expression index virt column.
statement ok
CREATE INDEX ON data ((a * b))

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWO9u2zYQ_76nONyXJhsdiZT8J_zkzE0wo0scWEKHYQgKRrq6QmzJI2mkWeDH2gvsyQZJdW0rlmvDMFAE1QeBvDsd78f78WfQz2j-HqPE3vDyIryEILwI-0HY7wVgOFwNB9cQK6vgj374Gwxuw_7gJoCLAAZXEPwZhJfXEPavL-FNg8_MG2SYZjHdqAkZlH8hR4YCGXrI0EeGTbxjONVZRMZkOg95Lj7ox59RugyTdDqzufmOYZRpQvmMNrFjQomhuh_TkFRM2nGRYUxWJeNimbzAbv76MH2gJ2TYy8azSWokKAb3DCIGMTIMpiq3NRwOKo2BQ2Y_kUaGQ0pj0hK6nEFXMOh6DLp-Pv6FSyn7N2GHQZf_nPuUVamIT7oe6_pSXv0-uAg7p8jw3XvIkRgJKS-nNpmQBPe_f005j7LUUmqTLH3h0tmjgZiiLKZYAnfd0nz_ZMmAJhVL6Lgu_FqaR8PbHkRqPDYrsVOV6EWsKIzX73s9MJamEGWz1MIJfbZOktpTCa6zDCB6qAsoyspmdjqz5Up3c4bl_EuTjFUjQslXutp_i9Kds90bG6jJdEzaaa43tTQHyT9UrF1ACqyyeZuWQ7FiZaszb93BVg3-Cx9btTWXw9Zy2K5FLyrom7Xol6BnaaZj0hSvgb6b1-7PxWikaaRsph3u7r5TcCJcF-5n0QNZc7qyb3WOyi5uC1vf029Eru9wXXCrztGGE7E013XCq3SCrxOR764w_BCFcXjDEcfVGHGgxohNGsPPWvAu2aAyYpPK-MdQGbGHyvB9mrtQmdZrUZnWGnqxO7XFQdQWDcc7LrW9H9SWYp_mLqjdfi3Ubq-h93antncQtb2G4x-X2v4Paktvn-YuqN15LdTurKH3d6e2fxC1_YbTPC61mwdS29tEbXHmbaa2t4narWNQ29uD2v4-zV1Q-_y1UPt8n0vfkMw0Sw1Vrj-bV3IrKzV4fk-ieETlpcpkMx3Rrc6iIracDopEhSEmY0svLyf9dOEyVpOafL2zrmbiWzOJtUx8NVOzmklsr2mforytqfz6TLyayd8Xniq6ginZx0w_lMfXUJrLf3EjXTjKA1x6lr9NC--EjFGjZYBb_Ce0rLNVrbO5tc5WPWJRzdT6PhG3q3W2t9bZqUfsVTN1vk_EnWqd59sPiFsP2X9xarcLwF6YvVrM4sz_BuZmBfN5Llkfx9njhyRGie6Xp7HhtXgw_0CNTK6bwafssSg6fJrmqvdRjQ0xvFYP9JYs6UmSJsYmEUqrZzSf__R_AAAA__-jn56z

# Check that we also collect stats on other hidden columns.
statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWO9u2zYQ_76nONyXJhsdiZT8J_zkzE0wo0scWEKHYQgKRrq6QmzJI2mkWeDH2gvsyQZJdW0rlmvDMFAE1QeBvDsd78f78WfQz2j-HqPE3vDyIryEILwI-0HY7wVgOFwNB9cQK6vgj374Gwxuw_7gJoCLAAZXEPwZhJfXEPavL-FNg8_MG2SYZjHdqAkZlH8hR4YCGXrI0EeGTbxjONVZRMZkOg95Lj7ox59RugyTdDqzufmOYZRpQvmMNrFjQomhuh_TkFRM2nGRYUxWJeNimbzAbv76MH2gJ2TYy8azSWokKAb3DCIGMTIMpiq3NRwOKo2BQ2Y_kUaGQ0pj0hK6nEFXMOh6DLp-Pv6FSyn7N2GHQZf_nPuUVamIT7oe6_pSXv0-uAg7p8jw3XvIkRgJKS-nNpmQBPe_f005j7LUUmqTLH3h0tmjgZiiLKZYAnfd0nz_ZMmAJhVL6Lgu_FqaR8PbHkRqPDYrsVOV6EWsKIzX73s9MJamEGWz1MIJfbZOktpTCa6zDCB6qAsoyspmdjqz5Up3c4bl_EuTjFUjQslXutp_i9Kds90bG6jJdEzaaa43tTQHyT9UrF1ACqyyeZuWQ7FiZaszb93BVg3-Cx9btTWXw9Zy2K5FLyrom7Xol6BnaaZj0hSvgb6b1-7PxWikaaRsph3u7r5TcCJcF-5n0QNZc7qyb3WOyi5uC1vf029Eru9wXXCrztGGE7E013XCq3SCrxOR764w_BCFcXjDEcfVGHGgxohNGsPPWvAu2aAyYpPK-MdQGbGHyvB9mrtQmdZrUZnWGnqxO7XFQdQWDcc7LrW9H9SWYp_mLqjdfi3Ubq-h93antncQtb2G4x-X2v4Paktvn-YuqN15LdTurKH3d6e2fxC1_YbTPC61mwdS29tEbXHmbaa2t4narWNQ29uD2v4-zV1Q-_y1UPt8n0vfkMw0Sw1Vrj-bV3IrKzV4fk-ieETlpcpkMx3Rrc6iIracDopEhSEmY0svLyf9dOEyVpOafL2zrmbiWzOJtUx8NVOzmklsr2mforytqfz6TLyayd8Xniq6ginZx0w_lMfXUJrLf3EjXTjKA1x6lr9NC--EjFGjZYBb_Ce0rLNVrbO5tc5WPWJRzdT6PhG3q3W2t9bZqUfsVTN1vk_EnWqd59sPiFsP2X9xarcLwF6YvVrM4sz_BuZmBfN5Llkfx9njhyRGie6Xp7HhtXgw_0CNTK6bwafssSg6fJrmqvdRjQ0xvFYP9JYs6UmSJsYmEUqrZzSf__R_AAAA__-jn56z

# Check that we can disable stats collection on virtual computed columns.
statement ok
SET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled = false

statement error cannot create statistics on virtual column
CREATE STATISTICS s1 ON e FROM data

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV-Fu2zYQ_r-nIO5PW4CuREp2HP5K5qaYUbgOLKHDMBgFI11dwbKokRTSLPBj7QX2ZIOkerYVy7VgFGiA-ocQ3p2O9919H8U8gvkrBQGj2c11eEOC8DocB-F4FBDDyNvZdEJiaSX5fRz-Rqa34Xj6PiDXAZm-JcEfQXgzIeF4ckNe9FhhXgCFTMX4Xq7QgPgTGFDgQMEDCj5Q6MOcQq5VhMYoXYY8Vi-M4y8gXApJlhe2NM8pREojiEewiU0RBITyLsUZyhi14wKFGK1M0mqbssCr8vExX-IDUBiptFhlRhBJyR0lESUxUAhyWdp6DiMyiwkjyn5GDRTefSBlFUaQjNVLm6xQEPfff0y9jlRmMbOJyp64tLo3JMZIxRgLwly3Nt89WDREo4wFGbou-bU2L2a3IxLJNDU7sblM9CaWV8bJh9GIGIs5iVSRWfISv1gnyewrQVxnG4C4bAuoylKFzQtb7zRfU6jXXxtsrFwgCLYzkfEbEO6anj6UQK7yFLXT3x9IbQ6Sv7Hau4IUWGkFuWLbP_mOle6uvH0H3TX4T3z0ym8Fxxvg-q3gtpiKTOkYNcZ7mObrVvjXi4XGhbRKO8w9vRHkJXddcldES7Tm1U5b2hyNJh0L22_ZNyKPNdBrNJDt04Odrll2jmYd1nN4u2r5marlh1TLXg_Iu-SAbvkh3frfQ7e8g25Zl8FsdDt4Jrod7IHjp7OOn8U63nO8dtZ5P1kneJfBbFh38UxYd7EHzjuddd5ZrPN6jt_OOv8n64TXZTAb1g2fCeuGe-D801nnn8U6v-f021nXP5N13iHW8dfeYdZ5h1g3-B6s8zqwzu8ymA3rLp8J6y67XPtnaHKVGWzckA_v5DZ26rHyKo3xAut7t1GFjvBWq6iKrZfTKlFliNHY2svqxTjbuIzVKFf__9eym4kdzcT3MrHdTP1mJn68pi5FeUdT-e2ZWDOT3xWerKYCGdp7pZe1Og1m1cFbfo83jlqftWf7Vdh4V2iMXGwDXA_mu3UOmnX2j9Y5aEfMm5kGPybii2adF0frHLYj9pqZhj8m4mGzzsvjAnHbIftPVHv8AOiE2WvFzF_738Dcb2C-LI-sT6m6_5jEIMD9-usdeGx-UL4gF6Y8N4PP6r4qOnzIy1Pvk0wNUpjIJb5Bi3qVZImxSQTC6gLX61_-CwAA__9rfQ6n

statement ok
RESET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled

subtest regression_98373

statement ok
CREATE TABLE IF NOT EXISTS t98373 AS
        SELECT
                g::INT2 AS _int2,
                g::INT4 AS _int4,
                g::INT8 AS _int8,
                g::FLOAT8 AS _float8,
                '2001-01-01'::DATE + g AS _date,
                '2001-01-01'::TIMESTAMP + g * '1 day'::INTERVAL AS _timestamp
        FROM
                generate_series(1, 5) AS g;

statement OK
SET vectorize = off

statement OK
SET distsql = always

# These query plans should be disallowed from executing in a distributed
# fashion, even with distsql = always. Check different flavors of EXPLAIN.

query T
EXPLAIN SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN

query T
EXPLAIN(DISTSQL) SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF9r2zAUxd_3KcR5akFh9sq2TE8tSTYMaZLZfhgUEzTr1hOVJU-S6Urwdx-20_1jg90HiftH5_6OTghfDQQ2nw7bm2zHLtZZURYft5es2Gw3q5J5ajrv6oujtvGVENmuXF4KkW8-HPL9it0UrHZm-eY1e5_vb1l8t7x6e3V9l1TgsE7RTrYUIO6QouIYhSgE58fSaRrI1DeIhEPbro9jueKonSeIE6KOhiBQys-GcpKK_MsEHIqi1GaSPS-cr2P3QE_gWDnTtzYINjGDo-jkmC7AkZNV5MUPW9fp2ROqgcP18SdGiLIhiPQX7mwNkQz8_9FzCp2zgX6j_tem5I9Ni3SoOEg1NP9XcL2v6eBdPc3O6X4SmgqKQpy76Zxk9rkVoifZzvgVx71xj0etIJCcY_GX4zkwPpBNGI0VX9zjJFs-dSPWvTSBOG7lA60pkm-11SHqGiL6nobhxfcAAAD__wgUvrk=

statement OK
RESET vectorize

statement OK
RESET distsql
