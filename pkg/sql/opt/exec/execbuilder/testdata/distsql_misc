# LogicTest: 5node

subtest scrub

# TODO(radu): rework or remove these tests (the inner ORDER BY is ignored by
# the optimizer).
#
# # Verify the index check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
#     FROM
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
#     FULL OUTER JOIN
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
#       ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
#     WHERE (leftside.k IS NULL) OR
#           (rightside.k IS NULL)
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLBlIJDs9CAq6dCFLGpdscio-uNY0a3AkM5Khy5J3L45hNw5x2vQ4I33zzc8bOG9pXRwogP4BEnKEhn1JIXjuUv2Hpf0Neo5QuaaNXTpHKD0T6DeIVawJNGyLnzVtqLDEszkgWIpFVZ_KNlwdCn41kUIEhKyNWhiFRqJJID8i-DZ-FA6x2BNoecR_lz97jsQzOfQaOUWjpmiS6ahG3aM5n1ENXYFK7-zdUyb_MWUyPiXCoYjli6jJaaFGremo9UPWOs-WmOzAlnfk375caf0b8Z6efOWIZ-mw_-1rQ1o87lYrke22XzfiKVuuAaGmX3FyNtzDF672L8MUIDxWdSTWYmKUWD6L9W61ehDZRkzM4j1-P4fE7iIJmhTNAs3n0Q0t7rnLhkLjXaDLTV2tPO_WQ3ZP_bqDb7mk7-zLk6YPsxN3SlgKsX-VfbB0_VPX4Dksb8LpAJaXsLoJJ7fNyR1mdQmnN-HFhTk_fvoTAAD__3P7gDg=
#
# # Verify the foreign key check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE parent (
#   id INT PRIMARY KEY,
#   id2 INT,
#   UNIQUE INDEX (id, id2)
# )
#
# statement ok
# CREATE TABLE child (
#   child_id INT PRIMARY KEY,
#   id INT,
#   id2 INT,
#   FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
# )
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT p.child_id, p.id, p.id2
#     FROM
#       (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
#     FULL OUTER JOIN
#       (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
#       ON p.id = c.id AND p.id2 = c.id2
#     WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
#           c.id IS NULL AND c.id2 IS NULL
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nID1bi9BAYZbAWL0-G8T0PEmXNtqEskidBS_O7DCGstvRvdY345__wO5-QRtJFYdL_QAf8BCTQUJmt6dM7YFW0FmbwHHlNQepr9ihsKvbEI_BG88iMCh7r7OWKFnUR7FQMFib5TY3i2v1WjbLvZm1Zpifft-a5VsrV4bqfOovYiVECzUDCzf3I43w0IPFno__WR7PvYZKtaSdbe4YPYyEUxuyh-8s3aWIkW5c7VrMl_lbzS_Ve0A94YpdFesX339cOEnFyf8pyUp_pLRW7KrAAKI559JNiRivR4-GjVcOsjkRypYMcDULhWo0fLSRRFgpHsOynKmhSnPD-QsiKRSHfsQD4Vn0kk3gf6nHz4Q4BCOXtOREIFoyK9OL70LXur0E1GO3w5xldfjtfZoRxw24Uzs-3xmzV90GzHMuQCkOj8dsu2Q6bDVfhYz8PJG8LsZZj9NZzuwvHSLO9-BwAA__9_viDb

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/66>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

query T
EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
distribution: full
vectorized: false
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lVtvmzAUx9_3Kazz1EpGYCA3PzVqOwmptwUeJk1R5YbTFJVgZht1XZXvPjlZ1sIKSpDCAwIDv_Pz3xfeQP_MgcPl97uraXRDTi6iOIm_XZ2S89nlNLkkcTJNojiJzmOiGbm9IYJ8nd1ek1QYARQKmeKNWKEG_gMYUPCBQgAUQqAwgDmFUskFai2VfeVt80GU_gLuUciKsjK2eU5hIRUCfwOTmRyBQyIecpyhSFG5HlBI0Ygs35Sxpc_s6b58xlegcC7zalVoTqxRXAp76biMiCIljEjzhArmawqyMu8FtRFLBM4-GEYXwL013V8yFqsyR-UO6oLb5jj7jZwwz_Osf2yE4eSMtYr4DZFBq8h7_aqQKkWFaa3-fN2qOl0uFS6Fkcpl3v7S5MT3PPJQLZ7R6NPWLgSNLrB6mGz_EWc9Rtxljuv3GnN2iOZuzIdHGPNhTcTfPy-_T16-4wa98vIP0dzlNTpCXqOaSLB_XkGfvALHDXvlFRyiuctrfIS8xjWRcP-8wj55hY476JVXeIjmLq_JEfKaHPIzmKEuZaGxsRd_XslrVHKY3bQxXeJ2h9eyUgu8U3KxeXd7e7sBbRpS1Gb7lG1vomL3SBuFYvXvX_aRxDpJfo3EPpIGTZLf7XSIVNCJCttJrEkK-3Zv2CQNOknDdie_SRr2dRo1SaNO0rjdKWiSxn2dxk3SpHsaeO1S4X9zs3uad1hN7NJ5zOXLfZYCB-_v4Xxy2h1gPxBLbddv_CRfNtjktbSr71HkGilci2e8QINqlRWZNtkCuFEVrtdf_gQAAP__uYub4w==

statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsltGOmzgUhu_3Kaxz1UpkwIZkMr7qbNqVomo6VYh6sxpVHjilKMRmbaN0dpTH2hfYJ1sBZZNQSEOkVL1oLlBsH875f85ny89g_sqAw2zx5nb5hoTL2-U8XM5nITGU3L8jgvyxuL8jsbACHJAqxndijQb4n0DBAQYO-OBAAA6M4cGBXKsIjVG6DHmuXpjHX4B7DqQyL2w5_eBApDQCfwab2gyBw1I8ZrhAEaN2PXAgRivSrCpTln5VPj7mK3wCB2YqK9bScFIqCnNR_h25lAgZE0qU_YwaHHj7gZTFDSeS1kONSarKYIvG1lM2XSMn3r__mHocKWlR2lTJb5a02hgSY6RijDmhnldPPz5ZNESjiDmZeh75vZ5OFu9nJBJZZvZic5HqJpZVk3cfZjNiLOYkUoW05AV-sW4q7UtOPHcXgLjqC6hkqcLmha0rPWwdqMdfP7WxIkHgdK8389fAva1zentCsc4z1O74sDX1dJj-jVXtylJoheXkFe0VwlpCxr1CdvULqXSMGuOD-g_bXqm3SaIxEVZpl3qniyYvmOeRxyJaoTUvey34LQv08GPS01mnZ7Du0pHLfijtrIt2ejUhb9MO3lkX78EleGcDeKdDWtTwPrkA75MDIex0Vtg5rLCR6_9iZSArbEiLGlauL8DK9YEQ_3RW_HNY8Udu8IuVgaz4Q1rUsDK9ACvTAyHB6awE57ASjNzxD2XF72KFXfndrPhdrEwuwYo_gJVgSIsaVm4uwMrNkMvfAk2upMHW3au7kteqNKLlJQ3jBOsbnVGFjvC9VlEVWw_vq0TVRIzG1qu0Hsxls2SsRrH-_-66n4kezcQOMtH9TON2JnZc0xBR_tFUQX8m2s4UDLUnqq6ARLtRelXvJIOyOtrKvdks1HupXtmdu83qGo0RyS6gJH1f56Stc3xU56TfMWtnmvycjq_bOq-P6pz2O_bbmaY_p-NpW-fN8Q3i9VsOvtm1xw-AQZ79Xs_sKviO53HL8015ZH3K1OZjGgMH7-tv1PFoflC-IBJTnpvhZ7WpRC-f8vLU-yQygw7ciRW-Rot6ncrU2DQCbnWB2-1v_wUAAP__51uRrA==

query T retry
EXPLAIN (DISTSQL, TYPES) SELECT * FROM data
----
distribution: full
vectorized: true
·
• scan
  columns: (a int, b int, c float, d decimal)
  estimated row count: 1,000 (100% of the table; stats collected <hidden> ago)
  table: data@data_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklEFvmz4UwO__T2G903-TERjIDpw2NZmElKZZ4LBpiioXv6aogJlt1FUR330ydGtBSYWID5bs5_zeLw8_H0H_KiCC1fft-ku8If8v4yRNvq0pSX9sV8kHkqzWq6uUfCRfdzfXRHDDgUIlBW54iRqin8CAgg8UAqAQAoUF7CnUSmaotVT2yLH7QSx-Q-RRyKu6MXZ7TyGTCiE6gslNgRBByu8K3CEXqFwPKAg0PC-6NDb1Zzvd1o_4DBSuZNGUlY4Ip-SOkowSARSSmts9x2WEV4IwIs0DKti3FGRjXjNrww8IEXujGi8h8lp6xvZVsqmkEqhQDAXzygB9me8LyU0XzvKSF7BvT_zZjXRk7S4GlHOe_shzMfBk06vKLqmqyxzXn1VXNvD1p_v6F_n6jhvM8vUHvsF03-Ai38Bxw1m-wcA3nO4bXuQbOu5ilm94ts9O-O5Q17LSOKlTvFEmh9neQ3HAvou1bFSGWyWz7my_vOlA3YZAbfoo6xdx1YWYzaCQl_-eibck9i7p04DkvUvy5zqxMSmYS_LHpHAuKRiTFnNJof2K94V8us0FROC9DOfE9Hd07zA_aHuVkgf51GHT59peBKMapHDNH3GJBlWZV7k2edYH2va_PwEAAP__DBRFDg==

# Check that we properly render virtual computed columns when collecting stats.
statement ok
ALTER TABLE data ADD COLUMN e INT AS (b + 1) VIRTUAL

statement ok
CREATE INDEX ON data (e)

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgQve9XEHNqsXQkUrLj8JSs2wWMIm1hG70sjIKRpqpgWdSSFNJs4M_aH9gvW0iqakmxXAtBgASoD4I4MxrOm3l8Bu_B_J2AgNni7dXqLVmurlbz5Wo-WxLDyJ-LD9cklFYChVSF-F5u0YD4CxhQ4EDBAwo-UBjDmkKmVYDGKF2E3JcfzMNvIFwKcZrltjCvKQRKI4h7sLFNEASs5E2CC5QhascFCiFaGSflNsXWl8Xjc7bBO6AwU0m-TY0gkpIbSgJKQqCwzGRhGzmMyDQkjCj7FTVQWGAaohbkklFyySm59Ci59Iv335kQYv5-NQUK7z6RolYjSMqqpcYoVkVKi8ZWJhtvURD3v39NtQ5UajG1sUofuLS6NSTEQIUYCsJctzLf3Fk0RKMMBZm6LvmjMkeLjzMSyCQxjdhMxrqO5aXx-tNsRozFjAQqTy15hd-sE6f2tSCusw9A3PQFlGWp3Ga5rXZa7yhU6--TMVZGCII1Rjl_A8Ld0dOnuZTbLEHtjNuTrMzL-B8s9y4hLa20xWz2r7xhpc2V13bQpsF_4KNN27gXJ-_gHPfi3MPLU6VD1Bi24K13vZ24iiKNkbRKO8w9vSfkFXddcpMHG7TmdaNDfY5Ov46Ftbv3k8h2LzvBfZ31Op1lbQqx0wWBPUYQHDZy-DOUBH5IEtjZhLyLD4gCPyQK_lOIAh8gCmzIRGtRmLw8UZi0cPLTmcsfxVw-crxfzH0S5vIhE62Ze_7ymHvewumdzlzvUcz1Ro7_i7lPwlxvyERr5k5fHnOnLZz-6cz1H8Vcf-SMnyFzvUPM5WfeYeZ6h5g7eQrmegOY6w-ZaM3ci5fH3IshV6UFmkylBjtXicM7uZ2dRqy4c2AYYXVBMSrXAX7UKihjq-WHMlFpCNHYysuqxTytXcZqlNsfN71mJnY0E29lYs1M424mfrymIUV5R1P5_ZlYN5M_FJ4spwIp2lulN9VBNZiWOl4oQe2ojmrl2f_J1N4tGiOjfYDrw7pZ56Rb5_honZN-xLybafI8EZ936zw_Wue0H7HXzTR9noin3Tovjh8Qtx-y_-DUHheAQZi9Xsz8zP8J5nEH80UhWV8Sdfs5DkGA-_03OvCof1B8ICNT6Obyq7oti17dZYXqfZGJQQrXcoNv0KLexmlsbByAsDrH3e63_wMAAP__5DVk2w==

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON c, e, a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV9Fu2zYUfd9XEPdpw-hKpGTH4ZMztwOMIklhG30ZjIKRblUhMqmRNNIs8GftB_ZlA6W4tVXLsIK4yEP0IICXV4fn6p5DkA9g_y5AwHj67mL-jszmF_PJbD4Zz4hl5PqKJJQgJZL8Ob2-JKl0EigoneKVXKIF8RcwoMCBQgQUYqDQhwWF0ugErdXGpzxUH0zSryBCCrkqV86HFxQSbRDEA7jcFQgC5vKmwCnKFE0QAoUUncyLahm_9Mi_PpW3eA8UxrpYLZUVRFJP8gYozErpA72AEalSwoh2X9AAhSmqFI0gI0bJiFMyin5nQojJ1XwIFN5_JJ6gFUSxemgwy7WHcmhdHXL5EgUJ__vX1uNEK4fK5Vr9MGX0nSUpJjrFVBAWhnX45t6hJQZlKsgwDMkfdTibfhiTRBaF3cotZW42ubwKXn4cj4l1WJJEr5Qjv-JXF-TK_SZIGHxPQLxtS6ho6ZUrV65eabGmUI8f22GdzBAE2-rf5C2IcE2Pb-FMLssCTdDfbV8dnuX_-D_lW-Wkq_ox4nQUtVLhDSr9VirfGayUNikaTHcYLNatZC-yzGAmnTYBC5-FdtSgzXZ_ITveBezJLghYL-AvyAd8nw_YmwF5n-9xAt_nhPgUTuAdnMC6tHHjhMFJnDDYocKPVxR_uqJ4L4heFfWsiuJd2rhR1NlJFHW2QyU6XlHR0xUV9YL4VVHPqqioSxs3ihqeRFHDHSrx8YqKn66ouBf0X5Cion2K4m-i_YqK9ilqcApFRR0UFXdp40ZR5ydR1HmXo-gUbamVxcY5cP9KYWOlHvMHRkwzrE-XVq9Mgh-MTqrcenhdAVWBFK2rZ1k9mKjNlHUG5fLbSXobiR1E4jtIbBup30Tihzl1IRUdhIrbkVgTKe5anqy6AgrdnTa3tZcsKn9h8ffOx3DtpTo-rO5Rm5klWiuzb5MhLLb5DZr8-gf5Ddor5U2kwcuq9KzJ7-wgv2F7pVETafiyKh02-Z0fNkLYXmr8gzsPG_2n13rut6TPhb77lKcgIHx8entemwf8BzKzfl-cfdF3Fdn5fel3tc-ysEjhUt7iW3RolrnKrcsTEM6scL3-5f8AAAD__-CHtbU=

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON e FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsVsFu2zgQve9XEHNqsXIkUrLj8NSs2wWMIklhG70sgoIRp6pgmdSSFNJs4M_aH9gvW0iqNrYqea2gBnKoDoI5HM2853mP4CPYPzPgMFu8u1y9I8vV5Wq-XM1nS2IpubkmSH5f3FwRKZwAD5SWeC02aIH_ARQ8YOBBCB5E4MEYbj3IjY7RWm3KlMfqg7n8CjzwIFV54crwrQexNgj8EVzqMgQOK3GX4QKFROMH4IFEJ9KsalO2flO-PuVrfAAPZjorNspycgceLHNR_hz5lAglCSXafUEDHixQSTScvKG_Us75_Ho1BQ_efyQlJMuJovXSYJLqsoRD6-qQSzfISfDP37Zex1o5VC7V6rsto-8tkRhriZITGgR1-O7BoSUGheRkGgTktzqcLD7MSCyyzO7k5iI1TS6rglcfZzNiHeYk1oVy5BV-dX6q3GtOAv8pAXHdl1DB0oXLC1d3ut16UK-_DcA6kSBwujOx-VvgwdY7fmhLsckzNP54f2B1eJn-hVXvitLSCVfOohcIawEZ9wJ56l8obSQalHv9b7e9UC-TxGAinDY-DY4HTV6xICB3RbxGZ1_3UghbFOj-n0mPdwB9hgN8OvLZC_AA6_IAPZuQ92mHC1iXC6JTuIANcAEdMrjGBZMTuGCyB4QdryD2HAWxkR_-VNAPURAbMrhGQecnUND5HpDweAWFz1FQOPKjnwr6IQoKhwyuUdD0BAqa7gGJjldQ9BwFRSN__AIUFHYpiJ2F3QoKuxQ0OYWCwgEKioYMrlHQxQkUdDHkUrlAm2tlsXWn6-4UtDqNaHn5Q5lgfVO0ujAxfjA6rnLr5U1VqApItK7epfVirpot6wyKzX934t1K9GAltleJ7lYatyuxw5iGgAoPlor6K9F2pWgoPVFNBRS6e23WtZMsqurAK73ZbNReqneeTuNmd4PWiuQpoVT6Ls5JG-f4IM5JP2PWrjR5mYzP2zjPD-Kc9jMO25WmL5PxtI3z4rBBgn7K0XeuPXwADOIc9nJmZ9H_cB63OF-UR9bnTN9_SiVwCL49o45X80D5gUhseW4uv-j7CvTqIS9Pvc8is-jBlVjjW3RoNqlKrUtj4M4UuN3-8m8AAAD___-erp0=

statement ok
ALTER TABLE data ADD COLUMN f FLOAT AS (atan2d(c, d::float)) VIRTUAL

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON f, e, d FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV9Fu2zYUfd9XEPepxehKpGRH4ZMztwWMLklhG30ZjIIRb1QhMqmRNNIs8GftB_Zlg6S4tVXbsIJ5yEP1IICXV4fn6p5DkI_g_ixAwGjy7mL2jkxnF7PxdDYeTYlj5PqK3FKClCjyfnJ9SZT0Eihoo_BKLtCB-AMYUOBAIQIKMVDow5xCaU2KzhlbpTzWH4zVVxAhhVyXS1-F5xRSYxHEI_jcFwgCZvKmwAlKhTYIgYJCL_OiXqZaeli9Ppd3-AAURqZYLrQTRFFyQ0kKFKalrAK9gBGpFWHE-C9ogcIEtUIryJBRMuS_MiHE-GqWUCK91Fy9GkZ0yIR4__v1xSx5DRQ-fCIVZyeIZs3QYpabCt2j803I5wsUJPznb9eMU6M9ap8b_cOUNfeOKEyNQiUIC8MmfPPg0RGLUgmShCH5rQlnk48jksqicBu5pcztOpfXwctPoxFxHkuSmqX25BV-9UGu_WtBwuB7AuLdvoSalln6cumbleYrCs34qUPOywxBsI2Wjt-CCFf0-K5O5aIs0Ab97Y424Wn-V_Wnqu556esWDTkdRnup8BaV_l4q3xkstbEKLaotBvPVXrIXWWYxk97YgIX_Ce2oRZtt_0J2vDHYs40RsF7AX7Y1-C5rsDcD8iHfYQ6-yxzxKczBO5iDdens2hyDk5hjsEWFHy8y_nyR8V4Q_RTZqUXGu3R2LbKzk4jsbItKdLzIoueLLOoF8U-RnVpkUZfOrkWWnERkyRaV-HiRxc8XWdwL-i9bZNEukfE30W6RRbtENjiFyKIOIou7dHYtsvOTiOy8y7F2gq402mHrTLl7pbC1Uo9Vh09UGTYnVWeWNsWP1qR1bjO8roHqgELnm1nWDMZ6PeW8Rbn4dirfRGIHkfgWEttE6reR-GFOXUhFB6Hi_UisjRR3LU_WXQGN_t7Yu8ZLDnV1-amutU_hxktNPKnvZOuZBTons2-TIcw3-Q3a_PoH-Q32V8rbSIOXVelZm9_ZQX7J_kqjNlLysipN2vzODxsh3F9q_IM7Dxv9f6_1vNqSbgtz_zlXICB8eno7XusHqg9k5qp9cfrF3NdkZw9ltavdysIhhUt5h2_Ro13kOnc-T0F4u8TV6pd_AwAA__9W9tA8

statement ok
CREATE TYPE gh AS (g INT, h INT)

# Try a virtual computed column whose expression cannot be distributed.
statement ok
ALTER TABLE data ADD COLUMN g gh[] AS (array_cat(ARRAY[(1, 2)], ARRAY[(a, b)])) VIRTUAL

# Error if we specify the problematic virtual computed column directly.
statement error cannot be executed with distsql
CREATE STATISTICS s1 ON g FROM data

# We should skip the problematic virtual computed column when using defaults.
query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgQve9XEHNKsHQkUrLj8OSs2wJGN01hG70sjIKRpq5gWdSSNNJs4M_aH9gvW0iqakmxXAtBixqID4I4MxrOm3l8Bh_B_B2DgPH09fX8NZnNr-eT2XwynhHDyJvp7Q0JpZVAIVEhvpNrNCD-AgYUOFDwgIIPFPqwoJBqFaAxSmchj_kHk_ALCJdClKQbm5kXFAKlEcQj2MjGCALm8i7GKcoQteMChRCtjOJ8m2zrUfb4mK7wASiMVbxZJ0YQSckdJQElIVCYpTKz9RxGZBISRpT9jBooTDEJUQsyYpSMOCUjj5KRn73_zoQQk3fzISXSyoSHZyOPjnwh3vx5ez0fngOFtx9IBsEIkrBiqXEZqWwni8YWJhutURD3v39NsQ5UYjGxkUqeuLS6NyTEQIUYCsJctzDfPVg0RKMMBRm6LvmjMC-n78ckkHFsKrGpjHQZy3PjzYfxmBiLKQnUJrHkDL9YJ0rsuSCuswtAXLUF5GWpjU03tthpsaVQrL8OzFi5RBCsMuHJKxDulh4_5JlcpzFqp18fcGGeRf9gvncOaWalzUa2e-UVK62uvLqDVg3-Ex-t2vq710ErZN6A3G-FvEO6SZQOUWNYQ7rYtjblernUuJRWaYe5x7eHnHHXJXebYIXWnFea1eZotO5QWL2R34mst7UteEDO-M7c1nCv0XBWJxk7XknYc5TEYT2Hn46W8H1awi4G5G20R034PjXxf4Sa8A5qwroMulSTwUmryaAGmR_Pbf4sbvOe471w-2dym3cZdMnty5Pm9mUNsnc8t71ncdvrOf4Lt38mt70ugy65PTxpbg9rkP3jue0_i9t-z-mfDre9fdzmF95-bnv7uD34Edz2OnDb7zLokttXJ83tqy6XuimaVCUGGzed_Tu5jZ16LLsSYbjE4v5k1EYH-F6rII8tlrd5otwQorGFlxWLSVK6jNUo19_upNVM7GAmXsvEqpn6zUz8cE1divIOpvLbM7FmJr8rPJlPBRK090qvijNrMMlFP2Nu6ShObeHZ_SOV3jUaI5e7ANeHRbXOQbPO_sE6B-2IeTPT4NdEfNms8_JgncN2xF4z0_DXRDxs1nl1-IC47ZD9J6f2sAB0wuy1YuYX_ncw9xuYrzLJ-hSr-49RCALcr7_enkf5g-wDuTSZbs4-q_u86PlDmqneJxkbpHAjV_gKLep1lETGRgEIqze43f72fwAAAP__BW2X9w==

# Check that we also collect stats on the hidden expression index virt column.
statement ok
CREATE INDEX ON data ((a * b))

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKdulIpOSf8OSs2wJGN01hG70sgoKRpq4QmdSSNNJs4MfaF9gnW0iq15JiuRaCom1QHwRyZjScj_PxE-gHsH-lIGAye3mxeEnmi4vFdL6YTubEMvJqdnVJYukkUFA6xjdyhRbEn8CAAgcKAVAIgUIfrilkRkdorTZ5yEPxwjT-BMKnkKhs7XLzNYVIGwTxAC5xKYKAhbxJcYYyRuP5QCFGJ5O0WCZfepw_3me3eA8UJjpdr5QVRFJyQ0lESQwU5pnMbT2PEaliwoh2H9EAhRmqGI0gY0bJmFMyDigZh_n4NyaEmL5ZjCgZs19zn3RS8fhkHNBxKMSrP64uFqNToPD6HcmRWEEUK6cGl4nOF3RoXWlyyQoF8f_9x5bzSCuHyiVaPXIZfWdJjJGOMRaE-X5pvrl3aIlBGQsy8n3ye2lezt5OSCTT1FZiM5mYbSwvjJfvJhNiHWYk0mvlyAl-cl6i3KkgvrcLQLxtCyjK0muXrV250vWGQjn_3Dfr5BJBsEqjpy9A-Bt6fK_ncpWlaLx-vc-leZ78jcXaBaS5ky7v3G7IK1ZanQV1B60awkc-WrX1d8PBbjhsRc8b6Put6Heg10qbGA3GNdDXm9b9uVguDS6l08Zj_vE7RU6475ObdXSLzp5W9q3N0djFQ2H1Pf1CZH2H24IHbY4hOeE7c1sngkYnWJ2I7HjRYU8RHY_1PP7DyQ7fJzvsbEBeJ3uEh-8TnvBrCA_vIDysS7-3wjN4LsIzqKHnx7OdP4ntvOcFP9n-DdjOu_R7y_bhc2H7sIY-OJ7twZPYHvS88CfbvwHbgy793rJ99FzYPqqhD49ne_gktoc9r__DsT3Yx3Z-Fuxne7CP7YOvwfagA9vDLv3esv38ubD9vMsFcoY208pi4yq1fyW_sVKP5XcujJdYXtCsXpsI3xodFbHl9KpIVBhitK70snIyVVuXdQbl6v_7bzUTO5iJ1zKxaqZ-MxM_XFOXooKDqcL2TKyZKewKTxZdAYXuTpvb8vhaVPkXobjdbh3lAS49u8_V1rtCa-VyF-AXfznt6hw06-wfrHPQjpg3Mw2-T8TDZp3Dg3WO2hEHzUyj7xPxqFnn-eED4rdDDh-d2sMC0Alz0IqZn4VfwNxvYD7PJetDqu_eJzEI8D__ense2x_kL8ilzXVz_lHfFUUv7rNc9T7I1CKFS3mLL9ChWSUqsS6JQDizxs3ml_8CAAD__0Nds9o=

# Check that we also collect stats on other hidden columns.
statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKdulIpOSf8OSs2wJGN01hG70sgoKRpq4QmdSSNNJs4MfaF9gnW0iq15JiuRaCom1QHwRyZjScj_PxE-gHsH-lIGAye3mxeEnmi4vFdL6YTubEMvJqdnVJYukkUFA6xjdyhRbEn8CAAgcKAVAIgUIfrilkRkdorTZ5yEPxwjT-BMKnkKhs7XLzNYVIGwTxAC5xKYKAhbxJcYYyRuP5QCFGJ5O0WCZfepw_3me3eA8UJjpdr5QVRFJyQ0lESQwU5pnMbT2PEaliwoh2H9EAhRmqGI0gY0bJmFMyDigZh_n4NyaEmL5ZjCgZs19zn3RS8fhkHNBxKMSrP64uFqNToPD6HcmRWEEUK6cGl4nOF3RoXWlyyQoF8f_9x5bzSCuHyiVaPXIZfWdJjJGOMRaE-X5pvrl3aIlBGQsy8n3ye2lezt5OSCTT1FZiM5mYbSwvjJfvJhNiHWYk0mvlyAl-cl6i3KkgvrcLQLxtCyjK0muXrV250vWGQjn_3Dfr5BJBsEqjpy9A-Bt6fK_ncpWlaLx-vc-leZ78jcXaBaS5ky7v3G7IK1ZanQV1B60awkc-WrX1d8PBbjhsRc8b6Put6Heg10qbGA3GNdDXm9b9uVguDS6l08Zj_vE7RU6475ObdXSLzp5W9q3N0djFQ2H1Pf1CZH2H24IHbY4hOeE7c1sngkYnWJ2I7HjRYU8RHY_1PP7DyQ7fJzvsbEBeJ3uEh-8TnvBrCA_vIDysS7-3wjN4LsIzqKHnx7OdP4ntvOcFP9n-DdjOu_R7y_bhc2H7sIY-OJ7twZPYHvS88CfbvwHbgy793rJ99FzYPqqhD49ne_gktoc9r__DsT3Yx3Z-Fuxne7CP7YOvwfagA9vDLv3esv38ubD9vMsFcoY208pi4yq1fyW_sVKP5XcujJdYXtCsXpsI3xodFbHl9KpIVBhitK70snIyVVuXdQbl6v_7bzUTO5iJ1zKxaqZ-MxM_XFOXooKDqcL2TKyZKewKTxZdAYXuTpvb8vhaVPkXobjdbh3lAS49u8_V1rtCa-VyF-AXfznt6hw06-wfrHPQjpg3Mw2-T8TDZp3Dg3WO2hEHzUyj7xPxqFnn-eED4rdDDh-d2sMC0Alz0IqZn4VfwNxvYD7PJetDqu_eJzEI8D__ense2x_kL8ilzXVz_lHfFUUv7rNc9T7I1CKFS3mLL9ChWSUqsS6JQDizxs3ml_8CAAD__0Nds9o=

# Check that we can disable stats collection on virtual computed columns.
statement ok
SET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled = false

statement error cannot create statistics on virtual column
CREATE STATISTICS s1 ON e FROM data

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV1Fvm0gQfr9fsZqnVloHdsGOw1Nybk-yqlwr2-rLyao2MKXImOV2F6W5yD_r_sD9shNQaiBAjaJWtVQ_IO_MMDvfzPct8Aj67xg8WKxe32xek_XmZrNcb5aLNdGM_LF6e0sCYQRQSGSAf4o9avD-AgYUOFBwgIILFKawpZAq6aPWUuUhj8UNy-AzeDaFKEkzk5u3FHypELxHMJGJETzYiLsYVygCVJYNFAI0IoqLbfKtr_PLh3SHD0BhIeNsn2iPCEruKPEpCYDCOhW5bWIxIpKAMCLNJ1RA4c17klehPZKwcqkwjGQebFCb0mSiPXrE_u9fXa59mRhMTCSTJy4l7zUJ0JcBBh5htl2a7x4MaqJQBB6Z2zb5vTSHq3cL4os41rXYVESqiuWF8fb9YkG0wZT4MksMeYGfjRUl5qVHbOsYgLjrCyjKkplJM1PutD1QKNdfeq6NCBE8VhvS8hV49oGePqe12KcxKmvanFFpXkf_YLF3AWlthPHINTv-5TUrra-cpoPWDe4TH712e8HxFrhpL7gjpiyRKkCFQQPT9tAL_yYMFYbCSGUx-_RGkBfctsld5u_Q6Je1tvQ5Wk0aCmu27BuRQw10Wg1kTXqw02XMniNji00s_kOFzLuEzC5m5E3UIWXeJWX3e0iZj5AyGzOrSsqzM5HyrAGOn05E_iwi8onl_CLiSCLyMbOqiHh5JkS8bIBzTiei8ywiOhPL_UXEkUR0xsyqIuL8TIg4b4BzTyei-ywiuhNr-kOJ6HQRkV843UR0uog4-x5EdEYQ0R0zq4qIV2dCxKsxnxAr1KlMNLbetrt3sls7TVj-Wo5BiOU7vJaZ8vGdkn4RWy7fFokKQ4DalF5WLpZJ5dJGodh__QKqZ2KDmXgjE6tnmrYz8eGaxhTlDKZy-zOxdiZ3LDxRTAUSNPdS7Up1akyKszh_aleOUp-l5_igqLx71FqExwDbgW29zlm7zulgnbN-xLydafZzIr5s13k5WOe8H7HTzjT_ORHP23VeDQvE7ofsPlHt8AEwCrPTi5lfuN_APG1hvsqPrI-xvP8QBeCB_eU36bhUP8hvEKHOz831J3lfFL15SPNT76OINVK4FTt8hQbVPkoibSIfPKMyPBx--z8AAP__7UAjzg==

statement ok
RESET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled

subtest regression_98373

statement ok
CREATE TABLE IF NOT EXISTS t98373 AS
        SELECT
                g::INT2 AS _int2,
                g::INT4 AS _int4,
                g::INT8 AS _int8,
                g::FLOAT8 AS _float8,
                '2001-01-01'::DATE + g AS _date,
                '2001-01-01'::TIMESTAMP + g * '1 day'::INTERVAL AS _timestamp
        FROM
                generate_series(1, 5) AS g;

statement OK
SET vectorize = off

statement OK
SET distsql = always

# These query plans should be disallowed from executing in a distributed
# fashion, even with distsql = always. Check different flavors of EXPLAIN.

query T
EXPLAIN SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN

query T
EXPLAIN(DISTSQL) SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF9r2zAUxd_3KcR5akFh9sq2TE8tSTYMaZLZfhgUEzTr1hOVJU-S6Urwdx-20_1jg90HiftH5_6OTghfDQQ2nw7bm2zHLtZZURYft5es2Gw3q5J5ajrv6oujtvGVENmuXF4KkW8-HPL9it0UrHZm-eY1e5_vb1l8t7x6e3V9l1TgsE7RTrYUIO6QouIYhSgE58fSaRrI1DeIhEPbro9jueKonSeIE6KOhiBQys-GcpKK_MsEHIqi1GaSPS-cr2P3QE_gWDnTtzYINjGDo-jkmC7AkZNV5MUPW9fp2ROqgcP18SdGiLIhiPQX7mwNkQz8_9FzCp2zgX6j_tem5I9Ni3SoOEg1NP9XcL2v6eBdPc3O6X4SmgqKQpy76Zxk9rkVoifZzvgVx71xj0etIJCcY_GX4zkwPpBNGI0VX9zjJFs-dSPWvTSBOG7lA60pkm-11SHqGiL6nobhxfcAAAD__wgUvrk=

statement OK
RESET vectorize

statement OK
RESET distsql
