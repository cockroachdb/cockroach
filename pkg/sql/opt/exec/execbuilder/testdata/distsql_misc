# LogicTest: 5node

subtest scrub

# TODO(radu): rework or remove these tests (the inner ORDER BY is ignored by
# the optimizer).
#
# # Verify the index check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
#     FROM
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
#     FULL OUTER JOIN
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
#       ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
#     WHERE (leftside.k IS NULL) OR
#           (rightside.k IS NULL)
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLBlIJDs9CAq6dCFLGpdscio-uNY0a3AkM5Khy5J3L45hNw5x2vQ4I33zzc8bOG9pXRwogP4BEnKEhn1JIXjuUv2Hpf0Neo5QuaaNXTpHKD0T6DeIVawJNGyLnzVtqLDEszkgWIpFVZ_KNlwdCn41kUIEhKyNWhiFRqJJID8i-DZ-FA6x2BNoecR_lz97jsQzOfQaOUWjpmiS6ahG3aM5n1ENXYFK7-zdUyb_MWUyPiXCoYjli6jJaaFGremo9UPWOs-WmOzAlnfk375caf0b8Z6efOWIZ-mw_-1rQ1o87lYrke22XzfiKVuuAaGmX3FyNtzDF672L8MUIDxWdSTWYmKUWD6L9W61ehDZRkzM4j1-P4fE7iIJmhTNAs3n0Q0t7rnLhkLjXaDLTV2tPO_WQ3ZP_bqDb7mk7-zLk6YPsxN3SlgKsX-VfbB0_VPX4Dksb8LpAJaXsLoJJ7fNyR1mdQmnN-HFhTk_fvoTAAD__3P7gDg=
#
# # Verify the foreign key check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE parent (
#   id INT PRIMARY KEY,
#   id2 INT,
#   UNIQUE INDEX (id, id2)
# )
#
# statement ok
# CREATE TABLE child (
#   child_id INT PRIMARY KEY,
#   id INT,
#   id2 INT,
#   FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
# )
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT p.child_id, p.id, p.id2
#     FROM
#       (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
#     FULL OUTER JOIN
#       (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
#       ON p.id = c.id AND p.id2 = c.id2
#     WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
#           c.id IS NULL AND c.id2 IS NULL
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nID1bi9BAYZbAWL0-G8T0PEmXNtqEskidBS_O7DCGstvRvdY345__wO5-QRtJFYdL_QAf8BCTQUJmt6dM7YFW0FmbwHHlNQepr9ihsKvbEI_BG88iMCh7r7OWKFnUR7FQMFib5TY3i2v1WjbLvZm1Zpifft-a5VsrV4bqfOovYiVECzUDCzf3I43w0IPFno__WR7PvYZKtaSdbe4YPYyEUxuyh-8s3aWIkW5c7VrMl_lbzS_Ve0A94YpdFesX339cOEnFyf8pyUp_pLRW7KrAAKI559JNiRivR4-GjVcOsjkRypYMcDULhWo0fLSRRFgpHsOynKmhSnPD-QsiKRSHfsQD4Vn0kk3gf6nHz4Q4BCOXtOREIFoyK9OL70LXur0E1GO3w5xldfjtfZoRxw24Uzs-3xmzV90GzHMuQCkOj8dsu2Q6bDVfhYz8PJG8LsZZj9NZzuwvHSLO9-BwAA__9_viDb

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/66>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

query T
EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
distribution: full
vectorized: false
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lVtvmzAUx9_3Kazz1EpGYCA3PzVqOwmptwUeJk1R5YbTFJVgZht1XZXvPjlZ1sIKSpDCAwIDv_Pz3xfeQP_MgcPl97uraXRDTi6iOIm_XZ2S89nlNLkkcTJNojiJzmOiGbm9IYJ8nd1ek1QYARQKmeKNWKEG_gMYUPCBQgAUQqAwgDmFUskFai2VfeVt80GU_gLuUciKsjK2eU5hIRUCfwOTmRyBQyIecpyhSFG5HlBI0Ygs35Sxpc_s6b58xlegcC7zalVoTqxRXAp76biMiCIljEjzhArmawqyMu8FtRFLBM4-GEYXwL013V8yFqsyR-UO6oLb5jj7jZwwz_Osf2yE4eSMtYr4DZFBq8h7_aqQKkWFaa3-fN2qOl0uFS6Fkcpl3v7S5MT3PPJQLZ7R6NPWLgSNLrB6mGz_EWc9Rtxljuv3GnN2iOZuzIdHGPNhTcTfPy-_T16-4wa98vIP0dzlNTpCXqOaSLB_XkGfvALHDXvlFRyiuctrfIS8xjWRcP-8wj55hY476JVXeIjmLq_JEfKaHPIzmKEuZaGxsRd_XslrVHKY3bQxXeJ2h9eyUgu8U3KxeXd7e7sBbRpS1Gb7lG1vomL3SBuFYvXvX_aRxDpJfo3EPpIGTZLf7XSIVNCJCttJrEkK-3Zv2CQNOknDdie_SRr2dRo1SaNO0rjdKWiSxn2dxk3SpHsaeO1S4X9zs3uad1hN7NJ5zOXLfZYCB-_v4Xxy2h1gPxBLbddv_CRfNtjktbSr71HkGilci2e8QINqlRWZNtkCuFEVrtdf_gQAAP__uYub4w==

statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsltGOmzgUhu_3Kaxz1UpkwAYyGV91Nu1KUTWdKkS9WY0qD5xSFGKzttF0dpTH2hfYJ1sBZSehkIaokXrRXKDYPpzz_5zPlp_A_JUDh_nyzfXqDYlW16tFtFrMI2IouX1HBPljeXtDEmEFOCBVgu_EBg3wP4GCAwwc8MGBABwI4c6BQqsYjVG6CnmqX1gkX4B7DmSyKG01fedArDQCfwKb2RyBw0rc57hEkaB2PXAgQSuyvC5TlX5VPT4Wa3wEB-YqLzfScFIpigpR_Z24lAiZEEqU_YwaHHj7gVTFDSeSNkONaaaqYIvGNlM22yAn3r__mGYcK2lR2kzJb5a0ejAkwVglmHBCPa-Zvn-0aIhGkXAy8zzyezOdLt_PSSzy3OzEFiLTbSyrJ28-zOfEWCxIrEppyQv8Yt1M2peceO5zAOJ6KKCWpUpblLapdLd1oBl__dTGihSB053eLF4D97bO8e2JxKbIUbvhfmua6Sj7G-vataXICsvJKzoohHWEhINCnuuXUukENSZ79e-2g1Kv01RjKqzSLvWOF01eMM8j92W8RmteDlrwOxbo_sekx7NOT2DdpROXDdPOfjztrI92ejElb7Me3lkf78E5eGcjeKdjWtTyPj0D79M9Iex4VtgprLCJ6w-z4v9ipY8VNqZFLSuXZ2Dlck-Ifzwr_ims-BM3GGYl-MVKHyv-mBa1rMzOwMpsT0hwPCvBKawEEzccZiX88az4faywC7-fFb-Plek5WPFHsBKMaVHLytUZWLkac_lboimUNNi5e_VX8jqVJrS6pGGSYnOjM6rUMb7XKq5jm-FtnaieSNDYZpU2g4Vsl4zVKDb_3113M9GDmdheJrqbKexmYoc1jRHlH0wVDGei3UzBWHui7gpItA9Kr5udZFDWR1t15WwXmr3UrDyfu-3qBo0R6XNARfquzmlXZ3hQ53TYMetmmv6cji-7Oi8P6pwNO_a7mWY_p-NZV-fV4Q3iDVsOvtm1hw-AUZ79Qc_sIviO57Dj-ao6sj7l6uFjlgAH7-tv0vNof1C9IFJTnZvRZ_VQi149FtWp90nkBh24EWt8jRb1JpOZsVkM3OoSt9vf_gsAAP__RO6Rtg==

query T retry
EXPLAIN (DISTSQL, TYPES) SELECT * FROM data
----
distribution: full
vectorized: true
·
• scan
  columns: (a int, b int, c float, d decimal)
  estimated row count: 1,000 (100% of the table; stats collected <hidden> ago)
  table: data@data_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklEFvmz4UwO__T2G903-TERjIDpw2NZmElKZZ4LBpiioXv6aogJlt1FUR330ydGtBSYWID5bs5_zeLw8_H0H_KiCC1fft-ku8If8v4yRNvq0pSX9sV8kHkqzWq6uUfCRfdzfXRHDDgUIlBW54iRqin8CAgg8UAqAQAoUF7CnUSmaotVT2yLH7QSx-Q-RRyKu6MXZ7TyGTCiE6gslNgRBByu8K3CEXqFwPKAg0PC-6NDb1Zzvd1o_4DBSuZNGUlY4Ip-SOkowSARSSmts9x2WEV4IwIs0DKti3FGRjXjNrww8IEXujGi8h8lp6xvZVsqmkEqhQDAXzygB9me8LyU0XzvKSF7BvT_zZjXRk7S4GlHOe_shzMfBk06vKLqmqyxzXn1VXNvD1p_v6F_n6jhvM8vUHvsF03-Ai38Bxw1m-wcA3nO4bXuQbOu5ilm94ts9O-O5Q17LSOKlTvFEmh9neQ3HAvou1bFSGWyWz7my_vOlA3YZAbfoo6xdx1YWYzaCQl_-eibck9i7p04DkvUvy5zqxMSmYS_LHpHAuKRiTFnNJof2K94V8us0FROC9DOfE9Hd07zA_aHuVkgf51GHT59peBKMapHDNH3GJBlWZV7k2edYH2va_PwEAAP__DBRFDg==

# Check that we properly render virtual computed columns when collecting stats.
statement ok
ALTER TABLE data ADD COLUMN e INT AS (b + 1) VIRTUAL

statement ok
CREATE INDEX ON data (e)

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgQve9XEHNqsXQkUrLj8OSs2wWMIm1hG70sjIKRpq5gWdSSNNJs4M_aH9gvW0iqakmRXAtugQaID4I4MxrOm3l8Bh_A_B2DgOn89fXyNVksr5ezxXI2XRDDyJ_zdzcklFYChUSF-FZu0YD4CxhQ4EDBAwo-UBjCikKqVYDGKJ2FPOQfzMIvIFwKUZLubGZeUQiURhAPYCMbIwhYytsY5yhD1I4LFEK0MorzbbKtJ9njY7rBe6AwVfFumxhBJCW3lASUhEBhkcrMNnAYkUlIGFH2M2qgMMckRC3IhFEy4ZRMPEomfvb-OxNCzN4ux0DhzQeS1WoESVix1LiOVJbSorGFyUZbFMT9719TrAOVWExspJJHLq3uDAkxUCGGgjDXLcy39xYN0ShDQcauS_4ozOv5-ykJZBybSmwqI13G8tx482E6JcZiSgK1Syx5gV-sEyX2pSCucwhA3HQF5GWpnU13tthptadQrL9Oxli5RhCsMsrZKxDunp4-zYXcpjFqZ1ifZGFeRP9gvncOaWGlzWZzeOUVK62uvLqDVg3-Ix-t2oadOHkD57AT5wHeLlE6RI1hDd5q39mJ6_Va41papR3mnt4T8oK7LrndBRu05mWlQ12ORr-OhdW7953Iei8bwV2d9RqdZXUKsdMFgZ0jCA4bOPxcSeA_XhJ4mySwixF5E7WIAm8TBf9niALvIQqsz0RLURg9PVEY1XDy05nLz2IuHzjeucz1npnbxlzeZ6Ilcy-fHnMvazi905nrncVcb-D45zLXf2ZuG3O9PhMtmTt-eswd13D6pzPXP4u5_sAZnsvc4Y9nrtfGXH7htTPXa2Pu6Gcw1-vBXL_PREvmXj095l71uSrN0aQqMdi4SrTv5DZ2GrDszoHhGosLilE7HeB7rYI8tli-yxPlhhCNLbysWMyS0mWsRrn9dtOrZmJHM_FaJlbNNGxm4sdr6lOUdzSV352JNTP5feHJfCqQoL1TelMcVINJruOZEpSO4qgWnsOfTOndojFyfQhwfVhV6xw16xwerXPUjZg3M41-TcSXzTovj9Y57kbsNTONf03E42adV8cPiNsN2X90ao8LQC_MXidmfuF_B_Owgfkqk6xPsbr7GIUgwP36G7Q8yh9kH8i1yXRz8Vnd5UUv79NM9T7J2CCFG7nBV2hRb6MkMjYKQFi9w_3-t_8DAAD__0sKZOU=

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON c, e, a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl9Fu2zYUhu_3FMS52jC6EinZcXjlzO0Ao0hS2EZvBqNgpFNViExqJI00C_xYe4E92UApbm1VNiwjLnpRXQjgIXX4H53vF6gnsH8XIGA8fXM1f0Nm86v5ZDafjGfEMnJ7QxJKkBJJ_pzeXpNUOgkUlE7xRi7RgvgLGFDgQCECCjFQ6MOCQml0gtZq45c8VQ9M0s8gQgq5KlfOhxcUEm0QxBO43BUIAubyrsApyhRNEAKFFJ3Mi2obv_XI3z6U9_gIFMa6WC2VFURSL_IOKMxK6QO9gBGpUsKIdp_QAIUpqhSNICNGyYhTMop-Z0KIyc18CBTevideoBVEsXpoMMu1T-XQujrk8iUKEv73r63HiVYOlcu1-mbK6AdLUkx0iqkgLAzr8N2jQ0sMylSQYRiSP-pwNn03JoksCru1tpS52azlVfD6_XhMrMOSJHqlHPkVP7sgV-43QcLg6wLE-30LKll65cqVq3darCnU4-d2WCczBMG2-jd5DSJc0-NbOJPLskAT9HfbV4dn-T_-TflWOemqfow4HUV7pfCGlP5eKV8VrJQ2KRpMdxQs1nvFXmWZwUw6bQIWvojsqCGb7b5CdrwL2MkuCFgv4Kf6gL-8D3ibD9irAXmbtziBtzkhPocTeAcnsC5t3DhhcBYnDHak8OOJ4qcTxXtBdCpR0U-i2ojiXdq4IeriLERd7EiJjicqOp2oqBfEpxIV_ySqjaioSxs3RA3PQtRwR0p8PFHx6UTFvaB_KlH9lycqaiOKv4raiYraiBqcg6ioA1FxlzZuiLo8C1GXXY6iU7SlVhYb58D2ncLGTj3mD4yYZlifLq1emQTfGZ1Ua-vhbZWoCqRoXT3L6sFEbaasMyiXX07S25nYwUx8JxPbztRvZuKHNXURFR1MFe_PxJqZ4q7lyaoroNA9aHNfe8mi8j8s_r_zOVx7qY4Pq_-ozcwSrZXZl8kQFtv6Bk19_YP6Bvsr5c1Mgx-r0oumvouD-ob7K42amYY_VqXDpr7Lw0YI95caf-POw0b_7rVe-k_Sx0I_fMhTEBA-X72W2-YC_4DMrP8uzj7ph0rs_LH0X7WPsrBI4Vre42t0aJa5yq3LExDOrHC9_uX_AAAA__8-arW_

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON e FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsVsFu2zgQve9XEHNqsXIkUrLj8NSs2wWMIklhG70sgoIRp6pgmdSSFNJs4M_aH9gvW0iqNrYqea2gBnqIDoI5HM2853mP4CPYPzPgMFu8u1y9I8vV5Wq-XM1nS2IpubkmSH5f3FwRKZwAD5SWeC02aIH_ARQ8YOBBCB5E4MEYbj3IjY7RWm3KlMfqg7n8CjzwIFV54crwrQexNgj8EVzqMgQOK3GX4QKFROMH4IFEJ9KsalO2flO-PuVrfAAPZjorNspycgceLHNR_hz5lAglCSXafUEDHixQSTScvKG_Us75_Ho1BQ_efyQlJMuJovXSYJLqsoRD6-qQSzfISfDP37Zex1o5VC7V6rsto-8tkRhriZITGgR1-O7BoSUGheRkGgTktzqcLD7MSCyyzO7k5iI1TS6rglcfZzNiHeYk1oVy5BV-dX6q3GtOAv8pAXHdl1DB0oXLC1d3ut16UK-_DcA6kSBwujOx-VvgwdY7fmhLsckzNP54f2B1eJn-hVXvitLSCVfOohcIawEZ9wJ56l8obSQalHv9b7e9UC-TxGAinDY-DY4HTV6xICB3RbxGZ1_3UghbFOj-n0mPdwB9hgN8OvLZUA-wH-8B1uUBejYh79MOF7AuF0SncAEb4AI6ZHCNCyYncMFkDwg7XkHsOQpiIz8cqqDwRUFdCmJDBtco6PwECjrfAxIer6DwOQoKR340VEHRi4K6FBQOGVyjoOkJFDTdAxIdr6DoOQqKRv54qILGP15BYZeC2FnYraCwS0GTUygoHKCgaMjgGgVdnEBBF0MulQu0uVYWW3e67k5Bq9OIlpc_lAnWN0WrCxPjB6PjKrde3lSFqoBE6-pdWi_mqtmyzqDY_Hcn3q1ED1Zie5XobqVxuxI7jGkIqPBgqai_Em1XiobSE9VUQKG712ZdO8miqg688irbbNReqneeTuNmd4PWiuQpoVT6Ls5JG-f4IM5JP2PWrjT5ORmft3GeH8Q57WcctitNf07G0zbOi8MGCfopR9-59vABMIhz2MuZnUX_w3nc4nxRHlmfM33_KZXAIfj2jDpezQPlByKx5bm5_KLvK9Crh7w89T6LzKIHV2KNb9Gh2aQqtS6NgTtT4Hb7y78BAAD__14Nrqc=

statement ok
ALTER TABLE data ADD COLUMN f FLOAT AS (atan2d(c, d::float)) VIRTUAL

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON f, e, d FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl8Fu2zgQhu_7FMScWixdiZTsODw567aA0U1S2EYvC6NgxIkrRCa1JI00G_ix9gX2yRaS4tZWZcMK7KKH6CCAQ2r4j-b7BeoR3N8ZCBiO311M35HJ9GI6mkxHwwlxjFxfkVtKkBJF3o-vL4mSXgIFbRReyQU6EH8BAwocKERAIQYKXZhRyK1J0DljiyWP5QMj9RVESCHV-dIX4RmFxFgE8Qg-9RmCgKm8yXCMUqENQqCg0Ms0K7cpth4Ut8_5HT4AhaHJlgvtBFGU3FCSAIVJLotAJ2BEakUYMf4LWqAwRq3QCjJglAz470wIMbqa9imRXmquXg0iOmBCvP_z-mLafw0UPnwihWYniGbV0OI8NUV2j85XIZ8uUJDwv39dNU6M9qh9avQPU9bcO6IwMQqVICwMq_DNg0dHLEolSD8MyR9VeD7-OCSJzDK3sTaXqV2v5WXw8tNwSJzHnCRmqT15hV99kGr_WpAw-L4A8W7XglKWWfp86audZisK1fipQ87LOYJgGy0dvQURrujhXZ3IRZ6hDbrbHa3Ck_Sf4k0V3fPSly0acDqIdkrhNSndnVK-K1hqYxVaVFsKZqudYi_mc4tz6Y0NWHgU2VFNNtt-hexwY7BnGyNgnYAf0Rr8-NbgTdZgb3rkQ9pgDt5kjvgU5uAtzMHadHZtjt5JzNHbksIPh4w_HzLeCaIjQha9QNYEGW_T2TVkZyeB7GxLSnQ4ZNHzIYs6QXxEyOIXyJogi9p0dg1Z_ySQ9bekxIdDFj8fsrgTdI8IWff4kEVNkPE3UTNkURNkvVNAFrWALG7T2TVk5yeB7LzNsXaMLjfaYe1M2bxTWNupw4rDJ6o5VidVZ5Y2wY_WJOXaanhdJioDCp2vZlk1GOn1lPMW5eLbqXwzE9ubiW9lYpuZuvVMfL-mNqKivani3ZlYPVPctjxZdgU0-ntj7yovOdTFz0_xW_sUrrxUxfvlP9l6ZoHOyfm3yRBmm_p6dX3dvfp6uyvl9Uy9X6vSs7q-s736-rsrjeqZ-r9Wpf26vvP9Rgh3lxr_4M79Rv_ptZ4Xn6TbzNx_ThUICJ-uTsNtfUHxgJy74rs4-WLuS7HTh7z4qt3KzCGFS3mHb9GjXaQ6dT5NQHi7xNXqt_8DAAD__7WI0EY=

statement ok
CREATE TYPE gh AS (g INT, h INT)

# Try a virtual computed column whose expression cannot be distributed.
statement ok
ALTER TABLE data ADD COLUMN g gh[] AS (array_cat(ARRAY[(1, 2)], ARRAY[(a, b)])) VIRTUAL

# Error if we specify the problematic virtual computed column directly.
statement error cannot be executed with distsql
CREATE STATISTICS s1 ON g FROM data

# We should skip the problematic virtual computed column when using defaults.
query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgQve9XEHNKsHQkUrLj8OSs2wJGN01hG70sjIKRpq5gWdSSNNJs4M_aH9gvW0iqa0mRXAupgQaoD4I4MxrOm3l8Bh_B_B2DgPH09fX8NZnNr-eT2XwynhHDyJvp7Q0JpZVAIVEhvpNrNCD-AgYUOFDwgIIPFPqwoJBqFaAxSmchj_kHk_ALCJdClKQbm5kXFAKlEcQj2MjGCALm8i7GKcoQteMChRCtjOJ8m2zrUfb4mK7wASiMVbxZJ0YQSckdJQElIVCYpTKz9RxGZBISRpT9jBooTDEJUQsyYpSMOCUjj5KRn73_zoQQk3fzISXSyoSHZyOPjnwh3vx5ez0fngOFtx9IBsEIkrBiqXEZqWwni8YWJhutURD3v39NsQ5UYjGxkUqeuLS6NyTEQIUYCsJctzDfPVg0RKMMBRm6LvmjMC-n78ckkHFsSrGpjPQulufGmw_jMTEWUxKoTWLJGX6xTpTYc0FcZx-AuGoLyMtSG5tubLHTYkuhWH8dmLFyiSBYacKTVyDcLT1-yDO5TmPUTr864MI8i_7BfO8c0sxKm41s_8pLVlpeeVUHLRv8Jz5atvX3r4NWyLwGud8KeY90kygdosawgnSxbW3K9XKpcSmt0g5zj28POeOuS-42wQqtOS81q81Ra92hsGojvxNZbWtb8ICc8b25reFereGsSjJ2vJKw5yiJw3oOP5GW8B-vJbxJS9jFgLyNGtSEN6mJfwo14R3UhHUZ9E5NBi9aTQYVyPx4bvNncZv3HO9E3PZ-cbuJ27zLoHfcvnzR3L6sQPaO57b3LG57Pcc_Ebf9X9xu4rbXZdA7bg9fNLeHFcj-8dz2n8Vtv-f0T8Tt_o_nttfEbX7hNXPba-L24BTc9jpw2-8y6B23r140t6-6XOqmaFKVGKzddJp3cms79Vh2JcJwicX9yaiNDvC9VkEeWyxv80S5IURjCy8rFpNk5zJWo1x_u5OWM7GDmXglEytn6tcz8cM1dSnKO5jKb8_E6pn8rvBkPhVI0N4rvSrOrMEkF_2MuTtHcWoLz_4faeddozFyuQ9wfViU6xzU6-wfrHPQjpjXMw1-TsSX9TovD9Y5bEfs1TMNf07Ew3qdV4cPiNsO2X9yag8LQCfMXitmfuF_B3O_hvkqk6xPsbr_GIUgwP366zU8dj_IPpBLk-nm7LO6z4ueP6SZ6n2SsUEKN3KFr9CiXkdJZGwUgLB6g9vtb_8HAAD__231mAE=

# Check that we also collect stats on the hidden expression index virt column.
statement ok
CREATE INDEX ON data ((a * b))

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKdulIpOSf8OSs2wJGN01hG70sgoKRpq5gWdSSNNJs4MfaF9gnW0iq15IiuRZSA0VQHwRyZjScj_PxE-hHMH_FIGAye321eE3mi6vFdL6YTubEMPJmdnNNQmklUEhUiO_kGg2IP4EBBQ4UPKDgA4U-3FJItQrQGKWzkMf8hWn4BYRLIUrSjc3MtxQCpRHEI9jIxggCFvIuxhnKELXjAoUQrYzifJls6XH2-Jiu8AEoTFS8WSdGEEnJHSUBJSFQmKcys_UcRmQSEkaU_YwaKMwwCVELMmaUjDklY4-SsZ-Nf2NCiOm7xYiSMfs180krEx6ejT069oV488fN1WJ0DhTefiAZEiNIwoqpxmWksgUtGluYbLRGQdx__zHFPFCJxcRGKnni0urekBADFWIoCHPdwnz3YNEQjTIUZOS65PfCvJy9n5BAxrEpxaYy0rtYnhuvP0wmxFhMSaA2iSVn-MU6UWLPBXGdfQDiqi0gL0ttbLqxxUq3WwrF_GvfjJVLBMFKjZ6-AuFu6fG9nst1GqN2-tU-F-Z59Dfma-eQ5lbarHP7IS9ZaXnmVR20bPCf-GjZ1t8PB_vhsBU9r6Hvt6Lfg94kSoeoMayAvt227s_VcqlxKa3SDnOP3ylyxl2X3G2CFVpzXtq3NkdtFw-FVff0G5HVHW4LHrQ5huSM781tnfBqnWBVIrLjRYc9R3Qc1nP4aWWHf3_Z4U2ywy4G5G3UIDy8SXj8UwgP7yA8rEu_d8IzeCnCM6ig58eznT-L7bzneKdlu_eT7U1s5136vWP78KWwfVhB7x3Pdu9ZbPd6jn9atvs_2d7Edq9Lv3dsH70Uto8q6P3j2e4_i-1-z-mflu397892r4nt_MJrZrvXxPbBKdjudWC736XfO7ZfvhS2X3a5QM7QpCoxWLtKNa_k1lbqsezOheESiwuaURsd4Hutgjy2mN7kiXJDiMYWXlZMpsnOZaxGuf7__lvOxA5m4pVMrJypX8_ED9fUpSjvYCq_PROrZ_K7wpN5VyBBe6_0qji-BpPsi5DfbneO4gAXnv3nauddozFyuQ9w87-c9nUO6nX2D9Y5aEfM65kGPybiYb3O4cE6R-2IvXqm0Y-JeFSv8_LwAXHbIftPTu1hAeiE2WvFzC_8b2Du1zBfZpL1KVb3H6MQBLhff72Gx-4H2QtyaTLdnH9W93nRi4c0U71PMjZI4Vqu8BVa1OsoiYyNAhBWb3C7_eW_AAAA__-tB7Pk

# Check that we also collect stats on other hidden columns.
statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKdulIpOSf8OSs2wJGN01hG70sgoKRpq5gWdSSNNJs4MfaF9gnW0iq15IiuRZSA0VQHwRyZjScj_PxE-hHMH_FIGAye321eE3mi6vFdL6YTubEMPJmdnNNQmklUEhUiO_kGg2IP4EBBQ4UPKDgA4U-3FJItQrQGKWzkMf8hWn4BYRLIUrSjc3MtxQCpRHEI9jIxggCFvIuxhnKELXjAoUQrYzifJls6XH2-Jiu8AEoTFS8WSdGEEnJHSUBJSFQmKcys_UcRmQSEkaU_YwaKMwwCVELMmaUjDklY4-SsZ-Nf2NCiOm7xYiSMfs180krEx6ejT069oV488fN1WJ0DhTefiAZEiNIwoqpxmWksgUtGluYbLRGQdx__zHFPFCJxcRGKnni0urekBADFWIoCHPdwnz3YNEQjTIUZOS65PfCvJy9n5BAxrEpxaYy0rtYnhuvP0wmxFhMSaA2iSVn-MU6UWLPBXGdfQDiqi0gL0ttbLqxxUq3WwrF_GvfjJVLBMFKjZ6-AuFu6fG9nst1GqN2-tU-F-Z59Dfma-eQ5lbarHP7IS9ZaXnmVR20bPCf-GjZ1t8PB_vhsBU9r6Hvt6Lfg94kSoeoMayAvt227s_VcqlxKa3SDnOP3ylyxl2X3G2CFVpzXtq3NkdtFw-FVff0G5HVHW4LHrQ5huSM781tnfBqnWBVIrLjRYc9R3Qc1nP4aWWHf3_Z4U2ywy4G5G3UIDy8SXj8UwgP7yA8rEu_d8IzeCnCM6ig58eznT-L7bzneKdlu_eT7U1s5136vWP78KWwfVhB7x3Pdu9ZbPd6jn9atvs_2d7Edq9Lv3dsH70Uto8q6P3j2e4_i-1-z-mflu397892r4nt_MJrZrvXxPbBKdjudWC736XfO7ZfvhS2X3a5QM7QpCoxWLtKNa_k1lbqsezOheESiwuaURsd4Hutgjy2mN7kiXJDiMYWXlZMpsnOZaxGuf7__lvOxA5m4pVMrJypX8_ED9fUpSjvYCq_PROrZ_K7wpN5VyBBe6_0qji-BpPsi5DfbneO4gAXnv3nauddozFyuQ9w87-c9nUO6nX2D9Y5aEfM65kGPybiYb3O4cE6R-2IvXqm0Y-JeFSv8_LwAXHbIftPTu1hAeiE2WvFzC_8b2Du1zBfZpL1KVb3H6MQBLhff72Gx-4H2QtyaTLdnH9W93nRi4c0U71PMjZI4Vqu8BVa1OsoiYyNAhBWb3C7_eW_AAAA__-tB7Pk

# Check that we can disable stats collection on virtual computed columns.
statement ok
SET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled = false

statement error cannot create statistics on virtual column
CREATE STATISTICS s1 ON e FROM data

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV1Fvm0gQfr9fsZqnVloHdsGOw1Nybk-yqlwr2-rLyao2MKXImOV2F6W5yD_r_sD9shNQaiBAjdJKtVQ_IO_MMDvfzPct8Aj67xg8WKxe32xek_XmZrNcb5aLNdGM_LF6e0sCYQRQSGSAf4o9avD-AgYUOFBwgIILFKawpZAq6aPWUuUhj8UNy-AzeDaFKEkzk5u3FHypELxHMJGJETzYiLsYVygCVJYNFAI0IoqLbfKtr_PLh3SHD0BhIeNsn2iPCEruKPEpCYDCOhW5bWIxIpKAMCLNJ1RA4c17klehPZKwcqkwjGQebFCb0mSiPXrE_u9fXa59mRhMTCSTJy4l7zUJ0JcBBh5htl2a7x4MaqJQBB6Z2zb5vTSHq3cL4os41rXYVESqiuWF8fb9YkG0wZT4MksMeYGfjRUl5qVHbOsYgLjrCyjKkplJM1PutD1QKNdfeq6NCBE8VhvS8hV49oGePqe12KcxKmvanFFpXkf_YLF3AWlthPHINTv-5TUrra-cpoPWDe4TH712e8HxFrhpL7gjpiyRKkCFQQPT9tAL_yYMFYbCSGUx-_RGkBfctsld5u_Q6Je1tvQ5Wk0aCmu27BuRQw10Wg1kTXqw02XMniNji00s3i9k_v2FzLuEzC5m5E3UIWXeJWX3R0iZj5AyGzOrSsqzM5HyrAGOn05E_iwi8onl9BPR-UXELiLyMbOqiHh5JkS8bIBzTiei8ywiOhPL7Sei-4uIXUR0xsyqIuL8TIg4b4BzTyei-ywiuhNr2k_E6fcnotNFRH7hdBPR6SLi7EcQ0RlBRHfMrCoiXp0JEa_GfEKsUKcy0dh62-7eyW7tNGH5azkGIZbv8Fpmysd3SvpFbLl8WyQqDAFqU3pZuVgmlUsbhWL_9QuonokNZuKNTKyeadrOxIdrGlOUM5jK7c_E2pncsfBEMRVI0NxLtSvVqTEpzuL8qV05Sn2WnuODovLuUWsRHgNsB7b1OmftOqeDdc76EfN2ptnPifiyXeflYJ3zfsROO9P850Q8b9d5NSwQux-y-0S1wwfAKMxOL2Z-4X4D87SF-So_sj7G8v5DFIAH9pffpONS_SC_QYQ6PzfXn-R9UfTmIc1PvY8i1kjhVuzwFRpU-yiJtIl88IzK8HD47f8AAAD__1G9I9g=

statement ok
RESET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled

subtest regression_98373

statement ok
CREATE TABLE IF NOT EXISTS t98373 AS
        SELECT
                g::INT2 AS _int2,
                g::INT4 AS _int4,
                g::INT8 AS _int8,
                g::FLOAT8 AS _float8,
                '2001-01-01'::DATE + g AS _date,
                '2001-01-01'::TIMESTAMP + g * '1 day'::INTERVAL AS _timestamp
        FROM
                generate_series(1, 5) AS g;

statement OK
SET vectorize = off

statement OK
SET distsql = always

# These query plans should be disallowed from executing in a distributed
# fashion, even with distsql = always. Check different flavors of EXPLAIN.

query T
EXPLAIN SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN

query T
EXPLAIN(DISTSQL) SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF9r2zAUxd_3KcR5akFh9sq2TE8tSTYMaZLZfhgUEzTr1hOVJU-S6Urwdx-20_1jg90HiftH5_6OTghfDQQ2nw7bm2zHLtZZURYft5es2Gw3q5J5ajrv6oujtvGVENmuXF4KkW8-HPL9it0UrHZm-eY1e5_vb1l8t7x6e3V9l1TgsE7RTrYUIO6QouIYhSgE58fSaRrI1DeIhEPbro9jueKonSeIE6KOhiBQys-GcpKK_MsEHIqi1GaSPS-cr2P3QE_gWDnTtzYINjGDo-jkmC7AkZNV5MUPW9fp2ROqgcP18SdGiLIhiPQX7mwNkQz8_9FzCp2zgX6j_tem5I9Ni3SoOEg1NP9XcL2v6eBdPc3O6X4SmgqKQpy76Zxk9rkVoifZzvgVx71xj0etIJCcY_GX4zkwPpBNGI0VX9zjJFs-dSPWvTSBOG7lA60pkm-11SHqGiL6nobhxfcAAAD__wgUvrk=

statement OK
RESET vectorize

statement OK
RESET distsql
