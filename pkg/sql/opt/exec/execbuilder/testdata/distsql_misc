# LogicTest: 5node

subtest scrub

# TODO(radu): rework or remove these tests (the inner ORDER BY is ignored by
# the optimizer).
#
# # Verify the index check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
#     FROM
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
#     FULL OUTER JOIN
#       (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
#       ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
#     WHERE (leftside.k IS NULL) OR
#           (rightside.k IS NULL)
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLBlIJDs9CAq6dCFLGpdscio-uNY0a3AkM5Khy5J3L45hNw5x2vQ4I33zzc8bOG9pXRwogP4BEnKEhn1JIXjuUv2Hpf0Neo5QuaaNXTpHKD0T6DeIVawJNGyLnzVtqLDEszkgWIpFVZ_KNlwdCn41kUIEhKyNWhiFRqJJID8i-DZ-FA6x2BNoecR_lz97jsQzOfQaOUWjpmiS6ahG3aM5n1ENXYFK7-zdUyb_MWUyPiXCoYjli6jJaaFGremo9UPWOs-WmOzAlnfk375caf0b8Z6efOWIZ-mw_-1rQ1o87lYrke22XzfiKVuuAaGmX3FyNtzDF672L8MUIDxWdSTWYmKUWD6L9W61ehDZRkzM4j1-P4fE7iIJmhTNAs3n0Q0t7rnLhkLjXaDLTV2tPO_WQ3ZP_bqDb7mk7-zLk6YPsxN3SlgKsX-VfbB0_VPX4Dksb8LpAJaXsLoJJ7fNyR1mdQmnN-HFhTk_fvoTAAD__3P7gDg=
#
# # Verify the foreign key check execution plan uses a merge join.
#
# statement ok
# CREATE TABLE parent (
#   id INT PRIMARY KEY,
#   id2 INT,
#   UNIQUE INDEX (id, id2)
# )
#
# statement ok
# CREATE TABLE child (
#   child_id INT PRIMARY KEY,
#   id INT,
#   id2 INT,
#   FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
# )
#
# query T
# EXPLAIN (DISTSQL)
#     SELECT p.child_id, p.id, p.id2
#     FROM
#       (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
#     FULL OUTER JOIN
#       (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
#       ON p.id = c.id AND p.id2 = c.id2
#     WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
#           c.id IS NULL AND c.id2 IS NULL
# ----
# https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nID1bi9BAYZbAWL0-G8T0PEmXNtqEskidBS_O7DCGstvRvdY345__wO5-QRtJFYdL_QAf8BCTQUJmt6dM7YFW0FmbwHHlNQepr9ihsKvbEI_BG88iMCh7r7OWKFnUR7FQMFib5TY3i2v1WjbLvZm1Zpifft-a5VsrV4bqfOovYiVECzUDCzf3I43w0IPFno__WR7PvYZKtaSdbe4YPYyEUxuyh-8s3aWIkW5c7VrMl_lbzS_Ve0A94YpdFesX339cOEnFyf8pyUp_pLRW7KrAAKI559JNiRivR4-GjVcOsjkRypYMcDULhWo0fLSRRFgpHsOynKmhSnPD-QsiKRSHfsQD4Vn0kk3gf6nHz4Q4BCOXtOREIFoyK9OL70LXur0E1GO3w5xldfjtfZoRxw24Uzs-3xmzV90GzHMuQCkOj8dsu2Q6bDVfhYz8PJG8LsZZj9NZzuwvHSLO9-BwAA__9_viDb

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE data WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/66>  …/1/1         {1}       1
…/1/1               …/1/2         {2}       2
…/1/2               …/1/3         {3}       3
…/1/3               …/1/4         {4}       4
…/1/4               …/1/5         {5}       5
…/1/5               …/1/6         {1}       1
…/1/6               …/1/7         {2}       2
…/1/7               …/1/8         {3}       3
…/1/8               …/1/9         {4}       4
…/1/9               <after:/Max>  {5}       5

query T
EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
distribution: full
vectorized: false
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lVtvmzAUx9_3Kazz1EpGYCA3PzVqOwmptwUeJk1R5YbTFJVgZht1XZXvPjlZ1sIKSpDCAwIDv_Pz3xfeQP_MgcPl97uraXRDTi6iOIm_XZ2S89nlNLkkcTJNojiJzmOiGbm9IYJ8nd1ek1QYARQKmeKNWKEG_gMYUPCBQgAUQqAwgDmFUskFai2VfeVt80GU_gLuUciKsjK2eU5hIRUCfwOTmRyBQyIecpyhSFG5HlBI0Ygs35Sxpc_s6b58xlegcC7zalVoTqxRXAp76biMiCIljEjzhArmawqyMu8FtRFLBM4-GEYXwL013V8yFqsyR-UO6oLb5jj7jZwwz_Osf2yE4eSMtYr4DZFBq8h7_aqQKkWFaa3-fN2qOl0uFS6Fkcpl3v7S5MT3PPJQLZ7R6NPWLgSNLrB6mGz_EWc9Rtxljuv3GnN2iOZuzIdHGPNhTcTfPy-_T16-4wa98vIP0dzlNTpCXqOaSLB_XkGfvALHDXvlFRyiuctrfIS8xjWRcP-8wj55hY476JVXeIjmLq_JEfKaHPIzmKEuZaGxsRd_XslrVHKY3bQxXeJ2h9eyUgu8U3KxeXd7e7sBbRpS1Gb7lG1vomL3SBuFYvXvX_aRxDpJfo3EPpIGTZLf7XSIVNCJCttJrEkK-3Zv2CQNOknDdie_SRr2dRo1SaNO0rjdKWiSxn2dxk3SpHsaeO1S4X9zs3uad1hN7NJ5zOXLfZYCB-_v4Xxy2h1gPxBLbddv_CRfNtjktbSr71HkGilci2e8QINqlRWZNtkCuFEVrtdf_gQAAP__uYub4w==

statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsltGOmzgUhu_3Kaxz1UpkwAYyGV91Nu1KUTWdKkS9WY0qD5xSFGKzttF0dpTH2hfYJ1sBZSehkIZUkXrRXKDYPpzz_5zPlp_A_JUDh_nyzfXqDYlW16tFtFrMI2IouX1HBPljeXtDEmEFOCBVgu_EBg3wP4GCAwwc8MGBABwI4c6BQqsYjVG6CnmqX1gkX4B7DmSyKG01fedArDQCfwKb2RyBw0rc57hEkaB2PXAgQSuyvC5TlX5VPT4Wa3wEB-YqLzfScFIpigpR_Z24lAiZEEqU_YwaHHj7gVTFDSeSNkObbZAT799_TDOOlbQobabkN0taPRiSYKwSTDihntdM3z9aNESjSDiZeR75vZlOl-_nJBZ5bnZiC5HpNpbVkzcf5nNiLBYkVqW05AV-sW4m7UtOPPc5AHE9FFDLUqUtSttUuts60Iy_fldjRYrA6U4jFq-Be1vn-F5EYlPkqN1wvw_NdJT9jXXt2lJkheXkFR0UwjpCwkEhz_VLqXSCGpO9-nfbQanXaaoxFVZpl3rHiyYvmOeR-zJeozUvBy34HQt0_2PS48GmJ4Dt0onLhtFmP4g260ObXkzJ26wHbtYHd3AOuNkIuOmYfrRwT88A93RPCDseDHYKGGzi-sNg-L_A4GxMP1owLs8AxuWeEP94MPxTwPAnbjAMRvALDO6P6UcLxuwMYMz2hATHgxGcAkYwccNhMMIfBMPvA4Nd-P1g-H1gTM8Bhj8CjGBMP1owrs4AxtWYC9sSTaGkwc59qb-S16k0odXFCpMUm1uYUaWO8b1WcR3bDG_rRPVEgsY2q7QZLGS7ZKxGsfn_vrmbiR7MxPYy0d1MYTcTO6xpjCj_YKpgOBPtZgrG2hN1V0CifVB63ewkg7I-x6prYrvQ7KVm5fmQbVc3aIxInwMq0nd1Trs6w4M6p8OOWTfT9Od0fNnVeXlQ52zYsd_NNPs5Hc-6Oq8ObxBv2HLwza49fACM8uwPemYXwXc8hx3PV9WR9SlXDx-zBDh4X3-Tnkf7g-oFkZrq3Iw-q4da9OqxqE69TyI36MCNWONrtKg3mcyMzWLgVpe43f72XwAAAP__T1BybA==

query T retry
EXPLAIN (DISTSQL, TYPES) SELECT * FROM data
----
distribution: full
vectorized: true
·
• scan
  columns: (a int, b int, c float, d decimal)
  estimated row count: 1,000 (100% of the table; stats collected <hidden> ago)
  table: data@data_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklEFvmz4UwO__T2G903-TERjIDpw2NZmElKZZ4LBpiioXv6aogJlt1FUR330ydGtBSYWID5bs5_zeLw8_H0H_KiCC1fft-ku8If8v4yRNvq0pSX9sV8kHkqzWq6uUfCRfdzfXRHDDgUIlBW54iRqin8CAgg8UAqAQAoUF7CnUSmaotVT2yLH7QSx-Q-RRyKu6MXZ7TyGTCiE6gslNgRBByu8K3CEXqFwPKAg0PC-6NDb1Zzvd1o_4DBSuZNGUlY4Ip-SOkowSARSSmts9x2WEV4IwIs0DKti3FGRjXjNrww8IEXujGi8h8lp6xvZVsqmkEqhQDAXzygB9me8LyU0XzvKSF7BvT_zZjXRk7S4GlHOe_shzMfBk06vKLqmqyxzXn1VXNvD1p_v6F_n6jhvM8vUHvsF03-Ai38Bxw1m-wcA3nO4bXuQbOu5ilm94ts9O-O5Q17LSOKlTvFEmh9neQ3HAvou1bFSGWyWz7my_vOlA3YZAbfoo6xdx1YWYzaCQl_-eibck9i7p04DkvUvy5zqxMSmYS_LHpHAuKRiTFnNJof2K94V8us0FROC9DOfE9Hd07zA_aHuVkgf51GHT59peBKMapHDNH3GJBlWZV7k2edYH2va_PwEAAP__DBRFDg==

# Check that we properly render virtual computed columns when collecting stats.
statement ok
ALTER TABLE data ADD COLUMN e INT AS (b + 1) VIRTUAL

statement ok
CREATE INDEX ON data (e)

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV1Fvm0gQfr9fsZqnVrcO7IIdZ5-Sc3uSVaWtbKsvJ6vawNRFxiy3uyjNRf5Z9wful52AUgMxrhGq1Ej1A2Jnhpn5Zr6ZZB_B_B2DgNni9c3qNVmublbz5Wo-WxLDyJ-Ld7cklFYChUSF-Fbu0ID4CxhQ4EDBAwo-UBjDmkKqVYDGKJ2bPBYfzMMvIFwKUZJmNhevKQRKI4hHsJGNEQSs5F2MC5QhascFCiFaGcVFmDz0df74mG7xASjMVJztEiOIpOSOkoCSECgsU5nLRg4jMgkJI8p-Rg0UFpiEqAW5ZpRcc0quPUqu_fz9dyaEmL9dTYHCmw8kz9UIkrDyaKMdCuL-968pz4FKLCY2UskTlVb3hoQYqBBDQZjrluK7B4uGaJShIFPXJX-U4s3i_YwEMo5NzTaVka5seSG8_TCbEWMxJYHKEkte4BfrRIl9KYjrHAwQt10GRVoqs2lmy0jrPYXy_LUNxsoNgmC1vs1fgXD39PzWLeUujVE742bbSvEy-geL2AWkpZU2b8ThldektH7ymgpaF_hPdLQuG3fi5C2c406cB3hZonSIGsMGvPW-sxI3m43GjbRKO8w9vybkBXddcpcFW7TmZa1CXYpWvU6ZNav3HctmLVvGXZX1WpVlTQqx86efDZl-h40cPnT--cD558fmn11MyJvoyAbgxzaA_yM2AO-xAVif9lUbYPL8NsCkgZOfT1M-iKZ85HhDaer9oqngfdpX0fTy-dH0soHTO5-m3iCaeiPHH0pT_xdNhdenfRVNp8-PptMGTv98mvqDaOqPnPFQmo4H0tQ7RlN-4R2nqXeMppMfQVOvB039Pu2raHr1_Gh61ed6s0CTqsRg69__45HcVqQRy-8JGG6wvFQYlekA32sVFLbl8V3hqBCEaGypZeVhnlQqYzXK3bfbWd0TO-mJNzyxuqdx2xM_nVOfpLyTrvxuT6ztye8LTxZdgQTtvdLbclANJsXSzse-UpSjWmoOf1Eq7Q6NkZuDgevDup7npJ3n-GSek27EvO1p8nMivmzneXkyz2k3Yq_tafpzIp6287w6PSBuN2T_ydSeXgC9MHudmPmF_x3M4xbmq3xlfYrV_ccoBAHu19_oyKP6Qf6B3Jh8by4_q_si6dVDmm-9TzI2SOFWbvEVWtS7KImMjQIQVme43__2fwAAAP__Ue9Fmw==

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON c, e, a FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl9Fu2zYUhu_3FMS52jC6EinZcXjlzO0Ao0hS2EZvBqNgxFNXiExqJI00C_xYe4E92UApbm3VNix3HnoRXQjgIfXzPzwfBfIJ3J8FCBiO31xN35DJ9Go6mkxHwwlxjNzekIwSpESS38e310RJL4GCNgpv5AIdiD-AAQUOFBKgkAKFLswolNZk6JyxYchT9cFIfQYRU8h1ufQhPKOQGYsgnsDnvkAQMJV3BY5RKrRRDBQUepkX1TRh6kF4fSjv8REoDE2xXGgniKTB5B1QmJQyBDoRI1Irwojxn9AChTFqhVaQAaNkwCkZJL8yIcToZtoHCm_fk2DQCaJZ3fT5AgWJ__nb1e3MaI_a50Z_02XNgyMKM6NQCcLiuA7fPXp0xKJUgvTjmPxWh-fjd0OSyaJwG2NLmdv1WF4Fr98Ph8R5LElmltqTn_Gzj3LtfxEkjr4OQLzfN6CyZZa-XPp6ptmKQt1-Xnvn5RxBsI1ijV6DiFf0-HpN5KIs0Ebd7VrV4Un-V1ipUBcvfbX4A04HyV4rvGGlu9fKVwdLbaxCi2rLwWy11-zVfG5xLr2xEYv_E9tJwzbbXkJ2PPLsZOQj1on4qdDz74Se74KeveqRt_kO7Pku7NNzYM9bYM_a1GyNfe8s2Pe2rPDj8eGn48M7UXIqPskLPoK3qdkan4uz4HOxZSU5Hp_kdHySTpSeik_6go9I2tRsjU__LPj0t6ykx-OTno5P2om6p-LT_U58kl348FfJbnySXfj0zoFP0gKftE3N1vhcngWfyzbHxzG60miHjbPb7pnixkwdFg55qOZYnwidWdoM31mTVWPr5m0lVAUUOl_3srox0usu5y3KxZfT76YSO6jEt5TYplK3qcQPe2pjKjkole5XYk2ltG16sqoKaPQPxt7Xe8mhDpeMcDF8Dtd7qY73q7vPumeBzsn5l84YZpv-ek1_3YP-evsz5U2l3o-V6UXT38VBf_39mSZNpf6PlWm_6e_y8EaI96eafrM7D2_0_z3Xy_BL-liYhw-5AgHx89PZ8Vo_ED6Qcxf-i5NP5qEyO30sw1_toywcUriW9_gaPdpFrnPn8wyEt0tcrX76NwAA__-J1ZZ1

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON e FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsltFu2zYUhu_3FMS5ajE6EinZcXjVzO0Ao0hS2EZvhqBgxFNXsExqJIU0C_xYe4E92SCpWmzV8qwUBnoRXwgmeXTO_-t8JPgI7s8MBExm7y4X78h8cbmYzhfTyZw4Rm6uCZLfZzdXREkvgYI2Cq_lGh2IP4ABBQ4UIqAQA4Uh3FLIrUnQOWPLkMfqhan6CiKkkOq88OX0LYXEWATxCD71GYKAhbzLcIZSoQ1CoKDQyzSrypSl35SPT_kKH4DCxGTFWjtB7oDCPJfl30HAiNSKMGL8F7RAYYZaoRXkDfuVCSGm14sxUHj_kZSSnCCa1UOfrlGQ8J-_XT1OjPaofWr0d0vW3DuiMDEKlSAsDOvpuwePjliUSpBxGJLf6unl7MOEJDLL3FZsLlPbxPJq8urjZEKcx5wkptCevMKvPki1fy1IGDwFIK66AipZpvB54etKtxsK9fjb13ZeLhEE22rP9C2IcEOP79BcrvMMbTDc7U49PU__wqp2ZWnupS8_fKcQ3hIy7BTyVL_Qxiq0qHbq3246pV4ulxaX0hsbsPB40eQVD0NyVyQr9O51p4WoZYHtfkx2PO7sGbgHbBDwvsDzHwSe7wOenY3I-3QP8nwf8vEpkOc9kGd9utQgPzoB8qMdIfx4XPhzcOGDIOqLS_SCi-B9utTgcn4CXM53hETH4xI9B5doEMR9cYlfcBFRny41uIxPgMt4R0h8PC7xc3CJB8GwLy7DH8Ql2ocLP4v24xLtw2V0ClyiHrjEfbrU4HJxAlwu-lwEZ-hyox227mH7K4WtSgNWXthQLbG-3TlT2AQ_WJNUsfXwpkpUTSh0vl5l9WCqmyXnLcr1f_fY7UzsYCa-k4ltZxq2M_HDmvqIig6mirszsXamuK89WXUFNPp7Y1f1TnKoq9OtvH42C_Veqleejt5mdY3OyeVTQEn6ts5RW-fwoM5Rt2PezjT6OR2ft3WeH9Q57nYctTONf07H47bOi8MbJOy2HH-3aw8fAL08R52e-Vn8P56HLc8X5ZH1OTP3n1IFAsJvv8GeR_OD8gW5dOW5Of9i7ivRi4e8PPU-y8whhSu5wrfo0a5TnTqfJiC8LXCz-eXfAAAA__-Uwo9d

statement ok
ALTER TABLE data ADD COLUMN f FLOAT AS (atan2d(c, d::float)) VIRTUAL

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON f, e, d FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl8Fu2zgQhu_7FMScWixdiZTsKDw567aA0U1S2EYvC6NgxIkrRCa1JI00G_ix9gX2yRaS4tZWbcNK7aKH6iCAQ2r4j-b7BeoR3N85CBiM3lxM3pDx5GIyHE-GgzFxjFxfkVtKkBJF3o6uL4mSXgIFbRReyTk6EH8BAwocKERAIQYKXZhSKKxJ0TljyyWP1QND9RlESCHTxcKX4SmF1FgE8Qg-8zmCgIm8yXGEUqENQqCg0Mssr7Ypt-6Xt4_FHT4AhYHJF3PtBFGU3FCSAoVxIctAJ2BEakUYMf4TWqAwQq3QCtJnlPT570wIMbyaJJRILzVXL_oR7TMh3v55fTFJXgKFdx9IqdkJolk99NkcBQn_-9fV49Roj9pnRn8zZc29IwpTo1AJwsKwDt88eHTEolSCJGFI_qjDs9H7AUllnru1tYXM7Gotr4KXHwYD4jwWJDUL7ckL_OyDTPuXgoTB1wWId7sWVLLMwhcLX-80XVKox0_tcF7OEARb69_wNYhwSQ9v4VjOixxt0N1sXx0eZ_-Ub6pslZe-6kef0360UwpvSOnulPJVwUIbq9Ci2lAwXe4UezGbWZxJb2zAwqPIjhqy2eYrZIe7gD3bBQHrBPyIPuDf6QO-zQfsVY-8y7Y4gW9zQnwKJ_AWTmBt2rhyQu8kTuhtSOGHE8WfTxTvBNERiYp-ESV4mzauiDo7CVFnG1Kiw4mKnk9U1AniIxIV_yJKRG3auCIqOQlRyYaU-HCi4ucTFXeC7hGJ6n4nUdE2oviraDtR0TaieqcgKmpBVNymjSuizk9C1Hmbo-gIXWG0w8Y5cPtOYWOnDisPjKhmWJ8unVnYFN9bk1Zr6-F1lagKKHS-nmX1YKhXU85blPMvJ-n1TGxvJr6Ria1n6jYz8f2a2oiK9qaKd2dizUxx2_Jk1RXQ6O-Nvau95FCXPyzlf-dTuPZSHU-q_6jVzBydk7MvkyFM1_X1mvq6e_X1dlfKm5l6P1elZ019Z3v1JbsrjZqZkp-r0qSp73y_EcLdpcbfuHO_0X94reflJ-k2N_cfMwUCwqers-W2uqB8QM5c-V0cfzL3ldjJQ1F-1W5l7pDCpbzD1-jRzjOdOZ-lILxd4HL52_8BAAD__3JusPw=

statement ok
CREATE TYPE gh AS (g INT, h INT)

# Try a virtual computed column whose expression cannot be distributed.
statement ok
ALTER TABLE data ADD COLUMN g gh[] AS (array_cat(ARRAY[(1, 2)], ARRAY[(a, b)])) VIRTUAL

# Error if we specify the problematic virtual computed column directly.
statement error cannot be executed with distsql
CREATE STATISTICS s1 ON g FROM data

# We should skip the problematic virtual computed column when using defaults.
query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgTvv9PQcwpwU9HIiU7Dk_Oui1gdNMUttHLwigYaeoKlkUtSSPNBn6sfYF9soWkai0plmvBMNAA9UEQZ0bD-WY-fgafwfwZg4Dx9O3t_C2ZzW_nk9l8Mp4Rw8i76f0dCaWVQCFRIX6QazQg_gAGFDhQ8ICCDxT6sKCQahWgMUpnIc_5B5PwGwiXQpSkG5uZFxQCpRHEM9jIxggC5vIhxinKELXjAoUQrYzifJts61H2-Jyu8AkojFW8WSdGEEnJAyUBJSFQmKUys_UcRmQSEkaU_YoaKEwxCVELMmKUjDglI4-SkZ-9_58JISYf5kNKpJUJDy9GHh35Qrz7_f52PrwECu8_kQyCESRhxdJGaxTE_edvU6wDlVhMbKSSFy6tHg0JMVAhhoIw1y3MD08WDdEoQ0GGrkt-K8zL6ccxCWQcm0psKiNdxvLcePdpPCbGYkoCtUksucBv1okSeymI6-wCEFdtAXlZamPTjS12WmwpFOvv0zFWLhEEq4xz8gaEu6XHT3Qm12mM2unXp1mYZ9FfmO-dQ5pZabP57F55xUqrK6_uoFWD_8JHq7b-7nXQCpk3IPdbIe-QbhKlQ9QY1pAutq1NuV0uNS6lVdph7vHtIRfcdcnDJlihNZeVZrU5Gq07FFZv5A8i621tCx6QC74ztzXcazSc1UnGjpcNdopsOKzn8DMJBz9ROPg-4WBXA_I-2iMdfJ90-OeQDt5BOliXqZbSMXjV0jGoQebHE5mfRGTec7wzEdn7RWTBu0y1JPL1qybydQ2ydzyRvZOI7PUc_0xE9n8RWXhdploSefiqiTysQfaPJ7J_EpH9ntM_E5H7JxLZ20dkfuXtJ7K3j8iDcxDZ60Bkv8tUSyLfvGoi33S5iE3RpCox2Lid7N_JbezUY9k1BsMlFnceozY6wI9aBXlssbzPE-WGEI0tvKxYTJLSZaxGuf7vHlnNxA5m4rVMrJqp38zED9fUpSjvYCq_PRNrZvK7wpP5VCBB-6j0qjizBpNc4TPmlo7i1Bae3d9P6V2jMXK5C3B9WFTrHDTr7B-sc9COmDczDX5OxNfNOq8P1jlsR-w1Mw1_TsTDZp03hw-I2w7Zf3FqDwtAJ8xeK2Z-5f8Ac7-B-SaTrC-xevwchSDA_f7r7XmUP8g-kEuT6ebsq3rMi54_pZnqfZGxQQp3coVv0KJeR0lkbBSAsHqD2-3__g0AAP__bnd4tw==

# Check that we also collect stats on the hidden expression index virt column.
statement ok
CREATE INDEX ON data ((a * b))

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKd-lIpOSf8OSs2wJGN01hG70sgoKRpq5gmdSSNNJs4MfaF9gnW0iq15ZiuRYMA0VQHQRyZjScj_PxM-gnsH-lIGA0eXM9e0Oms-vZeDobj6bEMvJ2cntDYukkUFA6xvdyiRbEn8CAAgcKAVAIgUIX7ihkRkdorTZ5yFPxwTj-CsKnkKhs5XLzHYVIGwTxBC5xKYKAmbxPcYIyRuP5QCFGJ5O0WCZfepi_PmULfAQKI52ulsoKIim5pySiJAYK00zmto7HiFQxYUS7L2iAwgRVjEaQIaNkyCkZBpQMw3z8GxNCjN_PBpQM2a-5TzqpeHwxDOgwFOLtH7fXs8EroPDuI8mRWEEUK6cuWaIg_r__2HIeaeVQuUSrZy6jHyyJMdIxxoIw3y_N948OLTEoY0EGvk9-L83zyYcRiWSa2p3YTCZmE8sL483H0YhYhxmJ9Eo5coFfnZco90oQ39sGIC6aAoqy9MplK1eudLemUM6_Nck6OUcQbKer49cg_DU9vrFTucxSNF632tTSPE3-xmLtAtLUSZe3aTvkO1a6OwuqDrprCJ_56K6tux32tsN-I3peQ99tRL8FvVLaxGgwroC-Wzfuz_V8bnAunTYe84_fKXLBfZ_cr6IFOvtqZ9-aHLVdPBRW3dPvRFZ3uCm41-Tokwu-NTd1Iqh1glWJyI5XGHaKwnis4_Hzagw_UWP4Po1hlz3yLtmjMnyfyoTnUBneQmVYm-ZuVKb3UlSmV0HPj6c2P4navOMF56V28JPagrdp7oba_ZdC7X4FfXA8tYOTqB10vPC81A5_UlsEbZq7ofbgpVB7UEEfHk_t8CRqhx2ve15qd0-kdrCP2vwy2E_tYB-1e-egdtCC2mGb5m6offVSqH3V5tI3QZtpZbF2_dm_kl9bqcPyexLGcywvVVavTIQfjI6K2HJ6WyQqDDFaV3pZORmrjcs6g3L5_511NxM7mIlXMrHdTN16Jn64pjZFBQdThc2ZWD1T2BaeLLoCCt2DNovy-FpUufwXN9KNozzApWf727TxLtFaOd8G-MV_Qts6e_U6uwfr7DUj5vVMvR8Tcb9eZ_9gnYNmxEE90-DHRDyo13l1-ID4zZDDZ6f2sAC0whw0YuaX4Xcwd2uYr3LJ-pzqh09JDAL8b09nz2vzQP6BnNtcN6df9ENR9Owxy1Xvs0wtUriRC3yNDs0yUYl1SQTCmRWu17_8FwAA__-iJpSa

# Check that we also collect stats on other hidden columns.
statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

statement ok
ALTER TABLE data ALTER COLUMN c SET NOT VISIBLE

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsWM1u2zgQvu9TEHNKd-lIpOSf8OSs2wJGN01hG70sgoKRpq5gmdSSNNJs4MfaF9gnW0iq15ZiuRYMA0VQHQRyZjScj_PxM-gnsH-lIGA0eXM9e0Oms-vZeDobj6bEMvJ2cntDYukkUFA6xvdyiRbEn8CAAgcKAVAIgUIX7ihkRkdorTZ5yFPxwTj-CsKnkKhs5XLzHYVIGwTxBC5xKYKAmbxPcYIyRuP5QCFGJ5O0WCZfepi_PmULfAQKI52ulsoKIim5pySiJAYK00zmto7HiFQxYUS7L2iAwgRVjEaQIaNkyCkZBpQMw3z8GxNCjN_PBpQM2a-5TzqpeHwxDOgwFOLtH7fXs8EroPDuI8mRWEEUK6cuWaIg_r__2HIeaeVQuUSrZy6jHyyJMdIxxoIw3y_N948OLTEoY0EGvk9-L83zyYcRiWSa2p3YTCZmE8sL483H0YhYhxmJ9Eo5coFfnZco90oQ39sGIC6aAoqy9MplK1eudLemUM6_Nck6OUcQbKer49cg_DU9vrFTucxSNF632tTSPE3-xmLtAtLUSZe3aTvkO1a6OwuqDrprCJ_56K6tux32tsN-I3peQ99tRL8FvVLaxGgwroC-Wzfuz_V8bnAunTYe84_fKXLBfZ_cr6IFOvtqZ9-aHLVdPBRW3dPvRFZ3uCm41-Tokwu-NTd1Iqh1glWJyI5XGHaKwnis4_Hzagw_UWP4Po1hlz3yLtmjMnyfyoTnUBneQmVYm-ZuVKb3UlSmV0HPj6c2P4navOMF56V28JPagrdp7oba_ZdC7X4FfXA8tYOTqB10vPC81A5_UlsEbZq7ofbgpVB7UEEfHk_t8CRqhx2ve15qd0-kdrCP2vwy2E_tYB-1e-egdtCC2mGb5m6offVSqH3V5tI3QZtpZbF2_dm_kl9bqcPyexLGcywvVVavTIQfjI6K2HJ6WyQqDDFaV3pZORmrjcs6g3L5_511NxM7mIlXMrHdTN16Jn64pjZFBQdThc2ZWD1T2BaeLLoCCt2DNovy-FpUufwXN9KNozzApWf727TxLtFaOd8G-MV_Qts6e_U6uwfr7DUj5vVMvR8Tcb9eZ_9gnYNmxEE90-DHRDyo13l1-ID4zZDDZ6f2sAC0whw0YuaX4Xcwd2uYr3LJ-pzqh09JDAL8b09nz2vzQP6BnNtcN6df9ENR9Owxy1Xvs0wtUriRC3yNDs0yUYl1SQTCmRWu17_8FwAA__-iJpSa

# Check that we can disable stats collection on virtual computed columns.
statement ok
SET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled = false

statement error cannot create statistics on virtual column
CREATE STATISTICS s1 ON e FROM data

query T
EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 FROM data
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 1,000 (7.8 KiB, 2,000 KVs, 1,000 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• create statistics
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsV8Fu2zgQve9XEHNqAToSKdlxeErW7QJGkW1hG70sjIKRpq5gWdSSFNJs4M_aH9gvW0iqakmxVAtGgQaID0I4MxrOm3mPYh7B_B2DgNni7c3qLVmublbz5Wo-WxLDyB-L97cklFYChUSF-KfcoQHxFzCgwIGCBxR8oDCGNYVUqwCNUToPeSxemIdfQbgUoiTNbG5eUwiURhCPYCMbIwhYybsYFyhD1I4LFEK0MoqLbfKtr_PHp3SLD0BhpuJslxhBJCV3lASUhEBhmcrcNnIYkUlIGFH2C2qg8O4jyaswgiSsXNpoh4K4__1rynWgEouJjVTyxKXVvSEhBirEUBDmuqX57sGiIRplKMjUdcnvpXmz-DAjgYxjU4tNZaSrWF4Ybz_OZsRYTEmgssSSV_jVOlFiXwviOocAxG1XQFGWymya2XKn9Z5Cuf7WYGPlBkGw2kTmb0C4e3r6UJZyl8aonXFzIKV5Gf2Dxd4FpKWVVpBrdviT16y0vvKaDlo3-E989NrvBMdb4Mad4A6YskTpEDWGDUzrfSf8m81G40ZapR3mnt4I8oq7LrnLgi1a87rWli5Hq0l9Yc2W_SCyr4Feq4GsSQ92umbZOZp12Mjh3arlZ6qWH1Mtu5iQd9ER3fJjuvV_hm75AN2yIYOpdDt5JrqdNMDx01nHz2IdHzleN-u8F9YJPmQwFesunwnrLhvgvNNZ553FOm_k-N2s819YJ7whg6lYN30mrJs2wPmns84_i3X-yBl3s258Juu8Y6zjF95x1nnHWDf5GazzBrDOHzKYinVXz4R1V0Ou_Qs0qUoMtm7Ix3dyWzuNWH6VxnCD5b3bqEwH-EGroIgtl--LRIUhRGNLLysX86RyGatR7r7_11LPxHoz8UYmVs80bmfi_TUNKcrrTeV3Z2LtTP5QeLKYCiRo75Xeluo0mBQHb_49rhylPkvP4atQeXdojNwcAlwP1vU6J-06x711TroR83amya-J-LJd52VvndNuxF470_TXRDxt13nVLxC3G7L_RLX9B8AgzF4nZn7h_wDzuIX5Kj-yPsfq_lMUggD322905FH9IH9Bbkx-bi6_qPui6NVDmp96n2VskMKt3OIbtKh3URIZGwUgrM5wv__t_wAAAP__N88Ejg==

statement ok
RESET CLUSTER SETTING sql.stats.virtual_computed_columns.enabled

subtest regression_98373

statement ok
CREATE TABLE IF NOT EXISTS t98373 AS
        SELECT
                g::INT2 AS _int2,
                g::INT4 AS _int4,
                g::INT8 AS _int8,
                g::FLOAT8 AS _float8,
                '2001-01-01'::DATE + g AS _date,
                '2001-01-01'::TIMESTAMP + g * '1 day'::INTERVAL AS _timestamp
        FROM
                generate_series(1, 5) AS g;

statement OK
SET vectorize = off

statement OK
SET distsql = always

# These query plans should be disallowed from executing in a distributed
# fashion, even with distsql = always. Check different flavors of EXPLAIN.

query T
EXPLAIN SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN

query T
EXPLAIN(DISTSQL) SELECT
        regproc(_int2::INT8)::REGPROC AS col865
FROM
        t98373@[0]
----
distribution: local
vectorized: false
·
• render
│
└── • scan
      missing stats
      table: t98373@t98373_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF9r2zAUxd_3KcR5akFh9sq2TE8tSTYMaZLZfhgUEzTr1hOVJU-S6Urwdx-20_1jg90HiftH5_6OTghfDQQ2nw7bm2zHLtZZURYft5es2Gw3q5J5ajrv6oujtvGVENmuXF4KkW8-HPL9it0UrHZm-eY1e5_vb1l8t7x6e3V9l1TgsE7RTrYUIO6QouIYhSgE58fSaRrI1DeIhEPbro9jueKonSeIE6KOhiBQys-GcpKK_MsEHIqi1GaSPS-cr2P3QE_gWDnTtzYINjGDo-jkmC7AkZNV5MUPW9fp2ROqgcP18SdGiLIhiPQX7mwNkQz8_9FzCp2zgX6j_tem5I9Ni3SoOEg1NP9XcL2v6eBdPc3O6X4SmgqKQpy76Zxk9rkVoifZzvgVx71xj0etIJCcY_GX4zkwPpBNGI0VX9zjJFs-dSPWvTSBOG7lA60pkm-11SHqGiL6nobhxfcAAAD__wgUvrk=

statement OK
RESET vectorize

statement OK
RESET distsql
