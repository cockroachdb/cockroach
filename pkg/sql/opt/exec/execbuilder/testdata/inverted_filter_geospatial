# LogicTest: local

# EXPLAIN test cases for using invertedFilterer on an inverted geospatial index.

statement ok
CREATE TABLE geo_table2(
  k int,
  geom geometry,
  k_plus_one int,
  PRIMARY KEY (k, k_plus_one),
  INVERTED INDEX geom_index(geom)
)

query T
EXPLAIN (DISTSQL) SELECT k FROM geo_table2 WHERE ST_Intersects('POINT(3.0 3.0)'::geometry, geom)
----
distribution: local
vectorized: true
·
• filter
│ filter: st_intersects('010100000000000000000008400000000000000840', geom)
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 31
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUVF1v4joQfb-_wpqXFsm0jgOi9RP3tum9uWpLF5B2VxsUmXhKI4Kdtc2WquK_rxL6mQq68GDhGc_xOcczeQT3swAB0beby7_ja3J4Ho_Goy-XLTKKLqOzMZmTi-HgiszQpF5OC-Tk63_RMCLOp7n2aB1m3h0e3Azi6_FheMRIeMRaB0L8Gw2uovHwO61KFy2goI3Ca7lAB-IHBDChUFqToXPGVqHH-kCsViAYhVyXS1-FJxQyYxHEI_jcFwgCxhWPIUqF9pgBBYVe5kUN-0qzX12b5lrhCiicmWK50E6QOSXztCyWLjUaN9yAwqiUVfI4gX-SZHWrkmQVsCRZsc8WaO9bEyRApFYkZMT4O7QOJmsKZulf9TovZwgieGNQfA6CremfexTrX2g9qou88GjRHgfvjXrOR6vSEqNJnwviKheI89J6UasKe90kYZwlCWOfLUBQq33LKjMablAYLL0g_YD2-VZreMOaYB9r_je5fuoevqt7nv6m5RwfGi1Ut802cmGDHN-H3Mt7he-pbeKiOXYsYAH7-DvpfNgfiLcz2eetV6e3Kuk0lIT7KBmiK412-E7HtptY46Z2sJ5QQDXDzafBmaXN8MaarD672Q5qoDqg0PlNNthsYv2cct6iXLwM0FukYCcS344UNJH4TqRwOxJvIoU7kTq71E0o3BbmPs0VCOj1uvJEZbLNO91uu9ObyrY8Dadt1uMyQ5VxOT2FqkDOXPVsoztzX8OOH8rK9FtZOKRwJed4jh7tIte583n2lFmv__odAAD__1qb-j4=

query T
EXPLAIN (DISTSQL) SELECT k, k_plus_one FROM geo_table2 WHERE ST_Intersects('POINT(3.0 3.0)'::geometry, geom)
----
distribution: local
vectorized: true
·
• filter
│ filter: st_intersects('010100000000000000000008400000000000000840', geom)
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 31
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUVN9v2jAQft9fYd1Li2RaO6Fl9RNbm26Z2tIB0jYtKArxQSOCndlmpar436eE_oBU0MGDhe98n7_v810ewf7JQUDw8_bqU3hDDi_C_qD__apB-sFVcD4gU0qmcZHPbawVkste95pMUMcuGeXokR9fg15ArIsz5dBYTJ09PLjthjeDQ_-IEf-INQ6E-BJ0r4NB7xctS2cNoKC0xJtkhhbEb-AwpFAYnaK12pShx-pAKBcgGIVMFXNXhocUUm0QxCO4zOUIAgYljx4mEs0xAwoSXZLlFewrzU55bZwpiQugcK7z-UxZsSltxQ0o9IukTB5H8DmKFmMZRQvOomjB3luguW8Nj4AkShKfEe3u0FgYLinouXvVa10yQRB8zaDwAgRb0v_3KFR_0TiUl1nu0KA55ptGPeeDRWGIVqTjCWJLF4h1iXGiUuW3T6KIeSyKGHtvAYJK7ltWmlFzg0J37gTpcNrxtlrj1azh-1jzTWfqqXu8Xd3z9DcupvhQa6GybdYbaStRv0bU24foy9v5mzRXcVEfQcYZZ29_H1tv9gdifT47XmPddX-rmFZNjL-PmB7aQiuLG1K23cRqNzX5ckgB5QRXXwqr5ybFW6PT6uxq262AqoBE61ZZvtqE6jllncFk9jJP60h8J5K3HYnXkbydSP52JK-O5O9Eau1SN6QwzvV9nEkQMBqdnI5RyqbvpdhsnYzPmmdcyqaU7RTbrfR01B5DWZBMbPls_Tt9X8EOHorS9HGSW6RwnUzxAh2aWaYy67L0KbNcfvgXAAD__6UmBI0=

query T
EXPLAIN SELECT k, k_plus_one FROM geo_table2 WHERE ST_Intersects('POINT(3.0 3.0)'::geometry, geom)
----
distribution: local
vectorized: true
·
• filter
│ filter: st_intersects('010100000000000000000008400000000000000840', geom)
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 31
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 31 spans

query T
EXPLAIN SELECT k, k_plus_one FROM geo_table2 WHERE ST_DFullyWithin('POINT(3.0 3.0)'::geometry, geom, 1)
----
distribution: local
vectorized: true
·
• filter
│ filter: st_dfullywithin('010100000000000000000008400000000000000840', geom, 1.0)
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 30
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 30 spans

# Bounding box operations.
statement ok
SET CLUSTER SETTING sql.spatial.experimental_box2d_comparison_operators.enabled = on

query T
EXPLAIN SELECT k FROM geo_table2 WHERE geom && 'POINT(3.0 3.0)'::geometry
----
distribution: local
vectorized: true
·
• filter
│ filter: geom && '010100000000000000000008400000000000000840'
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 31
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 31 spans

query T
EXPLAIN SELECT k FROM geo_table2 WHERE 'POINT(3.0 3.0)'::geometry::box2d && geom
----
distribution: local
vectorized: true
·
• filter
│ filter: 'BOX(3 3,3 3)' && geom
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 31
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 31 spans

query T
EXPLAIN SELECT k FROM geo_table2 WHERE 'LINESTRING(1.0 1.0, 5.0 5.0)'::geometry ~ geom
----
distribution: local
vectorized: true
·
• filter
│ filter: '010200000002000000000000000000F03F000000000000F03F00000000000014400000000000001440' ~ geom
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 33
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 33 spans

query T
EXPLAIN SELECT k FROM geo_table2 WHERE geom ~ 'LINESTRING(1.0 1.0, 5.0 5.0)'::geometry::box2d
----
distribution: local
vectorized: true
·
• filter
│ filter: geom ~ 'BOX(1 1,5 5)'
│
└── • index join
    │ table: geo_table2@geo_table2_pkey
    │
    └── • inverted filter
        │ inverted column: geom_inverted_key
        │ num spans: 30
        │
        └── • scan
              missing stats
              table: geo_table2@geom_index
              spans: 30 spans
