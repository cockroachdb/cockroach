# LogicTest: local-opt

statement ok
CREATE TABLE kv (
  k INT PRIMARY KEY,
  v INT,
  w INT,
  f FLOAT,
  d DECIMAL,
  s STRING,
  b BOOL,
  FAMILY (k, v, w, f, b),
  FAMILY (d),
  FAMILY (s)
)

statement OK
INSERT INTO kv VALUES
(1, 2, 3, 1.0, 1, 'a', true),
(3, 4, 5, 2, 8, 'a', true),
(5, NULL, 5, 9.9, -321, NULL, false),
(6, 2, 3, 4.4, 4.4, 'b', true),
(7, 2, 2, 6, 7.9, 'b', true),
(8, 4, 2, 3, 3, 'A', false)

query TTTTT
EXPLAIN (VERBOSE) SELECT avg(k), max(v), min(w), 2 + row_number() OVER () FROM kv ORDER BY 1
----
render               ·            ·                     (avg, max, min, "?column?")  ·
 │                   render 0     avg                   ·                            ·
 │                   render 1     max                   ·                            ·
 │                   render 2     min                   ·                            ·
 │                   render 3     row_number + 2        ·                            ·
 └── window          ·            ·                     (avg, max, min, row_number)  ·
      │              window 0     row_number() OVER ()  ·                            ·
      │              render 3     row_number() OVER ()  ·                            ·
      └── group      ·            ·                     (agg0, agg1, agg2)           ·
           │         aggregate 0  avg(k)                ·                            ·
           │         aggregate 1  max(v)                ·                            ·
           │         aggregate 2  min(w)                ·                            ·
           │         scalar       ·                     ·                            ·
           └── scan  ·            ·                     (k, v, w)                    ·
·                    table        kv@primary            ·                            ·
·                    spans        ALL                   ·                            ·

query TTT
EXPLAIN SELECT k, stddev(d) OVER w FROM kv WINDOW w as (PARTITION BY v) ORDER BY variance(d) OVER w, k
----
sort                 ·      ·
 │                   order  +variance,+k
 └── window          ·      ·
      └── render     ·      ·
           └── scan  ·      ·
·                    table  kv@primary
·                    spans  ALL

query TTTTT
EXPLAIN (TYPES) SELECT k, stddev(d) OVER w FROM kv WINDOW w as (PARTITION BY v) ORDER BY variance(d) OVER w, k
----
sort                 ·         ·                                         (k int, stddev decimal)                                                                          ·
 │                   order     +variance,+k                              ·                                                                                                ·
 └── window          ·         ·                                         (k int, stddev decimal, variance decimal)                                                        ·
      │              window 0  (stddev((d)[decimal]) OVER w)[decimal]    ·                                                                                                ·
      │              window 1  (variance((d)[decimal]) OVER w)[decimal]  ·                                                                                                ·
      │              render 1  (stddev((d)[decimal]) OVER w)[decimal]    ·                                                                                                ·
      │              render 2  (variance((d)[decimal]) OVER w)[decimal]  ·                                                                                                ·
      └── render     ·         ·                                         (k int, d decimal, d decimal, v int)                                                             d=d; k!=NULL; key(k)
           │         render 0  (k)[int]                                  ·                                                                                                ·
           │         render 1  (d)[decimal]                              ·                                                                                                ·
           │         render 2  (d)[decimal]                              ·                                                                                                ·
           │         render 3  (v)[int]                                  ·                                                                                                ·
           └── scan  ·         ·                                         (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                    table     kv@primary                                ·                                                                                                ·
·                    spans     ALL                                       ·                                                                                                ·

query TTTTT
EXPLAIN (TYPES) SELECT k, stddev(d) OVER (PARTITION BY v, 'a') FROM kv ORDER BY variance(d) OVER (PARTITION BY v, 100), k
----
sort                 ·         ·                                                                            (k int, stddev decimal)                                                                          ·
 │                   order     +variance,+k                                                                 ·                                                                                                ·
 └── window          ·         ·                                                                            (k int, stddev decimal, variance decimal)                                                        ·
      │              window 0  (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      │              window 1  (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]   ·                                                                                                ·
      │              render 1  (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      │              render 2  (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]   ·                                                                                                ·
      └── render     ·         ·                                                                            (k int, d decimal, d decimal, "?column?" int, "?column?" string, "?column?" int)                 d=d; "?column?"=CONST; "?column?"=CONST; k!=NULL; key(k)
           │         render 0  (k)[int]                                                                     ·                                                                                                ·
           │         render 1  (d)[decimal]                                                                 ·                                                                                                ·
           │         render 2  (d)[decimal]                                                                 ·                                                                                                ·
           │         render 3  (v)[int]                                                                     ·                                                                                                ·
           │         render 4  ('a')[string]                                                                ·                                                                                                ·
           │         render 5  (100)[int]                                                                   ·                                                                                                ·
           └── scan  ·         ·                                                                            (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                    table     kv@primary                                                                   ·                                                                                                ·
·                    spans     ALL                                                                          ·                                                                                                ·

query TTTTT
EXPLAIN (TYPES,NONORMALIZE) SELECT k, stddev(d) OVER (PARTITION BY v, 'a') FROM kv ORDER BY k
----
sort                 ·         ·                                                                            (k int, stddev decimal)                                                                          +k
 │                   order     +k                                                                           ·                                                                                                ·
 └── window          ·         ·                                                                            (k int, stddev decimal)                                                                          ·
      │              window 0  (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      │              render 1  (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      └── render     ·         ·                                                                            (k int, d decimal, "?column?" int, "?column?" string)                                            "?column?"=CONST; k!=NULL; key(k)
           │         render 0  (k)[int]                                                                     ·                                                                                                ·
           │         render 1  (d)[decimal]                                                                 ·                                                                                                ·
           │         render 2  (v)[int]                                                                     ·                                                                                                ·
           │         render 3  ('a')[string]                                                                ·                                                                                                ·
           └── scan  ·         ·                                                                            (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                    table     kv@primary                                                                   ·                                                                                                ·
·                    spans     ALL                                                                          ·                                                                                                ·

query TTTTT
EXPLAIN (TYPES) SELECT k, k + stddev(d) OVER (PARTITION BY v, 'a') FROM kv ORDER BY variance(d) OVER (PARTITION BY v, 100), k
----
sort                 ·         ·                                                                                                  (k int, "?column?" decimal)                                                                      ·
 │                   order     +variance,+k                                                                                       ·                                                                                                ·
 └── window          ·         ·                                                                                                  (k int, "?column?" decimal, variance decimal)                                                    ·
      │              window 0  (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]                        ·                                                                                                ·
      │              window 1  (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]                         ·                                                                                                ·
      │              render 1  ((k)[int] + (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal])[decimal]  ·                                                                                                ·
      │              render 2  (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]                         ·                                                                                                ·
      └── render     ·         ·                                                                                                  (k int, d decimal, d decimal, "?column?" int, "?column?" string, "?column?" int, k int)          k=k; d=d; "?column?"=CONST; "?column?"=CONST; k!=NULL; key(k)
           │         render 0  (k)[int]                                                                                           ·                                                                                                ·
           │         render 1  (d)[decimal]                                                                                       ·                                                                                                ·
           │         render 2  (d)[decimal]                                                                                       ·                                                                                                ·
           │         render 3  (v)[int]                                                                                           ·                                                                                                ·
           │         render 4  ('a')[string]                                                                                      ·                                                                                                ·
           │         render 5  (100)[int]                                                                                         ·                                                                                                ·
           │         render 6  (k)[int]                                                                                           ·                                                                                                ·
           └── scan  ·         ·                                                                                                  (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                    table     kv@primary                                                                                         ·                                                                                                ·
·                    spans     ALL                                                                                                ·                                                                                                ·

query TTTTT
EXPLAIN (TYPES) SELECT max(k), max(k) + stddev(d) OVER (PARTITION BY v, 'a') FROM kv GROUP BY d, v ORDER BY variance(d) OVER (PARTITION BY v, 100)
----
sort                           ·            ·                                                                                                              (max int, "?column?" decimal)                                                                    ·
 │                             order        +variance                                                                                                      ·                                                                                                ·
 └── window                    ·            ·                                                                                                              (max int, "?column?" decimal, variance decimal)                                                  ·
      │                        window 0     (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]                                    ·                                                                                                ·
      │                        window 1     (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]                                     ·                                                                                                ·
      │                        render 1     ((max((k)[int]))[int] + (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal])[decimal]  ·                                                                                                ·
      │                        render 2     (variance((d)[decimal]) OVER (PARTITION BY (v)[int], (100)[int]))[decimal]                                     ·                                                                                                ·
      └── render               ·            ·                                                                                                              (max int, d decimal, d decimal, "?column?" int, "?column?" string, "?column?" int)               d=d; "?column?"=CONST; "?column?"=CONST; weak-key(d,"?column?")
           │                   render 0     (agg0)[int]                                                                                                    ·                                                                                                ·
           │                   render 1     (agg1)[decimal]                                                                                                ·                                                                                                ·
           │                   render 2     (agg1)[decimal]                                                                                                ·                                                                                                ·
           │                   render 3     (agg2)[int]                                                                                                    ·                                                                                                ·
           │                   render 4     ('a')[string]                                                                                                  ·                                                                                                ·
           │                   render 5     (100)[int]                                                                                                     ·                                                                                                ·
           └── group           ·            ·                                                                                                              (agg0 int, agg1 decimal, agg2 int)                                                               weak-key(agg1,agg2)
                │              aggregate 0  max(k)                                                                                                         ·                                                                                                ·
                │              aggregate 1  d                                                                                                              ·                                                                                                ·
                │              aggregate 2  v                                                                                                              ·                                                                                                ·
                │              group by     @1-@2                                                                                                          ·                                                                                                ·
                └── render     ·            ·                                                                                                              (d decimal, v int, k int)                                                                        k!=NULL; key(k)
                     │         render 0     (d)[decimal]                                                                                                   ·                                                                                                ·
                     │         render 1     (v)[int]                                                                                                       ·                                                                                                ·
                     │         render 2     (k)[int]                                                                                                       ·                                                                                                ·
                     └── scan  ·            ·                                                                                                              (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                              table        kv@primary                                                                                                     ·                                                                                                ·
·                              spans        ALL                                                                                                            ·                                                                                                ·

query TTTTT
EXPLAIN (TYPES) SELECT max(k), stddev(d) OVER (PARTITION BY v, 'a') FROM kv GROUP BY d, v ORDER BY 1
----
sort                           ·            ·                                                                            (max int, stddev decimal)                                                                        +max
 │                             order        +max                                                                         ·                                                                                                ·
 └── window                    ·            ·                                                                            (max int, stddev decimal)                                                                        ·
      │                        window 0     (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      │                        render 1     (stddev((d)[decimal]) OVER (PARTITION BY (v)[int], ('a')[string]))[decimal]  ·                                                                                                ·
      └── render               ·            ·                                                                            (max int, d decimal, "?column?" int, "?column?" string)                                          "?column?"=CONST; weak-key(d,"?column?")
           │                   render 0     (agg0)[int]                                                                  ·                                                                                                ·
           │                   render 1     (agg1)[decimal]                                                              ·                                                                                                ·
           │                   render 2     (agg2)[int]                                                                  ·                                                                                                ·
           │                   render 3     ('a')[string]                                                                ·                                                                                                ·
           └── group           ·            ·                                                                            (agg0 int, agg1 decimal, agg2 int)                                                               weak-key(agg1,agg2)
                │              aggregate 0  max(k)                                                                       ·                                                                                                ·
                │              aggregate 1  d                                                                            ·                                                                                                ·
                │              aggregate 2  v                                                                            ·                                                                                                ·
                │              group by     @1-@2                                                                        ·                                                                                                ·
                └── render     ·            ·                                                                            (d decimal, v int, k int)                                                                        k!=NULL; key(k)
                     │         render 0     (d)[decimal]                                                                 ·                                                                                                ·
                     │         render 1     (v)[int]                                                                     ·                                                                                                ·
                     │         render 2     (k)[int]                                                                     ·                                                                                                ·
                     └── scan  ·            ·                                                                            (k int, v int, w[omitted] int, f[omitted] float, d decimal, s[omitted] string, b[omitted] bool)  k!=NULL; key(k)
·                              table        kv@primary                                                                   ·                                                                                                ·
·                              spans        ALL                                                                          ·                                                                                                ·
