# LogicTest: 5node-dist-opt

statement ok
CREATE TABLE xyz (
  id INT PRIMARY KEY,
  x INT,
  y INT,
  z INT
)

statement ok
CREATE TABLE abc (
  a STRING,
  b STRING,
  c STRING,
  PRIMARY KEY (a, b, c)
)

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

statement ok
ALTER TABLE xyz SPLIT AT VALUES (2), (4), (6), (7)

statement ok
ALTER TABLE xyz EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], 0),
  (ARRAY[2], 2),
  (ARRAY[3], 4),
  (ARRAY[4], 6),
  (ARRAY[5], 7)

statement ok
ALTER TABLE abc SPLIT AT VALUES
  (NULL, NULL, NULL),
  ('1', '1', '2'),
  ('1', '2', '2'),
  ('2', '3', '4'),
  ('3', '4', '5')

statement ok
ALTER TABLE abc EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], NULL, NULL, NULL),
  (ARRAY[2], '1', '1', '2'),
  (ARRAY[3], '1', '2', '2'),
  (ARRAY[4], '2', '3', '4'),
  (ARRAY[5], '3', '4', '5')

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE xyz]
----
start_key  end_key  replicas  lease_holder
NULL       /2       {1}       1
/2         /4       {2}       2
/4         /6       {3}       3
/6         /7       {4}       4
/7         NULL     {5}       5

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE abc]
----
start_key        end_key          replicas  lease_holder
NULL             /NULL/NULL/NULL  {5}       5
/NULL/NULL/NULL  /"1"/"1"/"2"     {1}       1
/"1"/"1"/"2"     /"1"/"2"/"2"     {2}       2
/"1"/"2"/"2"     /"2"/"3"/"4"     {3}       3
/"2"/"3"/"4"     /"3"/"4"/"5"     {4}       4
/"3"/"4"/"5"     NULL             {5}       5

query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz
----
distinct   ·            ·            (x, y, z)  weak-key(x,y,z)
 │         distinct on  x, y, z      ·          ·
 └── scan  ·            ·            (x, y, z)  ·
·          table        xyz@primary  ·          ·
·          spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslDHPmzAQhvf-iupmI7BxSD4mhi5ZmirqVjFQfIqQEoxsIyWN-O8VIJESJQeFbwTy-nmfi3V3KLXC79kFLcS_gAMDAQxCYCCBwQZSBpXROVqrTfuTPrBXV4gDBkVZ1a59nTLItUGI7-AKd0aI4Wf2-4xHzBQaPwAGCl1WnDtMZYpLZm7J9fYHGHh-izzULv6aCJaELJGQNgx07R6nW5edEGLesPkNvhXWFWXu_M0Yn3DWgd5SxFvK4_C61EahQTU6O22oHjz4zyLhqAifP3BODdwXni8Xjnyiw6AarRq5mG8qSFPpdU2WmE50GEy3q0zD-aYhaRp5XZMlphMdBtPdKlM531SSpltvoedEg8Hz49PWxQvKEW2lS4tPa-P1yUG7TlCdsN89Vtcmxx9G5x2mfzx0ue6FQuv6r7x_2Jf9p7bgv2FOhsUozJ_DgiZPoEMyLemwXNN7Q4YjmhytIW_J8I4m79aQP-j_Kpi4JvQle2anzZe_AQAA___poq4z

# Ensure that ordering propagates past local DISTINCT processors.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x
----
distinct        ·            ·            (x, y, z)  weak-key(x,y,z); +x
 │              distinct on  x, y, z      ·          ·
 │              order key    x            ·          ·
 └── sort       ·            ·            (x, y, z)  +x
      │         order        +x           ·          ·
      └── scan  ·            ·            (x, y, z)  ·
·               table        xyz@primary  ·          ·
·               spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lT9v2zAQxfd-iuDWUpCPpP9p0tAlS1Ok3QoPqngIBDiiQdJA0sDfvZBkQLUbHxXaHUX63Xv3u4P5Bq019LV6Jg_FT0AQIEGAAgEaBMxhI2DnbE3eW9f9ZBDcmxcoZgKadrcP3fFGQG0dQfEGoQlbggJ-VL-29EiVIZfPQIChUDXb3mbnmufKvZYvr79BQJZ3lg_7UNyVUpRKlBo2BwF2H8bqPlRPBAUexPQE360L5PL5qXmJny-Wlx8p_6XxoWnrkOPs3EH0jXRdOUOOTHFX4kVTddF09LJDnfc6YZP90_uHkumTZDh93sjNO5dZrhMnHslwnPgideKR8iNXvOHE5XSukuWqs77zFK6RDEeuy1SukfIjV3lDrmo6V8VyXWR95ylcIxmOXFepXCPlR67qhlz1dK6a5brMEqlGEhyprlOpRsqPVPV_-t9_x_SR_M62nk4cL1WedY8CmScaHhFv966mb87Wvc3w-dDr-gNDPgy3OHzct8NVF_BvMbJiyYslK1YnYjwXKz72grfWrHrOi-esOOK8uKbpJSte8c4rVrzmxetrYmNkx2JLxm8ZRtYMr9ozjCyajpjzm4aRVUN-186zbw6f_gQAAP__fBjH5A==

# Ensure that even with more ordering columns, ordering propagates past local
# DISTINCT processors.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x
----
distinct        ·            ·            (x, y)  weak-key(y); +y,+x
 │              distinct on  y            ·       ·
 │              order key    y            ·       ·
 └── sort       ·            ·            (x, y)  +y,+x
      │         order        +y,+x        ·       ·
      └── scan  ·            ·            (x, y)  ·
·               table        xyz@primary  ·       ·
·               spans        ALL          ·       ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslc-OmzAQh-99imqua0TGdv5x4tDLXrrVtrcqB4pHK6QsjmxH2u0q714BkWjSMiaBI5Cfv5lvRs4H1NbQ1-KVPGQ_AUGABAEKBGgQsISdgIOzJXlvXfOTLvBo3iBbCKjqwzE0r3cCSusIsg8IVdgTZPCj-LWnZyoMuXQBAgyFotq3mIOrXgv3nr-9_wYBSdogn44h-5xLkSvYnQTYY-iP9qF4IcjwJMbjv1sXyKXLS3IuH0SOD4MIeQviS-VDVZchxcU1pWnIGXJkmqYGcWoQ11Nsd85QH2xd_3Q_si59UReOHzRyg05lkup7Rh0p4Dzq1ZRRRxC9Upxl1HK8Uskq1Unb981KIwWcla6nKI0geqVyFqVqvFLFKl0lbd83K40UcFa6maI0guiVqlmU6vFKNat0ndwjNII_C91OERpB9EL17Df8f3DP5A-29nTBGjp50Vz9ZF6o-7vw9uhK-uZs2WK6x6c2174w5EP3FbuHx7r71BT4dxjZsOTDkg2rizBehxVf9opHaza95MNLNhwhr6Y0vWbDG568YcNbPrydUjZGdiy2ZPyWYWTNcNKeYWTRdATObxpGVg35XbuufXf69CcAAP__Y0zCGA==

# Distinct processors elided becaue of strong key.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc
----
scan  ·      ·            (a, b, c)  ·
·     table  abc@primary  ·          ·
·     spans  ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJykk8FuszAQhO__U0RzNgIM_AdOvUaK0ipqT4WDg1cpUoKRbaRWEe9eYaSG0DR1mstKY-8wH6v1EY2StBYHMshfEYOBgyEBQwqGDCVDq1VFxig9tIyGpXxHHjHUTdvZ4bhkqJQm5EfY2u4JOZ7Fdk8bEpJ0OHxXkhX13sW0uj4I_fEgthUYwvXLanUqQVggLvBVeQGUPYPq7CnMWLEj5HHPfgA6cXSN0pI0yTOGsr-AvFaBasNs1ng5mp9Fx_6z4Fdn8e3fg6m4aRzcnynxYuJTplEkrqbeTIk_U_oL0wwgmIqwQObNlPozRdeYgtkiL0QjF_FC2TfSf9jgCygbMq1qDHktaDRsOMkdjc_BqE5X9KRV5WJG-eh87kCSseNtPIpl464c4NQcXzX_PzNHczO_Jzm5x5zeY85uMpf9v88AAAD__xB-s60=

query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c
----
distinct        ·            ·            (a, b)     weak-key(a,b); +a,+b
 │              distinct on  a, b         ·          ·
 │              order key    a, b         ·          ·
 └── render     ·            ·            (a, b)     +a,+b
      │         render 0     a            ·          ·
      │         render 1     b            ·          ·
      └── scan  ·            ·            (a, b, c)  +a,+b,+c
·               table        abc@primary  ·          ·
·               spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFr2zAYhu_7FeG9RsGW7KSpTz7sUijtKNtp8UG1PjpDagVJgY2S_z5sDSfxFtnE2UUg26-el-cz-kCtFT3Jd7LIvoODQYAhAUMKhiUKhp3RJVmrTfOJDzyon8hihqre7V3zuGAotSFkH3CV2xIyfJWvW3ohqchEzbmKnKy2LWZnqndpfuXytQRD9PTt8fG4LKIN-AbdKjYAw_PeZbOcs1ywPEFxYNB7d4RbJ98IGT-w8QU_V9ZVdemi1Xm7ltIgjSJD6g_2IlNcZB5R2h_V58xZLuYsT-YoDqGCPJ7UMDlryMePTQTH9teYFqebSZMb6NiJubvh5MR4L8koL-LUi98k7Zpe7WWgY-dlfUMvyXgv6YCXnoTF6SbaYHm1l4GOnZf7G3pJx3uJQ14WvftvJms14zPtfpC5UsdAtU7H8j9dfP9gvpDd6drSGfHSyXFzG5J6I3-LWr03JX0xumwxfvvc5toHiqzzb7nfPNT-VVPwNMyDYXEW5v2wCJMH0EkwnYbD6ZTey2B4FSavppDvguF1mLyeQr4Pzyoe-E3CP1mfXRw-_Q4AAP__mGPsQA==
