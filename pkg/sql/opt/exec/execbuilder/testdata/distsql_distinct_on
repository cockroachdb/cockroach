# LogicTest: 5node

statement ok
CREATE TABLE xyz (
  id INT PRIMARY KEY,
  x INT,
  y INT,
  z INT
)

statement ok
CREATE TABLE abc (
  a STRING,
  b STRING,
  c STRING,
  PRIMARY KEY (a, b, c)
)

statement ok
ALTER TABLE xyz SPLIT AT VALUES (2), (4), (6), (7)

statement ok
ALTER TABLE xyz EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], 0),
  (ARRAY[2], 2),
  (ARRAY[3], 4),
  (ARRAY[4], 6),
  (ARRAY[5], 7)

statement ok
ALTER TABLE abc SPLIT AT VALUES
  (NULL, NULL, NULL),
  ('1', '1', '2'),
  ('1', '2', '2'),
  ('2', '3', '4'),
  ('3', '4', '5')

statement ok
ALTER TABLE abc EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], NULL, NULL, NULL),
  (ARRAY[2], '1', '1', '2'),
  (ARRAY[3], '1', '2', '2'),
  (ARRAY[4], '2', '3', '4'),
  (ARRAY[5], '3', '4', '5')

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE xyz WITH DETAILS]
ORDER BY 1
----
start_key           end_key                              replicas  lease_holder
<before:/Table/62>  …/1/2                                {1}       1
…/1/2               …/1/4                                {2}       2
…/1/4               …/1/6                                {3}       3
…/1/6               …/1/7                                {4}       4
…/1/7               <after:/Table/107/1/NULL/NULL/NULL>  {5}       5

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE abc WITH DETAILS]
----
start_key                end_key             replicas  lease_holder
<before:/Table/106/1/7>  …/1/NULL/NULL/NULL  {5}       5
…/1/NULL/NULL/NULL       …/1/"1"/"1"/"2"     {1}       1
…/1/"1"/"1"/"2"          …/1/"1"/"2"/"2"     {2}       2
…/1/"1"/"2"/"2"          …/1/"2"/"3"/"4"     {3}       3
…/1/"2"/"3"/"4"          …/1/"3"/"4"/"5"     {4}       4
…/1/"3"/"4"/"5"          <after:/Max>        {5}       5

query T
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz
----
distribution: full
vectorized: true
·
• distinct
│ columns: (x, y, z)
│ estimated row count: 1,000 (missing stats)
│ distinct on: x, y, z
│
└── • scan
      columns: (x, y, z)
      estimated row count: 1,000 (missing stats)
      table: xyz@xyz_pkey
      spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: x, y, z
│
└── • scan
      missing stats
      table: xyz@xyz_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8ll9vqkgYxu_3U5D3qk2G4AwDKFduajcxaW23erHJpmmovG1NkfEwmKqN3_0EbVXgMGUg8U758_CbeX7JO58gf0Xgw_V_9zd_D0fGxWA4noz_vbk0xtc311cTI_s_HF1NjLuRcbEixpoYm0vj64fxz8PdrbFab4BALEIcBXOU4P8PFAgwIGADAQ4EHHgksEjEFKUUSfbI5-6FYbgCv0NgFi-WaXb5kcBUJAj-J6SzNELwYRI8R_iAQYiJ1QECIabBLNp9ZrXe9FfrzdPiHddA4EpEy3ks_W88IDBeBNkF02LwuCUglunxQzINXhF8ekI2HIDf2ZL6cIOZTGfxNLWcPFmfkj4jfbvw1eOLz2vjLZBvlW8d-ViBz6nkO6YvY5GEmGCYy9-lVq6Admot4QhmF8Bo9c41IhsJUyws6hSe_DMML8Lkt4nWd4w2dMxipsVrW0Z18A4duWezzK3ka2kZbWtZfudY_WJZ02K5abm1i2U6eIdt8c5WrFfJ17JY1rbY_M7Z9Yu1mxbrmpZXu1hbB--wLd2zFdut5GtZrN222PzO8frF8qbFembtWrkO3GFTemertVfJ17JW3rZWrnNQekC5ELHEWsO8U_iUSbOlYPiK-3VLsUymeJ-I6e7Z_d-7XdDuQogy3d-l-z_D-PuWTBMM5odz3mkSLSbR0ySWS6KnSY5ekludRDWheoooTSqqWCDTxKKOIqvExZQN2tVRdgnLVsvgatjAlVFOdRItJjlNvXL1klReaUKpvNKkUnqliaX0qsTlNvaqhOUpo7rVMrBiUrepDJ5ekkoGTSiVDJpUShk0sZQylLh6jWUoYdEfRo5i5tilrMZDp6sZpRJCF0tlhC6XUgldMKUTZbLmk6cM9sPo4dVS8FJWafbUlaKnGaWSQhdLJYUul1IKXTClFGWy0giqLQXPTqkvkfh4moXgg-M5ThB2HBNtFpjcQc98ZtQxeyF1OfbQ4zQ7sL9EwavMjsrjN_Gxy52sF9lB9yWIJBK4Dd5xgCkm81mcHd6nX3e2279-BwAA__8wPw9X

# Ensure that ordering propagates past local DISTINCT processors.
query T
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x
----
distribution: full
vectorized: true
·
• sort
│ columns: (x, y, z)
│ ordering: +x
│ estimated row count: 1,000 (missing stats)
│ order: +x
│
└── • distinct
    │ columns: (x, y, z)
    │ estimated row count: 1,000 (missing stats)
    │ distinct on: x, y, z
    │
    └── • scan
          columns: (x, y, z)
          estimated row count: 1,000 (missing stats)
          table: xyz@xyz_pkey
          spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x
----
distribution: full
vectorized: true
·
• sort
│ order: +x
│
└── • distinct
    │ distinct on: x, y, z
    │
    └── • scan
          missing stats
          table: xyz@xyz_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8l11vo0YUhu_7K9C52lUHwQxgDFdp41SylHW2ti9aVdEKwySx1gEXsGInyn9fYccfMOFojpF8F4N55_E7Tw7wBsX_Cwjh5p_vt38MR8aXwXAynfx9-9WY3NzeXE-N6vNwdD017kbGlzUzNsx4_Wp8_GH8Nb77Zqw3r8bdeHAzNv7811gDgzRL5Ch6lgWE_wEHBgIYOMDABQYe3DNY5lksiyLLq6-8bS8YJmsIbQbzdLkqq8P3DOIslxC-QTkvFxJCmEazhRzLKJG5ZQODRJbRfLFdZr15vVpvXn8sf8oNMLjOFqvntAj3pMBgsoyqA6Yl4P6dQbYqjwsVZfQoIeQnZMMBhPY704cbzItynsal5dXJrji7EuzKaax6vHC2MZ6i4qn1qiOfaPB5rXzH9FWa5YnMZVLL36a2_gJua_2EI5jTAOOk5iZZXsrc4kpxv7cu6DYX1KnisyI-VvmEapSZ2dISdqO3z3m8Bo-oF8D1veZnem0J03K1zeYUvIMXvYuZ3Wvl62g272o2qbm92UpxBLPrVQh9k8S5Jrmm1dM2SVDwDvvgX8wkv5Wvo0miq0mk5vYmKcURTKpX4eib5JxrUs-0fG2THAreYR_6FzOp38rX0SSnq0mk5vYmKcURTKpX4eqb5J5rkm9qe-RS4A67EFzMo6CVr6NHblePSM3tPVKKI3gUUB4Tx7JYZmkhtR7I7MZSJq-6k8mj3BVdZKs8lt_zLN5-d_fxbhu0PZDIotyd5bsPw3R_qihzGT0f3g9Ok3gziZ8miVoSP03yaEl-exInQnGOZBGxuNeeJahcAZKlcAl0C532LXQULAeNctupHIXKRaMExSwPjeq1J_FmUu9cR3u0JMxRIhTqKBELdZTKhTmqcPnoFvYRRxWs_tmOKlQBPvzsdiyh_EMrg1RXLZ8YhblFxULlooKhdpHJML1UMmWe1ndSIIKpZPhAxQxTwfCJyl0ETMlSRqquYn1iFKYYFQtVjAqGKkYmwxRTyfC7EEduQ45KpsxWbcVUMHy2cmS4ukqWMlx1FQuIUZhiVCxUMSoYqhiZDFNMJcPvRwK5HzkKmcCf7DHFgup14WGRvfyYJxCCP_NnIrATM44eYtOV_syMpCfMPud81pe-SAIO1QXRY1G9s0yespdt7nSzrN44HqJFIRl8i37KgSxl_jxPq9e2-OPM-_tvvwIAAP__zddHCg==

# Ensure that even with more ordering columns, ordering propagates past local
# DISTINCT processors.
query T
EXPLAIN (VERBOSE) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x
----
distribution: full
vectorized: true
·
• distinct
│ columns: (x, y)
│ ordering: +y
│ estimated row count: 100 (missing stats)
│ distinct on: y
│ order key: y
│
└── • sort
    │ columns: (x, y)
    │ ordering: +y,+x
    │ estimated row count: 1,000 (missing stats)
    │ order: +y,+x
    │
    └── • scan
          columns: (x, y)
          estimated row count: 1,000 (missing stats)
          table: xyz@xyz_pkey
          spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: y
│ order key: y
│
└── • sort
    │ order: +y,+x
    │
    └── • scan
          missing stats
          table: xyz@xyz_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8l9GOokgUhu_3Kci5mskUgSoQgSt3Wzcx6dFZ9WI3GzOhoew2o-ICpqU7vvsGdRehpk5TaLxE5D8fP1-O8g7pPyvwYfDnt8dfhyPtU384nU3_ePysTQePg4eZVhwPRw8zbTzSPuWftT3Rcu33yfirts_ftPGkP5hov_2l5UTbA4FNHPFRsOYp-H8DBQIMCFhAwAYCHZgT2CZxyNM0ToqvvB8vGEZ78E0Cy812lxUfzwmEccLBf4dsma04-DALnlZ8woOIJ4YJBCKeBcvVccw-f-vt87fv2x88BwIP8Wq33qT-kRQITLdBcaQbDOYHAvEuK6ekWfDMwacXWMM--OaBNCebxknGE6NTheqxL6RHv0hHstrIjsrI_jLNlpswM6hZnwoExknEEx75Wq9-x2XCU669BOmLcPX8UCJaNUQqr6UMjk_DZWWgNyNUiN5MCWrXQeVlfgz6c8hRrMdbg1XrlvF0ajysWhxtbjptY7rBdMNu7DpVYTu77lznuqMystSD3tN1eS23cV2osK3r1TJZc7dYK7ds3XAau8VU2M5uda9zq6sysnwc7J5uyWu5jVtChW3dqpZpNXfLauWWoxvdxm5ZKmxnt9zr3HJVRpaPw7qnW_JabuOWUGFbt6pl2s3dslu51dUbm2WrkJ3N8q4zy1MZWT4M-55myWu5jVlChW3N8lT-Sk94uo03KW_0x86sjdJpcUs8euanGtJ4l4T8WxKHx--eDsfHoOMHEU-z01l6Ohhu_juVZgkP1v-_fFwmUTSJyZM69SRWT6KXSVYliV4mUQEKj3KRKEUqyuRZTBGLOkiWIhcz5VmWwGWhz9BGogQsG9dBxawOGuXIk2g9yUGTuvIkp57Ube2oAIVHYY4qUqGOKmKhjipyoY4KXG5rRwUsD19-ptwHJmy_DxYp4ntXyBJWaWO5RC48C7NLlQvVSxUM9UuVDBVMJBM2amPDRDB8o1JbroUlZOErlXbkWa6QJezUxoqJXHgWppgqF6qYKhiqmCoZqphIhv8QYYqJYMJyrWrhyrWwhSx8uVJPnuUJWcJ2bayYyIVnYYqpcqGKqYKhiqmSoYoJZAz_QcIU84rXhcUqfv2-jMAHx1lYYehSfbFwTd32mKN7zHvS7cixQtsKmBtYUFwQPKfFO8v0JX495s7ybfHGsQhWKSfwNfjB-zzjyXq5Kd6mwvOZw-GXfwMAAP__TjheRg==

# Distinct processors elided becaue of strong key.
query T
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc
----
distribution: full
vectorized: true
·
• scan
  columns: (a, b, c)
  estimated row count: 1,000 (missing stats)
  table: abc@abc_pkey
  spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc
----
distribution: full
vectorized: true
·
• scan
  missing stats
  table: abc@abc_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyklF1vmzwUgO_fX2Gdq1YyCjbmXcPVpiSTkFLSJZk0aYkqA6cpKsEME3VVlP8-mXQNsHQi7Mbi-OM5Dwcf9qB_pODB5Nvd9JMfkKuxv1guvkyvyWIynYyWxMR-MFqSWUCuJCUhJdE1eX0gn-ezWyLDCChkKsZAblGD9x0YUOBAwQEKAii4sKaQFypCrVVhtuyrA378EzybQpLlu9JMrylEqkDw9lAmZYrgwVKGKc5RxlgMDDfGUiZplUaG0UcZRvf5E74AhZFKd9tMe7_1gMIil2ZiEHydTk-DNVgBW8HbyFcA6wMFtStPHrqUGwSP1cT9MXjsQN9xPynvMlXEWGDc0F0fzrxdoCyVD9zWxvMqvKXiNlRY9zLyvmX8o2xWPbiwkryhz7vrO_-qz-v6x8CpRnGBvtPQd7rri_76LVerHgxW4F6gLxr6oru-3VPfajUhkVlMGFHlIxadre13u--M9Rx1rjKNnZrLbmWymGlXjDd47G2tdkWEd4WKqr3HcFaBqokYdXlcZcfAz6olZjIUKLdvP486if2V9H-DZNdJdpvE-zrxNsnpS3LaJNGXJNokty_JNl_xIVXP90kMHkSSc86GzBIMmSXwg7SkQMe6QZuHQkTDoXsD5oDcaHOVFo_qucIuX3JzER5kqpHCrXzCMZZYbJMs0WUSva4cDv_9CgAA__-hgU2-

query T
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c
----
distribution: full
vectorized: true
·
• project
│ columns: (a, b)
│ ordering: +a,+b
│
└── • distinct
    │ columns: (a, b, c)
    │ ordering: +a,+b
    │ estimated row count: 1,000 (missing stats)
    │ distinct on: a, b
    │ order key: a, b
    │
    └── • scan
          columns: (a, b, c)
          ordering: +a,+b,+c
          estimated row count: 1,000 (missing stats)
          table: abc@abc_pkey
          spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a, b
│ order key: a, b
│
└── • scan
      missing stats
      table: abc@abc_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzEl19vokoYh-_Pp5i8V206RIY_olx5TvUkJlZ71JPsZjXNAGM1VXAZTLdp_O4bYFcFypRhSbyZZAb5zTMvT_KO78C_b8GGwZfH0d_DMbrpD2fz2X-jWzQbjAb3cxTPh-P7OZqM0Q3FyLlF8Yj-nU4eEHVcNJn2B1P0z9dkGSMXMPiBx8Z0xzjY34AABg0w6IDBAAwmLDHsw8BlnAdh_JP35IWh9wNsFcPG3x-ieHmJwQ1CBvY7RJtoy8CGOXW2bMqox8JWnOuxiG62yTbUcXvUcZ_2L-wNMNwH28PO5_YF1WxP44XW-P_R6DworQWQBZxGbQGwPGIIDtGZg0f0mYFNLsCHfbDJEVdn7294tPHdqNXOgvcI7sX1mYQeC5lno3Qhy3COcd7QmvL1RxnL4xlVy6G2S1HP0UFKkI--wz3tDvf0u3SD0nMRUuNgZ2I9X9zy6lZD_hh3HCjBvkXM7CuTQ_QZn5HnMzN8pLq5Wl1zC6YqlxNJeTUZ_NNHtq4hr1WK2py8WrPyZqurVZdD_1M5tEs50omejIaEHLoM_qmInWvI0SlFbU4OvVk5stXVq8th1JcjZ4JyOWktwJSQw5DBPxWxew05uqWozclhNCtHtrpGdTnUmnIouRsRor6HCAqiNQsrO6HKUJ9qZ17DCbMUtTkn1GadUGUumlPG94HPWQahbCs1t5VC4oMx75mlBeHBIXTZYxi4yW_T6SQJShY8xqP0KUknQ__3Ix6FjO5O9-TLJJJPIpkkMxNFLqPaclFaeRKRpGoLoiSpuuVRmmytBCfUClia8Avq5VF6AUsXy9Aut0HNRxnCKLM8ScsnmbW9suSiRF5JUom8kqQSeSVbK5FXBax2ba8KWJYwqlMug55P6tSWoSMXJZJBkkokgySVSAbZWolkKGB1a8tQwCKftBxBzzEKWfWbTlcySySELJfICFkukRLS9RI5UQSr33mKYJ-0HkOi9ZBC76kshSmZJZJClkskhSyXSArpeomkKIIVWlBlKdT4lrraBq9PGy_-J-AYK4u0mWKq1FQMqnlKhzqO4qzUjuWqK4sQC-IX6DOPr8qzdfCa5M7f9vFFd0W3nGF4oC-szyIW7jZ-fJV3fz05Hv_6GQAA__8PBGRE
