# LogicTest: 5node-dist

statement ok
CREATE TABLE xyz (
  id INT PRIMARY KEY,
  x INT,
  y INT,
  z INT
)

statement ok
CREATE TABLE abc (
  a STRING,
  b STRING,
  c STRING,
  PRIMARY KEY (a, b, c)
)

statement ok
ALTER TABLE xyz SPLIT AT VALUES (2), (4), (6), (7)

statement ok
ALTER TABLE xyz EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], 0),
  (ARRAY[2], 2),
  (ARRAY[3], 4),
  (ARRAY[4], 6),
  (ARRAY[5], 7)

statement ok
ALTER TABLE abc SPLIT AT VALUES
  (NULL, NULL, NULL),
  ('1', '1', '2'),
  ('1', '2', '2'),
  ('2', '3', '4'),
  ('3', '4', '5')

statement ok
ALTER TABLE abc EXPERIMENTAL_RELOCATE VALUES
  (ARRAY[1], NULL, NULL, NULL),
  (ARRAY[2], '1', '1', '2'),
  (ARRAY[3], '1', '2', '2'),
  (ARRAY[4], '2', '3', '4'),
  (ARRAY[5], '3', '4', '5')

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE xyz]
----
start_key  end_key  replicas  lease_holder
NULL       /2       {1}       1
/2         /4       {2}       2
/4         /6       {3}       3
/6         /7       {4}       4
/7         NULL     {5}       5

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE abc]
----
start_key        end_key          replicas  lease_holder
NULL             /NULL/NULL/NULL  {5}       5
/NULL/NULL/NULL  /"1"/"1"/"2"     {1}       1
/"1"/"1"/"2"     /"1"/"2"/"2"     {2}       2
/"1"/"2"/"2"     /"2"/"3"/"4"     {3}       3
/"2"/"3"/"4"     /"3"/"4"/"5"     {4}       4
/"3"/"4"/"5"     NULL             {5}       5

query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz
----
·          distributed  true         ·          ·
·          vectorized   true         ·          ·
distinct   ·            ·            (x, y, z)  ·
 │         distinct on  x, y, z      ·          ·
 └── scan  ·            ·            (x, y, z)  ·
·          table        xyz@primary  ·          ·
·          spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslF2Lm0AUhu_7K4ZztQsn-JmP9cqym4KQJtskF4XFC6uHRXDVzoyQD_LfixqydWnGadyLQEZ953kfzjBHEL8z8GAzX8wft6ziGfu2Xn1nL_Ofz4uvwZLdPQWb7ebH4p6dP6nXwfJxy1ZLdrdDtkd2uGfnP214tz-EgJAXCS2jNxLgvYAFCDYgOIDgAsIYQoSSFzEJUfD6k2MTCJIdeCZCmpeVrB-HCHHBCbwjyFRmBB5so18ZrSlKiBsmICQkozRrMCVP3yK-93f7AyBsyigXHhsZNXlVSY_5NvoO-i6EJ4Siku8QIaNXAs86oX6Rp1TINI-lMe628C1sQFcp9lXK--ZVXvCEOCXdvdNc4vkH4UlVyjL_s5XTaWXpD8HSGIJhjwz3xjH0VLkYTwaNwdYXtnWE3VFT6BbhnioX4ekgYUdf2NERnoyaQrcI91S5CM8GCbv6wq6O8HR0o25PkYvuw6fdK_-grEmURS6ow7i2s1lfNZS8UntJiaLiMT3zIm4w7XLV5JoHCQnZvrXaRZC3r-qCf4ctZdjuhK2PYVtN7kE7yrSrDrtDeo-V4YmaPBlCnirDMzV5NoT8oJ6V2XNM1IfsIzs8ffkTAAD__0Wg12M=

# Ensure that ordering propagates past local DISTINCT processors.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x
----
·               distributed  true         ·          ·
·               vectorized   false        ·          ·
distinct        ·            ·            (x, y, z)  +x
 │              distinct on  x, y, z      ·          ·
 │              order key    x            ·          ·
 └── sort       ·            ·            (x, y, z)  +x
      │         order        +x           ·          ·
      └── scan  ·            ·            (x, y, z)  ·
·               table        xyz@primary  ·          ·
·               spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (x,y,z) x, y, z FROM xyz ORDER BY x]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lV-L2kAUxd_7KYb7tEtH4iTjvzylXS0IVrfqQ8viQ2qGJZDNpDMTiIrfveQPpLF1Jhvtg-AkOfec--PAnED-isCFzWwxe9qiVEToy3r1Fb3Mvj8vPs2X6GE632w33xaPqPokP8-XT1u0WqKHDKMDRsdHVP0pxdnhiFbr6WyNPv9A2Q4wxDxgS_-NSXBfgAAGGzA4gIEChgHsMCSC75mUXOSfnArBPMjA7WMI4yRV-eMdhj0XDNwTqFBFDFzY-j8jtmZ-wITVBwwBU34YFTaJCN98cfCywxEwbBI_li7qWbnzKlUu8mzsOdijsDtj4KmqTaTyXxm45IzbB9lwoZiwBs0MHvl4dbz9nvHTUKow3iuL9C8dcLFIvpUImGCBizxy1dS5alp78XJO0yeMFa5-gKu9tDn_IvGunLSRk7QvAWlRAsvuWbRjDQxRqhoMu9bAML7GS-5YA7s9XrsNXtorAHTBa4hS4R11xWsYX-O174jXaY_XaYN32CsAdMFriFLhHXfFaxhf43XuiJe2x0vb4B31OsI1BKngTrrCNYyv4dL_dEP8w3TNZMJjyRqO1yb38wuDBa-svG4kT8WePQu-L2zK46rQFQ8CJlX5lpSHeVy-ygP-KSZasa0X21qx0xCTS7Gjjz3UW1OteqAXD7Rig_PwlqVHWvFY7zzWiid68eSW2MTQMVPJ9C0jhpqRm3pGDEWjBnN904ihakTftcvsu_OH3wEAAP__6_T0Lw==

# Ensure that even with more ordering columns, ordering propagates past local
# DISTINCT processors.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x
----
·               distributed  true         ·       ·
·               vectorized   false        ·       ·
distinct        ·            ·            (x, y)  +y
 │              distinct on  y            ·       ·
 │              order key    y            ·       ·
 └── sort       ·            ·            (x, y)  +y,+x
      │         order        +y,+x        ·       ·
      └── scan  ·            ·            (x, y)  ·
·               table        xyz@primary  ·       ·
·               spans        ALL          ·       ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (y) x, y FROM xyz ORDER BY y, x]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslVtv2jAYhu_3K6zvqlWNgp1wyhVbYRISgw642FRxkRGrikRjZjtSUsR_n3KQ0rBim4bLHN48r5_vk3IE-XcPPqyn8-njBiVij76vlj_Q8_TX0_zrbIHuJrP1Zv1zfo-qV_Lr2eJxg5YLdJfdoxSjrMyk2RtaribTFfr2G2UYpVvAEPOQLYJXJsF_BgIYKGBwAYMHGHqwxXAQfMek5CJ_5VgEZmEKfhdDFB8Sld_eYthxwcA_gorUnoEPm-DPnq1YEDLhdAFDyFQQ7QvMQUSvgcjGafYGGNaHIJY-6jg5eZkoH40pHruwPWHgiaoJUgUvDHxywvYt1lwoJpxes8CYPuAxebiIoNcgJpFUUbxTDumeU_IDiZAJFuaHuohzL-JqCi-_0yREscJRrAC_O5G24X8eLBt6jYbEfvLEYvIO7TjeZ2Zv6FHNvt9m9gZEbZbcZPbU3iy1Met1iuNfbdbQozI7aGPWgKjN0puYde3NujZm-53i-FebNfSozA7bmDUgarPuTcx69mY9G7ODzme8GlpUXkdtvBoQtVfv5v-BD3ArJg88lqzBuvTlbv5bYOELK38qkidix54E3xWY8nJZ5IobIZOqfErKi1lcPsoLvg8TbZjqw1Qbdhthch529bX7erSnTff04Z42bCD32xx6oA0P9eShNjzSh0dtahPDjpmWTL9lxLBmpNWeEcOieQa4ftOIYdWIftfOu29PX_4FAAD__x3W62E=

# Distinct processors elided becaue of strong key.
query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc
----
·     distributed  true         ·          ·
·     vectorized   true         ·          ·
scan  ·            ·            (a, b, c)  ·
·     table        abc@primary  ·          ·
·     spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (a,b,c) a, b, c FROM abc]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJykk82K2zwUhvffVYh3NQMyjn_yLbxqmaZgcJ1pkkJh4oViHVKDx3IlGVpC7r3YHpo4nSlKs1HySnp8Hh-ODzDfayRYL7LFw4Z1umYfV8tP7Gnx9TF7n-bs7kO63qw_Z_fs5Uqf0_xhw5Y5uxOc7Tgr79nLnxEWu7IAR6Mk5eKZDJInBOAIwRGBIwbHHAVHq1VJxijdXzkMQCp_IJlxVE3b2X674CiVJiQH2MrWhAQbsatpRUKS9vvnSrKiqocyra6ehf75TuxKcKxb0ZiE-fmXLDstnr9FsMXvNdwCxZFDdfZU01ixJyTBkb_hddLpGqUlaZJTFWN11ez55AfF8ZX3yZWnWn8-wd8SCidCgXujQpdG_dEY7zxc1avQXS26Ri08VxtDNKyxs1rkrha7qV14eOfB32LurBa7q80c1LyL0WeikSxgyn4j_Q8z_4rRikyrGkNOwzvrp5_knsYPyKhOl_SoVTmUGeNy4IYNScaOp8EY0mY4GgTP4eCv8P8TeHYJh7dUjm6B41vg-VVwcfzvVwAAAP__U2Lf8g==

query TTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c
----
·               distributed  true         ·          ·
·               vectorized   true         ·          ·
render          ·            ·            (a, b)     +a,+b
 │              render 0     a            ·          ·
 │              render 1     b            ·          ·
 └── distinct   ·            ·            (a, b, c)  +a,+b
      │         distinct on  a, b         ·          ·
      │         order key    a, b         ·          ·
      └── scan  ·            ·            (a, b, c)  +a,+b,+c
·               table        abc@primary  ·          ·
·               spans        ALL          ·          ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT ON (a, b) a, b FROM abc ORDER BY a, b, c]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lOGPmjAYxr_vr2jeT3exRgvoeXxiO11i4uSGLtly8qFC40g4ytqSbDH-7wuwoLhZetF9KXkLT5-nv5e8e5A_UnBhNVvMntaoECn6GPif0Mvs6_Pi_XyJ7qbz1Xr1eXGP_nxS1vPl0xr5S3RHMdreo3KtZXQbIT-YzgL04Vu1jVEUAoaMx2xJX5kE9wUIYLAAgw0YHMAwghBDLnjEpOSi_GRfCebxT3CHGJIsL1S5HWKIuGDg7kElKmXgwppuUxYwGjMxKM-NmaJJWtnkInml4pdHtxFgWOU0ky4aLL8sFselP9gA2UCzWhuA8ICBF-roKRXdMXDJAZvnmiZSJVmkBuN2KI9gr7y7L2ImWOyieuOSp3XR82jF66PaPlKJJNvh1gMweKSHPauHPbsH4UGXmwyNgmPwC9V1C7t1C2LeUcuko391sH9avKmpHdEaOA83bKpljsN-Cw7rFEdd2NXqGOPoiNbgmNwQh22OwzHDcXb3_mkx2MDIGEdHtAbH4w1xOOY4hgY4-mfzD9EsRgRx9Z0JQwodiRoKo_80-P7hGTCZ80yyluOlk4fl2GPxjtVTVPJCROxZ8KiyqUu_0lUbMZOqfkvqYp7Vr8qAp2KiFVstMTkXW3rnDmtbq3b0Yuea3COteKx3Hl_j_KAVT_TOk2ucH_W9Gnb8Jvqf7Nw7PLz7HQAA__9E5Aw4
