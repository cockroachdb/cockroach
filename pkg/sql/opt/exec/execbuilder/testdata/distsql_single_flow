# LogicTest: 5node

statement ok
CREATE TABLE t (a INT PRIMARY KEY, b INT, c INT)

# Move the single range to a remote node.
statement ok
ALTER TABLE t EXPERIMENTAL_RELOCATE VALUES (ARRAY[2], 2);

# There are no stats on the table, so the single flow should stay on the remote
# node.
query T
EXPLAIN (VEC) SELECT * FROM t AS t1, t AS t2 WHERE t1.a = t2.b
----
│
├ Node 1
│ └ *colrpc.Inbox
└ Node 2
  └ *colrpc.Outbox
    └ *colexecjoin.hashJoiner
      ├ *colfetcher.ColBatchScan
      └ *colfetcher.ColBatchScan

query T
EXPLAIN (DISTSQL) SELECT * FROM t AS t1, t AS t2 WHERE t1.a = t2.b
----
distribution: full
vectorized: true
·
• hash join
│ equality: (a) = (b)
│ left cols are key
│
├── • scan
│     missing stats
│     table: t@t_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: t@t_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJysklFv2jAQx9_3Kax7gskpsQ2si1QpVWEqE4WOIG3SVFVOfEDUEGe2o65CfPcpoVshGnSb9mbfnX_3_59vA_ZbBgEMv9yOL0cT0hqMonn0adwm0XA8vJqTt-TDbHpDHLmMiGP0-cDJ5-vhbEgcO5Pkgjh-FgOFXCucyDVaCL4CAwoc7igURidorTZVeFMXjdR3CHwKaV6UrgrfUUi0QQg24FKXIQQw0Z4uOgIoKHQyzeqyLQVdupdH1sklQtDd6zIaQCC2dK8RO91oLuMMZygVmo5_0A5c6O6LB3wCClc6K9e5DYikJKYkAQpRIauAB8dksYYs_19lsf8qizdksaOyXtSUuTYKDarmf7xe8htv19KuPuo0R9Phh9YyXLhWyNoXJl2uXCvkbaAwLV1AQkZDTkNBwy4NezTsH_UnGv74gb9X1m6GttC5xT_aO7_RyWOVW1RL3E3P6tIkeGt0UtfurtMaVAcUWrfLdneXUf4zZZ1Buf61NfskdpIkDkjsJIn_BYnvk1iTJE6S_OPueDWxRaYf71MFASxixpKeRK_bF77XFed9Lxbn7z3u-0pwJfo9fAfVA7m01bdFK_1YY-dPRTX0hcwsUriRDzhAh2ad5ql1afKc2W7f_AgAAP__p7SVZQ==

# Inject stats so that column 'b' has few unique values whereas column 'c' has
# many unique values.
statement ok
ALTER TABLE t INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 10000
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 3
  },
  {
    "columns": ["c"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 10000,
    "distinct_count": 100
  }
]'

# Now check that the single flow with a join is moved to the gateway.
query T
EXPLAIN (VEC) SELECT * FROM t AS t1, t AS t2 WHERE t1.a = t2.b
----
│
└ Node 1
  └ *colexecjoin.hashJoiner
    ├ *colfetcher.ColBatchScan
    └ *colfetcher.ColBatchScan

query T
EXPLAIN (DISTSQL) SELECT * FROM t AS t1, t AS t2 WHERE t1.a = t2.b
----
distribution: local
vectorized: true
·
• hash join
│ estimated row count: 10,000
│ equality: (a) = (b)
│ left cols are key
│
├── • scan
│     estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
│     table: t@t_pkey
│     spans: FULL SCAN
│
└── • scan
      estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
      table: t@t_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyskl9r2zAUxd_3KcR9asZ1aylJaQUFlyajGWnTxYENRiiydZOYOpYnyXQl5LsPO2VNTLvRsTfr_vndcw7egPuRg4Tht7vx5eiWHQ1G8Sz-Mu6weDgeXs3YR_ZpOrlhnl3GzHN8_hDs6_VwOmSeHyt2wbw4TgChMJpu1ZocyO_AYY5QWpOSc8bWpU0zMNI_QYYIWVFWvi7PEVJjCeQGfOZzAgkzleQ0JaXJnoSAoMmrLG-wPvL35QM9AcKVyat14SRTyBJkKSDEpaoLAcy3CKbyLyecV0sCyfc0jQYgwy3-myz-X2WJliz-pqwXNVVhrCZL-kDJvN7828gr3q6VW302WUH2RBxay2nhjyLeubDZcuWPItEBhEnlJYs4RgKjLkY9jPoYnb7pr9vyJ94T-5RcaQpHbZ-vXgpblwJeuyW9pF16zlQ2pTtr0mZ295w0oKagyfldV-weo6Jp8fqCJbX-_dfsk_g7SGKfxNsk8UdS94AUHmqaIyxy83ifaZCgNVH3NOEBnWkd9Pq9RXCe6DRIzrgIF-dpr9_tQb2glq4OO16ZxwY7eyrrqBYqd4Rwox5oQJ7sOisy57P0ubPdfvgVAAD__3k_W0I=


# If we add a not very selective filter, the flow is still moved to the gateway.
query T
EXPLAIN (VEC) SELECT * FROM t AS t1, t AS t2 WHERE t1.b = 1 AND t1.a = t2.a
----
│
└ Node 1
  └ *colexecjoin.mergeJoinInnerOp
    ├ *colfetcher.ColBatchScan
    └ *colexecsel.selEQInt64Int64ConstOp
      └ *colfetcher.ColBatchScan

query T
EXPLAIN (DISTSQL) SELECT * FROM t AS t1, t AS t2 WHERE t1.b = 1 AND t1.a = t2.a
----
distribution: local
vectorized: true
·
• merge join
│ estimated row count: 3,333
│ equality: (a) = (a)
│ left cols are key
│ right cols are key
│
├── • scan
│     estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
│     table: t@t_pkey
│     spans: FULL SCAN
│
└── • filter
    │ estimated row count: 3,333
    │ filter: b = 1
    │
    └── • scan
          estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
          table: t@t_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJysktFr2zAQxt_3V4h7aja5iWQ3XQUFlyZlHm3axYENRiiyfU5NHcuTZLoS8r8P22VNTJMtY2_W6fz7vk93KzA_chAw_nZ3fRFMyNEoCGfhl-seCcfX48sZeU-uprc3xJKLkFhGXz44-fppPB2TI8uOI3JOWI9cTEbNUZJzYvmx7AGFQiU4kUs0IL4DgzmFUqsYjVG6Lq2ahiD5CWJAISvKytblOYVYaQSxApvZHEHATEY5TlEmqPsDoJCglVneYK1v78tHfAYKlyqvloURRFISURIDhbCUdcGB-ZqCquyrhLFygSDYhqdgBGKwpv9mi_1XW7xjix1i6yrLLWrUfb7tqa0L4vN6ZEKIYDL7uNOC27HAd1p4Va4KpRPUmGwJz-s__9TyRo4b1Av8rLICdd_djpJjao989qF3rrPFQ_sJFG4rK4jvUf-E-kPqM-pz6rs7I3qdiO4hrzxRjir7Xjfpm0InHSHvEKEpmlIVBv9KadBRclj9spgssJ2UUZWO8U6ruOltj7cNqCkkaGx767aHoGiuWK2gUS5_b-Mmie0l8S3SYJM06JL4AZ74Jol3Se5ekrfbk9sleXtJJ_vSzSmkuXq6zxIQ4A2jyJWcO6cx4443TCNHSpc77DQ-O5WSpWfDep3SXC5MvQDhg3pqsLPnsh5fKnODFG7kI47Qol5mRWZsFr_crNfvfgUAAP__b4vbwA==

# However, if we add a selective filter, the flow is kept on the remote node.
query T
EXPLAIN (VEC) SELECT * FROM t AS t1 INNER MERGE JOIN t AS t2 ON t1.a = t2.a WHERE t1.c = 1
----
│
├ Node 1
│ └ *colrpc.Inbox
└ Node 2
  └ *colrpc.Outbox
    └ *colexecjoin.mergeJoinInnerOp
      ├ *colexecsel.selEQInt64Int64ConstOp
      │ └ *colfetcher.ColBatchScan
      └ *colfetcher.ColBatchScan

query T
EXPLAIN (DISTSQL) SELECT * FROM t AS t1 INNER MERGE JOIN t AS t2 ON t1.a = t2.a WHERE t1.c = 1
----
distribution: full
vectorized: true
·
• merge join
│ estimated row count: 100
│ equality: (a) = (a)
│ left cols are key
│ right cols are key
│
├── • filter
│   │ estimated row count: 100
│   │ filter: c = 1
│   │
│   └── • scan
│         estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
│         table: t@t_pkey
│         spans: FULL SCAN
│
└── • scan
      estimated row count: 10,000 (100% of the table; stats collected <hidden> ago)
      table: t@t_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJysktFP2zAQxt_3V1j3BJtDaycdnSWkIAhbEE1ZW2mTJoTc5FIi0jizHTGE-r9PSdhoo7Ws096a786_-77rPYH5noOA4Ov11WkYkYPzcDqbfr46JNPgKjibkbfkYjIeEUtOp8QyEkZRMCGjYPIxIJfjMHoucDKOiGVHkpwQy48k-fIpmAS1EpMTwoBCoRKM5BINiG9QCxxuKJRaxWiM0rX81DSFyQ8QfQpZUVa2lm8oxEojiCewmc0RBETKUWXPAwoJWpnlTduKgqrsyyNj5QJBDNamhOcgvBVdG8R2D5rJeY4TlAnqXn9jHFjf3pb3-AgUzlReLQsjiKRkTkkMFKalrAUHttliHVv9fWxdZLlFjbrHNj21uiC-W29dCBFGs-FWC7xjgf3rZvh_3YzbscW32npxUxVKJ6gx6Z7E6y1_yDZCvcBLlRWoe-5mthxTe-Czd4cnOlvctT-BwriygviM-pz6LvU96g-o_35rRK8T0d2I-MrxT9CUqjD4V9ff70xyWB0YkwW2CzSq0jFeaxU3ve3nuAE1QoLGttVB-xEWv0rGapTL37e7TmI7SXwPEt9J8jZIbJ3EuiR3DxJfJ_EuydtJ6m9P59a7T3P1cJslIICxofS8NHE8Nj92vGMeO0M2TJ1YynnaPx7MWfIB6gdyYeoDmN6phwY7eyzrvy-VuUEKI3mP52hRL7MiMzaLnyur1ZufAQAA__-wjOAW
