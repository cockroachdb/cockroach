# LogicTest: 5node-dist-opt

statement ok
CREATE TABLE t (k INT PRIMARY KEY, v INT, w INT, INDEX v(v))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split the index into 5 parts, as if numbers were in the range 1 to 100.
statement ok
ALTER INDEX t@v SPLIT AT SELECT (i * 10)::int FROM generate_series(1, 4) AS g(i)

# Relocate the five parts to the five nodes.
statement ok
ALTER INDEX t@v EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i+1], (i * 10)::int FROM generate_series(0, 4) AS g(i)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM INDEX t@v]
----
start_key  end_key  replicas  lease_holder
NULL       /10      {1}       1
/10        /20      {2}       2
/20        /30      {3}       3
/30        /40      {4}       4
/40        NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM t WHERE v > 10 AND v < 50]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkDFLBDEUhHt_RZhKIWJWESTVCSJss8pxnaaIyXAE9jZLkgXlyH-X24CHhWA58703b3hHTNFzsAdm6Dd0MBJzio45x3Sy2kDvP6GVRJjmpZxsI-FiIvQRJZSR0NjZj5FbWs90oyDhWWwY19g5hYNNX5sCiWtIPIexMGlxubkV74tSdxSd0lr3w-7hSjwOT2fixP0PgakScSnnDrnYPaG7Kv_fc8s8xynzV8W_klU1EvR7tl_kuCTH1xTdeqbJl3VvNTxzabRrop8aqqZefAcAAP__e11zmQ==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM t WHERE v > 10 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkEFLxDAUhO_-ijInxcgmFUFyqiBCL1XWvWkPsXkshW5TXl5BWfrfpQ24rrCix5nJfBneHn3wVLkdRdgXGNQKA4eGYgw8W-lB6d9htULbD6PMdq3QBCbYPaSVjmCxcW8drcl54pWGgidxbbdgB253jj8KgcIVFB7aTohtdl7k2euo9TVlRltry2pze5HdVfeHpMluvhLUk0IY5bAhitsSrJnU33c-BxbilTmeWOSXJ_H5f_BrikPoIx3hT5H1VCuQ31I6dQwjN_TEoVm-SfJx6S2GpygpNUmUfYrmgd_L5tdy_qNcT2efAQAA__-Ou6aW

# Here we care about ordering by v, but v is not otherwise used.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT w FROM t WHERE v > 10 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkUFLxDAUhO_-ijAnxcgmXQTJqYIIvXRl3Zv2EJvHUug2JXkFZel_lzZgXWFFj28mM99Ajui8o9IeKMK8QKOS6IOvKUYfJik9KNw7jJJoun7gSa4kah8I5ghuuCUY7OxbS1uyjsJKQcIR26ada_vQHGz4yBkSN5B4bFqmYMRlnonXQak1Ca2MMUW5u7sS9-XD4tTi9suBxGZgI_JM5mtUo4QfeBkU2e4JRo_y76OffWAKK326N9fXC-ssKPsPaEux912kE9C5ZjVWEuT2lH4g-iHU9BR8PWPSuZlzs-AocnJ1OoouWdPA72H9azj7Ea7Gi88AAAD__0AFrBw=

# The single join reader should be on node 5, and doesn't need to output v.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT w FROM t WHERE v > 40 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkT1rwzAQhvf-ivLOCracZtGUNR2SEroVD6p1BIGjE5JcWoL_e7FUaFyI24738byPOF3g2NBenylCvUBCYINWwAfuKEYOU7ss7cw7VC1gnR_S1G4FOg4EdUGyqSco7HnFvmogYChp2-e1UYCH9A3FpE8EtR7FVbBcDn7Wrz0dSRsKVT2Lx9s2QaB6kKtqM40OQ1L3W4lbXvkf7yNb96WVc60P9qzDR5YX5fqmspkpf7nhkaJnF-lPR6zHVoDMico_RR5CR0-Bu6wp5SFzuWEopjJdl2Lnymh64DUsF-FmGW4W4foH3I53nwEAAP__LtzSZg==
