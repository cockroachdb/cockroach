# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 6 (48 B, 12 KVs, 6 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 4
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 4
                  KV pairs read: 8
                  KV bytes read: 32 B
                  KV gRPC calls: 4
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0leFu4kYQx7_3KUbzJYnqiF3bodxWlWgI19I2RwToqlON0J494SzsXd_u0hBFPFZfoE9W2Q4ROIEEtfUHw86M_56dH__lAe3XDAWO-7_1exNYwPvR8BrmpGdOfs4Ifv-5P-qDdbNUOTKWYmdPT8ajwdUPfvsd73x_Mxx8mJyGjDEWQPXBgrMTIX7qD6_7k9Enr9TKz2A4uuqP4PITLNBDpRP6IHOyKP5AjlMPC6NjslabMvRQFQySFQrmYaqKpSvDUw9jbQjFA7rUZYQCJ2WPI5IJmRZDDxNyMs0q2actdMsGZqlKaIUe9nS2zJUVsKg7Qw_HhSwDrQgvo2h1m0TRirMoWrHXbnh-7DM8QpAqgYCBdl_IWPTw14_g0pwEsL__elzHWjlSLtXqWcroOwsJxTqhREBYBz_fO7JgSCYCAh8u6-h8dNODWGaZfSosZGo2hR308PpjrwfWUQGxXioHp7RyrVS5MwGsGmhdQLTYV1D1o5euWLryLdO1h_XqkZh1ck4o-BbiwRUKtvbeTnmg_iTjKHmfZo4MmRbfRb3J91eFAa2gywXYEipYJ40TFaTgu4soYj6LIsZeuyGQSo59rGT7DO6wHEu37LfaYIWvplGvrZNZtgs5lyvIKdfmHmSW6Vi6kjSrqJY5-zUDR3kBSWoXsLRyTpv0Dgx_Lwy_AYMfA-MXnapHx_kHHFd_mxULun_Zddvz8A_N49_4w3_uD95-yR_-c3-E_4k_lpYSsM6QzMm8QveN-IIGPv8YfE8eCnbh1XHRPOkZZ7w8033mt9vv2PbVa__IOyGvFx3W4Z0w7If8RGwf_l3_bK8LDlJ_4yzCxiyCY2Yx1saRaYW7k-jyb49p9P-360Vjj-ExexyRLbSytLPHfW9ijTed8_XUQ0rmVP8tW700Md0YHVe19XJYCVWBhKyrs7xeDNQmVVvg6ejfVuIHlfz9Sryp5B9UCvYr-U2l4KBSuF8paCqFB5UuDs1p6uFtpu9maYICN7Y7f-G2ubB8QM5t-QMYf9F3lezkvijx3crMkofXckFX5MjkqUqtS2MUzixpvf7mnwAAAP__r7Yvgg==

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 4 (32 B, 8 KVs, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 2
                  KV pairs read: 4
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUld1u4kYUx-_7FEfnZhPVETO2Q9mpKtEQtqVtlgjQVquC0Kx9wlrYM96ZoSGKeKy-QJ-sGjtEwbuw0KvWFwPnw_-Zc36c4RHtpxwFjvu_9XsTWMKb0fAGFqTnTn7ICX7_uT_qg3XzTDkylhJnz16NR4PrH8L2a975_nY4eDs5ixljLILqg0Xnr4T4qT-86U9G7wOvVZzDcHTdH8HVe1higEqn9FYWZFH8gRxnAZZGJ2StNt71WCUM0jUKFmCmypXz7lmAiTaE4hFd5nJCgRN_xhHJlEyLYYApOZnllexzCV1_gHmmUlpjgD2drwplBSzrk2GA41J6R2uKV9Pp-i6dTtcs8gv7yoIXp77DpwhSpRAx0O4jGYsB_voOXFaQAPb3X092opUj5TKtPgsZfW8hpUSnlAoIa-eHB0cWDMlUAG_DVe1djG57kMg8t8-JpczMNjHGAG_e9XpgHZWQ6JVycEZr18qUOxfAqobWCUTLfQnVefTKlSvnd5ltAqytJ2LWyQWh4C8QD65RsE1wPOWB-pOMo_RNljsyZFp8F_U23l-XBrSCLhdgPVSwThonKkjRd5fTKfOQmGdxcEEglZ76mmf7Gdyhb0vXn7cqsMJX06ht62Se70Iu5BoKKrR5AJnnOpHOk2YVVR-zn3JwVJSQZnYJKysXtA0fCSNswOCnwPhFZ-pp4sIDE1d_m5dLevjy1B3dj__3fKwspWCdIVmQ-QrdI_FFDXzhKfieZyjahVf7RfOmZ5xxf6eHLGy3X7OXT6_9I-_EvDY6rMM7cdyP-Svx8vLvhuf_bgqO7EXc6EV0Si_G2jgyrXi3E13-7X9rXC8bNcan1DgiW2plaafGfTuxxk4XfDMLkNIF1X_LVq9MQrdGJ1VubQ4rocqRknV1lNfGQG1D9Qg8X_0vlfhBpXC_Em8qhQeVov1KYVMpOqgU71eKmkrxQaXLQ32aBXiX6_t5lqLA7dhdfGHZPuhfkAvrfwDjj_q-kp08lB7fncwtBXgjl3RNjkyRqcy6LEHhzIo2m2_-CQAA__-TvS9-

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 4 (32 B, 8 KVs, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
isolation level: serializable
priority: normal
quality of service: regular
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 2
                  KV pairs read: 4
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUld1u4kYUx-_7FEfnZhPVETO2Q9mpKtEQtqVtlgjQVquC0Kx9wlrYM96ZoSGKeKy-QJ-sGjtEwbuw0KvWFwPnw_-Zc36c4RHtpxwFjvu_9XsTWMKb0fAGFqTnTn7ICX7_uT_qg3XzTDkylhJnz16NR4PrH8L2a975_nY4eDs5ixljLILqg0Xnr4T4qT-86U9G7wOvVZzDcHTdH8HVe1higEqn9FYWZFH8gRxnAZZGJ2StNt71WCUM0jUKFmCmypXz7lmAiTaE4hFd5nJCgRN_xhHJlEyLYYApOZnllexzCV1_gHmmUlpjgD2drwplBSzrk2GA41J6R2uKV9Pp-i6dTtcs8gv7yoIXp77DpwhSpRAx0O4jGYsB_voOXFaQAPb3X092opUj5TKtPgsZfW8hpUSnlAoIa-eHB0cWDMlUAG_DVe1djG57kMg8t8-JpczMNjHGAG_e9XpgHZWQ6JVycEZr18qUOxfAqobWCUTLfQnVefTKlSvnd5ltAqytJ2LWyQWh4C8QD65RsE1wPOWB-pOMo_RNljsyZFp8F_U23l-XBrSCLhdgPVSwThonKkjRd5fTKfOQmGdxcEEglZ76mmf7Gdyhb0vXn7cqsMJX06ht62Se70Iu5BoKKrR5AJnnOpHOk2YVVR-zn3JwVJSQZnYJKysXtA0fCSNswOCnwPhFZ-pp4sIDE1d_m5dLevjy1B3dj__3fKwspWCdIVmQ-QrdI_FFDXzhKfieZyjahVf7RfOmZ5xxf6eHLGy3X7OXT6_9I-_EvDY6rMM7cdyP-Svx8vLvhuf_bgqO7EXc6EV0Si_G2jgyrXi3E13-7X9rXC8bNcan1DgiW2plaafGfTuxxk4XfDMLkNIF1X_LVq9MQrdGJ1VubQ4rocqRknV1lNfGQG1D9Qg8X_0vlfhBpXC_Em8qhQeVov1KYVMpOqgU71eKmkrxQaXLQ32aBXiX6_t5lqLA7dhdfGHZPuhfkAvrfwDjj_q-kp08lB7fncwtBXgjl3RNjkyRqcy6LEHhzIo2m2_-CQAA__-TvS9-
