# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 6 (48 B, 6 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 4
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 4
                  KV bytes read: 32 B
                  KV gRPC calls: 4
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu2zYQ_r-nONyfJJgGk5LiuRwGeHHVzdtSB0rQoZiMgJFurmCJVElqUxDksfYCe7JBYlLETaPW3YDNP2Tfd_dRd_f5k27Qvq1Q4Hnyc7K4gC28SFensCF96eRVRfDLD0magHWXpXJkLOXOHh6cp8vn34bTZ3z2zdlq-fLiMGaMsQiGLxYdHQjxfbI6TS7S10F_Vn0Eq_R5ksLJa9higEoX9FLWZFH8ihzXATZG52StNj10MxQsiw4FC7BUTet6eB1grg2huEFXuopQ4EXfY0qyIDNhGGBBTpbVcOy7EeZ9A5elKqjDABe6amtlBWx9ZxjgeSN7YJLhSZZ1vxVZ1nGWZR372AW_2pfDMwSpCogYaPeGjMUAf3oFrqxJAPvrz7s418qRcqVWj1JG_2HBkCwExB65unZ0D0UhnHh0k54tIJdVZX3h6avFAqyjBnLdKgeH1LlJqdyRADaszhcQbZ8qqGUHNdXaXIOsKp1LR4UANtzwSrr8DVnQrWtaJ6CvHzq9B2Jc3wboozstrZMbQsFvg0_Xe6l-J-OoeFFWjgyZCd8V_T6fdI0BrWDOBdheXrBOGicGuaKvj7OMhSzLGPvYBYFUsS-tV_mRzKt-DfO-32HAQUgvjY-tk1W1Kzd1lLeP_wVjQvQ5-7YCR3UDRWm30Fq5oU_WKXxSp3AfnX7UpbqzZThiS__rstnS9Yet-dneCB97g08_5I3wX_FGa6kA6wzJmsx_JlG0j0TvLBTtCuRx8f4jn3HG-4d7yMLp9Bl7-FlMv-OzmPtgxmZ8FsdJzA_Ew7fAPDx60gThZ5jgH6wp3mdN59o4MpN4d0lz_uX_zZ_H-0yVkm20srQz1VMns9t1gFRsyL-brW5NTmdG58NtfLgaeANQkHU-y32wVD7VN_iQzEfJ4Tg5HCVH4-RolByPk-NR8vF75PXtF38HAAD__4Oe_-I=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlf9u2zYQx__fUxzunySYBpOS4rkcBnhx1c3bUgdK0KGYjYCRbq5giVRJanMQ-LH2AnuygWJSxM2qzViBrf6D9v34Usf7-MQ7tG9rFHiZ_ZjNrmADL_LFOaxJXzt5UxP89F2WZ2DddaUcGUuFs8dHl_n8-dfx-BmffHWxmL-8Ok4ZYyyB_oslJ0dCfJstzrOr_HXk92pOYJE_z3I4ew0bjFDpkl7KhiyKn5HjKsLW6IKs1ca77vqEeblFwSKsVNs5715FWGhDKO7QVa4mFHjla8xJlmRGDCMsycmq7rd9d4SpL-C6UiVtMcKZrrtGWQGbUBlGeNlK7xgt8Wy53P5SLpdblviF_c2CXxyq4UsEqUpIGGj3hozFCH94Ba5qSAD74_d7u9DKkXKVVk9CRv9mwZAsBcTBc3Pr6MHFx3AWvOv8YgaFrGsbEs9fzWZgHbVQ6E45OKatG1XKnQhgfetCAtHmQwmN3EJDjTa3IOtaF9JRKYD1D7yRrnhDFnTn2s4J8Pl9pQ-OGFe7CIN1z9I6uSYUfBf9c95z9SsZR-WLqnZkyIz4PvSHeLZtDWgFUy7AerxgnTRO9LiSL0-XS-ZxMU9lcEEgVR4q85SfYF74Nkx9vf0Be5ABTbCtk3W9j5u2VHRP_wVDIHzMvq3BUdNCWdkNdFau6SNwig_h9L2u1P1YxgNjGX5dtxu6_evR_FRmo7NUgnWGZEPmP0OUHILo3Qgl-4CCX7z_ymeccf9yj1k8Hj9jjz-z8Td8kvJgTNiET9I0S_mReHwLTOOTjzoE_6JN6SFtutTGkRml-02a8s__b_N5esipcrKtVpb2TvWhndluFSGVawp3s9WdKejC6KJ_TDAXva53lGRdiPJgzFUI-QIfi_mgOB4Wx4PiZFicDIrTYXE6KD59T7zaffZnAAAA__-IE__i

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join (streamer)
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlf9u2zYQx__fUxzunySYBpOS4rkcBnhx1c3bUgdK0KGYjYCRbq5giVRJanMQ-LH2AnuygWJSxM2qzViBrf6D9v34Usf7-MQ7tG9rFHiZ_ZjNrmADL_LFOaxJXzt5UxP89F2WZ2DddaUcGUuFs8dHl_n8-dfx-BmffHWxmL-8Ok4ZYyyB_oslJ0dCfJstzrOr_HXk92pOYJE_z3I4ew0bjFDpkl7KhiyKn5HjKsLW6IKs1ca77vqEeblFwSKsVNs5715FWGhDKO7QVa4mFHjla8xJlmRGDCMsycmq7rd9d4SpL-C6UiVtMcKZrrtGWQGbUBlGeNlK7xgt8Wy53P5SLpdblviF_c2CXxyq4UsEqUpIGGj3hozFCH94Ba5qSAD74_d7u9DKkXKVVk9CRv9mwZAsBcTBc3Pr6MHFx3AWvOv8YgaFrGsbEs9fzWZgHbVQ6E45OKatG1XKnQhgfetCAtHmQwmN3EJDjTa3IOtaF9JRKYD1D7yRrnhDFnTn2s4J8Pl9pQ-OGFe7CIN1z9I6uSYUfBf9c95z9SsZR-WLqnZkyIz4PvSHeLZtDWgFUy7AerxgnTRO9LiSL0-XS-ZxMU9lcEEgVR4q85SfYF74Nkx9vf0Be5ABTbCtk3W9j5u2VHRP_wVDIHzMvq3BUdNCWdkNdFau6SNwig_h9L2u1P1YxgNjGX5dtxu6_evR_FRmo7NUgnWGZEPmP0OUHILo3Qgl-4CCX7z_ymeccf9yj1k8Hj9jjz-z8Td8kvJgTNiET9I0S_mReHwLTOOTjzoE_6JN6SFtutTGkRml-02a8s__b_N5esipcrKtVpb2TvWhndluFSGVawp3s9WdKejC6KJ_TDAXva53lGRdiPJgzFUI-QIfi_mgOB4Wx4PiZFicDIrTYXE6KD59T7zaffZnAAAA__-IE__i
