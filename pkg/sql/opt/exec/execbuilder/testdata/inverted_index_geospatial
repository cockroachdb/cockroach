# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 6 (48 B, 12 KVs, 6 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 4
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 4
                  KV pairs read: 8
                  KV bytes read: 32 B
                  KV gRPC calls: 4
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVuFu4kYQ_t-nGM2fJKoRu7bDka0q0RCupW2OCNBVpxqhjXcgFrbXt7s0RBGP1Rfok1W2kyjAwR09nVR-GGZ2_O3sfN-n5RHtxxQFjnq_97pjWMDb4eAa5qSnTt6mBH_80hv2wLppkjsylmJnT09Gw_7Vj37rgrd_uBn0341PQ8YYC6D6YsHZiRA_9wbXvfHwg1diZWcwGF71hnD5ARboYa4VvZMZWRR_IseJh4XRMVmrTZl6rAr6aoWCeZjkxdKV6YmHsTaE4hFd4lJCgeOyxyFJRabJ0ENFTiZpBftyhE7ZwDTJFa3Qw65Ol1luBSzqztDDUSHLRDPCyyhazVQUrTiLohX73AMbx77DIwSZKwgYaHdHxqKHv70Hl2QkgP3z91Mc69xR7hKd7ywZfW9BUawVKQFhnbx9cGTBkFQCAh8u6-x8eNOFWKapfSksZGKeC9vo4fX7bhesowJivcwdnNLKNZPcnQlg1UDrAqLFvoJMriCjTJsHkGmqY-nKvljVw6108R1Z0EtXLJ2Asr7q_zkR4mTtYR09MWydnBMK_koS_SsUbO19uSr6-V9kHKm3SerIkGnyTWk8r_dWhQGdQ4cLsKUIwDppnKhIDd6cRxHzWRQx9rkHAuXq2NdKLeyIYVCOpVP2Wx2wortmr46tk2m6KQpaUbzc1cohYso1-zEFR1kBKrELWFo5py_mzd_Lm7_FGz-Gt191kj-Z2T9g5vrXtFjQw6cN_TWO8ncdxVufcpS_66jwmzvq2xEXbBHnH0Pci9GCTdrqvNi-PhhnvLwofOa3Whfs9afb-om3Q14Hbdbm7TDshfxEvL5ROv7ZXqv4_8EqXzG2cGtswTFjG2njyDTDzaF1-Pf_N1efb50yPOaUQ7KFzi1tnHLfTmxrpwZfTzwkNaf6j4HVSxPTjdFxVVuHgwqoSiiyrl7lddDPn5esMySzl8vkNRI_iOTvR-LbSP5BpGA_kr-NFBxECvcjBdtI4UGk80Nzmng4S_X9NFEokBO_DVsXrYbPw1kjbIfthgwYb5y_UZK31CyUYSnlWSrnthTA6E7fV7Djh6KkbyZTSx5eywVdkSOTJXliXRKjcGZJ6_V3_wYAAP__309dbw==

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 4 (32 B, 8 KVs, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 2
                  KV pairs read: 4
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVm9v4sYTfv_7FKN5k0Q_I3ZtQ3xbVaIhXEvbHBGgq04FoY09IRa217e7NEQRH6tfoJ-sWjuJglNoUa9SVV4Y5s8-npnnGS2PaD5nKHAy-HHQn8IK3o9HV7AktbDyJiP46bvBeADGLtLCkjYUW3N6MhkPL7_2u-949NX1aPhhehoyxlgA1RcLzk6E-HYwuhpMx588h5WfwWh8ORjDxSdYoYeFSuiDzMmg-Bk5zj0stYrJGKWd67FKGCYbFMzDtCjX1rnnHsZKE4pHtKnNCAVOXY1jkgnpNkMPE7IyzSrYlxZ6roBFWiS0QQ_7KlvnhRGwqitDDyeldI72DC9ms81tMpttWOAe7E8e2Dr2DJ8hyCKBgIGyd6QNevjDR7BpTgLYb78-2bEqLBU2VcWbkFb3BhKKVUKJAL923jxYMqBJJgJ4Fy5q73J83YdYZpl5SSxlqp8TQ_Tw6mO_D8ZSCbFaFxZOaWPbaWHPBLBqoHUC0WpfQi43kFOu9APILFOxtK4uVtVwI218RwbU2pZrK8DlV_U_O3ycbz2srSeGjZVLQsFfSWJ4iYJtvb-uimHxC2lLyfs0s6RJt_muNJ7jg02pQRXQ4wKMEwEYK7UVFanBeWc2Y45U5rg7-ECgIjn2mNPCGzGM3Fh6rt6qwYrumr3aNlZm2a4oaEPx-q1WDhHjYuZzBpbyEpLUrGBt5JK-AG9-gzd-DG_fq7R4Wmb_wDLXvxblih7-eKH_uxv1zxEXNIjzjyHuZdGCXdpqv2heH4wz7i4Kn_nd7jv2-tPvfsOjkNdGxCIeheEg5Cfi9Y3S88--6Kr8jbGFjbEFx4xtorQl3Q53h9bj__-3bXWn0WV4TJdjMqUqDO10ue9NrPGmFt_OPaRkSfUfA6PWOqZrreIqtzZHFVDlSMjYOsprY1g8h4zVJPOXy-Q1Ej-I5O9H4k0k_yBSsB_JbyIFB5HC_UhBEyk8iNQ5NKe5h7eZul-kCQrkUadD0XncSnyKW-FN57YVxZ2oFcqIOoEfBx1-ju6AXBongMmduq9gpw-lo-9WZoY8vJIruiRLOk-L1Ng0RmH1mrbb__0eAAD__-2WXeA=

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows decoded from KV: 4 (32 B, 8 KVs, 4 gRPC calls)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ estimated max memory allocated: 0 B
│ estimated max sql temp disk usage: 0 B
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows decoded: 2
        │ KV pairs read: 4
        │ KV bytes read: 16 B
        │ KV gRPC calls: 2
        │ estimated max memory allocated: 0 B
        │ estimated max sql temp disk usage: 0 B
        │ table: geo_table@geo_table_pkey
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ estimated max memory allocated: 0 B
            │ estimated max sql temp disk usage: 0 B
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows decoded: 2
                  KV pairs read: 4
                  KV bytes read: 16 B
                  KV gRPC calls: 2
                  estimated max memory allocated: 0 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVu9u4kYQ_96nGM2XJKoRu7ZDyFaVaAjX0jZHBOiqU0FosQdiYXt9u0tDFPFYfYE-WbV2EgWn0KJeper4sDB__PPM_H6j5RHNpxQFjno_97pjWMG74eAGlqRmVs5Tgl9-6A17YOwsyS1pQ5E1pyejYf_6W791ydvf3A7678enIWOMBVB-seDsRIjve4Ob3nj40XNY2RkMhte9IVx9hBV6mKuY3suMDIpfkePUw0KriIxR2rkey4R-vEHBPEzyYm2de-phpDSheESb2JRQ4NjVOCQZk24y9DAmK5O0hH1poeMKmCV5TBv0sKvSdZYbAauqMvRwVEjnaE7wajLZLOLJZMMCd7C_ObBx7DN8giDzGAIGyt6RNujhTx_AJhkJYH_8_mRHKreU20Tlb0Ja3RuIKVIxxQL8yjl_sGRAk4wF8BZcVd7l8LYLkUxT85JYyEQ_J4bo4c2HbheMpQIitc4tnNLGNpPcnglg5UCrBKLVvoRMbiCjTOkHkGmqImldXaysYS5tdEcG1NoWayvA5Zf1Pzt8nG49rKwnho2VS0LBX0mif42Cbb1_rop-_htpS_G7JLWkSTf5rjSe471NoUHl0OECjBMBGCu1FSWpwcX5ZMIcqcxxd_BAoDw-9jGnhTdiGLixdFy9ZYMl3RV7lW2sTNNdUdCGovVbrRwixsXMpxQsZQXEiVnB2sglfQbe_Bpv_BjeflRJ_rTM_oFlrn7NihU9_PVCf7kb9d8RF9SI848h7mXRgl3aKr-oXx-MM-4uCp_5rdYle_3ptr7j7ZBXRpu1eTsMeyE_Ea9vlI5_9llX5V-MLayNLThmbCOlLelmuDu0Dv_6_7bV57Uuw2O6HJIpVG5op8t9b2K1NzX4duohxUuq_hgYtdYR3WoVlbmVOSiBSkdMxlZRXhn9_DlkrCaZvVwmr5H4QSR_PxKvI_kHkYL9SH4dKTiIFO5HCupI4UGk80Nzmnq4SNX9LIlRoH8R0YJdyEY7moeNkEeyIdvzy4b0A97yL88jP3T7v0jl0jgBjO7UfQk7figcfQuZGvLwRq7omizpLMkTY5MIhdVr2m6_-jMAAP__-a9d9g==
