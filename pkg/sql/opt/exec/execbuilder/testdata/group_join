# LogicTest: local

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

statement ok
SET experimental_hash_group_join_enabled = true

# Verify the hash group-join planning (at the moment only the DistSQL diagram
# shows it).
query T
EXPLAIN (DISTSQL) SELECT data1.a, sum(data1.d) FROM data AS data1 INNER HASH JOIN data AS data2 ON data1.a = data2.c GROUP BY data1.a
----
distribution: local
vectorized: true
·
• group (hash)
│ group by: a
│
└── • hash join
    │ equality: (a) = (c)
    │
    ├── • scan
    │     missing stats
    │     table: data@data_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycUu9v2jAU_L6_wnqfQHLa_EAri1QJVlhJBQkjIK2aEDLxA7KGOLMddRXif5-ctCugdmv3Jcp7d747X7ID9TMDH_rfxsNuEJJGL4in8ddhk8T9Yf9qSjjTzDljlKhy26gH3iRfJtGogkg3rikkCMP-hAy68YDcREF4hLokCp-UyGW9OkvI9SSajcnn2ycIKOSCY8i2qMD_Dg7MKRRSJKiUkGa1qwgB_wW-TSHNi1Kb9ZxCIiSCvwOd6gzBhylbZjhBxlGe20CBo2ZpVskat455LIo7fAAKVyIrt7nyCaOEA4W4YGayYL6nIEr97KI0WyP4zkGsoAe-vaf_l8x5a7LkLbHck1jOq7Ge05S5kBwl8qMkc3PyX5QX7jZganMtRVnciDRHee4e3y_DlW50nOalTNeb6g0oGCoZS_EDE52K3Ccdh3bMwW54uwij6SKcDYeP3Hg2anTc5qsNeCcNuO_5MBNUhcgVnjbxopN94mQ5pg_ka6z7VaKUCY6lSCpuPUaVULXgqHSNuvUQ5BXkGAeJbPvnvzpUct6h5B4qOadK7l-VvCMl-zjTnMIqE_eLlIMPdvuTt_QS13LxY9tqrS48i-ESrdYFWyYXrOW1vRaYA2ytTNnxRtxXstOHwlS1YplCCiN2hz3UKLdpniqdJo_Ifv_hdwAAAP___Hp99Q==

statement ok
RESET experimental_hash_group_join_enabled

# Same query as above, but with the hash group-join disabled.
query T
EXPLAIN (DISTSQL) SELECT data1.a, sum(data1.d) FROM data AS data1 INNER HASH JOIN data AS data2 ON data1.a = data2.c GROUP BY data1.a
----
distribution: local
vectorized: true
·
• group (hash)
│ group by: a
│
└── • hash join
    │ equality: (a) = (c)
    │
    ├── • scan
    │     missing stats
    │     table: data@data_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: data@data_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckv9P2kAUwH_fX3F5P0FyaK-gsCYmMGWzBltHMZlZCDl6j9pYet3dNc4Y_vflWp3QiNP9Qnhf-nmf99pH0L8y8GD842oy8gPSOvOjWfR90ibReDI-nRHBDWcHnBJdrlt1INrk6zS8rEpkFNUtxA-C8ZScj6JzchH6wU7VJWHwTCIndeogJt-m4fUV-XLzXAIKuRQY8DVq8H4CgzmFQskYtZbKph6rBl_8Bs-hkOZFaWx6TiGWCsF7BJOaDMGDGV9mOEUuUB06QEGg4WlWYe20of1ZFHf4ABROZVauc-0RTokAClHBbdSB-YaCLM3LFG14guCxLS3_DDxnQ__PjL3XLH6PltvQYnu1XmzKXCqBCsWOydw--a-WV3Y75_r2QqY5qkN3d7UMV6Y1ZO0TlSa31T-gEJbGI0NGh-7enbqNndyPnHqUJAoTbqQ67O7qDO3lR8HNIghni-B6Mnkyiq4vW0O3vVen19DpfkRnirqQucbmqV-d5DQmdZg9OIoE6xeoZalivFIyrnrrMKxAVUKgNnXVrQM_r0rMTlDI138_3G0S-wDJ3SaxJsl9k9TdITnbJLdJ6r5J6u0nOfZiq0zeL1IBHsRHS3486MadZXy87PRw0O8Mjlf9Duv3Pjs9l_XF0QDsAzzR9rVFt_K-ws4eCnv0Fc80Urjkd3iGBtU6zVNt0vipstl8-hMAAP__AZS0nw==

statement ok
SET experimental_hash_group_join_enabled = true

query T
EXPLAIN (VEC) SELECT data1.a, sum(data1.d) FROM data AS data1 INNER HASH JOIN data AS data2 ON data1.a = data2.c GROUP BY data1.a
----
│
└ Node 1
  └ *colexec.hashGroupJoiner
    ├ *colfetcher.ColBatchScan
    └ *colfetcher.ColBatchScan

statement ok
RESET experimental_hash_group_join_enabled

query T
EXPLAIN (VEC) SELECT data1.a, sum(data1.d) FROM data AS data1 INNER HASH JOIN data AS data2 ON data1.a = data2.c GROUP BY data1.a
----
│
└ Node 1
  └ *colexec.hashAggregator
    └ *colexecjoin.hashJoiner
      ├ *colfetcher.ColBatchScan
      └ *colfetcher.ColBatchScan
