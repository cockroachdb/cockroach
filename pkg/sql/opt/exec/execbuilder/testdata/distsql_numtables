# LogicTest: 5node-dist-opt

# First, we set up two data tables:
#   - NumToSquare maps integers from 1 to 100 to their squares
#   - NumToStr maps integers from 1 to 100*100 to strings; this table is
#     split and distributed to all nodes.
statement ok
CREATE TABLE NumToSquare (x INT PRIMARY KEY, xsquared INT)

statement ok
INSERT INTO NumToSquare SELECT i, i*i FROM generate_series(1, 100) AS g(i)

statement ok
CREATE TABLE NumToStr (y INT PRIMARY KEY, str STRING)

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into five parts.
statement ok
ALTER TABLE NumToStr SPLIT AT SELECT (i * 100 * 100 / 5)::int FROM generate_series(1, 4) AS g(i)

# Relocate the five parts to the five nodes.
statement ok
ALTER TABLE NumToStr EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i+1], (i * 100 * 100 / 5)::int FROM generate_series(0, 4) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE NumToSquare]
----
start_key  end_key  replicas  lease_holder
NULL       NULL     {1}       1

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE NumToStr]
----
start_key  end_key  replicas  lease_holder
NULL       /2000    {1}       1
/2000      /4000    {2}       2
/4000      /6000    {3}       3
/6000      /8000    {4}       4
/8000      NULL     {5}       5

#
# -- Basic tests --
#

# Query with a restricted span.

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT 5, 2+y, * FROM NumToStr WHERE y <= 10 ORDER BY str]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkEFLxDAUhO_-ijIe90mboiA59drLKnVv0kNsHkuhTcpLCsrS_y5tDu4KK-5x5mW-GXKC85b3ZuQA_Q6FljCJ7zgEL6uVHtT2E7og9G6a42q3hM4LQ58Q-zgwNA7mY-CGjWXJCxAsR9MPG3aSfjTyVbl5jD5EAeEhV0V-D0LDzrLo7ElrXe8Pz5RValeeCcqqEu1C8HP8aQ_RHBlaLfT_hW9eIkuuLsdVj7ur-PIWfMNh8i7wBf4auVhaAtsjp08OfpaOX8V3W02SL1tuMyyHmK4qidql0zrwPKz-DJe_wu1y9x0AAP__pMyl5w==

# Query which requires a full table scan.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT 5, 2 + y, * FROM NumToStr WHERE y % 1000 = 0 ORDER BY str]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElE-L2zAQxe_9FGag0LIKlmTF6xUUfCrkkpZ0byUHNxoWg2MZSYaWJd-9-E_ZdUgkkxR8s2S9eZrfE_MKtVa4LY5oQf4EBgQ4EEiAgAACa9gTaIw-oLXadEcGwUb9BkkJlHXTum57T-CgDYJ8BVe6CkHCc_Grwh0WCk1MgYBCV5RVb9OY8liYP3ndHp22zgCBVcwp7Y59LSuHRkafchZ9jBilVEq52T5nn6Mv0b9vILDDWnXn1uMWiXL2wN8tSJRz2J8I6Na93dK64gVBshOZ38kPbRyaeD1tIhcPV8vzq-Xfqmqj0KC6VPTCHbZ6pZuYTUFes08m9mx-TiyYUx_TKhbLhRVoZwwrvTUsPp8WD9MSPa10OVqBdkZaj7fSSubTSsK00p5WthytQDsjrexWWmI-LRGm1XFaLQQq0MkI6ul_TMwL5XdoG11bnDUMaTdOUb3gMH6tbs0Bvxt96G2G5bde128otG74y4bFph5-dRd8L2ZeMZ-I2bmY-50D1olXLfxicc-9115x6ndO73F-9Iozv3N2j_OTPysaeCb-R3buvT99-BsAAP__BUH9Rw==

# Query with a restricted span + filter.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT str FROM NumToStr WHERE y < 10 AND str LIKE '%e%' ORDER BY y]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkLFq9DAQhPv_Kcz8HNdssJ0uqq5Jgkm4C851wYViLYfBtsxqBQmH3j3YKkKKQMqZT5oZ9orZOz7aiQPMG2p0hEV8zyF4Wa38oHEfMBVhmJeoq90Rei8Mc4UOOjIMzvZ95JatYykrEByrHcYtdpFhsvJ5mOOkPqiAcFPelf9BeBhGZTHF4bZ4bp7ui_2Od3tjzOu5bY6PIJyirhRdIvio3_1B7YVh6kR_39hyWPwc-Me835Kr1BHYXTjfIfgoPb-I77eaLE_bv81wHDTTOotmzih16d9XAAAA__9ZgXQn

# Query which requires a full table scan.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT str FROM NumToStr WHERE y % 1000 = 0 AND str LIKE '%i%' ORDER BY y]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlF_LmzAUh-_3KcKB8vZlEZNoy0tg4GB_kA07ut4NL5w5FMEaSSJsFL_7MF50jnY6etHdmeQ8_M5z4HiGRivMihNakN-AAwUBFCKgEAOFDeQUWqNLtFaboWQEUvUDJKNQNW3nhuucQqkNgjyDq1yNIOFQfK9xj4VCEzKgoNAVVe1jWlOdCvMzabqT09YZoBCEgrGh7ENVOzSSrNcJJyvCGWNSyjQ7vDyTN-Ty_TZ7R9aJIJ_TT-_J06paPUkpvx72afbxGSjsOidJImjCIe8p6M5dOrWuOCJI3tMbNhcJbRQaVNP2E_Ea8v6KcqYD3YabSfWtdDFJ58tnyWdn6UcZhPFjByqWK4l5pdgrbR-rFC1XiuaVtl7p5bFK8XKleF5pkAn-kyW-YrNH2-rG4qIFZcOGozri-EewujMlfjG69DHjcec5f6HQuvGVj4e08U--wd9h_ld4O4HZn7C4Jzm6B47vgTf_BOf9q18BAAD__wRKAAE=

#
# -- Join tests --
#

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT x, str FROM NumToSquare JOIN NumToStr ON y = xsquared]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lU1vm0AQhu_9FdGcEmkt2AX8gVSJY9NDUkW9VRyImdpINkt3F6lR5P9eAZVcsLsDWdtHPp6dmeeVdt6hlDk-ZXvUEP8ADgwEMAiAQQgMIkgZVEquUWupml864DH_DbHPoCir2jSvUwZrqRDidzCF2SHE8D173eELZjkqzwcGOZqs2LVlKlXsM_WWlPXeSP2rzhQCgxmkBwayNn_PPB71-na3zfS2f0giID2kDLTJNggxP7CP9cZtvRnVNOYJ3_cndsd73Yn_dnc8py6lylFh3jspbUjqlzMjfsn09qssSlTevN_aDn-a-0Q8fFbFZmvuE_4ADJ5rE98lnCXhYM7jDIHDDGcafJIzWXmcD6c9Wzvs1ebj0xVkum24My-8bMT8thEvrhGxGK85oDWHreb5ZTWL22peXkNzMF5zSGuet5qXl9Uc3Fbz6hqaw_GaI1pzI3jqwrIZDm9rmPvX3gln6r-grmSpcdSN7zcTYL7BzoiWtVrjNyXXbZnu8bnl2ss2R226r6J7eCy7T02D4-HIBV64wCsXmHM7zScYE9PgyAVeuMArF3hg7IQWQ9r_lw7sugMrzPu-_SEduoRlh4mw7DARlh0mwrLDVFiRS1hzF912mNBthwnddpjQbYcp3QsX3UsX3XaY0G2HCd12mNBthyndKxfdfMqyPL1Dp2zLqTR1-U_Zl1Npyjk_2R5W6enh058AAAD__-s0uo8=

query TTTTT
EXPLAIN (VERBOSE) SELECT x, str FROM NumToSquare JOIN NumToStr ON x = y WHERE x % 2 = 0
----
render          ·               ·                    (x, str)     ·
 │              render 0        x                    ·            ·
 │              render 1        str                  ·            ·
 └── join       ·               ·                    (x, y, str)  ·
      │         type            inner                ·            ·
      │         equality        (x) = (y)            ·            ·
      │         mergeJoinOrder  +"(x=y)"             ·            ·
      ├── scan  ·               ·                    (x)          +x
      │         table           numtosquare@primary  ·            ·
      │         spans           ALL                  ·            ·
      │         filter          (x % 2) = 0          ·            ·
      └── scan  ·               ·                    (y, str)     +y
·               table           numtostr@primary     ·            ·
·               spans           ALL                  ·            ·
·               filter          (y % 2) = 0          ·            ·

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT x, str FROM NumToSquare JOIN NumToStr ON x = y WHERE x % 2 = 0]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEld9q2zAUh-_3FObAoKUqkWTnn6Dgq0EGS0fp3fCFG58lhsTKJBlWSt592O7I4mSSPS3JXRzr89H5fULnDQqZ4TzdoAbxDRgQ4EAgBAIREBhCQmCr5AK1lqpa0gCz7CcISiAvtqWp_k4ILKRCEG9gcrNGEPCcvqzxCdMM1YACgQxNmq_rMluVb1L1Ghflxkj9o0wVAoF7IPApXxtUIriJWfAx4EKI2fx5chs8BPT9NxB4LI0IYgbJjoAszfsW9pVfXoNVqleHNev1CQFt0iWCYDvyb60wWytGVX0MOKW0WzM-LfC_trD_TllIlaHC7OBLSUX-XnJqAcTsrqnVjuILqiV-lnmBajA6ZNb43dzE7O72QeXLVfNzb4vEYavbfSehRycn9jiX93I7YKzd88na0UFt1v0gcOdBqM_B_SC6wmlglz8N4_OcBt7dSOg2EtVGRlcwwi9vZHIeI2F3I5HbyKg2MrmCkfDyRqbnMRJ1NzJ0G6lcdJzF_09GdHkZjJ5_fp3YwhPqrSw0dppOtGoCsyU2uWhZqgV-VXJRl2keH2uuvvMz1KZ5y5uHWdG8qjbYHR76wGMfeOoDM2anWY_EeD946AOPfeCpD9xK7IjmbZr-SYf2uEMrzA7zpm068pFlhx2y7LBDlh12yLLDLllDH1kjn7jtsCNuO-yI2w474rbDrrjHPnFPfOK2w4647bAjbjvsiNsOu-Ke-sTN-gzL4zu0z7TsS7su_z7zsi_typwdTQ9r6Mnuw68AAAD__7489cI=

#
# -- Aggregation tests --
#

# Sum the numbers in the NumToStr table.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(y) FROM NumToStr]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE9vozAQxe_7KVZz2pUcgYEQwil7zGGbKm1PFQcXjxBSgpFtpFYR373CHAJRYpPQo_-8ee83tuYEleD4xI6oIH0HCgQCIBACgQgILCEjUEuRo1JCdld6wZZ_QuoTKKu60d12RiAXEiE9gS71ASGFV_ZxwD0yjtLzgQBHzcqDsalleWTya1M1Ry2UlkBg4QW-313bNTr9vaGQtQREo8_1lWYFQkpbMj3Dv6KQWDAtpLccR3h5-_9nQ__etAlu2pyrN5WQHCXyUemstQeh_n1JwlESOr3p1Nl00_OFFz3SeUeQAXA8p_PBdN7AzRsZ3vgRXkeQAe9qDm84nTd088aGN3mE1xFkwJvM4Y2m80Zu3o50cTeqI8MAdf1TQ-SKzR5VLSqFF8PkemW_GzLIC-wnkhKNzPFZitzY9Mud0ZkNjkr3p7RfbKv-qAs4FFOrOBiJ6aU4sDs7rEOrOrKLozm5l1ZxbHeO5zivrOLE7pzMcV7b38p3fBP7J7v0ztpf3wEAAP__wpW71g==

# Count the rows in the NumToStr table.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT count(*) FROM NumToStr]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE-rm0AUxff9FOWuXmGCjhqfz1VKV1lUS_7QRZFgnYsIiSMzI7QEv3tRF1FJZkS7nD9nzvndO9w7lJxhlN5QQvgLKBBwgIALBDwgsIWEQCV4hlJy0V7pBXv2B0KbQFFWtWq3EwIZFwjhHVShrgghnNLfVzxgylBYNhBgqNLi2tlUoril4u-urG-KSyWAwMZybLu9Ftcq_BzxEiFpCPBaPRykSnOEkDZkfoqveS4wTxUX1nYc4lt8jk6XQ_zz-PblpZfz0uthUZdcMBTIRu8njT4NndTkeP5-2Uentx19ncYdpaHz60-N9e_Kv7G8ZU0wRBlg-6ub4MzHdszYXoftL8M2RBlgv6_Gdudju2Zsv8MOlmEbogywg9XY3nxsz4zdAm8WEBtSDIg__uuQeeJ1QFnxUuJk2Dx_2W6HELIc-4kleS0y_CF41tn0y7jTdRsMpepPab_Yl_1RG3AoplqxMxLTqdjROxusXa3a04u9Nbm3WrGvd_bXOL9rxYHeOVjj_KHvlW34JvpPNvVOmk__AgAA__8gYsu8

# Count how many numbers contain the digit 5.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT count(*) FROM NumToStr WHERE str LIKE '%five%']
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lF9r2zAUxd_3KcKF0g4UYsmOm-opY2zDbHNGkrKHYYoX3RlDYgVJHhsl333YfqhtGsng-VF_js7hd8R9hkIKjNMTauA_gAIBBgR8IBAAgSUkBM5KHlBrqaorjSASf4B7BPLiXJpqOyFwkAqBP4PJzRGBwz79ecQtpgLVwgMCAk2aH2ubs8pPqfq7LsqTkdooIDBfMM-rrn3MjwYVn63Z7Ev0-cPs9uZX_htvbjnnu_02ij8BgU1p-CyWBUJyISBL85JCmzRD4PRChid9l2UKs9RItVh2g77fPMb7p-3m--7u7VUvdtXrxaIspBKoUHTeTy72NLTHbff49SmK93drej2N30lDh3dEnR3VFc0XwXRFOeK20ISji2LD0TA3mqBGE06HxhG3heZ-NBp_OBrfjSas0aymQ-OI20KzGo0mGI4mcKOpoMwnouJI2qLy8F-H3iteW9RnWWjsDb_XX_aqoYgiw2aCalmqA35T8lDbNMtNras3BGrTnNJmERXNURWwLaZWMeuIaV_M7M4Oa9-qDuziYEzupVUc2p3DMc73VvHK7rwa4_xg78pzfBP7J-t7J5c3_wIAAP__D7P8wg==

#
# -- Limit tests --
#

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT y FROM NumToStr LIMIT 5]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMj7FqAzEQRPt8hZl6Q-6KNKrcGkIcTLqgQjktRnAnHbsrSDD693CnIqQIuJw30szsDblEfg0LK9wHRnjCKmVi1SIb6g9O8QtuIKS8VtuwJ0xFGO4GSzYzHN7D58wXDpHlaQAhsoU077GrpCXI9zHXxYqagPAIwrmaOxxHEF7SkuzwDN8IpdpviVq4MtzY6P4hF9a1ZOU_G_5LHponcLxyP1ZLlYnfpEx7TZfn_d8OIqt1d-zilLvVfHv4CQAA__9O5G2n

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT y FROM NumToStr ORDER BY y LIMIT 5]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMj7FqAzEQRPt8hZl6Q-6KNKrcGkIcTLqgQjktRnAnHbsrSDD693CnIqQIuJw30szsDblEfg0LK9wHRnjCKmVi1SIb6g9O8QtuIKS8VtuwJ0xFGO4GSzYzHN7D58wXDpHlaQAhsoU077GrpCXI9zHXxYqagPAIwrmaOxxHEF7SkuzwDN8IpdpviVq4MtzY6P4hF9a1ZOU_G_5LHponcLxyP1ZLlYnfpEx7TZfn_d8OIqt1d-zilLvVfHv4CQAA__9O5G2n

# Test that the correct node is chosen in a reverse scan with multiple spans.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT y FROM NumToStr WHERE y < 1000 OR y > 9000 ORDER BY y DESC LIMIT 5]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkDFrwzAQhff-CvO6KtgOZIimrIGSlNCteFCtIxXYOiOdoCX4vxdZQ5NC04737r6n93SBZ0sHM1KEfkULhQ06hSlwTzFyyHI52tsP6EbB-SlJljuFngNBXyBOBoLGgVc81dnFkhg3LGezAif5hqKYM0GvZ3Vl3N43fjFvA53IWAp1c2OPKbjRhM-dT6NwlACFVb3dbuvHynhbtRXLO2X1mERXuxzuyY1Oqg1-i9beRPuj84nixD7Sv0o3c6dA9kzlXyOn0NNz4H55pozHhVsES1HKdl2GvS-rHPAabu_CzQ-4mx--AgAA__8yuKTE

query TTTTT
EXPLAIN (VERBOSE) SELECT x FROM (SELECT x, 2*x, x+1 FROM NumToSquare)
----
scan  ·      ·                    (x)  ·
·     table  numtosquare@primary  ·    ·
·     spans  ALL                  ·    ·

# Verifies that unused renders don't cause us to do rendering instead of a
# simple projection.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT x FROM (SELECT x, 2*x, x+1 FROM NumToSquare)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMjzFLBEEMhXt_hbw64m471bXXeHLYyRTjTjgWdidrkgHlmP8ut1OIhXDley_5XnJFkcwvaWVDeMeISNhUJjYTvVl94Ji_EAbCXLbqNzsSJlFGuMJnXxgBb-lj4TOnzPo8gJDZ07zs2E3nNen3odTVxT5rUgbhCYRT9fB4GBEbQar_0s3ThRHGRvdfcGbbpBj_Kf-PPLRI4Hzh_qVJ1YlfVaa9psvTvrcbmc17OnZxLD1qsT38BAAA___0b2wb

query TTTTT
EXPLAIN (VERBOSE) SELECT y, str, repeat('test', y) AS res FROM NumToStr ORDER BY res
----
render               ·         ·                  (y, str, res)  ·
 │                   render 0  y                  ·              ·
 │                   render 1  str                ·              ·
 │                   render 2  res                ·              ·
 └── sort            ·         ·                  (res, y, str)  +res
      │              order     +res               ·              ·
      └── render     ·         ·                  (res, y, str)  ·
           │         render 0  repeat('test', y)  ·              ·
           │         render 1  y                  ·              ·
           │         render 2  str                ·              ·
           └── scan  ·         ·                  (y, str)       ·
·                    table     numtostr@primary   ·              ·
·                    spans     ALL                ·              ·

query TTTTT
EXPLAIN (VERBOSE) SELECT y, str, repeat('test', y) AS res FROM NumToStr ORDER BY res LIMIT 10
----
render                    ·         ·                  (y, str, res)  ·
 │                        render 0  y                  ·              ·
 │                        render 1  str                ·              ·
 │                        render 2  res                ·              ·
 └── limit                ·         ·                  (res, y, str)  +res
      │                   count     10                 ·              ·
      └── sort            ·         ·                  (res, y, str)  +res
           │              order     +res               ·              ·
           └── render     ·         ·                  (res, y, str)  ·
                │         render 0  repeat('test', y)  ·              ·
                │         render 1  y                  ·              ·
                │         render 2  str                ·              ·
                └── scan  ·         ·                  (y, str)       ·
·                         table     numtostr@primary   ·              ·
·                         spans     ALL                ·              ·

# Regression test for #20481.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT count(*) FROM (SELECT 1 AS one FROM NumToSquare WHERE x > 10 ORDER BY xsquared LIMIT 10)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFKw0AQhu8-RZmT4kqy6S2niqeCNNJWPEiQNTuEhWYnzs6CUvLukuxBKzTY4_yz3_8tzBE8WdyYDgOUr6ChVtAzNRgC8RilB2v7CWWuwPk-yhjXChpihPII4uSAUMLevB9wi8YiZzkosCjGHabanl1n-GvlYycUPqJhBAWZ1ndQDwooyk9tENMilHpQ_1fviAU506fWVXELCqoo5WJDfjQ-us7JQudnrcUl1vu2ZWyNEGfFqfmhet7s37bVy-765qxreYlri6EnH_DEc645H2oFaFtMBwwUucEnpmbSpLGauCmwGCRtdRrWPq3GD_6G9SxczMPFLLz8A9fD1XcAAAD__xRP2yQ=
