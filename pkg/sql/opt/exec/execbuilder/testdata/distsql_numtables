# LogicTest: 5node

# First, we set up two data tables:
#   - NumToSquare maps integers from 1 to 100 to their squares
#   - NumToStr maps integers from 1 to 100*100 to strings; this table is
#     split and distributed to all nodes.
statement ok
CREATE TABLE NumToSquare (x INT PRIMARY KEY, xsquared INT)

statement ok
INSERT INTO NumToSquare SELECT i, i*i FROM generate_series(1, 100) AS g(i)

statement ok
CREATE TABLE NumToStr (y INT PRIMARY KEY, str STRING)

# Split into five parts.
statement ok
ALTER TABLE NumToStr SPLIT AT SELECT (i * 100 * 100 / 5)::int FROM generate_series(1, 4) AS g(i)

# Relocate the five parts to the five nodes.
statement ok
ALTER TABLE NumToStr EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i+1], (i * 100 * 100 / 5)::int FROM generate_series(0, 4) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE NumToSquare WITH DETAILS]
ORDER BY 1
----
start_key           end_key                    replicas  lease_holder
<before:/Table/62>  <after:/Table/107/1/2000>  {1}       1

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW RANGES FROM TABLE NumToStr WITH DETAILS]
ORDER BY 1
----
start_key           end_key       replicas  lease_holder
<before:/Table/62>  …/1/2000      {1}       1
…/1/2000            …/1/4000      {2}       2
…/1/4000            …/1/6000      {3}       3
…/1/6000            …/1/8000      {4}       4
…/1/8000            <after:/Max>  {5}       5

#
# -- Basic tests --
#

# Query with a restricted span.

query T
EXPLAIN (DISTSQL) SELECT 5, 2+y, * FROM NumToStr WHERE y <= 10 ORDER BY str
----
distribution: local
vectorized: true
·
• render
│
└── • sort
    │ order: +str
    │
    └── • scan
          missing stats
          table: numtostr@numtostr_pkey
          spans: [ - /10]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkdFv0zAQxt_5K073BMxR46xtOktIhTWISF07kkqAIJq85FqiJXGwHY2qyv-OklDoJm2CN3935-_7-XxA86NAgcHn6-XbcAUvF2G8iT8uX0EcLIPLDUwYeHAGewav4X20voKqKa0yVsOnD0EUwB6-Na57nr4B7sI6WgQRvPsCxmpkWKmMVrIkg-IrckwY1lqlZIzSXenQD4TZTxQuw7yqG9uVE4ap0oTigDa3BaHAjbwtKCKZkR65yDAjK_Oitz3izI-Hm_qO9sjwUhVNWRnRoQ84cS077Yw4x6RlqBr7N9JYuSMU_IQxXKBwW_bvmLHSlvSIPySce2fIMKIqIy1gIoQIV5sZgzk_804Eg7n3JJb3CIv_D1ZEplaVoQdYTyW5j5Ic3iYMKdvR8GVGNTqla63SfnaQ696oL2Rk7NDlgwirY8tYTbL8s9VTJ_6sk_ecU8JwW6j7mzxDgdvtxZTOZ77jT8dTZ-xOuTO7mHDHn3j-LPP98a03we6C3JluRfF3dd_bbvZ198CtLAwxvJJ3tCBLusyr3Ng8_d1p2xe_AgAA__-mWgKR

# Query which requires a full table scan.
query T
EXPLAIN (DISTSQL) SELECT 5, 2 + y, * FROM NumToStr WHERE y % 1000 = 0 ORDER BY str
----
distribution: full
vectorized: true
·
• render
│
└── • sort
    │ order: +str
    │
    └── • filter
        │ filter: (y % 1000) = 0
        │
        └── • scan
              missing stats
              table: numtostr@numtostr_pkey
              spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lm9r4koYxd_fTzE8cKG9nWAm_4yBC-5Wywqt7aqwuyylRPPYDY0ZdybSleJ3XxL_VJNmahp85yTxPL8555DJC8jfEXjQ_X53_anXJ2ed3nA0_Hp9Tobd6-7liNiUGOSCLCn5j1wNbm9IvJglXCaCfPvSHXTJ2ZL8S5iu6-fkf6KT20GnOyCffxCZCKAQ8wD7_gwleD-BAQUDKJhAwQIKNtxTmAs-QSm5SB95yf7QC_6Ap1MI4_kiSS_fU5hwgeC9QBImEYIHI38c4QD9AEVDBwoBJn4YZWO2gO3tj4f5Ey6BwiWPFrNYeulm1njDuZ-utYah6zrcryjwRfI6VCb-I4LH9ih7HfD0FT0e9CqMEhQoGvYh5fq6R87abGOg53m9_sjNfNz8LkUyckh2FaQhFwmKBsv51jYuSueZuXms3IPXOVwEKDB4a8obVH2u8XmD5WwaYBykNtkbRyhpswtjb0FJ2yjFtvLYhz6x4zvG6nYsq5jWsKoUjVWh3RXNOWXRnCpI26KxGkU79MA4PjGjdmJWlphTJTGjCu0useYpE2tWQdomZtRI7NAD8_jEzNqJOVlibpXEzCq0u8TcUybmVkHaJmbWSOzQA-v4xKzaiaVZaUeHZVUB3YXVOmVYrSpI27CsGmFZVY76Aco5jyUezCsbpedGaSw9pzF4xPW5LvlCTPBO8En27Hp5mwllFwKUyfouWy968faWTAT6s93H074SUyoZ5Up2XslQKpkHSmxfiRWgTPX2nAr7s5RSdrkSyyvZSiUFk5NXcj7sVAGqqZRyy6GMvJKrVGqVKzXzSq0Pb68Axd4puqLpZkFLXXWm6Lpb0Pp42Ytc77TdKueyClrqujNF31sFLXXhVXu00jfXNOLPD2EAHthjdBDHpuabyDRrOp5q_rg50QI2buqBa0xbQfrFM438R5m-Poe_-HOmO1rO05ff1I8kUrjxn7CDCYpZGIcyCSebO6vVP38DAAD__9kL5H4=

# Query with a restricted span + filter.
query T
EXPLAIN (DISTSQL) SELECT str FROM NumToStr WHERE y < 10 AND str LIKE '%e%' ORDER BY y
----
distribution: local
vectorized: true
·
• filter
│ filter: str LIKE '%e%'
│
└── • scan
      missing stats
      table: numtostr@numtostr_pkey
      spans: [ - /9]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkV9v0zAUxd_5FNaVpq2So8bp_uGnjTWDiK4dSSRAEE3GuSnRkjjYjkZV5bsjJxS6SZvgLfcc55yfr7dgflTAIfx0u7iMluRoHiVp8mExIUm4CK9SYqwm1_HqhjRdbZWbPr4L45AcbcjXzvdnkjB_Qi6Xc3LkzEX0PiSHB3hwOCGreB7G5M1nsgEKjcpxKWo0wL8Ag4xCq5VEY5R20nY4EOU_gfsUyqbtrJMzClJpBL4FW9oKgUMqvlUYo8hRT32gkKMVZTXE7hAvdh937T268itVdXVjONlQdyGgkLTCzd6U-ZD1FFRn_1YaK9YInO0xRnPgfk__HfO6rCxq1FP2mHHUObkI9nbFOU_SOFq-BQqrzjr3WargCRX7H6oYTasag4-YnmvynzR5rM8oYL7G8cWM6rTEW63kcHYcV0PQIORo7OiycYianWWsRlH_Wep-EnsxKXgpKaNQVOrhrsyBQ8HOg5NAFt7J7Fh6x2enzBNFfu7NhJSvT5k4y2cBuB_E2rgVJd_VwxCbblp3wUJUBinciHuco0Vdl01pbCl_O33_6lcAAAD__0LpCHA=

# Query which requires a full table scan.
query T
EXPLAIN (DISTSQL) SELECT str FROM NumToStr WHERE y % 1000 = 0 AND str LIKE '%i%' ORDER BY y
----
distribution: full
vectorized: true
·
• filter
│ filter: ((y % 1000) = 0) AND (str LIKE '%i%')
│
└── • scan
      missing stats
      table: numtostr@numtostr_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzElVFv2joUx9_vp7COVBV0HWEngYClK9Fb6BaNQgdI2zShKpBDFzVgFht1qOK7TwktJdkSkfLAW2zHf__8O7b8DOpnCAK6X-96V26fVDruaDz63KuSUbfXvR4TpSNyMxzckuV6oWXc-vKxO-ySSmVDLghnjFXJf4RVyVW_QyrxeM_91CWXF8HFZZUMhp3ukPz_jWyAwlL62PcWqEB8Bw4UTKBgAQUbKNRhQmEVyRkqJaP4l-dkguv_AsEoBMvVWsfdEwozGSGIZ9CBDhEEjL1piEP0fIxqDCj4qL0gTJZ5pW6_ftyvHjGGuZbherFUgmxovEegMFp5cduomYwxmGwpyLV-W1Rp7wFB8ANKtwOCbenxoDdBqDHCqFZPU-76BalU2vzFqhDC7Y-bidz9d-K4bR4oFkKMxkO3_6GaS2xmiOu5xG-gMvIxQj9N2eb_wmT7l231pSFXNZ5RP1hrQdpmLpeV4eJplfz4mvNTa56U3KjZZQrPy9DuC984Y-EbKWLzeL_myX7txG-jjF-zDO3er3NGv06K2Drer3Wy30bit1nGr1WGdu-3eUa_zRSxfbxf-2S_sVnjaLV2GdC92tYZ1bbKvGJDVCu5VJjizVuJZVYyePyCoP-AuxdHyXU0w7tIzpJ_d81BEpR0-Kj0bpTvGu7ydUjpCL3F_hE-TOKFSWYqiR8m1bNJZjFTGSirMMrOT-LZJPu922tkk-qFSY18JjOb1Hgvk5NNcgqTmvlMVjap-V6mZjapVXwMWD6U_cfZLD7mBVSt-OrMQ_l0H_gggNv1-XxmoeFYDjdsRMto2XbLmDpT02Fz7s_ZFOIJ3oOK7-_oh3xKYsebVXz75l6okMKt94gd1BgtgmWgdDB7Gdlu__kdAAD__5PC0aE=

#
# -- Join tests --
#

query T
EXPLAIN (DISTSQL) SELECT x, str FROM NumToSquare JOIN NumToStr ON y = xsquared
----
distribution: full
vectorized: true
·
• hash join
│ equality: (xsquared) = (y)
│ right cols are key
│
├── • scan
│     missing stats
│     table: numtosquare@numtosquare_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: numtostr@numtostr_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lk1v4jwUhffvr4juqpUcETsJH5Eq8artaKha6BQWI41QlRIDUUNMY0ctqvjvo4R2IDFxMRR2kI9jn_sc59534C8ReHD9-_72_07XOLvq9Af9X7fnRv_69vpyYLwhg4vE-PHQuzPidCYYf0n9hBo3vU7344JIjF7XWBgXxtvqZgAIYhbQrj-jHLw_gAEBAQQ2IHAAgQtDBPOEjSjnLMkeec9f6ARv4FkIwnieiuzyEMGIJRS8dxChiCh4MPCfIvpA_YAmNQsQBFT4YZQvs7G_9sbvx_kzXQCCSxals5h7maeNnfbnfnbRhOESAUvFx9LrFZ8WxtTn0-JabQLD5RABF_6Egoc3_HSuwLOWaD9LeJslkbQ_f0hmFjmgDR81YlmWphlcMENKZnClmbVuGrMkoKuKrpWH2ZtfPbKlIj99Pr1hYUyTWr241YiOxVmbnF8k4WQqztr4HBD0UuEZbYzaTsn32pNd8lQ_wNOWDXeZyeY1jMvut-7FKde3WGC8e1rIoWnJw2LWnO-ODKl0dILINI4TmUbBE9mdkn0wJSenVP9uSnaloxNQah6HUrPgyd6dknMwpXpOqfndlJxKRyeg1DoOpVbBk7M7JfdgShkf3WavBuRWmjkBIGwdhxDWGmEeKJ-zmNOd-p9VWsrEmUcaTOiqZpylyYjeJ2yUP7v628uF8l4SUC5Wd8nqTyf-vMVFQv3ZvwlsdyW3Wqmup9SoVsJET6qlkGrqSWFcrUWcshbWqDopbEtPya1WaugpNRR7svWkWgqplp5UqeoFLeKWtUhZy9rUsqsB2lLYbaUULhK0lOfG2TcLUtjVSoosSFlXK6myIEVdLaXIAtGslDIL0jfG3TsL0hGs7wtQOjdqJQVA6diolVQApVOjllIB1KyUEqD0uWrsDVA6N819AUphVyspAGIp7GopFUEp62opFUHNUikJSh-Z1t4E5YajM8YUtiXF_QspFUO5OetMMkUtuT3rjDLFyuuWS4lR7tBSi96Zo5PNpeOIvT6GAXhA3cBygxExLeI0TMd6cszWyLZMm9jjMfFt6rsYshf8Cc-G4_6Uvea6g8U8G23HfsQpgjv_mV5RQZNZGIdchKOPO8vlf38DAAD__2pSFZM=

query T
EXPLAIN (VERBOSE) SELECT x, str FROM NumToSquare JOIN NumToStr ON x = y WHERE x % 2 = 0
----
distribution: full
vectorized: true
·
• project
│ columns: (x, str)
│
└── • merge join (inner)
    │ columns: (x, y, str)
    │ estimated row count: 333 (missing stats)
    │ equality: (x) = (y)
    │ left cols are key
    │ right cols are key
    │ merge ordering: +"(x=y)"
    │
    ├── • filter
    │   │ columns: (x)
    │   │ ordering: +x
    │   │ estimated row count: 333 (missing stats)
    │   │ filter: (x % 2) = 0
    │   │
    │   └── • scan
    │         columns: (x)
    │         ordering: +x
    │         estimated row count: 1,000 (missing stats)
    │         table: numtosquare@numtosquare_pkey
    │         spans: FULL SCAN
    │
    └── • filter
        │ columns: (y, str)
        │ ordering: +y
        │ estimated row count: 333 (missing stats)
        │ filter: (y % 2) = 0
        │
        └── • scan
              columns: (y, str)
              ordering: +y
              estimated row count: 1,000 (missing stats)
              table: numtostr@numtostr_pkey
              spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT x, str FROM NumToSquare JOIN NumToStr ON x = y WHERE x % 2 = 0
----
distribution: full
vectorized: true
·
• merge join
│ equality: (x) = (y)
│ left cols are key
│ right cols are key
│
├── • filter
│   │ filter: (x % 2) = 0
│   │
│   └── • scan
│         missing stats
│         table: numtosquare@numtosquare_pkey
│         spans: FULL SCAN
│
└── • filter
    │ filter: (y % 2) = 0
    │
    └── • scan
          missing stats
          table: numtostr@numtostr_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzEl3Fro1gUxf_fT_G4sNAyhvjUqBEKWaYZNkObzDaBXVjCYONrKmM08zRMQsl3H9S2UW99-hKa_meMHo_n_i73-gTxzwAcGP737eav0ZhcXI-ms-k_N5dkOrwZfp6RrULihJMvd5NbEm5WSRT_3Licka-T0fj5RMLJZEy25IrsyL9_D--G5GJL_iTaJbkiKigQRh4buysWg_M_UFBAAwV0UMAABXowV2DNowWL44inlzxlN4y8LTiqAn643iTp6bkCi4gzcJ4g8ZOAgQMz9z5gd8z1GO-mD_JY4vpB9piC1UHh-Pv6B9uBAp-jYLMKY4dsQYHp2k0POzDfKxBtksMD48RdMnBoweHoGhx1r7Q3-cUPEsYZ79Kyw_y8Qy4GNA3LcZzReGZnmT0fV_wcJO935NGNH8t6Awrz_cGzVvFMZTwXg9XeCjbhg5cDFOkuI6aQa1dTVbU2XL1iVDsqXOus4RoVz1at54PuJoy4xzjzSsrz9M6XS966AAb0U_7s6rvfMr5kXyM_TNmqVClgD8nFgH66vOL-8jE_BAUmm8QhA6oM9Npy9Krc1Nej-d3ecD2OOtG6S61qCm-aMatmykHT9hTrp1KcQdzpGjIo6zJuX1G2PxRlu9bzuVDW3w3lcj209vQYJ9NjZPSYMvQYMm5f6el_KD39Ws_nosd4N3rK9dDb09M7mR4zo8eWoacn4_awo6gfig9Va12fi5_eu_FTrojRnh_zZH5ScurX2yo6pozRAzrn3W8ROrTW9bnQMd8NHVNmJ75j8ToKY9Zqw1Irj-rQ9DWZt2R5cnG04Qv2jUeL7Nr85yQTyk54LE7yf2n-YxS-_BUnnLmr1--lohKtKtGiklFSokUlU07JrlfK99r2UpQKtGxJLcEbaoakllWvpaPgNWEJ9foS0qqSLlFCrahkySnZ9Ur5PtdeqlLCslZfUkvwhlpPUsuq19JR8IawhD0BDah5euKGtiU62hRKWfVKqA2tY8FCTShWEoGFelAsJQJLQ1E1aInAQhVs0BKBhYK3jwYLtXRfDJZajwNqaYqmTlseUEc3SImAQB3doCUkArV0k5gICZR9k5iICZw-Gj6tocAzUTx8qGD64Jl49PiheBk5fgDhdeT4CaThheSEEYTTP2EG4fiPH0K4KxumkFmPBe5KNIZaY4GbUqwlwgL3pFhLiAXuyQYxERY4_QYxERY4fjSO2mJhqOlnx0MQ_frue-DAgtravU17nXvL8zqGTmmnb2pmh9m0_6Cqqq3qFqQ3uMs4_faZPka_Mt3Zbp1-uTy4QcwUuHV_sGuWML7yQz9O_MXzP_v9H78DAAD__9fwu_c=

#
# -- Aggregation tests --
#

# Sum the numbers in the NumToStr table.
query T
EXPLAIN (DISTSQL) SELECT sum(y) FROM NumToStr
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: numtostr@numtostr_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJykldtvmzAUxt_3V0TnqZWMgg3h9tSq7aRIva3JpElTVDnhlKECZrZRV1X53yfIugIbCMKbb_m-L79jH95A_UwggKtv99fny9vZyeVytV59uT6dra6ury7WM1WkJ6-ns88PdzezrEi1UFoCgUyEeMtTVBB8BwoEGBCwgIANBBawIZBLsUOlhCyPvFU_WIa_IDAJxFle6HJ5Q2AnJELwBjrWCUIAa75N8AF5iHJuAoEQNY-Tyubd_ux98Jg_4ysQuBBJkWYqmJWTVc7LoTFnpmnCZk9AFPrDT2keIQS0FnB5CYG5J8MznkeRxIhrIeeLZsTV15uTM3raactatotO2w-3IhMyRIlhw2qz7w9GzXHJrFYy2iRCh1eNTqhaVTRjbo8pHR0TtEbImVY6p2HLhvNhU_jYFR9nDB82JmiNjzuNj9uwtYbzsabwcSo-3hg-1pigNT7eND5ew9YezseewqckYwxGY4_JWEPjT0Pjj2nGD6hykSlsdcf_O5ktJ4OWbRTDCA89V4lC7vBeil119jC9q4SqhRCVPuzSw2SZvW8pLZGnf78ldSXaq8QaSrSutGgrsf5MY0JZvVJ2txJtK9nH_j2nrbToVXK6M7G2knNsJret5PYqed2ZrLaSd2wmr63k918DszuU_c_d7L_mPan88uk8JeLlMQ4hAMvzTIdtF8bW8V3D5iYzfH_rG8zzXNezLJ_tyrbwlPBIle939UO8VLLr17x8fU88UUjghj_jJWqUaZzFSse7Pzv7_affAQAA__-2IXp0

# Count the rows in the NumToStr table.
query T
EXPLAIN (DISTSQL) SELECT count(*) FROM NumToStr
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • scan
      missing stats
      table: numtostr@numtostr_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJysll1vokwYhs_fX2GeI_tmiAzfcNSm7SYmrXbFZjfZGDOFR5cUGXdmSLdp_O8bcLsFdiFCPBMG7_vymg95A_kjhQBuvz7cXU1no_HNNFyGn-8uRuHt3e31chTxPFPj_y9Gnxbz-1GW7xSXSgCBjMc4YzuUEHwDCgQMIGACAQsI2LAisBc8Qim5KB55K78wjX9CoBNIsn2uitsrAhEXCMEbqESlCAEs2VOKC2QxiokOBGJULEnLmvf6y_cP6_0zvgKBa57mu0wGQCDcs0wGI21i6LoOqwMBnquPNqnYFiGgFbzpDQT6gZxOeLXdCtwyxcXErgNezx9ny_Vi_iUcX7R2G41uu7X7ozLPuIhRYFzrWx266WjDX_h4v57OluNL2k5nNuhoXQ09ffLo4Mkr506bWH1mkPbBrDhyzjCDTq3bOF2RMVyRVSpy-igy-mBWFLlnUOTWus3TFZnDFTmlIq-PIrMPZkWRdwZFXq3bOl2RNVxRIUc72Y7Vh7Bixz-DHb_PCb1AueeZxMZp-e8mvdGk0eJYxXiLxzNY8lxE-CB4VD57vJyXQeWNGKU6jtLjxTR7H5JKINv9-YOpJtHOJKOWRKtJdjPJ6GbqA2V2RlntSbSZZA39eU4zye5MctqZjGaSM5TJbSa5nUleO5PZTPKGMnnNJL97GejtUNZfa7N7mXdQ-cXW2aT8ZZ3EEMDT5snf2LqvMZOZmuXGkeYx19R8Q2euaVv-xileUTYp28pi_4bf-UsZu3zdF7tvw1KJBO7ZM96gQrFLskSqJPo9cjj89ysAAP__LCuDTA==

# Count how many numbers contain the digit 5.
query T
EXPLAIN (DISTSQL) SELECT count(*) FROM NumToStr WHERE str LIKE '%five%'
----
distribution: full
vectorized: true
·
• group (scalar)
│
└── • filter
    │ filter: str LIKE '%five%'
    │
    └── • scan
          missing stats
          table: numtostr@numtostr_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8l1Fvok4Uxd__n4LcpKn9ByIDIwJPbVq7S9ZqV2y6ycYYCleXFBkXhu02jd99A26twEKlGt-YGTz3N_ecDOMLxD8DMKH37bZ_YQ2E1pVlj-2v_TPB7vV7l2PBZUnIW_-fCdej4Y0QJgvOYh4J9597o56QPvWtLz3h9GTm_8KTUxAhZB4OnAXGYH4HAiIoIIIKIlAQoQMTEZYRczGOWZS-8pL9wPJ-gymL4IfLhKfTExFcFiGYL8B9HiCYMHYeAhyh42HUlkEED7njB1mZV6zz14fp8hGfQYRLFiSLMDZTUhDBXjrpQGorsizDZCUCS_hbxZg7cwSTbCFaV2DKK3F3yms_4Bhh1O7kEdfzpnBO8h0zTdMej6zBJxBhmHBTGLAQK9GUAlqnCdrFfB7h3OEsapNCAy-Hd4PxdDS8t1tnlcXVQnFS3Zi3oknIIg8j9HIFJ6t3-Ards-9uptZg3Don1Xi0iJdvDtk9XWSvdGXhktq0ScRIE9RNxLRjRExrgrZtITlExPKNUXb3UNnPQ5p5qDXxUGmCuvGwewwPu03Qtj1UDuFhvjHq7h6q-3moZR7qTTxUm6BuPNSP4aHeBG3bQ_UQHuYbQ3f3kO7nYeqetLN9tAnlxj7jGPYZTdC27aOHsI82uSeMMF6yMMbCF_vfpeRCKYmkn3b05ri-B8QsiVy8jZibvbseDjOhbMLDmK9XyXpgha9LMY_QWWxuYNtKpFZJqVbqFJWUWiU1p0S2lUgJSq3fntZgf7RWqlOtRIpKnVqlGiatqKR9uFMlqG6tlF4NpRSV9Folo1qpW1QyPry9EhR5J-g1SVdLWvVRJzVZ10taHw97meudtNNqLlrSqo87qcm7UdKqD3zdHml6cs0C9jT1PTBBfzA8V5tRiaJhSFRRHMnwZEXSNFfWH3RH6xrpv5RZ4Mzj9Pi0f7CnTHf8vEwPv5kTxCjCjfOIV8gxWvihH3Pf_buyWv33JwAA___BcQSD

#
# -- Limit tests --
#

query T
EXPLAIN (DISTSQL) SELECT y FROM NumToStr LIMIT 5
----
distribution: local
vectorized: true
·
• scan
  missing stats
  table: numtostr@numtostr_pkey
  spans: LIMITED SCAN
  limit: 5
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMUE2L2zAUvPdXiDm1IFOLrJtUp5ZNCgZndxv7UChmUeTnVKxtuZLMNgT_92K7oR9Q2NubmaeZ0bvAf28gsfvykH1M79jrbZoX-efsDct32e62YGf26XC_Z93QBuuDY1m6TwuWgKOzFd2pljzkVwiUHL2zmry3bqIu80Ja_YCMOUzXD2GiSw5tHUFeEExoCBKFOjZ0IFWRexuDo6KgTDPbXmM_XIfH_onO4Li1zdB2XrIJ5L2axggcmWlNYAnKkcMO4XeoD-pEkOKPlukWMh75y4seyPe28_RXx_8lxf8kRWIsOag60XIdbwen6cFZPe8u8H42momKfFhUsYC0u0o-OFLtUr_kqBv7_GgqSKj1Ollt3q8jTatVdCNEHSl1o6OaxLuNTpQ4HjeYHqiTnz6Wf7PPs21x7qdatWo8cezVE20pkGtNZ3ww-pcyjq9-BgAA___10rZU

query T
EXPLAIN (DISTSQL) SELECT y FROM NumToStr ORDER BY y LIMIT 5
----
distribution: local
vectorized: true
·
• scan
  missing stats
  table: numtostr@numtostr_pkey
  spans: LIMITED SCAN
  limit: 5
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF-PlDAUxd_9FM150qRExpnV3T6pCyYkzM4KPGgM2XTpZWwWKLYlI5nw3Q3gxD-JiW_3nnM550fPcN8aCMSf7tN3yR17HiV5kX9MX7A8TuPbgo3sQ3bYs25ovXHeskMWxRl7_5mNLE32ScGuwNEZRXeyJQfxBRuUHL01FTln7Cydl4NEfYcIOXTXD36WS47KWII4w2vfEAQK-dhQRlKRfRmCQ5GXulliLwRvL8ND_0QjOG5NM7SdE2xe8l7OYwCOVLfasyuUE4cZ_K9S5-WRIDa_USYRRDjx_wfNyPWmc_QH47-awr-ags1UcpA60vo6zgy2ontrquV2XQ9L0CIocn51N-uSdBfLeUuyXfFLjroxpwetIPBYX4fb-uZ1UCklg129lYGU8iZQb67VbvcqlFvaYf5AHt38Y_lXc1pii7GfsWrZOOLYyyeKyJNtdaed19VPZ5qe_QgAAP__vuW5zg==

# Test that the correct node is chosen in a reverse scan with multiple spans.
query T
EXPLAIN (DISTSQL) SELECT y FROM NumToStr WHERE y < 1000 OR y > 9000 ORDER BY y DESC LIMIT 5
----
distribution: full
vectorized: true
·
• revscan
  missing stats
  table: numtostr@numtostr_pkey
  spans: [ - /999] [/9001 - ]
  limit: 5
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMUV9vm04QfP99itU-JdIh3wXzq81TW5uqSP6TgqW2aq3ogLWDAhy9O5Qii-9egePUiVS3b7uzuzNzcwc0Pwr0Mfhyu3gXruBqHsab-NPiGuJgEcw20MKHaL2EqimtMlbD549BFMBVC98bzt0UBOf8GtbRM0QwfYLmQQTvv0IL8yCewSJchhvwkGGlMlrJkgz631AgQw-3DGutUjJG6R4-DEth9hN9zjCv6sb28JZhqjShf0Cb24LQx5VyVD3qWTKyMi-GtY6hauzvI2PlntC_OVMJ5-iLjp0JictCG5kUFJHMSI_4Czk8hfP2VNzVD9Qiw5kqmrIyPvRNXMu-dEZ9ZCCrDAQoe08aGS7yMrfg4Z-ci1fO-Qvnf4koIlOrytA_ZcRfKTmi2zKkbE_HfzGq0SndapUOu8d2PRANQEbGHqc3xyasTiNjNcny2f45k7jIxC8xbRnuCvV4l2foI5_yifcmSRxXTFxnLP73nKk7GTtJtks8l9NYei72B3Jv-ojie_U40G7aun_gThaGGC7lA83Jki7zKjc2T58mXfffrwAAAP__m1cDhg==

query T
EXPLAIN (VERBOSE) SELECT x FROM (SELECT x, 2*x, x+1 FROM NumToSquare)
----
distribution: local
vectorized: true
·
• scan
  columns: (x)
  estimated row count: 1,000 (missing stats)
  table: numtosquare@numtosquare_pkey
  spans: FULL SCAN

# Verifies that unused renders don't cause us to do rendering instead of a
# simple projection.
query T
EXPLAIN (DISTSQL) SELECT x FROM (SELECT x, 2*x, x+1 FROM NumToSquare)
----
distribution: local
vectorized: true
·
• scan
  missing stats
  table: numtosquare@numtosquare_pkey
  spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMUE1r3DAUvPdXiDklrUzlrr1kdWrJbsGw-ejah0IxQbWetya25UgycVj834vthm4LhZ70ZuZpZqQT3FMNid3X-_2n5JZdbJM0S7_sL1m62--uMzawz4e7G3bxCjn7wN5Ox8DesXAR277xxj31ytIlOFqj6VY15CC_IUTO0VlTkHPGTtRpXkj0ACk4qrbr_UTnHIWxBHmCr3xNkMjU95oOpDTZ9wIcmryq6tn2LPLj2fzQPdILOK5N3Tetk2wAR9qpaQyQjxym978DnVdHggzPGiZbSDHy_y95INeZ1tEf_f6VJP5KCsIx5yB9pOVnnOltQffWFPPuAu9mo5nQ5PyihgtI2lfJeUuqWernHGVtnh8qDYkiFus4FlGgxFoEUSk2wWa1ioJNdFXq1WpdXsURpgvq6KaHpT_M82ybvXRTrVLVjjhu1CNtyZNtqrZyvip-KeP45mcAAAD__9Bkutg=

query T
EXPLAIN (VERBOSE) SELECT y, str, repeat('test', y) AS res FROM NumToStr ORDER BY res
----
distribution: full
vectorized: true
·
• sort
│ columns: (y, str, res)
│ ordering: +res
│ estimated row count: 1,000 (missing stats)
│ order: +res
│
└── • render
    │ columns: (res, y, str)
    │ render res: repeat('test', y)
    │ render y: y
    │ render str: str
    │
    └── • scan
          columns: (y, str)
          estimated row count: 1,000 (missing stats)
          table: numtostr@numtostr_pkey
          spans: FULL SCAN

query T
EXPLAIN (VERBOSE) SELECT y, str, repeat('test', y) AS res FROM NumToStr ORDER BY res LIMIT 10
----
distribution: full
vectorized: true
·
• top-k
│ columns: (y, str, res)
│ ordering: +res
│ estimated row count: 10 (missing stats)
│ order: +res
│ k: 10
│
└── • render
    │ columns: (res, y, str)
    │ render res: repeat('test', y)
    │ render y: y
    │ render str: str
    │
    └── • scan
          columns: (y, str)
          estimated row count: 1,000 (missing stats)
          table: numtostr@numtostr_pkey
          spans: FULL SCAN

# Regression test for #20481.
query T
EXPLAIN (DISTSQL) SELECT count(*) FROM (SELECT 1 AS one FROM NumToSquare WHERE x > 10 ORDER BY xsquared LIMIT 10)
----
distribution: local
vectorized: true
·
• group (scalar)
│
└── • top-k
    │ order: +xsquared
    │ k: 10
    │
    └── • scan
          missing stats
          table: numtosquare@numtosquare_pkey
          spans: [/11 - ]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUktGPmkAQxt_7V2zmSdslsmhM4ems0pRU5Qo016Y1ZsuOlByy3O6S82L83xvgelUTTe-N-Wb4vt_O7h70QwEe-N9u55NgSXqzIE7iL_M-if25P01IKuvS9N72yccoXJDes8rIJCayxE4t662R-qHmCsndJz_yyY78rG17iITZJIxmfkQ-fCe7bkSQebAIEsLsPlAopcAl36IG7wcwWFGolExRa6kaad8OBGIHnk0hL6vaNPKKQioVgrcHk5sCwYOE_yowQi5QDWygINDwvGhtj_hujr7X1T0-AYWpLOptqT2yoy-MQCGueCMOGLNgdaAga_MvXRueIXjsCDeYgWcf6P8Tx1IZVAN2CnvjvAMKiaw-e4Q1Bwlr45GlLPEihXNGwV5DMckyhRk3Ug2cU5Jp-HWZrKPwLu71L2YPz7Kd12RHqCtZajzJvZRknyVZ7LCigCLD7qFoWasUb5VM29muDFujVhCoTddlXRGUf1vaKOTblws8dmJXnZzLTuzcybnqNLzGtKKwKeTjOhfggSvGI5eJ1EoZR2vkOmPLdV1u2YKNN--FcEZDF5ofeKabZce_5WNrmzxVzao2vNBIYcHvcYYG1TYvc23y9LlzOLz5EwAA__-EulEk
