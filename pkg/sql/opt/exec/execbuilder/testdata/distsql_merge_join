# LogicTest: 5node

# The following tables form the following (used to be interleaved) hierarchy:
#   name:             primary key:                # rows:   'a' = id mod X :
#   parent1           (pid1)                      40        8
#     child1          (pid1, cid1)                150       66
#       grandchild1   (pid1, cid1, gcid1)         410       201
#     child2          (pid1, cid2, cid3)          15        7
#       grandchild2   (pid1, cid2, cid3, gcid2)   51        13
#   parent2           (pid2)                      5         2
# Additional rows in child1, child2, and grandchild1 with no corresponding
# parent row are also inserted.
#
# All IDs belonging to a table (pid1 --> parent1, cid1 --> child1, cid2,cid3
# --> child2, etc.) start from 1 up to (# rows).
# Foreign keys are modded by their ancestor's (# rows). For example, for child1
# row with cid1=500, we take ((cid1-1) % 200 + 1) = 100 as pid1.
# One exception is cid3, which is taken as cid2 % 15.
# There's a column 'a' that's modded by a factor.
#
# This allows us to test the following edge cases (in order of tests):
#   - one-to-many (parent1 - child1)
#   - one-to-one and one-to-none (parent1 - child2)
#   - parent-grandchild (parent1 - grandchild1)
#   - multiple "interleaved" columns (child2 - grandchild2)
#   - additional ancestor above (child2 - grandchild2)
#   - no "interleaved" relationship (parent1 - parent2, parent2 - child1)

#################
# Create tables #
#################

statement ok
CREATE TABLE parent1 (pid1 INT PRIMARY KEY, pa1 INT, FAMILY (pid1,pa1))

statement ok
CREATE TABLE parent2 (pid2 INT PRIMARY KEY, pa2 INT, FAMILY (pid2, pa2))

statement ok
CREATE TABLE child1 (
  pid1 INT,
  cid1 INT,
  ca1 INT,
  PRIMARY KEY(pid1, cid1),
  FAMILY (pid1,cid1,ca1)
)

statement ok
CREATE TABLE child2 (
  pid1 INT,
  cid2 INT,
  cid3 INT,
  ca2 INT,
  PRIMARY KEY(pid1, cid2, cid3),
  FAMILY (pid1,cid2,cid3,ca2)
)

statement ok
CREATE TABLE grandchild1 (
  pid1 INT,
  cid1 INT,
  gcid1 INT,
  gca1 INT,
  PRIMARY KEY(pid1, cid1, gcid1),
  FAMILY (pid1,cid1,gcid1,gca1)
)

# No foreign key since we are permitting the rows to overflow out of child2
# for pid1 > 15.
statement ok
CREATE TABLE grandchild2 (
  pid1 INT,
  cid2 INT,
  cid3 INT,
  gcid2 INT,
  gca2 INT,
  PRIMARY KEY(pid1, cid2, cid3, gcid2),
  FAMILY (pid1, cid2, cid3, gcid2, gca2)
)

####################
# Split our ranges #
####################

# Split at parent1 key into five parts.
statement ok
ALTER TABLE parent1 SPLIT AT SELECT i FROM generate_series(8, 32, 8) AS g(i)

# Split at child1 keys in between parent1 parts (total 10 parts).
statement ok
ALTER TABLE child1 SPLIT AT SELECT pid1, pid1 + 40 FROM
generate_series(4, 36, 8) AS g(pid1)

# Split at grandchild2 keys in between the 10 parts (total 20 parts).
statement ok
ALTER TABLE grandchild2 SPLIT AT SELECT pid1, pid1 + 40, pid1, pid1 FROM
generate_series(2, 38, 4) AS g(pid1)

# Relocate the twenty parts to the five nodes.
statement ok
ALTER TABLE grandchild2 EXPERIMENTAL_RELOCATE
  SELECT ARRAY[((i-1)/2)::INT%5+1], i, i+20, i, i FROM generate_series(1, 39, 2) AS g(i)

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE parent1]
----
start_key  end_key  replicas  lease_holder
NULL       /8       {1}       1
/8         /16      {1}       1
/16        /24      {1}       1
/24        /32      {1}       1
/32        NULL     {1}       1

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE child1]
----
start_key  end_key  replicas  lease_holder
NULL       /4/44    {1}       1
/4/44      /12/52   {1}       1
/12/52     /20/60   {1}       1
/20/60     /28/68   {1}       1
/28/68     /36/76   {1}       1
/36/76     NULL     {1}       1

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE grandchild1]
----
start_key  end_key  replicas  lease_holder
NULL       NULL     {1}       1

###############
# Merge joins #
###############

query T
EXPLAIN SELECT * FROM parent1 JOIN child1 USING(pid1)
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ left cols are key
│
├── • scan
│     missing stats
│     table: parent1@parent1_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: child1@child1_pkey
      spans: FULL SCAN

# Select over two ranges for parent/child with split at children key.
query T
EXPLAIN (VERBOSE) SELECT * FROM parent1 JOIN child1 USING(pid1) WHERE pid1 >= 3 AND pid1 <= 5
----
distribution: local
vectorized: true
·
• project
│ columns: (pid1, pa1, cid1, ca1)
│ estimated row count: 30 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, cid1, ca1, pid1, pa1)
    │ estimated row count: 30 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid1, ca1)
    │     ordering: +pid1
    │     estimated row count: 30 (missing stats)
    │     table: child1@child1_pkey
    │     spans: /3-/6
    │
    └── • scan
          columns: (pid1, pa1)
          ordering: +pid1
          estimated row count: 3 (missing stats)
          table: parent1@parent1_pkey
          spans: /3-/6
          parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN child1 USING(pid1) WHERE pid1 >= 3 AND pid1 <= 5
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: child1@child1_pkey
│     spans: [/3 - /5]
│
└── • scan
      missing stats
      table: parent1@parent1_pkey
      spans: [/3 - /5]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycktFv0zAQxt_5K0731IBR44TxEKlSpi1Api4dTRFIkAcTH12k1Da2I4Gq_u8oMdLWaQXGS5T7zp_v9528R_e9xwyLTzfL87KC2WVZb-r3ywjqYllcbOA5vFmvrsEIS8pzuFqVFbS3XS85fKjL6i3MTCd5BB_fFesiFPBliOOUFpBGcF5d3hfbBZxFyFBpSZXYkcPsM3JsGBqrW3JO21HaTwdK-QOzmGGnzOBHuWHYakuY7dF3vifMcCO-9rQmIcnOY2QoyYuun64NlLmx3U7Yn8jwQvfDTrkMRh4GbfgKjgxrI8bGPH05f43NgaEe_N1Q58WWMOMH9n9g_Bjs9y5Pk5l_Z0pOMt2hDEpbSZbkEUYzOv925JFg12S3dKU7RXaeHAfr6Zuf5fxFtLDd9jb8IsPV4DPIX7H8jOUJy9OTYdKnLHhNzmjl6GGoR2-OxyQktxQ24_RgW7qxup3GhHI1-SZBkvOhm4SiVFNregH3zfwJ5uShOfmjOT0yx4fm8OxXAAAA__8i3yy3

# Swap parent1 and child1 tables.
query T
EXPLAIN (VERBOSE) SELECT * FROM child1 JOIN parent1 USING(pid1) WHERE pid1 >= 3 AND pid1 <= 5
----
distribution: local
vectorized: true
·
• project
│ columns: (pid1, cid1, ca1, pa1)
│ estimated row count: 30 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, cid1, ca1, pid1, pa1)
    │ estimated row count: 30 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid1, ca1)
    │     ordering: +pid1
    │     estimated row count: 30 (missing stats)
    │     table: child1@child1_pkey
    │     spans: /3-/6
    │
    └── • scan
          columns: (pid1, pa1)
          ordering: +pid1
          estimated row count: 3 (missing stats)
          table: parent1@parent1_pkey
          spans: /3-/6
          parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM child1 JOIN parent1 USING(pid1) WHERE pid1 >= 3 AND pid1 <= 5
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: child1@child1_pkey
│     spans: [/3 - /5]
│
└── • scan
      missing stats
      table: parent1@parent1_pkey
      spans: [/3 - /5]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycktFv0zAQxt_5K0731IBR40TjIVKlTFuATF06miKQIA8mPrpIqW1sRwJV_d9RYqSt0wpsL1HuO3--33fyHt2PHjMsPt8sz8sKZpdlvak_LCOoi2VxsYGX8Ha9uob2tuslh6tVWYERlpTn8LEuq3cwM53kEXx6X6yLUMDXIY5TWkAawXl1eV9sF3AWIUOlJVViRw6zL8ixYWisbsk5bUdpPx0o5U_MYoadMoMf5YZhqy1htkff-Z4ww4341tOahCQ7j5GhJC-6fro2IOfGdjthfyHDC90PO-UyGHkYtOErODKsjRgb8_T1_A02B4Z68HdDnRdbwowf2PPA-DHYn_2dJjP_z5ScZLpDGZS2kizJI4xmdP7ryCPBrslu6Up3iuw8OQ7W03c_y_mraGG77W34RYarwWeQc5YnLE9ZfnYyTPqUBa_JGa0cPQz16M3xmITklsJmnB5sSzdWt9OYUK4m3yRIcj50k1CUampNL-C-mT_BnDw0J381p0fm-NAcXvwOAAD__xxkLLQ=

# Select over two ranges for parent/child with split at grandchild key.
# Also, rows with pid1 <= 30 should have 4 rows whereas pid1 > 30 should
# have 3 rows.
query T
EXPLAIN (VERBOSE) SELECT * FROM parent1 JOIN child1 ON parent1.pid1 = child1.pid1 WHERE parent1.pid1 >= 29 AND parent1.pid1 <= 31 ORDER BY parent1.pid1
----
distribution: local
vectorized: true
·
• merge join (inner)
│ columns: (pid1, pa1, pid1, cid1, ca1)
│ ordering: +pid1
│ estimated row count: 30 (missing stats)
│ equality: (pid1) = (pid1)
│ right cols are key
│ merge ordering: +"(pid1=pid1)"
│
├── • scan
│     columns: (pid1, cid1, ca1)
│     ordering: +pid1
│     estimated row count: 30 (missing stats)
│     table: child1@child1_pkey
│     spans: /29-/32
│
└── • scan
      columns: (pid1, pa1)
      ordering: +pid1
      estimated row count: 3 (missing stats)
      table: parent1@parent1_pkey
      spans: /29-/32
      parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN child1 ON parent1.pid1 = child1.pid1 WHERE parent1.pid1 >= 29 AND parent1.pid1 <= 31 ORDER BY parent1.pid1
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: child1@child1_pkey
│     spans: [/29 - /31]
│
└── • scan
      missing stats
      table: parent1@parent1_pkey
      spans: [/29 - /31]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycktGPk0AQxt_9Kybz1Opq2UUfjqQJ5xUjlx6ctIka5WFlxx4JZXF3STQN_7sBzpxcWk3vpenMN9_O75twQPujwgCjT7fryziB2SrebDcf1nPYROvoagvP4V2W3kAjDdWOw3UaJ1DclZXikCZ_2q-aUnFY3gtj9fF9lEUwm0x8bT3PpyWIizlcJqtjarEEn88hzVZRBm8_TzYgw1orSuSeLAZfkGPOsDG6IGu16VuHYSBWPzHwGJZ107q-nTMstCEMDuhKVxEGuJXfKspIKjILDxkqcrKshmfHFGFjyr00v5Dhla7afW0D6CEYFOOv7Hk2jeyFhbh4ufAF5h1D3bqHtdbJHWHAO_Y0ND5Fu7_GabbmHCpxkuoBpq21UWRITUDy3vm_kSPRbsjs6FqXNZmFmEar6LubhfzFfGnK3d34FxmmrQsgfM3CNyzkLBQs9E_m8c-5cka20bWlx7mOvuz1YUjtaDyO1a0p6NboYlgzlungGxqKrBtVMRZxPUjDZ_C3mZ9hFo_N4p9mf2L2urx79jsAAP__T5FBJg==

# Parent-child where pid1 <= 15 have one joined row and pid1 > 15 have no
# joined rows (since child2 only has 15 rows up to pid1 = 15).
# Note this spans all 5 nodes, which makes sense since we want to read all
# parent rows even if child rows are non-existent (so we can support OUTER
# joins).
# TODO(richardwu): we can remove nodes reading from just one table for INNER
# joins or LEFT/RIGHT joins.
query T
EXPLAIN (VERBOSE) SELECT * FROM parent1 JOIN child2 USING(pid1) WHERE pid1 >= 12 ORDER BY pid1
----
distribution: local
vectorized: true
·
• project
│ columns: (pid1, pa1, cid2, cid3, ca2)
│ ordering: +pid1
│ estimated row count: 333 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, pa1, pid1, cid2, cid3, ca2)
    │ ordering: +pid1
    │ estimated row count: 333 (missing stats)
    │ equality: (pid1) = (pid1)
    │ left cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, pa1)
    │     ordering: +pid1
    │     estimated row count: 333 (missing stats)
    │     table: parent1@parent1_pkey
    │     spans: /12-
    │
    └── • scan
          columns: (pid1, cid2, cid3, ca2)
          ordering: +pid1
          estimated row count: 333 (missing stats)
          table: child2@child2_pkey
          spans: /12-

query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN child2 USING(pid1) WHERE pid1 >= 12 ORDER BY pid1
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ left cols are key
│
├── • scan
│     missing stats
│     table: parent1@parent1_pkey
│     spans: [/12 - ]
│
└── • scan
      missing stats
      table: child2@child2_pkey
      spans: [/12 - ]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycktFv0zAQxt_5K0731IJRYxd4iDQpsAXI1DUjKQIEeTDx0VlK42A7Eqjq_47iII1MK9C9RPZ3_u5-3yl7dN8bjDH9eL16ma1hdpGVm_Ldag5lukrPN_AYXhf5FXTSUus5XObZGuob3SgB78ts_QZmnVZ8Dh_epkUKwxm-9FG0pDPgAvLiIi3g1adQQIatUbSWO3IYf0aOFcPOmpqcM3aQ9uFBpn5gHDHUbdf7Qa4Y1sYSxnv02jeEMW7k14YKkorsIkKGirzUTWj7GzXprN5J-xMZnpum37UuDhQMOjmglJ0cpAUXT7E6MDS9vx3nvNwSxvzAHobEp0jjwo4T1VqJ8F0yqKX4TzpxlO4Wqm-NVWRJTYCqwfmvJ_dEvCK7pUujW7ILMY3Y0Dc_S_iT-ZnV25vxiAzz3seQcJYIljxjyXOWvDiaZ3nKtgtynWkd3c11b-doCENqS-NynOltTdfW1GHMeM2DLwiKnB-rYrxkbSiF3-FPMz_BLO6axV_Ny4k5OlSHR78CAAD__1DfLRk=

# These rows are all on the same node 1 (gateway).
query T
EXPLAIN (VERBOSE) SELECT * FROM parent1 JOIN child2 USING(pid1) WHERE pid1 IN (1, 11, 21, 31) ORDER BY pid1
----
distribution: local
vectorized: true
·
• project
│ columns: (pid1, pa1, cid2, cid3, ca2)
│ ordering: +pid1
│ estimated row count: 40 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, cid2, cid3, ca2, pid1, pa1)
    │ ordering: +pid1
    │ estimated row count: 40 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid2, cid3, ca2)
    │     ordering: +pid1
    │     estimated row count: 40 (missing stats)
    │     table: child2@child2_pkey
    │     spans: /1-/2 /11-/12 /21-/22 /31-/32
    │
    └── • scan
          columns: (pid1, pa1)
          ordering: +pid1
          estimated row count: 4 (missing stats)
          table: parent1@parent1_pkey
          spans: /1/0 /11/0 /21/0 /31/0
          parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN child2 USING(pid1) WHERE pid1 IN (1, 11, 21, 31) ORDER BY pid1
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: child2@child2_pkey
│     spans: [/1 - /1] [/11 - /11] [/21 - /21] [/31 - /31]
│
└── • scan
      missing stats
      table: parent1@parent1_pkey
      spans: [/1 - /1] [/11 - /11] [/21 - /21] [/31 - /31]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckt-L00AQx9_9K4Z5uupIuxv1ISBE76Lm6DVnUlGRPKzZsQ2k2bi7AaX0f5dshLseV_V8CfPrO_l8h92j-95ijOmn6-WrbAVnF1m5Lt8vZ1Cmy_R8DY_hTZFfQa8sd17AZZ6toN42rZbwocxWb-Gsb7SYwcd3aZHCGMO4RhAIQSAFQSRmkBcXaQGvP4cBJOyM5pXascP4CwqsCHtranbO2LG0DwOZ_oHxgrDp-sGP5YqwNpYx3qNvfMsY41p9bblgpdnOF0io2aumDWsnyqS3zU7Zn0h4btph17k4QBDUjZbhGxHUSiJh2auxPRdP5xJUpyEC47dsHVYHQjP4Gw7n1YYxFgf6P1ZxzPr7vKdheyVuA84X_8YnT_LdYA2dsZot6yOkalT-beQek1dsN3xpmo7tXB6bbPmbP0vEk9lL22y2U4iE-eBjSJ5T8oISSUlEybOTfqKH3Ltg15vO8V1f925ejGZYb3g6jjODrfnamjr8ZkrzoAsFzc5PXTklWRda4UHcFosHiOVdsfyjODoSLw7V4dGvAAAA__97ija9

# Parent-grandchild.
# We add the pa1 > 0 condition so a lookup join is not considered to be a better plan.
query T
EXPLAIN (VERBOSE)
  SELECT * FROM parent1 JOIN grandchild2 USING(pid1) WHERE
    pid1 >= 11 AND pid1 <= 13
    OR pid1 >= 19 AND pid1 <= 21
    OR pid1 >= 31 AND pid1 <= 33
    OR pa1 > 0
----
distribution: full
vectorized: true
·
• project
│ columns: (pid1, pa1, cid2, cid3, gcid2, gca2)
│ estimated row count: 1,000 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, cid2, cid3, gcid2, gca2, pid1, pa1)
    │ estimated row count: 1,000 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid2, cid3, gcid2, gca2)
    │     ordering: +pid1
    │     estimated row count: 1,000 (missing stats)
    │     table: grandchild2@grandchild2_pkey
    │     spans: FULL SCAN
    │
    └── • filter
        │ columns: (pid1, pa1)
        │ ordering: +pid1
        │ estimated row count: 342 (missing stats)
        │ filter: ((((pid1 >= 11) AND (pid1 <= 13)) OR ((pid1 >= 19) AND (pid1 <= 21))) OR ((pid1 >= 31) AND (pid1 <= 33))) OR (pa1 > 0)
        │
        └── • scan
              columns: (pid1, pa1)
              ordering: +pid1
              estimated row count: 1,000 (missing stats)
              table: parent1@parent1_pkey
              spans: FULL SCAN

query T
EXPLAIN (DISTSQL)
  SELECT * FROM parent1 JOIN grandchild2 USING(pid1) WHERE
    pid1 >= 11 AND pid1 <= 13
    OR pid1 >= 19 AND pid1 <= 21
    OR pid1 >= 31 AND pid1 <= 33
    OR pa1 > 0
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: grandchild2@grandchild2_pkey
│     spans: FULL SCAN
│
└── • filter
    │ filter: ((((pid1 >= 11) AND (pid1 <= 13)) OR ((pid1 >= 19) AND (pid1 <= 21))) OR ((pid1 >= 31) AND (pid1 <= 33))) OR (pa1 > 0)
    │
    └── • scan
          missing stats
          table: parent1@parent1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzElVGPozYQx9_7Kax5Cj1HxjawLNJKnO5ybU57yTXZqpXaPHDgJkgsUEOknlb73StgcyFsYiel5F5QCPPzjP__GfsJir8T8GDy--f7t9MZGr2fLh-Wv9wbaDm5n7x7QD-iD4v5J5QHUqQlRR_n0xlayyCNwk2cRAz9upzOfkKjPI6ogX77ebKYoNFoVL-jP7emycUdotRAb2fvUevf8A5RbhhovkDd4NtjwYwaR6P50aU530XnwS4WmQZgSLNIzIJHUYD3B1DAwAADBwwWYLBhhSGXWSiKIpNVyFMNTKN_wDMxxGm-Lau_VxjCTArwnqCMy0SABw_Bl0QsRBAJSUzAEIkyiJM6TUsuP5fxYyC_AoZ3WbJ9TAsPVZVjFMYRq58co3Xzsg6DqrplHlRhY8KIxQgjDAVphCjKyo2QsHrGkG3Ll8L29Xz5ijZBsTmsxKewel5hKMpgLcCjz_i_bdA-XPalOU5vLg9oayOdmvf1sEvq-RAnpZBCEuewmOZ_r-5Cv92DnudNZw_uS7_47UbcfXrpsDZ2exJj31Y8wvHT6TjvcD771qK7L71s5Sdl3K-TyUhIEXXXeVMl3kdt02Nxda6uHZ-EXIuPWZwKSW4Ol03EX-XIp2-MOxmvN81PwDDflh7yHezfYJ9hn2Pfwr59sjmsM3Z1Qb2zbJzlhLJO5PHc9kFuev6g8CFOAkJNYpvVk5pjQi1iW9WTWgMdDPT6HUTN4VuInW8jHcTG3Xk-Jg6xHOIQZyAD2fUNdIf3j5_vnzXMGO4nb0yoS2y3elJ3IBf5dxhDOryN1vk2skFs3A3fuH2u1h6yxsPifzTRur6Jt9e9jY9UsxBFnqWFOOuuNav9iGgtGomKbCtD8VlmYZ2meZ3XXH0zRaIom6-8eZmmzaeqwPNhtw9MWR_a6ZXaVNO0S5tt-rBuswuzC_Rml8FuH7ij94W00yu1qaa5Um9LbZalhClXu2X3mQ41rJkONaybDjWtmQ5Nas10OH3cuumjtxrW6K2GdXqraY3emtQavd0-et_20VsNa_RWwzq91bRGb01q3en_6vK4RHD66vK4RHENrZFcQ-s01-Aa0XXJdaq_ukKUqq-ef_g3AAD__7Rs3aA=

query T
EXPLAIN (VERBOSE)
  SELECT * FROM grandchild2 JOIN parent1 USING(pid1) WHERE
    pid1 >= 11 AND pid1 <= 13
    OR pid1 >= 19 AND pid1 <= 21
    OR pid1 >= 31 AND pid1 <= 33
    OR pa1 > 0
----
distribution: full
vectorized: true
·
• project
│ columns: (pid1, cid2, cid3, gcid2, gca2, pa1)
│ estimated row count: 1,000 (missing stats)
│
└── • merge join (inner)
    │ columns: (pid1, cid2, cid3, gcid2, gca2, pid1, pa1)
    │ estimated row count: 1,000 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid2, cid3, gcid2, gca2)
    │     ordering: +pid1
    │     estimated row count: 1,000 (missing stats)
    │     table: grandchild2@grandchild2_pkey
    │     spans: FULL SCAN
    │
    └── • filter
        │ columns: (pid1, pa1)
        │ ordering: +pid1
        │ estimated row count: 342 (missing stats)
        │ filter: ((((pid1 >= 11) AND (pid1 <= 13)) OR ((pid1 >= 19) AND (pid1 <= 21))) OR ((pid1 >= 31) AND (pid1 <= 33))) OR (pa1 > 0)
        │
        └── • scan
              columns: (pid1, pa1)
              ordering: +pid1
              estimated row count: 1,000 (missing stats)
              table: parent1@parent1_pkey
              spans: FULL SCAN

query T
EXPLAIN (DISTSQL)
  SELECT * FROM grandchild2 JOIN parent1 USING(pid1) WHERE
    pid1 >= 11 AND pid1 <= 13
    OR pid1 >= 19 AND pid1 <= 21
    OR pid1 >= 31 AND pid1 <= 33
    OR pa1 > 0
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: grandchild2@grandchild2_pkey
│     spans: FULL SCAN
│
└── • filter
    │ filter: ((((pid1 >= 11) AND (pid1 <= 13)) OR ((pid1 >= 19) AND (pid1 <= 21))) OR ((pid1 >= 31) AND (pid1 <= 33))) OR (pa1 > 0)
    │
    └── • scan
          missing stats
          table: parent1@parent1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzElVGPozYQx9_7Kax5Cj1HxjawLNJKnO5ybU57yTXZqpXaPHDgJkgsUEOknlb73StgcyFsYiel5F5QCPPzjP__GfsJir8T8GDy--f7t9MZGr2fLh-Wv9wbaDm5n7x7QD-iD4v5J7SWQRqFmziJGPo4n85QHkiRlhT9upzOfkKjPI6ogX77ebKYoNFoVL-jP7emycUdotRAb2fvUevf8A5RbhhovkDd4NtjwYwaR6P50aU530XnwS4WmQZgSLNIzIJHUYD3B1DAwAADBwwWYLBhhSGXWSiKIpNVyFMNTKN_wDMxxGm-Lau_VxjCTArwnqCMy0SABw_Bl0QsRBAJSUzAEIkyiJM6TUs7P5fxYyC_AoZ3WbJ9TAsPVZVjFMYRq58co3Xzsg6DqrplHlRhY8KIxQgjDAVphCjKyo2QsHrGkG3Ll8L29Xz5ijZBsTmsxKewel5hKMpgLcCjz_i_bdA-XPalF05vLg9oayOdmvf1sEvq-RAnpZBCEuewmOZ_r-5Cv92DnudNZw_uS7_47UbcfXrpsDZ2exJj31Y8wvHT6TjvcD771qK7L71s5Sdl3K-TyUhIEXXXeVMl3kdt02Nxda6uHZ-EXIuPWZwKSW4Ol03EX-XIp2-MOxmvN81PwDDflh7yKfYZ9jn2Lezb2L852RzWGbu6oN5ZNs5yQlkn8nhu-yA3PX9Q-BAnAaEmsc3qSc0xoRaxrepJrYEOBnr9DqLm8C3EzreRDmLj7jwfE4dYDnGIM5CB7PoGusP7x8_3zxpmDPeTNybUJbZbPak7kIv8O4whHd5G63wb2SA27oZv3D5Xaw9Z42HxP5poXd_E2-vexkeqWYgiz9JCnHXXmtV-RLQWjURFtpWh-CyzsE7TvM5rrr6ZIlGUzVfevEzT5lNV4Pmw2wemrA_t9Eptqmnapc02fVi32YXZBXqzy2C3D9zR-0La6ZXaVNNcqbelNstSwpSr3bL7TIca1kyHGtZNh5rWTIcmtWY6nD5u3fTRWw1r9FbDOr3VtEZvTWqN3m4fvW_76K2GNXqrYZ3ealqjtya17vR_dXlcIjh9dXlcoriG1kiuoXWaa3CN6LrkOtVfXSFK1VfPP_wbAAD__29T3Yc=

query T
EXPLAIN SELECT * FROM grandchild2 JOIN parent1 USING(pid1) WHERE
  pid1 >= 11 AND pid1 <= 13
  OR pid1 >= 19 AND pid1 <= 21
  OR pid1 >= 31 AND pid1 <= 33
  OR pa1 > 0
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: grandchild2@grandchild2_pkey
│     spans: FULL SCAN
│
└── • filter
    │ filter: ((((pid1 >= 11) AND (pid1 <= 13)) OR ((pid1 >= 19) AND (pid1 <= 21))) OR ((pid1 >= 31) AND (pid1 <= 33))) OR (pa1 > 0)
    │
    └── • scan
          missing stats
          table: parent1@parent1_pkey
          spans: FULL SCAN

# Join on multiple "interleaved" columns with an overarching ancestor (parent1).
# Note there are 5 nodes because the filter cid2 >= 12 AND cid2 <= 14
# creates a giant parent span which requires reading from all rows.
query T
EXPLAIN (DISTSQL)
  SELECT * FROM child2 INNER MERGE JOIN grandchild2 ON
    child2.pid1=grandchild2.pid1
    AND child2.cid2=grandchild2.cid2
    AND child2.cid3=grandchild2.cid3
  WHERE
    child2.pid1 >= 5 AND child2.pid1 <= 7
    OR child2.cid2 >= 12 AND child2.cid2 <= 14
    OR gcid2 >= 49 AND gcid2 <= 51
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1, cid2, cid3) = (pid1, cid2, cid3)
│ left cols are key
│
├── • scan
│     missing stats
│     table: child2@child2_pkey
│     spans: FULL SCAN
│
└── • filter
    │ filter: (((pid1 >= 5) AND (pid1 <= 7)) OR ((cid2 >= 12) AND (cid2 <= 14))) OR ((gcid2 >= 49) AND (gcid2 <= 51))
    │
    └── • scan
          missing stats
          table: grandchild2@grandchild2_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzsl11vo0YUhu_7K0bnynTHhRkGbCNFYrXrbb1K8NaJ1EqtL1gzxUgOuIClrqL89wowNh9ejh2apBe5QTEzz5yP950T-wGSvzdgwfT3L9fvZw4ZfJzd3t3-eq2Q2-n19MMd-ZF8WsxvyGodbDxOZo4zXZCb6eLnKfk8nznEj93Q2y_OHTIYFH__tA08Rq6qy_krhbx3PpJy0yrweGNT9kpp7dLbu3SF_PbLdDElg3rMP3eapssrYtQPOa6trshIUch8cUw2z6MEGT-RZEkyoZSsX6PEZE_5tf0GUxSgEEaedNx7mYD1BzCgwIGCDhQEUDBgSWEbRyuZJFGcbXnIgZn3D1gahSDc7tLs9ZLCKoolWA-QBulGggV37teNXEjXk7GqAQVPpm6wycMU6dvbOLh3429A4UO02d2HiUWyXlCS5Zk_dUpWbpbQ7dbNloewfKQQ7dJ92GO0r9_I2k3W9Tg2ozantg7LxyWFJHV9CRZ7pE8rgtUPr4h-XiV-8cGvV6RyVXCVq5y4oUcYidK1jBtlHpPnlyT_KdikMpaxatYzL95bmT3tiisty5o5d-O9WeyKJ8uVvb3sqiMbVNWPB6zkRMWTDU5UfHng_gO19e827HjaLoxiT8bSq523zMhyy6kNYLN31ObvqK2_K2I2BbiRsS8_R0GYuadhn438Kx1UTlCu4sBf118BhfkutUhZGbUFtQ1qm9QeUXtM7cl3jSJ61H2iEicaRluVmc0OnYxt1GKz82-YeI4bpjJNNbTsybShyoRqiOzJxBMuHFLL4cJN3i5cu2EvfeHEK144fr7p-bOYvvyvMlRNVZiqqZpPsDtSxcHuoze7txv20nbnr2h3_Xy7G88z449jfaiysWqMsycbP8H0SC0H0zPtzfXtjr20641XdL043_X6s7i-HO3D6nec3PK8sHxypueRSg6eH79Zvt2wl7a8_j_5IXEiz4VMtlGYyLN-JmhZpdLzZdHEJNrFK_kljlZ5mOLjPOfy75GeTNJiVS8-zMJiKUvwfJhpvWizDz3qFRopmzVprUrzGqw1YX5Bw_llcKPhl9JmH3rUKzRStt7ZcNGtluiE2ahbLqOTNrths4_W3TCmNUIjWnfTiNZIaKTsUR-tx53wpFutSR-1umFMLYRG1OqmEbWQ0EjZrDVJL5GLdU9ShoxS1muWIjQmGYYjmiE4IhoWHCu910BlyEQ1ENVaI_Ui1bppVDUEx1TrxjHVkOBY6a3B2qna8vGHfwMAAP__TEWaug==

query T
EXPLAIN
  SELECT * FROM child2 INNER MERGE JOIN grandchild2 ON
    child2.pid1=grandchild2.pid1
    AND child2.cid2=grandchild2.cid2
    AND child2.cid3=grandchild2.cid3
  WHERE
    child2.pid1 >= 5 AND child2.pid1 <= 7
    OR child2.cid2 >= 12 AND child2.cid2 <= 14
    OR gcid2 >= 49 AND gcid2 <= 51
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1, cid2, cid3) = (pid1, cid2, cid3)
│ left cols are key
│
├── • scan
│     missing stats
│     table: child2@child2_pkey
│     spans: FULL SCAN
│
└── • filter
    │ filter: (((pid1 >= 5) AND (pid1 <= 7)) OR ((cid2 >= 12) AND (cid2 <= 14))) OR ((gcid2 >= 49) AND (gcid2 <= 51))
    │
    └── • scan
          missing stats
          table: grandchild2@grandchild2_pkey
          spans: FULL SCAN

# Aggregation over parent and child keys.
query T
EXPLAIN (DISTSQL)
  SELECT sum(parent1.pid1), sum(child1.cid1) FROM parent1 JOIN child1 USING(pid1) WHERE
    pid1 >= 10 AND pid1 <= 39
----
distribution: local
vectorized: true
·
• group (scalar)
│
└── • merge join
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │
    ├── • scan
    │     missing stats
    │     table: child1@child1_pkey
    │     spans: [/10 - /39]
    │
    └── • scan
          missing stats
          table: parent1@parent1_pkey
          spans: [/10 - /39]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycktFvmzAQxt_3V1j3BJpXMORlSJGIWrZRJaQLqTZp44HhG0UimNlG2hTlf59sKrVETbb0zf7ufv6-O9iD-tVCBMnXu-UizYhzk-bb_PPSJXmyTK63RA07py8ldppd9Q1nLrVS9dC0nF1VRiEfNusVeWwit-s0I2OZ3Odp9pE4liNfPiWbZLyQ74PvhzgnzHfJIrt5rlZzEr53gUInOGblDhVE34BBQaGXokKlhDTS3jak_DdEPoWm6wdt5IJCJSRCtAfd6BYhgm35o8UNlhyl5wMFjrpsWvvsmDPuZbMr5R-gcC3aYdepiJhAlJj5gELel0bzmP_Om_lQHCiIQT85Kl3WCBE70NelYtNUj6s8Fev_AwUnAz3lGDohOUrkkwyFIf_V8sJUK5Q13oqmQ-kF06la_KmdmL1157KpH8YjUFgPOiJxSOPg5BjhJXtd1LXEutRCeuE0QH6_cmJmPO0pcE8azi4x3KDqRafweH8vvuybpSGvcfwISgyywjspKmszXteWswJHpcdqMF7Szpbsn_YcZhfAwTEcnIXDCewfw-FZeHYEF4c3fwMAAP__b9NtWA==

###############
# Outer joins #
###############

# The schema/values for each table are as follows:
# Table:        pkey:                     pkey values (same):   values:
# outer_p1      (pid1)                    {1, 2, 3, ... 20}     100 + pkey
# outer_c1      (pid1, cid1, cid2)        {2, 4, 6, ... 28}     200 + pkey
# outer_gc1     (pid1, cid1, cid2, gcid1) {4, 8, 12, ... 36}    300 + pkey

# Split between 4 nodes based on pkey value (p):
# node 1:       p - 1 mod 20 ∈ [1...5)
# node 2:       p - 1 mod 20 ∈ [5...10)
# node 3:       p - 1 mod 20 ∈ [10...15)
# node 4:       p - 1 mod 20 ∈ [15...20)

statement ok
CREATE TABLE outer_p1 (
  pid1 INT PRIMARY KEY,
  pa1 INT,
  FAMILY (pid1, pa1)
)

statement ok
CREATE TABLE outer_c1 (
  pid1 INT,
  cid1 INT,
  cid2 INT,
  ca1 INT,
  PRIMARY KEY (pid1, cid1, cid2),
  FAMILY (pid1, cid1, cid2)
)

statement ok
CREATE TABLE outer_gc1 (
  pid1 INT,
  cid1 INT,
  cid2 INT,
  gcid1 INT,
  gca1 INT,
  PRIMARY KEY (pid1, cid1, cid2, gcid1),
  FAMILY (pid1, cid1, cid2)
)

statement ok
ALTER TABLE outer_p1 SPLIT AT
  SELECT i FROM generate_series(0, 40, 5) AS g(i)

statement ok
ALTER TABLE outer_p1 EXPERIMENTAL_RELOCATE
  SELECT ARRAY[(((i-3)/5)%4)::INT + 1], i FROM generate_series(3, 40, 5) AS g(i)

query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE outer_p1]
----
start_key  end_key  replicas  lease_holder
NULL       /0       {5}       5
/0         /5       {1}       1
/5         /10      {2}       2
/10        /15      {3}       3
/15        /20      {4}       4
/20        /25      {1}       1
/25        /30      {2}       2
/30        /35      {3}       3
/35        /40      {4}       4
/40        NULL     {5}       5

### Begin OUTER queries

query T
EXPLAIN (VERBOSE) SELECT * FROM outer_p1 FULL OUTER JOIN outer_c1 USING (pid1)
----
distribution: full
vectorized: true
·
• render
│ columns: (pid1, pa1, cid1, cid2, ca1)
│ estimated row count: 1,000 (missing stats)
│ render pid1: COALESCE(pid1, pid1)
│ render pa1: pa1
│ render cid1: cid1
│ render cid2: cid2
│ render ca1: ca1
│
└── • merge join (full outer)
    │ columns: (pid1, pa1, pid1, cid1, cid2, ca1)
    │ estimated row count: 1,000 (missing stats)
    │ equality: (pid1) = (pid1)
    │ left cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, pa1)
    │     ordering: +pid1
    │     estimated row count: 1,000 (missing stats)
    │     table: outer_p1@outer_p1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          columns: (pid1, cid1, cid2, ca1)
          ordering: +pid1
          estimated row count: 1,000 (missing stats)
          table: outer_c1@outer_c1_pkey
          spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT * FROM outer_p1 FULL OUTER JOIN outer_c1 USING (pid1)
----
distribution: full
vectorized: true
·
• render
│
└── • merge join (full outer)
    │ equality: (pid1) = (pid1)
    │ left cols are key
    │
    ├── • scan
    │     missing stats
    │     table: outer_p1@outer_p1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: outer_c1@outer_c1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMll9r4kAUxd_3Uwz3SbcjyeSPtYGFFNcuFqtdtbCwyJImdzVgM9lJhC3F774ktriGdiZhUHwRM5nf3Dnn3GTyAtmfNXgw-HE_uh6OSevrcDaffR-1yWwwGvTn5DO5mU7uCN_kKH6ljNw8jEbkdjIcvw6FjDzMhuNvpJXGEWsDhYRHOA6eMAPvJzCgYAEFGyg4QMGFBYVU8BCzjItiyksJDKO_4JkU4iTd5MXwgkLIBYL3AnmcrxE8mAePa5xiEKEwinUjzIN4XZZ5256fivgpEM9Aoc_Xm6ck80ixL0rSoEBmaVAMGWbHcEmQRIQRnq9QwGJLi0Vei-9rPj6TVZCtDqv5DBbbBYUsD5YIHtvSD0Ts1-EiQoFRdZ2LovB-1iZ5b15Zq2rGHYol3vI4QWFcHi47f07R2wU1eZgPpmVcQGGNv_OWzy7aX0S8XO3-AoUpJhEKj_Qn16PBrD9o-Yz6dpsS36LEdyjxXUr8bsWivXy7hvwGwsa8w1ODscrM92s7B7VZ_f6x9PrH7RjMPFIDsdM3UO-MGsiqH6KtFyIzOwY71mvAOn2KV2eUol0_RUczRbdjWMd6Fu3Tp8jMM4rRqR-jqRVjxzhWhA0kuO9JCCUSwrdfi5LwQI6WAOtDASfqwe4ZtaDio3CKWcqTDGt9LpiFcIyWuPMy4xsR4r3gYVlmdzkpufIYjjDLd3fZ69Uw2d0rdtiA1oEdHbirA_fkMKvC5v-wJYctKcwOabNK21phKWgdWBGWHFaEJYcVYTk6YbladitoHVhhtxxW2C2HFXZ3dey-1LJbQevACrvlsMJuOaywu6dj95WW3QpaB1bYLYcVdsth1Zu_0WFpNcW1aEeL7mrRPQXd7MRcbD_9CwAA__8Pq1y9

query T
EXPLAIN (VERBOSE) SELECT * FROM outer_gc1 FULL OUTER JOIN outer_c1 USING (pid1, cid1, cid2)
----
distribution: full
vectorized: true
·
• render
│ columns: (pid1, cid1, cid2, gcid1, gca1, ca1)
│ estimated row count: 1,999 (missing stats)
│ render pid1: COALESCE(pid1, pid1)
│ render cid1: COALESCE(cid1, cid1)
│ render cid2: COALESCE(cid2, cid2)
│ render gcid1: gcid1
│ render gca1: gca1
│ render ca1: ca1
│
└── • merge join (full outer)
    │ columns: (pid1, cid1, cid2, gcid1, gca1, pid1, cid1, cid2, ca1)
    │ estimated row count: 1,999 (missing stats)
    │ equality: (pid1, cid1, cid2) = (pid1, cid1, cid2)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)",+"(cid1=cid1)",+"(cid2=cid2)"
    │
    ├── • scan
    │     columns: (pid1, cid1, cid2, gcid1, gca1)
    │     ordering: +pid1,+cid1,+cid2
    │     estimated row count: 1,000 (missing stats)
    │     table: outer_gc1@outer_gc1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          columns: (pid1, cid1, cid2, ca1)
          ordering: +pid1,+cid1,+cid2
          estimated row count: 1,000 (missing stats)
          table: outer_c1@outer_c1_pkey
          spans: FULL SCAN

query T
EXPLAIN (DISTSQL) SELECT * FROM outer_gc1 FULL OUTER JOIN outer_c1 USING (pid1, cid1, cid2)
----
distribution: full
vectorized: true
·
• render
│
└── • merge join (full outer)
    │ equality: (pid1, cid1, cid2) = (pid1, cid1, cid2)
    │ right cols are key
    │
    ├── • scan
    │     missing stats
    │     table: outer_gc1@outer_gc1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: outer_c1@outer_c1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckm-Lm0AQxt_3UyzzKunNkazm-kco7JF6xcOLVzVQKKFYd2oF49pdhR4h372obS_KJZf2TWCenWfye8bZgflRgAPup3v_2luxyXsviqOP_pRFru8uY_aS3YTBHVNNTfpLlnJ2s_Z9dht4q99aytk68lYf2KTKJUeW_vm1poBQKkmrZEsGnM_AAeEKNgiVVikZo3Qr77omT_4EZ46Ql1VTt_IGIVWawNlBndcFgQMrdamqmQ0IkuokL7q2PYJq6keTqZOMwFns8WAwPz04Tr4WFFIiSc_mg_HwN7iodL5N9AMgLFXRbEvjsHFiZFlfZGnSho2qpG27hGOU_H8p-VOU50KeCWcdhXtkakqlJWmS44_yfMsTCe9IZ3Sr8pL0zBomjB8qcvrjC9axG3YnCAgFfasngl-gsC5Q2BfTdzrPvg8lQAiplKQdtgyufTdauhPBUbya4oFgoXg9EGwUb6bIxAKZuEIm3h7dlD3Y1DNXHJKpVGnorDOet2simVG_dqMandK9Vmn3N30ZdL5OkGTq_nXRF17ZP7WAh2Z-0mwPzHxstv7BbI3N9knzfIS92b_4FQAA__9AYngC

query T
EXPLAIN (VERBOSE) SELECT * FROM outer_c1 LEFT OUTER JOIN outer_p1 USING (pid1) WHERE pid1 >= 0 AND pid1 < 40
----
distribution: full
vectorized: true
·
• project
│ columns: (pid1, cid1, cid2, ca1, pa1)
│ estimated row count: 400 (missing stats)
│
└── • merge join (left outer)
    │ columns: (pid1, cid1, cid2, ca1, pid1, pa1)
    │ estimated row count: 400 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid1, cid2, ca1)
    │     ordering: +pid1
    │     estimated row count: 400 (missing stats)
    │     table: outer_c1@outer_c1_pkey
    │     spans: /0-/40
    │
    └── • scan
          columns: (pid1, pa1)
          ordering: +pid1
          estimated row count: 40 (missing stats)
          table: outer_p1@outer_p1_pkey
          spans: /0-/40
          parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM outer_c1 LEFT OUTER JOIN outer_p1 USING (pid1) WHERE pid1 >= 0 AND pid1 < 40
----
distribution: full
vectorized: true
·
• merge join (left outer)
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: outer_c1@outer_c1_pkey
│     spans: [/0 - /39]
│
└── • scan
      missing stats
      table: outer_p1@outer_p1_pkey
      spans: [/0 - /39]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlWFrm0AYx9_vUxzPq2a94J2aNBUKltZuKWnSJSkbbDKsPkuE1HOnwkrJdx9qS6tLNeVosjchnv7uuef_u-MeIPm9Agucb9ej0-GYHJwPZ_PZl1GHzJyRczYnH8nFdHJFRJai_OlzMnIu5uRyMhw_DsWc3MyG40_kIA4D3iFfPztTp3wgPzLGDDwhrENOx-cvB31isg5QiESAY-8OE7C-AwcKOlAwgIIJFHrgUoil8DFJhMw_eSiAYfAHLEYhjOIszYddCr6QCNYDpGG6QrBg7t2ucIpegFLL5w0w9cJVUeZp3XYswztP3gOFM7HK7qLEIvkKKYm9HJnFXj6ksa7WI14UEE5EukQJ7prmkzwWf655e0-WXrKsVrM5uGuXQpJ6CwRLX9NXmnieJ4uEDFBiUJnJzcmnTzZ9ADY_LGvVw7hCucBLEUYotX6Vmd_HaJVSJzdzZ1qoBQor_JUe2PywcyLDxbL8CxQmWWoRm1Nbp7ZBbZPa_Vocz60aCq1uaGIsuiLWOKuHsrG2WanNt98rutpe6XU1zt5ps_Ddb5ajPW0WfXthhpowzroaf6_jre_e2GBPxoztjZmKxnpdTX-vM2bs3tjxnoyZ2xtjm4z5Dcb8p1-dEr9-mZpMSRh_tYsdCev9BzfohiVOMYlFlOBW9yPLm8RggWVuicikj9dS-EWZ8nFScMW9E2CSlm85K5-GUfGuOD1voFVgUwXuq8CDZpjXYfYS1iswr8N6I8yribE6bSjJaqFV4BZZzXCLrGa4RZapIqunFHcLrQK3xN0Mt8TdDLfE3VeJ-0gp7hZaBW6JuxluibsZbol7oBL38VvifiutApsqcF8FHjTD_J97ozFvd_3hbwAAAP__eoaomw==

query T
EXPLAIN (VERBOSE) SELECT * FROM outer_p1 RIGHT OUTER JOIN outer_gc1 USING (pid1) WHERE pid1 >= 1 AND pid1 <= 20
----
distribution: full
vectorized: true
·
• project
│ columns: (pid1, pa1, cid1, cid2, gcid1, gca1)
│ estimated row count: 200 (missing stats)
│
└── • merge join (left outer)
    │ columns: (pid1, cid1, cid2, gcid1, gca1, pid1, pa1)
    │ estimated row count: 200 (missing stats)
    │ equality: (pid1) = (pid1)
    │ right cols are key
    │ merge ordering: +"(pid1=pid1)"
    │
    ├── • scan
    │     columns: (pid1, cid1, cid2, gcid1, gca1)
    │     ordering: +pid1
    │     estimated row count: 200 (missing stats)
    │     table: outer_gc1@outer_gc1_pkey
    │     spans: /1-/21
    │
    └── • scan
          columns: (pid1, pa1)
          ordering: +pid1
          estimated row count: 20 (missing stats)
          table: outer_p1@outer_p1_pkey
          spans: /1-/21
          parallel

query T
EXPLAIN (DISTSQL) SELECT * FROM outer_p1 RIGHT OUTER JOIN outer_gc1 USING (pid1) WHERE pid1 >= 1 AND pid1 <= 20
----
distribution: full
vectorized: true
·
• merge join (left outer)
│ equality: (pid1) = (pid1)
│ right cols are key
│
├── • scan
│     missing stats
│     table: outer_gc1@outer_gc1_pkey
│     spans: [/1 - /20]
│
└── • scan
      missing stats
      table: outer_p1@outer_p1_pkey
      spans: [/1 - /20]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlW9Po0AQxt_fp9jMK3tuU5Y_tZKYYBQVU1uvxdwld-SCMEdJKsstkJwx_e4XQKPlKtSsqfem6S7725l5ntnMA2S_l2CC_e16fOxMyN6pM3fnX8Y9MrfH9olLPpOz2fSK8CJH8TNlZOacX7jkcupMHveigJGbuTM5J3tpHLIe-Xphz-x6QX4UiqLhEWE9cjw5fbkZHBFV6QGFhIc48e8wA_M7MKCgAgUNKOhAwQCPQip4gFnGRXnkoQKc8A-YCoU4SYu83PYoBFwgmA-Qx_kSwQTXv13iDP0QxaC8N8Tcj5dVmKdqrFTEd764BwonfFncJZlJyhQpSf0Smad-uTVg_YFB_CQkjPB8gQK8FS0veQz-HPP2niz8bLEezWLgrTwKWe5HCKa6oq8U8XxPkXARosBw7SavJJ-ObDoAFtuvYzXFuEIR4SWPExSD4Trj3qdokrF95pLpjWvPKnOBwhJ_5XsW2-8diTha1H-BwrTITWIxah1QS6WWRi2dWkZDkedqNYlqN9Qx4X2eDpjS1GVjbH0tNtu-XVS5djH6ZYbv1yNs9z1y8HE9om7vkyb5rJX-gDXTkjFK3b1Ro48zStveKF3SKKM_UN_zRWm7N-rw44zStzdK2WRUFLQ4FTz9qpRE9SIKmtNTZVLmsVfL2ZF5xv8xMjdkOcMs5UmGWw1EpawTwwhr6TJeiACvBQ-qMPVyWnHV0Akxy-uvTKlXTlJ9qx7TG2gZWJeBhzLwqB1mTVh5CatrMGvCaivM1hVTmrQmZVYHLQN3mNUOd5jVDneYpcuYZUjJ3UHLwB1yt8MdcrfDHXIPZeQ-kJK7g5aBO-Ruhzvkboc75B7JyH34FrnfSsvAugw8lIFH7TD7Z2606u2tPv0NAAD__9BOo-w=

query T
EXPLAIN (DISTSQL) SELECT * FROM child1 JOIN child2 USING(pid1)
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid1)
│
├── • scan
│     missing stats
│     table: child1@child1_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: child2@child2_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycklGLEzEQx9_9FGGeWh25JkWFgBA5q-zRa89uBUH2IW7GvcB2syZZUMp-d9nk4ezROz1fQjIz_5nff8gRwo8WJKy-3KzfFRs2e1-U-_LTes7K1Xp1uWfP2Yfd9prVt7Y1nF1ti02-C_a5LDYf2ay3hs8BoXOGNvpAAeRX4FAh9N7VFILzU-iYCgrzE-QCwXb9EKdwhVA7TyCPEG1sCSTs9beWdqQN-YsFIBiK2rapbaZQvbcH7X8BwqVrh0MXJJsokNX51BwQyl5PiZdQjQhuiHcDQ9QNgeQj_h8UPwMlHoUS6VxOaOJf0MSDaHdEQ-e8IU_mhKaalH8rOePvmnxDV8525C_Eqb-WvseZ4i_mb71tbvMVELZDlExxVALVEtUrVK9RvXnQ0vIp295R6F0X6L61s50Xkx8yDeX9BDf4mm68q9OY_NwmXQoYCjFnRX4UXUql7_CnmD9BLO6LxaPi5Yl4MVbjs98BAAD__6SII3Q=

query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN parent2 ON pid1=pid2
----
distribution: local
vectorized: true
·
• merge join
│ equality: (pid1) = (pid2)
│ left cols are key
│ right cols are key
│
├── • scan
│     missing stats
│     table: parent1@parent1_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: parent2@parent2_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckUGL2zAQhe_9FWJOu63KWkpPggWXNAWHxE7jHArFB9WaugZHUiUZWoL_e7EcSBOSttmTPU96M98bHcD_6EDA4vNm9T7LycOHrNyVn1aPpFysFvMdeU0-bos1sdKhDowsiyw_FpwUObGtYuR5_HCgoI3CXO7Rg_gCDCoK1pkavTdulA7xQqZ-gkgotNr2YZQrCrVxCOIAoQ0dgoCd_NrhFqVC95QABYVBtl1seyRJrWv30v0CCnPT9XvtRYShxEoGFEorR-ktVAMF04fTLB9kgyDYQF_Gw67x8Bs8fOTh_8PDb_KcMHptnEKH6gyhGp3_unIl1Bpdg0vTanRP_DxUh9_CQ8rePD67tvk-_QKFog-CpIymnKYzmr67GWZ2z3K36K3RHi9DXe2cjElQNThtxpve1bhxpo5jprKIvigo9GE65VOR6XgUX_9PM7vDzC_N_K_m2Zk5Garh1e8AAAD__8jUIAk=

# Join on "non-interleaved" column uses hash joiner.
query T
EXPLAIN (DISTSQL) SELECT * FROM parent1 JOIN child1 ON pa1 = ca1
----
distribution: local
vectorized: true
·
• hash join
│ equality: (pa1) = (ca1)
│
├── • scan
│     missing stats
│     table: parent1@parent1_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: child1@child1_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckkGL2zAQhe_9FWJOSVFZy24vggWVbUq9pPY2zqFQfFCtaSJwJFWSoSX4vxfbhdQhaZu9GPRm3sz3Bh8hfG-Bw-rz0_ptXpDFu7zaVp_WS1Kt1quHLXlJ3m_Kj8RJjyYy8ljmBWn2ulWMlAVxkpF70kgGFIxVWMgDBuBfgEFNwXnbYAjWD9JxbMjVD-AJBW1cFwe5ptBYj8CPEHVsEThs5dcWNygV-rsEKCiMUrfj2N8Ywnl9kP4nUHiwbXcwgROnFaMDEFConBykV1D3FGwXT7tClDsEznr6PB4255kucR2nmb7_B5VehTqxdMZ6hR7VjKMenP9quZDsgwz7R6sN-rt0HqzFb3Eh0uW917t9XIhsCRTKLnIiGBUpFRkVr6l4czVMdsuFNxicNQHPQ12cnAxJUO1wukywnW_wydtmXDM9y9E3CgpDnKrp9MjNWBp_gT_N7AZzem5O_2rOZuakr_sXvwIAAP__RNgflQ==

query T
EXPLAIN (DISTSQL) SELECT * FROM child2 JOIN grandchild2 USING(pid1, cid2)
----
distribution: full
vectorized: true
·
• merge join
│ equality: (pid1, cid2) = (pid1, cid2)
│
├── • scan
│     missing stats
│     table: child2@child2_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: grandchild2@grandchild2_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzEld9vmzoUx9_vX2Gdp_bWkbGB_EC6ElddN6Vqk67ppEkTDxQ8gkQxM0RaVeV_n4BWKWlmwxjNiyWDPz7nfL-2zxPkPxJw4OLrzdX_8wU6-TBf3a0-X52i1cXVxfkd-hd9vF1eo2AdJyFDl8v5AkXST8PnD19W88UndJLFIcUoiEN2ChhSEfKF_8BzcL4BBQwMMJiAwQIMNngYMikCnudClkueKmAe_gTHwBCn2aYoP3sYAiE5OE9QxEXCwYE7_z7ht9wPuSQGYAh54cdJFabOx81k_ODLR8BwLpLNQ5o7aJdbNZoYBX6Z0Crzy98j8LYYxKZ4DruLdv-I1n6-bsZxKXYZeFsPQ174EQeHbvGfVUCbO7-StV0ZUT2JmuUQRixGGGHIT0NEkSjWXPatkf22xt1Wm1TIkEseNjbzSvJlyaEF4NIz7LKzOt6-XtdcRvxSxCmXZNzkEv69OHmGT_-TcbTeTQHDclM4qKoEuyZ2LexOsDvF7mxPi12RZo8iD6S-ECOREUr35TgY22rEpu0PkTXEISLUILZRjtQYEWoR2ypHag13puhxztTsXc8Ua-8rG8TXl7dhRMbEGpMxGQ_nKDuOo5N3ddRs76g9zE3dXc4RoVNiT8uRTofz1TyOr9R4V2Ot9saagxj7ckFHrx_jylVWu5r_XVut49g6PVpTP5DYLc8zkea8Vcs2ytJ4GPFasVxsZMBvpAiqMPV0WXFVdwt5XtR_WT2Zp_WvMsH28KQPTGkf2u4Dz9Qw7aAY6wZP-sB7inWk7T7wTA2zfdh4DZtquU0lTJt6G_u01ccsNawxSw3rzFLTGrPUsMYsu49Z4z5yq2GN3GpYJ7ea1sithjVyT_rIPe0jtxrWyK2GdXKraY3calgj96yP3LRLs3z7hHbpll1p7ePfpV92pTWa0zfNQym6t_3nVwAAAP__Q9lqFA==

# Subset join on "interleaved" columns uses hash joiner.
query T
EXPLAIN (DISTSQL) SELECT * FROM child2 JOIN grandchild2 USING(pid1, cid3)
----
distribution: full
vectorized: true
·
• hash join
│ equality: (pid1, cid3) = (pid1, cid3)
│
├── • scan
│     missing stats
│     table: child2@child2_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: grandchild2@grandchild2_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzEld9umzAUxu_3FNa5aidHxgbyB2kSU9dtqbqkazpp0sQFBS9BopgZIq2q8u4T0C4lzWwYg91YMubnc8732T4PkP2IwYHzr1eXb-cLdPJuvrpZfb48Ravzy_OzG_Qavb9efkLBJopDhi6W8wVaSz8JHz98Wc0XH9BJGoUUoyAKzVPAkIiQL_w7noHzDShgYIDBBAwWYLDBw5BKEfAsE7L45aEE5uFPcAwMUZJu8-KzhyEQkoPzAHmUxxwcuPFvY37N_ZBLYgCGkOd-FJdhqnzcVEZ3vrwHDGci3t4lmYN-58aqDDEK_CKhVeoXyyPwdhjENn8Mu492e482frapx3Epdk3wdh6GLPfXHBy6w39XAa3v_EzWZmWsq8m6Xg5hxGKEEYb8JEQUiXzDZdca2R9r3G-1TYQMueRhbTOvIHW_HBHqo59tLkSUcEnG9exi_j0_KVM8fSOj9eZpAhiW29xB5Qy7DLsWdsfYnWJ3dlD_vjCzQ2FHsl6IkUgJpYcSHI1t1WLT5gfH6uPgEGoQ2yhGaowItYhtFSO1-jtHdNhzNBvsHLHmXrJevHx6A0ZkTKwxGZNxfy6yYV2cDOai2dxFu58bub-EI0KnxJ4WI53256U5rJfUGMxMq7mZZi9mPl3E0fOHtnSSVU5m_9ZKa1grp_-lSR_J6ZpnqUgy3qgFG0VVPFzzSqVMbGXAr6QIyjDVdFlyZbcKeZZXq6yazJNqqUiwOTzpAlPahba7wDM1TFsoxtrBky7wgWItabsLPFPD7BA2nsOmWm5TCdO63sYhbXUxSw1rzFLDOrPUtMYsNawxy-5i1riL3GpYI7ca1smtpjVyq2GN3JMuck-7yK2GNXKrYZ3calojtxrWyD3rIjdt0yxfPqFtumVbWvv4t-mXbWmN5vRF81CK7u1e_QoAAP__OX5gyg==

# Multi-table staggered join uses merge joiner on the bottom join
# and a lookup join on the higher join.
query T
EXPLAIN (DISTSQL)
  SELECT * FROM grandchild1
  JOIN child1 USING (pid1, cid1)
  JOIN parent1 USING (pid1)
ORDER BY pid1
----
distribution: local
vectorized: true
·
• lookup join
│ table: parent1@parent1_pkey
│ equality: (pid1) = (pid1)
│ equality cols are key
│
└── • merge join
    │ equality: (pid1, cid1) = (pid1, cid1)
    │ right cols are key
    │
    ├── • scan
    │     missing stats
    │     table: grandchild1@grandchild1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: child1@child1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFv0z4QwN__n8K6p_a_Q2vSwkQkJMNWUKauHUmRQCgPJj4yQ2oH25FAVb87SlLUpmrHylNyvvvZvzt7De5HCRFMP97PXsdzNriJ02X6fjZk6XQ2vV6y_9nbZHHHCiu0zB9UKQN2u4jnbPv_IY3n79igUjJAlisZDLt0JSxp38sP2SK5mSbszSfWhICgjaS5WJGD6DMEkCFU1uTknLHN0rotiOVPiEYISle1b5YzhNxYgmgNXvmSIIKl-FJSQkKSvRwBgiQvVNluuyfOK6tWwv4ChGtT1ivtIrYTR1b8-YhGLq1EU_AMsg2Cqf3udOdFQRAFG_w3w6Bv-DS5J0qFJ6V2LrU2VpIl2fPIGvJvJUc6uyNb0K1Rmuxl2O-spK9-wIML5OHF8JVVxcMuBIRF7SPGA-Qh8jHyCfLnyF8gvzrZ3fickTdO24mP-17bx7k38pkx3-uKfTNKM6Mbq6N-V8hfnpSbnCOXkKuMdnR4BUd3HjVzJ1lQd4_O1Dane2vy9pguXLRcuyDJ-S4bdkGs21T7YPfh4Aw4PITDR-FxDx4dwuNH4ckBnG3--x0AAP__7dt9rQ==

# Multi-table join with parent1 and child1 at the bottom uses merge
# joiner but induces a hash joiner on the higher join.
query T
EXPLAIN (DISTSQL)
  SELECT * FROM parent1
  JOIN child1 USING (pid1)
  JOIN grandchild1 USING (pid1, cid1)
----
distribution: local
vectorized: true
·
• lookup join
│ table: parent1@parent1_pkey
│ equality: (pid1) = (pid1)
│ equality cols are key
│
└── • merge join
    │ equality: (pid1, cid1) = (pid1, cid1)
    │ left cols are key
    │
    ├── • scan
    │     missing stats
    │     table: child1@child1_pkey
    │     spans: FULL SCAN
    │
    └── • scan
          missing stats
          table: grandchild1@grandchild1_pkey
          spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyckl1v0zAUhu_5Fda5atlBq9PyFQnJaBSUqWtHUyQklAsTH7JAagfbkUBV_zuKM2hTto5yZZ2P1-c5r70B972CGKYfr2evkzkbvEnSVfp-NmTpdDa9WLHH7O1yccVqaUl7zi4XyZzlN2WlOPuQJvN3bFCXig-7QmGlVn9XkeVtDyBoo2gu1-Qg_gQcMoTampycM7ZNbUJDon5APEIodd34Np0h5MYSxBvwpa8IYljJzxUtSSqy5yNAUORlWYVru_mituVa2p-AcGGqZq1dzHYsyHLJASGtZVt4AtkWwTR-N9B5WRDEfIv_B8X7UHvOPERW_D7-jTC6l3AH1mhjFVlSPaisVT7UcseaV2QLujSlJnse9des6IsfCH6GIjobvrJlcbMLAWHR-JgJjiJCMUYxQfEUxTMUz-_dbnyK_y3Trf3jPtft992zfmbMt6ZmX02pmdEt1R--F4HvZUA8Cjc5BW5Jrjba0eET3HnzqPWdVEHdOzrT2JyurcnDmC5cBF1IKHK-q0ZdkOhQCr93X8xPEEeH4uioeNwTjw7F46PiyYE42z76FQAA__-hiXnR

statement ok
DROP TABLE grandchild2, grandchild1, child1, child2, parent1, parent2
