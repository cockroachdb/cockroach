# LogicTest: 5node

statement ok
CREATE TABLE json_tab (
  a INT PRIMARY KEY,
  b JSONB,
  c INT NOT NULL DEFAULT 10 CHECK (c IN (10, 20)),
  FAMILY (a, b, c)
)

statement ok
CREATE INVERTED INDEX json_inv ON json_tab(c, b)

statement ok
CREATE TABLE array_tab (
  a INT PRIMARY KEY,
  b INT[],
  c INT NOT NULL DEFAULT 10 CHECK (c IN (10, 20)),
  FAMILY (a, b, c)
)

statement ok
CREATE INVERTED INDEX arr_inv ON array_tab(c, b)

statement ok
INSERT INTO json_tab VALUES
  (1, '{"a": "b"}'),
  (2, '[1,2,3,4, "foo"]'),
  (3, '{"a": {"b": "c"}}'),
  (4, '{"a": {"b": [1]}}'),
  (5, '{"a": {"b": [1, [2]]}}'),
  (6, '{"a": {"b": [[2]]}}'),
  (7, '{"a": "b", "c": "d"}'),
  (8, '{"a": {"b":true}}'),
  (9, '{"a": {"b":false}}'),
  (10, '"a"'),
  (11, 'null'),
  (12, 'true'),
  (13, 'false'),
  (14, '1'),
  (15, '1.23'),
  (16, '[{"a": {"b": [1, [2]]}}, "d"]'),
  (17, '{}'),
  (18, '[]'),
  (19, '["a", "a"]'),
  (20, '[{"a": "a"}, {"a": "a"}]'),
  (21, '[[[["a"]]], [[["a"]]]]'),
  (22, '[1,2,3,1]'),
  (23, '{"a": 123.123}'),
  (24, '{"a": 123.123000}'),
  (25, '{"a": [{}]}'),
  (26, '[[], {}]'),
  (27, '[true, false, null, 1.23, "a"]'),
  (28, '{"a": {}}'),
  (29, NULL),
  (30, '{"a": []}'),
  (31, '{"a": {"b": "c", "d": "e"}, "f": "g"}'),
  (32, '{"a": [1]}'),
  (33, '[1, "bar"]')

statement ok
ALTER INDEX json_inv SPLIT AT VALUES (10), (20)

statement ok
ALTER INDEX json_inv EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 10), (ARRAY[3], 20)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW EXPERIMENTAL_RANGES FROM INDEX json_inv WITH DETAILS] ORDER BY lease_holder
----
start_key     end_key               replicas  lease_holder
…/<IndexMin>  …/10                  {1}       1
…/10          …/20                  {2}       2
…/20          <after:/Table/107/2>  {3}       3

statement ok
ALTER TABLE json_tab VALIDATE CONSTRAINT check_c

# Filter with a scalar.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '1' ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • scan
      missing stats
      table: json_tab@json_inv
      spans: 2 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJykk1Fv2j4Uxd__n8K6L_1PcxQ7DqLNE1vJNCQKLEHapg1VBt_QbCHObLN2qvjuUwLdAFFU2Etk-978ztHx9SPYHwVEEH8a9d_0BuT_bi8dpx_6r0ga9-PrMZHkXTK8Id-sLm-dnJKP7-MkJlPS-bpkTCC54BdkmHTjhLz9TCRQKLXCgVyghegLcKAQAAUBEwqV0TO0Vpu69Ng09tQDRIxCXlZLtz52uSsQItBGoUEFFBQ6mRcNr8Nfw2Q1oTDTBiH62z3Qnq78cKd7sqKgl25DnlCwTs4RIrFlpdeFKFzRLTd8y80BobGcFpigVGh8tmvuKaNOs8jLn0DhWhfLRWmjJpq0kvXS58znXvP1Rwaz_CEuFZGlIpxod4cGnnPO95yzU5yn2jg0fnAo0cNywZ5csCMXvDwofmZQQRNU8O9B8VOcb4IS5wclduTYcbkEbaVLiy-aXban5PH6NaCa4_r1WL00MxwZPWt619thA2oOFFq3rrbWm175VLLOoFz8GattEj9KCk4gBUdJbIfEt0nBPkkcJYXPe-L7pPBcT6LOPiv0_W2uIIKroIUthlOvJTPhhRkT3mWLtb12eCXbQrBLnGZQ_yDnth6A9E7fN9jxr6q-vkwWFincyO_YRYdmkZe5dflsU1mt_vsdAAD___Rm1KI=

# Filter with fully-specified arrays.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[1, 2]' OR b @> '[3, 4]' ORDER BY a
----
distribution: local
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 4
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 4 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkt9P2zAQx9_3V5zuBdhcJU7YAD-V0aBVAsqaSttEI-QkF8iW2pntABPq_z4lWRmtVDZerPul7_c-1j2i_VmhwOjr5dnx-AJ2R-N4Fn8-24M4OotOZiDhdDo5h-9Wq2snU_jyKZpGsJvCcN74fkiwc8UZBMnOHkym6_WQwX5fH0VT-PgNJDJUOqcLuSCL4go5JgxrozOyVpu29NgNjPMHFD7DUtWNa8sJw0wbQvGIrnQVocCZTCuakszJeD4yzMnJsupkV8sOu6BUd8jwRFfNQlkBkkGKDONatpnHfe_YGI8PniLv0lBRPkQqB6lyOADtbslYTJYMdeP-bmSdvCEU_BnCeITCX7L_pxirOzKO8tOycmTIeHwdZdWPHmoDWsGQC7Dt6mCdNE7M8WA-932_fcKniL9t36DPEUjl_x7kc4QOOFwBM5w0TsCQb0UPNtD5a9BjbRwZL1gHHvJ3W-3CDbvgNXZTsrVWltbstjn5G04DvkwYUn5D_ZFa3ZiMLo3Outk-nXRCXSEn6_ou75OxWrWsMyQXT4fyXIm_qBRsV-KbSsGLSuFLOyUMi0rfX5c5CszSIjzKsv0BL2Q62OdBNjh6_yEbHEr_MKU0KLKj9mCLSt7Y9rPjW33fyc5-1e1XFbKyxPBc_qAROTKLUpXWldmfznL55ncAAAD__ySEbWM=

# Filter with a path ending in an empty object.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '{"a": {}}' ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 2
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 2 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVFv2j4Uxd__n8K6L_1PM4qdBEr9xFZSDaktHSBt04Iqk1zabMFmttN2QvnuU0K7QVbQqPawF4R9r37nHp3kZgX2Ww4Coo9X528Gl-T__mA8Gb8_f0XG0Xl0OiGSnI2GF-SL1erayRn58C4aRWRGenHBWIDkaBWDjEGQVVkekeGoH43I209EAgWlU7yUC7QgPgMHCj5QCGBKYWl0gtZqU5VWdeMgfQDBKGRqWbj1tctcjiCgUNqkaDAFCik6meVVfVpOKSTaIIhfrf3Mukwlzgu3eqFXyQ8LJ0iPw7SkoAv3qDOlYJ28QRDBxmCDPoiwpDtme0Z5rI1D47Wbuq93yoUNufaWHN8vN5GzHEcoUzQe29Z8iqpX_8nUHVA41XmxUFYQSckMKIyXsjp5nHl1fN6qbG0evCuD8-whUimRKiWcaHeLZqcV3rDCDrEyUHdoHKZnWe7QoPH8bT9P9ehhaYhWpMcFsdX8xDppnIjhWMYxY6z64ScxEFRp41bEQDad2J1W_IYVf8uK_-ep8Jen4m-m4v-1VPghVn5LJfiXUgkOeTVHaJdaWWysj-eVWEOpxas9g-kNrpeS1YVJ8MropO5dH4c1qL5I0bp1la8PA_VUss6gXPzcLJskvpfU2U1iTZK_lxQcQAr2ktgWiW-S_CYp3Etq756JN0ntl84UVCnOc31_naUgYI5-u8O6nVaIyFphlwctmfjdVnISdLohdo59rL4g81ze2OpRGt_q-xo7-b6sHoS5zC1SuJBfsY8OzSJT1ZcneayU5X8_AgAA__9CT17U

# Filter with a path ending in an empty array.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '{"a": []}' ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 2
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 2 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlV9v0zAUxd_5FNZ9GQhXsfNnY3kqrJmotK2jrQRoiSY3ud0CqV1sZxuq8t1R0pW1Ya3oeOGlqn2vfuceneRmAeZHASFEXy7P3vcvyOtefzQefTp7Q0bRWXQyJoKcDgfn5JtR8tqKCfn8MRpGZEK6ccmYh-RgEYOIISRXSXVABsNeNCQfvhIBFKTK8ELM0EB4BRwouEDBg4TCXKsUjVG6Li2axn72ACGjkMt5aZfXNrcFQgilVDpDjRlQyNCKvKjrSZVQSJVGCJ9ae7mxuUyt42_0QreWH5Q2JF0OSUVBlfZRJ6FgrLhBCL21wfo9CP2KbpntGeWR0ha1E7R1326V81tywYYc3y03FpMChygy1A7b1FxF1W3-5PIOKJyoopxJExJByQQojOaiPjmcOU18zlXSeTosKiJkRjhR9hb1VgO8ZYDtY6Av71BbzE7zwqJG7bibLlb16GGuiZKky0Ni6qmJsULbMIYjEceMsfqHv4uBoMxat8cxkHUnZqsVt2XF3bDi_n0W_OVZuOtZuP-YBd_HwB9ZeP9TFt4-r-EQzVxJg61V8bwSayl1eL1TMLvB5QIyqtQpXmqVNr3L46ABNRcZGrus8uWhL1clYzWK2e8tsk7iO0mH20msTXJ3krw9SN5OEtsg8XWS2yb5O0nB9pl4mxS8dCavTnFaqPvrPIMQhHcsPB95B6eu2_GDIOscI7KOH-DhND2a-Eesfg2nhbgx9aM0ulX3DXb8c14_CFNRGKRwLr5jDy3qWS7rr0z6WKmqV78CAAD__3TIV1o=

# Filter with a nested array. This index expression is not tight.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[[1, 2]]' OR b @> '[[3, 4]]' ORDER BY a
----
distribution: local
vectorized: true
·
• filter
│ filter: (b @> '[[1, 2]]') OR (b @> '[[3, 4]]')
│
└── • index join
    │ table: json_tab@json_tab_pkey
    │
    └── • sort
        │ order: +a
        │
        └── • inverted filter
            │ inverted column: b_inverted_key
            │ num spans: 4
            │
            └── • scan
                  missing stats
                  table: json_tab@json_inv
                  spans: 4 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUlFtv4joQgN_Pr7Dmpe05RsRJEAc_0ZZUS9WWLiDtrkpUOcnQZhvsrG16UcV_XyWBbsk2qDxgeS58c_FMXsH8yoBD8P364nh4RQ4Hw8l08vXiiEyCi-B0SgQ5G48uyU-j5K0VEfn2JRgH5DAi_dnScTwkBzc3jBI3DA-OyGhcs3iU-GvLIBiTkx9EAAWpErwSCzTAb4BBSCHXKkZjlC5Ur6XDMHkG7lBIZb60hTqkECuNwF_BpjZD4DAVUYZjFAnqtgMUErQizUrsJuF-eUnlI1A4VdlyIQ0ngpIIKExyUUht5rSPtS5_rLUlta81ztPnQCZEyIR0ibL3qA2EKwpqaf9kZqy4Q-DsXSnDAXBnRT9fzVA-oraYnKWZRY26zbZL2tiD51wTJUmfcWKKEoixQls-g-5s5jhOcXgf3Ni_xelWMhCUyT5_YTMgZRO8TRMojJaWkz5rbIdbawfbpx0TpS3qtrvdhD77rzGcVwvn7hPuXKVyPUrerlGyIrrNH_Dlr3lqysqvZeXtk9XbLPjbOVV6Tg777gebyDk_n4yuTqqN3HZZr-SbyyeesVOrwN-ngjGaXEmDW_k3RXJqkVpsFVLA5A6rD4NRSx3jtVZx6VuJoxJUKhI0trKyShjKjclYjWLxtpTvSWwnyW0msTrJ3UnymkluneTtJPnNJK9O8neSOrv6FFKYZ-rpNk2AA4t7ccftsVbvf0xafux3W5Hbnbd8l3mdyBM9Jy4WZ56JO1MMwORePZXY6UtePN9cZAYpXIoHHKBFvUhlamwary2r1T-_AwAA__-VthId

# Combine predicates with OR.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[1]' OR b @> '[2]' ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 2
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 2 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzUVd9P2zoUfr9_hXVegHtdJU5aoHkqlwatElDWVtomWiEnPoVsqd3ZDjCh_u-TG-iajHYr2steIp8f-r7z6bNPnsB8zSGC-OPV-Unvkux3e8PR8P35ARnG5_HpiHByNuhfkM9GyRvLE_LhXTyIyX5COuPC90Mke9dssndA-oNqMiiT3XhA_v9EOFCQSuAln6GB6BoYUAiAQggTCnOtUjRGaVd6Wjb2xCNEPoVMzgtbpm1mc4QICqm0QI0CKAi0PMtdfbKYUEiVRoh-tHYzYzOZWq9Z6YWOo-8XNiIdBpMFBVXYZ54JBWP5LUIUrg3W60LUXNANs73CPFTaovZadd7_NtI1a3StCh3bTjfiSY4D5AK151c5X5zrLA-ZvAcKpyovZtJEhFOSAIXhnLvIY753orXHGquTd6Vxmj3GUhAuBWFE2TvUG0Wwmgh_FxE9eY_aojjLcosatRdUlbzU48e5JkqSDouIcZMTY7m20RiOxmPf990nXJ3Yv-4blDEQlOLXjWwMZF2v2Sg4qAkOKoKD33eNvd21YOVa8GdcY7uI-Mm18O9zLdzlaQ_QzJU0WFs_rzP5NaYGc3sKxS2WS82oQqd4pVW67C3D_hJomRBobFllZdCTLyVjNfLZajOtI7GtSIebkfw6UrAVKdwBKdyK5FeQ2DpSUEdqbkVqbZ6J1ZFab50pdC5Oc_VwkwmIgIvjZpul7UYg2kmjmQbYaKcJa2ByGKbttn8sjtyDneb81rirNLxTD0vY0be5uwhTnhukcMG_YBct6lkm3Z8rfa4sFv98DwAA__9AqXFD

# Combine predicates with OR.
query T
EXPLAIN (DISTSQL)
SELECT * FROM json_tab WHERE b @> '[3]' OR b @> '[[1, 2]]' ORDER BY a
----
distribution: local
vectorized: true
·
• filter
│ filter: (b @> '[3]') OR (b @> '[[1, 2]]')
│
└── • index join
    │ table: json_tab@json_tab_pkey
    │
    └── • sort
        │ order: +a
        │
        └── • inverted filter
            │ inverted column: b_inverted_key
            │ num spans: 3
            │
            └── • scan
                  missing stats
                  table: json_tab@json_inv
                  spans: 3 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUk11P4zoQhu_Pr7Dmho_jqnGSwsFXBRp0ioCyTaXdFY2Qm0whS2pnbZcPof73VRLaJZHS3d5E9szomfeNZ97B_MyAQ_Dt9up0eEP2B8NwEn65OiBhcBWcT8ghuRiPrskPo-S9FTPy9f9gHJD9GelPl47jIdm786K9AzIa14N3jBI3qjKDYEzOvhMBFKRK8EYs0AC_AwYRhVyrGI1Rugi9lwXD5BW4QyGV-dIW4YhCrDQCfweb2gyBw0TMMhyjSFB3HaCQoBVpVmLXWvvlIZXPQOFcZcuFNJwISmZAIcxFcesyp3uqddfrbE7dW43z9DWQCREyIT2i7CNqA9GKglra34qMFQ8InH2yMBwAd1b0710M5TNqi8lFmlnUqLusbmWdD15zTZQkfcaJKaQTY4W2fArH06njOMXH25zYYfE9qu5AUCZ_LmRTIKVhd22YwmhpOemzVutuwzrbxXqotEXddeuG--zf1nZeo527S7tLlcqPcfG2jYsVs_v8Cd-aM0NJ3CrMbwjzdhG2eXq_LquKc7Lfd-u7xjm_DEc3Z9XO1bLrpduUtEruNST7u0geo8mVNFgT3NbJaXTqsFVEAZMHrBbeqKWO8VaruKytrqMSVAYSNLbKsuoylOuUsRrFYrN0n0lsK8ltJ7Emyd1K8tpJbpPkbSX57SSvSfK3knrb_lNEYZ6pl_s0AQ4nbi_uHXn_deJjlnR8x_U6s57X68xj99j3nfjEOSmmcp6JB1MMQPioXkrs5C0vnm8uMoMUrsUTDtCiXqQyNTaNPzKr1T-_AgAA___UsgVe

# More complex combination.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab
WHERE (b @> '[1]'::json OR b @> '[2]'::json) AND (b @> '3'::json OR b @> '"bar"'::json)
ORDER BY a
----
distribution: local
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 6
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 6 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUk19v2jwUxu_fT3F0btrqNSI2_Tdf0ZZUY2qhS5C2qUGVgw9ttmAz27SdKr77lFBWQIKtN5F9Hp_nOT_LeUH_s0SJ8debq7NuD_Y73XSQfr46gDS-ii8GoOAy6V_Dd2_NXVA5fPkYJzHs7-fQzmZR1CLYu-XDPSk_pf3e-QH0E1jTxJt2AGe9znpra2tjhrlyGa4095NOnMD5N1DI0FhNPTUhj_IWOQ4ZTp0dkffWVaWX-kBXP6OMGBZmOgtVechwZB2hfMFQhJJQ4kDlJSWkNLlmhAw1BVWUte2SuV0vCvOIDC9sOZsYL0ExyJFhOlXVrsmj5uvEjZV188bRuHiOjQZlNHAONjyQ8zicM7Sz8DaWD-qeUPIVjm4HZTRn_47SNY_kAunLogzkyDX5Os9Sj5-nDqyBNpfgq_nBB-WCzPAky6Ioqj48yyIhKoi3CgIZ_ZdTIkOoWY-WqAz7syChzbdCiw1o_h7o1LpArinWUdv8_61xrY048Z64hPzUGk9rcduSoo2kBp8PGZK-p8Ub9XbmRnTj7Kg-u9j2a6O6oMmHhcoXm65ZSj44UpM_T2TVie90Etud-KaT2OnU2jXTkOG4tE93hUaJR6cfWuL4pNXggqvGIae8cTo-5A19mvMjpQ_H4rj6p8eluvfVZacP9qm2HfyaVlc1VqUnhtfqB3UokJsUpvChGL0q8_l_vwMAAP__Bxd_nQ==

# Combined with non-JSON predicates.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[1]' AND a % 2 = 0 ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • filter
    │ filter: (a % 2) = 0
    │
    └── • scan
          missing stats
          table: json_tab@json_inv
          spans: 1 span
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lHFv2jAQxf_fp7BOmgpaosROgNbSJLqSakgt7QBpmzpUmfjSZQsxs83aqeK7TwmUQQSoIO2_i-_4vYef7WcwvzLgEH25vTrv9kit0x0MB5-u6mQQXUUXQyLIZf_mmvwwKr-3Ykw-f4z6EamNSfvbzPcDJCd3dHRSJ-e9DqnVBHlLWJ28J36d3PQ7UZ98-EoEOJAriT0xQQP8Dig4wMCBAEYOTLWK0Rili9ZzOdiVT8B9B9J8OrOLZZvaDIGD0hI1SnBAohVpVvLa9B2M5iMHYqUR-L_pnnLV1GtuTI_mDqiZXZJHDhgrHhB4uGal2wHenDtrbuiamy1CQzHOsI9Covb8TXMvO9cuizT_DQ5cqGw2yQ0vt2YwFUXpUd8719qj7qrybjUm6VOUS9jlmlZc-4e4vkwzixq1xzYtL9Y5qbVpkSfnvNsbnpaxLuudfljFDzvEz0Bpi9oLt6W7XS6oyIUbcuz1odEjQ2Or0NjxodFDXK9CC_5baMEhfpahNY4PrbEh5--X66OZqtzgq-60X1FyafFKoHzAxati1EzHeKtVXM4uPm9KULkg0dhFt7X46OYvLWM1isnqyq2T6F4SO4DE9pKC3SRWJQV7Sf4Gia6Twiop3Etq7PZEq6TGXlJzNymokprH_rtGcR6STD3epxI4yPAspE2ZuPJs3HLD1jh2T8fNhisTFiSsJWIfEyh-IB5McSgH39VjiR3-mRZHKhGZQQeuxU_soEU9SfPU2DRedubzN38DAAD__wANYUI=

# The split disjunction rule allows us to use the index for this query.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[1]' OR a = 44 ORDER BY a
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a
│ order key: a
│
└── • union all
    │
    ├── • index join
    │   │ table: json_tab@json_tab_pkey
    │   │
    │   └── • sort
    │       │ order: +a
    │       │
    │       └── • scan
    │             missing stats
    │             table: json_tab@json_inv
    │             spans: 1 span
    │
    └── • scan
          missing stats
          table: json_tab@json_tab_pkey
          spans: [/44 - /44]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8l1Fv4jgUhd_3V1j3pa02KHESEoi0Et3Cahm1pQNIM6MOqpzEtJmGmLHDtFXFfx-FtECcxiW00zc7Nt89vjrHFo8gfsbgQe_rxelx_xwddvuj8ejz6REa9U57J2NE0H_DwRn6IVhylRIfffm_N-yhQx91vi8Mw6Lo4BJPDo7QYIgOCfoH2XY27vaG6N9viIAGCQvpOZlRAd4lYNDABA0smGgw5yygQjCeLT2uNvbDe_AMDaJkvkizzxMNAsYpeI-QRmlMwYMx8WM6pCSkXDdAg5CmJIpX-GeVnefB1fyWPoAGJyxezBLhIaIhHzQYzUk2021bN2Cy1IAt0k1FkZJrCh7ektjvgmcstd1VdiORRkmQ6u2ixE7WggEPKaehhzpYqr4B-A_ohoib0q8ny43CpqSwXalww2V5bZn7dw6uPAY2a51jo9GRNGLz3UWeswab69gqbh8sUqUwVxZmFYTh3V2IVS6Mkl8FA265Dxv6Mec6bqxH-gWn0-i-l4SVsk1Zdh3VI8ZTynXrpca-XM6SytVq0icWJU89au6V1CpVtqSqWUfV2tPuB0bTrVT49mga7xXN4g1n7p4Ac88EmOsEmPsnwKyj-ikB9v4JsOuU20qA80cT4NRRtbZO6wMT0KpU-PYE4PdKAK7zxg-pmLNE0ELxqlKGVKqBsyPR8JrmLRBswQN6wVmw2ptPByvQ6kNIRZqv4nzST56XRMopma1dsE3CMglvk1oFEt4mteuRsFWNyl_83VmmAtWUUaayVSpVLRllqbtuV7fdkFG2EtWsQWoqSU41qdR0R0lyq0m2THL3NZVbj6Q0ValTapbKVJaMau1tqlIA22pTGdVtx6XUvHItKO6F0glxKYJFllnNKkUQlzK4qx9KEXwFpTREuV9qmMoRJctj9eWg0uVm9_w0ZndXUQgeGG0rwGHbb2BnOm3YrksbvtkOGi3XdKhjNG1_9UdmGpNrkT02oxt2t-KOH-bZUzElsaAanJFb2qUp5bMoyZ7B4GllufzrdwAAAP__MDAh8w==

# We cannot use the index for this query.
query T
EXPLAIN (DISTSQL)
SELECT a FROM json_tab WHERE b @> '[1]' OR sqrt(a::decimal) = 2 ORDER BY a
----
distribution: local
vectorized: true
·
• filter
│ filter: (b @> '[1]') OR (sqrt(a::DECIMAL) = 2)
│
└── • scan
      missing stats
      table: json_tab@json_tab_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkVFvmz4Uxd__n8K6L00ko-Ik_0SzNIk2UI0pCR1E2qYORQZuMlaCqW3UVRHffQKWNanUanvjnnN17o_jA-iHAjh4X24XV_6KDFw_WkefFkMSeQtvviaC3ITBkvzQstwYkZDPH7zQI4OEON9q2x4jubhj8cWQBCEZ6AdlBoJz15v7y6vFkLwno9ZxvZBcfyUCKJQyw5XYowZ-BwxiCpWSKWotVSsdugU_-wncppCXVW1aOaaQSoXAD2ByUyBwWIukwBBFhurSBgoZGpEXXeyR1Tl-bKp7fAIKc1nU-1JzIihJgEJUiXayIG4oyNo8X9NG7BA4O8HzXeB2Q_-e8CYvDCpUl-wcr9c5GTij8xI55x-jYHV9UqbDztvkzyNQCGrDicNexR-9wGf_gh-irmSp8Qz-tUv2i0sWa2IKmO2wf1Uta5XirZJpt9uPQRfUCRlq07usH_zyaGmjUOz_tH-axN5MGr2VFFPYFvJxk2fAAf-fzrbjiW1NRcqsySwVVpIktpWOJ-8mUxSzqd3WsC3ETrcVRd_lYxe7fqraH9yKQiOFpbhHFw2qfV7m2uTpb6dp_vsVAAD__7gGElg=

statement ok
INSERT INTO array_tab VALUES
  (1, '{}'),
  (2, '{1}'),
  (3, '{1, 2}'),
  (4, '{1, 3}'),
  (5, '{1, 2, 3, 4}')

statement ok
ALTER TABLE array_tab VALIDATE CONSTRAINT check_c

statement ok
ALTER INDEX arr_inv SPLIT AT VALUES (10), (20)

statement ok
ALTER INDEX arr_inv EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 10), (ARRAY[3], 20)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder
FROM [SHOW EXPERIMENTAL_RANGES FROM INDEX arr_inv WITH DETAILS] ORDER BY lease_holder
----
start_key     end_key       replicas  lease_holder
…/<IndexMin>  …/10          {1}       1
…/10          …/20          {2}       2
…/20          <after:/Max>  {3}       3

query T
EXPLAIN (DISTSQL)
SELECT a FROM array_tab WHERE b @> '{}' ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • inverted filter
    │ inverted column: b_inverted_key
    │ num spans: 1
    │
    └── • scan
          missing stats
          table: array_tab@arr_inv
          spans: 1 span
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lF1v2j4Uxu__n8I6N_1Pc5Q4L7T1FVtJNSRaOmDapoEqJz500YLNbKcvqvjuU6DtStag0YvdWLKfo9_z6NjH92B_lsAh_XIxeNc_J__3-uPJ-OPgDRmng_RkQgQ5HQ3PiDBG3F06kZHPH9JRSjLSnVZBECE5uF8dkOGol47I-69EAAWlJZ6LBVrg34ABhRAoRDCjsDQ6R2u1qaX7dWFf3gIPKBRqWbnNsStcicChUtpINCiBgkQnirLWZ6sZhVwbBP67tFdYV6jc-fFWLXRr-2HlOOkymK0o6Mo9-MwoWCeuEHj0LFi_Bzxe0ZZsLziPtXFo_KTp-7bVLm7YJVt2bLfdRGQljlBINH6w7fl0RV1hzGWhroHCiS6rhbKcCEoyoDBeinrns8DzWeCffxoM1ktrWNYIG-wTtq-u0TiUp0Xp0KDxw-3Ej3p6uzREK9JlnNg6IUEl-RSm0-jwcLMAaY0YNiKGWxHDv-8ne30_w8Dzw9f0k-0T9o9-Rv-in9E-4zBCu9TKYmNkX3YKGk4eq2cb5RVuPgKrK5PjhdH5unazHa5B6wOJ1m1Uttn01aNknUGxeJrm5yS2k9RpJwVNUriTFO1BinaSgi0Se04Km6R4Jylpz8SapOS1maL6FuelvrksJHDAozjMjqOOdyQ66MWdeeIdY555MhGYRXGQRGE9SvNSXNn6KY2_65s1dnK3rB_CXJQWKZyJH9hDh2ZRqPq3zx-U1eq_XwEAAP__-7Mw6Q==

# Combined with non-Array predicates.
query T
EXPLAIN (DISTSQL)
SELECT a FROM array_tab WHERE b @> '{1}' AND a % 2 = 0 ORDER BY a
----
distribution: full
vectorized: true
·
• sort
│ order: +a
│
└── • filter
    │ filter: (a % 2) = 0
    │
    └── • scan
          missing stats
          table: array_tab@arr_inv
          spans: 1 span
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lO9q2zAUxb_vKcSF0YTJRJLzZwgG6ZqUBdq0SwLb2EKRrZvOzLEySVlXSt592Mm6xDSmLuxLkHRvfudYR9IDuJ8pSBh-vr44HY1JYzCazqYfL5pkOrwYns2IIueTq0uirFX3N15F5NOH4WRIGhHpf1szFiI5eeCbkyY5HQ9Io6HIayKa5B1hTXI1GQwn5P0XooBCZjSO1RIdyK_AgYIACiHMKaysidE5Y_PSQ9E40r9BMgpJtlr77bJPfIogwViNFjVQ0OhVkha8Pn8D882cQmwsgvzXPTaBWbW6B93zDQWz9jvynILz6hZBtvesjAYguxu654bvuXlCaKaiFCeoNNoWOzT3uHV9Ze1Nkv0CCmcmXS8zJ4utma5UPmxx1uJB_ivgmEde8sjqeDxPUo8WbUscGtyuS9Lo8zw9KeVoPHtbhLgbH_UjSn5EHT9TYz3aVvupLJ-WC0ty7QM58fyI-AsjEkVEok5EvI7Hx4jC_xZRWMfPLqLOyyPqHMixarkJupXJHD7rvrKSUsDzFwD1LW5fDGfWNsZra-Kidzu9KkDFgkbnt9XedjLK_pact6iWjxdsn8QrSaIGSVSSwuMkUSaFlSR2QOL7pHaZ1K4kdY574mVSp5LUPU4Ky6TuS7-uk5-HRWrubhINEuKo12UqZEHYWeigHXEdqCiMA9HrLTDSPYWLGPI_qFuXH8rpd3NXYGf3q_xILVTqkMKl-oED9GiXSZY4n8S7ymbz6k8AAAD__1tGVYY=

# The split disjunction rule allows us to use the index for this query.
query T
EXPLAIN (DISTSQL)
SELECT a FROM array_tab WHERE b @> '{1}' OR a = 1 ORDER BY a
----
distribution: full
vectorized: true
·
• distinct
│ distinct on: a
│ order key: a
│
└── • union all
    │
    ├── • index join
    │   │ table: array_tab@array_tab_pkey
    │   │
    │   └── • sort
    │       │ order: +a
    │       │
    │       └── • scan
    │             missing stats
    │             table: array_tab@arr_inv
    │             spans: 1 span
    │
    └── • scan
          missing stats
          table: array_tab@array_tab_pkey
          spans: [/1 - /1]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lm9v2joUxt_fT2GdN211g4idP5BIV-LewtWY2tIB0jZtCJnEbaOGmNlhHar47lMCg2CI12Td3qAkNr_z-MlzDjyD_BKDD70Pt1f_9m_Qebc_Go_eXV2gUe-qdzlGFP0_HFwjKgRdTVM6Q-_f9IY9dD5Dnc9L07QYOnvG67MLNBiic4r-QTi77PaG6L-PiIIBCQ_ZDZ0zCf4nwGAAAQMsmBiwEDxgUnKRLT3nG_vhN_BNA6JksUw3j9MojRn4wEXIBAvBgJClNIpzXgf_DZP1xICACwb-fvcNb_BFE5PD7YNl6qMOhsnaAL5MtzUmBsiU3jPwWwVR_S74mKyNgjBcEHai5pjOYjZkNGSiiQ8L7-zrUCGmUfIVDLjk8XKeSD93abSg2WUTm03cyD5JqUiiiqyiccRFykTTOmXj6XKWUs6qUu4tj5KtI47Gkc3VdPHIVgfGGGhWqstWdDlVdHUjmUZJkDbbqhFgwGCTtBNJ2QNmK_RA5cPRt_MwbhU6isJ2qcK6Kd8dA5uVzrHX6KphMg9Ekpcn3qz5fgvZb5qlOrGis7ZMUrMxSd6YpEpjkioat41p129Mu0q5QmO6v7kx3VJdvzbcWwe7y9SYippWFZd2_eX9wTHhvbpf-zGBX2tMHP7omHobh0wueCJZrRfWwNmRWHjPNhZIvhQBuxU8yPdubgc5KH8QMpluVrG1uesnP9ZkKhid7-ZHEYW1KFKBRLQkjSaikiwtyS4nuSrJVkm4SHIOSLhIalcjYVKOwkdOOdrzmRrUkVWuPgkalqOiWlpUu9x1rJLaWpJXTrJUklf7ePZR0H_SNLhcVuuIddQ1L82VVxGlDdaR8Vjfg7pkWdm0uYv50zQKwQfmtdw2sZ0GDdywYdskaHgzjzTswLNdzwxDp5X98bmL6b3MRt7ogT_l3PFqkQ2sOxpLZsA1fWRdljIxj5JsGAfblfX6r-8BAAD__7k7YEs=

# We cannot use the index for this query.
query T
EXPLAIN (DISTSQL)
SELECT a FROM array_tab WHERE (b @> '{2}' AND a = 3) OR b[0] = a ORDER BY a
----
distribution: full
vectorized: true
·
• filter
│ filter: ((b @> ARRAY[2]) AND (a = 3)) OR (a = b[0])
│
└── • scan
      missing stats
      table: array_tab@array_tab_pkey
      spans: FULL SCAN
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyUUlFr20wQfP9-xbEvkeFETlI-mhwE5MYKFTh2Khva4BpzklauiKxT706kxui_F8muaxvsNm_a2b2ZnR1tQP8ogEPw9XnYD0fEGoST6eTzsEcmwTB4mBJBHqPxExFKifXCiJh8-RREAbGsmPjfasY8JFcbt7nqkf5oQCxB7onX65FxRKx4xubknoi2GgQR-fhCBFAoZYojsUINfAYOUPBgTqFSMkGtpWrhTTcUpj-BMwp5WdWmhecUEqkQ-AZMbgoEDiNpy-raBQopGpEX3VhDQdbmzyNtxBKBewcq4QC429ADIeey0FTEBUYoUlTX7EgO9rfx91-L6hXXQOFBFvWq1JwISmKgMKlEW9lwbkfnZEf2nh0f88KgQnXtHC-4xTmxLN_dp9aPov7LzOWch6Pp7XyXn--0Ae7AXY4d5rsztp8FCuPacOI7Z424J0acIyN_STVCXclS4z_Fyk6UbKeZU8B0idtfSctaJfisZNLNbstxR9QBKWqz7XrbIix_t7RRKFb7HA6ZnItM7juY3ItM7DxT5zMr5NsiT4HDnZeJjHnMvo0Z2jfuXWrfpTexnX6IWYxJ9n-WetA-EEvdHnvyXb51tNN11Z4qE4VGCk_iFQdoUK3yMtcmT3adpvnvVwAAAP__--dQaA==
