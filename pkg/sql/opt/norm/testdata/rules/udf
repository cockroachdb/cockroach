exec-ddl
CREATE FUNCTION one() RETURNS INT LANGUAGE SQL AS 'SELECT 1';
----

# Do not attempt to hoist UDFs.
norm format=show-scalars
SELECT one()
----
values
 ├── columns: one:2
 ├── cardinality: [1 - 1]
 ├── volatile
 ├── key: ()
 ├── fd: ()-->(2)
 └── tuple
      └── udf: one
           └── body
                └── values
                     ├── columns: "?column?":1!null
                     ├── cardinality: [1 - 1]
                     ├── key: ()
                     ├── fd: ()-->(1)
                     └── tuple
                          └── const: 1

exec-ddl
CREATE FUNCTION strict_fn(i INT, t TEXT, b BOOl) RETURNS INT STRICT IMMUTABLE LANGUAGE SQL AS 'SELECT i'
----

# Strict UDFs should be folded to NULL in the presence of a constant NULL
# argument.
norm format=show-scalars
SELECT strict_fn(1, 'foo', NULL)
----
values
 ├── columns: strict_fn:5
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(5)
 └── tuple
      └── null

# The CASE expression used to check for NULL arguments in strict UDFs should be
# folded in the presence of all non-NULL arguments.
norm format=show-scalars
SELECT strict_fn(1, 'foo', true)
----
values
 ├── columns: strict_fn:5!null
 ├── cardinality: [1 - 1]
 ├── key: ()
 ├── fd: ()-->(5)
 └── tuple
      └── const: 1

# Regression test for #160475. An IN-subquery built as a complicated expression
# with a group-by and left-join should be simplifiable into a group-by with an
# inner-join.
exec-ddl
CREATE TABLE t160475 (
  a INT,
  b INT,
  c INT,
  INDEX (a, b),
  FAMILY (a, b, c)
)
----

exec-ddl
CREATE OR REPLACE FUNCTION f160475(x INT, y INT[]) RETURNS INT LANGUAGE SQL AS $$
  SELECT c FROM t160475 WHERE a = x AND b IN (SELECT unnest(y))
$$
----

norm format=show-scalars
SELECT f160475(33, ARRAY[44, 55]::INT[])
----
values
 ├── columns: f160475:13
 ├── cardinality: [1 - 1]
 ├── volatile
 ├── key: ()
 ├── fd: ()-->(13)
 └── tuple
      └── udf: f160475
           ├── args
           │    ├── const: 33
           │    └── const: ARRAY[44,55]
           ├── params: x:1 y:2
           └── body
                └── project
                     ├── columns: c:5
                     ├── outer: (1,2)
                     ├── cardinality: [0 - 1]
                     ├── immutable
                     ├── key: ()
                     ├── fd: ()-->(5)
                     └── limit
                          ├── columns: a:3!null c:5 rowid:6!null bool_or:11!null
                          ├── outer: (1,2)
                          ├── cardinality: [0 - 1]
                          ├── immutable
                          ├── key: ()
                          ├── fd: ()-->(3,5,6,11)
                          ├── select
                          │    ├── columns: a:3!null c:5 rowid:6!null bool_or:11!null
                          │    ├── outer: (1,2)
                          │    ├── immutable
                          │    ├── key: (6)
                          │    ├── fd: ()-->(3,11), (6)-->(5)
                          │    ├── group-by (hash)
                          │    │    ├── columns: a:3 c:5 rowid:6!null bool_or:11!null
                          │    │    ├── grouping columns: rowid:6!null
                          │    │    ├── outer: (2)
                          │    │    ├── immutable
                          │    │    ├── key: (6)
                          │    │    ├── fd: (6)-->(3,5,11)
                          │    │    ├── project
                          │    │    │    ├── columns: notnull:10!null a:3 c:5 rowid:6!null
                          │    │    │    ├── outer: (2)
                          │    │    │    ├── immutable
                          │    │    │    ├── fd: (6)-->(3,5)
                          │    │    │    ├── inner-join (cross)
                          │    │    │    │    ├── columns: a:3 b:4!null c:5 rowid:6!null unnest:9
                          │    │    │    │    ├── outer: (2)
                          │    │    │    │    ├── immutable
                          │    │    │    │    ├── fd: (6)-->(3-5)
                          │    │    │    │    ├── select
                          │    │    │    │    │    ├── columns: a:3 b:4!null c:5 rowid:6!null
                          │    │    │    │    │    ├── key: (6)
                          │    │    │    │    │    ├── fd: (6)-->(3-5)
                          │    │    │    │    │    ├── scan t160475
                          │    │    │    │    │    │    ├── columns: a:3 b:4 c:5 rowid:6!null
                          │    │    │    │    │    │    ├── key: (6)
                          │    │    │    │    │    │    └── fd: (6)-->(3-5)
                          │    │    │    │    │    └── filters
                          │    │    │    │    │         └── is-not [outer=(4), constraints=(/4: (/NULL - ]; tight)]
                          │    │    │    │    │              ├── variable: b:4
                          │    │    │    │    │              └── null
                          │    │    │    │    ├── project-set
                          │    │    │    │    │    ├── columns: unnest:9
                          │    │    │    │    │    ├── outer: (2)
                          │    │    │    │    │    ├── immutable
                          │    │    │    │    │    ├── values
                          │    │    │    │    │    │    ├── cardinality: [1 - 1]
                          │    │    │    │    │    │    ├── key: ()
                          │    │    │    │    │    │    └── tuple
                          │    │    │    │    │    └── zip
                          │    │    │    │    │         └── function: unnest [outer=(2), immutable]
                          │    │    │    │    │              └── variable: y:2
                          │    │    │    │    └── filters
                          │    │    │    │         └── is-not [outer=(4,9)]
                          │    │    │    │              ├── eq
                          │    │    │    │              │    ├── variable: b:4
                          │    │    │    │              │    └── variable: unnest:9
                          │    │    │    │              └── false
                          │    │    │    └── projections
                          │    │    │         └── is-not [as=notnull:10, outer=(9)]
                          │    │    │              ├── variable: unnest:9
                          │    │    │              └── null
                          │    │    └── aggregations
                          │    │         ├── bool-or [as=bool_or:11, outer=(10)]
                          │    │         │    └── variable: notnull:10
                          │    │         ├── const-agg [as=a:3, outer=(3)]
                          │    │         │    └── variable: a:3
                          │    │         └── const-agg [as=c:5, outer=(5)]
                          │    │              └── variable: c:5
                          │    └── filters
                          │         ├── eq [outer=(1,3), constraints=(/1: (/NULL - ]; /3: (/NULL - ]), fd=(1)==(3), (3)==(1)]
                          │         │    ├── variable: a:3
                          │         │    └── variable: x:1
                          │         └── variable: bool_or:11 [outer=(11), constraints=(/11: [/true - /true]; tight), fd=()-->(11)]
                          └── const: 1
