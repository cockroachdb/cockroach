statement ok
CREATE TABLE t (x INT PRIMARY KEY, y INT, z INT, INDEX i (z));
INSERT INTO t VALUES (1, 2, 3)

# Get the timestamp for row (1, 2, 3).
query B
SELECT mvcc_timestamp IS NOT NULL FROM t
----
true

let $base_ts
SELECT mvcc_timestamp FROM t

# Insert a new value into t.
statement ok
INSERT INTO t VALUES (2, 3, 4)

# Its timestamp should be bigger than the timestamp of the first row.
query B
SELECT mvcc_timestamp > $base_ts FROM t WHERE x = 2
----
true

# Check that trying to get the timestamp from t@i succeeds too.
query B
SELECT mvcc_timestamp = $base_ts FROM t@i WHERE x = 1
----
true

# Update the original row.
statement ok
UPDATE t SET z = 5 WHERE x = 1

query B
SELECT mvcc_timestamp > $base_ts FROM t
----
true
true

# Ensure that we can use the timestamp column in different places.
query III rowsort
SELECT * FROM t WHERE mvcc_timestamp IS NOT NULL
----
1 2 5
2 3 4

query IIIIII rowsort
SELECT t1.*, t2.* FROM t t1 JOIN t t2 ON t1.mvcc_timestamp = t2.mvcc_timestamp
----
1 2 5 1 2 5
2 3 4 2 3 4

let $update_ts
SELECT mvcc_timestamp FROM t WHERE x = 2

statement ok
UPDATE t SET z = 6 WHERE mvcc_timestamp = $update_ts

query III rowsort
SELECT * FROM t
----
1 2 5
2 3 6

# Ensure that we can't create columns that conflict with system column names.
statement error pq: column name "mvcc_timestamp" conflicts with a system column name
CREATE TABLE bad (mvcc_timestamp int)

statement error pq: column name "mvcc_timestamp" conflicts with a system column name
ALTER TABLE t ADD COLUMN mvcc_timestamp INT

statement error pq: column name "mvcc_timestamp" conflicts with a system column name
ALTER TABLE t RENAME COLUMN x TO mvcc_timestamp
