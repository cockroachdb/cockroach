# fakedist* configs are skipped because SetupAllNodesPlanning requires a
# non-nil txn, which is not available in job-based flows like INSPECT. Using
# them causes a nil pointer panic in the span resolver setup.
#
# LogicTest: !fakedist !fakedist-vec-off !fakedist-disk !local-mixed-25.2 !local-mixed-25.3


statement ok
CREATE VIEW last_inspect_job AS
SELECT status, jsonb_array_length(
    crdb_internal.pb_to_json('cockroach.sql.jobs.jobspb.Payload', payload)->'inspectDetails'->'checks'
  ) AS num_checks
FROM crdb_internal.system_jobs
WHERE job_type = 'INSPECT'
ORDER BY created DESC
LIMIT 1

statement ok
CREATE TABLE foo (c1 INT, c2 INT);
CREATE INDEX idx_c1 ON foo (c1);
CREATE INDEX idx_c2 ON foo (c2);

statement error pq: INSPECT TABLE requires the enable_inspect_command setting to be enabled
INSPECT TABLE foo;

statement error pq: INSPECT DATABASE requires the enable_inspect_command setting to be enabled
INSPECT DATABASE test;

statement ok
SET enable_inspect_command = true;

statement ok
BEGIN;

statement error pq: cannot run within a multi-statement transaction
INSPECT TABLE foo;

statement ok
ROLLBACK;

statement ok
INSPECT TABLE foo;

query TI
SELECT * FROM last_inspect_job;
----
succeeded  2

statement ok
INSPECT TABLE foo WITH OPTIONS INDEX (idx_c1);

query TI
SELECT * FROM last_inspect_job;
----
succeeded  1

statement ok
INSPECT TABLE foo AS OF SYSTEM TIME 1 WITH OPTIONS INDEX (idx_c1,idx_c2);

query TI
SELECT * FROM last_inspect_job;
----
succeeded  2

statement error pq: index "idx_c3" does not exist
INSPECT TABLE foo WITH OPTIONS INDEX (idx_c3);

statement ok
INSPECT TABLE foo WITH OPTIONS INDEX ALL;

query TI
SELECT * FROM last_inspect_job;
----
succeeded  2

statement ok
INSPECT DATABASE test;

query TI
SELECT * FROM last_inspect_job;
----
succeeded  28

# there is no index "idx_c3" in any of the test db's table
statement error pq: index "idx_c3" does not exist
INSPECT DATABASE test WITH OPTIONS INDEX (idx_c1, idx_c3);

statement ok
CREATE TABLE bar (c1 INT, c3 INT);

statement error pq: no indexes found to inspect
INSPECT TABLE bar;

statement error pq: inspect of index "bar_pkey" on table "bar" is unsupported: primary indexes are not supported
INSPECT TABLE bar WITH OPTIONS INDEX (bar@bar_pkey);

statement ok
CREATE INDEX idx_c1 ON bar (c1);
CREATE INDEX idx_c3 ON bar (c3);

statement error pq: index "bar@idx_c1" does not belong to table "foo"
INSPECT TABLE foo WITH OPTIONS INDEX (bar@idx_c1);

statement error index "dbfake.foo.idx_c1" does not belong to database "test"
INSPECT DATABASE test WITH OPTIONS INDEX (dbfake.foo.idx_c1);

statement error pq: index name "idx_c1" is ambiguous \(found in test.public.foo and test.public.bar\)
INSPECT DATABASE test WITH OPTIONS INDEX (idx_c1, idx_c3);

statement ok
INSPECT DATABASE test WITH OPTIONS INDEX (foo@idx_c1, test.public.bar@idx_c1, test.idx_c3);

query TI
SELECT * FROM last_inspect_job;
----
succeeded  3

subtest permissions

statement ok
CREATE USER testuser2;

user testuser2

statement ok
SET enable_inspect_command = true;

statement error pq: user testuser2 does not have INSPECT privilege
INSPECT TABLE foo;

statement error pq: user testuser2 does not have INSPECT privilege
INSPECT DATABASE test;

user root

statement ok
GRANT SYSTEM INSPECT TO testuser2;

user testuser2

statement ok
SET enable_inspect_command = true;

statement ok
INSPECT TABLE foo;

statement ok
INSPECT DATABASE test;

subtest end

subtest inspect_unsupported_indexes

user root

# Test that unsupported indexes (hash-sharded, expression) are skipped.
# Table has both unsupported indexes and a regular index.
statement ok
CREATE TABLE t2 (
    x INT, y INT, z INT,
    j JSONB NULL,
    INDEX hash_idx (x) USING HASH,
    INDEX expr_idx ((y + z)),
    INDEX regular_idx (z),
    VECTOR INDEX vector_idx ((CAST(j->>'v' AS VECTOR(3)))),
    INDEX partial_idx (j) WHERE 1=1,
    INVERTED INDEX inverted_idx (j)
);

statement ok
INSERT INTO t2 (x, y, z) VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3);

# Should succeed, checking only the regular index.
statement ok
INSPECT TABLE t2 AS OF SYSTEM TIME '-1us';

# Verify only one check was created (for the regular index).
query TI
SELECT * FROM last_inspect_job;
----
succeeded  1

statement error pq: inspect of index "hash_idx" on table "t2" is unsupported: sharded indexes are not supported
INSPECT TABLE t2 WITH OPTIONS INDEX (hash_idx);

statement error pq: inspect of index "expr_idx" on table "t2" is unsupported: expression indexes are not supported
INSPECT TABLE t2 WITH OPTIONS INDEX (expr_idx);

statement error pq: inspect of index "vector_idx" on table "t2" is unsupported: expression indexes are not supported
INSPECT TABLE t2 WITH OPTIONS INDEX (vector_idx);

statement error pq: inspect of index "partial_idx" on table "t2" is unsupported: partial indexes are not supported
INSPECT TABLE t2 WITH OPTIONS INDEX (partial_idx);

statement error pq: inspect of index "inverted_idx" on table "t2" is unsupported: inverted indexes are not supported
INSPECT TABLE t2 WITH OPTIONS INDEX (inverted_idx);

statement ok
DROP TABLE t2;

subtest end
