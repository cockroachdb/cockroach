# fakedist* configs are skipped because SetupAllNodesPlanning requires a
# non-nil txn, which is not available in job-based flows like INSPECT. Using
# them causes a nil pointer panic in the span resolver setup.
#
# LogicTest: !fakedist !fakedist-vec-off !fakedist-disk

subtest setup

statement ok
SET enable_scrub_job = true;

statement ok
CREATE TABLE t1 (c1 INT);

statement ok
CREATE INDEX i1 ON t1 (c1);

subtest end

subtest scrub_job_implicit_txn

statement ok
EXPERIMENTAL SCRUB TABLE t1 AS OF SYSTEM TIME '-1us';

query TTB
SELECT description, status, finished IS NOT NULL AS finished FROM [SHOW JOBS] WHERE job_type = 'INSPECT' ORDER BY created DESC LIMIT 1
----
EXPERIMENTAL SCRUB TABLE t1 AS OF SYSTEM TIME '-1us'  succeeded  true

subtest end

subtest scrub_job_multi_stmt_txn

statement ok
BEGIN;

statement error pq: cannot run within a multi-statement transaction
EXPERIMENTAL SCRUB TABLE t1;

statement ok
COMMIT;

subtest end

subtest scrub_database

statement error pq: SCRUB DATABASE not supported with enable_scrub_job
EXPERIMENTAL SCRUB DATABASE defaultdb;

subtest cleanup

statement ok
DROP TABLE t1;

subtest end

# inspect and scrub are converging so for now tests on INSPECT live here
subtest inspect

statement ok
CREATE TABLE foo (c1 INT);

statement error INSPECT TABLE requires the enable_inspect_command setting to be enabled
INSPECT TABLE foo;

statement error INSPECT DATABASE requires the enable_inspect_command setting to be enabled
INSPECT DATABASE test;

statement ok
SET enable_inspect_command = true;

statement ok
INSPECT TABLE foo;

statement ok
INSPECT TABLE foo WITH OPTIONS INDEX (bar.public.biz);

statement ok
INSPECT TABLE foo AS OF SYSTEM TIME 1 WITH OPTIONS INDEX (bar,biz);

# test permissions
statement ok
CREATE USER testuser2;

user testuser2

statement error pq: user testuser2 does not have INSPECT privilege
INSPECT TABLE foo;

statement error pq: user testuser2 does not have INSPECT privilege
INSPECT DATABASE test;

user root

statement ok
GRANT SYSTEM INSPECT TO testuser2;

user testuser2

statement ok
SET enable_inspect_command = true;

statement ok
INSPECT TABLE foo;

statement ok
INSPECT DATABASE test;

subtest end
