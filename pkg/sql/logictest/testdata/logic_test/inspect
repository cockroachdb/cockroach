# fakedist* configs are skipped because SetupAllNodesPlanning requires a
# non-nil txn, which is not available in job-based flows like INSPECT. Using
# them causes a nil pointer panic in the span resolver setup.
#
# LogicTest: !fakedist !fakedist-vec-off !fakedist-disk

subtest setup

statement ok
SET enable_scrub_job = true;

statement ok
CREATE TABLE t1 (c1 INT);

statement ok
CREATE INDEX i1 ON t1 (c1);

subtest end

subtest scrub_job_implicit_txn

statement ok
EXPERIMENTAL SCRUB TABLE t1 AS OF SYSTEM TIME '-1us';

query TTB
SELECT description, status, finished IS NOT NULL AS finished FROM [SHOW JOBS] WHERE job_type = 'INSPECT' ORDER BY created DESC LIMIT 1
----
EXPERIMENTAL SCRUB TABLE t1 AS OF SYSTEM TIME '-1us'  succeeded  true

# Verify the checks that were done.
query TI
SELECT
  json_extract_path_text(
    crdb_internal.pb_to_json('cockroach.sql.jobs.jobspb.Payload', payload),
    'inspectDetails', 'checks', '0', 'type'
  ) AS check_type,
  jsonb_array_length(
    crdb_internal.pb_to_json('cockroach.sql.jobs.jobspb.Payload', payload) -> 'inspectDetails' -> 'checks'
  ) AS num_checks
FROM crdb_internal.system_jobs
WHERE job_type = 'INSPECT'
ORDER BY created DESC
LIMIT 1
----
INSPECT_CHECK_INDEX_CONSISTENCY  1

subtest end

subtest scrub_job_multi_stmt_txn

statement ok
BEGIN;

statement error pq: cannot run within a multi-statement transaction
EXPERIMENTAL SCRUB TABLE t1;

statement ok
COMMIT;

subtest end

subtest scrub_database

statement error pq: SCRUB DATABASE not supported with enable_scrub_job
EXPERIMENTAL SCRUB DATABASE defaultdb;

subtest cleanup

statement ok
DROP TABLE t1;

subtest end

# inspect and scrub are converging so for now tests on INSPECT live here
subtest inspect

onlyif config local-mixed-25.2 local-mixed-25.3
statement error pq: SHOW INSPECT ERRORS requires the cluster to be upgraded to v25.4
SHOW INSPECT ERRORS

statement ok
CREATE TABLE foo (c1 INT);

skipif config local-mixed-25.2 local-mixed-25.3
statement error INSPECT TABLE requires the enable_inspect_command setting to be enabled
INSPECT TABLE foo;

skipif config local-mixed-25.2 local-mixed-25.3
statement error INSPECT DATABASE requires the enable_inspect_command setting to be enabled
INSPECT DATABASE test;

statement ok
SET enable_inspect_command = true;

skipif config local-mixed-25.2 local-mixed-25.3
statement ok
INSPECT TABLE foo;

skipif config local-mixed-25.2 local-mixed-25.3
statement ok
INSPECT TABLE foo WITH OPTIONS INDEX (bar.public.biz);

skipif config local-mixed-25.2 local-mixed-25.3
statement ok
INSPECT TABLE foo AS OF SYSTEM TIME 1 WITH OPTIONS INDEX (bar,biz);

# test permissions
statement ok
CREATE USER testuser2;

user testuser2

skipif config local-mixed-25.2 local-mixed-25.3
statement error pq: user testuser2 does not have INSPECT privilege
INSPECT TABLE foo;

skipif config local-mixed-25.2 local-mixed-25.3
statement error pq: user testuser2 does not have INSPECT privilege
INSPECT DATABASE test;

user root

statement ok
GRANT SYSTEM INSPECT TO testuser2;

user testuser2

statement ok
SET enable_inspect_command = true;

skipif config local-mixed-25.2 local-mixed-25.3
statement ok
INSPECT TABLE foo;

skipif config local-mixed-25.2 local-mixed-25.3
statement ok
INSPECT DATABASE test;

subtest end
