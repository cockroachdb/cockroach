# LogicTest: local

# Some sanity checks for node_txn_stats virtual table.

statement ok
SET application_name = test; SELECT 1

query B
SELECT count(*) > 0
  FROM crdb_internal.node_txn_stats
 WHERE application_name = 'test'
----
true

# We shouldn't have any aborted transactions.
query B
SELECT txn_count - committed_count = 0
  FROM crdb_internal.node_txn_stats
 WHERE application_name = 'test'
----
true

# We haven't executed any explicit transactions yet.
query B
SELECT txn_count = implicit_count
  FROM crdb_internal.node_txn_stats
 WHERE application_name = 'test'
----
true

statement ok
BEGIN TRANSACTION; SELECT 1; COMMIT TRANSACTION

# Now we should have exactly one explicit transaction.
query B
SELECT txn_count - implicit_count = 1
  FROM crdb_internal.node_txn_stats
 WHERE application_name = 'test'
----
true

# All transactions so far should be extremely fast, so we check that the
# average total transaction time is in [0s, 0.1s] range.
query B
SELECT count(*) = 0
  FROM crdb_internal.node_txn_stats
 WHERE application_name = 'test'
   AND (
        avg_total_time_sec < 0
        OR avg_total_time_sec > 0.1
       )
----
true
