# LogicTest: cockroach-go-testserver-upgrade-to-master

# Verify that all nodes are running 22.2 binaries.

query T nodeidx=0
SELECT crdb_internal.node_executable_version()
----
22.2

query T nodeidx=1
SELECT crdb_internal.node_executable_version()
----
22.2

query T nodeidx=2
SELECT crdb_internal.node_executable_version()
----
22.2

# Create another database.
statement ok
CREATE DATABASE a

# Create a table for database.
statement ok
CREATE TABLE a.b (id INT PRIMARY KEY)

# Insert data into the table
statement ok
INSERT INTO a.b SELECT generate_series(1, 10)

# Create a second table for database.
statement ok
CREATE TABLE a.c (id INT PRIMARY KEY)

# Insert data into the table
statement ok
INSERT INTO a.c SELECT generate_series(1, 10)

# Create third database.
statement ok
CREATE DATABASE b

# Create a table for database.
statement ok
CREATE TABLE b.a (id INT PRIMARY KEY)

# Insert data into the table
statement ok
INSERT INTO b.a SELECT generate_series(1, 10)

# Create a second table for database.
statement ok
CREATE TABLE b.b (id INT PRIMARY KEY)

# Insert data into the table
statement ok
INSERT INTO b.b SELECT generate_series(1, 10)

# Test that there are no problems getting tenant_span_stats on a mixed 22.2/23.1 cluster.
upgrade 1

query B nodeidx=1
SELECT crdb_internal.node_executable_version() SIMILAR TO '1000023.1-%'
----
true

# Get tenant span stats from 23.1 gateway node.
user root nodeidx=1

# Assert that we are collecting non-zero span stats for the tenant, no errors. Omit system database.
query IBBBB colnames
SELECT database_id, range_count > 0 as range_count, live_bytes > 0 as live_bytes, total_bytes > 0 as total_bytes, live_percentage > 0 as live_percentage FROM crdb_internal.tenant_span_stats() WHERE database_id != 1;
----
database_id range_count live_bytes total_bytes live_percentage
106         true        true       true        true
106         true        true       true        true
110         true        true       true        true
110         true        true       true        true
