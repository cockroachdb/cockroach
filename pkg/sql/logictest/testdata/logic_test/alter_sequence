# see also file `sequences`

statement ok
GRANT admin TO testuser

user testuser

statement ok
CREATE SEQUENCE foo

query I
SELECT nextval('foo')
----
1

query I
SELECT nextval('foo')
----
2

statement ok
ALTER SEQUENCE foo INCREMENT BY 5

query I
SELECT nextval('foo')
----
7

statement ok
ALTER SEQUENCE foo CACHE 100

query I
SELECT nextval('foo');
----
12

user root

query I
SELECT nextval('foo');
----
512

user testuser

query I
SELECT nextval('foo');
----
17

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE foo]
----
CREATE SEQUENCE public.foo MINVALUE 1 MAXVALUE 9223372036854775807 INCREMENT 5 START 1 CACHE 100

statement ok
ALTER SEQUENCE foo CACHE 1

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE foo]
----
CREATE SEQUENCE public.foo MINVALUE 1 MAXVALUE 9223372036854775807 INCREMENT 5 START 1

user root

# Alter between sequences, check it is ok.
statement ok
CREATE SEQUENCE seq_as AS int2

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_as]
----
CREATE SEQUENCE public.seq_as AS INT2 MINVALUE 1 MAXVALUE 32767 INCREMENT 1 START 1

statement ok
ALTER SEQUENCE seq_as AS int4

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_as]
----
CREATE SEQUENCE public.seq_as AS INT4 MINVALUE 1 MAXVALUE 2147483647 INCREMENT 1 START 1

statement ok
ALTER SEQUENCE seq_as AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_as]
----
CREATE SEQUENCE public.seq_as AS INT8 MINVALUE 1 MAXVALUE 9223372036854775807 INCREMENT 1 START 1

statement ok
ALTER SEQUENCE seq_as AS int4

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_as]
----
CREATE SEQUENCE public.seq_as AS INT4 MINVALUE 1 MAXVALUE 2147483647 INCREMENT 1 START 1

statement ok
ALTER SEQUENCE seq_as AS int2

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_as]
----
CREATE SEQUENCE public.seq_as AS INT2 MINVALUE 1 MAXVALUE 32767 INCREMENT 1 START 1

# Test ALTER SEQUENCE AS when downgrading sizes behaves appropriately if MINVALUE/MAXVALUE/START is set.

statement ok
CREATE SEQUENCE seq_int4_max_high AS int4 MAXVALUE 99999

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_max_high]
----
CREATE SEQUENCE public.seq_int4_max_high AS INT4 MINVALUE 1 MAXVALUE 99999 INCREMENT 1 START 1

statement error MAXVALUE \(99999\) must be less than \(32767\) for type INT2
ALTER SEQUENCE seq_int4_max_high AS int2

statement ok
ALTER SEQUENCE seq_int4_max_high AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_max_high]
----
CREATE SEQUENCE public.seq_int4_max_high AS INT8 MINVALUE 1 MAXVALUE 99999 INCREMENT 1 START 1

statement ok
CREATE SEQUENCE seq_int4_min_high AS int4 MINVALUE 99999

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_high]
----
CREATE SEQUENCE public.seq_int4_min_high AS INT4 MINVALUE 99999 MAXVALUE 2147483647 INCREMENT 1 START 99999

statement error MINVALUE \(99999\) must be less than \(32767\) for type INT2
ALTER SEQUENCE seq_int4_min_high AS int2

statement ok
ALTER SEQUENCE seq_int4_min_high AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_high]
----
CREATE SEQUENCE public.seq_int4_min_high AS INT8 MINVALUE 99999 MAXVALUE 9223372036854775807 INCREMENT 1 START 99999

statement ok
CREATE SEQUENCE seq_int4_start_high AS int4 START 99999

statement error START value \(99999\) cannot be greater than MAXVALUE \(32767\)
ALTER SEQUENCE seq_int4_start_high AS int2

statement ok
ALTER SEQUENCE seq_int4_start_high AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_start_high]
----
CREATE SEQUENCE public.seq_int4_start_high AS INT8 MINVALUE 1 MAXVALUE 9223372036854775807 INCREMENT 1 START 99999

statement ok
CREATE SEQUENCE seq_int4_min_low AS int4 MINVALUE -99999

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_low]
----
CREATE SEQUENCE public.seq_int4_min_low AS INT4 MINVALUE -99999 MAXVALUE 2147483647 INCREMENT 1 START -99999

statement error MINVALUE \(-99999\) must be greater than \(-32768\) for type INT2
ALTER SEQUENCE seq_int4_min_low AS int2

statement ok
ALTER SEQUENCE seq_int4_min_low AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_low]
----
CREATE SEQUENCE public.seq_int4_min_low AS INT8 MINVALUE -99999 MAXVALUE 9223372036854775807 INCREMENT 1 START -99999

statement ok
CREATE SEQUENCE seq_int4_max_high_desc AS int4 MAXVALUE 99999 INCREMENT -1

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_max_high_desc]
----
CREATE SEQUENCE public.seq_int4_max_high_desc AS INT4 MINVALUE -2147483648 MAXVALUE 99999 INCREMENT -1 START 99999

statement error MAXVALUE \(99999\) must be less than \(32767\) for type INT2
ALTER SEQUENCE seq_int4_max_high_desc AS int2

statement ok
ALTER SEQUENCE seq_int4_max_high_desc AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_max_high_desc]
----
CREATE SEQUENCE public.seq_int4_max_high_desc AS INT8 MINVALUE -9223372036854775808 MAXVALUE 99999 INCREMENT -1 START 99999

statement ok
CREATE SEQUENCE seq_int4_min_high_desc AS int4 MINVALUE -99999 INCREMENT -1

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_high_desc]
----
CREATE SEQUENCE public.seq_int4_min_high_desc AS INT4 MINVALUE -99999 MAXVALUE -1 INCREMENT -1 START -1

statement error MINVALUE \(-99999\) must be greater than \(-32768\) for type INT2
ALTER SEQUENCE seq_int4_min_high_desc AS int2

statement ok
ALTER SEQUENCE seq_int4_min_high_desc AS int8

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE seq_int4_min_high_desc]
----
CREATE SEQUENCE public.seq_int4_min_high_desc AS INT8 MINVALUE -99999 MAXVALUE -1 INCREMENT -1 START -1

statement ok
CREATE SEQUENCE reverse_direction_seqas AS integer;
ALTER SEQUENCE reverse_direction_seqas AS smallint INCREMENT -1

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE reverse_direction_seqas]
----
CREATE SEQUENCE public.reverse_direction_seqas AS INT2 MINVALUE -32768 MAXVALUE -1 INCREMENT -1 START -1

statement ok
ALTER SEQUENCE reverse_direction_seqas AS int INCREMENT 1

query T
SELECT create_statement FROM [SHOW CREATE SEQUENCE reverse_direction_seqas]
----
CREATE SEQUENCE public.reverse_direction_seqas AS INT8 MINVALUE 1 MAXVALUE 9223372036854775807 INCREMENT 1 START 1


################################## the case where the sequence is altered before it has ever been used
#### case 1 : Modify successfully, without START
statement ok
CREATE SEQUENCE seq_testx_1 INCREMENT BY 3 MINVALUE 1 MAXVALUE 12

query I
select last_value from seq_testx_1
----
-2

statement error pq:  START option unsupported in ALTER SEQUENCE
ALTER SEQUENCE seq_testx_4 INCREMENT BY 8 MINVALUE 1 MAXVALUE 30 start 10

statement error pq:  START option unsupported in ALTER SEQUENCE
ALTER SEQUENCE seq_testx_4 INCREMENT BY 8 MINVALUE 1 MAXVALUE 30 start with 10

statement ok
ALTER SEQUENCE seq_testx_1 INCREMENT BY 8 MINVALUE 1 MAXVALUE 12

query I
select last_value from seq_testx_1
----
-7

query I
SELECT nextval('seq_testx_1')
----
1

query  I
select last_value from seq_testx_1
----
1

query  I
SELECT nextval('seq_testx_1')
----
9

query error pq: nextval\(\): reached maximum value of sequence "seq_testx_1" \(12\)
SELECT nextval('seq_testx_1')

#### case 2 : Fail to modify, and set START when create sequence
statement ok
CREATE SEQUENCE seq_testx_2 INCREMENT BY 3 MINVALUE 1 MAXVALUE 12 START 2

query  I
select last_value from seq_testx_2
----
-1

statement error pq: MINVALUE cannot be made to be exceed than the current value
ALTER SEQUENCE seq_testx_2 INCREMENT BY 1 MINVALUE 4 MAXVALUE 12

query  I
select last_value from seq_testx_2
----
-1

query  I
SELECT nextval('seq_testx_2')
----
2

#### case 3 : Modify successfully, and set START when create sequence
statement ok
CREATE SEQUENCE seq_testx_3 INCREMENT BY 3 MINVALUE 1 MAXVALUE 12 start 5

query I
select last_value from seq_testx_3
----
2

statement ok
ALTER SEQUENCE seq_testx_3 INCREMENT BY 8 MINVALUE 1 MAXVALUE 12

query I
select last_value from seq_testx_3
----
-3

query I
select nextval('seq_testx_3')
----
5

query error pq: nextval\(\): reached maximum value of sequence "seq_testx_3" \(12\)
select nextval('seq_testx_3')

#### case 4 : Modify successfully, and the START set when create sequence not in [newMinValue, newMaxValue]
statement ok
CREATE SEQUENCE seq_testx_4 INCREMENT BY 3 MINVALUE 1 MAXVALUE 12 start 5

statement error pq: START value \(5\) cannot be greater than MAXVALUE \(4\)
ALTER SEQUENCE seq_testx_4 INCREMENT BY 1 MINVALUE 1 MAXVALUE 4

################################## the case where the sequence is altered after it has ever been used
statement ok
CREATE SEQUENCE customer_seq_alter_1 MINVALUE -2 MAXVALUE 2 START WITH 1 CACHE 5 INCREMENT BY -2

statement error pq: MINVALUE cannot be made to be exceed than the current value
ALTER SEQUENCE customer_seq INCREMENT  BY -1   MINVALUE 6 MAXVALUE 10

query error pq: nextval\(\): reached maximum value of sequence "customer_seq" \(5\)
SELECT customer_seq.nextval from dual

query I
select test.public.customer_seq.currval
----
5

statement ok
ALTER SEQUENCE customer_seq INCREMENT  BY 1   MINVALUE 5 MAXVALUE 10

query I
select test.public.customer_seq.currval
----
5

query I
select test.public.customer_seq.nextval
----
6

## sequenceVal in [Minimum, Maximum], increment = -1, Minimum < oldMinimum, Maximum > oldMaximum
statement ok
ALTER SEQUENCE customer_seq INCREMENT  BY -1   MINVALUE -5 MAXVALUE 15

query I
select test.public.customer_seq.currval
----
6

query I
select test.public.customer_seq.nextval
----
5

## sequenceVal not in [Minimum, Maximum], increment > 0, minimum = oldMinimum, maximum < oldMaximum
statement error pq: MAXVALUE cannot be made to be less than the current value
ALTER SEQUENCE customer_seq INCREMENT  BY 1   MINVALUE -5 MAXVALUE 0

query I
select test.public.customer_seq.currval
----
5

query I
select test.public.customer_seq.nextval
----
4

## check if the latest sequence is from cache
query I
select setval('customer_seq', 10)
----
10

## sequenceVal not in [Minimum, Maximum], increment < 0 and minimum > oldMinimum
statement error pq: MAXVALUE cannot be made to be less than the current value
ALTER SEQUENCE customer_seq INCREMENT  BY 1  MINVALUE 0 MAXVALUE 5

query I
select test.public.customer_seq.nextval
----
9

query I
select test.public.customer_seq.nextval
----
8

## sequenceVal in [Minimum, Maximum], increment > 0 and maximum > oldMaximum
statement ok
ALTER SEQUENCE customer_seq INCREMENT  BY 3  MINVALUE 0 MAXVALUE 10

query I
select test.public.customer_seq.currval
----
8

query error pq: nextval\(\): reached maximum value of sequence "customer_seq" \(10\)
select test.public.customer_seq.nextval

query I
select test.public.customer_seq.currval
----
8

statement error pq: MINVALUE cannot be made to be exceed than the current value
ALTER SEQUENCE customer_seq INCREMENT  BY 1  MINVALUE 10 MAXVALUE 15

statement ok
ALTER SEQUENCE customer_seq INCREMENT  BY 1  MINVALUE 0 MAXVALUE 9

query I
select test.public.customer_seq.nextval
----
9

query error pq: nextval\(\): reached maximum value of sequence "customer_seq" \(9\)
select test.public.customer_seq.nextval
