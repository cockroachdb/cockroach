# LogicTest: local

# Some sanity checks for node_txn_info virtual table.

statement ok
SET CLUSTER SETTING sql.metrics.transaction_details.enabled = true

statement ok
SET application_name = test; SELECT 1

query B
SELECT count(*) > 0
  FROM crdb_internal.node_txn_info
 WHERE application_name = 'test'
----
true

# We shouldn't have any aborted transactions.
query B
SELECT count(*) = 0
  FROM crdb_internal.node_txn_info
 WHERE application_name = 'test' AND committed = false
----
true

# We haven't executed any explicit transactions yet.
query B
SELECT count(*) = 0
  FROM crdb_internal.node_txn_info
 WHERE application_name = 'test' AND implicit = false
----
true

statement ok
BEGIN TRANSACTION; SELECT 1; COMMIT TRANSACTION

# Now we should have exactly one explicit transaction.
query B
SELECT count(*) = 1
  FROM crdb_internal.node_txn_info
 WHERE application_name = 'test' AND implicit = false
----
true

# All transactions so far should be extremely fast, so we check that the total
# time is in [0s, 0.1s] range.
query B
SELECT count(*) = 0
  FROM crdb_internal.node_txn_info
 WHERE application_name = 'test'
   AND (
        total_time_in_seconds < 0
        OR total_time_in_seconds > 0.1
       )
----
true
