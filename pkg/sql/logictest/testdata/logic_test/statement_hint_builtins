# LogicTest: !local-mixed-25.3 !local-prepared
# cluster-opt: disable-mvcc-range-tombstones-for-point-deletes

statement ok
CREATE TABLE xy (x INT PRIMARY KEY, y INT, INDEX (y));

statement ok
CREATE TABLE ab (a INT PRIMARY KEY, b INT, INDEX (b));

query I
SELECT count(*) FROM system.statement_hints;
----
0

let $hint1
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@primary WHERE y = 10'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint1;
----
SELECT * FROM xy WHERE y = 10

let $hint2
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@xy_y_idx WHERE y = 10'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint2;
----
SELECT * FROM xy WHERE y = 10

let $hint3
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b',
  'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint3;
----
SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b

query I
SELECT count(*) FROM system.statement_hints;
----
3

query I
SELECT count(*) FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM xy WHERE y = 10';
----
2

query I
SELECT count(*) FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b';
----
1

statement ok
DELETE FROM system.statement_hints WHERE true;

query I
SELECT count(*) FROM system.statement_hints;
----
0

# If the surrounding transaction is rolled back, no hint should be inserted.
statement ok
BEGIN;

let $hint4
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@{NO_FULL_SCAN} WHERE y = 10'
);

query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint4;
----
SELECT * FROM xy WHERE y = 10

statement ok
ROLLBACK;

query I
SELECT count(*) FROM system.statement_hints;
----
0

# Test that hints are loaded for matching statements.

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE x > y',
  'SELECT * FROM xy WHERE x > y'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
1

statement ok
EXPLAIN SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
2

statement ok
EXPLAIN ANALYZE SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
3

statement ok
PREPARE p AS SELECT * FROM xy WHERE x > y

statement ok
EXECUTE p

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
5

statement ok
SELECT crdb_internal.clear_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
6

statement ok
DELETE FROM system.statement_hints WHERE true

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

statement ok
EXECUTE p

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
6

statement ok
DEALLOCATE ALL

# Testcases for hint injection.

statement ok
CREATE TABLE abc (a INT PRIMARY KEY, b INT, c INT, INDEX (b))

# Temporary, until next commit.
statement ok
SET CLUSTER SETTING sql.query_cache.enabled = off

# Try some simple hint injections. First, an index hint.

query T
EXPLAIN SELECT a FROM abc WHERE a = 10
----
distribution: local
vectorized: true
·
• scan
  missing stats
  table: abc@abc_pkey
  spans: [/10 - /10]

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT a FROM abc WHERE a = _',
  'SELECT a FROM abc@abc_b_idx WHERE a = _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
SELECT a FROM abc WHERE a = 5

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
trying planning with injected hints

query T
EXPLAIN SELECT a FROM abc WHERE a = 10
----
distribution: local
vectorized: true
statement hints count: 1
·
• filter
│ filter: a = 10
│
└── • scan
      missing stats
      table: abc@abc_b_idx
      spans: FULL SCAN

# Try injecting a join hint.

query T
EXPLAIN SELECT a, x FROM abc JOIN xy ON y = b WHERE a = 10
----
distribution: local
vectorized: true
·
• lookup join
│ table: xy@xy_y_idx
│ equality: (b) = (y)
│
└── • scan
      missing stats
      table: abc@abc_pkey
      spans: [/10 - /10]

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT a, x FROM abc JOIN xy ON y = b WHERE a = _',
  'SELECT a, x FROM abc INNER HASH JOIN xy ON y = b WHERE a = _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
SELECT a, x FROM abc JOIN xy ON y = b WHERE a = 5

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
trying planning with injected hints

query T
EXPLAIN SELECT a, x FROM abc JOIN xy ON y = b WHERE a = 10
----
distribution: local
vectorized: true
statement hints count: 1
·
• hash join
│ equality: (b) = (y)
│ left cols are key
│
├── • scan
│     missing stats
│     table: abc@abc_pkey
│     spans: [/10 - /10]
│
└── • scan
      missing stats
      table: xy@xy_pkey
      spans: FULL SCAN

# Try removing a hint.

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT a FROM abc@abc_pkey WHERE b = _',
  'SELECT a FROM abc WHERE b = _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
SELECT a FROM abc@abc_pkey WHERE b = 5

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
trying planning with injected hints

query T
EXPLAIN SELECT a FROM abc@abc_pkey WHERE b = 10
----
distribution: local
vectorized: true
statement hints count: 1
·
• scan
  missing stats
  table: abc@abc_b_idx
  spans: [/10 - /10]

# Check that we do not use an invalid injected index hint.

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT a + _ FROM abc WHERE a = _',
  'SELECT a + _ FROM abc@foo WHERE a = _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
SELECT a + 1 FROM abc WHERE a = 5

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
trying planning with injected hints
planning with injected hints failed with: index "foo" not found
falling back to planning without injected hints

query T
EXPLAIN SELECT a + 1 FROM abc WHERE a = 10
----
distribution: local
vectorized: true
statement hints count: 1
·
• render
│
└── • scan
      missing stats
      table: abc@abc_pkey
      spans: [/10 - /10]

# Check that we do not use an unsatisfiable injected hint.

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT c FROM xy JOIN abc ON c = y WHERE x = _',
  'SELECT c FROM xy INNER LOOKUP JOIN abc ON c = y WHERE x = _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
SELECT c FROM xy JOIN abc ON c = y WHERE x = 5

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
trying planning with injected hints
planning with injected hints failed with: could not produce a query plan conforming to the LOOKUP JOIN hint
falling back to planning without injected hints

query T
EXPLAIN SELECT c FROM xy JOIN abc ON c = y WHERE x = 10
----
distribution: local
vectorized: true
statement hints count: 1
·
• hash join
│ equality: (c) = (y)
│ right cols are key
│
├── • scan
│     missing stats
│     table: abc@abc_pkey
│     spans: FULL SCAN
│
└── • scan
      missing stats
      table: xy@xy_pkey
      spans: [/10 - /10]

# Try a prepared statement with an injected hint.

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT c FROM abc WHERE b > _',
  'SELECT c FROM abc@{NO_INDEX_JOIN} WHERE b > _'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SET tracing = on

statement ok
PREPARE p AS SELECT c FROM abc WHERE b > $1

statement ok
EXECUTE p (5)

statement ok
SET tracing = off

query T
SELECT regexp_replace(split_part(message, ': SELECT', 1), E'\\d+', 'x')
FROM [SHOW TRACE FOR SESSION]
WHERE message LIKE '%injected hints%'
----
injected hints from external statement hint x
injected hints from external statement hint x
trying preparing with injected hints
trying planning with injected hints

# Temporary, until next commit.
statement ok
RESET CLUSTER SETTING sql.query_cache.enabled
