# LogicTest: !local-prepared
# cluster-opt: disable-mvcc-range-tombstones-for-point-deletes
# knob-opt: sync-event-log

# TODO(michae2): move explain tests into execbuilder

# Speed up the rangefeed.
user host-cluster-root

statement ok
SET CLUSTER SETTING kv.closed_timestamp.target_duration = '50ms';

statement ok
SET CLUSTER SETTING kv.closed_timestamp.side_transport_interval = '50ms';

statement ok
SET CLUSTER SETTING kv.rangefeed.closed_timestamp_refresh_interval = '50ms';

user root

statement ok
CREATE TABLE xy (x INT PRIMARY KEY, y INT, INDEX (y));

statement ok
CREATE TABLE ab (a INT PRIMARY KEY, b INT, INDEX (b));

statement ok
INSERT INTO xy VALUES (10, 10)

statement ok
INSERT INTO ab VALUES (10, 10)

query I
SELECT count(*) FROM system.statement_hints;
----
0

let $hint1
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@primary WHERE y = 10'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint1;
----
SELECT * FROM xy WHERE y = _

# Verify that hint_type and enabled columns are set correctly.
skipif config local-mixed-25.4
query TB
SELECT hint_type, enabled FROM system.statement_hints WHERE row_id = $hint1;
----
REWRITE INLINE HINTS  true

let $hint2
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@xy_y_idx WHERE y = 10'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint2;
----
SELECT * FROM xy WHERE y = _

let $hint3
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b',
  'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b'
);

# Verify that the returned hint ID is in the table.
query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint3;
----
SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b

query I
SELECT count(*) FROM system.statement_hints;
----
3

query I
SELECT count(*) FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM xy WHERE y = _';
----
2

query I
SELECT count(*) FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b';
----
1

# Verify that rewrite_inline_hints events were logged.

query I
SELECT count(*) FROM system.eventlog WHERE "eventType" = 'rewrite_inline_hints';
----
3

query ITT
SELECT "reportingID",
       info::JSONB->>'StatementFingerprint',
       info::JSONB->>'DonorSQL'
FROM system.eventlog
WHERE "eventType" = 'rewrite_inline_hints'
ORDER BY "timestamp"
----
1  SELECT * FROM xy WHERE y = _                   SELECT * FROM xy@primary WHERE y = _
1  SELECT * FROM xy WHERE y = _                   SELECT * FROM xy@xy_y_idx WHERE y = _
1  SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b  SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b

# Verify that the HintID in the event matches the returned hint ID.
query B
SELECT (info::JSONB->>'HintID')::INT = $hint1
FROM system.eventlog
WHERE "eventType" = 'rewrite_inline_hints'
  AND info::JSONB->>'StatementFingerprint' = 'SELECT * FROM xy WHERE y = _'
ORDER BY "timestamp"
LIMIT 1
----
true

# Verify the full event structure (excluding non-deterministic fields).
query IT
SELECT "reportingID", info::JSONB - 'Timestamp' - 'TxnReadTimestamp' - 'HintID'
FROM system.eventlog
WHERE "eventType" = 'rewrite_inline_hints'
  AND info::JSONB->>'StatementFingerprint' = 'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b'
----
1  {"DonorSQL": "SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b", "EventType": "rewrite_inline_hints", "Statement": "SELECT information_schema.crdb_rewrite_inline_hints('SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b', 'SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b')", "StatementFingerprint": "SELECT * FROM xy INNER JOIN ab ON xy.x = ab.b", "Tag": "SELECT", "User": "root"}

statement count 3
DELETE FROM system.statement_hints WHERE true;

query I
SELECT count(*) FROM system.statement_hints;
----
0

# If the surrounding transaction is rolled back, no hint should be inserted.
statement ok
BEGIN;

let $hint4
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT * FROM xy WHERE y = 10',
  'SELECT * FROM xy@{NO_FULL_SCAN} WHERE y = 10'
);

query T
SELECT fingerprint FROM system.statement_hints WHERE row_id = $hint4;
----
SELECT * FROM xy WHERE y = _

# Verify the event was logged within the transaction.
query I
SELECT count(*) FROM system.eventlog
WHERE "eventType" = 'rewrite_inline_hints'
  AND (info::JSONB->>'HintID')::INT = $hint4;
----
1

statement ok
ROLLBACK;

query I
SELECT count(*) FROM system.statement_hints;
----
0

# Verify the event log entry was also rolled back.
query I
SELECT count(*) FROM system.eventlog
WHERE "eventType" = 'rewrite_inline_hints'
  AND (info::JSONB->>'HintID')::INT = $hint4;
----
0

# Test that hints are loaded for matching statements.

statement ok
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT * FROM xy WHERE x > y',
  'SELECT * FROM xy WHERE x > y'
)

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
1

statement ok
EXPLAIN SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
2

statement ok
EXPLAIN ANALYZE SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
3

statement ok
PREPARE p AS SELECT * FROM xy WHERE x > y

statement ok
EXECUTE p

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
5

statement ok
SELECT crdb_internal.clear_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
6

statement count 1
DELETE FROM system.statement_hints WHERE true

statement ok
SELECT crdb_internal.await_statement_hints_cache()

statement ok
SELECT * FROM xy WHERE x > y

statement ok
EXECUTE p

query I
SELECT usage_count
FROM crdb_internal.feature_usage
WHERE feature_name = 'sql.session.statement-hints'
----
6

statement ok
DEALLOCATE ALL

# Testcases for inline hint rewriting.

statement ok
CREATE TABLE abc (a INT PRIMARY KEY, b INT, c INT, INDEX (b))

# Test basic validation when calling information_schema.crdb_rewrite_inline_hints.

statement error could not parse statement fingerprint: at or near "foo": syntax error
SELECT information_schema.crdb_rewrite_inline_hints(
  'foo',
  'SELECT a FROM ab'
)

statement error could not parse hint donor statement: at or near "foo": syntax error
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT a FROM ab',
  'foo'
)

statement error statement does not match hint donor statement: SELECT a FROM ab vs SELECT b FROM ab
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT a FROM ab',
  'SELECT b FROM ab'
)

statement ok
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT a FROM ab WHERE b = 5',
  'SELECT a FROM ab WHERE b = $1'
)

statement ok
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT a FROM ab WHERE b = 5',
  'SELECT a FROM ab WHERE b = _'
)

statement ok
SELECT information_schema.crdb_rewrite_inline_hints(
  'SELECT b FROM ab WHERE a = $1',
  'SELECT b FROM ab WHERE a = _'
)
