# LogicTest: default distsql

query ITTTTT
EXPLAIN (METADATA,NOOPTIMIZE) SELECT 1 FROM (SELECT 2 AS s)
----
0  render   (empty)  (empty)  ("1")  ="1"
1  render   (empty)  (empty)  (s)    =s
2  nullrow  (empty)  (empty)  ()     (empty)

# Propagation to data sources.
query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 2 AS s)
----
0  render   (empty)  (empty)  ("1")         ="1"
1  render   (empty)  (empty)  (s[omitted])  (empty)
2  nullrow  (empty)  (empty)  ()            (empty)

# Propagation through CREATE TABLE.
query ITTTTT
EXPLAIN (METADATA) CREATE TABLE t AS SELECT 1 FROM (SELECT 2 AS s)
----
0  create table  (empty)  (empty)  ()            (empty)
1  render        (empty)  (empty)  ("1")         ="1"
2  render        (empty)  (empty)  (s[omitted])  (empty)
3  nullrow       (empty)  (empty)  ()            (empty)

# Propagation through LIMIT.
query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 2 AS s) LIMIT 1
----
0  limit    (empty)  (empty)  ("1")         ="1"
1  render   (empty)  (empty)  ("1")         ="1"
2  render   (empty)  (empty)  (s[omitted])  (empty)
3  nullrow  (empty)  (empty)  ()            (empty)

query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 2 AS s LIMIT 1)
----
0  render   (empty)  (empty)  ("1")         ="1"
1  limit    (empty)  (empty)  (s[omitted])  (empty)
2  render   (empty)  (empty)  (s[omitted])  (empty)
3  nullrow  (empty)  (empty)  ()            (empty)

# Propagation through UNION.
query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 1 AS s UNION SELECT 2 AS s)
----
0  render   (empty)  (empty)  ("1")  ="1"
1  union    (empty)  (empty)  (s)    (empty)
2  render   (empty)  (empty)  (s)    =s
3  nullrow  (empty)  (empty)  ()     (empty)
2  render   (empty)  (empty)  (s)    =s
3  nullrow  (empty)  (empty)  ()     (empty)

query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 1 AS s UNION ALL SELECT 2 AS s)
----
0  render   (empty)  (empty)  ("1")         ="1"
1  append   (empty)  (empty)  (s[omitted])  (empty)
2  render   (empty)  (empty)  (s[omitted])  (empty)
3  nullrow  (empty)  (empty)  ()            (empty)
2  render   (empty)  (empty)  (s[omitted])  (empty)
3  nullrow  (empty)  (empty)  ()            (empty)

# Propagation through WITH ORDINALITY.
query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM (SELECT 1 AS s) WITH ORDINALITY
----
0  render      (empty)  (empty)  ("1")                       ="1"
1  ordinality  (empty)  (empty)  (s[omitted], "ordinality")  +"ordinality",unique
2  render      (empty)  (empty)  (s[omitted])                (empty)
3  nullrow     (empty)  (empty)  ()                          (empty)

# Propagation through sort, when the sorting column is in the results.
query ITTTTT
EXPLAIN (METADATA) SELECT x FROM (SELECT 1 AS x, 2 AS y) ORDER BY x
----
0  render   (empty)  (empty)  (x)              =x
1  render   (empty)  (empty)  (x, y[omitted])  =x
2  nullrow  (empty)  (empty)  ()               (empty)

# Propagation through sort, when the sorting column is not in the results.
query ITTTTT
EXPLAIN (METADATA) SELECT x FROM (SELECT 1 AS x, 2 AS y, 3 AS z) ORDER BY y
----
0  nosort   (empty)  (empty)  (x)                 =x
0  (empty)  order    +y       (empty)             (empty)
1  render   (empty)  (empty)  (x, y)              =x,=y
2  render   (empty)  (empty)  (x, y, z[omitted])  =x,=y
3  nullrow  (empty)  (empty)  ()                  (empty)

# Propagation to sub-queries.
query ITTTTT
EXPLAIN (METADATA) SELECT 1 = (SELECT 2 AS x FROM (SELECT 3 AS s)) AS y
----
0  render   (empty)     (empty)  (y)           =y
0  (empty)  subqueries  1        (empty)       (empty)
1  limit    (empty)     (empty)  (x)           =x
2  render   (empty)     (empty)  (x)           =x
3  render   (empty)     (empty)  (s[omitted])  (empty)
4  nullrow  (empty)     (empty)  ()            (empty)
1  nullrow  (empty)     (empty)  ()            (empty)

# Propagation through table scans.
statement ok
CREATE TABLE kv(k INT PRIMARY KEY, v INT)

query ITTTTT
EXPLAIN (METADATA) SELECT 1 FROM kv
----
0  render   (empty)  (empty)     ("1")                     ="1"
1  scan     (empty)  (empty)     (k[omitted], v[omitted])  (empty)
1  (empty)  table    kv@primary  (empty)                   (empty)
1  (empty)  spans    ALL         (empty)                   (empty)

# Propagation through DISTINCT.
query ITTTTT
EXPLAIN (METADATA) SELECT DISTINCT v FROM kv
----
0  distinct  (empty)  (empty)     (v)              (empty)
1  render    (empty)  (empty)     (v)              (empty)
2  scan      (empty)  (empty)     (k[omitted], v)  (empty)
2  (empty)   table    kv@primary  (empty)          (empty)
2  (empty)   spans    ALL         (empty)          (empty)

# Propagation through INSERT.
query ITTTTT
EXPLAIN (METADATA) INSERT INTO kv(k, v) SELECT 1, 2 FROM (SELECT 3 AS x, 4 AS y)
----
0  insert   (empty)  (empty)   ()                        (empty)
0  (empty)  into     kv(k, v)  (empty)                   (empty)
1  render   (empty)  (empty)   ("1", "2")                ="1",="2"
2  render   (empty)  (empty)   (x[omitted], y[omitted])  (empty)
3  nullrow  (empty)  (empty)   ()                        (empty)

# Propagation through DELETE.
query ITTTTT
EXPLAIN (METADATA) DELETE FROM kv WHERE k = 3
----
0  delete   (empty)  (empty)     ()               (empty)
0  (empty)  from     kv          (empty)          (empty)
1  render   (empty)  (empty)     (k)              (empty)
2  scan     (empty)  (empty)     (k, v[omitted])  (empty)
2  (empty)  table    kv@primary  (empty)          (empty)
2  (empty)  spans    /3-/4       (empty)          (empty)

# Ensure that propagations through a render node removes the renders
# and properly propagates the remaining needed columns.
query ITTTTT
EXPLAIN (VERBOSE) SELECT x FROM (SELECT 1 AS x, y FROM (SELECT 2 AS y))
----
0  render   (empty)   (empty)  (x)              =x
0  (empty)  render 0  x        (empty)          (empty)
1  render   (empty)   (empty)  (x, y[omitted])  =x
1  (empty)  render 0  1        (empty)          (empty)
1  (empty)  render 1  NULL     (empty)          (empty)
2  render   (empty)   (empty)  (y[omitted])     (empty)
2  (empty)  render 0  NULL     (empty)          (empty)
3  nullrow  (empty)   (empty)  ()               (empty)

query ITTTTT
EXPLAIN (VERBOSE) SELECT 1 FROM (SELECT k+1 AS x, v-2 AS y FROM kv)
----
0  render   (empty)   (empty)     ("1")                     ="1"
0  (empty)  render 0  1           (empty)                   (empty)
1  scan     (empty)   (empty)     (k[omitted], v[omitted])  (empty)
1  (empty)  table     kv@primary  (empty)                   (empty)
1  (empty)  spans     ALL         (empty)                   (empty)

statement ok
CREATE TABLE a ("name" string, age int);

query ITTTTT
EXPLAIN (VERBOSE) SELECT count(*) FROM (SELECT "name", age FROM a);
----
0  group    (empty)      (empty)       ("count(*)")                                            (empty)
0  (empty)  aggregate 0  count_rows()  (empty)                                                 (empty)
1  render   (empty)      (empty)       ()                                                      (empty)
2  render   (empty)      (empty)       ("name"[omitted], age[omitted])                         (empty)
2  (empty)  render 0     NULL          (empty)                                                 (empty)
2  (empty)  render 1     NULL          (empty)                                                 (empty)
3  scan     (empty)      (empty)       ("name"[omitted], age[omitted], rowid[hidden,omitted])  (empty)
3  (empty)  table        a@primary     (empty)                                                 (empty)
3  (empty)  spans        ALL           (empty)                                                 (empty)
