# LogicTest: local local-opt local-parallel-stmts fakedist fakedist-opt fakedist-metadata

subtest defaults

query T
SHOW default_int_size
----
8

query TTTTT
EXPLAIN (VERBOSE) SELECT 1::INT, 2::SERIAL
----
render         ·         ·           (int8, serial8)  int8=CONST; serial8=CONST
 │             render 0  1           ·                ·
 │             render 1  2::SERIAL8  ·                ·
 └── emptyrow  ·         ·           ()               ·

subtest set_int4

statement ok
SET default_int_size=4

query T
SHOW default_int_size
----
4

query TTTTT
EXPLAIN (VERBOSE) SELECT 1::INT, 2::SERIAL
----
render         ·         ·           (int4, serial8)  int4=CONST; serial8=CONST
 │             render 0  1           ·                ·
 │             render 1  2::SERIAL8  ·                ·
 └── emptyrow  ·         ·           ()               ·

# Note that we expect the naked SERIAL here to be upgraded to INT8,
# since we have 64-bit row ids.
statement ok
CREATE TABLE i4 (i4 INT, s4 SERIAL)

query TT
SHOW CREATE TABLE i4
----
i4  CREATE TABLE i4 (
    i4 INT4 NULL,
    s4 INT8 NOT NULL DEFAULT unique_rowid(),
    FAMILY "primary" (i4, s4, rowid)
)

subtest set_int8

statement ok
SET default_int_size=8

query T
SHOW default_int_size
----
8

query TTTTT
EXPLAIN (VERBOSE) SELECT 1::INT, 2::SERIAL
----
render         ·         ·           (int8, serial8)  int8=CONST; serial8=CONST
 │             render 0  1           ·                ·
 │             render 1  2::SERIAL8  ·                ·
 └── emptyrow  ·         ·           ()               ·

statement ok
CREATE TABLE i8 (i8 INT, s8 SERIAL)

query TT
SHOW CREATE TABLE i8
----
i8  CREATE TABLE i8 (
    i8 INT8 NULL,
    s8 INT8 NOT NULL DEFAULT unique_rowid(),
    FAMILY "primary" (i8, s8, rowid)
)

# https://github.com/cockroachdb/cockroach/issues/32846
subtest issue_32846

statement ok
SET default_int_size=8

# Parsing and evaluation are async, so the setting won't take
# effect until the next statement is evaluated.
query TTTTT
SET default_int_size=4; EXPLAIN (VERBOSE) SELECT 1::INT
----
render         ·         ·  (int8)  int8=CONST
 │             render 0  1  ·       ·
 └── emptyrow  ·         ·  ()      ·

query T
SHOW default_int_size
----
4

query TTTTT
EXPLAIN (VERBOSE) SELECT 1::INT
----
render         ·         ·  (int4)  int4=CONST
 │             render 0  1  ·       ·
 └── emptyrow  ·         ·  ()      ·

subtest set_bad_value

statement error pq: only 4 or 8 are supported by default_int_size
SET default_int_size=2
