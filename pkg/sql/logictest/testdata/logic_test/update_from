# LogicTest: local-opt

statement ok
CREATE TABLE abc (a int primary key, b int, c int)

statement ok
INSERT INTO abc VALUES (1, 2, 3), (2, 3, 4)

# Updating using self join.
statement ok
UPDATE abc SET b = other.b + 1, c = other.c + 1 FROM abc AS other WHERE abc.a = other.a

query III
SELECT * FROM abc
----
1  3  4
2  4  5

# Update from another table.
statement ok
CREATE TABLE new_abc (a int, b int, c int)

statement ok
INSERT INTO new_abc VALUES (1, 2, 3), (2, 3, 4)

statement ok
UPDATE abc SET b = other.b, c = other.c FROM new_abc AS other WHERE abc.a = other.a

query III
SELECT * FROM abc
----
1  2  3
2  3  4

# Multiple matching values for a given row.
statement ok
INSERT INTO new_abc VALUES (1, 1, 1)

statement ok
UPDATE abc SET b = other.b, c = other.c FROM new_abc AS other WHERE abc.a = other.a

query III
SELECT * FROM abc
----
1  2  3
2  3  4

# Returning old values.
query IIIII colnames
UPDATE abc SET b = old.b + 1, c = old.c + 2 FROM abc AS old WHERE abc.a = old.a RETURNING abc.a, abc.b AS new_b, old.b as old_b, abc.c as new_c, old.c as old_c
----
a  new_b  old_b  new_c  old_c
1  3      2      5      3
2  4      3      6      4

# Check if RETURNING * returns everything
query IIIIII
UPDATE abc SET b = old.b + 1, c = old.c + 2 FROM abc AS old WHERE abc.a = old.a RETURNING *
----
1  4  7  1  3  5
2  5  8  2  4  6
