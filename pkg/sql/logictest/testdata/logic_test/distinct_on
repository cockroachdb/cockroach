# LogicTest: default parallel-stmts distsql distsql-disk

statement ok
CREATE TABLE xyz (
  x INT,
  y INT,
  z INT
)

statement ok
INSERT INTO xyz VALUES
  (1, 1, NULL),
  (1, 1, 2),
  (1, 1, 2),
  (1, 2, 1),
  (2, 2, 3),
  (4, 5, 6)

##################
# Simple queries #
##################

# 3/3 columns

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x, y, z) x, y, z FROM xyz
----
0  distinct  ·            ·            (x, y, z)                         ·
0  ·         distinct on  x, y, z      ·                                 ·
1  render    ·            ·            (x, y, z)                         ·
1  ·         render 0     test.xyz.x   ·                                 ·
1  ·         render 1     test.xyz.y   ·                                 ·
1  ·         render 2     test.xyz.z   ·                                 ·
2  scan      ·            ·            (x, y, z, rowid[hidden,omitted])  rowid!=NULL; key(rowid)
2  ·         table        xyz@primary  ·                                 ·
2  ·         spans        ALL          ·                                 ·

query III rowsort
SELECT DISTINCT ON (x, y, z) x, y, z FROM xyz
----
1 1 NULL
1 1 2
1 2 1
2 2 3
4 5 6

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (z, x, y) x FROM xyz
----
0  distinct  ·            ·            (x)                               ·
0  ·         distinct on  x, z, y      ·                                 ·
1  render    ·            ·            (x, z, y)                         ·
1  ·         render 0     test.xyz.x   ·                                 ·
1  ·         render 1     test.xyz.z   ·                                 ·
1  ·         render 2     test.xyz.y   ·                                 ·
2  scan      ·            ·            (x, y, z, rowid[hidden,omitted])  rowid!=NULL; key(rowid)
2  ·         table        xyz@primary  ·                                 ·
2  ·         spans        ALL          ·                                 ·

query I rowsort
SELECT DISTINCT ON (y, x, z) x FROM xyz
----
1
1
1
2
4

query I rowsort
SELECT DISTINCT ON (z, y, x) z FROM xyz
----
NULL
2
1
3
6

# 2/3 columns

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x, y) y, x FROM xyz
----
0  distinct  ·            ·            (y, x)                                     ·
0  ·         distinct on  y, x         ·                                          ·
1  render    ·            ·            (y, x)                                     ·
1  ·         render 0     test.xyz.y   ·                                          ·
1  ·         render 1     test.xyz.x   ·                                          ·
2  scan      ·            ·            (x, y, z[omitted], rowid[hidden,omitted])  rowid!=NULL; key(rowid)
2  ·         table        xyz@primary  ·                                          ·
2  ·         spans        ALL          ·                                          ·

query II rowsort
SELECT DISTINCT ON (x, y) y, x FROM xyz
----
1 1
2 1
2 2
5 4

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (y, x) x FROM xyz
----
0  distinct  ·            ·            (x)                                        ·
0  ·         distinct on  x, y         ·                                          ·
1  render    ·            ·            (x, y)                                     ·
1  ·         render 0     test.xyz.x   ·                                          ·
1  ·         render 1     test.xyz.y   ·                                          ·
2  scan      ·            ·            (x, y, z[omitted], rowid[hidden,omitted])  rowid!=NULL; key(rowid)
2  ·         table        xyz@primary  ·                                          ·
2  ·         spans        ALL          ·                                          ·

query I rowsort
SELECT DISTINCT ON (y, x) x FROM xyz
----
1
1
2
4

query I rowsort
SELECT DISTINCT ON (x, y) y FROM xyz
----
1
2
2
5

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (y, x, x, y, x) x, y FROM xyz
----
0  distinct  ·            ·            (x, y)                                     ·
0  ·         distinct on  x, y         ·                                          ·
1  render    ·            ·            (x, y)                                     ·
1  ·         render 0     test.xyz.x   ·                                          ·
1  ·         render 1     test.xyz.y   ·                                          ·
2  scan      ·            ·            (x, y, z[omitted], rowid[hidden,omitted])  rowid!=NULL; key(rowid)
2  ·         table        xyz@primary  ·                                          ·
2  ·         spans        ALL          ·                                          ·

# 1/3 columns

query I rowsort
SELECT DISTINCT ON (y) y FROM xyz
----
1
2
5

#################
# With ORDER BY #
#################

statement error SELECT DISTINCT ON expressions must be a prefix of or include all ORDER BY expressions
SELECT DISTINCT ON (x) x, y, z FROM xyz ORDER BY y

statement error SELECT DISTINCT ON expressions must be a prefix of or include all ORDER BY expressions
SELECT DISTINCT ON (y) x, y, z FROM xyz ORDER BY x, y

statement error SELECT DISTINCT ON expressions must be a prefix of or include all ORDER BY expressions
SELECT DISTINCT ON (y, z) x, y, z FROM xyz ORDER BY x

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x) x FROM xyz ORDER BY x DESC
----
0  distinct  ·            ·            (x)                                                 -x
0  ·         distinct on  x            ·                                                   ·
0  ·         order key    x            ·                                                   ·
1  sort      ·            ·            (x)                                                 -x
1  ·         order        -x           ·                                                   ·
2  render    ·            ·            (x)                                                 ·
2  ·         render 0     test.xyz.x   ·                                                   ·
3  scan      ·            ·            (x, y[omitted], z[omitted], rowid[hidden,omitted])  rowid!=NULL; key(rowid)
3  ·         table        xyz@primary  ·                                                   ·
3  ·         spans        ALL          ·                                                   ·

query I
SELECT DISTINCT ON (x) x FROM xyz ORDER BY x DESC
----
4
2
1

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x, z) y, z, x FROM xyz ORDER BY z ASC
----
0  distinct  ·            ·            (y, z, x)                         +z
0  ·         distinct on  z, x         ·                                 ·
0  ·         order key    z            ·                                 ·
1  sort      ·            ·            (y, z, x)                         +z
1  ·         order        +z           ·                                 ·
2  render    ·            ·            (y, z, x)                         ·
2  ·         render 0     test.xyz.y   ·                                 ·
2  ·         render 1     test.xyz.z   ·                                 ·
2  ·         render 2     test.xyz.x   ·                                 ·
3  scan      ·            ·            (x, y, z, rowid[hidden,omitted])  rowid!=NULL; key(rowid)
3  ·         table        xyz@primary  ·                                 ·
3  ·         spans        ALL          ·                                 ·

query III
SELECT DISTINCT ON (x, z) y, z, x FROM xyz ORDER BY z
----
1 NULL 1
2 1 1
1 2 1
2 3 2
5 6 4

query ITTTTT
EXPLAIN (VERBOSE) SELECT DISTINCT ON (x) y, z, x FROM xyz ORDER BY x ASC, z DESC
----
0  distinct  ·            ·            (y, z, x)                         +x,-z
0  ·         distinct on  x            ·                                 ·
0  ·         order key    x            ·                                 ·
1  sort      ·            ·            (y, z, x)                         +x,-z
1  ·         order        +x,-z        ·                                 ·
2  render    ·            ·            (y, z, x)                         ·
2  ·         render 0     test.xyz.y   ·                                 ·
2  ·         render 1     test.xyz.z   ·                                 ·
2  ·         render 2     test.xyz.x   ·                                 ·
3  scan      ·            ·            (x, y, z, rowid[hidden,omitted])  rowid!=NULL; key(rowid)
3  ·         table        xyz@primary  ·                                 ·
3  ·         spans        ALL          ·                                 ·

query III
SELECT DISTINCT ON (x) y, z, x FROM xyz ORDER BY x ASC, z DESC
----
1 2 1
2 3 2
5 6 4
