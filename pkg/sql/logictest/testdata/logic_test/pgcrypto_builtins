subtest digest

# NB: CockroachDB currently differs from Postgres, since the shaX functions
# return a string in CockroachDB, while Postgres returns bytea.
query BTT
SELECT
  encode(digest('abc', alg), 'hex') = expected, digest(NULL, alg), digest('abc', NULL)
FROM
  (
    VALUES
      ('md5', md5('abc')),
      ('sha1', sha1('abc')),
      ('sha224', sha224('abc')),
      ('sha256', sha256('abc')),
      ('sha384', sha384('abc')),
      ('sha512', sha512('abc'))
  )
    AS v (alg, expected);
----
true  NULL  NULL
true  NULL  NULL
true  NULL  NULL
true  NULL  NULL
true  NULL  NULL
true  NULL  NULL

query T
SELECT digest(NULL, 'made up alg')
----
NULL

statement error pgcode 22023 cannot use "made up alg", no such hash algorithm
SELECT digest('cat', 'made up alg')

subtest hmac

# NB: These results were manually confirmed to match the hashed values
# created by Postgres.
query T
SELECT encode(hmac('abc', 'key', alg), 'hex')
FROM (VALUES ('md5'), ('sha1'), ('sha224'), ('sha256'), ('sha384'), ('sha512')) v(alg)
----
d2fe98063f876b03193afb49b4979591
4fd0b215276ef12f2b3e4c8ecac2811498b656fc
f524670b7e34f31467de0aa96593861cf65117d414fb2d86158d760e
9c196e32dc0175f86f4b1cb89289d6619de6bee699e4c378e68309ed97a1a6ab
30ddb9c8f347cffbfb44e519d814f074cf4047a55d6f563324f1c6a33920e5edfb2a34bac60bdc96cd33a95623d7d638
3926a207c8c42b0c41792cbd3e1a1aaaf5f7a25704f62dfc939c4987dd7ce060009c5bb1c2447355b3216f10b537e9afa7b64a4e5391b0d631172d07939e087a

query TTT
SELECT hmac('abc', 'key', NULL), hmac('abc', NULL, 'made up alg'), hmac(NULL, 'key', 'sha256')
----
NULL  NULL  NULL

statement error pgcode 22023 cannot use "made up alg", no such hash algorithm
SELECT hmac('dog', 'key', 'made up alg')

subtest gen_random_uuid

query IB
SELECT length(gen_random_uuid()::BYTES), gen_random_uuid() = gen_random_uuid()
----
16 false


subtest gen_salt_invalid_algo

statement error pgcode 22023 Unknown salt algorithm
SELECT gen_salt('invalid')

statement error pgcode 22023 Unknown salt algorithm
SELECT gen_salt('invalid', 0)

subtest gen_salt_des

query I
SELECT char_length(gen_salt('des'))
----
2

query I
SELECT char_length(gen_salt('des', rounds))
FROM (VALUES (0), (25)) AS t (rounds)
----
2
2

# invalid rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('des', 1)

subtest gen_salt_xdes

query TI
SELECT substr(salt, 1, 5), char_length(salt)
FROM (SELECT gen_salt('xdes') AS salt)
----
_J9..  9

query TI
SELECT substr(salt, 1, 5), char_length(salt)
FROM (SELECT gen_salt('xdes', rounds) AS salt FROM (VALUES (0), (1), (16777215)) AS t (rounds))
----
_J9..  9
_/...  9
_zzzz  9

# invalid even rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('xdes', 2)

# invalid min rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('xdes', -1)

# invalid max rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('xdes', 16777216)

subtest gen_salt_md5

query TI
SELECT substr(salt, 1, 3), char_length(salt)
FROM (SELECT gen_salt('md5') AS salt)
----
$1$ 11

query TI
SELECT substr(salt, 1, 3), char_length(salt)
FROM (SELECT gen_salt('md5', rounds) AS salt FROM (VALUES (0), (1000)) AS t (rounds))
----
$1$ 11
$1$ 11

# invalid rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('md5', 1)

subtest gen_salt_bf

query TI
SELECT substr(salt, 1, 7), char_length(salt)
FROM (SELECT gen_salt('bf', rounds) AS salt FROM (VALUES (0), (4), (31)) AS t (rounds))
----
$2a$06$ 29
$2a$04$ 29
$2a$31$ 29

# invalid min rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('bf', 3)

# invalid max rounds
statement error pgcode 22023 Incorrect number of rounds
SELECT gen_salt('bf', 32)

subtest crypt_bf

query T
SELECT crypt(password, '$2a$06$Ukv6DxN3PpZo4YboQRrIVO')
FROM (VALUES
  (''),
  ('password'),
  ('012345678901234567890123456789012345678901234567890123456789012345678901'),
  ('0123456789012345678901234567890123456789012345678901234567890123456789012')
) AS t (password)
----
$2a$06$Ukv6DxN3PpZo4YboQRrIVOXwHbf79QsnJ4GoQyYv5vZozGSILtNUu
$2a$06$Ukv6DxN3PpZo4YboQRrIVO6UrBIvyPUuhsGQvYZyAvmsIjt02Ze3O
$2a$06$Ukv6DxN3PpZo4YboQRrIVOFJvN8pQPiHosPsBChWcAcl.FJsUH.Jq
$2a$06$Ukv6DxN3PpZo4YboQRrIVOFJvN8pQPiHosPsBChWcAcl.FJsUH.Jq

query T
SELECT crypt('password', concat('$2a$', rounds, '$Ukv6DxN3PpZo4YboQRrIVO'))
FROM (VALUES ('04'), ('10')) AS t (rounds)
----
$2a$04$Ukv6DxN3PpZo4YboQRrIVOSgyjUD9vDt2W.RjRVhm7XC2QTQrtLSK
$2a$10$Ukv6DxN3PpZo4YboQRrIVOwLm63.TplP3REdrq258BBo3lUBnEbrm

# invalid min rounds
statement error pgcode 22023 Invalid salt
SELECT crypt('password', '$2a$03$Ukv6DxN3PpZo4YboQRrIVO')

# invalid max rounds
statement error pgcode 22023 Invalid salt
SELECT crypt('password', '$2a$32$Ukv6DxN3PpZo4YboQRrIVO')
