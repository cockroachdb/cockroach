# LogicTest: 5node-distsql

########################
#  LOOKUP JOIN FORCED  #
########################
statement ok
SET experimental_force_lookup_join = true;

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM GENERATE_SERIES(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data TESTING_RELOCATE
  SELECT ARRAY[i%5+1], i FROM GENERATE_SERIES(0, 9) AS g(i)

# Generate all combinations of values 1 to 10.
statement ok
INSERT INTO data SELECT a, b, c, d FROM
   GENERATE_SERIES(1, 10) AS A(a),
   GENERATE_SERIES(1, 10) AS B(b),
   GENERATE_SERIES(1, 10) AS C(c),
   GENERATE_SERIES(1, 10) AS D(d)


statement ok
CREATE TABLE distsql_lookup_test_1 (a INT, b INT, c INT, PRIMARY KEY (a, c)); INSERT INTO distsql_lookup_test_1 VALUES (1, 1, 2), (2, 1, 1), (2, NULL, 2)


statement ok
CREATE TABLE distsql_lookup_test_2 (d INT, e INT, f INT, PRIMARY KEY (f, e)); INSERT INTO distsql_lookup_test_2 VALUES (1, 1, 2), (2, 1, 1), (NULL, 2, 1)


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b
----
1  1  2  2  1  1
2  1  1  2  1  1
1  1  2  NULL  2  1
2  1  1  NULL  2  1


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a > 1 AND e > 1
----
2  1  1  NULL  2  1


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b AND a > 1 AND e > 1
----
2  1  1  NULL  2  1


# Filter right side of a lookup join with a restriction on an indexed column.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = a WHERE f > 1
----
2  1  1  1  1  2
2  NULL  2  1  1  2


# Test lookup join with restriction relating the left and right side.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a >= e
----
1  1  2  2  1  1
2  1  1  2  1  1
2  1  1  NULL  2  1


# Test lookup join with restriction relating the left and right side.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b AND a >= e
----
1  1  2  2  1  1
2  1  1  2  1  1
2  1  1  NULL  2  1


# Test lookup join with selecting a subset of the columns.
query III rowsort
SELECT a, b, e FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a >= e
----
1  1  1
2  1  1
2  1  2


# Ensure lookup join is planned.
query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkT9r8zAQh_f3U5ib7wVbbjpo0ppSkhK6FWNU6whqHZ0qydAS_N2LraFJIG4z3p_n9IjfERwb2ugDRZAvUAHCChoEH7ijGDlM7by0Np8gSwTr_JCmdoPQcSCQR0g29QQSNvyfPSAYStr289KIwEP6QWLSewJZj3hytlo--6xfe9qRNhTOjoMP9qDDlzI2pvjRtz3z--DbRDG101-2Q5KFqlAJVDVcc6lucXlg625VEYDwONfFG1tXsJOFEpd-qO5QrVDdXxUVZ6K_ZLGj6NlF-lMc5dggkNlTzjvyEDp6CtzNz-RyO3Nzw1BMeVrnYu3yaBI8hatFWCzDYhEuL-Bm_PcdAAD__9Aa7V4=


query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a > 1 AND e > 1]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkk9Lw0AQxe9-imXOI-SP9bCnPQkVaaX0piHE7FBW0524OwGl5LtLkoNtodEe5838Zt9j9gCeLa2qPUXQL5ACwgIKhDZwTTFyGORpaGm_QCcIzredDHKBUHMg0AcQJw2BhhXfcgsIlqRyzTjUI3Anv0iUakeg8x6P1qbza7fVW0MbqiyFk-XQBrevwrexLkr8bMqG-aNrS6Eo5ZBl3YlWJkWTocnhkpf0Gi-P7Py1VjJAeBpr9c7OK_ZamUF8cI1Q0Mos1GuXJDmpVGu9XG3PvaO5Q7NAc38xRHYS4o87bSi27CP961RJXyCQ3dH0FyJ3oabnwPX4zFSuR24ULEWZuvlULP3UGgwew-ksnM3D2SycnMFFf_MTAAD___rz9NY=


# Ensure lookup join is planned on a multi-node cluster.
query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM data JOIN data AS data2 on data.b = data2.a]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzMlMtq6zAQhvfnKcys50B8yeV4pW0OJSmhu-KFag3BbaIxkgwtwe9ebC_SBEcOZKEudfn0_cyIOYFmRRt5JAv5K8SAkABCCggZIMyhQKgNl2Qtm-7KAKzVJ-QzhErXjeu2C4SSDUF-Ale5A0EOL_LtQDuSigwgKHKyOvSS2lRHab6Ekk4CwrZxeSRiFAmKFEUGRYvAjTu_bJ3cE-Rxi_fb_3Ol75A_MX80dfTOlY5Y55FIRhKhmKNYoFiiWN1Ml9xMdw7VaDaKDKmLTEU7kn_Df7m-ujYuTi_EcdCmTNgDNyUJWpsJe-DapEFrM2EPXJssaG0m7L9o0I2k25GtWVu6a5LNukFIak_D1LTcmJKeDZe9Zlhue67fUGTdcBoPi7UejrqAP-HYCycXcHwNJ37zhDr10pkfzh7JPffCC7958Yh56YVXfvPqEfM_f69mE9_E_8mu3UX75zsAAP__2l_6CA==


# Ensure join performs properly on input that has more than 100 rows.
query I
SELECT COUNT(*) FROM data as d1 NATURAL JOIN data as d2
----
10000


query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT COUNT(*) FROM data as d1 NATURAL JOIN data as d2]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzElV-rmzAYxu_3Kcp7dQa5OFF7duqVY1cdWx39wy6GlMy8iFubSBJho_jdhzrolJq0tNNLtU9-vz48kBMIyXHFjqgh_AYUCHhAwAcCARCYQ0KgUDJFraWqf9IGlvwXhM8EclGUpn6dEEilQghPYHJzQAhhy74fcI2MowICHA3LDw2kUPmRqd8RZ4YBgbg04SyiJPJI5JMogKQiIEtzPlkbliGEtCLX0z_KXFwB_yTlz7KY_ZC5mEnR9firNujj3eLzPssUZszIns-HeLfa7tfx183T20GSP0g6A0ohFUeFvHN-Ut3gstl93i9X26eIDqsEHRU66QQc9NEn4PB54AS8SXt30Efv3eHzwN79SXt30Efv3eHzwN6DSXt30Efv3eHzn66aC6Q16kIKjb0r5_LJz_VVhDzD9t7SslQpflEybTDtY9zkmhcctWm_0vZhKdpPteC_YWoNe_awZw37nTDth3279osdHVjTc3t4bg07yC_3_Ol31vCrnfxqDS_s4cU92tSxMdfI7CujjpnRu3ZGHUMLHHD70qhjatS-tb57Ur35EwAA__-XQAWb


statement ok
CREATE TABLE foo (a int, b int); INSERT INTO foo VALUES (0, 1), (0, 2), (1, 1)

statement ok
CREATE TABLE bar (a int PRIMARY KEY, c int); INSERT INTO bar VALUES (0, 1), (1, 2), (2, 1)

query III rowsort
SELECT * FROM foo NATURAL JOIN bar
----
0  1  1
0  2  1
1  1  2


query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM foo NATURAL JOIN bar]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkTFPwzAQhXd-RfXmQ0pSWDxlLUItqthQBjc-KkPqs2xHAlX57yjxQIPUAKPv3ffe0_kMJ4a3-sQR6gUlCPdoCD5IyzFKGMd5aWM-oAqCdb5P47ghtBIY6oxkU8dQ2MqteBAMJ227aWkgSJ--kZj0kaHWA13Ylsu2z_rQ8Z614TAzhw_2pMNn_SoCwq5PalWXVFe4Flv-J_ZBrFtKPehReBR57_3qTaxbiRsLzKpQfXe1TTVr88tt9xy9uMh_Om8xNAQ2R87_F6UPLT8FaaeY_NxN3DQwHFNW1_mxcVkaC17C5SJcLcPVIlz8gJvh5isAAP__63jb_A==


# Ensure lookup join is not planned when no index is available.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM bar NATURAL JOIN foo]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyskjFrwzAQhff-inJTCypEjrsICh6bDkkJ3YoHxbo4AkdnTjK0BP_3YmtIbGonhW7S3X333hM6gSODa31ED-oTJAh4hlxAzVSg98RdOQ6tzBeohQDr6iZ05VxAQYygThBsqBAUrOmJahBgMGhb9UOtAGrCGfFBlwgqbcXFWjm_9kPvKtyiNsiD5VCzPWr-zna6a2yaoO4zKbIEpmTlv8ruiW6TTSZlz2qNIzbIaMbvd33kF--v2h_eyLqx9Qr34SGTjy9sy0N_GiQQWToZYjkIceUnbNHX5Dze9BkWXQI0JcYX8dRwge9MRS8Tr5ue6wsGfYjdNF5WLrY6g5ewnIWXA1iO4eQPcDKGl7PwYmQ7b-9-AgAA__81cSn3


statement ok
CREATE TABLE books (title STRING, edition INT, shelf INT, PRIMARY KEY (title, edition)); INSERT INTO books VALUES ('SICP', 1, 2), ('Intro to Algo', 1, 1), ('Intro to Algo', 2, 1), ('Intro to Algo', 3, 2), ('Art of Computer Programming', 1, 2), ('Art of Computer Programming', 2, 2)


statement ok
CREATE TABLE authors (name STRING, book STRING); INSERT INTO authors VALUES ('Hal Abelson', 'SICP'), ('Geral Jay Sussman', 'SICP'), ('Thomas H Cormen', 'Intro to Algo'), ('Charles E Leiserson', 'Intro to Algo'), ('Ronald Rivest', 'Intro to Algo'), ('Clifford Stein', 'Intro to Algo'), ('Donald Knuth', 'Art of Computer Programming')


query T rowsort
SELECT DISTINCT(b1.title) FROM books as b1 JOIN books as b2 ON b1.title = b2.title WHERE b1.shelf <> b2.shelf
----
Intro to Algo


# Filter on a column that is not returned or in the equality columns.
query T rowsort
SELECT DISTINCT(b1.title) FROM books as b1 JOIN books as b2 USING(title) WHERE b1.shelf <> b2.shelf
----
Intro to Algo


query T rowsort
SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
Thomas H Cormen
Charles E Leiserson
Ronald Rivest
Clifford Stein

query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJysks-L6jAQx-_vr5A5KeSBaa2HwoMe3uH5WHSRvS0eYjOrWWum5AfsIv7vS9qDtmyjwh6bzGc-35nmBJokLsURLeSvwIFBBhsGtaESrSUTjtuihfyAfMpA6dq7cLxhUJJByE_glKsQcljSb6qBgUQnVNUUnRmQdxfEOrFDyOdndtWWx9u-iG2FaxQSTac51EYdhfkshHf7kJXByrt8VHBWJDCk5j-q3hIdOuJ0UJw8Iv5PSt_jfSI6-Hr0TkqPSIcIlzCDSdLBJJcAXpORaFD2_-ftkm_G-SfsPozUH6fCNzcukskfo3Z7Ny745I74s0cW-VdZp3Tput5I96zT_caLX6OtSVu869FPw2ZQ7rDdtCVvSnw2VDaa9nPVcM2BROva23n7sdDtVQh4DfMoPOvAvA8nUTiNm9MHzEkfnkXhLG7OovC0B2_Ov74CAAD__1i6oG0=


query TTT
EXPLAIN (EXPRS) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
distinct                  ·               ·
 └── render               ·               ·
      │                   render 0        "name"
      └── join            ·               ·
           │              type            inner
           │              equality        (book) = (title)
           ├── scan       ·               ·
           │              table           authors@primary
           │              spans           ALL
           └── join       ·               ·
                │         type            inner
                │         equality        (title) = (title)
                │         mergeJoinOrder  +"(title=title)"
                │         pred            b1.shelf != b2.shelf
                ├── scan  ·               ·
                │         table           books@primary
                │         spans           ALL
                └── scan  ·               ·
·                         table           books@primary
·                         spans           ALL


query TITTTTT colnames
EXPLAIN (VERBOSE) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
Tree                      Level  Type      Field           Description                 Columns                                                                                                                                             Ordering
distinct                  0      distinct  ·               ·                           ("(authors.name)")                                                                                                                                  weak-key("(authors.name)")
 └── render               1      render    ·               ·                           ("(authors.name)")                                                                                                                                  ·
      │                   1      ·         render 0        test.public.authors."name"  ·                                                                                                                                                   ·
      └── join            2      join      ·               ·                           ("name", book[omitted], rowid[hidden,omitted], title[omitted], edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])  ·
           │              2      ·         type            inner                       ·                                                                                                                                                   ·
           │              2      ·         equality        (book) = (title)            ·                                                                                                                                                   ·
           ├── scan       3      scan      ·               ·                           ("name", book, rowid[hidden,omitted])                                                                                                               rowid!=NULL; key(rowid)
           │              3      ·         table           authors@primary             ·                                                                                                                                                   ·
           │              3      ·         spans           ALL                         ·                                                                                                                                                   ·
           └── join       3      join      ·               ·                           (title, edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])                                                         title=title; title!=NULL
                │         3      ·         type            inner                       ·                                                                                                                                                   ·
                │         3      ·         equality        (title) = (title)           ·                                                                                                                                                   ·
                │         3      ·         mergeJoinOrder  +"(title=title)"            ·                                                                                                                                                   ·
                │         3      ·         pred            b1.shelf != b2.shelf        ·                                                                                                                                                   ·
                ├── scan  4      scan      ·               ·                           (title, edition[omitted], shelf)                                                                                                                    title!=NULL; edition!=NULL; key(title,edition); +title
                │         4      ·         table           books@primary               ·                                                                                                                                                   ·
                │         4      ·         spans           ALL                         ·                                                                                                                                                   ·
                └── scan  4      scan      ·               ·                           (title, edition[omitted], shelf)                                                                                                                    title!=NULL; edition!=NULL; key(title,edition); +title
·                         4      ·         table           books@primary               ·                                                                                                                                                   ·
·                         4      ·         spans           ALL                         ·                                                                                                                                                   ·


# Ensure lookup join preserves sort from the left side.
query T
SELECT DISTINCT(a.name) FROM (SELECT * FROM authors ORDER BY name) AS a JOIN books AS b1 ON a.book = b1.title
----
Charles E Leiserson
Clifford Stein
Ronald Rivest
Thomas H Cormen
Donald Knuth
Geral Jay Sussman
Hal Abelson


# Cross joins should not be planned as lookup joins.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM books as b1 CROSS JOIN books as b2]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzEkrFOwzAQhneeAt18SHWSMnjySBlaVLGhDG58KhGpL7IdCVTl3VHioY1FUpgYfb7v_s_WncGyoa0-kQf5BgIQ1lAitI4r8p7dUI5NG_MJcoVQ27YLQ7lEqNgRyDOEOjQEErb8wC0gGAq6bsamHoG7cEF80EcCWfR4NVYsj33Vh4b2pA25yXBoXX3S7ksdmD88IOy6IO-VQJWhymEuW_xjdjabfYnsLDtDjkz6k7dbfnjAk_bvz1zb1H_ii6pAtUb1OCueT8Rv7MGefMvW069WYTVYkzlS_AXPnavoxXE1xsTjbuTGgiEf4m0RDxsbrwbBa1gswvkEFimc_QHOUjhfhFeJdtnffQcAAP__ALIo4A==


# Outer joins should not be planned as lookup joins.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM books as b1 LEFT OUTER JOIN books as b2 ON b1.title = b2.title]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzEksFKw0AQhu8-RZiT4gjdpPWwIOylQos2UuJJekizYwymmbC7AUvpu0uyh7bBpnrytjsz3_zzD7ODijUt0g1ZkG8gAGECK4TacEbWsmnDvmimv0COEIqqblwbXiFkbAjkDlzhSgIJC77jGhA0ubQou6I9AjfugFiX5gRyvMejtmK4bZKuS1pSqsmcNIfaFJvUbNWa-dMCQtw4GSiBKkQVwTlt8Y_a4Vntg2RTsdFkSPc3ebnkBwPPZHKac1H1DSTbmmTwNH1Mgvg1mS6DeTxbAEJJ7-5aidubB1PkH_7Z94dqjGqC6v6s0ejE6IW7WZKtubL0q9MZtS5J5-S3ZrkxGb0YzjoZ_407rgtoss5nx_4zq3yqHfAYFoNwdAKLPhz-AQ77cDQIj3pjr_ZX3wEAAP__G2E2Mg==


query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM authors INNER JOIN books ON books.edition = 1 WHERE books.title = authors.book]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkTFrwzAQhff-CvHmK8ROsggKmgopJSkhW_Gg2EeqxtEZSYaW4P9ebA9NCnHbUe_ue--hO8NLxWt74gj9igyEJQpCE6TkGCX08ri0qj6gZwTnmzb1ckEoJTD0GcmlmqGxlntpQKg4WVcPSx1B2vSNxGQPDD3v6MI2m7bd2X3NW7YVhytzNMGdbPg0tk1vfVfCpk1amYxMjlvR2X-in8T5qeS9yLHPfRY5to16F-eVeK1MDsKjqxMHrcxCPahMa71a7646kpmTWZBZ3iybX5X95fu3HBvxkf90gVlXELg68HjiKG0o-SVIOcSMz83ADULFMY3T-fhY-XHUF7yEs0k4n4bzSXj2Ay66u68AAAD__9tr5dM=


statement ok
CREATE TABLE players (id DECIMAL PRIMARY KEY, name STRING, team INT); INSERT INTO players VALUES (1.0, 'ready', 0)


query B
SELECT p1.team = p2.team FROM players p1 JOIN players p2 ON p1.id = p2.id;
----
true


statement ok
SET experimental_force_lookup_join = false;


##########################
#  LOOKUP JOIN DISABLED  #
##########################


# Simple joins should no longer be planned as lookup joins.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM foo JOIN bar USING(a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyskjFrwzAQhff-inJTCypEjrsICh6bDkkJ3YoHxbo4AkdnTjK0BP_3YmtIbGonhW7S6b5774k7gSODa31ED-oTJAh4hlxAzVSg98RdOTatzBeohQDr6iZ05VxAQYygThBsqBAUrOmJahBgMGhb9U2tAGrCGfFBlwgqbcXFWDk_9kPvKtyiNsiD4VCzPWr-zvZEIGDTBHWfSZElMCUr_1V2p_k22WRS9qzWOGKDjGb8f9dbfvH-qv3hjawbW69wHx4y-fjCtjz0p0ECkaWTIZaDEFc2YYu-JufxpmVYdAnQlBh_xFPDBb4zFb1MvG56ri8Y9CG-pvGycvGpM3gJy1l4OYDlGE7-ACdjeDkLL0a28_buJwAA__88ain3
