# LogicTest: 5node-distsql 5node-distsql-metadata

########################
#  LOOKUP JOIN FORCED  #
########################
statement ok
SET experimental_force_lookup_join = true;

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM GENERATE_SERIES(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data TESTING_RELOCATE
  SELECT ARRAY[i%5+1], i FROM GENERATE_SERIES(0, 9) AS g(i)

# Generate all combinations of values 1 to 10.
statement ok
INSERT INTO data SELECT a, b, c, d FROM
   GENERATE_SERIES(1, 10) AS A(a),
   GENERATE_SERIES(1, 10) AS B(b),
   GENERATE_SERIES(1, 10) AS C(c),
   GENERATE_SERIES(1, 10) AS D(d)


statement ok
CREATE TABLE distsql_lookup_test_1 (a INT, b INT, c INT, PRIMARY KEY (a, c)); INSERT INTO distsql_lookup_test_1 VALUES (1, 1, 2), (2, 1, 1), (2, NULL, 2)


statement ok
CREATE TABLE distsql_lookup_test_2 (d INT, e INT, f INT, PRIMARY KEY (f, e)); INSERT INTO distsql_lookup_test_2 VALUES (1, 1, 2), (2, 1, 1), (NULL, 2, 1)


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b
----
1  1  2  2  1  1
2  1  1  2  1  1
1  1  2  NULL  2  1
2  1  1  NULL  2  1


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a > 1 AND e > 1
----
2  1  1  NULL  2  1


query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b AND a > 1 AND e > 1
----
2  1  1  NULL  2  1


# Filter right side of a lookup join with a restriction on an indexed column.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = a WHERE f > 1
----
2  1  1  1  1  2
2  NULL  2  1  1  2


# Test lookup join with restriction relating the left and right side.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a >= e
----
1  1  2  2  1  1
2  1  1  2  1  1
2  1  1  NULL  2  1


# Test lookup join with restriction relating the left and right side.
query IIIIII rowsort
SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b AND a >= e
----
1  1  2  2  1  1
2  1  1  2  1  1
2  1  1  NULL  2  1


# Test lookup join with selecting a subset of the columns.
query III rowsort
SELECT a, b, e FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a >= e
----
1  1  1
2  1  1
2  1  2


# Ensure lookup join is planned.
query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkcFq8zAQhO__U5g9708sp-lBJ11TSlJCb8UY1VqCWkerSjK0BL97sVVoUoibHne0386gOYJjQxt9oAjyCQQgrKBG8IFbipHDKOeltXkHWSJY5_s0yjVCy4FAHiHZ1BFI2PB_9osKEAwlbbtpbUDgPn1DMek9gVwOeHJYzB9-1M8d7UgbCovy7Dz4YA86fChjY4pvXdMxv_a-SRRTI-CSu_iL-x1b92Uurjcfv-F-mosXtq5gJws1its-yUIJVBWqJaobVCtUtxejVmdRf2lgR9Gzi3RVBeVQI5DZU245ch9aegjcTjZ53E7cJBiKKb8u87B2-WkMeAqLWbiah6tZuPwB18O_zwAAAP__2Q3qzg==


query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a > 1 AND e > 1]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkcFq8zAQhO__U5g9708sp-lBJ11TSlJCb8UY1VqCWkerSjK0BL97sVVoUoibHne0386gOYJjQxt9oAjyCQQgrKBG8IFbipHDKOeltXkHWSJY5_s0yjVCy4FAHiHZ1BFI2PB_9osKEAwlbbtpbUDgPn1DMek9gVwOeHJYzB9-1M8d7UgbCovy7Dz4YA86fChjY4pvXdMxv_a-SRRTI-CSu_iL-x1b92Uurjcfv-F-mosXtq5gJws1its-yUIJVBWqJaobVCtUtxejVmdRf2lgR9Gzi3RVBeVQI5DZU245ch9aegjcTjZ53E7cJBiKKb8u87B2-WkMeAqLWbiah6tZuPwB18O_zwAAAP__2Q3qzg==


# Ensure lookup join is planned on a multi-node cluster.
query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM data JOIN data AS data2 on data.b = data2.a]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzElE-LnTAUxff9FHLXt4zx33NcZTulzJShu-IiNZfB9k2uJBFaBr97UQvje7yJgguXJjn-Ts4J9w0Ma3pUr-Sg-gECEBJASAEhA4QcaoTOckPOsR2PzIIH_QeqGKE1Xe_H5RqhYUtQvYFv_Zmggu_q55meSWmydzEgaPKqPU-Yzravyv6VWnkF9YDAvX__kfPqhaASA26HfeHW_GflARbCV-bffRf94tZEbKpIjtd96n0VSYEyQZmizFDmKAuUJ5Tlh_6SD_292-oNW02W9IWnerhxg0f-zN2diK9O3manF2yxvQixu4gV2KKI4pAiku1hJLvDWIEtwjgdEka6PYx0dxgrsEUY5SFhZNvDyHaHsQJbhHF_-Ly64e-ZXMfG0aZpFI_zjPQLzcPPcW8b-ma5mTDz59OkmxY0OT_vivnjwcxbo8GlWATFyYVYXIuTMHkFnQbVWVic7fGdB8VFmFzsIZ-C4jJMLveQ78NdxSvPJPzIrtn18OlfAAAA__8Afujr


# Ensure join performs properly on input that has more than 100 rows.
query I
SELECT COUNT(*) FROM data as d1 NATURAL JOIN data as d2
----
10000


query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT COUNT(*) FROM data as d1 NATURAL JOIN data as d2]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJy8lV9r2zAUxd_3KcJ96kDQXNtJEz957CljS0aasodhihZdjLdUMpIMGyXffTgeVDGN5KGSR_85Oke_e-A-g1SC1vyJDOTfAYFBAgxSYJABgxmUDBqt9mSM0t0vvWAlfkM-ZVDLprXd65LBXmmC_BlsbQ8EOez4jwNtiQvSt1NgIMjy-nCyaXT9xPWfQnDLoTwyUK19OchYXhHkeGTjzT6pWv7zmnm8GHxW6lfbTH6qWk6UzCcFsiJhRcqK7r6b1uaTtZJ0MVXyP6k-VJWmilulb3GA4OPmYb173G6-3d-8v2iWXjR78Wil0oI0ibPzy2MgzoDS_cOXx9V6d1Pg5TTZWRocP32Mnn7AzJn-_IrTD6RycWP09JPxvJNo3gEzh_fdFXkHUrm8k2je6XjeaTTvgJnDe3FF3oFULu80mnc2nncWzTtg5vBeXpF3IJXLO3vTbfKK2ZZMo6ShwVZ5_eRpt21IVNSvJqNavaevWu1PNv3j5qQ7vRBkbP8V-4eV7D91AV0xesWJX5x4xemZGIfi1B977rfOvOqZXzzzigPO85hL33nFC7_zwite-sXLmNgY6FioZP6WYaBmGNUzDBQtC5j7m4aBqqG_a8Ps5fHd3wAAAP__1CT_Hg==


statement ok
CREATE TABLE foo (a int, b int); INSERT INTO foo VALUES (0, 1), (0, 2), (1, 1)

statement ok
CREATE TABLE bar (a int PRIMARY KEY, c int); INSERT INTO bar VALUES (0, 1), (1, 2), (2, 1)

query III rowsort
SELECT * FROM foo NATURAL JOIN bar
----
0  1  1
0  2  1
1  1  2


query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM foo NATURAL JOIN bar]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkTFPwzAQhXd-RfXmQ01SWDxlLUItqthQBjc-KkPrs2xHAlX57ygxEi2iAUa_u--9p_MRTgyv9IEj1BNKEG7REHyQlmOUMMh5aWneoAqCdb5Lg9wQWgkMdUSyac9QWMm1-HkFguGk7X5c6wnSpS8oJr1jqEVPJ8bltPGj3u55w9pwmBdn9vDBHnR4r59FQFh3Sc3qkuoKl4LL_wTfiXWfueXPuVsdQLgXee387EWsm4kbKpyVofrmYp_qrM8vF95w9OIi_-nERd8Q2Ow4_2KULrT8EKQdY_JzPXKjYDimPF3kx9Ll0VDwFC4n4Woaribh4hvc9FcfAQAA__97bt0c


# Ensure lookup join is not planned when no index is available.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM bar NATURAL JOIN foo]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyckjFrwzAQhff-inJTCyqx7HQRFDw2HZISupUMinVJBI7OnGRoCf7vxdaQ2MRO20063XfvPXEncGRwqY_oQX2CBAHPsBFQMRXoPXFbjk0L8wUqEWBdVYe2vBFQECOoEwQbSgQFS3qiapaBAINB27JrawRQHc6QD3qPoOaNuBgspwd_6G2Ja9QGeZb0xkPF9qj5O99qhjEt-V8teV1rRwQCVnVQ97kUeToqnI4Kn_VqR2yQ0Qy_7XbLFfev2h_eyDrkWdo3X-IuPOTy8YXt_tCdehlEPh-NkfVi3FiCNfqKnMdfbUHSZkCzx_gnnmou8J2p6GTiddVxXcGgD_F1Hi8LF59ag5ewnISzHiyHcPoHOB3C2SScDGxvmrufAAAA___gtCho


statement ok
CREATE TABLE books (title STRING, edition INT, shelf INT, PRIMARY KEY (title, edition)); INSERT INTO books VALUES ('SICP', 1, 2), ('Intro to Algo', 1, 1), ('Intro to Algo', 2, 1), ('Intro to Algo', 3, 2), ('Art of Computer Programming', 1, 2), ('Art of Computer Programming', 2, 2)


statement ok
CREATE TABLE authors (name STRING, book STRING); INSERT INTO authors VALUES ('Hal Abelson', 'SICP'), ('Geral Jay Sussman', 'SICP'), ('Thomas H Cormen', 'Intro to Algo'), ('Charles E Leiserson', 'Intro to Algo'), ('Ronald Rivest', 'Intro to Algo'), ('Clifford Stein', 'Intro to Algo'), ('Donald Knuth', 'Art of Computer Programming')


query T rowsort
SELECT DISTINCT(b1.title) FROM books as b1 JOIN books as b2 ON b1.title = b2.title WHERE b1.shelf <> b2.shelf
----
Intro to Algo


# Filter on a column that is not returned or in the equality columns.
query T rowsort
SELECT DISTINCT(b1.title) FROM books as b1 JOIN books as b2 USING(title) WHERE b1.shelf <> b2.shelf
----
Intro to Algo


query T rowsort
SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
Thomas H Cormen
Charles E Leiserson
Ronald Rivest
Clifford Stein

query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJycks-O2jAQh-99CjQnkFwlzh8OkSrl0EOpKqhQbxUHE8-Cl-CJbEfaFeLdV0lWgkTEwB5jzzffbyY-gSaJS3FEC9l_4MAghQ2DylCB1pJpjruihXyDLGSgdFW75njDoCCDkJ3AKVciZLCk71QFKTCQ6IQq27IzA6rdBbJO7BCy-ZldNeb-xv_EtsQ1CokmCHvtoTLqKMx7Lmq3b_IyWNUum-Sc5RGMyflX5fy2fEt06KnjUXX0jPo3Kf1pjvzmP0SHupq8ktIT0k2IS5zRLPFolkuEWpORaFAO_-r9khsD_RJ23wyFJoj7A5X44qZ5NPth1G7vpjmfPTBA8swyfyrrlC5ckPTNnv5pr_-d179GW5G2-NDzD5vtoNxht21LtSnwr6Gi1XSfq5ZrDyRa193Ou4-F7q6agNcw98JJD-ZDOPLCsd8cP2GOhnDihVO_OfXC4QDenL99BAAA__8qCKK2


query TTTTT colnames
EXPLAIN (VERBOSE) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
Tree                      Field           Description               Columns                                                                                                                                           Ordering
distinct                  ·               ·                         ("(authors.name)")                                                                                                                                weak-key("(authors.name)")
 └── render               ·               ·                         ("(authors.name)")                                                                                                                                ·
      │                   render 0        test.public.authors.name  ·                                                                                                                                                 ·
      └── join            ·               ·                         (name, book[omitted], rowid[hidden,omitted], title[omitted], edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])  ·
           │              type            inner                     ·                                                                                                                                                 ·
           │              equality        (book) = (title)          ·                                                                                                                                                 ·
           ├── scan       ·               ·                         (name, book, rowid[hidden,omitted])                                                                                                               rowid!=NULL; key(rowid)
           │              table           authors@primary           ·                                                                                                                                                 ·
           │              spans           ALL                       ·                                                                                                                                                 ·
           └── join       ·               ·                         (title, edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])                                                       title=title; title!=NULL
                │         type            inner                     ·                                                                                                                                                 ·
                │         equality        (title) = (title)         ·                                                                                                                                                 ·
                │         mergeJoinOrder  +"(title=title)"          ·                                                                                                                                                 ·
                │         pred            b1.shelf != b2.shelf      ·                                                                                                                                                 ·
                ├── scan  ·               ·                         (title, edition[omitted], shelf)                                                                                                                  title!=NULL; edition!=NULL; key(title,edition); +title
                │         table           books@primary             ·                                                                                                                                                 ·
                │         spans           ALL                       ·                                                                                                                                                 ·
                └── scan  ·               ·                         (title, edition[omitted], shelf)                                                                                                                  title!=NULL; edition!=NULL; key(title,edition); +title
·                         table           books@primary             ·                                                                                                                                                 ·
·                         spans           ALL                       ·                                                                                                                                                 ·



# Ensure lookup join preserves sort from the left side.
query T
SELECT DISTINCT(a.name) FROM (SELECT * FROM authors ORDER BY name) AS a JOIN books AS b1 ON a.book = b1.title
----
Charles E Leiserson
Clifford Stein
Ronald Rivest
Thomas H Cormen
Donald Knuth
Geral Jay Sussman
Hal Abelson


# Cross joins should not be planned as lookup joins.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM books as b1 CROSS JOIN books as b2]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyckTFvszAQhvfvV3y6-apgIB08eWw6JFXUrWJw8ClFJT5kG6lVxH-vwEMCKqTN6PM99z66O4NlQ1t9Ig_yDQQgrKFAaByX5D27vhybNuYTZIJQ2aYNfblAKNkRyDOEKtQEErb8wM0qAwRDQVf10NYhcBsukA_6SCDzDq8Gi-XBr_pQ0560IbdKRuOhcdVJuy91YP7wMJcm7k0T96Sls2mXkNayM-TITLd1u-UH5Sft35-5suRW6dh41wb5XwlUKaoMVY5qjepxVj0bqd-49558w9bTrw6e9N5kjhT34Ll1Jb04LoeY-NwN3FAw5EP8zeNjY-NXL3gNi0U4G8FiCqd_gNMpnC3CyUS76P59BwAA__9upyMC


query T rowsort
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM authors INNER JOIN books ON books.edition = 1 WHERE books.title = authors.book]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkc9KAzEQh-8-xTLnke6m9pJTrhVppXiTPaSboca2mZA_oJR9d9mNYCt21WNm5pvvx-QEjg2t9JEiyGdoAGEBLYIP3FGMHIZyGVqaN5A1gnU-p6HcInQcCOQJkk0HAgkrvmU_E4BgKGl7GMd6BM7pC4pJ7wjkvMezxc304ie9PdCGtKEwqy_Wgw_2qMO70jm9DHkR1jnJSjWoBFyTN_-R37N1n-7mZ_eWeT-YH5j32VevbF3FTlZKXMRBNUd1h2pxNZe4yPXLtTcUPbtIfzp33bcIZHZUfjRyDh09Bu5GTXmuR24sGIqpdOflsXSlNQQ8h5tJWEzDYhKuv8Ftf_MRAAD__zUZ4Qg=


statement ok
CREATE TABLE players (id DECIMAL PRIMARY KEY, name STRING, team INT); INSERT INTO players VALUES (1.0, 'ready', 0)


query B
SELECT p1.team = p2.team FROM players p1 JOIN players p2 ON p1.id = p2.id;
----
true


statement ok
SET experimental_force_lookup_join = false;


##########################
#  LOOKUP JOIN DISABLED  #
##########################


# Simple joins should no longer be planned as lookup joins.
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT * FROM foo JOIN bar USING(a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJycksFqwzAMhu97iqHTBh6Nk-5iGOS47tCOstvowY3V1pBaQXZgo-TdR-JDm9Ck2262pE__L6ETODK41Ef0oD5BgoBn2AiomAr0nrgNx6KF-QKVCLCuqkMb3ggoiBHUCYINJYKCJT1RNctAgMGgbdmVNQKoDmfIB71HUPNGXDSW040_9LbENWqDPEt67aFie9T8ne-IQMCqDuo-lyJPYUxY_ldYXhfeah7VSke1zhK1IzbIaIZru11yxfCr9oc3sg55lvb9lrgLD7l8fGG7P3Sv3r5EPh8dI-uNceMI1ugrch5_dQVJOwOaPcadeKq5wHemopOJ31XHdQGDPsTsPH4WLqZag5ewnISzHiyHcPoHOB3C2SScDGxvmrufAAAA__9feSho


####################################
#  LOOKUP JOIN ON SECONDARY INDEX  #
####################################
statement ok
SET experimental_force_lookup_join = true

# Create a table with a secondary index which stores another column.
statement ok
CREATE TABLE multiples (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b), INDEX bc (b) STORING (c))

# Split into ten parts.
statement ok
ALTER TABLE multiples SPLIT AT SELECT i FROM GENERATE_SERIES(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE multiples TESTING_RELOCATE
  SELECT ARRAY[i%5+1], i FROM GENERATE_SERIES(0, 9) AS g(i)

# Generate 10 rows.
statement ok
INSERT INTO multiples SELECT x, 2*x, 3*x, 4*x FROM
  GENERATE_SERIES(1, 10) AS A(x)

# Lookup join on covering secondary index
query TTT colnames
EXPLAIN SELECT t1.a, t2.c FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
Tree            Field           Description
render          ·               ·
 └── join       ·               ·
      │         type            inner
      │         equality        (a) = (b)
      │         mergeJoinOrder  +"(a=b)"
      ├── scan  ·               ·
      │         table           multiples@primary
      │         spans           ALL
      └── scan  ·               ·
·               table           multiples@bc
·               spans           ALL

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT t1.a, t2.c FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJy8lM1qg0AUhfd9inDXU-Ko-XOVbUpJSuiuuDDOJdiauTIzQkvw3YtaGg3JKERczs-Z73DOcM8gSeA2OqGG4AM4MHCBgQcMfGAwg5BBpihGrUmVV2rBRnxD4DBIZJabcjtkEJNCCM5gEpMiBPAeHVLcYyRQTR1gINBESVphMpWcIvWzPuWpSbIUNTDY5SaYrDmEBQPKzeVdbaIjQsAL1p_9Qon8Q8_a6EPcor4SfeXZ5JMSOSFZGfi3wtb-XTfuXTcXE7kkJVChaDkIixt-t_RM2ZQ7Vzdvs70Wm_dvgQ_dQge70cJ8hBbc_km4QyfRwW4ksRghCa9_Et7QSXSwG0ksR0jC75-EP3QSHexGEquRZ9QNN3vUGUmNvSaQU84wFEesB56mXMX4piiuMPVyV-mqDYHa1Ke8XmxkfVQabIq5Vey2xPxa7NrJHWjPqvbtYv8R3zOreG4nzx8hL6zipZ28fIS8snfldHwT-ye7ZofF028AAAD__2gv7bk=

query II rowsort
SELECT t1.a, t2.c FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
2   3
4   6
6   9
8   12
10  15

# Lookup join on non-covering secondary index
# The index join should be subsumed by joinreader, which takes care of the
# primary index lookups.
query TTT colnames
EXPLAIN SELECT t1.a, t2.d FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
Tree                  Field           Description
render                ·               ·
 └── join             ·               ·
      │               type            inner
      │               equality        (a) = (b)
      │               mergeJoinOrder  +"(a=b)"
      ├── scan        ·               ·
      │               table           multiples@primary
      │               spans           ALL
      └── index-join  ·               ·
           ├── scan   ·               ·
           │          table           multiples@bc
           │          spans           ALL
           └── scan   ·               ·
·                     table           multiples@primary

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT t1.a, t2.d FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJy8lM2LqzAUxffvryh3nUeNH_1w1W0fj3YosxtcWHMpzthcSSLMUPzfB3WYammjUHGZj5Pf4ZxwLyBJ4C4-o4bwDTgwcIGBBwx8YBBAxCBXlKDWpKorjWArPiF0GKQyL0y1HTFISCGEFzCpyRBCeI2PGR4wFqjmDjAQaOI0qzG5Ss-x-tqci8ykeYYaGOwLE842HKKSARXm-q428Qkh5CUbzv5HqfxBB130MelQ_xN9FPnsnVI5I1kb-LXCNsFDN-5DN1cThSQlUKHoOIjKO3539JfyOXdubt5nex02H94CH7uFHnarhcUELbjDk3DHTqKH3UpiOUES3vAkvLGT6GG3klhNkIQ_PAl_7CR62K0k1hPPqDtuDqhzkhoHTSCnmmEoTtgMPE2FSvBFUVJjmuW-1tUbArVpTnmz2MrmqDLYFnOr2O2I-a3YtZN70J5V7dvF_jO-A6t4YScvniEvreKVnbx6hry2d-X0fBP7J7tlR-Wf7wAAAP__gsjtvg==

query II rowsort
SELECT t1.a, t2.d FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
2   4
4   8
6   12
8   16
10  20

############################
#  LEFT OUTER LOOKUP JOIN  #
############################
statement ok
create table t (a int primary key, b int, c int, d int, index bc (b, c));

statement ok
insert into t values
  (1, 10, 100, 1000),
  (2, 10, 200, 2000),
  (3, 20, 300, 3000)

# Left join against primary index
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, a FROM (VALUES (1), (3)) AS v(x) LEFT JOIN t ON x = a]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkEFLAzEQhe_-ivBOCoF2F085Ld4qYqUHL7KHsBlq7DazZBJQyv53yeagFSp6y7yZN-_LnBDY0aM9ksC8oEGvMUUeSIRjkerAxr3DrDV8mHIqcq8xcCSYE5JPI8Hg2Y6ZZLWGhqNk_bhsvFV36rpVw2sOB7lBP2twTl9bJNk9waxn_feke_ZhR9ZRXDXnaVP0Rxs_ugSNB-ZDntQb-6A4GNWV2W1O5aW79iJK8x-UHcnEQegM4_Inew1ye6qHFc5xoKfIwxJTy-3iWwRHkmq3qcUm1FYB_G5ufjW3P8z9fPUZAAD__98zpCo=

query II rowsort
SELECT x, b FROM (VALUES (2), (99)) AS v(x) LEFT JOIN t ON x = a
----
2 10
99 NULL

# Left join against covering secondary index
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, c FROM (VALUES (1), (10)) AS v(x) LEFT JOIN t@bc ON x = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkEFLAzEQhe_-ivBOCoHulp5yWrxVxEoPXmQPazLU2DWzZBIQyv53yeagFSp6y7yZN-_LnBDY0cPwTgLzjBa9xhTZkgjHItWBrfuAaTR8mHIqcq9hORLMCcmnkWDwNIyZZNVAw1Ea_Lhs3Khbdb1W9jWHo9ygnzU4p68tkoYDwTSz_nvSHfuwp8FRXLXnaS-2S9C4Zz7mSb2xD4qDUV0Z2-VUXrrbXKRo_0OxJ5k4CJ0RXP5fr0HuQPWmwjlaeoxsl5ha7hbfIjiSVLttLbahtgrgd3P7q3n9w9zPV58BAAD__wJNoe0=

query II rowsort
SELECT x, c FROM (VALUES (1), (10)) AS v(x) LEFT JOIN t@bc ON x = b
----
1 NULL
10 100
10 200

# Left join against non-covering secondary index
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, d FROM (VALUES (1), (10)) AS v(x) LEFT JOIN t@bc ON x = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkDFLBDEQhXt_RXiVQuB2D21SLXYn4skVNrLFmgxnvDWzZBIQjv3vkk2hJ5xol3kzb96XOSKwo4fhnQTmGS16jSmyJRGORaoDG_cB02j4MOVU5F7DciSYI5JPI8HgaRgzyaqBhqM0-HHZeK1u1eVa2dccDnKFftbgnL62SBr2BNPM-u9Jd-zDjgZHcdWepr3YLkHjnvmQJ_XGPigORnVlbJtTeenu5ixF-x-KHcnEQeiE4Pz_eg1ye6o3Fc7R0mNku8TUcrv4FsGRpNpta7EJtVUAv5vbX83rH-Z-vvgMAAD__wNKoe4=

query II rowsort
SELECT x, d FROM (VALUES (1), (10)) AS v(x) LEFT JOIN t@bc ON x = b
----
1 NULL
10 1000
10 2000

# Left join with ON filter on covering index
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, c FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b AND c < 300]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkEFLAzEQhe_-ivBOCoHulp5yWrxVxEoPXmQPazLU2DWzZBIQyv53yeagFSp6y7yZN-_LnBDY0cPwTgLzjBa9xhTZkgjHItWBrfuAaTR8mHIqcq9hORLMCcmnkWDwNIyZZNVAw1Ea_Lhs3Khbdb1W9jWHo9ygnzU4p68tkoYDwTSz_nvSHfuwp8FRXLXnaS-2S9C4Zz7mSb2xD4qDUV0Z2-VUXrrbXKRo_0OxJ5k4CJ0RXP5fr0HuQPWmwjlaeoxsl5ha7hbfIjiSVLttLbahtgrgd3P7q3n9w9zPV58BAAD__wJNoe0=

query II rowsort
SELECT x, c FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b AND c < 200
----
10 100
20 NULL

# Left join with ON filter on non-covering index
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, d FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b AND d < 3000]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkDFLBDEQhXt_RXiVQuB2D21SLXYn4skVNrLFmgxnvDWzZBIQjv3vkk2hJ5xol3kzb96XOSKwo4fhnQTmGS16jSmyJRGORaoDG_cB02j4MOVU5F7DciSYI5JPI8HgaRgzyaqBhqM0-HHZeK1u1eVa2dccDnKFftbgnL62SBr2BNPM-u9Jd-zDjgZHcdWepr3YLkHjnvmQJ_XGPigORnVlbJtTeenu5ixF-x-KHcnEQeiE4Pz_eg1ye6o3Fc7R0mNku8TUcrv4FsGRpNpta7EJtVUAv5vbX83rH-Z-vvgMAAD__wNKoe4=

query II rowsort
SELECT x, d FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b AND d < 2000
----
10 1000
20 NULL

# Left join with ON filter and WHERE clause
query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) SELECT x, d FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b WHERE d < 2000]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyUkE9LAzEQxe9-ivBOCoFmq73ktHgQVqSVIl50D2sy1Ng1s-QPCGW_u-zmoBUqepw37837JQd4trTu3ilCP6FCKzEENhQjh0kqhsZ-QCsJ54ecJrmVMBwI-oDkUk_QeOz6THGhIGEpda6fL16Ja3G-FOY1-328QDtKcE5fV2LqdgStRvn3plt2fkudpbCojtteTJ0gcce8z4N4Y-cFey3qyXbj-kRBi3olnrNSl0YslVJa62b9AIlNTpNR1quTkNV_ILcUB_aRjgBPP7-VILuj8uWRczB0H9jMNWXczLlZsBRT2VZlaHxZTYDfw9Wv4eWPcDuefQYAAP__3zip9Q==

query II rowsort
SELECT x, d FROM (VALUES (10), (20)) AS v(x) LEFT JOIN t@bc ON x = b WHERE d < 2000
----
10 1000
