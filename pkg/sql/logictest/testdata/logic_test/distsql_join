# LogicTest: 5node-distsql

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM GENERATE_SERIES(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data TESTING_RELOCATE
  SELECT ARRAY[i%5+1], i FROM GENERATE_SERIES(0, 9) AS g(i)

# Generate all combinations of values 1 to 10.
statement ok
INSERT INTO data SELECT a, b, c, d FROM
   GENERATE_SERIES(1, 10) AS A(a),
   GENERATE_SERIES(1, 10) AS B(b),
   GENERATE_SERIES(1, 10) AS C(c),
   GENERATE_SERIES(1, 10) AS D(d)

# Verify data placement.
query TTITI colnames
SHOW TESTING_RANGES FROM TABLE data
----
Start Key  End Key  Range ID  Replicas  Lease Holder
NULL       /1       1         {1}       1
/1         /2       2         {2}       2
/2         /3       3         {3}       3
/3         /4       4         {4}       4
/4         /5       5         {5}       5
/5         /6       6         {1}       1
/6         /7       7         {2}       2
/7         /8       8         {3}       3
/8         /9       9         {4}       4
/9         NULL     10        {5}       5

statement ok
SET CLUSTER SETTING sql.distsql.merge_joins.enabled = true;

# ensure merge joins are planned when there's orderings.
query ITTTTT
EXPLAIN (VERBOSE) (SELECT * FROM (SELECT a,b FROM data) NATURAL JOIN (SELECT a,b FROM data AS data2))
----
0  render  ·               ·                  (a, b)                          a!=NULL; b!=NULL
0  ·       render 0        a                  ·                               ·
0  ·       render 1        b                  ·                               ·
1  join    ·               ·                  (a, b, a[omitted], b[omitted])  a=a; b=b; a!=NULL; b!=NULL
1  ·       type            inner              ·                               ·
1  ·       equality        (a, b) = (a, b)    ·                               ·
1  ·       mergeJoinOrder  +"(a=a)",+"(b=b)"  ·                               ·
2  render  ·               ·                  (a, b)                          a!=NULL; b!=NULL; +a,+b
2  ·       render 0        test.data.a        ·                               ·
2  ·       render 1        test.data.b        ·                               ·
3  scan    ·               ·                  (a, b, c[omitted], d[omitted])  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
3  ·       table           data@primary       ·                               ·
3  ·       spans           /!NULL-            ·                               ·
3  ·       filter          b IS NOT NULL      ·                               ·
2  render  ·               ·                  (a, b)                          a!=NULL; b!=NULL; +a,+b
2  ·       render 0        data2.a            ·                               ·
2  ·       render 1        data2.b            ·                               ·
3  scan    ·               ·                  (a, b, c[omitted], d[omitted])  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
3  ·       table           data@primary       ·                               ·
3  ·       spans           /!NULL-            ·                               ·
3  ·       filter          b IS NOT NULL      ·                               ·


# ORDER BY on the mergeJoinOrder columns should not require a SORT node
query ITTTTT
EXPLAIN (VERBOSE) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY c,d)
----
0  join    ·               ·                                    (a, b, c, d)                    a=c; b=d; a!=NULL; b!=NULL; +a,+b
0  ·       type            inner                                ·                               ·
0  ·       equality        (a, b) = (c, d)                      ·                               ·
0  ·       mergeJoinOrder  +"(a=c)",+"(b=d)"                    ·                               ·
1  render  ·               ·                                    (a, b)                          a!=NULL; b!=NULL; +a,+b
1  ·       render 0        data1.a                              ·                               ·
1  ·       render 1        data1.b                              ·                               ·
2  scan    ·               ·                                    (a, b, c[omitted], d[omitted])  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
2  ·       table           data@primary                         ·                               ·
2  ·       spans           /!NULL-                              ·                               ·
2  ·       filter          b IS NOT NULL                        ·                               ·
1  sort    ·               ·                                    (c, d)                          c!=NULL; d!=NULL; +c,+d
1  ·       order           +c,+d                                ·                               ·
2  render  ·               ·                                    (c, d)                          c!=NULL; d!=NULL
2  ·       render 0        data2.c                              ·                               ·
2  ·       render 1        data2.d                              ·                               ·
3  scan    ·               ·                                    (a[omitted], b[omitted], c, d)  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d)
3  ·       table           data@primary                         ·                               ·
3  ·       spans           ALL                                  ·                               ·
3  ·       filter          (c IS NOT NULL) AND (d IS NOT NULL)  ·                               ·

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY c,d)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1Fv2jwUhu-_XxGdK6r6k7ATKI00KZOmSUwdTG13NXGREg8iUYwcI62q-O8TpBtLUvxiGZDgMiRPfHz8nL7pK81VJgfpsywo_kGcGAliFBKjiBh1aMRoodVYFoXS60dKoJ_9orjNKJ8vlmb984jRWGlJ8SuZ3MwkxfSYPs3kvUwzqYlRJk2azzaLLHT-nOqXJEtNSow-5zMjdRwkIug_BIPhYzD4fndHjIZLEwcJZ4mg0YqRWpq3xbZrPL0E07SYVt__BxkxKkw6kRTzFTte3a0k_Lfwq-Dj4FPQSqLKj3-3E7Ikqm1nW6dwqfNBaVMvMeHXLBHXvv0Kd9axfZXSmdQy27n-3k--s7WvUk_kF5XP6_ubyZ-m9YZefdD5ZLq9rBjD7I2O_Df4TtkD9b9aVJ7ftX6nsj4_00E6cN1HGyRQ58kGiV_6IIkzFfnAdR9NZFDnyUQWly5yeKYiH7juo4kM6jyZyOGlixydqcgHrvtoIoM6TyZydOkig3-G7mWxUPNC7vX13V7vR2YTWXarUEs9lt-0Gm-WKS-HG27zzZbJwpR3w_KiPy9vrQvcH-75wFx40V0fWrTtNK_T7Qpdgdt1WDg0XLjBPR-41nBXuutD1xreoENrwyP7aUX20-L24-r4zIcdBvNhh9F8ABrMh51G89G1dvzG3vAbn_mww2A-7DCaD0CD-bDTaD56PvNx62O4HQaG22FkOKCB4XYaJkAjQCod5-CPCm8kiIvkgAaWAxppjnDgOcCR6LyRIy6m80aOuKgOaOA6oJHsCAe2Axzqbs9Q3gG6u4Ro88xdUtSVhro75agrDnW3JynS3SVKXWmku1OYOuNId6c4beL2POW3QHeXRG2euUukutJQd6dQdcWR7sKeqnXdR6v_fgcAAP__BNmiUQ==

# ORDER BY on the columns equal to the mergeJoinOrder columns should not
# require a terminal SORT node.
query ITTTTT
EXPLAIN (VERBOSE) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY a,b)
----
0  join    ·               ·                                    (a, b, c, d)                    a=c; b=d; a!=NULL; b!=NULL; +a,+b
0  ·       type            inner                                ·                               ·
0  ·       equality        (a, b) = (c, d)                      ·                               ·
0  ·       mergeJoinOrder  +"(a=c)",+"(b=d)"                    ·                               ·
1  render  ·               ·                                    (a, b)                          a!=NULL; b!=NULL; +a,+b
1  ·       render 0        data1.a                              ·                               ·
1  ·       render 1        data1.b                              ·                               ·
2  scan    ·               ·                                    (a, b, c[omitted], d[omitted])  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
2  ·       table           data@primary                         ·                               ·
2  ·       spans           /!NULL-                              ·                               ·
2  ·       filter          b IS NOT NULL                        ·                               ·
1  sort    ·               ·                                    (c, d)                          c!=NULL; d!=NULL; +c,+d
1  ·       order           +c,+d                                ·                               ·
2  render  ·               ·                                    (c, d)                          c!=NULL; d!=NULL
2  ·       render 0        data2.c                              ·                               ·
2  ·       render 1        data2.d                              ·                               ·
3  scan    ·               ·                                    (a[omitted], b[omitted], c, d)  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d)
3  ·       table           data@primary                         ·                               ·
3  ·       spans           ALL                                  ·                               ·
3  ·       filter          (c IS NOT NULL) AND (d IS NOT NULL)  ·                               ·

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY a,b)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1Fv2jwUhu-_XxGdK6r6k7ATKI00KZOmSUwdTG13NXGREg8iUYwcI62q-O8TpBtLUvxiGZDgMiRPfHz8nL7pK81VJgfpsywo_kGcGAliFBKjiBh1aMRoodVYFoXS60dKoJ_9orjNKJ8vlmb984jRWGlJ8SuZ3MwkxfSYPs3kvUwzqYlRJk2azzaLLHT-nOqXJEtNSow-5zMjdRwkIug_BIPhYzD4fndHjIZLEwcJZ4mg0YqRWpq3xbZrPL0E07SYVt__BxkxKkw6kRTzFTte3a0k_Lfwq-Dj4FPQSqLKj3-3E7Ikqm1nW6dwqfNBaVMvMeHXLBHXvv0Kd9axfZXSmdQy27n-3k--s7WvUk_kF5XP6_ubyZ-m9YZefdD5ZLq9rBjD7I2O_Df4TtkD9b9aVJ7ftX6nsj4_00E6cN1HGyRQ58kGiV_6IIkzFfnAdR9NZFDnyUQWly5yeKYiH7juo4kM6jyZyOGlixydqcgHrvtoIoM6TyZydOkig3-G7mWxUPNC7vX13V7vR2YTWXarUEs9lt-0Gm-WKS-HG27zzZbJwpR3w_KiPy9vrQvcH-75wFx40V0fWrTtNK_T7Qpdgdt1WDg0XLjBPR-41nBXuutD1xreoENrwyP7aUX20-L24-r4zIcdBvNhh9F8ABrMh51G89G1dvzG3vAbn_mww2A-7DCaD0CD-bDTaD56PvNx62O4HQaG22FkOKCB4XYaJkAjQCod5-CPCm8kiIvkgAaWAxppjnDgOcCR6LyRIy6m80aOuKgOaOA6oJHsCAe2Axzqbs9Q3gG6u4Ro88xdUtSVhro75agrDnW3JynS3SVKXWmku1OYOuNId6c4beL2POW3QHeXRG2euUukutJQd6dQdcWR7sKeqnXdR6v_fgcAAP__BNmiUQ==

# ORDER BY on a different ordering should require a terminal SORT NODE.
query ITTTTT
EXPLAIN (VERBOSE) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY b,a)
----
0  sort    ·               ·                                    (a, b, c, d)                    a=c; b=d; a!=NULL; b!=NULL; +b,+a
0  ·       order           +b,+a                                ·                               ·
1  join    ·               ·                                    (a, b, c, d)                    a=c; b=d; a!=NULL; b!=NULL
1  ·       type            inner                                ·                               ·
1  ·       equality        (a, b) = (c, d)                      ·                               ·
1  ·       mergeJoinOrder  +"(a=c)",+"(b=d)"                    ·                               ·
2  render  ·               ·                                    (a, b)                          a!=NULL; b!=NULL; +a,+b
2  ·       render 0        data1.a                              ·                               ·
2  ·       render 1        data1.b                              ·                               ·
3  scan    ·               ·                                    (a, b, c[omitted], d[omitted])  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
3  ·       table           data@primary                         ·                               ·
3  ·       spans           /!NULL-                              ·                               ·
3  ·       filter          b IS NOT NULL                        ·                               ·
2  sort    ·               ·                                    (c, d)                          c!=NULL; d!=NULL; +c,+d
2  ·       order           +c,+d                                ·                               ·
3  render  ·               ·                                    (c, d)                          c!=NULL; d!=NULL
3  ·       render 0        data2.c                              ·                               ·
3  ·       render 1        data2.d                              ·                               ·
4  scan    ·               ·                                    (a[omitted], b[omitted], c, d)  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d)
4  ·       table           data@primary                         ·                               ·
4  ·       spans           ALL                                  ·                               ·
4  ·       filter          (c IS NOT NULL) AND (d IS NOT NULL)  ·                               ·

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d ORDER BY b,a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1Fr2z4Uxd__n8Lcp5bqD5HsdK1h4MEYdHTpaLunkQc31lJDGgVZgZXS7z4Sd83sJDqxbxJIHh37-Fwf6ecTv9DYZLqXPumC4p8kSZAiQSEJikhQl_qCJtYMdFEYO7ukFFxlvynuCMrHk6mb_dwXNDBWU_xCLncjTTHdpw8jfavTTFsSlGmX5qO5ycTmT6l9TrLUpSToSz5y2sZBooKru6B3cx_0flxfk6CbqYuDRIpEUf9VkJm6N7OFx8Nz8JgWj9X7_5X0BRUuHWqK5avY3dwnSfjv4KfBp97n4CSJKj--P04okqj2OIs5VZM574x19RETeSYSdcbNK1w7x-JWxmba6myt_8ZXrni0b9oO9VeTj-vPN9K_3Mmb9PSjzYePi8PKjhH-oCN20OpMJLIe9MKg2zrB9xuvmKRn_jeTyvXr_M8r_vJASd3y3DsjFcy5N1LlsZPaJuhGpKoDJWXLc--MFDDn3khRx05Km6AbkRIeKClbnntnpIA590ZKeOyktAm6ESnRgZKy5bl3RgqYc2-kRMdOSpugW38nrTC41cXEjAu90RdQZxaYzoa6XI7CTO1Af7dmMLcpD2_muvnfykwXrjwblgdX4_LUbMDNxZccsYxYapa3At6yru5U1BVxpy5WDQJXzcSXHHEt8KZqlrcC3qE38MgfeOQVd_1L3fUv9bnf-pwDl18MNrhfjOACapY3guuDN_ELf-AXHLj8YrDB_WIEF1CzvBFcl97AZcefuFx6lTbBSy69SpsQAtRgmwI1YgTJee6wgpZeqNVVC8GqLb1Rm4AC1GC3AjVCBcl57ggW6W8T2QW5-_sE0cLqE6BG-5XXKEjOc4e0-EtFglaRrFoBarRfecWC5Dx3SIu_WxToFsXqFsXqFqAG-xWoES1IznNHtCh_tyjQLYrVLUCNPjN43YLkPHdEi_J3iwLdopp1S__1vz8BAAD__0C7plQ=

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c and b=d ORDER BY a,b)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1Fv2jwUhu-_XxGdK6r6k7ATKI00KZOmSUwdTG13NXGREg8iUYwcI62q-O8TpBtLUvxiGZDgMiRPfHz8nL7pK81VJgfpsywo_kGcGAliFBKjiBh1aMRoodVYFoXS60dKoJ_9orjNKJ8vlmb984jRWGlJ8SuZ3MwkxfSYPs3kvUwzqYlRJk2azzaLLHT-nOqXJEtNSow-5zMjdRwkIug_BIPhYzD4fndHjIZLEwcJZ4mg0YqRWpq3xbZrPL0E07SYVt__BxkxKkw6kRTzFTte3a0k_Lfwq-Dj4FPQSqLKj3-3E7Ikqm1nW6dwqfNBaVMvMeHXLBHXvv0Kd9axfZXSmdQy27n-3k--s7WvUk_kF5XP6_ubyZ-m9YZefdD5ZLq9rBjD7I2O_Df4TtkD9b9aVJ7ftX6nsj4_00E6cN1HGyRQ58kGiV_6IIkzFfnAdR9NZFDnyUQWly5yeKYiH7juo4kM6jyZyOGlixydqcgHrvtoIoM6TyZydOkig3-G7mWxUPNC7vX13V7vR2YTWXarUEs9lt-0Gm-WKS-HG27zzZbJwpR3w_KiPy9vrQvcH-75wFx40V0fWrTtNK_T7Qpdgdt1WDg0XLjBPR-41nBXuutD1xreoENrwyP7aUX20-L24-r4zIcdBvNhh9F8ABrMh51G89G1dvzG3vAbn_mww2A-7DCaD0CD-bDTaD56PvNx62O4HQaG22FkOKCB4XYaJkAjQCod5-CPCm8kiIvkgAaWAxppjnDgOcCR6LyRIy6m80aOuKgOaOA6oJHsCAe2Axzqbs9Q3gG6u4Ro88xdUtSVhro75agrDnW3JynS3SVKXWmku1OYOuNId6c4beL2POW3QHeXRG2euUukutJQd6dQdcWR7sKeqnXdR6v_fgcAAP__BNmiUQ==


# Merge joins should be planned for (FULL|LEFT|RIGHT) OUTER joins

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) FULL OUTER JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c and b=d ORDER BY a,b)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1GL2kAUhd_7K5b71LJTcCZxuwYKed1Cd8u2b8WHrJlqwHVkEqHL4n8vmi2SaO5xuFkRH6P5cm5uzsnRV1q43N5nz7ak5DdpUmRIUUSKYlI0pLGipXcTW5bOb06pgbv8LyUDRcViuao2H48VTZy3lLxSVVRzSwn9yp7m9tFmufWkKLdVVsy3IktfPGf-Jc2zKiNFD6squUq1Sg2N14rcqnq75u5STy9Xs6ycNS_zHxkrKqtsainRa_Ve40UqjVvj7XRNiO5P56u2ZKqvVWqupfcfdc6xu5TzufU279Q_-swDt_bd-qn95opF-_7m9k_18Q399NUX09nusOEAxS86fp9F7wSG8g0emOTefXbLxvld-jcNfX3eAet1vICAAd2TBUxfesB6W3RXwMx5G7zX8QIMDnRPZnBz6QbvbdFdBo_O2-C9jhdgcKB7MoNHl27w3hbdZfD4vA3e63gBBge6JzN4fOkG723Rx_wHOCDwaMulW5T2qF_3g83CbD619eMo3cpP7A_vJluZ-vBhy21_e-W2rOpvo_rgblF_tRnweHgkgXUsokXaBmjrNj1o0A140IZNwMJNGDySwK2Fh9IibQO0I3bhMb_wmIWH_KMe8o_6hpe-kYSLh4HBeRiFC9AibRSuL-zGb_mF30rCxcPA4DyMwgVokTYK14hduB7wG9d7r9KQeOm9V2lIQgANbApolBGEy9RhBe29UJtPLQJPbe-NGhIUQAO3AhpFBeEydRQWzbeJHoK9832C0iLqE0Ajv8oaBeEydZgWvlQ0aBUtqhVAI7_KigXhMnWYFr5bDOgWI-oWI-oWQAO_AhqlBeEydZQWw3eLAd1iRN0CaPQ3Q9YtCJepo7QYvlsM6BYT1i3j9Yd_AQAA__8TJkfW

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) LEFT OUTER JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c and b=d ORDER BY a,b)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl1Fr2z4Uxd__n8Lcp5bqD5HsdK1h4MEYdHTpaLunkQc31lJDGgVZgZWS7z4Sdwt2Yp2Y64SQR8c-PtdH-vnEbzQ1mR6kL7qg-CdJEqRIUEiCIhLUp6GgmTUjXRTGLi8pBTfZb4p7gvLpbO6WPw8FjYzVFL-Ry91EU0yP6dNE3-s005YEZdql-WRlMrP5S2pfkyx1KQm6m7s4SKRIFA0Xgszcvd9zfaun1-A5LZ6rt_krGQoqXDrWFMuF6H68L_nEaRsHZ0kY3DwEg7vHYPDj9vY8-DT4HJwlUeXHf48TiiSqPc56TtVmzgdjXX3ERF6IRF1w8wob51jfythMW501-u985ZZH-6btWH81-bT-fBP9y529S88_2nz8vD6s7BjhDzraT9Brgz4_wS2TDMz_Zla5vsn_suIvjxvIjsbbO5BgzoMBKU8dyM6CbgJSHTcQHY23dyDAnAcDQp06EJ0F3QREeNxAdDTe3oEAcx4MiPDUgegs6CYgouMGoqPx9g4EmPNgQESnDkRnQe_yDbPF4F4XMzMt9E5fJ71lYDob63I5CjO3I_3dmtHKpjy8W-lW_wUzXbjybFge3EzLU8sBdxdfc8QyYqlZ3gp4y7q6V1FXxL26WLUIXLUTX3PEtcDbqlneCniH3sAjf-CRV9z3L3Xfv9SXfutLDlx-MdjgfjGCC6hZ3giuD97Er_yBX3Hg8ovBBveLEVxAzfJGcF17A5c9f-Jy41XaBi-58SptQwhQg20K1IgRJOe5wwraeKFWVy0Eq7bxRm0DClCD3QrUCBUk57kjWKS_TWQf5O7vE0QLq0-AGu1XXqMgOc8d0uIvFQlaRbJqBajRfuUVC5Lz3CEt_m5RoFsUq1sUq1uAGuxXoEa0IDnPHdGi_N2iQLcoVrcANfrM4HULkvPcES3K3y0KdItq1y3DxX9_AgAA__9xl4Ri

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b FROM data AS data1) RIGHT OUTER JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c and b=d ORDER BY a,b)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzcl0Fr204UxO__TyHe6V-yBe9KThNBQadCSuqUJD0VHxRr6wgcr1mtoSH4uxdbKUaytePlqQb76Fg_z9PbGU30RnNT6FH-oitKf5IkQYoExSQoIUFDGgtaWDPRVWXs-pIauCl-UzoQVM4XS7f-81jQxFhN6Ru50s00pfSYP830vc4LbUlQoV1ezjYiC1u-5PY1K3KXk6Av5cxpm0aZim4eotHdYzT6cXtLgu6WLo0yKTJF45Ugs3TvYluNp9foOa-em7__FxkLqlw-1ZTKleh_7nq8WGRJa7ytrgrRfTDWtSUzeSEydcG9_7hzju1PGVtoq4tO_YOv3HNr37Sd6q-mnLfvb6Z_uf_f0Q-fbTl93n5sOED4F538m0VvBYb8De6ZZGQ-mkXj-i79y4a-PNHk9TR3cPKA7tGSJ889eb0tuit56kSd39Pcwc4Hukdzvjp35_e26C7nxyfq_J7mDnY-0D2a8-Nzd35vi-5yfnKizu9p7mDnA92jOT85d-f3tuhD3jP2CNzramHmlT7oDWKwXpgupro-jsos7UR_t2aykak_3m24zb9xha5c_W1cf7iZ11-tBzwcvubAMmHRLG0FtGWbHjToBjxowypg4SoMvubArYWH0ixtBbRj78IT_8ITLzz0H_XQf9SXfulLTrj8MDC4H0bhAjRLG4Xrk3fjV_6FX3HC5YeBwf0wChegWdooXNfehcuBf-Ny51EaEi-58ygNSQiggU0BjTKCcJ46rKCdB2rz1GJwajtP1JCgABq4FdAoKgjnqaOwSH-byCHYu79PUFpYfQJo5FdeoyCcpw7T4i8VCVpFsmoF0MivvGJBOE8dpsXfLQp0i2J1i2J1C6CBXwGN0oJwnjpKi_J3iwLdoljdAmj0msHrFoTz1FFalL9bFOgWFdYt49V_fwIAAP__9NppyA==


# Nested merge joins should be planned on the same ordering
query ITTTTT
EXPLAIN (VERBOSE) (SELECT a,b from data AS data3 NATURAL JOIN ((SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d))
----
0  render  ·               ·                                                          (a, b)                                                                          a!=NULL; b!=NULL
0  ·       render 0        data3.a                                                    ·                                                                               ·
0  ·       render 1        data3.b                                                    ·                                                                               ·
1  join    ·               ·                                                          (a, b, c[omitted], d[omitted], a[omitted], b[omitted], c[omitted], d[omitted])  a=c=a=c; b=d=b=d; a!=NULL; b!=NULL
1  ·       type            inner                                                      ·                                                                               ·
1  ·       equality        (a, b, c, d) = (a, b, c, d)                                ·                                                                               ·
1  ·       mergeJoinOrder  +"(a=a)",+"(b=b)",+"(c=c)",+"(d=d)"                        ·                                                                               ·
2  scan    ·               ·                                                          (a, b, c, d)                                                                    a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b,+c,+d
2  ·       table           data@primary                                               ·                                                                               ·
2  ·       spans           /!NULL-                                                    ·                                                                               ·
2  ·       filter          (b IS NOT NULL) AND ((c IS NOT NULL) AND (d IS NOT NULL))  ·                                                                               ·
2  join    ·               ·                                                          (a, b, c, d)                                                                    a=c; b=d; a!=NULL; b!=NULL; +a,+b
2  ·       type            inner                                                      ·                                                                               ·
2  ·       equality        (a, b) = (c, d)                                            ·                                                                               ·
2  ·       mergeJoinOrder  +"(a=c)",+"(b=d)"                                          ·                                                                               ·
3  render  ·               ·                                                          (a, b)                                                                          a!=NULL; b!=NULL; +a,+b
3  ·       render 0        data1.a                                                    ·                                                                               ·
3  ·       render 1        data1.b                                                    ·                                                                               ·
4  scan    ·               ·                                                          (a, b, c[omitted], d[omitted])                                                  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d); +a,+b
4  ·       table           data@primary                                               ·                                                                               ·
4  ·       spans           /!NULL-                                                    ·                                                                               ·
4  ·       filter          b IS NOT NULL                                              ·                                                                               ·
3  sort    ·               ·                                                          (c, d)                                                                          c!=NULL; d!=NULL; +c,+d
3  ·       order           +c,+d                                                      ·                                                                               ·
4  render  ·               ·                                                          (c, d)                                                                          c!=NULL; d!=NULL
4  ·       render 0        data2.c                                                    ·                                                                               ·
4  ·       render 1        data2.d                                                    ·                                                                               ·
5  scan    ·               ·                                                          (a[omitted], b[omitted], c, d)                                                  a!=NULL; b!=NULL; c!=NULL; d!=NULL; key(a,b,c,d)
5  ·       table           data@primary                                               ·                                                                               ·
5  ·       spans           ALL                                                        ·                                                                               ·
5  ·       filter          (c IS NOT NULL) AND (d IS NOT NULL)                        ·                                                                               ·

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT * FROM (SELECT a,b from data AS data3 NATURAL JOIN ((SELECT a,b FROM data AS data1) JOIN (SELECT c,d FROM data AS data2 ORDER BY c,d) ON a=c AND b=d)))]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzsmN9r6kgUx9_3rwjnydJZcCbxR4WFLCwLXbp2abtPiw-pmbWCNZJEuKX0f7-ovfUmsefr6cQ8qI9GP-acM5NPvswrzZPYDqNnm9HgP9KkyJAinxQFpKhDI0WLNBnbLEvS1U82wHX8jQZtRdP5YpmvLo8UjZPU0uCV8mk-szSgh-hxZu9sFNuUFMU2j6az9U0W6fQ5Sl_COMojUvTndJbbdOC1QuNd33vD2wdv-O_NzYX3-_APr9UK_R1Xw6Bw8YIU3S7zgRdqFRoV-ioMaPSmKFnm7wVu63p88Z6i7KlYUxEcKcryaGJpoN_U4TouNlzo4QvVF-o2h6x7rzX5aGfHYmzr9CV13idpXi4x1JcqNJeu8wo-rWP7V0ka29TGn95_71_uaO1vm07sX8l0Xu5vZv_PW-_oxW_pdPK0_XiwXd9xnIYK_UsVBoKp_ER8dTo__qI0pY_L3PO1bb27R-vL-a5WdlY-TH5NFqWf7b5xr3BjfXJurbnjxtxa-0odyK2gzsbcqs9udZrG0bjVnJziau64McXVvlIHUhyoszHFmbPinKZxNIrzT05xNXfcmOJqX6kDKQ7U2Zji_LPinKZxNIoLTk5xNXfcmOJqX6kDKQ7U2ZjigrPinKZxNIoDp9J3Nlsk88zudcrXXnVm44ndzDFLlunY_pMm4_VtNh9v19z6bCC2Wb75trP5cD3ffLUqcH9YGye670KbwIX22zytWRrcmoe1dqJ7LrTxnegrnjZlul0YeQFul2FfMHEjg0sTl9I9F7o0cSl9xdOB4NkWwqVnW0r3XWgDlpunS892he6w27TL7_Euv8c1v8l7Li7mYeRiQAMX8zRyMU8jF_ddXMzDyMWABi7maeRiQAMXX7H7VLf5far5tyd4PAGNdIxw4GOAIyEjHBhZ869QoGRAIycjHEgZ4MjKAEda1nx8AF7W_IsUqBXQyK0IB3IFOLIrwGHU5d-m6OYgB6CwC3CUdkGOQHEX4MCxmk8SugskW8kSIsnyNJQswJFkeRxKFuBIspIcJaWhZEVJSopDyYqyVBWvpAqRZCupQiRZnoaSBTiSLI9DyfI4kqyRBCopjSSLcCBZgCPJIhwdKlRSRWHHGsNL1lRShUSygEaSRTiQLMCRZBEOJGskiUpKI8kiHEgW4EiyAEeSNZVYIZGsqaQKiWQBjSSLcCBZgCPJAhxKVhKopDSUrChQSXEoWVGgquKVVFGUbB9IVnJEU31cRGc0YhxJVnRKI8aRZCWJSkpDyYoSlRSHkhUlqurBeSVWsJIdvf3yPQAA__-cAdYX


# Test that the distSQL MergeJoiner follows SQL NULL semantics for ON predicate equivilance.
# The use of sorts here force

statement ok
CREATE TABLE distsql_mj_test (k INT, v INT)

statement ok
INSERT INTO distsql_mj_test VALUES (0, NULL), (0, 1), (2, 4), (NULL, 4)

# If SQL NULL semantics are not followed, NULL = NULL is truthy. This makes the rows with NULL also appear in the inner join.

query IIII rowsort
SELECT l.k, l.v, r.k, r.v FROM (SELECT * FROM distsql_mj_test ORDER BY k, v) l INNER JOIN (SELECT * FROM distsql_mj_test ORDER BY k, v) r ON l.k = r.k AND l.v = r.v
----
0  1  0  1
2  4  2  4

statement ok
DELETE FROM distsql_mj_test WHERE TRUE;

statement ok
INSERT INTO distsql_mj_test VALUES (0, NULL), (1, NULL), (2, NULL)

# We should not have any results for values with NULLs
query IIII rowsort
SELECT l.k, l.v, r.k, r.v FROM (SELECT * FROM distsql_mj_test ORDER BY k, v) l INNER JOIN (SELECT * FROM distsql_mj_test ORDER BY k, v) r ON l.k = r.k AND l.v = r.v
----

statement ok
DELETE FROM distsql_mj_test WHERE TRUE;

statement ok
INSERT INTO distsql_mj_test VALUES (NULL)

# We shouldn't expect a row of (NULL, NULL), otherwise NULL = NULL was joined.
query II rowsort
SELECT l.k, r.k FROM (SELECT * FROM distsql_mj_test ORDER BY k) l INNER JOIN (SELECT * FROM distsql_mj_test ORDER BY k) r ON l.k = r.k
----

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL) (SELECT l.k, r.k FROM (SELECT * FROM distsql_mj_test ORDER BY k) l INNER JOIN (SELECT * FROM distsql_mj_test ORDER BY k) r ON l.k = r.k)]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJzMk0FL-0AQxe__TxHm9Jeu0E2bHgJCTkKlptLWk5QSs2NcSbNxdgJK6XeXJIe2wWztQfCWnZ3fm_eWzA4KozBOtmghfAIJAgJYCyjJpGitobrcNk3VB4RDAbooK67LawGpIYRwB6w5RwghNtemBAEKOdF507QXYCo-IJaTDCGc7MWRrHTLrpLnHBeYKKQTcShJbxP6jJS2bN_zzfZtw2gZBNzqnJFCL5LedOnF85UXP85mIGBecV2FPmPyEmNLQ9z1FMlBr7j_V1OPfjP1uFf8oFkVhhQSqu7fc77lG4f3SBneGV10beb4wv8jObi6IZ29tp-H5xGR3xsiOAlxZg8WaEtTWPzRKgzrBKgybF_EmopSfCCTNmPa47zhmoJCy-3tpD1Mi_aqNngMSyfsu2HfCQcnsOzCIyc8dk8eXzDZ78KBEx52Jq_3_74CAAD__xX1pfg=
