# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 6 (48 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 4
                  KV rows read: 4
                  KV bytes read: 32 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMleFO40YQx7_3KUbzBVBdZdc2adiqUgqYNm0hyIlaoTpCiz0NFrbX7G5aI5THuhe4JzvZJhwhirnc3YfLh41mZv-bmd_Mbh7R3GcocBL8GZxM4Q7OwvE5zEldW3mTEfz9WxAGYOx1WljShmJr9vcm4ej0Z7d_xAc_XY5HF9N9nzHGPGi-mHewJ8Svwfg8mIZXTn1WfgDj8DQI4fgK7tDBQiV0IXMyKP5BjjMHS61iMkbp2vXYbBglFQrmYFqUC1u7Zw7GShOKR7SpzQgFTuscQ5IJ6R5DBxOyMs2aY59LGNYJXKdFQhU6OCllYQT0IjyOourfJIoqzqKoYm8t-MOuGh4hyCIBj4Gyt6QNOvjHX2DTnASw9--e7FgVlgqbqmIjpNX_BjTJRIDfem4eLK1cngvH6OCNtPEtGVALWy6sgJpDI1w5fJwtHWytJ47Gyjmh4Evn01mPiv9IW0rO0sySJt3j68BX8aAqNagChlyAqWmDsVJb0dDzfjyMIuayKGLsrQWBimRXWQ19g_q4xjCs820KbLi2SFvbWJll6_Sponix2ZRcVpBTrvQDyCxTsbSUCGBNI3JZpfkiB3OfgaW8hCQ1d7Awck6rLW_2yt3aK3eXXv2u0uLpWrjbrkWp01zqh494nKH7ipDbReizR9ndHGXeb_Bsgf4F1LxdqD1PtrfOrPWL168g44zX753L3H7_iL38nPR_4QOft8aADfjA9wOf74mXD-PQPdg6m53kvz4mfxdME6Ut6Z6_DmnIv_8Wr83hLpWFZEpVGFqrbNvJbDlzkJI5tX9ZRi10TJdaxc3PtOa40TWOhIxto7w1RkUbqhN8KeadYrdb7HaKvW6x1yn2u8V-p_jwlXi2_O5DAAAA__-h_7qw

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMleFO20gQx7_fU4zmC6DzKbu2yYU9nZQDzF2uhSAnaoXqCC32NFjYXrO7aY1QHqsv0CerbBNKQLiNaKX6w1ozs__1zG9217dorjMUOAleBwdTuIKjcHwMc1LnVl5kBG__C8IAjD1PC0vaUGzN9tYkHB3-7fb3-OCv0_HoZLrtM8aYB82LeTtbQvwbjI-DaXjm1GvlOzAOD4MQ9s_gCh0sVEInMieD4h1ynDlYahWTMUrXrttmwiipUDAH06Jc2No9czBWmlDcok1tRihwWucYkkxI9xg6mJCVadYse1_CsE7gPC0SqtDBSSkLI6AX4X4UVe-TKKqYVw_sGwP-samGRwiySMBjoOwlaYMOvnoDNs1JAPv86c6OVWGpsKkqnoS0-mhAk0wEuK3n4sbSysX7sI8OXkgbX5IBtbDlwgqoOTTClcPF2dLB1rrjaKycEwq-dL6f9aj4QNpScpRmljTpHl8HvooHValBFTDkAkxNG4yV2oqGnvfnbhSxmh6rIXUOCFQkm8pq6E-oj2sMwzrfpsCGa4u0tY2VWbZOnyqKF0-bkssKcsqVvgGZZSqWlhIBrGlELqs0X-RgrjOwlJeQpOYKFkbOaTXlBb1yN-nV_yot7o6F-9yxKHWaS33zFY8zdDch9BO28jPQX0DN24Ta_c721pm1fvH4FmSc8fq-c5nb7--xh89B_x8-8HlrDNiAD3w_8PmWeHgxDt2dH7o3X4DJ3wTTRGlLuuevQxry33_FY7O7SWUhmVIVhtYqe25ltpw5SMmc2l-WUQsd06lWcfOZ1hw3usaRkLFtlLfGqGhDdYIPxbxT7HaL3U6x1y32OsV-t9jvFO8-Es-Wv30JAAD__7LkurI=

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMleFO20gQx7_fU4zmC6DzKbu2yYU9nZQDzF2uhSAnaoXqCC32NFjYXrO7aY1QHqsv0CerbBNKQLiNaKX6w1ozs__1zG9217dorjMUOAleBwdTuIKjcHwMc1LnVl5kBG__C8IAjD1PC0vaUGzN9tYkHB3-7fb3-OCv0_HoZLrtM8aYB82LeTtbQvwbjI-DaXjm1GvlOzAOD4MQ9s_gCh0sVEInMieD4h1ynDlYahWTMUrXrttmwiipUDAH06Jc2No9czBWmlDcok1tRihwWucYkkxI9xg6mJCVadYse1_CsE7gPC0SqtDBSSkLI6AX4X4UVe-TKKqYVw_sGwP-samGRwiySMBjoOwlaYMOvnoDNs1JAPv86c6OVWGpsKkqnoS0-mhAk0wEuK3n4sbSysX7sI8OXkgbX5IBtbDlwgqoOTTClcPF2dLB1rrjaKycEwq-dL6f9aj4QNpScpRmljTpHl8HvooHValBFTDkAkxNG4yV2oqGnvfnbhSxmh6rIXUOCFQkm8pq6E-oj2sMwzrfpsCGa4u0tY2VWbZOnyqKF0-bkssKcsqVvgGZZSqWlhIBrGlELqs0X-RgrjOwlJeQpOYKFkbOaTXlBb1yN-nV_yot7o6F-9yxKHWaS33zFY8zdDch9BO28jPQX0DN24Ta_c721pm1fvH4FmSc8fq-c5nb7--xh89B_x8-8HlrDNiAD3w_8PmWeHgxDt2dH7o3X4DJ3wTTRGlLuuevQxry33_FY7O7SWUhmVIVhtYqe25ltpw5SMmc2l-WUQsd06lWcfOZ1hw3usaRkLFtlLfGqGhDdYIPxbxT7HaL3U6x1y32OsV-t9jvFO8-Es-Wv30JAAD__7LkurI=
