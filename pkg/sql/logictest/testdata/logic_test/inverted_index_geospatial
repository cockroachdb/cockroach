# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lN9v4kYQx9_7V4zmJUF1xa7tUrJVJUjitLQEUoPay8Uo2thziRWz69tdTkQR__vJNolIIshxD8fDovnxXWY-M8sj2s8FCpxEw-hkCgtTwFk8Poer6MPFsD8YQX_UH15-jODwdDCZTv4dtmCdet8k3pK-dvKmIPj_ryiOwLrrXDkyllJnDw8m8eD0D79zxLu_X4wHo-lhyBhjAdRfLGgdCPFnND6PpvGlV901b8E4Po1iOL6E-xl6qHRGIzkni-IKOc48LI1OyVptKtdjnTDIliiYh7kqF65yzzxMtSEUj-hyVxAKnFZFxiQzMm2GHmbkZF7U1z730KsquM5VRkv0cFJKZQW0EzxOkuWnLEmWnCXJkr134C_7aniCIFUGAQPt7shY9PCf_8DlcxLA1laqlSPlcq3WAa6e8hZlQRYMyUxA2PhuHtyzK_DhGD1cp-mFKxeuSpytPGysNTTr5C2h4Cvv28EO1BcyjrKzvHBkyLT5S7pP8WhZGtAKelyArdCCddI4UaMKfvs1SZjPkoSx9w4EUtm-sorwG8TjCkOvqrducM2xQdh4rJNFsTmHuVzCnObaPIAsCp1KR5kAVvOtYjY10qV3kOX2_m3Gqwn4Wyfg7zOBv3Wu1pvtb9vs0uRzaR7Qw2ZO4vVLZZzx6k36zO90jtjm56TT592QN0aXdXk3DKOQH4jNx9vzWzuI-tuJfu-e-_vwDPbhOdHGkWkHL1n2-M_7tPWDFiXcp7GYbKmVpReNbbuZrWYeUnZLzf-s1QuT0oXRaf0zjTmudbUjI-uaKG-MgWpCVYGbYr5T7O8W-zvFwW5xsFMcvhLPVj99DQAA__8evT9V

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlN1u2koQx-_PU4zmJkHHR-zaHEq2qgRJnJaWQGpQ2zRGkWNPEytm191dKqKId6_WJhFJFBram3KxaD7-y8xvZrlF871AgeNwEB5MYK4LOIpGx3AWfjkZ9PpD6A17g9OvIewe9seT8cdBA1ap13XiJalzm1wUBJ_fhVEIxp7n0pI2lFqzuzOO-odv_PYe77w-GfWHk90WY4wFUH2xoLEjxNtwdBxOolPP3TVrwCg6DCPYP4XrKXooVUbDZEYGxRlynHpYapWSMUo7122V0M8WKJiHuSzn1rmnHqZKE4pbtLktCAVOXJERJRnpJkMPM7JJXlTX3vfQdRWc5zKjBXo4LhNpBDRj3I_jxbcsjhcscAf7xYH_bavhMUIiMwgYKHtF2qCHHz6BzWckgK2sVElL0uZKrgJc3uXNy4IMaEoyAX7tu7ix9y7ehn30cJWm5racW5c4XXpYWytoxiaXhIIvvZeD7csfpC1lR3lhSZNu8od07-LhotSgJHS5AOPQgrGJtqJCFbz6P46ZQ8UckY0HAslsW5kj_ATxyGHounqrBlcca4S1x9ikKNbnMEsWMKOZ0jeQFIVKE0uZAFbxdTGT6sSmV5Dl5vppxosn4G8zgfcql6vN9p_b7FLns0TfoIf1nMTjl8o44-5N-sxvt_fY-ueg3eOdFq-NDuvwTqsVtviOWH-8Xb_xe0T_ZM9fzDPYhudYaUu6GTxk2eX__oWL0tqmsYhMqaShB409dzNbTj2k7JLq_1mj5jqlE63S6mdqc1TpKkdGxtZRXht9WYdcgetivlHsbxb7G8XBZnGwUdx6JJ4u__kZAAD__yxwP1c=

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlN1u2koQx-_PU4zmJkHHR-zaHEq2qgRJnJaWQGpQ2zRGkWNPEytm191dKqKId6_WJhFJFBram3KxaD7-y8xvZrlF871AgeNwEB5MYK4LOIpGx3AWfjkZ9PpD6A17g9OvIewe9seT8cdBA1ap13XiJalzm1wUBJ_fhVEIxp7n0pI2lFqzuzOO-odv_PYe77w-GfWHk90WY4wFUH2xoLEjxNtwdBxOolPP3TVrwCg6DCPYP4XrKXooVUbDZEYGxRlynHpYapWSMUo7122V0M8WKJiHuSzn1rmnHqZKE4pbtLktCAVOXJERJRnpJkMPM7JJXlTX3vfQdRWc5zKjBXo4LhNpBDRj3I_jxbcsjhcscAf7xYH_bavhMUIiMwgYKHtF2qCHHz6BzWckgK2sVElL0uZKrgJc3uXNy4IMaEoyAX7tu7ix9y7ehn30cJWm5racW5c4XXpYWytoxiaXhIIvvZeD7csfpC1lR3lhSZNu8od07-LhotSgJHS5AOPQgrGJtqJCFbz6P46ZQ8UckY0HAslsW5kj_ATxyGHounqrBlcca4S1x9ikKNbnMEsWMKOZ0jeQFIVKE0uZAFbxdTGT6sSmV5Dl5vppxosn4G8zgfcql6vN9p_b7FLns0TfoIf1nMTjl8o44-5N-sxvt_fY-ueg3eOdFq-NDuvwTqsVtviOWH-8Xb_xe0T_ZM9fzDPYhudYaUu6GTxk2eX__oWL0tqmsYhMqaShB409dzNbTj2k7JLq_1mj5jqlE63S6mdqc1TpKkdGxtZRXht9WYdcgetivlHsbxb7G8XBZnGwUdx6JJ4u__kZAAD__yxwP1c=
