# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
·
• sort
│ actual row count: 2
│ order: +k
│
└── • filter
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ actual row count: 2
        │ KV rows read: 2
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  actual row count: 2
                  KV rows read: 4
                  KV bytes read: 32 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVdFO20oQfb9fMZoXQNdX2bVNbtiqUgqYNm0hyIlaoTpCxp6CheN1dzeVEcpn9Qf6ZdXaISVEmEa0UvPgaM7s2ew5Z7y5Rf0lR4Gj4H1wMIZrOAqHx3BJ8tzEFznBxzdBGIA251lhSGlKjN7eGoWDw5dud4_3XpwOByfjbZ8xxjyov5i3syXE62B4HIzDM8fuNd2BYXgYhLB_BtfoYCFTOomnpFF8Qo4TB0slE9JaKgvd1gsGaYWCOZgV5cxYeOJgIhWhuEWTmZxQ4NieMaQ4JdVh6GBKJs7yetulhL49wHlWpFShg6MyLrSAToT7UVR9TqOo4iyKKvbUA__blMMjhLhIwWMgzRUpjQsxYGZlTlqAu0S0ifMcTDYlAez7N7v03Yf1uuaBojgV4DfYxY1ZQp4L--jgRWySK9IgZ6acGQHWmQX1DnJxMnewqRbeahNfEgo-d37d_0HxlZSh9CjLDSlSHb4awl0_qEoFsoA-F6BtAlawMqJ21Pt_N4qYy6KIsaceCFSkm9JsEGtJDK0Nfb6Wid-WCVWUzEwmi1V4GlcwpalUNxDnuUxiQ6kAVodhezpRNhJIM329vuJZcbmbxPVWZsXibXEfe1tKlU1jdfPTIafv_t7BdR838llWeJtYsZxYb9WIBhcPbzzGGbd3m8vcbneP3f8cdF_xns-bosd6vOf7gc-3xP1LsO_urMzcn9Dvb6J_JJUh1fFX1ff5v3_llO9uIi0kXcpC04q0x3Zm84mDlF5S88ej5UwldKpkUv9MUw5rXg2kpE3T5U0xKJqWPeB9Mm8lu-1kt5XstZO9VrLfTvZbybsPyJP5Pz8CAAD__4VhqH0=
·
WARNING: this statement is experimental!

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
·
• sort
│ actual row count: 2
│ order: +k
│
└── • filter
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ actual row count: 2
        │ KV rows read: 2
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFO2zwU_f89xdX9A-jLVDsJXfE0qQPC1jEoSismtFQoJHcQkcaZ7U5FqI-1F9iTTU5KR0Fki9ik9Yere-zj-pxz7d6i_pKjwFHwIdgbwzUchMMjuCR5buKLnODjuyAMQJvzrDCkNCVGb26MwsH-a7e7w3uvToaD4_GmzxhjHlRfzNvaEOJtMDwKxuGZY_eabsEw3A9C2D2Da3SwkCkdx1PSKD4hx4mDpZIJaS2VhW6rBYN0joI5mBXlzFh44mAiFaG4RZOZnFDg2J4xpDgl1WHoYEomzvJq25WEvj3AeVakNEcHR2VcaAGdCHejaP45jaI58-zAfjHgi7YcHiHERQoeA2muSGlcigEzK3PSAtwVok2c52CyKQlg37_ZpYenj-uKB4ritCYfnsLFjVlBvAu76OBFbJIr0iBnppwZAdaZJfUOcnGycLCult5qE18SCr5wft__QfGVlKH0IMsNKVIdvh7C3XwwLxXIAvpcgLYJWMHKiMpR7-V2FDHrKLPGNQ4IVKRtaTaIR0kMrQ193i4TmlMyM5ks1uFpPIcpTaW6gTjPZRIbSgWwKgw7pxNlI4E009ePVzwrLrdNXO9lVixvi_vUbSlVNo3VzU-HnL775xv3CSOfZYXXxopVx3rrRtS4ePjiMc64fdtc5na7O-z-Z6_7hvd8Xhc91uM93w98viHuP4J9d2ut5_6Gfr-N_pFUhlTHX1ff5___k12-3UZaSLqUhaY1aU_tzBYTBym9pPqPR8uZSuhEyaT6mbocVrwKSEmbepbXxaCop-wB75N5I9ltJruNZK-Z7DWS_Way30jefkCeLP77EQAA__-ikKiB
·
WARNING: this statement is experimental!

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
·
• sort
│ actual row count: 2
│ order: +k
│
└── • filter
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ actual row count: 2
        │ KV rows read: 2
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFO2zwU_f89xdX9A-jLVDsJXfE0qQPC1jEoSismtFQoJHcQkcaZ7U5FqI-1F9iTTU5KR0Fki9ik9Yere-zj-pxz7d6i_pKjwFHwIdgbwzUchMMjuCR5buKLnODjuyAMQJvzrDCkNCVGb26MwsH-a7e7w3uvToaD4_GmzxhjHlRfzNvaEOJtMDwKxuGZY_eabsEw3A9C2D2Da3SwkCkdx1PSKD4hx4mDpZIJaS2VhW6rBYN0joI5mBXlzFh44mAiFaG4RZOZnFDg2J4xpDgl1WHoYEomzvJq25WEvj3AeVakNEcHR2VcaAGdCHejaP45jaI58-zAfjHgi7YcHiHERQoeA2muSGlcigEzK3PSAtwVok2c52CyKQlg37_ZpYenj-uKB4ritCYfnsLFjVlBvAu76OBFbJIr0iBnppwZAdaZJfUOcnGycLCult5qE18SCr5wft__QfGVlKH0IMsNKVIdvh7C3XwwLxXIAvpcgLYJWMHKiMpR7-V2FDHrKLPGNQ4IVKRtaTaIR0kMrQ193i4TmlMyM5ks1uFpPIcpTaW6gTjPZRIbSgWwKgw7pxNlI4E009ePVzwrLrdNXO9lVixvi_vUbSlVNo3VzU-HnL775xv3CSOfZYXXxopVx3rrRtS4ePjiMc64fdtc5na7O-z-Z6_7hvd8Xhc91uM93w98viHuP4J9d2ut5_6Gfr-N_pFUhlTHX1ff5___k12-3UZaSLqUhaY1aU_tzBYTBym9pPqPR8uZSuhEyaT6mbocVrwKSEmbepbXxaCop-wB75N5I9ltJruNZK-Z7DWS_Way30jefkCeLP77EQAA__-ikKiB
·
WARNING: this statement is experimental!
