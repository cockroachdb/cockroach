# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 6 (48 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ MVCC step count: 0
        │ MVCC seek count: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 4
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 4
                  KV bytes read: 32 B
                  MVCC step count: 0
                  MVCC seek count: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu40QQ_s9TjOZPr8Kou7YbcouQQns-CNDLyYkOnXBUbe0hZ8XedXc34KrKY_ECPBmynZSkUVwC_CA_Nppv8u3OfN_s5hHtfYECp9GP0fUMlvA2ntzAgvStk3cFwU_fRXEE1t3mypGxlDr76mwaj9987Q9e8-FX7yfjd7NXIWOMBdB-seD8TIhvo8lNNIs_es1e5TlM4jdRDFcfYYkeKp3RO1mSRfEzcpx7WBmdkrXaNNBj-4NxVqNgHuaqWrkGnnuYakMoHtHlriAUOGtqjElmZC4YepiRk3nRbvvUwqgp4DZXGdXo4bSSygq4SPAqSepfsiSpOUuSmr204BencniCIFUGAQPtPpGx6OEPH8DlJQlgf_y-iVOtHCmXa3WQMvo3C4ZkJiDskLsHR1so8OEKPbz5cH0N1lEFqV4pJ4A9gUTLXfBOuvQTWdArV602WHvEFghxvvawizaKWycXhIKvvb_vylj9SsZR9jYvHBkyF3zfmm0-qisDWsGIC7CNL2CdNE60OgdfXiYJ81mSMPbSgkAqO5XW2HPgz6SRYdTU2zbYOtCJ38XWyaLY94lqSleH9pWyhpJKbR5AFoVOpaNMAGsta3L2vgBHZQVZbpewsnJB2_SLPvlHffJP8el7navN5fGPXZ7K5KU0D39J4438Z-r4fer844H3DweeD04c-CPW_At9g1P0fZr_YF_dDhfPX1XGGW_eT5_5g8Frtvu5HnzDhyHvgiEb8mEYRiE_E7sP7cg_PzrBvR799zKFp8g01caRuQj3RRrxz_9vl-vylK5ispVWlva6OrYzW889pGxB3d-f1SuT0nuj0_aYLpy0vBbIyLouy7tgrLpUU-AumfeS_X6y30sO-slBLznsJ4e95Mtn5Pn6sz8DAAD__-dk0Dg=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ MVCC step count: 0
        │ MVCC seek count: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  MVCC step count: 0
                  MVCC seek count: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu6zQU_s9THJ0_uxNBtZOs9BohlfXmQoHdTmk1NJFq8pJDFzWxM9uFTlMfixfgyVCSdrSbFqiGBPnh6Hwnn33O99nOI9r7AgVOox-j0QyW8DGeXMCC9I2TtwXBT99FcQTW3eTKkbGUOvvuZBqPP3zt99_zwVeXk_Gn2buQMcYCaF4sOD0R4ttochHN4muvnqs8hUn8IYrh_BqW6KHSGX2SJVkUPyPHuYeV0SlZq00NPTYfjLM1CuZhrqqVq-G5h6k2hOIRXe4KQoGzusaYZEamx9DDjJzMi2bapxaGdQE3ucpojR5OK6msgF6C50my_iVLkjUL6oH9zYBfHMvhCYJUGQQMtLsjY9HDH67A5SUJYH_8vo1TrRwpl2v1ImX0bxYMyUyA3yK3D452EO_DOXp4cTUagXVUQapXyglgTyDRch-8lS69Iwt65arVFmuW2AE-zjcettFWcevkglDwjffPXRmrX8k4yj7mhSNDpscPrdnlo3VlQCsYcgG29gWsk8aJRufgy7MkYbXOrJazc0AglR1Lq-154c-klmFY19s02DjQit_G1smiOPSJ1pSuXtpXyjWUVGrzALIodCodZQJYY1mds_cFOCoryHK7hJWVC9ql3-CTf4xP3-tcbQ-P_9rhqUxeSvPwlzTe0D9Gnf90w79izRv0DY7R92n_B4fqtrh4fqsyznh9f_rM7_ffs_1n1P-GD0LeBgM24IMwjEJ-IvYv2qF_-q_u4DfIFB4j01QbR6YXHoo05J__3w7X2TFdxWQrrSwddPXazGwz95CyBbW_P6tXJqVLo9NmmTacNLwGyMi6NsvbYKzaVF3gPpl3kv1ust9JDrrJQSc57CaHneSzZ-T55rM_AwAA___5NdA6

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ MVCC step count: 0
        │ MVCC seek count: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  MVCC step count: 0
                  MVCC seek count: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu6zQU_s9THJ0_uxNBtZOs9BohlfXmQoHdTmk1NJFq8pJDFzWxM9uFTlMfixfgyVCSdrSbFqiGBPnh6Hwnn33O99nOI9r7AgVOox-j0QyW8DGeXMCC9I2TtwXBT99FcQTW3eTKkbGUOvvuZBqPP3zt99_zwVeXk_Gn2buQMcYCaF4sOD0R4ttochHN4muvnqs8hUn8IYrh_BqW6KHSGX2SJVkUPyPHuYeV0SlZq00NPTYfjLM1CuZhrqqVq-G5h6k2hOIRXe4KQoGzusaYZEamx9DDjJzMi2bapxaGdQE3ucpojR5OK6msgF6C50my_iVLkjUL6oH9zYBfHMvhCYJUGQQMtLsjY9HDH67A5SUJYH_8vo1TrRwpl2v1ImX0bxYMyUyA3yK3D452EO_DOXp4cTUagXVUQapXyglgTyDRch-8lS69Iwt65arVFmuW2AE-zjcettFWcevkglDwjffPXRmrX8k4yj7mhSNDpscPrdnlo3VlQCsYcgG29gWsk8aJRufgy7MkYbXOrJazc0AglR1Lq-154c-klmFY19s02DjQit_G1smiOPSJ1pSuXtpXyjWUVGrzALIodCodZQJYY1mds_cFOCoryHK7hJWVC9ql3-CTf4xP3-tcbQ-P_9rhqUxeSvPwlzTe0D9Gnf90w79izRv0DY7R92n_B4fqtrh4fqsyznh9f_rM7_ffs_1n1P-GD0LeBgM24IMwjEJ-IvYv2qF_-q_u4DfIFB4j01QbR6YXHoo05J__3w7X2TFdxWQrrSwddPXazGwz95CyBbW_P6tXJqVLo9NmmTacNLwGyMi6NsvbYKzaVF3gPpl3kv1ust9JDrrJQSc57CaHneSzZ-T55rM_AwAA___5NdA6
