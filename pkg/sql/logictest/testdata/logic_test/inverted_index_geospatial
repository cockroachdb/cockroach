# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 6" since all the above shapes overflow
# the default index bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8VFFP20wQfP9-xWpfIPqO5s6JQriqUgKY1m1IqBOppThCxl5RC9vn3p1pEMp_r2ynbUJFCkKqX6ybm1nvjHZ9j-ZbihKn7sg9mkGpUzjxJ6dw4X4-Gw29MQzHw9H5Fxd2j73pbPpx1IIV9aYhXpO6tOFVSvDpneu7YOxlklvShiJrdnemvnf8xukdiP7rs4k3nu12Oee8A_WLd1o7Ur51J6fuzD9nVa2sBRP_2PXh8Bxu5sgwVzGNw4wMygsUOGdYaBWRMUpX0H1N8OIFSs4wyYvSVvCcYaQ0obxHm9iUUOKsatKnMCbd5sgwJhsmaV32l4dB1cFlkse0QIbTIsyNhPae2KsVV6GNvpIBVdqitBIqzJZFugb1kKGhlCKb3Cb2TgJ_xSuasWGagk0yksANzpcMG8mqWWPDa0Ipluzphrz8lrSl-CRJLWnSbbHp6ue9uyg0qBwGQoKpLIGxobYywCBw-H4QdPb3AwTK4wYSPEBAhpPK0KAqqtV3A5rCeGVw0wzDLFxARpnSd1AaiiU4HD4khy-LjBYUlTZR-d9jc54T23uV5KsxcB4bg0InWajvfofABs4TcqgHBx6wGvAP7r9JpvOcZKZKW9LtzmYqA_E_MmyGTD5cby64qBbZ4U6vd8DXn6PeUPS7ojn0eV_0u123K3bk-sYPnNbGpD0hFeflqXSfk4pPplC5oY1UHqvMl3OGFF9T828yqtQRnWkV1Z9pjpNaVwMxGdvciubg5c1V1eC6WGwVO9vFzlZxZ7u4s1XcfSCeL__7EQAA__9AYAH2

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lFFP2zAQx9_3KU73AtW81U66Nnia1AJh61ZallbaGK1QSE4QkcaZ7bAi1O8-pem2FkShmkQeHPn8_9vnn093h-ZnihKHfs8_GEGhUzgKBsdw5n8_6XW6fej0O73THz7sHnaHo-HXXg2W0utKeEnq3IYXKcG3T37gg7HnSWZJG4qs2d0ZBt3DD05zT3jvTwbd_mi3wTnnLix-3K3tSPnRHxz7o-CUlXtNazAIDv0A9k_heoIMMxVTP5ySQXmGAicMc60iMkbpMnS3EHTjGUrOMMnywpbhCcNIaUJ5hzaxKaHEUZlkQGFMus6RYUw2TNLFtn_v0C4zOE-ymGbIcJiHmZFQd0RTtJyW5wjhtjzX496bh7E9CLMYXA7KXpE2yPAitNEVGVCFzQsroTzUFnm6EnKQoaGUIpvcJPZWAn_LS5mxYZqCTaYkgRuczBlWluXdjA0vCaWYs-ffv5vdkLYUHyWpJU26LtYh_Fn3Z7kGlUFbSDAlATA21FaOcTx2W-_GY87dcuBPDAiUxVu6xBjhAcdBSapdZqvVLwOawnhJbp0Sw2k4gylNlb6FwlCp4vAl2f-_t6AZRYVNVPb0ezjbvMdnlWTLcnQeK8dcJ9NQ3_6DwNrOMzgsChjuqargA-3LkHG3ITNU2pKuu-tU2uI1MqyqV95vM1xwUTYUhzvN5h5f_Q6aHeE1RDXxuCe8RsNviB252nnaTm2t0l6GSmMbKgGZXGWG1qg8tjOfTxhSfElVjzSq0BGdaBUtjqmmg4VvEYjJ2GpVVJNuVi2VCa6axUazs9nsbDS7m83uRnPjnnkyf_U7AAD__7MQJP0=

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lFFP2zAQx9_3KU73AtW81U66Nnia1AJh61ZallbaGK1QSE4QkcaZ7bAi1O8-pem2FkShmkQeHPn8_9vnn093h-ZnihKHfs8_GEGhUzgKBsdw5n8_6XW6fej0O73THz7sHnaHo-HXXg2W0utKeEnq3IYXKcG3T37gg7HnSWZJG4qs2d0ZBt3DD05zT3jvTwbd_mi3wTnnLix-3K3tSPnRHxz7o-CUlXtNazAIDv0A9k_heoIMMxVTP5ySQXmGAicMc60iMkbpMnS3EHTjGUrOMMnywpbhCcNIaUJ5hzaxKaHEUZlkQGFMus6RYUw2TNLFtn_v0C4zOE-ymGbIcJiHmZFQd0RTtJyW5wjhtjzX496bh7E9CLMYXA7KXpE2yPAitNEVGVCFzQsroTzUFnm6EnKQoaGUIpvcJPZWAn_LS5mxYZqCTaYkgRuczBlWluXdjA0vCaWYs-ffv5vdkLYUHyWpJU26LtYh_Fn3Z7kGlUFbSDAlATA21FaOcTx2W-_GY87dcuBPDAiUxVu6xBjhAcdBSapdZqvVLwOawnhJbp0Sw2k4gylNlb6FwlCp4vAl2f-_t6AZRYVNVPb0ezjbvMdnlWTLcnQeK8dcJ9NQ3_6DwNrOMzgsChjuqargA-3LkHG3ITNU2pKuu-tU2uI1MqyqV95vM1xwUTYUhzvN5h5f_Q6aHeE1RDXxuCe8RsNviB252nnaTm2t0l6GSmMbKgGZXGWG1qg8tjOfTxhSfElVjzSq0BGdaBUtjqmmg4VvEYjJ2GpVVJNuVi2VCa6axUazs9nsbDS7m83uRnPjnnkyf_U7AAD__7MQJP0=
