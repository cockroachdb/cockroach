# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lN9P2zoUx9_vX3F0XqC6uaqd5HbF06QWCFu30rK02sZIhUxyBhFp3NnuFIT6v09JCitMDevD8uDo_Pg653zsk3s03zMUOAmGwdEUljqDk3B8ChfBl7NhfzCC_qg_PP8awP7xYDKdfBy2YJ16Wydek7q08ioj-PwuCAMw9jLNLWlDsTX7e5NwcPzG7Rzw7uuz8WA03fcZY8yD6sW81p4Qb4PxaTANz51yr3kLxuFxEMLhOdzO0MFcJTSSczIoLpDjzMGFVjEZo3Tpuq8SBkmBgjmY5oulLd0zB2OlCcU92tRmhAKnZZEhyYR0m6GDCVmZZtW2jz30ygou0zyhAh2cLGRuBLQjPIyi4lsSRQVnUVSwlxb8b1cNjxBknoDHQNkb0gYd_PAJbDonAezBWi4yMqBJJgL82nd1Zx9dDA5xtnJQLe0vDMbKa0LBV86foxrkP0hbSk7SzJIm3eZPeT3Eg2KhQeXQ4wJMCQuMldqKqnnv1f9RxFwWRYy9tCBQnuwqK5n9Bm28tAJ6Zb1Vg2tmNa7aY6zMsk2yc1nAnOZK34HMMhVLS2uYdczEWtr4BpLU3D7P2Ibb3QX3e5Xm64vpbruYC53Opb5DB-tDEc8HjXHGy5FymdvpHLDN56jT512f10aXdXnX9wOf74nN2eu5rQZ87nZ8zdfU3YrI2wXRRGlLuu09xdPj_-5S6d84aH-XLkIyC5UbetLFtp3ZauYgJddU_-aMWuqYzrSKq8_U5rjSVY6EjK2jvDYGeR0qC9wU80ax2yx2G8Ves9hrFPvPxLPVPz8DAAD__xcjFBw=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElN9v2joUx9_vX3F0Xlp0c4WdcLnUV5Ogbbplo9AFtK1rUOUmZ23UJM5sM1FV_O9TEtrRTtCxl_FgdH58zfl-bHOP5muGAif-0D-awlxncBKOT-HC_3Q2HAQjGIwGw_PPPuwfB5Pp5P2wBavW26bxmtSllVcZwcc3fuiDsZdpYUkbiq3Z35uEwfErt3vAe_-fjYPRdL_DGGMe1F_Ma-0J8dofn_rT8Nyp9spbMA6P_RAOz-F2hg4WKqGRzMmguECOMwdLrWIyRukqdV83BMkCBXMwLcq5rdIzB2OlCcU92tRmhAKn1ZAhyYR0m6GDCVmZZvW2jx761QSXaZHQAh2clLIwAtoRHkbR4ksSRQvmVQt7YcF_dtXwCEEWCXgMlL0hbdDBdx_ApjkJYA_RvMzIgCaZCHCb3NWdfUwxOMTZ0kE1tz8wGCuvCQVfOr-OKii-kbaUnKSZJU26zZ_yeqj7i1KDKqDPBZgKFhgrtRW1ee-_f6OIVeZZ5XHrgkBFsqusYvYTtPHcCuhX89YGV8waXE3GWJll62RzuYCccqXvQGaZiqWlFcymZmItbXwDSWpun3dswu3ugvutSovVxXQ3XcxSp7nUd-hgcyji-UNjnPHqSbnM7XYP2PrnqDvgvQ5vgh7r8V6n43f4nlh_e3239Xv4XrqmmxB5uyCaKG1Jt72nePr87z990J1dXIRkSlUYeuJi085sOXOQkmtq_uaMmuuYzrSK659pwnGtqxMJGdtUeRMERVOqBlwX861id7vY3Sr2tou9reLOM_Fs-df3AAAA__8jeBQe

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElN9v2joUx9_vX3F0Xlp0c4WdcLnUV5Ogbbplo9AFtK1rUOUmZ23UJM5sM1FV_O9TEtrRTtCxl_FgdH58zfl-bHOP5muGAif-0D-awlxncBKOT-HC_3Q2HAQjGIwGw_PPPuwfB5Pp5P2wBavW26bxmtSllVcZwcc3fuiDsZdpYUkbiq3Z35uEwfErt3vAe_-fjYPRdL_DGGMe1F_Ma-0J8dofn_rT8Nyp9spbMA6P_RAOz-F2hg4WKqGRzMmguECOMwdLrWIyRukqdV83BMkCBXMwLcq5rdIzB2OlCcU92tRmhAKn1ZAhyYR0m6GDCVmZZvW2jx761QSXaZHQAh2clLIwAtoRHkbR4ksSRQvmVQt7YcF_dtXwCEEWCXgMlL0hbdDBdx_ApjkJYA_RvMzIgCaZCHCb3NWdfUwxOMTZ0kE1tz8wGCuvCQVfOr-OKii-kbaUnKSZJU26zZ_yeqj7i1KDKqDPBZgKFhgrtRW1ee-_f6OIVeZZ5XHrgkBFsqusYvYTtPHcCuhX89YGV8waXE3GWJll62RzuYCccqXvQGaZiqWlFcymZmItbXwDSWpun3dswu3ugvutSovVxXQ3XcxSp7nUd-hgcyji-UNjnPHqSbnM7XYP2PrnqDvgvQ5vgh7r8V6n43f4nlh_e3239Xv4XrqmmxB5uyCaKG1Jt72nePr87z990J1dXIRkSlUYeuJi085sOXOQkmtq_uaMmuuYzrSK659pwnGtqxMJGdtUeRMERVOqBlwX861id7vY3Sr2tou9reLOM_Fs-df3AAAA__8jeBQe
