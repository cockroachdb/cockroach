# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8VFFP20gQfr9fMZoXiM6n7NomF_Z0UgKYNm1IqBO1pThCxp6CheN1dzdVEMp_r2wHmoBi8EvzsNF8M996vm9H84D6R4oCJ97QO57CQqVw6o_P4NL7ej7sD0bQH_WHF9882D8ZTKaTT8MWrEvvqsIbklcmvE4Jvrz3fA-0uUoyQ0pTZPT-3sQfnPxvdw5597_z8WA03XcZY8yB8o85rT0h3nnjM2_qX1jFXfMWjP0Tz4ejC7iboYWZjGkUzkmjuESOMwtzJSPSWqoCeigLBvESBbMwyfKFKeCZhZFUhOIBTWJSQoHTokmfwphUm6GFMZkwSctrnzT0ig6ukiymJVo4ycNMC2gHeBQEy-9xECw5C4Ile-3Af5pyeIAQZjE4DKS5JaXRwo-fwSRzEsAeo0WekgZFYSzArbDre_MEOTYcoYXrMrkw-cIUhbOVhVW0tkab8IZQ8JX1dvsG2U9ShuLTJDWkSLX5toePeW-ZK5AZ9LgAXRgI2oTKiNIQ59-DIGA2CwLGXjsQKIub0gofXxg5LmzoFf2WAtc-VhZWiDZhmm66PQ-XMKe5VPcQpqmMQkOxAFb6W-R0pEIT3UKc6LuXFc9ewN75AnaTF_ggk2w9v_au-c1VMg_V_W_RVs9-odverbt-5uwm2pwm2p6mytlWVuHi-VZhnPFif9jM7nQO2ebvuNPnXZdXQZd1edd1PZfvic1F07NbNXNR48-b1btN1E-kMqTa7rb2Hv-7SWt_aGQPmgjzSecy07QlbNfNbDWzkOIbqva6lgsV0bmSUfmZKhyXvBKISZsqy6tgkFWposFNMq8l2_Vku5bs1JOdWrJbT3ZryQfPyLPVX78CAAD___Jvd8U=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVFFP2zAQft-vON0LVMtUOwld8TSpBcLWrbQsrbYxUqGQ3CAiTTLbnYpQ__vkpLAWRGj3tD64uu_uc-77fLo7VL9SFDjy-t7hGGYyhWN_eALn3vfTfrc3gO6g2z_74cHuUW80Hn3pN2BZelMVXlF-ocPLlODbR8_3QOmLJNMkFUVa7e6M_N7Re7u1z9vvToe9wXjXZYwxB8o_5jR2hPjgDU-8sX9mmbumDRj6R54PB2dwM0ELszymQTglheIcOU4sLGQekVK5NNBdWdCL5yiYhUlWzLSBJxZGuSQUd6gTnRIKHJsmfQpjkk2GFsakwyQtr33Q0DEdXCRZTHO0cFSEmRLQDPAgCOY_4yCYM8cc7IUD32zL4QFCmMXgMMj1NUmFFn7-CjqZkgB2H82KlBRICmMBdoVd3uoHiLfgAC1cluUzXcy0KZwsLKyipTVKh1eEgi-sze3rZb9JaoqPk1STJNnk6x7e5715ISHPoMMFKGMgKB1KLUpDnLd7QcCMIczorj0QKIu3pRkfnxg5NDZ0TL-lwKWPlYUVonSYpqtuT8M5TGmay1sI0zSPQk2xAFb6a3IqkqGOriFO1M3Tio1fwN7mBT7lSbacX_u5-S1kMg3l7V_RVsfeRvfLM7exNmcbbQ9T5awrq3DxeKswzrjZHzazW619tvo7bHV52-VV0GZt3nZdz-U7YnXRdOzGv83FxurdbdSPcqlJNt117R3--j8c2b1thPmkijxTtCbsuZvZYmIhxVdU7XWVz2REpzKPys9U4bDklUBMSldZXgW9rEqZBlfJvJZs15PtWrJTT3ZqyW492a0l7z0iTxav_gQAAP__AVd3xw==

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVFFP2zAQft-vON0LVMtUOwld8TSpBcLWrbQsrbYxUqGQ3CAiTTLbnYpQ__vkpLAWRGj3tD64uu_uc-77fLo7VL9SFDjy-t7hGGYyhWN_eALn3vfTfrc3gO6g2z_74cHuUW80Hn3pN2BZelMVXlF-ocPLlODbR8_3QOmLJNMkFUVa7e6M_N7Re7u1z9vvToe9wXjXZYwxB8o_5jR2hPjgDU-8sX9mmbumDRj6R54PB2dwM0ELszymQTglheIcOU4sLGQekVK5NNBdWdCL5yiYhUlWzLSBJxZGuSQUd6gTnRIKHJsmfQpjkk2GFsakwyQtr33Q0DEdXCRZTHO0cFSEmRLQDPAgCOY_4yCYM8cc7IUD32zL4QFCmMXgMMj1NUmFFn7-CjqZkgB2H82KlBRICmMBdoVd3uoHiLfgAC1cluUzXcy0KZwsLKyipTVKh1eEgi-sze3rZb9JaoqPk1STJNnk6x7e5715ISHPoMMFKGMgKB1KLUpDnLd7QcCMIczorj0QKIu3pRkfnxg5NDZ0TL-lwKWPlYUVonSYpqtuT8M5TGmay1sI0zSPQk2xAFb6a3IqkqGOriFO1M3Tio1fwN7mBT7lSbacX_u5-S1kMg3l7V_RVsfeRvfLM7exNmcbbQ9T5awrq3DxeKswzrjZHzazW619tvo7bHV52-VV0GZt3nZdz-U7YnXRdOzGv83FxurdbdSPcqlJNt117R3--j8c2b1thPmkijxTtCbsuZvZYmIhxVdU7XWVz2REpzKPys9U4bDklUBMSldZXgW9rEqZBlfJvJZs15PtWrJTT3ZqyW492a0l7z0iTxav_gQAAP__AVd3xw==
