# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 6 (48 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 4
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 4
                  KV bytes read: 32 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMleFu2zYQx7_vKQ73JQmmwaSkeC6HAV5cdfO21IVsdCgmI2CkmytYIlWS3hQEfqy9wJ5skBR3cQwr89YP9QcZd8c_xfv_fPQ92g8FCpxHP0eTBazhVTy7hhXpGydvC4JffojiCKy7yZUjYyl19vxsHk9ffusPX_DRN29m09eL85AxxgJov1hwcSbE99HsOlrE77xmr_ICZvHLKIard7BGD5XO6LUsyaL4FTkuPayMTslabZrUfbtgmtUomIe5qjauSS89TLUhFPfoclcQClw0Z4xJZmQGDD3MyMm8aLf92MK4OcBNrjKq0cN5JZUVMEjwKknq37IkqTlLkpo998CvTtXwBEGqDAIG2r0nY9HDn96Cy0sSwP768yFOtXKkXK7VQcnoPywYkpmAsMvc3jnapQIfrtDD67eTCVhHFaR6oxycU-0GuXIXAlhrSreAaH1swa106XuyoDeu2jgBTa599S4R4nLrYRc9kLBOrggF33r_ntZU_U7GUfYqLxwZMgO-j2xXj-rKgFYw5gJswwusk8aJ1v_g68skYT5LEsaeeyCQyk6VNdgOuM0aG8bNedsGWzIdlC62ThbFPj-qKd0cYi1lDSWV2tyBLAqdSkeZANaibGr2QwGOygqy3K5hY-WKduVnOflHOfmncPpR5-phqPxjQ1WZvJTm7h9rvLH_xB2_z53_PAj-4SDw4ScahCPI_ofvwSm-f5yLYN_1Li-e3sKMM97ctz7zh8MX7PFnMvyOj0LeBSM24qMwjEJ-Jh5fzGP_4ugvu5fdp7cpPMWmuTaOzCDcN2nMv_zchu7ylK5ispVWlva6OrYz2y49pGxF3d-l1RuT0huj0_Y1XThrdW0iI-u6Ku-CqepKzQEfi3mv2O8X-73ioF8c9IrDfnHYK758Il5uv_g7AAD__zTN3qQ=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu2zYQ_r-nONyfJJgGk5LiuRwGeEnVzdtSF4rRoZiMgJFurmCJVEl6UxD4sfYCe7KBUtzFDazNyH7UP2jcd_zIu-_z0fdoP1Qo8Dr5OblcwBpepfMrWJG-cfK2IvjlhyRNwLqbUjkylnJnT0-u09nLb8PxCz755s189npxGjPGWATdF4vOToT4PplfJYv0XeDPqs9gnr5MUrh4B2sMUOmCXsuaLIpfkeMywMbonKzVxkP33YZZ0aJgAZaq2TgPLwPMtSEU9-hKVxEKXPgaU5IFmRHDAAtysqy6Yz-2MPUF3JSqoBYDvG6ksgJGGV5kWftbkWUti_zC_mXBr47l8AxBqgIiBtq9J2MxwJ_egitrEsD--vMhzrVypFyp1ZOU0X9YMCQLAWGP3N452kF8DBcY4NXby0uwjhrI9UY5OKXWjUrlzgSwTpR-A9H60IZb6fL3ZEFvXLNxAjzWXb0DQlxuA-yjByeskytCwbfBf3drpn4n46h4VVaODJkR37dsl0_axoBWMOUCrPcLrJPGiU7_6OvzLGNef-ZlHlwQSBXH0rxtT3ybexmmvt6uwc6Z3pQ-tk5W1b5_1FK-eWprLVuoqdbmDmRV6Vw6KgSwzkqfsx8qcFQ3UJR2DRsrV7RLP8On8BifftSlehiq8NBQNaaspbn7R5pgGh6jzmc5CAcse4bu0TG6f5yLaF_1HhefvsKMM-7f25CF4_EL9vhzOf6OT2LeBxM24ZM4TmJ-Ih4_zNPw7H_9ZT9DpvgYma61cWRG8b5IU_7l5zZ058d0lZJttLK019Whk9l2GSAVK-r_Lq3emJzeGJ131_ThvON1QEHW9VneBzPVp3yBj8l8kBwOk8NBcjRMjgbJ8TA5HiSff0Jebr_4OwAA__9HLt6m

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
regions: <hidden>
·
• sort
│ nodes: <hidden>
│ regions: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ nodes: <hidden>
    │ regions: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ nodes: <hidden>
        │ regions: <hidden>
        │ actual row count: 2
        │ KV time: 0µs
        │ KV contention time: 0µs
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ nodes: <hidden>
            │ regions: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  nodes: <hidden>
                  regions: <hidden>
                  actual row count: 2
                  KV time: 0µs
                  KV contention time: 0µs
                  KV rows read: 2
                  KV bytes read: 16 B
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu2zYQ_r-nONyfJJgGk5LiuRwGeEnVzdtSF4rRoZiMgJFurmCJVEl6UxD4sfYCe7KBUtzFDazNyH7UP2jcd_zIu-_z0fdoP1Qo8Dr5OblcwBpepfMrWJG-cfK2IvjlhyRNwLqbUjkylnJnT0-u09nLb8PxCz755s189npxGjPGWATdF4vOToT4PplfJYv0XeDPqs9gnr5MUrh4B2sMUOmCXsuaLIpfkeMywMbonKzVxkP33YZZ0aJgAZaq2TgPLwPMtSEU9-hKVxEKXPgaU5IFmRHDAAtysqy6Yz-2MPUF3JSqoBYDvG6ksgJGGV5kWftbkWUti_zC_mXBr47l8AxBqgIiBtq9J2MxwJ_egitrEsD--vMhzrVypFyp1ZOU0X9YMCQLAWGP3N452kF8DBcY4NXby0uwjhrI9UY5OKXWjUrlzgSwTpR-A9H60IZb6fL3ZEFvXLNxAjzWXb0DQlxuA-yjByeskytCwbfBf3drpn4n46h4VVaODJkR37dsl0_axoBWMOUCrPcLrJPGiU7_6OvzLGNef-ZlHlwQSBXH0rxtT3ybexmmvt6uwc6Z3pQ-tk5W1b5_1FK-eWprLVuoqdbmDmRV6Vw6KgSwzkqfsx8qcFQ3UJR2DRsrV7RLP8On8BifftSlehiq8NBQNaaspbn7R5pgGh6jzmc5CAcse4bu0TG6f5yLaF_1HhefvsKMM-7f25CF4_EL9vhzOf6OT2LeBxM24ZM4TmJ-Ih4_zNPw7H_9ZT9DpvgYma61cWRG8b5IU_7l5zZ058d0lZJttLK019Whk9l2GSAVK-r_Lq3emJzeGJ131_ThvON1QEHW9VneBzPVp3yBj8l8kBwOk8NBcjRMjgbJ8TA5HiSff0Jebr_4OwAA__9HLt6m
