# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 6 (48 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV MVCC keys read: 0
        │ KV MVCC seeks: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 4
                  KV rows read: 4
                  KV bytes read: 32 B
                  KV MVCC keys read: 0
                  KV MVCC seeks: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVeFu0zAQ_s9TWPdnmwiqnWSlC0Iq2zIosHVKK9BEqslLji5qYme2O1JNfSxegCdDSdbRrmpGBUL0h6v7zp97931n9w70TQoeDPyP_tGQTMhJ0D8lY5SXhl-lSD6_8wOfaHOZCINKY2T07s4g6B2_ttsHrPPqvN87G-66lFLqkOqLOns7nvfW75_6w-DCKs_K9kg_OPYDcnhBJmCBkDGe8Qw1eF-AwciCXMkItZaqhO6qDb24AI9akIh8akp4ZEEkFYJ3ByYxKYIHw7LGAHmMqkXBghgNT9Lq2IcWumUBl4mIsQALBjkX2iOtEA7DsPgah2HBaBgW9KkFXmzLYSEQLmLiUCLNNSoNFnz4REySoUfoj-_3cSSFQWESKdZS2W0UkQnONFHIY4_QJVgjTvQDpOS3xSa3Rq5mBheQY5NDsOCKm-gaNZFTk09Nza2IC8CF0dyCOrpXXBs-RvDY3Pp9V3riFpXB-CRJDSpULbZqzSLvF7kiUpAu84gufSHacGW8Smfn5X4YUpuGIaVPLUBQxNvSSnvW_OmXMnTLeqsGK11rSetYG56mqz5hgdF03b6MFyTDTKoZ4WkqI26wdLAyoszpm5QYzHISJ3pCppqPcZF-0id7o0_2Nj69l4m4vzz2psuTqyTjavZLGqtrP1LHblLnHwy8vT7wrF0JucGaP9DX2Ubfh_l3VtWtce_xq0oZZeX7aVO73T6gy5-j9hvWcVkddGiHdVzXd9mOt_zQdu29jRPc6NHfl8ndRqaBVAZVy10Vqcue_2-Xa3-brgLUuRQaV7radDKdjyzAeIz135-WUxXhuZJR9TN12K94FRCjNnWW1UFP1KmywGUyayTbzWS7kew0k51GsttMdhvJ-4_Io_mznwEAAP__bmPQdg==

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV MVCC keys read: 0
        │ KV MVCC seeks: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  KV MVCC keys read: 0
                  KV MVCC seeks: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVdFu0zAUfecrrPuyTQTVTrLSBSGVbRkU2DqlFWgi1eQlly5qYme2O1pN_Sx-gC9DTtbRblqgGhLkwdE918e59xzbuQF9lUMAg_BjeDAkE3IU9Y_JGOW54Rc5ks_vwigk2pxnwqDSmBi9vTWIeoev3fYe67w67fdOhts-pZR6pHpRb2crCN6G_eNwGJ05dq1ih_SjwzAi-2dkAg4ImeIJL1BD8AUYjBwolUxQa6ksdFNN6KUzCKgDmSinxsIjBxKpEIIbMJnJEQIY2hoj5CmqFgUHUjQ8y6tl71ro2gLOM5HiDBwYlFzogLRi2I_j2dc0jmfUswP9zQAvNuWwGAgXKfEokeYSlQYHPnwiJiswIPTH99s4kcKgMJkUD1LFdZKQCc41UcjTgNAVWCNO9B2k5LflJLdGLuYGlxBrk31w4IKb5BI1kVNTTk3NrYhLwIXRwoE6ulVcGz5GCNjC-XNXeuIalcH0KMsNKlQttm7NMh_OSkWkIF0WEG19IdpwZYJKZ-_lbhxTqzO1cjYOQFCkm9KsPQ_86VsZurbeqsFK11rSOtaG5_m6TzjDZPrQvoLPSIGFVHPC81wm3KB1sDLC5vRVTgwWJUkzPSFTzce4TD_BJ3cTn97LTNweHvexw1OqrOBq_ksap-tuos4_3fCPWPMEfb1N9L3b_966ujUe3L9VKaPM3p8uddvtPbr6HLTfsI7P6qBDO6zj-6HPtoLVi7br7vzVHfwEmfxNZBpIZVC1_HWRuuz5_3a4djfpKkJdSqFxravHVqaLkQOYjrH-_Wk5VQmeKplUn6nDfsWrgBS1qbOsDnqiTtkCV8mskew2k91GstdM9hrJfjPZbyTv3iOPFs9-BgAA__-ANNB4

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
EXPLAIN ANALYZE (DISTSQL) SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
planning time: 10µs
execution time: 100µs
distribution: <hidden>
vectorized: <hidden>
rows read from KV: 4 (32 B)
maximum memory usage: <hidden>
network usage: <hidden>
·
• sort
│ cluster nodes: <hidden>
│ actual row count: 2
│ order: +k
│
└── • filter
    │ cluster nodes: <hidden>
    │ actual row count: 2
    │ filter: st_intersects('010100002026690000000000000C6A18410000008081844E41', geom)
    │
    └── • index join
        │ cluster nodes: <hidden>
        │ actual row count: 2
        │ KV rows read: 2
        │ KV bytes read: 16 B
        │ KV MVCC keys read: 0
        │ KV MVCC seeks: 0
        │ table: geo_table@primary
        │
        └── • inverted filter
            │ cluster nodes: <hidden>
            │ actual row count: 2
            │ inverted column: geom_inverted_key
            │ num spans: 31
            │
            └── • scan
                  cluster nodes: <hidden>
                  actual row count: 2
                  KV rows read: 2
                  KV bytes read: 16 B
                  KV MVCC keys read: 0
                  KV MVCC seeks: 0
                  missing stats
                  table: geo_table@geom_index
                  spans: 31 spans
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJzMVdFu0zAUfecrrPuyTQTVTrLSBSGVbRkU2DqlFWgi1eQlly5qYme2O1pN_Sx-gC9DTtbRblqgGhLkwdE918e59xzbuQF9lUMAg_BjeDAkE3IU9Y_JGOW54Rc5ks_vwigk2pxnwqDSmBi9vTWIeoev3fYe67w67fdOhts-pZR6pHpRb2crCN6G_eNwGJ05dq1ih_SjwzAi-2dkAg4ImeIJL1BD8AUYjBwolUxQa6ksdFNN6KUzCKgDmSinxsIjBxKpEIIbMJnJEQIY2hoj5CmqFgUHUjQ8y6tl71ro2gLOM5HiDBwYlFzogLRi2I_j2dc0jmfUswP9zQAvNuWwGAgXKfEokeYSlQYHPnwiJiswIPTH99s4kcKgMJkUD1LFdZKQCc41UcjTgNAVWCNO9B2k5LflJLdGLuYGlxBrk31w4IKb5BI1kVNTTk3NrYhLwIXRwoE6ulVcGz5GCNjC-XNXeuIalcH0KMsNKlQttm7NMh_OSkWkIF0WEG19IdpwZYJKZ-_lbhxTqzO1cjYOQFCkm9KsPQ_86VsZurbeqsFK11rSOtaG5_m6TzjDZPrQvoLPSIGFVHPC81wm3KB1sDLC5vRVTgwWJUkzPSFTzce4TD_BJ3cTn97LTNweHvexw1OqrOBq_ksap-tuos4_3fCPWPMEfb1N9L3b_966ujUe3L9VKaPM3p8uddvtPbr6HLTfsI7P6qBDO6zj-6HPtoLVi7br7vzVHfwEmfxNZBpIZVC1_HWRuuz5_3a4djfpKkJdSqFxravHVqaLkQOYjrH-_Wk5VQmeKplUn6nDfsWrgBS1qbOsDnqiTtkCV8mskew2k91GstdM9hrJfjPZbyTv3iOPFs9-BgAA__-ANNB4
