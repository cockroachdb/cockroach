# LogicTest: local

# SRID of the geometry column is unspecified, so default index bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

# Shapes with SRID 26918. We've taken small X, Y values and added 400,000 to the X coordinate
# and 4,000,000 to the Y coordinate to place them inside the bounds of SRID 26918.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')

query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 6" since all the above shapes overflow
# the default index bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJysVGFP2zAQ_b5fcbovUM2odlqV4mlSC4QtW2lZWmljpEIhObGIJM5sZytC_e9TEjZaJrpWWr5Efnfv8u75Lg9ovqcoceqO3JMZlDqFM39yDlful4vR0BvDcDwcXX51Yf_Um86mn0YteEy9axJvSV3b8CYl-Pze9V0w9jrJLWlDkTX7e1PfO33r9I5E_83FxBvP9rucc96B-sU7rT0p37mTc3fmX7KqVtaCiX_q-nB8CXdzZJirmMZhRgblFQqcMyy0isgYpSvooU7w4gVKzjDJi9JW8JxhpDShfECb2JRQ4qwS6VMYk25zZBiTDZO0Lvunh0Gl4DrJY1ogw2kR5kZC-0Ac1Iyb0EbfyIAqbVFaCRVmyyJdgXrI0JuATTKSwA3Olwyb2KMqY8NbQimWbHvlXv6DtKX4LEktadJtsS7_d9xdFBpUDgMhwVTawdhQWxlgEDj8MAg6h4cBAuVxAwkeICDDSaV8UBXV6qcBTWHcdGJsmKZPzTDMwgVklCl9D6WhWILD4WNyvL03tKCotInK_22Rs4tFH1SSP96t89LdFjrJQn3_1DAbOFv0XE8DPMtqwL9y_78LnV1cmCptSbc76w4MxGtk2AyPfL6fXHBRbaLDnV7viK8-J72h6HdFc-jzvuh3u25X7MnVlR04rbUJ2sIBZzcHurs44JMpVG5ozYGXKvPlnCHFt9T8SIwqdUQXWkX1Z5rjpObVQEzGNlHRHLy8CVUCV8liI9nZTHY2kjubyZ2N5O4z8nz56lcAAAD__7yP52s=

statement ok
DROP TABLE geo_table

# SRID of the geometry column is specified, so SRID specific bounds are used.
statement ok
CREATE TABLE geo_table(
  k int primary key,
  geom geometry(geometry, 26918),
  INVERTED INDEX geom_index(geom)
)

# Same shapes.
statement ok
INSERT INTO geo_table VALUES
  (1, 'SRID=26918;POINT(400001 4000001)'),
  (2, 'SRID=26918;LINESTRING(400001 4000001, 400002 4000002)'),
  (3, 'SRID=26918;POINT(400003 4000003)'),
  (4, 'SRID=26918;LINESTRING(400004 4000004, 400005 4000005)'),
  (5, 'SRID=26918;LINESTRING(400040 4000040, 400041 4000041)'),
  (6, 'SRID=26918;POLYGON((400001 4000001, 400005 4000001, 400005 4000005, 400001 4000005, 400001 4000001))')


# Same result.
query I
SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k
----
3
6

# The InvertedFilterer stats show "rows read: 2" since all the above shapes are within the index
# bounds.
query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslFFP2zAQx9_3KU73AtU81U66Nnia1AJhy1ZallbaGK1QaE4QkcaZ7WxFqN99SsJGC6JQiT6k8t397fv_dLpbNL9SlDjy-_7BGAqdwlE4PIYz_8dJvxcMoDfo9U9_-rB7GIzGo2_9BtyVXteFl6TObXSREnz_7Ic-GHueZJa0oZk1uzujMDj86LT3hPfhZBgMxrstzjl3ofrjbmNHyk_-8Ngfh6esvGvegGF46IewfwrXU2SYqZgG0ZwMyjMUOGWYazUjY5QuQ7dVQRAvUHKGSZYXtgxPGc6UJpS3aBObEkocl02GFMWkmxwZxmSjJK2u_e-hW3ZwnmQxLZDhKI8yI6HpiLboOB3PEcLteK7HvXePY3sQZTG4HJS9Im2Q4UVkZ1dkQBU2L6yE8lFb5OlKyEGGwRBsMicJ3OB0ybDO3ZkwNroklGLJXm40yH6TthQfJaklTbop1t3-y_uLXIPKoCskmNIqGBtpKyc4mbid95MJ52754c98ECiLt1SJCcIjYMMSSbfsVqs_BjRFcY3I2ChN7ykxnEcLmNNc6RsoDJVVHL4m-y-HTguaFTZR2fPsnW3Yf1FJdjdjzlMzlutkHumbe8Os67zAczWV8KCqDj6qfX0K7jYURkpb0k13nUBXvEWG9VTKh3uCCy7KjeBwp93e46u_g3ZPeC1RHzzuCa_V8ltiR66ujq7TWJug1yfQ2oZASCZXmaE1Ak_dzJdThhRfUr3QjCr0jE60mlXP1MdhpasCMRlbZ0V9CLI6VTa4KhYbxc5msbNR7G4WuxvFrQfi6fLN3wAAAP__QFkKgQ==

# Also works when creating an index.
statement ok
DROP INDEX geo_table@geom_index

statement ok
CREATE INVERTED INDEX geom_index ON geo_table(geom)

query T
SELECT url FROM [EXPLAIN ANALYZE SELECT k FROM geo_table WHERE ST_Intersects('SRID=26918;POINT(400003 4000003)'::geometry, geom) ORDER BY k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslFFP2zAQx9_3KU73AtU81U66Nnia1AJhy1ZallbaGK1QaE4QkcaZ7WxFqN99SsJGC6JQiT6k8t397fv_dLpbNL9SlDjy-_7BGAqdwlE4PIYz_8dJvxcMoDfo9U9_-rB7GIzGo2_9BtyVXteFl6TObXSREnz_7Ic-GHueZJa0oZk1uzujMDj86LT3hPfhZBgMxrstzjl3ofrjbmNHyk_-8Ngfh6esvGvegGF46IewfwrXU2SYqZgG0ZwMyjMUOGWYazUjY5QuQ7dVQRAvUHKGSZYXtgxPGc6UJpS3aBObEkocl02GFMWkmxwZxmSjJK2u_e-hW3ZwnmQxLZDhKI8yI6HpiLboOB3PEcLteK7HvXePY3sQZTG4HJS9Im2Q4UVkZ1dkQBU2L6yE8lFb5OlKyEGGwRBsMicJ3OB0ybDO3ZkwNroklGLJXm40yH6TthQfJaklTbop1t3-y_uLXIPKoCskmNIqGBtpKyc4mbid95MJ52754c98ECiLt1SJCcIjYMMSSbfsVqs_BjRFcY3I2ChN7ykxnEcLmNNc6RsoDJVVHL4m-y-HTguaFTZR2fPsnW3Yf1FJdjdjzlMzlutkHumbe8Os67zAczWV8KCqDj6qfX0K7jYURkpb0k13nUBXvEWG9VTKh3uCCy7KjeBwp93e46u_g3ZPeC1RHzzuCa_V8ltiR66ujq7TWJug1yfQ2oZASCZXmaE1Ak_dzJdThhRfUr3QjCr0jE60mlXP1MdhpasCMRlbZ0V9CLI6VTa4KhYbxc5msbNR7G4WuxvFrQfi6fLN3wAAAP__QFkKgQ==
