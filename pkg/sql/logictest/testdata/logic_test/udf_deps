statement ok
CREATE TABLE t (
  a INT PRIMARY KEY,
  b INT,
  def INT DEFAULT 10,
  c INT,
  drop_sel INT,  cascade_sel INT,
  drop_ins INT,
  drop_ins2 INT, cascade_ins2 INT,
  drop_ups INT,
  drop_ups2 INT, cascade_ups2 INT,
  drop_up INT,   cascade_up INT,
  drop_del INT,  cascade_del INT
)

# --------------------------------------------------
# SELECT
# --------------------------------------------------

statement ok
CREATE FUNCTION sel() RETURNS VOID LANGUAGE SQL AS $$
  SELECT a, b, cascade_sel FROM t;
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"sel\" depends on it
DROP TABLE t

statement ok
ALTER TABLE t RENAME COLUMN c TO c2

statement ok
ALTER TABLE t DROP COLUMN drop_sel

statement ok
SELECT sel()

statement ok
ALTER TABLE t DROP COLUMN cascade_sel CASCADE

statement error pgcode 42883 unknown function: sel\(\)
SELECT sel()

# --------------------------------------------------
# INSERT
# --------------------------------------------------

statement ok
CREATE FUNCTION ins() RETURNS VOID LANGUAGE SQL AS $$
  INSERT INTO t VALUES (1, 10, DEFAULT);
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"ins\" depends on it
DROP TABLE t

# NOTE: Postgres allows this. We cannot until we can rewrite the column names in
# the INSERT statement, or use column IDs instead.
statement error pgcode 2BP01 cannot rename column \"b\" because function \"ins\" depends on it
ALTER TABLE t RENAME COLUMN b TO b2

statement error pgcode 2BP01 cannot drop column \"b\" because function \"ins\" depends on it
ALTER TABLE t DROP COLUMN b

statement error pgcode 2BP01 cannot drop column \"def\" because function \"ins\" depends on it
ALTER TABLE t DROP COLUMN def

statement ok
ALTER TABLE t RENAME COLUMN c2 TO c3

statement ok
ALTER TABLE t DROP COLUMN drop_ins

statement ok
SELECT ins()

query III rowsort
SELECT a, b, def FROM t
----
1  10  10

statement ok
DROP FUNCTION ins

statement ok
CREATE FUNCTION ins2() RETURNS VOID LANGUAGE SQL AS $$
  INSERT INTO t (a, b, cascade_ins2, def) VALUES (2, 20, 200, DEFAULT);
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"ins2\" depends on it
DROP TABLE t

# NOTE: Postgres allows this. We cannot until we can rewrite the column names in
# the INSERT statement, or use column IDs instead.
statement error pgcode 2BP01 cannot rename column \"b\" because function \"ins2\" depends on it
ALTER TABLE t RENAME COLUMN b TO b2

statement error pgcode 2BP01 cannot drop column \"b\" because function \"ins2\" depends on it
ALTER TABLE t DROP COLUMN b

statement error pgcode 2BP01 cannot drop column \"def\" because function \"ins2\" depends on it
ALTER TABLE t DROP COLUMN def

statement ok
ALTER TABLE t RENAME COLUMN c3 TO c4

statement ok
ALTER TABLE t DROP COLUMN drop_ins2

statement ok
SELECT ins2()

query III rowsort
SELECT a, b, def FROM t
----
1  10  10
2  20  10

statement ok
ALTER TABLE t DROP COLUMN cascade_ins2 CASCADE

statement error pgcode 42883 unknown function: ins2\(\)
SELECT ins2()

# --------------------------------------------------
# UPSERT
# --------------------------------------------------

statement ok
CREATE FUNCTION ups() RETURNS VOID LANGUAGE SQL AS $$
  UPSERT INTO t VALUES (3, 30, DEFAULT);
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"ups\" depends on it
DROP TABLE t

# NOTE: Postgres allows this. We cannot until we can rewrite the column names in
# the UPSERT statement, or use column IDs instead.
statement error pgcode 2BP01 cannot rename column \"b\" because function \"ups\" depends on it
ALTER TABLE t RENAME COLUMN b TO b2

statement error pgcode 2BP01 cannot drop column \"b\" because function \"ups\" depends on it
ALTER TABLE t DROP COLUMN b

statement error pgcode 2BP01 cannot drop column \"def\" because function \"ups\" depends on it
ALTER TABLE t DROP COLUMN def

statement ok
ALTER TABLE t RENAME COLUMN c4 TO c5

statement ok
ALTER TABLE t DROP COLUMN drop_ups

statement ok
SELECT ups()

query III rowsort
SELECT a, b, def FROM t
----
1  10  10
2  20  10
3  30  10

statement ok
DROP FUNCTION ups

statement ok
CREATE FUNCTION ups2() RETURNS VOID LANGUAGE SQL AS $$
  UPSERT INTO t (a, b, cascade_ups2, def) VALUES (4, 40, 400, DEFAULT);
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"ups2\" depends on it
DROP TABLE t

# NOTE: Postgres allows this. We cannot until we can rewrite the column names in
# the UPSERT statement, or use column IDs instead.
statement error pgcode 2BP01 cannot rename column \"b\" because function \"ups2\" depends on it
ALTER TABLE t RENAME COLUMN b TO b2

statement error pgcode 2BP01 cannot drop column \"b\" because function \"ups2\" depends on it
ALTER TABLE t DROP COLUMN b

statement error pgcode 2BP01 cannot drop column \"def\" because function \"ups2\" depends on it
ALTER TABLE t DROP COLUMN def

statement ok
ALTER TABLE t RENAME COLUMN c5 TO c6

statement ok
ALTER TABLE t DROP COLUMN drop_ups2

statement ok
SELECT ups2()

query III rowsort
SELECT a, b, def FROM t
----
1  10  10
2  20  10
3  30  10
4  40  10

statement ok
ALTER TABLE t DROP COLUMN cascade_ups2 CASCADE

statement error pgcode 42883 unknown function: ups2\(\)
SELECT ups2()

# --------------------------------------------------
# UPDATE
# --------------------------------------------------

statement ok
CREATE FUNCTION up() RETURNS VOID LANGUAGE SQL AS $$
  UPDATE t SET b = 11 WHERE a = 1 AND cascade_up IS NULL
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"up\" depends on it
DROP TABLE t

statement error pgcode 2BP01 cannot rename column \"a\" because function \"up\" depends on it
ALTER TABLE t RENAME COLUMN a TO a2

# TODO(#120836): Track dependencies of SET columns.
# statement error pgcode 2BP01 cannot rename column \"b\" because function \"up\" depends on it
# ALTER TABLE t RENAME COLUMN b TO b2

statement ok
ALTER TABLE t RENAME COLUMN c6 TO c7

statement ok
ALTER TABLE t DROP COLUMN drop_up

statement ok
SELECT up()

query III rowsort
SELECT a, b, def FROM t
----
1  11  10
2  20  10
3  30  10
4  40  10

statement ok
ALTER TABLE t DROP COLUMN cascade_up CASCADE

statement error pgcode 42883 unknown function: up\(\)
SELECT up()

# --------------------------------------------------
# DELETE
# --------------------------------------------------

statement ok
CREATE FUNCTION del() RETURNS VOID LANGUAGE SQL AS $$
  DELETE FROM t WHERE a = 1 AND cascade_del = 1
$$

skipif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop table t because other objects depend on it
DROP TABLE t

onlyif config local-legacy-schema-changer
statement error pgcode 2BP01 cannot drop relation \"t\" because function \"del\" depends on it
DROP TABLE t

statement error pgcode 2BP01 cannot rename column \"a\" because function \"del\" depends on it
ALTER TABLE t RENAME COLUMN a TO a2

statement ok
ALTER TABLE t RENAME COLUMN c7 TO c8

statement ok
ALTER TABLE t DROP COLUMN drop_del

statement ok
SELECT del()

query III rowsort
SELECT a, b, def FROM t
----
1  11  10
2  20  10
3  30  10
4  40  10

statement ok
ALTER TABLE t DROP COLUMN cascade_del CASCADE

statement error pgcode 42883 unknown function: del\(\)
SELECT del()

statement ok
DROP TABLE t

# --------------------------------------------------
# DROP FUNCTION CASCADE
# --------------------------------------------------

statement ok
CREATE TABLE t1 (a INT PRIMARY KEY)

statement ok
CREATE TABLE t2 (a INT PRIMARY KEY)

# Create a chain of function dependencies:
# f1 -> f2 -> f3
# where f1 depends on f2, and f2 depends on f3
statement ok
CREATE FUNCTION f3() RETURNS INT LANGUAGE SQL AS $$
  SELECT COUNT(*) FROM t1;
$$

statement ok
CREATE FUNCTION f2() RETURNS INT LANGUAGE SQL AS $$
  SELECT f3() + (SELECT COUNT(*) FROM t2);
$$

statement ok
CREATE FUNCTION f1() RETURNS INT LANGUAGE SQL AS $$
  SELECT f2() * 2;
$$

# Test that we can't drop f2 without CASCADE due to f1's dependency
statement error pgcode 2BP01 cannot drop function "f2" because other objects \(\[test.public.f1\]\) still depend on it
DROP FUNCTION f2

# Test that we can't drop f3 without CASCADE due to f2's dependency
statement error pgcode 2BP01 cannot drop function "f3" because other objects \(\[test.public.f2\]\) still depend on it
DROP FUNCTION f3

# Test that DROP FUNCTION CASCADE works and removes dependent functions
statement ok
DROP FUNCTION f3 CASCADE

# Verify that all dependent functions were dropped
statement error pgcode 42883 unknown function: f1\(\)
SELECT f1()

statement error pgcode 42883 unknown function: f2\(\)
SELECT f2()

statement error pgcode 42883 unknown function: f3\(\)
SELECT f3()

# Clean up
statement ok
DROP TABLE t1

statement ok
DROP TABLE t2

# --------------------------------------------------
# DROP FUNCTION CASCADE with DEFAULT column references
# --------------------------------------------------

statement ok
CREATE FUNCTION next_day() RETURNS TIMESTAMP LANGUAGE SQL AS $$
  SELECT current_timestamp() + INTERVAL '1 day'
$$

statement ok
CREATE TABLE scheduled_jobs (
  id INT PRIMARY KEY,
  name STRING NOT NULL,
  created_at TIMESTAMP DEFAULT current_timestamp(),
  due_at TIMESTAMP NOT NULL DEFAULT next_day()
)

# Cannot drop the function without CASCADE since table depends on it
statement error pgcode 2BP01 cannot drop function "next_day" because other objects \(\[.*scheduled_jobs.*\]\) still depend on it
DROP FUNCTION next_day

# Test that DROP FUNCTION CASCADE works
statement ok
DROP FUNCTION next_day CASCADE

# Verify the table still exists but the column default was removed
statement ok
INSERT INTO scheduled_jobs (id, name, due_at) VALUES (2, 'backup2', current_timestamp())

# But we can't insert without specifying the due_at column now
statement error pgcode 23502 null value in column "due_at" violates not-null constraint
INSERT INTO scheduled_jobs (id, name) VALUES (3, 'backup3')

# Clean up
statement ok
DROP TABLE scheduled_jobs
