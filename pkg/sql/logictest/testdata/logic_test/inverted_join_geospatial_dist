# LogicTest: 5node-default-configs !5node-metadata

statement ok
CREATE TABLE ltable(
  lk int primary key,
  geom1 geometry,
  geom2 geometry
)

statement ok
INSERT INTO ltable VALUES
  (1, 'POINT(3.0 3.0)', 'POINT(3.0 3.0)'),
  (2, 'POINT(4.5 4.5)', 'POINT(3.0 3.0)'),
  (3, 'POINT(1.5 1.5)', 'POINT(3.0 3.0)')

statement ok
CREATE TABLE rtable(
  rk int primary key,
  geom geometry,
  INVERTED INDEX geom_index(geom)
)

statement ok
INSERT INTO rtable VALUES
  (11, 'POINT(1.0 1.0)'),
  (12, 'LINESTRING(1.0 1.0, 2.0 2.0)'),
  (13, 'POINT(3.0 3.0)'),
  (14, 'LINESTRING(4.0 4.0, 5.0 5.0)'),
  (15, 'LINESTRING(40.0 40.0, 41.0 41.0)'),
  (16, 'POLYGON((1.0 1.0, 5.0 1.0, 5.0 5.0, 1.0 5.0, 1.0 1.0))')

statement ok
ALTER TABLE ltable SPLIT AT VALUES (2), (3)

statement ok
ALTER TABLE ltable EXPERIMENTAL_RELOCATE VALUES (ARRAY[1], 1), (ARRAY[2], 2), (ARRAY[3], 3)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE ltable] ORDER BY lease_holder
----
start_key  end_key  replicas  lease_holder
NULL       /2       {1}       1
/2         /3       {2}       2
/3         NULL     {3}       3

query II
SELECT lk, rk FROM ltable JOIN rtable@geom_index ON ST_Intersects(ltable.geom1, rtable.geom) ORDER BY (lk, rk)
----
1  13
1  16
2  14
2  16
3  12
3  16

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT lk, rk FROM ltable JOIN rtable@geom_index
ON ST_Intersects(ltable.geom1, rtable.geom) ORDER BY (lk, rk)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElF1v2jwYhs_fX2E9R0U1b3AC_chRtpVJqRjpoAebqqjKkkdd1mBntjN1qvjvUxI2CAUn7EOcYew79-VHl_wM6msGLszHk_GbW1LIjLydBe_I3fjDzeSVPyUnV_78dv5-0iOrI9kjJfKxPpXp6FOG5Drwp0RWv70HFIv7lCf4RIIpUfo-5Rqlwlirk_r4_-URRleBatUjwexqPCOvP5KT-vu9EChwkeA0WqAC9w4YULCBggMhhVyKGJUSstx6rg76yRO4Awopzwtd_h1SiIVEcJ9BpzpDcOG2bJxhlKC0BkAhQR2lWfX5ms3LZbqI5HegMM8jrlzSt8rSoNAu8Rj1bAiXFESh1yVKRw8ILlvS7iA-_4ZSY3ItUo7ScposL0YJ9Fdi_JTLrbF6NiXesNfApJ6zl9Q-hLQkXE3sbCflemITIR6LnHwRKSeCu8Qrr_VCgop21KDdj-ocgjoXUqO0LpuYHjulnn0KFBaRjj-TDLlL2N7G4d7GdZGQCUpMdveEyx1oU9EXucXsRmQfwqiBwLorzbopbdn9yriDpW5B2ZJ6eESpW0g3pD4_ttQtqCup2eAvWm13V8ruqJTT_x2hWkC2hBodUagW0g2hLo4tVAvqT6HYP3omd1TOUOWCK-z0-g3K9xOTB6zfXCUKGeONFHFVUy-DKlf9kaDS9S6rFz6vt0rAzTAzhm1z2DaGHXPYMYaHjTDbDg_Nd26pHhnTZ-bwmTF8bg6fG8MX5vDFn0zs0jyxQYsmLZK1WWbWjLV4xsyibd88XP73IwAA___909Eu

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT lk, rk FROM ltable JOIN rtable@geom_index
ON ST_Intersects(rtable.geom, ltable.geom1) OR ST_DWithin(ltable.geom1, rtable.geom, 2) ORDER BY (lk, rk)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUVVFv2jwUff9-hXWfQDUFO9DSPKXfSiUqRjrgYVOFqoxcdVlTO7PN1qnqf5-coJVQsOn60r5h-x7uPcfnOA-gf-QQwnQwGnyYkaXKyfkk_kiuBp8vR6fDMWmcDaez6adRk6xK8ltK1G1VlZvka47kIh6OiSp_Rzco764zkeI9icdEm-tMGFQaF0Y3qpJDW0JX2HLBmiSe2Nr0V2a-ZaKxfkZJDcZt7dlgQv7_QhrVLM05UBAyxXFyhxrCK2BAgQOFAOYUCiUXqLVU9uihLBym9xB2KGSiWBq7PaewkAohfACTmRwhhJltOsEkRdXuAIUUTZLl5d9X40WFyu4S9RsoTItE6JC02rZpvDQhiRiNOMwfKcileWqiTXKDELJHuv8gQ_ETlcH0QmYCVTuoz_JMdqB_EYP7Qm1cQcQpibqbele7lPDDThiG56P4dNZv1qjQKNjJhr-EzVQqg6p9VGcRsQMaBQc7WwQvaWGFWl3cyVaxni5uJOXtsiDfZSaIFCGJrLrPfBv1KIn4VtF6DtF2K9bdSeeJhVQpKky36MStTlt4j2VLFm3Ga5BdI_RqI7D9s8D2y0Kbt0qrvjgNnlE20tB942nwsFml4fg1afC0WEsD67yHOPD9vcj39GLQ-hcnegbZcGLvjTvRw2blxP5rnOhpse5E9h6c6PnOTFAXUmjc673t2Bcb0xusXnktl2qBl0ouyjbVMi5x5UaK2lSnrFoMRXVkB1wHMyeYu8HcCQ7c4MAJ7tbAbBPcdXP2tO450Udu8JETfOwGHzvBfTe4_xrFTtyKdTw28ZjM5zK3zZjHZ8xttE3m88f__gQAAP__5mgOKA==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT lk, rk FROM ltable JOIN rtable@geom_index
ON ST_Intersects(ltable.geom1, rtable.geom) AND ST_DWithin(rtable.geom, ltable.geom1, 2) ORDER BY (lk, rk)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUVV1vGjsQfb-_wponUEzAXkiInzb3hkhEXDYFHlpFKNqyo2Sbxd7apk0V8d-r3aUNy4eX9ENK3rBnDuec4Yx5AvM5AQHj3qD334QsdEIuR8H_5Kb3_npw3h-S2kV_PBm_G9TJqiV5oEQ_FF2JDT8mSK6C_pDo_LN_h2p-G8sIH0kwJMbextKiNjizpla0H2ctjK4A-alOzocXWXP0Nbb3sayt1Sgpw3idBKOL3oj8-4HUCjH1KVCQKsJhOEcD4gYYUOBAwYMphVSrGRqjdFZ6yhv70SOIFoVYpgubXU8pzJRGEE9gY5sgCJhkrCMMI9TNFlCI0IZxkn99ochPdTwP9TegME5DaQRpNDPSYGEF8Rn1OUyXFNTCPpMYG94hCLakhwvpyy-oLUZXKpaom15Zy9bcgf5E9B5TvfEb-JwSv7018OKaEn7cEkJcDoLzSbde8kJ9b68d_hI7mY3VWE92Wnke60Cph0VKPqlYEiUF8TPvW7HKtXe2LXUoyUp7Le33473Ez1hpi7p5VvbisyPq8yOgMA_t7J4kKAVhexnbexmfiZSOUGO0m2e63CFtqBoqbTJeguyT0ClJYIcvBztsOZq8kWf3xetRIWVjPdqvfT0q7Kytx-mbWI8KP6v1YK0_uB_88HDyA8PpNX4lmhVCNqLZee3RrLCzFs3um4hmhZ8f0WR_6eneQTlCkypp8KAXuZW96RjdYfE_YNRCz_Baq1lOUxyDHJdfRGhsUWXFoS-LUiZwHcycYO4GcyfYc4M9J7hdArNNcNvtuYK640SfuMEnTvCpG3zqBHfd4O7vTOzMPbFWRUwqQlaVMnfMWEXOmDtom86ny3--BwAA__-jCRy4

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable JOIN rtable@geom_index
ON ST_Intersects(ltable.geom1, rtable.geom) AND ST_Covers(ltable.geom2, rtable.geom)
AND (ST_DFullyWithin(rtable.geom, ltable.geom1, 100) OR ST_Intersects('POINT(1.0 1.0)', rtable.geom))]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzsVUFv2jAYve9XWN-lIBmIE6DUp1QrTKlo0gGHTRWqMuJ1WVM7s52uVcV_n5JUKwlgUk27wQnb7_l9ed_35BdQvxKgMB9Pxx8XKJMJmsyCK3Qz_nI9Pfd81Lrw5ov552kbvUKSe4zkfYlKdPgtYegy8Hwki__uHRMPtzGP2BMKfNRS-jbmmknFVlq1Snw3xxD8yihWbXTuXyClb1fikckK0K4CS2R-b_Q9S5Ln37H-EfPWBgSjqgyxrDYKZqhaysl14PmLFulaiHSt9klNZQkYuIiYHz4wBfQGCGCwAYMDSwypFCumlJD50UsB9KInoBaGmKeZzreXGFZCMqAvoGOdMKCwyAVmLIyY7FmAIWI6jJPi-rJkN5XxQyifAcM8DbmiqNOzYbnGIDL9dq_S4R0DSta4ubbHH5nULLoUMWey51Tlt5oH-C9j_JTKeiNdGyN3UO-a6xS7e1pUcop-dC1K6WQanC9Gu1pjEYtYW7-J5Uzq6xNK6adxcDVezL6W2oAhyDRFLsGujV0Hu_29BtrvMTA37rV3w53mvfVuKsR9lqKfIuZIcIrcfl7VVhoKQ4Y7TRzuNXGIUc77jyYOqybut8_Za9-baxkXMmKSRRXLlusdBvuiI9LeWQ24W7pfkSbNY0eaxa5nd3pOw-AdUK8Fr38MXj14BwzcCN7pMXjbwbObT7_dcPqdTsPZP6Bdm_3Bcfbrs3_AwI3ZHx1n3_zo7LBvxlQquGKN3hQrf5RYdMfKF0yJTK7YtRSrQqZcBgWv2IiY0uUpKRceL4_yAjfJxEi2zWTbSHYqZFInO-ayLbN038gemMkDI3loJg__5aNPjeSRWXlkJJ-ZyWfvKnu5_vAnAAD__96MMnU=

# This query performs a semi-join, which is converted to an inner join by the
# optimizer.
query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk FROM ltable WHERE EXISTS (SELECT * FROM rtable WHERE ST_Intersects(ltable.geom2, rtable.geom))]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElVFP2zAQx9_3Kax7opu71klaIE-ZRqZ16lrWIg0JVSg0J8gIcWY7Ewj1u09JKtKG1k4Ho49J7uf7-ey_8gjydwwuTP2h__mMZCImXybj7-TCPz8dfhqMyMHJYHo2_TFskWVJfFtWxCq4ipH8_OpPfOKf51XkYFnzviwRqyVSXUaJQiFxruRBSX-8Rn5n0WVh8dRqzYBCwkMcBXcowb0ABhQsoGDDjEIq-Byl5CL_9FgUDsJ7cLsUoiTNVP56RmHOBYL7CCpSMYILZ3mDCQYhik4XKISogiguli9VvFREd4F4AArTNEikS9qdvOk4Uy7xGPVsmC0o8ExVTaQKrhFctqDNRQbJHxQKw288SlB07HWXchBePojLKAnxHugT4d-nojZFz6LEc1qrmpbO1NrFNDdcTqy_0bKa2JDz2ywlv3iUEJ64xMu3NR5tsu2t225VtXdRPYmkipK56hyvi3r51RmLEAWGecNat2qBqwdyE8ibZ_RsURk5W42qdXjZq77Oh3KhrdrMMng_jWzrvHoN7LJkk99GtRFv87TDerXKzb37a71Z8ySyZknsWO0iKDtn0aBSy6KzxywaTFeyeLjvLBpUq0vdfbMwslcNo_3KYbSaB8JqGAi7_S9xMIjU4tDbYxwMpitxONp3HAyq1bVibxYH61Xj4PzHf9OGxhOUKU8kNvrzdHN1DK-x3KrkmZjjqeDzok35OC644kWIUpVfWfkwSMpPueAqzLSwpYctLWzrYbsOs1XYWYPZbjDrvoju6WlHu2sD3NMfVl8_s76WPtTDh1r4SA8faeFjPXz8kqPWw6ajNtCG02L6bJlofbiYIV1MHy9myBd7dsvXcceAP7vmuxyagTadmgk3DV6fsjo9W7z7GwAA__9Kzz7E

# Left joins are converted to paired joins by the optimizer.
query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable LEFT JOIN rtable ON ST_Intersects(ltable.geom1, rtable.geom)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlF9vmzwUxu_fT2Gdq1Zy3gRI0pYrpo1KVFnoEiZNqlDF8FnFSm1mm6lVle8-gaPlzxpDtqtcGp_H53kOP51XUD9K8GEZzsL3CallSa4X8UdyF365nb2L5uTsQ7RMlp9m52RdUj5SIh9NVamzryWSWXidkJs4mhNpPsRzovR9wTVKhblWZ6bw_wcUTw5dV7Wn8xQocMFwnj2hAv8OHKDgAgUPUgqVFDkqJWRz9doWRuwZ_BGFgle1bj6nFHIhEfxX0IUuEXxImvcXmDGUwxFQYKizomyfN06CShZPmXwBCssq48ong2HTNK61TwKHBi6kKwqi1psmSmcPCL6zov2NRPwnSo3sRhQc5dDb9ZK8VOib6cWfk3DRzhAomPkEzXzuC87wGejvl8LnSu4NN3ApCcbnQOFbIZUm30XBScFJlRUS2aA57kSjgUeDycGA7jEBm2DrQU-PCrf5ATMhHuvKuBbcJ0EzpT8IakNOm5AKc8FZV0rvYD7vYL5NrJoLyVAi28mUrt6YwFwMRDW82it8u_V4p7XTH2KnH8RDd9AydjTGHVb2MB6fHsYdAbcwvjhJjN3-LLk9WfIGf0NSh5E9kianR1JHwC2SLk-SpI6Fv0BVCa6w174bNQsT2QOa7apELXO8lSJv25hj3OraDwyVNreOOUTcXDUGt8WOVezaxa5V7O2InX2xZ7c9srceW9UTu3hiFU_t4um_hL6wii_tnS-t4iu7-Ooo2-nqv18BAAD__94Qg5I=

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable LEFT JOIN rtable@geom_index
ON ST_Intersects(rtable.geom, ltable.geom1) OR ST_DWithin(ltable.geom1, rtable.geom, 2) ORDER BY (lk, rk)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVV1vGjkUfd9fYd0nUEzAHiDET5PdEImIZbLASq0iFE2Z22SawZ7apk0U8d-rmaENEPBAP154tH2Pz_G598gvYD4nIGDU7Xf_GZO5TsjVMPiX3Hbf3fQvegNSueyNxqP_-lWyLEkeKdGPRVViww8Jkn73akyug96A6HzDv0c1u4tlhE8kGBBj72JpURucWlMpSk6zErq8IF-wKgmGWW30NbYPsaysnlGyBuNZ7WV3SP5-TyqFoOoEKEgV4SCcoQFxCwwocKDgwYRCqtUUjVE6O3rJC3vRE4gGhVimc5ttTyhMlUYQL2BjmyAIGGekQwwj1PUGUIjQhnGSX1_I81Mdz0L9DBRGaSiNILV6RhrMrSA-oz6HyYKCmttXEmPDewTBFnR_IT35BbXF6FrFEnXdW9cyfk5RFG0I_h93h3kzgMKbdgD9cVP3KdUbrfE5JX5zsw_FLiX8tCGEuOoHF-NOFSh8jLWx5JOKJYklScNYY1TLlmvPp75H_dZOE_ghJmSPXzajfZABr03qK_U4TwvVSgriZ06-mVG_TYnPtxrRfmuEwamSUZkT3k4PvEM8GCltUdfP19_vsxPq8xOgMAvt9IEkKAVhOxmbOxlfiZSOUGO0nWey2CJtoGoqrTO-BtklobUmge0fQ7ZfDOu8lqfk4CCWSNkIYvM4g1hiwkoQz442iCUeLIPIGr8xiXz_GPA9Y-DVfiYEJUI2QtA6zhCUmLASgs7RhqDEg-8hYH_oO9pCOUSTKmlwr1-mkf1TGN1j8bcZNddTvNFqmtMUyyDH5RsRGlucsmLRk8VRJnAVzJxg7gZzJ9hzgz0nuLkGZpvgpvvNJdQtJ7rtBred4DM3-MwJ7rjBnV9x7NztWKNkTEqGrGzK3GPGSuaMuQdt8-WTxV_fAgAA__8o6IH0

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable LEFT JOIN rtable@geom_index
ON ST_Intersects(ltable.geom1, rtable.geom) OR ST_DWithin(rtable.geom, ltable.geom2, 2) ORDER BY (lk, rk)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzclV9v2jAUxd_3Kaz7BKop2OFf85RupRIVIx0waVOFqozctVmDndlma1Xx3ackbIW0OKm2vfDoP8fn-udz5UfQ32NwYToYDd7NyErF5HzivydXg0-Xo9PhmNTOhtPZ9MOoTjZb4jtK1F2-KzbBlxjJaHA-Ixf-cExUNuHdoFxeRyLEe-KPiTbXkTCoNC6MruWa43QLoxtBNqoTf5LuDX9G5jYSta0lSrZUnBKe7j0bTMjbz6SWF1SfAwUhQxwHS9TgXgEDChwoODCnkCi5QK2lSpces43D8B7cFoVIJCuTTs8pLKRCcB_BRCZGcGGWuk4wCFE1W0AhRBNEcXZ8XpGXqGgZqAegME0CoV3SaHKYrynIlXk6V5vgBsFla1rdeyh-oDIYXshIoGo6u_azhwTdnLz_cTaYZPyBwrMXAPrnpMF9ogqv4XFKvE4Rveeks5Tw45bruucj_3TWrwOFr5HShnyTkSCRIEkQKQwb6RAo-CvjEo9Rj1PPoV6bet29HPhrOKT33zxB91UMnp5mJOXdKskLl8IlXjstuJjMjEXvGYseJSmPIguNCynCMhjtvQyc1zCYSmVQNU927--xI-rxI6CwDMzilsQoXML2Orb3Oj4ZSRWiwvBln_n6hdLGsiGTJuM7kn0ldHZKYNWbj1VrviZvNJ2K7VfiXmi_9sG2XwmHrfbrHWz7lTDYtB9r_cP-49XDzyuG32lUjH6JdyH6nYONfgmHrej3Dzb6JQx-R5_9p6_nBcsJ6kQKjZV-lFb6J2F4g_k_puVKLfBSyUVmkw_9TJdNhKhNvsrywVDkS2mB22JmFXO7mFvFjl3sWMXtHTEritv2O5dYd6zqrl3ctYp7dnHPKu7bxf2_IXZiJ9YqiUlJyMpSZo8ZK8kZswetePP5-s2vAAAA__9Rtnq9

query T
SELECT url FROM [EXPLAIN (DISTSQL)
WITH q AS (
  SELECT * FROM ltable WHERE lk > 2
)
SELECT count(*), (SELECT count(*) FROM q) FROM (
  SELECT lk, rk
  FROM q
  LEFT JOIN rtable ON ST_Intersects(q.geom1, rtable.geom)
) GROUP BY lk]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUU09vm04Qvf8-xWhOJtpfbSDtgRNuShoiCinGSqPUsghMLGqyi3eXKlHk714tOGliyag-ofnzZt577Dyj2tTo4SyIgrMMWlnDeZp8g9vgx1U0DWMYfQln2ex7ZMF1mF3ABqYzGO26T_reWud3NcH1RZAGUK_hZzuZuASOBbu-QrRcj04s9op8yfQDNrvvS7VeM5DrXQ2i4DyDyySMQfaLkhiUXlZck1RUaDXafFiReLDZrqGLLAu-psn8Cj7fQL1eIEMuSorzB1Lo3aKNC4aNFAUpJaRJPXcNYfmI3oRhxZtWm_SCYSEkofeMutI1oYe1KPIaVJFzuGvv70nCZDxBhiXpvKq78UmrPfBt5ju42DIUrf47Tul8RejZW_bvK0P-m6Sm8lJUnOTYfr8te2rI631K5lmQdm4hw94O39ixrHhJj8heJwWPjdyz0XcY-KcWMryvpNLwS1QcKg5NXkkq_zchsjfSmO8y_-NBgc4xAo2wlPKS5Ng5Slwjq4dcPiHDSIh12_SsBffAdw3b_bfSifxkRCoqBC-HVR4U5x4jbrpaSVrlWsix-16cb_7kNL5Zxkm2jOdRNPJtw-0smcfZMk2uZyMTpsRLkh4Y8rsjebkgcyQb6yDP02N4pqQawRW943ho8mS7YEjlivrjUaKVBV1JUXRr-jDpcF2iJKX7qt0HIe9LhuBbsD0IdobBziDYHQa7g-DTPfBi-9-fAAAA__-Mnap8

# Anti joins are also converted to paired joins by the optimizer.
query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk FROM ltable WHERE NOT EXISTS (SELECT * FROM rtable WHERE ST_Intersects(ltable.geom2, rtable.geom))]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlFFvmz4Uxd__n8K6T81fzhIgSVueqDaqUWXQJUyrVEUVi-8qVmoz20ytqnz3yRCtCWocsj3l0XCO7_ldHfkF1M8CfJiH0_B9SipZkMtZ8onchjfX04soJicfonk6_zztkbWkeGgUhc6-FUi-fgxnIYmTlIQ3RklO1rr_G5nclCl9l3ONUuFSq5Pmhnf3KB5duhbWp15vARS4YBhnj6jAvwUHKLhAwYMFhVKKJSolpPn1Ugsj9gT-kELOy0qbzwsKSyER_BfQuS4QfEjNgBlmDOVgCBQY6iwv6uubKEEp88dMPgOFeZlx5ZP-wAxNKu2TwKGBB4sVBVHp1yFKZ_cIvrOi3YNE_BdKjexK5BzlwNvOkj6X6JNpeJmS5EsazshVEsVAoVlQYBZ0l3OGT0D_3BQ-lbK13cClJBj1gML3XCpNfoick5yTMsslsr45bqK5NPBoMN4J6B4CaMDWi57shLuI06jF9rr_qRAPVdmEFtwngVlSEr_FODGMCpeCMzvkTjZvJ9srUsWFZCiRbfEsVm_Qx6IvysF5S_j26NHWaKd7gZ1uBR64_bpfB1d4T5RWhUfHV-E9gBsVPj26Crvde-R27JHX_5sW7QnSatH4-Fq0B3CjRWdH16I9j_wMVSm4wk7v3NA8lMjusXlVlajkEq-lWNZjmmNS--oPDJVu_jrNIeLNLxNw0-xYza7d7FrN3pbZaZs9e-yhffTI6h7bzWOreWI3T_4F-tRqPrNPPrOaz-3m84NiL1b__Q4AAP__dTiGJQ==

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk FROM ltable
WHERE NOT EXISTS (
  SELECT * FROM rtable WHERE ST_Covers(ltable.geom1, rtable.geom) AND lk > 5 AND rk > 12
) ORDER BY lk]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcVV1vm0oUfL-_4ug82feurw3YjrNPpA1RiVxIMVVTpVZEzWlETVi6C1GiyP-9Atz4Q_XaaZ-Sx92d4czMjpZHVD9S5Dhxxs7bEEqZwlngv4cr5_JifOJ60Dp1J-Hkw7gNS0g6bxBpEX1NCT69cwIHPD8E57JCQmuJ-7eByXVYSxXXM3FHUrUa-v83JG4NtkTVqzaceKfQSufwpez1LIJBe7kln7YMs90GPzh1AnjzGdL5FBlmIiYvuiWF_AoNZGgiQwunDHMpZqSUkNXRYw1043vkPYZJlpdFtT1lOBOSkD9ikRQpIcewkhRQFJPs9pBhTEWUpPXnG_F2LpPbSD4gw0keZYpDp1sN9cuCg20w28TpgqEoi9UQVUQ3hNxYsMOFuNkdyYLic5FkJLvWppbwIScOY-csBP9j6ARw7rseMmwitatIr5MspntkT19y7nMJq7uwTQZ2v11J96BlG0_Jc85dLxwt87etVf6_TpDht0SqAr6LJIMkgzxKJMWdarkRBbMtZg92BmI-J5AqiOXFDHeGceKF7lYWq_saCzEv80a0yDjYVmN-K5Nh5U_RTGSx3uBOX9ZOXys7QsYkKd50Yhv_4XTxG_Oe6Ii8e7yB3jW9vzHdOLzvxmF975qduo7PbvweKVuN77_-xu8JZK3xRy-q8ebhnTMP7JzV-ZPG7RGy1bjB62_cnkDWGjd6UY3b8-8ISOUiU3TQ-9mrHmCKb6h5sJUo5YwupJjVY5qlX_PqjZhU0ZwazcLNmqNK4DrZ0JJNPdnUkq0NsrFNtvSye_rRfS17oCcPtOShnjz8G9NHWvJIP3mkJR_rycfPkj1d_PMzAAD__yZUqzs=

# Bounding box operations.
statement ok
SET CLUSTER SETTING sql.spatial.experimental_box2d_comparison_operators.enabled = on

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable JOIN rtable@geom_index ON ltable.geom1 ~ rtable.geom]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElMGO2jwQgO__U1hz2pXMD0mAhZxStVTKiiZb4FBpFa1SPEIpwU5tZ0WF2GevkqBCKJjQSuUW2_N5Pnsm3oD6noIL09F49H5GcpmSj5PwE3kefXkav_MDcvfBn86mn8f3ZBeSLimRyyoq1fHXFMlj6AdElt_eAsXqJeEM1yQMdgH_F5MWedvFlMMIKHDBMIhXqMB9Bgso2EDBgYhCJsUclRKyWNqUgT5bg9uhkPAs18V0RGEuJIK7AZ3oFMGFWbH9BGOGst0BCgx1nKTl9pWJl8lkFcsfQGGaxVy5pNUukoa5dolnUc-GaEtB5HqfROl4geBaW9pcxOevKDWyR5FwlG2n7vLbVQH9RYzWmSRKv8zFK0p159mUeN37miL1nLOW9jWWhd3utvonDfe3NRZimWfkm0g4EdwlXnGkMCCeTd6I1zv0Oy_nnJXbO-VcSIYSWU0o2p7QD0RLZO3hUeDp1N1aaqt5G1nN2qhtt8oqX91IF1SOGql7o0a6YHnQSA__vpHs5tW0G1bTaf1JLS-IHNWyd6NaXrA8qOXgto_CCbkJqkxwhY3--U7xaCBbYPXCKJHLOT5JMS_TVMOw5MoJhkpXq1Y18Hm1VAgewpYRts2wbYSdGmwdw45Zu2NO3TXSPTPcM8J9M9z_m0M_GOGBOfPACA_N8PAq7Wj7388AAAD__5r_BqA=

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable JOIN rtable@geom_index ON rtable.geom ~ ltable.geom1]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElFFv2jAQx9_3Kax7aiUzSAIU8pRpY1IqRjrgYVIVVSk5oYxgZ7ZTUSH62ScnbBAGJmzSeIvP9_f_57uL1yB_pODCZDAcfJySXKTk8zj4Qh4H3x6GH_wRufnkT6aTr8Nbsk1JF5SIRZmVqug5RXIf-CMiim9vjnz5lLAYVyT4FXyvg-Rtm16srBAoMB7jKFqiBPcRLKBgAwUHQgqZ4DOUkgu9tS4S_XgFbotCwrJc6XBIYcYFgrsGlagUwYWpPn-MUYyi2QIKMaooSYvjS28vE8kyEq9AYZJFTLqk0dSmQa5c4lnUsyHcUOC52plIFc0RXGtD64P47AWFwvieJwxF06my_FEqoL8Vg1UmiFRPM_6CAuPn1xvPpsRr31YoqeecBLUvAdWA24J1j0LuCjbkfJFn5DtPGOHMJZ6-VTAiXoe8Ea9SxdNwzkm4HVPOuIj15StA4eYI_og3eNbsHyQet25XrK36k2TVm6Sm3SgaffEsnUE5mKX29WbpDOjeLN39_1my6zfUrtlQp_E37TwDctDOzvXaeQZ0r5296z4NR-DGKDPOJNb681v66cB4juU7I3kuZvgg-KywKZdBoSsCMUpV7lrlwmfllgbcF1tGsW0W20axUxFbh2LHjN0yW7eN6o5Z3DGKu2Zx918ufWcU98zOPaO4bxb3L8ION-9-BgAA__9vVwoz

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk FROM ltable JOIN rtable@geom_index ON rtable.geom && ltable.geom1]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlM-O2jAQh-99CmtOu5Ip-QMs5JSqpVJWlGyBQ6VttErxCKUEO7Wdigrx7lUSWggFE9oDvSBi-_N89m_kDahvKXgwHY6Gb2cklyl5Pwk_kOfhp6fRm2BM7t4F09n04-ie7JakS0rkslqV6vhLiuQxDMZElv_9BYrVS8IZrkn4a_B1MUg-55bl9KrfHVlO2BFQ4ILhOF6hAu8ZbKDgAAUXIgqZFHNUSshialMuDNgaPItCwrNcF8MRhbmQCN4GdKJTBA9mxf4TjBnKtgUUGOo4Scvtq9p-JpNVLH8AhWkWc-WRVrsoGubaI75NfQeiLQWR630RpeMFgmdvaXORgH9HqZE9ioSjbLt1lz9uDehvYrjOJFH6JeEapcK5Vne-Q4nfua9pUt89a-pcY1oY7m6sd9Jyf2MjIZZ5Rr6KhBPBPeIXxwrHxO_WY_ZrN3re0z3rudfLuZAMJbKaW7Q9cZKxaImsPThaeLp0p1babt5VdrOuajutMvSr--qCylFfdW7YVxdMD_rq4aZ95TQP12kYrtv6m2gviBxF271htBdMD6Lt_zdPxgnPCapMcIWNXgSreFKQLbB6f5TI5RyfpJiXZarPsOTKAYZKV7N29RHwaqoQPIRtI-yYYccIuzXYPoZds7ZlLt0x0l0z3DXCPTPc-5dDPxjhvrly3wgPzPDgKu1o--pnAAAA___waBaG

# Tests where the table with the inverted index has multiple columns in the primary
# key.
statement ok
CREATE TABLE rtable2(
  rk1 int,
  geom geometry,
  rk2 int,
  primary key (rk1, rk2),
  INVERTED INDEX geom_index(geom)
)

statement ok
INSERT INTO rtable2 VALUES
  (11, 'POINT(1.0 1.0)', 22),
  (12, 'LINESTRING(1.0 1.0, 2.0 2.0)', 24),
  (13, 'POINT(3.0 3.0)', 26),
  (14, 'LINESTRING(4.0 4.0, 5.0 5.0)', 28),
  (15, 'LINESTRING(40.0 40.0, 41.0 41.0)', 30),
  (16, 'POLYGON((1.0 1.0, 5.0 1.0, 5.0 5.0, 1.0 5.0, 1.0 1.0))', 32)

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk1, rk2 FROM ltable JOIN rtable2@geom_index
ON ST_Intersects(ltable.geom1, rtable2.geom) ORDER BY (lk, rk1, rk2)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlF1v2jAUhu_3K6xzVVQzsAO0zVW2lUlUDDroxaYKVRk56rIGO7OdqVPFf5-cdCvJGifsQ-0NIsl58z45euQ70F8T8GE5no7fXJBMJeTtYv6OXI4_nE9fTWbk4HSyvFi-n3bI_UhyQ4m6YfaHF7OJCT8lSM7mkxlR-X8eXKPcXMUiwlsynxFtrmJhUGlcG31QzL-0I_Y1RSK_7JD54nS8IK8_koPdns4KKAgZ4SzcoAb_EhhQ4EDBgxWFVMk1ai2VfXSXD06iW_D7FGKRZsbeXlFYS4Xg34GJTYLgw4UtXmAYoer1gUKEJoyT_PUFYpCqeBOq70BhmYZC-6Tbs6XzzPgkYDTgsNpSkJl5KNEmvEbw2Za2B5mIb6gMRmcyFqh6Xpnl95UC_RUZ36aqst6AUxIMOiVOGng0GNbS8n1oLeX91kaPkz6sbSrlTZaSLzIWRAqfWIyBJas6kUOPStD5aB2xtw_xUiqDqndSpg3YIQ34IQ28Q6CwCc36M0lQ-ITVtg5qWx_KpIpQYVTftdo-gjiTXZn2GC_F6jCGJQzW3nLWzvIe7-YS7u15A0rF88ETe95Au-P50TPxvIH43nPW_8ei8_aG8ZaGed0_8asBpOLX8In9aqDd8ev4mfjVQPzTL_YfD9JHaheoUyk0tjob-_Z0xegai1NZy0yt8VzJdV5TXM7zXH4jQm2Kp6y4mIjikQXcDTNnmLvD3Bn23GHPGR6UwqwaHri_uaF66EyP3OGRM3zkDh85w8fu8PHfbOzEvbF-gyYNkjVZ5taMNXjG3KJVv3y1ffEjAAD__z3N3qQ=

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk, rk1, rk2 FROM ltable LEFT JOIN rtable2@geom_index
ON ST_Intersects(ltable.geom1, rtable2.geom) ORDER BY (lk, rk1, rk2)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUVV1v2jAUfd-vsO5TUc3ADh9tnrKtqUTFSAdM2lShKkvuuqzBzmwztar475OTbgVWHNjHAy9I_jj3nHM5N34A_S0HHybhMHwzJQuVk_Nx9JZchR8uh68GI3J0NphMJ--GDfJ4Jb-lRN0y-8Oru7mJP-VIhuH5lFxEgxFR5QYPblDOrzOR4h2JRkSb60wYVBoTo48q0Et7xdaqEOWyQaLxWTgmrz-So1WyxgwoCJniKJ6jBv8KGFDgQMGDGYVCyQS1lsoePZQXB-kd-G0KmSgWxm7PKCRSIfgPYDKTI_gwtcRjjFNUrTZQSNHEWV6WryQGhcrmsboHCpMiFtonzZYljRbGJwGjAYfZkoJcmCcSbeIbBJ8t6e5CBuI7KoPphcwEqpa3rmV6X6BftTh6Pw3HZaOBwu-tBvqrVHhXqI22B5ySoNMACp8zpQ35KjNBMkGKOFOYNu1yzRsNPBp0adDbapLvY9Kae2x2bz-DT__CUMrbRVEpl8InVmHHit6MWOm1b71qTKRI68yWdbbZ9PaxOZHKoGqdrlsM2DEN-DENvGOgMI9N8oXkKHzCtrJ2trI-kUmVosJ0O9ds-YzEkWzKosX4GmybjO6aDLb7RLHdJqrFm2Xg956pGikbM9U5zJmqMbkyU_1Dnqkam48zxdr_eKj47mnmO6bZa_5JlmuEbGS5e5hZrjG5kuWTQ85yjc2fWWb_8YF4hnaMupBC407f_LZ9NTC9weq10XKhErxUMilpqmVU4sqNFLWpTlm1GIjqyApcBTMnmLvB3An23GDPCe6sgdkmuOP2XEPddaJ7bnDPCe67wX0n-MQNPvmbjp26O9auiUlNyOpS5o4Zq8kZcwdt0_ls-eJHAAAA___Z7kVN


query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk FROM ltable WHERE EXISTS (SELECT * FROM rtable2@geom_index
WHERE ST_Intersects(ltable.geom1, rtable2.geom)) ORDER BY lk]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlVFP2zwUhu-_X2GdK_rNXeskLZCrbCPTOnUta5HGhCoUGgsyQpzZzgRC_e-Tk440KbXT0QGXic_j8-bYj3IP4mcMLkz9of_hBGU8Rh8n4y_ozD89Hr4bjNDe0WB6Mv06bKFlSXxdVMQyuIgp-vbJn_jIP1VVaG9Z839RwvMSy7uk7OY8SkJ6uywX8jxKJOWCzqXYK3Z6q6oI_gPlj60WGk-O_Al6_x3F1zPAkLCQjoIbKsA9AwIYLMBgwwxDytmcCsG4WrrPCwfhLbhdDFGSZlK9nmGYM07BvQcZyZiCCyeq24QGIeWdLmAIqQyiON--yOWlPLoJ-B1gmKZBIlzU7qim40y6yCPYs2C2wMAyWTYRMrik4JIFbh5kkPyiXNLwM4sSyjt2Ncv6KAE_IP5tymsz9SyMPKdVyYk9G3u9jWmtbdKqlMup9R9PWo5tyNh1lqIfLEoQS1ykYjgq2eix0P1Ws-Ha28Q9ioSMkrnsHFbDeuoKjXlIOQ1Vw1q3coOLO3QViKs1erYoEzkbE5X7sKJXfZ83xUYbYxPLkPthZBvn1dt5uhFrs7RDepXyTe37lfakuZSkmZQdq507s7WWhig1LZ0X1tKQdkXL_degpSFueb-7z-Yl2amX9o69tJqLYTUUw27_jRaGIDUtei-shSHtihYHr0ELQ9zyepFn08LaqRbOP_xdPdJ4QkXKEkEb_Ym6KjoNL2nxqYJlfE6POZvnbYrHcc7lL0IqZLFKiodBUiypgKsw0cKWHra0sK2H7TpMVmGnApPtYNJ9Et3T0472qw1wT39Yff3M-lp6Xw_va-EDPXyghQ_18OFTjloPm47aQBtOi-jdMtF6uYjBLqLXixj8Imu3vIo7Bnztmm9zaAbadGom3DR4vWV1erb473cAAAD__7TDS8A=

query T
SELECT url FROM [EXPLAIN (DISTSQL)
SELECT lk FROM ltable WHERE NOT EXISTS (SELECT * FROM rtable2@geom_index
WHERE ST_Intersects(ltable.geom1, rtable2.geom)) ORDER BY lk]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlFFv0z4Uxd__n8K6T-sflzZJ2215ymCZyFSSkQYxNFVTqC9TWGYH20Wbpn535KSwtaxuCk99dHyO7_k5R34E9b0EHybhOHybkbksyVmavCdX4eXF-CSKycFpNMkmH8YdspSUt42i1PmXEsmnd2EakjjJSHhplORgqfu_kcla5gY3KO6uC87wfmlR-rrgGqXCmVYHzWmvjcqhv0z1stMhSXoapuTNZ1LeToECFwzj_A4V-FfgAAUXKHgwpVBJMUOlhDRbj7UwYvfg9ykUvJpr83lKYSYkgv8IutAlgg-ZmZZizlD2-kCBoc6Lsj6-yRVUsrjL5QNQmFQ5Vz7p9szQZK59Ejg0cGG6oCDm-mmI0vkNgu8saPsgEf-BUiM7FwVH2fNWs2QPFfpkHJ5lJPmYhSk5T6IYKPx5xUB_HxXeV3LtrgOXkmDQAQpfC6k0-SYKTgpOqryQyLpmucJGA48GQxqMNkK6u0AauOVljzYCnsRZtM739BPGQtzOqya44D4xAQcmc_wS6qFBVTgTnNlZN_J5G_mesIRkKJGtEgXOK5guXriEWHRF1TteUW-aPliZ7rTvstOuyz23W1dt5zZvibLW5sF-tnkL5LM2H-5lm932fXJb9snr_k2btgRZa9NwP9u0BfJZm472sk1b3v4UVSW4wlbvXt88nMhusHlolZjLGV5IMavHNMuk9tUfGCrd7DrNIuLNlgn43OxYza7d7FrN3orZWTd79th9--iB1T20m4dW88huHv0L9KHVfGSffGQ1H9vNxzvFni7--xkAAP__UJCTJA==
