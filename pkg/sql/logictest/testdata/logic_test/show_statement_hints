# LogicTest: !local-prepared
# cluster-opt: disable-mvcc-range-tombstones-for-point-deletes

statement ok
CREATE TABLE xy (x INT PRIMARY KEY, y INT, INDEX (y));

statement ok
CREATE TABLE ab (a INT PRIMARY KEY, b INT, INDEX (b));

# Test with no hints.
query ITTT colnames
SHOW STATEMENT HINTS FOR SELECT * FROM xy WHERE y = 10;
----
row_id  fingerprint  hint_type  created_at

query ITTTT colnames
SHOW STATEMENT HINTS WITH DETAILS FOR SELECT * FROM xy WHERE y = 10;
----
row_id  fingerprint  hint_type  created_at  details

statement ok
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE y = _',
  'SELECT * FROM xy@xy_y_idx WHERE y = _'
);

# Test SHOW STATEMENT HINTS without DETAILS. Note that hints are shown for the
# fingerprint with constants removed.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR SELECT * FROM xy WHERE y = 10];
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints

# Test SHOW STATEMENT HINTS with DETAILS.
query TTT colnames
SELECT fingerprint, hint_type, details
FROM [SHOW STATEMENT HINTS WITH DETAILS FOR SELECT * FROM xy WHERE y = 10];
----
fingerprint                   hint_type     details
SELECT * FROM xy WHERE y = _  inject_hints  {"donor_sql":"SELECT * FROM xy@xy_y_idx WHERE y = _"}

# Case with a placeholder in the requested statement.
query TTT
SELECT fingerprint, hint_type, details
FROM [SHOW STATEMENT HINTS WITH DETAILS FOR SELECT * FROM xy WHERE y = $1];
----
SELECT * FROM xy WHERE y = _  inject_hints  {"donor_sql":"SELECT * FROM xy@xy_y_idx WHERE y = _"}

# Case with a CTE.
statement ok
SELECT crdb_internal.inject_hint(
  'WITH cte AS (SELECT * FROM xy WHERE y = _) SELECT * FROM cte',
  'WITH cte AS (SELECT * FROM xy@xy_y_idx WHERE y = _) SELECT * FROM cte'
);

query TTT colnames
SELECT fingerprint, hint_type, details
FROM [SHOW STATEMENT HINTS WITH DETAILS FOR WITH cte AS (SELECT * FROM xy WHERE y = 10) SELECT * FROM cte]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                                                   hint_type     details
WITH cte AS (SELECT * FROM xy WHERE y = _) SELECT * FROM cte  inject_hints  {"donor_sql":"WITH cte AS (SELECT * FROM xy@xy_y_idx WHERE y = _) SELECT * FROM cte"}

# Test with non-existent fingerprint.
query ITTT
SHOW STATEMENT HINTS FOR SELECT * FROM nonexistent WHERE x = 1;
----

# Test with multiple hints for same fingerprint.
statement ok
SELECT crdb_internal.inject_hint(
  'SELECT * FROM xy WHERE y = _',
  'SELECT * FROM xy@primary WHERE y = _'
);

query I
SELECT count(*) FROM [SHOW STATEMENT HINTS FOR SELECT * FROM xy WHERE y = 10];
----
2

query TT
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR SELECT * FROM xy WHERE y = 10]
ORDER BY created_at DESC, row_id DESC;
----
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

query TTT colnames
SELECT fingerprint, hint_type, details
FROM [SHOW STATEMENT HINTS WITH DETAILS FOR SELECT * FROM xy WHERE y = 10]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type     details
SELECT * FROM xy WHERE y = _  inject_hints  {"donor_sql":"SELECT * FROM xy@primary WHERE y = _"}
SELECT * FROM xy WHERE y = _  inject_hints  {"donor_sql":"SELECT * FROM xy@xy_y_idx WHERE y = _"}

# Test that SHOW STATEMENT HINTS works inside a SELECT
query I
SELECT (SELECT count(*) FROM [SHOW STATEMENT HINTS FOR SELECT * FROM xy WHERE y = 10]);
----
2

# Show hints for the underlying statement for EXPLAIN.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR EXPLAIN SELECT * FROM xy WHERE y = 10]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

# Show hints for the underlying statement for EXPLAIN ANALYZE.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR EXPLAIN ANALYZE SELECT * FROM xy WHERE y = 10]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

# Show hints for the underlying statement for COPY (...) TO.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR COPY (SELECT * FROM xy WHERE y = 10) TO STDOUT CSV]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

# Show hints for the underlying statement for PREPARE.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR PREPARE p AS SELECT * FROM xy WHERE y = $1]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

statement ok
PREPARE p AS SELECT * FROM xy WHERE y = $1;

# Show hints for the prepared statement for EXECUTE.
query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR EXECUTE p]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint                   hint_type
SELECT * FROM xy WHERE y = _  inject_hints
SELECT * FROM xy WHERE y = _  inject_hints

query error pgcode 26000 pq: no such prepared statement p_nonexistent
SHOW STATEMENT HINTS FOR EXECUTE p_nonexistent

# Show hints for a DDL statement.
# TODO(#159229): consider disallowing this.
statement ok
SELECT crdb_internal.inject_hint(
  'CREATE INDEX ON xy (y)',
  'CREATE INDEX ON xy (y)'
);

query TT colnames
SELECT fingerprint, hint_type
FROM [SHOW STATEMENT HINTS FOR CREATE INDEX ON xy (y)]
ORDER BY created_at DESC, row_id DESC;
----
fingerprint             hint_type
CREATE INDEX ON xy (y)  inject_hints
