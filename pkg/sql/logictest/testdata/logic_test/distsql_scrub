# LogicTest: 5node-distsql 5node-distsql-disk

# Verify the index check execution plan uses a merge join.

statement ok
CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL)
    SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
    FROM
      (SELECT v,k,data FROM test@{FORCE_INDEX=[1],NO_INDEX_JOIN} ORDER BY v,k,data) AS leftside
    FULL OUTER JOIN
      (SELECT v,k,data FROM test@{FORCE_INDEX=[2],NO_INDEX_JOIN} ORDER BY v,k,data) AS rightside
      ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
    WHERE (leftside.k IS NULL) OR
          (rightside.k IS NULL)
]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJyskU2L2zAQhu_9FWJOWTKHlT96EBR06UKKuy7ezamY4lpTr8GRjCRDS8h_L7YhHyZ2a9ijRnrmmXl1BG0UPRcHciC-A4ccobWmJOeM7Uvjg536DeIRodZt5_tyjlAaSyCO4GvfEAh4LX42lFGhyAKCIl_UzdC0tfWhsH-kJ-cBIe28YDJAyVGGkJ8QTOcvbZ0vKgLBT_j_6hdj_dQq-RZlsEUZbmclwRrJ7H6OSqPV6g3D99wQ4VD48o01pAULZp3RrPOi6rSxiiypG1vek_96cmfwr2Qr-mJqPZ3-aZ8kP9L96-cMEBr65TdX-zx8snX1dlsChKe68WQF28iA7V7Y8z5JHliasY2Mz-dz_hz7LwhRRihjlB9nQ4nXfERGrjXa0TScu50f-0RIVTQm7ExnS_pmTTloxmM6cENBkfPjLR8POz1e9QNew3wRjm5gPoWDRThcNocrzMEUjhbheGLOTx_-BgAA__9uM3tG

# Verify the foreign key check execution plan uses a merge join.

statement ok
CREATE TABLE parent (
  id INT PRIMARY KEY,
  id2 INT,
  UNIQUE INDEX (id, id2)
)

statement ok
CREATE TABLE child (
  child_id INT PRIMARY KEY,
  id INT,
  id2 INT,
  FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
)

query T
SELECT "URL" FROM [EXPLAIN (DISTSQL)
    SELECT p.child_id, p.id, p.id2
    FROM
      (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
    FULL OUTER JOIN
      (SELECT id, id2 FROM parent@{FORCE_INDEX=[2],NO_INDEX_JOIN} ORDER BY id, id2) AS c
      ON p.id = c.id AND p.id2 = c.id2
    WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
          c.id IS NULL AND c.id2 IS NULL
]
----
https://cockroachdb.github.io/distsqlplan/decode.html?eJysksGLnDAUxu_9K8I7KeYwxvYiFFJoF6ZYLXbmVCRY88YNaxNJImxZ_N-LEbrrMNN2YI_55X35vvdenkAbiWX7Ex3k3yGFhsJoTYfOGbugtWAvHyHfUVB6nPyCGwqdsQj5E3jlB4QcDu2PAWtsJVqgING3agiPdvdqkKKdvBFKS3wUpwehpLB4EmNrUXseKoBCNfmc8JRyRnkGzUzBTP7Z0fm2R8jTmb5CqtV6CaIkEw_4i69kE-NqBnY1w7P1pI2VaFFujJtF-a-SC418QdvjZ6P0eSN3x6IQ1fHwqQYKA558xFlCeZbE763q733E04RylsRA4U4NHm1OoijijOy_kbI6kPJYFDGpahLxbMNi8qH8SCL-NtCX5N0f8t9by27ZWo1uNNrh-eQuvrxbxoWyx3X8zky2w6_WdMFmPVZBF4BE59dbth72OlyFb_VSnN4gZudi9ldxthHv5mZ-8zsAAP__Bhgjbw==
