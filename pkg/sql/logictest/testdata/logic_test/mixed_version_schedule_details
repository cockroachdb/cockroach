# LogicTest: cockroach-go-testserver-upgrade-to-master

# Verify that all nodes are running previous version binaries.

query T nodeidx=0
SELECT crdb_internal.node_executable_version()
----
23.1

query T nodeidx=1
SELECT crdb_internal.node_executable_version()
----
23.1

query T nodeidx=2
SELECT crdb_internal.node_executable_version()
----
23.1

# Upgrade a node and create a schedule through it
upgrade 0

statement ok nodeidx=0
CREATE SCHEDULE test FOR BACKUP INTO 'userfile:///1/example' RECURRING '@weekly' FULL BACKUP ALWAYS

# Remember the full backup schedule
let $fullID
WITH SCHEDULES AS (SHOW SCHEDULES FOR BACKUP) SELECT id FROM schedules WHERE label='test'

# Read some elements in the protobuf that stores the clusterID and Version in 23.2
query TT nodeidx=2
SELECT on_error, on_wait
FROM [SHOW SCHEUDLES FOR BACKUP]
WHERE id = $fullID;
----
RETRY_SCHED NO_WAIT

statement ok nodeidx=2
ALTER BACKUP SCHEDULE $fullID SET SCHEDULE OPTION on_previous_running = 'skip';

query TT nodeidx=2
SELECT on_error, on_wait
FROM [SHOW SCHEUDLES FOR BACKUP]
WHERE id = $fullID;
----
RETRY_SCHED SKIP
