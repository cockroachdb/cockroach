statement ok
SET experimental_enable_temp_tables=true

subtest test_meta_tables

statement ok
CREATE TEMP TABLE temp_table_test (a timetz PRIMARY KEY)

statement ok
CREATE TEMP TABLE temp_table_ref (a timetz PRIMARY KEY)

statement ok
ALTER TABLE temp_table_ref ADD CONSTRAINT fk_temp FOREIGN KEY (a) REFERENCES temp_table_test(a)

query TT
SHOW CREATE TABLE temp_table_test
----
temp_table_test  CREATE TEMP TABLE temp_table_test (
                 a TIMETZ NOT NULL,
                 CONSTRAINT "primary" PRIMARY KEY (a ASC),
                 FAMILY "primary" (a)
)

query TT
SELECT table_name, table_type FROM information_schema.tables WHERE table_name = 'temp_table_test' AND table_schema LIKE 'pg_temp_%'
----
temp_table_test  LOCAL TEMPORARY

# query changes names, so we can only grab a count to be sure.
query I
SELECT count(1) FROM pg_namespace WHERE nspname LIKE 'pg_temp_%'
----
1

query T
SELECT * FROM [SHOW TABLES FROM pg_temp] ORDER BY 1
----
temp_table_ref
temp_table_test

statement ok
DROP TABLE temp_table_ref CASCADE; DROP TABLE temp_table_test CASCADE

subtest test_database_operations

statement ok
CREATE DATABASE bob; USE bob; CREATE TEMP TABLE a(a int); USE defaultdb

statement ok
SET sql_safe_updates = true

statement error DROP DATABASE on non-empty database without explicit CASCADE
DROP DATABASE bob

statement ok
CREATE VIEW a_view AS SELECT a FROM bob.pg_temp.a

statement error cannot rename database because view "defaultdb.public.a_view" depends on table "a"
ALTER DATABASE bob RENAME TO alice

statement ok
DROP VIEW a_view; ALTER DATABASE bob RENAME TO alice

statement ok
DROP DATABASE alice CASCADE
