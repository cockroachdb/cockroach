# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWV1v4jgUfd9fYfmpowkT7EBLI41EZ7a7YpZCt7Sr7Y5QlRIvjYCEdUJpt-p_X4W0Kg3ENzBLyPVbPuzE59zrYx_fJxr-M6Y27Z22T79ekpkck18uumfk--mf5-2TVoecdE7a13-dkoOfW73L3u_tD-Sl6ej-08ggzv3wYDT_NPqQdBvdk2_dVoeM5qTbWTQhn0n8nvx60b06J1-uFw_71KB-4IqOMxEhtb9TRg3KqUEtatAaNWid9g06lcFAhGEg4yZPiw4t94HaVYN6_nQWxY_7Bh0EUlD7iUZeNBbUppfO7VhcCMcV0qxSg7oicrzx4jej--ZUehNHPlKD9qaOH9qkYsY_7s4imzTjYbS6JPImwibVkBr0tz-IDOYhkcJxbcKSJ7ePkXh91CBfqEFvnWhwJ0ISzKJp_KX4v9FsOl56xGj_2aDJXQLodcC3j-TOCe_eD7UZt-8bNIycoaA2eza2Y-AwxcB8lQGT4eCAZ3Lw9p1AukIKN_2dj_GPc7VaQ-eZkEPxLfB8IU2Wyqix-Ds6aLKPHz5Lb3iXXL5RaTRjXsWDGMwiL_CXSZ04D2QiJoF8JM54HAycSLg2qS6YjN-FAxnzSVwvHK222ILrNx6tTXLpZDiUYuhEgTRZfSU8Bu0mVL4kzknn-qbTvbzpXLXbB00WU9G7Ojto8vjqa_eqc_lyvZaTnWdQ7ccySE0Pr_4YPb2rs5tWTJAV310I3xVykUSkyc2m9T-S9kZIPQchM38dJWvZ6ASVYGryVJ5sO-x65rAP3w2b5VdDBq8HJq-YFgI1ZNtycJRjRUDCAc_koMAVgem2IgC5tLwiHOq1ImycQcCKwLCvCDy_rPAc0mpVzBoCWWHbctDIIa1IOOCZHBQorVw3aQVyaVlaj_SS1o0zCJBWjl1arfyyYuWQ1lrFrCOQFbYtB8c5pBUJBzyTgwKl1dJNWoFcWpbWhl7SunEGAdJqYZfWWn5ZqeWQ1noFgaiwbRmow8JaMRlxfJcwEkR3QiJgg2eyUaDE1nSTWCCrliX2WC-J3TiDAImtYZdYoGpwIcJp4IcidWS8_svVmC3hDkXCbhjM5ECcy2Cw-E1y2130W5zQuCKMkrc8uWn5r6_CyImyj5x3Po-qiXTkB9DIBOCLaB7IEZk7XrSMwRWhkJ4z9v510vBeu7wI8EB494vRL716VeLld7vAxawCgDEFsMYG2b4RMF0jxouI2G6AsQ00gpdRI9QAGpkAcAcmpRG7AbYbjQCA6RoxXkTEdgOMp4FVl4G9x1VNd7aUrNRKtglZk69qAKyKVvoBYHVNgXFdI8bxRqymVJgUrnTnurIzP3yvT3uXmDXwD7c0amUPqxpXthtAEphCjNo-IoPYqAFTCa-1PtrSqJU9YGpc2W6gNBqhBlCIUdtHZBAbNWAq4bXWDeVO6Fht1I63NGplj7Yal8K_lcaBAgjwbvvVwBAbNQAY3oixlYNwlVNDJJ1sk4NwVBHb5IBcI2AKc1aarSMEoYjg7Gc64XXObOU0XBMjBgDDu90HgCkcWnmEAoBQRHB2JBTAdMJrn9nKaf27rRKrqe0YWzkT18SPAcAQF9QgZNm749JYTQACYksGIUPsydQFMMSeTNe6GAAM8bZf24IZhAxBMROaToiDo2txDACGeNuvbdUMQoagoglNJ8TBUVfIGFAiY7rWyABgmD2ZtsUzAJnCqpXHbWpbJ-O61sn4_utkewGGt04GAEPsySBk2sZMYdVKs4nk-6-T7UgodK2TAcAQezIImbYxU1i18giFuk7GgToZ17VOBgBD7MkgZIi3_dqWzyBkCGqbXJs6Wf_5p_8CAAD__0NjAhU=

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcm19v4kYXxu_fTzGaq129Zs2MDSFIKyW7SVW2KWyTqOp2xYWDp8Hij-l4CEmjfPfKsAiM8RybCjPHd2tsg59zTn5nnjPeVxr9PaZtend9c_35nszlmPx02_uVfL_-4-vNZadLLruXN9_-vCbvrjp393e_3bwnPy6Njzvdz_fk3WjxYfF-ddvoiXzpdbpktCC9Lhk9fRiRjyQ-T3q3V9e35NO35VGfWnQa-qLrTURE298poxbl1KIOtahLLdqgfYvOZDgQURTK-JLX5Q0d_5m26xYNprO5ij_uW3QQSkHbr1QFaixom957D2NxKzxfSLtOLeoL5QXj5c-Mni5mMph48oVa9G7mTaM2qdnxD_fmqk0u4sfo9IgKJqJN6hG16C-_ExkuIiKF57cJW33y8KLE-qMW-UQt-uCpwVBEJJyrWfxN8e-q-Wy89RGj_TeLro5WgtYP_PBChl40TD7qRXx936KR8h4FbbM367AINHcisEhHwGbbMeDGxoBnxmDzPfNpKH0hhZ_4pn58J3TJnkD-7EXDL2EwFdJmO6U0Fn-pdxfs_UcZPA6X_0pEUDyLwVwF4XQ7kBPvmUzEJJQvxBuPw4GnhN8m9WX04nPRQMYxJH4QjdJXHBDfTeycIvVzFUQqmA6UzRqphBwg7eiF4f6HwtDJ5_UTyd9IaxTJ210olZA2T2Xt_wZWZDNH0valbClnb966YS2c2c5O0vbqzvHkjcwnP0s8OcvPYgZ3I5vXbAddPyoQg7Mc_SgRAyz9iJXcj1iF-hFQP5t-1ETYj4oVhrYfMcP6EZC3dT9KZc38fsTzE43noLpTs110VC8Qg1YOqidigIXqvGSq8wpRHaifDdXPEFK9WGFoqc4NozqQtzXVU1kzn-pOfqI5Oaju1uwGOqoXiMF5DqonYoCF6k7JVHcqRHWgfjZUbyGkerHC0FLdMYzqQN7WVE9lzXyqu_mJ5uageqOGjukFItCAmV6zGfGmPmEkVEMh0dHdLZnuboXoDlTShu7nCOlerDC0dHcNozuQtzXdU1kzn-7AnsetiGbhNBK7f9V7v7keJ1X4j2JVAVE4lwPxVYaD5c-sDnvL-5azLV9EanWWrw460_WpSHkqe3vh6MGr0yW48gs4zxQwFWoRyhFZeIHa1uCLSMjAGwf_eLvy1rf8YP9ABE_Lp986tW4C2-eOoYs1ShDGNMJaBaq9UMWximaMn6EVxgowgpvICL2A80wBuBOzw4jjCDsOI4CKYxXN2A4jMAnju8Lq28KchK767s2ONiquYYuQPfWqF8Dw9jRAGN6ephfGnaoKw7sgdrWEaegJ09De3EwGZffmpp5tyb_u-sn5tCd2Zwe6PNNrQq8ru9aRJKYUl3eKzCB2eYCwMjricdbcrQNdnukJ0-vKNn_GMEIvoBSXd4rMIHZ5gLAyXN5xGHGuXQmxun4RxvQTsmyfZ3q-AWEa_2eMg4Uk4HV6gDLEVg9ShtfrsdScLAkaDoBGP41qol2jMcDd4024XhjiSgYmaNkOz5j1J1R0ZXi50_w5IW56qWlZRdwcIAzxXp5emMbmmQMKoOjKMHRHAgWgDO--HdNPxlkTWGmlZuNVsXR6YYi39CBl2U3PHLOql4DZ0gHKEC-EU4PzJGhaAGhSM7WqWLrUTK0qlk4vrIxKPknGEG_aQbVo2hzzAAl4LR0v8qo2piUoIKwMS3ccUADCEO_cQbWY7fSMAQUkAa-l4_rhOQeG5zw1PK-IpQOEIbZ0kDLETU-vTOP0jDGrkAS8lo6nxudJ0LgAaPRvdOK1dDw1Uyvd0p1EGOJK1gtDbOmgWkTc9ABlps0x90kApn14nY9eGN5dOkAYZksH1CLetzEhZdlOzxxQ6IfnHBiec_0LqYgtHfBuNOLuBihDbOmAt6Pxbt5Bykz7_0j7Grf-DW8HeMPbSQ3VsFq6_tv__g0AAP__iYR1Eg==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMUc-P0kAUvvtXvLyTmjHQUjzMqehitop0BaKumx6GzsvuhLZTZ6YrhPC_m7ZrBARcNCYe53vvm-_HW6P9miHH6XA0fD2DymTwZhK_h5vh56vRIBrDYDwYXX8ZwtOLaDqbfhg9g4fV5-3i4h4-RbNLiCcX0XgwimbXMJiCYEcG8wQZFlrSWORkkd-ghwnD0uiUrNWmhtbNQiSXyLsMVVFWroYThqk2hHyNTrmMkONMzDOakJBkOl1kKMkJlTXfLu7D0qhcmBUynJaisBxeIMMoBqdy4tC1yPDdRzD6mwVDQnLot8h85egHFHThFTKcC5fekQVdubJyHGoxV5XZFtTHZMOwfT3YtU7cEnJvwx4fKTZSFSJTbtXxdhPRktLKKV1sB_grY_45xra79v_brnt_2HXvX3cdHDX2009VaCPJkNwxk9TM360cSHcp7N1brQoynWA3XVxbDT0W-izssTBgYZ-FL5Edjp2LJeSUa7MCkWU6FY4kh_ZW9cympi4GpLKLXzceUZp_vLX-OeeckC11YWm_vYM_d-vKSN5SewKrK5PSldFpI9M-44bXAJKsa6de-4iKdlQb3CZ7J8nBDtnbJ_snyb3Tyr0zlP19cnCS3N9TTjZPvgcAAP__YwsE7w==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzclEtv2kAQx-_9FKs5gbTIT6rIp9CWVig0pIDoI_Jh8Y7oCtvr7q55FPHdK9vQGpQ0zg1x3Jn5e-Y3f2t2oH_FEMCkP-y_n5JcxeTjePSZPPa_PQx7g3vSu-8Nv__ok9aHwWQ6-TJsk0MpWy1ayzYZzfpj0mpXquUqBAqp5HjPEtQQPIIDFFyg4AEFHyh0IaSQKRmh1lIVJbtSMOAbCGwKIs1yU4RDCpFUCMEOjDAxQgBTNo9xjIyjsmygwNEwEZdtlqvbTImEqS1QmGQs1QHpWEXjUW4CcluMMRgRIxIMiK2Bwt2MKLnWRCHjAXGqyHxr8Bi6Ie-AwpyZ6CdqInOTFV8q-po8i2shB8I9hep1mFwbtkAInD19hu4fVJ5KxVEhPwEK90_wfxUpl2tUVvcUvjf71Lp12n9hC-waW1GtDYvjOn7CNiTBRKotyTXygPg2uRMFMW4wyo2Qab28wRq6z67BPVmD09xk52WTLbdjeRdls9ucz23A53Us_6L4vOZ8XgM-v1P-zpfD5zfn8xvwdTsXRffCiR2jzmSq8ewYPf1luzhSyBdYXTQtcxXhg5JR2aZ6jkpdGeCoTZV1qscgLVPlgHWx81_x2xOxfS52X9O5RCmpIEWzlmpJ1kyYukUcNSrBYvGbnR_Fo-RgYYRihQcbj6mjl8fczSvcPOXyrpTLv1Ku7rVwhfs3fwIAAP__wvBIiQ==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkF_L0zAUxu_9FIfHG4VI09uA8E6tWKzrazv8N3qRtYdZ2jU1Sadj9LtLmyHsQngvn9_55UlOrnC_eiiUSZa83dFke3pf5J9on3x7zDbpljbbTfb9R0Iv3qXlrvycvaSb2gWxO9PXD0mRUEevSVYQGEzDW31iB7VHjEpgtKZm54xd0HUV0uYPlBRoh3HyC64EamMZ6grf-p6hsNOHngvWDdtIQqBhr9t-re3OD6NtT9peIFCOenCKIvkqktFzCOSTV_QQQyDNybcnViQdBD5-IWt-O7KsG0UykMPF8z9EbyBw0L7-yY7M5MelaRH9NPZ3qJoFQrq93nl9ZKh4Fk_fsGA3msHx3XL_a5ZzJcDNkcMvOjPZmh-tqddrQszXcyto2PkwjUNIhzCaq_nZ3wAAAP__8UOd1A==
