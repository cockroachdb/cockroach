# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUWF1v4jgUfd9fYfmp1YQJdgKlSCPBzHZXjGjo8iFtd4SqtPFSBENYJ7RbVf3vo0CrQtL4xsRx4A1Ccs89vs45Pjzj4L85buLBRffi2xCt-Bz90e9doh8Xf1912x0HtZ129_qfC3Tye2cwHPzVPUWvt84ePs8M5D5MTmaPn2enm8dmD-h7r-Og2SPqOetb0BcU_Y7-7PdGV-jr9friGBt44XvMcX-yADd_YIINTLGBLWxgGxu4hscGXnL_jgWBz6NbntcPdLz_cbNq4OliuQqjy2MD3_mc4eYzDqfhnOEmHrq3c9Znrse4WcUG9ljoTudrmNlDa8mnP13-hA08WLqLoIkqZgTcW4VN1IraCFfLOQuQvwqX0bXo0u1TyALEmes1UQN9xQbm_uPbBYLHLwbe3L5p9K2R2yd07wb3uy20ovvHBg5Cd8Jwk7wY-zGrx5g9JpmZpFxuNJXbex2fe4wzL17nUwSc6a4PlumS8Qn77k8XjJsktgPm7N_wpEU-nX7h08n95uP7Ehktmm2VdpflnbIlM872ZMLZxA19bpJaYiUN3Nuwfp1d27m-cXrDG2fU7Z60SNT1YHR50qLRp2-9kTN8_SzdvtxU7XxTFa8DreZbh8Ho8qYTrYQVfeuzhcf4erCoRc2WlW-4tQzMV4uPuH9I2_Er_tKkscnH-qvF-rOrggbrOw2S7GJCYJk0acW0DkYoJbidZRDKkrnRVG4ahZKUKJTAOLeFsn6kQik9VUAoydEIJc3-rtIMOmRVTPtgdEiCWyODDpXMjaZy06hDtEQdAsa5rUNnR6pD0lMFdIgejQ5Z2d9VK4MO2RWzdjA6JMHtPIMOlcyNpnLTqENWiToEjHNbhxpHqkPSUwV0yDoaHbKzv6t2Bh2qVQ5GhSSY1WAVqpgEuQsPEeSH94wfjB7Z5eiRXaIeAYPd1qPzI9Uj6akCemQfjR4B_1L2WbD0FwGL_aH1ceVqtCzMm7DNMgb-it-xK-7frWE2X3vr59aJ2GNBuPmVbr50Fm8_BaG7rr1D6vXPL5nCjcyFdwSjKotDrFSgvcRKClsXSZpOUhaISGwHKrMdxIUbmQvnIxDbDlTtdgCwdZGk6SRlgWgcqLoNtItTjT9sCbu087yYiUbFWKSq7AUBgGqagKguRlQdI1u4mWI48YdrwodpfXcryihTXZEDQvTFONm9QrKwwAHVMlBod8BICvX0M0UOCHEU42T3CsnCAgdUy0Ch3QEjKdTTG0LdORc74PmeDii7QGIcgfvtY7UAmDq_EAMpdEAASB0jkjjHiyxQ8eFU5mifi6TMUb9AIAnjky6dTkLDpBSmvcT5viCzA4AUJiMxkIT7SZdOJ6FiTwCTUufqJJEHdjSK2GLLI4lTfkGeBwApjHwQUi7ZlkVTaHsQkkLfE6e3Yn1PV74DgIq1DG0ZEELKkWOhSSkkoSvkAUDFWoa2IAgh5Qiz0KQUkhAnPQJEPaIr6wFAKn1PW9IDkASet5fDast7tMS8R_fNe8Vjq4uAAJBC34OQtHGSsMFk6X3znoo9oSsCAkAKfQ9C0sZJwgaTpcV5jwJ5j-rKewCQQt-DkBT6g7asByGpzbBUZ94bv_z2KwAA__8X-OX3

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMWFFv4jgQfr9fYflpqwub2Eloi7RSu1tOx6oHe9CH21vxkBJfQbCES0K5qup_PwUWsYnBY5MJ4a2kiT_PN-Pvm_ErTf6d0RYdtO_bnx7IMp6R3_q9P8i39l9f7m87XXLbvb3_-nebvLvrDB4Gf95fkB-vZr873U8P5N109X51sfls-kw-9zpdMl2RXpdMn99PyQeS_Z_0-nftPvn4df1rSC06j0LRDb6LhLa-UUYtyqlFXWpRj1rUp0OLLuJoJJIkirNXXtcfdML_aMux6GS-WKbZ46FFR1EsaOuVppN0JmiLPgSPM9EXQShi26EWDUUaTGZrmOnzzSKefA_iF2rRwSKYJy3SsDPg3jJtkZtsG-lyMRMJiZbpInuWPXp8SUVCYhGELXJFPlKLxtFq-4DR4ZtFN69vNrrdyOMLGQfJOL-Fm-z9oUWTNHgStMXerOMiaxYiW8mR2ezn2PjJY-MHY9uts5xHcShiEeZWGmZfQq_sIej3IBl_jiZzEduskPqZ-Cd9d8MuPsSTp_H6L1Nm8lTswnRNUng3SdLJfJTazJe4O2IXZgnxSiREFQt3MGLZ7dM3YXQQxamIbS7x-Wu5TTQ1yNpH1Rp5L1_dqBEtbLdAVmGLfmGLnqPY42Vuj0xfPRisizZv2O7ZKKNBbJcaypiLrW5lZCdWRlaPMgIp3Cljs25lNEuIUhlZlcoIMLpVRolPVGXk-ieTa6iO27C9s1Edg9iuNFQnF1vdqsNPrDq8HtUBUrhTncu6VccsIUrV4VWqDsDoVnUkPlFVx9U_ma6G6ngN2z8b1TGI7VpDdXKx1a067olVx61HdYAU7lTnqm7VMUuIUnXcKlUHYHSrOhKfqKrj6Z9MT0N1_MbZaI5BZD6sOQ2bkWAeEkaidCzis1Ef78Tq49WjPkAyd-pzXbf6mCVEqT5eleoDMLpVH4nPyu6g9myiL5JFNE9EsYr3ruxkZIrwSWyYT6JlPBJf4mi0htn87K2_W4-ZoUjSzX_55kdnvv1XkgbrtXNB_bi0Mln4WnvhnDw4pjjMPwh0lDQZkcdOFCS_RANiBuXATcpBvfC19sLlAiiUA8ctB4A8dqIgC-VQBogXgZyfgdwcjlP82FXu0itzMKWNqrEY3kkEgPBOohqIu6cCwlNqT1lMvrqYfOXHzfwmix831WWcrw7HRNYukewT4k6No58jw4UV9okbAaJXAkCHTyiCA1wh2ScUoxpH300NF1bYJ24EiF4JAB32SoRyuFbqDnPUksfUXd9hAzVuJ4Ae-vDZPMaqITTEZhZom_E8FELCM1Em9X75muJATak7umaV4siATgOPIzUQYjKAblDfPY3JKnUmy2YK8YhKTWFFjgkAIQ6gaiADCzUm67BpYtQEAI43dDJ1r8-agMRJ3X5VtqkGQhw6IaRSPa0pGqZtAkiISi1NBfmaugJqSuoiT2ibUhdZlW2qgQ4no_ogEedQiE79U2u8NJ5tcpNr-1IXgCbX-MiOA2AjDqMQnfrTqPHSiHe16smAA5MBlyaDimwTAEK0TQgJ8TyqkRSWeYxBQ2h4tsmlQSBfUx5QU-or30ptk0tdpKZtVo-NmB81EKJtQnQinloASf_UyksD_WalbqbGxhtAASBM2wToxLvEhZD0XVReWj0ZcGAy4Or7ZUTbBK7mEQ8ggIRom8DlPN6kCSGVGm5kNPXFvwtc_LtSz1ihbQ7ffvk_AAD__-FPbXw=

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8kE9v00AQxe98itWcAA2K_3LwyYYG1cjEJbYEpfJhkx0Vq67X7K4LUZTvjmwX0ZjGJAj1uDPz9v3e24L-VkEA2TyZv81Zqyr2bpl-YFfzzxdJFC9YtIiSyy9z9vwszvLsY_KC3Z--HA5v7tinOD9n6fIsXkRJnF-yKGMcDyxWBSDUUtCC35KG4ApsKBAaJdektVTdaNsfxOIHBBZCWTet6cYFwloqgmALpjQVQQA5X1W0JC5IzSxAEGR4WfXf3tyFjSpvudoAQtbwWgfsFSCYtqlIM9mapjUB8wFhtTGkmSIuAuZZ7A0gKPn918SHYocw3N9jaMOvCQJ7h8ejpkqUNa9Ks5nZ-6THEB1CcE5BeNiW8-Rtuf_Ylvv_2vIOIvx2bmupBCkSe7ZFp_zbySM5zrn--l6WNamZt58j7ehDG0MHQxdDD0Mfw9d_Vu6MEzrWVET_lJaXpBtZaxpHffRnq8tH4pqGvrRs1ZoulFz3NsMz7XX9QJA2w9YeHnE9rDrAh2J7Uuztie2x2JkUu9PO7gnOzljsTYr9kXOxe_YzAAD__4SBv_A=

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElFuP2jAQhd_7K0bzBJJRrlSVn4CWVqgUtoC2l1UevHiEIpI4tR12EeK_V0m2l1C2TSuVffR4Ts53Mpkc0HxJkONyPB2_XEGhE3i9mL-Dm_HHq-lwMoPhbDj99HkMnVeT5Wr5ftqFh1ax23S2XZhfjxfQ6daq7S5ChpmSNBMpGeQ36CFDHxkGyDBEhn2MGOZarckYpcuWQyWYyHvkLsM4ywtbliOGa6UJ-QFtbBNCjitxm9CChCTtuMhQkhVxUtlsd4Ncx6nQe2S4zEVmOPSc0nheWA6DEsMWeUIGVGHzslaWbveWDGgSksMLGCFDre6-FTyMjgzr9gciY8WGkHtH9gj1D9giU1qSJtkAjY5ncn2IM6nuSDv9Zqjh9ZvOwOt-D-E3-cpuY0WSgI1T4uAaZJiKe0gpVXoPhSHJIXThbTz6NX7_JH7owujRwH4jsNd-TN6fx-T4PSe4yKD89tx-C-6g54QX4Q7acwctuMNe9aH9f-6wPXfYgrvfu_g6n6FekMlVZuhkrc8_2S3XneSG6n-DUYVe05VW68qmPs4rXVWQZGx969WHSVZdVYA_i73fip83xO6p2P8b5ypKlerfXnjTOng66_DprPsXtI6Oz74GAAD__90ofiU=

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9r4zAUxO_7KR6zl13QYvsqWEjautTgJqkd6J_gg2I9grFjuZKcNgR_9xK7tPRQ6HF-MxoN7wT33EAij9P4ck29beg6W97SJn5YpfNkQfPFPH18iunPVZKv87v0L71H6ylYH-j-Js5iquk_hQUEWqN5ofbsIDeIUAh01pTsnLFndBoDiX6FDAWqtuv9GRcCpbEMeYKvfMOQWKttwxkrzTYIIaDZq6oZa-vDrLPVXtkjBPJOtU5SEP4LwuA3BJa9lzSLILA9enZkWWlJIV1AwJqXD4BiEDC9_5zgvNoxZDSIn8_M2HWmdfxl4XfN4VAIsN7xdApnelvyyppy_GaSy_HdCDQ7P7nRJJJ2soZi-PUWAAD__8Sii3E=
