# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWO9vokgY_n5_xWQ-uVlcnAGtNdlEb693cWOh54_kehvTUJlTogVvwHb3mv7vF7SbKlReBhmg_SYw8LzPO6_P-87ziP1_V7iDRxeDiy9jtOEr9PvQvETfLv66GvT6BuoZvcH13xeo9lt_NB79OfiAnpcu7z8tFWTdz2vLh0_LD7vXlvfoq9k30PIBmcZ2CfqMwufoj6E5uUK_Xm9vTrGCXc9mhnXHfNz5hglWMMUK1rCCdazgJp4qeM29GfN9j4dLHrcv9O3vuNNQsOOuN0F4e6rgmccZ7jziwAlWDHfw2LpdsSGzbMbVBlawzQLLWW1hlvfdNXfuLP4DK3i0tly_g-pqCGxugg7qhmHcWsFswXzkbYJ1eDP8RLBZr_Zuhcv6JgqcO9ZBDR8rmHsPPuLMssOH0ycF75buAv8Z2O0PtLD8xWFI3XD9VMF-YM0Z7pAnJRvTVoTpQ5ypSqrFlR7l-vIdj9uMMzv6nY8hcKpVr6TtkvE5--o5LuMqiVTIiv0T1Lrk44fP3Jkvdj9fUqZ0afqsse9stgkcz31J3mG2XjKhiex6bz7nbG4FHldJM5ZgBZu7ZDxvcc-4vjHM8Y0xGQxqXRKSGU0ua10a_vpiTozx8--8WInVgH5aDSSnhzZOS89ocnnTDxOkhVdD5tqMb8sAdana1aSUQjNFQjbuayl5NRuGV_fWKo3USYqwm2Jhtw7CJul1i8AKrdK6qlVIt0hWrmcpNLpiXOlRrgVqNKmeRgO7vq_Rrfel0cI1AGg0eesaTdMLAE0hdlpd1SskACQr13YKsasYV3qUa4FiR6sndsCu74vd2fsSO-EaAMSOvnWx09ILgJZC7PS62qyQAJCsXM9TiF3FuNKjXAsUO616Ygfs-r7Ytd-X2AnXACB22lsXOz29AOgpxK5Zr9Dfn2Rl2oSlrq4SZLk2IsgLFoxXiDU9yrpA0dOrJ3rA_u-L3vn7Ej3hGgBET3_roge4z0Pmrz3XZxHr8fUvN8JsMXvOdtn1vQ2fsSvuzbYwu0tz-97WV7CZH-ye0t1F3_35yA-sIK112ThKXySEtlAINvMZd6yV8591EirR8oGNa6ZQFOWQpzmRj8ESgWKjcootOYS2UAh5EY8UW2ZYqNiAKMohT3MiH4OlUdjGPuwhaiP6spYYs36KLB7vCiIhkIak_ygA2ywFlpbDlspiqyfWZgQ1-nIz8WXaOqxsOTLaynFsSJ-2ZFSxZimFeF5jgyisrDkB2OaChqSzHMeG9NyTUcWaZcZiSw4hr7FBFFbWnABsc0FDUjtRXc-Tx4bzHMeG9IlLRhWcFDJOK0AMshppMqy0sQGAlcWWxM5tSXODtGOEyDEuR_IiR7fCYAU7ftZTq9DRrbSdl-YbxM5yhUwAAKy083IyrGDbz1pxQBA5kQcrDth5WSMQiR0MD5SW6MlzAIkd8AoZBABYaZ4BhCvWmDJOIEAQ0mYBCFfaMJDsAxQ1DJTjBACwRfXDktwACLcQJwTaeWnky7EDANii-mFJlgCEW4gdAu28NPLJngABTAFSjisAwMobBkqyAgBcwf6fdQgpyRmglXAGaCHOwIlRyDIKAFhpwwCEWxJfwf6fsSXQQpwBsOLKMQoAWGnDAIRbEl_B_p-14pKdAQo4A7QcZwCAlTYMQLjS-mFJZgCEW4gTQstxBqZPv_wfAAD__56t7Vw=

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMmU9v4kYYxu_9FKM5JapZe8Y2SZBWSrqhKqsUtpBDtysODp4GC2JTewi7jfLdK0MRMSbzeoxf41sA28_7Lz8_M_NCk3_mtENH3bvup3uyjOfk1-Hgd_Kt--eXu5ten9z0b-6-_tUlZ7e90f3oj7tz8v-l6ede_9M9OZutPqzON7fNnsnnQa9PZisy6JPZ84cZ-UjS38lgeNsdkl--rj-NqUHDyBd970kktPONMmpQTg1qU4M61KAuHRt0EUcTkSRRnF7ysr6h53-nHcugQbhYyvTrsUEnUSxo54XKQM4F7dB772EuhsLzRWxa1KC-kF4wX8vMnq8XcfDkxT-oQUcLL0w6pGWmwoOl7JDrNIwHT06mIiHRUi7SL9NHyOVi_uar9LLegMjgSXSIlVCDxtEqIbHw_PTH8atBN5duAt8G9vCDTL1kmg3pOr1-bNBEeo-CdtirUS7T9l6mq3ymJnubKz95rvzdXHfPWYZR7ItY-JknjdM7oUsOFOw3L5l-joJQxCbbG425-FueXbPzj3HwOF3_VaZS4ruYLGUQhbuCZSu0y97W6fRtkMggnEiTubmSVhecXvucI9qnSpFbiCnuwnd16j-KYilik-eq_zNKbO0CpT1U2HVAB6vbj1rRwrT3Slsgclcv8otM5Kw4vxhMapO3TLuxrNbI9aIAqzO5No3VrGZWs0axGuj0jtXthrJar31KVrMTsBqo_5bVuerXwWpenAK8APHsluk0lngauV4WIF4m16YRj9dMPN4o4gGd3hHvoqHE02ufknj8BMQD6r8lXq76dRDPLk4BuwDxnJbpNpZ4GrleFSBeJtemEc-umXh2o4gHdHpHvMuGEk-vfUri2ScgHlD_LfFy1a-DeE5xCjgFiOe2Gss7jUxdmHctkxEv9AkjkZyKuLHkc2omn9Mo8gE935HvqqHk02ufknzOCcgH1H9Lvlz1696JPBDbUCSLKEzE_n_IwSdbaemF_yg2fUqiZTwRX-JospbZfBys71uv-H2RyM2vfPOhF25_SqQni25nWu-mrxPClVYIvkhEHHjz4F_vKFXmViObB6dW-dlJkucXSLJMY9g4zrCpQ7jSCqGqxPeGrbQsNGxA-dlJkt8btupk-b6s9VbWzqha-zfbypidY7D4_ltBJwSGhQZAFgsNallun0YW6-XjKGfTVc-mq7y5nQ15_-a2-r8iO1UWDoMvKvQcxWuuVtXrNEriVXkO3XpjkQSQrYgk0EvvskLPUTx3taqezSg5bOoQqvIcuvXGMhmAbEUmAxq2KyVdmaUGO1Pbcj3XoeHPgKWQHh9Kuh0oCLQlCbAUwjIekC6W82A5N54dUQ6MqNpVt-thOgNsG1bt1LJoLQMsuZ5tKLtuBkpekYk4tvNomMg59lpsBCCLtl2hltX0DmUnDih5RU4CnDggDKztC6Ze5rE2AOrcQq8eL6GWRdu1gHT1uFDWw6iDwPMSgC7aiym3wsuO6CUwojnPfhIvkfPs9XgJtWxFLTsyebQdCajoRy05Cr9ggCCwvATXOXOrcD9c55wN7XUKRIG2LQEVXc9NlJw4KAi0oxD1oo8Diz6eW_TV4iUAWTQvAemicUGtq2kfSnoYKAgsL8FzC7vsiDrAiKpPVGryEjzn2TG8xJFRoHVQLYvmJaCio2EC0D1qyVH4jQJY_5pe6uoosLYpAFk8LwEUHeuMA9LVsw9lJ0696OPAoo-rD2rQvARwGoYGCUAXzUsA52FYWxGQ7lHH7IU9jPoYzgaO4eycS6_FS4xff_ovAAD__xAJnwc=

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEkV9v0zAQwN_5FNY9ATJq86c8-CkRK1pQaEYTCcaUBzc-bdZSO9jO2FT1u6Mkk9ZWbWmR0B59dz_f7-5WYH_VwCCfptNPBWlNTT7Ps6_kZvrjKo2TGYlncXr9c0reXiR5kX9L35Hn0vdD4f0D-Z4UlySbXySzOE2KaxLnhNMDiUUJFJQWOONLtMBuwIOSQmN0hdZq04VWfUEiHoGNKUjVtK4LlxQqbRDYCpx0NQKDgi9qnCMXaEZjoCDQcVn3394_RI2RS26egELecGUZ-QAUFtxVd2iJbl3TOkY6zLVNvRGaAIUkI04ukZGxBQpG_7bEIBddslxTGEqfrazjtwjMW9PTzTMjpOK1dE8jb1v8REF8xKp1UqsXz0Ni_jlimyv1X3ulwT-uNPjfKw0Pir34tEobgQbFlkzZkX8r2TPdJbd3X7RUaEbh9nRZ5x95NPJpFNAopNGERh9Pu4t_5tyTcw4yR9toZXF3_r0_j7uhUdzisESrW1PhldFV32Z4Zj3XBwRaN2S94ZGoIdUJbsLeUTjcgr1d2D8KB8c7B2d09nfh8Cg82elcrt_8CQAA__8pXOKU

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE1v2kAQhu_9Fas5gbTIn_TgU2hLK1QKKaD0I_Jh4x3RFbbX3V0TUsR_r3YdNTglrXspOXp23pn3mbFmD_p7Dgksx9Px6xWpVU7eLuYfyPX48-V0NJmR0Ww0_fJ1THpvJsvV8uO0T-5T2Xbd2_TJ_Gq8IL1-o9psU6BQSo4zVqCG5BoCoBAChQgoxEBhCCmFSskMtZbKpuydYMJ3kPgURFnVxoZTCplUCMkejDA5QgIrdpPjAhlH5flAgaNhIndtNtuLSomCqTugsKxYqRMy8GzjeW0ScmFt3DCTfUNNZG0qG7QlTF3lRyGbNpkTIwpMiK-BgpK3mihk3D6mBwpN6r1DbdgaIQkO9AmKB_N1KRVHhbxlPD2c4PwkSi5vUXnDNuTo6l3vIuj_ggrb_my2NizPj_0XbEcKLKS6I7VGnpDYJ-_Fq27jsBVxh1lthCwfqj41hrA1hqD7MoO_L9MLB150lnWG3TnCDhzRwIvPwhF154g6cMQD93v-f464O0fcgWM4OPuROEGxQF3JUuOjY3G6sm-PCPI1NhdHy1pleKlk5to0n3OncwGO2jSvQfMxKd2TM3gsDv4oftkS-4_F4b90diiO6uQCOGpUguXiB2tfot9H3zYRPQcT8XMwMTyLifTw4mcAAAD__4s-skE=

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rs0AYxO_vp3iY99LCFvW6UEhoLRVsTDXQP8HDRh9S0bh2dw0twe9e1FxaKPQ4v5mdHZ4T7HsDiSyMw5sN9aahuzR5oG34vI6X0YqWq2X88hrSxW2UbbLH-JLO0XoO1kd6ug_TkGq6Jj-HQKtLXqkDW8gtAuQCndEFW6vNiE5TICo_IH2Bqu16N-JcoNCGIU9wlWsYEhu1azhlVbLxfAiU7FTVTLX1cdGZ6qDMJwSyTrVWkudfeb73HwJJ7yQtAgjslCve2JLuXTfCscb1XfMDRQm56sCSfIt8EJi98yzr1J4hg0H8fXrKttOt5W-rf2v2h1yAyz3P57G6NwWvjS6mb2aZTO8mULJ1sxvMImpna8iHf18BAAD__2zVkpI=
