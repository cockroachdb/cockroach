# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWP9vokgc_f3-isn81GZxcQbsF5NN7O31Lm4s9GqbXG9jGipz1mjBG7Bu0_R_36DdVLHOZ2DEmfY3gQHe5_F4PN8TTv4f4ybunnZOv16iKR-jPy_8M_T99J_zzknbQyfeSef631O090e7e9n9u7OPXpaOHj6PLBQ8DPZGs8-j_cVpowf0zW97aDRDvjdfgr6g7Dj668K_Oke_X8939rCFozhkXnDPEtz8jgm2MMUWdrCFXWzhBu5ZeMLjPkuSmGdLnuYntMMfuFm38DCaTNNsd8_C_Zgz3HzC6TAdM9zEl8HtmF2wIGTcrmMLhywNhuP5bUYPrQkf3gf8EVu4OwmipIlqdnZjf5o2USuDcRuk_TuWoHiaTrKd2SXS6WS8tCtb1vZROrxnTVRPsIV5PEsQZ0GYHew9W3ixdAH8F7DbR3QXJHerkFrZ-p6FkzQYMNwkz1a5SQ9yk87WJ7WJWbPSjbO-XifmIeMszF_nU3ZjqVVv0HbG-IB9i4cR4zbJKWTM_kv3WuTT_hc-HNwtfr5SZrWoPGvsB-tP02EcvZK3ytYrE06Rp34yGHA2CNKY26SxRrCF_QUZL4_4xLu-8fzLG--q09lrkWyY7tXZXotmv776V97ly-9tTVVMA66aBsT00LoaPd2rs5t2RpCTbV2wKGR8LgPUonbLqUQKDQlCptFblLzJhhfX4olNczqRgN0oBvtgBTaR9y0CO7RNa7ZjkG-RsrMeSni0YbPSjbPu0KOJeR4NPPVljz74WB5dWAOAR5P37tFU3gCohNk5Nds1yABI2VmPJMzOsFnpxll3aHbUPLMDnvqy2R1-LLMrrAHA7Oh7NztH3gAcCbNza3bDIAMgZWc9ljA7w2alG2fdodk55pkd8NSXze7oY5ldYQ0AZue8d7Nz5Q3AlTC7Rs2g15-UnbQBW13NJiiIQkRQnN4xbtDUdOPUOzQ91zzTA57_sukdfyzTK6wBwPTc9256QPt8wZJJHCUsVz2-feV6xhYLB2zBbhJPeZ-d87g_v81i05-fN-8VQpaki6N0sdGOfh1K0iCVrS7rG8cvAuFIFcKqhUUsncV8hMZByqL-YxlExFGBBLjqdhCaRxpVIq0kJFJA3LQacYshHKlC2DopOXEXhLQdcQMIzSONKpFWEhLNQ6ovQ1pFVM-f7AjncVUNTubNEEMgdQ1-AUBqGAeJmscS1cGSK3wXcojyJzeEJ9OD1Tepms_EQbUxrASlYkTKAUOdFLUYVgkrWnIXIB0DwuphtTGsBGdiRMoBQ0bcYghqMawSVrTkLkA6BoTVI-HX41gcw46ri2ElCRcjUktlsskQwKAjYIghaYlhACQdLJG1DkCUw7T8tSxSCeyItCIVgRGQ1JOXVHNSqAYwUk1aOq-1XkB72gIgaelzxJDU45eUwgEQSsRsSeGAmnTEVLJWQKx8ZYgrzlxkrSzQHroASFq6MAiT8sdc6g0Rg9CSuyBMWoKXuMMyIXiZ13ABkEzIFwY2YBCmnTSDkJq0EGNezQVAMiFfGFiDQZh2Ug9CatJCjLjrIkDZRcxruwBIeoKXgfUXgEkth0mHQQMbL2p840UrbLx2glBHAQZA0hK8IEwG8qSew2R8gVbYeG1J4eYVYAAkLcELwmQgT-o5TErh4saLAo0XNa_xAiBpCV4QJi35wsACDMK0k2aQmtd49Z5_-xkAAP__vBn9iA==

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMmt9u4kYUxu_7FKO5SlSzZsY2SZBWSrpJVVYpbJNcdLviwsHTYEFsag9hoyjvXhkWEePsnDEDPnMXgm2-82d-_ubYLzT_b0q79Pbq-urTHZlnU_L7zeBP8u3q7y_XF70-uehfXH_954ocXfZu727_uj4mPw4tPvf6n-7I0WTxYXG8Om3yRD4Pen0yWZBBn0yePkzIR1J8TwY3l1c35Levy09D6tAkjUQ_fBQ57X6jjDqUU4d61KE-dWhAhw6dZelI5HmaFYe8LE_oRd9pt-3QOJnNZfHvoUNHaSZo94XKWE4F7dK78H4qbkQYicxtU4dGQobxdPkzk6fzWRY_htkzdejtLEzyLmm5xQ8P5rJLzgsZ96EcjUVO0rmcFf8sLiHns-mbfxWH9QZExo-iS9o5dWiWLnKSiTAqvhy-OnR16Er4Wtj9MxmH-bgs6bw4fujQXIYPgnbZq7NbpJ2tSBfVSF32NlaOHiv_aayb68yTNItEJqLSlYbFmdAh7yTsjzAff07jRGQu22qNqfhXHp2z449Z_DBe_rVLpsR3MZrLOE02CStnaBO9V6fSl3Eu42QkXRZUUro_cfXK5xuUTxUibx8wxI38oE7-b9NMiszllez_ehBtHY3UvpfYpaB3s9tPW-nM9bZSq6E8qKf8pKSc6fOLwaR2ecv1rGV1jVhPNFhditU2VrOGWc2sYjVQ6Q2rO5ayul75lKxmCKwG8r9mdSX7TbCa61OAaxDPa7m-tcSrEeupBvFKsdpGPN4w8bhVxAMqvSHeiaXEq1c-JfE4AvGA_K-JV8l-E8Tz9CngaRDPb7mBtcSrEeuZBvFKsdpGPK9h4nlWEQ-o9IZ4p5YSr175lMTzEIgH5H9NvEr2myCer08BX4N4Qcta3tWINIB513IZCZOIMJLKscisJZ_fMPl8q8gH1HxDvjNLyVevfEry-QjkA_K_Jl8l-01PIt_RdiPyWZrkYnuFvHvldpF6ET2IVZ3ydJ6NxJcsHS1_ZvVxsDxvueOPRC5X3_LVh16y_iqXodQdZ7Z_Gn4dCWemEsocS4RcpNmETEMpktHzLopYYCIJQOteFHJmXdL4CYIkVqO5-WGaWy3hzFTC3pOy1dw1Je2nuYGyMeuSttXczUji25LabyV5JUXt7ZM9ZTy-KeB0VoZaAsNAGCAJA2FqSdyzTxLGDdtXroVAvRYC5cmdcjjbJ3fUq7Dcxe3D3GNODuvhdqiHWpFxh5gnxczDHSQrKKYNkGREvP2YgdPDergdcqZWZGzpdJpbLcHMwx0kKyimDZBkZNr209xnyrsHa6tvXEy95TJycbv6ZGDrbMQ4XWcJiUDZigLbYwwjB2nCcHKsstMqLwkOLAn1rqiDfz9jgH3GyLlaEkobAFsxY_umxRGgVMYwO3w3oaCushtDt2yAJJQxnFqSuYfT6nCgVEaubU8dDkjEGL0x9ciAdYCbVGVogO_b1JJQpnGQJuPNqdYKUYvA8W2AJpQbdmWSUF4Sp8CSqOzVrPNtlb0avm9TSzJqg0aShjKFgwppjDotrAAiMHwbr_MuQEPPuOq8G4BiTwCFKKM4qJDGszidDodEoDwyVQ8XODBc4JXhArpvAySh-DZIEwrb1JrMbJyul4REYPg2XhkglJeEDywJ9ZNXC3wbr-zV9ufbGlGI0hVqSSi-DSokCuoATcao08IKsB20wCSpFWKM3wBJOL4NKCTGM1RIk7GN0-pw9XCBA8MFrn4QjOLbgCf4KDADNKH4NuAZPsb4DdJkPHfRWhLqVwc84NUBr7I7Q_dtw9df_g8AAP__60KvMw==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEkV9v0zAQwN_5FNY9ATJq86c8-CkRK1pQaEYTCcaUBzc-bdZSO9jO2FT1u6Mkk9ZWbWmR0B59dz_f7-5WYH_VwCCfptNPBWlNTT7Ps6_kZvrjKo2TGYlncXr9c0reXiR5kX9L35Hn0vdD4f0D-Z4UlySbXySzOE2KaxLnhNMDiUUJFJQWOONLtMBuwIOSQmN0hdZq04VWfUEiHoGNKUjVtK4LlxQqbRDYCpx0NQKDgi9qnCMXaEZjoCDQcVn3394_RI2RS26egELecGUZ-QAUFtxVd2iJbl3TOkY6zLVNvRGaAIUkI04ukZGxBQpG_7bEIBddslxTGEqfrazjtwjMW9PTzTMjpOK1dE8jb1v8REF8xKp1UqsXz0Ni_jlimyv1X3ulwT-uNPjfKw0Pir34tEobgQbFlkzZkX8r2TPdJbd3X7RUaEbh9nRZ5x95NPJpFNAopNGERh9Pu4t_5tyTcw4yR9toZXF3_r0_j7uhUdzisESrW1PhldFV32Z4Zj3XBwRaN2S94ZGoIdUJbsLeUTjcgr1d2D8KB8c7B2d09nfh8Cg82elcrt_8CQAA__8pXOKU

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlEuP2jAQx-_9FNacQDLKkx5ygra0QqWwBbR9rHLwxiMakcSp7fAQ4rtXdrZdsmLbVKoKx4znP_P_zURzAPU9gwgWo8no9ZJUMiNv57MP5G70-WYyHE_JcDqcfPk6Ip0348Vy8XHSJQ-pbLPqrLtkdjuak063Vq03MVAoBMcpy1FBdAceUPCBQgAUQqDQh5hCKUWCSglpUg5WMOY7iFwKaVFW2oRjComQCNEBdKozhAiW7D7DOTKO0nGBAkfN0sy2WW8GpUxzJvdAYVGyQkWk55jGs0pHZGBs3DOdfENFRKVLEzQldFVmJyGTNp4RneYYEVcBBSm2ikhk3DzGRwp16oNDpdkKIfKO9BmKR_NVISRHibxhPD6e4fyUFlxsUTr9JuTw9l1n4HV_QflNfyZbaZZlp_5ztiM55kLuSaWQRyRwyfv0VbtxmIq4w6TSqSgeqz43Br8xBq_9Mr0_L9Pxe05wkXX67Tn8FhxBzwkvwhG05whacIQ9-3v-f46wPUfYgqPfu_iROEMxR1WKQuGTY3G-smuOCPIV1hdHiUomeCNFYtvUnzOrswGOStevXv0xLuyTNXgq9n4rftkQu0_F_t90tiiW6h8sgEKBeivkmmRMY5Hsfx6tpsHg2g2G126wf3UG4-OLHwEAAP__a1PTRA==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rs0AYxO_vp3iY99LCFvW6UEhoLRVsTDXQP8HDRh9S0bh2dw0twe9e1FxaKPQ4v5mdHZ4T7HsDiSyMw5sN9aahuzR5oG34vI6X0YqWq2X88hrSxW2UbbLH-JLO0XoO1kd6ug_TkGq6Jj-HQKtLXqkDW8gtAuQCndEFW6vNiE5TICo_IH2Bqu16N-JcoNCGIU9wlWsYEhu1azhlVbLxfAiU7FTVTLX1cdGZ6qDMJwSyTrVWkudfeb73HwJJ7yQtAgjslCve2JLuXTfCscb1XfMDRQm56sCSfIt8EJi98yzr1J4hg0H8fXrKttOt5W-rf2v2h1yAyz3P57G6NwWvjS6mb2aZTO8mULJ1sxvMImpna8iHf18BAAD__2zVkpI=
