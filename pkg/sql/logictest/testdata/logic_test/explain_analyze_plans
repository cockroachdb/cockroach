# LogicTest: 5node-dist

# These tests are different from explain_analyze because they require manual
# data placement and are run without the optimizer.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT)

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT)

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWNFuo0YUfe9XoHlKtVgwAzgOUiW2fUq7sats8lBVVkTC1EFrgzXg7kar_HsFdtc22HOZMJ6Z-M1g4J575nI4c76jLE_oOF7QAoV_I4xsRJCNPGQjH9koQFMbLVn-RIsiZ9Ul6xuuk28odG2UZstVWZ2e2ugpZxSF31GZlnOKQnQXP87pLY0TyhwX2SihZZzO6zJLli5i9hJ9-RfZaOBUFSerMrSiqj7LvxYWo3ESWtVhUcbzuVWmCxpaboGmrzbKV-Wm7Lba44v1HBfP-3UijKav0_oZM4pC_Gq_Df7wCPyvyEYOVtcAOdrA9jk5SyijSfM5H6rCna46wMUNZTP6e55mlDm4sZZz-k95EeEPP__C0tnz-ueWDjuquKmusRq01Oca3Niofkbz0vXJ1rWL-Ju1oIucvVirgiahRVzrj_TXBsNb9jyR5f84mzE6i8ucOThoLYqNJmsCN0v-cfzXw3hy9zC-__TpIsIVAZ_vby4iUv36bXI_vtv85s_GgZ7woZ7EpsbvNzV8cojbj5zP9zcP1xU9XnV0S7OEsnpwrIg4kSeNsi0dQQc6VtkhQg5yMc4H-dIhQePKw7WHe7VxdwXCHAF1yMDxtEioQAOXPAlV2AA52oBCCcX9JdTtLqGugIS6Vlf9BNZ-Vz-HJ9FPt5MYtBvqI57C8wKIJ1Yonm_l65hyku4vP-GplzdwfC3qJdDAiKdeChsgRxtQqF7kDNQLWPtd9bo8G_USnhdAvcg7Vi-v-8vv8dTLHziBFvUSaOCKp14KGyBHG1CoXl5_9fK7q5d_qu0rsPy7AjY6iYD5eravwlMDaJinUMN6UHZMxvzuKuDzZCwYaBExAfgBR8QGDrbiLLGwlZfPlGmRM1-PnPlnYMaAKdjVsquzMWPC8wIImf-OzRiQxd7SYplnBe0UsbkVUTSZ0TWxRb5iT_RPlj_VZdaHk_q-ejuf0KJc_0vWB9fZ_38VZVw_e9N5virppvd2q5uTSVp8-XGqfsW71x_Jrm-jx5eSFlZBs_INeLBnGqCODGFVgIh6hrDACJMTjDC__kh2_Z58NEbYAEAdGZI4wsDEqGeINAG5u4D28bjNmz1uN75sgWiB59fHrnJBAAAFhgEipjFE1DPkc1-ABp7mzQH3ZjLcf31O8AUYqjVRIJt8PNJNlWB9DSYKAKTeRAETo56hS7Umqice6aZKsL4GEwUAUm-igIlRz9CI-xm44puoKxkmSmIzfDzyTZUoAPUWgQ9Ig4kCAKlnCLe25jwXtQMIeq7IDltJoyJbbgMAyXc8wgjUWxxoajQERa1ttmaTAwDSEB3xAcm3PcIINIRFwNRoyNNa2_c9ncc-3-rg1mZbs9cBAGlIkCBE0r_togg02B0IkQa_ww9-3u53TMtzAEAa_I5xCQ-ESLr_EZ4aDZyYFuoAgDT4HeNiHgiRdP8jPDUaOOEnOxiIdrBp2Q4ASIffMS7tARB19T9-j_fAuHyHnCjfIVLyHYlbLgCQer8DANLgdyBExnEk3_-0EUjJd2TOsWn5DgBIg9-BEBnHkXz_00bAz3cIkO8Q0_IdAJAGvwMh0vBtNy7vgRCdPgMjsvKd6etP_wUAAP__zrJx7g==

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzkWMFu4zYQvfcriDm1qAyJlOQ4AgoEix66LdAU294KHxSLjYW1pYCkuxss8u8LyTYcSQ6HjBVSQG6xJGrejB7f48s3qOqC_5lvuYTsX6AQAIMAYggggQBSWAbwIOoVl7IWzSP7BR-Lr5BFAZTVw041l5cBrGrBIfsGqlQbDhn8k99t-CeeF1yEEQRQcJWXm7bMgyi3uXi8-fw_BDALm4q3O5WRm6a-qL9IInheZKT5KVW-2RBVbnlGIgnLpwDqnTqUPVW7eyTrXK67dW4oLJ-W7TvuOWT0KXgd_PkL8L9AACF93gB70wbYiw2c3rOralFwwYvOm5bNSuyRM1P4LZfr3-uy4iKkvY-44f-pH2_oT7-I8n7d_tWZQnOb9EbRXuvNI4B2ff_R_cXBs1LVghdElgXPSPsMBLDNv5It39bikewkLzLCIvJH-eFwpyjl58P1iHzozf8029iGHH_XQjUjSfuf62f0-5-BS18BN7GB-2spVVmtVMiiAb8CuN2TwWj7nUGvQ5kaEPYcF9tJniXkqZXB7HWtpBe3Mu-0Qs3Fg2q0L2SzMPaifhYNXOnUr9OAS_WjjtWPXqR-kbn6RYbq17zuJRJfoHwIMY7KN0eULzLecBfIHoL1pBXURivMoZvJHjPfakynFfEsTLxohUUDC51WdBpwqRXMsVawd6IVCDGOWnE1Ba1AsJ60gvnUith8q8U6rUhmYepFKywauNZpRacBl1oRO9aK-CKtSMy1IvGfqhByHPVigehF4ihVIXBPkhHbSIYZenPJSMx3XKKTjHTmRTAs4KcawZiFlORVQSip1ZoLL9KROJaO5J0cMxCKHGXjegrHDATrSTMSn8cM5P9Fn7h8qCvJ-4w9--aooSkv7vme9rLeiRX_S9Srtsz-5227rg1sBZdqf5ftf3ysjrekytt3Hzqvd4ofeh-2euYbQbunzOsvxq4fwN2j4pJIXqlX4KHx1AAZToi6AsTcT4haUJi9AYX19Rdj179wHj0KTwCQ4YRGpDDCGPcTYn1A0XNAXTxRf3GsXZzoFyfaxWl3M_cXp9rFbN4t_QZbb-7WvdDvqMczuptZ1vfgXggg9-6FMMb9hK7cuteFeEZ3M8v6HtwLAeTevRDGuJ_QQmsD13oDutYuppF-NR2cRnX-9WwW2AnB5lDp5JBrc8qcAKDxvcYagXtzwVjjIRsNTpae7QUB5CEt6QGNbzjWCDzkI4Q1HiKkPuRQJOVQfcyhKbJcH3Re7zJTyy8IIA8uM7lEgyEa3XWsWeNhJlMLMQggDy4zuViDIRrddaxZ42Em-iRDkShD9VmGIVmGvVGWYaNkmRGPFwgg9y6DAPLgMhiiyc1ofNcZIhgly4zJ46llGQSQB5fBEE1uRuO7zhCBPsswJMswfZZhSJZhY2WZ5dMP3wMAAP__09utpA==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k09r4zAQxe_7KcScdkHG__egU9pLCYWmhNIeig-KNQRT2zKS3CQEf_ci-ZA6TYwLznE0fu_9ZswcoZYCn3iFGtg7hEAhAgoxUEiAQgoZhUbJHLWWyn7SC5ZiDyygUNRNa-xzRiGXCoEdwRSmRGDwwjclrpELVH4AFAQaXpQuplFFxdVh8fEJFDzfJq5aw8jC5iu500QhF4zYUhtelsQUFTISaMg6CrI1p1ht-BaBhR29gnYiamupBCoUA5qsuwD_VtRC7lD56ZD87vXh7yL8N8RMf2JSqPieVFhJdSCtRsFIEpDH4v7qANFggHD6bsOR3fqR58ezbzeaDheNwcWen8wOF0-Hi8fgEs_9-3nhkulwyRhc6t30ZC6grVE3stZ4djqXnQN7Uii22N-flq3K8VnJ3MX05crp3INAbfpu2BfL2rUc4HdxOCr-PxAH5-LoN8luFDcVbA4GNdFYG0YCu8yhbXwb2-Q2tulMtln35ysAAP__3m0A4w==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMULtqxDAQ7PMVZtJusNyquvaaXDjSBReKtRwiOsvsrvPg0L8HW0VIEUg5MzsP9oa5RH4MV1b4FwwYCYuUiVWLbFQ7OMZPeEdI87LaRo-EqQjD32DJMsPjObxmPnOILL0DIbKFlPfYRdI1yNfh7R2E3j30rr8H4bSa7w4DCFI-tBMO0XebVS3k3Fm6su-cYqyEstpPtVq4MPxQ6f_zzqxLmZV_Lfsr2dWRwPHC7QVaVpn4Scq01zR42n07EVmtqUMDx7lJdax33wEAAP__YkNzJQ==
