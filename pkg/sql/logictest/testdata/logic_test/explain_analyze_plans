# LogicTest: 5node-dist

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzsmV9v4kYQwN_7KVb7xOlM7F3bhFg6Ce6aVlyJSfkjNT2hyMFbsDA2XRuSNMp3r4ypAIN3bDaNEMpbMPwYz3j2NyPygqO_fWzh3nX7-lsfLbiPful2btCP6z9u282WjZp2s3335zWq_Nzq9Xu_tz-h9Ueny4upgpzluDJ9vJh-SrHpEn3vtGw0fUQde_UR9AUl76Nfu53BLfp6t7o4xAoOQpfZzoxF2PqBCVYwxQrWsYINrGATDxU85-GIRVHIk4-8rICW-4QtTcFeMF_EyeWhgkchZ9h6wbEX-wxbuO88-KzLHJdxVcMKdlnseP4qzJx7M4c_N6ZLrODe3AkiC1XVJHBnEVuokdzGgxOPJixC4SKeJxeTa_Fi7mcuRcxno9hbevGzhbQLLYkUxY7vo9ibMQtpER6-KjhF0gT-u8GHZzRxosnurTUIHr4OV98xZtgir8pxGddyMn7cZKyS08yZ5ua8-Z6Qu4wzN_s9n5PAhT51oHw3jI_Z99ALGFdJpmN89ldcaZDPn75wbzxJ_9yUTmlQueqxJzZaxF4YbCqo4JnzhJZsFIfc-4e5aMZmIX9Gju-HIydmroV0Df3mfc3UelNHvUzvNMdjzsZOHHKVmHuPR8GdtJTrRmnad_d2p39vD9rtSoMkpegNbioNmvz1rTOw--u_37omPHyMEGeOu-Z2uy6t2bpQiyi5XXKoRuX60ZDrR3GxqSZX7N7g5r6VlFtPXnVZ4DK-aknUoGpDf_NHkNdsZoEiLYJDZTpYITushnOVZjoxm4q5n4opn0ptJxVS3LkEnjIqrar6CTqXHJvzZYE5c6I509yc33HOkHObM0DvbM-Z2tvNmWPnwv-rR5k5U7ofgTlDznHO0OKiogXkrFdV4wRFRY7NuV5AzieaM83N-R3lTM9NzkDvbMv58kPO-XIu3Y-AnOk5ylkvLiq9gJyNqmqeoKjIsTlfFZDzieZMc3N-Rznr5yZnoHe25Vz_kHO-nEv3IyBn_RzlbBQXlVFAzmb1BDVFjs3YhNVcVQlyAhcRFMYTxk8we5qb_TtK2jg3SQNdtC3pqw9J50u6dD8CkjbOUdLA_2y6LJqHQcQyP6cf_mYtqSBzxyyteBQu-Ijd8nC0CpO-7Ky41W9PLovi9F2avmgF6VvJDRaH6zIw0aVoqdgUiE1K1IyWg-sycKZmZWmp2BSITbO0tk3vwloW1oWhDfHTEsNEk6JNGZpKxaZAbENYcQA2hTCtiZ9XTUYqYhg42GIYkgpAS8WGpHIpIxUxDBxsMQxJBaClYkNSqQu79ErcpFcyUhHDkFQAGjibYhqSCkADscne5CxjFVJmcpalgdMJ0JAaIFwuOrhx7I3PUiuHmIbmvpgGlw4Al4sOGYLszdCdfiWG2BFkb4iWkQRAQ5aAcOiwiXHIExAORRdvEBAttUEANHRU5XYICJeLDopCao0AaOioyi0SEC4XHRSFeJcgwDJBpLYJgAZFIbdPADgoCrmNgkptFFRqowBo4KgCNCQKCJeLDomCSm0UAA0cVYCGRAHhctHBHzLEGwUFNgoqtVEANCQKCIcOm9xGAeFQ9HIbxfD1p38DAAD__y4aeNk=

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcmF9vo0YUxd_7KUbzlKg4MAM4DtJKyW5c1dvU3tp56HblBwLTGBkz7sxgJ43y3StMKi-QzIWQjUjewp8fM-dy7rnBd1j-E2MPz4YXw0-XKBUx-mU6-R19G_755eJsNEZn47OLr38N0cH5aHY5--PiED3cmh2Pxp8u0cFye7Q9zLHlBn2ejMZouUWTMVpujpboA8quo8n0fDhFH7_ujubYwAkP2dhfMYm9b5hgA1NsYBsb2MEGdvHcwGvBAyYlF9ktdztgFN5gzzJwlKxTlZ2eGzjggmHvDqtIxQx7-NK_itmU-SETpoUNHDLlR_FumbWIVr64PV1usIFnaz-RHuqZ2cKTVHnoNNvGla-CBZOIp2qdnczOqXQdl05JFrNARZtI3XrIOrKylaTy4xipaMU8ZEk8vzdwjuQC_t_g1S1a-HJR3NopwfP7-e4Z1wx75N54nuL-E4q3e8Um-V4z7Yxm-qTm_XPShIuQCRYWnjTPSOiWRwr3qy8Xn3mUMGGSklVi9rc6OCWHH0R0vdj99VIVYzcsSFXEk33VDLzyb9CGBYqL6F8WohVbcXGL_Djmga9Y6CHXQr9FH0v13dfObuKX80iqKAmUSdzKC3l5aYJvJRLMDx-4omFy6Q96U5lJJXqpTgub6IpBrecVw31mMdyXKIbb5L3PuFBMmJSUhf78A5SCjrb1yvoFZaR-AhI4803aM-3Op34Dzcc1Ur-guaupT1459ck7Sn3AL_vU7z8SdM9N6ZcuSr3Up_Vbg9aIA7tnOp2PgwaaBzXioKC5q3FAXzkO6DuKA8Av-zg4fvNxYNdvDbtGHDg90-18HDTQfFIjDgqauxoH9ivHgf2O4gDwyz4OBm8-Dpz6reHUiAO31_kwaKDYhcOgZxLkJyEiiKsFE52PBeeVY8F5R7EAOGcfCydvPhaAX0emTK55IlnZLo8-2co8wsJrlntO8lQE7IvgwW6Z_HCy43bfZSGTKr9K84NRkl_KNlgfHrSBSaulSb8NTS09TRrUjDaDB21g0mrpUs0a0qWaVWhapq3vabsAW2XY1sKO_m05WtjVr-xqYUr1dL9Nc-lhoLn0MNRcAA00F6AaaK7jNs2lh4Hm0sNQcwE00FyAaqC5BlqXnuhNetKmuUir-QHQgMcBGjI5hAMuh5RDM6TdEGk3RVqOkZZzpN0gIfpJQoBRQlrNElIZJo3srqchu-tp0O4ADtkdUA7ZvTJIG9ldT0N219Og3QEcsjugHLJ7ZZoW7X4M2L0yWBrZvTJYGtldT0N219Og3QEcsjugHLJ7Zag2sruehuyup0G7Azhkd0A59JlQmarFf7iJ3u60Mlu0dp_f__RfAAAA__8WcZGR

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMkUFv2kAQhe_9FaM5tdW22AZ62JNpQxW3FFJAatPIh8U7SlZZe93dNYIi_ntlHKmAgIT20Bx3dr6Z996s0P3UyHHSH_Q_TKGyGj6OR1_gpv_9atBLhtAb9gbXP_rw8iKZTCdfB6_gofV103g_h2_J9BJG44tk2Bsk02voTUCwIx-zFBkWRtJQ5OSQ32CIKcPSmoycM7YurTYNiVwgDxiqoqx8XU4ZZsYS8hV65TUhx6mYaRqTkGRbATKU5IXSm7GlVbmwy_h-jgwnpSgchzfIcCZ8dkcOTOXLynMIkaGvSr1V6iJDR5oyr-bKLzkEb4N6uvNCa_AqJw6Bw3TNsEEe1Dkvbgl5uGZPdzCyUhVCK79shbsG_kEoLSirvDLF42Kjc8Ruxx09l7jbfxl3-3_E3Tkq9o_GqjBWkiW5IzCtycdaDji-FO7uk1EF2VZn1_Go9hSHLI5Y3GZxh8VdFr972s2iQ1lEh7NgmIsFzCnzxqpfJCGn3NglCK1NJjxJDmEQwGf1_mhs3XNuPCZXmsLRfnwHJwd1ZiRvqbmBM5XN6MqabLOmeY423KYgyfnmN2weSdF81QK34fAk3NmBw304Ogm3T29un7E52oc7J-Hu3uZ0_eJ3AAAA__-Jhgp3

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE2P2jwQx-_Pp7DmBJJ58koPPsG2tEKlsAW0fVnl4I1H1CKJU9thQYjvXiVB3QZBm4oDPfpv_zL-eaLZg_meAIPFaDJ6vSSFTsjb-ewDeRx9vp8Mx1MynA4nX76OSOfNeLFcfJx0yfEo36w66y6ZPYzmpNOtqfUmAgqZEjjlKRpgj-ABBR8oBEAhBAp9iCjkWsVojNLlkX0FjMUWmEtBZnlhyziiECuNwPZgpU0QGCz5U4Jz5AK14wIFgZbLpCqTa5lyvRusN0BhkfPMMNJzysKzwjIyKK_xxG38DQ1Rhc3LsMxskScnkcEEYys30u4Ycf93y0rG8iQhVqbIiGsgOlCokeNNjeUrBOYd6AWbF4kiU1qgRtEQiA5nfD_JTKhn1E6_KTt8eNcZeN2fcn47uf4FOdxiXFipshdBClo9G6KRiyPXfAAKKd-SFFOld6QwKBgJXPJe3h13hDTrY-6Su4vv5Tfey2vffe_P3Xf8nhPctP9-ex-_hU_Qc8Kb-gTtfYIWPmGv-q9v5xO29wlb-PR7_8y0OWMzR5OrzODJ1Dn_ZbecRihWWI8uowod471WcVWmXs4qrgoEGlvvevVinFVb1QV_hb3fwq8asHsK-9dUDq6Bw2vg_l_B0eG_HwEAAP__ON5u1A==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkM9L-0AQxe_fv2KY70VhNZvrgtCiEQOxrUnBHyWHbTLUkG027k6KpeR_lyS9KAge5zPvvd03J_QfBhVmURLdrqFzBu7T5SNsopdVMo8XMF_Mk9e3CC7u4mydPSWXcJbWk7A-wPNDlEZQww3IHAU2tqSF3pNHtcEQc4GtswV5b92ATqMgLj9RSYFV03Y84FxgYR2hOiFXbAgVrvXWUEq6JBdIFFgS68qMsa2r9todZ_UBBWatbryCQF4FMviPApcdK5iFKHCruXgnD7bjdoBDDHet-YE8GSq4OlR8VCCv5chYGwNc7UmB9Jj3AifL-bee9Y5Qhb34e6OUfGsbT9_K_JYs-1wglTuaruZt5wpaOVuMz0zjcvSNoCTP0zachriZVn3e__sKAAD__xmzmlc=
