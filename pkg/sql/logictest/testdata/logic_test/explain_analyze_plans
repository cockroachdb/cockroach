# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWP9vokgc_f3-isn81GZxcQZsrckmenu9ixsLPb8k19uYhsqcEi14A9btNf3fL2g3Vax8GJRh2t9UBnifx_Px5j3h8N8ZbuDeZefyax8t-Az93rWv0PfLv647rbaFWlarc_P3JTr5rd3r9_7snKKXpdOHz1MNOQ_jk-ny8_R0fdr0AX2z2xaaLpFtrZagLyg-jv7o2oNr9OvN6sch1rAfuMxy7lmIG98xwRqmWMMG1rCJNVzDQw3PeTBiYRjweMnT6oS2-wM3qhr2_Pkiin8eangUcIYbTzjyohnDDdx37masyxyXcb2KNeyyyPFmq9tMH5pz7t07_BFruDd3_LCBKnp8Y3sRNVAzhnHnRKMJC1GwiObxj_ElosV8tvFTvKxto8i7Zw1UDbGGebAMEWeOGx8cPmt4vXQN_Cewu0c0ccLJNqRmvH6o4TByxgw3yLOWb9KzxKTL3Ul1otasdO-sr9cJuMs4c5PX-RTfONOqN2i7YnzMvgWez7hOEgqZsX-ikyb5dPqFe-PJ-uMrZVqTZmeN_WCjReQF_it522y9MmGIPPXWeMzZ2IkCrpPaDsEattdkvDzilnVza9n9W2vQ6Zw0STxMb3B10qTxp6_2wOq_fD7WVGIaMA_TQDo9tHoYPb3B1W07JsiIv3WZ7zK-kgFqUr1pFCKFWgZCFv5blLzJhhVUgrlOEzrJALsmBvtsCzbJ7lsEdmidVnRDId8ieWc9z-DRis1K984q0aOJeh4NPPVNjz77WB4trAHAo8l792ia3QBoBrMzKrqpkAGQvLPWM5idYrPSvbNKNDuqntkBT33T7M4_ltkJawAwO_rezc7IbgBGBrMzK3pNIQMgeWe9yGB2is1K984q0ewM9cwOeOqbZlf_WGYnrAHA7Iz3bnZmdgMwM5hdraLQ35_knbQGW11FJ8jxXURQEE0YV2hqundqiaZnqmd6wPPfNL2Lj2V6whoATM9876YHtM9dFs4DP2SJ6vHtK1djtpg7Zmt2w2DBR-yaB6PVbdZf7dV5q17BZWG0PkrXX9r-z0Nh5ERZq8vq3vFFINSFILgsZNxzZt5_zvZdNeyzaBnwKZo5EfNHj3mwEKNIMLv-KoRNJaJooUTtgCECIqbFiDgdQl0IQrF0JER8ZDCQiAFsKhFFCyVqBwxNgqlugtnGUk2ebKROYh5i4_vfYiIQSFWqIwBgagqBoSoxQ-UyY6ZqPoEleXIt9WR6tv2PKcb2z44Ynw4lMx2LWDwohI5i45MoGLl5CRBKqcHy_Ijx6VCe0rGIxYOcIk6HUGx8EgUjNy8BQik1WNZT3wYX6fHp4ojx6VCS07EI5qicWQ7AIDckpIORHJ8AMHKZITu78LT8JHmjJ7IpL5woke15yWAEU1LevkJoI66YdiS3Szs78xLzEQBGcn-SDkYwKuVVMgCiUEpAJQPakRsmyc7mf-t9Qcz0lER2tuslxiQAjOS-CUIj9irOmdoAEJKTEoRGclRKb4vKjUoqtUgAmHJzgVL9EoRGSuMGaUcyJSpVSQCYcnOBUiUThEZK7QZpRzIl6X0SAQololKjBICRHZWUKpcANIKZKW9wU6pVogq3SrTEVulAbHJLJgCM5KgEoVGKG8HMlPN1R0tslUAlq1QyAWAkRyUIjVLcCGamvEpOb5Uo0CpRlVolAIzkqAShkZwLlKqXIDRSGjeqUqs0fP7l_wAAAP___PbPOg==

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMml1v4kYUhu_7K0ZztVHNmhnbJEFaKekmVVmlsE1y0e2KCwdPgwWxqT2ETaP898pQRIzJHI8dH8_dAv54z0eeec_MPtP0nznt05vLq8vPt2SZzMmv16PfyffLP79enQ-G5Hx4fvXtr0vy4WJwc3vzx9UR-f_S7PNg-PmWfJitPq6ONrfNHsmX0WBIZisyGpLZ48cZ-USy38no-uLymvzybf1pTC0axYEY-g8ipf3vlFGLcmpRh1rUpRb16NiiiySeiDSNk-yS5_UNg-AH7XctGkaLpcy-Hlt0EieC9p-pDOVc0D699e_m4lr4gUjsLrVoIKQfztevmT2eLZLwwU-eqEVvFn6U9knHzl48Wso-Octk3PlyMhUpiZdykX2ZPUIuF_NXX2WXDUZEhg-iT7optWgSr1KSCD_Ifhy_WHRz6Ub4VtjdE5n66TQv6Sy7fmzRVPr3gvbZi1Ut0t5epKtipDZ7HStvPVb-Zqy75yyjOAlEIoLck8bZndAlBxL2m59Ov8RhJBKb7bXGXPwtP5yxo09JeD9d_6tKpsQPMVnKMI52CctnaBe9o1PpizCVYTSRNvMKKX0_cXrlc2uUTxUi7zYY4k6-p5P_mziRIrF5Ifs_N6KtVyK1hxK7FnQwu8O4Ey9sZy-1JZR7esqPc8pZeX4xmNQ279iOsazWiPW4BKtzsZrGaobMamYUq4FK71jdM5TVeuVTspq1wGog_1tWF7KPwWpengK8BPGcju0aSzyNWE9KEC8Xq2nE48jE40YRD6j0jnjHhhJPr3xK4vEWiAfkf0u8QvYxiOeUp4BTgnhux_aMJZ5GrKcliJeL1TTiOcjEc4wiHlDpHfFODCWeXvmUxHNaIB6Q_y3xCtnHIJ5bngJuCeJ5HWN5pxGpB_OuYzPiRwFhJJZTkRhLPheZfK5R5ANqviPfqaHk0yufknxuC-QD8r8lXyH72DuRB7Rdi3QRR6nY_ws5-ORulnoR3ItNndJ4mUzE1ySerF-z-Tha37ee-AORys2vfPNhEG1_SqUvy25ndt8MX0fCqZaEQKQiCf15-K-ff6tFIyFXcTIjc1-KaPJURQvzmhRThKxWqZhBieLHqGKYRhPzZppYLeFUS0Kz6dhr4ncWAzUxUCpmUKL2mrhpMXxfTPe1GCenpbt_s6OMxK2D8bdXMR0JDBdPgBhcPKnFcMckMbjLravseU_d857y5l4-kP2be-q_tny3dptZM47f0XvVrYRai15XNJKOZr2Xbm1waQaIaZRm0IJ-8o7eq26e1Fr0TFjFJlZLaNZ76dYG12wBYho1W1ATnypXA9ZVL0RMPQzpua_anhYYYfXIVdELQiKQx0NgWMU1YJAaXAfGCjNQvvU50PrqqaXX5srEAKuLm2e1GOSiA-ORntWqumMClKdRi1W3d5ABVpiTWjRZgBjkrS61GE2_VbWTgfI06rPATgbE4W5yMfXQznrAclMY29t0WmoxyDtekBo9YlX1fWoR2E4LUIO86Bam-HzrnwCtX5ifDHJahfmpTaelFtNo0WsmCnmPCypbrVGx9OIJiMB1WlznPLzxEyGdk3FkWwFoQ97ogsqm58AqdjIkAvk4UT3Yc2Cw54XBvkWnBYhBdlqQGmRiqdVoWq6Kvg8Sgeu0eGF4z7e-C7S--lSyVafFC_MTntOqqQ25B9RikJ0WVDZkgAFqao2KpVdLYDhr1dyoteFucQFisJ0WUDbcM0VIjZ7lqtrJ6sGeA4M9Vx-MIjst4PwaGVSAGmSnBZxg425uQWpq_Zed0r5PfXDuAAfnTmFiatFpjV9--i8AAP__C8aA5Q==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEkV9v0zAQwN_5FNY9ATJq86c8-CkRK1pQaEYTCcaUBzc-bdZSO9jO2FT1u6Mkk9ZWbWmR0B59dz_f7-5WYH_VwCCfptNPBWlNTT7Ps6_kZvrjKo2TGYlncXr9c0reXiR5kX9L35Hn0vdD4f0D-Z4UlySbXySzOE2KaxLnhNMDiUUJFJQWOONLtMBuwIOSQmN0hdZq04VWfUEiHoGNKUjVtK4LlxQqbRDYCpx0NQKDgi9qnCMXaEZjoCDQcVn3394_RI2RS26egELecGUZ-QAUFtxVd2iJbl3TOkY6zLVNvRGaAIUkI04ukZGxBQpG_7bEIBddslxTGEqfrazjtwjMW9PTzTMjpOK1dE8jb1v8REF8xKp1UqsXz0Ni_jlimyv1X3ulwT-uNPjfKw0Pir34tEobgQbFlkzZkX8r2TPdJbd3X7RUaEbh9nRZ5x95NPJpFNAopNGERh9Pu4t_5tyTcw4yR9toZXF3_r0_j7uhUdzisESrW1PhldFV32Z4Zj3XBwRaN2S94ZGoIdUJbsLeUTjcgr1d2D8KB8c7B2d09nfh8Cg82elcrt_8CQAA__8pXOKU

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE2P2jwQx-_Pp7DmBJJRXnkOOUFbWqFS2ALavqxy8MYjGpHEqe3wUsR3r-ysumQFbXopHDOe_8z_NxPNAdT3DCJYjCaj10tSyYy8nc8-kIfR57vJcDwlw-lw8uXriHTejBfLxcdJlzylss2qs-6S2f1oTjrdWrXexEChEBynLEcF0QN4QMEHCgFQCIFCH2IKpRQJKiWkSTlYwZjvIHIppEVZaROOKSRCIkQH0KnOECJYsscM58g4SscFChw1SzPbZr0ZlDLNmdwDhUXJChWRnmMazyodkYGx8ch08g0VEZUuTdCU0FWZnYRM2nhGdJpjRFwFFKTYKiKRcfMYHynUqU8OlWYrhMg70gsUz-arQkiOEnnDeHw8w_kpLbjYonT6Tcjh_bvOwOv-gvKb_ky20izLTv3nbEdyzIXck0ohj0jokvfpq3bjMBVxh0mlU1E8V700Br8xBq_9Mr0_L9Pxe05wlXX67Tn8FhxBzwmvwhG05whacIQ9-3v-e46wPUfYgqPfu_qROEMxR1WKQuGLY3G-smuOCPIV1hdHiUomeCdFYtvUnzOrswGOStevXv0xLuyTNXgq9n4r_r8hdl-K_b_pbFEs1dkFcFQoU5alP1jzElEoUG-FXJOMaSyS_YWFNK0Ft2stvF1r_RuyFh__-xkAAP__tEnQXQ==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rs0AYxO_vp3iY99LCFvW6UEhoLRVsTDXQP8HDRh9S0bh2dw0twe9e1FxaKPQ4v5mdHZ4T7HsDiSyMw5sN9aahuzR5oG34vI6X0YqWq2X88hrSxW2UbbLH-JLO0XoO1kd6ug_TkGq6Jj-HQKtLXqkDW8gtAuQCndEFW6vNiE5TICo_IH2Bqu16N-JcoNCGIU9wlWsYEhu1azhlVbLxfAiU7FTVTLX1cdGZ6qDMJwSyTrVWkudfeb73HwJJ7yQtAgjslCve2JLuXTfCscb1XfMDRQm56sCSfIt8EJi98yzr1J4hg0H8fXrKttOt5W-rf2v2h1yAyz3P57G6NwWvjS6mb2aZTO8mULJ1sxvMImpna8iHf18BAAD__2zVkpI=
