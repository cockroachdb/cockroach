# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcml9v4jgUxd_3U1h-atUwwU6gFGkk2NnuihFNuvyRtjtCVUq8gKAJ64R2RlW_-yjQUSEU35gQ4_atQP787sn18c1Rn3D0_wzXcfeyffmlhxZ8hv7suFfo2-U_1-1my0FNp9m--fcSnfzR6va6f7dP0cuh04dPUwN5D6OT6eOn6enqtOkD-uq2HDR9RK6zPAR9Rsnv6K-O279Gv98svxxgAwehzxzvnkW4_g0TbGCKDWxhA9vYwBU8MPCch0MWRSFPDnlantDyv-N62cCTYL6Ik68HBh6GnOH6E44n8YzhOu55dzPWYZ7PuFnGBvZZ7E1my9tMHxpzPrn3-A9s4O7cC6I6KpnJjd1FXEeNBOPOi4djFqFwEc-TL5NLxIv5bO2r5LCWi84Q-86Gi3gSBiie3LM6Kkd48Gzg1XEr6l9Udz_Q2IvGmzwNggfPAwNHsTdiuE6ejf3KrKbKfNwu0yQaFUp3Fvp6nZD7jDM_fZ2z5MaZjnpDsyvGR-xrOAkYN0mqN2bsv_ikQc5OP_PJaLz681Uvo0GzSwaq9aqEJfPIm6MRZyMvDrlJKlsCG9hdifHyfJvOza3j9m6dfrt90iBJMd3-1UmDJn99cftO7-XvQ1Ul1wN2vh4Qy0PL-eTp9q9uW4lAVvKpwwKf8WUboAY1G1YhrVDJIMgieEuSN9VwwlI4N2mqTzJgV-SwqxvYJLtpEdibTVoyLV1Mi-xb6HkGd9apULqzUIXuTPRzZ-CRr7tz9WO5s3QPAO5M3rs70-yrn2awOatk2rqsfrJvobUMNqdToXRnoQptjupnc8AjX7e5849lc9I9ANgcfe82Z2Vf_VYGm7NLZkWX1U_2LfQig83pVCjdWahCm7P0szngka_bXO1j2Zx0DwA2Z713m7Ozr347g81VSrqsfbJvmRXY5EomQV7gI4LCeMy4LiXTnSUrtDtbP7sDHv663V18LLuT7gHA7uz3bndAytxh0TwMIpaKGN--cjlRi_kjtlI3Chd8yK55OFzeZvXRXZ63TBF8FsWrX-nqQyv49VMUe3HWiLIsNg8ZjpomHMTKAwK4qRSILorQXIpIgRCJVqVH46hpwpFqVUkQqVYFQHRRhOZSRAqEpkHK6yCbHOX0yZawCluZA4k5SFnZwgdAKpqAUF0UoeoUsYWNnuJIn1wRnkyrm8ukwCqqmgxBYg51W76YI98QdEgQXRTJNwRJmfK5JkOQmEPdli_myDcEHRJEF0XyDUFSrVoT2vuFeAi6KG4IklJTzJFvCJJSEwBRt-WLQRQOQQCIOkXI1iuyaAoq8kVM5hW5UEVk3pGPCKJwlIFIcmly0C5RqMnWe_KxIh0xiMIEQwyicJ6BSHJpItevQJco1GTrvXvD6IktnmnI1tvykYYaAERhtAORKNw7xSQK5xqIROFgI05oFD4cXRIaAEThJq5NRgORKBz2ikxp5Eh0iWkAEIWbuDZBDUSicNgrMqqRIxFnNQQIa4guaQ0AonKw0SavAUjyDTZyHqBNYkN1SWxogYnNIUHUbeIAiMLBBiLRRhOFgw0tMLGR61ddEhsAROFgA5Foo4nKf8QRJzYUSGyoLokNAKJwsIFIFG7i2iQ2EInCeeJoic3g-befAQAA__-_Pfnv

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMmd9u4kYUxu_7FKO5SrRm7RnbJCCtlHRDVVYpbCEX3a64cGAaLIhN7SHZVZR3rwxFxDY7x7OG47mLwWO-8yc_f2fmhab_LmmXjnu3vY93ZJ0syW-j4R_ka--vz7fX_QG5Hlzffvm7R85u-uO78Z-35-T_W7Pr_uDjHTlbPL9_Pt8uWzyRT8P-gCyeyXBAFk_vF-QDyb4nw9FNb0R-_bK5mlCLRvFMDIJHkdLuV8qoRTm1qEst6lGL-nRi0VUST0Waxkl2y8tmQX_2jXYdi4bRai2zjycWncaJoN0XKkO5FLRL74L7pRiJYCYS26EWnQkZhMvNzyyerlZJ-Bgk36lFx6sgSrukZWc_PFzLLrnKZNwHcjoXKYnXcpV9mD1CrlfLNx9lt_WH5B0R38R0LcM4IjJ8FF3ipHTyatHtfVvVO1X338k8SOd5PVeMTl4nFk1l8CBol71aPxdmuxDmczlMm70NlDcbKP9hoPvnrKM4mYlEzHJPmmQroVsOZOv3IJ1_isNIJDYrNMVS_CPPrtj5hyR8mG_--pk0gRnaR-_qlPkmTGUYTaXN_FJKjydOr3xejfKpQuTOCUPcy_d18j-OEykSm5ey_-4k2toVUnsosRtBB7M7iFvxynYLqa2g3NdTfpFTzqrDi8GMtnnLds2ktEagFxUonQvUKEozZEozoygNlHlP6bahlNYrn5LSrAFKA_nfUbqUfQxK8-oI4BVY57Zsz0zWaQR6WYF1uUCNYh1HZh03inVAmfesuzCUdXrlU7KON8A6IP871pWyj8E6tzoC3Aqs81q2bybrNALtVGBdLlCjWOcis841inVAmfesuzSUdXrlU7LObYB1QP53rCtlH4N1XnUEeBVY57fMJJ1GmD5MupbNSBDNCCOxnIvETOZ5yMzzjGIeUPA98zqGMk-vfErmeQ0wD8j_jnml7GPvOB7QNhLpKo5SUfwPOfhkJ0u9mD2IbZ3SeJ1Mxecknm5-Zns53KzbzPczkcrtt3x70Y92X6UykFW3LR01QXR0dAzRwfw6QgCkahWGGZIRfoEmhGm0Km9MR8cQHYVW1RSi1apAYZghGSm06imF8KIQ560QN6fDKS52lVF4aARS62B4BAKE4BFILYS7pgjBe116ykb31Y3uKxe380EUF7fV_2L57nROmIILQxyUWgdeS6h11HNQxywMHr8AIbX4pUX0S0MclFoHnoNS66jnoI4oBNFBAUJqOSitVu0o8c4c9ZuFqYeWWh5Kz5EC82QtCOmZdEAJ4hwHTJR4NgpSgvfSZKXRJd_vHOh39cDRxusywJniJVQtBLGywPSC54eg2iCyCFCCyKLSANPUppJaCOKukloIoimCalPLFen1K6AEb2OJqWdm1gbeE6WpuSlfpBaCuLkEKcGbzgAlmL4IUIL49izNzvl-vwT6vTTPNOWLSvNMU75ILaRWZY-ZEUxfBNQGkUWAEjxfxHXOhU96kqJzMHxKDwAIQfRFUG3wdosgJYgHbur5mQPzMy_Nzw35IkAIoi-ClCCySK2kni_SYwCgBM8X8dIEne93D-h39bkdni_ipXnmeL7omEIQK6sWguiLoNogsghQgsgiYDLCsyNqIXj7RYAQTF8E1AbRFwFKEH2Ren7mwPzM1eeBiL4IOKpFZBGgBJFFwGEt3n4RpARvV4Grz41d4NzYLQ00WL5o8vrLfwEAAP__ep-rmg==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEkV1r2zAUhu_3K8S52odG4o_sQlc2a0Y9vLiLDVtXfKFYh1bUkTxJLi0h_33YLiwJTRYPxi51dB6d57zagP1ZA4N8ns4_FqQ1Nfm0zL6Qm_n3qzROFiRexOn1jzl5fZHkRf41fUOeW98OjfcP5FtSXJJseZEs4jQprkmcE06PXKxKoKC0wAVfowV2Ax6UFBqjK7RWm6606RsS8QhsSkGqpnVduaRQaYPANuCkqxEYFHxV4xK5QDOZAgWBjsu6f_b-IWqMXHPzBBTyhivLyHugsOKuukNLdOua1jHSYa5t6p3SDCgkGXlH8BGr1kmtiJNrZGRqodxSGPqelazjtwjM29LztTMjpOK1dE8Tb9_6TLsRYv4Ysd08_f-aZ_CXeQb_Os_wqNhvn1ZpI9Cg2JMpO_JPLS9sd8nt3WctFZpJuL9d1vlHHo18GgU0Cmk0o9GH8z7FH7n3bMyHLNE2Wlk83P_Fl6fd0ihucQjR6tZUeGV01Y8ZjlnP9QWB1g233nBI1HDVCe7C3kk43IO9Q9g_CQenJwcjJvuHcHgSnh1MLrevfgUAAP__idniBg==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE1v2kwQx-_PpxjNCfQs8is97Cm0pRUqDSmg9CXyYeMdUQvb6-6uCRHiu1drR02IaOtIFcnRs_Of-f9mrNmh-ZEjx8V4On6zhFrn8G4--whX4y8X09HkHEbno-nXb2PovZ0slotP0z7cpYrNqrfuw-xyPIdev1WtNwkyLJWkc1GQQX6FATIMkWGEDGNkOMSEYaVVSsYo7VJ2jWAit8h9hllZ1daFE4ap0oR8hzazOSHHpbjOaU5CkvZ8ZCjJiixv2qw3Z5XOCqFvkeGiEqXhMPBc41ltOZw5G9fCpt_JgKpt5YKuhK2r_EHIpU1m8D_QltLaZqoEmxXEwTeY7Bm2eXf2jBUrQh7s2W8Q7p3XpdKSNMkD18n-COTnrJTqhrQ3PCQcXb7vnQX9X0SOTasbA5qE5OCyjRV5fm-YYSG2UFCh9C3UhiSHyIcP2etus3AVnzCG8GAMQfdNBn_fpBcOvOj0uwy7Q4QdIKKBF58eIuoOEXWAiAfNj3liiLg7RNwBYjh43sNwBGFOplKloUcH4nhl3x0Okitqr4xRtU7pQqu0adN-zhpdE5BkbPsatB-TsnlqDD4UB38UvzoQ-4_F4VM6NygN1T-Y_qGP6IX4iF-Ij-Fz-Uj2__0MAAD___KWss0=

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rq0AUxffvU1zO27zHm4e6HSgktJYKNqYa6J_gYqKXVDSOnRlDSvC7FzWbFgpd3t_9zZk5c4Z9ayCRhXF4vaHeNHSbJve0DZ_W8TJa0XK1jJ9fQvpzE2Wb7CH-Sxe1nsX6SI93YRpSTVfk5xBodckrdWALuUWAXKAzumBrtRnReRKi8gTpC1Rt17sR5wKFNgx5hqtcw5DYqF3DKauSjedDoGSnqmaKrY-LzlQHZd4hkHWqtZI8_7_ne78hkPRO0iKAwE654pUt6d51IxxjXN81X1CU0D_iExe9q3RLrjqwJN8iHwRm7_JE69SeIYNB_LxGyrbTreVPDb5L9odcgMs9z19ldW8KXhtdTNfMYzKdm0DJ1s3bYB6idl4N-fDrIwAA__-YOZbR
