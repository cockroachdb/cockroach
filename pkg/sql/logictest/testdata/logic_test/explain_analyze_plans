# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWF1P4zgUfd9fYfmJ0aST2kn5iDRSmVl21VFJWArSsqMKhcZbqpak66QwCPHfV2lBtCn1dXAdB97aNM659_bk-Pg84PS_CfZw76h79P0MzfgE_XEaHKOfR3-fdA87Pjr0D7sX_xyhnd87vbPeX91P6OnW8e2XsYXC2-HO-O7L-NNi2fgW_Qg6PhrfocCf34K-ovx39OdpcH6Cvl3ML_axheMkYn54w1Ls_cQEW5hiCzvYwi62cAv3LTzlyYClacLzWx7mCzrRL-w1LTyKp7Msv9y38CDhDHsPOBtlE4Y9fBZeTdgpCyPG7Sa2cMSycDSZw4xv21M-ugn5PbZwbxrGqYcadg4czDIPtfMyrsJscM1SlMyyaX4xf0Q2m06WLuW3dQKUjW6Yh5ppvug-YyniLIw8RA_QN2xhntw9XyG4_2jhxepFL8-1Xt2j6zC9Xq2ynd_ft3CahUOGPfJova353ULzd-vN26T27dON7b88J-ER4ywqPudzDix11yuTPGZ8yH4ko5hxmxR4NGH_Zjtt8vnTVz4aXi8-vkzRalP5QbJfbDDLRkn8Ms_Vab1MwilDhMPhkLNhmCXcJq21AVs4WAzj6V8_9C8u_eDs0j_vdnfaJG-md36806b5p-_BuX_29HlbXZXjgKvGAfF4aFNtPL3z48tOPiAn_3bK4ojxOQ1Qm9ptRwsVWhIDmcWvjeTVafhJI5natMATibJb5creXSmbyEsZgXXcpg3bqbeUkbe2vyeh5PVvn25sv0IlJ_VTcoAIy0q--7GUvDQHACUn713JqbwmUAlJdBq2W29NIG9tf19CEuvfPt3YfoWSSOsniQARliVx72NJYmkOAJJI37skOvKa4EhIotuwW_XWBPLW9g8kJLH-7dON7VcoiU79JBEgwrIk7n8sSSzNAUASnfcuia68JrgSkthq1FsRyFubb8GC2LAJCuMIEZRk14zXexB04yAqlEa3ftIIUGJZGg8-ljSW5gAgje57l0YgFT9l6TSJU1aIRF9_cjOfFouGbDHdNJnxATvhyWAOs_gazNfNk4yIpdniV7r40omff0qzMJONVJsb2y9Twr5qCcuqVhKbOCrgYkklLfqqppaqz-RwqNJwQHBSgphUDzHFJeyrlqDQfoGYJcG3QUygPpPDoUrDAcFpEby5DL6K3SwudoSVu6pyI8NqcQmkqfWtBsBbBsGpyc6p3s5dIWcL2MXFLeFiurvKeD1SvKvXpgiHJ8ZW3oLV21ezKYr9a_YgwB9v3KDt6bUpwtmIsZW3YBliiktQsymK_Wv2IMAfb9yg7QtV-0BsUw702RRwsGJsNX8i65GAGvRu1mJwzTYFANfbOVk7cYp8yjbfKepIHXrKHEq3Ppwyx9GKwdUdiNR5vNSh04AZgPihOTFZO5lW6EUAcM15gBhc3YZIsRMoQmkEW2EnwA-9Zo2sHYBXtJ24YkdC1o6wFVoSAFxzZgKhK2-LUuwWF6HZlUDomm2JOAExb0tMpiMAuPk92Wh2AqFXkh5B_NA8ApMRCQBufk82GqBA6JVESBA_NI9AnJMQICghJpMSAFy3LTEakgDoan5E2hQZTUtozdMSqjEt2Yb2AvXpDVQAcM22BEI32ru6H5F5d6nGtGQr7DQZqADgmm0JhG60d3U_IsVOcVpCgbSEmkxLAHDNtgRC17wnG41JIPRKkiJat7Sk__jb_wEAAP__1GChmw==

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUmc9v4kYUx-_9K0Zz2qhmzYxtEpBWSnaTqqxS2CY5dLvi4OBpsCA2tYewUZT_vTIUEWN23niHZ5tbcDx-P_3x98280PTfGe3R26vrq093ZJHMyG83wz_It6u_vlxf9AfkYnBx_fXvK_Lusn97d_vn9Qn5_9bsd3_w6Y68my7fL0_Wy6ZP5POwPyDTJRkOyPTp_ZR8INn_yfDm8uqGfPy6-jWiFo3iQAz8R5HS3jfKqEU5tahDLepSi3p0ZNF5Eo9FmsZJdsvLakE_-E57bYuG0Xwhs8sji47jRNDeC5WhnAnao3f-_UzcCD8Qid2mFg2E9MPZysz06XyehI9-8kwtejv3o7RHWnZmeLiQPXKeuXHvy_FEpCReyHl2MXuEXMxnby5lt_WHRIaPokfaabboWYqUJMIPeoR3yUdq0SRebq4wOnq16Hr1OpaNr_fPZOKnk7yX59n9I4um0n8QtMderZ8LvrMT_LIYvM3ehs-bGD7_Yfjb5yyiOAlEIoLck0bZSuiWPTn83U8nn-MwEonNdhpoJv6R787ZyYckfJis_vqZ5InvYryQYRxtc5jP0DZ6p0zxL8NUhtFY2swrpPRwzpUrn2tQPlWIvI0Y4tZ9r0z-b-NEisTmhez_iuJbRyO1-xK7cmhvdgdxK57bzk5qNTz3ynl-mvOc6SONwTy3ect2jonoJcI_1SB6LvwjIDqrmOisUUQHir8leqehRC9XPiXRWQ1EB_K_IXoh-1UQneuDgWtw0WnZ7jFxsUT4ZxpczIV_BFzkFXORN4qLQPG3XDxtKBfLlU_JRV4DF4H8b7hYyH4VXHT0weBocNFt2d4xcbFE-F0NLubCPwIuOhVz0WkUF4Hib7l41lAuliufkotODVwE8r_hYiH7VXDR1QeDq8FFr3VMVCwRvAdTsWUz4kcBYSSWE5EcEx_divnoNoqPQBts-dhtKB_LlU_JR7cGPgL53_CxkP2qd0j3-HYj0nkcpWL3Ddn75HaWehE8iHWd0niRjMWXJB6vzKx_DlfrVnsMgUjl-r98_aMfbf6VSl_qbrO2fxh-GRe6pi68RVtJ28wzMa7mKvP4XrCWKg-rMTn8FNU4K9GYHKcx1S50TV0wCH-nMUsaP0RjAuVhNSZnpzEPbZzvGm-_Ne7kbLd3FztKz11T3Oh0tdoFhosUwDguUtTGuVOncdzPnKvsWU_ds55ycSfv-O7ijvptyXdbG4fjp7gaR5l5tW3jqpuHb6ZxDONHFjCAcSPaHOIjeoarcZS5Uds2Fjc6jal2wUzjGMaPLGAA40YC5hCN2VVSm7XVHwymHhyMVA6sDYGRzog4uhoLcgJ5dAIGN1yhA1nHVTqsMBvkW5cDratW9526vxgMkJG4uVUbRy4sMDoYyxit9xpIvzFcsPsDGTyFOaNCQQMYR96uURs31zJa3Qmk30jTHKQ7AQdxN26YepBlHeDTUBhlq1Q1auPIuzaQdeNBSqu71U5gqxrAOvLHrzDJ5lv3DGjdwrzRMFVTmDeqVDVq40aFrSA5yPs3UGmMwaP16gNO4KoaXuaM9OCnDWVOR2v4pAP-IW_iQKUx3sXR6U7ICeTjKPXAy4GBlxcG3gpVDWAcWdVA1pGporZuJmd0NRXkBK6q4YVhNd-6LtC66lOt2lUNL8wbh1M1FfiHXHu1cWRVA5UGGTyAdWPwaL36wEBTu7BQ-4e7nQMYx1Y1QGlwz6Yg68ZyRqs71QMvBwZerj5gQ1Y1wLkmMlwA68iqBjjZxN2kgawbz_Jaras-PHWAw1OnME3UrGpGr7_8FwAA__8TL1NK

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMkc9v0zAUx-_8FdY7ATJq84uDTwmsaEGhGU0kGFMObvy0RUvtYDtjVdX_HSUZWlu1pUVC2tHP7-P3-T6vwPysgUE2SSYfc9LqmnyapV_IzeT7VRLFUxJNo-T6x4S8voizPPuavCFPrW-HxvsH8i3OL0k6u4inURLn1yTKCKcHLuYFUJBK4JQv0AC7AQcKCo1WJRqjdFda9Q2xeAQ2plDJprVduaBQKo3AVmArWyMwyPm8xhlygXo0BgoCLa_q_tn7h7DR1YLrJVDIGi4NI--Awpzb8g4NUa1tWstIh9m2qTdKAVCIU2KrBTIyNh20tGiIRi4YcfyAfAAKWv36UwqgWFMY8CdTY_ktAnPW9PQ0qRaV5HVllyNnO8yJ0viIZWsrJZ_dD4m554htrtl9iWv2_nHN3v9es39Q7NmnlUoL1Ci2ZIqO_FvLnnSX3Nx9VpVEPfK306Wdf-jQ0KWhR0OfhgEN35_2V-6ZuYNzPmSGplHS4G7-vS-Pu9AobnFYolGtLvFKq7IfMxzTnusLAo0dbp3hEMvhqhPchJ2jsL8FO7uwexT2jk_2zpjs7sL-UTjYmVysX_0OAAD__86Z7eY=

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE1v2kAQhu_9Fas5gbTIn1TqniAtrVAppIDSj8iHjXdELWyvu7smIMR_r9ZOGxyRxlUvPnp23pn3mbHmCPpnCgxWk9nk7ZqUKiXvl4tP5Hby9Xo2ns7JeD6effs-Ib1309V69XnWJw-pfLfpbftkcTNZkl6_Vm13EVDIpcA5z1ADuwUPKPhAIQAKIVAYQkShUDJGraWyKcdKMBV7YC6FJC9KY8MRhVgqBHYEk5gUgcGa36W4RC5QOS5QEGh4klZttrtRoZKMqwNQWBU814wMHNt4URpGRtbGHTfxD9RElqawQVvClEV6FrJp0wUxSYaMuNqKDgY1UcgFI_4bcgUUlLz_HfEgOlGo1Q-mteEbBOad6DNgjzxlLpVAhaLBEp0uoH9JciHvUTnDJvf45kNv5PX_cPpNfzZbG56m50gZ35MMM6kOpNQoGAld8jG5ajchWxH3GJcmkflj1efG4DfG4LXfr_fyfh1_4ARd2bDfHs1vgRYMnLAraEF7tKAFWjiofuJOoIXt0cIWaMNBV8BeuKRL1IXMNT45PJcru_Ygodhgfb20LFWM10rGVZv6c1HpqoBAbepXr_6Y5tVTZfBc7P1V_Lohdp-K_X_pXKFUVP-_E2_oX1xK017QbXtht-0NO2YvOr36FQAA___Ch-cn

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rs0AYxO_vp3iY99LCFvW6UEhoLRVsTDXQP8HDRh9S0bh2dw0twe9e1FxaKPQ4v5mdHZ4T7HsDiSyMw5sN9aahuzR5oG34vI6X0YqWq2X88hrSxW2UbbLH-JLO0XoO1kd6ug_TkGq6Jj-HQKtLXqkDW8gtAuQCndEFW6vNiE5TICo_IH2Bqu16N-JcoNCGIU9wlWsYEhu1azhlVbLxfAiU7FTVTLX1cdGZ6qDMJwSyTrVWkudfeb73HwJJ7yQtAgjslCve2JLuXTfCscb1XfMDRQm56sCSfIt8EJi98yzr1J4hg0H8fXrKttOt5W-rf2v2h1yAyz3P57G6NwWvjS6mb2aZTO8mULJ1sxvMImpna8iHf18BAAD__2zVkpI=
