# LogicTest: 5node 5node-spec-planning

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWF1v4kYUfe-vGM0TqzVrZmwIQVoJuk0rVsRO-ZCarlDk4CkgiE3HJtlVlP9eGbIKmDDXY8ZTJ2_YHvvcc-dyjo8fcfTvErfw4KJ38WWI1nyJfu-7l-jbxV9XvU7XQR2n07v--wJVfusOhoM_ex_Q89LF_aeFgbz7aWXx8GnxYXvb4h59dbsOWjwg19ksQZ9Rch390XdHV-jX683JMTZwEPrM8e5YhFvfMMEGptjAFjawjQ1cx2MDr3g4YVEU8mTJ4-aGrv8dt2oGngerdZycHht4EnKGW484nsdLhlt46N0uWZ95PuNmDRvYZ7E3X25gFvftFZ_fefwHNvBg5QVRC1XNBNhdxy3UTsq49eLJjEUoXMer5GTyiHi9Wu6cSpZ1XRTP71gL1SJsYB4-RIgzz08ujp8MvF26LfxnYbc_0MyLZvsltZP1YwNHsTdluEWejHxMGymmD4dMTVIurvQo15fnhNxnnPnp53xMgDOteqVtl4xP2ddwHjBuktSELNk_caVNPn74zOfT2fbnS8uMNs3eNfadTdbxPAxemrffrZdOWDK73plOOZt6cchNUj9osIHdbTOet7jjXN847vDGGfV6lTZJyAxGl5U2TX59cUfO8Pm3KlZyM2CfNgPi9tDaae0ZjC5vukmDrOSozwKf8c0YoDY121Yho1DP0JB18FpLXu2GE1bDlUlTc5Kh7Lpc2Y29skl23SKwQpu0alol0i2Sl-tZBo0uGVd6lKtGjSbl02hg13c1uvG-NFp6BgCNJm9do2l2AaAZxM6qmnaJBIDk5drMIHYl40qPctUodrR8Ygfs-q7Ynb0vsZOeAUDs6FsXOyu7AFgZxM6umvUSCQDJy_U8g9iVjCs9ylWj2FnlEztg13fFrvm-xE56BgCxs9662NnZBcDOIHb1aon-_iQv0zosdVWTIC_wEUFhPGO8RKzpUdYaRc8un-gB-78reufvS_SkZwAQPfutix7w9bnPolUYRCz16fH1J9eSbjF_yrbdjcI1n7ArHk42MNtDd3Pf5ruCz6J4e5VuD7rBz0tR7MVZP13WjtKXKaEpVcKuXkkCESs30qEySgFro0jzUzxAIhKDQ4sZHHEJTakSTuCaGhwZJGhwAGBtFGl-igdINI1U20XaB6qlb7aEZdqnyNVxtZYpgdTU_cUApLouJKqNE1XIyRbOWQoofXNdeDNt7E9pMfLWUGjNwk6JgeTcqRCuJ1izLJJCLwb2r7jXjTOF1ixkKAaSc6ecgyMu4QRrlkVS6MXA_hX3utEUqt652JrPFVqzsD1iIEkDzvkSANSg0MbESCqtGUBSyIkcxBSRN6t8n5ZJLadRlAknRSJJemfeKCaVVHRuqcrIexBdijJWAEll7hMjSRpo3ukBisjPF5weYEsVvj-Qg-izJ3rEFtsrOcgzRfkrgKQy4UJQck6Q08uBIlRaLASl0mPFEbZAj9WWWwGkAj1HX1yFoLSkc2hLVfLVFl4BpAI9R19mhaC0RHRoS1XyFSdYAkRYoi3DAkhKPVZfVgWgJJ00r53ry7H0_8qxtKgceyKwwlgLIKn0WAhKHytJJ80pyLSoHAtOj7ZYCyCp9FgISh8rSSfNOz3iHEuBHEu15VgASaXHQlAqPUdfWoWgtKRzqi3Hjp9--S8AAP__l-CBjQ==

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMWVFzokgQfr9fMTVPSR0uzAAardqq5DZenVs53dM83N6WD0TmIqUBDzDuVir__QpdyyBmmoEGeYsR_Lq_7vm-bnih0X9L2qOT_l3_0z1Zh0vy-3j0J_nW__vL3c1gSG6GN3df_-mTi9vB5H7y190l-Xlp8nkw_HRPLhabD5vL3W2LZ_J5NBiSxYaMhmTx_GFBPpLkezIa3_bH5Lev209TqlE_cMXQeRIR7X2jjGqUU42aVKMW1ahNpxpdhcFMRFEQJpe8bG8YuN9pz9Co56_WcfLvqUZnQSho74XGXrwUtEfvnYelGAvHFaFuUI26Ina85RZm8Xy9Cr0nJ_xBNTpZOX7UIy09AR6t4x65TsJ4cOLZXEQkWMer5J_JT8Tr1fLNv5LLBiMSe0-iR4yIajQMNhEJheMmX05fNbq7dBf4PrCHH2TuRPN0SNfJ9VONRrHzKGiPvWrFMm0fZbrJZqqzt7nys-fK38318DtrPwhdEQo39UvT5E7okhOE_eFE88-B54tQZ0etsRT_xhfX7PJj6D3Ot38VYUp8F7N17AX-gbA0Q4fsTZVK33pR7PmzWGd2hlK84NTKZ5UonyxFblSY4iF8W4X_SRDGItR5hv1fK4mtnYPaU8RuAzrJ7jBoBSvdPKI2R-S2WuSdVOQsv34xWKl13tLNxmq1Qq6dHFqdyrVpWs1q1mrWKK0GKn3Q6nZDtVqtfFKtZmfQaoD_vVZn2K9Dq3l-FeA5FM9s6VZjFU8h16scipfKtWmKx2tWPN4oxQMqfVC8TkMVT618UsXjZ1A8gP-94mXYr0PxzPwqYOZQPKul241VPIVcuzkUL5Vr0xTPrFnxzEYpHlDpg-JdNVTx1MonVTzzDIoH8L9XvAz7dSielV8FrByKZ7caq3cKmdqw3rV0RhzfJYwE8VyEjVU-q2blsxqlfEDND8rXbajyqZVPqnzWGZQP4H-vfBn2634SeSK2sYhWgR-J4xNy8peNhHrhPopdnaJgHc7ElzCYbWF2H0fb-7YbvyuiePct330Y-PuvotiJ8z7ONN5NXyWErlIIb0VLEYjZhZGy8qhEMqsrRd7BQ2IKjcOraRx5CF2lEErketQ4KkhQ4wAks7pSPGqcUkj8GMl4i2SmgIzjm01pmFYZuXpfrVVCYIiHGUBCPMxyJG7WhoSo9pa0z2x5n9nSm9vpKI9vbss7PN0hRjXa2EH0dSnNciC1elaSawlfV2UV8ewDSMXPPmQ5V4i-Ls1QDqTm3gUbRx5CCV9XZRXRyAGk4kYONU5XqnrMkAsuk0-uas4un3SANUDtEBccIqAgMAd1YCdANHcICtHdWWZgTbcbB9pNPoW2K5NXBgxAiAzJkTBrAQyqagZcdBkEiC3uzWVLinmWM0NtVe4MIGEu13IkRRcu2j0AscUNGuweABlx82byrYa1Ac3M7DWVWbQcCXPHhqDUDm_RaUAeBKpFA1CYtpDZYdLtdgW0W2aSrcuiM5NsZRYtRypei5IpYq7MEJulxu3c8g4EgWjRXOWNSrkHqSovTjAtCwDG3JshNtV8uWD3QEFgPhyXrzUcWGt4Zq2pyqIBJEyLhqAwD68cStGIC04DUBCIFs0zq0u63Syg3eTP2KuzaJ6ZZJEsuiQwZmnkSJgWDbGJeZYBqFLjdm49B2bg6oxTDoy4VANIqBYNsIn4bBuCUjPiot0jX2s4sNZw-QN6TIsGXm9gHmsACtOigRcciLsyBFXq5WbuaUD-XsUE3quYmdm1Kouevv7yfwAAAP__JkEzOA==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzEkV9v0zAQwN_5FNY9ATJq86c8-CkRK1pQaEYTCcaUBzc-bdZSO9jO2FT1u6Mkk9ZWbWmR0B59dz_f7-5WYH_VwCCfptNPBWlNTT7Ps6_kZvrjKo2TGYlncXr9c0reXiR5kX9L35Hn0vdD4f0D-Z4UlySbXySzOE2KaxLnhNMDiUUJFJQWOONLtMBuwIOSQmN0hdZq04VWfUEiHoGNKUjVtK4LlxQqbRDYCpx0NQKDgi9qnCMXaEZjoCDQcVn3394_RI2RS26egELecGUZ-QAUFtxVd2iJbl3TOkY6zLVNvRGaAIUkI04ukZGxBQpG_7bEIBddslxTGEqfrazjtwjMW9PTzTMjpOK1dE8jb1v8REF8xKp1UqsXz0Ni_jlimyv1X3ulwT-uNPjfKw0Pir34tEobgQbFlkzZkX8r2TPdJbd3X7RUaEbh9nRZ5x95NPJpFNAopNGERh9Pu4t_5tyTcw4yR9toZXF3_r0_j7uhUdzisESrW1PhldFV32Z4Zj3XBwRaN2S94ZGoIdUJbsLeUTjcgr1d2D8KB8c7B2d09nfh8Cg82elcrt_8CQAA__8pXOKU

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElE1v2kAQhu_9Fas5gbTIn_SwJ2hLK1QKKaD0I_Jh4x1RC9vr7q4JEeK_V7uOGhyR1L2Eo2dn5n2fGWsOoH_nwGA1mU3er0mtcvJxufhCbibfr2bj6ZyM5-PZj58T0vswXa1XX2d98pDKd5vetk8W15Ml6fWbqu0uAQqlFDjnBWpgNxAAhRAoREAhBgpDSChUSqaotVQ25eAKpmIPzKeQlVVtbDihkEqFwA5gMpMjMFjz2xyXyAUqzwcKAg3Pciez3Y0qlRVc3QOFVcVLzcjAs8KL2jAysjZuuUl_oSayNpUN2hamrvKTkE2bLojJCmTE10BByTtNFHJhH5MjhSb1waE2fIPAgiN9huLRfF1KJVChaBlPjmc4v2WlkHeovGEbcnz9qTcK-n-hwrY_m60Nz_NT_wXfkwILqe5JrVEwEvvkc_au2zhsR9xjWptMlo9dnxtD2BpD0H2Zwb-X6YUDL7rIOsPuHGEHjmjgxRfhiLpzRB044oH7PV-fI-7OEXfgGA4ufiTOUCxRV7LU-ORYnO_s2yOCYoPNxdGyVileKZk6meZz4epcQKA2zWvQfExL9-QMnhYHLxa_bRX7T4vD_1F2KI7q7AJennZbN7qQbnwh3eFr6SbHN38CAAD__7CXm4U=

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9rs0AYxO_vp3iY99LCFvW6UEhoLRVsTDXQP8HDRh9S0bh2dw0twe9e1FxaKPQ4v5mdHZ4T7HsDiSyMw5sN9aahuzR5oG34vI6X0YqWq2X88hrSxW2UbbLH-JLO0XoO1kd6ug_TkGq6Jj-HQKtLXqkDW8gtAuQCndEFW6vNiE5TICo_IH2Bqu16N-JcoNCGIU9wlWsYEhu1azhlVbLxfAiU7FTVTLX1cdGZ6qDMJwSyTrVWkudfeb73HwJJ7yQtAgjslCve2JLuXTfCscb1XfMDRQm56sCSfIt8EJi98yzr1J4hg0H8fXrKttOt5W-rf2v2h1yAyz3P57G6NwWvjS6mb2aZTO8mULJ1sxvMImpna8iHf18BAAD__2zVkpI=
