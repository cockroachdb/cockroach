# LogicTest: 5node-dist

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzsmV9vqkgUwN_3U0zmyeZiYQawluQmeu92N9612PVPst3GNFRmlYjgDmjbNP3uG6QbFWUOOL2NMX2r6M_DOZz5nRP7gqN_fWzh3lX76nsfLbiPfut2rtHd1V837WbLRk272b79-wpVfm31-r0_22fo7aPT5flUQc5yXJk-nk_PUmy6RD86LRtNH1HHXn0EfUXJ--j3bmdwg77dri4OsYKD0GW2M2MRtu4wwQqmWME6VrCBFWzioYLnPByxKAp58pGXFdByn7ClKdgL5os4uTxU8CjkDFsvOPZin2EL950Hn3WZ4zKualjBLosdz1-FmXNv5vDnxnSJFdybO0FkoaqaBO4sYgs1ktt4cOLRhEUoXMTz5GJyLV7M_cyliPlsFHtLL362kHauJZGi2PF9FHszZiEtwsNXBadImsD_N_jwjCZONNm-tQbBw9fh6jvGDFvkVTks41pOxo_rjFVynDnT3JzX3xNyl3HmZr_nSxK40Kf2lO-a8TH7EXoB4yrJdIzP_okrDfLl7Cv3xpP0z3XplAaVqx57YqNF7IXBuoIKnjlPaMZmIX9Gju-HIydmroV0Df3hfcsUeF08vUzDNMdjzsZOHHKVmDvPRMGdtH5v3dG0b-_tTv_eHrTblQZJ8u8NrisNmvz1vTOw-29_v3chePgYIc4c943bbrWtQi2i5HbJvhqVa0JDrgnFxaaaXLF7g-v7VlJuPXnVZYHL-KoPUYOqDf3dH0Fes5kFirQI9pVpb4XssBrOVZrpxGwq5m4qpnwqta1USHHREni0qLSq6kcoWnJozhcFhsuR5kxzc_7A4UJOYrgADbM5XGrvN1wOHQY_14kyw6V0EwLDhZzicKHF7UQLGFmvqsYR2okcmnO9gJGPNGeam_MHGpmehJGBhtk08sWnkfONXLoJASPTUzSyXtxOegEjG1XVPEI7kUNzvixg5CPNmebm_IFG1k_CyEDDbBq5_mnkfCOXbkLAyPopGtkobiejgJHN6hG6iRyasQn7uKoS5AQuIiiMJ4wfYfY0N_sPNLNxEmYGWmfTzJefZs43c-kmBMxsnKKZgf_DdFk0D4OIZX4i3__NWlJB5o5ZWvEoXPARu-HhaBUmfdlZcaufllwWxem7NH3RCtK3khssDtdlYKJL0VKxKRCblKgZLQfXZeBMzcrSUrEpEJtmaW2T3oa1LKwLQxvipyWGiSZFmzI0lYpNgdiGsOIAbAphWhM_r5qMVMQwcLDFMCQVgJaKDUnlQkYqYhg42GIYkgpAS8WGpFIXdumluEkvZaQihiGpADRwNsU0JBWABmKTnclZxiqkzOQsSwOnE6AhNUC4XHRw49gZn6VWDjENzX0xDS4dAC4XHTIE2ZmhW_1KDLEjyM4QLSMJgIYsAeHQYRPjkCcgHIou3iAgWmqDAGjoqMrtEBAuFx0UhdQaAdDQUZVbJCBcLjooCvEuQYBlgkhtEwANikJunwBwUBRyGwWV2iio1EYB0MBRBWhIFBAuFx0SBZXaKAAaOKoADYkCwuWigz9kiDcKCmwUVGqjAGhIFBAOHTa5jQLCoejlNorh6y__BQAA__8EVGL-

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUmF9vo0YUxd_7KUb3KVFxYAZwHKSVkt24qrepvbXz0O3KDwSmMTIGd2aIE0X57hX2Vl4gmQshjfBb-PNj5lzOPTf4EeQ_MXgwG14NP12TTMTkl-nkd_Jt-OeXq4vRmFyML66-_jUkR5ej2fXsj6tj8v3W_Hg0_nRNjpabk83xDlvekc-T0ZgsN2QyJsu7kyX5QPLrZDK9HE7Jx6_bozkYkKQhH_srLsH7BhQMYGCADQY4YIALcwPWIg24lKnIb3ncAqPwHjzLgChZZyo_PTcgSAUH7xFUpGIOHlz7NzGfcj_kwrTAgJArP4q3y6xFtPLFw_nyDgyYrf1EeqRn5gtPMuWR83wbN74KFlySNFPr_GR-TmXruHRK8pgHKrqL1INHrBMrX0kqP46JilbcI5aE-ZMBO2Qn4L8N3jyQhS8Xxa2dU5g_zbfPuOXg0SfjdYr7Lyje7BWb9EfNrDOa2Yua98_JklSEXPCw8KR5TmK3PFO4X325-JxGCRcmLVkl5n-ro3N6_EFEt4vtX29VMX7Pg0xFabKvmgEr_56s-CoVD8SP4zTwFQ894lrkt-hjqaj7gtlNTHIZSRUlgTKpW3kLb69HpBtJBPfD71zRJQW9mcylUr1Up4U3dMVg1uuK4b6yGO5bFMNt8t5nqVBcmIyWhf78Pyh93sa2Xk6_IIfWzzqKp7vJeqbd-XxvoPm0Rr4XNHc13-k75zs99HxHTLLP9_4zkfbaPH7rStTLd1a_H1iNDLB7ptP5DGigeVAjAwqau5oB7J0zgB16BiAm2WfA6cFngF2_H-waGeD0TLfzGdBA81mNDCho7moG2O-cAfahZwBikn0GDA4-A5z6_eDUyAC31_kEaKDYxROgZ1LiJyGhJFULLjqfBc47Z4Fz6FmA2GWfBWcHnwXIzxxTLtdpInnZI88-2cqNwcNbvjOaTDMR8C8iDbbL7A4nW2772RVyqXZX2e5glOwu5RusDw_awLTV0rTfhmaWnqYNasaawYM2MG21dKlmDelSzSo0K9PWj7RdgK0ybGthR_-2HC3s6ld2tTBjerrfprn0MNJcehhrLoRGmgtRjTTXaZvm0sNIc-lhrLkQGmkuRDXSXAOtS8_0Jj1r01y01fxAaMTjCI2ZHMMRl2PKsRnSboi0myItx0jLOdJukFD9JKHIKKGtZgmtDJNGdtfTmN31NGp3BMfsjijH7F4ZpI3srqcxu-tp1O4IjtkdUY7ZvTJNi3Y_RexeGSyN7F4ZLI3srqcxu-tp1O4IjtkdUY7ZvTJUG9ldT2N219Oo3REcszuiHPtMqEzV4j_cVG93VpktWrvPn376NwAA__8V1ndX

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMkUFv00AQhe_8itGcAC3UdhIOe3KgQTWEpCSRoFQ-bLyjdtW11-yuo0RR_juyXYkkStIGDnDcmXkz7327RvdTI8fpYDj4MIPKavg4GX-B28H362E_GUF_1B_e_BjAy8tkOpt-Hb6Cx9HX7eDDAr4lsysYTy6TUX-YzG6gPwXBjjTmKTIsjKSRyMkhv8UQU4alNRk5Z2xdWjcDiVwiDxiqoqx8XU4ZZsYS8jV65TUhx5mYa5qQkGQvAmQoyQulm7WlVbmwq_hhgQynpSgchzfIcC58dk8OTOXLynMIkaGvSr1V6iFDR5oyrxbKrzgEb4N6u_NCa_AqJw6Bw3TDsJU8unNe3BHycMOen2BspSqEVn51Ee4G-AujtKSs8soUT5uNzjG7jTv6X3B3_hB351_g7h41-9tjVRgryZLcMZjWyqdGDiS-Eu7-k1EF2YvubuJxnSkOWRyxuMPiLot7LH73vD-LDrGIDrNgmIsl5JQbuwKhtcmEJ8khDAL4rN4fZdU752Mn5EpTONpndnBzUIMieUcteGcqm9G1NVlzpn2OG11TkOR82w3bR1K0rdrgtjg8Ke7uiMN9cXRS3Dl9uXPG5Whf3D0p7u1dTjcvfgUAAP__9mQGGA==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE2P2jwQx-_Pp7DmBJJ58koPPsG2tEKlsAW0fVnl4I1H1CKJU9thQYjvXiVB3QZBm4oDPfpv_zL-eaLZg_meAIPFaDJ6vSSFTsjb-ewDeRx9vp8Mx1MynA4nX76OSOfNeLFcfJx0yfEo36w66y6ZPYzmpNOtqfUmAgqZEjjlKRpgj-ABBR8oBEAhBAp9iCjkWsVojNLlkX0FjMUWmEtBZnlhyziiECuNwPZgpU0QGCz5U4Jz5AK14wIFgZbLpCqTa5lyvRusN0BhkfPMMNJzysKzwjIyKK_xxG38DQ1Rhc3LsMxskScnkcEEYys30u4Ycf93y0rG8iQhVqbIiGsgOlCokeNNjeUrBOYd6AWbF4kiU1qgRtEQiA5nfD_JTKhn1E6_KTt8eNcZeN2fcn47uf4FOdxiXFipshdBClo9G6KRiyPXfAAKKd-SFFOld6QwKBgJXPJe3h13hDTrY-6Su4vv5Tfey2vffe_P3Xf8nhPctP9-ex-_hU_Qc8Kb-gTtfYIWPmGv-q9v5xO29wlb-PR7_8y0OWMzR5OrzODJ1Dn_ZbecRihWWI8uowod471WcVWmXs4qrgoEGlvvevVinFVb1QV_hb3fwq8asHsK-9dUDq6Bw2vg_l_B0eG_HwEAAP__ON5u1A==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkM9L-0AQxe_fv2KY70VhNZvrgtCiEQOxrUnBHyWHbTLUkG027k6KpeR_lyS9KAge5zPvvd03J_QfBhVmURLdrqFzBu7T5SNsopdVMo8XMF_Mk9e3CC7u4mydPSWXcJbWk7A-wPNDlEZQww3IHAU2tqSF3pNHtcEQc4GtswV5b92ATqMgLj9RSYFV03Y84FxgYR2hOiFXbAgVrvXWUEq6JBdIFFgS68qMsa2r9todZ_UBBWatbryCQF4FMviPApcdK5iFKHCruXgnD7bjdoBDDHet-YE8GSq4OlR8VCCv5chYGwNc7UmB9Jj3AifL-bee9Y5Qhb34e6OUfGsbT9_K_JYs-1wglTuaruZt5wpaOVuMz0zjcvSNoCTP0zachriZVn3e__sKAAD__xmzmlc=
