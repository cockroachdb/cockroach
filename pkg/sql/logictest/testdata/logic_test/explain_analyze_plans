# LogicTest: 5node

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcW19v4rgXff99CstPHU2YYAdaijQSnfl1V8xS6JZ2td0RqlLipRGQsI7pn6363VchtKWB2ElKg2_eCI5JzrnXx_f4ikcc_DPBTdw_7hx_P0dzPkG_nPVO0M_jP087R-0uOuoedS7_OkZ7_2_3z_u_dz6h5a3j2y9jA9m3o73x3Zfxp2ja-Bb96LW7aHyHet3FLegrCsfRr2e9i1P07XLx5QAb2PMd1rWnLMDNn5hgA1NsYAsbuIYNXMcDA8-4P2RB4PPwlsfFhLZzj5tVA7vebC7CrwcGHvqc4eYjFq6YMNzE5_b1hJ0x22HcrGIDO0zY7mTxmPFta8bdqc0fsIH7M9sLmqhihg_uzUUTtcLX-O0PJNwpa6JqEF0NfU8wT7i-txwg3nJEzGcTFiDObKeJlnOvH8TLVw30DRv42hbDGxYgfy5m4VPCd1rOfP6K4MGTgaOrCOwzmOsHdGMHN29htML7BwYOhD1iuEmejHzs7MfYuVtnxyTw-aGJ_Lz-js8dxpkT_53P4YNT3bWB6hPGR-yH73qMmySWiRP2t9hrkc-fvnJ3dBN9fKXZaIWcs3s2nK_wuiB8at-jKZv6_AHZk4k_tAVzmqi6YDIcC4Y85BM5bjBevyMH1688Wlny7Gg04mxkC5-bpL4WHgP3IiqXSXXUvbzq9s6vuhedzl6LhFT0L072WjT89L130T1fft7IyYdnUO19GSSnh1bfR0__4uSqHRJkhVdnzHMYXyQRalGzZW2RtFdC6ikImXubKNnIRtev-DOTxvIk72vXE197_81rk_RKSdT7iEkrpgVcKUlefg5S7CQl4Icm8lPgTkLKtpMo8mx1J9kv106SOYMUOwmBvpPQ9JJDU0iyVTFrwCWH5OWnkUKSS8APTeSnQEmmZZNkRZ6tSvJBuSQ5cwYpJJlCl2QrveRYKSS5VjHrwCWH5OXnMIUkl4AfmshPgZJslU2SFXm2KsmNckly5gxSSLIFXZJr6SWnlkKS6xXggkPyslNXC3LFJMj2HESQL24YB84UTWSqQGmulU2aFRm3Ks2H5ZLmzBmkkOYadGlWdEXOWDDzvYDFjsQ3_3I1ZIs5IxaxG_hzPmSn3B8uHhNd9hbzFidJDgtENEqji7b3PBQIWyQfqX_4OqpG0pEeQCMRgMfEnc_H6M52xSoGhwWMu_bE_deOw3ue8iLBQ-beLt5_ZfBZi1_GPgwbsQoBRyTgsm02mcCVOXI0e-QKR0AyCAPVURjkABqJAIBEILb60yDQafUrwIEPD80ensIR0DiC6iqCtwCq8cmWFH5Ns8JhQwbKAZAq6P1HAa5eYnA0e-R0QwA7PDWprMSwxSfXpZPp_ltR2rmubIC_n9NRaZOccgDJdTmQCOSwTZqFIIc30gxBDgOkU_F6kNMbaRMdOYDk4nsXq1n-rgXZoN0EAoINUqwF2C61Ia1GDuUO6TCnQ4KQt3JsEvOkjf1TIMhegmsWAwg2SIEAQAzI2kGvzOwAUz-S5QxYz_BkOQSGiEBiZrSxYyoIxXR6drVIALhNsnYQ_E4_o1OlogAHoMJWIJA4IH0kQAEhexS0kgDF-oFtUcnaYfWbEofU5C6IrB0Hv9MGFU-AHEGOTpF2EJLrVG38mgICBLujggDB78j7M8D9DvjWjQIB8Eobfl9HBSE5QDup2rbexCmecPCtGgUC4JXz1ps7usVHYm30cWdb7-EUHwV5p4YoWjWkzL0aBTgQ_gV-t0YBQeJf9LFg8Ps1tMz9Grrtfg0gcABaOQoEBf2dZ1foYP-fR7W0kmO3i4KO6tDQ-TAh2HZDR6s8y93rKQM6AM041dIC0Iyj8oYOVTR06LYbOlplKPxejwoC7D-XKNBBaAOpIABoxtFStYEGT__7LwAA__-Z01XA

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcW9FyozYUfe9XaPSUTPFiCewkzOxMspt06m1qb5NMp9sdPxBQY8Y2uCDHSTP59w44jo0xuuAdg8RbMMjo3HN9j86V8oKjfyfYwrdX11ef79A8nKBfbga_o-9Xf329vuj10UX_4vrb31fo6LJ3e3f7x_Uxens0vu71P9-ho_Hiw-J4OWz8iL4Men00XqBBH40fP4zRRxTfR4Oby6sb9OlbcjXEGvYDl_XtKYuw9R0TrGGKNWxgDZtYwx081PAsDBwWRUEYP_KSDOi5T9hqa9jzZ3MefzzUsBOEDFsvmHt8wrCF7-z7CbthtstCvY017DJue5PkNePH81noTe3wGWv4dmb7kYVaevziwZxb6Dyexm9_Iu5NmYXa0fLKCXzOfO4F_tsN4r_d4fPZhEUoZLZrobex98_8_aNT9Alr-N7mzohFKJjzWfyWeE5vI1cfETx81fDyagl2Beb-GY3saJSGcR4_P9RwxO0Hhi3yqu0Xne5WdBbZ6OhkMz5UyfjQ3Pisv2fuB6HLQuamvmkYj4Qe2RHkX-1o9CXwfBbqZCsFJ-wffnROjj-G3sMo-SsVXfbEnPlGLJMgT-0nNGXTIHxG9mQSODZnroXaSfTie5ETxjFErheNs0_sEd917IwyuXXpRdzzHa6TToaQPaAdPDHMH0gMEXzargn-GlqnDG-3QchZqNMMaz9LmJHdAqTtoiyBs5O3ftAKZrqxRdpO3AVm3smd-Ulq5qR4nSawium0pRuN0rES8TkpoGOp-DRBx0jFOkYapGNAbq11rKugjpVLDKGOEcl0DOBtpWMZ1uTXMVq82tECamC0dLNRalAiPqcF1CAVnyaoAa1YDWiD1ADIrbUanCioBuUSQ6gGVDI1AHhbqUGGNfnVwChe7YwCamC29E6j1KBEfM4KqEEqPk1QA6NiNTAapAZAbq3V4FRBNSiXGEI1MCRTA4C3lRpkWJNfDczi1c4soAadVqO0oER0OrAWtHSCbN9FBAV8xMJGqYJZsSqYDVIFIMvWqnCmoCqUSwyhKpiSqQLA20oVMqzJrwrAns4Ni2aBH7HtX_XOb27HpDL3gS0zIArmocO-hoGTvGZ5OUjGJT04l0V8eZcuL3r-6lbE7eS7Dx-nNk5qVPG5nuXO1Wd8EYRjtLA9vsm1yyIWevbE-8_eToPVkPdC7zDvMZn_xs1VxX-_dzBspFMJOCIAV07SSiUZaTBz9KQ0uMoRkBI1gG4AqKeAlgZwlgtAhfQSY9sqDIcCd6jCAGQeaTBzW4VBNXB0G1x7E5yRwtbeHmwII2PmVswaV2xlABC1BQ0AV17Q1AFHjSaDU3uFbAorTkdccTrCwd10YLYHd8W1Lv1rb9dskk72NHTSrEbFAPJzWL5gV-Ta6iFiD9cmG4JqlOxQa-fTPV2bNOyIAeS7NmlspxhARdasHnYUt2YAuGqs2aEKw5lwuULa4pUSEfez8s2ZCrwD4ATGTRrrCUFQod8ItEzVNmEQuvIurHoImdZVuoRQoISIm0NdpZddBDDZCrArRqBCfgItqnzfVcvuBJAx1XQL6_o9qN0uJJmuk2ouC0BQfnNMNgQCnyWNU4TSqBo3dbASAKBTe6eLiHvHpAsshjLd4yb5KTE4xTfCIHT50iaPWxRDUN1qAejU3vAimfZ1uvCcAoUn0-RqkgvLNLl-0IVJRbwYXDVZXRNze-yZycaPwNDJsyAFICjQRaRlji6rtugEwFVzpPFQJQAAp_jGGZSX-V5PmuoAQShv6KpnQdzCpkALm2Za2A1ybQA4xV0bhE7thiSATmDopPGkEAS1XRvN9MPThccECo_4mKParo1mWmk1uLaawCmwrQYgUMGaQRmmuLQB6GRrSO6CALTs1DY2YnBq_yMaAE511wbkpdrnHSF0-YZOnsIh7oZToBtOxUc-FTd0wElkBY7qQxAUd23AgWO1t-EgdPlLX3k8qfjQtAEcmjYyDTOVXdvw9af_AwAA__85m2zy

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUUV2P0kAUffdX3NwnNWOWluLDPBVdzFYRViDquunD0LnZbWhn6sx0AyH8d9MPFRBw0fjg45xzz9xz7lmj_Zohx-lgOHg9g9Jk8GYyfg-3g8_Xw340gv6oP7z5MoCnl9F0Nv0wfAbt6PNmcPEAn6LZFYwnl9GoP4xmN9CfgmBHiHmMDJWWNBI5WeS36GHMsDA6IWu1qaB1PRDJJfIOw1QVpavgmGGiDSFfo0tdRshxJuYZTUhIMhcdZCjJiTSrv108hIVJc2FWyHBaCGU5vECG7z6CS3Pi0LHNK9HKkXKpVi3hqZZxZZGRBUNCcug12HzlfkBBB14hw7lwyT1Z0KUrSsehMtJKv0M9jDcMm1cbxTpxR8i9DXt83LGRqRJZ6lYX3m5aWlJSbmWow_2VMf8cY9s9-P9lD90_7KH7r3sIjhr76adU2kgyJHfMxJXydyMH0l0Je_9Wp4rMRbCbblxZDT0W-izssjBgYY-FL5Edjp2LJeSUa7MCkWU6EY4kh6arirOJqQ4DMrWLXycecTT_-NV659Q5IVtoZWn_egd_7lQnI3lHTQVWlyaha6OTek3zHNe6GpBkXcN6zSNSDVUZ3BZ7J8XBjtjbF_snxd3Tm7tnbPb3xcFJcW9vc7x58i0AAP__RA0X_w==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkF9LwzAUxd_9FOE-dRBY42OenFqxsH-u8w-MPIT2WseyZuYmIpR-d2kj6ISJPt5zzzm_5LZArwYkFNk0u1qz4Ay7WS1mbJM9LaeTfM6S67xYF3fTEfu0UNgnu1F07d7Y4222ytizNoQKODS2wrneI4HcgADF4eBsiUTW9VI7GPLqHWTKYdscgu9lxaG0DkG24LfeIEh40CYgjVPgUKHXWzM0puySJSkrX0KzoxGojoMN_quFvK4RZNrxv5Mmde2w1t66sTimFfez5EKcxoj_YFZIB9sQHiFOf0BxwKrGeDSywZW4dLYcMHFcDLlBqJB83Io45E1c9Q_8Hha_hs9_hFV39hEAAP__TsavHw==

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzclV1v2j4Uxu__n8I6VyAZQV74a_JV2cYmNFY6qLqXKhdufNRZJHZmO7RdxXef4gQGtF3TS3rpc_zw-Pcc49yD_ZUBg8V4On53TkqTkQ_z2WdyOf52Nh1NTsnodDT9_mNMOu8ni_PFl2mXNFv56rqz7JLZxXhOOt1atVwlQEFpgac8RwvsEgKgEAKFCCjEQGEICYXC6BSt1abacu8FE3ELbEBBqqJ0VTmhkGqDwO7BSZchMDjnVxnOkQs0_QFQEOi4zLzNcnVSGJlzcwcUFgVXlpFevzKelY6Rk-oYny6IkzkyMrD1KtXKoXJSq6YRqKbjyiJDSwxywUijvbpz29Ib8hYoXHGX_kRLdOmKyqU6U6PclAJI1hTqVUNlHb9GYMGaPkH-F7hU2gg0KPZgk_Uj2XyVSugbNP3hfjCji4-dk6C7DaKKxDs1jIwMtxXreJbtZpTzW5Jjrs0d4VmmU-5QMDLw8FXPpqaKgAhplw93HERR-eAtpuVO4N7lYYxPZRbuZRa0vy3B87elH_b60dHcl7A9e9iCPer146Nhj9qzRy3Y457_zxwHe9yePW7BPuwdDfkz34Y52kIriwcv5eO_PKheUBTXWD-3VpcmxTOjU29TL2de5wsCrau7Qb2YKN_yB9wVB_8U_78nHhyKw5c4exRPBQrdjTZLcsOl2x2fQItG8kz-5ocv7kayHWKKcoXNIDfNzTQ3vZdNdJ8tesVs8StmG74mtmT9358AAAD__yCSjQU=

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkE9r4zAQxe_7KYbZyy6oWL4KCklbl5q6SWqH_gs-KPaQGjuWKsmhIfi7F1uG0EOhx_ebN096c0L70aDALEqi6zV0poHbdPkAm-hllczjBcwX8-T1LYJ_N3G2zh6T_zBZa2-sD_B8F6UR1HAJPEeGrSppIfdkUWwwxJyhNqoga5UZ0Gk0xOUnCs6wanXnBpwzLJQhFCd0lWsIBa7ltqGUZEkm4MiwJCerZoytDzNtqr00R2SYadlaAQG_CHjwFxkuOydgFiLD-ydw1Z4EcDupTjdkwZAsBXDPtkd3RnCFDLfSFe9kQXVOD1mDcdo8o7xn6NX0f-vkjlCEPft9x5SsVq2lb_V-SuZ9zpDKHfk7WtWZglZGFeMzXi7HvRGUZJ2fhl7ErR_1ef_nKwAA__9iwp6v
