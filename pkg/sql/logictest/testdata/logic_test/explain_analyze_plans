# LogicTest: 5node-dist

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT)

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT)

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWG1v4jgY_H6_wvKnVhs2sRP6grQS3b3eiT0KvdJK11uhKm18NAISzgntVlX_-yqBLi8psQ2Gx9tvEJx4nmEYxvOMk_8HuIY7p83TL5dozAfoj4v2Gfp2-s9586TRQietk-b1v6do7_dG57Lzd3MfTZf2Hz72LeQ_9Pb6jx_7-5Pb-g_oa7vRQv1H1G7lS9AnlH2O_rxoX52jz9f5xS62cBQHrOUPWYJr3zDBFqbYwi62sIctXMVdC494fMeSJObZkuf8hkbwHdccC4fRaJxml7sWvos5w7VnnIbpgOEavvRvB-yC-QHjtoMtHLDUDwf5NiMeDn3-VO8_YAt3Rn6U1FDFzjZuj9MaqmcwePyYIM78oIayt0nqDwYoDYeshpwEW_j2KWWvC-gx-oy7LxaOx-kU0AzH7RO695P7RQR1grsv3fyxPYZr5MVab7CDFYM9zgazCehodOVos-fEPGCcBYvPCaMUW7hOPmTbK6x9g7EzxnvsaxxGjNtkSQsD9l-6Vycf9j_xsHc_eTljy6pn1GVr0BJr-bUCdfkzlpdOLhbWDv3vaMiGMX9C44RlXDvor3CZ7RmTropITno9znp-GnObVAtfkIXbExqnijhpXd-02pc3ratmc69OMgI6V2d7dZq9-tK-al1OX4ukU5iJvDWTmoK8DRRkBewuHPoDS6CQObqosxldnauzm0ZGmJu9u2BRwHguJVSndt3VRuKMoKoEQeNIRNHbxLTiSjyy6aKEVgE5WABC5G2MiP3ZphXbNcWhFUY7lHBo2NHoytGAHJps7tCOvEM7Cg7tFKheZc8Chczb88FW7NmRcpbiQJt4s5p21vFmskNvXpfBVcZM5U2DSvihW7E9U_xQYbQjCT-EHY2uHA3ID-k78EOBQub98PDd-KGadtbxQ_oL-6ErbxquhB96Fbtqih8qjHYs4Yewo9GVowH5obu5H3ryfuht6wQvEMm8JR5txRI9mBO8moLWcUV3h664AYmrjNGTdw9PwhirFVNsUWGwqtgWKzZBfhQgguL0nnFTDNKDN0jvHQRGgVbm3fH43QRGNe2sY43eLxwYBZX3BUtGcZQwqarSyYhiQY9NqE7iMb9j5zy-y7eZvG3n9-W1RsCSdPIpnbxpRK8fJamfP3s6eTxO2XT24qjTi0GY9H9eyn_68vsf6d7_1QwTFqU_vw0VRMQ1D5IkS2R3kCgES0RBynQLUi7f_0j3_hszsiRlIyBJsqRVygLdQLBElyE585AWETnLN7ul83i6zaIAvnx_4gBYgwBS1ThI1DyWKARLXukPYQnR8s3V0pvpweLPaAv_CAe7DVcSfJYj0h63FPcHCVcCSBDhSqAbCJYOdxuuNkakPW4p7g8SrgSQIMKVQDcQLB2V_i0cl4erYx3hSus45Yj0xy1VABCxoRwSSLgSQIJgiRQO8WXpag6S-MkqZ_EdDatyPDcCkv40pIwAIvyItANSLRUO5ODxRwAJpG4qh6Q_EikjAKmXBNoBaeEKR_0F5ydeeQgihWM5eAoSQAJpnUSYtP_nqyIACUIiTCBJqLwq2iQJmdcBCSCBJCEDeyERJu3ZSFk7IKyYVwQJIIEkIQPLIREm7dlIWTsgrJS3QURQBxHz-iABJJgkZGBHJMAkm428DX4PBnZCdGudENXSCWk9mgkgQSQhASSQJCTCZCBP-rNREYGWTkivns3rhASQQJKQCJOBPOnPRkUE5Z0QFXRC1LxOSAAJJAmJMIH85xvYEokwbb87o_o6oe7Lbz8CAAD__3DDL-8=

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzkWV1v2kgUfd9fMbpPidbUHn-QYKlSkobV0s1CF_Kw3YoHB88GC7DZmSE0ivLfVzakxLiZGWPXg9S32p6Pc2fOuacnPAH7bw4-jLo33Q-3aEXn6Lfh4E_0pfv3p5vLXh9d9i9vPv_TRSfXvdHt6K-bU7Qdmj73-h9u0cls_W59upk2e0AfB70-mq3RoI9mD-9m6D1Kv6PB8Lo7RFefs6cxGBAnIekHC8LA_wIYDLDBAAcMcMEAD8YGLGkyIYwlNB3ylE3ohV_BtwyI4uWKp6_HBkwSSsB_Ah7xOQEfboO7ORmSICTUtMCAkPAgmmfbLGm0COjjxewBDBgtg5j5qGWmGw9W3EcXKQyarBmiJAh9lD4yHszniEcL4iOLgQF3j5y8DLA76ArGzwYkK74FtMNx94imAZvmEVxgGD-Ps2XvCfj42TissPYbha13hZn4dWl206XZb5a2W2cVJzQklIT5laKYp1srjvvOSf0esOnHJIoJNfEeBebkX35ygU_f0-h-mv0rd0TpZ7R3Ttm7wmFl8_eHbl4WxjKeUBIiFoXER9kYMGARfEULskjoI1oxkh65hf6IrrZfwojNtu-twk3sTtkpQ6DriPEonnATe4Wrk7OjgFeEy616-yL4tiWG71WG75U51lFCOaGmjfdR_XoILHwAC9o5uFi9jWB5fzTtlukcS4csUdqZQofMlaa5Q2JtHRJX6pCWeoe0FDtkutxbiq3QHSXk2XXHtri9WDV3R1ud1LaCXp2W6R6LXkuUdq6g11xpmvVqa9Or_ZPoVUKenV7PmtWro05qR0Gvbsv0jkWvJUrrKOg1V5pmvTra9OpU0qurrldXfwKREGin2XOxZt2aNeuqE9tV0KzXOhbFlijMkyu2ZWIUxCHCKOFTQo9Fu6427bo_iddKaLTTbadZr5VE7yFhyyRmJAfqrZWt9LJJeE82NGLJik7IJ5pMsm02j4NsXpYVQsL45qu9eejFL58YD7K1t5UnK062tRdL_c6tbOipvv953fu_iJWRmH-7jTKIcO1HUh1SWw0Sbg6SbWk4JVyCyvYPoLJ4__O69698Irj2I6kOqa0GqVYqS3hjaTglex-S9RqSk0Nk7U92hJPdvDL3J7vCyZ54Z0842c7zzfoBEmw362YKNylGVLu_ldxfi5tJIOlwMwlvdLjZWbNuVhlR7f5Wcn8tbiaBpMPNJLzR4WbnQlvoiD2lU8bNXpUjt_2Go4_K_0SOLw1JINVvIKUR6PALGXe0xJ-G8091SFoiUdOZqDQCLRHoCDMQFocgLElBuFQMKmUchYyk3zjEkLQYhxiSluQhw1S7lZTmjhbjKMR2_cYhhqTFOMSQ9PwxTYKpdispzR0txlFI83njOJMYRyFB1WYchSB0iHHUa_xiSFqMQwxJj3FIMCkaR5OY6reSIoJCNj_EOOrlsxiSFuMQQ9JjHBJMisbRJKb6raT4q0sh1ed_v8Bi47ALIepg4xg___J_AAAA__8E9vs7

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8UcFu00AQvfMVozkBWhTbcTjsySkNqiEkJYkEpcphkx3SVWyv2V2XRlH-HdkOap0QiyDUgw9-8968t2-2aH8kyHE6GA7ezaAwCbyfjD_B7eDr9bAfj6A_6g9vvg3g5WU8nU0_D1_Bnvq6Jq7v4Us8u4Lx5DIe9Yfx7Ab6UxDsxGAxR4aZljQSKVnkt-jjnGFu9JKs1aaEthUhlg_IPYYqywtXwnOGS20I-Radcgkhx5lYJDQhIcl0PGQoyQmVVGtzo1JhNtH6HhlOc5FZDm-QodE_LRgSkkMPGVonkgScSomDZ5HhYuPoN8EPe3CB8x1DXbjHFNaJFSH3d-zvk46NVJlIlNt0_GbQ9kCnzINzzJ_WFDx3Td1_rKn7P2oKT5o_ehaZNpIMyaahyhzbf-X6M_l_eNuVsHcftMrIdMKmdFw4DpHPooBFXRaFLOqx6C0yTOi7g4OXV9jRPYxa3R1Ra_CIa502JMEqSRwqDjJMxQOklGqzgcKS5BB48FFd7CdS2fUe91pu3Tvn1hOyuc4sNbo4tdkrGyW5ovp2VhdmSddGLyub-ndc6SpAknX11K9_4qwelQGfiv1WcdgQ-4fioFXcbXfunuEcHIrDVnHvwHm-e_ErAAD__6Op6Fw=

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE2P2jwQx-_Pp7DmBJJ58koPPsG2tEKlsAW0fVnl4I1H1CKJU9thQYjvXuVF3Wa1tKk40GP-9i_j32g0RzDfE2Cwmswmr9ek0Al5u1x8IPeTz7ez8XROxvPx7MvXCem9ma7Wq4-zPmmu8t2mt-2Txd1kSXr9mtruIqCQKYFznqIBdg8eUPCBQgAUQqAwhIhCrlWMxihdXjlWwFTsgbkUZJYXtowjCrHSCOwIVtoEgcGaPyS4RC5QOy5QEGi5TKoyuZYp14fRdgcUVjnPDCMDpyy8KCwjo_IZD9zG39AQVdi8DMvMFnnyLDKYYGzlTtoDI-7_blnJWJ4kxMoUGXENRCcKNdK81Fi-QWDeiZ6xeZIoMqUFahRtAZlZiE4vSH-SmVCPqJ1hGxjfveuNvP5PQ7-b4fCMIe4xLqxU2ZMlBa0eDdHIRcO1u0Ah5XuSYqr0gRQGBSOBS97Lm-ZESLNtcpfcnG2a32qa130EvD-PgOMPnOCqQ-B39_E7-AQDJ7yqT9DdJ-jgEw6qub6eT9jdJ-zgMxz8MyvnBZslmlxlBlsi5_7sltsIxQbr_WVUoWO81SquytSfi4qrAoHG1qde_THNqqPqgb_C3m_hVy3YfQ77l1QOLoHDS-DhX8HR6b8fAQAA__8GDnBj

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkM9L-0AQxe_fv2KY70VhNZvrgtCiEQOxrUnBHyWHbTLUkG027k6KpeR_lyS9KAge5zPvvd03J_QfBhVmURLdrqFzBu7T5SNsopdVMo8XMF_Mk9e3CC7u4mydPSWXcJbWk7A-wPNDlEZQww3IHAU2tqSF3pNHtcEQc4GtswV5b92ATqMgLj9RSYFV03Y84FxgYR2hOiFXbAgVrvXWUEq6JBdIFFgS68qMsa2r9todZ_UBBWatbryCQF4FMviPApcdK5iFKHCruXgnD7bjdoBDDHet-YE8GSq4OlR8VCCv5chYGwNc7UmB9Jj3AifL-bee9Y5Qhb34e6OUfGsbT9_K_JYs-1wglTuaruZt5wpaOVuMz0zjcvSNoCTP0zachriZVn3e__sKAAD__xmzmlc=
