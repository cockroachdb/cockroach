# LogicTest: !local-prepared

statement ok
CREATE TABLE jsontab (
  a INT PRIMARY KEY,
  b JSONB
)

statement ok
CREATE INVERTED INDEX inv_idx ON jsontab(b)

query T
SELECT jsonb_path_query('{}', '$')
----
{}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$');

statement error pgcode 2203A JSON object does not contain key "a"
SELECT jsonb_path_query('{}', 'strict $.a')

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a');

query T
SELECT jsonb_path_query('{"a": "b"}', '$')
----
{"a": "b"}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "b"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$');

query T
SELECT jsonb_path_query('{"a": ["b", true, false, null]}', '$')
----
{"a": ["b", true, false, null]}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": ["b", true, false, null]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$');

# WITH a AS (
#     SELECT '{
#         "a": {
#             "aa": {
#                 "aaa": "s1",
#                 "aab": 123,
#                 "aac": true,
#                 "aad": false,
#                 "aae": null,
#                 "aaf": [1, 2, 3],
#                 "aag": {
#                     "aaga": "s2"
#                 }
#             },
#             "ab": "s3"
#         },
#         "b": "s4",
#         "c": [
#             {"ca": "s5"},
#             {"ca": "s6"},
#             1,
#             true,
#         ],
#         "d": 123.45,
#     }'::JSONB AS data
# )

statement ok
CREATE TABLE a AS SELECT '{"a": {"aa": {"aaa": "s1", "aab": 123, "aac": true, "aad": false, "aae": null, "aaf": [1, 2, 3], "aag": {"aaga": "s2"}}, "ab": "s3"}, "b": "s4", "c": [{"ca": "s5"}, {"ca": "s6"}, 1, true], "d": 123.45}'::JSONB AS data

statement ok
CREATE INVERTED INDEX inv_a ON a(data)

query T
SELECT jsonb_path_query(data, '$.a.aa.aaa') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aaa')
----
"s1"

query T
SELECT jsonb_path_query(data, '$.a.aa.aab') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aab')
----
123

query T
SELECT jsonb_path_query(data, '$.a.aa.aac') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aac')
----
true

query T
SELECT jsonb_path_query(data, '$.a.aa.aad') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aad')
----
false

query T
SELECT jsonb_path_query(data, '$.a.aa.aae') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aae')
----
null

query T
SELECT jsonb_path_query(data, '$.a.aa.aaf') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aaf')
----
[1, 2, 3]

query T
SELECT jsonb_path_query(data, '$.a.aa.aag') FROM a@inv_a WHERE jsonb_path_exists(data, '$.a.aa.aag')
----
{"aaga": "s2"}

query T
SELECT jsonb_path_query(data, '$.c') FROM a@inv_a WHERE jsonb_path_exists(data, '$.c')
----
[{"ca": "s5"}, {"ca": "s6"}, 1, true]

query T
SELECT jsonb_path_query(data, '$.d') FROM a@inv_a WHERE jsonb_path_exists(data, '$.d')
----
123.45

query T rowsort
SELECT jsonb_path_query(data, '$.c[*].ca') FROM a@inv_a WHERE jsonb_path_exists(data, '$.c[*].ca')
----
"s5"
"s6"

statement error pq: index "inv_a" is inverted and cannot be used for this query
SELECT jsonb_path_query(data, 'strict $.aa') FROM a@inv_a WHERE jsonb_path_exists(data, 'strict $.aa')

statement error pq: index "inv_a" is inverted and cannot be used for this query
SELECT jsonb_path_query(data, 'strict $.aa.aaa.aaaa') FROM a@inv_a WHERE jsonb_path_exists(data, 'strict $.aa.aaa.aaaa')

query empty
SELECT jsonb_path_query('{}', '$.a')

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a');
----

query empty
SELECT jsonb_path_query('[]', '$.a')

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[]')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a');
----

statement ok
CREATE TABLE b (j JSONB)

statement ok
INSERT INTO b VALUES ('{"a": [1, 2, 3], "b": "hello"}'), ('{"a": false}')

query T rowsort
SELECT jsonb_path_query(j, '$.a') FROM b
----
[1, 2, 3]
false

query T
SELECT jsonb_path_query(j, '$.b') FROM b
----
"hello"

query T rowsort
SELECT jsonb_path_query('{"a": [1, 2, {"b": [4, 5]}, null, [true, false]]}', '$.a[*]')
----
1
2
{"b": [4, 5]}
null
[true, false]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, {"b": [4, 5]}, null, [true, false]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*]');
----
1

query T rowsort
SELECT jsonb_path_query('{"a": [1, 2, {"b": [{"c": true}, {"c": false}]}, null, [true, false], {"b": [{"c": 0.1}, {"d": null}, {"c": 10}]}]}', '$.a[*].b[*].c')
----
true
false
0.1
10

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, {"b": [{"c": true}, {"c": false}]}, null, [true, false], {"b": [{"c": 0.1}, {"d": null}, {"c": 10}]}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*].b[*].c');
----
1

query T
SELECT jsonb_path_query('{"a": [1]}', '$.a', '{}');
----
[1]

statement error pgcode 22023 "vars" argument is not an object
SELECT jsonb_path_query('{"a": [1]}', '$.a', '[]');

query T
SELECT jsonb_path_query('{"a": [1]}', '$.b', '{}', false);
----

query T
SELECT jsonb_path_query('{"a": [1]}', '$.b', '{}', true);
----

statement error pgcode 2203A JSON object does not contain key "b"
SELECT jsonb_path_query('{"a": [1]}', 'strict $.b', '{}', false);

query T
SELECT jsonb_path_query('{"a": [1]}', 'strict $.b', '{}', true);
----

query T rowsort
SELECT jsonb_path_query('{"a": {"b": [1, 2, 3]}}', '$.a[*].b[*]');
----
1
2
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": [1, 2, 3]}}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*].b[*]');
----
1

statement error pgcode 22039 jsonpath wildcard array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": {"b": [1, 2, 3]}}', 'strict $.a[*].b[*]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": [1, 2, 3]}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a[*].b[*]');

query T
SELECT jsonb_path_query('{"a": [1, 2, 3, 4, 5]}', '$.a[0]');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, 3, 4, 5]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[0]');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$[1 to 3, 2, 1 to 3]');
----
2
3
4
3
2
3
4

query empty
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$[3 to 1]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[3 to 1]');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$[4 to 4]');
----
5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[4 to 4]');

query T
SELECT jsonb_path_query('{"a": "hello"}', '$.a[0 to 0]');
----
"hello"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "hello"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[0 to 0]');

query T rowsort
SELECT jsonb_path_query('{"a": [[5, 4], [7, 6], [6, 7], [10], []]}', '$.a[*][0]');
----
5
7
6
10

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*][0]');

statement error pgcode 22033 jsonpath array subscript is out of bounds
SELECT jsonb_path_query('{"a": [[5, 4], [7, 6], [6, 7], [10], []]}', 'strict $.a[*][0]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a[*][0]');

query T rowsort
SELECT jsonb_path_query('{"a": [{}, [5, 4], [7, 6], [6, 7], [10], []]}', '$.a[*][0]');
----
{}
5
7
6
10

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{}, [5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*][0]');

statement error pgcode 22039 jsonpath array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": [{}, [5, 4], [7, 6], [6, 7], [10], []]}', 'strict $.a[*][0]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{}, [5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a[*][0]');

query T rowsort
SELECT jsonb_path_query('{"a": ["hello", [5, 4], [7, 6], [6, 7], [10], []]}', '$.a[*][0]');
----
"hello"
5
7
6
10

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": ["hello", [5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*][0]');

query T rowsort
SELECT jsonb_path_query('{"a": ["hello", [5, 4], [7, 6], [6, 7], [10], []]}', '$.a[*][1]');
----
4
6
7

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": ["hello", [5, 4], [7, 6], [6, 7], [10], []]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*][1]');

statement error pgcode 22039 jsonpath array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": "hello"}', 'strict $.a[1 to 3]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "hello"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a[1 to 3]');

statement error pgcode 22039 jsonpath array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": [1, 2, 3, 4, 5]}', 'strict $[3 to 1]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, 3, 4, 5]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[3 to 1]');

query empty
SELECT jsonb_path_query('{"a": [1, 2, 3]}', '$.a.b');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, 3]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a.b');
----

statement error pgcode 2203A jsonpath member accessor can only be applied to an object
SELECT jsonb_path_query('{"a": [1, 2, 3]}', 'strict $.a.b');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, 3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a.b');

query T
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$[1]');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[1]');

query T
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[0.99]');
----
10

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [10, 9, 8, 7]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[0.99]');

query T
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[1.01]');
----
9

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [10, 9, 8, 7]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[1.01]');

query T
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[$varInt]', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')
----
9

query T
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[$varFloat]', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}');
----
8

statement error pgcode 22033 jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[$varString]', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')

statement error pgcode 22033 jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[$varBool]', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')

statement error pgcode 22033 jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('{"a": [10, 9, 8, 7]}', '$.a[$varNull]', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')

query T
SELECT jsonb_path_query('{"foo": [{"bar": "value"}]}', '$.foo.bar');
----
"value"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"foo": [{"bar": "value"}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.foo.bar');
----
1

query T rowsort
SELECT jsonb_path_query('{"foo": [{"bar": "value"}, {"bar": "value2"}, {"baz": "value3"}]}', '$.foo.bar');
----
"value"
"value2"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"foo": [{"bar": "value"}, {"bar": "value2"}, {"baz": "value3"}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.foo.bar');
----
1

statement error pgcode 2203A jsonpath member accessor can only be applied to an object
SELECT jsonb_path_query('{"foo": [{"bar": "value"}, {"bar": "value2"}]}', 'strict $.foo.bar');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"foo": [{"bar": "value"}, {"bar": "value2"}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.foo.bar');

statement error pgcode 22033 pq: jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('{"a": [1, 2, 3, 4, 5]}', '$.a[$.a]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2, 3, 4, 5]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[$.a]');

query T
SELECT jsonb_path_query('{}', '$"true"', '{"true": "hello"}');
----
"hello"

statement error pgcode 22033 pq: jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('{"a": []}', '$.a[true]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[true]');

statement error pgcode 42704 pq: could not find jsonpath variable "undefined_var"
SELECT jsonb_path_query('[{"a": 1}]', '$undefined_var');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[{"a": 1}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$undefined_var');

query T
SELECT jsonb_path_query('{}', '2')
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2');

query T
SELECT jsonb_path_query('{}'::jsonb, '8.73'::jsonpath);
----
8.73

query T
SELECT jsonb_path_query('{}', 'false')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'false');

query T
SELECT jsonb_path_query('{}', '$varInt', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')
----
1

query T
SELECT jsonb_path_query('{}', '$varFloat', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')
----
2.3

query T
SELECT jsonb_path_query('{}', '$varString', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')
----
"a"

query T
SELECT jsonb_path_query('{}', '$varBool', '{"varInt": 1, "varFloat": 2.3, "varString": "a", "varBool": true, "varNull": null}')
----
true

query T
SELECT jsonb_path_query('{}', '1 < 1');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 < 1');

query T
SELECT jsonb_path_query('{}', '1 <= 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 <= 1');

query T
SELECT jsonb_path_query('{}', '1 > 1');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 > 1');

query T
SELECT jsonb_path_query('{}', '1 >= 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 >= 1');

query T
SELECT jsonb_path_query('{}', '1 != 1');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 != 1');

query T
SELECT jsonb_path_query('{}', '1 == 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 == 1');

query T
SELECT jsonb_path_query('{}', '(true < false)');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(true < false)');

query T
SELECT jsonb_path_query('{}', '((true <= false))');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '((true <= false))');

query T
SELECT jsonb_path_query('{}', '(((true > false)))');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(((true > false)))');

query T
SELECT jsonb_path_query('{}', 'true >= false');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'true >= false');

query T
SELECT jsonb_path_query('{}', 'true != false');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'true != false');

query T
SELECT jsonb_path_query('{}', 'true == false');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'true == false');

query T
SELECT jsonb_path_query('{}', '$ < 1');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ < 1');

query T
SELECT jsonb_path_query('{}', '$ == $');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ == $');

query T
SELECT jsonb_path_query('{}', '1 < 2');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 < 2');

query T
SELECT jsonb_path_query('{}', '1 <= 2');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 <= 2');

query T
SELECT jsonb_path_query('{}', '2 > 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2 > 1');

query T
SELECT jsonb_path_query('{}', '2 >= 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2 >= 1');

query T
SELECT jsonb_path_query('{}', '1 == 2');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 == 2');

query T
SELECT jsonb_path_query('{}', '1 != 2');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 != 2');

query T
SELECT jsonb_path_query('{}', '((1 < 2))');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '((1 < 2))');

query T
SELECT jsonb_path_query('{}', '((2 > 1))');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '((2 > 1))');

query T
SELECT jsonb_path_query('{}', '1.5 > 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1.5 > 1');

query T
SELECT jsonb_path_query('{}', '1.5 < 2');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1.5 < 2');

query T
SELECT jsonb_path_query('{}', '1.5 == 1.5');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1.5 == 1.5');

query T
SELECT jsonb_path_query('{}', '1.5 != 1.5');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1.5 != 1.5');

query T
SELECT jsonb_path_query('{}', '1.0 == 1.0000');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1.0 == 1.0000');

query T
SELECT jsonb_path_query('{}', '$var == $var2', '{"var": 1, "var2": 1}');
----
true

query T
SELECT jsonb_path_query('{}', '$var != $var2', '{"var": 1, "var2": 1}');
----
false

query T
SELECT jsonb_path_query('{}', '$var < $var2', '{"var": 1, "var2": 2}');
----
true

query T
SELECT jsonb_path_query('{}', '$var <= $var2', '{"var": 1, "var2": 2}');
----
true

query T
SELECT jsonb_path_query('{}', '$var > $var2', '{"var": 1, "var2": 2}');
----
false

query T
SELECT jsonb_path_query('{}', '$var >= $var2', '{"var": 1, "var2": 2}');
----
false

query T
SELECT jsonb_path_query('{"a": {"b": 5}}', '$.a.b > 3');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": 5}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a.b > 3');

query T
SELECT jsonb_path_query('{"a": {"b": 5}}', '$.a.b <= 3');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": 5}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a.b <= 3');

query T
SELECT jsonb_path_query('{"arr": [1,2,3,4]}', '$.arr[0] == 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"arr": [1,2,3,4]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.arr[0] == 1');

query T
SELECT jsonb_path_query('{"arr": [1,2,3,4]}', '$.arr[3] >= 4');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"arr": [1,2,3,4]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.arr[3] >= 4');

query T
SELECT jsonb_path_query('{"a": {"b": [10,20,30]}}', '$.a.b[1] < $.a.b[2]');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": [10,20,30]}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a.b[1] < $.a.b[2]');

query T
SELECT jsonb_path_query('{"x": 5, "y": 5}', '$.x == $.y');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"x": 5, "y": 5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.x == $.y');

query T
SELECT jsonb_path_query('{"vals": [{"a": 1}, {"a": 2}]}', '$.vals[0].a != $.vals[1].a');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"vals": [{"a": 1}, {"a": 2}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.vals[0].a != $.vals[1].a');

query T
SELECT jsonb_path_query('{"outer": {"inner": {"val": 100}}}', '$.outer.inner.val >= 100');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"outer": {"inner": {"val": 100}}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.outer.inner.val >= 100');

query T
SELECT jsonb_path_query('{"a": [2, 3]}', '$.a == 2');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [2, 3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 2');

query T
SELECT jsonb_path_query('{"a": [1, 3]}', '$.a == 2');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 2');

query T
SELECT jsonb_path_query('{"a": [2, 3]}', 'strict $.a == 2');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [2, 3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == 2');

query T
SELECT jsonb_path_query('{"a": [1, 3]}', 'strict $.a == 2');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == 2');

query T
SELECT jsonb_path_query('{"a": 5, "b": 10}', '$.a == 5 && $.b == 10');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5, "b": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 5 && $.b == 10');

query T
SELECT jsonb_path_query('{"a": 5, "b": 10}', '$.a == 5 && $.b == 5');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5, "b": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 5 && $.b == 5');

query T
SELECT jsonb_path_query('{"a": 5, "b": 10}', '$.a == 5 || $.b == 5');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5, "b": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 5 || $.b == 5');

query T
SELECT jsonb_path_query('{"a": 5, "b": 10}', '$.a == 1 || $.b == 1');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5, "b": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == 1 || $.b == 1');

query T
SELECT jsonb_path_query('{"a": 5}', '!($.a == 1)');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '!($.a == 1)');

query T
SELECT jsonb_path_query('{"a": 5}', '!($.a == 5)');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '!($.a == 5)');

query T
SELECT jsonb_path_query('{"a": 5, "b": 10}', '(1.5 > 1.2 && (!($.a == 1) || $.b == 1))');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 5, "b": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(1.5 > 1.2 && (!($.a == 1) || $.b == 1))');

query T rowsort
SELECT jsonb_path_query('{"a": [1,2,3]}', '$.a ? (1 == 1)');
----
1
2
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (1 == 1)');

query empty
SELECT jsonb_path_query('{"a": [1,2,3]}', '$.a ? (1 != 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (1 != 1)');

query T
SELECT jsonb_path_query('{"a": [1,2,3]}', 'strict $.a ? (1 == 1)');
----
[1, 2, 3]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a ? (1 == 1)');

# Ensure keyword ("strict") is parsed case-insensitively.
query T
SELECT jsonb_path_query('{"a": [1,2,3]}', 'StriCt $.a ? (1 == 1)');
----
[1, 2, 3]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'StriCt $.a ? (1 == 1)');

query empty
SELECT jsonb_path_query('{"a": [1,2,3]}', 'strict $.a ? (1 != 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a ? (1 != 1)');

query T rowsort
SELECT jsonb_path_query('{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}', '$.a[*] ? (@.b == 1)');
----
{"b": 1, "c": "hello"}
{"b": 1, "c": "!"}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*] ? (@.b == 1)');
----
1

query empty
SELECT jsonb_path_query('{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}', 'strict $.a ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a ? (@.b == 1)');

query T rowsort
SELECT jsonb_path_query('{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}', '$.a ? (@.b == 1)');
----
{"b": 1, "c": "hello"}
{"b": 1, "c": "!"}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b == 1)');
----
1

query T rowsort
SELECT jsonb_path_query('{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}', '$.a ? (@.b == 1)');
----
[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]
[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b == 1)');
----
1

query T rowsort
SELECT jsonb_path_query('{"a": [[[{"b": 1, "c": "aaa"}, {"b": 2, "c": "bbb"}, {"b": 1, "c": "ccc"}], [{"b": 1, "c": "zzz"}, {"b": 2, "c": "xxx"}, {"b": 1, "c": "yyy"}]]]}', '$.a[*] ? (@.b == 1)');
----
[{"b": 1, "c": "aaa"}, {"b": 2, "c": "bbb"}, {"b": 1, "c": "ccc"}]
[{"b": 1, "c": "zzz"}, {"b": 2, "c": "xxx"}, {"b": 1, "c": "yyy"}]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[[{"b": 1, "c": "aaa"}, {"b": 2, "c": "bbb"}, {"b": 1, "c": "ccc"}], [{"b": 1, "c": "zzz"}, {"b": 2, "c": "xxx"}, {"b": 1, "c": "yyy"}]]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a[*] ? (@.b == 1)');
----
1

query empty
SELECT jsonb_path_query('{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}', 'strict $.a ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a ? (@.b == 1)');

query empty
SELECT jsonb_path_query('{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}', 'strict $.a[*] ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}], [{"b": 1, "c": "hello"}, {"b": 2, "c": "world"}, {"b": 1, "c": "!"}]]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a[*] ? (@.b == 1)');

query T rowsort
SELECT jsonb_path_query('{"a": [1,2,3,4,5]}', '$.a ? (@ > 3)');
----
4
5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3,4,5]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@ > 3)');

query T rowsort
SELECT jsonb_path_query('{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}, {"b": 3, "c": 30}]}', '$.a ? (@.c > 15)');
----
{"b": 2, "c": 20}
{"b": 3, "c": 30}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}, {"b": 3, "c": 30}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.c > 15)');

query T rowsort
SELECT jsonb_path_query('{"a": [{"b": "x", "c": true}, {"b": "y", "c": false}, {"b": "z", "c": true}]}', '$.a ? (@.c == true)');
----
{"b": "x", "c": true}
{"b": "z", "c": true}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": "x", "c": true}, {"b": "y", "c": false}, {"b": "z", "c": true}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.c == true)');
----
1

query T
SELECT jsonb_path_query('{"c": {"a": 1, "b":1}}', '$.c ? ($.c.a == @.b)');
----
{"a": 1, "b": 1}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"c": {"a": 1, "b":1}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.c ? ($.c.a == @.b)');

query empty
SELECT jsonb_path_query('{"a": [1,2,3]}', '$.a ? (@ > 10)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1,2,3]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@ > 10)');

query empty
SELECT jsonb_path_query('{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}', '$.a ? (@.c > 100)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.c > 100)');

query empty
SELECT jsonb_path_query('{"a": [[[{"b": 1}], [{"b": 2}]], [[{"b": 2}], [{"b": 1}]]]}', '$.a ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[[{"b": 1}], [{"b": 2}]], [[{"b": 2}], [{"b": 1}]]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b == 1)');
----

query empty
SELECT jsonb_path_query('{"a": [[[[[[{"b": 1}]]]]]]}', '$.a ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[[[[[{"b": 1}]]]]]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b == 1)');
----

query empty
SELECT jsonb_path_query('{"a": [[[{"b": 1}], [{"b": 2}]]]}', '$.a ? (@.b == 1)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [[[{"b": 1}], [{"b": 2}]]]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b == 1)');
----

query T
SELECT jsonb_path_query('{}', '1 + 2');
----
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 + 2');

query T
SELECT jsonb_path_query('{}', '1 - 2');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 - 2');

query T
SELECT jsonb_path_query('{}', '1 * 2');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 * 2');

query T
SELECT jsonb_path_query('{}', '1 / 2');
----
0.50000000000000000000

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 / 2');

query T
SELECT jsonb_path_query('{}', '3 % 2');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '3 % 2');

statement error pgcode 22012 pq: division by zero
SELECT jsonb_path_query('{}', '1 % 0');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 % 0');

query T
SELECT jsonb_path_query('{"a": 4, "b": 5}', '$.a + $.b');
----
9

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 4, "b": 5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a + $.b');

query T
SELECT jsonb_path_query('{"a": 4, "b": 5, "c": [9, 8, 7]}', '$.c[0] + $.c[1]');
----
17

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 4, "b": 5, "c": [9, 8, 7]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.c[0] + $.c[1]');

query T
SELECT jsonb_path_query('{"a": 4, "b": 5, "c": [9, 8, 7]}', '$.c[$.b - $.a]');
----
8

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 4, "b": 5, "c": [9, 8, 7]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.c[$.b - $.a]');

query T
SELECT jsonb_path_query('{"a": 4, "b": 5, "c": [9, 8, 7]}', '$.c[$.b - $.a] + $var', '{"var": 10}');
----
18

statement error pgcode 22012 pq: division by zero
SELECT jsonb_path_query('{}', '1 / 0');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 / 0');

statement error pgcode 22038 pq: left operand of jsonpath operator / is not a single numeric value
SELECT jsonb_path_query('[1, 2]', '$[*] / 2');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] / 2');

statement error pgcode 22038 pq: right operand of jsonpath operator \+ is not a single numeric value
SELECT jsonb_path_query('[1, 2]', '2 + $[*]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2 + $[*]');

statement error pgcode 22038 pq: left operand of jsonpath operator / is not a single numeric value
SELECT jsonb_path_query('{"a": "hello"}', '$.a / 2');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "hello"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a / 2');

statement error pgcode 22038 pq: right operand of jsonpath operator \+ is not a single numeric value
SELECT jsonb_path_query('{"a": null}', '2 + $.a');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": null}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2 + $.a');

query T
SELECT jsonb_path_query('{}', '"a" == "b"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"a" == "b"');

query T
SELECT jsonb_path_query('{}', '"a" < "b"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"a" < "b"');

query T
SELECT jsonb_path_query('{}', '"a" > "b"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"a" > "b"');

statement error pgcode 22038 pq: left operand of jsonpath operator \+ is not a single numeric value
SELECT jsonb_path_query('{}', '"a" + "b"');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"a" + "b"');

query T rowsort
SELECT jsonb_path_query('{"data": [{"val": "a", "num": 1}, {"val": "b", "num": 2}, {"val": "a", "num": 3}]}', '$.data ? (@.val == "a")');
----
{"num": 1, "val": "a"}
{"num": 3, "val": "a"}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"data": [{"val": "a", "num": 1}, {"val": "b", "num": 2}, {"val": "a", "num": 3}]}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.data ? (@.val == "a")');
----
1

query T
SELECT jsonb_path_query('{}', 'null == null');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null == null');

query T
SELECT jsonb_path_query('{}', 'null != null');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null != null');

query T
SELECT jsonb_path_query('{}', 'null != 1');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null != 1');

query T
SELECT jsonb_path_query('{}', 'null <= "null"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null <= "null"');

statement error pgcode 22038 pq: left operand of jsonpath operator \% is not a single numeric value
SELECT jsonb_path_query('{}', 'null % 1');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null % 1');

query T
SELECT jsonb_path_query('{}', 'null like_regex "^he.*$"');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null like_regex "^he.*$"');

query T
SELECT jsonb_path_query('{}', '"hello" like_regex "^he.*$"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"hello" like_regex "^he.*$"');

query T
SELECT jsonb_path_query('{}', '"ahello" like_regex "^he.*$"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"ahello" like_regex "^he.*$"');

query T
SELECT jsonb_path_query('{"a": "e"}', '$.a ? (@ like_regex "^[aeiou]")');
----
"e"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "e"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@ like_regex "^[aeiou]")');

query T
SELECT jsonb_path_query('{"a": {"b": "e"}}', '$.a ? (@.b like_regex "^[aeiou]")');
----
{"b": "e"}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": "e"}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b like_regex "^[aeiou]")');

query empty
SELECT jsonb_path_query('{"a": {"b": "r"}}', '$.a ? (@.b like_regex "^[aeiou]")');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": "r"}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? (@.b like_regex "^[aeiou]")');

query T rowsort
SELECT jsonb_path_query('["apple", "banana", "orange", "umbrella", "grape"]', 'strict $[*] ? (@ like_regex "^[aeiou]")');
----
"apple"
"orange"
"umbrella"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '["apple", "banana", "orange", "umbrella", "grape"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[*] ? (@ like_regex "^[aeiou]")');

query T rowsort
SELECT jsonb_path_query('[{"balance": "987_650", "name": "a"}, {"balance": "987_424", "name": "b"}, {"balance": "100", "name": "c"}]', '$[*] ? (@.balance like_regex "987_.*").balance');
----
"987_650"
"987_424"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[{"balance": "987_650", "name": "a"}, {"balance": "987_424", "name": "b"}, {"balance": "100", "name": "c"}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (@.balance like_regex "987_.*").balance');

query T
SELECT jsonb_path_query('{"ab\\c": "hello"}', '$."ab\\c"');
----
"hello"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"ab\\c": "hello"}')

query I
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$."ab\\c"');
----
1

query empty
SELECT jsonb_path_query('"a\nb"', '$ ? (@ like_regex "^.*$")');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"a\nb"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@ like_regex "^.*$")');

query T
SELECT jsonb_path_query('"\\"', '$ ? (@ like_regex "^\\\\$")');
----
"\\"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"\\"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@ like_regex "^\\\\$")');

query T
SELECT jsonb_path_query('"\\\\"', '$ ? (@ like_regex "^\\\\\\\\$")');
----
"\\\\"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"\\\\"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@ like_regex "^\\\\\\\\$")');

query T
SELECT jsonb_path_query('{"paths": ["C:\\Program Files", "D:\\Data"]}', '$.paths[*] ? (@ like_regex "^[A-Z]:\\\\[A-Za-z]+$")');
----
"D:\\Data"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"paths": ["C:\\Program Files", "D:\\Data"]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.paths[*] ? (@ like_regex "^[A-Z]:\\\\[A-Za-z]+$")');

query T rowsort
SELECT jsonb_path_query('{"paths": ["C:\\Program Files (x86)\\", "D:\\My Documents\\", "E:\\Test!@#$"]}', '$.paths[*] ? (@ like_regex "^[A-Z]:\\\\.*\\\\$")');
----
"C:\\Program Files (x86)\\"
"D:\\My Documents\\"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"paths": ["C:\\Program Files (x86)\\", "D:\\My Documents\\", "E:\\Test!@#$"]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.paths[*] ? (@ like_regex "^[A-Z]:\\\\.*\\\\$")');

query T rowsort
SELECT jsonb_path_query('{"urls": ["http:\/\/example.com", "https:\/\/test.com\/path"]}', '$.urls[*] ? (@ like_regex "^https?:\/\/.*\.com")');
----
"http://example.com"
"https://test.com/path"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"urls": ["http:\/\/example.com", "https:\/\/test.com\/path"]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.urls[*] ? (@ like_regex "^https?:\/\/.*\.com")');

query T rowsort
SELECT jsonb_path_query('{"mixed": ["C:/path\\to/file", "D:\\path/to\\file"]}', '$.mixed[*] ? (@ like_regex "^[A-Z]:[/\\\\].*")');
----
"C:/path\\to/file"
"D:\\path/to\\file"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"mixed": ["C:/path\\to/file", "D:\\path/to\\file"]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.mixed[*] ? (@ like_regex "^[A-Z]:[/\\\\].*")');

query T rowsort
SELECT jsonb_path_query('["a+b", "a*b", "a?b", "a.b", "a[b]", "a{b}"]', '$[*] ? (@ like_regex "^a[\\+\\*\\?\\.]b$|^a\\[b\\]$|^a\\{b\\}$")');
----
"a+b"
"a*b"
"a?b"
"a.b"
"a[b]"
"a{b}"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '["a+b", "a*b", "a?b", "a.b", "a[b]", "a{b}"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (@ like_regex "^a[\\+\\*\\?\\.]b$|^a\\[b\\]$|^a\\{b\\}$")');

query T rowsort
SELECT jsonb_path_query('[null, 1, "abc", "abd", "aBdC", "abdacb", "babc", "adc\nabc", "ab\nadc"]', 'lax $[*] ? (@ like_regex "^ab.*c")');
----
"abc"
"abdacb"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc", "adc\nabc", "ab\nadc"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $[*] ? (@ like_regex "^ab.*c")');

# Ensure keywords ("lax", "like_regex") are parsed case-insensitively.
query T rowsort
SELECT jsonb_path_query('[null, 1, "abc", "abd", "aBdC", "abdacb", "babc", "adc\nabc", "ab\nadc"]', 'LaX $[*] ? (@ like_rEgeX "^ab.*c")');
----
"abc"
"abdacb"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc", "adc\nabc", "ab\nadc"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'LaX $[*] ? (@ like_rEgeX "^ab.*c")');

query T
SELECT jsonb_path_query('"He said \"Hello\\World!\""', '$ ? (@ like_regex ".*\"H.*\\\\.*!.*\".*")');
----
"He said \"Hello\\World!\""

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"He said \"Hello\\World!\""')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@ like_regex ".*\"H.*\\\\.*!.*\".*")');

query T
SELECT jsonb_path_query('["hello", "a"]', '$ like_regex "he"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '["hello", "a"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "he"');

query T
SELECT jsonb_path_query('["hello", "a"]', 'strict $ like_regex "he"');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '["hello", "a"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $ like_regex "he"');

query T rowsort
SELECT jsonb_path_query('{"a": [1, 2], "b": "hello"}', '$.a ? ($.b == "hello") ');
----
1
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2], "b": "hello"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a ? ($.b == "hello") ');

# Test empty array comparisons in lax mode (should return false) - Issue #145099
query T
SELECT jsonb_path_query('{"a": [1], "b": []}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": []}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": {}}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": {}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": {"c": 1}}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": {"c": 1}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

# Test empty array comparisons with different operators in lax mode
query T
SELECT jsonb_path_query('{"a": [], "b": []}', '$.a != $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a != $.b');

query T
SELECT jsonb_path_query('{"a": [1], "b": []}', '$.a != $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a != $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [1]}', '$.a < $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [1]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a < $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [1]}', '$.a <= $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [1]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a <= $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [1]}', '$.a > $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [1]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a > $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [1]}', '$.a >= $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [1]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a >= $.b');

# Test empty array comparisons in strict mode (should return null)
query T
SELECT jsonb_path_query('{"a": [1], "b": []}', 'strict $.a == $.b')
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": []}', 'strict $.a == $.b')
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": {}}', 'strict $.a == $.b')
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": {}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": {"c": 1}}', 'strict $.a == $.b')
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": {"c": 1}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a == $.b');

# Test mixed empty/non-empty arrays
query T
SELECT jsonb_path_query('{"a": [1, 2], "b": []}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [1, 2]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [1, 2]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

# Test empty array vs specific value types
query T
SELECT jsonb_path_query('{"a": [], "b": [null]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [null]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [0]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [0]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [false]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [false]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [], "b": [""]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": [""]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

# Regression tests - ensure existing behavior is preserved
query T
SELECT jsonb_path_query('{"a": [1], "b": [1]}', '$.a == $.b')
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1], "b": [1]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [1], "b": [2]}', '$.a == $.b')
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1], "b": [2]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": "test", "b": "test"}', '$.a == $.b')
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "test", "b": "test"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a == $.b');

query T
SELECT jsonb_path_query('{"a": [1, 2], "b": "hello"}', 'strict $.a ? ($.b == "hello") ');
----
[1, 2]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [1, 2], "b": "hello"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.a ? ($.b == "hello") ');

# Test logical operators with empty arrays
query T
SELECT jsonb_path_query('{"a": [], "b": []}', '$ ? ($.a == $.b || $.a != $.b)')
----

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? ($.a == $.b || $.a != $.b)');

query T
SELECT jsonb_path_query('{"a": [], "b": []}', '$ ? ($.a == $.b && $.a != $.b)')
----

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [], "b": []}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? ($.a == $.b && $.a != $.b)');

query T rowsort
SELECT jsonb_path_query('{"a": "world", "b": 2, "c": true}', '$.*');
----
"world"
2
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": "world", "b": 2, "c": true}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*');

query T rowsort
SELECT jsonb_path_query('{"a": ["hello", "world"], "b": [2, 5], "c": [true, false], "d": "non-array"}', '$.*[1]');
----
"world"
5
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": ["hello", "world"], "b": [2, 5], "c": [true, false], "d": "non-array"}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*[1]');

query T
SELECT jsonb_path_query('{"a": {"ab": 1}, "b": {"bc": 2}, "c": {"cd": 3}}', '$.*.bc');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"ab": 1}, "b": {"bc": 2}, "c": {"cd": 3}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*.bc');

query empty
SELECT jsonb_path_query('{}', '$.*');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*');

query empty
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$.*');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*');

query T rowsort
SELECT jsonb_path_query('{"a": {"x": {"y": 1}}, "b": {"x": {"z": 2}}}', '$.*.x.*');
----
1
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"x": {"y": 1}}, "b": {"x": {"z": 2}}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.*.x.*');

query T
SELECT jsonb_path_query('{}', '-1');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '-1');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3]', '-$[*]');
----
-1
-2
-3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '-$[*]');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3]', '-$');
----
-1
-2
-3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '-$');

query T
SELECT jsonb_path_query('{}', '1 + 2 * -4');
----
-7

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '1 + 2 * -4');

query T
SELECT jsonb_path_query('{"a": -10, "b": -5}', '$.a * -2 + $.b');
----
15

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": -10, "b": -5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a * -2 + $.b');

query T rowsort
SELECT jsonb_path_query('[1, -2, 3, -4]', '$[*] ? (@ < -1)');
----
-2
-4

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, -2, 3, -4]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (@ < -1)');

query T
SELECT jsonb_path_query('{"x": 5, "y": -3}', '(-$.x * 2 + $.y) / -1')
----
13.000000000000000000

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"x": 5, "y": -3}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-$.x * 2 + $.y) / -1');

statement error pgcode 22012 pq: division by zero
SELECT jsonb_path_query('{"x": 5, "y": -3}', '(-$.x * 2 + $.y) / -0')

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"x": 5, "y": -3}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-$.x * 2 + $.y) / -0');

query empty
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', '$[-1]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-1]');

statement error pgcode 22033 pq: jsonpath array subscript is out of bounds
SELECT jsonb_path_query('[1, 2, 3, 4, 5]', 'strict $[-1]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, 5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[-1]');

statement error pgcode 2203B pq: operand of unary jsonpath operator - is not a numeric value
SELECT jsonb_path_query('[1, 2, 3, 4, "hello"]', '-$[*]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4, "hello"]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '-$[*]');

statement error pgcode 2203B pq: operand of unary jsonpath operator \+ is not a numeric value
SELECT jsonb_path_query('null', '+$');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '+$');

query T
SELECT jsonb_path_query('{}', '+1');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '+1');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3]', '+$[*]');
----
1
2
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '+$[*]');

query T
SELECT jsonb_path_query('{}', '+1 + 2 * +4');
----
9

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '+1 + 2 * +4');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3, 4]', '$[*] ? (@ > +2)');
----
3
4

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (@ > +2)');

statement error pgcode 42601 pq: jsonb_path_query\(\): could not parse "last" as type jsonpath: LAST is allowed only in array subscripts
SELECT jsonb_path_query('{}', 'last'::JSONPATH);

statement error pgcode 42601 pq: jsonb_path_query\(\): could not parse "@" as type jsonpath: @ is not allowed in root expressions
SELECT jsonb_path_query('{}', '@'::JSONPATH);

query T
SELECT jsonb_path_query('[1, 2, 3, 4]', '$[last]');
----
4

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[last]');

# Ensure keyword ("last") is parsed case-insensitively.
query T
SELECT jsonb_path_query('[1, 2, 3, 4]', '$[LaSt]');
----
4

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3, 4]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[LaSt]');

query T
SELECT jsonb_path_query('"hello"', '$[last]');
----
"hello"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"hello"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[last]');

query T rowsort
SELECT jsonb_path_query('[1, 2, 3, 4]', '$[1 to last, last to last]');
----
2
3
4
4

query T
SELECT jsonb_path_query('[1, 2, 3]', 'exists($[*])');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'exists($[*])');

query T
SELECT jsonb_path_query('[]', 'exists($[*])');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'exists($[*])');

query T
SELECT jsonb_path_query('[{"items": [{"id": 1}, {"id": 2}]}, {"items": []}]', '$[*] ? (exists(@.items[*].id))');
----
{"items": [{"id": 1}, {"id": 2}]}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[{"items": [{"id": 1}, {"id": 2}]}, {"items": []}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (exists(@.items[*].id))');

query T
SELECT jsonb_path_query('[{"a": 1, "b": 2}, {"a": 1}, {"b": 2}, {}]', '$[*] ? (exists(@.a) && exists(@.b))');
----
{"a": 1, "b": 2}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[{"a": 1, "b": 2}, {"a": 1}, {"b": 2}, {}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? (exists(@.a) && exists(@.b))');

query T
SELECT jsonb_path_query('{}', '(1 + 2 == 3) is unknown');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(1 + 2 == 3) is unknown');

query T
SELECT jsonb_path_query('{}', '($ < 1) is unknown');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($ < 1) is unknown');

query T
SELECT jsonb_path_query('{}', '(null like_regex "^he.*$") is unknown');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(null like_regex "^he.*$") is unknown');

# Ensure keyword ("like_regex") is parsed case-insensitively.
query T
SELECT jsonb_path_query('{}', '(null like_RegEx "^he.*$") is unknown');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(null like_RegEx "^he.*$") is unknown');

query T
SELECT jsonb_path_query('"abcdef"', '$ starts with "abc"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"abcdef"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ starts with "abc"');

query T
SELECT jsonb_path_query('"abc"', '$ starts with "abc"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"abc"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ starts with "abc"');

query T
SELECT jsonb_path_query('"ab"', '$ starts with "abc"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"ab"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ starts with "abc"');

query T
SELECT jsonb_path_query('"abcdef"', '$ starts with $var', '{"var": "abc"}');
----
true

query T
SELECT jsonb_path_query('"abc"', '$ starts with $var', '{"var": "abc"}');
----
true

query T
SELECT jsonb_path_query('"ab"', '$ starts with $var', '{"var": "abc"}');
----
false

query T
SELECT jsonb_path_query('["ab", "abc"]', '$ starts with $var', '{"var": "abc"}');
----
true

query T
SELECT jsonb_path_query('["ab", "a"]', '$ starts with $var', '{"var": "abc"}');
----
false

query T
SELECT jsonb_path_query('["ab", "abc"]', 'strict $ starts with $var', '{"var": "abc"}');
----
null

query T
SELECT jsonb_path_query('["ab", "abc"]', 'strict $ starts with $var', '{"var": 1}');
----
null

query T
SELECT jsonb_path_query('["ab", 1]', 'strict $ starts with $var', '{"var": "abc"}');
----
null

query T
SELECT jsonb_path_query('{}', 'exists(2 + "3")');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'exists(2 + "3")');

query T
SELECT jsonb_path_query('{}', '2 / 0 > 0');
----
null

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '2 / 0 > 0');

query T rowsort
SELECT jsonb_path_query('{"g": [{"x": 2}, {"y": 3}]}', 'lax $.g ? ((exists (@.x + "3")) is unknown)');
----
{"x": 2}
{"y": 3}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"g": [{"x": 2}, {"y": 3}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $.g ? ((exists (@.x + "3")) is unknown)');

query T
SELECT jsonb_path_query('{"g": [{"x": 2}, {"y": 3}]}', 'strict $.g[*] ? ((exists (@.x)) is unknown)');
----
{"y": 3}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"g": [{"x": 2}, {"y": 3}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.g[*] ? ((exists (@.x)) is unknown)');

query T
SELECT jsonb_path_query('{"g": [{"x": 2}, {"y": 3}]}', 'strict $.g ? ((exists (@[*].x)) is unknown)');
----
[{"x": 2}, {"y": 3}]

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"g": [{"x": 2}, {"y": 3}]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.g ? ((exists (@[*].x)) is unknown)');

query T
SELECT jsonb_path_query('[1,2,0,3]', '$[*] ? ((2 / @ > 0) is unknown)');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1,2,0,3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*] ? ((2 / @ > 0) is unknown)');

statement error pgcode 2203A pq: JSON object does not contain key "a"
SELECT jsonb_path_query('{}', 'strict $.a', '{}', false);

query empty
SELECT jsonb_path_query('{}', 'strict $.a', '{}', true);

query empty
SELECT jsonb_path_query('{}', '$.a', '{}', false);

query empty
SELECT jsonb_path_query('{}', '$.a', '{}', true);

query empty
SELECT jsonb_path_query('{}', 'strict 0 / 0', '{}', true);

statement error pgcode 22012 pq: division by zero
SELECT jsonb_path_query('{}', 'strict 0 / 0', '{}', false);

query empty
SELECT jsonb_path_query('{}', '0 / 0', '{}', true);

statement error pgcode 22012 pq: division by zero
SELECT jsonb_path_query('{}', '0 / 0', '{}', false);

query T
SELECT jsonb_path_query('{}', 'strict (0 / 0) < (0 / 0)', '{}', true);
----
null

query T
SELECT jsonb_path_query('{}', 'strict (0 / 0) < (0 / 0)', '{}', false);
----
null

query T
SELECT jsonb_path_query('{}', '(0 / 0) < (0 / 0)', '{}', true);
----
null

query T
SELECT jsonb_path_query('{}', '(0 / 0) < (0 / 0)', '{}', false);
----
null

query empty
SELECT jsonb_path_query('{}', 'strict $[*]', '{}', true);

statement error pgcode 22039 pq: jsonpath wildcard array accessor can only be applied to an array
SELECT jsonb_path_query('{}', 'strict $[*]', '{}', false);

query T
SELECT jsonb_path_query('{}', '$[*]', '{}', true);
----
{}

query T
SELECT jsonb_path_query('{}', '$[*]', '{}', false);
----
{}

query empty
SELECT jsonb_path_query('{"a": 1}', 'strict $[0]', '{}', true);

statement error pgcode 22039 pq: jsonpath array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": 1}', 'strict $[0]', '{}', false);

query T
SELECT jsonb_path_query('{"a": 1}', '$[0]', '{}', true);
----
{"a": 1}

query T
SELECT jsonb_path_query('{"a": 1}', '$[0]', '{}', false);
----
{"a": 1}

query empty
SELECT jsonb_path_query('[1, 2, 3]', 'strict $[3]', '{}', true);

statement error pgcode 22033 pq: jsonpath array subscript is out of bounds
SELECT jsonb_path_query('[1, 2, 3]', 'strict $[3]', '{}', false);

query empty
SELECT jsonb_path_query('[1, 2, 3]', '$[3]', '{}', true);

query empty
SELECT jsonb_path_query('[1, 2, 3]', '$[3]', '{}', false);

query empty
SELECT jsonb_path_query('[1, 2, 3]', 'strict $["a"]', '{}', true);

statement error pgcode 22033 pq: jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('[1, 2, 3]', 'strict $["a"]', '{}', false);

query empty
SELECT jsonb_path_query('[1, 2, 3]', '$["a"]', '{}', true);

statement error pgcode 22033 pq: jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('[1, 2, 3]', '$["a"]', '{}', false);

query empty
SELECT jsonb_path_query('{"a": "hello"}', 'strict $.a[1 to 3]', '{}', true);

statement error pgcode 22039 pq: jsonpath array accessor can only be applied to an array
SELECT jsonb_path_query('{"a": "hello"}', 'strict $.a[1 to 3]', '{}', false);

query empty
SELECT jsonb_path_query('{"a": "hello"}', '$.a[1 to 3]', '{}', true);

query empty
SELECT jsonb_path_query('{"a": "hello"}', '$.a[1 to 3]', '{}', false);

query empty
SELECT jsonb_path_query('"abc"', 'strict $.a', '{}', true);

statement error pgcode 2203A pq: jsonpath member accessor can only be applied to an object
SELECT jsonb_path_query('"abc"', 'strict $.a', '{}', false);

query empty
SELECT jsonb_path_query('"abc"', '$.a', '{}', true);

query empty
SELECT jsonb_path_query('"abc"', '$.a', '{}', false);

query empty
SELECT jsonb_path_query('"abc"', 'strict $.*', '{}', true);

statement error pgcode 2203C pq: jsonpath wildcard member accessor can only be applied to an object
SELECT jsonb_path_query('"abc"', 'strict $.*', '{}', false);

query empty
SELECT jsonb_path_query('"abc"', '$.*', '{}', true);

query empty
SELECT jsonb_path_query('"abc"', '$.*', '{}', false);

query empty
SELECT jsonb_path_query('{}', 'strict -$', '{}', true);

statement error pgcode 2203B pq: operand of unary jsonpath operator - is not a numeric value
SELECT jsonb_path_query('{}', 'strict -$', '{}', false);

query empty
SELECT jsonb_path_query('{}', '-$', '{}', true);

statement error pgcode 2203B pq: operand of unary jsonpath operator - is not a numeric value
SELECT jsonb_path_query('{}', '-$', '{}', false);

query empty
SELECT jsonb_path_query('{}', 'strict $ - 1', '{}', true);

statement error pgcode 22038 pq: left operand of jsonpath operator - is not a single numeric value
SELECT jsonb_path_query('{}', 'strict $ - 1', '{}', false);

query empty
SELECT jsonb_path_query('{}', '$ - 1', '{}', true);

statement error pgcode 22038 pq: left operand of jsonpath operator - is not a single numeric value
SELECT jsonb_path_query('{}', '$ - 1', '{}', false);

query empty
SELECT jsonb_path_query('{}', 'strict 1 - $', '{}', true);

statement error pgcode 22038 pq: right operand of jsonpath operator - is not a single numeric value
SELECT jsonb_path_query('{}', 'strict 1 - $', '{}', false);

query empty
SELECT jsonb_path_query('{}', '1 - $', '{}', true);

statement error pgcode 22038 pq: right operand of jsonpath operator - is not a single numeric value
SELECT jsonb_path_query('{}', '1 - $', '{}', false);

statement error pgcode 42704 pq: could not find jsonpath variable "var"
SELECT jsonb_path_query('{}', 'strict $var', '{}', true);

statement error pgcode 42704 pq: could not find jsonpath variable "var"
SELECT jsonb_path_query('{}', 'strict $var', '{}', false);

statement error pgcode 42704 pq: could not find jsonpath variable "var"
SELECT jsonb_path_query('{}', '$var', '{}', true);

statement error pgcode 42704 pq: could not find jsonpath variable "var"
SELECT jsonb_path_query('{}', '$var', '{}', false);

query T
SELECT jsonb_path_query('[1, 2, 3]', '($[*] > 2) ? (@ == true)');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($[*] > 2) ? (@ == true)');

query T
SELECT jsonb_path_query('[1, 2, 3]', '((($[*] > (2)))) ? ((@ == true))');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '((($[*] > (2)))) ? ((@ == true))');

query T
SELECT jsonb_path_query('{"a": {"b": {"c": 1}}}', '($.a.b).c');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": {"c": 1}}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($.a.b).c');

query T rowsort
SELECT jsonb_path_query('{"a": {"b": {"c": 1, "d": 2}}}', '($.a.b).*');
----
1
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": {"c": 1, "d": 2}}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($.a.b).*');

query T
SELECT jsonb_path_query('{"a": [10, 20, 30]}', '($.a)[1]');
----
20

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": [10, 20, 30]}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($.a)[1]');

query T
SELECT jsonb_path_query('{"a": {"b": [{"c": 1}, {"c": 2}]}}', '($.a.b[1]).c');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": {"b": [{"c": 1}, {"c": 2}]}}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '($.a.b[1]).c');

statement error pgcode 22033 pq: jsonpath array subscript is out of integer range
SELECT jsonb_path_query('[1]', 'lax $[10000000000000000]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $[10000000000000000]');

statement error pgcode 22033 pq: jsonpath array subscript is out of integer range
SELECT jsonb_path_query('[1]', 'lax $[-10000000000000000]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $[-10000000000000000]');

query empty
SELECT jsonb_path_query('[1]', '$[2147483647]');
----

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2147483647]');

statement error pgcode 22033 pq: jsonpath array subscript is out of integer range
SELECT jsonb_path_query('[1]', '$[2147483648]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2147483648]');

query empty
SELECT jsonb_path_query('[1]', '$[-2147483648]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-2147483648]');

statement error pgcode 22033 pq: jsonpath array subscript is out of integer range
SELECT jsonb_path_query('[1]', '$[-2147483649]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-2147483649]');

query T
SELECT jsonb_path_query('[1, 2]', '$.size()');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.size()');

query T
SELECT jsonb_path_query('[]', '$.size()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.size()');

query T
SELECT jsonb_path_query('{}', '$.size()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.size()');

statement error pgcode 22039 pq: jsonpath item method .size\(\) can only be applied to an array
SELECT jsonb_path_query('{}', 'strict $.size()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $.size()');

query T rowsort
SELECT jsonb_path_query('[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]', 'lax $[*].size()');
----
1
1
1
1
0
1
3
1
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $[*].size()');

statement error pgcode 22039 pq: jsonpath item method .size\(\) can only be applied to an array
SELECT jsonb_path_query('[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]', 'strict $[*].size()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[*].size()');

query T rowsort
SELECT jsonb_path_query('[12, {"a": 13}, {"b": 14}, "ccc", true]', '$[2 - 1 to $.size() - 2]');
----
{"a": 13}
{"b": 14}
"ccc"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[12, {"a": 13}, {"b": 14}, "ccc", true]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2 - 1 to $.size() - 2]');

query T
SELECT jsonb_path_query('{}', '$.type()');
----
"object"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('[]', '$.type()');
----
"array"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('"hello"', '$.type()');
----
"string"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"hello"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('0', '$.type()');
----
"number"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '0')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('0.1', '$.type()');
----
"number"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '0.1')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('true', '$.type()');
----
"boolean"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'true')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('false', '$.type()');
----
"boolean"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'false')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('null', '$.type()');
----
"null"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.type()');

query T
SELECT jsonb_path_query('null', '"123".type()');
----
"string"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '"123".type()');

query T
SELECT jsonb_path_query('null', '(123).type()');
----
"number"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(123).type()');

query T
SELECT jsonb_path_query('null', 'true.type()');
----
"boolean"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'true.type()');

query T
SELECT jsonb_path_query('null', 'null.type()');
----
"null"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'null.type()');

query T rowsort
SELECT jsonb_path_query('[null,1,true,"a",[],{}]', '$[*].type()');
----
"null"
"number"
"boolean"
"string"
"array"
"object"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[null,1,true,"a",[],{}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[*].type()');

query T
SELECT jsonb_path_query('[null,1,true,"a",[],{}]', 'lax $.type()');
----
"array"

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[null,1,true,"a",[],{}]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'lax $.type()');

statement error pgcode 22033 pq: jsonpath array subscript is not a single numeric value
SELECT jsonb_path_query('[1,2,3]', '$[last ? (@.type() == "string")]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1,2,3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[last ? (@.type() == "string")]');

query T
SELECT jsonb_path_query('[1,2,3]', '$[last ? (@.type() == "number")]');
----
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1,2,3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[last ? (@.type() == "number")]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[1.1]');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[1.1]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[1.5]');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[1.5]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[1.99999999]');
----
2

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[1.99999999]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[2.1]');
----
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2.1]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[2.5]');
----
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2.5]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[2.99999999]');
----
3

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[2.99999999]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[-0.1]');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-0.1]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[-0.5]');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-0.5]');

query T
SELECT jsonb_path_query('[1, 2, 3]', '$[-0.99999999]');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-0.99999999]');

query empty
SELECT jsonb_path_query('[1, 2, 3]', '$[-1.01]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$[-1.01]');

query T
SELECT jsonb_path_query('[1, 2, 3]', 'strict $[-0.9999999999999]');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[-0.9999999999999]');

statement error pgcode 22033 pq: jsonpath array subscript is out of bounds
SELECT jsonb_path_query('[1, 2, 3]', 'strict $[-1.01]');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, 3]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, 'strict $[-1.01]');

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@.a < $value)');

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)', '{}');

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)', '{"other": 10}');

query T
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)', '{"value": 11}');
----
{"a": 10}

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10, "b": 20}', '$ ? (@.a < $value && @.b > $value)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 10, "b": 20}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@.a < $value && @.b > $value)');

statement error pgcode 42704 pq: could not find jsonpath variable "min"
SELECT jsonb_path_query('{"a": 10, "b": 20}', '$ ? (@.a < $min && @.b > $max)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 10, "b": 20}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? (@.a < $min && @.b > $max)');

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', 'strict $ ? (@.a < $value)', '{}', true);

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', 'strict $ ? (@.a < $value)', '{}', false);

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)', '{}', true);

statement error pgcode 42704 pq: could not find jsonpath variable "value"
SELECT jsonb_path_query('{"a": 10}', '$ ? (@.a < $value)', '{}', false);

statement error pgcode 42704 pq: could not find jsonpath variable "d"
SELECT jsonb_path_query('{}', '$ ? ($d < $a && @.c > $b)');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? ($d < $a && @.c > $b)');

query T
SELECT jsonb_path_query('{"a": 10}', '$ ? ((@.a < 12) || (@.a < $value))');
----
{"a": 10}

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": 10}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ ? ((@.a < 12) || (@.a < $value))');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('{}', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('"a"', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"a"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('true', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'true')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('null', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, 'null')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

query T
SELECT jsonb_path_query('{}', '(1).abs()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(1).abs()');

query T
SELECT jsonb_path_query('{}', '(-1).abs()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-1).abs()');

query T
SELECT jsonb_path_query('{}', '(0.5).abs()');
----
0.5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.5).abs()');

query T
SELECT jsonb_path_query('{}', '(-0.5).abs()');
----
0.5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.5).abs()');

query T rowsort
SELECT jsonb_path_query('[1, -1, 0.5, -0.5]', '$.abs()');
----
1
1
0.5
0.5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, -1, 0.5, -0.5]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

query T
SELECT jsonb_path_query('{}', '(1).ceiling()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(1).ceiling()');

query T
SELECT jsonb_path_query('{}', '(-1).ceiling()');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-1).ceiling()');

query T
SELECT jsonb_path_query('{}', '(0.5).ceiling()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.5).ceiling()');

query T
SELECT jsonb_path_query('{}', '(-0.5).ceiling()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.5).ceiling()');

query T
SELECT jsonb_path_query('{}', '(0.1).ceiling()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.1).ceiling()');

query T
SELECT jsonb_path_query('{}', '(-0.1).ceiling()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.1).ceiling()');

query T
SELECT jsonb_path_query('{}', '(0.9).ceiling()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.9).ceiling()');

query T
SELECT jsonb_path_query('{}', '(-0.9).ceiling()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.9).ceiling()');

query T rowsort
SELECT jsonb_path_query('[1, -1, 0.5, -0.5, 0.1, -0.1, 0.9, -0.9]', '$.ceiling()');
----
1
-1
1
0
1
0
1
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, -1, 0.5, -0.5, 0.1, -0.1, 0.9, -0.9]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.ceiling()');

query T
SELECT jsonb_path_query('{}', '(1).floor()');
----
1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(1).floor()');

query T
SELECT jsonb_path_query('{}', '(-1).floor()');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-1).floor()');

query T
SELECT jsonb_path_query('{}', '(0.5).floor()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.5).floor()');

query T
SELECT jsonb_path_query('{}', '(-0.5).floor()');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.5).floor()');

query T
SELECT jsonb_path_query('{}', '(0.1).floor()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.1).floor()');

query T
SELECT jsonb_path_query('{}', '(-0.1).floor()');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.1).floor()');

query T
SELECT jsonb_path_query('{}', '(0.9).floor()');
----
0

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(0.9).floor()');

query T
SELECT jsonb_path_query('{}', '(-0.9).floor()');
----
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(-0.9).floor()');

query T rowsort
SELECT jsonb_path_query('[1, -1, 0.5, -0.5, 0.1, -0.1, 0.9, -0.9]', '$.floor()');
----
1
-1
0
-1
0
-1
0
-1

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, -1, 0.5, -0.5, 0.1, -0.1, 0.9, -0.9]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.floor()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('[[1, 2]]', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[[1, 2]]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('[1, 2, [3, 4]]', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '[1, 2, [3, 4]]')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

query T
SELECT jsonb_path_query('{"a": -0.5}', '$.a.abs()')
----
0.5

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{"a": -0.5}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.a.abs()');

statement error pgcode 22036 pq: jsonpath item method .abs\(\) can only be applied to a numeric value
SELECT jsonb_path_query('"1"', '$.abs()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"1"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$.abs()');

statement error pgcode 22036 pq: jsonpath item method .floor\(\) can only be applied to a numeric value
SELECT jsonb_path_query('{}', '(null).floor()');

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '{}')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '(null).floor()');

query T
SELECT jsonb_path_query('"Hello"', '$ like_regex "hello" flag "i"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "hello" flag "i"');

query T
SELECT jsonb_path_query('"HELLO"', '$ like_regex "hello" flag "i"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"HELLO"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "hello" flag "i"');

# Use the same pattern but different flags to ensure that ReCache recognizes
# the change of flags.
query T
SELECT jsonb_path_query('"HELLO"', '$ like_regex "hello" flag ""');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"HELLO"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "hello" flag ""');

query T
SELECT jsonb_path_query('"Hello\nWorld"', '$ like_regex "Hello.World" flag "s"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello\nWorld"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "Hello.World" flag "s"');

query T
SELECT jsonb_path_query('"Hello\nWorld"', '$ like_regex "Hello.World" flag ""');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello\nWorld"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "Hello.World" flag ""');

query T
SELECT jsonb_path_query('"Line1\nLine2"', '$ like_regex "^Line2$" flag "m"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nLine2"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^Line2$" flag "m"');

query T
SELECT jsonb_path_query('"Line1\nLine2"', '$ like_regex "^Line2$" flag ""');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nLine2"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^Line2$" flag ""');

query T
SELECT jsonb_path_query('"Hello123World"', '$ like_regex "Hello.*World" flag "q"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello123World"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "Hello.*World" flag "q"');

query T
SELECT jsonb_path_query('"Hello123World"', '$ like_regex "Hello.*World" flag ""');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello123World"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "Hello.*World" flag ""');

# Case insensitive and dot matches newline
query T
SELECT jsonb_path_query('"Hello\nWorld"', '$ like_regex "hello.world" flag "is"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello\nWorld"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "hello.world" flag "is"');

# Case insensitive and multiline
query T
SELECT jsonb_path_query('"Line1\nline2"', '$ like_regex "^LINE2$" flag "im"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nline2"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^LINE2$" flag "im"');

# Case insensitive and literal matching
query T
SELECT jsonb_path_query('"Hello123World"', '$ like_regex "HELLO.*WORLD" flag "iq"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello123World"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "HELLO.*WORLD" flag "iq"');

# Dot matches newline and multiline
query T
SELECT jsonb_path_query('"Line1\nLine2\nLine3"', '$ like_regex "^Line1.Line2.Line3$" flag "ms"');
----
true

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nLine2\nLine3"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^Line1.Line2.Line3$" flag "ms"');

query T
SELECT jsonb_path_query('"Line1\nLine2\nLine3"', '$ like_regex "^Line1.Line2.Line3$" flag "m"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nLine2\nLine3"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^Line1.Line2.Line3$" flag "m"');

# Dot matches newline and literal matching
query T
SELECT jsonb_path_query('"Hello\nWorld"', '$ like_regex "Hello.World" flag "sq"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Hello\nWorld"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "Hello.World" flag "sq"');

# Multiline and literal matching
query T
SELECT jsonb_path_query('"Line1\nLine2"', '$ like_regex "^Line1\nLine2$" flag "mq"');
----
false

statement ok
truncate table jsontab;

statement ok
INSERT INTO jsontab VALUES (1, '"Line1\nLine2"')

statement error pq: index "inv_idx" is inverted and cannot be used for this query
SELECT a from jsontab@inv_idx WHERE jsonb_path_exists(b, '$ like_regex "^Line1\nLine2$" flag "mq"');

# If a key is accidentally a keyword, it won't be normalized.
query T
SELECT jsonb_path_query('{"STRICT": 1}'::JSONB, 'strIct $.STRICT'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"STRICT": 1}'::JSONB, 'lax $.STRICT'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"STRICT": 1}'::JSONB, 'lax $.strict'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"STRICt": 1}'::JSONB, '$.STRICt'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"STRICt": 1}'::JSONB, '$.STRICT'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"strict": 1}'::JSONB, '$.STRICT'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"strict": 1}'::JSONB, 'lax $.STRICT'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"strict": 1}'::JSONB, '$.STRICt'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"strict": 1}'::JSONB, 'lax $.STRICt'::JSONPATH);
----

query T
SELECT jsonb_path_query('{"strict": 1}'::JSONB, '$.strict'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"LIKE_REGEX": 1}'::JSONB, '$.LIKE_REGEX'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"LIKE_REGEx": 1}'::JSONB, '$.LIKE_REGEx'::JSONPATH);
----
1

query T
SELECT jsonb_path_query('{"LIKE_REGEx": 1}'::JSONB, '$.LIKE_REGEX'::JSONPATH);
----
