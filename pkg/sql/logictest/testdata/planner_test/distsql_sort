# LogicTest: 5node-dist

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Ensure sort-all strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY d
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE1v4jAQhu_7K9Bc15Fjx-EjJ65c2BXtrcrBjUc0EsSRbaRWiP9e5UOiQeBEpsfYvPPMM9g-Q6UVbuURLWRvwIAABwIJEBBAIIWcQG10gdZq0_ykC2zUJ2QxgbKqT65ZzgkU2iBkZ3ClOyBk8CrfD7hDqdDQGAgodLI8tJjalEdpvtZKOgkEIspmslIzNtPuAw3kFwL65K6lrZN7hIxdyHT8izYODU2H5LX4-7A8f1j-WlUbhQbVvaJ3etjqSNeUDe0f4ZMBnk0fLvMOl7KI8oDxjjTQj3ceOl4-3Y_7_XhEkwC_kQZ6v0WoXzLdL_H7JREVAX4jDfR-y1A_Md1P-P1ERNMAv5EGer_Vb1z_O-V3aGtdWZx0s-PmbUC1x-4tsfpkCvxvdNFius9_ba5dUGhdt8u6j03VbTUN_gwzb5gPwuw2zP3kEXTiTQt_WDzTd-oNz_3k-TPkhTe89JOXz5BX_v8qHjkm_kN2y84vf74DAAD__2Jyo-o=

# Ensure top-k strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY d limit 10
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE_rmzAYx-97FfJcF4mJsX889VoY3eh2Gx4y89AJrZEkhY3iex_-gc7-2ijWo0m_-Xw_T0NuUGqFB3lBC-lPYECAA4EYCAggkEBGoDI6R2u1aX7SBfbqD6QRgaKsrq5Zzgjk2iCkN3CFOyOk8EP-OuMRpUJDIyCg0Mni3GIqU1yk-btT0kkgEFIWyFIFLNDuNxrIagL66u5HWydPCCmryXT8d20cGpoMyTvxGQh8KS6FC1j0ksRfku4AbRQaVB_Pz-ondQ461BVlD4MYLRIPirDpE2feiVMWUj5j5iMF-pmvFpg5n67K_ao8pPEM1ZECvep6AdV4umrsV41DKmaojhToVTcLqIrpqsKvKkKazFAdKdCrbhd-NJ6QjmgrXVockF6dHDUvCqoTdi-Q1VeT4zej8xbTfX5tc-2CQuu6XdZ97Mtuqyn4f5h5w3wQZo9h7iePoGNvWvjD4p3eiTe88pNX75DX3vDGT968Q976_6to5Jr4L9kjO6s__QsAAP__JU-1Xg==

# Ensure chunk strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY a, c
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lM3OojAUhvdzFeRsv5LSFvyUlVs3zsSZ3YRFh54oCVLS1mQmhnuf8JM4GC0EnSXU1-d9Ds25QqUV7uUZLaQ_gQEBDgQEEIiBQAIZgdroHK3Vpv1JH9ip35BGBIqqvrj2dUYg1wYhvYIrXImQwg_5q8QDSoWGRkBAoZNF2WFqU5yl-bNV0kkgEFIWyEoFLNDuhAayhoC-uNtfWyePCClryHz8d20cGpqMyVv2QbbiAwicpctPQYlVGrCnRP6UeANpo9CgeszJmgfV9jrUNWXjoTyrIEYV2PyZM-_MKQspXzD1iQLD1FdvnDqfr8z9yjykYoHyRIFB-fONymK-svAri5DGC5QnCgzK6zcqx_OVY79yHNJkgfJEgUF585_WyQPiAW2tK4uztkTU7hlUR-x3k9UXk-M3o_MO0z9-7XLdC4XW9aesf9hV_VFb8N8w84b5KMzuw9xPnkALbzr2h-NXeife8MpPXr1C_vSG137y-hXyxv-toolr4r9k9-ys-fI3AAD__2psvpc=
