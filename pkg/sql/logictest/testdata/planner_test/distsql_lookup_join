# LogicTest: 5node-dist

########################
#  LOOKUP JOIN FORCED  #
########################
statement ok
SET experimental_force_lookup_join = true;

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

statement ok
CREATE TABLE distsql_lookup_test_1 (a INT, b INT, c INT, PRIMARY KEY (a, c))

statement ok
CREATE TABLE distsql_lookup_test_2 (d INT, e INT, f INT, PRIMARY KEY (f, e))

# Ensure lookup join is planned.
query T rowsort
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFOwzAMhu88ReWzp7Ud45BTrkNoQxM3VE2hsaZAF4cklUBT3x2lQWJDWhlH__bnfo2PYFnTWh0ogHiGChCW0CA4zy2FwD7FeWilP0CUCMa6Pqa4QWjZE4gjRBM7AgFrnrGb14CgKSrTjWMDAvfxBwpR7QnEYsCTxdX04if10tGWlCY_L8_Wg_PmoPyn1CbE8N7tOua33u0ihbhL_zODSwbVfwzu2dhvgep6gfQUD2NdvLKxBVtRyBRu-igKWaGsUS5Q3qJcory7qFqfqf5xhS0FxzbQVWcohwaB9J7ypQP3vqVHz-34mVxuRm4MNIWYu4tcrGxuJcFTuJqE62m4noTLX3Az3HwFAAD__y5362s=


query T rowsort
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM distsql_lookup_test_1 JOIN distsql_lookup_test_2 ON f = b WHERE a > 1 AND e > 1]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkk9L80AQxu_vp1jm9ApTmj9WZE97EiLSSulNQ4nZoa6mO3F3Ay0l312SCLZCYz3OM_ObPE9mD2BZ07zYkgf5BDEgzCBHqB2X5D27Th6GMr0DGSEYWzehk3OEkh2BPEAwoSKQMOcJ19MEEDSFwlT9WIvATfiGfCg2BDJt8WhxPL54VbxUtKRCk5tGJ-uhdmZbuL3Sxgf_Ua0r5vemXgfyYd3lmSYTOOch_ouHezb2y0J8uYXuZzz0tXhjYwVbKVQnZlbT7s5UgVyniOcmilISsZQym69uxX9nNq9BeKNJsK32V4CwaIIUKkaVoEpRXaOaobo5Gy85iffL7Zbka7aeLjpe1OYIpDc0vA_PjSvp0XHZf2YoFz3XC5p8GLrpUGR2aHUGj-F4FE7G4WQUjn7AefvvMwAA__93f_un


# Ensure lookup join is planned on a multi-node cluster.
query T rowsort
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM data JOIN data AS data2 on data.b = data2.a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElMGOmzAQhu99CjTnQWADSZaTr1tVu9Wqt4qDG4-2tFkPso3UapV3rwiVlkSJQckhR8B_vj_fWPMOlg096TfyUH8HAQgSEApAKAGhggahc7wl79kNR8bAo_kDdY7Q2q4Pw-sGYcuOoH6H0IYdQQ3f9I8dvZA25LIcEAwF3e4OmM61b9r9VUYHDQhpJhJtTSISDj_JQbNH4D58_LQP-pWgFntcjv_Mrf1Pr6L0L8y_-y75xa1N2NaJGgQ896FOlEAlURWoSlQVqhWqNarNxX7yYr-PWr1lZ8iROerU7M_8gydOuctEfnLyPLs4YovloxFROZlIM3nFcGYKTIazustw5HJBMi5IpllxhaCZAhNB67sIKpYLKuKCijQrrxA0U2AiaHMXQeVyQWVcUJlm1RWCZgpMBD3cff-d6fdCvmPradF2y4f9SOaVxmXquXdb-up4e8CMj8-H3OGFIR_Gr2J8eLTjp6HgNCyiYXkUFqdhGSfPoItouoyHy1t6V9HwKk5e3UJeR8ObOHlzC_khPqt85prEL9kpu9l_-hcAAP__P88C-Q==


query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT count(*) FROM data as d1 NATURAL JOIN data as d2]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lVGLGjEUhd_7K4b7tIXI7E1GV-dpSp8srRbXpQ9FltRc7LRuIpkMtCz-96JT2FHWG-sUH5PMyTmT78B9BusMTfQTVZB_BQQBEgQoEJCBgD4sBGy8W1JVOb_7pBGMzS_IbwWUdlOH3fZCwNJ5gvwZQhnWBDnM9bc1zUgb8uktCDAUdLne22x8-aT978LooEFAL8VEW5Ng4sJ38rDYCnB1eLm6CnpFkONWnG__wZX2r3ufdf_o3M96k_xwpU2czZMCRSFFoUSxe4FpHfJk4iydTCX_JdW71crTSgfnUzx6lPfTh8n8cTb9cn_z9qSZOmn24lFb5w15Mgf3L7aROEevdP_w6XE8md8UeDpNdpAGz-8DskRS7KXygkZEArQaMbhiIyKp2giwcyPk-Qwkz0D2UnUBg0iAFoO7KzKIpGozkJ0ZqPMZKJ6B6qXZBQwiAVoMhldkEEnVZqA6M8jOZ5DxDLJe2r-AQSRAi8HoigwiqdoMsv86nV4xm1G1cbaioyn1-s23u-lFZkXNqKtc7Zf02bvl3qZZTve6_YahKjSn2CzGtjnaBWyLkRVLXixZsToQ47FY8bEHvHXGqvu8uM-KI86DLj99x4qHvPOQFY948ahLbIx0LFYyvmUYqRl26hlGipZFzPmmYaRqyHftOPti--ZPAAAA___3cRks


statement ok
CREATE TABLE foo (a int, b int)

statement ok
CREATE TABLE bar (a int PRIMARY KEY, c int)

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM foo NATURAL JOIN bar]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkcFO8zAQhO__U1Rz3qpJ-nPxKdci1KKKG8rBjZfK0Hot25FAVd4dJUaiRTTA0bP7zYzWJzgxvNZHjlCPKEG4QUPwQVqOUcIg56WVeYUqCNb5Lg1yQ2glMNQJyaYDQ2Etc_GLCgTDSdvDuNYTpEufUEx6z1DLns6My2njB7078Ja14bAoLuzhgz3q8FY_iYAwB2HTJTWrS6orXAsv_xJ-K9Z9ZJffZ-90AOFO5KXzs2exbiZuqHBRhur_V_tUF31-uPKWoxcX-VdnLvqGwGbP-SejdKHl-yDtGJOfm5EbBcMx5ekyP1Yuj4aC53A5CVfTcDUJF1_gpv_3HgAA__-qk925


# Ensure lookup join is not planned when no index is available.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM bar NATURAL JOIN foo]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyckjFr8zAQhvfvV3zc1IJCLDtdBAWPTYekhG4lg2JdEoGjMycZWkL-e7E0JDZx0naTTvfco1foCI4MLvQBPagPkCDgCdYCGqYKvSfuyqlpbj5BZQKsa9rQldcCKmIEdYRgQ42gYEETaqYFCDAYtK1j20kAteEM-aB3CGp2EheD5e3B73pT4wq1QZ5mvfHQsD1o_io3mkHABMZ88q8-ed23JYo-Acs2qP-lFGU-Ks9H5Wdn64gNMprh891vuZLgRfv9K1mHPM37AWrchodSPj6z3e3jqpdBlLPRGEUvxp3PsELfkPP4o9-QdRnQ7DC9iaeWK3xjqqImbZeRiwWDPqTTWdrMXTrqLngJy5tw0YPlEM5_AedDuLgJZ4Nrr0__vgMAAP__oYQpog==


statement ok
CREATE TABLE books (title STRING, edition INT, shelf INT, PRIMARY KEY (title, edition))

statement ok
CREATE TABLE authors (name STRING, book STRING)

query T rowsort
SELECT url FROM [EXPLAIN (DISTSQL) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyck8-K2zAQh-99CndOu6DFlv_swbDgQw_dUrIl9FZyUKxposbRGEmGlpB3L7ILid1YSfZoab75fTNGB9AkcSH2aKH8ARwYFLBi0Bqq0Voy_ngoepW_oUwYKN12zh-vGNRkEMoDOOUahBIW9ERtXAADiU6opi87MqDOnSDrxAahfD6ys8Y83Pi7WDe4RCHRxMmoPbRG7YX5U4nObb0vgydg8Na5Mqo4q1KYE-DvFeCXBdZEu__is9n49J74L6T0v_Q0nP6VaNe10S9SOiLtJbzOIqrS6ONLVBUnuVmzbNbsJNRpMhINyum_vl5yYbzPwm79iGjibDxegz_dQ5U-vhi12bqHij_eMEB-z2o_KeuUrl2cj5MD_YtR_ytvYom2JW3xpkeR-O2g3OCwbUudqfGbobqPGT7feq4_kGjdcPs8fLzq4coLnsM8COcjmE_hNAhn4eTsjuR0CudBuAgnF0E4mcCr44e_AQAA___BuKai

query TTTTT colnames
EXPLAIN (VERBOSE) SELECT DISTINCT(authors.name) FROM authors, books AS b1, books AS b2 WHERE b1.title = b2.title AND authors.book = b1.title AND b1.shelf <> b2.shelf
----
tree                      field           description               columns                                                                                                                                           ordering
distinct                  ·               ·                         (name)                                                                                                                                            weak-key(name)
 └── render               ·               ·                         (name)                                                                                                                                            ·
      │                   render 0        test.public.authors.name  ·                                                                                                                                                 ·
      └── join            ·               ·                         (name, book[omitted], rowid[hidden,omitted], title[omitted], edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])  ·
           │              type            inner                     ·                                                                                                                                                 ·
           │              equality        (book) = (title)          ·                                                                                                                                                 ·
           ├── scan       ·               ·                         (name, book, rowid[hidden,omitted])                                                                                                               rowid!=NULL; key(rowid)
           │              table           authors@primary           ·                                                                                                                                                 ·
           │              spans           ALL                       ·                                                                                                                                                 ·
           └── join       ·               ·                         (title, edition[omitted], shelf[omitted], title[omitted], edition[omitted], shelf[omitted])                                                       title=title; title!=NULL
                │         type            inner                     ·                                                                                                                                                 ·
                │         equality        (title) = (title)         ·                                                                                                                                                 ·
                │         mergeJoinOrder  +"(title=title)"          ·                                                                                                                                                 ·
                │         pred            b1.shelf != b2.shelf      ·                                                                                                                                                 ·
                ├── scan  ·               ·                         (title, edition[omitted], shelf)                                                                                                                  title!=NULL; edition!=NULL; key(title,edition); +title
                │         table           books@primary             ·                                                                                                                                                 ·
                │         spans           ALL                       ·                                                                                                                                                 ·
                └── scan  ·               ·                         (title, edition[omitted], shelf)                                                                                                                  title!=NULL; edition!=NULL; key(title,edition); +title
·                         table           books@primary             ·                                                                                                                                                 ·
·                         spans           ALL                       ·                                                                                                                                                 ·



# Cross joins should not be planned as lookup joins.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM books as b1 CROSS JOIN books as b2]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyckbFOwzAQhneeAt18VeOkZfDkkTK0qGJDGdz4VCJSX2Q7EqjKu6PEQ5uIpNDR5_vu_3R3BsuGtvpEHuQ7CEBYQ45QOy7Ie3ZdOTZtzBfIBKG0dRO6co5QsCOQZwhlqAgkbHnB9TIDBENBl1Xf1iJwEy6QD_pIIFctXg0W84Pf9KGiPWlDbpkMxkPtypN23-rA_OkBYQFTieLeRHFvYjqZeAlqLDtDjsx4a7dbftF-1v7jhUtLbpkOrXdNkI9KoEpRZahWqNaonibVs4H6jbvvyddsPf3p8EnnTeZIcQ-eG1fQq-Oij4nPXc_1BUM-xN9VfGxs_OoEr2ExC2cDWIzh9B9wOoazWTgZaeftw08AAAD__xy3JDw=


query T rowsort
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM authors INNER JOIN books ON books.edition = 1 WHERE books.title = authors.book]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkkFr4zAQhe_7K8ScdmFCbGcDRVDwqeBSkhJyKz4o1pCocTRGkiEh-L8X2YUmpXHbo97MN--Nx2ewrGmhDuRBvkAKCHMoERrHFXnPLspDU6GPIBMEY5s2RLlEqNgRyDMEE2oCCQuecDPNAEFTUKbu2zoEbsMH5IPaEshZhxeD0_HBa7WpaUVKk5smV-Ohceag3ClXbdjFvAgTQFi2QYo8xTyDWwHS3wR4ZGPf_dOv_TfM--j-xLxvG_HKxgq2UuTxcxRW0_HB1IFcVMS9SKWUxWJ9J_46s90F4Y0mwbY-_btKj_kM8_-Yz2-ukV2t8c2BVuQbtp5-dKGkKxFIb2n4CTy3rqJnx1VvMzyXPdcLmnwYqrPhUdihFANewukonI3D2SicfILL7s9bAAAA__-13-_0


statement ok
CREATE TABLE players (id DECIMAL PRIMARY KEY, name STRING, team INT)


##########################
#  LOOKUP JOIN DISABLED  #
##########################

statement ok
SET experimental_force_lookup_join = false;


# Simple joins should no longer be planned as lookup joins.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM foo JOIN bar USING(a)]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyckkFr8kAQhu_fr_h4Ty2smE3sJVDIsfagRXorHtbsqIGYCbMbaBH_e0n2oAlG2952Z-eZZ2bYIyq2tDAHckg_oKHwhLVCLZyTcyxtOCTN7SfSSKGo6sa34bVCzkJIj_CFLwkpFjzheppAwZI3RdmlnRS48WfIebMjpLOTuiisbxd-N5uSVmQsyTTqlUctxcHIV7ZlhsIECsvGp_8zrbIYY3L9V7m-Lt8Y6eRjvnjUd9Y0FYslITtc3_2UK02_GLd_5aIimcb9nkva-odMPz5Lsdt3p97OVDYbHSPpjXHnM6zI1Vw5-tFviNoZyO4o7MRxIzm9CeedJlyXHdcFLDkfXmfhMq_CU9vgJaxvwkkP1kM4_gUcD-HkJhwN2l6f_n0HAAD__yTQKaI=


####################################
#  LOOKUP JOIN ON SECONDARY INDEX  #
####################################
statement ok
SET experimental_force_lookup_join = true

# Create a table with a secondary index which stores another column.
statement ok
CREATE TABLE multiples (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b), INDEX bc (b) STORING (c))

# Split into ten parts.
statement ok
ALTER TABLE multiples SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE multiples EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE multiples]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Lookup join on covering secondary index
query TTT colnames
EXPLAIN SELECT t1.a, t2.c FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
tree            field           description
render          ·               ·
 └── join       ·               ·
      │         type            inner
      │         equality        (a) = (b)
      │         mergeJoinOrder  +"(a=b)"
      ├── scan  ·               ·
      │         table           multiples@primary
      │         spans           ALL
      └── scan  ·               ·
·               table           multiples@bc
·               spans           ALL

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.a, t2.c FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lMFq3DAQhu99CjNnGVmydrPxaa8pJSmht-KDYw2pW6_GSDK0hH33snZp7GUjCww-2tLP__GNmDcwpPGxOqGD4jsIYCCBQQ4MFDDYQcmgs1Sjc2QvV8bAg_4NRcagMV3vL79LBjVZhOINfONbhAK-VS8tPmOl0fIMGGj0VdMONZ1tTpX9czz1rW-6Fh0wSLlIKqMTkZD_gRYYPPW-SI4CyjMD6v17k_PVK0Ihziye5jM15h_Mbg7zUs84vhD96rvkJzUmITMA_EdhR_UhjfyQ5h2iN2Q1WtQzgvJ8g_eRUuq4yK5u3u7OZ90ifi5ieS5cpFyumswCz2Qy-w0mI-PtyAg7MuX5KjsLPBM7dxvYyePt5BF28pSrVXYWeCZ2DhvYUfF2VIQdlfLdKjsLPBM79xvvvBs0z-g6Mg6jNlp22YmoX3FcoI56W-NXS_VQM34-Dbnhh0bnx1MxfjyY8egCOA2LYFjOwuI6LMPNC9V5MK3CYbWGexcM78PN-zXNd8HwIdx8WNN8H55VtvBMwo_surs8f_obAAD__9yeB8c=

# Lookup join on non-covering secondary index
# The index join should be subsumed by joinreader, which takes care of the
# primary index lookups.
query TTT colnames
EXPLAIN SELECT t1.a, t2.d FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b
----
tree                  field           description
render                ·               ·
 └── join             ·               ·
      │               type            inner
      │               equality        (a) = (b)
      │               mergeJoinOrder  +"(a=b)"
      ├── scan        ·               ·
      │               table           multiples@primary
      │               spans           ALL
      └── index-join  ·               ·
           ├── scan   ·               ·
           │          table           multiples@bc
           │          spans           ALL
           └── scan   ·               ·
·                     table           multiples@primary

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.a, t2.d FROM multiples t1 JOIN multiples@bc t2 ON t1.a = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy8lEGLnDAUx-_9FPLOkZios7Oe5rql7Jalt-LBNY-trZMnSYSWZb57UUtXh9kYEDxq8uf_4_fCewNNCh-rM1oovoMABhIYpMAgAwY5lAw6QzVaS2a4MgUe1G8oEgaN7no3_C4Z1GQQijdwjWsRCvhWvbT4jJVCwxNgoNBVTTvWdKY5V-bP6dy3rulatMAg5iKqtIpERO4HGmDw1LsiOgkoLwyod-9N1lWvCIW4sHCaz9TofzD5EualXnB8IfrVd9FPanREegT4j8JO-Yc08kOad4hek1FoUC0IyssN3keKqeMiubp5uztddIvwuYj1uXARc7lpMis8s8kcdpiMDLcjA-zImKeb7KzwzOzc7WAnDbeTBthJY55tsrPCM7Nz3MFOFm4nC7CTxTzfZGeFZ2bnfuedd4PmGW1H2mLQRkuGnYjqFacFaqk3NX41VI810-fTmBt_KLRuOhXTx4OejgbAeVh4w3IRFtdh6W9eqU696cwfzrZw597wwd982NJ85w0f_c3HLc33_lklK8_E_8iuu8vLp78BAAD___f_B8w=

############################
#  LEFT OUTER LOOKUP JOIN  #
############################
# Left join against primary index
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.b, t2.a FROM multiples t1 LEFT JOIN multiples t2 ON t1.b = t2.a]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzElcGK2zAQhu99CjFnGVuyk836lMsWsixJCemp-OBGw9atozGSDF2WvHtJXLpOSCWBDzla0s__5RuhvIMmhev6gBbKbyCAgwQOOXAogMMMKg6doT1aS-Z0ZAis1G8oMw6N7np3Wq447MkglO_gGtcilLCrv7e4xVqhSTPgoNDVTXuu6UxzqM3b8tC3rulatMAhSQWrtWKCkfuBBjhseleypYTqyIF699FkXf2KUIojj6d5pkb_hZldwuzeOizZy9PnHdt83T1t2fNmtQZ-E_KF6FffsZ_UaEa6ZEvxj1NwD6r8L-oHYa_JKDSoLvCq440fs6aEulRkVydvd-cX3SJ-aCI8tFQkqZw0tgDPaGzze49NxquTEepkkuaT1AV4Ruoe7q0uj1eXR6jLk7SYpC7AM1K3uLe6Il5dEaGuSNLZJHUBnpG6x3urC_wlbNF2pC1GvaLZ6R1G9YrDo22pN3v8Ymh_rhk-N-fceUGhdcOuGD5Wetg6AY7DwhuWF2FxHZb-5kB17k0X_nAxhXvmDc_9zfMpzQ_e8MLfvJjS_OifVRa4Jv5Ldt1dHT_9CQAA__-_OzPr

# Left join against covering secondary index
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.c, t2.c FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlEFvmzAUx-_7FNY7G4GBpCmnXDopVZVMUXaaOFD81LERP2QbaVWV7z4FphWi1FjikB4B__X_8XvWewNFErfFEQ1kP0AAhxg4JMAhBQ4LyDk0mko0hvT5SB_YyD-QRRwq1bT2_DrnUJJGyN7AVrZGyOBQPNe4x0KiDiPgINEWVd3VNLo6Fvp1fWxrWzU1GuAQhIIVSjLByP5EDRx2rc3YOoH8xIFa-95kbPGCkIkT96d5pEr9g1mMYQ6vDWbs6eHrge2-Hx727HG32QKH53LE90T0u23YL6oUI5WxtfiPKPg6_ZAy_pDyHa5VpCVqlCOy_HTlP7YUUBOK6OLk9e5k1C385yWm5xWKIIxnTWyCZzCx5Q0nFvtbiz2sxUGYzLI2wTOwdndDa4m_tcTDWhKE6SxrEzwDa6sbWkv9raUe1tIgXMyyNsEzsHb_SXbqFco9moaUQa-NGZ13LsoX7Be0oVaX-E1T2dX0j7su172QaGz_VfQPG9V_OgMOw8IZjkdhcRmO3c0T1YkznbrD6RzuhTO8dDcv5zTfOcMrd_NqTvO9e1bRxDVxX7LL7vz05W8AAAD__-cDKL8=

# Verify stats for covering secondary index do not include extra primary index lookups.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT t1.c, t2.c FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzclcGOmzAQhu99CmvORmAg2axPuWylrFZJFaWnigPBoy0tsZFt1I1WefcKqLoQpcY9cMkR49_zjb-R_A5SCdzmJzTAvwEDCjFQSIBCChQWkFGotSrQGKXbLX1gI96ARxRKWTe2Xc4oFEoj8Hewpa0QOBzyY4V7zAXqMAIKAm1eVl2ZWpenXJ_Xp6ayZV2hAQpByEguBWFE2e-ogcKusZysWxStfhmiMRectCcZm1cVseUJOYkMZBcKqrEfJMbmrwicXag_7bMq5R_YxRj2cK6Rk5enzwey-3p42pPn3WYLFI7FiP9FqZ9NTX6oUhIlOVmzvy0wuk4nu2jxBL6Rq139omfH8T87_mi0kUoL1ChGXWaXG3eyVYGqQxZd7bxdOxnVZv6zwaZnI2RBGM86HRO8g-lY3sl0xP6GYg9DcRAmsxqa4B0YergTQ4m_ocTDUBKE6ayGJngHhlZ3Yij1N5R6GEqDcDGroQnegaHHOzE08erv0dRKGvR64aL2jUTxiv2DalSjC_yiVdGV6T93Xa5bEGhs_5f1HxvZ_2oBh2HmDMejMLsOx-7KE6UTZzp1h9P_4e5usbtQOJ4tGmJQ2lZvdn3swnns0s20nIfpwXnsys20mofp0W0-mhg698j6U2WXT78DAAD__9Lq9GI=

# Left join against non-covering secondary index
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.c, t2.d FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlM9r2zAUx-_7K8Q7y9jyjzT1KZcOUkoyQnYaPrjWo_Pm6BlJhpWS_30kHqsdUlngQ3q0rS_fjz9PvDdQJHFTHtBA_gMEcIiBQwIcUuCQQcGh1VShMaRPR_rAWv6BPOJQq7azp9cFh4o0Qv4GtrYNQg778rnBHZYSdRgBB4m2rJtzTavrQ6lfV4eusXXboAEOQShYqSQTjOxP1MBh29mcrRIojhyos-9NxpYvCLk4cn-aR6rVP5hsDLN_bTFnTw9f92z7ff-wY4_b9QY4PFcjviei313LflGtGKmcrcR_RMFX2YeU8YeU73CdIi1RoxyRFccr_7GhgNpQRBcnr3cno27hPy8xPa9QBGE8a2ITPIOJLW44sdjfWuxhLQ7CZJa1CZ6BtbsbWkv8rSUe1pIgTGdZm-AZWFve0Frqby31sJYGYTbL2gTPwNr9J9mpVyh3aFpSBr02ZnTauShfsF_Qhjpd4TdN1bmmf9yec-cXEo3tv4r-Ya36TyfAYVg4w_EoLC7Dsbt5ojpxplN3OJ3DnTnDC3fzYk7znTO8dDcv5zTfu2cVTVwT9yW77C6OX_4GAAD__wNjKMQ=

# Verify stats for non-covering secondary index include primary index lookups.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT t1.c, t2.d FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzslkFvmzAUx-_7FNY7G4GBtKlPuXRSqiqZouw0cSD4qWMjNrKN1qjKd5-AaoUsM96BW46x_ff78X5Pit9AKoGb_IgG-DdgQCEGCglQSIHCAjIKtVYFGqN0e6QPrMUr8IhCKevGtssZhUJpBP4GtrQVAod9fqhwh7lAHUZAQaDNy6orU-vymOvT6thUtqwrNEAhCBnJpSCMKPsdNVDYNpaTVYui1S9DNOaCk_YmY_OqIrY8IieRgexMQTX2g8TY_AWBszP1p31SpXyHXYxh96caOXl-_Lwn26_7xx152q43QOFQjPiflfrZ1OSHKiVRkpMV-_MJjK4Wk1_R4gl8JRen-sW_zr53kFzNjDc9uxX_s1sfTWqk0gI1ilGHsvOVfm5UoOqQRRcnr9dORrWZ_1yx6bkKWRDGs07WBO9gsu5uk8Vjf7uxh904CJNZ7U7wDuze3-zyxN9u4mE3CcJ0VrsTvAO7y5tdnvrbTT3spkG4mNXuBO_A7sPN7tQLaYemVtKg1z961L4JULxg_4AwqtEFftGq6Mr0P7ddrlsQaGy_y_ofa9lvtYDDMHOG41GYXYZjd-WJ0okznbrD6f9wd13sGgqHk0VDDErbas4ur104r71zM93Nw3TvvHbpZlrOw_TgNh9NDJ17ZP2psvOn3wEAAP__unVbXw==

# Left join with ON filter on covering index
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.c, t2.c FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b AND t2.c < 20]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlcFr2zAUxu_7K8Q7bSBjy3baVKdcWkgpyQjeafPBtR6pNkcykgwNJf_7cDxWO7Sywaccbenj-97vE7w3UFrgpjigBf4TGFCIgUICFFKgsICcQm10idZq017pBGvxCjyiIFXduPZ3TqHUBoG_gZOuQuCQFc8V7rAQaMIIKAh0hazONrWRh8IcV4emcrKu0AKFIGSkUIIwot0LGqCwbRwnqwTyEwXduHcn64o9AmcnOj3No5bqX5jFMEx2rJGTp_uHjGx_ZPc78rhdb4DCcznI96T1n6Ymv7VURCtOVi2rtRL4-iArh6aNSn41UZSUJI445-tNtiRfjdy_OGKlQKJVdfz2fy5GV-mno8WfjvY-UaO0EWhQDMbJTx8Mv9GBrkMWXdz82DsZeLPpJbPxkkMWhPGsmkfy9Gq-ubaa4-mo4wmo4yBMZqEeydNDfXttqJPpqJMJqJMgTGehHsnTQ728NtTpdNTpBNRpEC5moR7J00N9d22oR1bgDm2tlcVJWyBq9wiKPXZLx-rGlPjd6PJs031uz7rzD4HWdaes-1ir7qgN2BczrzgeiNmlOPY7j1gnXnXqF6dzci-84hu_880c51uveOl3Xs5xvvN3FY08E_8ju_TOT1_-BgAA__9GQ3j2

# Left join with ON filter on non-covering index
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.c, t2.d FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b AND t2.d < 30]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUlcFr2zAUxu_7K8Q7bSBjy3LaVKdcWkgpyQjZacvBtR6pNkcykgwNJf_7cDxWO7Sywaccbenj-97vE7w30EbiKj-gA_ETGFBIgQIHChlQmMGOQmVNgc4Z21xpBUv5CiKhoHRV--b3jkJhLIJ4A698iSBgmz-XuMFcoo0ToCDR56o821RWHXJ7XBzq0quqRAcUopiRXEvCiPEvaIHCuvaCLDjsThRM7d-dnM_3CIKd6Pg0j0bpf2Fm_TDbY4WCPN0_bMn6x_Z-Qx7XyxVQeC56-Z6M-VNX5LdRmhgtyKJhtdQSXx9U6dEKssjIrzpJeEF4IoRYrrZz8tWq_YsnTkkkRpfHb__nYnQx-3S09NPR3ieqtbESLcreOLvTB8OvTGSqmCUXNz_25j1vNr5kNlxyzKI4nVTzQJ5OzTfXVnM6HnU6AnUaxXwS6oE8HdS314aaj0fNR6DmUZxNQj2Qp4N6fm2os_GosxGosyieTUI9kKeD-u7aUA-swA26ymiHo7ZA0uwRlHtsl44ztS3wuzXF2ab9XJ915x8SnW9PWfux1O1RE7ArZkFx2hOzS3Eadh6w5kF1FhZnU3LPguKbsPPNFOfboHgedp5Pcb4Ld5UMPJPwI7v03p2-_A0AAP__ox95BQ==

# Left join with ON filter and WHERE clause
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT t1.c, t2.d FROM multiples t1 LEFT JOIN multiples@bc t2 ON t1.c = t2.b WHERE t2.d < 30]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlcFvmzAYxe_7K6zvbATG0KY-cWmlVFUyRey0caDwqWMjNrKNtKrK_z4RphWi1ljikiPYT-99v2fZbyBVjbvyiAbEd2BAIQYKHCgkQCGFgkKnVYXGKD1sGQXb-g-IiEIju94OvwsKldII4g1sY1sEAXn53OIByxp1GAGFGm3ZtGebTjfHUr9mx761TdeiAQpByEgpa8KIsj9RA4V9bwXJOBQnCqq3707Gli8Igp2of5pH1ch_YdJ5mPy1Q0Ge7h9ysv-W3x_I4367AwrP1Szfk1K_-478Uo0kSgqSDawemtaiFiRLyY8-inhFeCSE2O7yzf8BGM3ST2eIP53hPXovla5RYz3LXZw-mHKnAtWFLLrY-bE3n3kz_zbZcpshC8J4VZ8LeSZ93lxtn7E_09iDaRyEfBXThTwTprdXy5T7M-UeTHkQJquYLuSZMN1cLdPEn2niwTQJwnQV04U8E6Z3V8t04T06oOmUNOh1U0fDXY_1C44Pg1G9rvCrVtXZZvzcn3XnHzUaO66y8WMrx6Uh4FTMnOJ4JmaX4tjtvGDNnerELU7W5E6d4hu3880a51uneON23qxxvnN3FS0cE_chu_QuTl_-BgAA__98lFAk
