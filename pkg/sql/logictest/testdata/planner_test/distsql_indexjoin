# LogicTest: 5node-dist

statement ok
CREATE TABLE t (k INT PRIMARY KEY, v INT, w INT, INDEX v(v))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split the index into 5 parts, as if numbers were in the range 1 to 100.
statement ok
ALTER INDEX t@v SPLIT AT SELECT (i * 10)::int FROM generate_series(1, 4) AS g(i)

# Relocate the five parts to the five nodes.
statement ok
ALTER INDEX t@v EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i+1], (i * 10)::int FROM generate_series(0, 4) AS g(i)

query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM INDEX t@v]
----
start_key  end_key  replicas  lease_holder
NULL       /10      {1}       1
/10        /20      {2}       2
/20        /30      {3}       3
/30        /40      {4}       4
/40        NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM t WHERE v > 10 AND v < 50]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslD1vgzAQQPf-iupmI_wBScrEmg5JFXWrGCg-RUgJRrapWlX57xU4UiEiDigZ8fn58Zb7hUpJ3ORHNJB8AAMCHAgIIBABgRgyArVWBRqjdHvFAWv5DQklUFZ1Y92xLe0BIYGmUlqiRgkEJNq8PLTz7JQRKJRGSP6vblSg6nB1cZGAauz52YyAsfkeIREn0lOznnrk4ff884A7zCXqkA6eh6_UAoGQsSDk7Wjb2OQ5ZXDNy-Z4X1VZnbXRUFvr8pjrn05-VpKUk1RcFfOBmE8PZqPBnAahmB98w9sLjh8bLKYH89FgQYMwmh98w9sLXjw2OJoeLEaDIxqE8fzgG95e8PKxwdQv3qGpVWVw0nag7XpBuUe3i4xqdIFvWhWdxn1uO647kGism764j3XlRu0P9mHmhbkf5l6YDmB2CQsvHPnN0T3m2Asv_ObFPealF175zatZ5uz09BcAAP__Hzw_2A==

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT * FROM t WHERE v > 10 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslLuOozAUQPv9itVt1wg_IMlS0WaLZBVNN6Jg8FWElGBkm9GMRvz7CBwpMCIOeZR-HB-f5n5BpSRu8iMaSF6BAQEOBAQQiIBADBmBWqsCjVG6u-KAtfyAhBIoq7qxbtuW9oCQgNISNUogINHm5aF_N-V_IGszAoXSCMn59kYFqg5Xo9tZS0A19vRyRsDYfI-QiJYM7Gxgn3j4JX874A5ziTqk48-8pxYIhIwFIe-Oto1NfqeMpBwuqdkt6n-qrE7maGyudXnM9WfvP1tJKi6K-UjM5zezyWZOg1Dc1XxFPWiOn9ss5jfzyWZBgzC6q_mKetC8eG5zNL9ZTDZHNAjju5qvqAfNy-c2U794h6ZWlcFZk4J2owblHt1oMqrRBf7Xqug1brntuX5DorHu9K9brCt31H1wCDMvzP0w98J0BLOfsPDCkd8cPWKOvfDCb148Yl564ZXfvLrJnLW_vgMAAP__1kxCTg==

# Here we care about ordering by v, but v is not otherwise used.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT w FROM t WHERE v > 10 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyslDtvszAUQPfvV3y6a43wA5KUiTUdkirqVjFQfBUhJRjZpmpV8d8rcKRCRR3yGP04Pj7L_YJKSdzkRzSQvAIDAhwICCAQAYEYMgK1VgUao3R3xQFr-QEJJVBWdWPdti3tASEBpSVqlEBAos3LQ_9uyh8gazMChdIIyc_tjQpUHa5Gt7OWgGrs6eWMgLH5HiERLRnY2cA-8fBL_nbAHeYSdUjHn3lPLRAIGQtC3h1tG5v8TxlJOfylZpeon1RZnczR2Fzr8pjrz97vrMJn5SMrnx_MJoM5DUJxVfAZ9SA4vmOwmB_MJ4MFDcLoquAz6kHw4o7B0fxgMRkc0SCMrwo-ox4EL-8YTP3WHZpaVQZnTQfajReUe3TjyKhGF_isVdFr3HLbc_2GRGPd6aNbrCt31H1wCDMvzP0w98J0BLPfsPDCkd8c3WKOvfDCb17cYl564ZXfvLrInLX_vgMAAP__2tc_2g==

# The single join reader should be on node 5, and doesn't need to output v.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT w FROM t WHERE v > 40 AND v < 50 ORDER BY v]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyUkT1rwzAQhvf-ivLOCracZtGUNR2SEroVD6p1BIGjE5JcWoL_e7FUaFyI24738byPOF3g2NBenylCvUBCYINWwAfuKEYOU7ss7cw7VC1gnR_S1G4FOg4EdUGyqSco7HnFvmogYChp2-e1UYCH9A3FpE8EtR7FVbBcDn7Wrz0dSRsKVT2Lx9s2QaB6kKtqM40OQ1L3W4lbXvkf7yNb96WVc60P9qzDR5YX5fqmspkpf7nhkaJnF-lPR6zHVoDMico_RR5CR0-Bu6wp5SFzuWEopjJdl2Lnymh64DUsF-FmGW4W4foH3I53nwEAAP__LtzSZg==
