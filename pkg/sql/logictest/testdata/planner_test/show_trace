# LogicTest: local

# ------------------------------------------------------------------------------
# SELECT queries
# ------------------------------------------------------------------------------

statement ok
CREATE TABLE abc (
  a INT,
  b TEXT,
  c FLOAT,
  PRIMARY KEY (a, b),
  UNIQUE INDEX foo (b),
  INDEX bar (a),
  FAMILY (a, b),
  FAMILY (c)
)

statement ok
SET tracing = on,kv,results; SELECT * FROM abc; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----

statement ok
INSERT INTO abc VALUES (1, 'one', 1.1), (2, 'two', NULL), (3, 'three', NULL)

statement ok
SET tracing = on,kv,results; SELECT * FROM abc; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
output row: [1 'one' 1.1]
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]
fetched: /abc/primary/3/'three' -> NULL
output row: [3 'three' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc LIMIT 2; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
output row: [1 'one' 1.1]
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc OFFSET 2; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL
output row: [3 'three' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc LIMIT 1 OFFSET 1; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc ORDER BY a; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
output row: [1 'one' 1.1]
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]
fetched: /abc/primary/3/'three' -> NULL
output row: [3 'three' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc ORDER BY b DESC; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL
output row: [2 'two' NULL]
output row: [3 'three' NULL]
output row: [1 'one' 1.1]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc ORDER BY b DESC LIMIT 1 OFFSET 1; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/foo/'two' -> /2
fetched: /abc/foo/'three' -> /3
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL
output row: [3 'three' NULL]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc WHERE a = 2; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]

statement ok
SET tracing = on,kv,results; SELECT b FROM abc@foo; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/foo/'one' -> /1
output row: ['one']
fetched: /abc/foo/'three' -> /3
output row: ['three']
fetched: /abc/foo/'two' -> /2
output row: ['two']

statement ok
SET tracing = on,kv,results; SELECT a FROM abc@bar; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/bar/1/'one' -> NULL
output row: [1]
fetched: /abc/bar/2/'two' -> NULL
output row: [2]
fetched: /abc/bar/3/'three' -> NULL
output row: [3]

statement ok
UPDATE abc SET c = NULL WHERE a = 1

statement ok
SET tracing = on,kv,results; SELECT * FROM abc; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
output row: [1 'one' NULL]
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]
fetched: /abc/primary/3/'three' -> NULL
output row: [3 'three' NULL]

statement ok
SET tracing = on,kv,results; SELECT 3; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [3]

statement ok
SET tracing = on,kv,results; VALUES (1, 2, 3), (4, 5, 6); SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [1 2 3]
output row: [4 5 6]

statement ok
SET tracing = on,kv,results; VALUES (1, 2, 3), (4, 5, 6) ORDER BY 1 DESC; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [4 5 6]
output row: [1 2 3]

statement ok
SET tracing = on,kv,results; SELECT * FROM (VALUES (1, 2, 3), (4, 5, 6)) AS a; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [1 2 3]
output row: [4 5 6]

statement ok
SET tracing = on,kv,results; SELECT * FROM (SELECT * FROM abc) AS sub WHERE a % 2 = 0; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]
fetched: /abc/primary/3/'three' -> NULL

statement ok
SET tracing = on,kv,results; SELECT * FROM (SELECT a+a/a-1 FROM abc) AS sub(a) WHERE a > 1 OFFSET 1; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL
output row: [3]

statement ok
SET tracing = on,kv,results; SELECT * FROM (SELECT * FROM abc WHERE a = 2) AS sub; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/2/'two' -> NULL
output row: [2 'two' NULL]

statement ok
SET tracing = on,kv,results; SELECT DISTINCT * FROM (VALUES (1, 2, 3), (4, 5, 6), (1, 2, 3), (1, 2, 4)) AS a; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [1 2 3]
output row: [4 5 6]
output row: [1 2 4]

statement ok
CREATE TABLE ab (a INT, b INT, PRIMARY KEY(a, b))

statement ok
INSERT INTO ab VALUES (1, 4), (1, 5), (2, 1), (2, 2), (2, 6), (3, 9)

statement ok
SET tracing = on,kv,results; SELECT count(*) FROM ab; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/3/9 -> NULL
output row: [6]

# Note: the output from GROUP BY is in random order; the example is constructed so
# those rows are identical.
statement ok
SET tracing = on,kv,results; SELECT sum(b) FROM ab GROUP BY a; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
output row: [9]
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/3/9 -> NULL
output row: [9]
output row: [9]

statement ok
SET tracing = on,kv,results; VALUES (1, 2), (1, 1), (1, 2), (2, 1), (2, 1) UNION VALUES (1, 3), (3, 4), (1, 1); SET tracing = off

query T rowsort
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
output row: [1 2]
output row: [1 1]
output row: [2 1]
output row: [1 3]
output row: [3 4]

statement ok
SET tracing = on,kv,results; SELECT * FROM abc EXCEPT SELECT * FROM abc WHERE b > 'p'; SET tracing = off

query T rowsort
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/foo/'three' -> /3
fetched: /abc/foo/'two' -> /2
fetched: /abc/primary/3/'three' -> NULL
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/1/'one' -> NULL
output row: [1 'one' NULL]
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL

statement ok
SET tracing = on,kv,results; SELECT * FROM ab WHERE a > 1 INTERSECT SELECT * FROM ab WHERE b > 1; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/3/9 -> NULL
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
output row: [2 2]
fetched: /ab/primary/2/6 -> NULL
output row: [2 6]
fetched: /ab/primary/3/9 -> NULL
output row: [3 9]

statement ok
SET tracing = on,kv,results; INSERT INTO ab(a, b) VALUES (42, 51); SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----

statement ok
SET tracing = on,kv,results; INSERT INTO ab(a, b) SELECT a+1, b+1 FROM ab WHERE b > 6; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/3/9 -> NULL
fetched: /ab/primary/42/51 -> NULL

statement ok
SET tracing = on,kv,results; UPDATE ab SET a = a + 1 WHERE b > 6; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/3/9 -> NULL
fetched: /ab/primary/4/10 -> NULL
fetched: /ab/primary/42/51 -> NULL
fetched: /ab/primary/43/52 -> NULL

statement ok
SET tracing = on,kv,results; DELETE FROM ab WHERE b > 6; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /ab/primary/1/4 -> NULL
fetched: /ab/primary/1/5 -> NULL
fetched: /ab/primary/2/1 -> NULL
fetched: /ab/primary/2/2 -> NULL
fetched: /ab/primary/2/6 -> NULL
fetched: /ab/primary/4/9 -> NULL
fetched: /ab/primary/5/10 -> NULL
fetched: /ab/primary/43/51 -> NULL
fetched: /ab/primary/44/52 -> NULL

statement ok
SET tracing = on,kv,results; DELETE FROM ab; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----

statement ok
UPDATE abc SET c = 1.1 WHERE a = 1

statement ok
SET tracing = on,kv,results; SELECT * FROM ab, abc WHERE abc.a+ab.b = abc.a*ab.a; SET tracing = off

query T
SELECT message FROM [SHOW KV TRACE FOR SESSION]
 WHERE message LIKE 'fetched:%' OR message LIKE 'output row%'
----
fetched: /abc/primary/1/'one' -> NULL
fetched: /abc/primary/1/'one'/c -> 1.1
fetched: /abc/primary/2/'two' -> NULL
fetched: /abc/primary/3/'three' -> NULL

# ------------------------------------------------------------------------------
# DDL and CRUD queries
# ------------------------------------------------------------------------------

statement ok
SET tracing = on,kv,results; CREATE DATABASE t; SET tracing = off

# Check the KV trace; we need to remove the eventlog entry and
# internal queries since the timestamp is non-deterministic.
query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  querying next range at /Table/2/1/0/"t"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /System/"desc-idgen"
dist sender send  r1: sending batch 1 Inc to (n1,s1):1
sql txn           CPut /Table/2/1/0/"t"/3/1 -> 55
sql txn           CPut /Table/3/1/55/2/1 -> database:<name:"t" id:55 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > >
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 2 CPut, 1 BeginTxn to (n1,s1):1
sql txn           rows affected: 0
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 1 EndTxn, 7 QueryIntent to (n1,s1):1


# More KV operations.
statement ok
SET tracing = on,kv,results; CREATE TABLE t.kv(k INT PRIMARY KEY, v INT); SET tracing = off

query TT
SELECT operation, regexp_replace(message, 'wall_time:\d+', 'wall_time:...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  querying next range at /Table/2/1/0/"test"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/3/1/52/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/2/1/0/"t"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/3/1/55/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/2/1/55/"kv"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /System/"desc-idgen"
dist sender send  r1: sending batch 1 Inc to (n1,s1):1
sql txn           CPut /Table/2/1/55/"kv"/3/1 -> 56
sql txn           CPut /Table/3/1/56/2/1 -> table:<name:"kv" id:56 parent_id:55 version:1 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:false hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > next_column_id:3 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_ids:1 column_ids:2 default_column_id:2 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"k" column_directions:ASC column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:2 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > next_mutation_id:1 format_version:3 state:PUBLIC view_query:"" drop_time:0 replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:0 >
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 2 CPut, 1 BeginTxn to (n1,s1):1
dist sender send  querying next range at /Table/3/1/55/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           rows affected: 0
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 1 EndTxn, 7 QueryIntent to (n1,s1):1

# We avoid using the full trace output, because that would make the
# ensuing trace especially chatty, as it traces the index backfill at
# the end of the implicit transaction. A chatty trace could be OK in
# tests, however the backfill also incur job table traffic which has a
# timestamp index, and we can't use (non-deterministic) timestamp
# values in expected values.
statement ok
SET tracing = on,kv,results; CREATE UNIQUE INDEX woo ON t.kv(v); SET tracing = off

query TT
SELECT operation,
       regexp_replace(regexp_replace(message, 'mutationJobs:<[^>]*>', 'mutationJobs:<...>'), 'wall_time:\d+', 'wall_time:...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%' AND message NOT LIKE 'querying next range at%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           Put /Table/3/1/56/2/1 -> table:<name:"kv" id:56 parent_id:55 version:2 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:false hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > next_column_id:3 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_ids:1 column_ids:2 default_column_id:2 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"k" column_directions:ASC column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:3 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > mutations:<index:<name:"woo" id:2 unique:true column_names:"v" column_directions:ASC column_ids:2 extra_column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > state:DELETE_ONLY direction:ADD mutation_id:1 rollback:false > next_mutation_id:2 format_version:3 state:PUBLIC view_query:"" mutationJobs:<...> drop_time:0 replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:0 >
dist sender send  r1: sending batch 1 Put to (n1,s1):1
sql txn           rows affected: 0
dist sender send  r1: sending batch 1 EndTxn, 9 QueryIntent to (n1,s1):1

statement ok
SET tracing = on,kv,results; INSERT INTO t.kv(k, v) VALUES (1,2); SET tracing = off

query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           CPut /Table/56/1/1/0 -> /TUPLE/2:2:Int/2
sql txn           InitPut /Table/56/2/2/0 -> /BYTES/0x89
dist sender send  querying next range at /Table/56/1/1/0
dist sender send  r1: sending batch 1 CPut, 1 BeginTxn, 1 EndTxn, 1 InitPut to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 1


statement error duplicate key value
SET tracing = on,kv,results; INSERT INTO t.kv(k, v) VALUES (1,2); SET tracing = off

query TT
set tracing=off;
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           CPut /Table/56/1/1/0 -> /TUPLE/2:2:Int/2
sql txn           InitPut /Table/56/2/2/0 -> /BYTES/0x89
dist sender send  querying next range at /Table/56/1/1/0
dist sender send  r1: sending batch 1 CPut, 1 BeginTxn, 1 EndTxn, 1 InitPut to (n1,s1):1
sql txn           execution failed after 0 rows: duplicate key value (k)=(1) violates unique constraint "primary"
dist sender send  querying next range at /Table/56/1/1/0
dist sender send  r1: sending batch 1 EndTxn to (n1,s1):1

statement error duplicate key value
SET tracing = on,kv,results; INSERT INTO t.kv(k, v) VALUES (2,2); SET tracing = off

query TT
set tracing=off;
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           CPut /Table/56/1/2/0 -> /TUPLE/2:2:Int/2
sql txn           InitPut /Table/56/2/2/0 -> /BYTES/0x8a
dist sender send  querying next range at /Table/56/1/2/0
dist sender send  r1: sending batch 1 CPut, 1 BeginTxn, 1 EndTxn, 1 InitPut to (n1,s1):1
sql txn           execution failed after 0 rows: duplicate key value (v)=(2) violates unique constraint "woo"
dist sender send  querying next range at /Table/56/1/2/0
dist sender send  r1: sending batch 1 EndTxn to (n1,s1):1

statement ok
SET tracing = on,kv,results; UPSERT INTO t.kv(k, v) VALUES (2,3); SET tracing = off

query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           Scan /Table/56/1/{2-3}
dist sender send  querying next range at /Table/56/1/2
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           CPut /Table/56/1/2/0 -> /TUPLE/2:2:Int/3
sql txn           InitPut /Table/56/2/3/0 -> /BYTES/0x8a
dist sender send  querying next range at /Table/56/1/2/0
dist sender send  r1: sending batch 1 CPut, 1 BeginTxn, 1 EndTxn, 1 InitPut to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 1

statement ok
SET tracing = on,kv,results; UPSERT INTO t.kv(k, v) VALUES (1,2); SET tracing = off

query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           Scan /Table/56/1/{1-2}
dist sender send  querying next range at /Table/56/1/1
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           fetched: /kv/primary/1/v -> /2
sql txn           Put /Table/56/1/1/0 -> /TUPLE/2:2:Int/2
dist sender send  querying next range at /Table/56/1/1/0
dist sender send  r1: sending batch 1 Put, 1 BeginTxn, 1 EndTxn to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 1

statement error duplicate key value
SET tracing = on,kv,results; UPSERT INTO t.kv(k, v) VALUES (2,2); SET tracing = off

query TT
set tracing=off;
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           Scan /Table/56/1/{2-3}
dist sender send  querying next range at /Table/56/1/2
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           fetched: /kv/primary/2/v -> /3
sql txn           Put /Table/56/1/2/0 -> /TUPLE/2:2:Int/2
sql txn           Del /Table/56/2/3/0
sql txn           CPut /Table/56/2/2/0 -> /BYTES/0x8a
dist sender send  querying next range at /Table/56/1/2/0
dist sender send  r1: sending batch 1 Put, 1 CPut, 1 Del, 1 BeginTxn, 1 EndTxn to (n1,s1):1
sql txn           execution failed after 0 rows: duplicate key value (v)=(2) violates unique constraint "woo"
dist sender send  querying next range at /Table/56/1/2/0
dist sender send  r1: sending batch 1 EndTxn to (n1,s1):1

statement ok
SET tracing = on,kv,results; CREATE TABLE t.kv2 AS TABLE t.kv; SET tracing = off

query TT
SELECT operation, regexp_replace(regexp_replace(message, 'wall_time:\d+', 'wall_time:...'), '\d\d\d\d\d+', '...PK...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  querying next range at /Table/2/1/0/"test"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/3/1/52/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/2/1/0/"t"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/3/1/55/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/2/1/55/"kv2"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /System/"desc-idgen"
dist sender send  r1: sending batch 1 Inc to (n1,s1):1
sql txn           CPut /Table/2/1/55/"kv2"/3/1 -> 57
sql txn           CPut /Table/3/1/57/2/1 -> table:<name:"kv2" id:57 parent_id:55 version:1 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > columns:<name:"rowid" id:3 type:<semantic_type:INT width:0 precision:0 visible_type:NONE > nullable:false default_expr:"unique_rowid()" hidden:true > next_column_id:4 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_names:"rowid" column_ids:1 column_ids:2 column_ids:3 default_column_id:0 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"rowid" column_directions:ASC column_ids:3 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:2 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > next_mutation_id:1 format_version:3 state:PUBLIC view_query:"" drop_time:0 replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:0 >
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 2 CPut, 1 BeginTxn to (n1,s1):1
dist sender send  querying next range at /Table/3/1/55/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           Scan /Table/56/{1-2}
dist sender send  querying next range at /Table/56/1
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           fetched: /kv/primary/1/v -> /2
sql txn           CPut /Table/57/1/...PK.../0 -> /TUPLE/1:1:Int/1/1:2:Int/2
sql txn           fetched: /kv/primary/2/v -> /3
sql txn           CPut /Table/57/1/...PK.../0 -> /TUPLE/1:1:Int/2/1:2:Int/3
dist sender send  querying next range at /Table/SystemConfigSpan/Start
dist sender send  r1: sending batch 2 CPut, 1 EndTxn, 7 QueryIntent to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 2

statement ok
SET tracing = on,kv,results; UPDATE t.kv2 SET v = v + 2; SET tracing = off

query TT
SELECT operation, regexp_replace(message, '(\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d\.)?\d\d\d\d\d+', '...PK...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  querying next range at /Table/2/1/55/"kv2"/3/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  querying next range at /Table/3/1/57/2/1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 EndTxn, 1 QueryIntent to (n1,s1):1
sql txn           Scan /Table/57/{1-2}
dist sender send  querying next range at /Table/57/1
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           fetched: /kv2/primary/...PK.../k/v -> /1/2
sql txn           Put /Table/57/1/...PK.../0 -> /TUPLE/1:1:Int/1/1:2:Int/4
sql txn           fetched: /kv2/primary/...PK.../k/v -> /2/3
sql txn           Put /Table/57/1/...PK.../0 -> /TUPLE/1:1:Int/2/1:2:Int/5
dist sender send  querying next range at /Table/57/1/...PK.../0
dist sender send  r1: sending batch 2 Put, 1 BeginTxn, 1 EndTxn to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 2

statement ok
SET tracing = on,kv,results; DELETE FROM t.kv2; SET tracing = off

query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           Scan /Table/57/{1-2}
dist sender send  querying next range at /Table/57/1
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           DelRange /Table/57/1 - /Table/57/2
dist sender send  querying next range at /Table/57/1
dist sender send  r1: sending batch 1 DelRng, 1 BeginTxn, 1 EndTxn to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 2

statement ok
SET tracing = on,kv,results; DROP TABLE t.kv2; SET tracing = off

query TT
SELECT operation,
       regexp_replace(regexp_replace(regexp_replace(message, 'drop_job_id:[1-9]\d*', 'drop_job_id:...'), 'wall_time:\d+', 'wall_time:...'), 'drop_time:\d+', 'drop_time:...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%' AND message NOT LIKE 'querying next range at%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           Put /Table/3/1/57/2/1 -> table:<name:"kv2" id:57 parent_id:55 version:2 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > columns:<name:"rowid" id:3 type:<semantic_type:INT width:0 precision:0 visible_type:NONE > nullable:false default_expr:"unique_rowid()" hidden:true > next_column_id:4 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_names:"rowid" column_ids:1 column_ids:2 column_ids:3 default_column_id:0 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"rowid" column_directions:ASC column_ids:3 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:2 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > next_mutation_id:1 format_version:3 state:DROP draining_names:<parent_id:55 name:"kv2" > view_query:"" drop_time:... replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:... >
dist sender send  r1: sending batch 1 Put to (n1,s1):1
sql txn           rows affected: 0
dist sender send  r1: sending batch 1 EndTxn, 10 QueryIntent to (n1,s1):1

statement ok
SET tracing = on,kv,results; DELETE FROM t.kv; SET tracing = off

query TT
SELECT operation, message FROM [SHOW KV TRACE FOR SESSION]
----
sql txn           Scan /Table/56/{1-2}
dist sender send  querying next range at /Table/56/1
dist sender send  r1: sending batch 1 Scan to (n1,s1):1
sql txn           fetched: /kv/primary/1/v -> /2
sql txn           Del /Table/56/2/2/0
sql txn           Del /Table/56/1/1/0
sql txn           fetched: /kv/primary/2/v -> /3
sql txn           Del /Table/56/2/3/0
sql txn           Del /Table/56/1/2/0
dist sender send  querying next range at /Table/56/1/1/0
dist sender send  r1: sending batch 4 Del, 1 BeginTxn, 1 EndTxn to (n1,s1):1
sql txn           fast path completed
sql txn           rows affected: 2

statement ok
SET tracing = on,kv,results; DROP INDEX t.kv@woo CASCADE; SET tracing = off

query TT
SELECT operation,
       regexp_replace(regexp_replace(message, 'mutationJobs:<[^>]*>', 'mutationJobs:<...>'), 'wall_time:\d+', 'wall_time:...') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%' AND message NOT LIKE 'querying next range at%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           Put /Table/3/1/56/2/1 -> table:<name:"kv" id:56 parent_id:55 version:5 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:false hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > next_column_id:3 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_ids:1 column_ids:2 default_column_id:2 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"k" column_directions:ASC column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:3 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > mutations:<index:<name:"woo" id:2 unique:true column_names:"v" column_directions:ASC column_ids:2 extra_column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > state:DELETE_AND_WRITE_ONLY direction:DROP mutation_id:2 rollback:false > next_mutation_id:3 format_version:3 state:PUBLIC view_query:"" mutationJobs:<...> drop_time:0 replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:0 >
dist sender send  r1: sending batch 1 Put to (n1,s1):1
sql txn           rows affected: 0
dist sender send  r1: sending batch 1 EndTxn, 9 QueryIntent to (n1,s1):1

statement ok
SET tracing = on,kv,results; DROP TABLE t.kv; SET tracing = off

query TT
SELECT operation, regexp_replace(regexp_replace(regexp_replace(message, 'job_id:[1-9]\d*', 'job_id:...', 'g'), 'wall_time:\d+', 'wall_time:...'), 'drop_time:\d+', 'drop_time:...', 'g') as message
  FROM [SHOW KV TRACE FOR SESSION]
WHERE message NOT LIKE '%Z/%' AND message NOT LIKE 'querying next range at%'
  AND tag NOT LIKE '%intExec=%'
  AND tag NOT LIKE '%scExec%'
  AND tag NOT LIKE '%IndexBackfiller%'
----
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
dist sender send  r1: sending batch 1 Get to (n1,s1):1
sql txn           Put /Table/3/1/56/2/1 -> table:<name:"kv" id:56 parent_id:55 version:8 modification_time:<wall_time:... > columns:<name:"k" id:1 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:false hidden:false > columns:<name:"v" id:2 type:<semantic_type:INT width:64 precision:0 visible_type:BIGINT > nullable:true hidden:false > next_column_id:3 families:<name:"primary" id:0 column_names:"k" column_names:"v" column_ids:1 column_ids:2 default_column_id:2 > next_family_id:1 primary_index:<name:"primary" id:1 unique:true column_names:"k" column_directions:ASC column_ids:1 foreign_key:<table:0 index:0 name:"" validity:Validated shared_prefix_len:0 on_delete:NO_ACTION on_update:NO_ACTION match:SIMPLE > interleave:<> partitioning:<num_columns:0 > type:FORWARD > next_index_id:3 privileges:<users:<user:"admin" privileges:2 > users:<user:"root" privileges:2 > > next_mutation_id:3 format_version:3 state:DROP draining_names:<parent_id:55 name:"kv" > view_query:"" drop_time:... replacement_of:<id:0 time:<> > audit_mode:DISABLED drop_job_id:... gc_mutations:<index_id:2 drop_time:... job_id:... > >
dist sender send  r1: sending batch 1 Put to (n1,s1):1
sql txn           rows affected: 0
dist sender send  r1: sending batch 1 EndTxn, 14 QueryIntent to (n1,s1):1
