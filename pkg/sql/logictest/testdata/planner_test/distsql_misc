# LogicTest: 5node-dist

subtest scrub

# Verify the index check execution plan uses a merge join.

statement ok
CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))

query T
SELECT url FROM [EXPLAIN (DISTSQL)
    SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
    FROM
      (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
    FULL OUTER JOIN
      (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
      ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
    WHERE (leftside.k IS NULL) OR
          (rightside.k IS NULL)
]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyckc2K2zAQgO99CjGnLJmSSHZ6EBR06UKWNC7Z5FR8cK1p1uBIZiRDlyXvXhzDbhzWabPHGembb35ewHlL6-JAAfRPkJAjNOxLCsFzl-o_LO0f0HOEyjVt7NI5QumZQL9ArGJNoGFb_KppQ4Ulns0BwVIsqvpUtuHqUPCziRQiIHwGhKyNWhiFRqJJID8i-Da-FQ-x2BNoecT_b-DRcySeyaHbyCkaNUWTTEc16hbN-Zxq6ApUemc_NGnygUmT8UkRDkUsn0RNTgs1ak1HrW-y1nm2xGQHtrwj__Xlnda_E-_pwVeOeJYO-98-N6TF_W61Etlu-20jHrLlGhBq-h0nZ8PdfeVq_zRMAcJ9VUdiLSZGieWjWO9WqzuRbcTELF7j13NI7C6SoEnRLNB8Gd3Q4pa7bCg03gW63NS7lefdesjuqV938C2X9IN9edL0YXbiTglLIfavsg-Wrn_qGjyH5VU4HcDyElZX4eS6ObnBrC7h9Cq8uDDnx09_AwAA__97EoFy

# Verify the foreign key check execution plan uses a merge join.

statement ok
CREATE TABLE parent (
  id INT PRIMARY KEY,
  id2 INT,
  UNIQUE INDEX (id, id2)
)

statement ok
CREATE TABLE child (
  child_id INT PRIMARY KEY,
  id INT,
  id2 INT,
  FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
)

query T
SELECT url FROM [EXPLAIN (DISTSQL)
    SELECT p.child_id, p.id, p.id2
    FROM
      (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
    FULL OUTER JOIN
      (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
      ON p.id = c.id AND p.id2 = c.id2
    WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
          c.id IS NULL AND c.id2 IS NULL
]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJycklFrnTAUx9_3KcJ58nIzqnF7CQwy2AoWp8N5n4aIM-faUJdIEqGl-N2HEdZa2o7uMb-cf37JObkHbSQW3W90wH9CAg2FyZoenTN2RVtBJm-BxxSUnma_4oZCbywCvwev_IjAoe5-jVhhJ9FexEBBou_UGI7tr9Uo2272plVa4m17vmmVbC2e26mzqL0IFUDhPTQLBTP7B4_z3YDAk4X-312S_V024apXkrU3eCc28qqcvSh_cM7aWIkW5c7XrMl_lTzzgm9oB7wySqO9YPsX1HcTcnJ5ynNSnuqvFbkqswIojHj2kWBHKtLj4ZNVw7WPRHKkgh0PQOFSjR4tJ1EUCUayH6Qoa1Kc8vxAyopEIt2xA_lcfCGR-BDoY_LxLwEK5ew5EQkVjIr0xfalb5ldhW4y2uHTNj57crz2DuWA2yycmW2P363pg2ZbliEXgETnt122LTIdtsLnehxO3hBmT8Ps1XC6C8dLs7z7EwAA__8DzyIV

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lE2PmzAQhu_9FWhOrWTkDyCb5bQ97qVbbXqrODh4RFEJRraR2kb89woQSokSg0R6xM6b59Uz1pyh1gq_yBNaSL8DBwICCERAIAYCCWQEGqNztFab_idj4FX9gpQRKOumdf1xRiDXBiE9gytdhZDCN3ms8B2lQkMZEFDoZFkNmMaUJ2l-vyjpJBAIKQ9krQIeaPcDDRB4a10avHDIOgK6dReIdbJASHlH1hc5yFNToaHJvMR4fCj_YBpwxljf8eCkHyzugi-8ttZGoUE142Xd3Wqfi8JgIZ02lLP1JYOPgrHg2OY_0dlPdytHs8p8_dC4d2iUh1RsGttClWlsu4ePTax3IPwOREijTQ4WqkwOnh7uIFrvIPI7iEIab3KwUGVysH-4g3i9g9jvIA5pssnBQpXJwfN_XWE3wO9oG11bvFplt_-Z9SsOVYHjPrS6NTl-NTofMOPn25AbDhRaN97y8eO1Hq_6gv-GuTcsZmF-HRZ-8gI68qZjfzje0jvxhnd-8m4L-ckb3vvJ-y3kZ_-s2MIz8T-ya3bWffgbAAD__6RX6GU=
