/* setup */
CREATE DATABASE db;
CREATE TABLE db.public.tbl (i INT PRIMARY KEY, k INT);
CREATE SEQUENCE db.public.sq1;

/* test */
ALTER TABLE db.public.tbl ADD COLUMN l INT UNIQUE DEFAULT NULL, ADD COLUMN j INT NOT NULL DEFAULT 42, ADD COLUMN m INT NOT NULL DEFAULT 42;
EXPLAIN (ddl, verbose) rollback at post-commit stage 1 of 14;
----
• Schema change plan for rolling back ALTER TABLE ‹db›.public.‹tbl› ADD COLUMN ‹l› INT8 UNIQUE DEFAULT ‹NULL›, ADD COLUMN ‹j› INT8 NOT NULL DEFAULT ‹42›, ADD COLUMN ‹m› INT8 NOT NULL DEFAULT ‹42›;
│
└── • PostCommitNonRevertiblePhase
    │
    └── • Stage 1 of 1 in PostCommitNonRevertiblePhase
        │
        ├── • 27 elements transitioning toward ABSENT
        │   │
        │   ├── • Column:{DescID: 106, ColumnID: 3}
        │   │   │ DELETE_ONLY → ABSENT
        │   │   │
        │   │   ├── • PreviousTransactionPrecedence dependency from DELETE_ONLY Column:{DescID: 106, ColumnID: 3}
        │   │   │     rule: "Column transitions to ABSENT uphold 2-version invariant: DELETE_ONLY->ABSENT"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT ColumnName:{DescID: 106, Name: l, ColumnID: 3}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • SameStagePrecedence dependency from ABSENT ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 3}
        │   │   │     rule: "dependents removed before column"
        │   │   │     rule: "column type removed right before column when not dropping relation"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 2}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT SecondaryIndex:{DescID: 106, IndexID: 2, ConstraintID: 2, TemporaryIndexID: 3, SourceIndexID: 4, RecreateSourceIndexID: 0}
        │   │   │     rule: "indexes containing column reach absent before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 3}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │   │     rule: "indexes containing column reach absent before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   └── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 5}
        │   │         rule: "dependents removed before column"
        │   │
        │   ├── • ColumnName:{DescID: 106, Name: l, ColumnID: 3}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 3}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 3}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 3, ConstraintID: 3, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 3}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 3, ConstraintID: 3, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • TemporaryIndex:{DescID: 106, IndexID: 3, ConstraintID: 3, SourceIndexID: 1}
        │   │   │ DELETE_ONLY → ABSENT
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 3}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 3}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   └── • PreviousTransactionPrecedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 3, ConstraintID: 3, SourceIndexID: 1}
        │   │         rule: "TemporaryIndex transitions to ABSENT uphold 2-version invariant: DELETE_ONLY->ABSENT"
        │   │
        │   ├── • Column:{DescID: 106, ColumnID: 4}
        │   │   │ DELETE_ONLY → ABSENT
        │   │   │
        │   │   ├── • PreviousTransactionPrecedence dependency from DELETE_ONLY Column:{DescID: 106, ColumnID: 4}
        │   │   │     rule: "Column transitions to ABSENT uphold 2-version invariant: DELETE_ONLY->ABSENT"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT ColumnName:{DescID: 106, Name: j, ColumnID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • SameStagePrecedence dependency from ABSENT ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │     rule: "column type removed right before column when not dropping relation"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT ColumnDefaultExpression:{DescID: 106, ColumnID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │   │     rule: "indexes containing column reach absent before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 5}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   └── • Precedence dependency from ABSENT ColumnNotNull:{DescID: 106, ColumnID: 4, IndexID: 4}
        │   │         rule: "dependents removed before column"
        │   │
        │   ├── • ColumnName:{DescID: 106, Name: j, ColumnID: 4}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • SameStagePrecedence dependency from ABSENT ColumnDefaultExpression:{DescID: 106, ColumnID: 4}
        │   │         rule: "column type dependents removed right before column type"
        │   │
        │   ├── • ColumnDefaultExpression:{DescID: 106, ColumnID: 4}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │   │ BACKFILL_ONLY → ABSENT
        │   │   │
        │   │   ├── • PreviousTransactionPrecedence dependency from BACKFILL_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │   │     rule: "PrimaryIndex transitions to ABSENT uphold 2-version invariant: BACKFILL_ONLY->DELETE_ONLY"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexName:{DescID: 106, Name: tbl_pkey, IndexID: 4}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 4}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 2, IndexID: 4}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 4}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 4}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   └── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 4}
        │   │         rule: "dependents removed before index"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 2, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexData:{DescID: 106, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from ABSENT PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index removed before garbage collection"
        │   │
        │   ├── • TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │   │ DELETE_ONLY → ABSENT
        │   │   │
        │   │   ├── • PreviousTransactionPrecedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │   │     rule: "TemporaryIndex transitions to ABSENT uphold 2-version invariant: DELETE_ONLY->ABSENT"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 5}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 2, IndexID: 5}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 5}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 5}
        │   │   │     rule: "dependents removed before index"
        │   │   │
        │   │   └── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 5}
        │   │         rule: "dependents removed before index"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 1, IndexID: 5}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 2, IndexID: 5}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 3, IndexID: 5}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 4, IndexID: 5}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   ├── • Column:{DescID: 106, ColumnID: 5}
        │   │   │ DELETE_ONLY → ABSENT
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │   │     rule: "indexes containing column reach absent before column"
        │   │   │
        │   │   ├── • PreviousTransactionPrecedence dependency from DELETE_ONLY Column:{DescID: 106, ColumnID: 5}
        │   │   │     rule: "Column transitions to ABSENT uphold 2-version invariant: DELETE_ONLY->ABSENT"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT ColumnName:{DescID: 106, Name: m, ColumnID: 5}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • SameStagePrecedence dependency from ABSENT ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 5}
        │   │   │     rule: "dependents removed before column"
        │   │   │     rule: "column type removed right before column when not dropping relation"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT ColumnDefaultExpression:{DescID: 106, ColumnID: 5}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 4}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   ├── • Precedence dependency from ABSENT IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 5}
        │   │   │     rule: "dependents removed before column"
        │   │   │
        │   │   └── • Precedence dependency from ABSENT ColumnNotNull:{DescID: 106, ColumnID: 5, IndexID: 4}
        │   │         rule: "dependents removed before column"
        │   │
        │   ├── • ColumnName:{DescID: 106, Name: m, ColumnID: 5}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 5}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • SameStagePrecedence dependency from ABSENT ColumnDefaultExpression:{DescID: 106, ColumnID: 5}
        │   │         rule: "column type dependents removed right before column type"
        │   │
        │   ├── • ColumnDefaultExpression:{DescID: 106, ColumnID: 5}
        │   │     PUBLIC → ABSENT
        │   │
        │   ├── • IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 4}
        │   │   │ PUBLIC → ABSENT
        │   │   │
        │   │   └── • Precedence dependency from DELETE_ONLY PrimaryIndex:{DescID: 106, IndexID: 4, ConstraintID: 4, TemporaryIndexID: 5, SourceIndexID: 1}
        │   │         rule: "index drop mutation visible before cleaning up index columns"
        │   │
        │   └── • IndexColumn:{DescID: 106, ColumnID: 5, IndexID: 5}
        │       │ PUBLIC → ABSENT
        │       │
        │       └── • Precedence dependency from DELETE_ONLY TemporaryIndex:{DescID: 106, IndexID: 5, ConstraintID: 5, SourceIndexID: 1}
        │             rule: "index drop mutation visible before cleaning up index columns"
        │
        └── • 26 Mutation operations
            │
            ├── • SetColumnName
            │     ColumnID: 3
            │     Name: crdb_internal_column_3_name_placeholder
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 3
            │     IndexID: 3
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 1
            │     IndexID: 3
            │     Kind: 1
            │     TableID: 106
            │
            ├── • MakeIndexAbsent
            │     IndexID: 3
            │     TableID: 106
            │
            ├── • SetColumnName
            │     ColumnID: 4
            │     Name: crdb_internal_column_4_name_placeholder
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 1
            │     IndexID: 4
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 2
            │     IndexID: 4
            │     Kind: 2
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 3
            │     IndexID: 4
            │     Kind: 2
            │     Ordinal: 1
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 4
            │     IndexID: 4
            │     Kind: 2
            │     Ordinal: 2
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 1
            │     IndexID: 5
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 2
            │     IndexID: 5
            │     Kind: 2
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 3
            │     IndexID: 5
            │     Kind: 2
            │     Ordinal: 1
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 4
            │     IndexID: 5
            │     Kind: 2
            │     Ordinal: 2
            │     TableID: 106
            │
            ├── • SetColumnName
            │     ColumnID: 5
            │     Name: crdb_internal_column_5_name_placeholder
            │     TableID: 106
            │
            ├── • RemoveColumnDefaultExpression
            │     ColumnID: 5
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 5
            │     IndexID: 4
            │     Kind: 2
            │     Ordinal: 3
            │     TableID: 106
            │
            ├── • RemoveColumnFromIndex
            │     ColumnID: 5
            │     IndexID: 5
            │     Kind: 2
            │     Ordinal: 3
            │     TableID: 106
            │
            ├── • RemoveColumnDefaultExpression
            │     ColumnID: 4
            │     TableID: 106
            │
            ├── • MakeIndexAbsent
            │     IndexID: 4
            │     TableID: 106
            │
            ├── • CreateGCJobForIndex
            │     IndexID: 4
            │     StatementForDropJob:
            │       Rollback: true
            │       Statement: ALTER TABLE db.public.tbl ADD COLUMN l INT8 UNIQUE DEFAULT NULL, ADD COLUMN j INT8 NOT NULL DEFAULT 42, ADD COLUMN m INT8 NOT NULL DEFAULT 42
            │     TableID: 106
            │
            ├── • MakeIndexAbsent
            │     IndexID: 5
            │     TableID: 106
            │
            ├── • MakeDeleteOnlyColumnAbsent
            │     ColumnID: 3
            │     TableID: 106
            │
            ├── • MakeDeleteOnlyColumnAbsent
            │     ColumnID: 5
            │     TableID: 106
            │
            ├── • MakeDeleteOnlyColumnAbsent
            │     ColumnID: 4
            │     TableID: 106
            │
            ├── • RemoveJobStateFromDescriptor
            │     DescriptorID: 106
            │     JobID: 1
            │
            └── • UpdateSchemaChangerJob
                  DescriptorIDsToRemove:
                  - 106
                  IsNonCancelable: true
                  JobID: 1
                  RunningStatus: all stages completed
