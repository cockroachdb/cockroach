setup
CREATE TABLE t (i INT PRIMARY KEY, j INT);
CREATE INDEX idx ON t(j);
CREATE FUNCTION f_trigger() RETURNS TRIGGER LANGUAGE PLpgSQL AS $$
BEGIN
  SELECT j FROM t@idx WHERE j = 1;
  RETURN NULL;
END;
$$;
CREATE TRIGGER trg AFTER INSERT ON t FOR EACH ROW EXECUTE FUNCTION f_trigger();
----

stage-exec phase=PostCommitNonRevertiblePhase stage=:
INSERT INTO t (i, j) VALUES($stageKey, $stageKey);
INSERT INTO t (i, j) VALUES($stageKey + 1, $stageKey + 1);
----

stage-exec phase=PostCommitNonRevertiblePhase stage=:
DELETE FROM t WHERE j=$stageKey+1;
INSERT INTO t (i, j) VALUES($stageKey + 1, $stageKey + 1);
----

# Each insert will be injected twice per stage, so we should always,
# see a count of 2.
stage-query phase=PostCommitNonRevertiblePhase stage=:
SELECT count(*)=$successfulStageCount*2 FROM t;
----
true

# Verify the trigger is gone after the schema change completes.
stage-query phase=PostCommitNonRevertiblePhase stage=3
SELECT count(*) FROM [SHOW TRIGGERS FROM t];
----
0

test
DROP INDEX idx CASCADE
----
