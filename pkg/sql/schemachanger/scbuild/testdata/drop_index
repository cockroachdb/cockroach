# Create four indexes:
# 1. a 'vanilla' index;
# 2. a partial, expression index;
# 3. a hash-sharded index;
# 4. a unique, composite index with a dependent view and a dependent FK constraint
setup
CREATE TABLE t1(i INT, j STRING);
CREATE INDEX idx1 ON t1(i);
CREATE INDEX idx2 ON t1(lower(j)) WHERE i > 0;
CREATE INDEX idx3 ON t1(i) USING HASH;
CREATE UNIQUE INDEX idx4 ON t1(i, j);
CREATE TABLE t2(i INT, j STRING, CONSTRAINT fk FOREIGN KEY (i, j) REFERENCES t1 (i, j));
CREATE VIEW v AS (SELECT i, j FROM t1@idx4 WHERE i > 0 AND j = 'Hello')
----

build
DROP INDEX idx1 CASCADE
----
- [[IndexName:{DescID: 104, Name: idx1, IndexID: 2}, ABSENT], PUBLIC]
  details:
    indexId: 2
    name: idx1
    tableId: 104
- [[SecondaryIndex:{DescID: 104, IndexID: 2, ConstraintID: 0}, ABSENT], PUBLIC]
  details:
    embeddedIndex:
      indexId: 2
      isCreatedExplicitly: true
      keyColumnDirections:
      - ASC
      keyColumnIds:
      - 1
      keySuffixColumnIds:
      - 3
      tableId: 104

build
DROP INDEX idx2 CASCADE
----
- [[Column:{DescID: 104, ColumnID: 4}, ABSENT], PUBLIC]
  details:
    columnId: 4
    isInaccessible: true
    pgAttributeNum: 4
    tableId: 104
- [[ColumnName:{DescID: 104, Name: crdb_internal_idx_expr, ColumnID: 4}, ABSENT], PUBLIC]
  details:
    columnId: 4
    name: crdb_internal_idx_expr
    tableId: 104
- [[ColumnType:{DescID: 104, ColumnFamilyID: 0, ColumnID: 4}, ABSENT], PUBLIC]
  details:
    columnId: 4
    computeExpr:
      expr: lower(j)
    embeddedTypeT:
      type:
        family: StringFamily
        oid: 25
    isNullable: true
    isRelationBeingDropped: true
    isVirtual: true
    tableId: 104
- [[IndexName:{DescID: 104, Name: idx2, IndexID: 4}, ABSENT], PUBLIC]
  details:
    indexId: 4
    name: idx2
    tableId: 104
- [[SecondaryIndex:{DescID: 104, IndexID: 4, ConstraintID: 0}, ABSENT], PUBLIC]
  details:
    embeddedIndex:
      indexId: 4
      isCreatedExplicitly: true
      keyColumnDirections:
      - ASC
      keyColumnIds:
      - 4
      keySuffixColumnIds:
      - 3
      tableId: 104
- [[SecondaryIndexPartial:{DescID: 104, IndexID: 4}, ABSENT], PUBLIC]
  details:
    embeddedExpr:
      expr: i > 0:::INT8
    indexId: 4
    isRelationBeingDropped: true
    tableId: 104

build
DROP INDEX idx3 CASCADE
----
- [[CheckConstraint:{DescID: 104, ConstraintID: 4}, ABSENT], PUBLIC]
  details:
    columnIds:
    - 5
    constraintId: 4
    embeddedExpr:
      expr: crdb_internal_i_shard_16 IN (0:::INT8, 1:::INT8, 2:::INT8, 3:::INT8, 4:::INT8,
        5:::INT8, 6:::INT8, 7:::INT8, 8:::INT8, 9:::INT8, 10:::INT8, 11:::INT8, 12:::INT8,
        13:::INT8, 14:::INT8, 15:::INT8)
    tableId: 104
- [[Column:{DescID: 104, ColumnID: 5}, ABSENT], PUBLIC]
  details:
    columnId: 5
    isHidden: true
    pgAttributeNum: 5
    tableId: 104
- [[ColumnName:{DescID: 104, Name: crdb_internal_i_shard_16, ColumnID: 5}, ABSENT], PUBLIC]
  details:
    columnId: 5
    name: crdb_internal_i_shard_16
    tableId: 104
- [[ColumnType:{DescID: 104, ColumnFamilyID: 0, ColumnID: 5}, ABSENT], PUBLIC]
  details:
    columnId: 5
    computeExpr:
      expr: mod(fnv32(crdb_internal.datums_to_bytes(i)), 16:::INT8)
    embeddedTypeT:
      type:
        family: IntFamily
        oid: 20
        width: 64
    isRelationBeingDropped: true
    isVirtual: true
    tableId: 104
- [[ConstraintName:{DescID: 104, Name: check_crdb_internal_i_shard_16, ConstraintID: 4}, ABSENT], PUBLIC]
  details:
    constraintId: 4
    name: check_crdb_internal_i_shard_16
    tableId: 104
- [[IndexName:{DescID: 104, Name: idx3, IndexID: 6}, ABSENT], PUBLIC]
  details:
    indexId: 6
    name: idx3
    tableId: 104
- [[SecondaryIndex:{DescID: 104, IndexID: 6, ConstraintID: 0}, ABSENT], PUBLIC]
  details:
    embeddedIndex:
      indexId: 6
      isCreatedExplicitly: true
      keyColumnDirections:
      - ASC
      - ASC
      keyColumnIds:
      - 5
      - 1
      keySuffixColumnIds:
      - 3
      sharding:
        columnNames:
        - i
        isSharded: true
        name: crdb_internal_i_shard_16
        shardBuckets: 16
      tableId: 104

build
DROP INDEX idx4 CASCADE
----
- [[Column:{DescID: 106, ColumnID: 1}, ABSENT], PUBLIC]
  details:
    columnId: 1
    pgAttributeNum: 1
    tableId: 106
- [[Column:{DescID: 106, ColumnID: 2}, ABSENT], PUBLIC]
  details:
    columnId: 2
    pgAttributeNum: 2
    tableId: 106
- [[Column:{DescID: 106, ColumnID: 4294967294}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967294e+09
    isHidden: true
    isSystemColumn: true
    pgAttributeNum: 4.294967294e+09
    tableId: 106
- [[Column:{DescID: 106, ColumnID: 4294967295}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967295e+09
    isHidden: true
    isSystemColumn: true
    pgAttributeNum: 4.294967295e+09
    tableId: 106
- [[ColumnName:{DescID: 106, Name: crdb_internal_mvcc_timestamp, ColumnID: 4294967295}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967295e+09
    name: crdb_internal_mvcc_timestamp
    tableId: 106
- [[ColumnName:{DescID: 106, Name: i, ColumnID: 1}, ABSENT], PUBLIC]
  details:
    columnId: 1
    name: i
    tableId: 106
- [[ColumnName:{DescID: 106, Name: j, ColumnID: 2}, ABSENT], PUBLIC]
  details:
    columnId: 2
    name: j
    tableId: 106
- [[ColumnName:{DescID: 106, Name: tableoid, ColumnID: 4294967294}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967294e+09
    name: tableoid
    tableId: 106
- [[ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 1}, ABSENT], PUBLIC]
  details:
    columnId: 1
    embeddedTypeT:
      type:
        family: IntFamily
        oid: 20
        width: 64
    isNullable: true
    isRelationBeingDropped: true
    tableId: 106
- [[ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 2}, ABSENT], PUBLIC]
  details:
    columnId: 2
    embeddedTypeT:
      type:
        family: StringFamily
        oid: 25
    isNullable: true
    isRelationBeingDropped: true
    tableId: 106
- [[ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 4294967294}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967294e+09
    embeddedTypeT:
      type:
        family: OidFamily
        oid: 26
    isNullable: true
    isRelationBeingDropped: true
    tableId: 106
- [[ColumnType:{DescID: 106, ColumnFamilyID: 0, ColumnID: 4294967295}, ABSENT], PUBLIC]
  details:
    columnId: 4.294967295e+09
    embeddedTypeT:
      type:
        family: DecimalFamily
        oid: 1700
    isNullable: true
    isRelationBeingDropped: true
    tableId: 106
- [[ConstraintName:{DescID: 105, Name: fk, ConstraintID: 2}, ABSENT], PUBLIC]
  details:
    constraintId: 2
    name: fk
    tableId: 105
- [[ForeignKeyConstraint:{DescID: 105, ConstraintID: 2, ReferencedDescID: 104}, ABSENT], PUBLIC]
  details:
    columnIds:
    - 1
    - 2
    constraintId: 2
    referencedColumnIds:
    - 1
    - 2
    referencedTableId: 104
    tableId: 105
- [[IndexName:{DescID: 104, Name: idx4, IndexID: 8}, ABSENT], PUBLIC]
  details:
    indexId: 8
    name: idx4
    tableId: 104
- [[Namespace:{DescID: 106, Name: v, ReferencedDescID: 100}, ABSENT], PUBLIC]
  details:
    databaseId: 100
    descriptorId: 106
    name: v
    schemaId: 101
- [[ObjectParent:{DescID: 106, ReferencedDescID: 101}, ABSENT], PUBLIC]
  details:
    objectId: 106
    parentSchemaId: 101
- [[Owner:{DescID: 106}, ABSENT], PUBLIC]
  details:
    descriptorId: 106
    owner: root
- [[SecondaryIndex:{DescID: 104, IndexID: 8, ConstraintID: 9}, ABSENT], PUBLIC]
  details:
    embeddedIndex:
      constraintId: 9
      indexId: 8
      isCreatedExplicitly: true
      isUnique: true
      keyColumnDirections:
      - ASC
      - ASC
      keyColumnIds:
      - 1
      - 2
      keySuffixColumnIds:
      - 3
      tableId: 104
- [[UserPrivileges:{DescID: 106, Name: admin}, ABSENT], PUBLIC]
  details:
    descriptorId: 106
    privileges: 2
    userName: admin
- [[UserPrivileges:{DescID: 106, Name: root}, ABSENT], PUBLIC]
  details:
    descriptorId: 106
    privileges: 2
    userName: root
- [[View:{DescID: 106}, ABSENT], PUBLIC]
  details:
    forwardReferences:
    - columnIds:
      - 1
      - 2
      indexId: 8
      toId: 104
    usesRelationIds:
    - 104
    viewId: 106
