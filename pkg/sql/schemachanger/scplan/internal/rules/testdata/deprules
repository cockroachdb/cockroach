rules
----
columnInIndex(index-column, index, table-id, column-id, index-id):
    - $index-column[Type] = '*scpb.IndexColumn'
    - $index-column[DescID] = $_
    - $index-column[ColumnID] = $column-id
    - $index[IndexID] = $index-id
    - joinOnIndexID($index, $index-column, $table-id, $index-id)
columnInSwappedInPrimaryIndex(index-column, index, table-id, column-id, index-id):
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - sourceIndexIsSet($index)
joinOnColumnID(a, b, desc-id, col-id):
    - joinOnDescID($a, $b, $desc-id)
    - $a[ColumnID] = $col-id
    - $b[ColumnID] = $col-id
joinOnConstraintID(a, b, desc-id, constraint-id):
    - joinOnDescID($a, $b, $desc-id)
    - $a[ConstraintID] = $constraint-id
    - $b[ConstraintID] = $constraint-id
joinOnDescID(a, b, id):
    - $a[DescID] = $id
    - $b[DescID] = $id
joinOnIndexID(a, b, desc-id, index-id):
    - joinOnDescID($a, $b, $desc-id)
    - $a[IndexID] = $index-id
    - $b[IndexID] = $index-id
joinReferencedDescID(referrer, referenced, id):
    - $referrer[ReferencedDescID] = $id
    - $referenced[DescID] = $id
joinTarget(element, target):
    - $target[Type] = '*scpb.Target'
    - $target[Element] = $element
    - $element[DescID] = $_
joinTargetNode(element, target, node):
    - joinTarget($element, $target)
    - $node[Type] = '*screl.Node'
    - $node[Target] = $target
sourceIndexIsSet(index):
    - $index[SourceIndexID] != 0
toAbsent(target1, target2):
    - $target1[TargetStatus] = ABSENT
    - $target2[TargetStatus] = ABSENT
toPublicOrTransient(target1, target2):
    - $target1[TargetStatus] IN [PUBLIC, TRANSIENT_ABSENT]
    - $target2[TargetStatus] IN [PUBLIC, TRANSIENT_ABSENT]
transient(target1, target2):
    - $target1[TargetStatus] = TRANSIENT_ABSENT
    - $target2[TargetStatus] = TRANSIENT_ABSENT

deprules
----
- name: DEFAULT or ON UPDATE existence precedes writes to column
  from: expr-node
  kind: Precedence
  to: column-node
  query:
    - $expr[Type] IN ['*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($expr, $column, $table-id, $col-id)
    - toPublicOrTransient($expr-target, $column-target)
    - $expr-node[CurrentStatus] = PUBLIC
    - $column-node[CurrentStatus] = WRITE_ONLY
    - joinTargetNode($expr, $expr-target, $expr-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: column dependents exist before column becomes public
  from: dependent-node
  kind: Precedence
  to: column-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($dependent, $column, $table-id, $col-id)
    - toPublicOrTransient($dependent-target, $column-target)
    - $dependent-node[CurrentStatus] = PUBLIC
    - $column-node[CurrentStatus] = PUBLIC
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: column existence precedes column dependents
  from: column-node
  kind: Precedence
  to: dependent-node
  query:
    - $column[Type] = '*scpb.Column'
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - joinOnColumnID($column, $dependent, $table-id, $col-id)
    - toPublicOrTransient($column-target, $dependent-target)
    - $column-node[CurrentStatus] = DELETE_ONLY
    - $dependent-node[CurrentStatus] = PUBLIC
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: column existence precedes index existence
  from: column-node
  kind: Precedence
  to: index-node
  query:
    - $column[Type] = '*scpb.Column'
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - joinOnColumnID($column, $index-column, $table-id, $column-id)
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - toPublicOrTransient($column-target, $index-target)
    - $column-node[CurrentStatus] = DELETE_ONLY
    - $index-node[CurrentStatus] = BACKFILL_ONLY
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: column existence precedes temp index existence
  from: column-node
  kind: Precedence
  to: index-node
  query:
    - $column[Type] = '*scpb.Column'
    - $index[Type] = '*scpb.TemporaryIndex'
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - toPublicOrTransient($column-target, $index-target)
    - $column-node[CurrentStatus] = DELETE_ONLY
    - $index-node[CurrentStatus] = DELETE_ONLY
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: column is WRITE_ONLY before temporary index is WRITE_ONLY
  from: column-node
  kind: Precedence
  to: index-node
  query:
    - $column[Type] = '*scpb.Column'
    - $index[Type] = '*scpb.TemporaryIndex'
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - toPublicOrTransient($column-target, $index-target)
    - $column-node[CurrentStatus] = WRITE_ONLY
    - $index-node[CurrentStatus] = WRITE_ONLY
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: column name and type set right after column existence
  from: column-node
  kind: SameStagePrecedence
  to: column-name-or-type-node
  query:
    - $column[Type] = '*scpb.Column'
    - $column-name-or-type[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType']
    - toPublicOrTransient($column-target, $column-name-or-type-target)
    - $column-node[CurrentStatus] = DELETE_ONLY
    - $column-name-or-type-node[CurrentStatus] = PUBLIC
    - joinOnColumnID($column, $column-name-or-type, $table-id, $col-id)
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($column-name-or-type, $column-name-or-type-target, $column-name-or-type-node)
- name: column no longer public before dependents
  from: column-node
  kind: Precedence
  to: dependent-node
  query:
    - $column[Type] = '*scpb.Column'
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - joinOnColumnID($column, $dependent, $table-id, $col-id)
    - toAbsent($column-target, $dependent-target)
    - $column-node[CurrentStatus] = WRITE_ONLY
    - $dependent-node[CurrentStatus] = ABSENT
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: column no longer public before dependents
  from: column-node
  kind: Precedence
  to: dependent-node
  query:
    - $column[Type] = '*scpb.Column'
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - joinOnColumnID($column, $dependent, $table-id, $col-id)
    - $column-target[TargetStatus] = TRANSIENT_ABSENT
    - $column-node[CurrentStatus] = TRANSIENT_WRITE_ONLY
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = ABSENT
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: column no longer public before dependents
  from: column-node
  kind: Precedence
  to: dependent-node
  query:
    - $column[Type] = '*scpb.Column'
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - joinOnColumnID($column, $dependent, $table-id, $col-id)
    - $column-target[TargetStatus] = ABSENT
    - $column-node[CurrentStatus] = WRITE_ONLY
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: column no longer public before dependents
  from: column-node
  kind: Precedence
  to: dependent-node
  query:
    - $column[Type] = '*scpb.Column'
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - joinOnColumnID($column, $dependent, $table-id, $col-id)
    - transient($column-target, $dependent-target)
    - $column-node[CurrentStatus] = TRANSIENT_WRITE_ONLY
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($column, $column-target, $column-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: column type dependents removed right before column type
  from: dependent-node
  kind: SameStagePrecedence
  to: column-type-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner']
    - $column-type[Type] = '*scpb.ColumnType'
    - joinOnColumnID($dependent, $column-type, $table-id, $col-id)
    - toAbsent($dependent-target, $column-type-target)
    - $dependent-node[CurrentStatus] = ABSENT
    - $column-type-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column-type, $column-type-target, $column-type-node)
- name: column type removed right before column when not dropping relation
  from: column-type-node
  kind: SameStagePrecedence
  to: column-node
  query:
    - $column-type[Type] = '*scpb.ColumnType'
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($column-type, $column, $table-id, $col-id)
    - toAbsent($column-type-target, $column-target)
    - $column-type-node[CurrentStatus] = ABSENT
    - $column-node[CurrentStatus] = ABSENT
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - joinTargetNode($column-type, $column-type-target, $column-type-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - toAbsent($dependent-target, $constraint-target)
    - $dependent-node[CurrentStatus] = VALIDATED
    - $constraint-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - toAbsent($dependent-target, $constraint-target)
    - $dependent-node[CurrentStatus] = ABSENT
    - $constraint-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - transient($dependent-target, $constraint-target)
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $constraint-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $constraint-target[TargetStatus] = ABSENT
    - $constraint-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = ABSENT
    - $constraint-target[TargetStatus] = TRANSIENT_ABSENT
    - $constraint-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - transient($dependent-target, $constraint-target)
    - $dependent-node[CurrentStatus] = TRANSIENT_VALIDATED
    - $constraint-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_VALIDATED
    - $constraint-target[TargetStatus] = ABSENT
    - $constraint-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent absent right before constraint
  from: dependent-node
  kind: SameStagePrecedence
  to: constraint-node
  query:
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - $constraint[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnConstraintID($dependent, $constraint, $table-id, $constraint-id)
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = VALIDATED
    - $constraint-target[TargetStatus] = TRANSIENT_ABSENT
    - $constraint-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
- name: constraint dependent public right before constraint
  from: constraint-node
  kind: SameStagePrecedence
  to: dependent-node
  query:
    - $constraint[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex', '*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - $dependent[Type] IN ['*scpb.ConstraintName', '*scpb.ConstraintComment']
    - joinOnConstraintID($constraint, $dependent, $table-id, $constraint-id)
    - toPublicOrTransient($constraint-target, $dependent-target)
    - $constraint-node[CurrentStatus] = PUBLIC
    - $dependent-node[CurrentStatus] = PUBLIC
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: dependents removed before column
  from: dependent-node
  kind: Precedence
  to: column-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($dependent, $column, $table-id, $col-id)
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = ABSENT
    - $column-target[TargetStatus] = TRANSIENT_ABSENT
    - $column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: dependents removed before column
  from: dependent-node
  kind: Precedence
  to: column-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($dependent, $column, $table-id, $col-id)
    - toAbsent($dependent-target, $column-target)
    - $dependent-node[CurrentStatus] = ABSENT
    - $column-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: dependents removed before column
  from: dependent-node
  kind: Precedence
  to: column-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($dependent, $column, $table-id, $col-id)
    - transient($dependent-target, $column-target)
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: dependents removed before column
  from: dependent-node
  kind: Precedence
  to: column-node
  query:
    - $dependent[Type] IN ['*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexColumn']
    - $column[Type] = '*scpb.Column'
    - joinOnColumnID($dependent, $column, $table-id, $col-id)
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $column-target[TargetStatus] = ABSENT
    - $column-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: dependents removed before index
  from: dependent-node
  kind: Precedence
  to: index-node
  query:
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($dependent, $index, $table-id, $index-id)
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = ABSENT
    - $index-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: dependents removed before index
  from: dependent-node
  kind: Precedence
  to: index-node
  query:
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($dependent, $index, $table-id, $index-id)
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $index-target[TargetStatus] = ABSENT
    - $index-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: dependents removed before index
  from: dependent-node
  kind: Precedence
  to: index-node
  query:
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($dependent, $index, $table-id, $index-id)
    - transient($dependent-target, $index-target)
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: dependents removed before index
  from: dependent-node
  kind: Precedence
  to: index-node
  query:
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($dependent, $index, $table-id, $index-id)
    - toAbsent($dependent-target, $index-target)
    - $dependent-node[CurrentStatus] = ABSENT
    - $index-node[CurrentStatus] = ABSENT
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: descriptor drop right before dependent element removal
  from: descriptor-node
  kind: SameStagePrecedence
  to: dependent-node
  query:
    - $descriptor[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.View', '*scpb.Sequence', '*scpb.Table', '*scpb.EnumType', '*scpb.AliasType']
    - $dependent[Type] IN ['*scpb.ColumnFamily', '*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint', '*scpb.TableComment', '*scpb.RowLevelTTL', '*scpb.TableZoneConfig', '*scpb.TableLocalityGlobal', '*scpb.TableLocalityPrimaryRegion', '*scpb.TableLocalitySecondaryRegion', '*scpb.TableLocalityRegionalByRow', '*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn', '*scpb.ConstraintName', '*scpb.ConstraintComment', '*scpb.Namespace', '*scpb.Owner', '*scpb.UserPrivileges', '*scpb.DatabaseRegionConfig', '*scpb.DatabaseRoleSetting', '*scpb.DatabaseComment', '*scpb.SchemaParent', '*scpb.SchemaComment', '*scpb.ObjectParent', '*scpb.EnumTypeValue']
    - joinOnDescID($descriptor, $dependent, $desc-id)
    - toAbsent($descriptor-target, $dependent-target)
    - $descriptor-node[CurrentStatus] = DROPPED
    - $dependent-node[CurrentStatus] = ABSENT
    - joinTargetNode($descriptor, $descriptor-target, $descriptor-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: descriptor drop right before removing dependent with attr ref
  from: referenced-descriptor-node
  kind: SameStagePrecedence
  to: referencing-via-attr-node
  query:
    - $referenced-descriptor[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.View', '*scpb.Sequence', '*scpb.Table', '*scpb.EnumType', '*scpb.AliasType']
    - $referencing-via-attr[Type] IN ['*scpb.ColumnFamily', '*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint', '*scpb.TableComment', '*scpb.RowLevelTTL', '*scpb.TableZoneConfig', '*scpb.TableLocalityGlobal', '*scpb.TableLocalityPrimaryRegion', '*scpb.TableLocalitySecondaryRegion', '*scpb.TableLocalityRegionalByRow', '*scpb.ColumnName', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SequenceOwner', '*scpb.ColumnComment', '*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn', '*scpb.ConstraintName', '*scpb.ConstraintComment', '*scpb.Namespace', '*scpb.Owner', '*scpb.UserPrivileges', '*scpb.DatabaseRegionConfig', '*scpb.DatabaseRoleSetting', '*scpb.DatabaseComment', '*scpb.SchemaParent', '*scpb.SchemaComment', '*scpb.ObjectParent', '*scpb.EnumTypeValue']
    - joinReferencedDescID($referencing-via-attr, $referenced-descriptor, $desc-id)
    - toAbsent($referenced-descriptor-target, $referencing-via-attr-target)
    - $referenced-descriptor-node[CurrentStatus] = DROPPED
    - $referencing-via-attr-node[CurrentStatus] = ABSENT
    - joinTargetNode($referenced-descriptor, $referenced-descriptor-target, $referenced-descriptor-node)
    - joinTargetNode($referencing-via-attr, $referencing-via-attr-target, $referencing-via-attr-node)
- name: descriptor drop right before removing dependent with expr ref
  from: referenced-descriptor-node
  kind: SameStagePrecedence
  to: referencing-via-expr-node
  query:
    - $referenced-descriptor[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.View', '*scpb.Sequence', '*scpb.Table', '*scpb.EnumType', '*scpb.AliasType']
    - $referencing-via-expr[Type] IN ['*scpb.CheckConstraint', '*scpb.ColumnType', '*scpb.ColumnDefaultExpression', '*scpb.ColumnOnUpdateExpression', '*scpb.SecondaryIndexPartial']
    - toAbsent($referenced-descriptor-target, $referencing-via-expr-target)
    - $referenced-descriptor-node[CurrentStatus] = DROPPED
    - $referencing-via-expr-node[CurrentStatus] = ABSENT
    - RefByExpression(scpb.Element, scpb.Element)($referenced-descriptor, $referencing-via-expr)
    - joinTargetNode($referenced-descriptor, $referenced-descriptor-target, $referenced-descriptor-node)
    - joinTargetNode($referencing-via-expr, $referencing-via-expr-target, $referencing-via-expr-node)
- name: descriptor drop right before removing dependent with type ref
  from: referenced-descriptor-node
  kind: SameStagePrecedence
  to: referencing-via-type-node
  query:
    - $referenced-descriptor[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.View', '*scpb.Sequence', '*scpb.Table', '*scpb.EnumType', '*scpb.AliasType']
    - $referencing-via-type[Type] = '*scpb.ColumnType'
    - toAbsent($referenced-descriptor-target, $referencing-via-type-target)
    - $referenced-descriptor-node[CurrentStatus] = DROPPED
    - $referencing-via-type-node[CurrentStatus] = ABSENT
    - RefByTypeT(scpb.Element, scpb.Element)($referenced-descriptor, $referencing-via-type)
    - joinTargetNode($referenced-descriptor, $referenced-descriptor-target, $referenced-descriptor-node)
    - joinTargetNode($referencing-via-type, $referencing-via-type-target, $referencing-via-type-node)
- name: descriptor removal right before dependent element removal
  from: descriptor-node
  kind: SameStagePrecedence
  to: idx-or-col-node
  query:
    - $descriptor[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.View', '*scpb.Sequence', '*scpb.Table', '*scpb.EnumType', '*scpb.AliasType']
    - $idx-or-col[Type] IN ['*scpb.Column', '*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnDescID($descriptor, $idx-or-col, $desc-id)
    - toAbsent($descriptor-target, $idx-or-col-target)
    - $descriptor-node[CurrentStatus] = ABSENT
    - $idx-or-col-node[CurrentStatus] = ABSENT
    - joinTargetNode($descriptor, $descriptor-target, $descriptor-node)
    - joinTargetNode($idx-or-col, $idx-or-col-target, $idx-or-col-node)
- name: ensure columns are in increasing order
  from: later-column-node
  kind: SameStagePrecedence
  to: earlier-column-node
  query:
    - $later-column[Type] = '*scpb.Column'
    - $earlier-column[Type] = '*scpb.Column'
    - joinOnDescID($later-column, $earlier-column, $table-id)
    - toPublicOrTransient($later-column-target, $earlier-column-target)
    - $status IN [WRITE_ONLY, PUBLIC]
    - $later-column-node[CurrentStatus] = $status
    - $earlier-column-node[CurrentStatus] = $status
    - SmallerColumnIDFirst(*scpb.Column, *scpb.Column)($later-column, $earlier-column)
    - joinTargetNode($later-column, $later-column-target, $later-column-node)
    - joinTargetNode($earlier-column, $earlier-column-target, $earlier-column-node)
- name: index dependents exist before index becomes public
  from: dependent-node
  kind: Precedence
  to: index-node
  query:
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($dependent, $index, $table-id, $index-id)
    - toPublicOrTransient($dependent-target, $index-target)
    - $dependent-node[CurrentStatus] = PUBLIC
    - $index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: index existence precedes index dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - toPublicOrTransient($index-target, $dependent-target)
    - $index-node[CurrentStatus] = BACKFILL_ONLY
    - $dependent-node[CurrentStatus] = PUBLIC
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: index named right before index becomes public
  from: index-name-node
  kind: SameStagePrecedence
  to: index-node
  query:
    - $index-name[Type] = '*scpb.IndexName'
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - joinOnIndexID($index-name, $index, $table-id, $index-id)
    - toPublicOrTransient($index-name-target, $index-target)
    - $index-name-node[CurrentStatus] = PUBLIC
    - $index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($index-name, $index-name-target, $index-name-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: index no longer public before dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - toAbsent($index-target, $dependent-target)
    - $index-node[CurrentStatus] = VALIDATED
    - $dependent-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: index no longer public before dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - $index-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_VALIDATED
    - $dependent-target[TargetStatus] = ABSENT
    - $dependent-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: index no longer public before dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - $index-target[TargetStatus] = ABSENT
    - $index-node[CurrentStatus] = VALIDATED
    - $dependent-target[TargetStatus] = TRANSIENT_ABSENT
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: index no longer public before dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - transient($index-target, $dependent-target)
    - $index-node[CurrentStatus] = TRANSIENT_VALIDATED
    - $dependent-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: index-column added to index before index is backfilled
  from: index-column-node
  kind: Precedence
  to: index-node
  query:
    - $index-column[Type] = '*scpb.IndexColumn'
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - joinOnIndexID($index-column, $index, $table-id, $index-id)
    - toPublicOrTransient($index-column-target, $index-target)
    - $index-column-node[CurrentStatus] = PUBLIC
    - $index-node[CurrentStatus] = BACKFILLED
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: index-column added to index before temp index receives writes
  from: index-column-node
  kind: Precedence
  to: index-node
  query:
    - $index-column[Type] = '*scpb.IndexColumn'
    - $index[Type] = '*scpb.TemporaryIndex'
    - joinOnIndexID($index-column, $index, $table-id, $index-id)
    - transient($index-column-target, $index-target)
    - $index-column-node[CurrentStatus] = PUBLIC
    - $index-node[CurrentStatus] = WRITE_ONLY
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: indexes containing column reach absent before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $column[Type] = '*scpb.Column'
    - $column-type[Type] = '*scpb.ColumnType'
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - joinOnColumnID($index-column, $column-type, $table-id, $column-id)
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - toAbsent($index-target, $column-target)
    - $index-node[CurrentStatus] = ABSENT
    - $column-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: indexes containing column reach absent before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $column[Type] = '*scpb.Column'
    - $column-type[Type] = '*scpb.ColumnType'
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - joinOnColumnID($index-column, $column-type, $table-id, $column-id)
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - $index-target[TargetStatus] = ABSENT
    - $index-node[CurrentStatus] = ABSENT
    - $column-target[TargetStatus] = TRANSIENT_ABSENT
    - $column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: indexes containing column reach absent before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $column[Type] = '*scpb.Column'
    - $column-type[Type] = '*scpb.ColumnType'
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - joinOnColumnID($index-column, $column-type, $table-id, $column-id)
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - transient($index-target, $column-target)
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - $column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: indexes containing column reach absent before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $column[Type] = '*scpb.Column'
    - $column-type[Type] = '*scpb.ColumnType'
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - joinOnColumnID($index-column, $column-type, $table-id, $column-id)
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - $index-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - $column-target[TargetStatus] = ABSENT
    - $column-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: old index absent before new index public when swapping with transient
  from: old-primary-index-node
  kind: Precedence
  to: new-primary-index-node
  query:
    - $old-primary-index[Type] = '*scpb.PrimaryIndex'
    - $transient-primary-index[Type] = '*scpb.PrimaryIndex'
    - $new-primary-index[Type] = '*scpb.PrimaryIndex'
    - joinOnDescID($old-primary-index, $transient-primary-index, $table-id)
    - $old-primary-index[IndexID] = $old-index-id
    - $transient-primary-index[SourceIndexID] = $old-index-id
    - joinOnDescID($transient-primary-index, $new-primary-index, $table-id)
    - $transient-primary-index[IndexID] = $transient-index-id
    - $new-primary-index[SourceIndexID] = $transient-index-id
    - $old-primary-index-target[TargetStatus] = ABSENT
    - $old-primary-index-node[CurrentStatus] = ABSENT
    - $new-primary-index-target[TargetStatus] = PUBLIC
    - $new-primary-index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($old-primary-index, $old-primary-index-target, $old-primary-index-node)
    - joinTargetNode($new-primary-index, $new-primary-index-target, $new-primary-index-node)
- name: partial predicate removed right before secondary index when not dropping relation
  from: partial-predicate-node
  kind: SameStagePrecedence
  to: index-node
  query:
    - $partial-predicate[Type] = '*scpb.SecondaryIndexPartial'
    - $index[Type] = '*scpb.SecondaryIndex'
    - joinOnIndexID($partial-predicate, $index, $table-id, $index-id)
    - relationIsNotBeingDropped(*scpb.SecondaryIndexPartial)($partial-predicate)
    - toAbsent($partial-predicate-target, $index-target)
    - $partial-predicate-node[CurrentStatus] = ABSENT
    - $index-node[CurrentStatus] = ABSENT
    - joinTargetNode($partial-predicate, $partial-predicate-target, $partial-predicate-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: partial predicate removed right before secondary index when not dropping relation
  from: partial-predicate-node
  kind: SameStagePrecedence
  to: index-node
  query:
    - $partial-predicate[Type] = '*scpb.SecondaryIndexPartial'
    - $index[Type] = '*scpb.SecondaryIndex'
    - joinOnIndexID($partial-predicate, $index, $table-id, $index-id)
    - relationIsNotBeingDropped(*scpb.SecondaryIndexPartial)($partial-predicate)
    - transient($partial-predicate-target, $index-target)
    - $partial-predicate-node[CurrentStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($partial-predicate, $partial-predicate-target, $partial-predicate-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: partial predicate removed right before secondary index when not dropping relation
  from: partial-predicate-node
  kind: SameStagePrecedence
  to: index-node
  query:
    - $partial-predicate[Type] = '*scpb.SecondaryIndexPartial'
    - $index[Type] = '*scpb.SecondaryIndex'
    - joinOnIndexID($partial-predicate, $index, $table-id, $index-id)
    - relationIsNotBeingDropped(*scpb.SecondaryIndexPartial)($partial-predicate)
    - $partial-predicate-target[TargetStatus] = ABSENT
    - $partial-predicate-node[CurrentStatus] = ABSENT
    - $index-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($partial-predicate, $partial-predicate-target, $partial-predicate-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: partial predicate removed right before secondary index when not dropping relation
  from: partial-predicate-node
  kind: SameStagePrecedence
  to: index-node
  query:
    - $partial-predicate[Type] = '*scpb.SecondaryIndexPartial'
    - $index[Type] = '*scpb.SecondaryIndex'
    - joinOnIndexID($partial-predicate, $index, $table-id, $index-id)
    - relationIsNotBeingDropped(*scpb.SecondaryIndexPartial)($partial-predicate)
    - $partial-predicate-target[TargetStatus] = TRANSIENT_ABSENT
    - $partial-predicate-node[CurrentStatus] = TRANSIENT_ABSENT
    - $index-target[TargetStatus] = ABSENT
    - $index-node[CurrentStatus] = ABSENT
    - joinTargetNode($partial-predicate, $partial-predicate-target, $partial-predicate-node)
    - joinTargetNode($index, $index-target, $index-node)
- name: primary index swap
  from: old-index-node
  kind: SameStagePrecedence
  to: new-index-node
  query:
    - $old-index[Type] = '*scpb.PrimaryIndex'
    - $new-index[Type] = '*scpb.PrimaryIndex'
    - joinOnDescID($old-index, $new-index, $table-id)
    - $old-index[IndexID] = $old-index-id
    - $new-index[SourceIndexID] = $old-index-id
    - $old-index-target[TargetStatus] = TRANSIENT_ABSENT
    - $old-index-node[CurrentStatus] = TRANSIENT_VALIDATED
    - $new-index-target[TargetStatus] IN [PUBLIC, TRANSIENT_ABSENT]
    - $new-index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($old-index, $old-index-target, $old-index-node)
    - joinTargetNode($new-index, $new-index-target, $new-index-node)
- name: primary index swap
  from: old-index-node
  kind: SameStagePrecedence
  to: new-index-node
  query:
    - $old-index[Type] = '*scpb.PrimaryIndex'
    - $new-index[Type] = '*scpb.PrimaryIndex'
    - joinOnDescID($old-index, $new-index, $table-id)
    - $old-index[IndexID] = $old-index-id
    - $new-index[SourceIndexID] = $old-index-id
    - $old-index-target[TargetStatus] = ABSENT
    - $old-index-node[CurrentStatus] = VALIDATED
    - $new-index-target[TargetStatus] IN [PUBLIC, TRANSIENT_ABSENT]
    - $new-index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($old-index, $old-index-target, $old-index-node)
    - joinTargetNode($new-index, $new-index-target, $new-index-node)
- name: primary index swap
  from: new-index-node
  kind: SameStagePrecedence
  to: old-index-node
  query:
    - $new-index[Type] = '*scpb.PrimaryIndex'
    - $old-index[Type] = '*scpb.PrimaryIndex'
    - joinOnDescID($new-index, $old-index, $table-id)
    - $new-index[SourceIndexID] = $old-index-id
    - $old-index[IndexID] = $old-index-id
    - $new-index-target[TargetStatus] = ABSENT
    - $new-index-node[CurrentStatus] = VALIDATED
    - $old-index-target[TargetStatus] = PUBLIC
    - $old-index-node[CurrentStatus] = PUBLIC
    - joinTargetNode($new-index, $new-index-target, $new-index-node)
    - joinTargetNode($old-index, $old-index-target, $old-index-node)
- name: primary index with new columns should exist before secondary indexes
  from: primary-index-node
  kind: Precedence
  to: secondary-index-node
  query:
    - $primary-index[Type] = '*scpb.PrimaryIndex'
    - $secondary-index[Type] = '*scpb.SecondaryIndex'
    - joinOnDescID($primary-index, $secondary-index, $table-id)
    - $primary-index[IndexID] = $primary-index-id
    - $secondary-index[SourceIndexID] = $primary-index-id
    - toPublicOrTransient($primary-index-target, $secondary-index-target)
    - $primary-index-node[CurrentStatus] = PUBLIC
    - $secondary-index-node[CurrentStatus] = BACKFILL_ONLY
    - joinTargetNode($primary-index, $primary-index-target, $primary-index-node)
    - joinTargetNode($secondary-index, $secondary-index-target, $secondary-index-node)
- name: primary index with new columns should exist before temp indexes
  from: primary-index-node
  kind: Precedence
  to: temp-index-node
  query:
    - $primary-index[Type] = '*scpb.PrimaryIndex'
    - $temp-index[Type] = '*scpb.TemporaryIndex'
    - joinOnDescID($primary-index, $temp-index, $table-id)
    - $primary-index[IndexID] = $primary-index-id
    - $temp-index[SourceIndexID] = $primary-index-id
    - toPublicOrTransient($primary-index-target, $temp-index-target)
    - $primary-index-node[CurrentStatus] = PUBLIC
    - $temp-index-node[CurrentStatus] = DELETE_ONLY
    - joinTargetNode($primary-index, $primary-index-target, $primary-index-node)
    - joinTargetNode($temp-index, $temp-index-target, $temp-index-node)
- name: remove columns from index right before removing index
  from: index-node
  kind: Precedence
  to: index-column-node
  query:
    - $index[Type] = '*scpb.IndexColumn'
    - $index-column[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($index, $index-column, $table-id, $index-id)
    - transient($index-target, $index-column-target)
    - $index-node[CurrentStatus] = TRANSIENT_DELETE_ONLY
    - $index-column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
- name: remove columns from index right before removing index
  from: index-node
  kind: Precedence
  to: index-column-node
  query:
    - $index[Type] = '*scpb.IndexColumn'
    - $index-column[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($index, $index-column, $table-id, $index-id)
    - toAbsent($index-target, $index-column-target)
    - $index-node[CurrentStatus] = DELETE_ONLY
    - $index-column-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
- name: remove columns from index right before removing index
  from: index-node
  kind: Precedence
  to: index-column-node
  query:
    - $index[Type] = '*scpb.IndexColumn'
    - $index-column[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($index, $index-column, $table-id, $index-id)
    - $index-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-node[CurrentStatus] = TRANSIENT_DELETE_ONLY
    - $index-column-target[TargetStatus] = ABSENT
    - $index-column-node[CurrentStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
- name: remove columns from index right before removing index
  from: index-node
  kind: Precedence
  to: index-column-node
  query:
    - $index[Type] = '*scpb.IndexColumn'
    - $index-column[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex', '*scpb.TemporaryIndex']
    - joinOnIndexID($index, $index-column, $table-id, $index-id)
    - $index-target[TargetStatus] = ABSENT
    - $index-node[CurrentStatus] = DELETE_ONLY
    - $index-column-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-column-node[CurrentStatus] = TRANSIENT_ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($index-column, $index-column-target, $index-column-node)
- name: secondary indexes containing column as key reach write-only before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] = '*scpb.SecondaryIndex'
    - $column[Type] = '*scpb.Column'
    - columnInIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - toAbsent($index-target, $column-target)
    - $index-node[CurrentStatus] = VALIDATED
    - $column-node[CurrentStatus] = WRITE_ONLY
    - $column-type[Type] = '*scpb.ColumnType'
    - joinOnColumnID($index-column, $column-type, $table-id, $column-id)
    - relationIsNotBeingDropped(*scpb.ColumnType)($column-type)
    - isIndexKeyColumnKey(*scpb.IndexColumn)($index-column)
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: swapped primary index public before column
  from: index-node
  kind: Precedence
  to: column-node
  query:
    - $index[Type] = '*scpb.PrimaryIndex'
    - $column[Type] = '*scpb.Column'
    - columnInSwappedInPrimaryIndex($index-column, $index, $table-id, $column-id, $index-id)
    - joinOnColumnID($index-column, $column, $table-id, $column-id)
    - toPublicOrTransient($index-target, $column-target)
    - $index-node[CurrentStatus] = PUBLIC
    - $column-node[CurrentStatus] = PUBLIC
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($column, $column-target, $column-node)
- name: temp index existence precedes index dependents
  from: index-node
  kind: Precedence
  to: dependent-node
  query:
    - $index[Type] = '*scpb.TemporaryIndex'
    - $dependent[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning', '*scpb.SecondaryIndexPartial', '*scpb.IndexComment', '*scpb.IndexColumn']
    - joinOnIndexID($index, $dependent, $table-id, $index-id)
    - toPublicOrTransient($index-target, $dependent-target)
    - $index-node[CurrentStatus] = DELETE_ONLY
    - $dependent-node[CurrentStatus] = PUBLIC
    - joinTargetNode($index, $index-target, $index-node)
    - joinTargetNode($dependent, $dependent-target, $dependent-node)
- name: temp index is WRITE_ONLY before backfill
  from: temp-node
  kind: Precedence
  to: index-node
  query:
    - $temp[Type] = '*scpb.TemporaryIndex'
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - joinOnDescID($temp, $index, $table-id)
    - $temp[IndexID] = $temp-index-id
    - $index[TemporaryIndexID] = $temp-index-id
    - $temp-target[TargetStatus] = TRANSIENT_ABSENT
    - $index-target[TargetStatus] IN [PUBLIC, TRANSIENT_ABSENT]
    - $temp-node[CurrentStatus] = WRITE_ONLY
    - $index-node[CurrentStatus] = BACKFILLED
    - joinTargetNode($temp, $temp-target, $temp-node)
    - joinTargetNode($index, $index-target, $index-node)
