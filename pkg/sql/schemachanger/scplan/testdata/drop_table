create-table
CREATE TABLE defaultdb.customers (id INT PRIMARY KEY, email STRING UNIQUE);
----

create-table
CREATE TABLE IF NOT EXISTS defaultdb.orders (
    id INT PRIMARY KEY,
    customer INT UNIQUE NOT NULL REFERENCES customers (id),
    orderTotal DECIMAL(9,2),
    INDEX (customer)
  );
----

create-sequence
CREATE SEQUENCE defaultdb.SQ2;
----

create-table
CREATE TABLE defaultdb.shipments (
    tracking_number UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    carrier STRING,
    status STRING,
    customer_id INT,
    randcol INT DEFAULT nextval('defaultdb.sq2'),
    CONSTRAINT fk_customers FOREIGN KEY (customer_id) REFERENCES customers(id),
    CONSTRAINT fk_orders FOREIGN KEY (customer_id) REFERENCES orders(customer)
  );
----

create-sequence
CREATE SEQUENCE defaultdb.SQ1 OWNED BY defaultdb.shipments.carrier
----

create-view
CREATE VIEW v1 as (select customer_id, carrier from defaultdb.shipments);
----

ops
DROP TABLE defaultdb.shipments CASCADE;
----
Stage 0
  *scop.MarkDescriptorAsDroppedSynthetically
    DescID: 55
  *scop.MakeDroppedColumnDeleteAndWriteOnly
    ColumnID: 1
    TableID: 55
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      column:
        columnId: 1
        defaultExpr: gen_random_uuid()
        familyName: primary
        pgAttributeNum: 1
        tableId: 55
        type:
          family: UuidFamily
          oid: 2950
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.MakeDroppedColumnDeleteAndWriteOnly
    ColumnID: 2
    TableID: 55
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      column:
        columnId: 2
        familyName: primary
        nullable: true
        pgAttributeNum: 2
        tableId: 55
        type:
          family: StringFamily
          oid: 25
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.MakeDroppedColumnDeleteAndWriteOnly
    ColumnID: 3
    TableID: 55
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      column:
        columnId: 3
        familyName: primary
        nullable: true
        pgAttributeNum: 3
        tableId: 55
        type:
          family: StringFamily
          oid: 25
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.MakeDroppedColumnDeleteAndWriteOnly
    ColumnID: 4
    TableID: 55
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      column:
        columnId: 4
        familyName: primary
        nullable: true
        pgAttributeNum: 4
        tableId: 55
        type:
          family: IntFamily
          oid: 20
          width: 64
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.MakeDroppedColumnDeleteAndWriteOnly
    ColumnID: 5
    TableID: 55
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      column:
        columnId: 5
        defaultExpr: nextval(54:::REGCLASS)
        familyName: primary
        nullable: true
        pgAttributeNum: 5
        tableId: 55
        type:
          family: IntFamily
          oid: 20
          width: 64
        usesSequenceIds:
        - 54
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.MakeDroppedPrimaryIndexDeleteAndWriteOnly
    IndexID: 1
    TableID: 55
  *scop.MarkDescriptorAsDroppedSynthetically
    DescID: 57
Stage 1
  *scop.DrainDescriptorName
    TableID: 55
  *scop.DrainDescriptorName
    TableID: 57
Stage 2 (non-revertible)
  *scop.MarkDescriptorAsDropped
    DescID: 55
  *scop.RemoveColumnDefaultExpression
    ColumnID: 1
    TableID: 55
  *scop.UpdateRelationDeps
    TableID: 55
  *scop.RemoveColumnDefaultExpression
    ColumnID: 5
    TableID: 55
  *scop.UpdateRelationDeps
    TableID: 55
  *scop.DropForeignKeyRef
    Name: fk_customers
    Outbound: true
    TableID: 55
  *scop.DropForeignKeyRef
    Name: fk_orders
    Outbound: true
    TableID: 55
  *scop.MarkDescriptorAsDropped
    DescID: 57
  *scop.RemoveRelationDependedOnBy
    DependedOnBy: 57
    TableID: 55
  *scop.MakeDroppedColumnDeleteOnly
    ColumnID: 1
    TableID: 55
  *scop.MakeDroppedColumnDeleteOnly
    ColumnID: 2
    TableID: 55
  *scop.RemoveSequenceOwnedBy
    TableID: 56
  *scop.MakeDroppedColumnDeleteOnly
    ColumnID: 3
    TableID: 55
  *scop.MakeDroppedColumnDeleteOnly
    ColumnID: 4
    TableID: 55
  *scop.MakeDroppedColumnDeleteOnly
    ColumnID: 5
    TableID: 55
  *scop.RemoveRelationDependedOnBy
    DependedOnBy: 55
    TableID: 54
  *scop.MakeDroppedIndexDeleteOnly
    IndexID: 1
    TableID: 55
Stage 3 (non-revertible)
  *scop.LogEvent
    DescID: 55
    Direction: 2
    Element:
      table:
        tableId: 55
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 1
        SubWorkID: 1
      Username: root
  *scop.CreateGcJobForDescriptor
    DescID: 55
  *scop.MakeColumnAbsent
    ColumnID: 1
    TableID: 55
  *scop.MakeColumnAbsent
    ColumnID: 2
    TableID: 55
  *scop.MakeColumnAbsent
    ColumnID: 3
    TableID: 55
  *scop.MakeColumnAbsent
    ColumnID: 4
    TableID: 55
  *scop.MakeColumnAbsent
    ColumnID: 5
    TableID: 55
  *scop.MakeIndexAbsent
    IndexID: 1
    TableID: 55
  *scop.LogEvent
    DescID: 57
    Direction: 2
    Element:
      view:
        tableId: 57
    Metadata:
      Statement: DROP TABLE defaultdb.shipments CASCADE
      TargetMetadata:
        SourceElementID: 2
        SubWorkID: 1
      Username: root
  *scop.CreateGcJobForDescriptor
    DescID: 57

deps
DROP TABLE defaultdb.shipments CASCADE;
----
- from: [DefaultExpression:{DescID: 55, ColumnID: 1}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [DefaultExpression:{DescID: 55, ColumnID: 5}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [ForeignKey:{DescID: 55, ReferencedDescID: 52, Name: fk_customers}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [ForeignKey:{DescID: 55, ReferencedDescID: 53, Name: fk_orders}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [Namespace:{DescID: 55, Name: shipments}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [Namespace:{DescID: 57, Name: v1}, ABSENT]
  to:   [View:{DescID: 57}, DROPPED]
- from: [RelationDependedOnBy:{DescID: 54, ReferencedDescID: 55}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [RelationDependedOnBy:{DescID: 55, ReferencedDescID: 57}, ABSENT]
  to:   [Table:{DescID: 55}, DROPPED]
- from: [RelationDependedOnBy:{DescID: 55, ReferencedDescID: 57}, ABSENT]
  to:   [View:{DescID: 57}, DROPPED]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [DefaultExpression:{DescID: 55, ColumnID: 1}, ABSENT]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [DefaultExpression:{DescID: 55, ColumnID: 5}, ABSENT]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [ForeignKey:{DescID: 55, ReferencedDescID: 52, Name: fk_customers}, ABSENT]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [ForeignKey:{DescID: 55, ReferencedDescID: 53, Name: fk_orders}, ABSENT]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [Namespace:{DescID: 55, Name: shipments}, ABSENT]
- from: [Table:{DescID: 55}, ABSENT]
  to:   [RelationDependedOnBy:{DescID: 55, ReferencedDescID: 57}, ABSENT]
- from: [View:{DescID: 57}, ABSENT]
  to:   [Namespace:{DescID: 57, Name: v1}, ABSENT]
