# These tests are disabled until the new merge fixup is implemented.

# ----------------------------------------------------------------------
# Basic merge cases.
# ----------------------------------------------------------------------
load-index min-partition-size=2 max-partition-size=4 beam-size=2
• 1 [0, 0]
│
├───• 5 [7, 0]
│   │
│   ├───• vec6 [14, 1]
│   └───• vec9 [5, 2]
│
├───• 7 [0.6667, 6]
│   │
│   ├───• vec5 [3, 6]
│   ├───• vec3 [-2, 8]
│   └───• vec8 [1, 4]
│
└───• 6 [2.5, 8.5]
    │
    ├───• vec1 [0, -1]
    ├───• vec7 [0, 0]
    ├───• vec2 [3, 10]
    └───• vec4 [2, 7]
----
Loaded 9 vectors.

# Delete vectors from a partition, causing it to drop below min-partition-size.
delete
vec5
vec3
vec8
----
• 1 [0, 0]
│
├───• 5 [7, 0]
│   │
│   ├───• vec6 [14, 1]
│   └───• vec9 [5, 2]
│
└───• 6 [2.5, 8.5]
    │
    ├───• vec1 [0, -1]
    ├───• vec7 [0, 0]
    ├───• vec2 [3, 10]
    └───• vec4 [2, 7]

# Partition should still exist, but be empty and detached from its parent.
format-tree root=7
----
• 7 [0.6667, 6] (Merging)

# Delete all but one vector in a partition and expect it to be merged.
delete
vec6
----
• 1 [0, 0]
│
├───• 5 [7, 0]
│   │
│   └───• vec9 [5, 2]
│
└───• 6 [2.5, 8.5]
    │
    ├───• vec1 [0, -1]
    ├───• vec7 [0, 0]
    ├───• vec2 [3, 10]
    └───• vec4 [2, 7]

# Trigger partition merge (and then split).
search
[5, 2]
----
vec9: 0
5 leaf vectors, 7 vectors, 1 full vectors, 3 partitions

format-tree
----
• 1 [0, 0]
│
├───• 9 [2.5, 8.5]
│   │
│   ├───• vec4 [2, 7]
│   └───• vec2 [3, 10]
│
└───• 8 [1.6667, 0.3333]
    │
    ├───• vec1 [0, -1]
    ├───• vec7 [0, 0]
    └───• vec9 [5, 2]

# Delete all but one vector and ensure that only one partition remains.
delete
vec1
vec4
vec7
vec9
----
• 1 [0, 0]
│
└───• 8 [1.6667, 0.3333]
    │
    └───• vec2 [3, 10]

# ----------------------------------------------------------------------
# Test merge with dangling vectors.
# ----------------------------------------------------------------------
load-index min-partition-size=3 max-partition-size=6 beam-size=2
• 1 [0, 0]
│
├───• 5 [2.75, 8]
│   │
│   ├───• vec2 [3, 10]
│   ├───• vec4 [2, 7]
│   ├───• vec5 [3, 6]
│   └───• vec9 [3, 9]
│
├───• 3 [5, 0]
│   │
│   ├───• vec6 [10, 1]
│   └───• vec1 [0, -1]
│
└───• 4 [-0.5, 6]
    │
    ├───• vec7 [0, 0]
    ├───• vec8 [1, 4]
    └───• vec3 [-2, 8]
----
Loaded 9 vectors.

# Trigger merge when a partition contains only dangling vectors.
delete not-found
vec6
vec1
----
• 1 [0, 0]
│
├───• 5 [2.75, 8]
│   │
│   ├───• vec2 [3, 10]
│   ├───• vec4 [2, 7]
│   ├───• vec5 [3, 6]
│   └───• vec9 [3, 9]
│
├───• 3 [5, 0]
│   │
│   ├───• vec6 [MISSING]
│   └───• vec1 [MISSING]
│
└───• 4 [-0.5, 6]
    │
    ├───• vec7 [0, 0]
    ├───• vec8 [1, 4]
    └───• vec3 [-2, 8]

# Search will trigger merge of the partition containing only missing vectors.
search
[0, -1]
----
vec7: 1
5 leaf vectors, 8 vectors, 3 full vectors, 3 partitions

format-tree
----
• 1 [0, 0]
│
├───• 5 [2.75, 8]
│   │
│   ├───• vec2 [3, 10]
│   ├───• vec4 [2, 7]
│   ├───• vec5 [3, 6]
│   └───• vec9 [3, 9]
│
└───• 4 [-0.5, 6]
    │
    ├───• vec7 [0, 0]
    ├───• vec8 [1, 4]
    └───• vec3 [-2, 8]

# Repeat, but this time merge with both a missing and a present vector.
delete
vec7
----
• 1 [0, 0]
│
├───• 5 [2.75, 8]
│   │
│   ├───• vec2 [3, 10]
│   ├───• vec4 [2, 7]
│   ├───• vec5 [3, 6]
│   └───• vec9 [3, 9]
│
└───• 4 [-0.5, 6]
    │
    ├───• vec3 [-2, 8]
    └───• vec8 [1, 4]

delete not-found
vec8
----
• 1 [0, 0]
│
├───• 5 [2.75, 8]
│   │
│   ├───• vec2 [3, 10]
│   ├───• vec4 [2, 7]
│   ├───• vec5 [3, 6]
│   └───• vec9 [3, 9]
│
└───• 4 [-0.5, 6]
    │
    ├───• vec3 [-2, 8]
    └───• vec8 [MISSING]

search
[-2, 8]
----
vec3: 0
6 leaf vectors, 8 vectors, 2 full vectors, 3 partitions

format-tree
----
• 1 [0, 0]
│
└───• 5 [2.75, 8]
    │
    ├───• vec2 [3, 10]
    ├───• vec4 [2, 7]
    ├───• vec5 [3, 6]
    ├───• vec9 [3, 9]
    └───• vec3 [-2, 8]

# ----------------------------------------------------------------------
# Delete all vectors and expect tree to be merged into three levels of
# empty partitions (because we don't yet implement removing levels).
# ----------------------------------------------------------------------
load-index min-partition-size=2 max-partition-size=4 beam-size=3
• 1 [4.625, 5]
│
├───• 2 [8.5, 5]
│   │
│   ├───• vec6 [14, 1]
│   ├───• vec2 [3, 9]
│   └───• vec9 [5, 2]
│
├───• 4 [0, -0.5]
│   │
│   ├───• vec7 [0, 0]
│   └───• vec1 [0, -1]
│
└───• 5 [1, 6.25]
    │
    ├───• vec5 [3, 6]
    ├───• vec4 [2, 7]
    ├───• vec3 [-2, 8]
    └───• vec8 [1, 4]
----
Loaded 9 vectors.

insert
vec10: [3, 6]
vec11: [2, 10]
vec12: [6, 8]
vec13: [4, 6]
vec14: [2, 7]
vec15: [3, 7]
vec16: [3, 8]
vec17: [3, 5]
vec18: [6, 6]
----
• 1 [4.625, 5]
│
├───• 21 [1.5, 8.75]
│   │
│   ├───• 11 [0, 9]
│   │   │
│   │   ├───• vec3 [-2, 8]
│   │   └───• vec11 [2, 10]
│   │
│   └───• 18 [3, 8.5]
│       │
│       ├───• vec2 [3, 9]
│       └───• vec16 [3, 8]
│
├───• 23 [1, 2.25]
│   │
│   ├───• 15 [2, 5]
│   │   │
│   │   ├───• vec17 [3, 5]
│   │   └───• vec8 [1, 4]
│   │
│   └───• 4 [0, -0.5]
│       │
│       ├───• vec7 [0, 0]
│       └───• vec1 [0, -1]
│
└───• 22 [4.7083, 6.625]
    │
    ├───• 19 [2.3333, 7]
    │   │
    │   ├───• vec10 [3, 6]
    │   ├───• vec5 [3, 6]
    │   ├───• vec4 [2, 7]
    │   ├───• vec14 [2, 7]
    │   └───• vec15 [3, 7]
    │
    ├───• 13 [4.5, 7]
    │   │
    │   ├───• vec13 [4, 6]
    │   ├───• vec18 [6, 6]
    │   └───• vec12 [6, 8]
    │
    ├───• 2 [8.5, 5]
    │   │
    │   ├───• vec6 [14, 1]
    │   └───• vec9 [5, 2]
    │
    └───• 10 [3.5, 7.5] (Merging)

# Delete all vectors.
delete
vec1
vec2
vec3
vec4
vec5
vec6
vec7
vec8
vec9
vec10
vec11
vec12
vec13
vec14
vec15
vec16
vec17
vec18
----
• 1 [4.625, 5]
│
└───• 30 [3.25, 6.75]
    │
    └───• 29 [3, 7.5]

# Search for vector in empty tree with multiple levels.
search
[4, 5]
----
0 leaf vectors, 2 vectors, 0 full vectors, 3 partitions

# ----------------------------------------------------------------------
# Merge of partition that's too large or not a child of the parent are no-ops.
# ----------------------------------------------------------------------
load-index min-partition-size=2 max-partition-size=8 beam-size=2
• 1 [0, 0]
│
├───• 2 [0.6667, 1.3333]
│   │
│   ├───• vec1 [0, -1]
│   ├───• vec4 [-2, 2]
│   └───• vec3 [4, 3]
│
└───• 3 [2, 7]
    │
    ├───• vec2 [3, 9]
    └───• vec5 [1, 5]
----
Loaded 5 vectors.

# Partition #2 is too large to merge, so no-op.
force-merge partition-key=2 parent-partition-key=1
----
• 1 [0, 0]
│
├───• 2 [0.6667, 1.3333]
│   │
│   ├───• vec1 [0, -1]
│   ├───• vec4 [-2, 2]
│   └───• vec3 [4, 3]
│
└───• 3 [2, 7]
    │
    ├───• vec2 [3, 9]
    └───• vec5 [1, 5]

# Partition #3 won't get removed because its parent is not partition #2.
force-merge partition-key=3 parent-partition-key=2
----
• 1 [0, 0]
│
├───• 2 [0.6667, 1.3333]
│   │
│   ├───• vec1 [0, -1]
│   ├───• vec4 [-2, 2]
│   ├───• vec3 [4, 3]
│   ├───• vec2 [3, 9]
│   └───• vec5 [1, 5]
│
└───• 3 [2, 7] (Merging)

# Partition #3 won't get removed because the parent does not exist.
force-merge partition-key=3 parent-partition-key=99
----
• 1 [0, 0]
│
├───• 2 [0.6667, 1.3333]
│   │
│   ├───• vec1 [0, -1]
│   ├───• vec4 [-2, 2]
│   ├───• vec3 [4, 3]
│   ├───• vec2 [3, 9]
│   └───• vec5 [1, 5]
│
└───• 3 [2, 7] (Merging)
