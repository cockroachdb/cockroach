exec-ddl
CREATE TABLE t (a int)
----

# copy quote without CSV not allowed.
copy-from-error
COPY t FROM STDIN QUOTE '"'
----
ERROR: QUOTE only supported with CSV format (SQLSTATE 0A000)

copy-from-error
COPY t FROM STDIN QUOTE 'x'
----
ERROR: QUOTE only supported with CSV format (SQLSTATE 0A000)

# builtins not allowed
copy-from-error
COPY t FROM STDIN
random()
----
ERROR: could not parse "random()" as type int: strconv.ParseInt: parsing "random()": invalid syntax (SQLSTATE 22P02)

copy-from
COPY t FROM STDIN QUOTE '"' CSV
----
0

copy-from
COPY t FROM STDIN
1
----
1

copy-from
COPY t FROM STDIN
1
2
----
2

query
SELECT * FROM t
----
1
1
2

exec-ddl
CREATE TABLE t2 (i INT, d DATE, dec DECIMAL, t TIMESTAMP)
----

copy-from
COPY t2 FROM STDIN
1	1996-03-13	12.123	2016-01-25 10:10:10.555555
----
1

query
SELECT i,dec FROM t2
----
1|12.123

copy-from-error
COPY t2 FROM STDIN
a	1996-03-13	12.123	2016-01-25 10:10:10.555555
----
ERROR: could not parse "a" as type int: strconv.ParseInt: parsing "a": invalid syntax (SQLSTATE 22P02)

copy-from-error
COPY t2 FROM STDIN
1	2	12.123	2016-01-25 10:10:10.555555
----
ERROR: parsing as type date: missing required date fields (SQLSTATE 22007)

copy-from-error
COPY t2 FROM STDIN
1	1996-03-13	not a decimal	2016-01-25 10:10:10.555555
----
ERROR: could not parse "not a decimal" as type decimal: parse exponent: cimal: strconv.ParseInt: parsing "cimal": invalid syntax (SQLSTATE 22P02)

copy-from-error
COPY t2 FROM STDIN
1	1996-03-13	12.123	not a timestamp
----
ERROR: parsing as type timestamp: could not parse "not a timestamp" (SQLSTATE 22007)

copy-from-error
COPY t2 FROM STDIN
1	1996-03-13	12.123
----
ERROR: expected 4 values, got 3 (SQLSTATE 22P04)

copy-from-error
COPY t2 FROM STDIN
1	1996-03-13	12.123	2016-01-25 10:10:10.555555	extra col
----
ERROR: expected 4 values, got 5 (SQLSTATE 22P04)

# now is allowed
copy-from
COPY t2 FROM STDIN
2	1996-03-13	12.123	now
----
1

# now is allowed
copy-from
COPY t2 FROM STDIN
3	1996-03-13	12.123	now()
----
1

# expressions are not allowed
copy-from-error
COPY t2 FROM STDIN
2	1996-03-13	12.123	now()-1
----
ERROR: parsing as type timestamp: could not parse "now()-1" (SQLSTATE 22007)

query
SELECT count(t) FROM t2 WHERE t > now()
----
0

copy-from
COPY t2 FROM STDIN
\N	\N	\N	\N
----
1

copy-from-error
COPY t2 FROM STDIN WITH DESTINATION = 'foo.csv'
\N	\N	\N	\N
----
ERROR: DESTINATION can only be specified when table is external storage table (SQLSTATE 0A000)

#subtest constraints

exec-ddl
CREATE TABLE t3 (i INT CHECK (i > 0))
----

copy-from-error
COPY t3 FROM STDIN
0
----
ERROR: failed to satisfy CHECK constraint (i > 0:::INT8) (SQLSTATE 23514)


# Foreign key checks happen
exec-ddl
CREATE TABLE parent (k INT PRIMARY KEY);
CREATE TABLE child (k INT PRIMARY KEY REFERENCES parent)
----

copy-from-error
COPY child FROM STDIN
1
----
ERROR: insert on table "child" violates foreign key constraint "child_k_fkey" (SQLSTATE 23503)

exec-ddl
CREATE TABLE t4 (i INT UNIQUE)
----

copy-from-error
COPY t4 FROM STDIN
1
1
----
ERROR: duplicate key value violates unique constraint "t4_i_key" (SQLSTATE 23505)

#subtest defaults
# Default column values tests

exec-ddl
CREATE table tdefaults (i INT PRIMARY KEY DEFAULT unique_rowid(), d INT NOT NULL
DEFAULT -1, x INT)
----

copy-from
COPY tdefaults(x) FROM STDIN
1
----
1

copy-from
COPY tdefaults(x,d) FROM STDIN
1	2
----
1

copy-from
COPY tdefaults FROM STDIN
1	1	1
----
1

query
SELECT d,x FROM tdefaults
----
1|1
-1|1
2|1


#subtest array_decoding

exec-ddl
CREATE TABLE test_copy_array (id INT PRIMARY KEY, data TEXT[])
----

copy-from
COPY test_copy_array(id,data) FROM STDIN
1	{}
2	{}
3	{}
4	{}
5	{}
6	{}
7	{}
8	{\b}
9	{"\t"}
10	{"\n"}
11	{"\v"}
12	{"\f"}
13	{"\r"}
14	{}
15	{}
16	{}
17	{}
18	{}
19	{}
20	{}
21	{}
22	{}
23	{}
24	{}
25	{}
26	{}
27	{}
28	{}
29	{}
30	{}
31	{}
32	{" "}
33	{!}
34	{"\\""}
35	{#}
36	{$}
37	{%}
38	{&}
39	{'}
40	{(}
41	{)}
42	{*}
43	{+}
44	{","}
45	{-}
46	{.}
47	{/}
48	{0}
49	{1}
50	{2}
51	{3}
52	{4}
53	{5}
54	{6}
55	{7}
56	{8}
57	{9}
58	{:}
59	{;}
60	{<}
61	{=}
62	{>}
63	{?}
64	{@}
65	{A}
66	{B}
67	{C}
68	{D}
69	{E}
70	{F}
71	{G}
72	{H}
73	{I}
74	{J}
75	{K}
76	{L}
77	{M}
78	{N}
79	{O}
80	{P}
81	{Q}
82	{R}
83	{S}
84	{T}
85	{U}
86	{V}
87	{W}
88	{X}
89	{Y}
90	{Z}
91	{[}
92	{"\\\\"}
93	{]}
94	{^}
95	{_}
96	{`}
97	{a}
98	{b}
99	{c}
100	{d}
101	{e}
102	{f}
103	{g}
104	{h}
105	{i}
106	{j}
107	{k}
108	{l}
109	{m}
110	{n}
111	{o}
112	{p}
113	{q}
114	{r}
115	{s}
116	{t}
117	{u}
118	{v}
119	{w}
120	{x}
121	{y}
122	{z}
123	{"{"}
124	{|}
125	{"}"}
126	{~}
127	{}
128	{Â€}
129	{Â}
130	{Â‚}
131	{Âƒ}
132	{Â„}
133	{Â…}
134	{Â†}
135	{Â‡}
136	{Âˆ}
137	{Â‰}
138	{ÂŠ}
139	{Â‹}
140	{ÂŒ}
141	{Â}
142	{Â}
143	{Â}
144	{Â}
145	{Â‘}
146	{Â’}
147	{Â“}
148	{Â”}
149	{Â•}
150	{Â–}
151	{Â—}
152	{Â˜}
153	{Â™}
154	{Âš}
155	{Â›}
156	{Âœ}
157	{Â}
158	{Â}
159	{ÂŸ}
160	{Â }
161	{Â¡}
162	{Â¢}
163	{Â£}
164	{Â¤}
165	{Â¥}
166	{Â¦}
167	{Â§}
168	{Â¨}
169	{Â©}
170	{Âª}
171	{Â«}
172	{Â¬}
173	{Â­}
174	{Â®}
175	{Â¯}
176	{Â°}
177	{Â±}
178	{Â²}
179	{Â³}
180	{Â´}
181	{Âµ}
182	{Â¶}
183	{Â·}
184	{Â¸}
185	{Â¹}
186	{Âº}
187	{Â»}
188	{Â¼}
189	{Â½}
190	{Â¾}
191	{Â¿}
192	{Ã€}
193	{Ã}
194	{Ã‚}
195	{Ãƒ}
196	{Ã„}
197	{Ã…}
198	{Ã†}
199	{Ã‡}
200	{Ãˆ}
201	{Ã‰}
202	{ÃŠ}
203	{Ã‹}
204	{ÃŒ}
205	{Ã}
206	{Ã}
207	{Ã}
208	{Ã}
209	{Ã‘}
210	{Ã’}
211	{Ã“}
212	{Ã”}
213	{Ã•}
214	{Ã–}
215	{Ã—}
216	{Ã˜}
217	{Ã™}
218	{Ãš}
219	{Ã›}
220	{Ãœ}
221	{Ã}
222	{Ã}
223	{ÃŸ}
224	{Ã }
225	{Ã¡}
226	{Ã¢}
227	{Ã£}
228	{Ã¤}
229	{Ã¥}
230	{Ã¦}
231	{Ã§}
232	{Ã¨}
233	{Ã©}
234	{Ãª}
235	{Ã«}
236	{Ã¬}
237	{Ã­}
238	{Ã®}
239	{Ã¯}
240	{Ã°}
241	{Ã±}
242	{Ã²}
243	{Ã³}
244	{Ã´}
245	{Ãµ}
246	{Ã¶}
247	{Ã·}
248	{Ã¸}
249	{Ã¹}
250	{Ãº}
251	{Ã»}
252	{Ã¼}
253	{Ã½}
254	{Ã¾}
255	{Ã¿}
----
255

query
SELECT id, data AS got, array[chr(id)] AS want FROM test_copy_array WHERE data != ARRAY[chr(id)]
----

# Regression test for #87011
exec-ddl
CREATE TABLE tab (
  col1 STRING,
  col2 STRING,
  col3 STRING,
  col4 STRING,
  col5 STRING,
  col6 STRING NOT NULL, index(col5) where col3 like '%ride%', index ((col2 || col3)),
  PRIMARY KEY (col1, col2, col3, col4, col5) using hash,
  UNIQUE (col5, col6)
);
CREATE TABLE tab_child (
  col1 STRING,
  col2 STRING,
  col3 STRING,
  col4 STRING,
  col5 STRING,
  col6 STRING NOT NULL, index(col5) where col3 like '%ride%', index ((col2 || col3)),
  PRIMARY KEY (col1, col2, col3, col4, col5) using hash,
  FOREIGN KEY (col5, col6) REFERENCES tab (col5, col6)
)
----

copy-from-error
COPY tab_child FROM STDIN
'high'	'straight'	'writer'	'develop'	'shells'	'bean'
'basic'	'tent'	'compound'	'it'	'future'	'held'
'bite'	'bring'	'taught'	'world'	'themselves'	'airplane'
'island'	'number'	'has'	'blow'	'prize'	'cookies'
'hole'	'wear'	'way'	'troops'	'eye'	'sure'
'thick'	'joy'	'impossible'	'area'	'ordinary'	'piano'
'grabbed'	'reader'	'number'	'serve'	'fill'	'wonderful'
'tower'	'former'	'mainly'	'point'	'class'	'idea'
----
ERROR: insert on table "tab_child" violates foreign key constraint "tab_child_col5_col6_fkey" (SQLSTATE 23503)
