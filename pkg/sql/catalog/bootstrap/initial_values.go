// Copyright 2022 The Cockroach Authors.
//
// Use of this software is governed by the Business Source License
// included in the file licenses/BSL.txt.
//
// As of the Change Date specified in that file, in accordance with
// the Business Source License, use of this software will be governed
// by the Apache License, Version 2.0, included in the file
// licenses/APL.txt.

package bootstrap

import (
	"bytes"
	"crypto/sha256"
	_ "embed"
	"encoding/hex"
	"sort"
	"strings"

	"github.com/cockroachdb/cockroach/pkg/clusterversion"
	"github.com/cockroachdb/cockroach/pkg/config/zonepb"
	"github.com/cockroachdb/cockroach/pkg/keys"
	"github.com/cockroachdb/cockroach/pkg/roachpb"
	"github.com/cockroachdb/errors"
)

// InitialValuesOpts is used to get initial values for system/secondary tenants
// and allows overriding initial values with ones from previous releases.
type InitialValuesOpts struct {
	DefaultZoneConfig       *zonepb.ZoneConfig
	DefaultSystemZoneConfig *zonepb.ZoneConfig
	OverrideKey             clusterversion.Key
	Codec                   keys.SQLCodec
}

// GenerateInitialValues generates the initial values with which to bootstrap a
// new cluster. This generates the values assuming a cluster version equal to
// the latest binary, unless explicitly overridden.
func (opts InitialValuesOpts) GenerateInitialValues() ([]roachpb.KeyValue, []roachpb.RKey, error) {
	versionKey := clusterversion.BinaryVersionKey
	if opts.OverrideKey != 0 {
		versionKey = opts.OverrideKey
	}
	f, ok := initialValuesFactoryByKey[versionKey]
	if !ok {
		return nil, nil, errors.Newf("unsupported version %q", versionKey)
	}
	return f(opts)
}

// VersionsWithInitialValues returns all the versions which can be used for
// InitialValuesOpts.OverrideKey, in descending order; the first one is always
// the current version.
func VersionsWithInitialValues() []clusterversion.Key {
	res := make([]clusterversion.Key, 0, len(initialValuesFactoryByKey))
	for k := range initialValuesFactoryByKey {
		res = append(res, k)
	}
	sort.Slice(res, func(i, j int) bool {
		return res[i] > res[j]
	})
	return res
}

type initialValuesFactoryFn = func(opts InitialValuesOpts) (
	kvs []roachpb.KeyValue, splits []roachpb.RKey, _ error,
)

var initialValuesFactoryByKey = map[clusterversion.Key]initialValuesFactoryFn{
	clusterversion.Latest: buildLatestInitialValues,
	clusterversion.V23_2: hardCodedInitialValues{
		system:        system232,
		systemHash:    system232SHA256,
		nonSystem:     nonSystem232,
		nonSystemHash: nonSystem232SHA256,
	}.build,
	clusterversion.V23_1: hardCodedInitialValues{
		system:        system231,
		systemHash:    system231SHA256,
		nonSystem:     nonSystem231,
		nonSystemHash: nonSystem231SHA256,
	}.build,
}

// buildLatestInitialValues is the default initial value factory.
func buildLatestInitialValues(
	opts InitialValuesOpts,
) (kvs []roachpb.KeyValue, splits []roachpb.RKey, _ error) {
	schema := MakeMetadataSchema(opts.Codec, opts.DefaultZoneConfig, opts.DefaultSystemZoneConfig)
	kvs, splits = schema.GetInitialValues()
	return kvs, splits, nil
}

// hardCodedInitialValues defines an initialValuesFactoryFn using
// hard-coded values.
type hardCodedInitialValues struct {
	system, systemHash, nonSystem, nonSystemHash string
}

// build implements initialValuesFactoryFn for hardCodedInitialValues.
func (f hardCodedInitialValues) build(
	opts InitialValuesOpts,
) (kvs []roachpb.KeyValue, splits []roachpb.RKey, err error) {
	defer func() {
		err = errors.Wrapf(err, "error making initial values for tenant %s", opts.Codec.TenantPrefix())
	}()
	input, expectedHash := f.system, f.systemHash
	if !opts.Codec.ForSystemTenant() {
		input, expectedHash = f.nonSystem, f.nonSystemHash
	}
	input = strings.TrimSpace(input)
	expectedHash = strings.TrimSpace(expectedHash)
	h := sha256.Sum256([]byte(input))
	if actualHash := hex.EncodeToString(h[:]); actualHash != expectedHash {
		return nil, nil, errors.AssertionFailedf("expected %s, got %s", expectedHash, actualHash)
	}
	var initialKVs []roachpb.KeyValue
	initialKVs, splits, err = InitialValuesFromString(opts.Codec, input)
	if err != nil {
		return nil, nil, err
	}
	// Replace system.zones entries.
	kvs = InitialZoneConfigKVs(opts.Codec, opts.DefaultZoneConfig, opts.DefaultSystemZoneConfig)
	zonesTablePrefix := opts.Codec.TablePrefix(keys.ZonesTableID)
	for _, kv := range initialKVs {
		if !bytes.Equal(zonesTablePrefix, kv.Key[:len(zonesTablePrefix)]) {
			kvs = append(kvs, kv)
		}
	}
	sort.Sort(roachpb.KeyValueByKey(kvs))
	return kvs, splits, nil
}

var (
	// system231 is the hard-coded string representation of the
	// initial values for a system tenant as produced by the 23.1
	// release binary.
	//
	// This file was generated by copying over the expected results for the
	// TestInitialValuesToString test in the release-23.1 branch.
	//go:embed data/23_1_system.keys
	system231 string

	// system231SHA256 is the SHA-256 hash of the above constant.
	//go:embed data/23_1_system.sha256
	system231SHA256 string

	// nonSystem231 is the hard-coded string representation of the
	// initial values for a non-system tenant as produced by the 23.1
	// release binary.
	//
	// This file was generated by copying over the expected results for the
	// TestInitialValuesToString test in the release-23.1 branch.
	//go:embed data/23_1_tenant.keys
	nonSystem231 string

	// nonSystem231SHA256 is the SHA-256 hash of the above constant.
	//go:embed data/23_1_tenant.sha256
	nonSystem231SHA256 string

	// system232 is the hard-coded string representation of the
	// initial values for a system tenant as produced by the 23.2
	// release binary.
	//
	// This file was generated by copying over the expected results for the
	// TestInitialValuesToString test in the release-23.2 branch.
	//go:embed data/23_2_system.keys
	system232 string

	// system232SHA256 is the SHA-256 hash of the above constant.
	//go:embed data/23_2_system.sha256
	system232SHA256 string

	// nonSystem232 is the hard-coded string representation of the
	// initial values for a non-system tenant as produced by the 23.2
	// release binary.
	//
	// This file was generated by copying over the expected results for the
	// TestInitialValuesToString test in the release-23.2 branch.
	//go:embed data/23_2_tenant.keys
	nonSystem232 string

	// nonSystem232SHA256 is the SHA-256 hash of the above constant.
	//go:embed data/23_2_tenant.sha256
	nonSystem232SHA256 string
)
