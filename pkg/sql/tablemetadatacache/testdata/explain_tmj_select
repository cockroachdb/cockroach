explain-select-query
----
----
EXPLAIN (REDACT) 
WITH cte (n_id, n_name, "n_parentID", db_name, "n_parentSchemaID", schema_name, d) AS (
   SELECT
       n.id,
       n.name,
       n."parentID",
       db_name.name,
       n."parentSchemaID",
       schema_name.name,
       crdb_internal.pb_to_json('cockroach.sql.sqlbase.Descriptor', enc_desc.descriptor)
   FROM system.namespace n
   JOIN system.descriptor enc_desc ON n.id = enc_desc.id
   JOIN system.namespace db_name ON n."parentID" = db_name.id AND db_name."parentID" = 0
   JOIN system.namespace schema_name ON n."parentSchemaID" = schema_name.id AND schema_name."parentID" = n."parentID"
   WHERE (n."parentID", n."parentSchemaID", n.name) > ($1, $2, $3)
     AND n."parentSchemaID" != 0
   ORDER BY n."parentID", n."parentSchemaID", n.name
   LIMIT $4
)
SELECT
    n_id AS id,
    n_name AS name,
    "n_parentID" AS "parentID",
    db_name,
    "n_parentSchemaID" AS "parentSchemaID",
    schema_name,
    json_array_length(d->'table' -> 'columns') as columns,
    COALESCE(json_array_length(d->'table' -> 'indexes'), 0) as indexes,
    CASE
        WHEN d->'table'->>'isMaterializedView' = 'true' THEN 'MATERIALIZED_VIEW'
        WHEN d->'table'->>'viewQuery' IS NOT NULL THEN 'VIEW'
        WHEN d->'table'->'sequenceOpts' IS NOT NULL THEN 'SEQUENCE'
        ELSE 'TABLE'
    END as table_type,
    (d->'table'->'autoStatsSettings'->>'enabled')::BOOL as auto_stats_enabled,
    (
        SELECT max("createdAt") as stats_last_updated
        FROM system.table_statistics
        WHERE "tableID" = n_id
        GROUP BY "tableID"
    ),
    crdb_internal.table_span(n_id) as span
FROM
    cte
AS OF SYSTEM TIME '-1us'

---
distribution: local

• render
│
└── • apply join (left outer)
    │
    ├── • render
    │   │
    │   └── • limit
    │       │ count: ‹×›
    │       │
    │       └── • lookup join
    │           │ table: descriptor@primary
    │           │ equality: (id) = (id)
    │           │ equality cols are key
    │           │
    │           └── • sort
    │               │ order: +"parentID",+"parentSchemaID",+name
    │               │
    │               └── • hash join
    │                   │ equality: (parentID, parentSchemaID) = (id, id)
    │                   │
    │                   ├── • filter
    │                   │   │ filter: "parentSchemaID" != ‹×›
    │                   │   │
    │                   │   └── • scan
    │                   │         missing stats
    │                   │         table: namespace@primary
    │                   │         spans: 1 span
    │                   │
    │                   └── • lookup join
    │                       │ table: namespace@primary
    │                       │ equality: (id) = (parentID)
    │                       │ pred: id != ‹×›
    │                       │
    │                       └── • scan
    │                             missing stats
    │                             table: namespace@primary
    │                             spans: 1 span
    │
    └── • inner loop (unoptimized)
        │
        └── • group-by (streaming)
               ├── select
               │    ├── scan table_statistics
               │    └── filters
               │         └── tableID = n_id
               └── aggregations
                    └── max
                         └── createdAt
----
----
