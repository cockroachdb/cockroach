# This test verifies that the Parse/Bind/Describe/Execute protocol works with
# prepared statements created with SQL-level PREPARE (so therefore must be
# run with the EXECUTE statement).

send
Query {"String": "DROP TABLE IF EXISTS t0;"}
Query {"String": "CREATE TABLE t0(c0 INT8);"}
----

until ignore=NoticeResponse
ReadyForQuery
ReadyForQuery
----
{"Type":"CommandComplete","CommandTag":"DROP TABLE"}
{"Type":"ReadyForQuery","TxStatus":"I"}
{"Type":"CommandComplete","CommandTag":"CREATE TABLE"}
{"Type":"ReadyForQuery","TxStatus":"I"}

# Prepare INSERT statement with a SQL-level PREPARE.
send
Query {"String": "PREPARE insert_query (int8) AS INSERT INTO t0 VALUES ($1);"}
----

until
ReadyForQuery
----
{"Type":"CommandComplete","CommandTag":"PREPARE"}
{"Type":"ReadyForQuery","TxStatus":"I"}

# Execute INSERT statement using Parse/Bind/Describe/Execute protocol. The
# Describe should return NoData, since INSERT doesn't return rows.
send
Parse {"Name": "insert_query_stmt", "Query": "EXECUTE insert_query(1)"}
Bind {"DestinationPortal": "insert_query_portal", "PreparedStatement": "insert_query_stmt"}
Describe {"ObjectType": "P", "Name": "insert_query_portal"}
Execute {"Portal": "insert_query_portal"}
Sync
----

until ignore_table_oids
ReadyForQuery
----
{"Type":"ParseComplete"}
{"Type":"BindComplete"}
{"Type":"NoData"}
{"Type":"CommandComplete","CommandTag":"INSERT 0 1"}
{"Type":"ReadyForQuery","TxStatus":"I"}

# Prepare SELECT statement with a SQL-level PREPARE.
send
Query {"String": "PREPARE select_query (int8) AS SELECT * FROM t0 WHERE c0 = $1;"}
----

until
ReadyForQuery
----
{"Type":"CommandComplete","CommandTag":"PREPARE"}
{"Type":"ReadyForQuery","TxStatus":"I"}

# Execute SELECT statement using Parse/Bind/Describe/Execute protocol. The
# Describe should return a RowDescription, since SELECT returns rows.
send
Parse {"Name": "select_query_stmt", "Query": "EXECUTE select_query(1)"}
Bind {"DestinationPortal": "select_query_portal", "PreparedStatement": "select_query_stmt"}
Describe {"ObjectType": "P", "Name": "select_query_portal"}
Execute {"Portal": "select_query_portal"}
Sync
----

until ignore_table_oids
ReadyForQuery
----
{"Type":"ParseComplete"}
{"Type":"BindComplete"}
{"Type":"RowDescription","Fields":[{"Name":"c0","TableOID":0,"TableAttributeNumber":1,"DataTypeOID":20,"DataTypeSize":8,"TypeModifier":-1,"Format":0}]}
{"Type":"DataRow","Values":[{"text":"1"}]}
{"Type":"CommandComplete","CommandTag":"SELECT 1"}
{"Type":"ReadyForQuery","TxStatus":"I"}
