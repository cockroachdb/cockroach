# Verify system-identity to database-user substitutions.

config secure
----


# Set HBA to empty in case it wasn't done before.
set_hba
----
----
# Active authentication configuration on this node:
# Original configuration:
# host  all root all cert-password # CockroachDB mandatory rule
# host  all all  all cert-password map=cockroach-default # built-in CockroachDB default
# local all all      password      map=cockroach-default # built-in CockroachDB default
#
# Interpreted configuration:
# TYPE DATABASE USER ADDRESS METHOD        OPTIONS
host   all      root all     cert-password
host   all      all  all     cert-password map=cockroach-default
local  all      all          password      map=cockroach-default


# Active identity mapping on this node:
# (empty configuration)
----
----

set_identity_map
cockroach-default testuser carl               # Exact remapping
cockroach-default /(.*)@cockroachlabs.com \1  # Generalized domain mapping
cockroach-default testuser another_carl       # Verify first-one-wins
----
----
# Active authentication configuration on this node:
# Original configuration:
# host  all root all cert-password # CockroachDB mandatory rule
# host  all all  all cert-password map=cockroach-default # built-in CockroachDB default
# local all all      password      map=cockroach-default # built-in CockroachDB default
#
# Interpreted configuration:
# TYPE DATABASE USER ADDRESS METHOD        OPTIONS
host   all      root all     cert-password
host   all      all  all     cert-password map=cockroach-default
local  all      all          password      map=cockroach-default


# Active identity mapping on this node:
# Original configuration:
# cockroach-default testuser carl               # Exact remapping
# cockroach-default /(.*)@cockroachlabs.com \1  # Generalized domain mapping
# cockroach-default testuser another_carl       # Verify first-one-wins
# Active configuration:
# map-name        system-username        database-username
cockroach-default ^testuser$             carl
cockroach-default (.*)@cockroachlabs.com \1                # substituteAt=0
cockroach-default ^testuser$             another_carl
----
----

sql
CREATE USER carl WITH PASSWORD 'doggo';
----
ok


subtest password_still_works_with_db_username

# Sanity-check the database user
connect user=carl database=mydb password=doggo
----
ok mydb

subtest end


subtest password_with_remapped_user

connect user=carl@cockroachlabs.com database=mydb password=doggo
----
ok mydb

authlog 6
----
12 {"EventType":"client_authentication_info","Info":"HBA rule: host  all all  all cert-password map=cockroach-default # built-in CockroachDB default","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"carl@cockroachlabs.com"}
13 {"EventType":"client_authentication_info","Info":"remapped system-identity \"carl@cockroachlabs.com\" to database-username \"carl\"","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"carl@cockroachlabs.com"}
14 {"EventType":"client_authentication_info","Info":"no client certificate, proceeding with password authentication","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"carl@cockroachlabs.com"}
15 {"EventType":"client_authentication_ok","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"carl@cockroachlabs.com"}
16 {"Duration":"NNN","EventType":"client_session_end","InstanceID":1,"Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX"}
17 {"Duration":"NNN","EventType":"client_connection_end","InstanceID":1,"Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX"}

subtest end


# Connect as the magic "testuser" since that comes pre-equipped with a cert.
subtest certificate

connect user=testuser database=mydb
----
ok mydb

authlog 6
----
19 {"EventType":"client_authentication_info","Info":"HBA rule: host  all all  all cert-password map=cockroach-default # built-in CockroachDB default","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"testuser"}
20 {"EventType":"client_authentication_info","Info":"remapped system-identity \"testuser\" to database-username \"carl\"","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"testuser"}
21 {"EventType":"client_authentication_info","Info":"client presented certificate, proceeding with certificate validation","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"testuser"}
22 {"EventType":"client_authentication_ok","InstanceID":1,"Method":"cert-password","Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX","Transport":"hostssl","User":"testuser"}
23 {"Duration":"NNN","EventType":"client_session_end","InstanceID":1,"Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX"}
24 {"Duration":"NNN","EventType":"client_connection_end","InstanceID":1,"Network":"tcp","RemoteAddress":"XXX","Timestamp":"XXX"}

subtest end

# Clean up

set_identity_map
----
----
# Active authentication configuration on this node:
# Original configuration:
# host  all root all cert-password # CockroachDB mandatory rule
# host  all all  all cert-password map=cockroach-default # built-in CockroachDB default
# local all all      password      map=cockroach-default # built-in CockroachDB default
#
# Interpreted configuration:
# TYPE DATABASE USER ADDRESS METHOD        OPTIONS
host   all      root all     cert-password
host   all      all  all     cert-password map=cockroach-default
local  all      all          password      map=cockroach-default


# Active identity mapping on this node:
# (empty configuration)
----
----
