# Copyright 2017 The Cockroach Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http:#www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing
# permissions and limitations under the License.
#

# This file extracts inline help specifications from the grammar file
# (sql.y) into a Go map[string]HelpMessageBody suitable for building
# messages towards clients.
#
# See README.md for details.

BEGIN {
    inhelp = 0
    instring = 0
    helpkey = ""
    print "// Code generated by help.awk. DO NOT EDIT."
    print "// GENERATED FILE DO NOT EDIT"
    print
    print "package parser"
    print
    print "var helpMessages = map[string]HelpMessageBody{"
}

/^\/\/ %Help:/ && inhelp == 1 { printf "%d: unexpected: %s (last: %s)", NR, $0, helpkey >"/dev/stderr";    exit 1 }

/^\/\/ %Help:/ && inhelp == 0 {
    inhelp = 1
    instring = 0
    helprest = substr($0, index($0, ":")+1)
    sub("^[ \t]*", "", helprest)
    helpkey = helprest
    summary = ""
    has_summary = index(helprest, "-")
    if (has_summary > 0) {
	summary = substr(helprest, has_summary+1)
	sub("^[ \t]*", "", summary)
	helpkey = substr(helprest, 1, has_summary-1)
    }
    sub("[ \t]*$", "", helpkey)
    print "  //line sql.y:", NR
    printf "  `%s`: {\n", helpkey
    if (summary != "") {
	printf "    ShortDescription: `%s`,\n", summary
    }
    next
}

/^\/\/ %/ && inhelp == 0 { printf "%d: unexpected: %s (last: %s)", NR, $0, helpkey >"/dev/stderr"; exit 1 }

/^\/\/ %Category:/ && inhelp == 1 {
    key = substr($0, index($0, ":")+1)
    sub("^[ \t]*", "", key)
    if (instring == 1) {
	print "`,"
    }
    print "    //line sql.y:", NR
    printf "    Category: h%s,\n", key
    instring = 0
    next
}

/^\/\/ %[^:]*:/ && inhelp == 1 {
    key = substr($0, index($0, "%")+1, index($0,":")-index($0, "%")-1)
    rest = substr($0, index($0, ":")+1)
    sub("^[ \t]*", "", rest)
    if (instring == 1) {
	print "`,"
    }
    print "    //line sql.y:", NR
    printf "    %s: `%s\n", key, rest
    instring = 1
    next
}

(/^[^/]/ || /^\/\/ %End/) && inhelp == 1 {
    if (instring == 1) {
	print "`,"
    }
    print "  },"
    inhelp = 0
    instring = 0
    next
}

/^\/\// && inhelp == 1 {
    print substr($0, 4)
    next
}

END {
    if (inhelp == 1) {
	printf "missing %% End (last: %s)\n", helpkey >"/dev/stderr"
	exit 1
    }
    print "}"
}
