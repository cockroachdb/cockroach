# This file contains telemetry tests for counters triggered by errors.

feature-allowlist
othererror.*
errorcodes.*
unimplemented.*
sql.schema.validation_errors.*
----

# Table descriptor validation failure on read.
feature-usage
CREATE DATABASE t;
CREATE TABLE t.test (k INT);
CREATE TABLE fktbl (id INT PRIMARY KEY);
CREATE TABLE tbl (customer INT NOT NULL REFERENCES fktbl (id));
INSERT INTO system.users VALUES ('node', NULL, true);
GRANT node TO root;
DELETE FROM system.descriptor WHERE id=52;
DELETE FROM system.descriptor WHERE id=54;
REVOKE node FROM root;
DELETE FROM system.users WHERE username = 'node';
SELECT * FROM tbl;
----
error: pq: relation "tbl" (55): invalid foreign key: missing table=54: referenced table ID 54: descriptor not found
errorcodes.XXUUU
othererror.XXUUU
sql.schema.validation_errors.read.cross_references.relation

# Type descriptor validation failure on read.
feature-usage
CREATE TYPE greeting AS ENUM('hello', 'hi');
INSERT INTO system.users VALUES ('node', NULL, true);
GRANT node TO root;
DELETE FROM system.descriptor WHERE id=57;
REVOKE node FROM root;
DELETE FROM system.users WHERE username = 'node';
SELECT 'hello'::greeting;
----
error: pq: type "greeting" (56): arrayTypeID 57 does not exist for "ENUM": referenced type ID 57: descriptor not found
errorcodes.XXUUU
othererror.XXUUU
sql.schema.validation_errors.read.cross_references.type

# Table descriptor validation failure on transaction commit.
feature-usage
CREATE TABLE t (x INT PRIMARY KEY);
BEGIN;
ALTER TABLE t DROP CONSTRAINT "primary";
COMMIT;
----
error: pq: relation "t" (58): unimplemented: primary key dropped without subsequent addition of new primary key in same transaction
errorcodes.0A000
sql.schema.validation_errors.write.pre_txn_commit.relation
unimplemented.#48026

# 42601 is pgcode.Syntax.
feature-usage
some non-parsing garbage
----
error: pq: at or near "some": syntax error
errorcodes.42601

feature-usage
SELECT crdb_internal.force_error('blah', 'foo')
----
error: pq: foo
errorcodes.blah

# XXUUU is pgcode.Uncategorized.
feature-usage
SELECT crdb_internal.force_error('', 'foo')
----
error: pq: foo
errorcodes.XXUUU
othererror.XXUUU

# XX000 is pgcode.Internal.
feature-usage
SELECT crdb_internal.force_assertion_error('woo')
----
error: pq: internal error: crdb_internal.force_assertion_error(): woo
errorcodes.XX000

# XXUUU is pgcode.Uncategorized.
feature-usage
SELECT crdb_internal.set_vmodule('invalid')
----
error: pq: crdb_internal.set_vmodule(): syntax error: expect comma-separated list of filename=N
errorcodes.XXUUU
othererror.XXUUU
othererror.XXUUU.crdb_internal.set_vmodule()

# 0A000 is pgcode.FeatureNotSupported.
feature-usage
CREATE TABLE foo (a INT8 PRIMARY KEY, b INT8, INDEX (b) INTERLEAVE IN PARENT foo (b))
----
error: pq: unimplemented: use CREATE INDEX to make interleaved indexes
errorcodes.0A000
unimplemented.#9148

# 0A000 is pgcode.FeatureNotSupported.
feature-usage
SELECT * FROM pg_catalog.pg_stat_wal_receiver
----
error: pq: unimplemented: virtual schema table not implemented: pg_catalog.pg_stat_wal_receiver
errorcodes.0A000
unimplemented.pg_catalog.pg_stat_wal_receiver

# 22012 is pgcode.DivisionByZero.
feature-usage
SELECT 2/0
----
error: pq: division by zero
errorcodes.22012
