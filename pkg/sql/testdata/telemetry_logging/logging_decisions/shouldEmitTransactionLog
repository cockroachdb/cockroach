# shouldEmitTransaction unit tests

subtest telemetry_disabled

set-cluster-settings telemetryLoggingEnabled=false samplingMode=transaction stmtSampleFreq=10 txnSampleFreq=10
----

shouldEmitTransactionLog unixSecs=1 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=2 force=true
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=3 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=4 force=true
----
emit: false, skippedTxns: 0

subtest end

subtest telemetry_enabled_txn_freq_0

set-cluster-settings telemetryLoggingEnabled=true samplingMode=transaction txnSampleFreq=0
----

shouldEmitTransactionLog unixSecs=1 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=2 force=true
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=3 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=4 force=true
----
emit: false, skippedTxns: 0

subtest end

subtest telemetry_enabled_txn_mode_off

set-cluster-settings telemetryLoggingEnabled=true samplingMode=statement txnSampleFreq=10
----

shouldEmitTransactionLog unixSecs=1 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=2 force=true
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=3 force=false
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=4 force=true
----
emit: false, skippedTxns: 0

subtest end

subtest telemetry_enabled_txn_mode_on

set-cluster-settings telemetryLoggingEnabled=true samplingMode=transaction txnSampleFreq=1
----

shouldEmitTransactionLog unixSecs=1 force=false
----
emit: true, skippedTxns: 0

# Not enough time elapsed.
shouldEmitTransactionLog unixSecs=1.5 force=false
----
emit: false, skippedTxns: 1

# Enough time elapsed.
shouldEmitTransactionLog unixSecs=2 force=false
----
emit: true, skippedTxns: 1

# Force should override the sampling frequency.
shouldEmitTransactionLog unixSecs=2.5 force=true
----
emit: true, skippedTxns: 0


# Sampling internal queries is off.
shouldEmitTransactionLog unixSecs=4 force=false isInternal=true
----
emit: false, skippedTxns: 0

shouldEmitTransactionLog unixSecs=4 force=true isInternal=true
----
emit: false, skippedTxns: 0

subtest end

subtest telemetry_enabled_txn_mode_on_internal_queries_on
# Test that internal queries are sampled when internalStmtsOn is true.

set-cluster-settings telemetryLoggingEnabled=true samplingMode=transaction txnSampleFreq=1 internalStmtsOn=true
----

shouldEmitTransactionLog unixSecs=1 force=false isInternal=true
----
emit: true, skippedTxns: 0

shouldEmitTransactionLog unixSecs=1.5 force=false isInternal=true
----
emit: false, skippedTxns: 1

shouldEmitTransactionLog unixSecs=2 force=false isInternal=true
----
emit: true, skippedTxns: 1

shouldEmitTransactionLog unixSecs=2.5 force=true isInternal=true
----
emit: true, skippedTxns: 0

shouldEmitTransactionLog unixSecs=2.5 force=true isInternal=true
----
emit: true, skippedTxns: 0

shouldEmitTransactionLog unixSecs=4 force=false isInternal=false
----
emit: true, skippedTxns: 0

shouldEmitTransactionLog unixSecs=5 force=true isInternal=false
----
emit: true, skippedTxns: 0

subtest end
