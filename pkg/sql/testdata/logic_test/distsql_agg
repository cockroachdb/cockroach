# LogicTest: 5node

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM GENERATE_SERIES(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data TESTING_RELOCATE
  SELECT ARRAY[i%5+1], i FROM GENERATE_SERIES(0, 9) AS g(i)

# Generate all combinations of values 1 to 10.
statement ok
INSERT INTO data SELECT a, b, c, d FROM
   GENERATE_SERIES(1, 10) AS A(a),
   GENERATE_SERIES(1, 10) AS B(b),
   GENERATE_SERIES(1, 10) AS C(c),
   GENERATE_SERIES(1, 10) AS D(d)

# Verify data placement.
query TTTI colnames
SHOW TESTING_RANGES FROM TABLE data
----
Start Key  End Key  Replicas  Lease Holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Ready to roll!
statement ok
SET DISTSQL = ON

# We hardcode the plan for the testcase that follows to make it easier to debug
# errors caused by changing planning logic.
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM(a) FROM data]
----
https://raduberinde.github.io/decode.html?eJy8k09LwzAYxu9-CnlOCu9h6bo5e5rHHXQy9SQ9xOalFLamJCkoo99d1iLaIukgo8f8-T2_PG1yRKkVP8kDWyTvECBEIMxBiEFYICVURmdsrTanLR2wUZ9IZoSirGp3mk4JmTaM5AhXuD0jwav82POOpWIDgmIni30rqUxxkOZrraSTIGxrl1yvBdKGoGv3E9jQ-aqHPDecS6cHppe3x5u1uD07-jexLrVRbFj1AtPmwnIx3SccUYW0iKZrMaIKaTGfrsWIKqRFPF2LEdWlHuU_0Tu2lS4tDx5nPy8lsMq5e9dW1ybjZ6OzNrwbbtvd7YRi67pV0Q02Zbd0OtZfWHjhqAeLIRz5zSPquZeO_XAccu6FF176zcsQ850XXvnNqxDzvf9fzUauif-SDd1pc_UdAAD__1oVf74=

query R
SELECT SUM(a) FROM data
----
55000

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM((a-1)*1000 + (b-1)*100 + (c-1)*10 + (d-1)) FROM data]
----
https://raduberinde.github.io/decode.html?eJzcVDFvszAU3L9fgd7kr3UlDCRNPdExQ9MqTaeKwcVPCCnByDZSq4j_XgUSNdDKRCIT4_P57nxny3solMSV2KEB_g4MKARAIQQKEVCYQUKh1CpFY5Q-bGkJS_kJ3KeQF2VlD8sJhVRpBL4Hm9stAoeN-NjiGoVEDRQkWpFvG5NS5zuhv2IprAAKaywkau4RQkjMvDuPcc6Xq81_78Zjvu-fpluPkDj4hR-HIx728XM4js5QSGoKqrKnADW9PNpjlmnMhFW9ZK9vTyRml0v_KFaF0hI1yo5gUl_ZnE33ygaijWktmG5rA9HGtBZOt7WBaGNai6bb2kC0a32qf0iv0ZSqMNj7XLt6CQWUGbb_slGVTvFFq7QRb8fnZnezINHYFmXtsCxa6HCsczJzkoMOmfXJgdt5wDp0siM3ORpz7pmTPHc7z8c43zvJC7fzYozzg_uu_IFn4n5kfe-k_vcdAAD__2P1870=

query R
SELECT SUM((a-1)*1000 + (b-1)*100 + (c-1)*10 + (d-1)) FROM data
----
49995000

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM((a-1)*1000) + SUM((b-1)*100) + SUM((c-1)*10) + SUM(d-1) FROM data]
----
https://raduberinde.github.io/decode.html?eJzcVU1vozAUvO-vQO8Udr0SBpLN-kSPOTSt0vRUcXDxE0JKMLKN1Criv1fgNh-0MpHS9MAF2R6P5808y-yglAKXfIsa2BNQIBACgQgIxEBgCimBSskMtZaq3WIJC_ECLCBQlFVt2uWUQCYVAtuBKcwGgcGaP29whVygAgICDS82nUilii1Xr4nghgOBFZYCFfMmCfX-epQxtliufe-3R4MgsDNvkoSfsD0U9aF3JIkPAKQNAVmbj3Ibcr6RmzxXmHMjez4eHm8nCfWB2FG4H0X7UeyfLXzQq0upBCoUJ3Jp8-2lHWXfhv_HS0K__UbdN3aWTsfS_AEj12t-OJYEB4xcL8FoLAkOGLlegvFYEhww8jNP-BfCK9SVLDX2nvLT81ICKHK0fwEta5XhvZJZd7id3nW7uwWB2liU2smitFBb1jGZOsnhCZn2yaFbeUA6crJjNzm-pO6pkzxzK88uUf7nJM_dyvNLlP-7exUMXBP3Jetrp82vtwAAAP__9bkTog==

query R
SELECT SUM((a-1)*1000) + SUM((b-1)*100) + SUM((c-1)*10) + SUM(d-1) FROM data
----
49995000

query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM(a), MIN(b), MAX(c), COUNT(d) FROM data]
----
https://raduberinde.github.io/decode.html?eJzElM1q4zAQgO_7FMucHJhDZDvZrE8Ke_IhyZIfKBRTVGswhsQykgwtwe9ebFPamCIH0tQ3_X3zzTBizlAoSWtxIgPRIzBA8AEhAIQQEGaQIJRapWSM0s2TDojlC0RThLwoK9scJwip0gTRGWxujwQR7MXzkbYkJGlAkGRFfmwlpc5PQr9yKawAhE1lo9-cIfeRB8hDSGoEVdn3yDVe71xmmaZMWNVT7g4rj7MJIKzitcf9drV88HjQrP5tDuu9x8PJ1eoPY1UoLUmTvBAm9bcltzusnuIr0mMjdGPAec9u-COUO-C8Z7nBCOUOOO9ZbjhCuQPOnxotX6i3ZEpVGOqNmMt4CQLJjLrpZFSlU_qvVdoG77ab9nV7IMnY7pZ1m7jorpq0PsPMCfsXMOvDvts8oA6cdOiGw1vynjnhuds8v8X8xwkv3ObFLea_7l5NB76J-5P13Un96y0AAP__3tqzXw==

query RIII
SELECT SUM(a), MIN(b), MAX(c), COUNT(d) FROM data
----
55000 1 10 10000

# We don't yet support local stages for AVG (or STDDEV, VARIANCE).
query T
SELECT url FROM [EXPLAIN (DISTSQL) SELECT SUM(a), MIN(b), MAX(c), COUNT(d), AVG(a+b+c+d) FROM data]
----
https://raduberinde.github.io/decode.html?eJzMkzFr8zAQhvfvV5h3Uvg0RLbTwZNCh5IhSUmTUigeVOswhsQykgwtwf-9WKa0CW1KyeJFnHT33D0Y3xG10bRSB3LIniHAEYMjAUcKjhlyjsaagpwzti8ZgIV-RTblqOqm9f1zzlEYS8iO8JXfEzJs1cueNqQ0WXBo8qrahyGNrQ7KvkmtvALHhmpNNoukiGQcySSSacSYFNH_SMaT_kzCmSLvOEzrP0Z2_AeZT4e2NlaTJX1ikHff6M7L0lKpvDmzfdgtmRQTcCwXKybjEM2fmEz66Ha9W22ZTPt4_njH5GxyUVOM6ZvFY5JJxiSTjknmlz3bkGtM7ejsFz_tl3OQLmnYDmdaW9C9NUVoPlzXoTo8aHJ-yIrhsqhDSvRaX2FxEb45gafncHzN5OQaOL0Gnv0Jzrt_7wEAAP__y32t4g==

query RIIIR
SELECT SUM(a), MIN(b), MAX(c), COUNT(d), AVG(a+b+c+d) FROM data
----
55000 1 10 10000 22

query I
SELECT DISTINCT (a) FROM data
----
1
2
3
4
5
6
7
8
9
10

query R
SELECT SUM (DISTINCT A) FROM data
----
55

query T
SELECT URL FROM [EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A) FROM data]
----
https://raduberinde.github.io/decode.html?eJy8lMFqg0AQhu99ijCnFvaQNSZNPaUkFw9NSpKewh627iCCcWV3hZbguxc1pVXCbkD06Mz8880_LnOBTArc8jNqCE5AgYAHBGZAwAcCc2AEciUj1FqqqqQRhOILgimBJMsLU4UZgUgqhOACJjEpQgBH_pniHrlABQQEGp6kNSRXyZmr75XghgOBXWGCyYoCKwnIwvw2LMn9qE2iTZJFps2RSqBCsZapDiYnViWvddfQlN0N_WMV2bVvC8bKG2O9xrHCmBvZWcDh4-1xEx6O4XZ9nKzok3UKOt6WHahhtuyN58-BGsbfbDx_DtQw_vzx_DlQw1-BG9A96lxmGjvXoN2PEUARY3NItCxUhO9KRnXz5nNXV9cBgdo0Wdp8hFmTqsb6L6ZWsdcS067Ys5Md6JlV7dvFfp-551bxwk5e9CE_W8VLO3nZh_xi_1dTxzOxP7Ium5UPPwEAAP__RnyyyQ==

query RR
SELECT SUM (DISTINCT A), SUM (DISTINCT B) from data
----
55 55

query T
SELECT URL FROM [EXPLAIN (DISTSQL) SELECT SUM (DISTINCT A), SUM (DISTINCT B) FROM data]
----
https://raduberinde.github.io/decode.html?eJy8lEGrm0AQx-_9FDKnBuaQNSZNPVmSi4cmJUlPYQ9bdxDBuLK7Qh_B7_5Q83hPCWsgxKMz85_f_MdlrlAoSTtxIQPhGRgg-ICwAIQAEJbAEUqtEjJG6aakE8TyP4RzhKwoK9uEOUKiNEF4BZvZnCCEk_iX04GEJA0IkqzI8hZS6uwi9FskhRWAsK9s6EUMIx94jaAq-9Gzxsdp28zYrEhsH6W0JE1yo3ITemfeJG91t9DcY_xh7CetKm6dezhe3xnsV5pqSoVVgy0c__7-vo2Pp3i3OXkRmwEOQv7MORibdPsjtFdt35_U5AjtVSYXk5ocob3KZDCpyRHaFMfiDvZAplSFocHR6PfjCCRT6u6NUZVO6I9WSdu8-9y31W1AkrFdlnUfcdGlmrG-iplT7PfEbCj23eQR9MKpDtzi4Jm5l07xyk1ePUP-4RSv3eT1M-Sf7n81H3km7kc2ZPP623sAAAD__0FyvB4=

query II
SELECT DISTINCT a, b FROM data WHERE (a + b + c) = 27 ORDER BY c,b,a;
----
10 10
10 9
9 10
10 8
9 9
8 10
10 7
9 8
8 9
7 10

query T
SELECT URL FROM [EXPLAIN (DISTSQL) SELECT DISTINCT a, b FROM data WHERE (a + b + c) = 27 ORDER BY c,b,a]
----
https://raduberinde.github.io/decode.html?eJzMlU9r3DAQxe_9FGJOCTuHSPbmj6AgaCnsJSlpbkEH1xqKwbGMJENL8Hcvtre0axopsN7FF4Mlvfk9PR7oFRpr6L54IQ_yGTggCEDIACEHhC1ohNbZkry3bjgyCXbmJ8grhKppuzAsa4TSOgL5CqEKNYGEp-J7TY9UGHKAYCgUVT1CWle9FO6XMkUoAOFLVQdykl1cKM42TInL4Ztdso9M3Egpd_dPgPDQBckURyVQZaB7BNuFP_Ae32_rm3Vh7khlG1Rig4pvlkR9rnyomjIcwqwz5Mh8srWX7FkPm_tz-6UrxvW7sX9p-7lv30z3Z_TI11mOhK0ly5FAnSp4sc7gE7aWDD6BOlXw2TqDT9haMvgE6lTB5-sMPmFryeATqHO8Q__BPpJvbePpADufpxHI_KDpKfO2cyV9dbYch0-_D-PpccGQD9Mun352zbQ12PpXzKNiEReLqDg7EPO5OIvbvo6j86h6Gxdvo-IE-fqYS99Exbdx8m1UfBcX3x1jmyc6lipZvGU8UTN-VM94omh5Ah5vGk9Ujce7Nveu-w-_AwAA___Ig_iC
