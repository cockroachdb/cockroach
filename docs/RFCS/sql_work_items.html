<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script src="http://ariutta.github.io/svg-pan-zoom/dist/svg-pan-zoom.js"></script>
<meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title>Evolving the SQL layer in CockroachDB</title>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: GÃ¼nter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 7952 2016-07-26 18:15:59Z milde $               */
/* :Copyright: Â© 2015 GÃ¼nter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS2.1_ stylesheet defines rules for Docutils elements without    */
/* HTML equivalent. It is required to make the document semantic visible. */
/*                                                                        */
/* .. _CSS2.1: http://www.w3.org/TR/CSS2                                  */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link       */

/* alignment of text and inline objects inside block objects*/
.align-left   { text-align: left; }
.align-right  { text-align: right; }
.align-center { clear: both; text-align: center; }
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* titles */
h1.title, p.subtitle {
  text-align: center;
}
p.admonition-title,
p.topic-title,
p.sidebar-title,
p.rubric,
p.system-message-title {
  font-weight: bold;
}
h1 + p.subtitle,
h1 + p.section-subtitle {
  font-size: 1.6em;
}
h2 + p.section-subtitle { font-size: 1.28em; }
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
p.sidebar-title,
p.rubric {
  font-size: larger;
}
p.rubric { color: maroon; }
a.toc-backref {
  color: black;
  text-decoration: none; }

/* Warnings, Errors */
div.caution p.admonition-title,
div.attention p.admonition-title,
div.danger p.admonition-title,
div.error p.admonition-title,
div.warning p.admonition-title,
div.system-messages h1,
div.error,
span.problematic,
p.system-message-title {
  color: red;
}

/* inline literals */
span.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wraph at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .compact li,
.simple  ul, .compact ul,
.simple  ol, .compact ol,
.simple > li p, .compact > li p,
dl.simple > dd, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}

/* Table of Contents */
div.topic.contents { margin: 0; }
ul.auto-toc {
  list-style-type: none;
  padding-left: 1.5em; }

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

dt span.classifier { font-style: italic }
dt span.classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}

/* Field Lists and drivatives */
/* bold field name, content starts on the same line */
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt,
dl.footnote > dt,
dl.citation > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples */
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}
/* field names followed by a colon */
dl.field-list > dt:after,
dl.docinfo > dt:after {
  content: ":";
}

/* Bibliographic Fields (docinfo) */
pre.address { font: inherit; }
dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list { margin-left: 40px; }
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */
dl.footnote.superscript > dd {margin-left: 1em; }
dl.footnote.brackets > dd {margin-left: 2em; }
dl > dt.label { font-weight: normal; }
a.footnote-reference.brackets:before,
dt.label > span.brackets:before { content: "["; }
a.footnote-reference.brackets:after,
dt.label > span.brackets:after { content: "]"; }
a.footnote-reference.superscript,
dl.footnote.superscript > dt.label {
  vertical-align: super;
  font-size: smaller;
}
dt.label > span.fn-backref { margin-left: 0.2em; }
dt.label > span.fn-backref > a { font-style: italic; }

/* Line Blocks */
div.line-block { display: block; }
div.line-block div.line-block {
  margin-top: 0;
  margin-bottom: 0;
  margin-left: 40px;
}

/* Figures, Images, and Tables */
.figure.align-left,
img.align-left,
object.align-left,
table.align-left {
  margin-right: auto;
}
.figure.align-center,
img.align-center,
object.align-center {
  margin-left: auto;
  margin-right: auto;
  display: block;
}
table.align-center {
  margin-left: auto;
  margin-right: auto;
}
.figure.align-right,
img.align-right,
object.align-right,
table.align-right {
  margin-left: auto;
}
/* reset inner alignment in figures and tables */
div.align-left, div.align-center, div.align-right,
table.align-left, table.align-center, table.align-right
{ text-align: inherit }

/* Admonitions and System Messages */
div.admonition,
div.system-message,
div.sidebar{
  margin: 40px;
  border: medium outset;
  padding-right: 1em;
  padding-left: 1em;
}

/* Sidebar */
div.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
}

/* Text Blocks */
div.topic,
pre.literal-block,
pre.doctest-block,
pre.math,
pre.code {
  margin-right: 40px;
  margin-left: 40px;
}
pre.code .ln { color: gray; } /* line numbers */

/* Tables */
table { border-collapse: collapse; }
td, th {
  border-style: solid;
  border-color: silver;
  padding: 0 1ex;
  border-width: thin;
}
td > p:first-child, th > p:first-child { margin-top: 0; }
td > p, th > p { margin-bottom: 0; }

table > caption {
  text-align: left;
  margin-bottom: 0.25em
}

table.borderless td, table.borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.		   */
/*                                                                         */
/* :Author: GÃ¼nter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 7952 2016-07-26 18:15:59Z milde $               */
/* :Copyright: Â© 2015 GÃ¼nter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*    	     	      	     	 					   */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: http://www.w3.org/TR/CSS3		        		   */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  padding: 0 5%;
  margin: 8px 0;
}
div.document {
  line-height:1.3;
  counter-reset: table;
  /* counter-reset: figure; */
  /* avoid long lines --> better reading */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50em;
  margin: auto;
}

/* Sections */

/* Transitions */

hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs               */
/* ==========               */

/* vertical space (parskip) */
p, ol, ul, dl,
div.line-block,
table{
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}
h1, h2, h3, h4, h5, h6,
dl > dd {
  margin-bottom: 0.5em;
}

/* Lists                    */
/* ==========               */

/* Definition Lists         */

dl > dd p:first-child { margin-top: 0; }
/* :last-child is not part of CSSÂ 2.1 (introduced in CSSÂ 3) */
/* dl > dd p:last-child  { margin-bottom: 0; } */

/* lists nested in definition lists */
/* :only-child is not part of CSSÂ 2.1 (introduced in CSSÂ 3) */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}

/* Field Lists */

/* example for custom field-name width */
dl.field-list.narrow > dd {
  margin-left: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use special definition list dl.docinfo */
/* but dedication and abstract are placed into "topic" divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* Citations */
dl.citation dt.label {
  font-weight: bold;
}
span.fn-backref {
  font-weight: normal;
}

/* Text Blocks           */
/* ============          */

/* Literal Blocks           */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  margin-left: 1.5em;
  margin-right: 1.5em
}

/* Block Quotes             */

blockquote,
div.topic {
  margin-left: 1.5em;
  margin-right: 1.5em
}
blockquote > table,
div.topic > table {
  margin-top: 0;
  margin-bottom: 0;
}
blockquote p.attribution,
div.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables                   */
/* ======                   */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks   */
/* ======================   */

/* Footnotes and Citations  */
/* -----------------------  */

/* line on the left */
dl.footnote {
  padding-left: 1ex;
  border-left: solid;
  border-left-width: thin;
}

/* Directives               */
/* ----------               */

/* Body Elements            */
/* ~~~~~~~~~~~~~            */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
.figure.align-left,
img.align-left,
object.align-left {
  display: block;
  clear: left;
  float: left;
  margin-right: 1em
}
.figure.align-right,
img.align-right,
object.align-right {
  display: block;
  clear: right;
  float: right;
  margin-left: 1em
}
/* Stop floating sidebars, images and figures at section level 1,2,3 */
h1, h2, h3 { clear: both; }

/* Sidebar */

/* Move into the margin. In a layout with fixed margins, */
/* it can be moved into the margin completely.		 */
div.sidebar {
  width: 30%;
  max-width: 26em;
  margin-left: 1em;
  margin-right: -5.5%;
  background-color: #ffffee ;
}

/* Code                     */

pre.code, code { background-color: #eeeeee }
pre.code .ln { color: gray; } /* line numbers */
/* basic highlighting: for a complete scheme, see */
/* http://docutils.sourceforge.net/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

/* Math                     */
/* styled separately (see math.css for math-output=HTML) */

/* Epigraph                 */
/* Highlights               */
/* Pull-Quote               */
/* Compound Paragraph       */
/* Container                */

/* can be styled in a custom stylesheet */

/* Document Header and Footer */

div.footer, div.header {
  clear: both;
  font-size: smaller;
}

/* Inline Markup            */
/* =============            */

/* Emphasis                 */
/*   em                     */
/* Strong Emphasis          */
/*   strong		    */
/* Interpreted Text         */
/*   span.interpreted  	    */
/* Title Reference 	    */
/*   cite		    */
/* Inline Literals          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal {Â white-space: pre-wrap; } */

/* Hyperlink References     */
a { text-decoration: none; }

/* External Targets         */
/*   span.target.external   */
/* Internal Targets  	    */
/*   span.target.internal   */
/* Footnote References      */
/*   a.footnote-reference   */
/* Citation References      */
/*   a.citation-reference   */

</style>
<style type="text/css">

/*
 Stylesheet for HTML derived from rST.

 Key features:

 - auto beautification of the rST metadata at the start.
 - proper fitting of SVG inlines.
*/
body {
    font-family: "OFL Sorts Mill Goudy TT", "Palatino Linotype", "Book Antiqua", "Palatino", serif;
    font-size: 12pt;
    text-align: justify;
    color: #222;
}

div.document {
    line-height: 1.7em;
}

dl.docinfo {
    margin: 0;
    padding: 0;
    width: 100%;
}

dl.docinfo dt {
    width: 0;
    display: none;
}

dl.docinfo dd {
    margin: 0;
    padding: 0;
    display: block;
    text-align: center;
    width: 100%;
    font-style: italic;
    font-size: 90%;
    color: #777;
}

/*
hr {
    margin-bottom: 1.7em;
    margin-top: 1.7em;
    border: solid #ddd;
    border-width: 0 0 1px 0;
}
*/

svg {
    width: 100%;
}

#svg-container-items {
    border: 1px solid  black;
    width: 150ex;
    margin-left: -40ex;
}

#svg-items {
    width: 150ex;
    height: 40em;
}

pre, tt {
    font-size: 10pt;
    line-height: 1.3em;
    font-family: "Lucida Console", "Monaco", monospace;
}

pre.literal-block, pre.doctest-block, pre.math, pre.code {
    margin-left: 0px;
    margin-right: 0px;
}

table.borderless {
    width: 150%;
    padding: 0;
    margin-left: -25%;
    color: #555;
    font-size: 85%;
}

@import "http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:regular,italic";

</style>
</head>
<body>
<div class="document" id="evolving-the-sql-layer-in-cockroachdb">
<h1 class="title">Evolving the SQL layer in CockroachDB</h1>

<dl class="docinfo simple">
<dt class="authors">Authors</dt>
<dd class="authors"><p>Raphael 'kena' Poss</p>
</dd>
<dt class="status">Status</dt>
<dd class="status">draft</dd>
<dt class="start-date">Start Date</dt>
<dd class="start-date"><p>2017-10-03</p>
</dd>
<dt class="rfc-pr">RFC PR</dt>
<dd class="rfc-pr"><p></p></dd>
</dl>
<div class="section" id="summary">
<h1><a class="toc-backref" href="#id10"><span class="sectnum">1</span> Summary</a></h1>
<p>This document outlines a path towards improving the handling of SQL
in CockroachDB.</p>
<p>With input from Peter Mattis, Jordan Lewis, and others.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#summary" id="id10"><span class="sectnum">1</span> Summary</a></p></li>
<li><p><a class="reference internal" href="#motivation" id="id11"><span class="sectnum">2</span> Motivation</a></p></li>
<li><p><a class="reference internal" href="#how-to-read-this-document" id="id12"><span class="sectnum">3</span> How to read this document</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#methodology" id="id13"><span class="sectnum">3.1</span> Methodology</a></p></li>
<li><p><a class="reference internal" href="#characteristics" id="id14"><span class="sectnum">3.2</span> Characteristics</a></p></li>
<li><p><a class="reference internal" href="#visual-language" id="id15"><span class="sectnum">3.3</span> Visual language</a></p></li>
<li><p><a class="reference internal" href="#request-to-the-reader" id="id16"><span class="sectnum">3.4</span> Request to the reader</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#work-items" id="id17"><span class="sectnum">4</span> Work items</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#plan-overview" id="id18"><span class="sectnum">4.1</span> Plan overview</a></p></li>
<li><p><a class="reference internal" href="#areas-of-work" id="id19"><span class="sectnum">4.2</span> Areas of work</a></p></li>
<li><p><a class="reference internal" href="#work-items-for-semantic-extensions" id="id20"><span class="sectnum">4.3</span> Work items for semantic extensions</a></p></li>
<li><p><a class="reference internal" href="#query-compilation" id="id21"><span class="sectnum">4.4</span> Query compilation</a></p></li>
<li><p><a class="reference internal" href="#middle-end-refactorings" id="id22"><span class="sectnum">4.5</span> Middle-end refactorings</a></p></li>
<li><p><a class="reference internal" href="#back-end-refactorings" id="id23"><span class="sectnum">4.6</span> Back-end refactorings</a></p></li>
<li><p><a class="reference internal" href="#performance-otimizations-in-logical-planning" id="id24"><span class="sectnum">4.7</span> Performance otimizations in logical planning</a></p></li>
<li><p><a class="reference internal" href="#cost-based-logical-plan-optimizations" id="id25"><span class="sectnum">4.8</span> Cost-based logical plan optimizations</a></p></li>
<li><p><a class="reference internal" href="#user-facing-features" id="id26"><span class="sectnum">4.9</span> User-facing features</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#backlog" id="id27"><span class="sectnum">5</span> Backlog</a></p></li>
</ul>
</div>
</div>
<div class="section" id="motivation">
<h1><a class="toc-backref" href="#id11"><span class="sectnum">2</span> Motivation</a></h1>
<p>The goal of this document is to <em>map out</em>, at a relatively high level,
the general directions of work that we wish to invest into
CockroachDB's SQL middle-end (mainly logical planning, semantic
analysis insofar that it supports planning) and back-end (query
execution).</p>
<p>The emphasis is on &quot;mapping out&quot;: the motivation for this document is
to reveal the dependencies between work items as well as <em>hidden
dependencies</em> - significant investments that do not clearly correspond
to user-facing features.</p>
<p>Differences with roadmapping: so far roadmapping in CockroachDB has
been 1) flat - i.e. it doesn't track dependencies 2) oriented on
business value: roadmap items are mainly identified based on a clear
&quot;end value&quot; and thus can be small or large. In contrast, this
document highlights the dependencies and delineates work items
foremost so that all work items have comparable amounts of work to
them.</p>
</div>
<div class="section" id="how-to-read-this-document">
<h1><a class="toc-backref" href="#id12"><span class="sectnum">3</span> How to read this document</a></h1>
<p>Context: <a class="reference external" href="../tech-notes/sql-principles.md">Guiding principles for the SQL middle-end and back-end in CockroachDB</a>.</p>
<p>Take heed of the notion of <em>orthogonality</em> introduced in that tech note.</p>
<div class="section" id="methodology">
<h2><a class="toc-backref" href="#id13"><span class="sectnum">3.1</span> Methodology</a></h2>
<p>This is achieved by identifying technical <em>work items</em>: packages of
work to achieve well-defined goals by means of piecemeal evolutions of
the source code and documentation.</p>
<p>The main criteria to delineate a work item are as follows:</p>
<ul class="simple">
<li><p><em>effort</em>: the work requires more than a week and less than a month of
dedicated work by two engineers (at least one author and one
reviewer / work partner).</p></li>
<li><p><em>goals</em>: the results of the work enable either:</p>
<ul>
<li><p>a (set of) new abstractiun(s) that accelerates how engineers think
about a problem domain;</p></li>
<li><p>a (set of) data structure(s) that enable a class of multiple related
algorithms;</p></li>
<li><p>a common reusable programming pattern;</p></li>
<li><p>a non-trivial, preferably reusable algorithm;</p></li>
<li><p>a shared service with an API.</p></li>
</ul>
</li>
</ul>
<p>The following aspects are out of scope for this particular document:</p>
<ul class="simple">
<li><p>business motivations for the work items;</p></li>
<li><p>&quot;who does what&quot; (scheduling of human resources);</p></li>
<li><p>&quot;what and when&quot; (the precise calendar scheduling of the work);</p></li>
<li><p>most front-end matters: SQL syntax, built-in functions, operators;</p></li>
<li><p>most schema matters: structure of descriptors, schema access and
updates;</p></li>
<li><p>most SQL/KV interface matters: how to encode values, how to access
KV.</p></li>
</ul>
</div>
<div class="section" id="characteristics">
<h2><a class="toc-backref" href="#id14"><span class="sectnum">3.2</span> Characteristics</a></h2>
<p>Each work item is characterized by:</p>
<ul class="simple">
<li><p>a title;</p></li>
<li><p>its goals;</p></li>
<li><p>its <em>dependencies</em>: other work items that must be completed
beyond the MVP phase before the new work item can start;</p></li>
<li><p>its <em>accelerators</em>: other work items that, if completed
before the new work item, will significantly speed up development
and strengthen the results obtained for the goals.</p></li>
<li><p>optionally, its <em>sidecars</em>: side-benefits of the work items
that can motivate the work beyond reaching the stated goals:</p>
<ul>
<li><p>functional changes visible to users (&quot;features&quot;);</p></li>
<li><p>non-functional behavior changes (mainly: performance);</p></li>
<li><p>orthogonality improvements (changes the way engineers think about the
engine).</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="visual-language">
<h2><a class="toc-backref" href="#id15"><span class="sectnum">3.3</span> Visual language</a></h2>
<p>Visually, we map out work items as boxes, with the dependencies and
accelerator relationships drawn as directed edges between
them. Dependencies will be drawn using a solid arrow, and accelerators
as dotted arrows.</p>
<p>Work items are colored transparently by default; a functional sidecar
is indicated by a green background, a non-functional behavior sidecar
by a blue background, and an orthogonality sidecar with a pink
background.</p>
<p>We add one star (â˜…) next to the title if the preliminary
design phase has started already (e.g. RFC work); two stars (â˜…â˜…) if
the implementation has started, three stars (â˜…â˜…â˜…) if the work is
sufficiently advanced so as to enable other work items that have the
item as dependency.</p>
<p>We add one direct hit icon (ðŸŽ¯) next to the title if:</p>
<ul class="simple">
<li><p>for performance, an improvement over 10% over a key metric is
expected or a constant/linear improvement is expected on a
performance model / asymptotic complexity</p></li>
<li><p>for user-facing features, a blog post on the feature will likely
become popular</p></li>
<li><p>for orthogonality projects, at least 2 people will notice an
improvement in their work</p></li>
</ul>
<p>We add two direct hit icons (ðŸŽ¯ðŸŽ¯) next to the title if:</p>
<ul class="simple">
<li><p>for performance, an improvement over 100% over a key metric is
expected or a quadratic/exponential improvement is expected on a
performance model / asymptotic complexity</p></li>
<li><p>for user-facing features, the work enables a strong marketing /
sales story</p></li>
<li><p>for orthogonality projects, most of the relevant engineering team
will notice an improvement in their work</p></li>
</ul>
<p>multiplicative effect is expected on user productivity</p>
</div>
<div class="section" id="request-to-the-reader">
<h2><a class="toc-backref" href="#id16"><span class="sectnum">3.4</span> Request to the reader</a></h2>
<p>Do's:</p>
<ul class="simple">
<li><p>Double-check that the stated goals match the criteria stated above.</p></li>
<li><p>Double-check that the dependency and accelerator relationships make
sense.</p></li>
<li><p>Suggest improvements.</p></li>
<li><p>Feel encouraged and empowered to create your own plan(s) of action
using the same visual language but a different set of work items.</p></li>
<li><p>Signal your interest to work in a given general area, even if you
disagree with particular work item definitions.</p></li>
<li><p>Suggest new work items or areas of work.</p></li>
</ul>
<p>Don't:</p>
<ul class="simple">
<li><p>Never consider this document as &quot;final&quot;.</p></li>
<li><p>Do not attempt to match work items presented here 1-to-1 to issues
on GitHub, items on the roadmap, high-level product features or
marketing pillars.</p></li>
</ul>
</div>
</div>
<div class="section" id="work-items">
<h1><a class="toc-backref" href="#id17"><span class="sectnum">4</span> Work items</a></h1>
<div class="section" id="plan-overview">
<h2><a class="toc-backref" href="#id18"><span class="sectnum">4.1</span> Plan overview</a></h2>
<div id='svg-container-items'>
<svg id='svg-items' width="3227pt" height="863pt"
 viewBox="0.00 0.00 3227.00 862.69" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 858.686)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-858.686 3223,-858.686 3223,4 -4,4"/>
<!-- pleq -->
<g id="node1" class="node"><title>pleq</title>
<g id="a_node1"><a xlink:href="#pleq" xlink:title="Plan equivalency classes">
<polygon fill="none" stroke="black" points="1355,-588 1204,-588 1204,-552 1355,-552 1355,-588"/>
<text text-anchor="middle" x="1279.5" y="-566.3" font-family="Times,serif" font-size="14.00">Plan equivalency classes</text>
</a>
</g>
</g>
<!-- prewrite -->
<g id="node13" class="node"><title>prewrite</title>
<g id="a_node13"><a xlink:href="#prewrite" xlink:title="Plan rewriting infrastructure">
<polygon fill="none" stroke="black" points="1747,-498 1577,-498 1577,-462 1747,-462 1747,-498"/>
<text text-anchor="middle" x="1662" y="-476.3" font-family="Times,serif" font-size="14.00">Plan rewriting infrastructure</text>
</a>
</g>
</g>
<!-- pleq&#45;&gt;prewrite -->
<g id="edge10" class="edge"><title>pleq&#45;&gt;prewrite</title>
<path fill="none" stroke="black" d="M1355.22,-552.326C1418.32,-537.402 1508.7,-516.024 1574.84,-500.381"/>
<polygon fill="black" stroke="black" points="1575.9,-503.726 1584.82,-498.018 1574.29,-496.914 1575.9,-503.726"/>
</g>
<!-- expalt -->
<g id="node24" class="node"><title>expalt</title>
<g id="a_node24"><a xlink:href="#expalt" xlink:title="Show opt alternatives in EXPLAIN">
<polygon fill="lightgreen" stroke="black" points="1767,-644 1557,-644 1557,-608 1767,-608 1767,-644"/>
<text text-anchor="middle" x="1662" y="-622.3" font-family="Times,serif" font-size="14.00">Show opt alternatives in EXPLAIN</text>
</a>
</g>
</g>
<!-- pleq&#45;&gt;expalt -->
<g id="edge24" class="edge"><title>pleq&#45;&gt;expalt</title>
<path fill="none" stroke="black" d="M1355.22,-580.997C1409.75,-589.023 1484.67,-600.049 1546.7,-609.178"/>
<polygon fill="black" stroke="black" points="1546.53,-612.691 1556.93,-610.684 1547.55,-605.765 1546.53,-612.691"/>
</g>
<!-- vtpreds -->
<g id="node2" class="node"><title>vtpreds</title>
<g id="a_node2"><a xlink:href="#vtpreds" xlink:title="Push down predicates to vtables">
<polygon fill="lightblue" stroke="black" points="986,-198 795,-198 795,-162 986,-162 986,-198"/>
<text text-anchor="middle" x="890.5" y="-176.3" font-family="Times,serif" font-size="14.00">Push down predicates to vtables</text>
</a>
</g>
</g>
<!-- smartds -->
<g id="node3" class="node"><title>smartds</title>
<g id="a_node3"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="pink" stroke="black" points="602.5,-144 346.5,-144 346.5,-108 602.5,-108 602.5,-144"/>
<text text-anchor="middle" x="474.5" y="-122.3" font-family="Times,serif" font-size="14.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;vtpreds -->
<g id="edge1" class="edge"><title>smartds&#45;&gt;vtpreds</title>
<path fill="none" stroke="black" d="M602.527,-142.569C660.929,-150.186 729.367,-159.113 784.759,-166.338"/>
<polygon fill="black" stroke="black" points="784.576,-169.844 794.945,-167.667 785.481,-162.903 784.576,-169.844"/>
</g>
<!-- gends -->
<g id="node10" class="node"><title>gends</title>
<g id="a_node10"><a xlink:href="#gends" xlink:title="Partial replanning infrastructure">
<polygon fill="pink" stroke="black" points="985.5,-252 795.5,-252 795.5,-216 985.5,-216 985.5,-252"/>
<text text-anchor="middle" x="890.5" y="-230.3" font-family="Times,serif" font-size="14.00">Partial replanning infrastructure</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;gends -->
<g id="edge5" class="edge"><title>smartds&#45;&gt;gends</title>
<path fill="none" stroke="black" d="M541.408,-144.021C602.814,-160.708 696.971,-186.035 779,-207 787.41,-209.15 796.191,-211.357 804.965,-213.539"/>
<polygon fill="black" stroke="black" points="804.302,-216.98 814.85,-215.987 805.985,-210.186 804.302,-216.98"/>
</g>
<!-- vtprojs -->
<g id="node31" class="node"><title>vtprojs</title>
<g id="a_node31"><a xlink:href="#vtprojs" xlink:title="Push down projections to vtables">
<polygon fill="lightblue" stroke="black" points="989,-144 792,-144 792,-108 989,-108 989,-144"/>
<text text-anchor="middle" x="890.5" y="-122.3" font-family="Times,serif" font-size="14.00">Push down projections to vtables</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;vtprojs -->
<g id="edge28" class="edge"><title>smartds&#45;&gt;vtprojs</title>
<path fill="none" stroke="black" d="M602.527,-126C659.922,-126 727.01,-126 781.883,-126"/>
<polygon fill="black" stroke="black" points="781.981,-129.5 791.981,-126 781.981,-122.5 781.981,-129.5"/>
</g>
<!-- kvpreds -->
<g id="node33" class="node"><title>kvpreds</title>
<g id="a_node33"><a xlink:href="#kvpreds" xlink:title="ðŸŽ¯Push down predicates to KV">
<polygon fill="lightblue" stroke="black" points="984,-90 797,-90 797,-54 984,-54 984,-90"/>
<text text-anchor="middle" x="890.5" y="-68.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Push down predicates to KV</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;kvpreds -->
<g id="edge31" class="edge"><title>smartds&#45;&gt;kvpreds</title>
<path fill="none" stroke="black" d="M602.527,-109.431C661.6,-101.726 730.942,-92.6815 786.664,-85.4134"/>
<polygon fill="black" stroke="black" points="787.441,-88.8418 796.904,-84.0777 786.536,-81.9006 787.441,-88.8418"/>
</g>
<!-- kvprojs -->
<g id="node43" class="node"><title>kvprojs</title>
<g id="a_node43"><a xlink:href="#kvprojs" xlink:title="Push down projections to KV">
<polygon fill="lightblue" stroke="black" points="979.5,-36 801.5,-36 801.5,-0 979.5,-0 979.5,-36"/>
<text text-anchor="middle" x="890.5" y="-14.3" font-family="Times,serif" font-size="14.00">Push down projections to KV</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;kvprojs -->
<g id="edge57" class="edge"><title>smartds&#45;&gt;kvprojs</title>
<path fill="none" stroke="black" d="M541.408,-107.979C602.814,-91.2919 696.971,-65.9654 779,-45 787.41,-42.8504 796.191,-40.643 804.965,-38.4609"/>
<polygon fill="black" stroke="black" points="805.985,-41.8142 814.85,-36.0126 804.302,-35.0195 805.985,-41.8142"/>
</g>
<!-- nbench -->
<g id="node4" class="node"><title>nbench</title>
<g id="a_node4"><a xlink:href="#nbench" xlink:title="Node benchmarking">
<polygon fill="none" stroke="black" points="1726,-60 1598,-60 1598,-24 1726,-24 1726,-60"/>
<text text-anchor="middle" x="1662" y="-38.3" font-family="Times,serif" font-size="14.00">Node benchmarking</text>
</a>
</g>
</g>
<!-- nqual -->
<g id="node32" class="node"><title>nqual</title>
<g id="a_node32"><a xlink:href="#nqual" xlink:title="ðŸŽ¯ðŸŽ¯Expose node quality to users">
<polygon fill="lightgreen" stroke="black" points="2123,-60 1921,-60 1921,-24 2123,-24 2123,-60"/>
<text text-anchor="middle" x="2022" y="-38.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Expose node quality to users</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;nqual -->
<g id="edge29" class="edge"><title>nbench&#45;&gt;nqual</title>
<path fill="none" stroke="black" d="M1726.18,-42C1777.23,-42 1850.32,-42 1910.95,-42"/>
<polygon fill="black" stroke="black" points="1910.95,-45.5001 1920.95,-42 1910.95,-38.5001 1910.95,-45.5001"/>
</g>
<!-- ncst -->
<g id="node37" class="node"><title>ncst</title>
<g id="a_node37"><a xlink:href="#ncst" xlink:title="Node&#45;specific costing">
<polygon fill="lightblue" stroke="black" points="2089.5,-164 1954.5,-164 1954.5,-128 2089.5,-128 2089.5,-164"/>
<text text-anchor="middle" x="2022" y="-142.3" font-family="Times,serif" font-size="14.00">Node&#45;specific costing</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;ncst -->
<g id="edge38" class="edge"><title>nbench&#45;&gt;ncst</title>
<path fill="none" stroke="black" d="M1726.08,-57.9412C1739.61,-61.4815 1753.8,-65.2878 1767,-69 1830.86,-86.9619 1903.23,-109.074 1954.34,-124.988"/>
<polygon fill="black" stroke="black" points="1953.36,-128.348 1963.94,-127.985 1955.44,-121.666 1953.36,-128.348"/>
</g>
<!-- fdpsel -->
<g id="node44" class="node"><title>fdpsel</title>
<g id="a_node44"><a xlink:href="#fdpsel" xlink:title="ðŸŽ¯Feeback&#45;directed plan selection">
<polygon fill="lightblue" stroke="black" points="2484.5,-266 2281.5,-266 2281.5,-230 2484.5,-230 2484.5,-266"/>
<text text-anchor="middle" x="2383" y="-244.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Feeback&#45;directed plan selection</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;fdpsel -->
<g id="edge63" class="edge"><title>nbench&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1726.18,-49.8405C1836.25,-63.917 2058.54,-94.3086 2133,-119 2212.88,-145.489 2298.41,-195.022 2345.55,-224.401"/>
<polygon fill="black" stroke="black" points="2343.84,-227.462 2354.17,-229.819 2347.56,-221.535 2343.84,-227.462"/>
</g>
<!-- restart -->
<g id="node5" class="node"><title>restart</title>
<g id="a_node5"><a xlink:href="#restart" xlink:title="Make physical plans restartable">
<polygon fill="pink" stroke="black" points="569,-279 380,-279 380,-243 569,-243 569,-279"/>
<text text-anchor="middle" x="474.5" y="-257.3" font-family="Times,serif" font-size="14.00">Make physical plans restartable</text>
</a>
</g>
</g>
<!-- apply -->
<g id="node7" class="node"><title>apply</title>
<g id="a_node7"><a xlink:href="#apply" xlink:title="Apply relational operator">
<polygon fill="pink" stroke="black" points="967.5,-370 813.5,-370 813.5,-334 967.5,-334 967.5,-370"/>
<text text-anchor="middle" x="890.5" y="-348.3" font-family="Times,serif" font-size="14.00">Apply relational operator</text>
</a>
</g>
</g>
<!-- restart&#45;&gt;apply -->
<g id="edge43" class="edge"><title>restart&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M569.35,-275.622C590.974,-279.341 613.836,-283.555 635,-288 695.61,-300.73 763.612,-317.987 814.066,-331.373"/>
<polygon fill="black" stroke="black" points="813.351,-334.805 823.915,-333.996 815.153,-328.04 813.351,-334.805"/>
</g>
<!-- restart&#45;&gt;gends -->
<g id="edge4" class="edge"><title>restart&#45;&gt;gends</title>
<path fill="none" stroke="black" d="M569.184,-254.89C633.505,-250.695 718.925,-245.124 785.377,-240.791"/>
<polygon fill="black" stroke="black" points="785.705,-244.277 795.456,-240.133 785.249,-237.292 785.705,-244.277"/>
</g>
<!-- incrjoin -->
<g id="node19" class="node"><title>incrjoin</title>
<g id="a_node19"><a xlink:href="#incrjoin" xlink:title="Incremental / segmented joins">
<polygon fill="none" stroke="black" points="981.5,-306 799.5,-306 799.5,-270 981.5,-270 981.5,-306"/>
<text text-anchor="middle" x="890.5" y="-284.3" font-family="Times,serif" font-size="14.00">Incremental / segmented joins</text>
</a>
</g>
</g>
<!-- restart&#45;&gt;incrjoin -->
<g id="edge33" class="edge"><title>restart&#45;&gt;incrjoin</title>
<path fill="none" stroke="black" d="M569.184,-267.11C634.753,-271.386 722.247,-277.092 789.223,-281.46"/>
<polygon fill="black" stroke="black" points="789.163,-284.964 799.37,-282.122 789.619,-277.978 789.163,-284.964"/>
</g>
<!-- corr -->
<g id="node6" class="node"><title>corr</title>
<g id="a_node6"><a xlink:href="#corr" xlink:title="ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries">
<polygon fill="lightgreen" stroke="black" points="1397,-389 1162,-389 1162,-353 1397,-353 1397,-389"/>
<text text-anchor="middle" x="1279.5" y="-367.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries</text>
</a>
</g>
</g>
<!-- corropt -->
<g id="node11" class="node"><title>corropt</title>
<g id="a_node11"><a xlink:href="#corropt" xlink:title="ðŸŽ¯CSQ elimination in common cases">
<polygon fill="lightblue" stroke="black" points="2133,-525 1911,-525 1911,-489 2133,-489 2133,-525"/>
<text text-anchor="middle" x="2022" y="-503.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯CSQ elimination in common cases</text>
</a>
</g>
</g>
<!-- corr&#45;&gt;corropt -->
<g id="edge6" class="edge"><title>corr&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M1397.1,-366.572C1496.67,-365.422 1643.02,-370.002 1767,-399 1845.46,-417.352 1930.44,-458.195 1979.52,-484.063"/>
<polygon fill="black" stroke="black" points="1978.08,-487.26 1988.55,-488.867 1981.37,-481.08 1978.08,-487.26"/>
</g>
<!-- apply&#45;&gt;corr -->
<g id="edge2" class="edge"><title>apply&#45;&gt;corr</title>
<path fill="none" stroke="black" d="M967.959,-355.754C1020.33,-358.325 1091.03,-361.796 1151.74,-364.777"/>
<polygon fill="black" stroke="black" points="1151.62,-368.275 1161.78,-365.27 1151.97,-361.284 1151.62,-368.275"/>
</g>
<!-- tstatsui -->
<g id="node8" class="node"><title>tstatsui</title>
<g id="a_node8"><a xlink:href="#tstatsui" xlink:title="ðŸŽ¯Reveal table stats to users">
<polygon fill="lightgreen" stroke="black" points="1748,-114 1576,-114 1576,-78 1748,-78 1748,-114"/>
<text text-anchor="middle" x="1662" y="-92.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Reveal table stats to users</text>
</a>
</g>
</g>
<!-- tstats -->
<g id="node9" class="node"><title>tstats</title>
<g id="a_node9"><a xlink:href="#tstats" xlink:title="Collecting table statistics">
<polygon fill="none" stroke="black" points="1356,-114 1203,-114 1203,-78 1356,-78 1356,-114"/>
<text text-anchor="middle" x="1279.5" y="-92.3" font-family="Times,serif" font-size="14.00">Collecting table statistics</text>
</a>
</g>
</g>
<!-- tstats&#45;&gt;tstatsui -->
<g id="edge3" class="edge"><title>tstats&#45;&gt;tstatsui</title>
<path fill="none" stroke="black" d="M1356.13,-96C1416.3,-96 1500.87,-96 1565.67,-96"/>
<polygon fill="black" stroke="black" points="1565.9,-99.5001 1575.9,-96 1565.9,-92.5001 1565.9,-99.5001"/>
</g>
<!-- cstf -->
<g id="node23" class="node"><title>cstf</title>
<g id="a_node23"><a xlink:href="#cstf" xlink:title="Costing function for logical plans">
<polygon fill="lightblue" stroke="black" points="1762,-168 1562,-168 1562,-132 1762,-132 1762,-168"/>
<text text-anchor="middle" x="1662" y="-146.3" font-family="Times,serif" font-size="14.00">Costing function for logical plans</text>
</a>
</g>
</g>
<!-- tstats&#45;&gt;cstf -->
<g id="edge58" class="edge"><title>tstats&#45;&gt;cstf</title>
<path fill="none" stroke="black" d="M1356.13,-106.733C1412.09,-114.675 1489.13,-125.609 1551.77,-134.499"/>
<polygon fill="black" stroke="black" points="1551.3,-137.967 1561.7,-135.907 1552.29,-131.036 1551.3,-137.967"/>
</g>
<!-- incphy -->
<g id="node16" class="node"><title>incphy</title>
<g id="a_node16"><a xlink:href="#incphy" xlink:title="Incremental physical planning for dist queries">
<polygon fill="none" stroke="black" points="1413,-260 1146,-260 1146,-224 1413,-224 1413,-260"/>
<text text-anchor="middle" x="1279.5" y="-238.3" font-family="Times,serif" font-size="14.00">Incremental physical planning for dist queries</text>
</a>
</g>
</g>
<!-- gends&#45;&gt;incphy -->
<g id="edge13" class="edge"><title>gends&#45;&gt;incphy</title>
<path fill="none" stroke="black" d="M985.676,-235.947C1030.68,-236.877 1085.52,-238.011 1135.51,-239.044"/>
<polygon fill="black" stroke="black" points="1135.7,-242.549 1145.77,-239.256 1135.85,-235.55 1135.7,-242.549"/>
</g>
<!-- lookupjoin -->
<g id="node18" class="node"><title>lookupjoin</title>
<g id="a_node18"><a xlink:href="#lookupjoin" xlink:title="ðŸŽ¯ðŸŽ¯Lookup&#45;based joins">
<polygon fill="lightblue" stroke="black" points="1738,-260 1586,-260 1586,-224 1738,-224 1738,-260"/>
<text text-anchor="middle" x="1662" y="-238.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Lookup&#45;based joins</text>
</a>
</g>
</g>
<!-- gends&#45;&gt;lookupjoin -->
<g id="edge17" class="edge"><title>gends&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" d="M985.679,-225.287C1033.63,-221.279 1092.87,-216.981 1146,-215 1264.58,-210.58 1294.51,-208.569 1413,-215 1467.3,-217.947 1528,-224.499 1575.76,-230.411"/>
<polygon fill="black" stroke="black" points="1575.39,-233.892 1585.74,-231.661 1576.26,-226.946 1575.39,-233.892"/>
</g>
<!-- sjoin -->
<g id="node12" class="node"><title>sjoin</title>
<g id="a_node12"><a xlink:href="#sjoin" xlink:title="Semi&#45;joins">
<polygon fill="pink" stroke="black" points="1700,-552 1624,-552 1624,-516 1700,-516 1700,-552"/>
<text text-anchor="middle" x="1662" y="-530.3" font-family="Times,serif" font-size="14.00">Semi&#45;joins</text>
</a>
</g>
</g>
<!-- sjoin&#45;&gt;corropt -->
<g id="edge7" class="edge"><title>sjoin&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M1700.3,-531.187C1747.41,-527.634 1830.77,-521.347 1900.69,-516.073"/>
<polygon fill="black" stroke="black" points="1901.2,-519.545 1910.91,-515.303 1900.67,-512.565 1901.2,-519.545"/>
</g>
<!-- prewrite&#45;&gt;corropt -->
<g id="edge8" class="edge"><title>prewrite&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M1747.39,-486.364C1793.03,-489.807 1850.19,-494.117 1900.44,-497.908"/>
<polygon fill="black" stroke="black" points="1900.49,-501.421 1910.72,-498.683 1901.02,-494.441 1900.49,-501.421"/>
</g>
<!-- cbpsel -->
<g id="node22" class="node"><title>cbpsel</title>
<g id="a_node22"><a xlink:href="#cbpsel" xlink:title="ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection">
<polygon fill="lightblue" stroke="black" points="2114,-266 1930,-266 1930,-230 2114,-230 2114,-266"/>
<text text-anchor="middle" x="2022" y="-244.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection</text>
</a>
</g>
</g>
<!-- prewrite&#45;&gt;cbpsel -->
<g id="edge21" class="edge"><title>prewrite&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" d="M1746.59,-461.937C1753.65,-459.327 1760.55,-456.362 1767,-453 1841.64,-414.098 1845.22,-382.515 1911,-330 1936.14,-309.927 1965.38,-288.208 1987.38,-272.169"/>
<polygon fill="black" stroke="black" points="1989.71,-274.808 1995.74,-266.098 1985.59,-269.144 1989.71,-274.808"/>
</g>
<!-- irplan -->
<g id="node14" class="node"><title>irplan</title>
<g id="a_node14"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="1194.5" y1="-670" x2="1364.5" y2="-670" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="1364.5,-688 1194.5,-688 1194.5,-652 1364.5,-652 1364.5,-688"/>
<text text-anchor="middle" x="1279.5" y="-666.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;corropt -->
<g id="edge9" class="edge"><title>irplan&#45;&gt;corropt</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1364.6,-679.147C1463.13,-687.124 1630.28,-692.065 1767,-653 1855.17,-627.809 1945.12,-565.693 1990.62,-531.152"/>
<polygon fill="black" stroke="black" points="1992.79,-533.902 1998.59,-525.038 1988.52,-528.349 1992.79,-533.902"/>
</g>
<!-- irplan&#45;&gt;prewrite -->
<g id="edge12" class="edge"><title>irplan&#45;&gt;prewrite</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1314.55,-651.905C1341.49,-637.433 1379.94,-616.42 1413,-597 1478.08,-558.776 1487.67,-536.828 1557,-507 1561.7,-504.978 1566.58,-503.08 1571.56,-501.302"/>
<polygon fill="black" stroke="black" points="1572.88,-504.552 1581.23,-498.029 1570.63,-497.922 1572.88,-504.552"/>
</g>
<!-- planser -->
<g id="node17" class="node"><title>planser</title>
<g id="a_node17"><a xlink:href="#planser" xlink:title="Logical plan spec/ser language">
<polygon fill="pink" stroke="black" points="1754.5,-736 1569.5,-736 1569.5,-700 1754.5,-700 1754.5,-736"/>
<text text-anchor="middle" x="1662" y="-714.3" font-family="Times,serif" font-size="14.00">Logical plan spec/ser language</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;planser -->
<g id="edge15" class="edge"><title>irplan&#45;&gt;planser</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1364.95,-680.653C1422.39,-687.9 1498.72,-697.528 1559.48,-705.193"/>
<polygon fill="black" stroke="black" points="1559.12,-708.675 1569.47,-706.454 1559.99,-701.73 1559.12,-708.675"/>
</g>
<!-- plancomp -->
<g id="node39" class="node"><title>plancomp</title>
<g id="a_node39"><a xlink:href="#plancomp" xlink:title="ðŸŽ¯Plan compilation">
<defs>
<linearGradient id="l_1" gradientUnits="userSpaceOnUse" x1="1960" y1="-798" x2="2084" y2="-798" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_1)" stroke="black" points="2084,-816 1960,-816 1960,-780 2084,-780 2084,-816"/>
<text text-anchor="middle" x="2022" y="-794.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Plan compilation</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;plancomp -->
<g id="edge48" class="edge"><title>irplan&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1663,-764C1761.9,-777.51 1876.91,-787.407 1949.33,-792.934"/>
<polygon fill="black" stroke="black" points="1949.46,-796.454 1959.7,-793.718 1949.99,-789.474 1949.46,-796.454"/>
</g>
<!-- vector -->
<g id="node40" class="node"><title>vector</title>
<g id="a_node40"><a xlink:href="#vector" xlink:title="ðŸŽ¯Vectorized operations on row batches">
<polygon fill="lightblue" stroke="black" points="3219,-816 2983,-816 2983,-780 3219,-780 3219,-816"/>
<text text-anchor="middle" x="3101" y="-794.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Vectorized operations on row batches</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;vector -->
<g id="edge51" class="edge"><title>irplan&#45;&gt;vector</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1358.1,-688.008C1376.16,-692.404 1395.29,-697.222 1413,-702 1477.49,-719.402 1492.05,-729.419 1557,-745 1602.69,-755.961 1614.45,-757.641 1661,-764"/>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1663,-764C1727.73,-772.843 2773.76,-767.44 2839,-771 2882.69,-773.384 2930.34,-777.78 2972.82,-782.343"/>
<polygon fill="black" stroke="black" points="2972.61,-785.841 2982.93,-783.442 2973.37,-778.882 2972.61,-785.841"/>
</g>
<!-- ctxfreeplans -->
<g id="node15" class="node"><title>ctxfreeplans</title>
<g id="a_node15"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="pink" stroke="black" points="1382.5,-516 1176.5,-516 1176.5,-480 1382.5,-480 1382.5,-516"/>
<text text-anchor="middle" x="1279.5" y="-494.3" font-family="Times,serif" font-size="14.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;prewrite -->
<g id="edge11" class="edge"><title>ctxfreeplans&#45;&gt;prewrite</title>
<path fill="none" stroke="black" d="M1382.72,-493.164C1439.91,-490.459 1510.72,-487.109 1566.6,-484.466"/>
<polygon fill="black" stroke="black" points="1567.03,-487.949 1576.86,-483.981 1566.7,-480.957 1567.03,-487.949"/>
</g>
<!-- ctxfreeplans&#45;&gt;planser -->
<g id="edge14" class="edge"><title>ctxfreeplans&#45;&gt;planser</title>
<path fill="none" stroke="black" d="M1347.3,-516.013C1368.89,-523.05 1392.53,-532.084 1413,-543 1484.07,-580.893 1490.78,-607.163 1557,-653 1577.95,-667.502 1602.04,-682.65 1621.76,-694.671"/>
<polygon fill="black" stroke="black" points="1620.11,-697.768 1630.48,-699.96 1623.74,-691.782 1620.11,-697.768"/>
</g>
<!-- cacheplans -->
<g id="node36" class="node"><title>cacheplans</title>
<g id="a_node36"><a xlink:href="#cacheplans" xlink:title="ðŸŽ¯Cache query plans">
<polygon fill="lightblue" stroke="black" points="1727.5,-444 1596.5,-444 1596.5,-408 1727.5,-408 1727.5,-444"/>
<text text-anchor="middle" x="1662" y="-422.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Cache query plans</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;cacheplans -->
<g id="edge56" class="edge"><title>ctxfreeplans&#45;&gt;cacheplans</title>
<path fill="none" stroke="black" d="M1376.03,-479.924C1441.06,-467.619 1525.91,-451.562 1586.07,-440.179"/>
<polygon fill="black" stroke="black" points="1587.08,-443.55 1596.25,-438.252 1585.78,-436.672 1587.08,-443.55"/>
</g>
<!-- qexstats -->
<g id="node38" class="node"><title>qexstats</title>
<g id="a_node38"><a xlink:href="#qexstats" xlink:title="ðŸŽ¯Collect per&#45;planop ex stats">
<polygon fill="none" stroke="black" points="1750,-352 1574,-352 1574,-316 1750,-316 1750,-352"/>
<text text-anchor="middle" x="1662" y="-330.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Collect per&#45;planop ex stats</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;qexstats -->
<g id="edge40" class="edge"><title>ctxfreeplans&#45;&gt;qexstats</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1322.31,-479.98C1392.47,-449.737 1533.7,-388.869 1609.73,-356.096"/>
<polygon fill="black" stroke="black" points="1611.32,-359.222 1619.12,-352.05 1608.55,-352.794 1611.32,-359.222"/>
</g>
<!-- ctxfreeplans&#45;&gt;plancomp -->
<g id="edge45" class="edge"><title>ctxfreeplans&#45;&gt;plancomp</title>
<path fill="none" stroke="black" d="M1355.41,-516.028C1410.92,-529.153 1488.5,-547.007 1557,-561 1649.93,-579.985 1680.46,-560.169 1767,-599 1863.19,-642.162 1955.23,-729.413 1997.23,-772.601"/>
<polygon fill="black" stroke="black" points="1994.79,-775.11 2004.24,-779.885 1999.83,-770.254 1994.79,-775.11"/>
</g>
<!-- incphy&#45;&gt;lookupjoin -->
<g id="edge18" class="edge"><title>incphy&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1413.05,-242C1467.11,-242 1528.04,-242 1575.97,-242"/>
<polygon fill="black" stroke="black" points="1575.99,-245.5 1585.99,-242 1575.99,-238.5 1575.99,-245.5"/>
</g>
<!-- dbaoverride -->
<g id="node34" class="node"><title>dbaoverride</title>
<g id="a_node34"><a xlink:href="#dbaoverride" xlink:title="ðŸŽ¯ðŸŽ¯Allow DBAs to override plans">
<defs>
<linearGradient id="l_2" gradientUnits="userSpaceOnUse" x1="2277" y1="-426" x2="2489" y2="-426" >
<stop offset="0" style="stop-color:lightgreen;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_2)" stroke="black" points="2489,-444 2277,-444 2277,-408 2489,-408 2489,-444"/>
<text text-anchor="middle" x="2383" y="-422.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Allow DBAs to override plans</text>
</a>
</g>
</g>
<!-- planser&#45;&gt;dbaoverride -->
<g id="edge36" class="edge"><title>planser&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" d="M1716.9,-699.928C1733.07,-694.349 1750.81,-688.071 1767,-682 1979.65,-602.261 2227.93,-494.224 2332.05,-448.219"/>
<polygon fill="black" stroke="black" points="2333.65,-451.341 2341.38,-444.095 2330.82,-444.939 2333.65,-451.341"/>
</g>
<!-- planser&#45;&gt;plancomp -->
<g id="edge47" class="edge"><title>planser&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1743.79,-736.053C1805.68,-749.885 1890.27,-768.787 1949.68,-782.062"/>
<polygon fill="black" stroke="black" points="1949.2,-785.543 1959.73,-784.308 1950.73,-778.711 1949.2,-785.543"/>
</g>
<!-- lookupjoin&#45;&gt;cbpsel -->
<g id="edge22" class="edge"><title>lookupjoin&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1738.05,-243.258C1790.76,-244.141 1861.86,-245.333 1919.61,-246.301"/>
<polygon fill="black" stroke="black" points="1919.8,-249.804 1929.86,-246.473 1919.92,-242.805 1919.8,-249.804"/>
</g>
<!-- incrjoin&#45;&gt;lookupjoin -->
<g id="edge16" class="edge"><title>incrjoin&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" d="M981.839,-289.533C1060.29,-290.497 1176.92,-291.051 1278.5,-288"/>
<path fill="none" stroke="black" d="M1280.5,-288C1382.5,-284.936 1498.85,-269.034 1575.75,-256.776"/>
<polygon fill="black" stroke="black" points="1576.54,-260.192 1585.86,-255.148 1575.43,-253.281 1576.54,-260.192"/>
</g>
<!-- fixedmem -->
<g id="node21" class="node"><title>fixedmem</title>
<g id="a_node21"><a xlink:href="#fixedmem" xlink:title="Constant&#45;space query execution">
<polygon fill="lightblue" stroke="black" points="1374.5,-168 1184.5,-168 1184.5,-132 1374.5,-132 1374.5,-168"/>
<text text-anchor="middle" x="1279.5" y="-146.3" font-family="Times,serif" font-size="14.00">Constant&#45;space query execution</text>
</a>
</g>
</g>
<!-- incrjoin&#45;&gt;fixedmem -->
<g id="edge19" class="edge"><title>incrjoin&#45;&gt;fixedmem</title>
<path fill="none" stroke="black" d="M971.251,-269.95C981.659,-267.175 992.129,-264.17 1002,-261 1083.07,-234.967 1174.21,-196.517 1228.95,-172.383"/>
<polygon fill="black" stroke="black" points="1230.68,-175.445 1238.4,-168.196 1227.84,-169.045 1230.68,-175.445"/>
</g>
<!-- incrjoin&#45;&gt;cbpsel -->
<g id="edge23" class="edge"><title>incrjoin&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1280.5,-288C1496.79,-281.503 1551.01,-282.14 1767,-269 1817.4,-265.934 1873.35,-261.428 1919.88,-257.375"/>
<polygon fill="black" stroke="black" points="1920.3,-260.851 1929.96,-256.491 1919.69,-253.878 1920.3,-260.851"/>
</g>
<!-- scapi -->
<g id="node20" class="node"><title>scapi</title>
<g id="a_node20"><a xlink:href="#scapi" xlink:title="Interface&#45;based schema API">
<polygon fill="pink" stroke="black" points="170,-408 0,-408 0,-372 170,-372 170,-408"/>
<text text-anchor="middle" x="85" y="-386.3" font-family="Times,serif" font-size="14.00">Interface&#45;based schema API</text>
</a>
</g>
</g>
<!-- scopes -->
<g id="node29" class="node"><title>scopes</title>
<g id="a_node29"><a xlink:href="#scopes" xlink:title="Introduce scoping and free vars in name resolutionâ˜…â˜…">
<polygon fill="pink" stroke="black" points="635,-408 314,-408 314,-372 635,-372 635,-408"/>
<text text-anchor="middle" x="474.5" y="-386.3" font-family="Times,serif" font-size="14.00">Introduce scoping and free vars in name resolutionâ˜…â˜…</text>
</a>
</g>
</g>
<!-- scapi&#45;&gt;scopes -->
<g id="edge34" class="edge"><title>scapi&#45;&gt;scopes</title>
<path fill="none" stroke="black" d="M170.082,-390C209.276,-390 257.397,-390 303.67,-390"/>
<polygon fill="black" stroke="black" points="303.822,-393.5 313.822,-390 303.822,-386.5 303.822,-393.5"/>
</g>
<!-- fixedmem&#45;&gt;cstf -->
<g id="edge59" class="edge"><title>fixedmem&#45;&gt;cstf</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1374.56,-150C1428.11,-150 1495.47,-150 1551.41,-150"/>
<polygon fill="black" stroke="black" points="1551.71,-153.5 1561.71,-150 1551.71,-146.5 1551.71,-153.5"/>
</g>
<!-- cbpsel&#45;&gt;fdpsel -->
<g id="edge61" class="edge"><title>cbpsel&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" d="M2114.05,-248C2161.77,-248 2220.59,-248 2270.96,-248"/>
<polygon fill="black" stroke="black" points="2271.24,-251.5 2281.24,-248 2271.24,-244.5 2271.24,-251.5"/>
</g>
<!-- cstf&#45;&gt;cbpsel -->
<g id="edge20" class="edge"><title>cstf&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" d="M1729.08,-168.089C1790.29,-184.844 1881.26,-209.748 1945.35,-227.292"/>
<polygon fill="black" stroke="black" points="1944.43,-230.669 1955,-229.934 1946.28,-223.918 1944.43,-230.669"/>
</g>
<!-- cstf&#45;&gt;ncst -->
<g id="edge39" class="edge"><title>cstf&#45;&gt;ncst</title>
<path fill="none" stroke="black" d="M1762.25,-148.891C1819.79,-148.248 1891.15,-147.451 1944.35,-146.856"/>
<polygon fill="black" stroke="black" points="1944.44,-150.356 1954.4,-146.744 1944.37,-143.356 1944.44,-150.356"/>
</g>
<!-- exprcomp -->
<g id="node25" class="node"><title>exprcomp</title>
<g id="a_node25"><a xlink:href="#exprcomp" xlink:title="ðŸŽ¯Expression compilationâ˜…">
<defs>
<linearGradient id="l_3" gradientUnits="userSpaceOnUse" x1="1193" y1="-762" x2="1366" y2="-762" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_3)" stroke="black" points="1366,-780 1193,-780 1193,-744 1366,-744 1366,-780"/>
<text text-anchor="middle" x="1279.5" y="-758.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Expression compilationâ˜…</text>
</a>
</g>
</g>
<!-- exprcomp&#45;&gt;plancomp -->
<g id="edge46" class="edge"><title>exprcomp&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1366.32,-776.831C1443.23,-788.948 1559.27,-804.34 1661,-806"/>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1663,-806C1762.39,-807.622 1877.27,-804.097 1949.53,-801.222"/>
<polygon fill="black" stroke="black" points="1950.03,-804.705 1959.88,-800.803 1949.74,-797.711 1950.03,-804.705"/>
</g>
<!-- leafdata -->
<g id="node26" class="node"><title>leafdata</title>
<g id="a_node26"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<defs>
<linearGradient id="l_4" gradientUnits="userSpaceOnUse" x1="421.5" y1="-467" x2="527.5" y2="-467" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_4)" stroke="black" points="527.5,-485 421.5,-485 421.5,-449 527.5,-449 527.5,-485"/>
<text text-anchor="middle" x="474.5" y="-463.3" font-family="Times,serif" font-size="14.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;apply -->
<g id="edge42" class="edge"><title>leafdata&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M527.675,-451.139C587.992,-432.973 690.351,-402.671 779,-379 787.091,-376.84 795.534,-374.654 803.989,-372.511"/>
<polygon fill="black" stroke="black" points="805.057,-375.852 813.901,-370.019 803.35,-369.063 805.057,-375.852"/>
</g>
<!-- leafdata&#45;&gt;exprcomp -->
<g id="edge25" class="edge"><title>leafdata&#45;&gt;exprcomp</title>
<path fill="none" stroke="black" d="M488.975,-485.253C535.738,-546.762 698.631,-746.06 889.5,-808"/>
<path fill="none" stroke="black" d="M891.5,-808C944.411,-825.17 1089.01,-801.306 1185.69,-782.036"/>
<polygon fill="black" stroke="black" points="1186.65,-785.413 1195.77,-780.01 1185.27,-778.55 1186.65,-785.413"/>
</g>
<!-- irast -->
<g id="node27" class="node"><title>irast</title>
<g id="a_node27"><a xlink:href="#irast" xlink:title="ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…">
<defs>
<linearGradient id="l_5" gradientUnits="userSpaceOnUse" x1="791" y1="-693" x2="990" y2="-693" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_5)" stroke="black" points="990,-711 791,-711 791,-675 990,-675 990,-711"/>
<text text-anchor="middle" x="890.5" y="-689.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;irast -->
<g id="edge52" class="edge"><title>leafdata&#45;&gt;irast</title>
<path fill="none" stroke="black" d="M508.68,-485.112C583.489,-525.951 765.192,-625.141 847.611,-670.133"/>
<polygon fill="black" stroke="black" points="845.996,-673.239 856.45,-674.958 849.35,-667.095 845.996,-673.239"/>
</g>
<!-- leafdata&#45;&gt;cacheplans -->
<g id="edge55" class="edge"><title>leafdata&#45;&gt;cacheplans</title>
<path fill="none" stroke="black" d="M527.585,-465.199C716.301,-458.672 1364.77,-436.245 1586.2,-428.587"/>
<polygon fill="black" stroke="black" points="1586.54,-432.077 1596.41,-428.234 1586.3,-425.081 1586.54,-432.077"/>
</g>
<!-- leafdata&#45;&gt;plancomp -->
<g id="edge44" class="edge"><title>leafdata&#45;&gt;plancomp</title>
<path fill="none" stroke="black" d="M891.5,-808C1216.8,-913.565 1319.04,-800.421 1661,-806"/>
</g>
<!-- irast&#45;&gt;irplan -->
<g id="edge30" class="edge"><title>irast&#45;&gt;irplan</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M990.158,-687.137C1049.86,-683.589 1125.56,-679.09 1184.41,-675.592"/>
<polygon fill="black" stroke="black" points="1184.67,-679.083 1194.45,-674.995 1184.26,-672.095 1184.67,-679.083"/>
</g>
<!-- irast&#45;&gt;exprcomp -->
<g id="edge26" class="edge"><title>irast&#45;&gt;exprcomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M990.158,-710.59C1049.33,-721.14 1124.21,-734.492 1182.84,-744.944"/>
<polygon fill="black" stroke="black" points="1182.39,-748.419 1192.85,-746.728 1183.62,-741.527 1182.39,-748.419"/>
</g>
<!-- irast&#45;&gt;vector -->
<g id="edge50" class="edge"><title>irast&#45;&gt;vector</title>
<path fill="none" stroke="black" d="M990.129,-695.669C1118.89,-700.061 1336.8,-710.86 1413,-735 1483.85,-757.445 1485.84,-798.574 1557,-820 1754.73,-879.535 1814.5,-844 2021,-844 2021,-844 2021,-844 2384,-844 2586.4,-844 2637.13,-839.642 2839,-825 2882.64,-821.835 2930.27,-817.244 2972.76,-812.742"/>
<polygon fill="black" stroke="black" points="2973.31,-816.204 2982.88,-811.662 2972.56,-809.244 2973.31,-816.204"/>
</g>
<!-- ctes -->
<g id="node28" class="node"><title>ctes</title>
<g id="a_node28"><a xlink:href="#ctes" xlink:title="ðŸŽ¯Common table expressions (CTEs)">
<defs>
<linearGradient id="l_6" gradientUnits="userSpaceOnUse" x1="779" y1="-406" x2="1002" y2="-406" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightgreen;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_6)" stroke="black" points="1002,-424 779,-424 779,-388 1002,-388 1002,-424"/>
<text text-anchor="middle" x="890.5" y="-402.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Common table expressions (CTEs)</text>
</a>
</g>
</g>
<!-- scopes&#45;&gt;apply -->
<g id="edge41" class="edge"><title>scopes&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M635.267,-375.335C692.441,-370.088 754.694,-364.374 803.287,-359.913"/>
<polygon fill="black" stroke="black" points="803.804,-363.381 813.442,-358.981 803.164,-356.41 803.804,-363.381"/>
</g>
<!-- scopes&#45;&gt;ctes -->
<g id="edge27" class="edge"><title>scopes&#45;&gt;ctes</title>
<path fill="none" stroke="black" d="M635.267,-396.175C679.539,-397.886 726.857,-399.714 768.519,-401.324"/>
<polygon fill="black" stroke="black" points="768.577,-404.829 778.705,-401.718 768.847,-397.834 768.577,-404.829"/>
</g>
<!-- opthints -->
<g id="node30" class="node"><title>opthints</title>
<g id="a_node30"><a xlink:href="#opthints" xlink:title="ðŸŽ¯Enable manual override of planner decisions">
<defs>
<linearGradient id="l_7" gradientUnits="userSpaceOnUse" x1="337" y1="-315" x2="612" y2="-315" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightgreen;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_7)" stroke="black" points="612,-333 337,-333 337,-297 612,-297 612,-333"/>
<text text-anchor="middle" x="474.5" y="-311.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Enable manual override of planner decisions</text>
</a>
</g>
</g>
<!-- opthints&#45;&gt;incrjoin -->
<g id="edge32" class="edge"><title>opthints&#45;&gt;incrjoin</title>
<path fill="none" stroke="black" d="M612.206,-306.084C669.957,-302.318 735.99,-298.012 789.128,-294.546"/>
<polygon fill="black" stroke="black" points="789.484,-298.03 799.235,-293.887 789.029,-291.045 789.484,-298.03"/>
</g>
<!-- explstats -->
<g id="node35" class="node"><title>explstats</title>
<g id="a_node35"><a xlink:href="#explstats" xlink:title="ðŸŽ¯Expose query stats to users">
<polygon fill="lightgreen" stroke="black" points="2111.5,-375 1932.5,-375 1932.5,-339 2111.5,-339 2111.5,-375"/>
<text text-anchor="middle" x="2022" y="-353.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Expose query stats to users</text>
</a>
</g>
</g>
<!-- explstats&#45;&gt;dbaoverride -->
<g id="edge35" class="edge"><title>explstats&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" d="M2111.74,-374.056C2162.17,-383.748 2225.56,-395.932 2278.27,-406.063"/>
<polygon fill="black" stroke="black" points="2277.84,-409.545 2288.32,-407.995 2279.16,-402.671 2277.84,-409.545"/>
</g>
<!-- cacheplans&#45;&gt;dbaoverride -->
<g id="edge37" class="edge"><title>cacheplans&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M1727.76,-426C1849.4,-426 2113.53,-426 2266.38,-426"/>
<polygon fill="black" stroke="black" points="2266.74,-429.5 2276.74,-426 2266.74,-422.5 2266.74,-429.5"/>
</g>
<!-- qexstats&#45;&gt;explstats -->
<g id="edge54" class="edge"><title>qexstats&#45;&gt;explstats</title>
<path fill="none" stroke="black" d="M1750.12,-339.597C1802.03,-342.932 1868.1,-347.177 1921.98,-350.639"/>
<polygon fill="black" stroke="black" points="1922.04,-354.149 1932.24,-351.298 1922.49,-347.164 1922.04,-354.149"/>
</g>
<!-- qexstats&#45;&gt;fdpsel -->
<g id="edge62" class="edge"><title>qexstats&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" d="M1750.09,-323.584C1880.8,-307.949 2127.64,-278.425 2271.07,-261.269"/>
<polygon fill="black" stroke="black" points="2271.7,-264.718 2281.21,-260.055 2270.87,-257.768 2271.7,-264.718"/>
</g>
<!-- batchrows -->
<g id="node42" class="node"><title>batchrows</title>
<g id="a_node42"><a xlink:href="#batchrows" xlink:title="ðŸŽ¯ðŸŽ¯Batched row processing">
<defs>
<linearGradient id="l_8" gradientUnits="userSpaceOnUse" x1="2295" y1="-798" x2="2471" y2="-798" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_8)" stroke="black" points="2471,-816 2295,-816 2295,-780 2471,-780 2471,-816"/>
<text text-anchor="middle" x="2383" y="-794.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Batched row processing</text>
</a>
</g>
</g>
<!-- plancomp&#45;&gt;batchrows -->
<g id="edge60" class="edge"><title>plancomp&#45;&gt;batchrows</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M2084.31,-798C2139.24,-798 2220.77,-798 2284.62,-798"/>
<polygon fill="black" stroke="black" points="2284.71,-801.5 2294.71,-798 2284.71,-794.5 2284.71,-801.5"/>
</g>
<!-- cstore -->
<g id="node41" class="node"><title>cstore</title>
<g id="a_node41"><a xlink:href="#cstore" xlink:title="ðŸŽ¯Column storage for row batches">
<polygon fill="lightblue" stroke="black" points="2839,-816 2633,-816 2633,-780 2839,-780 2839,-816"/>
<text text-anchor="middle" x="2736" y="-794.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Column storage for row batches</text>
</a>
</g>
</g>
<!-- cstore&#45;&gt;vector -->
<g id="edge49" class="edge"><title>cstore&#45;&gt;vector</title>
<path fill="none" stroke="black" d="M2839.08,-798C2880.52,-798 2928.84,-798 2972.55,-798"/>
<polygon fill="black" stroke="black" points="2972.68,-801.5 2982.68,-798 2972.68,-794.5 2972.68,-801.5"/>
</g>
<!-- batchrows&#45;&gt;cstore -->
<g id="edge53" class="edge"><title>batchrows&#45;&gt;cstore</title>
<path fill="none" stroke="black" d="M2471.22,-798C2517.09,-798 2573.84,-798 2622.94,-798"/>
<polygon fill="black" stroke="black" points="2622.97,-801.5 2632.97,-798 2622.97,-794.5 2622.97,-801.5"/>
</g>
</g>
</svg>
</div>
</div>
<div class="section" id="areas-of-work">
<h2><a class="toc-backref" href="#id19"><span class="sectnum">4.2</span> Areas of work</a></h2>
<p>Here are the major areas of work that form clusters of related work
items in the definitions below:</p>
<ul class="simple">
<li><p><em>semantic extensions</em> to the SQL engine, which enables running SQL
queries which were not supported previously.</p></li>
<li><p><em>middle-end refactorings</em> / extensions; this supports
e.g. further work on logical plan optimizations.</p></li>
<li><p><em>back-end refactorings</em> / extensions; this supports
e.g. new algorithms to execute queries.</p></li>
<li><p><em>query compilation</em>: improving row throughput.</p></li>
<li><p><em>perf. opts. for logical plan selection</em>: improving latency to last
result.</p></li>
<li><p><em>perf. opts. for logical planning</em>: improving latency to first
result.</p></li>
</ul>
<p>Some work items may conceptually belong to two or more clusters; for
the sake of readability, these are grouped visually in the cluster
where they most naturally belong.</p>
</div>
<div class="section" id="work-items-for-semantic-extensions">
<h2><a class="toc-backref" href="#id20"><span class="sectnum">4.3</span> Work items for semantic extensions</a></h2>
<div class="contents local topic" id="id3">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#common-table-expressions-ctes" id="id28"><span class="sectnum">4.3.1</span> Common table expressions (CTEs)</a></p></li>
<li><p><a class="reference internal" href="#apply-relational-operator" id="id29"><span class="sectnum">4.3.2</span> Apply relational operator</a></p></li>
<li><p><a class="reference internal" href="#general-purpose-correlated-subqueries-csqs" id="id30"><span class="sectnum">4.3.3</span> General-purpose correlated subqueries (CSQs)</a></p></li>
<li><p><a class="reference internal" href="#semi-joins" id="id31"><span class="sectnum">4.3.4</span> Semi-joins</a></p></li>
</ul>
</div>
<div class="section" id="common-table-expressions-ctes">
<h3><a class="toc-backref" href="#id28"><span class="sectnum">4.3.1</span> Common table expressions (CTEs)</a></h3>
<p id="ctes">Overview:</p>
<div id='svg-container-ctes'>
<svg id='svg-ctes' width="570pt" height="44pt"
 viewBox="0.00 0.00 570.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 566,-40 566,4 -4,4"/>
<!-- ctes -->
<g id="node1" class="node"><title>ctes</title>
<g id="a_node1"><a xlink:href="#ctes" xlink:title="ðŸŽ¯Common table expressions (CTEs)">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="339" y1="-18" x2="562" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightgreen;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="562,-36 339,-36 339,-0 562,-0 562,-36"/>
<text text-anchor="middle" x="450.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Common table expressions (CTEs)</text>
</a>
</g>
</g>
<!-- scopes -->
<g id="node2" class="node"><title>scopes</title>
<g id="a_node2"><a xlink:href="#scopes" xlink:title="Introduce scoping and free vars in name resolutionâ˜…â˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="195,-36 1.42109e-14,-36 1.42109e-14,-0 195,-0 195,-36"/>
<text text-anchor="middle" x="97.5" y="-16.1" font-family="Times,serif" font-size="8.00">Introduce scoping and free vars in name resolutionâ˜…â˜…</text>
</a>
</g>
</g>
<!-- scopes&#45;&gt;ctes -->
<g id="edge1" class="edge"><title>scopes&#45;&gt;ctes</title>
<path fill="none" stroke="black" d="M195.341,-18C236.569,-18 285.099,-18 328.643,-18"/>
<polygon fill="black" stroke="black" points="328.722,-21.5001 338.722,-18 328.722,-14.5001 328.722,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>support the WITH syntax (not recursive)</p></li>
</ul>
</div>
<div class="section" id="apply-relational-operator">
<h3><a class="toc-backref" href="#id29"><span class="sectnum">4.3.2</span> Apply relational operator</a></h3>
<p id="apply">Overview:</p>
<div id='svg-container-apply'>
<svg id='svg-apply' width="501pt" height="152pt"
 viewBox="0.00 0.00 501.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 497,-148 497,4 -4,4"/>
<!-- apply -->
<g id="node1" class="node"><title>apply</title>
<g id="a_node1"><a xlink:href="#apply" xlink:title="Apply relational operator">
<polygon fill="pink" stroke="black" points="493,-90 339,-90 339,-54 493,-54 493,-90"/>
<text text-anchor="middle" x="416" y="-68.3" font-family="Times,serif" font-size="14.00">Apply relational operator</text>
</a>
</g>
</g>
<!-- scopes -->
<g id="node2" class="node"><title>scopes</title>
<g id="a_node2"><a xlink:href="#scopes" xlink:title="Introduce scoping and free vars in name resolutionâ˜…â˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="195,-144 1.42109e-14,-144 1.42109e-14,-108 195,-108 195,-144"/>
<text text-anchor="middle" x="97.5" y="-124.1" font-family="Times,serif" font-size="8.00">Introduce scoping and free vars in name resolutionâ˜…â˜…</text>
</a>
</g>
</g>
<!-- scopes&#45;&gt;apply -->
<g id="edge1" class="edge"><title>scopes&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M195.18,-109.505C237.838,-102.227 287.567,-93.7422 328.925,-86.6857"/>
<polygon fill="black" stroke="black" points="329.708,-90.1029 338.976,-84.9708 328.53,-83.2026 329.708,-90.1029"/>
</g>
<!-- leafdata -->
<g id="node3" class="node"><title>leafdata</title>
<g id="a_node3"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="133,-90 62,-90 62,-54 133,-54 133,-90"/>
<text text-anchor="middle" x="97.5" y="-70.1" font-family="Times,serif" font-size="8.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;apply -->
<g id="edge2" class="edge"><title>leafdata&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M133.276,-72C179.919,-72 264.31,-72 328.607,-72"/>
<polygon fill="black" stroke="black" points="328.745,-75.5001 338.745,-72 328.745,-68.5001 328.745,-75.5001"/>
</g>
<!-- restart -->
<g id="node4" class="node"><title>restart</title>
<g id="a_node4"><a xlink:href="#restart" xlink:title="Make physical plans restartable">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="157,-36 38,-36 38,-0 157,-0 157,-36"/>
<text text-anchor="middle" x="97.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make physical plans restartable</text>
</a>
</g>
</g>
<!-- restart&#45;&gt;apply -->
<g id="edge3" class="edge"><title>restart&#45;&gt;apply</title>
<path fill="none" stroke="black" d="M157.289,-28.0304C205.506,-36.2569 274.438,-48.0178 328.88,-57.3065"/>
<polygon fill="black" stroke="black" points="328.422,-60.779 338.869,-59.0108 329.6,-53.8787 328.422,-60.779"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>new function/operator &quot;apply&quot; which given a logical plan and a row of
values,
binds the free variables in the plan to the values and runs the plan.</p></li>
<li><p>provide infrastructure to run apply wherever present in a plan (ie.
when not optimized away - removing apply is then done in particular
query
patterns during a later optimization).</p></li>
</ul>
</div>
<div class="section" id="general-purpose-correlated-subqueries-csqs">
<h3><a class="toc-backref" href="#id30"><span class="sectnum">4.3.3</span> General-purpose correlated subqueries (CSQs)</a></h3>
<p id="corr">Overview:</p>
<div id='svg-container-corr'>
<svg id='svg-corr' width="485pt" height="44pt"
 viewBox="0.00 0.00 485.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 481,-40 481,4 -4,4"/>
<!-- corr -->
<g id="node1" class="node"><title>corr</title>
<g id="a_node1"><a xlink:href="#corr" xlink:title="ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries">
<polygon fill="lightgreen" stroke="black" points="477,-36 242,-36 242,-0 477,-0 477,-36"/>
<text text-anchor="middle" x="359.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries</text>
</a>
</g>
</g>
<!-- apply -->
<g id="node2" class="node"><title>apply</title>
<g id="a_node2"><a xlink:href="#apply" xlink:title="Apply relational operator">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="98,-36 7.10543e-15,-36 7.10543e-15,-0 98,-0 98,-36"/>
<text text-anchor="middle" x="49" y="-16.1" font-family="Times,serif" font-size="8.00">Apply relational operator</text>
</a>
</g>
</g>
<!-- apply&#45;&gt;corr -->
<g id="edge1" class="edge"><title>apply&#45;&gt;corr</title>
<path fill="none" stroke="black" d="M98.2031,-18C133.963,-18 184.461,-18 231.474,-18"/>
<polygon fill="black" stroke="black" points="231.759,-21.5001 241.759,-18 231.759,-14.5001 231.759,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>encapsulate sub-plans with free variables with an apply operator.</p></li>
<li><p>add the corresponding logic tests</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>this makes CockroachDB able to run arbitrary sub-queries.</p></li>
</ul>
</div>
<div class="section" id="semi-joins">
<h3><a class="toc-backref" href="#id31"><span class="sectnum">4.3.4</span> Semi-joins</a></h3>
<p id="sjoin">Overview:</p>
<div id='svg-container-sjoin'>
<svg id='svg-sjoin' width="84pt" height="44pt"
 viewBox="0.00 0.00 84.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 80,-40 80,4 -4,4"/>
<!-- sjoin -->
<g id="node1" class="node"><title>sjoin</title>
<g id="a_node1"><a xlink:href="#sjoin" xlink:title="Semi&#45;joins">
<polygon fill="pink" stroke="black" points="76,-36 0,-36 0,-0 76,-0 76,-36"/>
<text text-anchor="middle" x="38" y="-14.3" font-family="Times,serif" font-size="14.00">Semi&#45;joins</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Semi-join(A, B, P, X): a relational operator which, for every row in A
for which a row in B matches according to join predicate P, runs
plan/operator X with the matching rows in A and B as arguments.</p>
<p>Goals:</p>
<ul class="simple">
<li><p>introduce the semi-join logical operator</p></li>
<li><p>implement a logical execution path to run this operator
for testing (for testing; the semijoins later dissipate into
regular joins by rewriting)</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="query-compilation">
<h2><a class="toc-backref" href="#id21"><span class="sectnum">4.4</span> Query compilation</a></h2>
<p>Query compilation is a class of optimizations that improves the
overall row throughput during the execution of a single query, by
paying the cost of an extra compilation step before query
execution can start.</p>
<p>The essence of compilation is to pre-allocate (&quot;statically&quot;) resources
needed during execution before the execution starts. For example,
native code generation pre-allocates stack entries and machine
registers for variables. Another example is compilation of a task
schedule (&quot;static scheduling&quot;), where task segments are identified
upfront and a branch to the (pre-decided) next task segment is
inserted in the code at the end of each segment, bypassing the need
for any scheduling logic in a runtime system.</p>
<div class="contents local topic" id="id4">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#expression-compilation" id="id32"><span class="sectnum">4.4.1</span> Expression compilation</a></p></li>
<li><p><a class="reference internal" href="#plan-compilation-for-local-execution" id="id33"><span class="sectnum">4.4.2</span> Plan compilation for local execution</a></p></li>
<li><p><a class="reference internal" href="#batched-row-processing" id="id34"><span class="sectnum">4.4.3</span> Batched row processing</a></p></li>
<li><p><a class="reference internal" href="#column-storage-for-row-batches" id="id35"><span class="sectnum">4.4.4</span> Column storage for row batches</a></p></li>
<li><p><a class="reference internal" href="#vectorized-operations-on-row-batches" id="id36"><span class="sectnum">4.4.5</span> Vectorized operations on row batches</a></p></li>
</ul>
</div>
<div class="section" id="expression-compilation">
<h3><a class="toc-backref" href="#id32"><span class="sectnum">4.4.1</span> Expression compilation</a></h3>
<p id="exprcomp">Overview:</p>
<div id='svg-container-exprcomp'>
<svg id='svg-exprcomp' width="450pt" height="98pt"
 viewBox="0.00 0.00 450.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 446,-94 446,4 -4,4"/>
<!-- exprcomp -->
<g id="node1" class="node"><title>exprcomp</title>
<g id="a_node1"><a xlink:href="#exprcomp" xlink:title="ðŸŽ¯Expression compilationâ˜…">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="269" y1="-45" x2="442" y2="-45" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="442,-63 269,-63 269,-27 442,-27 442,-63"/>
<text text-anchor="middle" x="355.5" y="-41.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Expression compilationâ˜…</text>
</a>
</g>
</g>
<!-- leafdata -->
<g id="node2" class="node"><title>leafdata</title>
<g id="a_node2"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="98,-90 27,-90 27,-54 98,-54 98,-90"/>
<text text-anchor="middle" x="62.5" y="-70.1" font-family="Times,serif" font-size="8.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;exprcomp -->
<g id="edge1" class="edge"><title>leafdata&#45;&gt;exprcomp</title>
<path fill="none" stroke="black" d="M98.0243,-68.7967C137.425,-65.1409 203.558,-59.0049 258.8,-53.8794"/>
<polygon fill="black" stroke="black" points="259.345,-57.3439 268.979,-52.9349 258.698,-50.3739 259.345,-57.3439"/>
</g>
<!-- irast -->
<g id="node3" class="node"><title>irast</title>
<g id="a_node3"><a xlink:href="#irast" xlink:title="ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="125,-36 7.10543e-15,-36 7.10543e-15,-0 125,-0 125,-36"/>
<text text-anchor="middle" x="62.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…</text>
</a>
</g>
</g>
<!-- irast&#45;&gt;exprcomp -->
<g id="edge2" class="edge"><title>irast&#45;&gt;exprcomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M125.214,-23.726C163.986,-27.3234 214.8,-32.0381 258.736,-36.1146"/>
<polygon fill="black" stroke="black" points="258.588,-39.6159 268.869,-37.0548 259.235,-32.6458 258.588,-39.6159"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>eliminate allocations of <span class="docutils literal">Datum</span>s during SQL expression
evaluation
(by preallocating intermediate temporary values and reusing them
between evaluations).</p></li>
<li><p>reduce/eliminate the need for tree traversals for evaluation (by
pre-scheduling the operations to perform).</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster throughput overall</p></li>
<li><p>lower memory footprint throughout CockroachDB, by reducing
the amount of dead Datums waiting for GC by the Go runtime</p></li>
</ul>
</div>
<div class="section" id="plan-compilation-for-local-execution">
<h3><a class="toc-backref" href="#id33"><span class="sectnum">4.4.2</span> Plan compilation for local execution</a></h3>
<p id="plancomp">Overview:</p>
<div id='svg-container-plancomp'>
<svg id='svg-plancomp' width="405pt" height="260pt"
 viewBox="0.00 0.00 405.00 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-256 401,-256 401,4 -4,4"/>
<!-- plancomp -->
<g id="node1" class="node"><title>plancomp</title>
<g id="a_node1"><a xlink:href="#plancomp" xlink:title="ðŸŽ¯Plan compilation">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="273" y1="-126" x2="397" y2="-126" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="397,-144 273,-144 273,-108 397,-108 397,-144"/>
<text text-anchor="middle" x="335" y="-122.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Plan compilation</text>
</a>
</g>
</g>
<!-- leafdata -->
<g id="node2" class="node"><title>leafdata</title>
<g id="a_node2"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="100,-252 29,-252 29,-216 100,-216 100,-252"/>
<text text-anchor="middle" x="64.5" y="-232.1" font-family="Times,serif" font-size="8.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;plancomp -->
<g id="edge1" class="edge"><title>leafdata&#45;&gt;plancomp</title>
<path fill="none" stroke="black" d="M100.052,-220.102C145.481,-201.829 225.802,-169.521 279.471,-147.933"/>
<polygon fill="black" stroke="black" points="280.865,-151.145 288.837,-144.166 278.253,-144.651 280.865,-151.145"/>
</g>
<!-- ctxfreeplans -->
<g id="node3" class="node"><title>ctxfreeplans</title>
<g id="a_node3"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-198 0,-198 0,-162 129,-162 129,-198"/>
<text text-anchor="middle" x="64.5" y="-178.1" font-family="Times,serif" font-size="8.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;plancomp -->
<g id="edge2" class="edge"><title>ctxfreeplans&#45;&gt;plancomp</title>
<path fill="none" stroke="black" d="M129.131,-167.203C169.245,-159.135 221.118,-148.703 262.63,-140.354"/>
<polygon fill="black" stroke="black" points="263.561,-143.737 272.674,-138.334 262.18,-136.874 263.561,-143.737"/>
</g>
<!-- exprcomp -->
<g id="node4" class="node"><title>exprcomp</title>
<g id="a_node4"><a xlink:href="#exprcomp" xlink:title="ðŸŽ¯Expression compilationâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="118,-144 11,-144 11,-108 118,-108 118,-144"/>
<text text-anchor="middle" x="64.5" y="-124.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Expression compilationâ˜…</text>
</a>
</g>
</g>
<!-- exprcomp&#45;&gt;plancomp -->
<g id="edge3" class="edge"><title>exprcomp&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M118.227,-126C159.544,-126 217.442,-126 262.863,-126"/>
<polygon fill="black" stroke="black" points="262.941,-129.5 272.941,-126 262.941,-122.5 262.941,-129.5"/>
</g>
<!-- planser -->
<g id="node5" class="node"><title>planser</title>
<g id="a_node5"><a xlink:href="#planser" xlink:title="Logical plan spec/ser language">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="122.5,-90 6.5,-90 6.5,-54 122.5,-54 122.5,-90"/>
<text text-anchor="middle" x="64.5" y="-70.1" font-family="Times,serif" font-size="8.00">Logical plan spec/ser language</text>
</a>
</g>
</g>
<!-- planser&#45;&gt;plancomp -->
<g id="edge4" class="edge"><title>planser&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M122.771,-83.5181C163.636,-91.7368 218.874,-102.846 262.613,-111.643"/>
<polygon fill="black" stroke="black" points="262.119,-115.113 272.612,-113.654 263.499,-108.251 262.119,-115.113"/>
</g>
<!-- irplan -->
<g id="node6" class="node"><title>irplan</title>
<g id="a_node6"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="118,-36 11,-36 11,-0 118,-0 118,-36"/>
<text text-anchor="middle" x="64.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;plancomp -->
<g id="edge5" class="edge"><title>irplan&#45;&gt;plancomp</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M110.441,-36.0768C157.004,-54.8059 229.798,-84.0865 279.586,-104.113"/>
<polygon fill="black" stroke="black" points="278.329,-107.38 288.913,-107.864 280.941,-100.885 278.329,-107.38"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>eliminate allocations of <span class="docutils literal">[]Datum</span> (by preallocating
intermediate row buffers and reusing them during plan execution)
(note: already done in distsql)</p></li>
<li><p>reduce/eliminate the need for dynamic dispatch in local execution
by pre-allocating processors and linking them via shared buffers
(note: already done in distsql)</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster throughput overall;</p></li>
<li><p>lower memory footprint throughout CockroachDB, by reducing
the amount of dead Datums waiting for GC by the Go runtime;</p></li>
</ul>
</div>
<div class="section" id="batched-row-processing">
<h3><a class="toc-backref" href="#id34"><span class="sectnum">4.4.3</span> Batched row processing</a></h3>
<p id="batchrows">Overview:</p>
<div id='svg-container-batchrows'>
<svg id='svg-batchrows' width="407pt" height="44pt"
 viewBox="0.00 0.00 407.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 403,-40 403,4 -4,4"/>
<!-- batchrows -->
<g id="node1" class="node"><title>batchrows</title>
<g id="a_node1"><a xlink:href="#batchrows" xlink:title="ðŸŽ¯ðŸŽ¯Batched row processing">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="223" y1="-18" x2="399" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="399,-36 223,-36 223,-0 399,-0 399,-36"/>
<text text-anchor="middle" x="311" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Batched row processing</text>
</a>
</g>
</g>
<!-- plancomp -->
<g id="node2" class="node"><title>plancomp</title>
<g id="a_node2"><a xlink:href="#plancomp" xlink:title="ðŸŽ¯Plan compilation">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="79,-36 7.10543e-15,-36 7.10543e-15,-0 79,-0 79,-36"/>
<text text-anchor="middle" x="39.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Plan compilation</text>
</a>
</g>
</g>
<!-- plancomp&#45;&gt;batchrows -->
<g id="edge1" class="edge"><title>plancomp&#45;&gt;batchrows</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M79.1128,-18C113.893,-18 166.503,-18 212.723,-18"/>
<polygon fill="black" stroke="black" points="212.785,-21.5001 222.785,-18 212.785,-14.5001 212.785,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>make every plan processor work on batches (&quot;segments&quot;) of multiple
rows at a time.</p></li>
<li><p>change the interface between components to support this.</p></li>
<li><p>stretch goal: if implemented after lookup joins, extend lookup joins
to concentrate key prefixes across batches.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster throughput overall</p></li>
</ul>
</div>
<div class="section" id="column-storage-for-row-batches">
<h3><a class="toc-backref" href="#id35"><span class="sectnum">4.4.4</span> Column storage for row batches</a></h3>
<p id="cstore">Overview:</p>
<div id='svg-container-cstore'>
<svg id='svg-cstore' width="468pt" height="44pt"
 viewBox="0.00 0.00 468.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 464,-40 464,4 -4,4"/>
<!-- cstore -->
<g id="node1" class="node"><title>cstore</title>
<g id="a_node1"><a xlink:href="#cstore" xlink:title="ðŸŽ¯Column storage for row batches">
<polygon fill="lightblue" stroke="black" points="460,-36 254,-36 254,-0 460,-0 460,-36"/>
<text text-anchor="middle" x="357" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Column storage for row batches</text>
</a>
</g>
</g>
<!-- batchrows -->
<g id="node2" class="node"><title>batchrows</title>
<g id="a_node2"><a xlink:href="#batchrows" xlink:title="ðŸŽ¯ðŸŽ¯Batched row processing">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="110,-36 0,-36 0,-0 110,-0 110,-36"/>
<text text-anchor="middle" x="55" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯ðŸŽ¯Batched row processing</text>
</a>
</g>
</g>
<!-- batchrows&#45;&gt;cstore -->
<g id="edge1" class="edge"><title>batchrows&#45;&gt;cstore</title>
<path fill="none" stroke="black" d="M110.328,-18C147.453,-18 197.998,-18 243.591,-18"/>
<polygon fill="black" stroke="black" points="243.842,-21.5001 253.842,-18 243.842,-14.5001 243.842,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>store row batches by columns (i.e. all values in a column of a batch
are contiguous in memory)</p></li>
<li><p>validate (measure) that doing so ensure that filters/renders etc
maximize locality of access across rows</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster throughput overall</p></li>
</ul>
</div>
<div class="section" id="vectorized-operations-on-row-batches">
<h3><a class="toc-backref" href="#id36"><span class="sectnum">4.4.5</span> Vectorized operations on row batches</a></h3>
<p id="vector">Overview:</p>
<div id='svg-container-vector'>
<svg id='svg-vector' width="516pt" height="152pt"
 viewBox="0.00 0.00 516.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 512,-148 512,4 -4,4"/>
<!-- vector -->
<g id="node1" class="node"><title>vector</title>
<g id="a_node1"><a xlink:href="#vector" xlink:title="ðŸŽ¯Vectorized operations on row batches">
<polygon fill="lightblue" stroke="black" points="508,-90 272,-90 272,-54 508,-54 508,-90"/>
<text text-anchor="middle" x="390" y="-68.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Vectorized operations on row batches</text>
</a>
</g>
</g>
<!-- cstore -->
<g id="node2" class="node"><title>cstore</title>
<g id="a_node2"><a xlink:href="#cstore" xlink:title="ðŸŽ¯Column storage for row batches">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="128,-144 0,-144 0,-108 128,-108 128,-144"/>
<text text-anchor="middle" x="64" y="-124.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Column storage for row batches</text>
</a>
</g>
</g>
<!-- cstore&#45;&gt;vector -->
<g id="edge1" class="edge"><title>cstore&#45;&gt;vector</title>
<path fill="none" stroke="black" d="M128.24,-115.46C168.814,-108.698 222.754,-99.7077 271.044,-91.6594"/>
<polygon fill="black" stroke="black" points="271.649,-95.1068 280.938,-90.0104 270.498,-88.2021 271.649,-95.1068"/>
</g>
<!-- irast -->
<g id="node3" class="node"><title>irast</title>
<g id="a_node3"><a xlink:href="#irast" xlink:title="ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="126.5,-90 1.5,-90 1.5,-54 126.5,-54 126.5,-90"/>
<text text-anchor="middle" x="64" y="-70.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…</text>
</a>
</g>
</g>
<!-- irast&#45;&gt;vector -->
<g id="edge2" class="edge"><title>irast&#45;&gt;vector</title>
<path fill="none" stroke="black" d="M126.705,-72C164.85,-72 215.226,-72 261.626,-72"/>
<polygon fill="black" stroke="black" points="261.769,-75.5001 271.769,-72 261.769,-68.5001 261.769,-75.5001"/>
</g>
<!-- irplan -->
<g id="node4" class="node"><title>irplan</title>
<g id="a_node4"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="117.5,-36 10.5,-36 10.5,-0 117.5,-0 117.5,-36"/>
<text text-anchor="middle" x="64" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;vector -->
<g id="edge3" class="edge"><title>irplan&#45;&gt;vector</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M117.777,-26.7962C159.134,-33.689 218.266,-43.5444 270.768,-52.2947"/>
<polygon fill="black" stroke="black" points="270.391,-55.78 280.83,-53.9717 271.542,-48.8753 270.391,-55.78"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>make common filtering/projection steps use vector operations</p></li>
<li><p>validate (measure) this yields throughput improvements</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster throughput overall</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="middle-end-refactorings">
<h2><a class="toc-backref" href="#id22"><span class="sectnum">4.5</span> Middle-end refactorings</a></h2>
<div class="contents local topic" id="id5">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#sql-leaf-data" id="id37"><span class="sectnum">4.5.1</span> SQL leaf data</a></p></li>
<li><p><a class="reference internal" href="#use-ir-codegen-for-asts" id="id38"><span class="sectnum">4.5.2</span> Use IR codegen for ASTs</a></p></li>
<li><p><a class="reference internal" href="#use-ir-codegen-for-logical-plans" id="id39"><span class="sectnum">4.5.3</span> Use IR codegen for logical plans</a></p></li>
<li><p><a class="reference internal" href="#make-plans-stateless-context-free" id="id40"><span class="sectnum">4.5.4</span> Make plans stateless / context-free</a></p></li>
<li><p><a class="reference internal" href="#logical-plan-specification-serialization-language" id="id41"><span class="sectnum">4.5.5</span> Logical plan specification/serialization language</a></p></li>
<li><p><a class="reference internal" href="#interface-based-schema-api" id="id42"><span class="sectnum">4.5.6</span> Interface-based schema API</a></p></li>
<li><p><a class="reference internal" href="#introduce-scoping-and-free-vars-in-name-resolution" id="id43"><span class="sectnum">4.5.7</span> Introduce scoping and free vars in name resolution</a></p></li>
</ul>
</div>
<div class="section" id="sql-leaf-data">
<h3><a class="toc-backref" href="#id37"><span class="sectnum">4.5.1</span> SQL leaf data</a></h3>
<p id="leafdata">Overview:</p>
<div id='svg-container-leafdata'>
<svg id='svg-leafdata' width="114pt" height="44pt"
 viewBox="0.00 0.00 114.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 110,-40 110,4 -4,4"/>
<!-- leafdata -->
<g id="node1" class="node"><title>leafdata</title>
<g id="a_node1"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="0" y1="-18" x2="106" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="106,-36 0,-36 0,-0 106,-0 106,-36"/>
<text text-anchor="middle" x="53" y="-14.3" font-family="Times,serif" font-size="14.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>migrate leaf data into a value data structure passed as argument
throughout semantic checks and evaluation</p></li>
<li><p>make IR trees immutable</p></li>
<li><p>reduce/eliminate allocations caused by tree rewrites</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>more performance</p></li>
<li><p>simpler to reason about the code</p></li>
</ul>
</div>
<div class="section" id="use-ir-codegen-for-asts">
<h3><a class="toc-backref" href="#id38"><span class="sectnum">4.5.2</span> Use IR codegen for ASTs</a></h3>
<p id="irast">Overview:</p>
<div id='svg-container-irast'>
<svg id='svg-irast' width="422pt" height="44pt"
 viewBox="0.00 0.00 422.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 418,-40 418,4 -4,4"/>
<!-- irast -->
<g id="node1" class="node"><title>irast</title>
<g id="a_node1"><a xlink:href="#irast" xlink:title="ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="215" y1="-18" x2="414" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="414,-36 215,-36 215,-0 414,-0 414,-36"/>
<text text-anchor="middle" x="314.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…</text>
</a>
</g>
</g>
<!-- leafdata -->
<g id="node2" class="node"><title>leafdata</title>
<g id="a_node2"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="71,-36 0,-36 0,-0 71,-0 71,-36"/>
<text text-anchor="middle" x="35.5" y="-16.1" font-family="Times,serif" font-size="8.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;irast -->
<g id="edge1" class="edge"><title>leafdata&#45;&gt;irast</title>
<path fill="none" stroke="black" d="M71.0222,-18C104.533,-18 157.183,-18 204.871,-18"/>
<polygon fill="black" stroke="black" points="204.963,-21.5001 214.963,-18 204.963,-14.5001 204.963,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define AST nodes using a higher-level, condensed definition language</p></li>
<li><p>reduce manually maintained boilerplate in Go sources</p></li>
<li><p>reduce allocation costs of parsing &amp; other tree algorithms</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>accelerates further engineering of tree algorithms</p></li>
<li><p>lower memory usage</p></li>
<li><p>probably more performance due to more efficient data storage</p></li>
</ul>
</div>
<div class="section" id="use-ir-codegen-for-logical-plans">
<h3><a class="toc-backref" href="#id39"><span class="sectnum">4.5.3</span> Use IR codegen for logical plans</a></h3>
<p id="irplan">Overview:</p>
<div id='svg-container-irplan'>
<svg id='svg-irplan' width="447pt" height="44pt"
 viewBox="0.00 0.00 447.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 443,-40 443,4 -4,4"/>
<!-- irplan -->
<g id="node1" class="node"><title>irplan</title>
<g id="a_node1"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="269" y1="-18" x2="439" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="439,-36 269,-36 269,-0 439,-0 439,-36"/>
<text text-anchor="middle" x="354" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irast -->
<g id="node2" class="node"><title>irast</title>
<g id="a_node2"><a xlink:href="#irast" xlink:title="ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="125,-36 7.10543e-15,-36 7.10543e-15,-0 125,-0 125,-36"/>
<text text-anchor="middle" x="62.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for ASTsâ˜…â˜…</text>
</a>
</g>
</g>
<!-- irast&#45;&gt;irplan -->
<g id="edge1" class="edge"><title>irast&#45;&gt;irplan</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M125.25,-18C164.073,-18 214.928,-18 258.731,-18"/>
<polygon fill="black" stroke="black" points="258.83,-21.5001 268.83,-18 258.83,-14.5001 258.83,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define logical plan nodes using a higher-level, condensed definition
language</p></li>
<li><p>reduce manually maintained boilerplate in Go sources</p></li>
<li><p>reduce allocation costs of logical planning &amp; other tree algorithms</p></li>
</ul>
</div>
<div class="section" id="make-plans-stateless-context-free">
<h3><a class="toc-backref" href="#id40"><span class="sectnum">4.5.4</span> Make plans stateless / context-free</a></h3>
<p id="ctxfreeplans">Overview:</p>
<div id='svg-container-ctxfreeplans'>
<svg id='svg-ctxfreeplans' width="214pt" height="44pt"
 viewBox="0.00 0.00 214.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 210,-40 210,4 -4,4"/>
<!-- ctxfreeplans -->
<g id="node1" class="node"><title>ctxfreeplans</title>
<g id="a_node1"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="pink" stroke="black" points="206,-36 0,-36 0,-0 206,-0 206,-36"/>
<text text-anchor="middle" x="103" y="-14.3" font-family="Times,serif" font-size="14.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>remove execution-level data structures from logical plan nodes (e.g.
make
them live in semi-persistent state tables attached to the planner)</p></li>
<li><p>make logical plan nodes immutable after logical planning</p></li>
<li><p>make logical plan nodes reusable across different queries that use
the same SQL text</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>makes it easier to reason about the code</p></li>
</ul>
</div>
<div class="section" id="logical-plan-specification-serialization-language">
<h3><a class="toc-backref" href="#id41"><span class="sectnum">4.5.5</span> Logical plan specification/serialization language</a></h3>
<p id="planser">Overview:</p>
<div id='svg-container-planser'>
<svg id='svg-planser' width="466pt" height="98pt"
 viewBox="0.00 0.00 466.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 462,-94 462,4 -4,4"/>
<!-- planser -->
<g id="node1" class="node"><title>planser</title>
<g id="a_node1"><a xlink:href="#planser" xlink:title="Logical plan spec/ser language">
<polygon fill="pink" stroke="black" points="458,-63 273,-63 273,-27 458,-27 458,-63"/>
<text text-anchor="middle" x="365.5" y="-41.3" font-family="Times,serif" font-size="14.00">Logical plan spec/ser language</text>
</a>
</g>
</g>
<!-- ctxfreeplans -->
<g id="node2" class="node"><title>ctxfreeplans</title>
<g id="a_node2"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-90 0,-90 0,-54 129,-54 129,-90"/>
<text text-anchor="middle" x="64.5" y="-70.1" font-family="Times,serif" font-size="8.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;planser -->
<g id="edge1" class="edge"><title>ctxfreeplans&#45;&gt;planser</title>
<path fill="none" stroke="black" d="M129.276,-66.2409C168.021,-62.7423 218.368,-58.1959 262.536,-54.2075"/>
<polygon fill="black" stroke="black" points="263.092,-57.6716 272.736,-53.2864 262.462,-50.7 263.092,-57.6716"/>
</g>
<!-- irplan -->
<g id="node3" class="node"><title>irplan</title>
<g id="a_node3"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="118,-36 11,-36 11,-0 118,-0 118,-36"/>
<text text-anchor="middle" x="64.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;planser -->
<g id="edge2" class="edge"><title>irplan&#45;&gt;planser</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M118.267,-22.7649C158.179,-26.369 214.21,-31.4287 262.742,-35.8112"/>
<polygon fill="black" stroke="black" points="262.702,-39.3217 272.976,-36.7353 263.332,-32.3501 262.702,-39.3217"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define and implement a mini-language to specify logical plans
exactly, so as to
enable bypassing of the SQL analysis / logical plans.</p></li>
<li><p>enable printing out an existing plan in this language.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>facilitates further testing and debugging of logical planner</p></li>
</ul>
</div>
<div class="section" id="interface-based-schema-api">
<h3><a class="toc-backref" href="#id42"><span class="sectnum">4.5.6</span> Interface-based schema API</a></h3>
<p id="scapi">Overview:</p>
<div id='svg-container-scapi'>
<svg id='svg-scapi' width="178pt" height="44pt"
 viewBox="0.00 0.00 178.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 174,-40 174,4 -4,4"/>
<!-- scapi -->
<g id="node1" class="node"><title>scapi</title>
<g id="a_node1"><a xlink:href="#scapi" xlink:title="Interface&#45;based schema API">
<polygon fill="pink" stroke="black" points="170,-36 0,-36 0,-0 170,-0 170,-36"/>
<text text-anchor="middle" x="85" y="-14.3" font-family="Times,serif" font-size="14.00">Interface&#45;based schema API</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>encapsulate all schema accessors behind an interface API</p></li>
</ul>
</div>
<div class="section" id="introduce-scoping-and-free-vars-in-name-resolution">
<h3><a class="toc-backref" href="#id43"><span class="sectnum">4.5.7</span> Introduce scoping and free vars in name resolution</a></h3>
<p id="scopes">Overview:</p>
<div id='svg-container-scopes'>
<svg id='svg-scopes' width="583pt" height="44pt"
 viewBox="0.00 0.00 583.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 579,-40 579,4 -4,4"/>
<!-- scopes -->
<g id="node1" class="node"><title>scopes</title>
<g id="a_node1"><a xlink:href="#scopes" xlink:title="Introduce scoping and free vars in name resolutionâ˜…â˜…">
<polygon fill="pink" stroke="black" points="575,-36 254,-36 254,-0 575,-0 575,-36"/>
<text text-anchor="middle" x="414.5" y="-14.3" font-family="Times,serif" font-size="14.00">Introduce scoping and free vars in name resolutionâ˜…â˜…</text>
</a>
</g>
</g>
<!-- scapi -->
<g id="node2" class="node"><title>scapi</title>
<g id="a_node2"><a xlink:href="#scapi" xlink:title="Interface&#45;based schema API">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="110,-36 0,-36 0,-0 110,-0 110,-36"/>
<text text-anchor="middle" x="55" y="-16.1" font-family="Times,serif" font-size="8.00">Interface&#45;based schema API</text>
</a>
</g>
</g>
<!-- scapi&#45;&gt;scopes -->
<g id="edge1" class="edge"><title>scapi&#45;&gt;scopes</title>
<path fill="none" stroke="black" d="M110.297,-18C146.13,-18 195.211,-18 243.445,-18"/>
<polygon fill="black" stroke="black" points="243.72,-21.5001 253.72,-18 243.72,-14.5001 243.72,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>introduce name resolution environments with a data structure that
separates
the definition of table/col names to their uses.</p></li>
<li><p>change the <span class="docutils literal">getDataSource</span> logic to use a name resolution
environment.</p></li>
<li><p>modify all logical plan constructors to use name environments to look
up table names
and columns.</p></li>
<li><p>collect free column variables in the environment.</p></li>
<li><p>make <span class="docutils literal">getDataSource</span> owner of the error detection for &quot;unknown
column names&quot;
(derived from &quot;are there still free variables after name resolution&quot;)</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="back-end-refactorings">
<h2><a class="toc-backref" href="#id23"><span class="sectnum">4.6</span> Back-end refactorings</a></h2>
<div class="contents local topic" id="id6">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#make-data-sources-accept-filters-projections" id="id44"><span class="sectnum">4.6.1</span> Make data sources accept filters/projections</a></p></li>
<li><p><a class="reference internal" href="#push-down-predicates-to-vtables" id="id45"><span class="sectnum">4.6.2</span> Push down predicates to vtables</a></p></li>
<li><p><a class="reference internal" href="#push-down-projections-to-vtables" id="id46"><span class="sectnum">4.6.3</span> Push down projections to vtables</a></p></li>
<li><p><a class="reference internal" href="#push-down-predicates-to-kv" id="id47"><span class="sectnum">4.6.4</span> Push down predicates to KV</a></p></li>
<li><p><a class="reference internal" href="#push-down-projections-to-kv" id="id48"><span class="sectnum">4.6.5</span> Push down projections to KV</a></p></li>
<li><p><a class="reference internal" href="#make-physical-plans-restartable" id="id49"><span class="sectnum">4.6.6</span> Make physical plans restartable</a></p></li>
<li><p><a class="reference internal" href="#partial-replanning-infrastructure" id="id50"><span class="sectnum">4.6.7</span> Partial replanning infrastructure</a></p></li>
<li><p><a class="reference internal" href="#incremental-phy-planning-of-distributed-queries" id="id51"><span class="sectnum">4.6.8</span> Incremental phy planning of distributed queries</a></p></li>
<li><p><a class="reference internal" href="#incremental-joins" id="id52"><span class="sectnum">4.6.9</span> Incremental joins</a></p></li>
<li><p><a class="reference internal" href="#lookup-joins" id="id53"><span class="sectnum">4.6.10</span> Lookup joins</a></p></li>
<li><p><a class="reference internal" href="#constant-space-query-execution" id="id54"><span class="sectnum">4.6.11</span> Constant-space query execution</a></p></li>
</ul>
</div>
<div class="section" id="make-data-sources-accept-filters-projections">
<h3><a class="toc-backref" href="#id44"><span class="sectnum">4.6.1</span> Make data sources accept filters/projections</a></h3>
<p id="smartds">Overview:</p>
<div id='svg-container-smartds'>
<svg id='svg-smartds' width="264pt" height="44pt"
 viewBox="0.00 0.00 264.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 260,-40 260,4 -4,4"/>
<!-- smartds -->
<g id="node1" class="node"><title>smartds</title>
<g id="a_node1"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="pink" stroke="black" points="256,-36 0,-36 0,-0 256,-0 256,-36"/>
<text text-anchor="middle" x="128" y="-14.3" font-family="Times,serif" font-size="14.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>create a general-purpose &quot;data source&quot; interface that can be used
in physical plans; have this interface support an API
to feed additional constraints or projections to the data source</p></li>
<li><p>use this interface during predicate and projection push-down in
the existing planning code.</p></li>
</ul>
</div>
<div class="section" id="push-down-predicates-to-vtables">
<h3><a class="toc-backref" href="#id45"><span class="sectnum">4.6.2</span> Push down predicates to vtables</a></h3>
<p id="vtpreds">Overview:</p>
<div id='svg-container-vtpreds'>
<svg id='svg-vtpreds' width="502pt" height="44pt"
 viewBox="0.00 0.00 502.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 498,-40 498,4 -4,4"/>
<!-- vtpreds -->
<g id="node1" class="node"><title>vtpreds</title>
<g id="a_node1"><a xlink:href="#vtpreds" xlink:title="Push down predicates to vtables">
<polygon fill="lightblue" stroke="black" points="494,-36 303,-36 303,-0 494,-0 494,-36"/>
<text text-anchor="middle" x="398.5" y="-14.3" font-family="Times,serif" font-size="14.00">Push down predicates to vtables</text>
</a>
</g>
</g>
<!-- smartds -->
<g id="node2" class="node"><title>smartds</title>
<g id="a_node2"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="159,-36 1.42109e-14,-36 1.42109e-14,-0 159,-0 159,-36"/>
<text text-anchor="middle" x="79.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;vtpreds -->
<g id="edge1" class="edge"><title>smartds&#45;&gt;vtpreds</title>
<path fill="none" stroke="black" d="M159.267,-18C199.584,-18 249.208,-18 292.711,-18"/>
<polygon fill="black" stroke="black" points="292.758,-21.5001 302.758,-18 292.758,-14.5001 292.758,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement the data source API to accept predicates on vtables</p></li>
<li><p>use predictates to filter out rows during initial vtable population</p></li>
</ul>
</div>
<div class="section" id="push-down-projections-to-vtables">
<h3><a class="toc-backref" href="#id46"><span class="sectnum">4.6.3</span> Push down projections to vtables</a></h3>
<p id="vtprojs">Overview:</p>
<div id='svg-container-vtprojs'>
<svg id='svg-vtprojs' width="508pt" height="44pt"
 viewBox="0.00 0.00 508.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 504,-40 504,4 -4,4"/>
<!-- vtprojs -->
<g id="node1" class="node"><title>vtprojs</title>
<g id="a_node1"><a xlink:href="#vtprojs" xlink:title="Push down projections to vtables">
<polygon fill="lightblue" stroke="black" points="500,-36 303,-36 303,-0 500,-0 500,-36"/>
<text text-anchor="middle" x="401.5" y="-14.3" font-family="Times,serif" font-size="14.00">Push down projections to vtables</text>
</a>
</g>
</g>
<!-- smartds -->
<g id="node2" class="node"><title>smartds</title>
<g id="a_node2"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="159,-36 1.42109e-14,-36 1.42109e-14,-0 159,-0 159,-36"/>
<text text-anchor="middle" x="79.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;vtprojs -->
<g id="edge1" class="edge"><title>smartds&#45;&gt;vtprojs</title>
<path fill="none" stroke="black" d="M159.191,-18C199.45,-18 249.065,-18 292.815,-18"/>
<polygon fill="black" stroke="black" points="292.925,-21.5001 302.925,-18 292.925,-14.5001 292.925,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement the data source API to accept projections on vtables</p></li>
<li><p>use projection info to filter out columns during initial vtable
population</p></li>
</ul>
</div>
<div class="section" id="push-down-predicates-to-kv">
<h3><a class="toc-backref" href="#id47"><span class="sectnum">4.6.4</span> Push down predicates to KV</a></h3>
<p id="kvpreds">Overview:</p>
<div id='svg-container-kvpreds'>
<svg id='svg-kvpreds' width="498pt" height="44pt"
 viewBox="0.00 0.00 498.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 494,-40 494,4 -4,4"/>
<!-- kvpreds -->
<g id="node1" class="node"><title>kvpreds</title>
<g id="a_node1"><a xlink:href="#kvpreds" xlink:title="ðŸŽ¯Push down predicates to KV">
<polygon fill="lightblue" stroke="black" points="490,-36 303,-36 303,-0 490,-0 490,-36"/>
<text text-anchor="middle" x="396.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Push down predicates to KV</text>
</a>
</g>
</g>
<!-- smartds -->
<g id="node2" class="node"><title>smartds</title>
<g id="a_node2"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="159,-36 1.42109e-14,-36 1.42109e-14,-0 159,-0 159,-36"/>
<text text-anchor="middle" x="79.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;kvpreds -->
<g id="edge1" class="edge"><title>smartds&#45;&gt;kvpreds</title>
<path fill="none" stroke="black" d="M159.175,-18C199.58,-18 249.311,-18 292.712,-18"/>
<polygon fill="black" stroke="black" points="292.732,-21.5001 302.732,-18 292.731,-14.5001 292.732,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement the data source API to accept predicates on KV scans</p></li>
<li><p>use predictates to filter out rows during KV scans</p></li>
</ul>
</div>
<div class="section" id="push-down-projections-to-kv">
<h3><a class="toc-backref" href="#id48"><span class="sectnum">4.6.5</span> Push down projections to KV</a></h3>
<p id="kvprojs">Overview:</p>
<div id='svg-container-kvprojs'>
<svg id='svg-kvprojs' width="489pt" height="44pt"
 viewBox="0.00 0.00 489.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 485,-40 485,4 -4,4"/>
<!-- kvprojs -->
<g id="node1" class="node"><title>kvprojs</title>
<g id="a_node1"><a xlink:href="#kvprojs" xlink:title="Push down projections to KV">
<polygon fill="lightblue" stroke="black" points="481,-36 303,-36 303,-0 481,-0 481,-36"/>
<text text-anchor="middle" x="392" y="-14.3" font-family="Times,serif" font-size="14.00">Push down projections to KV</text>
</a>
</g>
</g>
<!-- smartds -->
<g id="node2" class="node"><title>smartds</title>
<g id="a_node2"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="159,-36 1.42109e-14,-36 1.42109e-14,-0 159,-0 159,-36"/>
<text text-anchor="middle" x="79.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;kvprojs -->
<g id="edge1" class="edge"><title>smartds&#45;&gt;kvprojs</title>
<path fill="none" stroke="black" d="M159.254,-18C199.755,-18 249.517,-18 292.533,-18"/>
<polygon fill="black" stroke="black" points="292.741,-21.5001 302.741,-18 292.741,-14.5001 292.741,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement the data source API to accept predicates on KV scans</p></li>
<li><p>use projection info to eliminate some KV lookups</p></li>
</ul>
</div>
<div class="section" id="make-physical-plans-restartable">
<h3><a class="toc-backref" href="#id49"><span class="sectnum">4.6.6</span> Make physical plans restartable</a></h3>
<p id="restart">Overview:</p>
<div id='svg-container-restart'>
<svg id='svg-restart' width="197pt" height="44pt"
 viewBox="0.00 0.00 197.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 193,-40 193,4 -4,4"/>
<!-- restart -->
<g id="node1" class="node"><title>restart</title>
<g id="a_node1"><a xlink:href="#restart" xlink:title="Make physical plans restartable">
<polygon fill="pink" stroke="black" points="189,-36 0,-36 0,-0 189,-0 189,-36"/>
<text text-anchor="middle" x="94.5" y="-14.3" font-family="Times,serif" font-size="14.00">Make physical plans restartable</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>add a &quot;restart&quot; API to arbitrary physical plans (note: scans already
can do it) to reuse the existing resources (e.g. distsql
flows/processors, compiled program if relevant, etc)</p></li>
<li><p>make it possible to change key parameters (in particular add
constraints / change spans) in-between restarts</p></li>
</ul>
</div>
<div class="section" id="partial-replanning-infrastructure">
<h3><a class="toc-backref" href="#id50"><span class="sectnum">4.6.7</span> Partial replanning infrastructure</a></h3>
<p id="gends">Overview:</p>
<div id='svg-container-gends'>
<svg id='svg-gends' width="501pt" height="98pt"
 viewBox="0.00 0.00 501.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 497,-94 497,4 -4,4"/>
<!-- gends -->
<g id="node1" class="node"><title>gends</title>
<g id="a_node1"><a xlink:href="#gends" xlink:title="Partial replanning infrastructure">
<polygon fill="pink" stroke="black" points="493,-63 303,-63 303,-27 493,-27 493,-63"/>
<text text-anchor="middle" x="398" y="-41.3" font-family="Times,serif" font-size="14.00">Partial replanning infrastructure</text>
</a>
</g>
</g>
<!-- restart -->
<g id="node2" class="node"><title>restart</title>
<g id="a_node2"><a xlink:href="#restart" xlink:title="Make physical plans restartable">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="139,-90 20,-90 20,-54 139,-54 139,-90"/>
<text text-anchor="middle" x="79.5" y="-70.1" font-family="Times,serif" font-size="8.00">Make physical plans restartable</text>
</a>
</g>
</g>
<!-- restart&#45;&gt;gends -->
<g id="edge1" class="edge"><title>restart&#45;&gt;gends</title>
<path fill="none" stroke="black" d="M139.289,-66.9848C182.278,-63.3175 241.733,-58.2455 292.705,-53.8972"/>
<polygon fill="black" stroke="black" points="293.112,-57.3753 302.779,-53.0378 292.517,-50.4006 293.112,-57.3753"/>
</g>
<!-- smartds -->
<g id="node3" class="node"><title>smartds</title>
<g id="a_node3"><a xlink:href="#smartds" xlink:title="Make data sources accept filters/projections">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="159,-36 1.42109e-14,-36 1.42109e-14,-0 159,-0 159,-36"/>
<text text-anchor="middle" x="79.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make data sources accept filters/projections</text>
</a>
</g>
</g>
<!-- smartds&#45;&gt;gends -->
<g id="edge2" class="edge"><title>smartds&#45;&gt;gends</title>
<path fill="none" stroke="black" d="M159.143,-24.7088C199.566,-28.1573 249.361,-32.4052 292.925,-36.1216"/>
<polygon fill="black" stroke="black" points="292.724,-39.617 302.985,-36.9798 293.319,-32.6424 292.724,-39.617"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>defer span computation to the &quot;start&quot;/&quot;restart&quot; phase
of execution</p></li>
<li><p>extend the data source API to accept new
filters and projections during the &quot;start&quot;/&quot;restart&quot; phase of
execution</p></li>
</ul>
</div>
<div class="section" id="incremental-phy-planning-of-distributed-queries">
<h3><a class="toc-backref" href="#id51"><span class="sectnum">4.6.8</span> Incremental phy planning of distributed queries</a></h3>
<p id="incphy">Overview:</p>
<div id='svg-container-incphy'>
<svg id='svg-incphy' width="540pt" height="44pt"
 viewBox="0.00 0.00 540.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 536,-40 536,4 -4,4"/>
<!-- incphy -->
<g id="node1" class="node"><title>incphy</title>
<g id="a_node1"><a xlink:href="#incphy" xlink:title="Incremental physical planning for dist queries">
<polygon fill="none" stroke="black" points="532,-36 265,-36 265,-0 532,-0 532,-36"/>
<text text-anchor="middle" x="398.5" y="-14.3" font-family="Times,serif" font-size="14.00">Incremental physical planning for dist queries</text>
</a>
</g>
</g>
<!-- gends -->
<g id="node2" class="node"><title>gends</title>
<g id="a_node2"><a xlink:href="#gends" xlink:title="Partial replanning infrastructure">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="121,-36 7.10543e-15,-36 7.10543e-15,-0 121,-0 121,-36"/>
<text text-anchor="middle" x="60.5" y="-16.1" font-family="Times,serif" font-size="8.00">Partial replanning infrastructure</text>
</a>
</g>
</g>
<!-- gends&#45;&gt;incphy -->
<g id="edge1" class="edge"><title>gends&#45;&gt;incphy</title>
<path fill="none" stroke="black" d="M121.183,-18C158.341,-18 207.823,-18 254.641,-18"/>
<polygon fill="black" stroke="black" points="254.898,-21.5001 264.898,-18 254.897,-14.5001 254.898,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>See RFC on <a class="reference external" href="../RFCS/20170602_distsql_limit.md">distributed phy planning for LIMIT</a> - although the RFC was
written with LIMIT in mind, the overall optimization is useful in
general: it ensures that a cluster is not flooded with processors
unless there is demand for the additional throughput.</p>
<p>Goals:</p>
<ul class="simple">
<li><p>add a run-time API to stimulate the creation of new processors while
a plan is running;</p></li>
<li><p>modify the phy planner to only spawn processor &quot;on demand&quot; for more
rows;</p></li>
<li><p>modify the synchronizers / mergers to spawn processors on demand when
starved of rows</p></li>
<li><p>investigate when/whether it is advantageous to select the node(s)
closest to the gateway initially.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>faster handling of queries with LIMIT</p></li>
<li><p>possibly lower memory usage throughout the cluster</p></li>
</ul>
</div>
<div class="section" id="incremental-joins">
<h3><a class="toc-backref" href="#id52"><span class="sectnum">4.6.9</span> Incremental joins</a></h3>
<p id="incrjoin">Overview:</p>
<div id='svg-container-incrjoin'>
<svg id='svg-incrjoin' width="503pt" height="98pt"
 viewBox="0.00 0.00 503.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 499,-94 499,4 -4,4"/>
<!-- incrjoin -->
<g id="node1" class="node"><title>incrjoin</title>
<g id="a_node1"><a xlink:href="#incrjoin" xlink:title="Incremental / segmented joins">
<polygon fill="none" stroke="black" points="495,-63 313,-63 313,-27 495,-27 495,-63"/>
<text text-anchor="middle" x="404" y="-41.3" font-family="Times,serif" font-size="14.00">Incremental / segmented joins</text>
</a>
</g>
</g>
<!-- opthints -->
<g id="node2" class="node"><title>opthints</title>
<g id="a_node2"><a xlink:href="#opthints" xlink:title="ðŸŽ¯Enable manual override of planner decisions">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="169,-90 1.42109e-14,-90 1.42109e-14,-54 169,-54 169,-90"/>
<text text-anchor="middle" x="84.5" y="-70.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Enable manual override of planner decisions</text>
</a>
</g>
</g>
<!-- opthints&#45;&gt;incrjoin -->
<g id="edge1" class="edge"><title>opthints&#45;&gt;incrjoin</title>
<path fill="none" stroke="black" d="M169.335,-64.8708C210.241,-61.3921 259.757,-57.1813 302.66,-53.5329"/>
<polygon fill="black" stroke="black" points="303.175,-57.0017 312.843,-52.6669 302.582,-50.0269 303.175,-57.0017"/>
</g>
<!-- restart -->
<g id="node3" class="node"><title>restart</title>
<g id="a_node3"><a xlink:href="#restart" xlink:title="Make physical plans restartable">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="144,-36 25,-36 25,-0 144,-0 144,-36"/>
<text text-anchor="middle" x="84.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make physical plans restartable</text>
</a>
</g>
</g>
<!-- restart&#45;&gt;incrjoin -->
<g id="edge2" class="edge"><title>restart&#45;&gt;incrjoin</title>
<path fill="none" stroke="black" d="M144.104,-22.9837C188.544,-26.7628 250.679,-32.0467 302.939,-36.4909"/>
<polygon fill="black" stroke="black" points="302.652,-39.979 312.913,-37.339 303.245,-33.0042 302.652,-39.979"/>
</g>
</g>
</svg>
</div>
<p>(Also sometimes called &quot;nested loops&quot;, except it also works with
hashing.)</p>
<p>Goals:</p>
<ul class="simple">
<li><p>implement a new join data strategy which fetches the rows in the left
operand in batches, and for each batch computes the hash table, then
restarts the right operand (entirely) to filter the result rows.</p></li>
<li><p>make this algorithm parameterized by the maximum memory usage
allowed.</p></li>
</ul>
</div>
<div class="section" id="lookup-joins">
<h3><a class="toc-backref" href="#id53"><span class="sectnum">4.6.10</span> Lookup joins</a></h3>
<p id="lookupjoin">Overview:</p>
<div id='svg-container-lookupjoin'>
<svg id='svg-lookupjoin' width="468pt" height="152pt"
 viewBox="0.00 0.00 468.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 464,-148 464,4 -4,4"/>
<!-- lookupjoin -->
<g id="node1" class="node"><title>lookupjoin</title>
<g id="a_node1"><a xlink:href="#lookupjoin" xlink:title="ðŸŽ¯ðŸŽ¯Lookup&#45;based joins">
<polygon fill="lightblue" stroke="black" points="460,-90 308,-90 308,-54 460,-54 460,-90"/>
<text text-anchor="middle" x="384" y="-68.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Lookup&#45;based joins</text>
</a>
</g>
</g>
<!-- incrjoin -->
<g id="node2" class="node"><title>incrjoin</title>
<g id="a_node2"><a xlink:href="#incrjoin" xlink:title="Incremental / segmented joins">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="138.5,-144 25.5,-144 25.5,-108 138.5,-108 138.5,-144"/>
<text text-anchor="middle" x="82" y="-124.1" font-family="Times,serif" font-size="8.00">Incremental / segmented joins</text>
</a>
</g>
</g>
<!-- incrjoin&#45;&gt;lookupjoin -->
<g id="edge1" class="edge"><title>incrjoin&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" d="M138.725,-115.97C183.364,-107.935 246.736,-96.5276 297.746,-87.3458"/>
<polygon fill="black" stroke="black" points="298.552,-90.757 307.774,-85.5407 297.312,-83.8677 298.552,-90.757"/>
</g>
<!-- gends -->
<g id="node3" class="node"><title>gends</title>
<g id="a_node3"><a xlink:href="#gends" xlink:title="Partial replanning infrastructure">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="142.5,-90 21.5,-90 21.5,-54 142.5,-54 142.5,-90"/>
<text text-anchor="middle" x="82" y="-70.1" font-family="Times,serif" font-size="8.00">Partial replanning infrastructure</text>
</a>
</g>
</g>
<!-- gends&#45;&gt;lookupjoin -->
<g id="edge2" class="edge"><title>gends&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" d="M142.629,-72C186.991,-72 248.166,-72 297.698,-72"/>
<polygon fill="black" stroke="black" points="297.761,-75.5001 307.761,-72 297.76,-68.5001 297.761,-75.5001"/>
</g>
<!-- incphy -->
<g id="node4" class="node"><title>incphy</title>
<g id="a_node4"><a xlink:href="#incphy" xlink:title="Incremental physical planning for dist queries">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="164,-36 0,-36 0,-0 164,-0 164,-36"/>
<text text-anchor="middle" x="82" y="-16.1" font-family="Times,serif" font-size="8.00">Incremental physical planning for dist queries</text>
</a>
</g>
</g>
<!-- incphy&#45;&gt;lookupjoin -->
<g id="edge3" class="edge"><title>incphy&#45;&gt;lookupjoin</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M164.184,-32.6132C205.632,-40.0737 256.029,-49.1452 298.005,-56.7009"/>
<polygon fill="black" stroke="black" points="297.467,-60.1603 307.929,-58.4873 298.708,-53.271 297.467,-60.1603"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement a new join resolution algorithm that extends the extant
&quot;index join&quot; algorithm to arbitrary plan operands: for
every (group of) row(s) on the left, transform the
values in the rows to a WHERE constraint, propagate
to the right operand, recompute spans, and restart the
right operand plan to get the next &quot;batch&quot; of rows to
advance the join.</p></li>
</ul>
</div>
<div class="section" id="constant-space-query-execution">
<h3><a class="toc-backref" href="#id54"><span class="sectnum">4.6.11</span> Constant-space query execution</a></h3>
<p id="fixedmem">Overview:</p>
<div id='svg-container-fixedmem'>
<svg id='svg-fixedmem' width="455pt" height="44pt"
 viewBox="0.00 0.00 455.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 451,-40 451,4 -4,4"/>
<!-- fixedmem -->
<g id="node1" class="node"><title>fixedmem</title>
<g id="a_node1"><a xlink:href="#fixedmem" xlink:title="Constant&#45;space query execution">
<polygon fill="lightblue" stroke="black" points="447,-36 257,-36 257,-0 447,-0 447,-36"/>
<text text-anchor="middle" x="352" y="-14.3" font-family="Times,serif" font-size="14.00">Constant&#45;space query execution</text>
</a>
</g>
</g>
<!-- incrjoin -->
<g id="node2" class="node"><title>incrjoin</title>
<g id="a_node2"><a xlink:href="#incrjoin" xlink:title="Incremental / segmented joins">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="113,-36 0,-36 0,-0 113,-0 113,-36"/>
<text text-anchor="middle" x="56.5" y="-16.1" font-family="Times,serif" font-size="8.00">Incremental / segmented joins</text>
</a>
</g>
</g>
<!-- incrjoin&#45;&gt;fixedmem -->
<g id="edge1" class="edge"><title>incrjoin&#45;&gt;fixedmem</title>
<path fill="none" stroke="black" d="M113.05,-18C150.749,-18 201.752,-18 246.869,-18"/>
<polygon fill="black" stroke="black" points="246.996,-21.5001 256.996,-18 246.996,-14.5001 246.996,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>ensure that any query plan can either accept a memory
budget and guarantee query completion within that budget (spilling
to disk / using segmented processing as necessary), or refuse
that budget during planning.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>more concurrent queries can run simultaneously, overall better Q
throughput</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="performance-otimizations-in-logical-planning">
<h2><a class="toc-backref" href="#id24"><span class="sectnum">4.7</span> Performance otimizations in logical planning</a></h2>
<div class="contents local topic" id="id7">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#enable-manual-override-of-planner-decisions" id="id55"><span class="sectnum">4.7.1</span> Enable manual override of planner decisions</a></p></li>
<li><p><a class="reference internal" href="#cache-query-plans" id="id56"><span class="sectnum">4.7.2</span> Cache query plans</a></p></li>
</ul>
</div>
<div class="section" id="enable-manual-override-of-planner-decisions">
<h3><a class="toc-backref" href="#id55"><span class="sectnum">4.7.1</span> Enable manual override of planner decisions</a></h3>
<p id="opthints">Overview:</p>
<div id='svg-container-opthints'>
<svg id='svg-opthints' width="283pt" height="44pt"
 viewBox="0.00 0.00 283.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 279,-40 279,4 -4,4"/>
<!-- opthints -->
<g id="node1" class="node"><title>opthints</title>
<g id="a_node1"><a xlink:href="#opthints" xlink:title="ðŸŽ¯Enable manual override of planner decisions">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="0" y1="-18" x2="275" y2="-18" >
<stop offset="0" style="stop-color:pink;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightgreen;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="275,-36 0,-36 0,-0 275,-0 275,-36"/>
<text text-anchor="middle" x="137.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Enable manual override of planner decisions</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>a.k.a. &quot;query hints&quot; except they would not be hints for now and more
like constraints.</p>
<p>Goals:</p>
<ul class="simple">
<li><p>design and implement a general-purpose annotation syntax to force
particular logical planning choices</p></li>
<li><p>ensure it works to select:</p>
<ul>
<li><p>which join algorithm to use</p></li>
<li><p>which sort algorithm to use</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="cache-query-plans">
<h3><a class="toc-backref" href="#id56"><span class="sectnum">4.7.2</span> Cache query plans</a></h3>
<p id="cacheplans">Overview:</p>
<div id='svg-container-cacheplans'>
<svg id='svg-cacheplans' width="412pt" height="98pt"
 viewBox="0.00 0.00 412.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 408,-94 408,4 -4,4"/>
<!-- cacheplans -->
<g id="node1" class="node"><title>cacheplans</title>
<g id="a_node1"><a xlink:href="#cacheplans" xlink:title="ðŸŽ¯Cache query plans">
<polygon fill="lightblue" stroke="black" points="404,-63 273,-63 273,-27 404,-27 404,-63"/>
<text text-anchor="middle" x="338.5" y="-41.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Cache query plans</text>
</a>
</g>
</g>
<!-- leafdata -->
<g id="node2" class="node"><title>leafdata</title>
<g id="a_node2"><a xlink:href="#leafdata" xlink:title="SQL leaf dataâ˜…">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="100,-90 29,-90 29,-54 100,-54 100,-90"/>
<text text-anchor="middle" x="64.5" y="-70.1" font-family="Times,serif" font-size="8.00">SQL leaf dataâ˜…</text>
</a>
</g>
</g>
<!-- leafdata&#45;&gt;cacheplans -->
<g id="edge1" class="edge"><title>leafdata&#45;&gt;cacheplans</title>
<path fill="none" stroke="black" d="M100.225,-68.553C140.993,-64.5062 209.771,-57.679 262.812,-52.4138"/>
<polygon fill="black" stroke="black" points="263.255,-55.8872 272.86,-51.4165 262.563,-48.9215 263.255,-55.8872"/>
</g>
<!-- ctxfreeplans -->
<g id="node3" class="node"><title>ctxfreeplans</title>
<g id="a_node3"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-36 0,-36 0,-0 129,-0 129,-36"/>
<text text-anchor="middle" x="64.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;cacheplans -->
<g id="edge2" class="edge"><title>ctxfreeplans&#45;&gt;cacheplans</title>
<path fill="none" stroke="black" d="M129.272,-24.3303C169.164,-28.2901 220.735,-33.4094 262.574,-37.5625"/>
<polygon fill="black" stroke="black" points="262.415,-41.0639 272.712,-38.5689 263.107,-34.0981 262.415,-41.0639"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>reuse query plans across EXECUTEs</p></li>
<li><p>ensure plans are properly discarded upon schema change events</p></li>
<li><p>either measure that caching is always beneficial, or introduce a
threshold beyond which caching and cache lookups are performed.</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="cost-based-logical-plan-optimizations">
<h2><a class="toc-backref" href="#id25"><span class="sectnum">4.8</span> Cost-based logical plan optimizations</a></h2>
<div class="contents local topic" id="id8">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#collecting-table-statistics" id="id57"><span class="sectnum">4.8.1</span> Collecting table statistics</a></p></li>
<li><p><a class="reference internal" href="#costing-function-for-logical-plans" id="id58"><span class="sectnum">4.8.2</span> Costing function for logical plans</a></p></li>
<li><p><a class="reference internal" href="#plan-equivalency-classes" id="id59"><span class="sectnum">4.8.3</span> Plan equivalency classes</a></p></li>
<li><p><a class="reference internal" href="#plan-rewriting-infrastructure" id="id60"><span class="sectnum">4.8.4</span> Plan rewriting infrastructure</a></p></li>
<li><p><a class="reference internal" href="#cost-based-plan-selection" id="id61"><span class="sectnum">4.8.5</span> Cost-based plan selection</a></p></li>
<li><p><a class="reference internal" href="#feedback-directed-plan-selection" id="id62"><span class="sectnum">4.8.6</span> Feedback-directed plan selection</a></p></li>
<li><p><a class="reference internal" href="#collect-plan-execution-statistics" id="id63"><span class="sectnum">4.8.7</span> Collect plan execution statistics</a></p></li>
<li><p><a class="reference internal" href="#node-benchmarking" id="id64"><span class="sectnum">4.8.8</span> Node benchmarking</a></p></li>
<li><p><a class="reference internal" href="#node-specific-costing" id="id65"><span class="sectnum">4.8.9</span> Node-specific costing</a></p></li>
<li><p><a class="reference internal" href="#eliminate-csqs-in-common-cases" id="id66"><span class="sectnum">4.8.10</span> Eliminate CSQs in common cases</a></p></li>
</ul>
</div>
<div class="section" id="collecting-table-statistics">
<h3><a class="toc-backref" href="#id57"><span class="sectnum">4.8.1</span> Collecting table statistics</a></h3>
<p id="tstats">Overview:</p>
<div id='svg-container-tstats'>
<svg id='svg-tstats' width="161pt" height="44pt"
 viewBox="0.00 0.00 161.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 157,-40 157,4 -4,4"/>
<!-- tstats -->
<g id="node1" class="node"><title>tstats</title>
<g id="a_node1"><a xlink:href="#tstats" xlink:title="Collecting table statistics">
<polygon fill="none" stroke="black" points="153,-36 0,-36 0,-0 153,-0 153,-36"/>
<text text-anchor="middle" x="76.5" y="-14.3" font-family="Times,serif" font-size="14.00">Collecting table statistics</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>provide an API which, given an index descriptor
and a set of indexed column IDs, returns an estimate of the
cardinality of that tuple, or &quot;not known&quot;</p></li>
<li><p>actually maintain and delivers actual cardinality estimates in most
KV tables</p></li>
<li><p>if possible, also maintain/deliver for vtables</p></li>
</ul>
<p>Suggestion: review data collected by pg, see
<a class="reference external" href="https://www.postgresql.org/docs/9.6/static/view-pg-stats.html">https://www.postgresql.org/docs/9.6/static/view-pg-stats.html</a></p>
</div>
<div class="section" id="costing-function-for-logical-plans">
<h3><a class="toc-backref" href="#id58"><span class="sectnum">4.8.2</span> Costing function for logical plans</a></h3>
<p id="cstf">Overview:</p>
<div id='svg-container-cstf'>
<svg id='svg-cstf' width="471pt" height="98pt"
 viewBox="0.00 0.00 471.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 467,-94 467,4 -4,4"/>
<!-- cstf -->
<g id="node1" class="node"><title>cstf</title>
<g id="a_node1"><a xlink:href="#cstf" xlink:title="Costing function for logical plans">
<polygon fill="lightblue" stroke="black" points="463,-63 263,-63 263,-27 463,-27 463,-63"/>
<text text-anchor="middle" x="363" y="-41.3" font-family="Times,serif" font-size="14.00">Costing function for logical plans</text>
</a>
</g>
</g>
<!-- tstats -->
<g id="node2" class="node"><title>tstats</title>
<g id="a_node2"><a xlink:href="#tstats" xlink:title="Collecting table statistics">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="108.5,-90 10.5,-90 10.5,-54 108.5,-54 108.5,-90"/>
<text text-anchor="middle" x="59.5" y="-70.1" font-family="Times,serif" font-size="8.00">Collecting table statistics</text>
</a>
</g>
</g>
<!-- tstats&#45;&gt;cstf -->
<g id="edge1" class="edge"><title>tstats&#45;&gt;cstf</title>
<path fill="none" stroke="black" d="M108.607,-67.6919C147.336,-64.2237 203.277,-59.214 252.752,-54.7834"/>
<polygon fill="black" stroke="black" points="253.229,-58.2548 262.877,-53.8767 252.605,-51.2827 253.229,-58.2548"/>
</g>
<!-- fixedmem -->
<g id="node3" class="node"><title>fixedmem</title>
<g id="a_node3"><a xlink:href="#fixedmem" xlink:title="Constant&#45;space query execution">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="119,-36 0,-36 0,-0 119,-0 119,-36"/>
<text text-anchor="middle" x="59.5" y="-16.1" font-family="Times,serif" font-size="8.00">Constant&#45;space query execution</text>
</a>
</g>
</g>
<!-- fixedmem&#45;&gt;cstf -->
<g id="edge2" class="edge"><title>fixedmem&#45;&gt;cstf</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M119.348,-23.27C157.267,-26.6657 207.729,-31.1847 252.813,-35.222"/>
<polygon fill="black" stroke="black" points="252.669,-38.7231 262.942,-36.1291 253.294,-31.751 252.669,-38.7231"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define a preliminary costing model, and document the formula
for the existing relational operators currently implemented in
CockroachDB.</p></li>
<li><p>define and implement a function which takes a logical
plan as input and delivers an estimate cost based on the preliminary
costing model.</p></li>
<li><p>use this cost in the current index selection code (instead of the
arbitrary constants currently used).</p></li>
<li><p>investigate and if possible implement a memoization of this cost.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>probably better index selection already with the existing code,
and thus better query performance in some cases</p></li>
</ul>
</div>
<div class="section" id="plan-equivalency-classes">
<h3><a class="toc-backref" href="#id59"><span class="sectnum">4.8.3</span> Plan equivalency classes</a></h3>
<p id="pleq">Overview:</p>
<div id='svg-container-pleq'>
<svg id='svg-pleq' width="159pt" height="44pt"
 viewBox="0.00 0.00 159.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 155,-40 155,4 -4,4"/>
<!-- pleq -->
<g id="node1" class="node"><title>pleq</title>
<g id="a_node1"><a xlink:href="#pleq" xlink:title="Plan equivalency classes">
<polygon fill="none" stroke="black" points="151,-36 0,-36 0,-0 151,-0 151,-36"/>
<text text-anchor="middle" x="75.5" y="-14.3" font-family="Times,serif" font-size="14.00">Plan equivalency classes</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>extend the data structure(s) used to represent plans to
use equivalency classes in the references between nodes</p></li>
<li><p>make the equivalency class data structure carry plan properties
(needed columns, column types, etc) instead of the nodes themselves</p></li>
<li><p>define/deliver an API to manipulate nodes and add new nodes
in a given equivalency class</p></li>
</ul>
</div>
<div class="section" id="plan-rewriting-infrastructure">
<h3><a class="toc-backref" href="#id60"><span class="sectnum">4.8.4</span> Plan rewriting infrastructure</a></h3>
<p id="prewrite">Overview:</p>
<div id='svg-container-prewrite'>
<svg id='svg-prewrite' width="451pt" height="152pt"
 viewBox="0.00 0.00 451.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 447,-148 447,4 -4,4"/>
<!-- prewrite -->
<g id="node1" class="node"><title>prewrite</title>
<g id="a_node1"><a xlink:href="#prewrite" xlink:title="Plan rewriting infrastructure">
<polygon fill="none" stroke="black" points="443,-90 273,-90 273,-54 443,-54 443,-90"/>
<text text-anchor="middle" x="358" y="-68.3" font-family="Times,serif" font-size="14.00">Plan rewriting infrastructure</text>
</a>
</g>
</g>
<!-- pleq -->
<g id="node2" class="node"><title>pleq</title>
<g id="a_node2"><a xlink:href="#pleq" xlink:title="Plan equivalency classes">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="112.5,-144 16.5,-144 16.5,-108 112.5,-108 112.5,-144"/>
<text text-anchor="middle" x="64.5" y="-124.1" font-family="Times,serif" font-size="8.00">Plan equivalency classes</text>
</a>
</g>
</g>
<!-- pleq&#45;&gt;prewrite -->
<g id="edge1" class="edge"><title>pleq&#45;&gt;prewrite</title>
<path fill="none" stroke="black" d="M112.658,-117.264C153.144,-109.764 212.734,-98.725 262.93,-89.4263"/>
<polygon fill="black" stroke="black" points="263.641,-92.8543 272.836,-87.5913 262.366,-85.9714 263.641,-92.8543"/>
</g>
<!-- ctxfreeplans -->
<g id="node3" class="node"><title>ctxfreeplans</title>
<g id="a_node3"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-90 0,-90 0,-54 129,-54 129,-90"/>
<text text-anchor="middle" x="64.5" y="-70.1" font-family="Times,serif" font-size="8.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;prewrite -->
<g id="edge2" class="edge"><title>ctxfreeplans&#45;&gt;prewrite</title>
<path fill="none" stroke="black" d="M129.111,-72C168.198,-72 218.986,-72 262.694,-72"/>
<polygon fill="black" stroke="black" points="262.771,-75.5001 272.771,-72 262.771,-68.5001 262.771,-75.5001"/>
</g>
<!-- irplan -->
<g id="node4" class="node"><title>irplan</title>
<g id="a_node4"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="118,-36 11,-36 11,-0 118,-0 118,-36"/>
<text text-anchor="middle" x="64.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;prewrite -->
<g id="edge3" class="edge"><title>irplan&#45;&gt;prewrite</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M118.288,-27.779C158.496,-35.2274 214.903,-45.6767 262.79,-54.5477"/>
<polygon fill="black" stroke="black" points="262.4,-58.0349 272.87,-56.4151 263.675,-51.1521 262.4,-58.0349"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define a software pattern which makes it possible to write
all rewrite rules in one location</p></li>
<li><p>define a &quot;rule application engine&quot; which can run the rules
and applies them and memoizes the results</p></li>
<li><p>ensure that rule application is properly traced,
and each rule is uniquely identified for the purpose of tracing</p></li>
<li><p>define a base (small!) set of simple rules for testing</p></li>
</ul>
</div>
<div class="section" id="cost-based-plan-selection">
<h3><a class="toc-backref" href="#id61"><span class="sectnum">4.8.5</span> Cost-based plan selection</a></h3>
<p id="cbpsel">Overview:</p>
<div id='svg-container-cbpsel'>
<svg id='svg-cbpsel' width="460pt" height="206pt"
 viewBox="0.00 0.00 460.00 206.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 202)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-202 456,-202 456,4 -4,4"/>
<!-- cbpsel -->
<g id="node1" class="node"><title>cbpsel</title>
<g id="a_node1"><a xlink:href="#cbpsel" xlink:title="ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection">
<polygon fill="lightblue" stroke="black" points="452,-117 268,-117 268,-81 452,-81 452,-117"/>
<text text-anchor="middle" x="360" y="-95.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection</text>
</a>
</g>
</g>
<!-- cstf -->
<g id="node2" class="node"><title>cstf</title>
<g id="a_node2"><a xlink:href="#cstf" xlink:title="Costing function for logical plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="124,-198 7.10543e-15,-198 7.10543e-15,-162 124,-162 124,-198"/>
<text text-anchor="middle" x="62" y="-178.1" font-family="Times,serif" font-size="8.00">Costing function for logical plans</text>
</a>
</g>
</g>
<!-- cstf&#45;&gt;cbpsel -->
<g id="edge1" class="edge"><title>cstf&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" d="M124.331,-163.217C170.528,-150.575 234.121,-133.173 283.454,-119.673"/>
<polygon fill="black" stroke="black" points="284.4,-123.043 293.121,-117.028 282.552,-116.291 284.4,-123.043"/>
</g>
<!-- prewrite -->
<g id="node3" class="node"><title>prewrite</title>
<g id="a_node3"><a xlink:href="#prewrite" xlink:title="Plan rewriting infrastructure">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="117,-144 7,-144 7,-108 117,-108 117,-144"/>
<text text-anchor="middle" x="62" y="-124.1" font-family="Times,serif" font-size="8.00">Plan rewriting infrastructure</text>
</a>
</g>
</g>
<!-- prewrite&#45;&gt;cbpsel -->
<g id="edge2" class="edge"><title>prewrite&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" d="M117.291,-121.048C156.475,-117.474 210.545,-112.541 257.612,-108.248"/>
<polygon fill="black" stroke="black" points="258.21,-111.708 267.851,-107.314 257.574,-104.737 258.21,-111.708"/>
</g>
<!-- lookupjoin -->
<g id="node4" class="node"><title>lookupjoin</title>
<g id="a_node4"><a xlink:href="#lookupjoin" xlink:title="ðŸŽ¯ðŸŽ¯Lookup&#45;based joins">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="109.5,-90 14.5,-90 14.5,-54 109.5,-54 109.5,-90"/>
<text text-anchor="middle" x="62" y="-70.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯ðŸŽ¯Lookup&#45;based joins</text>
</a>
</g>
</g>
<!-- lookupjoin&#45;&gt;cbpsel -->
<g id="edge3" class="edge"><title>lookupjoin&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M109.576,-76.2485C149.177,-79.8608 207.447,-85.1759 257.708,-89.7606"/>
<polygon fill="black" stroke="black" points="257.697,-93.274 267.974,-90.6969 258.333,-86.3029 257.697,-93.274"/>
</g>
<!-- incrjoin -->
<g id="node5" class="node"><title>incrjoin</title>
<g id="a_node5"><a xlink:href="#incrjoin" xlink:title="Incremental / segmented joins">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="118.5,-36 5.5,-36 5.5,-0 118.5,-0 118.5,-36"/>
<text text-anchor="middle" x="62" y="-16.1" font-family="Times,serif" font-size="8.00">Incremental / segmented joins</text>
</a>
</g>
</g>
<!-- incrjoin&#45;&gt;cbpsel -->
<g id="edge4" class="edge"><title>incrjoin&#45;&gt;cbpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M118.675,-33.2355C165.166,-45.9576 231.894,-64.2175 283.246,-78.2699"/>
<polygon fill="black" stroke="black" points="282.404,-81.6683 292.973,-80.9319 284.252,-74.9165 282.404,-81.6683"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define and implement a plan enumeration strategy which
performs pruning and exercises rule rewriting to
converge on &quot;good plans&quot;</p></li>
<li><p>ensure the feature is gated behind a session variable</p></li>
<li><p>measure the perf gains/losses when using this algorithm
for a set of reference queries</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>more performance overall</p></li>
</ul>
</div>
<div class="section" id="feedback-directed-plan-selection">
<h3><a class="toc-backref" href="#id62"><span class="sectnum">4.8.6</span> Feedback-directed plan selection</a></h3>
<p id="fdpsel">Overview:</p>
<div id='svg-container-fdpsel'>
<svg id='svg-fdpsel' width="470pt" height="152pt"
 viewBox="0.00 0.00 470.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 466,-148 466,4 -4,4"/>
<!-- fdpsel -->
<g id="node1" class="node"><title>fdpsel</title>
<g id="a_node1"><a xlink:href="#fdpsel" xlink:title="ðŸŽ¯Feeback&#45;directed plan selection">
<polygon fill="lightblue" stroke="black" points="462,-90 259,-90 259,-54 462,-54 462,-90"/>
<text text-anchor="middle" x="360.5" y="-68.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Feeback&#45;directed plan selection</text>
</a>
</g>
</g>
<!-- cbpsel -->
<g id="node2" class="node"><title>cbpsel</title>
<g id="a_node2"><a xlink:href="#cbpsel" xlink:title="ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="115,-144 7.10543e-15,-144 7.10543e-15,-108 115,-108 115,-144"/>
<text text-anchor="middle" x="57.5" y="-124.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯ðŸŽ¯Cost&#45;based plan selection</text>
</a>
</g>
</g>
<!-- cbpsel&#45;&gt;fdpsel -->
<g id="edge1" class="edge"><title>cbpsel&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" d="M115.116,-115.843C152.797,-109.083 203.551,-99.9776 249.041,-91.8166"/>
<polygon fill="black" stroke="black" points="249.738,-95.2475 258.962,-90.0366 248.502,-88.3575 249.738,-95.2475"/>
</g>
<!-- qexstats -->
<g id="node3" class="node"><title>qexstats</title>
<g id="a_node3"><a xlink:href="#qexstats" xlink:title="ðŸŽ¯Collect per&#45;planop ex stats">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="113,-90 2,-90 2,-54 113,-54 113,-90"/>
<text text-anchor="middle" x="57.5" y="-70.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Collect per&#45;planop ex stats</text>
</a>
</g>
</g>
<!-- qexstats&#45;&gt;fdpsel -->
<g id="edge2" class="edge"><title>qexstats&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" d="M113.009,-72C150.81,-72 202.477,-72 248.746,-72"/>
<polygon fill="black" stroke="black" points="248.836,-75.5001 258.836,-72 248.836,-68.5001 248.836,-75.5001"/>
</g>
<!-- nbench -->
<g id="node4" class="node"><title>nbench</title>
<g id="a_node4"><a xlink:href="#nbench" xlink:title="Node benchmarking">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="98,-36 17,-36 17,-0 98,-0 98,-36"/>
<text text-anchor="middle" x="57.5" y="-16.1" font-family="Times,serif" font-size="8.00">Node benchmarking</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;fdpsel -->
<g id="edge3" class="edge"><title>nbench&#45;&gt;fdpsel</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M98.16,-25.1151C136.478,-31.9894 196.306,-42.7227 249.054,-52.1859"/>
<polygon fill="black" stroke="black" points="248.696,-55.6774 259.157,-53.9983 249.933,-48.7874 248.696,-55.6774"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>collect measured ex stats across all instances of the same query
structure (either in memory on each node, and/or persist to KV
periodically). Attach a &quot;degree of certainty&quot; to this information
based on how often a query was seen and the stddev of the measured
ex stats.</p></li>
<li><p>while costing, compare measured ex stats with cost predicted by
costing function. If they diverge, use the one with higher degree of
certainty.</p></li>
<li><p>measure benefits.</p></li>
<li><p>ensure feature is gated behind feature flag.</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>possibly higher performance for some queries, when
the underlying data changes faster than the background table
statistics collection process.</p></li>
</ul>
</div>
<div class="section" id="collect-plan-execution-statistics">
<h3><a class="toc-backref" href="#id63"><span class="sectnum">4.8.7</span> Collect plan execution statistics</a></h3>
<p id="qexstats">Overview:</p>
<div id='svg-container-qexstats'>
<svg id='svg-qexstats' width="457pt" height="44pt"
 viewBox="0.00 0.00 457.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 453,-40 453,4 -4,4"/>
<!-- qexstats -->
<g id="node1" class="node"><title>qexstats</title>
<g id="a_node1"><a xlink:href="#qexstats" xlink:title="ðŸŽ¯Collect per&#45;planop ex stats">
<polygon fill="none" stroke="black" points="449,-36 273,-36 273,-0 449,-0 449,-36"/>
<text text-anchor="middle" x="361" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Collect per&#45;planop ex stats</text>
</a>
</g>
</g>
<!-- ctxfreeplans -->
<g id="node2" class="node"><title>ctxfreeplans</title>
<g id="a_node2"><a xlink:href="#ctxfreeplans" xlink:title="Make plans stateless / context&#45;free">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-36 0,-36 0,-0 129,-0 129,-36"/>
<text text-anchor="middle" x="64.5" y="-16.1" font-family="Times,serif" font-size="8.00">Make plans stateless / context&#45;free</text>
</a>
</g>
</g>
<!-- ctxfreeplans&#45;&gt;qexstats -->
<g id="edge1" class="edge"><title>ctxfreeplans&#45;&gt;qexstats</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M129.04,-18C168.022,-18 218.726,-18 262.692,-18"/>
<polygon fill="black" stroke="black" points="262.834,-21.5001 272.834,-18 262.834,-14.5001 262.834,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>annotate stages of a logical query plan with a (plan internal) stage
identifier</p></li>
<li><p>propagate the stage identifiers to physical plans and distributed
processors</p></li>
<li><p>during query execution collect row count, row throughput, memory
usage and (for
joins/unions/distinct) observed cardinality for each stage of a query
plan;
associate this data to the stage IDs</p></li>
</ul>
</div>
<div class="section" id="node-benchmarking">
<h3><a class="toc-backref" href="#id64"><span class="sectnum">4.8.8</span> Node benchmarking</a></h3>
<p id="nbench">Overview:</p>
<div id='svg-container-nbench'>
<svg id='svg-nbench' width="136pt" height="44pt"
 viewBox="0.00 0.00 136.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 132,-40 132,4 -4,4"/>
<!-- nbench -->
<g id="node1" class="node"><title>nbench</title>
<g id="a_node1"><a xlink:href="#nbench" xlink:title="Node benchmarking">
<polygon fill="none" stroke="black" points="128,-36 0,-36 0,-0 128,-0 128,-36"/>
<text text-anchor="middle" x="64" y="-14.3" font-family="Times,serif" font-size="14.00">Node benchmarking</text>
</a>
</g>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>measure disk I/O max throughput upon node start-up, possibly detect
hypervisor / VM type</p></li>
<li><p>measure CPU speed upon node start-up</p></li>
<li><p>keep this data in the node metadata in gossip so all other nodes can
observe it</p></li>
</ul>
</div>
<div class="section" id="node-specific-costing">
<h3><a class="toc-backref" href="#id65"><span class="sectnum">4.8.9</span> Node-specific costing</a></h3>
<p id="ncst">Overview:</p>
<div id='svg-container-ncst'>
<svg id='svg-ncst' width="411pt" height="98pt"
 viewBox="0.00 0.00 411.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 407,-94 407,4 -4,4"/>
<!-- ncst -->
<g id="node1" class="node"><title>ncst</title>
<g id="a_node1"><a xlink:href="#ncst" xlink:title="Node&#45;specific costing">
<polygon fill="lightblue" stroke="black" points="403,-63 268,-63 268,-27 403,-27 403,-63"/>
<text text-anchor="middle" x="335.5" y="-41.3" font-family="Times,serif" font-size="14.00">Node&#45;specific costing</text>
</a>
</g>
</g>
<!-- nbench -->
<g id="node2" class="node"><title>nbench</title>
<g id="a_node2"><a xlink:href="#nbench" xlink:title="Node benchmarking">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="102.5,-90 21.5,-90 21.5,-54 102.5,-54 102.5,-90"/>
<text text-anchor="middle" x="62" y="-70.1" font-family="Times,serif" font-size="8.00">Node benchmarking</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;ncst -->
<g id="edge1" class="edge"><title>nbench&#45;&gt;ncst</title>
<path fill="none" stroke="black" d="M102.769,-68.0451C143.281,-64.0163 207.142,-57.6654 257.574,-52.6501"/>
<polygon fill="black" stroke="black" points="258.19,-56.1062 267.794,-51.6337 257.497,-49.1406 258.19,-56.1062"/>
</g>
<!-- cstf -->
<g id="node3" class="node"><title>cstf</title>
<g id="a_node3"><a xlink:href="#cstf" xlink:title="Costing function for logical plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="124,-36 7.10543e-15,-36 7.10543e-15,-0 124,-0 124,-36"/>
<text text-anchor="middle" x="62" y="-16.1" font-family="Times,serif" font-size="8.00">Costing function for logical plans</text>
</a>
</g>
</g>
<!-- cstf&#45;&gt;ncst -->
<g id="edge2" class="edge"><title>cstf&#45;&gt;ncst</title>
<path fill="none" stroke="black" d="M124.268,-24.093C163.796,-28.0239 215.527,-33.1684 257.782,-37.3705"/>
<polygon fill="black" stroke="black" points="257.453,-40.855 267.75,-38.3619 258.146,-33.8894 257.453,-40.855"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>modify/extend the costing function during planning to take into
account the measured
node perf values</p></li>
</ul>
<p>Sidecars:</p>
<ul class="simple">
<li><p>better planning when using new hardware with perf characteristics
different
from testing clusters used at Cockroach Labs</p></li>
<li><p>better planning when using heterogeneous nodes</p></li>
</ul>
</div>
<div class="section" id="eliminate-csqs-in-common-cases">
<h3><a class="toc-backref" href="#id66"><span class="sectnum">4.8.10</span> Eliminate CSQs in common cases</a></h3>
<p id="corropt">Overview:</p>
<div id='svg-container-corropt'>
<svg id='svg-corropt' width="522pt" height="206pt"
 viewBox="0.00 0.00 522.00 206.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 202)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-202 518,-202 518,4 -4,4"/>
<!-- corropt -->
<g id="node1" class="node"><title>corropt</title>
<g id="a_node1"><a xlink:href="#corropt" xlink:title="ðŸŽ¯CSQ elimination in common cases">
<polygon fill="lightblue" stroke="black" points="514,-117 292,-117 292,-81 514,-81 514,-117"/>
<text text-anchor="middle" x="403" y="-95.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯CSQ elimination in common cases</text>
</a>
</g>
</g>
<!-- corr -->
<g id="node2" class="node"><title>corr</title>
<g id="a_node2"><a xlink:href="#corr" xlink:title="ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="148,-198 0,-198 0,-162 148,-162 148,-198"/>
<text text-anchor="middle" x="74" y="-178.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯ðŸŽ¯General&#45;case correlated subqueries</text>
</a>
</g>
</g>
<!-- corr&#45;&gt;corropt -->
<g id="edge1" class="edge"><title>corr&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M147.978,-161.923C198.73,-149.351 266.473,-132.571 319.238,-119.501"/>
<polygon fill="black" stroke="black" points="320.38,-122.824 329.245,-117.022 318.697,-116.029 320.38,-122.824"/>
</g>
<!-- sjoin -->
<g id="node3" class="node"><title>sjoin</title>
<g id="a_node3"><a xlink:href="#sjoin" xlink:title="Semi&#45;joins">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="101,-144 47,-144 47,-108 101,-108 101,-144"/>
<text text-anchor="middle" x="74" y="-124.1" font-family="Times,serif" font-size="8.00">Semi&#45;joins</text>
</a>
</g>
</g>
<!-- sjoin&#45;&gt;corropt -->
<g id="edge2" class="edge"><title>sjoin&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M101.207,-123.836C140.201,-120.616 215.963,-114.361 281.693,-108.934"/>
<polygon fill="black" stroke="black" points="282.052,-112.416 291.73,-108.105 281.476,-105.44 282.052,-112.416"/>
</g>
<!-- prewrite -->
<g id="node4" class="node"><title>prewrite</title>
<g id="a_node4"><a xlink:href="#prewrite" xlink:title="Plan rewriting infrastructure">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="129,-90 19,-90 19,-54 129,-54 129,-90"/>
<text text-anchor="middle" x="74" y="-70.1" font-family="Times,serif" font-size="8.00">Plan rewriting infrastructure</text>
</a>
</g>
</g>
<!-- prewrite&#45;&gt;corropt -->
<g id="edge3" class="edge"><title>prewrite&#45;&gt;corropt</title>
<path fill="none" stroke="black" d="M129.364,-76.4888C170.823,-79.912 229.512,-84.7579 281.824,-89.0772"/>
<polygon fill="black" stroke="black" points="281.599,-92.5704 291.853,-89.9053 282.175,-85.5942 281.599,-92.5704"/>
</g>
<!-- irplan -->
<g id="node5" class="node"><title>irplan</title>
<g id="a_node5"><a xlink:href="#irplan" xlink:title="ðŸŽ¯Use IR codegen for plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="127.5,-36 20.5,-36 20.5,-0 127.5,-0 127.5,-36"/>
<text text-anchor="middle" x="74" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Use IR codegen for plans</text>
</a>
</g>
</g>
<!-- irplan&#45;&gt;corropt -->
<g id="edge4" class="edge"><title>irplan&#45;&gt;corropt</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M127.538,-31.0141C179.271,-43.8286 259.066,-63.5942 319.308,-78.5166"/>
<polygon fill="black" stroke="black" points="318.631,-81.9546 329.179,-80.9618 320.314,-75.16 318.631,-81.9546"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>implement and apply rules to eliminate the apply operator in plans
in common cases</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
<div class="section" id="user-facing-features">
<h2><a class="toc-backref" href="#id26"><span class="sectnum">4.9</span> User-facing features</a></h2>
<div class="contents local topic" id="id9">
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#show-rewrite-alternatives-in-explain" id="id67"><span class="sectnum">4.9.1</span> Show rewrite alternatives in EXPLAIN</a></p></li>
<li><p><a class="reference internal" href="#reveal-table-stats-to-users" id="id68"><span class="sectnum">4.9.2</span> Reveal table stats to users</a></p></li>
<li><p><a class="reference internal" href="#expose-query-stats-to-users" id="id69"><span class="sectnum">4.9.3</span> Expose query stats to users</a></p></li>
<li><p><a class="reference internal" href="#expose-node-quality-to-users" id="id70"><span class="sectnum">4.9.4</span> Expose node quality to users</a></p></li>
<li><p><a class="reference internal" href="#allow-dbas-to-override-plans" id="id71"><span class="sectnum">4.9.5</span> Allow DBAs to override plans</a></p></li>
</ul>
</div>
<div class="section" id="show-rewrite-alternatives-in-explain">
<h3><a class="toc-backref" href="#id67"><span class="sectnum">4.9.1</span> Show rewrite alternatives in EXPLAIN</a></h3>
<p id="expalt">Overview:</p>
<div id='svg-container-expalt'>
<svg id='svg-expalt' width="458pt" height="44pt"
 viewBox="0.00 0.00 458.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 454,-40 454,4 -4,4"/>
<!-- expalt -->
<g id="node1" class="node"><title>expalt</title>
<g id="a_node1"><a xlink:href="#expalt" xlink:title="Show opt alternatives in EXPLAIN">
<polygon fill="lightgreen" stroke="black" points="450,-36 240,-36 240,-0 450,-0 450,-36"/>
<text text-anchor="middle" x="345" y="-14.3" font-family="Times,serif" font-size="14.00">Show opt alternatives in EXPLAIN</text>
</a>
</g>
</g>
<!-- pleq -->
<g id="node2" class="node"><title>pleq</title>
<g id="a_node2"><a xlink:href="#pleq" xlink:title="Plan equivalency classes">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="96,-36 0,-36 0,-0 96,-0 96,-36"/>
<text text-anchor="middle" x="48" y="-16.1" font-family="Times,serif" font-size="8.00">Plan equivalency classes</text>
</a>
</g>
</g>
<!-- pleq&#45;&gt;expalt -->
<g id="edge1" class="edge"><title>pleq&#45;&gt;expalt</title>
<path fill="none" stroke="black" d="M96.0698,-18C132.063,-18 183.25,-18 229.777,-18"/>
<polygon fill="black" stroke="black" points="229.935,-21.5001 239.935,-18 229.935,-14.5001 229.935,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>(optional) modify the current rewrite code to keep old plan nodes
alongside
the new nodes in their equivalency class</p></li>
<li><p>show all members of each equivalency class in EXPLAIN side-by-side,
so that the user can view which plans were considered. Probably a new
EXPLAIN option should gate this feature.</p></li>
<li><p>deprecate EXPLAIN(NOOPTIMIZE/NOEXPAND) in favor of this new feature.</p></li>
</ul>
<p>Sidecar:</p>
<ul class="simple">
<li><p>facilitates testing and troubleshooting of further plan optimizations</p></li>
</ul>
</div>
<div class="section" id="reveal-table-stats-to-users">
<h3><a class="toc-backref" href="#id68"><span class="sectnum">4.9.2</span> Reveal table stats to users</a></h3>
<p id="tstatsui">Overview:</p>
<div id='svg-container-tstatsui'>
<svg id='svg-tstatsui' width="422pt" height="44pt"
 viewBox="0.00 0.00 422.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 418,-40 418,4 -4,4"/>
<!-- tstatsui -->
<g id="node1" class="node"><title>tstatsui</title>
<g id="a_node1"><a xlink:href="#tstatsui" xlink:title="ðŸŽ¯Reveal table stats to users">
<polygon fill="lightgreen" stroke="black" points="414,-36 242,-36 242,-0 414,-0 414,-36"/>
<text text-anchor="middle" x="328" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Reveal table stats to users</text>
</a>
</g>
</g>
<!-- tstats -->
<g id="node2" class="node"><title>tstats</title>
<g id="a_node2"><a xlink:href="#tstats" xlink:title="Collecting table statistics">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="98,-36 7.10543e-15,-36 7.10543e-15,-0 98,-0 98,-36"/>
<text text-anchor="middle" x="49" y="-16.1" font-family="Times,serif" font-size="8.00">Collecting table statistics</text>
</a>
</g>
</g>
<!-- tstats&#45;&gt;tstatsui -->
<g id="edge1" class="edge"><title>tstats&#45;&gt;tstatsui</title>
<path fill="none" stroke="black" d="M98.2497,-18C134.997,-18 186.757,-18 231.749,-18"/>
<polygon fill="black" stroke="black" points="231.831,-21.5001 241.831,-18 231.831,-14.5001 231.831,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>expose table statistics either as documented system table or via
<span class="docutils literal">crdb_internal</span> accessor</p></li>
<li><p>investigate and if possible provide <span class="docutils literal">pg_stats</span>
<a class="reference external" href="https://www.postgresql.org/docs/9.6/static/view-pg-stats.html">https://www.postgresql.org/docs/9.6/static/view-pg-stats.html</a></p></li>
<li><p>implement an admin UI hidden debug page that reveals the statis</p></li>
<li><p>put the opportunity for more UI for table stats on the radar of the
design department</p></li>
</ul>
</div>
<div class="section" id="expose-query-stats-to-users">
<h3><a class="toc-backref" href="#id69"><span class="sectnum">4.9.3</span> Expose query stats to users</a></h3>
<p id="explstats">Overview:</p>
<div id='svg-container-explstats'>
<svg id='svg-explstats' width="442pt" height="44pt"
 viewBox="0.00 0.00 442.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 438,-40 438,4 -4,4"/>
<!-- explstats -->
<g id="node1" class="node"><title>explstats</title>
<g id="a_node1"><a xlink:href="#explstats" xlink:title="ðŸŽ¯Expose query stats to users">
<polygon fill="lightgreen" stroke="black" points="434,-36 255,-36 255,-0 434,-0 434,-36"/>
<text text-anchor="middle" x="344.5" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯Expose query stats to users</text>
</a>
</g>
</g>
<!-- qexstats -->
<g id="node2" class="node"><title>qexstats</title>
<g id="a_node2"><a xlink:href="#qexstats" xlink:title="ðŸŽ¯Collect per&#45;planop ex stats">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="111,-36 7.10543e-15,-36 7.10543e-15,-0 111,-0 111,-36"/>
<text text-anchor="middle" x="55.5" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Collect per&#45;planop ex stats</text>
</a>
</g>
</g>
<!-- qexstats&#45;&gt;explstats -->
<g id="edge1" class="edge"><title>qexstats&#45;&gt;explstats</title>
<path fill="none" stroke="black" d="M111.158,-18C148.883,-18 200.113,-18 244.869,-18"/>
<polygon fill="black" stroke="black" points="244.904,-21.5001 254.904,-18 244.904,-14.5001 244.904,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>ensure the stats show up in SHOW TRACE.</p></li>
<li><p>define and implement infrastructure to communicate and aggregate
these collected ex stats back to the gateway node.</p></li>
<li><p>make <span class="docutils literal">EXPLAIN ANALYZE</span> show the data after the query has run, see
<a class="reference external" href="https://www.postgresql.org/docs/9.1/static/sql-explain.html">https://www.postgresql.org/docs/9.1/static/sql-explain.html</a></p></li>
<li><p>log/aggregate this data in a new in-memory table
<span class="docutils literal">node_query_statistics</span> modeled
after <span class="docutils literal">node_statement_statistics</span>.</p></li>
</ul>
</div>
<div class="section" id="expose-node-quality-to-users">
<h3><a class="toc-backref" href="#id70"><span class="sectnum">4.9.4</span> Expose node quality to users</a></h3>
<p id="nqual">Overview:</p>
<div id='svg-container-nqual'>
<svg id='svg-nqual' width="435pt" height="44pt"
 viewBox="0.00 0.00 435.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 431,-40 431,4 -4,4"/>
<!-- nqual -->
<g id="node1" class="node"><title>nqual</title>
<g id="a_node1"><a xlink:href="#nqual" xlink:title="ðŸŽ¯ðŸŽ¯Expose node quality to users">
<polygon fill="lightgreen" stroke="black" points="427,-36 225,-36 225,-0 427,-0 427,-36"/>
<text text-anchor="middle" x="326" y="-14.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Expose node quality to users</text>
</a>
</g>
</g>
<!-- nbench -->
<g id="node2" class="node"><title>nbench</title>
<g id="a_node2"><a xlink:href="#nbench" xlink:title="Node benchmarking">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="81,-36 0,-36 0,-0 81,-0 81,-36"/>
<text text-anchor="middle" x="40.5" y="-16.1" font-family="Times,serif" font-size="8.00">Node benchmarking</text>
</a>
</g>
</g>
<!-- nbench&#45;&gt;nqual -->
<g id="edge1" class="edge"><title>nbench&#45;&gt;nqual</title>
<path fill="none" stroke="black" d="M81.218,-18C115.788,-18 167.582,-18 214.55,-18"/>
<polygon fill="black" stroke="black" points="214.803,-21.5001 224.803,-18 214.803,-14.5001 214.803,-21.5001"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>modify <span class="docutils literal">node ls</span> and/or admin UI to highlight nodes with slow disks
and/or slow CPU and/or low memory</p></li>
<li><p>define a notion of &quot;node quality&quot; based on these metrics and show it
to users</p></li>
</ul>
</div>
<div class="section" id="allow-dbas-to-override-plans">
<h3><a class="toc-backref" href="#id71"><span class="sectnum">4.9.5</span> Allow DBAs to override plans</a></h3>
<p id="dbaoverride">Overview:</p>
<div id='svg-container-dbaoverride'>
<svg id='svg-dbaoverride' width="480pt" height="152pt"
 viewBox="0.00 0.00 480.00 152.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)">
<title>sql</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-148 476,-148 476,4 -4,4"/>
<!-- dbaoverride -->
<g id="node1" class="node"><title>dbaoverride</title>
<g id="a_node1"><a xlink:href="#dbaoverride" xlink:title="ðŸŽ¯ðŸŽ¯Allow DBAs to override plans">
<defs>
<linearGradient id="l_0" gradientUnits="userSpaceOnUse" x1="260" y1="-72" x2="472" y2="-72" >
<stop offset="0" style="stop-color:lightgreen;stop-opacity:1.;"/>
<stop offset="1" style="stop-color:lightblue;stop-opacity:1.;"/>
</linearGradient>
</defs>
<polygon fill="url(#l_0)" stroke="black" points="472,-90 260,-90 260,-54 472,-54 472,-90"/>
<text text-anchor="middle" x="366" y="-68.3" font-family="Times,serif" font-size="14.00">ðŸŽ¯ðŸŽ¯Allow DBAs to override plans</text>
</a>
</g>
</g>
<!-- explstats -->
<g id="node2" class="node"><title>explstats</title>
<g id="a_node2"><a xlink:href="#explstats" xlink:title="ðŸŽ¯Expose query stats to users">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="114,-144 2,-144 2,-108 114,-108 114,-144"/>
<text text-anchor="middle" x="58" y="-124.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Expose query stats to users</text>
</a>
</g>
</g>
<!-- explstats&#45;&gt;dbaoverride -->
<g id="edge1" class="edge"><title>explstats&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" d="M114.06,-116.284C152.614,-109.48 205.482,-100.15 252.753,-91.8084"/>
<polygon fill="black" stroke="black" points="253.508,-95.2292 262.747,-90.0446 252.291,-88.3358 253.508,-95.2292"/>
</g>
<!-- planser -->
<g id="node3" class="node"><title>planser</title>
<g id="a_node3"><a xlink:href="#planser" xlink:title="Logical plan spec/ser language">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="116,-90 7.10543e-15,-90 7.10543e-15,-54 116,-54 116,-90"/>
<text text-anchor="middle" x="58" y="-70.1" font-family="Times,serif" font-size="8.00">Logical plan spec/ser language</text>
</a>
</g>
</g>
<!-- planser&#45;&gt;dbaoverride -->
<g id="edge2" class="edge"><title>planser&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" d="M116.197,-72C153.668,-72 203.968,-72 249.534,-72"/>
<polygon fill="black" stroke="black" points="249.783,-75.5001 259.783,-72 249.783,-68.5001 249.783,-75.5001"/>
</g>
<!-- cacheplans -->
<g id="node4" class="node"><title>cacheplans</title>
<g id="a_node4"><a xlink:href="#cacheplans" xlink:title="ðŸŽ¯Cache query plans">
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="100,-36 16,-36 16,-0 100,-0 100,-36"/>
<text text-anchor="middle" x="58" y="-16.1" font-family="Times,serif" font-size="8.00">ðŸŽ¯Cache query plans</text>
</a>
</g>
</g>
<!-- cacheplans&#45;&gt;dbaoverride -->
<g id="edge3" class="edge"><title>cacheplans&#45;&gt;dbaoverride</title>
<path fill="none" stroke="black" stroke-dasharray="1,5" d="M100.269,-25.2827C139.354,-32.18 199.828,-42.852 253.116,-52.2557"/>
<polygon fill="black" stroke="black" points="252.519,-55.7044 262.975,-53.9956 253.736,-48.8109 252.519,-55.7044"/>
</g>
</g>
</svg>
</div>
<p>Goals:</p>
<ul class="simple">
<li><p>define a table that matches query structure to (predefined) logical
plans;</p></li>
<li><p>define a mechanism for operators to &quot;save&quot; the logical plan for a
query
into that table;</p></li>
<li><p>modify the planner to check this table for new queries; if a query
matches
use the predefined plan instead of the regular logical planning code.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="backlog">
<h1><a class="toc-backref" href="#id27"><span class="sectnum">5</span> Backlog</a></h1>
<p>Items from Jordan:</p>
<ul class="simple">
<li><p>change PK of a table</p></li>
<li><p>constraint checking:</p></li>
<li><p>change defaults to become like postgres</p></li>
<li><p>implement synchronous checking</p></li>
<li><p>add indexes automatically for FKs</p></li>
<li><p>implement DEFERRABLE INITIALLY DEFERRED</p>
<ul>
<li><p>test/support FK cycles</p></li>
<li><p>modify dump to use INITIALLY DEFERRED to break cycles</p></li>
</ul>
</li>
<li><p>db/table initialization using TEMPLATE</p></li>
</ul>
</div>
</div>
<script>
 window.onload = function() {
   window.zoomSvg = svgPanZoom('#svg-items', {
     zoomEnabled: true,
     controlIconsEnabled: true,
     fit: true,
     center: true,
   });
 }
</script>
</body>
</html>
