- Feature Name:
- Status: draft
- Start Date: 2021-04-23
- Authors: Andrii Vorobiov
- RFC PR: (PR # after acceptance of initial draft)
- Cockroach Issue: (one or more # from the issue tracker)

**Remember, you can submit a PR with your RFC before the text is
complete. Refer to the [README](README.md#rfc-process) for details.**

**Remember, you can either fill in this template from scratch, for
example if you prefer working from a blank slate, or you can follow
the writing prompts in the [GUIDE](GUIDE.md). In any case, please ensure
at the end that you have all relevant topics from the guide covered in
your prose.**

# Summary

Migration from Make builds to Bazel build tool for the entire project is one of OKRAs which is aimed to
deliver the product in a timely and sustainable manner. This proposal outlines a subset of changes required to perform 
migration to Bazel build for DB Console (and UI related packages).

# Motivation

Migration should not affect the current build process with `Make` so it can be gradual (without
breaking changes).
The migration process can be broken down into the following parts:
- establish Bazel build for Db Console (with support for both OSS and CCL licensing);
- establish Bazel build and publishing artifacts to NPM registry for `cluster-ui` package;
- setup development workflows with `ibazel` to run dev-server with hot reloading on every change, and
tests execution.

Bazel builds (comparing to Make build) allow defining granular steps which can be run independently for particular
package instead of the entire project, which in turn reduces the build time and a chain of unnecessary rebuilds for
unchanged parts of code.

Github `Bazel` project already includes following tasks related to migration to Bazel for Db Console   
- [build: Bazelize UI](https://github.com/cockroachdb/cockroach/issues/56068)
- [build: Get built UI to bindata (bazel)](https://github.com/cockroachdb/cockroach/issues/56069)
- [build,bazel: Implement JS protobuf support for Bazel](https://github.com/cockroachdb/cockroach/issues/59329)
- [build: Get bazel building both ccl and oss builds](https://github.com/cockroachdb/cockroach/issues/56071)

# Technical design

Current UI project has following dependencies

![DbConsole project dependencies](images/db-console-bazel-build.png?raw=true)

where:
- `*.proto` files are set of protobuf files that are required to build JS protobuf client code
- `ccl/oss` specifies build condition, whether the project is built for CCL or OSS licence
- `ccl protos/oss protos` - autogenerated JS protobuf client code
- `db-console` is main `ui` project
- `cluster-ui` is a nested `ui/cluster-ui` JS project
- `ui/(ccl|oss)/bidndata.go` - autogenerated Go sources that embed JS bundled files

Bazel build pipeline for UI can be broken down in following steps:
- Build protobuf js client code [db-console: bazel build for protobufjs clients #64065](https://github.com/cockroachdb/cockroach/pull/64065)
- `cluster-ui` standalone build (react + webpack project) 
- `db-console` standalone build (react + webpack project)

### Generate protobuf JS client code
Protobuf CCL and OSS packages are considered as an independent bazel builds. The installation of `protobufjs` package
requires additional steps to install required dependencies for protobufjs-cli tool. This problem persists in Makefile
as well and will be fixed with major release of protobufjs ver 7. Installation of dependencies and binding protobuf cli
is done according to example provided here: https://github.com/bazelbuild/rules_nodejs/tree/stable/examples/protobufjs.

### Build `db-console` and `cluster-ui` packages
`db-console` and `cluster-ui` are typescript packages which have their own webpack configuration to build production
bundle, run dev server and watch for changes.
To build these projects, additional project changes required:
- install `@bazel/typescript` to handle typescript compilation
- change relative paths for input and output files to be absolute paths in webpack configs because bazel resolves
  relative paths from workspace root dir (which is root of entire `cockroach` project)

Simplified webpack rules to build `db-console` project and run dev server can be defined like this:
```
webpack(
    name = "ui_bundle",
    args = [
        "--config",
        "$(execpath webpack.app.js)",
        "--env.dist",
        "ccl" # use select()
    ],
    data = [
        "src",
        "styl",
        "fonts",
        "assets",
        "ccl",
        ".babelrc",
        "webpack.app.js",
        "tsconfig.json",
        "protos.ccl.manifest.json",
        "vendor.oss.manifest.json",
        "distccl/vendor.dll.js",
        "distccl/protos.dll.js",
        "favicon.ico",
        "@npm//:node_modules"
    ],
)

webpack_dev_server(
    name = "ui_watch",
    args = [
        "--config",
        "$(execpath webpack.app.js)",
        "--env.dist",
        "ccl",
        "--port",
        "3000",
        "--mode",
        "development",
        "--env.target",
        "http://localhost:8080",
    ],
    data = [
        "src",
        "styl",
        "fonts",
        "assets",
        "ccl",
        ".babelrc",
        "webpack.app.js",
        "tsconfig.json",
        "protos.ccl.manifest.json",
        "vendor.oss.manifest.json",
        "distccl/vendor.dll.js",
        "distccl/protos.dll.js",
        "favicon.ico",
        "@npm//:node_modules"
    ],
)
```

This configuration has to be extended to accept additional arguments which can alter target builds.

Build bundle with command: `bazel build pkg/ui:ui_bundle` which accepts following arguments
- `--env.dist=oss|ccl` - build for specific licence
Watch mode: `bazel run pkg/ui:ui_watch` which accepts following arguments
- `--port` - specify port to proxy requests on server
- `--secure` - run in secure mode (https)

### Suggested out of [bazel] scope project improvements 
To make transition to Bazel builds more straightforward it might be necessary to:  
- get rid of offline NPM packages support with `ui/yarn-vendor` sub-module
- restructure `ui` code. It includes following NPM projects: `db-console` (root project), `cluster-ui`, and
`crdb-protobufjs-client` projects. These projects depend on each other and reuse same dependencies.
`db-console` and `cluster-ui` projects can be merged into a single project to simplify and speed up project build.
  (it might be considered as a task out of scope for this RFC or as a prerequisite for it).
- `db-console` project includes 3 separate webpack configs (`webpack.app.js`, `webpack.protos.js`, `webpack.vendor.js`)
that can be merged into single config.

# Unresolved questions
- `db-console` project includes optional dependencies (`pkg/ui/opt`) which is required for ui testing purposes and
  should not be installed with common build processes. It is not clear for now, how and when these dependencies should
  be installed.
- Go 1.6 introduces `embed` flag which can potentially replace `binddata` external package and the logic of binding
  assets. Should we consider this option, or it's early to adopt it?
