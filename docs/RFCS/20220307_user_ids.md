- Feature Name: User IDs For Internal User Information
- Status: draft
- Start Date: 2022-03-07
- Authors: Fenil Patel
- RFC PR: (PR # after acceptance of initial draft)
- Cockroach Issue: [76079](https://github.com/cockroachdb/cockroach/issues/76079)


# Summary
Support stable IDs to key internal user information instead of username. Requires a long-running migration to give 
existing users IDs

# Motivation

Currently, all internal per-user information is keyed by the username. This is not ideal because it makes it difficult 
to rename a user without breaking things. It's also not ideal because usernames can be considered personal data, but we 
need to use them in many places in logging.


# High-level Summary
The idea is to convert code dependencies of username and lookups to use the IDs instead in 3 steps. First adding the ID 
columns to system tables and updating related syntax statements. Second, updating the user privileges objects and lookup 
based on usernames. Finally, migrating the existing instances of cockroach.


# Technical design
### Adding ID columns to tables with username columns
The ids will be randomly generated UUID when creating a new user during insert into system.users. The SQL syntax for all 
other tables will be updated such that the ids from the users table are used when adding new rows and lookups.

#### System Tables Currently:
```
fenil@free-tier11.gcp-us-east1.cockroachlabs.cloud:26257/defaultdb> \d system.users
column_name   | data_type | is_nullable | column_default | generation_expression |  indices  | is_hidden
-----------------+-----------+-------------+----------------+-----------------------+-----------+------------
username       | STRING    |    false    | NULL           |                       | {primary} |   false
hashedPassword | BYTES     |    true     | NULL           |                       | {primary} |   false
isRole         | BOOL      |    false    | false          |                       | {primary} |   false
(3 rows)
```

```
fenil@free-tier11.gcp-us-east1.cockroachlabs.cloud:26257/defaultdb> \d system.role_options
column_name | data_type | is_nullable | column_default | generation_expression |  indices  | is_hidden
--------------+-----------+-------------+----------------+-----------------------+-----------+------------
username    | STRING    |    false    | NULL           |                       | {primary} |   false
option      | STRING    |    false    | NULL           |                       | {primary} |   false
value       | STRING    |    true     | NULL           |                       | {primary} |   false
(3 rows)
```

```
fenil@free-tier11.gcp-us-east1.cockroachlabs.cloud:26257/defaultdb> \d system.role_members
column_name | data_type | is_nullable | column_default | generation_expression |                         indices                         | is_hidden
--------------+-----------+-------------+----------------+-----------------------+---------------------------------------------------------+------------
role        | STRING    |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
member      | STRING    |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
isAdmin     | BOOL      |    false    | NULL           |                       | {primary}                                               |   false
(3 rows)
```

```
fenil@free-tier11.gcp-us-east1.cockroachlabs.cloud:26257/defaultdb> \d system.database_role_settings
column_name | data_type | is_nullable | column_default | generation_expression |  indices  | is_hidden
--------------+-----------+-------------+----------------+-----------------------+-----------+------------
database_id | OID       |    false    | NULL           |                       | {primary} |   false
role_name   | STRING    |    false    | NULL           |                       | {primary} |   false
settings    | STRING[]  |    false    | NULL           |                       | {primary} |   false
(3 rows)
```


#### After Change:
```
demo@127.0.0.1:26257/movr> \d system.users
column_name   | data_type | is_nullable |  column_default   | generation_expression |             indices             | is_hidden
-----------------+-----------+-------------+-------------------+-----------------------+---------------------------------+------------
username       | STRING    |    false    | NULL              |                       | {primary,users_username_id_idx} |   false
hashedPassword | BYTES     |    true     | NULL              |                       | {primary}                       |   false
isRole         | BOOL      |    false    | false             |                       | {primary}                       |   false
id             | UUID      |    false    | gen_random_uuid() |                       | {primary,users_username_id_idx} |   false
(4 rows)
```

```
demo@127.0.0.1:26257/movr> \d system.role_options
column_name | data_type | is_nullable | column_default | generation_expression |  indices  | is_hidden
--------------+-----------+-------------+----------------+-----------------------+-----------+------------
username    | STRING    |    false    | NULL           |                       | {primary} |   false
option      | STRING    |    false    | NULL           |                       | {primary} |   false
value       | STRING    |    true     | NULL           |                       | {primary} |   false
id          | UUID      |    false    | NULL           |                       | {primary} |   false
(4 rows)
```

```
demo@127.0.0.1:26257/movr> \d system.role_members
column_name | data_type | is_nullable | column_default | generation_expression |                         indices                         | is_hidden
--------------+-----------+-------------+----------------+-----------------------+---------------------------------------------------------+------------
role        | STRING    |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
member      | STRING    |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
isAdmin     | BOOL      |    false    | NULL           |                       | {primary}                                               |   false
roleId      | UUID      |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
memberId    | UUID      |    false    | NULL           |                       | {primary,role_members_member_idx,role_members_role_idx} |   false
(5 rows)
```

```
demo@127.0.0.1:26257/movr> \d system.database_role_settings
column_name | data_type | is_nullable | column_default | generation_expression |  indices  | is_hidden
--------------+-----------+-------------+----------------+-----------------------+-----------+------------
database_id | OID       |    false    | NULL           |                       | {primary} |   false
role_name   | STRING    |    false    | NULL           |                       | {primary} |   false
settings    | STRING[]  |    false    | NULL           |                       | {primary} |   false
role_id     | UUID      |    false    | NULL           |                       | {primary} |   false
(4 rows)
```


### Type of User ID
- **UUID** allows for randomly generated IDs during insert using `gen_random_uuid()` as default value for the column.
  #### Pros:
  - It requires no collision handling 
  - Adding a new column with default value makes it easy to migrate older versions
  #### Cons:
  - Users can't make use of ids themselves in other statements as they are hard to remember


- **INT** is closer to what [postgres does](https://www.postgresql.org/docs/8.0/sql-createuser.html) with uid when creating a user. This is useful when allowing a user to specify the 
uid in future updates. For existing users, a hash function could be used to generated their ID. We can also take an approach similar to postgres and have the new ID be the highest ID + 1
  #### Pros:
  - Matches postgres use of UID (see example below)
  - User can refer to them and possibly use in other statements
  #### Cons:
  - Migration will need to atomically add a NOT NULL column and fill in all the ids
  
  ```
  postgres=# create user a;
  CREATE ROLE
  postgres=# SELECT *                                                                                                                                                                                                                           FROM pg_user;
  usename  | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig
  ----------+----------+-------------+----------+---------+--------------+----------+----------+-----------
  postgres |       10 | t           | t        | t       | t            | ******** |          |
  a        |    16385 | f           | f        | f       | f            | ******** |          |
  (2 rows)
  
  postgres=# create user b;
  CREATE ROLE
  postgres=# create user aa;
  CREATE ROLE
  postgres=# create user ba;
  CREATE ROLE
  postgres=# create user ab;
  CREATE ROLE
  postgres=# SELECT *                                                                                                                                                                                                                           FROM pg_user;
  usename  | usesysid | usecreatedb | usesuper | userepl | usebypassrls |  passwd  | valuntil | useconfig
  ----------+----------+-------------+----------+---------+--------------+----------+----------+-----------
  postgres |       10 | t           | t        | t       | t            | ******** |          |
  a        |    16385 | f           | f        | f       | f            | ******** |          |
  b        |    16386 | f           | f        | f       | f            | ******** |          |
  aa       |    16387 | f           | f        | f       | f            | ******** |          |
  ba       |    16388 | f           | f        | f       | f            | ******** |          |
  ab       |    16389 | f           | f        | f       | f            | ******** |          |
  (6 rows)
  ```

***Require more discussion on this**



### Updating User Privileges and Lookups
An ID field will be added to UserPriviliges object. The Privilege Descriptors store user privilege objects in an array 
in sorted order based on usernames currently. We’ll need to refactor the code such that the privileges array is sorted 
by IDs instead.

`Code in privilege.pb.go`:

```
// PrivilegeDescriptor describes a list of users and attached
// privileges. The list should be sorted by user for fast access.
type PrivilegeDescriptor struct {
Users      []UserPrivileges                                               `protobuf:"bytes,1,rep,name=users" json:"users"`
OwnerProto github_com_cockroachdb_cockroach_pkg_security.SQLUsernameProto `protobuf:"bytes,2,opt,name=owner_proto,json=ownerProto,casttype=github.com/cockroachdb/cockroach/pkg/security.SQLUsernameProto" json:"owner_proto"`
Version    PrivilegeDescVersion                                           `protobuf:"varint,3,opt,name=version,casttype=PrivilegeDescVersion" json:"version"`
}
```


Since most SQL syntax takes in username/role, we also require a lookup function to get the id from system.users by a 
username. Additionally, add caching the lookups to reduce the overall runtime of statements and tests.


### Long-running migration
We need to add the new system table columns to existing instances and migrate all the existing users and generate their 
corresponding IDs.The migration will need to update the UserPriviliges to contain the new user IDs.

During the migration, we will need to update the existing Privilege descriptors and resort the UserPriviliges arrays by 
ID in order to support the lookups by user IDs.

![](images/user-ids-migration-mixed.png?raw=true)


### Mixed Version Deployments
We’ll need to version gate all lookups to ensure the use of username until all the nodes have been migrated to 22.1. 
It ensures that if the ID field does not exist in UserPrivileges of all nodes, it doesn’t result in conflicts during lookups.
Once all nodes are upgraded from 21.2 to 22.1, the version gate will allow privilege lookups using IDs.

#### Differences:
| 22.1 & Mixed Cluster                                                                       | 22.2                                                                                                               | 
|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------| 
| User privilege lookups are done using username. ID field in 22.2 version nodes is ignored. | ID is acquired from system.user and user privilege lookups are done using IDs instead.|




