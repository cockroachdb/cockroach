diff --git a/internal/buildtags/BUILD.bazel b/internal/buildtags/BUILD.bazel
index a556ba522..db4fbfc14 100644
--- a/internal/buildtags/BUILD.bazel
+++ b/internal/buildtags/BUILD.bazel
@@ -5,17 +5,29 @@ go_library(
     srcs = [
         "cgo_off.go",
         "cgo_on.go",
-        "invariants_off.go",
         "race_off.go",
         "race_on.go",
         "slow_build_off.go",
         "slow_build_on.go",
         "tracing_off.go",
-    ],
+    ] + select({
+        "@com_github_cockroachdb_cockroach//build/toolchains:crdb_test": [":gen-crdb-test-on"],
+        "//conditions:default": ["invariants_off.go", "invariants_on.go"],
+    }),
     importpath = "github.com/cockroachdb/pebble/internal/buildtags",
     visibility = ["//:__subpackages__"],
 )
 
+REMOVE_GO_BUILD_CONSTRAINTS = "cat $< | grep -v '//go:build' | grep -v '// +build' > $@"
+
+# In crdb-test mode, we unconditionally enable invariants.
+genrule(
+    name = "gen-crdb-test-on",
+    srcs = ["invariants_on.go"],
+    outs = ["gen-crdb_test_on.go"],
+    cmd = REMOVE_GO_BUILD_CONSTRAINTS,
+)
+
 alias(
     name = "go_default_library",
     actual = ":buildtags",
diff --git a/internal/invariants/BUILD.bazel b/internal/invariants/BUILD.bazel
index 3dd80d650..36dae2b77 100644
--- a/internal/invariants/BUILD.bazel
+++ b/internal/invariants/BUILD.bazel
@@ -4,14 +4,25 @@ go_library(
     name = "invariants",
     srcs = [
         "invariants.go",
-        "off.go",
-        "on.go",
-    ],
+    ] + select({
+        "@com_github_cockroachdb_cockroach//build/toolchains:crdb_test": [":gen-crdb-test-on"],
+        "//conditions:default": ["off.go", "on.go"],
+    }),
     importpath = "github.com/cockroachdb/pebble/internal/invariants",
     visibility = ["//:__subpackages__"],
     deps = ["//internal/buildtags"],
 )
 
+REMOVE_GO_BUILD_CONSTRAINTS = "cat $< | grep -v '//go:build' | grep -v '// +build' > $@"
+
+# In crdb-test mode, we unconditionally enable invariants.
+genrule(
+    name = "gen-crdb-test-on",
+    srcs = ["on.go"],
+    outs = ["gen-crdb_test_on.go"],
+    cmd = REMOVE_GO_BUILD_CONSTRAINTS,
+)
+
 alias(
     name = "go_default_library",
     actual = ":invariants",
diff --git a/internal/treesteps/BUILD.bazel b/internal/treesteps/BUILD.bazel
index e4fbbab69..e1cccbe79 100644
--- a/internal/treesteps/BUILD.bazel
+++ b/internal/treesteps/BUILD.bazel
@@ -5,13 +5,25 @@ go_library(
     srcs = [
         "data.go",
         "doc.go",
-        "tree_steps_off.go",
-    ],
+    ] + select({
+        "@com_github_cockroachdb_cockroach//build/toolchains:crdb_test": [":gen-crdb-test-on"],
+        "//conditions:default": ["tree_steps_off.go", "tree_steps_on.go"],
+    }),
     importpath = "github.com/cockroachdb/pebble/internal/treesteps",
     visibility = ["//:__subpackages__"],
     deps = ["//internal/treeprinter"],
 )
 
+REMOVE_GO_BUILD_CONSTRAINTS = "cat $< | grep -v '//go:build' | grep -v '// +build' > $@"
+
+# In crdb-test mode, we unconditionally enable invariants.
+genrule(
+    name = "gen-crdb-test-on",
+    srcs = ["tree_steps_on.go"],
+    outs = ["gen-crdb_test_on.go"],
+    cmd = REMOVE_GO_BUILD_CONSTRAINTS,
+)
+
 alias(
     name = "go_default_library",
     actual = ":treesteps",
diff --git a/objstorage/objstorageprovider/objiotracing/BUILD.bazel b/objstorage/objstorageprovider/objiotracing/BUILD.bazel
index 171354745..198824703 100644
--- a/objstorage/objstorageprovider/objiotracing/BUILD.bazel
+++ b/objstorage/objstorageprovider/objiotracing/BUILD.bazel
@@ -5,6 +5,7 @@ go_library(
     srcs = [
         "obj_io_tracing.go",
         "obj_io_tracing_off.go",
+        "obj_io_tracing_on.go",
     ],
     importpath = "github.com/cockroachdb/pebble/objstorage/objstorageprovider/objiotracing",
     visibility = ["//visibility:public"],
