#!/usr/bin/env sh
# Push tagger binaries to AWS.
# This is run by circle-ci when building due to a tag.
#
# Prerequisites:
# - binaries must be statically linked by running build/build-static-binaries.sh
# - circleci must have AWS credentials configured
# - AWS credentials must have S3 write permissions on the bucket
# - the aws cli must be installed on the machine
# - the region must be configured
#
# Ask marc@cockroachlabs.com for the aws credentials file to use, then follow the
# steps in circle.yml to configure aws and generate the binaries.

set -eux

cd "$(dirname "${0}")"

export BUCKET_NAME=binaries.cockroachdb.com

# Tar up and push linux/osx binaries. One tagged, one called "latest".
./push-release-tarball.sh cockroach cockroach-"${VERSION}".linux-amd64
./push-release-tarball.sh cockroach cockroach-latest.linux-amd64
# The OSX binary name is generated by build-osx.sh. One tagged, one called "latest".
./push-release-tarball.sh cockroach-darwin-10.9-amd64 cockroach-"${VERSION}".darwin-10.9-amd64
./push-release-tarball.sh cockroach-darwin-10.9-amd64 cockroach-latest.darwin-10.9-amd64
# Push source tarball (for Homebrew and other package managers that like
# tarballs). One tagged, one called "latest".
time aws s3 cp cockroach.tgz "s3://${BUCKET_NAME}/cockroach-latest.source.tgz"
time aws s3 cp cockroach.tgz "s3://${BUCKET_NAME}/cockroach-${VERSION}.source.tgz"