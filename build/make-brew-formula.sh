#!/bin/bash
#
# Update the cockroach homebrew formula. Expected usage:
#
# 1. Tag a new release on https://github.com/cockroachdb/cockroach/releases
#   a. The tag should have a name like v0.1-alpha
#   b. This script currently requires the tag to start with a "v".
# 2. `git pull` to grab the newly create git tag
# 3. `git checkout <tag>`
#   a. `glock sync github.com/cockroachdb/cockroach` to ensure
#      dependencies are at the right version
# 4. build/make-brew-formula.sh
# 5. Test the formula: brew install --verbose build/cockroach.rb
#
# Author: Peter Mattis (peter@cockroachlabs.com)

set -euo pipefail

version="$(git describe --tags --dirty --candidates=0)"
revision=$(git rev-parse ${version})
template="build/cockroach-template.rb"
output="build/cockroach.rb"
line=$(grep -n '### GO RESOURCES ###' ${template} | cut -d ":" -f 1)

{
    echo "### Generated by build/make-brew-formula.rb"
    echo "### source: ${template}"
    echo "### DO NOT EDIT!'"
    echo
    head -n $((line-1)) ${template} | sed -e s/@VERSION@/${version}/g -e s/@REVISION@/${revision}/g

    for dep in $(build/depvers.sh); do
        repo=$(echo ${dep} | cut -f1 -d:)
        if test "${repo}" = "github.com/cockroachdb/cockroach"; then
            continue
        fi
        rev=$(echo ${dep} | cut -f2 -d:)
        echo
        echo "  go_resource \"${repo}\" do"
        echo "    url \"https://${repo}.git\","
        echo "      :revision => \"${rev}\""
        echo "  end"
    done

    tail -n +$(($line+1)) ${template}
} > ${output}

echo "generated: ${output}"
