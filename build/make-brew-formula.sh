#!/bin/bash
#
# Update the cockroach homebrew formula. Requires
# github.com/samertm/homebrew-go-resources. Expected usage:
#
# 1. Tag a new release on https://github.com/cockroachdb/cockroach/releases
#   a. The tag should have a name like v0.1-alpha
#   b. This script currently requires the tag to start with a "v".
# 2. `git pull` to grab the newly create git tag
# 3. `git checkout <tag>`
# 4. build/make-brew-formula.sh
# 5. Test the formula: brew install --verbose build/cockroach.rb
#
# Author: Peter Mattis (peter@cockroachlabs.com)

set -euo pipefail

version="$(git describe --tags --dirty --candidates=0)"
url="https://github.com/cockroachdb/cockroach/archive/${version}.tar.gz"
echo -n "${version}: computing sha256: "
# The use of shasum here might be Mac OS X specific, but that isn't
# too onerous for whomever is regenerating the brew formula.
sha256=$(curl -L -s ${url} | shasum -a 256 | awk '{print $1}')
echo "${sha256}"

template="build/cockroach-template.rb"
output="build/cockroach.rb"
line=$(grep -n '### GO RESOURCES ###' ${template} | cut -d ":" -f 1)

{
    echo "### Generated by build/make-brew-formula.rb"
    echo "### source: ${template}"
    echo "### DO NOT EDIT!'"
    echo
    head -n $((line-1)) ${template} | sed -e s/@VERSION@/${version#v}/g -e s/@SHA256@/${sha256}/g
    # homebrew-go-resources outputs some urls with "https///". We
    # could potentially generate this section from the GLOCKFILE,
    # though the dependencies there are more than what we need to
    # build just the cockroach binary.
    homebrew-go-resources . | sed 's,https///,https://,g'
    tail -n +$(($line+1)) ${template}
} > ${output}

echo "generated: ${output}"
