// Generated by tsc.
// source: cockroach/resource/us/ts/...
// DO NOT EDIT!
//
// Copyright 2015 The Cockroach Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
// implied. See the License for the specific language governing
// permissions and limitations under the License. See the AUTHORS file
// for names of contributors.
//
// Authors: Bram Gruneir (bram.gruneir@gmail.com)
//		    Andrew Bonventre (andybons@gmail.com)
//		    Matt Tracy (matt@cockroachlabs.com)
//
var headerDescription = 'This file is designed to add the header to the top of the combined js file.';
// source: models/timeseries.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
// Author: Matt Tracy (matt@cockroachlabs.com)
var Models;
(function (Models) {
    var Metrics;
    (function (Metrics) {
        (function (QueryAggregator) {
            QueryAggregator[QueryAggregator["AVG"] = 1] = "AVG";
            QueryAggregator[QueryAggregator["AVG_RATE"] = 2] = "AVG_RATE";
        })(Metrics.QueryAggregator || (Metrics.QueryAggregator = {}));
        var QueryAggregator = Metrics.QueryAggregator;
        function query(start, end, agg, series) {
            var url = "/ts/query";
            var data = {
                start_nanos: start.getTime() * 1.0e6,
                end_nanos: end.getTime() * 1.0e6,
                queries: series.map(function (r) {
                    return {
                        name: r,
                        aggregator: agg,
                    };
                }),
            };
            return m.request({ url: url, method: "POST", extract: nonJsonErrors, data: data })
                .then(function (d) {
                if (!d.results) {
                    d.results = [];
                }
                d.results.forEach(function (r) {
                    if (!r.datapoints) {
                        r.datapoints = [];
                    }
                });
                return d;
            });
        }
        var RecentQuery = (function () {
            function RecentQuery(windowDuration, _agg) {
                var series = [];
                for (var _i = 2; _i < arguments.length; _i++) {
                    series[_i - 2] = arguments[_i];
                }
                this.windowDuration = windowDuration;
                this._agg = _agg;
                this._series = series;
            }
            RecentQuery.prototype.query = function () {
                var endTime = new Date();
                var startTime = new Date(endTime.getTime() - this.windowDuration);
                return query(startTime, endTime, this._agg, this._series);
            };
            return RecentQuery;
        })();
        Metrics.RecentQuery = RecentQuery;
        var QueryManager = (function () {
            function QueryManager(_query) {
                this._query = _query;
                this._result = null;
                this._error = null;
                this._resultEpoch = 0;
                this._outstanding = null;
            }
            QueryManager.prototype.processOutstanding = function () {
                if (this._outstanding) {
                    var completed = (this._outstanding.error() != null || this._outstanding.result() != null);
                    if (completed) {
                        this._result = this._outstanding.result();
                        this._error = this._outstanding.error();
                        this._outstanding = null;
                        this._resultEpoch++;
                    }
                }
            };
            QueryManager.prototype.setQuery = function (q) {
                this._query = q;
            };
            QueryManager.prototype.result = function () {
                this.processOutstanding();
                return this._result;
            };
            QueryManager.prototype.epoch = function () {
                this.processOutstanding();
                return this._resultEpoch;
            };
            QueryManager.prototype.error = function () {
                this.processOutstanding();
                return this._error;
            };
            QueryManager.prototype.refresh = function () {
                this.result();
                if (!this._outstanding) {
                    this._outstanding = {
                        result: this._query.query(),
                        error: m.prop(null),
                    };
                    this._outstanding.result.then(null, this._outstanding.error);
                }
                return this._outstanding.result;
            };
            return QueryManager;
        })();
        Metrics.QueryManager = QueryManager;
        function nonJsonErrors(xhr, opts) {
            return xhr.status > 200 ? JSON.stringify(xhr.responseText) : xhr.responseText;
        }
    })(Metrics = Models.Metrics || (Models.Metrics = {}));
})(Models || (Models = {}));
// source: components/metrics.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="../typings/d3/d3.d.ts" />
/// <reference path="../models/timeseries.ts" />
var Components;
(function (Components) {
    var Metrics;
    (function (Metrics) {
        var LineGraph;
        (function (LineGraph) {
            var Controller = (function () {
                function Controller(vm) {
                    var _this = this;
                    this.vm = vm;
                    this.chart = nv.models.lineChart()
                        .x(function (d) { return new Date(d.timestamp_nanos / 1.0e6); })
                        .y(function (d) { return d.value; })
                        .useInteractiveGuideline(true)
                        .showLegend(true)
                        .showYAxis(true)
                        .showXAxis(true)
                        .xScale(d3.time.scale());
                    this.drawGraph = function (element, isInitialized, context) {
                        if (!isInitialized) {
                            nv.addGraph(_this.chart);
                        }
                        if (_this.shouldRenderData()) {
                            var formattedData = [];
                            if (_this.vm.query.result()) {
                                formattedData = _this.vm.query.result().results.map(function (d) {
                                    return {
                                        values: d.datapoints,
                                        key: d.name,
                                        color: Controller.colors(d.name),
                                        area: true,
                                        fillOpacity: .1,
                                    };
                                });
                            }
                            d3.select(element)
                                .datum(formattedData)
                                .transition().duration(500)
                                .call(_this.chart);
                        }
                    };
                    this.chart.xAxis
                        .tickFormat(d3.time.format('%I:%M:%S'))
                        .showMaxMin(false);
                }
                Controller.prototype.shouldRenderData = function () {
                    var epoch = this.vm.query.epoch();
                    if (epoch > this.vm.lastEpoch) {
                        this.vm.lastEpoch = epoch;
                        return true;
                    }
                    return false;
                };
                Controller.prototype.hasData = function () {
                    return this.vm.query.epoch() > 0;
                };
                Controller.colors = d3.scale.category10();
                return Controller;
            })();
            function controller(model) {
                return new Controller(model);
            }
            LineGraph.controller = controller;
            function view(ctrl) {
                if (ctrl.hasData()) {
                    return m(".linegraph", { style: "width:500px;height:300px;" }, m("svg.graph", { config: ctrl.drawGraph }));
                }
                else {
                    return m("", "loading...");
                }
            }
            LineGraph.view = view;
            function create(query, key) {
                var vm = { lastEpoch: 0, query: query };
                if (key) {
                    vm.key = key;
                }
                return m.component(LineGraph, vm);
            }
            LineGraph.create = create;
        })(LineGraph = Metrics.LineGraph || (Metrics.LineGraph = {}));
    })(Metrics = Components.Metrics || (Components.Metrics = {}));
})(Components || (Components = {}));
// source: pages/graph.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="../typings/d3/d3.d.ts" />
/// <reference path="../models/timeseries.ts" />
/// <reference path="../components/metrics.ts" />
var AdminViews;
(function (AdminViews) {
    var Graph;
    (function (Graph) {
        var Page;
        (function (Page) {
            var Controller = (function () {
                function Controller() {
                    var _this = this;
                    this.sumquery = new Models.Metrics.RecentQuery(10 * 60 * 1000, Models.Metrics.QueryAggregator.AVG, "cr.node.calls.success.1");
                    this.ratequery = new Models.Metrics.RecentQuery(10 * 60 * 1000, Models.Metrics.QueryAggregator.AVG_RATE, "cr.node.calls.success.1");
                    this.toggleGraph = function () {
                        _this.showRates = !_this.showRates;
                        if (_this.showRates) {
                            _this.manager.setQuery(_this.ratequery);
                        }
                        else {
                            _this.manager.setQuery(_this.sumquery);
                        }
                        _this.manager.refresh();
                    };
                    this.manager = new Models.Metrics.QueryManager(this.sumquery);
                    this.manager.refresh();
                    this.interval = setInterval(function () { return _this.manager.refresh(); }, 10000);
                }
                Controller.prototype.onunload = function () {
                    clearInterval(this.interval);
                };
                return Controller;
            })();
            function controller() {
                return new Controller();
            }
            Page.controller = controller;
            function view(ctrl) {
                var buttonText;
                if (ctrl.showRates) {
                    buttonText = "Show Totals";
                }
                else {
                    buttonText = "Show Rates";
                }
                return m(".graphPage", [
                    m("H3", "Graph Demo"),
                    Components.Metrics.LineGraph.create(ctrl.manager),
                    Components.Metrics.LineGraph.create(ctrl.manager),
                    m("", m("input[type=button]", {
                        value: buttonText,
                        onclick: ctrl.toggleGraph,
                    })),
                ]);
            }
            Page.view = view;
        })(Page = Graph.Page || (Graph.Page = {}));
    })(Graph = AdminViews.Graph || (AdminViews.Graph = {}));
})(AdminViews || (AdminViews = {}));
// source: pages/monitor.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
var AdminViews;
(function (AdminViews) {
    var Monitor;
    (function (Monitor) {
        var Page;
        (function (Page) {
            function controller() { }
            Page.controller = controller;
            function view() {
                return m("h3", "Monitor Placeholder");
            }
            Page.view = view;
        })(Page = Monitor.Page || (Monitor.Page = {}));
    })(Monitor = AdminViews.Monitor || (AdminViews.Monitor = {}));
})(AdminViews || (AdminViews = {}));
// source: models/stats.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
// Author: Bram Gruneir (bram.gruneir@gmail.com)
var Models;
(function (Models) {
    var Stats;
    (function (Stats) {
        function FormatBytes(bytes) {
            var thresh = 1024;
            if (Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }
            var units = ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
            var u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while (Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1) + ' ' + units[u];
        }
        Stats.FormatBytes = FormatBytes;
        var tableStyle = "border-collapse:collapse; border - spacing:0; border - color:#ccc";
        var thStyle = "font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#efefef;text-align:center";
        var tdStyleOddFirst = "font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#efefef;text-align:center";
        var tdStyleOdd = "font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#f9f9f9;text-align:center";
        var tdStyleEvenFirst = "font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#efefef;text-align:center";
        var tdStyleEven = "font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#ccc;color:#333;background-color:#fff;text-align:center";
        function CreateStatsTable(stats) {
            return m("div", [
                m("h3", "Statistics"),
                m("table", { style: tableStyle }, [
                    m("tr", [
                        m("th", { style: thStyle }, ""),
                        m("th", { style: thStyle }, "Key"),
                        m("th", { style: thStyle }, "Value"),
                        m("th", { style: thStyle }, "Live"),
                        m("th", { style: thStyle }, "Intent"),
                        m("th", { style: thStyle }, "System")
                    ]),
                    m("tr", [
                        m("td", { style: tdStyleOddFirst }, "Count"),
                        m("td", { style: tdStyleOdd }, stats.key_count),
                        m("td", { style: tdStyleOdd }, stats.val_count),
                        m("td", { style: tdStyleOdd }, stats.live_count),
                        m("td", { style: tdStyleOdd }, stats.intent_count),
                        m("td", { style: tdStyleOdd }, stats.sys_count)
                    ]),
                    m("tr", [
                        m("td", { style: tdStyleEvenFirst }, "Size"),
                        m("td", { style: tdStyleEven }, FormatBytes(stats.key_bytes)),
                        m("td", { style: tdStyleEven }, FormatBytes(stats.val_bytes)),
                        m("td", { style: tdStyleEven }, FormatBytes(stats.live_bytes)),
                        m("td", { style: tdStyleEven }, FormatBytes(stats.intent_bytes)),
                        m("td", { style: tdStyleEven }, FormatBytes(stats.sys_bytes))
                    ])
                ])
            ]);
        }
        Stats.CreateStatsTable = CreateStatsTable;
    })(Stats = Models.Stats || (Models.Stats = {}));
})(Models || (Models = {}));
// source: models/node_status.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="stats.ts" />
// Author: Bram Gruneir (bram.gruneir@gmail.com)
var Models;
(function (Models) {
    var NodeStatus;
    (function (NodeStatus) {
        var Nodes = (function () {
            function Nodes() {
                this._data = m.prop({});
                this.desc = m.prop({});
                this.statuses = m.prop({});
            }
            Nodes.prototype.Query = function () {
                var _this = this;
                var url = "/_status/nodes/";
                return m.request({ url: url, method: "GET", extract: nonJsonErrors })
                    .then(function (results) {
                    results.d.forEach(function (status) {
                        var nodeId = status.desc.node_id;
                        if (_this._data()[nodeId] == null) {
                            _this._data()[nodeId] = [];
                        }
                        var statusList = _this._data()[nodeId];
                        if ((statusList.length == 0) ||
                            (statusList[statusList.length - 1].updated_at < status.updated_at)) {
                            _this._data()[nodeId].push(status);
                            _this.statuses()[nodeId] = status;
                        }
                    });
                    _this._pruneOldEntries();
                    _this._updateDescriptions();
                    return results;
                });
            };
            Nodes.prototype._updateDescriptions = function () {
                this.desc({});
                var nodeId;
                for (nodeId in this._data()) {
                    this.desc()[nodeId] = this._data()[nodeId][this._data()[nodeId].length - 1].desc;
                }
            };
            Nodes.prototype._pruneOldEntries = function () {
                var nodeId;
                for (nodeId in this._data()) {
                    var status = this._data()[nodeId];
                    if (status.length > Nodes._dataLimit) {
                        status = status.sclice(status.length - Nodes._dataPrunedSize, status.length - 1);
                    }
                }
            };
            Nodes._availability = function (status) {
                if (status.leader_range_count == 0) {
                    return "100%";
                }
                return (status.available_range_count / status.leader_range_count * 100).toString() + "%";
            };
            Nodes._replicated = function (status) {
                if (status.leader_range_count == 0) {
                    return "100%";
                }
                return (status.replicated_range_count / status.leader_range_count * 100).toString() + "%";
            };
            Nodes._formatDate = function (nanos) {
                var datetime = new Date(nanos / 1.0e6);
                return Nodes._datetimeFormater(datetime);
            };
            Nodes.prototype.Details = function (nodeId) {
                var node = this.statuses()[nodeId];
                if (node == null) {
                    return m("div", "No data present yet.");
                }
                return m("div", [
                    m("table", [
                        m("tr", [m("td", "Stores (" + node.store_ids.length + "):"),
                            m("td", [node.store_ids.map(function (storeId) {
                                    return m("div", [
                                        m("a[href=/stores/" + storeId + "]", { config: m.route }, storeId),
                                        " "]);
                                })])
                        ]),
                        m("tr", [m("td", "Network:"), m("td", node.desc.address.network)]),
                        m("tr", [m("td", "Address:"), m("td", node.desc.address.address)]),
                        m("tr", [m("td", "Started at:"), m("td", Nodes._formatDate(node.started_at))]),
                        m("tr", [m("td", "Updated at:"), m("td", Nodes._formatDate(node.updated_at))]),
                        m("tr", [m("td", "Ranges:"), m("td", node.range_count)]),
                        m("tr", [m("td", "Leader Ranges:"), m("td", node.leader_range_count)]),
                        m("tr", [m("td", "Available Ranges:"), m("td", node.available_range_count)]),
                        m("tr", [m("td", "Availablility:"), m("td", Nodes._availability(node))]),
                        m("tr", [m("td", "Under-Replicated Ranges:"), m("td", node.leader_range_count - node.replicated_range_count)]),
                        m("tr", [m("td", "Fully Replicated:"), m("td", Nodes._replicated(node))])
                    ]),
                    Models.Stats.CreateStatsTable(node.stats)
                ]);
            };
            Nodes.prototype.AllDetails = function () {
                var status = {
                    range_count: 0,
                    updated_at: 0,
                    leader_range_count: 0,
                    replicated_range_count: 0,
                    available_range_count: 0,
                    stats: {
                        live_bytes: 0,
                        key_bytes: 0,
                        val_bytes: 0,
                        intent_bytes: 0,
                        live_count: 0,
                        key_count: 0,
                        val_count: 0,
                        intent_count: 0,
                        sys_bytes: 0,
                        sys_count: 0
                    }
                };
                var nodeId;
                for (nodeId in this.statuses()) {
                    var nodeStatus = this.statuses()[nodeId];
                    status.range_count += nodeStatus.range_count;
                    status.leader_range_count += nodeStatus.leader_range_count;
                    status.replicated_range_count += nodeStatus.replicated_range_count;
                    status.available_range_count += nodeStatus.available_range_count;
                    if (nodeStatus.updated_at > status.updated_at) {
                        status.updated_at = nodeStatus.updated_at;
                    }
                    status.stats.live_bytes += nodeStatus.stats.live_bytes;
                    status.stats.key_bytes += nodeStatus.stats.key_bytes;
                    status.stats.val_bytes += nodeStatus.stats.val_bytes;
                    status.stats.intent_bytes += nodeStatus.stats.intent_bytes;
                    status.stats.live_count += nodeStatus.stats.live_count;
                    status.stats.key_count += nodeStatus.stats.key_count;
                    status.stats.val_count += nodeStatus.stats.val_count;
                    status.stats.intent_count += nodeStatus.stats.intent_count;
                    status.stats.sys_bytes += nodeStatus.stats.sys_bytes;
                    status.stats.sys_count += nodeStatus.stats.sys_count;
                }
                ;
                return m("div", [
                    m("h2", "Details"),
                    m("table", [
                        m("tr", [m("td", "Updated at:"), m("td", Nodes._formatDate(status.updated_at))]),
                        m("tr", [m("td", "Ranges:"), m("td", status.range_count)]),
                        m("tr", [m("td", "Leader Ranges:"), m("td", status.leader_range_count)]),
                        m("tr", [m("td", "Available Ranges:"), m("td", status.available_range_count)]),
                        m("tr", [m("td", "Availablility:"), m("td", Nodes._availability(status))]),
                        m("tr", [m("td", "Under-Replicated Ranges:"), m("td", status.leader_range_count - status.replicated_range_count)]),
                        m("tr", [m("td", "Fully Replicated:"), m("td", Nodes._replicated(status))])
                    ]),
                    Models.Stats.CreateStatsTable(status.stats)
                ]);
            };
            Nodes._dataLimit = 100000;
            Nodes._dataPrunedSize = 90000;
            Nodes._datetimeFormater = d3.time.format("%Y-%m-%d %H:%M:%S");
            return Nodes;
        })();
        NodeStatus.Nodes = Nodes;
        function nonJsonErrors(xhr, opts) {
            return xhr.status > 200 ? JSON.stringify(xhr.responseText) : xhr.responseText;
        }
    })(NodeStatus = Models.NodeStatus || (Models.NodeStatus = {}));
})(Models || (Models = {}));
// source: pages/nodes.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="../models/node_status.ts" />
/// <reference path="../models/timeseries.ts" />
/// <reference path="../components/metrics.ts" />
var AdminViews;
(function (AdminViews) {
    var Nodes;
    (function (Nodes) {
        Nodes.nodeStatuses = new Models.NodeStatus.Nodes();
        Nodes.queryManagers = {};
        var Controller = (function () {
            function Controller(nodeId) {
                var _this = this;
                this._refreshFunctions = [{
                        f: Nodes.nodeStatuses.Query,
                        o: Nodes.nodeStatuses
                    }];
                if (nodeId != null) {
                    this._nodeId = nodeId;
                    if (Nodes.queryManagers[nodeId] == null) {
                        Nodes.queryManagers[nodeId] = {};
                    }
                    this._addChart(Models.Metrics.QueryAggregator.AVG_RATE, "calls.success");
                    this._addChart(Models.Metrics.QueryAggregator.AVG_RATE, "calls.error");
                }
                else {
                    this._nodeId = null;
                }
                this._refresh();
                this._interval = setInterval(function () { return _this._refresh(); }, Controller._queryEveryMS);
            }
            Controller.prototype._refresh = function () {
                for (var i = 0; i < this._refreshFunctions.length; i++) {
                    this._refreshFunctions[i].f.call(this._refreshFunctions[i].o);
                }
            };
            Controller._queryManagerBuilder = function (nodeId, agg, source) {
                var query = new Models.Metrics.RecentQuery(10 * 60 * 1000, agg, "cr.node." + source + "." + nodeId);
                return new Models.Metrics.QueryManager(query);
            };
            Controller.prototype._addChart = function (agg, source) {
                var name = agg + ":" + source;
                if (Nodes.queryManagers[this._nodeId][name] == null) {
                    Nodes.queryManagers[this._nodeId][name] = Controller._queryManagerBuilder(this._nodeId, agg, source);
                }
                this._refreshFunctions.push({ f: Nodes.queryManagers[this._nodeId][name].refresh, o: Nodes.queryManagers[this._nodeId][name] });
            };
            Controller.prototype.onunload = function () {
                clearInterval(this._interval);
            };
            Controller._queryEveryMS = 10000;
            return Controller;
        })();
        Nodes.Controller = Controller;
        var NodesPage;
        (function (NodesPage) {
            function controller() {
                return new Controller();
            }
            NodesPage.controller = controller;
            function view(ctrl) {
                return m("div", [
                    m("h2", "Nodes List"),
                    m("ul", [
                        Object.keys(Nodes.nodeStatuses.desc()).sort().map(function (nodeId) {
                            var desc = Nodes.nodeStatuses.desc()[nodeId];
                            return m("li", { key: desc.node_id }, m("div", [
                                m.trust("&nbsp;&bull;&nbsp;"),
                                m("a[href=/nodes/" + desc.node_id + "]", { config: m.route }, "Node:" + desc.node_id),
                                " with Address:" + desc.address.network + "-" + desc.address.address
                            ]));
                        }),
                    ]),
                    Nodes.nodeStatuses.AllDetails()
                ]);
            }
            NodesPage.view = view;
        })(NodesPage = Nodes.NodesPage || (Nodes.NodesPage = {}));
        var NodePage;
        (function (NodePage) {
            function controller() {
                var nodeId = m.route.param("node_id");
                return new Nodes.Controller(nodeId);
            }
            NodePage.controller = controller;
            function view(ctrl) {
                var nodeId = m.route.param("node_id");
                return m("div", [
                    m("h2", "Node Status"),
                    m("div", [
                        m("h3", "Node: " + nodeId),
                        Nodes.nodeStatuses.Details(nodeId)
                    ]),
                    m("table", [
                        m("tr", [
                            m("td", [
                                m("h4", "Successful Calls Rate"),
                                Components.Metrics.LineGraph.create(Nodes.queryManagers[nodeId]["2:calls.success"])
                            ]),
                            m("td", [
                                m("h4", "Error Calls Rate"),
                                Components.Metrics.LineGraph.create(Nodes.queryManagers[nodeId]["2:calls.error"])
                            ])
                        ])
                    ])
                ]);
            }
            NodePage.view = view;
        })(NodePage = Nodes.NodePage || (Nodes.NodePage = {}));
    })(Nodes = AdminViews.Nodes || (AdminViews.Nodes = {}));
})(AdminViews || (AdminViews = {}));
// source: pages/rest_explorer.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
var AdminViews;
(function (AdminViews) {
    var RestExplorer;
    (function (RestExplorer) {
        var Model;
        (function (Model) {
            Model.singleKey = m.prop("");
            Model.singleValue = m.prop("");
            Model.singleCounter = m.prop(0);
            Model.rangeStart = m.prop("");
            Model.rangeEnd = m.prop("");
            Model.responseLog = m.prop([]);
            function logResponse(xhr, opts) {
                var data;
                if (xhr.responseType === "json") {
                    data = JSON.stringify(xhr.response);
                }
                else {
                    data = xhr.responseText;
                }
                data = data.length > 0 ? data : "(no response body)";
                data = ['[', opts.method, '] ', xhr.status, ' ', opts.url, ': ', data].join('');
                Model.responseLog().push(data);
                return JSON.stringify(data);
            }
            function scan(method) {
                var endpoint = "/kv/rest/range?start=" + encodeURIComponent(Model.rangeStart());
                if (!!Model.rangeEnd()) {
                    endpoint += '&end=' + encodeURIComponent(Model.rangeEnd());
                }
                return m.request({
                    method: method,
                    url: endpoint,
                    extract: logResponse,
                });
            }
            Model.scan = scan;
            function entry(method) {
                var endpoint = "/kv/rest/entry/" + Model.singleKey();
                var request = {
                    method: method,
                    url: endpoint,
                    extract: logResponse,
                    serialize: function (data) { return data; },
                };
                if (method === "POST") {
                    request.config = function (xhr, opts) {
                        xhr.setRequestHeader("Content-Type", "text/plain; charset=UTF-8");
                        return xhr;
                    };
                    request.data = Model.singleValue();
                }
                return m.request(request);
            }
            Model.entry = entry;
            function counter(method) {
                var endpoint = "/kv/rest/counter/" + Model.singleKey();
                var request = {
                    method: method,
                    url: endpoint,
                    extract: logResponse,
                    serialize: function (data) { return data; },
                };
                if (method === "POST") {
                    request.config = function (xhr, opts) {
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                        return xhr;
                    };
                    request.data = Model.singleCounter();
                }
                return m.request(request);
            }
            Model.counter = counter;
            function clearLog() {
                Model.responseLog([]);
            }
            Model.clearLog = clearLog;
            ;
        })(Model || (Model = {}));
        function button(text, onclick, disabled) {
            return m("input[type=button]", {
                value: text,
                disabled: disabled(),
                onclick: onclick,
            });
        }
        function field(text, value, disabled) {
            return m("input[type=text]", {
                placeholder: text,
                disabled: disabled(),
                value: value(),
                onchange: m.withAttr("value", value),
            });
        }
        var EntryComponent;
        (function (EntryComponent) {
            var Controller = (function () {
                function Controller() {
                    var _this = this;
                    this.responsePending = m.prop(false);
                    this.key = Model.singleKey;
                    this.val = Model.singleValue;
                    this.complete = function () { return _this.responsePending(false); };
                    this.get = function () { return _this.request("GET"); };
                    this.post = function () { return _this.request("POST"); };
                    this.head = function () { return _this.request("HEAD"); };
                    this.delete = function () { return _this.request("DELETE"); };
                }
                Controller.prototype.request = function (method) {
                    this.responsePending(true);
                    Model.entry(method).then(this.complete, this.complete);
                };
                return Controller;
            })();
            function controller() {
                return new Controller();
            }
            EntryComponent.controller = controller;
            function view(ctrl) {
                return m("section.restExplorerControls-control", [
                    m("h3", "K/V Pair"),
                    m("form", [
                        field("Key", ctrl.key, ctrl.responsePending),
                        m.trust("&rarr;"),
                        field("Value", ctrl.val, ctrl.responsePending),
                        button("Get", ctrl.get, ctrl.responsePending),
                        button("Head", ctrl.head, ctrl.responsePending),
                        button("Put", ctrl.post, ctrl.responsePending),
                        button("Delete", ctrl.delete, ctrl.responsePending),
                    ])
                ]);
            }
            EntryComponent.view = view;
        })(EntryComponent || (EntryComponent = {}));
        var RangeComponent;
        (function (RangeComponent) {
            var Controller = (function () {
                function Controller() {
                    var _this = this;
                    this.responsePending = m.prop(false);
                    this.rangeStart = Model.rangeStart;
                    this.rangeEnd = Model.rangeEnd;
                    this.complete = function () { return _this.responsePending(false); };
                    this.get = function () { return _this.request("GET"); };
                    this.delete = function () { return _this.request("DELETE"); };
                }
                Controller.prototype.request = function (method) {
                    this.responsePending(true);
                    Model.scan(method).then(this.complete, this.complete);
                };
                return Controller;
            })();
            function controller() {
                return new Controller();
            }
            RangeComponent.controller = controller;
            function view(ctrl) {
                return m("section.restExplorerControls-control", [
                    m("h3", "Range"),
                    m("form", [
                        field("Start", ctrl.rangeStart, ctrl.responsePending),
                        m.trust("&rarr;"),
                        field("End", ctrl.rangeEnd, ctrl.responsePending),
                        button("Get", ctrl.get, ctrl.responsePending),
                        button("Delete", ctrl.delete, ctrl.responsePending),
                    ])
                ]);
            }
            RangeComponent.view = view;
        })(RangeComponent || (RangeComponent = {}));
        var CounterComponent;
        (function (CounterComponent) {
            var Controller = (function () {
                function Controller() {
                    var _this = this;
                    this.responsePending = m.prop(false);
                    this.key = Model.singleKey;
                    this.val = Model.singleCounter;
                    this.complete = function () { return _this.responsePending(false); };
                    this.get = function () { return _this.request("GET"); };
                    this.post = function () { return _this.request("POST"); };
                    this.head = function () { return _this.request("HEAD"); };
                    this.delete = function () { return _this.request("DELETE"); };
                }
                Controller.prototype.request = function (method) {
                    this.responsePending(true);
                    Model.counter(method).then(this.complete, this.complete);
                };
                return Controller;
            })();
            function controller() {
                return new Controller();
            }
            CounterComponent.controller = controller;
            function view(ctrl) {
                return m("section.restExplorerControls-control", [
                    m("h3", "Counter"),
                    m("form", [
                        field("Key", ctrl.key, ctrl.responsePending),
                        m.trust("&rarr;"),
                        field("Value", ctrl.val, ctrl.responsePending),
                        button("Get", ctrl.get, ctrl.responsePending),
                        button("Head", ctrl.head, ctrl.responsePending),
                        button("Put", ctrl.post, ctrl.responsePending),
                        button("Delete", ctrl.delete, ctrl.responsePending),
                    ])
                ]);
            }
            CounterComponent.view = view;
        })(CounterComponent || (CounterComponent = {}));
        var LogComponent;
        (function (LogComponent) {
            function controller() {
                return {
                    log: Model.responseLog,
                    clear: Model.clearLog,
                };
            }
            LogComponent.controller = controller;
            function view(ctrl) {
                return m(".restExplorerLog", [
                    m("h3", "Console"),
                    button("Clear", ctrl.clear, function () { return false; }),
                    ctrl.log().map(function (str) {
                        return m("", str);
                    })
                ]);
            }
            LogComponent.view = view;
        })(LogComponent || (LogComponent = {}));
        var Page;
        (function (Page) {
            function controller() { }
            Page.controller = controller;
            function view() {
                return m(".restExplorer", [
                    m(".restExplorerControls", [
                        EntryComponent,
                        RangeComponent,
                        CounterComponent,
                    ]),
                    LogComponent,
                ]);
            }
            Page.view = view;
        })(Page = RestExplorer.Page || (RestExplorer.Page = {}));
    })(RestExplorer = AdminViews.RestExplorer || (AdminViews.RestExplorer = {}));
})(AdminViews || (AdminViews = {}));
// source: models/store_status.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="../typings/d3/d3.d.ts" />
/// <reference path="node_status.ts" />
/// <reference path="stats.ts" />
// Author: Bram Gruneir (bram.gruneir@gmail.com)
var Models;
(function (Models) {
    var StoreStatus;
    (function (StoreStatus) {
        var Stores = (function () {
            function Stores() {
                this._data = m.prop({});
                this.desc = m.prop({});
                this.statuses = m.prop({});
            }
            Stores.prototype.Query = function () {
                var _this = this;
                var url = "/_status/stores/";
                return m.request({ url: url, method: "GET", extract: nonJsonErrors })
                    .then(function (results) {
                    results.d.forEach(function (status) {
                        var storeId = status.desc.store_id;
                        if (_this._data()[storeId] == null) {
                            _this._data()[storeId] = [];
                        }
                        var statusList = _this._data()[storeId];
                        if ((statusList.length == 0) ||
                            (statusList[statusList.length - 1].updated_at < status.updated_at)) {
                            _this._data()[storeId].push(status);
                            _this.statuses()[storeId] = status;
                        }
                    });
                    _this._pruneOldEntries();
                    _this._updateDescriptions();
                    return results;
                });
            };
            Stores.prototype._updateDescriptions = function () {
                this.desc({});
                var nodeId;
                for (nodeId in this._data()) {
                    this.desc()[nodeId] = this._data()[nodeId][this._data()[nodeId].length - 1].desc;
                }
            };
            Stores.prototype._pruneOldEntries = function () {
                var nodeId;
                for (nodeId in this._data()) {
                    var status = this._data()[nodeId];
                    if (status.length > Stores._dataLimit) {
                        status = status.sclice(status.length - Stores._dataPrunedSize, status.length - 1);
                    }
                }
            };
            Stores._availability = function (store) {
                if (store.leader_range_count == 0) {
                    return "100%";
                }
                return (store.available_range_count / store.leader_range_count * 100).toString() + "%";
            };
            Stores._replicated = function (store) {
                if (store.leader_range_count == 0) {
                    return "100%";
                }
                return (store.replicated_range_count / store.leader_range_count * 100).toString() + "%";
            };
            Stores._formatDate = function (nanos) {
                var datetime = new Date(nanos / 1.0e6);
                return Stores._datetimeFormater(datetime);
            };
            Stores.prototype.Details = function (storeId) {
                var store = this.statuses()[storeId];
                if (store == null) {
                    return m("div", "No data present yet.");
                }
                return m("div", [
                    m("table", [
                        m("tr", [m("td", "Node Id:"), m("td", m("a[href=/nodes/" + store.desc.node.node_id + "]", { config: m.route }, store.desc.node.node_id))]),
                        m("tr", [m("td", "Node Network:"), m("td", store.desc.node.address.network)]),
                        m("tr", [m("td", "Node Address:"), m("td", store.desc.node.address.address)]),
                        m("tr", [m("td", "Started at:"), m("td", Stores._formatDate(store.started_at))]),
                        m("tr", [m("td", "Updated at:"), m("td", Stores._formatDate(store.updated_at))]),
                        m("tr", [m("td", "Ranges:"), m("td", store.range_count)]),
                        m("tr", [m("td", "Leader Ranges:"), m("td", store.leader_range_count)]),
                        m("tr", [m("td", "Available Ranges:"), m("td", store.available_range_count)]),
                        m("tr", [m("td", "Availablility:"), m("td", Stores._availability(store))]),
                        m("tr", [m("td", "Under-Replicated Ranges:"), m("td", store.leader_range_count - store.replicated_range_count)]),
                        m("tr", [m("td", "Fully Replicated:"), m("td", Stores._replicated(store))])
                    ]),
                    Models.Stats.CreateStatsTable(store.stats)
                ]);
            };
            Stores.prototype.AllDetails = function () {
                var status = {
                    range_count: 0,
                    updated_at: 0,
                    leader_range_count: 0,
                    replicated_range_count: 0,
                    available_range_count: 0,
                    stats: {
                        live_bytes: 0,
                        key_bytes: 0,
                        val_bytes: 0,
                        intent_bytes: 0,
                        live_count: 0,
                        key_count: 0,
                        val_count: 0,
                        intent_count: 0,
                        sys_bytes: 0,
                        sys_count: 0
                    }
                };
                var storeId;
                for (storeId in this.statuses()) {
                    var storeStatus = this.statuses()[storeId];
                    status.range_count += storeStatus.range_count;
                    status.leader_range_count += storeStatus.leader_range_count;
                    status.replicated_range_count += storeStatus.replicated_range_count;
                    status.available_range_count += storeStatus.available_range_count;
                    if (storeStatus.updated_at > status.updated_at) {
                        status.updated_at = storeStatus.updated_at;
                    }
                    status.stats.live_bytes += storeStatus.stats.live_bytes;
                    status.stats.key_bytes += storeStatus.stats.key_bytes;
                    status.stats.val_bytes += storeStatus.stats.val_bytes;
                    status.stats.intent_bytes += storeStatus.stats.intent_bytes;
                    status.stats.live_count += storeStatus.stats.live_count;
                    status.stats.key_count += storeStatus.stats.key_count;
                    status.stats.val_count += storeStatus.stats.val_count;
                    status.stats.intent_count += storeStatus.stats.intent_count;
                    status.stats.sys_bytes += storeStatus.stats.sys_bytes;
                    status.stats.sys_count += storeStatus.stats.sys_count;
                }
                ;
                return m("div", [
                    m("h2", "Details"),
                    m("table", [
                        m("tr", [m("td", "Updated at:"), m("td", Stores._formatDate(status.updated_at))]),
                        m("tr", [m("td", "Ranges:"), m("td", status.range_count)]),
                        m("tr", [m("td", "Leader Ranges:"), m("td", status.leader_range_count)]),
                        m("tr", [m("td", "Available Ranges:"), m("td", status.available_range_count)]),
                        m("tr", [m("td", "Availablility:"), m("td", Stores._availability(status))]),
                        m("tr", [m("td", "Under-Replicated Ranges:"), m("td", status.leader_range_count - status.replicated_range_count)]),
                        m("tr", [m("td", "Fully Replicated:"), m("td", Stores._replicated(status))])
                    ]),
                    Models.Stats.CreateStatsTable(status.stats)
                ]);
            };
            Stores._dataLimit = 100000;
            Stores._dataPrunedSize = 90000;
            Stores._datetimeFormater = d3.time.format("%Y-%m-%d %H:%M:%S");
            return Stores;
        })();
        StoreStatus.Stores = Stores;
        function nonJsonErrors(xhr, opts) {
            return xhr.status > 200 ? JSON.stringify(xhr.responseText) : xhr.responseText;
        }
    })(StoreStatus = Models.StoreStatus || (Models.StoreStatus = {}));
})(Models || (Models = {}));
// source: pages/stores.ts
/// <reference path="../typings/mithriljs/mithril.d.ts" />
/// <reference path="../models/store_status.ts" />
var AdminViews;
(function (AdminViews) {
    var Stores;
    (function (Stores) {
        Stores.storeStatuses = new Models.StoreStatus.Stores();
        Stores.queryManagers = {};
        var Controller = (function () {
            function Controller(storeId) {
                var _this = this;
                this._refreshFunctions = [{
                        f: Stores.storeStatuses.Query,
                        o: Stores.storeStatuses
                    }];
                if (storeId != null) {
                    this._storeId = storeId;
                    if (Stores.queryManagers[storeId] == null) {
                        Stores.queryManagers[storeId] = {};
                    }
                    this._addChart(Models.Metrics.QueryAggregator.AVG, "keycount");
                    this._addChart(Models.Metrics.QueryAggregator.AVG, "valcount");
                    this._addChart(Models.Metrics.QueryAggregator.AVG, "livecount");
                    this._addChart(Models.Metrics.QueryAggregator.AVG, "intentcount");
                    this._addChart(Models.Metrics.QueryAggregator.AVG, "ranges");
                }
                else {
                    this._storeId = null;
                }
                this._refresh();
                this._interval = setInterval(function () { return _this._refresh(); }, Controller._queryEveryMS);
            }
            Controller.prototype._refresh = function () {
                for (var i = 0; i < this._refreshFunctions.length; i++) {
                    this._refreshFunctions[i].f.call(this._refreshFunctions[i].o);
                }
            };
            Controller._queryManagerBuilder = function (storeId, agg, source) {
                var query = new Models.Metrics.RecentQuery(10 * 60 * 1000, agg, "cr.store." + source + "." + storeId);
                return new Models.Metrics.QueryManager(query);
            };
            Controller.prototype._addChart = function (agg, source) {
                var name = agg + ":" + source;
                if (Stores.queryManagers[this._storeId][name] == null) {
                    Stores.queryManagers[this._storeId][name] = Controller._queryManagerBuilder(this._storeId, agg, source);
                }
                this._refreshFunctions.push({ f: Stores.queryManagers[this._storeId][name].refresh, o: Stores.queryManagers[this._storeId][name] });
            };
            Controller.prototype.onunload = function () {
                clearInterval(this._interval);
            };
            Controller._queryEveryMS = 10000;
            return Controller;
        })();
        Stores.Controller = Controller;
        var StoresPage;
        (function (StoresPage) {
            function controller() {
                return new Controller();
            }
            StoresPage.controller = controller;
            function view(crtl) {
                return m("div", [
                    m("h2", "Stores List"),
                    m("ul", [
                        Object.keys(Stores.storeStatuses.desc()).sort().map(function (storeId) {
                            var desc = Stores.storeStatuses.desc()[storeId];
                            return m("li", { key: desc.store_id }, m("div", [
                                m.trust("&nbsp;&bull;&nbsp;"),
                                m("a[href=/stores/" + storeId + "]", { config: m.route }, "Store:" + storeId),
                                " on ",
                                m("a[href=/nodes/" + desc.node.node_id + "]", { config: m.route }, "Node:" + desc.node.node_id),
                                " with Address:" + desc.node.address.network + "-" + desc.node.address.address
                            ]));
                        }),
                        Stores.storeStatuses.AllDetails()
                    ]),
                ]);
            }
            StoresPage.view = view;
        })(StoresPage = Stores.StoresPage || (Stores.StoresPage = {}));
        var StorePage;
        (function (StorePage) {
            function controller() {
                var storeId = m.route.param("store_id");
                return new Stores.Controller(storeId);
            }
            StorePage.controller = controller;
            function view(crtl) {
                var storeId = m.route.param("store_id");
                return m("div", [
                    m("h2", "Store Status"),
                    m("div", [
                        m("h3", "Store: " + storeId),
                        Stores.storeStatuses.Details(storeId)
                    ]),
                    m("table", [
                        m("tr", [
                            m("td", [
                                m("h4", "Key Count"),
                                Components.Metrics.LineGraph.create(Stores.queryManagers[storeId]["1:keycount"])
                            ]),
                            m("td", [
                                m("h4", "Value Count"),
                                Components.Metrics.LineGraph.create(Stores.queryManagers[storeId]["1:valcount"])
                            ])
                        ]),
                        m("tr", [
                            m("td", [
                                m("h4", "Live Count"),
                                Components.Metrics.LineGraph.create(Stores.queryManagers[storeId]["1:livecount"])
                            ]),
                            m("td", [
                                m("h4", "Intent Count"),
                                Components.Metrics.LineGraph.create(Stores.queryManagers[storeId]["1:intentcount"])
                            ])
                        ]),
                        m("tr", [
                            m("td", [
                                m("h4", "Range Count"),
                                Components.Metrics.LineGraph.create(Stores.queryManagers[storeId]["1:ranges"])
                            ]),
                            m("td")
                        ])
                    ])
                ]);
            }
            StorePage.view = view;
        })(StorePage = Stores.StorePage || (Stores.StorePage = {}));
    })(Stores = AdminViews.Stores || (AdminViews.Stores = {}));
})(AdminViews || (AdminViews = {}));
// source: app.ts
/// <reference path="typings/mithriljs/mithril.d.ts" />
/// <reference path="pages/graph.ts" />
/// <reference path="pages/monitor.ts" />
/// <reference path="pages/nodes.ts" />
/// <reference path="pages/rest_explorer.ts" />
/// <reference path="pages/stores.ts" />
m.route.mode = "hash";
m.route(document.getElementById("root"), "/rest-explorer", {
    "/graph": AdminViews.Graph.Page,
    "/monitor": AdminViews.Monitor.Page,
    "/node": AdminViews.Nodes.NodesPage,
    "/nodes": AdminViews.Nodes.NodesPage,
    "/node/:node_id": AdminViews.Nodes.NodePage,
    "/nodes/:node_id": AdminViews.Nodes.NodePage,
    "/rest-explorer": AdminViews.RestExplorer.Page,
    "/store": AdminViews.Stores.StorePage,
    "/stores": AdminViews.Stores.StoresPage,
    "/store/:store_id": AdminViews.Stores.StorePage,
    "/stores/:store_id": AdminViews.Stores.StorePage
});
